<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:22:11 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>http.c File Reference</h1>
<p>http server for AMI access  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &lt;<a class="el" href="time_8h_source.html">time.h</a>&gt;</code><br/>
<code>#include &lt;sys/time.h&gt;</code><br/>
<code>#include &lt;sys/stat.h&gt;</code><br/>
<code>#include &lt;sys/signal.h&gt;</code><br/>
<code>#include &lt;fcntl.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="paths_8h_source.html">asterisk/paths.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="network_8h_source.html">asterisk/network.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cli_8h_source.html">asterisk/cli.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="tcptls_8h_source.html">asterisk/tcptls.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="http_8h_source.html">asterisk/http.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="strings_8h_source.html">asterisk/strings.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="config_8h_source.html">asterisk/config.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="stringfields_8h_source.html">asterisk/stringfields.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="ast__version_8h_source.html">asterisk/ast_version.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="manager_8h_source.html">asterisk/manager.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="__private_8h_source.html">asterisk/_private.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="astobj2_8h_source.html">asterisk/astobj2.h</a>&quot;</code><br/>

<p><a href="http_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structhttp__uri__redirect.html">http_uri_redirect</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structuri__redirects.html">uri_redirects</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structuris.html">uris</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a7771602f42db0453fab887c997cd05e1">DO_SSL</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#aa63ba314dbe0a2b65c79f047de3244c6">HOOK_T</a>&nbsp;&nbsp;&nbsp;int</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a5af8c911aa793e61d90637ed34b3a0b1">LEN_T</a>&nbsp;&nbsp;&nbsp;int</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#aecb32037d29b6d4c9d903ba03b56f065">MAX_PREFIX</a>&nbsp;&nbsp;&nbsp;80</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a3ce71802a2d0296a3478fcfeb3c21aac">__ast_http_load</a> (int reload)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a50af5ddf9c9a9dd76f2a1203f50dafdd">add_redirect</a> (const char *value)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Add a new URI redirect The entries in the redirect list are sorted by length, just like the list of URI handlers.  <a href="#a50af5ddf9c9a9dd76f2a1203f50dafdd"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__str.html">ast_str</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a934683361438de9f78b6c88a6a106b46">ast_http_error</a> (int <a class="el" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>, const char *title, const char *extra_header, const char *<a class="el" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Return an <a class="el" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> <a class="el" href="astmm_8h.html#ab8b25cd8f16d4a6552afe4e65c4f082d">malloc()</a>'d string containing an HTTP error <a class="el" href="structmessage.html">message</a>.  <a href="#a934683361438de9f78b6c88a6a106b46"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#ab02497431dec0900ac24fafa1c8599c6">ast_http_init</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a0059c10f2538cfa09f9979d5fefd5638">ast_http_prefix</a> (char *<a class="el" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, int len)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Return the current prefix.  <a href="#a0059c10f2538cfa09f9979d5fefd5638"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a5998a3b542a4d15b6102bfe9e005de76">ast_http_reload</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a5b30188fccd09ea5f099a088b325a190">ast_http_uri_link</a> (struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *urih)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Link the new uri into the list.  <a href="#a5b30188fccd09ea5f099a088b325a190"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#abc4e71c538d9c1ad56b8e4a2e46bed35">ast_http_uri_unlink</a> (struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *urih)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Unregister a URI handler.  <a href="#abc4e71c538d9c1ad56b8e4a2e46bed35"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#ae05bfd31702ddfd156bd1312ccbf2441">ast_http_uri_unlink_all_with_key</a> (const char *key)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Unregister all handlers with matching key.  <a href="#ae05bfd31702ddfd156bd1312ccbf2441"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#afc08b749db765fdf2c6e2a2e9593a6fe">ftype2mtype</a> (const char *ftype, char *wkspace, int wkspacelen)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#abd384ccb6510fda645ef76636af6642a">handle_show_http</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__str.html">ast_str</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a9265ccf674be7c051596c0da7ea30201">handle_uri</a> (struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *ser, char *uri, enum <a class="el" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80ef">ast_http_method</a> method, int *<a class="el" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>, char **title, int *contentlength, struct <a class="el" href="structast__variable.html">ast_variable</a> **cookies, struct <a class="el" href="structast__variable.html">ast_variable</a> *headers, unsigned int *static_content)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#ae57381d7764de9906ba0ce595fe0fa0f">http_decode</a> (char *s)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a0605800ec02aa2a6ffd42af6ba06b98f">httpd_helper_thread</a> (void *arg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__str.html">ast_str</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a151755d5fac621a55deef1256ddd49b1">httpstatus_callback</a> (struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *ser, const struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *urih, const char *uri, enum <a class="el" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80ef">ast_http_method</a> method, struct <a class="el" href="structast__variable.html">ast_variable</a> *vars, struct <a class="el" href="structast__variable.html">ast_variable</a> *headers, int *<a class="el" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>, char **title, int *contentlength)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static uint32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#ad581b301a954f309d107108bfac61775">manid_from_vars</a> (struct <a class="el" href="structast__variable.html">ast_variable</a> *sid)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#aaabfd592781e75ac9fb18a499327bff9">parse_cookies</a> (char *cookies)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__str.html">ast_str</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#aca1b87b99ebfc893da36e957ed5402ff">static_callback</a> (struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *ser, const struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *urih, const char *uri, enum <a class="el" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80ef">ast_http_method</a> method, struct <a class="el" href="structast__variable.html">ast_variable</a> *vars, struct <a class="el" href="structast__variable.html">ast_variable</a> *headers, int *<a class="el" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>, char **title, int *contentlength)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a62ac5f089c743a2d4113e518818000fa">cli_http</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a0d575742490f0b0242cfeace49c81b16">enablestatic</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <br class="typebreak"/>
<a class="el" href="structast__tcptls__session__args.html">ast_tcptls_session_args</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__tls__config.html">ast_tls_config</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <br class="typebreak"/>
<a class="el" href="structast__tcptls__session__args.html">ast_tcptls_session_args</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a></td></tr>
<tr><td class="memItemLeft" >struct {</td></tr>
<tr><td class="memItemLeft" >&nbsp;&nbsp;&nbsp;const char *&nbsp;&nbsp;&nbsp;<a class="el" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a></td></tr>
<tr><td class="memItemLeft" >&nbsp;&nbsp;&nbsp;const char *&nbsp;&nbsp;&nbsp;<a class="el" href="http_8c.html#a3189f2c804f88ece5a83d4772e11ff9e">mtype</a></td></tr>
<tr><td class="memItemLeft" valign="top">}&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a2ebb3c927f9a7eaf360284a393806e85">mimetypes</a> []</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Limit the kinds of files we're willing to serve up.  <a href="#a2ebb3c927f9a7eaf360284a393806e85"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a> [MAX_PREFIX]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__http__uri.html">ast_http_uri</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#ae59ae7f4b3e145d3d7468113fd4166ff">staticuri</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__http__uri.html">ast_http_uri</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8c.html#a092e39cea3cca5eca8cf40da0b7a47e1">statusuri</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>http server for AMI access </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Mark Spencer &lt;<a href="mailto:markster@digium.com">markster@digium.com</a>&gt;</dd></dl>
<p>This program implements a tiny http server and was inspired by micro-httpd by Jef Poskanzer</p>
<p><a class="el" href="AstHTTP.html">AMI over HTTP support</a> - AMI over the http protocol </p>

<p>Definition in file <a class="el" href="http_8c_source.html">http.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a7771602f42db0453fab887c997cd05e1"></a><!-- doxytag: member="http.c::DO_SSL" ref="a7771602f42db0453fab887c997cd05e1" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DO_SSL</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00059">59</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

</div>
</div>
<a class="anchor" id="aa63ba314dbe0a2b65c79f047de3244c6"></a><!-- doxytag: member="http.c::HOOK_T" ref="aa63ba314dbe0a2b65c79f047de3244c6" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define HOOK_T&nbsp;&nbsp;&nbsp;int</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00579">579</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

</div>
</div>
<a class="anchor" id="a5af8c911aa793e61d90637ed34b3a0b1"></a><!-- doxytag: member="http.c::LEN_T" ref="a5af8c911aa793e61d90637ed34b3a0b1" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LEN_T&nbsp;&nbsp;&nbsp;int</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00580">580</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

</div>
</div>
<a class="anchor" id="aecb32037d29b6d4c9d903ba03b56f065"></a><!-- doxytag: member="http.c::MAX_PREFIX" ref="aecb32037d29b6d4c9d903ba03b56f065" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_PREFIX&nbsp;&nbsp;&nbsp;80</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00055">55</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l00848">__ast_http_load()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a3ce71802a2d0296a3478fcfeb3c21aac"></a><!-- doxytag: member="http.c::__ast_http_load" ref="a3ce71802a2d0296a3478fcfeb3c21aac" args="(int reload)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int __ast_http_load </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>reload</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00848">848</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="http_8c_source.html#l00793">add_redirect()</a>, <a class="el" href="tcptls_8h_source.html#l00067">AST_CERTFILE</a>, <a class="el" href="config_8c_source.html#l00827">ast_config_destroy()</a>, <a class="el" href="config_8c_source.html#l02071">ast_config_load2()</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="utils_8c_source.html#l00182">ast_gethostbyname()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="linkedlists_8h_source.html#l00828">AST_RWLIST_REMOVE_HEAD</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>, <a class="el" href="tcptls_8c_source.html#l00334">ast_ssl_setup()</a>, <a class="el" href="astmm_8h_source.html#l00099">ast_strdup</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="tcptls_8c_source.html#l00432">ast_tcptls_server_start()</a>, <a class="el" href="utils_8c_source.html#l01311">ast_true()</a>, <a class="el" href="config_8c_source.html#l00411">ast_variable_browse()</a>, <a class="el" href="tcptls_8h_source.html#l00080">ast_tls_config::certfile</a>, <a class="el" href="tcptls_8h_source.html#l00081">ast_tls_config::cipher</a>, <a class="el" href="config_8h_source.html#l00043">CONFIG_FLAG_FILEUNCHANGED</a>, <a class="el" href="config_8h_source.html#l00050">CONFIG_STATUS_FILEINVALID</a>, <a class="el" href="config_8h_source.html#l00048">CONFIG_STATUS_FILEMISSING</a>, <a class="el" href="config_8h_source.html#l00049">CONFIG_STATUS_FILEUNCHANGED</a>, <a class="el" href="tcptls_8h_source.html#l00079">ast_tls_config::enabled</a>, <a class="el" href="devicestate_8c_source.html#l00199">enabled</a>, <a class="el" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">http_uri_redirect::entry</a>, <a class="el" href="chan__skinny_8c_source.html#l00982">hp</a>, <a class="el" href="http_8c_source.html#l00062">http_tls_cfg</a>, <a class="el" href="tcptls_8h_source.html#l00116">ast_tcptls_session_args::local_address</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="http_8c_source.html#l00055">MAX_PREFIX</a>, <a class="el" href="config_8h_source.html#l00075">ast_variable::name</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, <a class="el" href="tcptls_8h_source.html#l00120">ast_tcptls_session_args::tls_cfg</a>, and <a class="el" href="config_8h_source.html#l00076">ast_variable::value</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l01023">ast_http_init()</a>, and <a class="el" href="http_8c_source.html#l01014">ast_http_reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00849"></a>00849 {
<a name="l00850"></a>00850    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l00851"></a>00851    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l00852"></a>00852    <span class="keywordtype">int</span> <a class="code" href="devicestate_8c.html#a63be54a0beac1f5717217e1d9e629c71">enabled</a>=0;
<a name="l00853"></a>00853    <span class="keywordtype">int</span> newenablestatic=0;
<a name="l00854"></a>00854    <span class="keyword">struct </span>hostent *<a class="code" href="chan__skinny_8c.html#aa0f575fa3882aa394cc287edba645a35">hp</a>;
<a name="l00855"></a>00855    <span class="keyword">struct </span><a class="code" href="structast__hostent.html">ast_hostent</a> <a class="code" href="chan__skinny_8c.html#a9e435aef83f14da6d3d5ec44f821558e">ahp</a>;
<a name="l00856"></a>00856    <span class="keywordtype">char</span> newprefix[<a class="code" href="http_8c.html#aecb32037d29b6d4c9d903ba03b56f065">MAX_PREFIX</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00857"></a>00857    <span class="keywordtype">int</span> have_sslbindaddr = 0;
<a name="l00858"></a>00858    <span class="keyword">struct </span><a class="code" href="structhttp__uri__redirect.html">http_uri_redirect</a> *redirect;
<a name="l00859"></a>00859    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="app__rpt_8c.html#a1f57f20c1f46890828791a4827fe8752">config_flags</a> = { <a class="code" href="app__amd_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l00860"></a>00860 
<a name="l00861"></a>00861    cfg = <a class="code" href="config_8h.html#aab3eac8fa82a86a93c074deb7b77dbc9" title="Load a config file.">ast_config_load2</a>(<span class="stringliteral">&quot;http.conf&quot;</span>, <span class="stringliteral">&quot;http&quot;</span>, config_flags);
<a name="l00862"></a>00862    <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a> || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l00863"></a>00863       <span class="keywordflow">return</span> 0;
<a name="l00864"></a>00864    }
<a name="l00865"></a>00865 
<a name="l00866"></a>00866    <span class="comment">/* default values */</span>
<a name="l00867"></a>00867    memset(&amp;<a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>));
<a name="l00868"></a>00868    <a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_port = htons(8088);
<a name="l00869"></a>00869 
<a name="l00870"></a>00870    memset(&amp;<a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>));
<a name="l00871"></a>00871    <a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_port = htons(8089);
<a name="l00872"></a>00872 
<a name="l00873"></a>00873    <a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a> = 0;
<a name="l00874"></a>00874    <span class="keywordflow">if</span> (<a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a333dffcec025fcdbee0676476f401685">certfile</a>) {
<a name="l00875"></a>00875       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a333dffcec025fcdbee0676476f401685">certfile</a>);
<a name="l00876"></a>00876    }
<a name="l00877"></a>00877    <a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a333dffcec025fcdbee0676476f401685">certfile</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<a class="code" href="tcptls_8h.html#a1850a109f5255895d75980912723ae7c">AST_CERTFILE</a>);
<a name="l00878"></a>00878    <span class="keywordflow">if</span> (<a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a3d12e13733aa5172b5cb091fbf8ea478">cipher</a>) {
<a name="l00879"></a>00879       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a3d12e13733aa5172b5cb091fbf8ea478">cipher</a>);
<a name="l00880"></a>00880    }
<a name="l00881"></a>00881    <a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a3d12e13733aa5172b5cb091fbf8ea478">cipher</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00882"></a>00882 
<a name="l00883"></a>00883    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>);
<a name="l00884"></a>00884    <span class="keywordflow">while</span> ((redirect = <a class="code" href="linkedlists_8h.html#a3d3aa4fb3b4ba38ad8d6d255d97e037c">AST_RWLIST_REMOVE_HEAD</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>, entry))) {
<a name="l00885"></a>00885       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(redirect);
<a name="l00886"></a>00886    }
<a name="l00887"></a>00887    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>);
<a name="l00888"></a>00888 
<a name="l00889"></a>00889    <span class="keywordflow">if</span> (cfg) {
<a name="l00890"></a>00890       v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>);
<a name="l00891"></a>00891       <span class="keywordflow">for</span> (; v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00892"></a>00892          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;enabled&quot;</span>)) {
<a name="l00893"></a>00893             enabled = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00894"></a>00894          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;sslenable&quot;</span>)) {
<a name="l00895"></a>00895             <a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00896"></a>00896          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;sslbindport&quot;</span>)) {
<a name="l00897"></a>00897             <a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_port = htons(atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>));
<a name="l00898"></a>00898          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;sslcert&quot;</span>)) {
<a name="l00899"></a>00899             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a333dffcec025fcdbee0676476f401685">certfile</a>);
<a name="l00900"></a>00900             <a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a333dffcec025fcdbee0676476f401685">certfile</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00901"></a>00901          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;sslcipher&quot;</span>)) {
<a name="l00902"></a>00902             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a3d12e13733aa5172b5cb091fbf8ea478">cipher</a>);
<a name="l00903"></a>00903             <a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a3d12e13733aa5172b5cb091fbf8ea478">cipher</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00904"></a>00904          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;enablestatic&quot;</span>)) {
<a name="l00905"></a>00905             newenablestatic = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00906"></a>00906          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;bindport&quot;</span>)) {
<a name="l00907"></a>00907             <a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_port = htons(atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>));
<a name="l00908"></a>00908          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;sslbindaddr&quot;</span>)) {
<a name="l00909"></a>00909             <span class="keywordflow">if</span> ((hp = <a class="code" href="utils_8h.html#ad3b63ee1041593219ef0765b28d70442" title="Thread-safe gethostbyname function to use in Asterisk.">ast_gethostbyname</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, &amp;<a class="code" href="chan__skinny_8c.html#a9e435aef83f14da6d3d5ec44f821558e">ahp</a>))) {
<a name="l00910"></a>00910                memcpy(&amp;<a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_addr, hp-&gt;h_addr, <span class="keyword">sizeof</span>(<a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_addr));
<a name="l00911"></a>00911                have_sslbindaddr = 1;
<a name="l00912"></a>00912             } <span class="keywordflow">else</span> {
<a name="l00913"></a>00913                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid bind address &apos;%s&apos;\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00914"></a>00914             }
<a name="l00915"></a>00915          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;bindaddr&quot;</span>)) {
<a name="l00916"></a>00916             <span class="keywordflow">if</span> ((hp = <a class="code" href="utils_8h.html#ad3b63ee1041593219ef0765b28d70442" title="Thread-safe gethostbyname function to use in Asterisk.">ast_gethostbyname</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, &amp;<a class="code" href="chan__skinny_8c.html#a9e435aef83f14da6d3d5ec44f821558e">ahp</a>))) {
<a name="l00917"></a>00917                memcpy(&amp;<a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_addr, hp-&gt;h_addr, <span class="keyword">sizeof</span>(<a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_addr));
<a name="l00918"></a>00918             } <span class="keywordflow">else</span> {
<a name="l00919"></a>00919                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid bind address &apos;%s&apos;\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00920"></a>00920             }
<a name="l00921"></a>00921          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;prefix&quot;</span>)) {
<a name="l00922"></a>00922             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l00923"></a>00923                newprefix[0] = <span class="charliteral">&apos;/&apos;</span>;
<a name="l00924"></a>00924                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(newprefix + 1, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(newprefix) - 1);
<a name="l00925"></a>00925             } <span class="keywordflow">else</span> {
<a name="l00926"></a>00926                newprefix[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00927"></a>00927             }
<a name="l00928"></a>00928          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;redirect&quot;</span>)) {
<a name="l00929"></a>00929             <a class="code" href="http_8c.html#a50af5ddf9c9a9dd76f2a1203f50dafdd" title="Add a new URI redirect The entries in the redirect list are sorted by length, just...">add_redirect</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00930"></a>00930          } <span class="keywordflow">else</span> {
<a name="l00931"></a>00931             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Ignoring unknown option &apos;%s&apos; in http.conf\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00932"></a>00932          }
<a name="l00933"></a>00933       }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l00936"></a>00936    }
<a name="l00937"></a>00937 
<a name="l00938"></a>00938    <span class="keywordflow">if</span> (!have_sslbindaddr) {
<a name="l00939"></a>00939       <a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_addr = <a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_addr;
<a name="l00940"></a>00940    }
<a name="l00941"></a>00941    <span class="keywordflow">if</span> (enabled) {
<a name="l00942"></a>00942       <a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_family = <a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_family = AF_INET;
<a name="l00943"></a>00943    }
<a name="l00944"></a>00944    <span class="keywordflow">if</span> (strcmp(<a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>, newprefix)) {
<a name="l00945"></a>00945       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>, newprefix, <span class="keyword">sizeof</span>(<a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>));
<a name="l00946"></a>00946    }
<a name="l00947"></a>00947    <a class="code" href="http_8c.html#a0d575742490f0b0242cfeace49c81b16">enablestatic</a> = newenablestatic;
<a name="l00948"></a>00948    <a class="code" href="tcptls_8h.html#a29375a4482c8de1e9879b97be2e88bf0" title="This is a generic (re)start routine for a TCP server, which does the socket/bind/listen...">ast_tcptls_server_start</a>(&amp;<a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>);
<a name="l00949"></a>00949    <span class="keywordflow">if</span> (<a class="code" href="tcptls_8h.html#a24ff4bad1d2894ae3cae4e555d508fd0">ast_ssl_setup</a>(<a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>.<a class="code" href="structast__tcptls__session__args.html#aeb4a21e3ae033a326cc9dfd20a7ab074">tls_cfg</a>)) {
<a name="l00950"></a>00950       <a class="code" href="tcptls_8h.html#a29375a4482c8de1e9879b97be2e88bf0" title="This is a generic (re)start routine for a TCP server, which does the socket/bind/listen...">ast_tcptls_server_start</a>(&amp;<a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>);
<a name="l00951"></a>00951    }
<a name="l00952"></a>00952 
<a name="l00953"></a>00953    <span class="keywordflow">return</span> 0;
<a name="l00954"></a>00954 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a50af5ddf9c9a9dd76f2a1203f50dafdd"></a><!-- doxytag: member="http.c::add_redirect" ref="a50af5ddf9c9a9dd76f2a1203f50dafdd" args="(const char *value)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void add_redirect </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>value</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add a new URI redirect The entries in the redirect list are sorted by length, just like the list of URI handlers. </p>

<p>Definition at line <a class="el" href="http_8c_source.html#l00793">793</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="linkedlists_8h_source.html#l00451">AST_RWLIST_EMPTY</a>, <a class="el" href="linkedlists_8h_source.html#l00422">AST_RWLIST_FIRST</a>, <a class="el" href="linkedlists_8h_source.html#l00686">AST_RWLIST_INSERT_AFTER</a>, <a class="el" href="linkedlists_8h_source.html#l00702">AST_RWLIST_INSERT_HEAD</a>, <a class="el" href="linkedlists_8h_source.html#l00725">AST_RWLIST_INSERT_TAIL</a>, <a class="el" href="linkedlists_8h_source.html#l00440">AST_RWLIST_NEXT</a>, <a class="el" href="linkedlists_8h_source.html#l00493">AST_RWLIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>, <a class="el" href="strings_8h_source.html#l00092">ast_skip_blanks()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="http_8c_source.html#l00112">http_uri_redirect::dest</a>, <a class="el" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">http_uri_redirect::entry</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>, and <a class="el" href="http_8c_source.html#l00113">http_uri_redirect::target</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l00848">__ast_http_load()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00794"></a>00794 {
<a name="l00795"></a>00795    <span class="keywordtype">char</span> *target, *dest;
<a name="l00796"></a>00796    <span class="keyword">struct </span><a class="code" href="structhttp__uri__redirect.html">http_uri_redirect</a> *redirect, *cur;
<a name="l00797"></a>00797    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> target_len;
<a name="l00798"></a>00798    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> total_len;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800    dest = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(value);
<a name="l00801"></a>00801    dest = <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(dest);
<a name="l00802"></a>00802    target = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;dest, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00803"></a>00803    target = <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(target);
<a name="l00804"></a>00804    target = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;target, <span class="stringliteral">&quot; &quot;</span>); <span class="comment">/* trim trailing whitespace */</span>
<a name="l00805"></a>00805 
<a name="l00806"></a>00806    <span class="keywordflow">if</span> (!dest) {
<a name="l00807"></a>00807       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid redirect &apos;%s&apos;\n&quot;</span>, value);
<a name="l00808"></a>00808       <span class="keywordflow">return</span>;
<a name="l00809"></a>00809    }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811    target_len = strlen(target) + 1;
<a name="l00812"></a>00812    total_len = <span class="keyword">sizeof</span>(*redirect) + target_len + strlen(dest) + 1;
<a name="l00813"></a>00813 
<a name="l00814"></a>00814    <span class="keywordflow">if</span> (!(redirect = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, total_len))) {
<a name="l00815"></a>00815       <span class="keywordflow">return</span>;
<a name="l00816"></a>00816    }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818    redirect-&gt;<a class="code" href="structhttp__uri__redirect.html#a21b0374bf8175befbde3cf5ad4831c04">dest</a> = redirect-&gt;<a class="code" href="structhttp__uri__redirect.html#aa00cb69f785f055cd7b8eda63452666e">target</a> + target_len;
<a name="l00819"></a>00819    strcpy(redirect-&gt;<a class="code" href="structhttp__uri__redirect.html#aa00cb69f785f055cd7b8eda63452666e">target</a>, target);
<a name="l00820"></a>00820    strcpy(redirect-&gt;<a class="code" href="structhttp__uri__redirect.html#a21b0374bf8175befbde3cf5ad4831c04">dest</a>, dest);
<a name="l00821"></a>00821 
<a name="l00822"></a>00822    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>);
<a name="l00823"></a>00823 
<a name="l00824"></a>00824    target_len--; <span class="comment">/* So we can compare directly with strlen() */</span>
<a name="l00825"></a>00825    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a0044f6572f50a89049b3b5272e51b0e7">AST_RWLIST_EMPTY</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>) 
<a name="l00826"></a>00826        || strlen(<a class="code" href="linkedlists_8h.html#a64835fe6d570951b2a0404799c3d116f">AST_RWLIST_FIRST</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>)-&gt;target) &lt;= target_len) {
<a name="l00827"></a>00827       <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>, redirect, <a class="code" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">entry</a>);
<a name="l00828"></a>00828       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>);
<a name="l00829"></a>00829 
<a name="l00830"></a>00830       <span class="keywordflow">return</span>;
<a name="l00831"></a>00831    }
<a name="l00832"></a>00832 
<a name="l00833"></a>00833    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>, cur, <a class="code" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">entry</a>) {
<a name="l00834"></a>00834       <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a5c021d1e034a53d09360da4d95c76220">AST_RWLIST_NEXT</a>(cur, <a class="code" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">entry</a>) 
<a name="l00835"></a>00835           &amp;&amp; strlen(<a class="code" href="linkedlists_8h.html#a5c021d1e034a53d09360da4d95c76220">AST_RWLIST_NEXT</a>(cur, <a class="code" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">entry</a>)-&gt;target) &lt;= target_len) {
<a name="l00836"></a>00836          <a class="code" href="linkedlists_8h.html#a5937d72e8b39660a1b824af2042c0e9c">AST_RWLIST_INSERT_AFTER</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>, cur, redirect, <a class="code" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">entry</a>);
<a name="l00837"></a>00837          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>); 
<a name="l00838"></a>00838 
<a name="l00839"></a>00839          <span class="keywordflow">return</span>;
<a name="l00840"></a>00840       }
<a name="l00841"></a>00841    }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843    <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>, redirect, <a class="code" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">entry</a>);
<a name="l00844"></a>00844 
<a name="l00845"></a>00845    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>);
<a name="l00846"></a>00846 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a934683361438de9f78b6c88a6a106b46"></a><!-- doxytag: member="http.c::ast_http_error" ref="a934683361438de9f78b6c88a6a106b46" args="(int status, const char *title, const char *extra_header, const char *text)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__str.html">ast_str</a>* ast_http_error </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>status</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>title</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>extra_header</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>text</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Return an <a class="el" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> <a class="el" href="astmm_8h.html#ab8b25cd8f16d4a6552afe4e65c4f082d">malloc()</a>'d string containing an HTTP error <a class="el" href="structmessage.html">message</a>. </p>

<p>Definition at line <a class="el" href="http_8c_source.html#l00309">309</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, and <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>.</p>

<p>Referenced by <a class="el" href="manager_8c_source.html#l03804">generic_http_callback()</a>, <a class="el" href="http_8c_source.html#l00423">handle_uri()</a>, <a class="el" href="res__http__post_8c_source.html#l00296">http_post_callback()</a>, <a class="el" href="http_8c_source.html#l00659">httpd_helper_thread()</a>, <a class="el" href="res__phoneprov_8c_source.html#l00401">phoneprov_callback()</a>, and <a class="el" href="http_8c_source.html#l00154">static_callback()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00310"></a>00310 {
<a name="l00311"></a>00311    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *out = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(512);
<a name="l00312"></a>00312 
<a name="l00313"></a>00313    <span class="keywordflow">if</span> (out == NULL) {
<a name="l00314"></a>00314       <span class="keywordflow">return</span> out;
<a name="l00315"></a>00315    }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;out, 0,
<a name="l00318"></a>00318           <span class="stringliteral">&quot;Content-type: text/html\r\n&quot;</span>
<a name="l00319"></a>00319           <span class="stringliteral">&quot;%s&quot;</span>
<a name="l00320"></a>00320           <span class="stringliteral">&quot;\r\n&quot;</span>
<a name="l00321"></a>00321           <span class="stringliteral">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;-//IETF//DTD HTML 2.0//EN\&quot;&gt;\r\n&quot;</span>
<a name="l00322"></a>00322           <span class="stringliteral">&quot;&lt;html&gt;&lt;head&gt;\r\n&quot;</span>
<a name="l00323"></a>00323           <span class="stringliteral">&quot;&lt;title&gt;%d %s&lt;/title&gt;\r\n&quot;</span>
<a name="l00324"></a>00324           <span class="stringliteral">&quot;&lt;/head&gt;&lt;body&gt;\r\n&quot;</span>
<a name="l00325"></a>00325           <span class="stringliteral">&quot;&lt;h1&gt;%s&lt;/h1&gt;\r\n&quot;</span>
<a name="l00326"></a>00326           <span class="stringliteral">&quot;&lt;p&gt;%s&lt;/p&gt;\r\n&quot;</span>
<a name="l00327"></a>00327           <span class="stringliteral">&quot;&lt;hr /&gt;\r\n&quot;</span>
<a name="l00328"></a>00328           <span class="stringliteral">&quot;&lt;address&gt;Asterisk Server&lt;/address&gt;\r\n&quot;</span>
<a name="l00329"></a>00329           <span class="stringliteral">&quot;&lt;/body&gt;&lt;/html&gt;\r\n&quot;</span>,
<a name="l00330"></a>00330           (extra_header ? extra_header : <span class="stringliteral">&quot;&quot;</span>), <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>, title, title, <a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>);
<a name="l00331"></a>00331 
<a name="l00332"></a>00332    <span class="keywordflow">return</span> out;
<a name="l00333"></a>00333 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab02497431dec0900ac24fafa1c8599c6"></a><!-- doxytag: member="http.c::ast_http_init" ref="ab02497431dec0900ac24fafa1c8599c6" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_http_init </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Provided by <a class="el" href="http_8c.html" title="http server for AMI access">http.c</a> </p>

<p>Definition at line <a class="el" href="http_8c_source.html#l01023">1023</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="http_8c_source.html#l00848">__ast_http_load()</a>, <a class="el" href="isdn__lib_8c_source.html#l00040">ARRAY_LEN</a>, <a class="el" href="cli_8c_source.html#l01927">ast_cli_register_multiple()</a>, <a class="el" href="http_8c_source.html#l00344">ast_http_uri_link()</a>, <a class="el" href="http_8c_source.html#l01019">cli_http</a>, <a class="el" href="http_8c_source.html#l00298">staticuri</a>, and <a class="el" href="http_8c_source.html#l00289">statusuri</a>.</p>

<p>Referenced by <a class="el" href="asterisk_8c_source.html#l03095">main()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01024"></a>01024 {
<a name="l01025"></a>01025    <a class="code" href="http_8h.html#ac99d56925cf94f8cf3ed0acac52e2d75" title="Register a URI handler.">ast_http_uri_link</a>(&amp;<a class="code" href="http_8c.html#a092e39cea3cca5eca8cf40da0b7a47e1">statusuri</a>);
<a name="l01026"></a>01026    <a class="code" href="http_8h.html#ac99d56925cf94f8cf3ed0acac52e2d75" title="Register a URI handler.">ast_http_uri_link</a>(&amp;<a class="code" href="http_8c.html#ae59ae7f4b3e145d3d7468113fd4166ff">staticuri</a>);
<a name="l01027"></a>01027    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="http_8c.html#a62ac5f089c743a2d4113e518818000fa">cli_http</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="http_8c.html#a62ac5f089c743a2d4113e518818000fa">cli_http</a>));
<a name="l01028"></a>01028 
<a name="l01029"></a>01029    <span class="keywordflow">return</span> <a class="code" href="http_8c.html#a3ce71802a2d0296a3478fcfeb3c21aac">__ast_http_load</a>(0);
<a name="l01030"></a>01030 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0059c10f2538cfa09f9979d5fefd5638"></a><!-- doxytag: member="http.c::ast_http_prefix" ref="a0059c10f2538cfa09f9979d5fefd5638" args="(char *buf, int len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_http_prefix </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Return the current prefix. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buf[out]</em>&nbsp;</td><td>destination buffer for previous </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>len[in]</em>&nbsp;</td><td>length of prefix to copy </td></tr>
  </table>
  </dd>
</dl>
<dl class="since"><dt><b>Since:</b></dt><dd>1.6.1 </dd></dl>

<p>Definition at line <a class="el" href="http_8c_source.html#l00147">147</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00148"></a>00148 {
<a name="l00149"></a>00149    <span class="keywordflow">if</span> (<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>) {
<a name="l00150"></a>00150       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l00151"></a>00151    }
<a name="l00152"></a>00152 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5998a3b542a4d15b6102bfe9e005de76"></a><!-- doxytag: member="http.c::ast_http_reload" ref="a5998a3b542a4d15b6102bfe9e005de76" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_http_reload </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Provided by <a class="el" href="http_8c.html" title="http server for AMI access">http.c</a> </p>

<p>Definition at line <a class="el" href="http_8c_source.html#l01014">1014</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="http_8c_source.html#l00848">__ast_http_load()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01015"></a>01015 {
<a name="l01016"></a>01016    <span class="keywordflow">return</span> <a class="code" href="http_8c.html#a3ce71802a2d0296a3478fcfeb3c21aac">__ast_http_load</a>(1);
<a name="l01017"></a>01017 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5b30188fccd09ea5f099a088b325a190"></a><!-- doxytag: member="http.c::ast_http_uri_link" ref="a5b30188fccd09ea5f099a088b325a190" args="(struct ast_http_uri *urih)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_http_uri_link </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *&nbsp;</td>
          <td class="paramname"> <em>urih</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Link the new uri into the list. </p>
<p>Register a URI handler.</p>
<p>They are sorted by length of the string, not alphabetically. Duplicate entries are not replaced, but the insertion order (using &lt;= and not just &lt;) makes sure that more recent insertions hide older ones. On a lookup, we just scan the list and stop at the first matching entry. </p>

<p>Definition at line <a class="el" href="http_8c_source.html#l00344">344</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="linkedlists_8h_source.html#l00451">AST_RWLIST_EMPTY</a>, <a class="el" href="linkedlists_8h_source.html#l00422">AST_RWLIST_FIRST</a>, <a class="el" href="linkedlists_8h_source.html#l00686">AST_RWLIST_INSERT_AFTER</a>, <a class="el" href="linkedlists_8h_source.html#l00702">AST_RWLIST_INSERT_HEAD</a>, <a class="el" href="linkedlists_8h_source.html#l00725">AST_RWLIST_INSERT_TAIL</a>, <a class="el" href="linkedlists_8h_source.html#l00440">AST_RWLIST_NEXT</a>, <a class="el" href="linkedlists_8h_source.html#l00493">AST_RWLIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>, <a class="el" href="http_8h_source.html#l00080">ast_http_uri::description</a>, <a class="el" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">http_uri_redirect::entry</a>, <a class="el" href="func__strings_8c_source.html#l00821">len()</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="http_8h_source.html#l00087">ast_http_uri::supports_get</a>, <a class="el" href="http_8h_source.html#l00089">ast_http_uri::supports_post</a>, and <a class="el" href="http_8h_source.html#l00081">ast_http_uri::uri</a>.</p>

<p>Referenced by <a class="el" href="res__http__post_8c_source.html#l00408">__ast_http_post_load()</a>, <a class="el" href="manager_8c_source.html#l04061">__init_manager()</a>, <a class="el" href="http_8c_source.html#l01023">ast_http_init()</a>, and <a class="el" href="res__phoneprov_8c_source.html#l01250">load_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00345"></a>00345 {
<a name="l00346"></a>00346    <span class="keyword">struct </span><a class="code" href="structast__http__uri.html" title="Definition of a URI handler.">ast_http_uri</a> *<a class="code" href="structast__http__uri.html#a69ec24fb2d0a5f5e532deb9adaab81d6">uri</a>;
<a name="l00347"></a>00347    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(urih-&gt;<a class="code" href="structast__http__uri.html#a69ec24fb2d0a5f5e532deb9adaab81d6">uri</a>);
<a name="l00348"></a>00348 
<a name="l00349"></a>00349    <span class="keywordflow">if</span> (!(urih-&gt;<a class="code" href="structast__http__uri.html#aefc8e8b7c3d28c7cf42196597cb4c281">supports_get</a> || urih-&gt;<a class="code" href="structast__http__uri.html#a79428a579d69a59c104cf74df85577dd">supports_post</a>)) {
<a name="l00350"></a>00350       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;URI handler does not provide either GET or POST method: %s (%s)\n&quot;</span>, urih-&gt;<a class="code" href="structast__http__uri.html#a69ec24fb2d0a5f5e532deb9adaab81d6">uri</a>, urih-&gt;<a class="code" href="structast__http__uri.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a>);
<a name="l00351"></a>00351       <span class="keywordflow">return</span> -1;
<a name="l00352"></a>00352    }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a0044f6572f50a89049b3b5272e51b0e7">AST_RWLIST_EMPTY</a>(&amp;<a class="code" href="structuris.html">uris</a>) || strlen(<a class="code" href="linkedlists_8h.html#a64835fe6d570951b2a0404799c3d116f">AST_RWLIST_FIRST</a>(&amp;<a class="code" href="structuris.html">uris</a>)-&gt;uri) &lt;= len) {
<a name="l00357"></a>00357       <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;<a class="code" href="structuris.html">uris</a>, urih, entry);
<a name="l00358"></a>00358       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>);
<a name="l00359"></a>00359 
<a name="l00360"></a>00360       <span class="keywordflow">return</span> 0;
<a name="l00361"></a>00361    }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structuris.html">uris</a>, uri, entry) {
<a name="l00364"></a>00364       <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a5c021d1e034a53d09360da4d95c76220">AST_RWLIST_NEXT</a>(uri, entry) &amp;&amp;
<a name="l00365"></a>00365           strlen(<a class="code" href="linkedlists_8h.html#a5c021d1e034a53d09360da4d95c76220">AST_RWLIST_NEXT</a>(uri, entry)-&gt;uri) &lt;= len) {
<a name="l00366"></a>00366          <a class="code" href="linkedlists_8h.html#a5937d72e8b39660a1b824af2042c0e9c">AST_RWLIST_INSERT_AFTER</a>(&amp;<a class="code" href="structuris.html">uris</a>, uri, urih, entry);
<a name="l00367"></a>00367          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>); 
<a name="l00368"></a>00368 
<a name="l00369"></a>00369          <span class="keywordflow">return</span> 0;
<a name="l00370"></a>00370       }
<a name="l00371"></a>00371    }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373    <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;<a class="code" href="structuris.html">uris</a>, urih, entry);
<a name="l00374"></a>00374 
<a name="l00375"></a>00375    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>);
<a name="l00376"></a>00376    
<a name="l00377"></a>00377    <span class="keywordflow">return</span> 0;
<a name="l00378"></a>00378 }  
</pre></div></p>

</div>
</div>
<a class="anchor" id="abc4e71c538d9c1ad56b8e4a2e46bed35"></a><!-- doxytag: member="http.c::ast_http_uri_unlink" ref="abc4e71c538d9c1ad56b8e4a2e46bed35" args="(struct ast_http_uri *urih)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_http_uri_unlink </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *&nbsp;</td>
          <td class="paramname"> <em>urih</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Unregister a URI handler. </p>

<p>Definition at line <a class="el" href="http_8c_source.html#l00380">380</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="linkedlists_8h_source.html#l00860">AST_RWLIST_REMOVE</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>, and <a class="el" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">http_uri_redirect::entry</a>.</p>

<p>Referenced by <a class="el" href="manager_8c_source.html#l04061">__init_manager()</a>, and <a class="el" href="res__phoneprov_8c_source.html#l01271">unload_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00381"></a>00381 {
<a name="l00382"></a>00382    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>);
<a name="l00383"></a>00383    <a class="code" href="linkedlists_8h.html#a6091f0518f8b6f443fd9f5150f3ac407">AST_RWLIST_REMOVE</a>(&amp;<a class="code" href="structuris.html">uris</a>, urih, entry);
<a name="l00384"></a>00384    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>);
<a name="l00385"></a>00385 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae05bfd31702ddfd156bd1312ccbf2441"></a><!-- doxytag: member="http.c::ast_http_uri_unlink_all_with_key" ref="ae05bfd31702ddfd156bd1312ccbf2441" args="(const char *key)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_http_uri_unlink_all_with_key </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>key</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Unregister all handlers with matching key. </p>

<p>Definition at line <a class="el" href="http_8c_source.html#l00387">387</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="linkedlists_8h_source.html#l00564">AST_RWLIST_REMOVE_CURRENT</a>, <a class="el" href="linkedlists_8h_source.html#l00541">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>, <a class="el" href="linkedlists_8h_source.html#l00601">AST_RWLIST_TRAVERSE_SAFE_END</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>, <a class="el" href="http_8h_source.html#l00095">ast_http_uri::data</a>, <a class="el" href="http_8h_source.html#l00093">ast_http_uri::dmallocd</a>, <a class="el" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">http_uri_redirect::entry</a>, <a class="el" href="http_8h_source.html#l00097">ast_http_uri::key</a>, and <a class="el" href="http_8h_source.html#l00091">ast_http_uri::mallocd</a>.</p>

<p>Referenced by <a class="el" href="res__http__post_8c_source.html#l00408">__ast_http_post_load()</a>, and <a class="el" href="res__http__post_8c_source.html#l00467">unload_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00388"></a>00388 {
<a name="l00389"></a>00389    <span class="keyword">struct </span><a class="code" href="structast__http__uri.html" title="Definition of a URI handler.">ast_http_uri</a> *urih;
<a name="l00390"></a>00390    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>);
<a name="l00391"></a>00391    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structuris.html">uris</a>, urih, entry) {
<a name="l00392"></a>00392       <span class="keywordflow">if</span> (!strcmp(urih-&gt;<a class="code" href="structast__http__uri.html#acd3d88da3c0e0313c3645ff34f62f542">key</a>, <a class="code" href="structast__http__uri.html#acd3d88da3c0e0313c3645ff34f62f542">key</a>)) {
<a name="l00393"></a>00393          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(entry);
<a name="l00394"></a>00394       }
<a name="l00395"></a>00395       <span class="keywordflow">if</span> (urih-&gt;<a class="code" href="structast__http__uri.html#a55ab2ed9aeff792462e0efe00685b7d6">dmallocd</a>) {
<a name="l00396"></a>00396          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(urih-&gt;<a class="code" href="structast__http__uri.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l00397"></a>00397       }
<a name="l00398"></a>00398       <span class="keywordflow">if</span> (urih-&gt;<a class="code" href="structast__http__uri.html#ae6cd4621862105820006f1c6ba56e427">mallocd</a>) {
<a name="l00399"></a>00399          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(urih);
<a name="l00400"></a>00400       }
<a name="l00401"></a>00401    }
<a name="l00402"></a>00402    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l00403"></a>00403    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>);
<a name="l00404"></a>00404 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="afc08b749db765fdf2c6e2a2e9593a6fe"></a><!-- doxytag: member="http.c::ftype2mtype" ref="afc08b749db765fdf2c6e2a2e9593a6fe" args="(const char *ftype, char *wkspace, int wkspacelen)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static const char* ftype2mtype </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>ftype</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>wkspace</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>wkspacelen</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00118">118</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="isdn__lib_8c_source.html#l00040">ARRAY_LEN</a>, <a class="el" href="http_8c_source.html#l00097">ext</a>, <a class="el" href="http_8c.html#a2ebb3c927f9a7eaf360284a393806e85">mimetypes</a>, and <a class="el" href="strings_8h_source.html#l00072">S_OR</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l00154">static_callback()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00119"></a>00119 {
<a name="l00120"></a>00120    <span class="keywordtype">int</span> x;
<a name="l00121"></a>00121 
<a name="l00122"></a>00122    <span class="keywordflow">if</span> (ftype) {
<a name="l00123"></a>00123       <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="http_8c.html#a2ebb3c927f9a7eaf360284a393806e85" title="Limit the kinds of files we&amp;#39;re willing to serve up.">mimetypes</a>); x++) {
<a name="l00124"></a>00124          <span class="keywordflow">if</span> (!strcasecmp(ftype, <a class="code" href="http_8c.html#a2ebb3c927f9a7eaf360284a393806e85" title="Limit the kinds of files we&amp;#39;re willing to serve up.">mimetypes</a>[x].<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>)) {
<a name="l00125"></a>00125             <span class="keywordflow">return</span> <a class="code" href="http_8c.html#a2ebb3c927f9a7eaf360284a393806e85" title="Limit the kinds of files we&amp;#39;re willing to serve up.">mimetypes</a>[x].mtype;
<a name="l00126"></a>00126          }
<a name="l00127"></a>00127       }
<a name="l00128"></a>00128    }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130    snprintf(wkspace, wkspacelen, <span class="stringliteral">&quot;text/%s&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(ftype, <span class="stringliteral">&quot;plain&quot;</span>));
<a name="l00131"></a>00131 
<a name="l00132"></a>00132    <span class="keywordflow">return</span> wkspace;
<a name="l00133"></a>00133 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="abd384ccb6510fda645ef76636af6642a"></a><!-- doxytag: member="http.c::handle_show_http" ref="abd384ccb6510fda645ef76636af6642a" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_show_http </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00956">956</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="utils_8c_source.html#l00431">ast_inet_ntoa()</a>, <a class="el" href="linkedlists_8h_source.html#l00451">AST_RWLIST_EMPTY</a>, <a class="el" href="linkedlists_8h_source.html#l00077">AST_RWLIST_RDLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00493">AST_RWLIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="http_8h_source.html#l00080">ast_http_uri::description</a>, <a class="el" href="http_8c_source.html#l00112">http_uri_redirect::dest</a>, <a class="el" href="tcptls_8h_source.html#l00079">ast_tls_config::enabled</a>, <a class="el" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">http_uri_redirect::entry</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="http_8h_source.html#l00083">ast_http_uri::has_subtree</a>, <a class="el" href="http_8c_source.html#l00062">http_tls_cfg</a>, <a class="el" href="tcptls_8h_source.html#l00117">ast_tcptls_session_args::old_address</a>, <a class="el" href="http_8c_source.html#l00113">http_uri_redirect::target</a>, <a class="el" href="http_8h_source.html#l00081">ast_http_uri::uri</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00957"></a>00957 {
<a name="l00958"></a>00958    <span class="keyword">struct </span><a class="code" href="structast__http__uri.html" title="Definition of a URI handler.">ast_http_uri</a> *urih;
<a name="l00959"></a>00959    <span class="keyword">struct </span><a class="code" href="structhttp__uri__redirect.html">http_uri_redirect</a> *redirect;
<a name="l00960"></a>00960 
<a name="l00961"></a>00961    <span class="keywordflow">switch</span> (cmd) {
<a name="l00962"></a>00962    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00963"></a>00963       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;http show status&quot;</span>;
<a name="l00964"></a>00964       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l00965"></a>00965          <span class="stringliteral">&quot;Usage: http show status\n&quot;</span>
<a name="l00966"></a>00966          <span class="stringliteral">&quot;       Lists status of internal HTTP engine\n&quot;</span>;
<a name="l00967"></a>00967       <span class="keywordflow">return</span> NULL;
<a name="l00968"></a>00968    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00969"></a>00969       <span class="keywordflow">return</span> NULL;
<a name="l00970"></a>00970    }
<a name="l00971"></a>00971    
<a name="l00972"></a>00972    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3) {
<a name="l00973"></a>00973       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00974"></a>00974    }
<a name="l00975"></a>00975    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;HTTP Server Status:\n&quot;</span>);
<a name="l00976"></a>00976    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Prefix: %s\n&quot;</span>, <a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>);
<a name="l00977"></a>00977    <span class="keywordflow">if</span> (!<a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a>.sin_family) {
<a name="l00978"></a>00978       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Server Disabled\n\n&quot;</span>);
<a name="l00979"></a>00979    } <span class="keywordflow">else</span> {
<a name="l00980"></a>00980       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Server Enabled and Bound to %s:%d\n\n&quot;</span>,
<a name="l00981"></a>00981          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a>.sin_addr),
<a name="l00982"></a>00982          ntohs(<a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a>.sin_port));
<a name="l00983"></a>00983       <span class="keywordflow">if</span> (<a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a>) {
<a name="l00984"></a>00984          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;HTTPS Server Enabled and Bound to %s:%d\n\n&quot;</span>,
<a name="l00985"></a>00985             <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a>.sin_addr),
<a name="l00986"></a>00986             ntohs(<a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a>.sin_port));
<a name="l00987"></a>00987       }
<a name="l00988"></a>00988    }
<a name="l00989"></a>00989 
<a name="l00990"></a>00990    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Enabled URI&apos;s:\n&quot;</span>);
<a name="l00991"></a>00991    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>);
<a name="l00992"></a>00992    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a0044f6572f50a89049b3b5272e51b0e7">AST_RWLIST_EMPTY</a>(&amp;<a class="code" href="structuris.html">uris</a>)) {
<a name="l00993"></a>00993       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;None.\n&quot;</span>);
<a name="l00994"></a>00994    } <span class="keywordflow">else</span> {
<a name="l00995"></a>00995       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structuris.html">uris</a>, urih, <a class="code" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">entry</a>) {
<a name="l00996"></a>00996          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s/%s%s =&gt; %s\n&quot;</span>, <a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>, urih-&gt;<a class="code" href="structast__http__uri.html#a69ec24fb2d0a5f5e532deb9adaab81d6">uri</a>, (urih-&gt;<a class="code" href="structast__http__uri.html#a208647b07f25afba1725ed60eefb98ac">has_subtree</a> ? <span class="stringliteral">&quot;/...&quot;</span> : <span class="stringliteral">&quot;&quot;</span>), urih-&gt;<a class="code" href="structast__http__uri.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a>);
<a name="l00997"></a>00997       }
<a name="l00998"></a>00998    }
<a name="l00999"></a>00999    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>);
<a name="l01000"></a>01000 
<a name="l01001"></a>01001    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\nEnabled Redirects:\n&quot;</span>);
<a name="l01002"></a>01002    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>);
<a name="l01003"></a>01003    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>, redirect, <a class="code" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">entry</a>) {
<a name="l01004"></a>01004       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  %s =&gt; %s\n&quot;</span>, redirect-&gt;<a class="code" href="structhttp__uri__redirect.html#aa00cb69f785f055cd7b8eda63452666e">target</a>, redirect-&gt;<a class="code" href="structhttp__uri__redirect.html#a21b0374bf8175befbde3cf5ad4831c04">dest</a>);
<a name="l01005"></a>01005    }
<a name="l01006"></a>01006    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a0044f6572f50a89049b3b5272e51b0e7">AST_RWLIST_EMPTY</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>)) {
<a name="l01007"></a>01007       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  None.\n&quot;</span>);
<a name="l01008"></a>01008    }
<a name="l01009"></a>01009    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>);
<a name="l01010"></a>01010 
<a name="l01011"></a>01011    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01012"></a>01012 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9265ccf674be7c051596c0da7ea30201"></a><!-- doxytag: member="http.c::handle_uri" ref="a9265ccf674be7c051596c0da7ea30201" args="(struct ast_tcptls_session_instance *ser, char *uri, enum ast_http_method method, int *status, char **title, int *contentlength, struct ast_variable **cookies, struct ast_variable *headers, unsigned int *static_content)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__str.html">ast_str</a>* handle_uri </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *&nbsp;</td>
          <td class="paramname"> <em>ser</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>uri</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80ef">ast_http_method</a>&nbsp;</td>
          <td class="paramname"> <em>method</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>status</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&nbsp;</td>
          <td class="paramname"> <em>title</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>contentlength</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__variable.html">ast_variable</a> **&nbsp;</td>
          <td class="paramname"> <em>cookies</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td>
          <td class="paramname"> <em>headers</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int *&nbsp;</td>
          <td class="paramname"> <em>static_content</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00423">423</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="http_8c_source.html#l00309">ast_http_error()</a>, <a class="el" href="http_8h_source.html#l00070">AST_HTTP_GET</a>, <a class="el" href="http_8h_source.html#l00071">AST_HTTP_POST</a>, <a class="el" href="linkedlists_8h_source.html#l00077">AST_RWLIST_RDLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00493">AST_RWLIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="astmm_8h_source.html#l00099">ast_strdup</a>, <a class="el" href="config_8c_source.html#l00223">ast_variable_new()</a>, <a class="el" href="config_8c_source.html#l00397">ast_variables_destroy()</a>, <a class="el" href="manager_8c_source.html#l03521">astman_is_authed()</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="http_8h_source.html#l00082">ast_http_uri::callback</a>, <a class="el" href="pbx__gtkconsole_8c_source.html#l00088">cleanup()</a>, <a class="el" href="http_8c_source.html#l00112">http_uri_redirect::dest</a>, <a class="el" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">http_uri_redirect::entry</a>, <a class="el" href="http_8h_source.html#l00083">ast_http_uri::has_subtree</a>, <a class="el" href="http_8c_source.html#l00411">http_decode()</a>, <a class="el" href="http_8c_source.html#l00135">manid_from_vars()</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, <a class="el" href="http_8h_source.html#l00085">ast_http_uri::static_content</a>, <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>, <a class="el" href="http_8h_source.html#l00087">ast_http_uri::supports_get</a>, <a class="el" href="http_8h_source.html#l00089">ast_http_uri::supports_post</a>, <a class="el" href="http_8c_source.html#l00113">http_uri_redirect::target</a>, <a class="el" href="http_8h_source.html#l00081">ast_http_uri::uri</a>, and <a class="el" href="ast__expr2f_8c_source.html#l00613">var</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l00659">httpd_helper_thread()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00426"></a>00426 {
<a name="l00427"></a>00427    <span class="keywordtype">char</span> *c;
<a name="l00428"></a>00428    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *out = NULL;
<a name="l00429"></a>00429    <span class="keywordtype">char</span> *params = uri;
<a name="l00430"></a>00430    <span class="keyword">struct </span><a class="code" href="structast__http__uri.html" title="Definition of a URI handler.">ast_http_uri</a> *urih = NULL;
<a name="l00431"></a>00431    <span class="keywordtype">int</span> l;
<a name="l00432"></a>00432    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *vars = NULL, *v, *prev = NULL;
<a name="l00433"></a>00433    <span class="keyword">struct </span><a class="code" href="structhttp__uri__redirect.html">http_uri_redirect</a> *redirect;
<a name="l00434"></a>00434    <span class="keywordtype">int</span> saw_method = 0;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436    <span class="comment">/* preserve previous behavior of only support URI parameters on GET requests */</span>
<a name="l00437"></a>00437    <span class="keywordflow">if</span> (method == <a class="code" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80efa74b1cb5c2ecb5e0bd9af5d46a7b78fd2">AST_HTTP_GET</a>) {
<a name="l00438"></a>00438       <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;params, <span class="stringliteral">&quot;?&quot;</span>);
<a name="l00439"></a>00439       
<a name="l00440"></a>00440       <span class="comment">/* Extract arguments from the request and store them in variables.</span>
<a name="l00441"></a>00441 <span class="comment">       * Note that a request can have multiple arguments with the same</span>
<a name="l00442"></a>00442 <span class="comment">       * name, and we store them all in the list of variables.</span>
<a name="l00443"></a>00443 <span class="comment">       * It is up to the application to handle multiple values.</span>
<a name="l00444"></a>00444 <span class="comment">       */</span>
<a name="l00445"></a>00445       <span class="keywordflow">if</span> (params) {
<a name="l00446"></a>00446          <span class="keywordtype">char</span> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *<a class="code" href="structval.html">val</a>;
<a name="l00447"></a>00447          
<a name="l00448"></a>00448          <span class="keywordflow">while</span> ((val = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;params, <span class="stringliteral">&quot;&amp;&quot;</span>))) {
<a name="l00449"></a>00449             var = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;val, <span class="stringliteral">&quot;=&quot;</span>);
<a name="l00450"></a>00450             <span class="keywordflow">if</span> (val) {
<a name="l00451"></a>00451                <a class="code" href="http_8c.html#ae57381d7764de9906ba0ce595fe0fa0f">http_decode</a>(val);
<a name="l00452"></a>00452             } <span class="keywordflow">else</span> {
<a name="l00453"></a>00453                val = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00454"></a>00454             }
<a name="l00455"></a>00455             <a class="code" href="http_8c.html#ae57381d7764de9906ba0ce595fe0fa0f">http_decode</a>(var);
<a name="l00456"></a>00456             <span class="keywordflow">if</span> ((v = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(var, val, <span class="stringliteral">&quot;&quot;</span>))) {
<a name="l00457"></a>00457                <span class="keywordflow">if</span> (vars) {
<a name="l00458"></a>00458                   prev-&gt;next = v;
<a name="l00459"></a>00459                } <span class="keywordflow">else</span> {
<a name="l00460"></a>00460                   vars = v;
<a name="l00461"></a>00461                }
<a name="l00462"></a>00462                prev = v;
<a name="l00463"></a>00463             }
<a name="l00464"></a>00464          }
<a name="l00465"></a>00465       }
<a name="l00466"></a>00466    }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468    <span class="comment">/*</span>
<a name="l00469"></a>00469 <span class="comment">    * Append the cookies to the list of variables.</span>
<a name="l00470"></a>00470 <span class="comment">    * This saves a pass in the cookies list, but has the side effect</span>
<a name="l00471"></a>00471 <span class="comment">    * that a variable might mask a cookie with the same name if the</span>
<a name="l00472"></a>00472 <span class="comment">    * application stops at the first match.</span>
<a name="l00473"></a>00473 <span class="comment">    * Note that this is the same behaviour as $_REQUEST variables in PHP.</span>
<a name="l00474"></a>00474 <span class="comment">    */</span>
<a name="l00475"></a>00475    <span class="keywordflow">if</span> (prev) {
<a name="l00476"></a>00476       prev-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a> = *cookies;
<a name="l00477"></a>00477    } <span class="keywordflow">else</span> {
<a name="l00478"></a>00478       vars = *cookies;
<a name="l00479"></a>00479    }
<a name="l00480"></a>00480    *cookies = NULL;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482    <a class="code" href="http_8c.html#ae57381d7764de9906ba0ce595fe0fa0f">http_decode</a>(uri);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>);
<a name="l00485"></a>00485    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>, redirect, <a class="code" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">entry</a>) {
<a name="l00486"></a>00486       <span class="keywordflow">if</span> (!strcasecmp(uri, redirect-&gt;<a class="code" href="structhttp__uri__redirect.html#aa00cb69f785f055cd7b8eda63452666e">target</a>)) {
<a name="l00487"></a>00487          <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[512];
<a name="l00488"></a>00488 
<a name="l00489"></a>00489          snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;Location: %s\r\n&quot;</span>, redirect-&gt;<a class="code" href="structhttp__uri__redirect.html#a21b0374bf8175befbde3cf5ad4831c04">dest</a>);
<a name="l00490"></a>00490          out = <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 302),
<a name="l00491"></a>00491                     (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;Moved Temporarily&quot;</span>)),
<a name="l00492"></a>00492                     buf, <span class="stringliteral">&quot;Redirecting...&quot;</span>);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494          <span class="keywordflow">break</span>;
<a name="l00495"></a>00495       }
<a name="l00496"></a>00496    }
<a name="l00497"></a>00497    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuri__redirects.html">uri_redirects</a>);
<a name="l00498"></a>00498 
<a name="l00499"></a>00499    <span class="keywordflow">if</span> (redirect) {
<a name="l00500"></a>00500       <span class="keywordflow">goto</span> <a class="code" href="pbx__gtkconsole_8c.html#ae553432d9c2050cb69863126759710e4">cleanup</a>;
<a name="l00501"></a>00501    }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503    <span class="comment">/* We want requests to start with the (optional) prefix and &apos;/&apos; */</span>
<a name="l00504"></a>00504    l = strlen(<a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>);
<a name="l00505"></a>00505    <span class="keywordflow">if</span> (!strncasecmp(uri, <a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>, l) &amp;&amp; uri[l] == <span class="charliteral">&apos;/&apos;</span>) {
<a name="l00506"></a>00506       uri += l + 1;
<a name="l00507"></a>00507       <span class="comment">/* scan registered uris to see if we match one. */</span>
<a name="l00508"></a>00508       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>);
<a name="l00509"></a>00509       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structuris.html">uris</a>, urih, <a class="code" href="structhttp__uri__redirect.html#a09c38895cda29616adf65bdaeb13a36a">entry</a>) {
<a name="l00510"></a>00510          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;match request [%s] with handler [%s] len %d\n&quot;</span>, uri, urih-&gt;<a class="code" href="structast__http__uri.html#a69ec24fb2d0a5f5e532deb9adaab81d6">uri</a>, l);
<a name="l00511"></a>00511          <span class="keywordflow">if</span> (!saw_method) {
<a name="l00512"></a>00512             <span class="keywordflow">switch</span> (method) {
<a name="l00513"></a>00513             <span class="keywordflow">case</span> <a class="code" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80efa74b1cb5c2ecb5e0bd9af5d46a7b78fd2">AST_HTTP_GET</a>:
<a name="l00514"></a>00514                <span class="keywordflow">if</span> (urih-&gt;<a class="code" href="structast__http__uri.html#aefc8e8b7c3d28c7cf42196597cb4c281">supports_get</a>) {
<a name="l00515"></a>00515                   saw_method = 1;
<a name="l00516"></a>00516                }
<a name="l00517"></a>00517                <span class="keywordflow">break</span>;
<a name="l00518"></a>00518             <span class="keywordflow">case</span> <a class="code" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80efa544b9492daf28b47937772ca54e31c80">AST_HTTP_POST</a>:
<a name="l00519"></a>00519                <span class="keywordflow">if</span> (urih-&gt;<a class="code" href="structast__http__uri.html#a79428a579d69a59c104cf74df85577dd">supports_post</a>) {
<a name="l00520"></a>00520                   saw_method = 1;
<a name="l00521"></a>00521                }
<a name="l00522"></a>00522                <span class="keywordflow">break</span>;
<a name="l00523"></a>00523             }
<a name="l00524"></a>00524          }
<a name="l00525"></a>00525 
<a name="l00526"></a>00526          l = strlen(urih-&gt;<a class="code" href="structast__http__uri.html#a69ec24fb2d0a5f5e532deb9adaab81d6">uri</a>);
<a name="l00527"></a>00527          c = uri + l;   <span class="comment">/* candidate */</span>
<a name="l00528"></a>00528 
<a name="l00529"></a>00529          <span class="keywordflow">if</span> (strncasecmp(urih-&gt;<a class="code" href="structast__http__uri.html#a69ec24fb2d0a5f5e532deb9adaab81d6">uri</a>, uri, l) || <span class="comment">/* no match */</span>
<a name="l00530"></a>00530              (*c &amp;&amp; *c != <span class="charliteral">&apos;/&apos;</span>)) { <span class="comment">/* substring */</span>
<a name="l00531"></a>00531             <span class="keywordflow">continue</span>;
<a name="l00532"></a>00532          }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534          <span class="keywordflow">if</span> (*c == <span class="charliteral">&apos;/&apos;</span>) {
<a name="l00535"></a>00535             c++;
<a name="l00536"></a>00536          }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538          <span class="keywordflow">if</span> (!*c || urih-&gt;<a class="code" href="structast__http__uri.html#a208647b07f25afba1725ed60eefb98ac">has_subtree</a>) {
<a name="l00539"></a>00539             <span class="keywordflow">if</span> (((method == <a class="code" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80efa74b1cb5c2ecb5e0bd9af5d46a7b78fd2">AST_HTTP_GET</a>) &amp;&amp; urih-&gt;<a class="code" href="structast__http__uri.html#aefc8e8b7c3d28c7cf42196597cb4c281">supports_get</a>) ||
<a name="l00540"></a>00540                 ((method == <a class="code" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80efa544b9492daf28b47937772ca54e31c80">AST_HTTP_POST</a>) &amp;&amp; urih-&gt;<a class="code" href="structast__http__uri.html#a79428a579d69a59c104cf74df85577dd">supports_post</a>)) {
<a name="l00541"></a>00541                uri = c;
<a name="l00542"></a>00542 
<a name="l00543"></a>00543                <span class="keywordflow">break</span>;
<a name="l00544"></a>00544             }
<a name="l00545"></a>00545          }
<a name="l00546"></a>00546       }
<a name="l00547"></a>00547 
<a name="l00548"></a>00548       <span class="keywordflow">if</span> (!urih) {
<a name="l00549"></a>00549          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>);
<a name="l00550"></a>00550       }
<a name="l00551"></a>00551    }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553    <span class="keywordflow">if</span> (method == <a class="code" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80efa544b9492daf28b47937772ca54e31c80">AST_HTTP_POST</a> &amp;&amp; !<a class="code" href="manager_8h.html#acb49e15f3ae80cc0ee0cfa3a250d00c0" title="Determinie if a manager session ident is authenticated.">astman_is_authed</a>(<a class="code" href="http_8c.html#ad581b301a954f309d107108bfac61775">manid_from_vars</a>(vars))) {
<a name="l00554"></a>00554       out = <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 403),
<a name="l00555"></a>00555                (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;Access Denied&quot;</span>)),
<a name="l00556"></a>00556                NULL, <span class="stringliteral">&quot;You do not have permission to access the requested URL.&quot;</span>);
<a name="l00557"></a>00557    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (urih) {
<a name="l00558"></a>00558       *static_content = urih-&gt;<a class="code" href="structast__http__uri.html#aea3489981d43dff5a3f9d073b6679843">static_content</a>;
<a name="l00559"></a>00559       out = urih-&gt;<a class="code" href="structast__http__uri.html#a4ef4b8290b170231e27114a0a02f1c51">callback</a>(ser, urih, uri, method, vars, headers, <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>, title, contentlength);
<a name="l00560"></a>00560       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structuris.html">uris</a>);
<a name="l00561"></a>00561    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (saw_method) {
<a name="l00562"></a>00562       out = <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 404),
<a name="l00563"></a>00563                  (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;Not Found&quot;</span>)), NULL,
<a name="l00564"></a>00564                  <span class="stringliteral">&quot;The requested URL was not found on this server.&quot;</span>);
<a name="l00565"></a>00565    } <span class="keywordflow">else</span> {
<a name="l00566"></a>00566       out = <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 501),
<a name="l00567"></a>00567                  (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;Not Implemented&quot;</span>)), NULL,
<a name="l00568"></a>00568                  <span class="stringliteral">&quot;Attempt to use unimplemented / unsupported method&quot;</span>);
<a name="l00569"></a>00569    }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571 <a class="code" href="pbx__gtkconsole_8c.html#ae553432d9c2050cb69863126759710e4">cleanup</a>:
<a name="l00572"></a>00572    <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(vars);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574    <span class="keywordflow">return</span> out;
<a name="l00575"></a>00575 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae57381d7764de9906ba0ce595fe0fa0f"></a><!-- doxytag: member="http.c::http_decode" ref="ae57381d7764de9906ba0ce595fe0fa0f" args="(char *s)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void http_decode </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>s</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00411">411</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="utils_8c_source.html#l00414">ast_uri_decode()</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l00423">handle_uri()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00412"></a>00412 {
<a name="l00413"></a>00413    <span class="keywordtype">char</span> *t;
<a name="l00414"></a>00414    
<a name="l00415"></a>00415    <span class="keywordflow">for</span> (t = <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>; *t; t++) {
<a name="l00416"></a>00416       <span class="keywordflow">if</span> (*t == <span class="charliteral">&apos;+&apos;</span>)
<a name="l00417"></a>00417          *t = <span class="charliteral">&apos; &apos;</span>;
<a name="l00418"></a>00418    }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420    <a class="code" href="utils_8h.html#adafa7619a91aca23fc519bcc31ae8dff" title="Decode URI, URN, URL (overwrite string).">ast_uri_decode</a>(<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>);
<a name="l00421"></a>00421 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0605800ec02aa2a6ffd42af6ba06b98f"></a><!-- doxytag: member="http.c::httpd_helper_thread" ref="a0605800ec02aa2a6ffd42af6ba06b98f" args="(void *arg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void * httpd_helper_thread </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>arg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00659">659</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="version_8c_source.html#l00014">ast_get_version()</a>, <a class="el" href="http_8c_source.html#l00309">ast_http_error()</a>, <a class="el" href="http_8h_source.html#l00070">AST_HTTP_GET</a>, <a class="el" href="http_8h_source.html#l00071">AST_HTTP_POST</a>, <a class="el" href="localtime_8c_source.html#l01305">ast_localtime()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="strings_8h_source.html#l00092">ast_skip_blanks()</a>, <a class="el" href="strings_8h_source.html#l00131">ast_skip_nonblanks()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="localtime_8c_source.html#l01928">ast_strftime()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="strings_8h_source.html#l00117">ast_trim_blanks()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="config_8c_source.html#l00223">ast_variable_new()</a>, <a class="el" href="config_8c_source.html#l00397">ast_variables_destroy()</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="tcptls_8h_source.html#l00134">ast_tcptls_session_instance::f</a>, <a class="el" href="ast__expr2f_8c_source.html#l00563">fwrite</a>, <a class="el" href="http_8c_source.html#l00423">handle_uri()</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00053">name</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, <a class="el" href="http_8c_source.html#l00622">parse_cookies()</a>, <a class="el" href="app__jack_8c_source.html#l00141">status</a>, and <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00660"></a>00660 {
<a name="l00661"></a>00661    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[4096];
<a name="l00662"></a>00662    <span class="keywordtype">char</span> cookie[4096];
<a name="l00663"></a>00663    <span class="keyword">struct </span><a class="code" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *ser = data;
<a name="l00664"></a>00664    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *vars=NULL, *headers = NULL;
<a name="l00665"></a>00665    <span class="keywordtype">char</span> *uri, *title=NULL;
<a name="l00666"></a>00666    <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 200, contentlength = 0;
<a name="l00667"></a>00667    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *out = NULL;
<a name="l00668"></a>00668    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> static_content = 0;
<a name="l00669"></a>00669    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *tail = headers;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671    <span class="keywordflow">if</span> (!fgets(buf, <span class="keyword">sizeof</span>(buf), ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>)) {
<a name="l00672"></a>00672       <span class="keywordflow">goto</span> done;
<a name="l00673"></a>00673    }
<a name="l00674"></a>00674 
<a name="l00675"></a>00675    uri = <a class="code" href="strings_8h.html#a7d452227c6dc0b921257b1dd01853fb8" title="Gets a pointer to first whitespace character in a string.">ast_skip_nonblanks</a>(buf);   <span class="comment">/* Skip method */</span>
<a name="l00676"></a>00676    <span class="keywordflow">if</span> (*uri) {
<a name="l00677"></a>00677       *uri++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00678"></a>00678    }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680    uri = <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(uri);   <span class="comment">/* Skip white space */</span>
<a name="l00681"></a>00681 
<a name="l00682"></a>00682    <span class="keywordflow">if</span> (*uri) {       <span class="comment">/* terminate at the first blank */</span>
<a name="l00683"></a>00683       <span class="keywordtype">char</span> *c = <a class="code" href="strings_8h.html#a7d452227c6dc0b921257b1dd01853fb8" title="Gets a pointer to first whitespace character in a string.">ast_skip_nonblanks</a>(uri);
<a name="l00684"></a>00684 
<a name="l00685"></a>00685       <span class="keywordflow">if</span> (*c) {
<a name="l00686"></a>00686          *c = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00687"></a>00687       }
<a name="l00688"></a>00688    }
<a name="l00689"></a>00689 
<a name="l00690"></a>00690    <span class="comment">/* process &quot;Cookie: &quot; lines */</span>
<a name="l00691"></a>00691    <span class="keywordflow">while</span> (fgets(cookie, <span class="keyword">sizeof</span>(cookie), ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>)) {
<a name="l00692"></a>00692       <span class="comment">/* Trim trailing characters */</span>
<a name="l00693"></a>00693       <a class="code" href="strings_8h.html#ac5899ca9e586caf3041865762e770550" title="Trims trailing whitespace characters from a string.">ast_trim_blanks</a>(cookie);
<a name="l00694"></a>00694       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cookie)) {
<a name="l00695"></a>00695          <span class="keywordflow">break</span>;
<a name="l00696"></a>00696       }
<a name="l00697"></a>00697       <span class="keywordflow">if</span> (!strncasecmp(cookie, <span class="stringliteral">&quot;Cookie: &quot;</span>, 8)) {
<a name="l00698"></a>00698          vars = <a class="code" href="http_8c.html#aaabfd592781e75ac9fb18a499327bff9">parse_cookies</a>(cookie);
<a name="l00699"></a>00699       } <span class="keywordflow">else</span> {
<a name="l00700"></a>00700          <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, *<a class="code" href="structval.html">val</a>;
<a name="l00701"></a>00701 
<a name="l00702"></a>00702          val = cookie;
<a name="l00703"></a>00703          name = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;val, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l00704"></a>00704          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(name) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(val)) {
<a name="l00705"></a>00705             <span class="keywordflow">continue</span>;
<a name="l00706"></a>00706          }
<a name="l00707"></a>00707          <a class="code" href="strings_8h.html#ac5899ca9e586caf3041865762e770550" title="Trims trailing whitespace characters from a string.">ast_trim_blanks</a>(name);
<a name="l00708"></a>00708          val = <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(val);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710          <span class="keywordflow">if</span> (!headers) {
<a name="l00711"></a>00711             headers = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(name, val, __FILE__);
<a name="l00712"></a>00712             tail = headers;
<a name="l00713"></a>00713          } <span class="keywordflow">else</span> {
<a name="l00714"></a>00714             tail-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a> = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(name, val, __FILE__);
<a name="l00715"></a>00715             tail = tail-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l00716"></a>00716          }
<a name="l00717"></a>00717       }
<a name="l00718"></a>00718    }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720    <span class="keywordflow">if</span> (!*uri) {
<a name="l00721"></a>00721       out = <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>(400, <span class="stringliteral">&quot;Bad Request&quot;</span>, NULL, <span class="stringliteral">&quot;Invalid Request&quot;</span>);
<a name="l00722"></a>00722    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcasecmp(buf, <span class="stringliteral">&quot;post&quot;</span>) &amp;&amp; strcasecmp(buf, <span class="stringliteral">&quot;get&quot;</span>)) {
<a name="l00723"></a>00723       out = <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>(501, <span class="stringliteral">&quot;Not Implemented&quot;</span>, NULL,
<a name="l00724"></a>00724                  <span class="stringliteral">&quot;Attempt to use unimplemented / unsupported method&quot;</span>);
<a name="l00725"></a>00725    } <span class="keywordflow">else</span> { <span class="comment">/* try to serve it */</span>
<a name="l00726"></a>00726       out = <a class="code" href="http_8c.html#a9265ccf674be7c051596c0da7ea30201">handle_uri</a>(ser, uri, (!strcasecmp(buf, <span class="stringliteral">&quot;get&quot;</span>)) ? <a class="code" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80efa74b1cb5c2ecb5e0bd9af5d46a7b78fd2">AST_HTTP_GET</a> : <a class="code" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80efa544b9492daf28b47937772ca54e31c80">AST_HTTP_POST</a>,
<a name="l00727"></a>00727              &amp;status, &amp;title, &amp;contentlength, &amp;vars, headers, &amp;static_content);
<a name="l00728"></a>00728    }
<a name="l00729"></a>00729 
<a name="l00730"></a>00730    <span class="comment">/* If they aren&apos;t mopped up already, clean up the cookies */</span>
<a name="l00731"></a>00731    <span class="keywordflow">if</span> (vars) {
<a name="l00732"></a>00732       <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(vars);
<a name="l00733"></a>00733    }
<a name="l00734"></a>00734    <span class="comment">/* Clean up all the header information pulled as well */</span>
<a name="l00735"></a>00735    <span class="keywordflow">if</span> (headers) {
<a name="l00736"></a>00736       <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(headers);
<a name="l00737"></a>00737    }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739    <span class="keywordflow">if</span> (out) {
<a name="l00740"></a>00740       <span class="keyword">struct </span>timeval now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00741"></a>00741       <span class="keywordtype">char</span> timebuf[256];
<a name="l00742"></a>00742       <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744       <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(timebuf, <span class="keyword">sizeof</span>(timebuf), <span class="stringliteral">&quot;%a, %d %b %Y %H:%M:%S %Z&quot;</span>, <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;tm, <span class="stringliteral">&quot;GMT&quot;</span>));
<a name="l00745"></a>00745       fprintf(ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>,
<a name="l00746"></a>00746          <span class="stringliteral">&quot;HTTP/1.1 %d %s\r\n&quot;</span>
<a name="l00747"></a>00747          <span class="stringliteral">&quot;Server: Asterisk/%s\r\n&quot;</span>
<a name="l00748"></a>00748          <span class="stringliteral">&quot;Date: %s\r\n&quot;</span>
<a name="l00749"></a>00749          <span class="stringliteral">&quot;Connection: close\r\n&quot;</span>
<a name="l00750"></a>00750          <span class="stringliteral">&quot;%s&quot;</span>,
<a name="l00751"></a>00751          status, title ? title : <span class="stringliteral">&quot;OK&quot;</span>, <a class="code" href="ast__version_8h.html#a7765c608aea948584928643ab3963b2a" title="Retrieve the Asterisk version string.">ast_get_version</a>(), timebuf,
<a name="l00752"></a>00752          static_content ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;Cache-Control: no-cache, no-store\r\n&quot;</span>);
<a name="l00753"></a>00753          <span class="comment">/* We set the no-cache headers only for dynamic content.</span>
<a name="l00754"></a>00754 <span class="comment">         * If you want to make sure the static file you requested is not from cache,</span>
<a name="l00755"></a>00755 <span class="comment">         * append a random variable to your GET request.  Ex: &apos;something.html?r=109987734&apos;</span>
<a name="l00756"></a>00756 <span class="comment">         */</span>
<a name="l00757"></a>00757       <span class="keywordflow">if</span> (!contentlength) {   <span class="comment">/* opaque body ? just dump it hoping it is properly formatted */</span>
<a name="l00758"></a>00758          fprintf(ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out));
<a name="l00759"></a>00759       } <span class="keywordflow">else</span> {
<a name="l00760"></a>00760          <span class="keywordtype">char</span> *tmp = strstr(<a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out), <span class="stringliteral">&quot;\r\n\r\n&quot;</span>);
<a name="l00761"></a>00761 
<a name="l00762"></a>00762          <span class="keywordflow">if</span> (tmp) {
<a name="l00763"></a>00763             fprintf(ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>, <span class="stringliteral">&quot;Content-length: %d\r\n&quot;</span>, contentlength);
<a name="l00764"></a>00764             <span class="comment">/* first write the header, then the body */</span>
<a name="l00765"></a>00765             <span class="keywordflow">if</span> (<a class="code" href="ast__expr2f_8c.html#a8541b986268a39ba1b07d9e912d31732">fwrite</a>(<a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out), 1, (tmp + 4 - <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out)), ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>) != tmp + 4 - <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out)) {
<a name="l00766"></a>00766                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;fwrite() failed: %s\n&quot;</span>, strerror(errno));
<a name="l00767"></a>00767             }
<a name="l00768"></a>00768             <span class="keywordflow">if</span> (<a class="code" href="ast__expr2f_8c.html#a8541b986268a39ba1b07d9e912d31732">fwrite</a>(tmp + 4, 1, contentlength, ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>) != contentlength ) {
<a name="l00769"></a>00769                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;fwrite() failed: %s\n&quot;</span>, strerror(errno));
<a name="l00770"></a>00770             }
<a name="l00771"></a>00771          }
<a name="l00772"></a>00772       }
<a name="l00773"></a>00773       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(out);
<a name="l00774"></a>00774    }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776    <span class="keywordflow">if</span> (title) {
<a name="l00777"></a>00777       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(title);
<a name="l00778"></a>00778    }
<a name="l00779"></a>00779 
<a name="l00780"></a>00780 done:
<a name="l00781"></a>00781    fclose(ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>);
<a name="l00782"></a>00782    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(ser, -1);
<a name="l00783"></a>00783    ser = NULL;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785    <span class="keywordflow">return</span> NULL;
<a name="l00786"></a>00786 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a151755d5fac621a55deef1256ddd49b1"></a><!-- doxytag: member="http.c::httpstatus_callback" ref="a151755d5fac621a55deef1256ddd49b1" args="(struct ast_tcptls_session_instance *ser, const struct ast_http_uri *urih, const char *uri, enum ast_http_method method, struct ast_variable *vars, struct ast_variable *headers, int *status, char **title, int *contentlength)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__str.html">ast_str</a>* httpstatus_callback </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *&nbsp;</td>
          <td class="paramname"> <em>ser</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *&nbsp;</td>
          <td class="paramname"> <em>urih</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>uri</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80ef">ast_http_method</a>&nbsp;</td>
          <td class="paramname"> <em>method</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td>
          <td class="paramname"> <em>vars</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td>
          <td class="paramname"> <em>headers</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>status</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&nbsp;</td>
          <td class="paramname"> <em>title</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>contentlength</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00243">243</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="utils_8c_source.html#l00431">ast_inet_ntoa()</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="tcptls_8h_source.html#l00079">ast_tls_config::enabled</a>, <a class="el" href="http_8c_source.html#l00062">http_tls_cfg</a>, <a class="el" href="config_8h_source.html#l00075">ast_variable::name</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, <a class="el" href="tcptls_8h_source.html#l00117">ast_tcptls_session_args::old_address</a>, and <a class="el" href="config_8h_source.html#l00076">ast_variable::value</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00244"></a>00244 {
<a name="l00245"></a>00245    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *out = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(512);
<a name="l00246"></a>00246    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248    <span class="keywordflow">if</span> (out == NULL) {
<a name="l00249"></a>00249       <span class="keywordflow">return</span> out;
<a name="l00250"></a>00250    }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0,
<a name="l00253"></a>00253              <span class="stringliteral">&quot;\r\n&quot;</span>
<a name="l00254"></a>00254              <span class="stringliteral">&quot;&lt;title&gt;Asterisk HTTP Status&lt;/title&gt;\r\n&quot;</span>
<a name="l00255"></a>00255              <span class="stringliteral">&quot;&lt;body bgcolor=\&quot;#ffffff\&quot;&gt;\r\n&quot;</span>
<a name="l00256"></a>00256              <span class="stringliteral">&quot;&lt;table bgcolor=\&quot;#f1f1f1\&quot; align=\&quot;center\&quot;&gt;&lt;tr&gt;&lt;td bgcolor=\&quot;#e0e0ff\&quot; colspan=\&quot;2\&quot; width=\&quot;500\&quot;&gt;\r\n&quot;</span>
<a name="l00257"></a>00257              <span class="stringliteral">&quot;&lt;h2&gt;&amp;nbsp;&amp;nbsp;Asterisk&amp;trade; HTTP Status&lt;/h2&gt;&lt;/td&gt;&lt;/tr&gt;\r\n&quot;</span>);
<a name="l00258"></a>00258    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;&lt;tr&gt;&lt;td&gt;&lt;i&gt;Prefix&lt;/i&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;%s&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;\r\n&quot;</span>, <a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>);
<a name="l00259"></a>00259    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;&lt;tr&gt;&lt;td&gt;&lt;i&gt;Bind Address&lt;/i&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;%s&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;\r\n&quot;</span>,
<a name="l00260"></a>00260              <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a>.sin_addr));
<a name="l00261"></a>00261    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;&lt;tr&gt;&lt;td&gt;&lt;i&gt;Bind Port&lt;/i&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;%d&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;\r\n&quot;</span>,
<a name="l00262"></a>00262              ntohs(<a class="code" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a>.sin_port));
<a name="l00263"></a>00263 
<a name="l00264"></a>00264    <span class="keywordflow">if</span> (<a class="code" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a>.<a class="code" href="structast__tls__config.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a>) {
<a name="l00265"></a>00265       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;&lt;tr&gt;&lt;td&gt;&lt;i&gt;SSL Bind Port&lt;/i&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;%d&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;\r\n&quot;</span>,
<a name="l00266"></a>00266                 ntohs(<a class="code" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a>.<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a>.sin_port));
<a name="l00267"></a>00267    }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;&lt;tr&gt;&lt;td colspan=\&quot;2\&quot;&gt;&lt;hr&gt;&lt;/td&gt;&lt;/tr&gt;\r\n&quot;</span>);
<a name="l00270"></a>00270 
<a name="l00271"></a>00271    <span class="keywordflow">for</span> (v = vars; v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00272"></a>00272       <span class="keywordflow">if</span> (strncasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;cookie_&quot;</span>, 7)) {
<a name="l00273"></a>00273          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;&lt;tr&gt;&lt;td&gt;&lt;i&gt;Submitted Variable &apos;%s&apos;&lt;/i&gt;&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;\r\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00274"></a>00274       }
<a name="l00275"></a>00275    }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;&lt;tr&gt;&lt;td colspan=\&quot;2\&quot;&gt;&lt;hr&gt;&lt;/td&gt;&lt;/tr&gt;\r\n&quot;</span>);
<a name="l00278"></a>00278 
<a name="l00279"></a>00279    <span class="keywordflow">for</span> (v = vars; v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00280"></a>00280       <span class="keywordflow">if</span> (!strncasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;cookie_&quot;</span>, 7)) {
<a name="l00281"></a>00281          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;&lt;tr&gt;&lt;td&gt;&lt;i&gt;Cookie &apos;%s&apos;&lt;/i&gt;&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;\r\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00282"></a>00282       }
<a name="l00283"></a>00283    }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;&lt;/table&gt;&lt;center&gt;&lt;font size=\&quot;-1\&quot;&gt;&lt;i&gt;Asterisk and Digium are registered trademarks of Digium, Inc.&lt;/i&gt;&lt;/font&gt;&lt;/center&gt;&lt;/body&gt;\r\n&quot;</span>);
<a name="l00286"></a>00286    <span class="keywordflow">return</span> out;
<a name="l00287"></a>00287 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad581b301a954f309d107108bfac61775"></a><!-- doxytag: member="http.c::manid_from_vars" ref="ad581b301a954f309d107108bfac61775" args="(struct ast_variable *sid)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static uint32_t manid_from_vars </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td>
          <td class="paramname"> <em>sid</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00135">135</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="config_8h_source.html#l00075">ast_variable::name</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, and <a class="el" href="config_8h_source.html#l00076">ast_variable::value</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l00423">handle_uri()</a>, and <a class="el" href="http_8c_source.html#l00154">static_callback()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00135"></a>00135                                                           {
<a name="l00136"></a>00136    uint32_t mngid;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138    <span class="keywordflow">while</span> (sid &amp;&amp; strcmp(sid-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mansession_id&quot;</span>))
<a name="l00139"></a>00139       sid = sid-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141    <span class="keywordflow">if</span> (!sid || sscanf(sid-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30x&quot;</span>, &amp;mngid) != 1)
<a name="l00142"></a>00142       <span class="keywordflow">return</span> 0;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144    <span class="keywordflow">return</span> mngid;
<a name="l00145"></a>00145 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aaabfd592781e75ac9fb18a499327bff9"></a><!-- doxytag: member="http.c::parse_cookies" ref="aaabfd592781e75ac9fb18a499327bff9" args="(char *cookies)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__variable.html">ast_variable</a>* parse_cookies </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>cookies</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>replacement read/write functions for SSL support. We use wrappers rather than SSL_read/SSL_write directly so we can put in some debugging. </p>

<p>Definition at line <a class="el" href="http_8c_source.html#l00622">622</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="strings_8h_source.html#l00150">ast_strip()</a>, <a class="el" href="utils_8c_source.html#l01209">ast_strip_quoted()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="config_8c_source.html#l00223">ast_variable_new()</a>, <a class="el" href="logger_8h_source.html#l00119">LOG_DEBUG</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00053">name</a>, <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>, <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>, and <a class="el" href="ast__expr2f_8c_source.html#l00613">var</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l00659">httpd_helper_thread()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00623"></a>00623 {
<a name="l00624"></a>00624    <span class="keywordtype">char</span> *cur;
<a name="l00625"></a>00625    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *vars = NULL, *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627    <span class="comment">/* Skip Cookie: */</span>
<a name="l00628"></a>00628    cookies += 8;
<a name="l00629"></a>00629 
<a name="l00630"></a>00630    <span class="keywordflow">while</span> ((cur = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;cookies, <span class="stringliteral">&quot;;&quot;</span>))) {
<a name="l00631"></a>00631       <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, *<a class="code" href="structval.html">val</a>;
<a name="l00632"></a>00632       
<a name="l00633"></a>00633       name = val = cur;
<a name="l00634"></a>00634       <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;val, <span class="stringliteral">&quot;=&quot;</span>);
<a name="l00635"></a>00635 
<a name="l00636"></a>00636       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(name) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(val)) {
<a name="l00637"></a>00637          <span class="keywordflow">continue</span>;
<a name="l00638"></a>00638       }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640       name = <a class="code" href="strings_8h.html#aeb1c54e6e100c63176d8e22b0d5ca865" title="Strip leading/trailing whitespace from a string.">ast_strip</a>(name);
<a name="l00641"></a>00641       val = <a class="code" href="strings_8h.html#aeb597bdc9a1209c2e7dd8af04de43485" title="Strip leading/trailing whitespace and quotes from a string.">ast_strip_quoted</a>(val, <span class="stringliteral">&quot;\&quot;&quot;</span>, <span class="stringliteral">&quot;\&quot;&quot;</span>);
<a name="l00642"></a>00642 
<a name="l00643"></a>00643       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(name) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(val)) {
<a name="l00644"></a>00644          <span class="keywordflow">continue</span>;
<a name="l00645"></a>00645       }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>) {
<a name="l00648"></a>00648          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;mmm ... cookie!  Name: &apos;%s&apos;  Value: &apos;%s&apos;\n&quot;</span>, name, val);
<a name="l00649"></a>00649       }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651       var = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(name, val, __FILE__);
<a name="l00652"></a>00652       var-&gt;next = vars;
<a name="l00653"></a>00653       vars = var;
<a name="l00654"></a>00654    }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656    <span class="keywordflow">return</span> vars;
<a name="l00657"></a>00657 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aca1b87b99ebfc893da36e957ed5402ff"></a><!-- doxytag: member="http.c::static_callback" ref="aca1b87b99ebfc893da36e957ed5402ff" args="(struct ast_tcptls_session_instance *ser, const struct ast_http_uri *urih, const char *uri, enum ast_http_method method, struct ast_variable *vars, struct ast_variable *headers, int *status, char **title, int *contentlength)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__str.html">ast_str</a>* static_callback </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *&nbsp;</td>
          <td class="paramname"> <em>ser</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *&nbsp;</td>
          <td class="paramname"> <em>urih</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>uri</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80ef">ast_http_method</a>&nbsp;</td>
          <td class="paramname"> <em>method</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td>
          <td class="paramname"> <em>vars</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td>
          <td class="paramname"> <em>headers</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>status</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&nbsp;</td>
          <td class="paramname"> <em>title</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>contentlength</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00154">154</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>References <a class="el" href="asterisk_8c_source.html#l00254">ast_config_AST_DATA_DIR</a>, <a class="el" href="version_8c_source.html#l00014">ast_get_version()</a>, <a class="el" href="http_8c_source.html#l00309">ast_http_error()</a>, <a class="el" href="localtime_8c_source.html#l01305">ast_localtime()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astmm_8h_source.html#l00099">ast_strdup</a>, <a class="el" href="localtime_8c_source.html#l01928">ast_strftime()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="manager_8c_source.html#l03521">astman_is_authed()</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="tcptls_8h_source.html#l00134">ast_tcptls_session_instance::f</a>, <a class="el" href="http_8c_source.html#l00118">ftype2mtype()</a>, <a class="el" href="ast__expr2f_8c_source.html#l00563">fwrite</a>, <a class="el" href="func__strings_8c_source.html#l00821">len()</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="http_8c_source.html#l00135">manid_from_vars()</a>, and <a class="el" href="http_8c_source.html#l00098">mtype</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00155"></a>00155 {
<a name="l00156"></a>00156    <span class="keywordtype">char</span> *path;
<a name="l00157"></a>00157    <span class="keywordtype">char</span> *ftype;
<a name="l00158"></a>00158    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#a3189f2c804f88ece5a83d4772e11ff9e">mtype</a>;
<a name="l00159"></a>00159    <span class="keywordtype">char</span> wkspace[80];
<a name="l00160"></a>00160    <span class="keyword">struct </span>stat st;
<a name="l00161"></a>00161    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l00162"></a>00162    <span class="keywordtype">int</span> fd;
<a name="l00163"></a>00163    <span class="keyword">struct </span>timeval now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00164"></a>00164    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256];
<a name="l00165"></a>00165    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167    <span class="comment">/* Yuck.  I&apos;m not really sold on this, but if you don&apos;t deliver static content it makes your configuration </span>
<a name="l00168"></a>00168 <span class="comment">      substantially more challenging, but this seems like a rather irritating feature creep on Asterisk. */</span>
<a name="l00169"></a>00169    <span class="keywordflow">if</span> (!<a class="code" href="http_8c.html#a0d575742490f0b0242cfeace49c81b16">enablestatic</a> || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(uri)) {
<a name="l00170"></a>00170       <span class="keywordflow">goto</span> out403;
<a name="l00171"></a>00171    }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173    <span class="comment">/* Disallow any funny filenames at all */</span>
<a name="l00174"></a>00174    <span class="keywordflow">if</span> ((uri[0] &lt; 33) || strchr(<span class="stringliteral">&quot;./|~@#$%^&amp;*() \t&quot;</span>, uri[0])) {
<a name="l00175"></a>00175       <span class="keywordflow">goto</span> out403;
<a name="l00176"></a>00176    }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178    <span class="keywordflow">if</span> (strstr(uri, <span class="stringliteral">&quot;/..&quot;</span>)) {
<a name="l00179"></a>00179       <span class="keywordflow">goto</span> out403;
<a name="l00180"></a>00180    }
<a name="l00181"></a>00181       
<a name="l00182"></a>00182    <span class="keywordflow">if</span> ((ftype = strrchr(uri, <span class="charliteral">&apos;.&apos;</span>))) {
<a name="l00183"></a>00183       ftype++;
<a name="l00184"></a>00184    }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186    mtype = <a class="code" href="http_8c.html#afc08b749db765fdf2c6e2a2e9593a6fe">ftype2mtype</a>(ftype, wkspace, <span class="keyword">sizeof</span>(wkspace));
<a name="l00187"></a>00187    
<a name="l00188"></a>00188    <span class="comment">/* Cap maximum length */</span>
<a name="l00189"></a>00189    <span class="keywordflow">if</span> ((len = strlen(uri) + strlen(<a class="code" href="paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a>) + strlen(<span class="stringliteral">&quot;/static-http/&quot;</span>) + 5) &gt; 1024) {
<a name="l00190"></a>00190       <span class="keywordflow">goto</span> out403;
<a name="l00191"></a>00191    }
<a name="l00192"></a>00192       
<a name="l00193"></a>00193    path = alloca(len);
<a name="l00194"></a>00194    sprintf(path, <span class="stringliteral">&quot;%s/static-http/%s&quot;</span>, <a class="code" href="paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a>, uri);
<a name="l00195"></a>00195    <span class="keywordflow">if</span> (stat(path, &amp;st)) {
<a name="l00196"></a>00196       <span class="keywordflow">goto</span> out404;
<a name="l00197"></a>00197    }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199    <span class="keywordflow">if</span> (S_ISDIR(st.st_mode)) {
<a name="l00200"></a>00200       <span class="keywordflow">goto</span> out404;
<a name="l00201"></a>00201    }  
<a name="l00202"></a>00202 
<a name="l00203"></a>00203    <span class="keywordflow">if</span> ((fd = open(path, O_RDONLY)) &lt; 0) {
<a name="l00204"></a>00204       <span class="keywordflow">goto</span> out403;
<a name="l00205"></a>00205    }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207    <span class="keywordflow">if</span> (strstr(path, <span class="stringliteral">&quot;/private/&quot;</span>) &amp;&amp; !<a class="code" href="manager_8h.html#acb49e15f3ae80cc0ee0cfa3a250d00c0" title="Determinie if a manager session ident is authenticated.">astman_is_authed</a>(<a class="code" href="http_8c.html#ad581b301a954f309d107108bfac61775">manid_from_vars</a>(vars))) {
<a name="l00208"></a>00208       <span class="keywordflow">goto</span> out403;
<a name="l00209"></a>00209    }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211    <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;%a, %d %b %Y %H:%M:%S %Z&quot;</span>, <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;tm, <span class="stringliteral">&quot;GMT&quot;</span>));
<a name="l00212"></a>00212    fprintf(ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>, <span class="stringliteral">&quot;HTTP/1.1 200 OK\r\n&quot;</span>
<a name="l00213"></a>00213       <span class="stringliteral">&quot;Server: Asterisk/%s\r\n&quot;</span>
<a name="l00214"></a>00214       <span class="stringliteral">&quot;Date: %s\r\n&quot;</span>
<a name="l00215"></a>00215       <span class="stringliteral">&quot;Connection: close\r\n&quot;</span>
<a name="l00216"></a>00216       <span class="stringliteral">&quot;Cache-Control: private\r\n&quot;</span>
<a name="l00217"></a>00217       <span class="stringliteral">&quot;Content-Length: %d\r\n&quot;</span>
<a name="l00218"></a>00218       <span class="stringliteral">&quot;Content-type: %s\r\n\r\n&quot;</span>,
<a name="l00219"></a>00219       <a class="code" href="ast__version_8h.html#a7765c608aea948584928643ab3963b2a" title="Retrieve the Asterisk version string.">ast_get_version</a>(), buf, (<span class="keywordtype">int</span>) st.st_size, mtype);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221    <span class="keywordflow">while</span> ((len = read(fd, buf, <span class="keyword">sizeof</span>(buf))) &gt; 0) {
<a name="l00222"></a>00222       <span class="keywordflow">if</span> (<a class="code" href="ast__expr2f_8c.html#a8541b986268a39ba1b07d9e912d31732">fwrite</a>(buf, 1, len, ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>) != len) {
<a name="l00223"></a>00223          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;fwrite() failed: %s\n&quot;</span>, strerror(errno));
<a name="l00224"></a>00224       }
<a name="l00225"></a>00225    }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227    close(fd);
<a name="l00228"></a>00228 
<a name="l00229"></a>00229    <span class="keywordflow">return</span> NULL;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 out404:
<a name="l00232"></a>00232    <span class="keywordflow">return</span> <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 404),
<a name="l00233"></a>00233                (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;Not Found&quot;</span>)),
<a name="l00234"></a>00234                 NULL, <span class="stringliteral">&quot;The requested URL was not found on this server.&quot;</span>);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 out403:
<a name="l00237"></a>00237    <span class="keywordflow">return</span> <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 403),
<a name="l00238"></a>00238                (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;Access Denied&quot;</span>)),
<a name="l00239"></a>00239                NULL, <span class="stringliteral">&quot;You do not have permission to access the requested URL.&quot;</span>);
<a name="l00240"></a>00240 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a62ac5f089c743a2d4113e518818000fa"></a><!-- doxytag: member="http.c::cli_http" ref="a62ac5f089c743a2d4113e518818000fa" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> <a class="el" href="http_8c.html#a62ac5f089c743a2d4113e518818000fa">cli_http</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="http_8c.html#abd384ccb6510fda645ef76636af6642a">handle_show_http</a>, <span class="stringliteral">&quot;Display HTTP server status&quot;</span>),
}
</pre></div>
<p>Definition at line <a class="el" href="http_8c_source.html#l01019">1019</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l01023">ast_http_init()</a>.</p>

</div>
</div>
<a class="anchor" id="a0d575742490f0b0242cfeace49c81b16"></a><!-- doxytag: member="http.c::enablestatic" ref="a0d575742490f0b0242cfeace49c81b16" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="http_8c.html#a0d575742490f0b0242cfeace49c81b16">enablestatic</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00093">93</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

</div>
</div>
<a class="anchor" id="af9b32121c4ad80b0887a3d73fd24de5f"></a><!-- doxytag: member="http.c::ext" ref="af9b32121c4ad80b0887a3d73fd24de5f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* <a class="el" href="res__phoneprov_8c.html#a71ac783a3ca66bd546dc964f1dd0e0f0">ext</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00097">97</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>Referenced by <a class="el" href="file_8c_source.html#l00408">ast_filehelper()</a>, <a class="el" href="rtp_8c_source.html#l01562">ast_rtp_read()</a>, <a class="el" href="chan__console_8c_source.html#l00768">cli_console_dial()</a>, <a class="el" href="app__chanspy_8c_source.html#l00767">common_exec()</a>, <a class="el" href="chan__oss_8c_source.html#l01153">console_transfer()</a>, <a class="el" href="app__directory_8c_source.html#l00646">do_directory()</a>, <a class="el" href="file_8c_source.html#l00276">exts_compare()</a>, <a class="el" href="http_8c_source.html#l00118">ftype2mtype()</a>, <a class="el" href="pbx__config_8c_source.html#l00672">handle_cli_dialplan_save()</a>, <a class="el" href="chan__iax2_8c_source.html#l08921">iax_park_thread()</a>, <a class="el" href="chan__misdn_8c_source.html#l02394">misdn_call()</a>, <a class="el" href="chan__misdn_8c_source.html#l03426">misdn_request()</a>, <a class="el" href="app__mixmonitor_8c_source.html#l00280">mixmonitor_thread()</a>, <a class="el" href="res__musiconhold_8c_source.html#l00957">moh_scan_files()</a>, <a class="el" href="chan__h323_8c_source.html#l01722">oh323_request()</a>, <a class="el" href="pbx__config_8c_source.html#l01367">pbx_load_config()</a>, <a class="el" href="pbx__config_8c_source.html#l01608">pbx_load_users()</a>, <a class="el" href="pval_8c_source.html#l05419">pvalGotoSetTarget()</a>, <a class="el" href="app__record_8c_source.html#l00132">record_exec()</a>, <a class="el" href="chan__skinny_8c_source.html#l01764">register_exten()</a>, <a class="el" href="chan__iax2_8c_source.html#l08216">register_peer_exten()</a>, <a class="el" href="chan__sip_8c_source.html#l18706">sip_park_thread()</a>, <a class="el" href="chan__sip_8c_source.html#l23066">sip_request_call()</a>, and <a class="el" href="chan__skinny_8c_source.html#l01789">unregister_exten()</a>.</p>

</div>
</div>
<a class="anchor" id="aef37d79896cadcf96c364f8c5609fd2f"></a><!-- doxytag: member="http.c::http_desc" ref="aef37d79896cadcf96c364f8c5609fd2f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__tcptls__session__args.html">ast_tcptls_session_args</a> <a class="el" href="http_8c.html#aef37d79896cadcf96c364f8c5609fd2f">http_desc</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>we have up to two accepting threads, one for http, one for https </p>

<p>Definition at line <a class="el" href="http_8c_source.html#l00069">69</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

</div>
</div>
<a class="anchor" id="a1c80a21a7aa2d6eee02f11b48485a331"></a><!-- doxytag: member="http.c::http_tls_cfg" ref="a1c80a21a7aa2d6eee02f11b48485a331" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__tls__config.html">ast_tls_config</a> <a class="el" href="http_8c.html#a1c80a21a7aa2d6eee02f11b48485a331">http_tls_cfg</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00062">62</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l00848">__ast_http_load()</a>, <a class="el" href="http_8c_source.html#l00956">handle_show_http()</a>, and <a class="el" href="http_8c_source.html#l00243">httpstatus_callback()</a>.</p>

</div>
</div>
<a class="anchor" id="ad04999a886797d6dfe4fc6f6742527f5"></a><!-- doxytag: member="http.c::https_desc" ref="ad04999a886797d6dfe4fc6f6742527f5" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__tcptls__session__args.html">ast_tcptls_session_args</a> <a class="el" href="http_8c.html#ad04999a886797d6dfe4fc6f6742527f5">https_desc</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00079">79</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

</div>
</div>
<a class="anchor" id="a2ebb3c927f9a7eaf360284a393806e85"></a><!-- doxytag: member="http.c::mimetypes" ref="a2ebb3c927f9a7eaf360284a393806e85" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct { ... }   <a class="el" href="res__phoneprov_8c.html#a1fcea5c467a2309e3c4f2ca36c0dde06">mimetypes</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Limit the kinds of files we're willing to serve up. </p>

<p>Referenced by <a class="el" href="http_8c_source.html#l00118">ftype2mtype()</a>.</p>

</div>
</div>
<a class="anchor" id="a3189f2c804f88ece5a83d4772e11ff9e"></a><!-- doxytag: member="http.c::mtype" ref="a3189f2c804f88ece5a83d4772e11ff9e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* <a class="el" href="res__phoneprov_8c.html#aff336343ef8b74fa572dd6e820a53580">mtype</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00098">98</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>Referenced by <a class="el" href="res__phoneprov_8c_source.html#l00180">ftype2mtype()</a>, and <a class="el" href="http_8c_source.html#l00154">static_callback()</a>.</p>

</div>
</div>
<a class="anchor" id="a6f25bc812d09fedb86bf394c01061c56"></a><!-- doxytag: member="http.c::prefix" ref="a6f25bc812d09fedb86bf394c01061c56" args="[MAX_PREFIX]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__http__post_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>[MAX_PREFIX]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00092">92</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>Referenced by <a class="el" href="app__while_8c_source.html#l00189">_while_exec()</a>, <a class="el" href="db_8c_source.html#l00091">ast_db_deltree()</a>, <a class="el" href="db_8c_source.html#l00473">ast_db_gettree()</a>, <a class="el" href="asterisk_8c_source.html#l02595">ast_remotecontrol()</a>, <a class="el" href="func__strings_8c_source.html#l00569">exec_clearhash()</a>, <a class="el" href="db_8c_source.html#l00350">handle_cli_database_show()</a>, <a class="el" href="func__strings_8c_source.html#l00642">hashkeys_read()</a>, <a class="el" href="chan__misdn_8c_source.html#l02185">read_config()</a>, <a class="el" href="func__global_8c_source.html#l00128">shared_read()</a>, <a class="el" href="func__global_8c_source.html#l00176">shared_write()</a>, <a class="el" href="chan__sip_8c_source.html#l15919">sip_show_settings()</a>, and <a class="el" href="app__while_8c_source.html#l00311">while_continue_exec()</a>.</p>

</div>
</div>
<a class="anchor" id="ae59ae7f4b3e145d3d7468113fd4166ff"></a><!-- doxytag: member="http.c::staticuri" ref="ae59ae7f4b3e145d3d7468113fd4166ff" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> <a class="el" href="http_8c.html#ae59ae7f4b3e145d3d7468113fd4166ff">staticuri</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00298">298</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l01023">ast_http_init()</a>.</p>

</div>
</div>
<a class="anchor" id="a092e39cea3cca5eca8cf40da0b7a47e1"></a><!-- doxytag: member="http.c::statusuri" ref="a092e39cea3cca5eca8cf40da0b7a47e1" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> <a class="el" href="http_8c.html#a092e39cea3cca5eca8cf40da0b7a47e1">statusuri</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="http_8c_source.html#l00289">289</a> of file <a class="el" href="http_8c_source.html">http.c</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l01023">ast_http_init()</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:22:11 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
