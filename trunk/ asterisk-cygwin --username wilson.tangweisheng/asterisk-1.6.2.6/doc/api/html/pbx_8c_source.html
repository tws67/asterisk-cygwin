<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:43 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>pbx.c</h1><a href="pbx_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2008, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment">* the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Core PBX routines.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 243490 $&quot;</span>)
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;asterisk/_private.h&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="paths_8h.html" title="Asterisk file paths, configured in asterisk.conf.">asterisk/paths.h</a>&quot;</span>   <span class="comment">/* use ast_config_AST_SYSTEM_NAME */</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="code" href="time_8h.html" title="Time-related functions and macros.">time.h</a>&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#if defined(HAVE_SYSINFO)</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/sysinfo.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#endif</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#if defined(SOLARIS)</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/loadavg.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#endif</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="callerid_8h.html" title="CallerID (and other GR30) management and generation Includes code and algorithms...">asterisk/callerid.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="cdr_8h.html" title="Call Detail Record API.">asterisk/cdr.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="term_8h.html" title="Handy terminal functions for vt* terms.">asterisk/term.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="time_8h.html" title="Time-related functions and macros.">asterisk/time.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="ast__expr_8h.html">asterisk/ast_expr.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="linkedlists_8h.html" title="A set of macros to manage forward-linked lists.">asterisk/linkedlists.h</a>&quot;</span>
<a name="l00054"></a><a class="code" href="pbx_8c.html#a94e18d208abcc315ebc628f19fc5e30c">00054</a> <span class="preprocessor">#define  SAY_STUBS   </span><span class="comment">/* generate declarations and stubs for say methods */</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="say_8h.html" title="Say numbers and dates (maybe words one day too).">asterisk/say.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="causes_8h.html" title="Internal Asterisk hangup causes.">asterisk/causes.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="musiconhold_8h.html" title="Music on hold handling.">asterisk/musiconhold.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="devicestate_8h.html" title="Device state management.">asterisk/devicestate.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="event_8h.html">asterisk/event.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="hashtab_8h.html" title="Generic (perhaps overly so) hashtable implementation Hash Table support in Asterisk...">asterisk/hashtab.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="indications_8h.html" title="Tone Indication Support.">asterisk/indications.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="taskprocessor_8h.html" title="An API for managing task processing threads that can be shared across modules.">asterisk/taskprocessor.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="xmldoc_8h.html" title="Asterisk XML Documentation API.">asterisk/xmldoc.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="comment"></span>
<a name="l00068"></a>00068 <span class="comment">/*!</span>
<a name="l00069"></a>00069 <span class="comment"> * \note I M P O R T A N T :</span>
<a name="l00070"></a>00070 <span class="comment"> *</span>
<a name="l00071"></a>00071 <span class="comment"> *    The speed of extension handling will likely be among the most important</span>
<a name="l00072"></a>00072 <span class="comment"> * aspects of this PBX.  The switching scheme as it exists right now isn&apos;t</span>
<a name="l00073"></a>00073 <span class="comment"> * terribly bad (it&apos;s O(N+M), where N is the # of extensions and M is the avg #</span>
<a name="l00074"></a>00074 <span class="comment"> * of priorities, but a constant search time here would be great ;-)</span>
<a name="l00075"></a>00075 <span class="comment"> *</span>
<a name="l00076"></a>00076 <span class="comment"> * A new algorithm to do searching based on a &apos;compiled&apos; pattern tree is introduced</span>
<a name="l00077"></a>00077 <span class="comment"> * here, and shows a fairly flat (constant) search time, even for over</span>
<a name="l00078"></a>00078 <span class="comment"> * 10000 patterns.</span>
<a name="l00079"></a>00079 <span class="comment"> *</span>
<a name="l00080"></a>00080 <span class="comment"> * Also, using a hash table for context/priority name lookup can help prevent</span>
<a name="l00081"></a>00081 <span class="comment"> * the find_extension routines from absorbing exponential cpu cycles as the number</span>
<a name="l00082"></a>00082 <span class="comment"> * of contexts/priorities grow. I&apos;ve previously tested find_extension with red-black trees,</span>
<a name="l00083"></a>00083 <span class="comment"> * which have O(log2(n)) speed. Right now, I&apos;m using hash tables, which do</span>
<a name="l00084"></a>00084 <span class="comment"> * searches (ideally) in O(1) time. While these techniques do not yield much</span>
<a name="l00085"></a>00085 <span class="comment"> * speed in small dialplans, they are worth the trouble in large dialplans.</span>
<a name="l00086"></a>00086 <span class="comment"> *</span>
<a name="l00087"></a>00087 <span class="comment"> */</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="comment">/*** DOCUMENTATION</span>
<a name="l00090"></a>00090 <span class="comment">   &lt;application name=&quot;Answer&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00091"></a>00091 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00092"></a>00092 <span class="comment">         Answer a channel if ringing.</span>
<a name="l00093"></a>00093 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00094"></a>00094 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00095"></a>00095 <span class="comment">         &lt;parameter name=&quot;delay&quot;&gt;</span>
<a name="l00096"></a>00096 <span class="comment">            &lt;para&gt;Asterisk will wait this number of milliseconds before returning to</span>
<a name="l00097"></a>00097 <span class="comment">            the dialplan after answering the call.&lt;/para&gt;</span>
<a name="l00098"></a>00098 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00099"></a>00099 <span class="comment">         &lt;parameter name=&quot;nocdr&quot;&gt;</span>
<a name="l00100"></a>00100 <span class="comment">            &lt;para&gt;Asterisk will send an answer signal to the calling phone, but will not</span>
<a name="l00101"></a>00101 <span class="comment">            set the disposition or answer time in the CDR for this call.&lt;/para&gt;</span>
<a name="l00102"></a>00102 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00103"></a>00103 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00104"></a>00104 <span class="comment">      &lt;description&gt;</span>
<a name="l00105"></a>00105 <span class="comment">         &lt;para&gt;If the call has not been answered, this application will</span>
<a name="l00106"></a>00106 <span class="comment">         answer it. Otherwise, it has no effect on the call.&lt;/para&gt;</span>
<a name="l00107"></a>00107 <span class="comment">      &lt;/description&gt;</span>
<a name="l00108"></a>00108 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00109"></a>00109 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Hangup&lt;/ref&gt;</span>
<a name="l00110"></a>00110 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00111"></a>00111 <span class="comment">   &lt;/application&gt;</span>
<a name="l00112"></a>00112 <span class="comment">   &lt;application name=&quot;BackGround&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00113"></a>00113 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00114"></a>00114 <span class="comment">         Play an audio file while waiting for digits of an extension to go to.</span>
<a name="l00115"></a>00115 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00116"></a>00116 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00117"></a>00117 <span class="comment">         &lt;parameter name=&quot;filenames&quot; required=&quot;true&quot; argsep=&quot;&amp;amp;&quot;&gt;</span>
<a name="l00118"></a>00118 <span class="comment">            &lt;argument name=&quot;filename1&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00119"></a>00119 <span class="comment">            &lt;argument name=&quot;filename2&quot; multiple=&quot;true&quot; /&gt;</span>
<a name="l00120"></a>00120 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00121"></a>00121 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00122"></a>00122 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00123"></a>00123 <span class="comment">               &lt;option name=&quot;s&quot;&gt;</span>
<a name="l00124"></a>00124 <span class="comment">                  &lt;para&gt;Causes the playback of the message to be skipped</span>
<a name="l00125"></a>00125 <span class="comment">                  if the channel is not in the &lt;literal&gt;up&lt;/literal&gt; state (i.e. it</span>
<a name="l00126"></a>00126 <span class="comment">                  hasn&apos;t been answered yet). If this happens, the</span>
<a name="l00127"></a>00127 <span class="comment">                  application will return immediately.&lt;/para&gt;</span>
<a name="l00128"></a>00128 <span class="comment">               &lt;/option&gt;</span>
<a name="l00129"></a>00129 <span class="comment">               &lt;option name=&quot;n&quot;&gt;</span>
<a name="l00130"></a>00130 <span class="comment">                  &lt;para&gt;Don&apos;t answer the channel before playing the files.&lt;/para&gt;</span>
<a name="l00131"></a>00131 <span class="comment">               &lt;/option&gt;</span>
<a name="l00132"></a>00132 <span class="comment">               &lt;option name=&quot;m&quot;&gt;</span>
<a name="l00133"></a>00133 <span class="comment">                  &lt;para&gt;Only break if a digit hit matches a one digit</span>
<a name="l00134"></a>00134 <span class="comment">                  extension in the destination context.&lt;/para&gt;</span>
<a name="l00135"></a>00135 <span class="comment">               &lt;/option&gt;</span>
<a name="l00136"></a>00136 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00137"></a>00137 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00138"></a>00138 <span class="comment">         &lt;parameter name=&quot;langoverride&quot;&gt;</span>
<a name="l00139"></a>00139 <span class="comment">            &lt;para&gt;Explicitly specifies which language to attempt to use for the requested sound files.&lt;/para&gt;</span>
<a name="l00140"></a>00140 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00141"></a>00141 <span class="comment">         &lt;parameter name=&quot;context&quot;&gt;</span>
<a name="l00142"></a>00142 <span class="comment">            &lt;para&gt;This is the dialplan context that this application will use when exiting</span>
<a name="l00143"></a>00143 <span class="comment">            to a dialed extension.&lt;/para&gt;</span>
<a name="l00144"></a>00144 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00145"></a>00145 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00146"></a>00146 <span class="comment">      &lt;description&gt;</span>
<a name="l00147"></a>00147 <span class="comment">         &lt;para&gt;This application will play the given list of files &lt;emphasis&gt;(do not put extension)&lt;/emphasis&gt;</span>
<a name="l00148"></a>00148 <span class="comment">         while waiting for an extension to be dialed by the calling channel. To continue waiting</span>
<a name="l00149"></a>00149 <span class="comment">         for digits after this application has finished playing files, the &lt;literal&gt;WaitExten&lt;/literal&gt;</span>
<a name="l00150"></a>00150 <span class="comment">         application should be used.&lt;/para&gt;</span>
<a name="l00151"></a>00151 <span class="comment">         &lt;para&gt;If one of the requested sound files does not exist, call processing will be terminated.&lt;/para&gt;</span>
<a name="l00152"></a>00152 <span class="comment">         &lt;para&gt;This application sets the following channel variable upon completion:&lt;/para&gt;</span>
<a name="l00153"></a>00153 <span class="comment">         &lt;variablelist&gt;</span>
<a name="l00154"></a>00154 <span class="comment">            &lt;variable name=&quot;BACKGROUNDSTATUS&quot;&gt;</span>
<a name="l00155"></a>00155 <span class="comment">               &lt;para&gt;The status of the background attempt as a text string.&lt;/para&gt;</span>
<a name="l00156"></a>00156 <span class="comment">               &lt;value name=&quot;SUCCESS&quot; /&gt;</span>
<a name="l00157"></a>00157 <span class="comment">               &lt;value name=&quot;FAILED&quot; /&gt;</span>
<a name="l00158"></a>00158 <span class="comment">            &lt;/variable&gt;</span>
<a name="l00159"></a>00159 <span class="comment">         &lt;/variablelist&gt;</span>
<a name="l00160"></a>00160 <span class="comment">      &lt;/description&gt;</span>
<a name="l00161"></a>00161 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00162"></a>00162 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;ControlPlayback&lt;/ref&gt;</span>
<a name="l00163"></a>00163 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;WaitExten&lt;/ref&gt;</span>
<a name="l00164"></a>00164 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;BackgroundDetect&lt;/ref&gt;</span>
<a name="l00165"></a>00165 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;TIMEOUT&lt;/ref&gt;</span>
<a name="l00166"></a>00166 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00167"></a>00167 <span class="comment">   &lt;/application&gt;</span>
<a name="l00168"></a>00168 <span class="comment">   &lt;application name=&quot;Busy&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00169"></a>00169 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00170"></a>00170 <span class="comment">         Indicate the Busy condition.</span>
<a name="l00171"></a>00171 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00172"></a>00172 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00173"></a>00173 <span class="comment">         &lt;parameter name=&quot;timeout&quot;&gt;</span>
<a name="l00174"></a>00174 <span class="comment">            &lt;para&gt;If specified, the calling channel will be hung up after the specified number of seconds.</span>
<a name="l00175"></a>00175 <span class="comment">            Otherwise, this application will wait until the calling channel hangs up.&lt;/para&gt;</span>
<a name="l00176"></a>00176 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00177"></a>00177 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00178"></a>00178 <span class="comment">      &lt;description&gt;</span>
<a name="l00179"></a>00179 <span class="comment">         &lt;para&gt;This application will indicate the busy condition to the calling channel.&lt;/para&gt;</span>
<a name="l00180"></a>00180 <span class="comment">      &lt;/description&gt;</span>
<a name="l00181"></a>00181 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00182"></a>00182 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Congestion&lt;/ref&gt;</span>
<a name="l00183"></a>00183 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Progess&lt;/ref&gt;</span>
<a name="l00184"></a>00184 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Playtones&lt;/ref&gt;</span>
<a name="l00185"></a>00185 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Hangup&lt;/ref&gt;</span>
<a name="l00186"></a>00186 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00187"></a>00187 <span class="comment">   &lt;/application&gt;</span>
<a name="l00188"></a>00188 <span class="comment">   &lt;application name=&quot;Congestion&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00189"></a>00189 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00190"></a>00190 <span class="comment">         Indicate the Congestion condition.</span>
<a name="l00191"></a>00191 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00192"></a>00192 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00193"></a>00193 <span class="comment">         &lt;parameter name=&quot;timeout&quot;&gt;</span>
<a name="l00194"></a>00194 <span class="comment">            &lt;para&gt;If specified, the calling channel will be hung up after the specified number of seconds.</span>
<a name="l00195"></a>00195 <span class="comment">            Otherwise, this application will wait until the calling channel hangs up.&lt;/para&gt;</span>
<a name="l00196"></a>00196 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00197"></a>00197 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00198"></a>00198 <span class="comment">      &lt;description&gt;</span>
<a name="l00199"></a>00199 <span class="comment">         &lt;para&gt;This application will indicate the congestion condition to the calling channel.&lt;/para&gt;</span>
<a name="l00200"></a>00200 <span class="comment">      &lt;/description&gt;</span>
<a name="l00201"></a>00201 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00202"></a>00202 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Busy&lt;/ref&gt;</span>
<a name="l00203"></a>00203 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Progess&lt;/ref&gt;</span>
<a name="l00204"></a>00204 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Playtones&lt;/ref&gt;</span>
<a name="l00205"></a>00205 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Hangup&lt;/ref&gt;</span>
<a name="l00206"></a>00206 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00207"></a>00207 <span class="comment">   &lt;/application&gt;</span>
<a name="l00208"></a>00208 <span class="comment">   &lt;application name=&quot;ExecIfTime&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00209"></a>00209 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00210"></a>00210 <span class="comment">         Conditional application execution based on the current time.</span>
<a name="l00211"></a>00211 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00212"></a>00212 <span class="comment">      &lt;syntax argsep=&quot;?&quot;&gt;</span>
<a name="l00213"></a>00213 <span class="comment">         &lt;parameter name=&quot;day_condition&quot; required=&quot;true&quot;&gt;</span>
<a name="l00214"></a>00214 <span class="comment">            &lt;argument name=&quot;times&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00215"></a>00215 <span class="comment">            &lt;argument name=&quot;weekdays&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00216"></a>00216 <span class="comment">            &lt;argument name=&quot;mdays&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00217"></a>00217 <span class="comment">            &lt;argument name=&quot;months&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00218"></a>00218 <span class="comment">            &lt;argument name=&quot;timezone&quot; required=&quot;false&quot; /&gt;</span>
<a name="l00219"></a>00219 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00220"></a>00220 <span class="comment">         &lt;parameter name=&quot;appname&quot; required=&quot;true&quot; hasparams=&quot;optional&quot;&gt;</span>
<a name="l00221"></a>00221 <span class="comment">            &lt;argument name=&quot;appargs&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00222"></a>00222 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00223"></a>00223 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00224"></a>00224 <span class="comment">      &lt;description&gt;</span>
<a name="l00225"></a>00225 <span class="comment">         &lt;para&gt;This application will execute the specified dialplan application, with optional</span>
<a name="l00226"></a>00226 <span class="comment">         arguments, if the current time matches the given time specification.&lt;/para&gt;</span>
<a name="l00227"></a>00227 <span class="comment">      &lt;/description&gt;</span>
<a name="l00228"></a>00228 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00229"></a>00229 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Exec&lt;/ref&gt;</span>
<a name="l00230"></a>00230 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;TryExec&lt;/ref&gt;</span>
<a name="l00231"></a>00231 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00232"></a>00232 <span class="comment">   &lt;/application&gt;</span>
<a name="l00233"></a>00233 <span class="comment">   &lt;application name=&quot;Goto&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00234"></a>00234 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00235"></a>00235 <span class="comment">         Jump to a particular priority, extension, or context.</span>
<a name="l00236"></a>00236 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00237"></a>00237 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00238"></a>00238 <span class="comment">         &lt;parameter name=&quot;context&quot; /&gt;</span>
<a name="l00239"></a>00239 <span class="comment">         &lt;parameter name=&quot;extensions&quot; /&gt;</span>
<a name="l00240"></a>00240 <span class="comment">         &lt;parameter name=&quot;priority&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00241"></a>00241 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00242"></a>00242 <span class="comment">      &lt;description&gt;</span>
<a name="l00243"></a>00243 <span class="comment">         &lt;para&gt;This application will set the current context, extension, and priority in the channel structure.</span>
<a name="l00244"></a>00244 <span class="comment">         After it completes, the pbx engine will continue dialplan execution at the specified location.</span>
<a name="l00245"></a>00245 <span class="comment">         If no specific &lt;replaceable&gt;extension&lt;/replaceable&gt;, or &lt;replaceable&gt;extension&lt;/replaceable&gt; and</span>
<a name="l00246"></a>00246 <span class="comment">         &lt;replaceable&gt;context&lt;/replaceable&gt;, are specified, then this application will</span>
<a name="l00247"></a>00247 <span class="comment">         just set the specified &lt;replaceable&gt;priority&lt;/replaceable&gt; of the current extension.&lt;/para&gt;</span>
<a name="l00248"></a>00248 <span class="comment">         &lt;para&gt;At least a &lt;replaceable&gt;priority&lt;/replaceable&gt; is required as an argument, or the goto will</span>
<a name="l00249"></a>00249 <span class="comment">         return a &lt;literal&gt;-1&lt;/literal&gt;,  and the channel and call will be terminated.&lt;/para&gt;</span>
<a name="l00250"></a>00250 <span class="comment">         &lt;para&gt;If the location that is put into the channel information is bogus, and asterisk cannot</span>
<a name="l00251"></a>00251 <span class="comment">         find that location in the dialplan, then the execution engine will try to find and execute the code in</span>
<a name="l00252"></a>00252 <span class="comment">         the &lt;literal&gt;i&lt;/literal&gt; (invalid) extension in the current context. If that does not exist, it will try to execute the</span>
<a name="l00253"></a>00253 <span class="comment">         &lt;literal&gt;h&lt;/literal&gt; extension. If either or neither the &lt;literal&gt;h&lt;/literal&gt; or &lt;literal&gt;i&lt;/literal&gt; extensions</span>
<a name="l00254"></a>00254 <span class="comment">         have been defined, the channel is hung up, and the execution of instructions on the channel is terminated.</span>
<a name="l00255"></a>00255 <span class="comment">         What this means is that, for example, you specify a context that does not exist, then</span>
<a name="l00256"></a>00256 <span class="comment">         it will not be possible to find the &lt;literal&gt;h&lt;/literal&gt; or &lt;literal&gt;i&lt;/literal&gt; extensions,</span>
<a name="l00257"></a>00257 <span class="comment">         and the call will terminate!&lt;/para&gt;</span>
<a name="l00258"></a>00258 <span class="comment">      &lt;/description&gt;</span>
<a name="l00259"></a>00259 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00260"></a>00260 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;GotoIf&lt;/ref&gt;</span>
<a name="l00261"></a>00261 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;GotoIfTime&lt;/ref&gt;</span>
<a name="l00262"></a>00262 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Gosub&lt;/ref&gt;</span>
<a name="l00263"></a>00263 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Macro&lt;/ref&gt;</span>
<a name="l00264"></a>00264 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00265"></a>00265 <span class="comment">   &lt;/application&gt;</span>
<a name="l00266"></a>00266 <span class="comment">   &lt;application name=&quot;GotoIf&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00267"></a>00267 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00268"></a>00268 <span class="comment">         Conditional goto.</span>
<a name="l00269"></a>00269 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00270"></a>00270 <span class="comment">      &lt;syntax argsep=&quot;?&quot;&gt;</span>
<a name="l00271"></a>00271 <span class="comment">         &lt;parameter name=&quot;condition&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00272"></a>00272 <span class="comment">         &lt;parameter name=&quot;destination&quot; required=&quot;true&quot; argsep=&quot;:&quot;&gt;</span>
<a name="l00273"></a>00273 <span class="comment">            &lt;argument name=&quot;labeliftrue&quot;&gt;</span>
<a name="l00274"></a>00274 <span class="comment">               &lt;para&gt;Continue at &lt;replaceable&gt;labeliftrue&lt;/replaceable&gt; if the condition is true.&lt;/para&gt;</span>
<a name="l00275"></a>00275 <span class="comment">            &lt;/argument&gt;</span>
<a name="l00276"></a>00276 <span class="comment">            &lt;argument name=&quot;labeliffalse&quot;&gt;</span>
<a name="l00277"></a>00277 <span class="comment">               &lt;para&gt;Continue at &lt;replaceable&gt;labeliffalse&lt;/replaceable&gt; if the condition is false.&lt;/para&gt;</span>
<a name="l00278"></a>00278 <span class="comment">            &lt;/argument&gt;</span>
<a name="l00279"></a>00279 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00280"></a>00280 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00281"></a>00281 <span class="comment">      &lt;description&gt;</span>
<a name="l00282"></a>00282 <span class="comment">         &lt;para&gt;This application will set the current context, extension, and priority in the channel structure</span>
<a name="l00283"></a>00283 <span class="comment">         based on the evaluation of the given condition. After this application completes, the</span>
<a name="l00284"></a>00284 <span class="comment">         pbx engine will continue dialplan execution at the specified location in the dialplan.</span>
<a name="l00285"></a>00285 <span class="comment">         The labels are specified with the same syntax as used within the Goto application.</span>
<a name="l00286"></a>00286 <span class="comment">         If the label chosen by the condition is omitted, no jump is performed, and the execution passes to the</span>
<a name="l00287"></a>00287 <span class="comment">         next instruction. If the target location is bogus, and does not exist, the execution engine will try</span>
<a name="l00288"></a>00288 <span class="comment">         to find and execute the code in the &lt;literal&gt;i&lt;/literal&gt; (invalid) extension in the current context.</span>
<a name="l00289"></a>00289 <span class="comment">         If that does not exist, it will try to execute the &lt;literal&gt;h&lt;/literal&gt; extension.</span>
<a name="l00290"></a>00290 <span class="comment">         If either or neither the &lt;literal&gt;h&lt;/literal&gt; or &lt;literal&gt;i&lt;/literal&gt; extensions have been defined,</span>
<a name="l00291"></a>00291 <span class="comment">         the channel is hung up, and the execution of instructions on the channel is terminated.</span>
<a name="l00292"></a>00292 <span class="comment">         Remember that this command can set the current context, and if the context specified</span>
<a name="l00293"></a>00293 <span class="comment">         does not exist, then it will not be able to find any &apos;h&apos; or &apos;i&apos; extensions there, and</span>
<a name="l00294"></a>00294 <span class="comment">         the channel and call will both be terminated!.&lt;/para&gt;</span>
<a name="l00295"></a>00295 <span class="comment">      &lt;/description&gt;</span>
<a name="l00296"></a>00296 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00297"></a>00297 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Goto&lt;/ref&gt;</span>
<a name="l00298"></a>00298 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;GotoIfTime&lt;/ref&gt;</span>
<a name="l00299"></a>00299 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;GosubIf&lt;/ref&gt;</span>
<a name="l00300"></a>00300 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;MacroIf&lt;/ref&gt;</span>
<a name="l00301"></a>00301 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00302"></a>00302 <span class="comment">   &lt;/application&gt;</span>
<a name="l00303"></a>00303 <span class="comment">   &lt;application name=&quot;GotoIfTime&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00304"></a>00304 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00305"></a>00305 <span class="comment">         Conditional Goto based on the current time.</span>
<a name="l00306"></a>00306 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00307"></a>00307 <span class="comment">      &lt;syntax argsep=&quot;?&quot;&gt;</span>
<a name="l00308"></a>00308 <span class="comment">         &lt;parameter name=&quot;condition&quot; required=&quot;true&quot;&gt;</span>
<a name="l00309"></a>00309 <span class="comment">            &lt;argument name=&quot;times&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00310"></a>00310 <span class="comment">            &lt;argument name=&quot;weekdays&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00311"></a>00311 <span class="comment">            &lt;argument name=&quot;mdays&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00312"></a>00312 <span class="comment">            &lt;argument name=&quot;months&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00313"></a>00313 <span class="comment">            &lt;argument name=&quot;timezone&quot; required=&quot;false&quot; /&gt;</span>
<a name="l00314"></a>00314 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00315"></a>00315 <span class="comment">         &lt;parameter name=&quot;destination&quot; required=&quot;true&quot; argsep=&quot;:&quot;&gt;</span>
<a name="l00316"></a>00316 <span class="comment">            &lt;argument name=&quot;labeliftrue&quot; /&gt;</span>
<a name="l00317"></a>00317 <span class="comment">            &lt;argument name=&quot;labeliffalse&quot; /&gt;</span>
<a name="l00318"></a>00318 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00319"></a>00319 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00320"></a>00320 <span class="comment">      &lt;description&gt;</span>
<a name="l00321"></a>00321 <span class="comment">         &lt;para&gt;This application will set the context, extension, and priority in the channel structure</span>
<a name="l00322"></a>00322 <span class="comment">         based on the evaluation of the given time specification. After this application completes,</span>
<a name="l00323"></a>00323 <span class="comment">         the pbx engine will continue dialplan execution at the specified location in the dialplan.</span>
<a name="l00324"></a>00324 <span class="comment">         If the current time is within the given time specification, the channel will continue at</span>
<a name="l00325"></a>00325 <span class="comment">         &lt;replaceable&gt;labeliftrue&lt;/replaceable&gt;. Otherwise the channel will continue at &lt;replaceable&gt;labeliffalse&lt;/replaceable&gt;.</span>
<a name="l00326"></a>00326 <span class="comment">         If the label chosen by the condition is omitted, no jump is performed, and execution passes to the next</span>
<a name="l00327"></a>00327 <span class="comment">         instruction. If the target jump location is bogus, the same actions would be taken as for &lt;literal&gt;Goto&lt;/literal&gt;.</span>
<a name="l00328"></a>00328 <span class="comment">         Further information on the time specification can be found in examples</span>
<a name="l00329"></a>00329 <span class="comment">         illustrating how to do time-based context includes in the dialplan.&lt;/para&gt;</span>
<a name="l00330"></a>00330 <span class="comment">      &lt;/description&gt;</span>
<a name="l00331"></a>00331 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00332"></a>00332 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;GotoIf&lt;/ref&gt;</span>
<a name="l00333"></a>00333 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;IFTIME&lt;/ref&gt;</span>
<a name="l00334"></a>00334 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00335"></a>00335 <span class="comment">   &lt;/application&gt;</span>
<a name="l00336"></a>00336 <span class="comment">   &lt;application name=&quot;ImportVar&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00337"></a>00337 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00338"></a>00338 <span class="comment">         Import a variable from a channel into a new variable.</span>
<a name="l00339"></a>00339 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00340"></a>00340 <span class="comment">      &lt;syntax argsep=&quot;=&quot;&gt;</span>
<a name="l00341"></a>00341 <span class="comment">         &lt;parameter name=&quot;newvar&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00342"></a>00342 <span class="comment">         &lt;parameter name=&quot;vardata&quot; required=&quot;true&quot;&gt;</span>
<a name="l00343"></a>00343 <span class="comment">            &lt;argument name=&quot;channelname&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00344"></a>00344 <span class="comment">            &lt;argument name=&quot;variable&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00345"></a>00345 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00346"></a>00346 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00347"></a>00347 <span class="comment">      &lt;description&gt;</span>
<a name="l00348"></a>00348 <span class="comment">         &lt;para&gt;This application imports a &lt;replaceable&gt;variable&lt;/replaceable&gt; from the specified</span>
<a name="l00349"></a>00349 <span class="comment">         &lt;replaceable&gt;channel&lt;/replaceable&gt; (as opposed to the current one) and stores it as a variable</span>
<a name="l00350"></a>00350 <span class="comment">         (&lt;replaceable&gt;newvar&lt;/replaceable&gt;) in the current channel (the channel that is calling this</span>
<a name="l00351"></a>00351 <span class="comment">         application). Variables created by this application have the same inheritance properties as those</span>
<a name="l00352"></a>00352 <span class="comment">         created with the &lt;literal&gt;Set&lt;/literal&gt; application.&lt;/para&gt;</span>
<a name="l00353"></a>00353 <span class="comment">      &lt;/description&gt;</span>
<a name="l00354"></a>00354 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00355"></a>00355 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Set&lt;/ref&gt;</span>
<a name="l00356"></a>00356 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00357"></a>00357 <span class="comment">   &lt;/application&gt;</span>
<a name="l00358"></a>00358 <span class="comment">   &lt;application name=&quot;Hangup&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00359"></a>00359 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00360"></a>00360 <span class="comment">         Hang up the calling channel.</span>
<a name="l00361"></a>00361 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00362"></a>00362 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00363"></a>00363 <span class="comment">         &lt;parameter name=&quot;causecode&quot;&gt;</span>
<a name="l00364"></a>00364 <span class="comment">            &lt;para&gt;If a &lt;replaceable&gt;causecode&lt;/replaceable&gt; is given the channel&apos;s</span>
<a name="l00365"></a>00365 <span class="comment">            hangup cause will be set to the given value.&lt;/para&gt;</span>
<a name="l00366"></a>00366 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00367"></a>00367 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00368"></a>00368 <span class="comment">      &lt;description&gt;</span>
<a name="l00369"></a>00369 <span class="comment">         &lt;para&gt;This application will hang up the calling channel.&lt;/para&gt;</span>
<a name="l00370"></a>00370 <span class="comment">      &lt;/description&gt;</span>
<a name="l00371"></a>00371 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00372"></a>00372 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Answer&lt;/ref&gt;</span>
<a name="l00373"></a>00373 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Busy&lt;/ref&gt;</span>
<a name="l00374"></a>00374 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Congestion&lt;/ref&gt;</span>
<a name="l00375"></a>00375 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00376"></a>00376 <span class="comment">   &lt;/application&gt;</span>
<a name="l00377"></a>00377 <span class="comment">   &lt;application name=&quot;Incomplete&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00378"></a>00378 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00379"></a>00379 <span class="comment">         Returns AST_PBX_INCOMPLETE value.</span>
<a name="l00380"></a>00380 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00381"></a>00381 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00382"></a>00382 <span class="comment">         &lt;parameter name=&quot;n&quot;&gt;</span>
<a name="l00383"></a>00383 <span class="comment">            &lt;para&gt;If specified, then Incomplete will not attempt to answer the channel first.&lt;/para&gt;</span>
<a name="l00384"></a>00384 <span class="comment">            &lt;note&gt;&lt;para&gt;Most channel types need to be in Answer state in order to receive DTMF.&lt;/para&gt;&lt;/note&gt;</span>
<a name="l00385"></a>00385 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00386"></a>00386 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00387"></a>00387 <span class="comment">      &lt;description&gt;</span>
<a name="l00388"></a>00388 <span class="comment">         &lt;para&gt;Signals the PBX routines that the previous matched extension is incomplete</span>
<a name="l00389"></a>00389 <span class="comment">         and that further input should be allowed before matching can be considered</span>
<a name="l00390"></a>00390 <span class="comment">         to be complete.  Can be used within a pattern match when certain criteria warrants</span>
<a name="l00391"></a>00391 <span class="comment">         a longer match.&lt;/para&gt;</span>
<a name="l00392"></a>00392 <span class="comment">      &lt;/description&gt;</span>
<a name="l00393"></a>00393 <span class="comment">   &lt;/application&gt;</span>
<a name="l00394"></a>00394 <span class="comment">   &lt;application name=&quot;NoOp&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00395"></a>00395 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00396"></a>00396 <span class="comment">         Do Nothing (No Operation).</span>
<a name="l00397"></a>00397 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00398"></a>00398 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00399"></a>00399 <span class="comment">         &lt;parameter name=&quot;text&quot;&gt;</span>
<a name="l00400"></a>00400 <span class="comment">            &lt;para&gt;Any text provided can be viewed at the Asterisk CLI.&lt;/para&gt;</span>
<a name="l00401"></a>00401 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00402"></a>00402 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00403"></a>00403 <span class="comment">      &lt;description&gt;</span>
<a name="l00404"></a>00404 <span class="comment">         &lt;para&gt;This application does nothing. However, it is useful for debugging purposes.&lt;/para&gt;</span>
<a name="l00405"></a>00405 <span class="comment">         &lt;para&gt;This method can be used to see the evaluations of variables or functions without having any effect.&lt;/para&gt;</span>
<a name="l00406"></a>00406 <span class="comment">      &lt;/description&gt;</span>
<a name="l00407"></a>00407 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00408"></a>00408 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Verbose&lt;/ref&gt;</span>
<a name="l00409"></a>00409 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Log&lt;/ref&gt;</span>
<a name="l00410"></a>00410 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00411"></a>00411 <span class="comment">   &lt;/application&gt;</span>
<a name="l00412"></a>00412 <span class="comment">   &lt;application name=&quot;Proceeding&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00413"></a>00413 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00414"></a>00414 <span class="comment">         Indicate proceeding.</span>
<a name="l00415"></a>00415 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00416"></a>00416 <span class="comment">      &lt;syntax /&gt;</span>
<a name="l00417"></a>00417 <span class="comment">      &lt;description&gt;</span>
<a name="l00418"></a>00418 <span class="comment">         &lt;para&gt;This application will request that a proceeding message be provided to the calling channel.&lt;/para&gt;</span>
<a name="l00419"></a>00419 <span class="comment">      &lt;/description&gt;</span>
<a name="l00420"></a>00420 <span class="comment">   &lt;/application&gt;</span>
<a name="l00421"></a>00421 <span class="comment">   &lt;application name=&quot;Progress&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00422"></a>00422 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00423"></a>00423 <span class="comment">         Indicate progress.</span>
<a name="l00424"></a>00424 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00425"></a>00425 <span class="comment">      &lt;syntax /&gt;</span>
<a name="l00426"></a>00426 <span class="comment">      &lt;description&gt;</span>
<a name="l00427"></a>00427 <span class="comment">         &lt;para&gt;This application will request that in-band progress information be provided to the calling channel.&lt;/para&gt;</span>
<a name="l00428"></a>00428 <span class="comment">      &lt;/description&gt;</span>
<a name="l00429"></a>00429 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00430"></a>00430 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Busy&lt;/ref&gt;</span>
<a name="l00431"></a>00431 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Congestion&lt;/ref&gt;</span>
<a name="l00432"></a>00432 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Ringing&lt;/ref&gt;</span>
<a name="l00433"></a>00433 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Playtones&lt;/ref&gt;</span>
<a name="l00434"></a>00434 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00435"></a>00435 <span class="comment">   &lt;/application&gt;</span>
<a name="l00436"></a>00436 <span class="comment">   &lt;application name=&quot;RaiseException&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00437"></a>00437 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00438"></a>00438 <span class="comment">         Handle an exceptional condition.</span>
<a name="l00439"></a>00439 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00440"></a>00440 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00441"></a>00441 <span class="comment">         &lt;parameter name=&quot;reason&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00442"></a>00442 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00443"></a>00443 <span class="comment">      &lt;description&gt;</span>
<a name="l00444"></a>00444 <span class="comment">         &lt;para&gt;This application will jump to the &lt;literal&gt;e&lt;/literal&gt; extension in the current context, setting the</span>
<a name="l00445"></a>00445 <span class="comment">         dialplan function EXCEPTION(). If the &lt;literal&gt;e&lt;/literal&gt; extension does not exist, the call will hangup.&lt;/para&gt;</span>
<a name="l00446"></a>00446 <span class="comment">      &lt;/description&gt;</span>
<a name="l00447"></a>00447 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00448"></a>00448 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;Exception&lt;/ref&gt;</span>
<a name="l00449"></a>00449 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00450"></a>00450 <span class="comment">   &lt;/application&gt;</span>
<a name="l00451"></a>00451 <span class="comment">   &lt;application name=&quot;ResetCDR&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00452"></a>00452 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00453"></a>00453 <span class="comment">         Resets the Call Data Record.</span>
<a name="l00454"></a>00454 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00455"></a>00455 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00456"></a>00456 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00457"></a>00457 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00458"></a>00458 <span class="comment">               &lt;option name=&quot;w&quot;&gt;</span>
<a name="l00459"></a>00459 <span class="comment">                  &lt;para&gt;Store the current CDR record before resetting it.&lt;/para&gt;</span>
<a name="l00460"></a>00460 <span class="comment">               &lt;/option&gt;</span>
<a name="l00461"></a>00461 <span class="comment">               &lt;option name=&quot;a&quot;&gt;</span>
<a name="l00462"></a>00462 <span class="comment">                  &lt;para&gt;Store any stacked records.&lt;/para&gt;</span>
<a name="l00463"></a>00463 <span class="comment">               &lt;/option&gt;</span>
<a name="l00464"></a>00464 <span class="comment">               &lt;option name=&quot;v&quot;&gt;</span>
<a name="l00465"></a>00465 <span class="comment">                  &lt;para&gt;Save CDR variables.&lt;/para&gt;</span>
<a name="l00466"></a>00466 <span class="comment">               &lt;/option&gt;</span>
<a name="l00467"></a>00467 <span class="comment">               &lt;option name=&quot;e&quot;&gt;</span>
<a name="l00468"></a>00468 <span class="comment">                  &lt;para&gt;Enable CDR only (negate effects of NoCDR).&lt;/para&gt;</span>
<a name="l00469"></a>00469 <span class="comment">               &lt;/option&gt;</span>
<a name="l00470"></a>00470 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00471"></a>00471 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00472"></a>00472 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00473"></a>00473 <span class="comment">      &lt;description&gt;</span>
<a name="l00474"></a>00474 <span class="comment">         &lt;para&gt;This application causes the Call Data Record to be reset.&lt;/para&gt;</span>
<a name="l00475"></a>00475 <span class="comment">      &lt;/description&gt;</span>
<a name="l00476"></a>00476 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00477"></a>00477 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;ForkCDR&lt;/ref&gt;</span>
<a name="l00478"></a>00478 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;NoCDR&lt;/ref&gt;</span>
<a name="l00479"></a>00479 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00480"></a>00480 <span class="comment">   &lt;/application&gt;</span>
<a name="l00481"></a>00481 <span class="comment">   &lt;application name=&quot;Ringing&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00482"></a>00482 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00483"></a>00483 <span class="comment">         Indicate ringing tone.</span>
<a name="l00484"></a>00484 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00485"></a>00485 <span class="comment">      &lt;syntax /&gt;</span>
<a name="l00486"></a>00486 <span class="comment">      &lt;description&gt;</span>
<a name="l00487"></a>00487 <span class="comment">         &lt;para&gt;This application will request that the channel indicate a ringing tone to the user.&lt;/para&gt;</span>
<a name="l00488"></a>00488 <span class="comment">      &lt;/description&gt;</span>
<a name="l00489"></a>00489 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00490"></a>00490 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Busy&lt;/ref&gt;</span>
<a name="l00491"></a>00491 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Congestion&lt;/ref&gt;</span>
<a name="l00492"></a>00492 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Progress&lt;/ref&gt;</span>
<a name="l00493"></a>00493 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Playtones&lt;/ref&gt;</span>
<a name="l00494"></a>00494 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00495"></a>00495 <span class="comment">   &lt;/application&gt;</span>
<a name="l00496"></a>00496 <span class="comment">   &lt;application name=&quot;SayAlpha&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00497"></a>00497 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00498"></a>00498 <span class="comment">         Say Alpha.</span>
<a name="l00499"></a>00499 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00500"></a>00500 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00501"></a>00501 <span class="comment">         &lt;parameter name=&quot;string&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00502"></a>00502 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00503"></a>00503 <span class="comment">      &lt;description&gt;</span>
<a name="l00504"></a>00504 <span class="comment">         &lt;para&gt;This application will play the sounds that correspond to the letters of the</span>
<a name="l00505"></a>00505 <span class="comment">         given &lt;replaceable&gt;string&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00506"></a>00506 <span class="comment">      &lt;/description&gt;</span>
<a name="l00507"></a>00507 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00508"></a>00508 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;SayDigits&lt;/ref&gt;</span>
<a name="l00509"></a>00509 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;SayNumber&lt;/ref&gt;</span>
<a name="l00510"></a>00510 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;SayPhonetic&lt;/ref&gt;</span>
<a name="l00511"></a>00511 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;CHANNEL&lt;/ref&gt;</span>
<a name="l00512"></a>00512 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00513"></a>00513 <span class="comment">   &lt;/application&gt;</span>
<a name="l00514"></a>00514 <span class="comment">   &lt;application name=&quot;SayDigits&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00515"></a>00515 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00516"></a>00516 <span class="comment">         Say Digits.</span>
<a name="l00517"></a>00517 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00518"></a>00518 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00519"></a>00519 <span class="comment">         &lt;parameter name=&quot;digits&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00520"></a>00520 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00521"></a>00521 <span class="comment">      &lt;description&gt;</span>
<a name="l00522"></a>00522 <span class="comment">         &lt;para&gt;This application will play the sounds that correspond to the digits of</span>
<a name="l00523"></a>00523 <span class="comment">         the given number. This will use the language that is currently set for the channel.&lt;/para&gt;</span>
<a name="l00524"></a>00524 <span class="comment">      &lt;/description&gt;</span>
<a name="l00525"></a>00525 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00526"></a>00526 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;SayAlpha&lt;/ref&gt;</span>
<a name="l00527"></a>00527 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;SayNumber&lt;/ref&gt;</span>
<a name="l00528"></a>00528 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;SayPhonetic&lt;/ref&gt;</span>
<a name="l00529"></a>00529 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;CHANNEL&lt;/ref&gt;</span>
<a name="l00530"></a>00530 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00531"></a>00531 <span class="comment">   &lt;/application&gt;</span>
<a name="l00532"></a>00532 <span class="comment">   &lt;application name=&quot;SayNumber&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00533"></a>00533 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00534"></a>00534 <span class="comment">         Say Number.</span>
<a name="l00535"></a>00535 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00536"></a>00536 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00537"></a>00537 <span class="comment">         &lt;parameter name=&quot;digits&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00538"></a>00538 <span class="comment">         &lt;parameter name=&quot;gender&quot; /&gt;</span>
<a name="l00539"></a>00539 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00540"></a>00540 <span class="comment">      &lt;description&gt;</span>
<a name="l00541"></a>00541 <span class="comment">         &lt;para&gt;This application will play the sounds that correspond to the given &lt;replaceable&gt;digits&lt;/replaceable&gt;.</span>
<a name="l00542"></a>00542 <span class="comment">         Optionally, a &lt;replaceable&gt;gender&lt;/replaceable&gt; may be specified. This will use the language that is currently</span>
<a name="l00543"></a>00543 <span class="comment">         set for the channel. See the LANGUAGE() function for more information on setting the language for the channel.&lt;/para&gt;</span>
<a name="l00544"></a>00544 <span class="comment">      &lt;/description&gt;</span>
<a name="l00545"></a>00545 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00546"></a>00546 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;SayAlpha&lt;/ref&gt;</span>
<a name="l00547"></a>00547 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;SayDigits&lt;/ref&gt;</span>
<a name="l00548"></a>00548 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;SayPhonetic&lt;/ref&gt;</span>
<a name="l00549"></a>00549 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;CHANNEL&lt;/ref&gt;</span>
<a name="l00550"></a>00550 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00551"></a>00551 <span class="comment">   &lt;/application&gt;</span>
<a name="l00552"></a>00552 <span class="comment">   &lt;application name=&quot;SayPhonetic&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00553"></a>00553 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00554"></a>00554 <span class="comment">         Say Phonetic.</span>
<a name="l00555"></a>00555 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00556"></a>00556 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00557"></a>00557 <span class="comment">         &lt;parameter name=&quot;string&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00558"></a>00558 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00559"></a>00559 <span class="comment">      &lt;description&gt;</span>
<a name="l00560"></a>00560 <span class="comment">         &lt;para&gt;This application will play the sounds from the phonetic alphabet that correspond to the</span>
<a name="l00561"></a>00561 <span class="comment">         letters in the given &lt;replaceable&gt;string&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00562"></a>00562 <span class="comment">      &lt;/description&gt;</span>
<a name="l00563"></a>00563 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00564"></a>00564 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;SayAlpha&lt;/ref&gt;</span>
<a name="l00565"></a>00565 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;SayDigits&lt;/ref&gt;</span>
<a name="l00566"></a>00566 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;SayNumber&lt;/ref&gt;</span>
<a name="l00567"></a>00567 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00568"></a>00568 <span class="comment">   &lt;/application&gt;</span>
<a name="l00569"></a>00569 <span class="comment">   &lt;application name=&quot;Set&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00570"></a>00570 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00571"></a>00571 <span class="comment">         Set channel variable or function value.</span>
<a name="l00572"></a>00572 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00573"></a>00573 <span class="comment">      &lt;syntax argsep=&quot;=&quot;&gt;</span>
<a name="l00574"></a>00574 <span class="comment">         &lt;parameter name=&quot;name&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00575"></a>00575 <span class="comment">         &lt;parameter name=&quot;value&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00576"></a>00576 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00577"></a>00577 <span class="comment">      &lt;description&gt;</span>
<a name="l00578"></a>00578 <span class="comment">         &lt;para&gt;This function can be used to set the value of channel variables or dialplan functions.</span>
<a name="l00579"></a>00579 <span class="comment">         When setting variables, if the variable name is prefixed with &lt;literal&gt;_&lt;/literal&gt;,</span>
<a name="l00580"></a>00580 <span class="comment">         the variable will be inherited into channels created from the current channel.</span>
<a name="l00581"></a>00581 <span class="comment">         If the variable name is prefixed with &lt;literal&gt;__&lt;/literal&gt;, the variable will be</span>
<a name="l00582"></a>00582 <span class="comment">         inherited into channels created from the current channel and all children channels.&lt;/para&gt;</span>
<a name="l00583"></a>00583 <span class="comment">         &lt;note&gt;&lt;para&gt;If (and only if), in &lt;filename&gt;/etc/asterisk/asterisk.conf&lt;/filename&gt;, you have</span>
<a name="l00584"></a>00584 <span class="comment">         a &lt;literal&gt;[compat]&lt;/literal&gt; category, and you have &lt;literal&gt;app_set = 1.6&lt;/literal&gt; under that,then</span>
<a name="l00585"></a>00585 <span class="comment">         the behavior of this app changes, and does not strip surrounding quotes from the right hand side as</span>
<a name="l00586"></a>00586 <span class="comment">         it did previously in 1.4. The &lt;literal&gt;app_set = 1.6&lt;/literal&gt; is only inserted if &lt;literal&gt;make samples&lt;/literal&gt;</span>
<a name="l00587"></a>00587 <span class="comment">         is executed, or if users insert this by hand into the &lt;filename&gt;asterisk.conf&lt;/filename&gt; file.</span>
<a name="l00588"></a>00588 <span class="comment">         The advantages of not stripping out quoting, and not caring about the separator characters (comma and vertical bar)</span>
<a name="l00589"></a>00589 <span class="comment">         were sufficient to make these changes in 1.6. Confusion about how many backslashes would be needed to properly</span>
<a name="l00590"></a>00590 <span class="comment">         protect separators and quotes in various database access strings has been greatly</span>
<a name="l00591"></a>00591 <span class="comment">         reduced by these changes.&lt;/para&gt;&lt;/note&gt;</span>
<a name="l00592"></a>00592 <span class="comment">      &lt;/description&gt;</span>
<a name="l00593"></a>00593 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00594"></a>00594 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;MSet&lt;/ref&gt;</span>
<a name="l00595"></a>00595 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;GLOBAL&lt;/ref&gt;</span>
<a name="l00596"></a>00596 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;SET&lt;/ref&gt;</span>
<a name="l00597"></a>00597 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;ENV&lt;/ref&gt;</span>
<a name="l00598"></a>00598 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00599"></a>00599 <span class="comment">   &lt;/application&gt;</span>
<a name="l00600"></a>00600 <span class="comment">   &lt;application name=&quot;MSet&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00601"></a>00601 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00602"></a>00602 <span class="comment">         Set channel variable(s) or function value(s).</span>
<a name="l00603"></a>00603 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00604"></a>00604 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00605"></a>00605 <span class="comment">         &lt;parameter name=&quot;set1&quot; required=&quot;true&quot; argsep=&quot;=&quot;&gt;</span>
<a name="l00606"></a>00606 <span class="comment">            &lt;argument name=&quot;name1&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00607"></a>00607 <span class="comment">            &lt;argument name=&quot;value1&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00608"></a>00608 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00609"></a>00609 <span class="comment">         &lt;parameter name=&quot;set2&quot; multiple=&quot;true&quot; argsep=&quot;=&quot;&gt;</span>
<a name="l00610"></a>00610 <span class="comment">            &lt;argument name=&quot;name2&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00611"></a>00611 <span class="comment">            &lt;argument name=&quot;value2&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00612"></a>00612 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00613"></a>00613 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00614"></a>00614 <span class="comment">      &lt;description&gt;</span>
<a name="l00615"></a>00615 <span class="comment">         &lt;para&gt;This function can be used to set the value of channel variables or dialplan functions.</span>
<a name="l00616"></a>00616 <span class="comment">         When setting variables, if the variable name is prefixed with &lt;literal&gt;_&lt;/literal&gt;,</span>
<a name="l00617"></a>00617 <span class="comment">         the variable will be inherited into channels created from the current channel</span>
<a name="l00618"></a>00618 <span class="comment">         If the variable name is prefixed with &lt;literal&gt;__&lt;/literal&gt;, the variable will be</span>
<a name="l00619"></a>00619 <span class="comment">         inherited into channels created from the current channel and all children channels.</span>
<a name="l00620"></a>00620 <span class="comment">         MSet behaves in a similar fashion to the way Set worked in 1.2/1.4 and is thus</span>
<a name="l00621"></a>00621 <span class="comment">         prone to doing things that you may not expect. For example, it strips surrounding</span>
<a name="l00622"></a>00622 <span class="comment">         double-quotes from the right-hand side (value). If you need to put a separator</span>
<a name="l00623"></a>00623 <span class="comment">         character (comma or vert-bar), you will need to escape them by inserting a backslash</span>
<a name="l00624"></a>00624 <span class="comment">         before them. Avoid its use if possible.&lt;/para&gt;</span>
<a name="l00625"></a>00625 <span class="comment">      &lt;/description&gt;</span>
<a name="l00626"></a>00626 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00627"></a>00627 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Set&lt;/ref&gt;</span>
<a name="l00628"></a>00628 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00629"></a>00629 <span class="comment">   &lt;/application&gt;</span>
<a name="l00630"></a>00630 <span class="comment">   &lt;application name=&quot;SetAMAFlags&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00631"></a>00631 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00632"></a>00632 <span class="comment">         Set the AMA Flags.</span>
<a name="l00633"></a>00633 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00634"></a>00634 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00635"></a>00635 <span class="comment">         &lt;parameter name=&quot;flag&quot; /&gt;</span>
<a name="l00636"></a>00636 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00637"></a>00637 <span class="comment">      &lt;description&gt;</span>
<a name="l00638"></a>00638 <span class="comment">         &lt;para&gt;This application will set the channel&apos;s AMA Flags for billing purposes.&lt;/para&gt;</span>
<a name="l00639"></a>00639 <span class="comment">      &lt;/description&gt;</span>
<a name="l00640"></a>00640 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00641"></a>00641 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;CDR&lt;/ref&gt;</span>
<a name="l00642"></a>00642 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00643"></a>00643 <span class="comment">   &lt;/application&gt;</span>
<a name="l00644"></a>00644 <span class="comment">   &lt;application name=&quot;Wait&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00645"></a>00645 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00646"></a>00646 <span class="comment">         Waits for some time.</span>
<a name="l00647"></a>00647 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00648"></a>00648 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00649"></a>00649 <span class="comment">         &lt;parameter name=&quot;seconds&quot; required=&quot;true&quot;&gt;</span>
<a name="l00650"></a>00650 <span class="comment">            &lt;para&gt;Can be passed with fractions of a second. For example, &lt;literal&gt;1.5&lt;/literal&gt; will ask the</span>
<a name="l00651"></a>00651 <span class="comment">            application to wait for 1.5 seconds.&lt;/para&gt;</span>
<a name="l00652"></a>00652 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00653"></a>00653 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00654"></a>00654 <span class="comment">      &lt;description&gt;</span>
<a name="l00655"></a>00655 <span class="comment">         &lt;para&gt;This application waits for a specified number of &lt;replaceable&gt;seconds&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00656"></a>00656 <span class="comment">      &lt;/description&gt;</span>
<a name="l00657"></a>00657 <span class="comment">   &lt;/application&gt;</span>
<a name="l00658"></a>00658 <span class="comment">   &lt;application name=&quot;WaitExten&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00659"></a>00659 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00660"></a>00660 <span class="comment">         Waits for an extension to be entered.</span>
<a name="l00661"></a>00661 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00662"></a>00662 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00663"></a>00663 <span class="comment">         &lt;parameter name=&quot;seconds&quot;&gt;</span>
<a name="l00664"></a>00664 <span class="comment">            &lt;para&gt;Can be passed with fractions of a second. For example, &lt;literal&gt;1.5&lt;/literal&gt; will ask the</span>
<a name="l00665"></a>00665 <span class="comment">            application to wait for 1.5 seconds.&lt;/para&gt;</span>
<a name="l00666"></a>00666 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00667"></a>00667 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00668"></a>00668 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00669"></a>00669 <span class="comment">               &lt;option name=&quot;m&quot;&gt;</span>
<a name="l00670"></a>00670 <span class="comment">                  &lt;para&gt;Provide music on hold to the caller while waiting for an extension.&lt;/para&gt;</span>
<a name="l00671"></a>00671 <span class="comment">                  &lt;argument name=&quot;x&quot;&gt;</span>
<a name="l00672"></a>00672 <span class="comment">                     &lt;para&gt;Specify the class for music on hold.&lt;/para&gt;</span>
<a name="l00673"></a>00673 <span class="comment">                  &lt;/argument&gt;</span>
<a name="l00674"></a>00674 <span class="comment">               &lt;/option&gt;</span>
<a name="l00675"></a>00675 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00676"></a>00676 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00677"></a>00677 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00678"></a>00678 <span class="comment">      &lt;description&gt;</span>
<a name="l00679"></a>00679 <span class="comment">         &lt;para&gt;This application waits for the user to enter a new extension for a specified number</span>
<a name="l00680"></a>00680 <span class="comment">         of &lt;replaceable&gt;seconds&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00681"></a>00681 <span class="comment">         &lt;xi:include xpointer=&quot;xpointer(/docs/application[@name=&apos;Macro&apos;]/description/warning[2])&quot; /&gt;</span>
<a name="l00682"></a>00682 <span class="comment">      &lt;/description&gt;</span>
<a name="l00683"></a>00683 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00684"></a>00684 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Background&lt;/ref&gt;</span>
<a name="l00685"></a>00685 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;TIMEOUT&lt;/ref&gt;</span>
<a name="l00686"></a>00686 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00687"></a>00687 <span class="comment">   &lt;/application&gt;</span>
<a name="l00688"></a>00688 <span class="comment">   &lt;function name=&quot;EXCEPTION&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00689"></a>00689 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00690"></a>00690 <span class="comment">         Retrieve the details of the current dialplan exception.</span>
<a name="l00691"></a>00691 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00692"></a>00692 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00693"></a>00693 <span class="comment">         &lt;parameter name=&quot;field&quot; required=&quot;true&quot;&gt;</span>
<a name="l00694"></a>00694 <span class="comment">            &lt;para&gt;The following fields are available for retrieval:&lt;/para&gt;</span>
<a name="l00695"></a>00695 <span class="comment">            &lt;enumlist&gt;</span>
<a name="l00696"></a>00696 <span class="comment">               &lt;enum name=&quot;reason&quot;&gt;</span>
<a name="l00697"></a>00697 <span class="comment">                  &lt;para&gt;INVALID, ERROR, RESPONSETIMEOUT, ABSOLUTETIMEOUT, or custom</span>
<a name="l00698"></a>00698 <span class="comment">                  value set by the RaiseException() application&lt;/para&gt;</span>
<a name="l00699"></a>00699 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00700"></a>00700 <span class="comment">               &lt;enum name=&quot;context&quot;&gt;</span>
<a name="l00701"></a>00701 <span class="comment">                  &lt;para&gt;The context executing when the exception occurred.&lt;/para&gt;</span>
<a name="l00702"></a>00702 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00703"></a>00703 <span class="comment">               &lt;enum name=&quot;exten&quot;&gt;</span>
<a name="l00704"></a>00704 <span class="comment">                  &lt;para&gt;The extension executing when the exception occurred.&lt;/para&gt;</span>
<a name="l00705"></a>00705 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00706"></a>00706 <span class="comment">               &lt;enum name=&quot;priority&quot;&gt;</span>
<a name="l00707"></a>00707 <span class="comment">                  &lt;para&gt;The numeric priority executing when the exception occurred.&lt;/para&gt;</span>
<a name="l00708"></a>00708 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00709"></a>00709 <span class="comment">            &lt;/enumlist&gt;</span>
<a name="l00710"></a>00710 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00711"></a>00711 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00712"></a>00712 <span class="comment">      &lt;description&gt;</span>
<a name="l00713"></a>00713 <span class="comment">         &lt;para&gt;Retrieve the details (specified &lt;replaceable&gt;field&lt;/replaceable&gt;) of the current dialplan exception.&lt;/para&gt;</span>
<a name="l00714"></a>00714 <span class="comment">      &lt;/description&gt;</span>
<a name="l00715"></a>00715 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00716"></a>00716 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;RaiseException&lt;/ref&gt;</span>
<a name="l00717"></a>00717 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00718"></a>00718 <span class="comment">   &lt;/function&gt;</span>
<a name="l00719"></a>00719 <span class="comment"> ***/</span>
<a name="l00720"></a>00720 
<a name="l00721"></a>00721 <span class="preprocessor">#ifdef LOW_MEMORY</span>
<a name="l00722"></a>00722 <span class="preprocessor"></span><span class="preprocessor">#define EXT_DATA_SIZE 256</span>
<a name="l00723"></a>00723 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00724"></a><a class="code" href="pbx_8c.html#ab07357218392804a25091a0a5d03d260">00724</a> <span class="preprocessor"></span><span class="preprocessor">#define EXT_DATA_SIZE 8192</span>
<a name="l00725"></a>00725 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00726"></a>00726 <span class="preprocessor"></span>
<a name="l00727"></a><a class="code" href="pbx_8c.html#afc730834643b17952148c5bb2f994165">00727</a> <span class="preprocessor">#define SWITCH_DATA_LENGTH 256</span>
<a name="l00728"></a>00728 <span class="preprocessor"></span>
<a name="l00729"></a><a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">00729</a> <span class="preprocessor">#define VAR_BUF_SIZE 4096</span>
<a name="l00730"></a>00730 <span class="preprocessor"></span>
<a name="l00731"></a><a class="code" href="pbx_8c.html#a4f144864da23f83e16ce1d29946b5164">00731</a> <span class="preprocessor">#define  VAR_NORMAL     1</span>
<a name="l00732"></a><a class="code" href="pbx_8c.html#a0afa9d9f36f92f8e1dc608c717f2064b">00732</a> <span class="preprocessor"></span><span class="preprocessor">#define  VAR_SOFTTRAN   2</span>
<a name="l00733"></a><a class="code" href="pbx_8c.html#ab53568989f7bec56ada5db0d3c25f87b">00733</a> <span class="preprocessor"></span><span class="preprocessor">#define  VAR_HARDTRAN   3</span>
<a name="l00734"></a>00734 <span class="preprocessor"></span>
<a name="l00735"></a><a class="code" href="pbx_8c.html#a95d317328467a30745a66647d2d232b1">00735</a> <span class="preprocessor">#define BACKGROUND_SKIP    (1 &lt;&lt; 0)</span>
<a name="l00736"></a><a class="code" href="pbx_8c.html#a248fc16b454bba0625d03d7d51efab8a">00736</a> <span class="preprocessor"></span><span class="preprocessor">#define BACKGROUND_NOANSWER   (1 &lt;&lt; 1)</span>
<a name="l00737"></a><a class="code" href="pbx_8c.html#a9e2cebe13600680593a802b3189f0b27">00737</a> <span class="preprocessor"></span><span class="preprocessor">#define BACKGROUND_MATCHEXTEN (1 &lt;&lt; 2)</span>
<a name="l00738"></a><a class="code" href="pbx_8c.html#a90814d9147f1b02a8e33667d6400c43d">00738</a> <span class="preprocessor"></span><span class="preprocessor">#define BACKGROUND_PLAYBACK   (1 &lt;&lt; 3)</span>
<a name="l00739"></a>00739 <span class="preprocessor"></span>
<a name="l00740"></a>00740 <a class="code" href="app_8h.html#a520a3c6b7d57903d9a616051da1a019d" title="Declares an array of options for an application.">AST_APP_OPTIONS</a>(<a class="code" href="pbx_8c.html#a7d8f03c22efbc83c74240c45229c1ce9">background_opts</a>, {
<a name="l00741"></a>00741    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;s&apos;</span>, <a class="code" href="pbx_8c.html#a95d317328467a30745a66647d2d232b1">BACKGROUND_SKIP</a>),
<a name="l00742"></a>00742    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;n&apos;</span>, <a class="code" href="pbx_8c.html#a248fc16b454bba0625d03d7d51efab8a">BACKGROUND_NOANSWER</a>),
<a name="l00743"></a>00743    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;m&apos;</span>, <a class="code" href="pbx_8c.html#a9e2cebe13600680593a802b3189f0b27">BACKGROUND_MATCHEXTEN</a>),
<a name="l00744"></a>00744    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;p&apos;</span>, <a class="code" href="pbx_8c.html#a90814d9147f1b02a8e33667d6400c43d">BACKGROUND_PLAYBACK</a>),
<a name="l00745"></a><a class="code" href="pbx_8c.html#a7d8f03c22efbc83c74240c45229c1ce9">00745</a> });
<a name="l00746"></a>00746 
<a name="l00747"></a><a class="code" href="pbx_8c.html#a0e259130f0ff2cd87950ae18493ce7c1">00747</a> <span class="preprocessor">#define WAITEXTEN_MOH      (1 &lt;&lt; 0)</span>
<a name="l00748"></a><a class="code" href="pbx_8c.html#a359267485801a1ea1e310520cf44e698">00748</a> <span class="preprocessor"></span><span class="preprocessor">#define WAITEXTEN_DIALTONE (1 &lt;&lt; 1)</span>
<a name="l00749"></a>00749 <span class="preprocessor"></span>
<a name="l00750"></a>00750 <a class="code" href="app_8h.html#a520a3c6b7d57903d9a616051da1a019d" title="Declares an array of options for an application.">AST_APP_OPTIONS</a>(<a class="code" href="pbx_8c.html#a89c4b430fb75cf73d9aac833701ee3e2">waitexten_opts</a>, {
<a name="l00751"></a>00751    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;m&apos;</span>, <a class="code" href="pbx_8c.html#a0e259130f0ff2cd87950ae18493ce7c1">WAITEXTEN_MOH</a>, 0),
<a name="l00752"></a>00752    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;d&apos;</span>, <a class="code" href="pbx_8c.html#a359267485801a1ea1e310520cf44e698">WAITEXTEN_DIALTONE</a>, 0),
<a name="l00753"></a><a class="code" href="pbx_8c.html#a89c4b430fb75cf73d9aac833701ee3e2">00753</a> });
<a name="l00754"></a>00754 
<a name="l00755"></a>00755 <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a>;
<a name="l00756"></a>00756 <span class="keyword">struct </span><a class="code" href="structast__app.html" title="ast_app: A registered application">ast_app</a>;
<a name="l00757"></a>00757 
<a name="l00758"></a><a class="code" href="pbx_8c.html#ad8ddef01864220bd5b800060f0afbe17">00758</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__taskprocessor.html" title="A ast_taskprocessor structure is a singleton by name.">ast_taskprocessor</a> *<a class="code" href="pbx_8c.html#ad8ddef01864220bd5b800060f0afbe17">device_state_tps</a>;
<a name="l00759"></a>00759 
<a name="l00760"></a><a class="code" href="pbx_8c.html#a34c5d02998c18d892113d659590cd28e">00760</a> <a class="code" href="threadstorage_8h.html#ac268c0a8272ec11e73269392507fb1a6" title="Define a thread storage variable.">AST_THREADSTORAGE</a>(<a class="code" href="pbx_8c.html#a34c5d02998c18d892113d659590cd28e">switch_data</a>);
<a name="l00761"></a><a class="code" href="pbx_8c.html#ac5308f5883751f800daddb3dfbdd7480">00761</a> <a class="code" href="threadstorage_8h.html#ac268c0a8272ec11e73269392507fb1a6" title="Define a thread storage variable.">AST_THREADSTORAGE</a>(<a class="code" href="pbx_8c.html#ac5308f5883751f800daddb3dfbdd7480">extensionstate_buf</a>);
<a name="l00762"></a>00762 <span class="comment"></span>
<a name="l00763"></a>00763 <span class="comment">/*!</span>
<a name="l00764"></a>00764 <span class="comment">   \brief ast_exten: An extension</span>
<a name="l00765"></a>00765 <span class="comment">   The dialplan is saved as a linked list with each context</span>
<a name="l00766"></a>00766 <span class="comment">   having it&apos;s own linked list of extensions - one item per</span>
<a name="l00767"></a>00767 <span class="comment">   priority.</span>
<a name="l00768"></a>00768 <span class="comment">*/</span>
<a name="l00769"></a><a class="code" href="structast__exten.html">00769</a> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> {
<a name="l00770"></a><a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">00770</a>    <span class="keywordtype">char</span> *<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>;         <span class="comment">/*!&lt; Extension name */</span>
<a name="l00771"></a><a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">00771</a>    <span class="keywordtype">int</span> <a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a>;        <span class="comment">/*!&lt; Match caller id ? */</span>
<a name="l00772"></a><a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">00772</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>;      <span class="comment">/*!&lt; Caller id to match for this extension */</span>
<a name="l00773"></a><a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">00773</a>    <span class="keywordtype">int</span> <a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>;        <span class="comment">/*!&lt; Priority */</span>
<a name="l00774"></a><a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">00774</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>;      <span class="comment">/*!&lt; Label */</span>
<a name="l00775"></a><a class="code" href="structast__exten.html#a7733606f3f625c2782402ba971995641">00775</a>    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="structast__exten.html#a7733606f3f625c2782402ba971995641">parent</a>;   <span class="comment">/*!&lt; The context this extension belongs to  */</span>
<a name="l00776"></a><a class="code" href="structast__exten.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">00776</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__exten.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">app</a>;     <span class="comment">/*!&lt; Application to execute */</span>
<a name="l00777"></a><a class="code" href="structast__exten.html#a595b923ccb74fb5923f3de8bc77adc50">00777</a>    <span class="keyword">struct </span><a class="code" href="structast__app.html" title="ast_app: A registered application">ast_app</a> *<a class="code" href="structast__exten.html#a595b923ccb74fb5923f3de8bc77adc50">cached_app</a>;     <span class="comment">/*!&lt; Cached location of application */</span>
<a name="l00778"></a><a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">00778</a>    <span class="keywordtype">void</span> *<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a>;       <span class="comment">/*!&lt; Data to use (arguments) */</span>
<a name="l00779"></a>00779    void (*<a class="code" href="structast__exten.html#ad11dc8dd7d18a2cf6451b32ea529221c">datad</a>)(<span class="keywordtype">void</span> *);     <span class="comment">/*!&lt; Data destructor */</span>
<a name="l00780"></a><a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">00780</a>    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>;    <span class="comment">/*!&lt; Next higher priority with our extension */</span>
<a name="l00781"></a><a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">00781</a>    <span class="keyword">struct </span><a class="code" href="structast__hashtab.html">ast_hashtab</a> *<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>;    <span class="comment">/*!&lt; Priorities list in hashtab form -- only on the head of the peer list */</span>
<a name="l00782"></a><a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">00782</a>    <span class="keyword">struct </span><a class="code" href="structast__hashtab.html">ast_hashtab</a> *<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>; <span class="comment">/*!&lt; labeled priorities in the peers -- only on the head of the peer list */</span>
<a name="l00783"></a><a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">00783</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>;     <span class="comment">/*!&lt; Registrar */</span>
<a name="l00784"></a><a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">00784</a>    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>;    <span class="comment">/*!&lt; Extension with a greater ID */</span>
<a name="l00785"></a><a class="code" href="structast__exten.html#a7af2365ea6fa5bbbf507c1666e946824">00785</a>    <span class="keywordtype">char</span> <a class="code" href="structast__exten.html#a7af2365ea6fa5bbbf507c1666e946824">stuff</a>[0];
<a name="l00786"></a>00786 };
<a name="l00787"></a>00787 <span class="comment"></span>
<a name="l00788"></a>00788 <span class="comment">/*! \brief ast_include: include= support in extensions.conf */</span>
<a name="l00789"></a><a class="code" href="structast__include.html">00789</a> <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> {
<a name="l00790"></a><a class="code" href="structast__include.html#a8f8f80d37794cde9472343e4487ba3eb">00790</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__include.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;
<a name="l00791"></a><a class="code" href="structast__include.html#a0fc4d731325a10cc181d26c7e5549b40">00791</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__include.html#a0fc4d731325a10cc181d26c7e5549b40">rname</a>;         <span class="comment">/*!&lt; Context to include */</span>
<a name="l00792"></a><a class="code" href="structast__include.html#aa05090666ce7a4905fe1b56b4fdd3be3">00792</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__include.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>;        <span class="comment">/*!&lt; Registrar */</span>
<a name="l00793"></a><a class="code" href="structast__include.html#a5e1a4fa8d4d02bae74f72169ade15143">00793</a>    <span class="keywordtype">int</span> <a class="code" href="structast__include.html#a5e1a4fa8d4d02bae74f72169ade15143">hastime</a>;            <span class="comment">/*!&lt; If time construct exists */</span>
<a name="l00794"></a><a class="code" href="structast__include.html#a137134920b381175bea34c57d2565f91">00794</a>    <span class="keyword">struct </span><a class="code" href="structast__timing.html">ast_timing</a> <a class="code" href="structast__include.html#a137134920b381175bea34c57d2565f91">timing</a>;               <span class="comment">/*!&lt; time construct */</span>
<a name="l00795"></a><a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">00795</a>    <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a>;     <span class="comment">/*!&lt; Link them together */</span>
<a name="l00796"></a><a class="code" href="structast__include.html#a7af2365ea6fa5bbbf507c1666e946824">00796</a>    <span class="keywordtype">char</span> <a class="code" href="structast__include.html#a7af2365ea6fa5bbbf507c1666e946824">stuff</a>[0];
<a name="l00797"></a>00797 };
<a name="l00798"></a>00798 <span class="comment"></span>
<a name="l00799"></a>00799 <span class="comment">/*! \brief ast_sw: Switch statement in extensions.conf */</span>
<a name="l00800"></a><a class="code" href="structast__sw.html">00800</a> <span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> {
<a name="l00801"></a><a class="code" href="structast__sw.html#a5ac083a645d964373f022d03df4849c8">00801</a>    <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#a5ac083a645d964373f022d03df4849c8">name</a>;
<a name="l00802"></a><a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">00802</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>;        <span class="comment">/*!&lt; Registrar */</span>
<a name="l00803"></a><a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">00803</a>    <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a>;          <span class="comment">/*!&lt; Data load */</span>
<a name="l00804"></a><a class="code" href="structast__sw.html#a4e3f077fec8b035a2678e7740f366dea">00804</a>    <span class="keywordtype">int</span> <a class="code" href="structast__sw.html#a4e3f077fec8b035a2678e7740f366dea">eval</a>;
<a name="l00805"></a><a class="code" href="structast__sw.html#a9dba44603dc55a347a5cbe388aeac9f0">00805</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a>) <a class="code" href="structast__sw.html#a7012dbab4ff0b0e3f8df13e88a017b18">list</a>;
<a name="l00806"></a><a class="code" href="structast__sw.html#a7af2365ea6fa5bbbf507c1666e946824">00806</a>    <span class="keywordtype">char</span> <a class="code" href="structast__sw.html#a7af2365ea6fa5bbbf507c1666e946824">stuff</a>[0];
<a name="l00807"></a>00807 };
<a name="l00808"></a>00808 <span class="comment"></span>
<a name="l00809"></a>00809 <span class="comment">/*! \brief ast_ignorepat: Ignore patterns in dial plan */</span>
<a name="l00810"></a><a class="code" href="structast__ignorepat.html">00810</a> struct <a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> {
<a name="l00811"></a><a class="code" href="structast__ignorepat.html#aa05090666ce7a4905fe1b56b4fdd3be3">00811</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>;
<a name="l00812"></a><a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">00812</a>    <span class="keyword">struct </span>ast_ignorepat *<a class="code" href="structast__sw.html#a9dba44603dc55a347a5cbe388aeac9f0">next</a>;
<a name="l00813"></a><a class="code" href="structast__ignorepat.html#a22c50d97e30c98ae5e62eaed74605c78">00813</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="structast__ignorepat.html#a22c50d97e30c98ae5e62eaed74605c78">pattern</a>[0];
<a name="l00814"></a>00814 };
<a name="l00815"></a>00815 <span class="comment"></span>
<a name="l00816"></a>00816 <span class="comment">/*! \brief match_char: forms a syntax tree for quick matching of extension patterns */</span>
<a name="l00817"></a><a class="code" href="structmatch__char.html">00817</a> <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a>
<a name="l00818"></a>00818 {
<a name="l00819"></a><a class="code" href="structmatch__char.html#a67e42f878971513be0d2fa914019a38d">00819</a>    <span class="keywordtype">int</span> is_pattern; <span class="comment">/* the pattern started with &apos;_&apos; */</span>
<a name="l00820"></a><a class="code" href="structmatch__char.html#a3cb0d95aa820737d010fdfaccac92ec3">00820</a>    <span class="keywordtype">int</span> deleted;    <span class="comment">/* if this is set, then... don&apos;t return it */</span>
<a name="l00821"></a><a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">00821</a>    <span class="keywordtype">char</span> *x;       <span class="comment">/* the pattern itself-- matches a single char */</span>
<a name="l00822"></a><a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">00822</a>    <span class="keywordtype">int</span> specificity; <span class="comment">/* simply the strlen of x, or 10 for X, 9 for Z, and 8 for N; and &apos;.&apos; and &apos;!&apos; will add 11 ? */</span>
<a name="l00823"></a><a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">00823</a>    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>;
<a name="l00824"></a><a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">00824</a>    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>;
<a name="l00825"></a><a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">00825</a>    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>; <span class="comment">/* attached to last char of a pattern for exten */</span>
<a name="l00826"></a>00826 };
<a name="l00827"></a>00827 
<a name="l00828"></a><a class="code" href="structscoreboard.html">00828</a> <span class="keyword">struct </span><a class="code" href="structscoreboard.html">scoreboard</a>  <span class="comment">/* make sure all fields are 0 before calling new_find_extension */</span>
<a name="l00829"></a>00829 {
<a name="l00830"></a><a class="code" href="structscoreboard.html#a4de425bb2743e2e19c2e954dfe1f0bf8">00830</a>    <span class="keywordtype">int</span> total_specificity;
<a name="l00831"></a><a class="code" href="structscoreboard.html#a411afdaaca990dd80881e20637dc44af">00831</a>    <span class="keywordtype">int</span> total_length;
<a name="l00832"></a><a class="code" href="structscoreboard.html#a58353d0395200b159f144de279d0a9b2">00832</a>    <span class="keywordtype">char</span> last_char;   <span class="comment">/* set to ! or . if they are the end of the pattern */</span>
<a name="l00833"></a><a class="code" href="structscoreboard.html#a0cfb5b2675ee3fe3abfe9b5a7aee6329">00833</a>    <span class="keywordtype">int</span> <a class="code" href="pbx__lua_8c.html#a161611b39a822c50ab75c350a69eedd2">canmatch</a>;     <span class="comment">/* if the string to match was just too short */</span>
<a name="l00834"></a><a class="code" href="structscoreboard.html#ae6f7c8319cca7a79bdab95ecfa8b57eb">00834</a>    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *node;
<a name="l00835"></a><a class="code" href="structscoreboard.html#afd6db51221fa39c96b9469fa115db1cb">00835</a>    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *canmatch_exten;
<a name="l00836"></a><a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">00836</a>    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>;
<a name="l00837"></a>00837 };
<a name="l00838"></a>00838 <span class="comment"></span>
<a name="l00839"></a>00839 <span class="comment">/*! \brief ast_context: An extension context */</span>
<a name="l00840"></a><a class="code" href="structast__context.html">00840</a> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> {
<a name="l00841"></a><a class="code" href="structast__context.html#ace4e0066a5b24f84b90536e9906619f6">00841</a>    <a class="code" href="lock_8h.html#af7598796d461f7dcb95cea6be65806f8">ast_rwlock_t</a> <a class="code" href="app__meetme_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>;         <span class="comment">/*!&lt; A lock to prevent multiple threads from clobbering the context */</span>
<a name="l00842"></a><a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">00842</a>    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *root;       <span class="comment">/*!&lt; The root of the list of extensions */</span>
<a name="l00843"></a><a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">00843</a>    <span class="keyword">struct </span><a class="code" href="structast__hashtab.html">ast_hashtab</a> *root_table;            <span class="comment">/*!&lt; For exact matches on the extensions in the pattern tree, and for traversals of the pattern_tree  */</span>
<a name="l00844"></a><a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">00844</a>    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *pattern_tree;        <span class="comment">/*!&lt; A tree to speed up extension pattern matching */</span>
<a name="l00845"></a><a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">00845</a>    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="structast__sw.html#a9dba44603dc55a347a5cbe388aeac9f0">next</a>;     <span class="comment">/*!&lt; Link them together */</span>
<a name="l00846"></a><a class="code" href="structast__context.html#abaa8691efe3e8fe26f5930720bfd8edb">00846</a>    <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *includes;    <span class="comment">/*!&lt; Include other contexts */</span>
<a name="l00847"></a><a class="code" href="structast__context.html#aedb0afcd332920e51d2f82860f794347">00847</a>    <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ignorepats;   <span class="comment">/*!&lt; Patterns for which to continue playing dialtone */</span>
<a name="l00848"></a><a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">00848</a>    <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>;        <span class="comment">/*!&lt; Registrar -- make sure you malloc this, as the registrar may have to survive module unloads */</span>
<a name="l00849"></a><a class="code" href="structast__context.html#a6022c8a609170c7365fb96e83cb2df48">00849</a>    <span class="keywordtype">int</span> refcount;                   <span class="comment">/*!&lt; each module that would have created this context should inc/dec this as appropriate */</span>
<a name="l00850"></a><a class="code" href="structast__context.html#ae59b83ffcc6f20181a385cffbb6cabcb">00850</a>    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a>) alts;   <span class="comment">/*!&lt; Alternative switches */</span>
<a name="l00851"></a><a class="code" href="structast__context.html#a34eb63008d294b713376e64bb2a7b2ef">00851</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> macrolock;        <span class="comment">/*!&lt; A lock to implement &quot;exclusive&quot; macros - held whilst a call is executing in the macro */</span>
<a name="l00852"></a><a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">00852</a>    <span class="keywordtype">char</span> <a class="code" href="structast__sw.html#a5ac083a645d964373f022d03df4849c8">name</a>[0];           <span class="comment">/*!&lt; Name of the context */</span>
<a name="l00853"></a>00853 };
<a name="l00854"></a>00854 <span class="comment"></span>
<a name="l00855"></a>00855 <span class="comment">/*! \brief ast_app: A registered application */</span>
<a name="l00856"></a><a class="code" href="structast__app.html">00856</a> struct <a class="code" href="structast__app.html" title="ast_app: A registered application">ast_app</a> {
<a name="l00857"></a>00857    int (*execute)(<span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a>);
<a name="l00858"></a>00858    <a class="code" href="stringfields_8h.html#a061580e89c55282a7140fa3fdfd52b6d" title="Declare the fields needed in a structure.">AST_DECLARE_STRING_FIELDS</a>(
<a name="l00859"></a>00859       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="app__externalivr_8c.html#afa26529a1480355101f5b6d883a7d37e">synopsis</a>);     <span class="comment">/*!&lt; Synopsis text for &apos;show applications&apos; */</span>
<a name="l00860"></a>00860       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a>);  <span class="comment">/*!&lt; Description (help text) for &apos;show application &amp;lt;name&amp;gt;&apos; */</span>
<a name="l00861"></a>00861       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(syntax);       <span class="comment">/*!&lt; Syntax text for &apos;core show applications&apos; */</span>
<a name="l00862"></a>00862       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(arguments);    <span class="comment">/*!&lt; Arguments description */</span>
<a name="l00863"></a>00863       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(seealso);      <span class="comment">/*!&lt; See also */</span>
<a name="l00864"></a><a class="code" href="structast__app.html#ac72ddaf7b92092136fc38629a809c87a">00864</a>    );
<a name="l00865"></a><a class="code" href="structast__app.html#aa871ca3c361d229d4e37edf3c6016cc1">00865</a>    <span class="keyword">enum</span> <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3" title="From where the documentation come from.">ast_doc_src</a> docsrc;<span class="comment">/*!&lt; Where the documentation come from. */</span>
<a name="l00866"></a><a class="code" href="structast__app.html#a0c2179d67ff3d5659a5285243a194a81">00866</a>    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(ast_app) <a class="code" href="structast__sw.html#a7012dbab4ff0b0e3f8df13e88a017b18">list</a>;     <span class="comment">/*!&lt; Next app in list */</span>
<a name="l00867"></a><a class="code" href="structast__app.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">00867</a>    struct <a class="code" href="structast__module.html">ast_module</a> *module;    <span class="comment">/*!&lt; Module this app belongs to */</span>
<a name="l00868"></a><a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">00868</a>    <span class="keywordtype">char</span> name[0];           <span class="comment">/*!&lt; Name of the application */</span>
<a name="l00869"></a>00869 };
<a name="l00870"></a>00870 <span class="comment"></span>
<a name="l00871"></a>00871 <span class="comment">/*! \brief ast_state_cb: An extension state notify register item */</span>
<a name="l00872"></a><a class="code" href="structast__state__cb.html">00872</a> struct <a class="code" href="structast__state__cb.html" title="ast_state_cb: An extension state notify register item">ast_state_cb</a> {
<a name="l00873"></a><a class="code" href="structast__state__cb.html#a7441ef0865bcb3db9b8064dd7375c1ea">00873</a>    <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#acd1f0e9b4730ec60f62cb0806cb06ef1">id</a>;
<a name="l00874"></a><a class="code" href="structast__state__cb.html#a735984d41155bc1032e09bece8f8d66d">00874</a>    <span class="keywordtype">void</span> *<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a>;
<a name="l00875"></a><a class="code" href="structast__state__cb.html#a51f35e8871a0e589626a6c24024a2e17">00875</a>    <a class="code" href="pbx_8h.html#aa158b092800168cef19ea3fdd5b47538" title="Typedef for devicestate and hint callbacks.">ast_state_cb_type</a> callback;
<a name="l00876"></a><a class="code" href="structast__state__cb.html#aed7a48de3b1a28b9cd6839275f9445a7">00876</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(ast_state_cb) entry;
<a name="l00877"></a>00877 };
<a name="l00878"></a>00878 <span class="comment"></span>
<a name="l00879"></a>00879 <span class="comment">/*! \brief Structure for dial plan hints</span>
<a name="l00880"></a>00880 <span class="comment"></span>
<a name="l00881"></a>00881 <span class="comment">  \note Hints are pointers from an extension in the dialplan to one or</span>
<a name="l00882"></a>00882 <span class="comment">  more devices (tech/name)</span>
<a name="l00883"></a>00883 <span class="comment">   - See \ref AstExtState</span>
<a name="l00884"></a>00884 <span class="comment">*/</span>
<a name="l00885"></a><a class="code" href="structast__hint.html">00885</a> struct <a class="code" href="structast__hint.html" title="Structure for dial plan hints.">ast_hint</a> {
<a name="l00886"></a><a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">00886</a>    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>;   <span class="comment">/*!&lt; Extension */</span>
<a name="l00887"></a><a class="code" href="structast__hint.html#a0078d2e3ae10f15d7634c01199f33d4f">00887</a>    <span class="keywordtype">int</span> laststate;       <span class="comment">/*!&lt; Last known state */</span>
<a name="l00888"></a><a class="code" href="structast__hint.html#a72cb6fc63a95612b6884d7fddd990b6d">00888</a>    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, ast_state_cb) callbacks; <span class="comment">/*!&lt; Callback list for this extension */</span>
<a name="l00889"></a><a class="code" href="structast__hint.html#a8603addd66f4f550ad09cdba8fe3e570">00889</a>    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(ast_hint) list;<span class="comment">/*!&lt; Pointer to next hint in list */</span>
<a name="l00890"></a>00890 };
<a name="l00891"></a>00891 
<a name="l00892"></a><a class="code" href="structcfextension__states.html">00892</a> static const struct <a class="code" href="structcfextension__states.html">cfextension_states</a> {
<a name="l00893"></a><a class="code" href="structcfextension__states.html#a96e40dac6a068ce67b46205303d3e20a">00893</a>    <span class="keywordtype">int</span> extension_state;
<a name="l00894"></a><a class="code" href="structcfextension__states.html#aecfd3170c3d94608e5e5c038085fdf3f">00894</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> * <span class="keyword">const</span> <a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>;
<a name="l00895"></a>00895 } <a class="code" href="pbx_8c.html#a56ab82243e18b6c036a9bb41725dd549">extension_states</a>[] = {
<a name="l00896"></a>00896    { <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa435abb1e907b1cee83ec44d2d77866e6">AST_EXTENSION_NOT_INUSE</a>,                     <span class="stringliteral">&quot;Idle&quot;</span> },
<a name="l00897"></a>00897    { <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa47e9214860b5f9b887945f7cd1baec1a">AST_EXTENSION_INUSE</a>,                         <span class="stringliteral">&quot;InUse&quot;</span> },
<a name="l00898"></a>00898    { <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fad62d357f0ccde2a718c374a0a4af2b98">AST_EXTENSION_BUSY</a>,                          <span class="stringliteral">&quot;Busy&quot;</span> },
<a name="l00899"></a>00899    { <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa5820eb407f3a3dbc5046c97ad43ee1f3">AST_EXTENSION_UNAVAILABLE</a>,                   <span class="stringliteral">&quot;Unavailable&quot;</span> },
<a name="l00900"></a>00900    { <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa4063bf4e94e14df04126be6f08cc7bfc">AST_EXTENSION_RINGING</a>,                       <span class="stringliteral">&quot;Ringing&quot;</span> },
<a name="l00901"></a>00901    { <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa47e9214860b5f9b887945f7cd1baec1a">AST_EXTENSION_INUSE</a> | <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa4063bf4e94e14df04126be6f08cc7bfc">AST_EXTENSION_RINGING</a>, <span class="stringliteral">&quot;InUse&amp;Ringing&quot;</span> },
<a name="l00902"></a>00902    { <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa83180bb058ded006c01229431fc887f9">AST_EXTENSION_ONHOLD</a>,                        <span class="stringliteral">&quot;Hold&quot;</span> },
<a name="l00903"></a>00903    { <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa47e9214860b5f9b887945f7cd1baec1a">AST_EXTENSION_INUSE</a> | <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa83180bb058ded006c01229431fc887f9">AST_EXTENSION_ONHOLD</a>,  <span class="stringliteral">&quot;InUse&amp;Hold&quot;</span> }
<a name="l00904"></a>00904 };
<a name="l00905"></a>00905 
<a name="l00906"></a>00906 <span class="keyword">struct </span><a class="code" href="structstatechange.html">statechange</a> {
<a name="l00907"></a><a class="code" href="structstatechange.html#ad882a27c743e890683ae9ce17ac077e6">00907</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structstatechange.html">statechange</a>) entry;
<a name="l00908"></a><a class="code" href="structstatechange.html#afe67fe8a593b86ec431b116b7b4162d7">00908</a>    <span class="keywordtype">char</span> dev[0];
<a name="l00909"></a>00909 };
<a name="l00910"></a>00910 
<a name="l00911"></a><a class="code" href="structpbx__exception.html">00911</a> struct <a class="code" href="structpbx__exception.html">pbx_exception</a> {
<a name="l00912"></a>00912    <a class="code" href="stringfields_8h.html#a061580e89c55282a7140fa3fdfd52b6d" title="Declare the fields needed in a structure.">AST_DECLARE_STRING_FIELDS</a>(
<a name="l00913"></a>00913       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>); <span class="comment">/*!&lt; Context associated with this exception */</span>
<a name="l00914"></a>00914       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(exten);   <span class="comment">/*!&lt; Exten associated with this exception */</span>
<a name="l00915"></a>00915       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(reason);     <span class="comment">/*!&lt; The exception reason */</span>
<a name="l00916"></a><a class="code" href="structpbx__exception.html#af9968f5aac9a0d889c0506368ea1e649">00916</a>    );
<a name="l00917"></a>00917 
<a name="l00918"></a><a class="code" href="structpbx__exception.html#acec9ce2df15222151ad66fcb1d74eb9f">00918</a>    <span class="keywordtype">int</span> priority;           <span class="comment">/*!&lt; Priority associated with this exception */</span>
<a name="l00919"></a>00919 };
<a name="l00920"></a>00920 
<a name="l00921"></a>00921 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga07e7e350a58c79e93f784ca58ee57988">pbx_builtin_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00922"></a>00922 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#gae51321ae79f6f8a85cfbfe8d033a2df6">pbx_builtin_goto</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00923"></a>00923 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga30a1a1a976e72e564e7babdbbe26ca7c">pbx_builtin_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00924"></a>00924 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#gaab32a9f46cfa10fd991f16c6a7dc0f41">pbx_builtin_background</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00925"></a>00925 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga68501e1e569b1d53a6bba41cc1d20a90">pbx_builtin_wait</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00926"></a>00926 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga0c007df1099e478f13cdde9876a7f9df">pbx_builtin_waitexten</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00927"></a>00927 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a65ca23cfe7ba11aea248fca6caf43da3">pbx_builtin_incomplete</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00928"></a>00928 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga2f1090aa1e3405c842bedae424db5b20">pbx_builtin_resetcdr</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00929"></a>00929 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#gab695b2eba5ced025a2eb04fbdd87475f">pbx_builtin_setamaflags</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00930"></a>00930 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga9dadf39fac4d7bf36c38ce43bef6e8bc">pbx_builtin_ringing</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00931"></a>00931 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga8511a318e816998621739771aaab5a1f">pbx_builtin_proceeding</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00932"></a>00932 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga0afd7cd1dcef243a218c70fe30551b15">pbx_builtin_progress</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00933"></a>00933 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga5f356581010a6f1ed24407db1758cdc2">pbx_builtin_congestion</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00934"></a>00934 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#gafdd3cfad2a2fa9180649782c8794b01f">pbx_builtin_busy</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00935"></a>00935 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#afde9dbe9cdcad8b299a374c07001ac0c">pbx_builtin_noop</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00936"></a>00936 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a948dfb362e060b3fe11e1944087d559d">pbx_builtin_gotoif</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00937"></a>00937 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga71db5198713c09e6b55360f5ced0212e">pbx_builtin_gotoiftime</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00938"></a>00938 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#gaa259135ffd279c9afc70b476ee0b4cd6">pbx_builtin_execiftime</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00939"></a>00939 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a061e43c8e74d19fd03e12bb1077de9bd">pbx_builtin_saynumber</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00940"></a>00940 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#aa19185bb6342008244943fc600124945">pbx_builtin_saydigits</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00941"></a>00941 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a972e4233e7b77a15acd2a741a9c7bc95">pbx_builtin_saycharacters</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00942"></a>00942 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a3d9d3a454980053f0dbe6d62b37ddba1">pbx_builtin_sayphonetic</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00943"></a>00943 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#aa387123ad981d4889f47275234042a2e">matchcid</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *cidpattern, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid);
<a name="l00944"></a>00944 <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aa2489c1ea3b067f827ad20abf363cdcd" title="Parse and set a single channel variable, where the name and value are separated with...">pbx_builtin_setvar</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00945"></a>00945 <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a45d3d0857a56e9ec039a20350bbb7d7f">log_match_char_tree</a>(<span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *node, <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>); <span class="comment">/* for use anywhere */</span>
<a name="l00946"></a>00946 <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a990bfc8582dc017423d8518bcc110a2c" title="Parse and set multiple channel variables, where the pairs are separated by the &amp;#39;...">pbx_builtin_setvar_multiple</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00947"></a>00947 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#ae4f48a51cb2dca6080d6d8488b41d4f9">pbx_builtin_importvar</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l00948"></a>00948 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> pri);
<a name="l00949"></a>00949 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a2c64874adba109557bade6a7cbfd1eea">new_find_extension</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>, <span class="keyword">struct</span> <a class="code" href="structscoreboard.html">scoreboard</a> *score,
<a name="l00950"></a>00950       <span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *tree, <span class="keywordtype">int</span> length, <span class="keywordtype">int</span> spec, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid,
<a name="l00951"></a>00951       <span class="keyword">const</span> <span class="keywordtype">char</span> *label, <span class="keyword">enum</span> <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26be">ext_match_t</a> action);
<a name="l00952"></a>00952 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="pbx_8c.html#af1aa3d895c5e3a802e232e181d2b37d3">already_in_tree</a>(<span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *current, <span class="keywordtype">char</span> *pat);
<a name="l00953"></a>00953 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="pbx_8c.html#aa638cd9d03f5d710b6a320ffda6d6392">add_exten_to_pattern_tree</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con,
<a name="l00954"></a>00954       <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e1, <span class="keywordtype">int</span> findonly);
<a name="l00955"></a>00955 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="pbx_8c.html#a3c23cd74ba6d85ef65661423e173ca08">add_pattern_node</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con,
<a name="l00956"></a>00956       <span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *current, <span class="keywordtype">char</span> *pattern, <span class="keywordtype">int</span> <a class="code" href="structmatch__char.html#a67e42f878971513be0d2fa914019a38d">is_pattern</a>,
<a name="l00957"></a>00957       <span class="keywordtype">int</span> already, <span class="keywordtype">int</span> <a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a>, <span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> **parent);
<a name="l00958"></a>00958 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a705ac1563ea8e4c1e3f369e6ad952fda">create_match_char_tree</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con);
<a name="l00959"></a>00959 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="pbx_8c.html#aefee0e2a38de76a008277db39cd9e3a8">get_canmatch_exten</a>(<span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *node);
<a name="l00960"></a>00960 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a3900cc7c8183ab6a7316f5dbc2b955ed">destroy_pattern_tree</a>(<span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *pattern_tree);
<a name="l00961"></a>00961 <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a20a2f5668173430437db02cdd0acc9f3" title="hashtable functions for contexts">ast_hashtab_compare_contexts</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *ah_a, <span class="keyword">const</span> <span class="keywordtype">void</span> *ah_b);
<a name="l00962"></a>00962 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a01a31156d536b161d4c400af885a6b23">hashtab_compare_extens</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *ha_a, <span class="keyword">const</span> <span class="keywordtype">void</span> *ah_b);
<a name="l00963"></a>00963 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a312597f1da31dcefbf18f31335f7295c">hashtab_compare_exten_numbers</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *ah_a, <span class="keyword">const</span> <span class="keywordtype">void</span> *ah_b);
<a name="l00964"></a>00964 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#aad72a88ef3aa3258d69475cd14f274d0">hashtab_compare_exten_labels</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *ah_a, <span class="keyword">const</span> <span class="keywordtype">void</span> *ah_b);
<a name="l00965"></a>00965 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a56461864a4e21b14e753b78f9ac7afb7">ast_hashtab_hash_contexts</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj);
<a name="l00966"></a>00966 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a46084c800c9b3dbe1f2b57e2d2b62304">hashtab_hash_extens</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj);
<a name="l00967"></a>00967 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a4ee70a9380daf9be2bf681becb1a69c3">hashtab_hash_priority</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj);
<a name="l00968"></a>00968 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#ae4a0bd08dbd3bc22fc65de969d3bfa45">hashtab_hash_labels</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj);
<a name="l00969"></a>00969 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#af51adb9b78f628397d7b0c1781b6d79e">__ast_internal_context_destroy</a>( <span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con);
<a name="l00970"></a>00970 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a62350bf22ada5eec5dcb16986c1909b9">ast_add_extension_nolock</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keywordtype">int</span> replace, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structextension.html">extension</a>,
<a name="l00971"></a>00971    <span class="keywordtype">int</span> <a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid,
<a name="l00972"></a>00972    <span class="keyword">const</span> <span class="keywordtype">char</span> *application, <span class="keywordtype">void</span> *data, <span class="keywordtype">void</span> (*<a class="code" href="structast__exten.html#ad11dc8dd7d18a2cf6451b32ea529221c">datad</a>)(<span class="keywordtype">void</span> *), <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>);
<a name="l00973"></a>00973 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a828413e4b0e9b9f0e6936f35e633b015" title="add the extension in the priority chain.">add_pri_lockopt</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *tmp,
<a name="l00974"></a>00974    <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e, <span class="keywordtype">int</span> replace, <span class="keywordtype">int</span> lockhints);
<a name="l00975"></a>00975 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#adb069bbd2459e4cc80cf858655d0c62f" title="Does all the work of ast_add_extension2, but adds two args, to determine if context...">ast_add_extension2_lockopt</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con,
<a name="l00976"></a>00976    <span class="keywordtype">int</span> replace, <span class="keyword">const</span> <span class="keywordtype">char</span> *extension, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *label, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid,
<a name="l00977"></a>00977    <span class="keyword">const</span> <span class="keywordtype">char</span> *application, <span class="keywordtype">void</span> *data, <span class="keywordtype">void</span> (*<a class="code" href="structast__exten.html#ad11dc8dd7d18a2cf6451b32ea529221c">datad</a>)(<span class="keywordtype">void</span> *),
<a name="l00978"></a>00978    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>, <span class="keywordtype">int</span> lockconts, <span class="keywordtype">int</span> lockhints);
<a name="l00979"></a>00979 
<a name="l00980"></a>00980 <span class="comment">/* a func for qsort to use to sort a char array */</span>
<a name="l00981"></a><a class="code" href="pbx_8c.html#a64ec6367a27dcdeb7ce0b7b614a2cc44">00981</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a64ec6367a27dcdeb7ce0b7b614a2cc44">compare_char</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *a, <span class="keyword">const</span> <span class="keywordtype">void</span> *b)
<a name="l00982"></a>00982 {
<a name="l00983"></a>00983    <span class="keyword">const</span> <span class="keywordtype">char</span> *ac = a;
<a name="l00984"></a>00984    <span class="keyword">const</span> <span class="keywordtype">char</span> *bc = b;
<a name="l00985"></a>00985    <span class="keywordflow">if</span> ((*ac) &lt; (*bc))
<a name="l00986"></a>00986       <span class="keywordflow">return</span> -1;
<a name="l00987"></a>00987    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*ac) == (*bc))
<a name="l00988"></a>00988       <span class="keywordflow">return</span> 0;
<a name="l00989"></a>00989    <span class="keywordflow">else</span>
<a name="l00990"></a>00990       <span class="keywordflow">return</span> 1;
<a name="l00991"></a>00991 }
<a name="l00992"></a>00992 
<a name="l00993"></a>00993 <span class="comment">/* labels, contexts are case sensitive  priority numbers are ints */</span>
<a name="l00994"></a><a class="code" href="pbx_8c.html#a20a2f5668173430437db02cdd0acc9f3">00994</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a20a2f5668173430437db02cdd0acc9f3" title="hashtable functions for contexts">ast_hashtab_compare_contexts</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *ah_a, <span class="keyword">const</span> <span class="keywordtype">void</span> *ah_b)
<a name="l00995"></a>00995 {
<a name="l00996"></a>00996    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *ac = ah_a;
<a name="l00997"></a>00997    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *bc = ah_b;
<a name="l00998"></a>00998    <span class="keywordflow">if</span> (!ac || !bc) <span class="comment">/* safety valve, but it might prevent a crash you&apos;d rather have happen */</span>
<a name="l00999"></a>00999       <span class="keywordflow">return</span> 1;
<a name="l01000"></a>01000    <span class="comment">/* assume context names are registered in a string table! */</span>
<a name="l01001"></a>01001    <span class="keywordflow">return</span> strcmp(ac-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, bc-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l01002"></a>01002 }
<a name="l01003"></a>01003 
<a name="l01004"></a><a class="code" href="pbx_8c.html#a01a31156d536b161d4c400af885a6b23">01004</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a01a31156d536b161d4c400af885a6b23">hashtab_compare_extens</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *ah_a, <span class="keyword">const</span> <span class="keywordtype">void</span> *ah_b)
<a name="l01005"></a>01005 {
<a name="l01006"></a>01006    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *ac = ah_a;
<a name="l01007"></a>01007    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *bc = ah_b;
<a name="l01008"></a>01008    <span class="keywordtype">int</span> x = strcmp(ac-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, bc-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l01009"></a>01009    <span class="keywordflow">if</span> (x) { <span class="comment">/* if exten names are diff, then return */</span>
<a name="l01010"></a>01010       <span class="keywordflow">return</span> x;
<a name="l01011"></a>01011    }
<a name="l01012"></a>01012 
<a name="l01013"></a>01013    <span class="comment">/* but if they are the same, do the cidmatch values match? */</span>
<a name="l01014"></a>01014    <span class="keywordflow">if</span> (ac-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> &amp;&amp; bc-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a>) {
<a name="l01015"></a>01015       <span class="keywordflow">return</span> strcmp(ac-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>,bc-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>);
<a name="l01016"></a>01016    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ac-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> &amp;&amp; !bc-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a>) {
<a name="l01017"></a>01017       <span class="keywordflow">return</span> 0; <span class="comment">/* if there&apos;s no matchcid on either side, then this is a match */</span>
<a name="l01018"></a>01018    } <span class="keywordflow">else</span> {
<a name="l01019"></a>01019       <span class="keywordflow">return</span> 1; <span class="comment">/* if there&apos;s matchcid on one but not the other, they are different */</span>
<a name="l01020"></a>01020    }
<a name="l01021"></a>01021 }
<a name="l01022"></a>01022 
<a name="l01023"></a><a class="code" href="pbx_8c.html#a312597f1da31dcefbf18f31335f7295c">01023</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a312597f1da31dcefbf18f31335f7295c">hashtab_compare_exten_numbers</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *ah_a, <span class="keyword">const</span> <span class="keywordtype">void</span> *ah_b)
<a name="l01024"></a>01024 {
<a name="l01025"></a>01025    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *ac = ah_a;
<a name="l01026"></a>01026    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *bc = ah_b;
<a name="l01027"></a>01027    <span class="keywordflow">return</span> ac-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> != bc-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>;
<a name="l01028"></a>01028 }
<a name="l01029"></a>01029 
<a name="l01030"></a><a class="code" href="pbx_8c.html#aad72a88ef3aa3258d69475cd14f274d0">01030</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#aad72a88ef3aa3258d69475cd14f274d0">hashtab_compare_exten_labels</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *ah_a, <span class="keyword">const</span> <span class="keywordtype">void</span> *ah_b)
<a name="l01031"></a>01031 {
<a name="l01032"></a>01032    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *ac = ah_a;
<a name="l01033"></a>01033    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *bc = ah_b;
<a name="l01034"></a>01034    <span class="keywordflow">return</span> strcmp(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(ac-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>, <span class="stringliteral">&quot;&quot;</span>), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(bc-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>, <span class="stringliteral">&quot;&quot;</span>));
<a name="l01035"></a>01035 }
<a name="l01036"></a>01036 
<a name="l01037"></a><a class="code" href="pbx_8c.html#a56461864a4e21b14e753b78f9ac7afb7">01037</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a56461864a4e21b14e753b78f9ac7afb7">ast_hashtab_hash_contexts</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj)
<a name="l01038"></a>01038 {
<a name="l01039"></a>01039    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *ac = obj;
<a name="l01040"></a>01040    <span class="keywordflow">return</span> <a class="code" href="hashtab_8h.html#af8904cce564fd39de28b566bb8c261eb" title="Hashes a string to a number.">ast_hashtab_hash_string</a>(ac-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l01041"></a>01041 }
<a name="l01042"></a>01042 
<a name="l01043"></a><a class="code" href="pbx_8c.html#a46084c800c9b3dbe1f2b57e2d2b62304">01043</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a46084c800c9b3dbe1f2b57e2d2b62304">hashtab_hash_extens</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj)
<a name="l01044"></a>01044 {
<a name="l01045"></a>01045    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *ac = obj;
<a name="l01046"></a>01046    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> x = <a class="code" href="hashtab_8h.html#af8904cce564fd39de28b566bb8c261eb" title="Hashes a string to a number.">ast_hashtab_hash_string</a>(ac-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l01047"></a>01047    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> y = 0;
<a name="l01048"></a>01048    <span class="keywordflow">if</span> (ac-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a>)
<a name="l01049"></a>01049       y = <a class="code" href="hashtab_8h.html#af8904cce564fd39de28b566bb8c261eb" title="Hashes a string to a number.">ast_hashtab_hash_string</a>(ac-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>);
<a name="l01050"></a>01050    <span class="keywordflow">return</span> x+y;
<a name="l01051"></a>01051 }
<a name="l01052"></a>01052 
<a name="l01053"></a><a class="code" href="pbx_8c.html#a4ee70a9380daf9be2bf681becb1a69c3">01053</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a4ee70a9380daf9be2bf681becb1a69c3">hashtab_hash_priority</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj)
<a name="l01054"></a>01054 {
<a name="l01055"></a>01055    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *ac = obj;
<a name="l01056"></a>01056    <span class="keywordflow">return</span> <a class="code" href="hashtab_8h.html#a42e7322ae7381ee379bfe15798ca75e2">ast_hashtab_hash_int</a>(ac-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l01057"></a>01057 }
<a name="l01058"></a>01058 
<a name="l01059"></a><a class="code" href="pbx_8c.html#ae4a0bd08dbd3bc22fc65de969d3bfa45">01059</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#ae4a0bd08dbd3bc22fc65de969d3bfa45">hashtab_hash_labels</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj)
<a name="l01060"></a>01060 {
<a name="l01061"></a>01061    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *ac = obj;
<a name="l01062"></a>01062    <span class="keywordflow">return</span> <a class="code" href="hashtab_8h.html#af8904cce564fd39de28b566bb8c261eb" title="Hashes a string to a number.">ast_hashtab_hash_string</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(ac-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>, <span class="stringliteral">&quot;&quot;</span>));
<a name="l01063"></a>01063 }
<a name="l01064"></a>01064 
<a name="l01065"></a>01065 
<a name="l01066"></a><a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">01066</a> <a class="code" href="lock_8h.html#a7443635fb39ae2aa946e2373dada3ac7">AST_RWLOCK_DEFINE_STATIC</a>(<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l01067"></a><a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">01067</a> <span class="keyword">static</span> <span class="keyword">struct </span>varshead <a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a> = <a class="code" href="linkedlists_8h.html#a5a79a9dc65f139cedb64503d171d5df4" title="Defines initial values for a declaration of AST_LIST_HEAD_NOLOCK.">AST_LIST_HEAD_NOLOCK_INIT_VALUE</a>;
<a name="l01068"></a>01068 
<a name="l01069"></a><a class="code" href="pbx_8c.html#a5f7ea48b3f8614ef9314e5aece1f1bc3">01069</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a5f7ea48b3f8614ef9314e5aece1f1bc3">autofallthrough</a> = 1;
<a name="l01070"></a><a class="code" href="pbx_8c.html#a3a7600857afccfa4f7a5c55dcaec8407">01070</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a3a7600857afccfa4f7a5c55dcaec8407">extenpatternmatchnew</a> = 0;
<a name="l01071"></a><a class="code" href="pbx_8c.html#a8f600ca9999b2d9c3d64cbcdb503895c">01071</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a8f600ca9999b2d9c3d64cbcdb503895c">overrideswitch</a> = NULL;
<a name="l01072"></a>01072 <span class="comment"></span>
<a name="l01073"></a>01073 <span class="comment">/*! \brief Subscription for device state change events */</span>
<a name="l01074"></a><a class="code" href="pbx_8c.html#a51ca11f2c73a7d856c3d3ca3e45fbc31">01074</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__event__sub.html" title="Event subscription.">ast_event_sub</a> *<a class="code" href="pbx_8c.html#a51ca11f2c73a7d856c3d3ca3e45fbc31" title="Subscription for device state change events.">device_state_sub</a>;
<a name="l01075"></a>01075 
<a name="l01076"></a><a class="code" href="pbx_8c.html#a55c3f21eda54c35107729cd65e482aec">01076</a> <a class="code" href="lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a>(<a class="code" href="pbx_8c.html#a55c3f21eda54c35107729cd65e482aec">maxcalllock</a>);
<a name="l01077"></a><a class="code" href="pbx_8c.html#a098053e0fabe1ebd3f0b70fd7c9f8a71">01077</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a098053e0fabe1ebd3f0b70fd7c9f8a71">countcalls</a>;
<a name="l01078"></a><a class="code" href="pbx_8c.html#a078330b9a32065ec6a0c0731c06719cd">01078</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a078330b9a32065ec6a0c0731c06719cd">totalcalls</a>;
<a name="l01079"></a>01079 
<a name="l01080"></a><a class="code" href="structacf__root.html#ace4e0066a5b24f84b90536e9906619f6">01080</a> <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structacf__root.html">acf_root</a>, <a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a>);
<a name="l01081"></a>01081 <span class="comment"></span>
<a name="l01082"></a>01082 <span class="comment">/*! \brief Declaration of builtin applications */</span>
<a name="l01083"></a><a class="code" href="structpbx__builtin.html">01083</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structpbx__builtin.html" title="Declaration of builtin applications.">pbx_builtin</a> {
<a name="l01084"></a><a class="code" href="structpbx__builtin.html#aeed581095f50a8b4b7603351c91258db">01084</a>    <span class="keywordtype">char</span> name[<a class="code" href="pbx_8h.html#a3414b82af9b33fe907c9377c5c73c453">AST_MAX_APP</a>];
<a name="l01085"></a>01085    int (*execute)(<span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data);
<a name="l01086"></a>01086 } <a class="code" href="pbx_8c.html#a5b85032a1e719d9b83d5699fd350134e" title="Declaration of builtin applications.">builtins</a>[] =
<a name="l01087"></a>01087 {
<a name="l01088"></a>01088    <span class="comment">/* These applications are built into the PBX core and do not</span>
<a name="l01089"></a>01089 <span class="comment">      need separate modules */</span>
<a name="l01090"></a>01090 
<a name="l01091"></a>01091    { <span class="stringliteral">&quot;Answer&quot;</span>,         <a class="code" href="group__applications.html#ga07e7e350a58c79e93f784ca58ee57988">pbx_builtin_answer</a> },
<a name="l01092"></a>01092    { <span class="stringliteral">&quot;BackGround&quot;</span>,     <a class="code" href="group__applications.html#gaab32a9f46cfa10fd991f16c6a7dc0f41">pbx_builtin_background</a> },
<a name="l01093"></a>01093    { <span class="stringliteral">&quot;Busy&quot;</span>,           <a class="code" href="group__applications.html#gafdd3cfad2a2fa9180649782c8794b01f">pbx_builtin_busy</a> },
<a name="l01094"></a>01094    { <span class="stringliteral">&quot;Congestion&quot;</span>,     <a class="code" href="group__applications.html#ga5f356581010a6f1ed24407db1758cdc2">pbx_builtin_congestion</a> },
<a name="l01095"></a>01095    { <span class="stringliteral">&quot;ExecIfTime&quot;</span>,     <a class="code" href="group__applications.html#gaa259135ffd279c9afc70b476ee0b4cd6">pbx_builtin_execiftime</a> },
<a name="l01096"></a>01096    { <span class="stringliteral">&quot;Goto&quot;</span>,           <a class="code" href="group__applications.html#gae51321ae79f6f8a85cfbfe8d033a2df6">pbx_builtin_goto</a> },
<a name="l01097"></a>01097    { <span class="stringliteral">&quot;GotoIf&quot;</span>,         <a class="code" href="pbx_8c.html#a948dfb362e060b3fe11e1944087d559d">pbx_builtin_gotoif</a> },
<a name="l01098"></a>01098    { <span class="stringliteral">&quot;GotoIfTime&quot;</span>,     <a class="code" href="group__applications.html#ga71db5198713c09e6b55360f5ced0212e">pbx_builtin_gotoiftime</a> },
<a name="l01099"></a>01099    { <span class="stringliteral">&quot;ImportVar&quot;</span>,      <a class="code" href="pbx_8c.html#ae4f48a51cb2dca6080d6d8488b41d4f9">pbx_builtin_importvar</a> },
<a name="l01100"></a>01100    { <span class="stringliteral">&quot;Hangup&quot;</span>,         <a class="code" href="group__applications.html#ga30a1a1a976e72e564e7babdbbe26ca7c">pbx_builtin_hangup</a> },
<a name="l01101"></a>01101    { <span class="stringliteral">&quot;Incomplete&quot;</span>,     <a class="code" href="pbx_8c.html#a65ca23cfe7ba11aea248fca6caf43da3">pbx_builtin_incomplete</a> },
<a name="l01102"></a>01102    { <span class="stringliteral">&quot;NoOp&quot;</span>,           <a class="code" href="pbx_8c.html#afde9dbe9cdcad8b299a374c07001ac0c">pbx_builtin_noop</a> },
<a name="l01103"></a>01103    { <span class="stringliteral">&quot;Proceeding&quot;</span>,     <a class="code" href="group__applications.html#ga8511a318e816998621739771aaab5a1f">pbx_builtin_proceeding</a> },
<a name="l01104"></a>01104    { <span class="stringliteral">&quot;Progress&quot;</span>,       <a class="code" href="group__applications.html#ga0afd7cd1dcef243a218c70fe30551b15">pbx_builtin_progress</a> },
<a name="l01105"></a>01105    { <span class="stringliteral">&quot;RaiseException&quot;</span>, <a class="code" href="pbx_8h.html#abc705e1c806491af6419892a1237d920">pbx_builtin_raise_exception</a> },
<a name="l01106"></a>01106    { <span class="stringliteral">&quot;ResetCDR&quot;</span>,       <a class="code" href="group__applications.html#ga2f1090aa1e3405c842bedae424db5b20">pbx_builtin_resetcdr</a> },
<a name="l01107"></a>01107    { <span class="stringliteral">&quot;Ringing&quot;</span>,        <a class="code" href="group__applications.html#ga9dadf39fac4d7bf36c38ce43bef6e8bc">pbx_builtin_ringing</a> },
<a name="l01108"></a>01108    { <span class="stringliteral">&quot;SayAlpha&quot;</span>,       <a class="code" href="pbx_8c.html#a972e4233e7b77a15acd2a741a9c7bc95">pbx_builtin_saycharacters</a> },
<a name="l01109"></a>01109    { <span class="stringliteral">&quot;SayDigits&quot;</span>,      <a class="code" href="pbx_8c.html#aa19185bb6342008244943fc600124945">pbx_builtin_saydigits</a> },
<a name="l01110"></a>01110    { <span class="stringliteral">&quot;SayNumber&quot;</span>,      <a class="code" href="pbx_8c.html#a061e43c8e74d19fd03e12bb1077de9bd">pbx_builtin_saynumber</a> },
<a name="l01111"></a>01111    { <span class="stringliteral">&quot;SayPhonetic&quot;</span>,    <a class="code" href="pbx_8c.html#a3d9d3a454980053f0dbe6d62b37ddba1">pbx_builtin_sayphonetic</a> },
<a name="l01112"></a>01112    { <span class="stringliteral">&quot;Set&quot;</span>,            <a class="code" href="pbx_8h.html#aa2489c1ea3b067f827ad20abf363cdcd" title="Parse and set a single channel variable, where the name and value are separated with...">pbx_builtin_setvar</a> },
<a name="l01113"></a>01113    { <span class="stringliteral">&quot;MSet&quot;</span>,           <a class="code" href="pbx_8h.html#a990bfc8582dc017423d8518bcc110a2c" title="Parse and set multiple channel variables, where the pairs are separated by the &amp;#39;...">pbx_builtin_setvar_multiple</a> },
<a name="l01114"></a>01114    { <span class="stringliteral">&quot;SetAMAFlags&quot;</span>,    <a class="code" href="group__applications.html#gab695b2eba5ced025a2eb04fbdd87475f">pbx_builtin_setamaflags</a> },
<a name="l01115"></a>01115    { <span class="stringliteral">&quot;Wait&quot;</span>,           <a class="code" href="group__applications.html#ga68501e1e569b1d53a6bba41cc1d20a90">pbx_builtin_wait</a> },
<a name="l01116"></a>01116    { <span class="stringliteral">&quot;WaitExten&quot;</span>,      <a class="code" href="group__applications.html#ga0c007df1099e478f13cdde9876a7f9df">pbx_builtin_waitexten</a> }
<a name="l01117"></a>01117 };
<a name="l01118"></a>01118 
<a name="l01119"></a><a class="code" href="pbx_8c.html#aae85d5aab50f2d1b8392d6df276f2561">01119</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="pbx_8c.html#aae85d5aab50f2d1b8392d6df276f2561">contexts</a>;
<a name="l01120"></a><a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">01120</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__hashtab.html">ast_hashtab</a> *<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a> = NULL;
<a name="l01121"></a>01121 
<a name="l01122"></a><a class="code" href="pbx_8c.html#aa0a1f2323798ac5928ae23d6fb55449e">01122</a> <a class="code" href="lock_8h.html#a7443635fb39ae2aa946e2373dada3ac7">AST_RWLOCK_DEFINE_STATIC</a>(<a class="code" href="pbx_8c.html#aa0a1f2323798ac5928ae23d6fb55449e">conlock</a>);     <span class="comment">/*!&lt; Lock for the ast_context list */</span>
<a name="l01123"></a>01123 
<a name="l01124"></a><a class="code" href="structapps.html#ace4e0066a5b24f84b90536e9906619f6">01124</a> <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structapps.html">apps</a>, ast_app);
<a name="l01125"></a>01125 
<a name="l01126"></a><a class="code" href="structswitches.html#ace4e0066a5b24f84b90536e9906619f6">01126</a> <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structswitches.html">switches</a>, <a class="code" href="structast__switch.html">ast_switch</a>);
<a name="l01127"></a>01127 
<a name="l01128"></a><a class="code" href="pbx_8c.html#a70382561daaa758a201b7a711d566e24">01128</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a70382561daaa758a201b7a711d566e24">stateid</a> = 1;
<a name="l01129"></a>01129 <span class="comment">/* WARNING:</span>
<a name="l01130"></a>01130 <span class="comment">   When holding this list&apos;s lock, do _not_ do anything that will cause conlock</span>
<a name="l01131"></a>01131 <span class="comment">   to be taken, unless you _already_ hold it. The ast_merge_contexts_and_delete</span>
<a name="l01132"></a>01132 <span class="comment">   function will take the locks in conlock/hints order, so any other</span>
<a name="l01133"></a>01133 <span class="comment">   paths that require both locks must also take them in that order.</span>
<a name="l01134"></a>01134 <span class="comment">*/</span>
<a name="l01135"></a><a class="code" href="structhints.html#ace4e0066a5b24f84b90536e9906619f6">01135</a> <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structhints.html">hints</a>, ast_hint);
<a name="l01136"></a>01136 
<a name="l01137"></a><a class="code" href="structstatecbs.html#a72cb6fc63a95612b6884d7fddd990b6d">01137</a> <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a547735280f0983afc46bf476d17be24a" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_NOLOCK_STATIC</a>(<a class="code" href="structstatecbs.html">statecbs</a>, ast_state_cb);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139 <span class="preprocessor">#ifdef CONTEXT_DEBUG</span>
<a name="l01140"></a>01140 <span class="preprocessor"></span>
<a name="l01141"></a>01141 <span class="comment">/* these routines are provided for doing run-time checks</span>
<a name="l01142"></a>01142 <span class="comment">   on the extension structures, in case you are having</span>
<a name="l01143"></a>01143 <span class="comment">   problems, this routine might help you localize where</span>
<a name="l01144"></a>01144 <span class="comment">   the problem is occurring. It&apos;s kinda like a debug memory</span>
<a name="l01145"></a>01145 <span class="comment">   allocator&apos;s arena checker... It&apos;ll eat up your cpu cycles!</span>
<a name="l01146"></a>01146 <span class="comment">   but you&apos;ll see, if you call it in the right places,</span>
<a name="l01147"></a>01147 <span class="comment">   right where your problems began...</span>
<a name="l01148"></a>01148 <span class="comment">*/</span>
<a name="l01149"></a>01149 
<a name="l01150"></a>01150 <span class="comment">/* you can break on the check_contexts_trouble()</span>
<a name="l01151"></a>01151 <span class="comment">routine in your debugger to stop at the moment</span>
<a name="l01152"></a>01152 <span class="comment">there&apos;s a problem */</span>
<a name="l01153"></a>01153 <span class="keywordtype">void</span> check_contexts_trouble(<span class="keywordtype">void</span>);
<a name="l01154"></a>01154 
<a name="l01155"></a>01155 <span class="keywordtype">void</span> check_contexts_trouble(<span class="keywordtype">void</span>)
<a name="l01156"></a>01156 {
<a name="l01157"></a>01157    <span class="keywordtype">int</span> x = 1;
<a name="l01158"></a>01158    x = 2;
<a name="l01159"></a>01159 }
<a name="l01160"></a>01160 
<a name="l01161"></a>01161 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e" title="lookup for a context with a given name,">find_context_locked</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context);
<a name="l01162"></a>01162 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="pval_8h.html#a939b5867de88d9d61eb4999402805027">find_context</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context);
<a name="l01163"></a>01163 <span class="keywordtype">int</span> check_contexts(<span class="keywordtype">char</span> *, <span class="keywordtype">int</span>);
<a name="l01164"></a>01164 
<a name="l01165"></a>01165 <span class="keywordtype">int</span> check_contexts(<span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> line )
<a name="l01166"></a>01166 {
<a name="l01167"></a>01167    <span class="keyword">struct </span><a class="code" href="structast__hashtab__iter.html" title="an iterator for traversing the buckets">ast_hashtab_iter</a> *t1;
<a name="l01168"></a>01168    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c1, *c2;
<a name="l01169"></a>01169    <span class="keywordtype">int</span> found = 0;
<a name="l01170"></a>01170    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e1, *e2, *e3;
<a name="l01171"></a>01171    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> ex;
<a name="l01172"></a>01172 
<a name="l01173"></a>01173    <span class="comment">/* try to find inconsistencies */</span>
<a name="l01174"></a>01174    <span class="comment">/* is every context in the context table in the context list and vice-versa ? */</span>
<a name="l01175"></a>01175 
<a name="l01176"></a>01176    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>) {
<a name="l01177"></a>01177       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: No contexts_table!\n&quot;</span>, file, line);
<a name="l01178"></a>01178       usleep(500000);
<a name="l01179"></a>01179    }
<a name="l01180"></a>01180 
<a name="l01181"></a>01181    t1 = <a class="code" href="hashtab_8h.html#ac5a19bffadbbd4eb31f190e576f88512" title="Gives an iterator to hastable.">ast_hashtab_start_traversal</a>(<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>);
<a name="l01182"></a>01182    <span class="keywordflow">while</span>( (c1 = <a class="code" href="hashtab_8h.html#a43983b6169e9a0f9af48cca5cf9d3197" title="Gets the next object in the list, advances iter one step returns null on end of traversal...">ast_hashtab_next</a>(t1))) {
<a name="l01183"></a>01183       <span class="keywordflow">for</span>(c2=<a class="code" href="pbx_8c.html#aae85d5aab50f2d1b8392d6df276f2561">contexts</a>;c2;c2=c2-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a>) {
<a name="l01184"></a>01184          <span class="keywordflow">if</span> (!strcmp(c1-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>)) {
<a name="l01185"></a>01185             found = 1;
<a name="l01186"></a>01186             <span class="keywordflow">break</span>;
<a name="l01187"></a>01187          }
<a name="l01188"></a>01188       }
<a name="l01189"></a>01189       <span class="keywordflow">if</span> (!found) {
<a name="l01190"></a>01190          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: Could not find the %s context in the linked list\n&quot;</span>, file, line, c1-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l01191"></a>01191          check_contexts_trouble();
<a name="l01192"></a>01192       }
<a name="l01193"></a>01193    }
<a name="l01194"></a>01194    <a class="code" href="hashtab_8h.html#a9c804e9bfc8355c25197187f0c6d0265" title="end the traversal, free the iterator, unlock if necc.">ast_hashtab_end_traversal</a>(t1);
<a name="l01195"></a>01195    <span class="keywordflow">for</span>(c2=<a class="code" href="pbx_8c.html#aae85d5aab50f2d1b8392d6df276f2561">contexts</a>;c2;c2=c2-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a>) {
<a name="l01196"></a>01196       c1 = <a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e" title="lookup for a context with a given name,">find_context_locked</a>(c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l01197"></a>01197       <span class="keywordflow">if</span> (!c1) {
<a name="l01198"></a>01198          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: Could not find the %s context in the hashtab\n&quot;</span>, file, line, c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l01199"></a>01199          check_contexts_trouble();
<a name="l01200"></a>01200       } <span class="keywordflow">else</span>
<a name="l01201"></a>01201          <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l01202"></a>01202    }
<a name="l01203"></a>01203 
<a name="l01204"></a>01204    <span class="comment">/* loop thru all contexts, and verify the exten structure compares to the </span>
<a name="l01205"></a>01205 <span class="comment">      hashtab structure */</span>
<a name="l01206"></a>01206    <span class="keywordflow">for</span>(c2=<a class="code" href="pbx_8c.html#aae85d5aab50f2d1b8392d6df276f2561">contexts</a>;c2;c2=c2-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a>) {
<a name="l01207"></a>01207       c1 = <a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e" title="lookup for a context with a given name,">find_context_locked</a>(c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l01208"></a>01208       <span class="keywordflow">if</span> (c1)
<a name="l01209"></a>01209       {
<a name="l01210"></a>01210 
<a name="l01211"></a>01211          <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l01212"></a>01212 
<a name="l01213"></a>01213          <span class="comment">/* is every entry in the root list also in the root_table? */</span>
<a name="l01214"></a>01214          <span class="keywordflow">for</span>(e1 = c1-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a>; e1; e1=e1-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>)
<a name="l01215"></a>01215          {
<a name="l01216"></a>01216             <span class="keywordtype">char</span> dummy_name[1024];
<a name="l01217"></a>01217             ex.exten = dummy_name;
<a name="l01218"></a>01218             ex.matchcid = e1-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a>;
<a name="l01219"></a>01219             ex.cidmatch = e1-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>;
<a name="l01220"></a>01220             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dummy_name, e1-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, <span class="keyword">sizeof</span>(dummy_name));
<a name="l01221"></a>01221             e2 = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(c1-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, &amp;ex);
<a name="l01222"></a>01222             <span class="keywordflow">if</span> (!e2) {
<a name="l01223"></a>01223                <span class="keywordflow">if</span> (e1-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a>) {
<a name="l01224"></a>01224                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: The %s context records the exten %s (CID match: %s) but it is not in its root_table\n&quot;</span>, file, line, c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, dummy_name, e1-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a> );
<a name="l01225"></a>01225                } <span class="keywordflow">else</span> {
<a name="l01226"></a>01226                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: The %s context records the exten %s but it is not in its root_table\n&quot;</span>, file, line, c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, dummy_name );
<a name="l01227"></a>01227                }
<a name="l01228"></a>01228                check_contexts_trouble();
<a name="l01229"></a>01229             }
<a name="l01230"></a>01230          }
<a name="l01231"></a>01231 
<a name="l01232"></a>01232          <span class="comment">/* is every entry in the root_table also in the root list? */</span> 
<a name="l01233"></a>01233          <span class="keywordflow">if</span> (!c2-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>) {
<a name="l01234"></a>01234             <span class="keywordflow">if</span> (c2-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a>) {
<a name="l01235"></a>01235                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: No c2-&gt;root_table for context %s!\n&quot;</span>, file, line, c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l01236"></a>01236                usleep(500000);
<a name="l01237"></a>01237             }
<a name="l01238"></a>01238          } <span class="keywordflow">else</span> {
<a name="l01239"></a>01239             t1 = <a class="code" href="hashtab_8h.html#ac5a19bffadbbd4eb31f190e576f88512" title="Gives an iterator to hastable.">ast_hashtab_start_traversal</a>(c2-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>);
<a name="l01240"></a>01240             <span class="keywordflow">while</span>( (e2 = <a class="code" href="hashtab_8h.html#a43983b6169e9a0f9af48cca5cf9d3197" title="Gets the next object in the list, advances iter one step returns null on end of traversal...">ast_hashtab_next</a>(t1)) ) {
<a name="l01241"></a>01241                <span class="keywordflow">for</span>(e1=c2-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a>;e1;e1=e1-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>) {
<a name="l01242"></a>01242                   <span class="keywordflow">if</span> (!strcmp(e1-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, e2-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>)) {
<a name="l01243"></a>01243                      found = 1;
<a name="l01244"></a>01244                      <span class="keywordflow">break</span>;
<a name="l01245"></a>01245                   }
<a name="l01246"></a>01246                }
<a name="l01247"></a>01247                <span class="keywordflow">if</span> (!found) {
<a name="l01248"></a>01248                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: The %s context records the exten %s but it is not in its root_table\n&quot;</span>, file, line, c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, e2-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l01249"></a>01249                   check_contexts_trouble();
<a name="l01250"></a>01250                }
<a name="l01251"></a>01251 
<a name="l01252"></a>01252             }
<a name="l01253"></a>01253             <a class="code" href="hashtab_8h.html#a9c804e9bfc8355c25197187f0c6d0265" title="end the traversal, free the iterator, unlock if necc.">ast_hashtab_end_traversal</a>(t1);
<a name="l01254"></a>01254          }
<a name="l01255"></a>01255       }
<a name="l01256"></a>01256       <span class="comment">/* is every priority reflected in the peer_table at the head of the list? */</span>
<a name="l01257"></a>01257 
<a name="l01258"></a>01258       <span class="comment">/* is every entry in the root list also in the root_table? */</span>
<a name="l01259"></a>01259       <span class="comment">/* are the per-extension peer_tables in the right place? */</span>
<a name="l01260"></a>01260 
<a name="l01261"></a>01261       <span class="keywordflow">for</span>(e1 = c2-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a>; e1; e1 = e1-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>) {
<a name="l01262"></a>01262 
<a name="l01263"></a>01263          <span class="keywordflow">for</span>(e2=e1;e2;e2=e2-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>) {
<a name="l01264"></a>01264             ex.priority = e2-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>;
<a name="l01265"></a>01265             <span class="keywordflow">if</span> (e2 != e1 &amp;&amp; e2-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>) {
<a name="l01266"></a>01266                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: The %s context, %s exten, %d priority has a peer_table entry, and shouldn&apos;t!\n&quot;</span>, file, line, c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, e1-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, e2-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> );
<a name="l01267"></a>01267                check_contexts_trouble();
<a name="l01268"></a>01268             }
<a name="l01269"></a>01269 
<a name="l01270"></a>01270             <span class="keywordflow">if</span> (e2 != e1 &amp;&amp; e2-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>) {
<a name="l01271"></a>01271                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: The %s context, %s exten, %d priority has a peer_label_table entry, and shouldn&apos;t!\n&quot;</span>, file, line, c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, e1-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, e2-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> );
<a name="l01272"></a>01272                check_contexts_trouble();
<a name="l01273"></a>01273             }
<a name="l01274"></a>01274 
<a name="l01275"></a>01275             <span class="keywordflow">if</span> (e2 == e1 &amp;&amp; !e2-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>){
<a name="l01276"></a>01276                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: The %s context, %s exten, %d priority doesn&apos;t have a peer_table!\n&quot;</span>, file, line, c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, e1-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, e2-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> );
<a name="l01277"></a>01277                check_contexts_trouble();
<a name="l01278"></a>01278             }
<a name="l01279"></a>01279 
<a name="l01280"></a>01280             <span class="keywordflow">if</span> (e2 == e1 &amp;&amp; !e2-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>) {
<a name="l01281"></a>01281                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: The %s context, %s exten, %d priority doesn&apos;t have a peer_label_table!\n&quot;</span>, file, line, c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, e1-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, e2-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> );
<a name="l01282"></a>01282                check_contexts_trouble();
<a name="l01283"></a>01283             }
<a name="l01284"></a>01284 
<a name="l01285"></a>01285 
<a name="l01286"></a>01286             e3 = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(e1-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>, &amp;ex);
<a name="l01287"></a>01287             <span class="keywordflow">if</span> (!e3) {
<a name="l01288"></a>01288                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: The %s context, %s exten, %d priority is not reflected in the peer_table\n&quot;</span>, file, line, c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, e1-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, e2-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> );
<a name="l01289"></a>01289                check_contexts_trouble();
<a name="l01290"></a>01290             }
<a name="l01291"></a>01291          }
<a name="l01292"></a>01292 
<a name="l01293"></a>01293          <span class="keywordflow">if</span> (!e1-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>){
<a name="l01294"></a>01294             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: No e1-&gt;peer_table!\n&quot;</span>, file, line);
<a name="l01295"></a>01295             usleep(500000);
<a name="l01296"></a>01296          }
<a name="l01297"></a>01297 
<a name="l01298"></a>01298          <span class="comment">/* is every entry in the peer_table also in the peer list? */</span>
<a name="l01299"></a>01299          t1 = <a class="code" href="hashtab_8h.html#ac5a19bffadbbd4eb31f190e576f88512" title="Gives an iterator to hastable.">ast_hashtab_start_traversal</a>(e1-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>);
<a name="l01300"></a>01300          <span class="keywordflow">while</span>( (e2 = <a class="code" href="hashtab_8h.html#a43983b6169e9a0f9af48cca5cf9d3197" title="Gets the next object in the list, advances iter one step returns null on end of traversal...">ast_hashtab_next</a>(t1)) ) {
<a name="l01301"></a>01301             <span class="keywordflow">for</span>(e3=e1;e3;e3=e3-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>) {
<a name="l01302"></a>01302                <span class="keywordflow">if</span> (e3-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> == e2-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>) {
<a name="l01303"></a>01303                   found = 1;
<a name="l01304"></a>01304                   <span class="keywordflow">break</span>;
<a name="l01305"></a>01305                }
<a name="l01306"></a>01306             }
<a name="l01307"></a>01307             <span class="keywordflow">if</span> (!found) {
<a name="l01308"></a>01308                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Called from: %s:%d: The %s context, %s exten, %d priority is not reflected in the peer list\n&quot;</span>, file, line, c2-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, e1-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, e2-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> );
<a name="l01309"></a>01309                check_contexts_trouble();
<a name="l01310"></a>01310             }
<a name="l01311"></a>01311          }
<a name="l01312"></a>01312          <a class="code" href="hashtab_8h.html#a9c804e9bfc8355c25197187f0c6d0265" title="end the traversal, free the iterator, unlock if necc.">ast_hashtab_end_traversal</a>(t1);
<a name="l01313"></a>01313       }
<a name="l01314"></a>01314    }
<a name="l01315"></a>01315    <span class="keywordflow">return</span> 0;
<a name="l01316"></a>01316 }
<a name="l01317"></a>01317 <span class="preprocessor">#endif</span>
<a name="l01318"></a>01318 <span class="preprocessor"></span>
<a name="l01319"></a>01319 <span class="comment">/*</span>
<a name="l01320"></a>01320 <span class="comment">   \note This function is special. It saves the stack so that no matter</span>
<a name="l01321"></a>01321 <span class="comment">   how many times it is called, it returns to the same place */</span>
<a name="l01322"></a><a class="code" href="pbx_8c.html#afb87ff7a4504ef6031a45ae4170acaad">01322</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="comment">/*!&lt; Channel */</span>
<a name="l01323"></a>01323         <span class="keyword">struct</span> ast_app *<a class="code" href="adsistub_8c.html#ad194d73de26c0d836555e029d245493d">app</a>,       <span class="comment">/*!&lt; Application */</span>
<a name="l01324"></a>01324         <span class="keywordtype">void</span> *data)                <span class="comment">/*!&lt; Data for execution */</span>
<a name="l01325"></a>01325 {
<a name="l01326"></a>01326    <span class="keywordtype">int</span> res;
<a name="l01327"></a>01327    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u = NULL;
<a name="l01328"></a>01328    <span class="keyword">const</span> <span class="keywordtype">char</span> *saved_c_appl;
<a name="l01329"></a>01329    <span class="keyword">const</span> <span class="keywordtype">char</span> *saved_c_data;
<a name="l01330"></a>01330 
<a name="l01331"></a>01331    <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> &amp;&amp; !<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(c))
<a name="l01332"></a>01332       <a class="code" href="cdr_8h.html#a877162d212a320e7daec6aa7f695e9a8" title="Set the last executed application.">ast_cdr_setapp</a>(c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, app-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, data);
<a name="l01333"></a>01333 
<a name="l01334"></a>01334    <span class="comment">/* save channel values */</span>
<a name="l01335"></a>01335    saved_c_appl= c-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a>;
<a name="l01336"></a>01336    saved_c_data= c-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>;
<a name="l01337"></a>01337 
<a name="l01338"></a>01338    c-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a> = app-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>;
<a name="l01339"></a>01339    c-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a> = data;
<a name="l01340"></a>01340    <span class="keywordflow">if</span> (app-&gt;<a class="code" href="structast__app.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">module</a>)
<a name="l01341"></a>01341       u = <a class="code" href="module_8h.html#ad315d50d0a7d61cb9feac19223fff8c0">__ast_module_user_add</a>(app-&gt;<a class="code" href="structast__app.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">module</a>, c);
<a name="l01342"></a>01342    <span class="keywordflow">if</span> (strcasecmp(app-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, <span class="stringliteral">&quot;system&quot;</span>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data) &amp;&amp;
<a name="l01343"></a>01343          strchr(data, <span class="charliteral">&apos;|&apos;</span>) &amp;&amp; !strchr(data, <span class="charliteral">&apos;,&apos;</span>) &amp;&amp; !<a class="code" href="options_8h.html#a5240f07b6ff8003ff47b856d44ef7226">ast_opt_dont_warn</a>) {
<a name="l01344"></a>01344       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;The application delimiter is now the comma, not &quot;</span>
<a name="l01345"></a>01345          <span class="stringliteral">&quot;the pipe.  Did you forget to convert your dialplan?  (%s(%s))\n&quot;</span>,
<a name="l01346"></a>01346          app-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, (<span class="keywordtype">char</span> *) data);
<a name="l01347"></a>01347    }
<a name="l01348"></a>01348    res = app-&gt;<a class="code" href="structast__app.html#aaa273c19af19ad4f2f0cd376bd1b5f8f">execute</a>(c, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>((<span class="keywordtype">char</span> *) data, <span class="stringliteral">&quot;&quot;</span>));
<a name="l01349"></a>01349    <span class="keywordflow">if</span> (app-&gt;<a class="code" href="structast__app.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">module</a> &amp;&amp; u)
<a name="l01350"></a>01350       <a class="code" href="module_8h.html#aee5ac94e279928d1d1f7b6aafb62ec7a">__ast_module_user_remove</a>(app-&gt;<a class="code" href="structast__app.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">module</a>, u);
<a name="l01351"></a>01351    <span class="comment">/* restore channel values */</span>
<a name="l01352"></a>01352    c-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a> = saved_c_appl;
<a name="l01353"></a>01353    c-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a> = saved_c_data;
<a name="l01354"></a>01354    <span class="keywordflow">return</span> res;
<a name="l01355"></a>01355 }
<a name="l01356"></a>01356 
<a name="l01357"></a>01357 <span class="comment"></span>
<a name="l01358"></a>01358 <span class="comment">/*! Go no deeper than this through includes (not counting loops) */</span>
<a name="l01359"></a><a class="code" href="pbx_8c.html#a05848c0de74d85dc2fb259f332d33f25">01359</a> <span class="preprocessor">#define AST_PBX_MAX_STACK  128</span>
<a name="l01360"></a>01360 <span class="preprocessor"></span><span class="comment"></span>
<a name="l01361"></a>01361 <span class="comment">/*! \brief Find application handle in linked list</span>
<a name="l01362"></a>01362 <span class="comment"> */</span>
<a name="l01363"></a><a class="code" href="pbx_8c.html#a0db9808b647984133225652170b22b79">01363</a> <span class="keyword">struct </span>ast_app *<a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#ad194d73de26c0d836555e029d245493d">app</a>)
<a name="l01364"></a>01364 {
<a name="l01365"></a>01365    <span class="keyword">struct </span>ast_app *tmp;
<a name="l01366"></a>01366 
<a name="l01367"></a>01367    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l01368"></a>01368    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structapps.html">apps</a>, tmp, list) {
<a name="l01369"></a>01369       <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, app))
<a name="l01370"></a>01370          <span class="keywordflow">break</span>;
<a name="l01371"></a>01371    }
<a name="l01372"></a>01372    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l01373"></a>01373 
<a name="l01374"></a>01374    <span class="keywordflow">return</span> tmp;
<a name="l01375"></a>01375 }
<a name="l01376"></a>01376 
<a name="l01377"></a><a class="code" href="pbx_8c.html#a7b44c1c9eafe43b4400fd90794078cef">01377</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__switch.html">ast_switch</a> *<a class="code" href="pbx_8c.html#a7b44c1c9eafe43b4400fd90794078cef">pbx_findswitch</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sw)
<a name="l01378"></a>01378 {
<a name="l01379"></a>01379    <span class="keyword">struct </span><a class="code" href="structast__switch.html">ast_switch</a> *asw;
<a name="l01380"></a>01380 
<a name="l01381"></a>01381    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structswitches.html">switches</a>);
<a name="l01382"></a>01382    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structswitches.html">switches</a>, asw, list) {
<a name="l01383"></a>01383       <span class="keywordflow">if</span> (!strcasecmp(asw-&gt;<a class="code" href="structast__switch.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, sw))
<a name="l01384"></a>01384          <span class="keywordflow">break</span>;
<a name="l01385"></a>01385    }
<a name="l01386"></a>01386    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structswitches.html">switches</a>);
<a name="l01387"></a>01387 
<a name="l01388"></a>01388    <span class="keywordflow">return</span> asw;
<a name="l01389"></a>01389 }
<a name="l01390"></a>01390 
<a name="l01391"></a><a class="code" href="pbx_8c.html#a6a57ed16bf75bd443baa0c8a7ad74a1a">01391</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a6a57ed16bf75bd443baa0c8a7ad74a1a">include_valid</a>(<span class="keyword">struct</span> <a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *i)
<a name="l01392"></a>01392 {
<a name="l01393"></a>01393    <span class="keywordflow">if</span> (!i-&gt;<a class="code" href="structast__include.html#a5e1a4fa8d4d02bae74f72169ade15143">hastime</a>)
<a name="l01394"></a>01394       <span class="keywordflow">return</span> 1;
<a name="l01395"></a>01395 
<a name="l01396"></a>01396    <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a17b7d6ec799c60a8fda825cf59aea7eb" title="Evaluate a pre-constructed bitmap as to whether the current time falls within the...">ast_check_timing</a>(&amp;(i-&gt;<a class="code" href="structast__include.html#a137134920b381175bea34c57d2565f91">timing</a>));
<a name="l01397"></a>01397 }
<a name="l01398"></a>01398 
<a name="l01399"></a><a class="code" href="pbx_8c.html#a1a7e2b65d9fc687fe40a8dbcefa7bc4e">01399</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a1a7e2b65d9fc687fe40a8dbcefa7bc4e">pbx_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structast__pbx.html">ast_pbx</a> *p)
<a name="l01400"></a>01400 {
<a name="l01401"></a>01401    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(p);
<a name="l01402"></a>01402 }
<a name="l01403"></a>01403 
<a name="l01404"></a>01404 <span class="comment">/* form a tree that fully describes all the patterns in a context&apos;s extensions</span>
<a name="l01405"></a>01405 <span class="comment"> * in this tree, a &quot;node&quot; represents an individual character or character set</span>
<a name="l01406"></a>01406 <span class="comment"> * meant to match the corresponding character in a dial string. The tree</span>
<a name="l01407"></a>01407 <span class="comment"> * consists of a series of match_char structs linked in a chain</span>
<a name="l01408"></a>01408 <span class="comment"> * via the alt_char pointers. More than one pattern can share the same parts of the</span>
<a name="l01409"></a>01409 <span class="comment"> * tree as other extensions with the same pattern to that point.</span>
<a name="l01410"></a>01410 <span class="comment"> * My first attempt to duplicate the finding of the &apos;best&apos; pattern was flawed in that</span>
<a name="l01411"></a>01411 <span class="comment"> * I misunderstood the general algorithm. I thought that the &apos;best&apos; pattern</span>
<a name="l01412"></a>01412 <span class="comment"> * was the one with lowest total score. This was not true. Thus, if you have</span>
<a name="l01413"></a>01413 <span class="comment"> * patterns &quot;1XXXXX&quot; and &quot;X11111&quot;, you would be tempted to say that &quot;X11111&quot; is</span>
<a name="l01414"></a>01414 <span class="comment"> * the &quot;best&quot; match because it has fewer X&apos;s, and is therefore more specific,</span>
<a name="l01415"></a>01415 <span class="comment"> * but this is not how the old algorithm works. It sorts matching patterns</span>
<a name="l01416"></a>01416 <span class="comment"> * in a similar collating sequence as sorting alphabetic strings, from left to</span>
<a name="l01417"></a>01417 <span class="comment"> * right. Thus, &quot;1XXXXX&quot; comes before &quot;X11111&quot;, and would be the &quot;better&quot; match,</span>
<a name="l01418"></a>01418 <span class="comment"> * because &quot;1&quot; is more specific than &quot;X&quot;.</span>
<a name="l01419"></a>01419 <span class="comment"> * So, to accomodate this philosophy, I sort the tree branches along the alt_char</span>
<a name="l01420"></a>01420 <span class="comment"> * line so they are lowest to highest in specificity numbers. This way, as soon</span>
<a name="l01421"></a>01421 <span class="comment"> * as we encounter our first complete match, we automatically have the &quot;best&quot;</span>
<a name="l01422"></a>01422 <span class="comment"> * match and can stop the traversal immediately. Same for CANMATCH/MATCHMORE.</span>
<a name="l01423"></a>01423 <span class="comment"> * If anyone would like to resurrect the &quot;wrong&quot; pattern trie searching algorithm,</span>
<a name="l01424"></a>01424 <span class="comment"> * they are welcome to revert pbx to before 1 Apr 2008.</span>
<a name="l01425"></a>01425 <span class="comment"> * As an example, consider these 4 extensions:</span>
<a name="l01426"></a>01426 <span class="comment"> * (a) NXXNXXXXXX</span>
<a name="l01427"></a>01427 <span class="comment"> * (b) 307754XXXX</span>
<a name="l01428"></a>01428 <span class="comment"> * (c) fax</span>
<a name="l01429"></a>01429 <span class="comment"> * (d) NXXXXXXXXX</span>
<a name="l01430"></a>01430 <span class="comment"> *</span>
<a name="l01431"></a>01431 <span class="comment"> * In the above, between (a) and (d), (a) is a more specific pattern than (d), and would win over</span>
<a name="l01432"></a>01432 <span class="comment"> * most numbers. For all numbers beginning with 307754, (b) should always win.</span>
<a name="l01433"></a>01433 <span class="comment"> *</span>
<a name="l01434"></a>01434 <span class="comment"> * These pattern should form a (sorted) tree that looks like this:</span>
<a name="l01435"></a>01435 <span class="comment"> *   { &quot;3&quot; }  --next--&gt;  { &quot;0&quot; }  --next--&gt; { &quot;7&quot; } --next--&gt; { &quot;7&quot; } --next--&gt; { &quot;5&quot; } ... blah ... --&gt; { &quot;X&quot; exten_match: (b) }</span>
<a name="l01436"></a>01436 <span class="comment"> *      |</span>
<a name="l01437"></a>01437 <span class="comment"> *      |alt</span>
<a name="l01438"></a>01438 <span class="comment"> *      |</span>
<a name="l01439"></a>01439 <span class="comment"> *   { &quot;f&quot; }  --next--&gt;  { &quot;a&quot; }  --next--&gt; { &quot;x&quot;  exten_match: (c) }</span>
<a name="l01440"></a>01440 <span class="comment"> *   { &quot;N&quot; }  --next--&gt;  { &quot;X&quot; }  --next--&gt; { &quot;X&quot; } --next--&gt; { &quot;N&quot; } --next--&gt; { &quot;X&quot; } ... blah ... --&gt; { &quot;X&quot; exten_match: (a) }</span>
<a name="l01441"></a>01441 <span class="comment"> *      |                                                        |</span>
<a name="l01442"></a>01442 <span class="comment"> *      |                                                        |alt</span>
<a name="l01443"></a>01443 <span class="comment"> *      |alt                                                     |</span>
<a name="l01444"></a>01444 <span class="comment"> *      |                                                     { &quot;X&quot; } --next--&gt; { &quot;X&quot; } ... blah ... --&gt; { &quot;X&quot; exten_match: (d) }</span>
<a name="l01445"></a>01445 <span class="comment"> *      |</span>
<a name="l01446"></a>01446 <span class="comment"> *     NULL</span>
<a name="l01447"></a>01447 <span class="comment"> *</span>
<a name="l01448"></a>01448 <span class="comment"> *   In the above, I could easily turn &quot;N&quot; into &quot;23456789&quot;, but I think that a quick &quot;if( *z &gt;= &apos;2&apos; &amp;&amp; *z &lt;= &apos;9&apos; )&quot; might take</span>
<a name="l01449"></a>01449 <span class="comment"> *   fewer CPU cycles than a call to strchr(&quot;23456789&quot;,*z), where *z is the char to match...</span>
<a name="l01450"></a>01450 <span class="comment"> *</span>
<a name="l01451"></a>01451 <span class="comment"> *   traversal is pretty simple: one routine merely traverses the alt list, and for each matching char in the pattern,  it calls itself</span>
<a name="l01452"></a>01452 <span class="comment"> *   on the corresponding next pointer, incrementing also the pointer of the string to be matched, and passing the total specificity and length.</span>
<a name="l01453"></a>01453 <span class="comment"> *   We pass a pointer to a scoreboard down through, also.</span>
<a name="l01454"></a>01454 <span class="comment"> *   The scoreboard isn&apos;t as necessary to the revised algorithm, but I kept it as a handy way to return the matched extension.</span>
<a name="l01455"></a>01455 <span class="comment"> *   The first complete match ends the traversal, which should make this version of the pattern matcher faster</span>
<a name="l01456"></a>01456 <span class="comment"> *   the previous. The same goes for &quot;CANMATCH&quot; or &quot;MATCHMORE&quot;; the first such match ends the traversal. In both</span>
<a name="l01457"></a>01457 <span class="comment"> *   these cases, the reason we can stop immediately, is because the first pattern match found will be the &quot;best&quot;</span>
<a name="l01458"></a>01458 <span class="comment"> *   according to the sort criteria.</span>
<a name="l01459"></a>01459 <span class="comment"> *   Hope the limit on stack depth won&apos;t be a problem... this routine should</span>
<a name="l01460"></a>01460 <span class="comment"> *   be pretty lean as far a stack usage goes. Any non-match terminates the recursion down a branch.</span>
<a name="l01461"></a>01461 <span class="comment"> *</span>
<a name="l01462"></a>01462 <span class="comment"> *   In the above example, with the number &quot;3077549999&quot; as the pattern, the traversor could match extensions a, b and d.  All are</span>
<a name="l01463"></a>01463 <span class="comment"> *   of length 10; they have total specificities of  24580, 10246, and 25090, respectively, not that this matters</span>
<a name="l01464"></a>01464 <span class="comment"> *   at all. (b) wins purely because the first character &quot;3&quot; is much more specific (lower specificity) than &quot;N&quot;. I have</span>
<a name="l01465"></a>01465 <span class="comment"> *   left the specificity totals in the code as an artifact; at some point, I will strip it out.</span>
<a name="l01466"></a>01466 <span class="comment"> *</span>
<a name="l01467"></a>01467 <span class="comment"> *   Just how much time this algorithm might save over a plain linear traversal over all possible patterns is unknown,</span>
<a name="l01468"></a>01468 <span class="comment"> *   because it&apos;s a function of how many extensions are stored in a context. With thousands of extensions, the speedup</span>
<a name="l01469"></a>01469 <span class="comment"> *   can be very noticeable. The new matching algorithm can run several hundreds of times faster, if not a thousand or</span>
<a name="l01470"></a>01470 <span class="comment"> *   more times faster in extreme cases.</span>
<a name="l01471"></a>01471 <span class="comment"> *</span>
<a name="l01472"></a>01472 <span class="comment"> *   MatchCID patterns are also supported, and stored in the tree just as the extension pattern is. Thus, you</span>
<a name="l01473"></a>01473 <span class="comment"> *   can have patterns in your CID field as well.</span>
<a name="l01474"></a>01474 <span class="comment"> *</span>
<a name="l01475"></a>01475 <span class="comment"> * */</span>
<a name="l01476"></a>01476 
<a name="l01477"></a>01477 
<a name="l01478"></a><a class="code" href="pbx_8c.html#a04876a5c80405b2f4ee492bbc4777bd4">01478</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a04876a5c80405b2f4ee492bbc4777bd4">update_scoreboard</a>(<span class="keyword">struct</span> <a class="code" href="structscoreboard.html">scoreboard</a> *board, <span class="keywordtype">int</span> length, <span class="keywordtype">int</span> spec, <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *exten, <span class="keywordtype">char</span> <a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keywordtype">int</span> deleted, <span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *node)
<a name="l01479"></a>01479 {
<a name="l01480"></a>01480    <span class="comment">/* if this extension is marked as deleted, then skip this -- if it never shows</span>
<a name="l01481"></a>01481 <span class="comment">      on the scoreboard, it will never be found, nor will halt the traversal. */</span>
<a name="l01482"></a>01482    <span class="keywordflow">if</span> (deleted)
<a name="l01483"></a>01483       <span class="keywordflow">return</span>;
<a name="l01484"></a>01484    board-&gt;<a class="code" href="structscoreboard.html#a4de425bb2743e2e19c2e954dfe1f0bf8">total_specificity</a> = spec;
<a name="l01485"></a>01485    board-&gt;<a class="code" href="structscoreboard.html#a411afdaaca990dd80881e20637dc44af">total_length</a> = length;
<a name="l01486"></a>01486    board-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> = exten;
<a name="l01487"></a>01487    board-&gt;<a class="code" href="structscoreboard.html#a58353d0395200b159f144de279d0a9b2">last_char</a> = last;
<a name="l01488"></a>01488    board-&gt;<a class="code" href="structscoreboard.html#ae6f7c8319cca7a79bdab95ecfa8b57eb">node</a> = node;
<a name="l01489"></a>01489 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l01490"></a>01490 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Scoreboarding (LONGER) %s, len=%d, score=%d\n&quot;</span>, exten-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, length, spec);
<a name="l01491"></a>01491 <span class="preprocessor">#endif</span>
<a name="l01492"></a>01492 <span class="preprocessor"></span>}
<a name="l01493"></a>01493 
<a name="l01494"></a><a class="code" href="pbx_8c.html#a45d3d0857a56e9ec039a20350bbb7d7f">01494</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a45d3d0857a56e9ec039a20350bbb7d7f">log_match_char_tree</a>(<span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *node, <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>)
<a name="l01495"></a>01495 {
<a name="l01496"></a>01496    <span class="keywordtype">char</span> extenstr[40];
<a name="l01497"></a>01497    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *my_prefix = <a class="code" href="strings_8h.html#a7fc844c12b769ccded05e7514036e241">ast_str_alloca</a>(1024);
<a name="l01498"></a>01498 
<a name="l01499"></a>01499    extenstr[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01500"></a>01500 
<a name="l01501"></a>01501    <span class="keywordflow">if</span> (node &amp;&amp; node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> &amp;&amp; node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>)
<a name="l01502"></a>01502       snprintf(extenstr, <span class="keyword">sizeof</span>(extenstr), <span class="stringliteral">&quot;(%p)&quot;</span>, node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>);
<a name="l01503"></a>01503 
<a name="l01504"></a>01504    <span class="keywordflow">if</span> (strlen(node-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>) &gt; 1) {
<a name="l01505"></a>01505       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s[%s]:%c:%c:%d:%s%s%s\n&quot;</span>, prefix, node-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>, node-&gt;<a class="code" href="structmatch__char.html#a67e42f878971513be0d2fa914019a38d">is_pattern</a> ? <span class="charliteral">&apos;Y&apos;</span>:<span class="charliteral">&apos;N&apos;</span>,
<a name="l01506"></a>01506          node-&gt;<a class="code" href="structmatch__char.html#a3cb0d95aa820737d010fdfaccac92ec3">deleted</a>? <span class="charliteral">&apos;D&apos;</span>:<span class="charliteral">&apos;-&apos;</span>, node-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a>, node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>? <span class="stringliteral">&quot;EXTEN:&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,
<a name="l01507"></a>01507          node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> ? node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a> : <span class="stringliteral">&quot;&quot;</span>, extenstr);
<a name="l01508"></a>01508    } <span class="keywordflow">else</span> {
<a name="l01509"></a>01509       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s%s:%c:%c:%d:%s%s%s\n&quot;</span>, prefix, node-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>, node-&gt;<a class="code" href="structmatch__char.html#a67e42f878971513be0d2fa914019a38d">is_pattern</a> ? <span class="charliteral">&apos;Y&apos;</span>:<span class="charliteral">&apos;N&apos;</span>,
<a name="l01510"></a>01510          node-&gt;<a class="code" href="structmatch__char.html#a3cb0d95aa820737d010fdfaccac92ec3">deleted</a>? <span class="charliteral">&apos;D&apos;</span>:<span class="charliteral">&apos;-&apos;</span>, node-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a>, node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>? <span class="stringliteral">&quot;EXTEN:&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,
<a name="l01511"></a>01511          node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> ? node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a> : <span class="stringliteral">&quot;&quot;</span>, extenstr);
<a name="l01512"></a>01512    }
<a name="l01513"></a>01513 
<a name="l01514"></a>01514    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;my_prefix, 0, <span class="stringliteral">&quot;%s+       &quot;</span>, prefix);
<a name="l01515"></a>01515 
<a name="l01516"></a>01516    <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>)
<a name="l01517"></a>01517       <a class="code" href="pbx_8c.html#a45d3d0857a56e9ec039a20350bbb7d7f">log_match_char_tree</a>(node-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(my_prefix));
<a name="l01518"></a>01518 
<a name="l01519"></a>01519    <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>)
<a name="l01520"></a>01520       <a class="code" href="pbx_8c.html#a45d3d0857a56e9ec039a20350bbb7d7f">log_match_char_tree</a>(node-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>, prefix);
<a name="l01521"></a>01521 }
<a name="l01522"></a>01522 
<a name="l01523"></a><a class="code" href="pbx_8c.html#a36264871dfb05b0e331f7a6f19049ab6">01523</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a36264871dfb05b0e331f7a6f19049ab6">cli_match_char_tree</a>(<span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *node, <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>, <span class="keywordtype">int</span> fd)
<a name="l01524"></a>01524 {
<a name="l01525"></a>01525    <span class="keywordtype">char</span> extenstr[40];
<a name="l01526"></a>01526    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *my_prefix = <a class="code" href="strings_8h.html#a7fc844c12b769ccded05e7514036e241">ast_str_alloca</a>(1024);
<a name="l01527"></a>01527 
<a name="l01528"></a>01528    extenstr[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01529"></a>01529 
<a name="l01530"></a>01530    <span class="keywordflow">if</span> (node &amp;&amp; node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> &amp;&amp; node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>)
<a name="l01531"></a>01531       snprintf(extenstr, <span class="keyword">sizeof</span>(extenstr), <span class="stringliteral">&quot;(%p)&quot;</span>, node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>);
<a name="l01532"></a>01532 
<a name="l01533"></a>01533    <span class="keywordflow">if</span> (strlen(node-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>) &gt; 1) {
<a name="l01534"></a>01534       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s[%s]:%c:%c:%d:%s%s%s\n&quot;</span>, prefix, node-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>, node-&gt;<a class="code" href="structmatch__char.html#a67e42f878971513be0d2fa914019a38d">is_pattern</a> ? <span class="charliteral">&apos;Y&apos;</span> : <span class="charliteral">&apos;N&apos;</span>,
<a name="l01535"></a>01535          node-&gt;<a class="code" href="structmatch__char.html#a3cb0d95aa820737d010fdfaccac92ec3">deleted</a> ? <span class="charliteral">&apos;D&apos;</span> : <span class="charliteral">&apos;-&apos;</span>, node-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a>, node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>? <span class="stringliteral">&quot;EXTEN:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01536"></a>01536          node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> ? node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a> : <span class="stringliteral">&quot;&quot;</span>, extenstr);
<a name="l01537"></a>01537    } <span class="keywordflow">else</span> {
<a name="l01538"></a>01538       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s%s:%c:%c:%d:%s%s%s\n&quot;</span>, prefix, node-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>, node-&gt;<a class="code" href="structmatch__char.html#a67e42f878971513be0d2fa914019a38d">is_pattern</a> ? <span class="charliteral">&apos;Y&apos;</span> : <span class="charliteral">&apos;N&apos;</span>,
<a name="l01539"></a>01539          node-&gt;<a class="code" href="structmatch__char.html#a3cb0d95aa820737d010fdfaccac92ec3">deleted</a> ? <span class="charliteral">&apos;D&apos;</span> : <span class="charliteral">&apos;-&apos;</span>, node-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a>, node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>? <span class="stringliteral">&quot;EXTEN:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01540"></a>01540          node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> ? node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a> : <span class="stringliteral">&quot;&quot;</span>, extenstr);
<a name="l01541"></a>01541    }
<a name="l01542"></a>01542 
<a name="l01543"></a>01543    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;my_prefix, 0, <span class="stringliteral">&quot;%s+       &quot;</span>, prefix);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545    <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>)
<a name="l01546"></a>01546       <a class="code" href="pbx_8c.html#a36264871dfb05b0e331f7a6f19049ab6">cli_match_char_tree</a>(node-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(my_prefix), fd);
<a name="l01547"></a>01547 
<a name="l01548"></a>01548    <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>)
<a name="l01549"></a>01549       <a class="code" href="pbx_8c.html#a36264871dfb05b0e331f7a6f19049ab6">cli_match_char_tree</a>(node-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>, prefix, fd);
<a name="l01550"></a>01550 }
<a name="l01551"></a>01551 
<a name="l01552"></a><a class="code" href="pbx_8c.html#aefee0e2a38de76a008277db39cd9e3a8">01552</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="pbx_8c.html#aefee0e2a38de76a008277db39cd9e3a8">get_canmatch_exten</a>(<span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *node)
<a name="l01553"></a>01553 {
<a name="l01554"></a>01554    <span class="comment">/* find the exten at the end of the rope */</span>
<a name="l01555"></a>01555    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *node2 = node;
<a name="l01556"></a>01556 
<a name="l01557"></a>01557    <span class="keywordflow">for</span> (node2 = node; node2; node2 = node2-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>) {
<a name="l01558"></a>01558       <span class="keywordflow">if</span> (node2-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>) {
<a name="l01559"></a>01559 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l01560"></a>01560 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;CanMatch_exten returns exten %s(%p)\n&quot;</span>, node2-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, node2-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>);
<a name="l01561"></a>01561 <span class="preprocessor">#endif</span>
<a name="l01562"></a>01562 <span class="preprocessor"></span>         <span class="keywordflow">return</span> node2-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>;
<a name="l01563"></a>01563       }
<a name="l01564"></a>01564    }
<a name="l01565"></a>01565 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l01566"></a>01566 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;CanMatch_exten returns NULL, match_char=%s\n&quot;</span>, node-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>);
<a name="l01567"></a>01567 <span class="preprocessor">#endif</span>
<a name="l01568"></a>01568 <span class="preprocessor"></span>   <span class="keywordflow">return</span> 0;
<a name="l01569"></a>01569 }
<a name="l01570"></a>01570 
<a name="l01571"></a><a class="code" href="pbx_8c.html#ae41a2e0750d89ec626fd85b4f24d1e5d">01571</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="pbx_8c.html#ae41a2e0750d89ec626fd85b4f24d1e5d">trie_find_next_match</a>(<span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *node)
<a name="l01572"></a>01572 {
<a name="l01573"></a>01573    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *m3;
<a name="l01574"></a>01574    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *m4;
<a name="l01575"></a>01575    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e3;
<a name="l01576"></a>01576 
<a name="l01577"></a>01577    <span class="keywordflow">if</span> (node &amp;&amp; node-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[0] == <span class="charliteral">&apos;.&apos;</span> &amp;&amp; !node-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[1]) { <span class="comment">/* dot and ! will ALWAYS be next match in a matchmore */</span>
<a name="l01578"></a>01578       <span class="keywordflow">return</span> node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>;
<a name="l01579"></a>01579    }
<a name="l01580"></a>01580 
<a name="l01581"></a>01581    <span class="keywordflow">if</span> (node &amp;&amp; node-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[0] == <span class="charliteral">&apos;!&apos;</span> &amp;&amp; !node-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[1]) {
<a name="l01582"></a>01582       <span class="keywordflow">return</span> node-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>;
<a name="l01583"></a>01583    }
<a name="l01584"></a>01584 
<a name="l01585"></a>01585    <span class="keywordflow">if</span> (!node || !node-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>) {
<a name="l01586"></a>01586       <span class="keywordflow">return</span> NULL;
<a name="l01587"></a>01587    }
<a name="l01588"></a>01588 
<a name="l01589"></a>01589    m3 = node-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>;
<a name="l01590"></a>01590 
<a name="l01591"></a>01591    <span class="keywordflow">if</span> (m3-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>) {
<a name="l01592"></a>01592       <span class="keywordflow">return</span> m3-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>;
<a name="l01593"></a>01593    }
<a name="l01594"></a>01594    <span class="keywordflow">for</span> (m4 = m3-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>; m4; m4 = m4-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>) {
<a name="l01595"></a>01595       <span class="keywordflow">if</span> (m4-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>) {
<a name="l01596"></a>01596          <span class="keywordflow">return</span> m4-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>;
<a name="l01597"></a>01597       }
<a name="l01598"></a>01598    }
<a name="l01599"></a>01599    <span class="keywordflow">for</span> (m4 = m3; m4; m4 = m4-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>) {
<a name="l01600"></a>01600       e3 = <a class="code" href="pbx_8c.html#ae41a2e0750d89ec626fd85b4f24d1e5d">trie_find_next_match</a>(m3);
<a name="l01601"></a>01601       <span class="keywordflow">if</span> (e3) {
<a name="l01602"></a>01602          <span class="keywordflow">return</span> e3;
<a name="l01603"></a>01603       }
<a name="l01604"></a>01604    }
<a name="l01605"></a>01605    <span class="keywordflow">return</span> NULL;
<a name="l01606"></a>01606 }
<a name="l01607"></a>01607 
<a name="l01608"></a>01608 <span class="preprocessor">#ifdef DEBUG_THIS</span>
<a name="l01609"></a>01609 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">char</span> *action2str(<span class="keyword">enum</span> <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26be">ext_match_t</a> action)
<a name="l01610"></a>01610 {
<a name="l01611"></a>01611    <span class="keywordflow">switch</span> (action) {
<a name="l01612"></a>01612    <span class="keywordflow">case</span> <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea2e605157e82dec388ffc89c1694fb7be">E_MATCH</a>:
<a name="l01613"></a>01613       <span class="keywordflow">return</span> <span class="stringliteral">&quot;MATCH&quot;</span>;
<a name="l01614"></a>01614    <span class="keywordflow">case</span> <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea413c09377a892aa154e7669cbdaf27ba">E_CANMATCH</a>:
<a name="l01615"></a>01615       <span class="keywordflow">return</span> <span class="stringliteral">&quot;CANMATCH&quot;</span>;
<a name="l01616"></a>01616    <span class="keywordflow">case</span> <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>:
<a name="l01617"></a>01617       <span class="keywordflow">return</span> <span class="stringliteral">&quot;MATCHMORE&quot;</span>;
<a name="l01618"></a>01618    <span class="keywordflow">case</span> <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7b10ab7b3dd6af9d933dbb03dd183eb5">E_FINDLABEL</a>:
<a name="l01619"></a>01619       <span class="keywordflow">return</span> <span class="stringliteral">&quot;FINDLABEL&quot;</span>;
<a name="l01620"></a>01620    <span class="keywordflow">case</span> <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea8f986496ee140e4c7167ae25ad28d0ee">E_SPAWN</a>:
<a name="l01621"></a>01621       <span class="keywordflow">return</span> <span class="stringliteral">&quot;SPAWN&quot;</span>;
<a name="l01622"></a>01622    <span class="keywordflow">default</span>:
<a name="l01623"></a>01623       <span class="keywordflow">return</span> <span class="stringliteral">&quot;?ACTION?&quot;</span>;
<a name="l01624"></a>01624    }
<a name="l01625"></a>01625 }
<a name="l01626"></a>01626 
<a name="l01627"></a>01627 <span class="preprocessor">#endif</span>
<a name="l01628"></a>01628 <span class="preprocessor"></span>
<a name="l01629"></a><a class="code" href="pbx_8c.html#a2c64874adba109557bade6a7cbfd1eea">01629</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a2c64874adba109557bade6a7cbfd1eea">new_find_extension</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>, <span class="keyword">struct</span> <a class="code" href="structscoreboard.html">scoreboard</a> *score, <span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *tree, <span class="keywordtype">int</span> length, <span class="keywordtype">int</span> spec, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keyword">const</span> <span class="keywordtype">char</span> *label, <span class="keyword">enum</span> <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26be">ext_match_t</a> action)
<a name="l01630"></a>01630 {
<a name="l01631"></a>01631    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *p; <span class="comment">/* note minimal stack storage requirements */</span>
<a name="l01632"></a>01632    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> pattern = { .<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a> = label };
<a name="l01633"></a>01633 <span class="preprocessor">#ifdef DEBUG_THIS</span>
<a name="l01634"></a>01634 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (tree)
<a name="l01635"></a>01635       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;new_find_extension called with %s on (sub)tree %s action=%s\n&quot;</span>, str, tree-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>, action2str(action));
<a name="l01636"></a>01636    <span class="keywordflow">else</span>
<a name="l01637"></a>01637       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;new_find_extension called with %s on (sub)tree NULL action=%s\n&quot;</span>, str, action2str(action));
<a name="l01638"></a>01638 <span class="preprocessor">#endif</span>
<a name="l01639"></a>01639 <span class="preprocessor"></span>   <span class="keywordflow">for</span> (p = tree; p; p = p-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>) {
<a name="l01640"></a>01640       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[0] == <span class="charliteral">&apos;N&apos;</span>) {
<a name="l01641"></a>01641          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[1] == 0 &amp;&amp; *str &gt;= <span class="charliteral">&apos;2&apos;</span> &amp;&amp; *str &lt;= <span class="charliteral">&apos;9&apos;</span> ) {
<a name="l01642"></a>01642 <span class="preprocessor">#define NEW_MATCHER_CHK_MATCH        \</span>
<a name="l01643"></a>01643 <span class="preprocessor">            if (p-&gt;exten &amp;&amp; !(*(str + 1))) { </span><span class="comment">/* if a shorter pattern matches along the way, might as well report it */</span>           \
<a name="l01644"></a>01644                if (action == E_MATCH || action == E_SPAWN || action == E_FINDLABEL) { <span class="comment">/* if in CANMATCH/MATCHMORE, don&apos;t let matches get in the way */</span>   \
<a name="l01645"></a>01645                   update_scoreboard(score, length + 1, spec + p-&gt;specificity, p-&gt;exten, 0, callerid, p-&gt;deleted, p);           \
<a name="l01646"></a>01646                   if (!p-&gt;deleted) {                                                                                           \
<a name="l01647"></a>01647                      if (action == E_FINDLABEL) {                                                                             \
<a name="l01648"></a>01648                         if (ast_hashtab_lookup(score-&gt;exten-&gt;peer_label_table, &amp;pattern)) {                                  \
<a name="l01649"></a>01649                            ast_debug(4, &quot;Found label in preferred extension\n&quot;);                                            \
<a name="l01650"></a>01650                            return;                                                                                          \
<a name="l01651"></a>01651                         }                                                                                                    \
<a name="l01652"></a>01652                      } else {                                                                                                 \
<a name="l01653"></a>01653                         ast_debug(4,&quot;returning an exact match-- first found-- %s\n&quot;, p-&gt;exten-&gt;exten);                       \
<a name="l01654"></a>01654                         return; <span class="comment">/* the first match, by definition, will be the best, because of the sorted tree */</span>           \
<a name="l01655"></a>01655                      }                                                                                                        \
<a name="l01656"></a>01656                   }                                                                                                            \
<a name="l01657"></a>01657                }                                                                                                                \
<a name="l01658"></a>01658             }
<a name="l01659"></a>01659 
<a name="l01660"></a>01660 <span class="preprocessor">#define NEW_MATCHER_RECURSE              \</span>
<a name="l01661"></a>01661 <span class="preprocessor">            if (p-&gt;next_char &amp;&amp; ( *(str + 1) || (p-&gt;next_char-&gt;x[0] == &apos;/&apos; &amp;&amp; p-&gt;next_char-&gt;x[1] == 0)               \</span>
<a name="l01662"></a>01662 <span class="preprocessor">                                                 || p-&gt;next_char-&gt;x[0] == &apos;!&apos;)) {                                        \</span>
<a name="l01663"></a>01663 <span class="preprocessor">               if (*(str + 1) || p-&gt;next_char-&gt;x[0] == &apos;!&apos;) {                                                       \</span>
<a name="l01664"></a>01664 <span class="preprocessor">                  new_find_extension(str + 1, score, p-&gt;next_char, length + 1, spec+p-&gt;specificity, callerid, label, action); \</span>
<a name="l01665"></a>01665 <span class="preprocessor">                  if (score-&gt;exten)  {                                                                             \</span>
<a name="l01666"></a>01666 <span class="preprocessor">                       ast_debug(4, &quot;returning an exact match-- %s\n&quot;, score-&gt;exten-&gt;exten);                        \</span>
<a name="l01667"></a>01667 <span class="preprocessor">                     return; </span><span class="comment">/* the first match is all we need */</span>                                                 \
<a name="l01668"></a>01668                   }                                                                                    \
<a name="l01669"></a>01669                } else {                                                                                             \
<a name="l01670"></a>01670                   new_find_extension(&quot;/&quot;, score, p-&gt;next_char, length + 1, spec+p-&gt;specificity, callerid, label, action);   \
<a name="l01671"></a>01671                   if (score-&gt;exten || ((action == E_CANMATCH || action == E_MATCHMORE) &amp;&amp; score-&gt;canmatch)) {      \
<a name="l01672"></a>01672                        ast_debug(4,&quot;returning a (can/more) match--- %s\n&quot;, score-&gt;exten ? score-&gt;exten-&gt;exten :     \
<a name="l01673"></a>01673                                        &quot;NULL&quot;);                                                                          \
<a name="l01674"></a>01674                      return; <span class="comment">/* the first match is all we need */</span>                                                 \
<a name="l01675"></a>01675                   }                                                                                    \
<a name="l01676"></a>01676                }                                                                                                    \
<a name="l01677"></a>01677             } else if (p-&gt;next_char &amp;&amp; !*(str + 1)) {                                                                \
<a name="l01678"></a>01678                score-&gt;canmatch = 1;                                                                                 \
<a name="l01679"></a>01679                score-&gt;canmatch_exten = get_canmatch_exten(p);                                                       \
<a name="l01680"></a>01680                if (action == E_CANMATCH || action == E_MATCHMORE) {                                                 \
<a name="l01681"></a>01681                     ast_debug(4, &quot;returning a canmatch/matchmore--- str=%s\n&quot;, str);                                 \
<a name="l01682"></a>01682                   return;                                                                                          \
<a name="l01683"></a>01683                }                                                                                        \
<a name="l01684"></a>01684             }
<a name="l01685"></a>01685 
<a name="l01686"></a>01686             <a class="code" href="pbx_8c.html#ae9a20ca55100e97d325d306500dd49bd">NEW_MATCHER_CHK_MATCH</a>;
<a name="l01687"></a>01687             <a class="code" href="pbx_8c.html#a7825b1b6bf1206afac71bc155cff804b">NEW_MATCHER_RECURSE</a>;
<a name="l01688"></a>01688          }
<a name="l01689"></a>01689       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[0] == <span class="charliteral">&apos;Z&apos;</span>) {
<a name="l01690"></a>01690          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[1] == 0 &amp;&amp; *str &gt;= <span class="charliteral">&apos;1&apos;</span> &amp;&amp; *str &lt;= <span class="charliteral">&apos;9&apos;</span> ) {
<a name="l01691"></a>01691             <a class="code" href="pbx_8c.html#ae9a20ca55100e97d325d306500dd49bd">NEW_MATCHER_CHK_MATCH</a>;
<a name="l01692"></a>01692             <a class="code" href="pbx_8c.html#a7825b1b6bf1206afac71bc155cff804b">NEW_MATCHER_RECURSE</a>;
<a name="l01693"></a>01693          }
<a name="l01694"></a>01694       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[0] == <span class="charliteral">&apos;X&apos;</span>) {
<a name="l01695"></a>01695          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[1] == 0 &amp;&amp; *str &gt;= <span class="charliteral">&apos;0&apos;</span> &amp;&amp; *str &lt;= <span class="charliteral">&apos;9&apos;</span> ) {
<a name="l01696"></a>01696             <a class="code" href="pbx_8c.html#ae9a20ca55100e97d325d306500dd49bd">NEW_MATCHER_CHK_MATCH</a>;
<a name="l01697"></a>01697             <a class="code" href="pbx_8c.html#a7825b1b6bf1206afac71bc155cff804b">NEW_MATCHER_RECURSE</a>;
<a name="l01698"></a>01698          }
<a name="l01699"></a>01699       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[0] == <span class="charliteral">&apos;.&apos;</span> &amp;&amp; p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[1] == 0) {
<a name="l01700"></a>01700          <span class="comment">/* how many chars will the . match against? */</span>
<a name="l01701"></a>01701          <span class="keywordtype">int</span> i = 0;
<a name="l01702"></a>01702          <span class="keyword">const</span> <span class="keywordtype">char</span> *str2 = str;
<a name="l01703"></a>01703          <span class="keywordflow">while</span> (*str2 &amp;&amp; *str2 != <span class="charliteral">&apos;/&apos;</span>) {
<a name="l01704"></a>01704             str2++;
<a name="l01705"></a>01705             i++;
<a name="l01706"></a>01706          }
<a name="l01707"></a>01707          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> &amp;&amp; *str2 != <span class="charliteral">&apos;/&apos;</span>) {
<a name="l01708"></a>01708             <a class="code" href="pbx_8c.html#a04876a5c80405b2f4ee492bbc4777bd4">update_scoreboard</a>(score, length+i, spec+(i*p-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a>), p-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>, <span class="charliteral">&apos;.&apos;</span>, callerid, p-&gt;<a class="code" href="structmatch__char.html#a3cb0d95aa820737d010fdfaccac92ec3">deleted</a>, p);
<a name="l01709"></a>01709             <span class="keywordflow">if</span> (score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>) {
<a name="l01710"></a>01710                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4,<span class="stringliteral">&quot;return because scoreboard has a match with &apos;/&apos;--- %s\n&quot;</span>, score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l01711"></a>01711                <span class="keywordflow">return</span>; <span class="comment">/* the first match is all we need */</span>
<a name="l01712"></a>01712             }
<a name="l01713"></a>01713          }
<a name="l01714"></a>01714          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a> &amp;&amp; p-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[0] == <span class="charliteral">&apos;/&apos;</span> &amp;&amp; p-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[1] == 0) {
<a name="l01715"></a>01715             <a class="code" href="pbx_8c.html#a2c64874adba109557bade6a7cbfd1eea">new_find_extension</a>(<span class="stringliteral">&quot;/&quot;</span>, score, p-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>, length+i, spec+(p-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a>*i), callerid, label, action);
<a name="l01716"></a>01716             <span class="keywordflow">if</span> (score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> || ((action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea413c09377a892aa154e7669cbdaf27ba">E_CANMATCH</a> || action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>) &amp;&amp; score-&gt;<a class="code" href="structscoreboard.html#a0cfb5b2675ee3fe3abfe9b5a7aee6329">canmatch</a>)) {
<a name="l01717"></a>01717                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;return because scoreboard has exact match OR CANMATCH/MATCHMORE &amp; canmatch set--- %s\n&quot;</span>, score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> ? score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a> : <span class="stringliteral">&quot;NULL&quot;</span>);
<a name="l01718"></a>01718                <span class="keywordflow">return</span>; <span class="comment">/* the first match is all we need */</span>
<a name="l01719"></a>01719             }
<a name="l01720"></a>01720          }
<a name="l01721"></a>01721       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[0] == <span class="charliteral">&apos;!&apos;</span> &amp;&amp; p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[1] == 0) {
<a name="l01722"></a>01722          <span class="comment">/* how many chars will the . match against? */</span>
<a name="l01723"></a>01723          <span class="keywordtype">int</span> i = 1;
<a name="l01724"></a>01724          <span class="keyword">const</span> <span class="keywordtype">char</span> *str2 = str;
<a name="l01725"></a>01725          <span class="keywordflow">while</span> (*str2 &amp;&amp; *str2 != <span class="charliteral">&apos;/&apos;</span>) {
<a name="l01726"></a>01726             str2++;
<a name="l01727"></a>01727             i++;
<a name="l01728"></a>01728          }
<a name="l01729"></a>01729          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> &amp;&amp; *str2 != <span class="charliteral">&apos;/&apos;</span>) {
<a name="l01730"></a>01730             <a class="code" href="pbx_8c.html#a04876a5c80405b2f4ee492bbc4777bd4">update_scoreboard</a>(score, length + 1, spec+(p-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a> * i), p-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>, <span class="charliteral">&apos;!&apos;</span>, callerid, p-&gt;<a class="code" href="structmatch__char.html#a3cb0d95aa820737d010fdfaccac92ec3">deleted</a>, p);
<a name="l01731"></a>01731             <span class="keywordflow">if</span> (score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>) {
<a name="l01732"></a>01732                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;return because scoreboard has a &apos;!&apos; match--- %s\n&quot;</span>, score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l01733"></a>01733                <span class="keywordflow">return</span>; <span class="comment">/* the first match is all we need */</span>
<a name="l01734"></a>01734             }
<a name="l01735"></a>01735          }
<a name="l01736"></a>01736          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a> &amp;&amp; p-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[0] == <span class="charliteral">&apos;/&apos;</span> &amp;&amp; p-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[1] == 0) {
<a name="l01737"></a>01737             <a class="code" href="pbx_8c.html#a2c64874adba109557bade6a7cbfd1eea">new_find_extension</a>(<span class="stringliteral">&quot;/&quot;</span>, score, p-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>, length + i, spec + (p-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a> * i), callerid, label, action);
<a name="l01738"></a>01738             <span class="keywordflow">if</span> (score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> || ((action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea413c09377a892aa154e7669cbdaf27ba">E_CANMATCH</a> || action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>) &amp;&amp; score-&gt;<a class="code" href="structscoreboard.html#a0cfb5b2675ee3fe3abfe9b5a7aee6329">canmatch</a>)) {
<a name="l01739"></a>01739                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4,<span class="stringliteral">&quot;return because scoreboard has exact match OR CANMATCH/MATCHMORE &amp; canmatch set with &apos;/&apos; and &apos;!&apos;--- %s\n&quot;</span>, score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> ? score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a> : <span class="stringliteral">&quot;NULL&quot;</span>);
<a name="l01740"></a>01740                <span class="keywordflow">return</span>; <span class="comment">/* the first match is all we need */</span>
<a name="l01741"></a>01741             }
<a name="l01742"></a>01742          }
<a name="l01743"></a>01743       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[0] == <span class="charliteral">&apos;/&apos;</span> &amp;&amp; p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>[1] == 0) {
<a name="l01744"></a>01744          <span class="comment">/* the pattern in the tree includes the cid match! */</span>
<a name="l01745"></a>01745          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a> &amp;&amp; callerid &amp;&amp; *callerid) {
<a name="l01746"></a>01746             <a class="code" href="pbx_8c.html#a2c64874adba109557bade6a7cbfd1eea">new_find_extension</a>(callerid, score, p-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>, length+1, spec, callerid, label, action);
<a name="l01747"></a>01747             <span class="keywordflow">if</span> (score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> || ((action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea413c09377a892aa154e7669cbdaf27ba">E_CANMATCH</a> || action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>) &amp;&amp; score-&gt;<a class="code" href="structscoreboard.html#a0cfb5b2675ee3fe3abfe9b5a7aee6329">canmatch</a>)) {
<a name="l01748"></a>01748                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;return because scoreboard has exact match OR CANMATCH/MATCHMORE &amp; canmatch set with &apos;/&apos;--- %s\n&quot;</span>, score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> ? score-&gt;<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a> : <span class="stringliteral">&quot;NULL&quot;</span>);
<a name="l01749"></a>01749                <span class="keywordflow">return</span>; <span class="comment">/* the first match is all we need */</span>
<a name="l01750"></a>01750             }
<a name="l01751"></a>01751          }
<a name="l01752"></a>01752       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(p-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>, *str)) {
<a name="l01753"></a>01753          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;Nothing strange about this match\n&quot;</span>);
<a name="l01754"></a>01754          <a class="code" href="pbx_8c.html#ae9a20ca55100e97d325d306500dd49bd">NEW_MATCHER_CHK_MATCH</a>;
<a name="l01755"></a>01755          <a class="code" href="pbx_8c.html#a7825b1b6bf1206afac71bc155cff804b">NEW_MATCHER_RECURSE</a>;
<a name="l01756"></a>01756       }
<a name="l01757"></a>01757    }
<a name="l01758"></a>01758    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;return at end of func\n&quot;</span>);
<a name="l01759"></a>01759 }
<a name="l01760"></a>01760 
<a name="l01761"></a>01761 <span class="comment">/* the algorithm for forming the extension pattern tree is also a bit simple; you</span>
<a name="l01762"></a>01762 <span class="comment"> * traverse all the extensions in a context, and for each char of the extension,</span>
<a name="l01763"></a>01763 <span class="comment"> * you see if it exists in the tree; if it doesn&apos;t, you add it at the appropriate</span>
<a name="l01764"></a>01764 <span class="comment"> * spot. What more can I say? At the end of each exten, you cap it off by adding the</span>
<a name="l01765"></a>01765 <span class="comment"> * address of the extension involved. Duplicate patterns will be complained about.</span>
<a name="l01766"></a>01766 <span class="comment"> *</span>
<a name="l01767"></a>01767 <span class="comment"> * Ideally, this would be done for each context after it is created and fully</span>
<a name="l01768"></a>01768 <span class="comment"> * filled. It could be done as a finishing step after extensions.conf or .ael is</span>
<a name="l01769"></a>01769 <span class="comment"> * loaded, or it could be done when the first search is encountered. It should only</span>
<a name="l01770"></a>01770 <span class="comment"> * have to be done once, until the next unload or reload.</span>
<a name="l01771"></a>01771 <span class="comment"> *</span>
<a name="l01772"></a>01772 <span class="comment"> * I guess forming this pattern tree would be analogous to compiling a regex. Except</span>
<a name="l01773"></a>01773 <span class="comment"> * that a regex only handles 1 pattern, really. This trie holds any number</span>
<a name="l01774"></a>01774 <span class="comment"> * of patterns. Well, really, it **could** be considered a single pattern,</span>
<a name="l01775"></a>01775 <span class="comment"> * where the &quot;|&quot; (or) operator is allowed, I guess, in a way, sort of...</span>
<a name="l01776"></a>01776 <span class="comment"> */</span>
<a name="l01777"></a>01777 
<a name="l01778"></a><a class="code" href="pbx_8c.html#af1aa3d895c5e3a802e232e181d2b37d3">01778</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="pbx_8c.html#af1aa3d895c5e3a802e232e181d2b37d3">already_in_tree</a>(<span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *current, <span class="keywordtype">char</span> *pat)
<a name="l01779"></a>01779 {
<a name="l01780"></a>01780    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *t;
<a name="l01781"></a>01781 
<a name="l01782"></a>01782    <span class="keywordflow">if</span> (!current) {
<a name="l01783"></a>01783       <span class="keywordflow">return</span> 0;
<a name="l01784"></a>01784    }
<a name="l01785"></a>01785 
<a name="l01786"></a>01786    <span class="keywordflow">for</span> (t = current; t; t = t-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>) {
<a name="l01787"></a>01787       <span class="keywordflow">if</span> (!strcmp(pat, t-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>)) { <span class="comment">/* uh, we may want to sort exploded [] contents to make matching easy */</span>
<a name="l01788"></a>01788          <span class="keywordflow">return</span> t;
<a name="l01789"></a>01789       }
<a name="l01790"></a>01790    }
<a name="l01791"></a>01791 
<a name="l01792"></a>01792    <span class="keywordflow">return</span> 0;
<a name="l01793"></a>01793 }
<a name="l01794"></a>01794 
<a name="l01795"></a>01795 <span class="comment">/* The first arg is the location of the tree ptr, or the</span>
<a name="l01796"></a>01796 <span class="comment">   address of the next_char ptr in the node, so we can mess</span>
<a name="l01797"></a>01797 <span class="comment">   with it, if we need to insert at the beginning of the list */</span>
<a name="l01798"></a>01798 
<a name="l01799"></a><a class="code" href="pbx_8c.html#af16fde113e4d9557207bb21772312196">01799</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#af16fde113e4d9557207bb21772312196">insert_in_next_chars_alt_char_list</a>(<span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> **parent_ptr, <span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *node)
<a name="l01800"></a>01800 {
<a name="l01801"></a>01801    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *curr, *lcurr;
<a name="l01802"></a>01802 
<a name="l01803"></a>01803    <span class="comment">/* insert node into the tree at &quot;current&quot;, so the alt_char list from current is</span>
<a name="l01804"></a>01804 <span class="comment">      sorted in increasing value as you go to the leaves */</span>
<a name="l01805"></a>01805    <span class="keywordflow">if</span> (!(*parent_ptr)) {
<a name="l01806"></a>01806       *parent_ptr = node;
<a name="l01807"></a>01807    } <span class="keywordflow">else</span> {
<a name="l01808"></a>01808       <span class="keywordflow">if</span> ((*parent_ptr)-&gt;specificity &gt; node-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a>) {
<a name="l01809"></a>01809          <span class="comment">/* insert at head */</span>
<a name="l01810"></a>01810          node-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a> = (*parent_ptr);
<a name="l01811"></a>01811          *parent_ptr = node;
<a name="l01812"></a>01812       } <span class="keywordflow">else</span> {
<a name="l01813"></a>01813          lcurr = *parent_ptr;
<a name="l01814"></a>01814          <span class="keywordflow">for</span> (curr = (*parent_ptr)-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>; curr; curr = curr-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>) {
<a name="l01815"></a>01815             <span class="keywordflow">if</span> (curr-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a> &gt; node-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a>) {
<a name="l01816"></a>01816                node-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a> = curr;
<a name="l01817"></a>01817                lcurr-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a> = node;
<a name="l01818"></a>01818                <span class="keywordflow">break</span>;
<a name="l01819"></a>01819             }
<a name="l01820"></a>01820             lcurr = curr;
<a name="l01821"></a>01821          }
<a name="l01822"></a>01822          <span class="keywordflow">if</span> (!curr) {
<a name="l01823"></a>01823             lcurr-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a> = node;
<a name="l01824"></a>01824          }
<a name="l01825"></a>01825       }
<a name="l01826"></a>01826    }
<a name="l01827"></a>01827 }
<a name="l01828"></a>01828 
<a name="l01829"></a>01829 
<a name="l01830"></a>01830 
<a name="l01831"></a><a class="code" href="pbx_8c.html#a3c23cd74ba6d85ef65661423e173ca08">01831</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="pbx_8c.html#a3c23cd74ba6d85ef65661423e173ca08">add_pattern_node</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *current, <span class="keywordtype">char</span> *pattern, <span class="keywordtype">int</span> <a class="code" href="structmatch__char.html#a67e42f878971513be0d2fa914019a38d">is_pattern</a>, <span class="keywordtype">int</span> already, <span class="keywordtype">int</span> <a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a>, <span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> **nextcharptr)
<a name="l01832"></a>01832 {
<a name="l01833"></a>01833    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *m;
<a name="l01834"></a>01834 
<a name="l01835"></a>01835    <span class="keywordflow">if</span> (!(m = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*m)))) {
<a name="l01836"></a>01836       <span class="keywordflow">return</span> NULL;
<a name="l01837"></a>01837    }
<a name="l01838"></a>01838 
<a name="l01839"></a>01839    <span class="keywordflow">if</span> (!(m-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(pattern))) {
<a name="l01840"></a>01840       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(m);
<a name="l01841"></a>01841       <span class="keywordflow">return</span> NULL;
<a name="l01842"></a>01842    }
<a name="l01843"></a>01843 
<a name="l01844"></a>01844    <span class="comment">/* the specificity scores are the same as used in the old</span>
<a name="l01845"></a>01845 <span class="comment">      pattern matcher. */</span>
<a name="l01846"></a>01846    m-&gt;<a class="code" href="structmatch__char.html#a67e42f878971513be0d2fa914019a38d">is_pattern</a> = is_pattern;
<a name="l01847"></a>01847    <span class="keywordflow">if</span> (specificity == 1 &amp;&amp; is_pattern &amp;&amp; pattern[0] == <span class="charliteral">&apos;N&apos;</span>)
<a name="l01848"></a>01848       m-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a> = 0x0802;
<a name="l01849"></a>01849    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (specificity == 1 &amp;&amp; is_pattern &amp;&amp; pattern[0] == <span class="charliteral">&apos;Z&apos;</span>)
<a name="l01850"></a>01850       m-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a> = 0x0901;
<a name="l01851"></a>01851    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (specificity == 1 &amp;&amp; is_pattern &amp;&amp; pattern[0] == <span class="charliteral">&apos;X&apos;</span>)
<a name="l01852"></a>01852       m-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a> = 0x0a00;
<a name="l01853"></a>01853    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (specificity == 1 &amp;&amp; is_pattern &amp;&amp; pattern[0] == <span class="charliteral">&apos;.&apos;</span>)
<a name="l01854"></a>01854       m-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a> = 0x10000;
<a name="l01855"></a>01855    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (specificity == 1 &amp;&amp; is_pattern &amp;&amp; pattern[0] == <span class="charliteral">&apos;!&apos;</span>)
<a name="l01856"></a>01856       m-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a> = 0x20000;
<a name="l01857"></a>01857    <span class="keywordflow">else</span>
<a name="l01858"></a>01858       m-&gt;<a class="code" href="structmatch__char.html#accb0e073a411e79bf141d0436538373c">specificity</a> = specificity;
<a name="l01859"></a>01859 
<a name="l01860"></a>01860    <span class="keywordflow">if</span> (!con-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>) {
<a name="l01861"></a>01861       <a class="code" href="pbx_8c.html#af16fde113e4d9557207bb21772312196">insert_in_next_chars_alt_char_list</a>(&amp;con-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>, m);
<a name="l01862"></a>01862    } <span class="keywordflow">else</span> {
<a name="l01863"></a>01863       <span class="keywordflow">if</span> (already) { <span class="comment">/* switch to the new regime (traversing vs appending)*/</span>
<a name="l01864"></a>01864          <a class="code" href="pbx_8c.html#af16fde113e4d9557207bb21772312196">insert_in_next_chars_alt_char_list</a>(nextcharptr, m);
<a name="l01865"></a>01865       } <span class="keywordflow">else</span> {
<a name="l01866"></a>01866          <a class="code" href="pbx_8c.html#af16fde113e4d9557207bb21772312196">insert_in_next_chars_alt_char_list</a>(&amp;current-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>, m);
<a name="l01867"></a>01867       }
<a name="l01868"></a>01868    }
<a name="l01869"></a>01869 
<a name="l01870"></a>01870    <span class="keywordflow">return</span> m;
<a name="l01871"></a>01871 }
<a name="l01872"></a>01872 
<a name="l01873"></a><a class="code" href="pbx_8c.html#aa638cd9d03f5d710b6a320ffda6d6392">01873</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="pbx_8c.html#aa638cd9d03f5d710b6a320ffda6d6392">add_exten_to_pattern_tree</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e1, <span class="keywordtype">int</span> findonly)
<a name="l01874"></a>01874 {
<a name="l01875"></a>01875    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="aesopt_8h.html#a112fa29c92065d6624349eb69f35f0fb">m1</a> = NULL, *<a class="code" href="aesopt_8h.html#a097873c534253aa2dfaf9612d377f499">m2</a> = NULL, **m0;
<a name="l01876"></a>01876    <span class="keywordtype">int</span> specif;
<a name="l01877"></a>01877    <span class="keywordtype">int</span> already;
<a name="l01878"></a>01878    <span class="keywordtype">int</span> pattern = 0;
<a name="l01879"></a>01879    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256];
<a name="l01880"></a>01880    <span class="keywordtype">char</span> extenbuf[512];
<a name="l01881"></a>01881    <span class="keywordtype">char</span> *s1 = extenbuf;
<a name="l01882"></a>01882    <span class="keywordtype">int</span> l1 = strlen(e1-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>) + strlen(e1-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>) + 2;
<a name="l01883"></a>01883 
<a name="l01884"></a>01884 
<a name="l01885"></a>01885    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(extenbuf, e1-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, <span class="keyword">sizeof</span>(extenbuf));
<a name="l01886"></a>01886 
<a name="l01887"></a>01887    <span class="keywordflow">if</span> (e1-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> &amp;&amp;  l1 &lt;= <span class="keyword">sizeof</span>(extenbuf)) {
<a name="l01888"></a>01888       strcat(extenbuf, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l01889"></a>01889       strcat(extenbuf, e1-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>);
<a name="l01890"></a>01890    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l1 &gt; <span class="keyword">sizeof</span>(extenbuf)) {
<a name="l01891"></a>01891       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;The pattern %s/%s is too big to deal with: it will be ignored! Disaster!\n&quot;</span>, e1-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, e1-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>);
<a name="l01892"></a>01892       <span class="keywordflow">return</span> 0;
<a name="l01893"></a>01893    }
<a name="l01894"></a>01894 <span class="preprocessor">#ifdef NEED_DEBUG</span>
<a name="l01895"></a>01895 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Adding exten %s%c%s to tree\n&quot;</span>, s1, e1-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> ? <span class="charliteral">&apos;/&apos;</span> : <span class="charliteral">&apos; &apos;</span>, e1-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> ? e1-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l01896"></a>01896 <span class="preprocessor">#endif</span>
<a name="l01897"></a>01897 <span class="preprocessor"></span>   m1 = con-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>; <span class="comment">/* each pattern starts over at the root of the pattern tree */</span>
<a name="l01898"></a>01898    m0 = &amp;con-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>;
<a name="l01899"></a>01899    already = 1;
<a name="l01900"></a>01900 
<a name="l01901"></a>01901    <span class="keywordflow">if</span> ( *s1 == <span class="charliteral">&apos;_&apos;</span>) {
<a name="l01902"></a>01902       pattern = 1;
<a name="l01903"></a>01903       s1++;
<a name="l01904"></a>01904    }
<a name="l01905"></a>01905    <span class="keywordflow">while</span>( *s1 ) {
<a name="l01906"></a>01906       <span class="keywordflow">if</span> (pattern &amp;&amp; *s1 == <span class="charliteral">&apos;[&apos;</span> &amp;&amp; *(s1-1) != <span class="charliteral">&apos;\\&apos;</span>) {
<a name="l01907"></a>01907          <span class="keywordtype">char</span> *s2 = buf;
<a name="l01908"></a>01908          buf[0] = 0;
<a name="l01909"></a>01909          s1++; <span class="comment">/* get past the &apos;[&apos; */</span>
<a name="l01910"></a>01910          <span class="keywordflow">while</span> (*s1 != <span class="charliteral">&apos;]&apos;</span> &amp;&amp; *(s1 - 1) != <span class="charliteral">&apos;\\&apos;</span> ) {
<a name="l01911"></a>01911             <span class="keywordflow">if</span> (*s1 == <span class="charliteral">&apos;\\&apos;</span>) {
<a name="l01912"></a>01912                <span class="keywordflow">if</span> (*(s1 + 1) == <span class="charliteral">&apos;]&apos;</span>) {
<a name="l01913"></a>01913                   *s2++ = <span class="charliteral">&apos;]&apos;</span>;
<a name="l01914"></a>01914                   s1++; s1++;
<a name="l01915"></a>01915                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(s1 + 1) == <span class="charliteral">&apos;\\&apos;</span>) {
<a name="l01916"></a>01916                   *s2++ = <span class="charliteral">&apos;\\&apos;</span>;
<a name="l01917"></a>01917                   s1++; s1++;
<a name="l01918"></a>01918                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(s1 + 1) == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l01919"></a>01919                   *s2++ = <span class="charliteral">&apos;-&apos;</span>;
<a name="l01920"></a>01920                   s1++; s1++;
<a name="l01921"></a>01921                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(s1 + 1) == <span class="charliteral">&apos;[&apos;</span>) {
<a name="l01922"></a>01922                   *s2++ = <span class="charliteral">&apos;[&apos;</span>;
<a name="l01923"></a>01923                   s1++; s1++;
<a name="l01924"></a>01924                }
<a name="l01925"></a>01925             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s1 == <span class="charliteral">&apos;-&apos;</span>) { <span class="comment">/* remember to add some error checking to all this! */</span>
<a name="l01926"></a>01926                <span class="keywordtype">char</span> s3 = *(s1 - 1);
<a name="l01927"></a>01927                <span class="keywordtype">char</span> s4 = *(s1 + 1);
<a name="l01928"></a>01928                <span class="keywordflow">for</span> (s3++; s3 &lt;= s4; s3++) {
<a name="l01929"></a>01929                   *s2++ = s3;
<a name="l01930"></a>01930                }
<a name="l01931"></a>01931                s1++; s1++;
<a name="l01932"></a>01932             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s1 == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01933"></a>01933                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;A matching &apos;]&apos; was not found for &apos;[&apos; in pattern string &apos;%s&apos;\n&quot;</span>, extenbuf);
<a name="l01934"></a>01934                <span class="keywordflow">break</span>;
<a name="l01935"></a>01935             } <span class="keywordflow">else</span> {
<a name="l01936"></a>01936                *s2++ = *s1++;
<a name="l01937"></a>01937             }
<a name="l01938"></a>01938          }
<a name="l01939"></a>01939          *s2 = 0; <span class="comment">/* null terminate the exploded range */</span>
<a name="l01940"></a>01940          <span class="comment">/* sort the characters */</span>
<a name="l01941"></a>01941 
<a name="l01942"></a>01942          specif = strlen(buf);
<a name="l01943"></a>01943          qsort(buf, specif, 1, <a class="code" href="pbx_8c.html#a64ec6367a27dcdeb7ce0b7b614a2cc44">compare_char</a>);
<a name="l01944"></a>01944          specif &lt;&lt;= 8;
<a name="l01945"></a>01945          specif += buf[0];
<a name="l01946"></a>01946       } <span class="keywordflow">else</span> {
<a name="l01947"></a>01947 
<a name="l01948"></a>01948          <span class="keywordflow">if</span> (*s1 == <span class="charliteral">&apos;\\&apos;</span>) {
<a name="l01949"></a>01949             s1++;
<a name="l01950"></a>01950             buf[0] = *s1;
<a name="l01951"></a>01951          } <span class="keywordflow">else</span> {
<a name="l01952"></a>01952             <span class="keywordflow">if</span> (pattern) {
<a name="l01953"></a>01953                <span class="keywordflow">if</span> (*s1 == <span class="charliteral">&apos;n&apos;</span>) <span class="comment">/* make sure n,x,z patterns are canonicalized to N,X,Z */</span>
<a name="l01954"></a>01954                   *s1 = <span class="charliteral">&apos;N&apos;</span>;
<a name="l01955"></a>01955                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s1 == <span class="charliteral">&apos;x&apos;</span>)
<a name="l01956"></a>01956                   *s1 = <span class="charliteral">&apos;X&apos;</span>;
<a name="l01957"></a>01957                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s1 == <span class="charliteral">&apos;z&apos;</span>)
<a name="l01958"></a>01958                   *s1 = <span class="charliteral">&apos;Z&apos;</span>;
<a name="l01959"></a>01959             }
<a name="l01960"></a>01960             buf[0] = *s1;
<a name="l01961"></a>01961          }
<a name="l01962"></a>01962          buf[1] = 0;
<a name="l01963"></a>01963          specif = 1;
<a name="l01964"></a>01964       }
<a name="l01965"></a>01965       m2 = 0;
<a name="l01966"></a>01966       <span class="keywordflow">if</span> (already &amp;&amp; (m2 = <a class="code" href="pbx_8c.html#af1aa3d895c5e3a802e232e181d2b37d3">already_in_tree</a>(m1,buf)) &amp;&amp; m2-&gt;next_char) {
<a name="l01967"></a>01967          <span class="keywordflow">if</span> (!(*(s1 + 1))) {  <span class="comment">/* if this is the end of the pattern, but not the end of the tree, then mark this node with the exten...</span>
<a name="l01968"></a>01968 <span class="comment">                          * a shorter pattern might win if the longer one doesn&apos;t match */</span>
<a name="l01969"></a>01969             m2-&gt;exten = e1;
<a name="l01970"></a>01970             m2-&gt;deleted = 0;
<a name="l01971"></a>01971          }
<a name="l01972"></a>01972          m1 = m2-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>; <span class="comment">/* m1 points to the node to compare against */</span>
<a name="l01973"></a>01973          m0 = &amp;m2-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>; <span class="comment">/* m0 points to the ptr that points to m1 */</span>
<a name="l01974"></a>01974       } <span class="keywordflow">else</span> { <span class="comment">/* not already OR not m2 OR nor m2-&gt;next_char */</span>
<a name="l01975"></a>01975          <span class="keywordflow">if</span> (m2) {
<a name="l01976"></a>01976             <span class="keywordflow">if</span> (findonly) {
<a name="l01977"></a>01977                <span class="keywordflow">return</span> m2;
<a name="l01978"></a>01978             }
<a name="l01979"></a>01979             m1 = m2; <span class="comment">/* while m0 stays the same */</span>
<a name="l01980"></a>01980          } <span class="keywordflow">else</span> {
<a name="l01981"></a>01981             <span class="keywordflow">if</span> (findonly) {
<a name="l01982"></a>01982                <span class="keywordflow">return</span> m1;
<a name="l01983"></a>01983             }
<a name="l01984"></a>01984             m1 = <a class="code" href="pbx_8c.html#a3c23cd74ba6d85ef65661423e173ca08">add_pattern_node</a>(con, m1, buf, pattern, already,specif, m0); <span class="comment">/* m1 is the node just added */</span>
<a name="l01985"></a>01985             m0 = &amp;m1-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>;
<a name="l01986"></a>01986          }
<a name="l01987"></a>01987 
<a name="l01988"></a>01988          <span class="keywordflow">if</span> (!(*(s1 + 1))) {
<a name="l01989"></a>01989             m1-&gt;<a class="code" href="structmatch__char.html#a3cb0d95aa820737d010fdfaccac92ec3">deleted</a> = 0;
<a name="l01990"></a>01990             m1-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> = e1;
<a name="l01991"></a>01991          }
<a name="l01992"></a>01992 
<a name="l01993"></a>01993          already = 0;
<a name="l01994"></a>01994       }
<a name="l01995"></a>01995       s1++; <span class="comment">/* advance to next char */</span>
<a name="l01996"></a>01996    }
<a name="l01997"></a>01997    <span class="keywordflow">return</span> m1;
<a name="l01998"></a>01998 }
<a name="l01999"></a>01999 
<a name="l02000"></a><a class="code" href="pbx_8c.html#a705ac1563ea8e4c1e3f369e6ad952fda">02000</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a705ac1563ea8e4c1e3f369e6ad952fda">create_match_char_tree</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con)
<a name="l02001"></a>02001 {
<a name="l02002"></a>02002    <span class="keyword">struct </span><a class="code" href="structast__hashtab__iter.html" title="an iterator for traversing the buckets">ast_hashtab_iter</a> *t1;
<a name="l02003"></a>02003    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e1;
<a name="l02004"></a>02004 <span class="preprocessor">#ifdef NEED_DEBUG</span>
<a name="l02005"></a>02005 <span class="preprocessor"></span>   <span class="keywordtype">int</span> biggest_bucket, resizes, numobjs, numbucks;
<a name="l02006"></a>02006 
<a name="l02007"></a>02007    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>,<span class="stringliteral">&quot;Creating Extension Trie for context %s\n&quot;</span>, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l02008"></a>02008    <a class="code" href="hashtab_8h.html#ae52333d2a29053dce852f8a2d35ca421" title="Returns key stats for the table.">ast_hashtab_get_stats</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, &amp;biggest_bucket, &amp;resizes, &amp;numobjs, &amp;numbucks);
<a name="l02009"></a>02009    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>,<span class="stringliteral">&quot;This tree has %d objects in %d bucket lists, longest list=%d objects, and has resized %d times\n&quot;</span>,
<a name="l02010"></a>02010          numobjs, numbucks, biggest_bucket, resizes);
<a name="l02011"></a>02011 <span class="preprocessor">#endif</span>
<a name="l02012"></a>02012 <span class="preprocessor"></span>   t1 = <a class="code" href="hashtab_8h.html#ac5a19bffadbbd4eb31f190e576f88512" title="Gives an iterator to hastable.">ast_hashtab_start_traversal</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>);
<a name="l02013"></a>02013    <span class="keywordflow">while</span> ((e1 = <a class="code" href="hashtab_8h.html#a43983b6169e9a0f9af48cca5cf9d3197" title="Gets the next object in the list, advances iter one step returns null on end of traversal...">ast_hashtab_next</a>(t1))) {
<a name="l02014"></a>02014       <span class="keywordflow">if</span> (e1-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>) {
<a name="l02015"></a>02015          <a class="code" href="pbx_8c.html#aa638cd9d03f5d710b6a320ffda6d6392">add_exten_to_pattern_tree</a>(con, e1, 0);
<a name="l02016"></a>02016       } <span class="keywordflow">else</span> {
<a name="l02017"></a>02017          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Attempt to create extension with no extension name.\n&quot;</span>);
<a name="l02018"></a>02018       }
<a name="l02019"></a>02019    }
<a name="l02020"></a>02020    <a class="code" href="hashtab_8h.html#a9c804e9bfc8355c25197187f0c6d0265" title="end the traversal, free the iterator, unlock if necc.">ast_hashtab_end_traversal</a>(t1);
<a name="l02021"></a>02021 }
<a name="l02022"></a>02022 
<a name="l02023"></a><a class="code" href="pbx_8c.html#a3900cc7c8183ab6a7316f5dbc2b955ed">02023</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a3900cc7c8183ab6a7316f5dbc2b955ed">destroy_pattern_tree</a>(<span class="keyword">struct</span> <a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *pattern_tree) <span class="comment">/* pattern tree is a simple binary tree, sort of, so the proper way to destroy it is... recursively! */</span>
<a name="l02024"></a>02024 {
<a name="l02025"></a>02025    <span class="comment">/* destroy all the alternates */</span>
<a name="l02026"></a>02026    <span class="keywordflow">if</span> (pattern_tree-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>) {
<a name="l02027"></a>02027       <a class="code" href="pbx_8c.html#a3900cc7c8183ab6a7316f5dbc2b955ed">destroy_pattern_tree</a>(pattern_tree-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a>);
<a name="l02028"></a>02028       pattern_tree-&gt;<a class="code" href="structmatch__char.html#ac603db225d03f7ba125a0e2af1a37130">alt_char</a> = 0;
<a name="l02029"></a>02029    }
<a name="l02030"></a>02030    <span class="comment">/* destroy all the nexts */</span>
<a name="l02031"></a>02031    <span class="keywordflow">if</span> (pattern_tree-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>) {
<a name="l02032"></a>02032       <a class="code" href="pbx_8c.html#a3900cc7c8183ab6a7316f5dbc2b955ed">destroy_pattern_tree</a>(pattern_tree-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a>);
<a name="l02033"></a>02033       pattern_tree-&gt;<a class="code" href="structmatch__char.html#ae2f869d85ce6930805f0aa8ff9a928c9">next_char</a> = 0;
<a name="l02034"></a>02034    }
<a name="l02035"></a>02035    pattern_tree-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> = 0; <span class="comment">/* never hurts to make sure there&apos;s no pointers laying around */</span>
<a name="l02036"></a>02036    <span class="keywordflow">if</span> (pattern_tree-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>) {
<a name="l02037"></a>02037       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(pattern_tree-&gt;<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a>);
<a name="l02038"></a>02038    }
<a name="l02039"></a>02039    <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(pattern_tree);
<a name="l02040"></a>02040 }
<a name="l02041"></a>02041 
<a name="l02042"></a>02042 <span class="comment">/*</span>
<a name="l02043"></a>02043 <span class="comment"> * Special characters used in patterns:</span>
<a name="l02044"></a>02044 <span class="comment"> * &apos;_&apos;   underscore is the leading character of a pattern.</span>
<a name="l02045"></a>02045 <span class="comment"> *    In other position it is treated as a regular char.</span>
<a name="l02046"></a>02046 <span class="comment"> * .  one or more of any character. Only allowed at the end of</span>
<a name="l02047"></a>02047 <span class="comment"> *    a pattern.</span>
<a name="l02048"></a>02048 <span class="comment"> * !  zero or more of anything. Also impacts the result of CANMATCH</span>
<a name="l02049"></a>02049 <span class="comment"> *    and MATCHMORE. Only allowed at the end of a pattern.</span>
<a name="l02050"></a>02050 <span class="comment"> *    In the core routine, ! causes a match with a return code of 2.</span>
<a name="l02051"></a>02051 <span class="comment"> *    In turn, depending on the search mode: (XXX check if it is implemented)</span>
<a name="l02052"></a>02052 <span class="comment"> *    - E_MATCH retuns 1 (does match)</span>
<a name="l02053"></a>02053 <span class="comment"> *    - E_MATCHMORE returns 0 (no match)</span>
<a name="l02054"></a>02054 <span class="comment"> *    - E_CANMATCH returns 1 (does match)</span>
<a name="l02055"></a>02055 <span class="comment"> *</span>
<a name="l02056"></a>02056 <span class="comment"> * /  should not appear as it is considered the separator of the CID info.</span>
<a name="l02057"></a>02057 <span class="comment"> *    XXX at the moment we may stop on this char.</span>
<a name="l02058"></a>02058 <span class="comment"> *</span>
<a name="l02059"></a>02059 <span class="comment"> * X Z N match ranges 0-9, 1-9, 2-9 respectively.</span>
<a name="l02060"></a>02060 <span class="comment"> * [  denotes the start of a set of character. Everything inside</span>
<a name="l02061"></a>02061 <span class="comment"> *    is considered literally. We can have ranges a-d and individual</span>
<a name="l02062"></a>02062 <span class="comment"> *    characters. A &apos;[&apos; and &apos;-&apos; can be considered literally if they</span>
<a name="l02063"></a>02063 <span class="comment"> *    are just before &apos;]&apos;.</span>
<a name="l02064"></a>02064 <span class="comment"> *    XXX currently there is no way to specify &apos;]&apos; in a range, nor \ is</span>
<a name="l02065"></a>02065 <span class="comment"> *    considered specially.</span>
<a name="l02066"></a>02066 <span class="comment"> *</span>
<a name="l02067"></a>02067 <span class="comment"> * When we compare a pattern with a specific extension, all characters in the extension</span>
<a name="l02068"></a>02068 <span class="comment"> * itself are considered literally.</span>
<a name="l02069"></a>02069 <span class="comment"> * XXX do we want to consider space as a separator as well ?</span>
<a name="l02070"></a>02070 <span class="comment"> * XXX do we want to consider the separators in non-patterns as well ?</span>
<a name="l02071"></a>02071 <span class="comment"> */</span>
<a name="l02072"></a>02072 <span class="comment"></span>
<a name="l02073"></a>02073 <span class="comment">/*!</span>
<a name="l02074"></a>02074 <span class="comment"> * \brief helper functions to sort extensions and patterns in the desired way,</span>
<a name="l02075"></a>02075 <span class="comment"> * so that more specific patterns appear first.</span>
<a name="l02076"></a>02076 <span class="comment"> *</span>
<a name="l02077"></a>02077 <span class="comment"> * ext_cmp1 compares individual characters (or sets of), returning</span>
<a name="l02078"></a>02078 <span class="comment"> * an int where bits 0-7 are the ASCII code of the first char in the set,</span>
<a name="l02079"></a>02079 <span class="comment"> * while bit 8-15 are the cardinality of the set minus 1.</span>
<a name="l02080"></a>02080 <span class="comment"> * This way more specific patterns (smaller cardinality) appear first.</span>
<a name="l02081"></a>02081 <span class="comment"> * Wildcards have a special value, so that we can directly compare them to</span>
<a name="l02082"></a>02082 <span class="comment"> * sets by subtracting the two values. In particular:</span>
<a name="l02083"></a>02083 <span class="comment"> *  0x000xx    one character, xx</span>
<a name="l02084"></a>02084 <span class="comment"> *  0x0yyxx    yy character set starting with xx</span>
<a name="l02085"></a>02085 <span class="comment"> *  0x10000    &apos;.&apos; (one or more of anything)</span>
<a name="l02086"></a>02086 <span class="comment"> *  0x20000    &apos;!&apos; (zero or more of anything)</span>
<a name="l02087"></a>02087 <span class="comment"> *  0x30000    NUL (end of string)</span>
<a name="l02088"></a>02088 <span class="comment"> *  0x40000    error in set.</span>
<a name="l02089"></a>02089 <span class="comment"> * The pointer to the string is advanced according to needs.</span>
<a name="l02090"></a>02090 <span class="comment"> * NOTES:</span>
<a name="l02091"></a>02091 <span class="comment"> * 1. the empty set is equivalent to NUL.</span>
<a name="l02092"></a>02092 <span class="comment"> * 2. given that a full set has always 0 as the first element,</span>
<a name="l02093"></a>02093 <span class="comment"> *    we could encode the special cases as 0xffXX where XX</span>
<a name="l02094"></a>02094 <span class="comment"> *    is 1, 2, 3, 4 as used above.</span>
<a name="l02095"></a>02095 <span class="comment"> */</span>
<a name="l02096"></a><a class="code" href="pbx_8c.html#a3cead23d6726af243aed9f68f38b7a32">02096</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a3cead23d6726af243aed9f68f38b7a32" title="helper functions to sort extensions and patterns in the desired way, so that more...">ext_cmp1</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> **p, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *bitwise)
<a name="l02097"></a>02097 {
<a name="l02098"></a>02098    <span class="keywordtype">int</span> c, cmin = 0xff, count = 0;
<a name="l02099"></a>02099    <span class="keyword">const</span> <span class="keywordtype">char</span> *end;
<a name="l02100"></a>02100 
<a name="l02101"></a>02101    <span class="comment">/* load value and advance pointer */</span>
<a name="l02102"></a>02102    c = *(*p)++;
<a name="l02103"></a>02103 
<a name="l02104"></a>02104    <span class="comment">/* always return unless we have a set of chars */</span>
<a name="l02105"></a>02105    <span class="keywordflow">switch</span> (toupper(c)) {
<a name="l02106"></a>02106    <span class="keywordflow">default</span>: <span class="comment">/* ordinary character */</span>
<a name="l02107"></a>02107       bitwise[c / 8] = 1 &lt;&lt; (c % 8);
<a name="l02108"></a>02108       <span class="keywordflow">return</span> 0x0100 | (c &amp; 0xff);
<a name="l02109"></a>02109 
<a name="l02110"></a>02110    <span class="keywordflow">case</span> <span class="charliteral">&apos;N&apos;</span>:   <span class="comment">/* 2..9 */</span>
<a name="l02111"></a>02111       bitwise[6] = 0xfc;
<a name="l02112"></a>02112       bitwise[7] = 0x03;
<a name="l02113"></a>02113       <span class="keywordflow">return</span> 0x0800 | <span class="charliteral">&apos;2&apos;</span>;
<a name="l02114"></a>02114 
<a name="l02115"></a>02115    <span class="keywordflow">case</span> <span class="charliteral">&apos;X&apos;</span>:   <span class="comment">/* 0..9 */</span>
<a name="l02116"></a>02116       bitwise[6] = 0xff;
<a name="l02117"></a>02117       bitwise[7] = 0x03;
<a name="l02118"></a>02118       <span class="keywordflow">return</span> 0x0A00 | <span class="charliteral">&apos;0&apos;</span>;
<a name="l02119"></a>02119 
<a name="l02120"></a>02120    <span class="keywordflow">case</span> <span class="charliteral">&apos;Z&apos;</span>:   <span class="comment">/* 1..9 */</span>
<a name="l02121"></a>02121       bitwise[6] = 0xfe;
<a name="l02122"></a>02122       bitwise[7] = 0x03;
<a name="l02123"></a>02123       <span class="keywordflow">return</span> 0x0900 | <span class="charliteral">&apos;1&apos;</span>;
<a name="l02124"></a>02124 
<a name="l02125"></a>02125    <span class="keywordflow">case</span> <span class="charliteral">&apos;.&apos;</span>:   <span class="comment">/* wildcard */</span>
<a name="l02126"></a>02126       <span class="keywordflow">return</span> 0x10000;
<a name="l02127"></a>02127 
<a name="l02128"></a>02128    <span class="keywordflow">case</span> <span class="charliteral">&apos;!&apos;</span>:   <span class="comment">/* earlymatch */</span>
<a name="l02129"></a>02129       <span class="keywordflow">return</span> 0x20000;   <span class="comment">/* less specific than NULL */</span>
<a name="l02130"></a>02130 
<a name="l02131"></a>02131    <span class="keywordflow">case</span> <span class="charliteral">&apos;\0&apos;</span>:  <span class="comment">/* empty string */</span>
<a name="l02132"></a>02132       *p = NULL;
<a name="l02133"></a>02133       <span class="keywordflow">return</span> 0x30000;
<a name="l02134"></a>02134 
<a name="l02135"></a>02135    <span class="keywordflow">case</span> <span class="charliteral">&apos;[&apos;</span>:   <span class="comment">/* pattern */</span>
<a name="l02136"></a>02136       <span class="keywordflow">break</span>;
<a name="l02137"></a>02137    }
<a name="l02138"></a>02138    <span class="comment">/* locate end of set */</span>
<a name="l02139"></a>02139    end = strchr(*p, <span class="charliteral">&apos;]&apos;</span>);
<a name="l02140"></a>02140 
<a name="l02141"></a>02141    <span class="keywordflow">if</span> (end == NULL) {
<a name="l02142"></a>02142       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Wrong usage of [] in the extension\n&quot;</span>);
<a name="l02143"></a>02143       <span class="keywordflow">return</span> 0x40000;   <span class="comment">/* XXX make this entry go last... */</span>
<a name="l02144"></a>02144    }
<a name="l02145"></a>02145 
<a name="l02146"></a>02146    <span class="keywordflow">for</span> (; *p &lt; end  ; (*p)++) {
<a name="l02147"></a>02147       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c1, c2;   <span class="comment">/* first-last char in range */</span>
<a name="l02148"></a>02148       c1 = (<span class="keywordtype">unsigned</span> char)((*p)[0]);
<a name="l02149"></a>02149       <span class="keywordflow">if</span> (*p + 2 &lt; end &amp;&amp; (*p)[1] == <span class="charliteral">&apos;-&apos;</span>) { <span class="comment">/* this is a range */</span>
<a name="l02150"></a>02150          c2 = (<span class="keywordtype">unsigned</span> char)((*p)[2]);
<a name="l02151"></a>02151          *p += 2;    <span class="comment">/* skip a total of 3 chars */</span>
<a name="l02152"></a>02152       } <span class="keywordflow">else</span> {        <span class="comment">/* individual character */</span>
<a name="l02153"></a>02153          c2 = c1;
<a name="l02154"></a>02154       }
<a name="l02155"></a>02155       <span class="keywordflow">if</span> (c1 &lt; cmin) {
<a name="l02156"></a>02156          cmin = c1;
<a name="l02157"></a>02157       }
<a name="l02158"></a>02158       <span class="keywordflow">for</span> (; c1 &lt;= c2; c1++) {
<a name="l02159"></a>02159          <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> mask = 1 &lt;&lt; (c1 % 8);<span class="comment"></span>
<a name="l02160"></a>02160 <span class="comment">         /*!\note If two patterns score the same, the one with the lowest</span>
<a name="l02161"></a>02161 <span class="comment">          * ascii values will compare as coming first. */</span>
<a name="l02162"></a>02162          <span class="comment">/* Flag the character as included (used) and count it. */</span>
<a name="l02163"></a>02163          <span class="keywordflow">if</span> (!(bitwise[ c1 / 8 ] &amp; mask)) {
<a name="l02164"></a>02164             bitwise[ c1 / 8 ] |= mask;
<a name="l02165"></a>02165             count += 0x100;
<a name="l02166"></a>02166          }
<a name="l02167"></a>02167       }
<a name="l02168"></a>02168    }
<a name="l02169"></a>02169    (*p)++;
<a name="l02170"></a>02170    <span class="keywordflow">return</span> count == 0 ? 0x30000 : (count | cmin);
<a name="l02171"></a>02171 }
<a name="l02172"></a>02172 <span class="comment"></span>
<a name="l02173"></a>02173 <span class="comment">/*!</span>
<a name="l02174"></a>02174 <span class="comment"> * \brief the full routine to compare extensions in rules.</span>
<a name="l02175"></a>02175 <span class="comment"> */</span>
<a name="l02176"></a><a class="code" href="pbx_8c.html#a12793cf64a2e55f7b94646b9c8fb2f5d">02176</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a12793cf64a2e55f7b94646b9c8fb2f5d" title="the full routine to compare extensions in rules.">ext_cmp</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *a, <span class="keyword">const</span> <span class="keywordtype">char</span> *b)
<a name="l02177"></a>02177 {
<a name="l02178"></a>02178    <span class="comment">/* make sure non-patterns come first.</span>
<a name="l02179"></a>02179 <span class="comment">    * If a is not a pattern, it either comes first or</span>
<a name="l02180"></a>02180 <span class="comment">    * we do a more complex pattern comparison.</span>
<a name="l02181"></a>02181 <span class="comment">    */</span>
<a name="l02182"></a>02182    <span class="keywordtype">int</span> ret = 0;
<a name="l02183"></a>02183 
<a name="l02184"></a>02184    <span class="keywordflow">if</span> (a[0] != <span class="charliteral">&apos;_&apos;</span>)
<a name="l02185"></a>02185       <span class="keywordflow">return</span> (b[0] == <span class="charliteral">&apos;_&apos;</span>) ? -1 : strcmp(a, b);
<a name="l02186"></a>02186 
<a name="l02187"></a>02187    <span class="comment">/* Now we know a is a pattern; if b is not, a comes first */</span>
<a name="l02188"></a>02188    <span class="keywordflow">if</span> (b[0] != <span class="charliteral">&apos;_&apos;</span>)
<a name="l02189"></a>02189       <span class="keywordflow">return</span> 1;
<a name="l02190"></a>02190 
<a name="l02191"></a>02191    <span class="comment">/* ok we need full pattern sorting routine.</span>
<a name="l02192"></a>02192 <span class="comment">    * skip past the underscores */</span>
<a name="l02193"></a>02193    ++a; ++b;
<a name="l02194"></a>02194    <span class="keywordflow">do</span> {
<a name="l02195"></a>02195       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> bitwise[2][32] = { { 0, } };
<a name="l02196"></a>02196       ret = <a class="code" href="pbx_8c.html#a3cead23d6726af243aed9f68f38b7a32" title="helper functions to sort extensions and patterns in the desired way, so that more...">ext_cmp1</a>(&amp;a, bitwise[0]) - <a class="code" href="pbx_8c.html#a3cead23d6726af243aed9f68f38b7a32" title="helper functions to sort extensions and patterns in the desired way, so that more...">ext_cmp1</a>(&amp;b, bitwise[1]);
<a name="l02197"></a>02197       <span class="keywordflow">if</span> (ret == 0) {
<a name="l02198"></a>02198          <span class="comment">/* Are the classes different, even though they score the same? */</span>
<a name="l02199"></a>02199          ret = memcmp(bitwise[0], bitwise[1], 32);
<a name="l02200"></a>02200       }
<a name="l02201"></a>02201    } <span class="keywordflow">while</span> (!ret &amp;&amp; a &amp;&amp; b);
<a name="l02202"></a>02202    <span class="keywordflow">if</span> (ret == 0) {
<a name="l02203"></a>02203       <span class="keywordflow">return</span> 0;
<a name="l02204"></a>02204    } <span class="keywordflow">else</span> {
<a name="l02205"></a>02205       <span class="keywordflow">return</span> (ret &gt; 0) ? 1 : -1;
<a name="l02206"></a>02206    }
<a name="l02207"></a>02207 }
<a name="l02208"></a>02208 
<a name="l02209"></a><a class="code" href="pbx_8c.html#aa9130cb982e3e236c465136e0637cfaa">02209</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aa9130cb982e3e236c465136e0637cfaa" title="Determine if one extension should match before another.">ast_extension_cmp</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *a, <span class="keyword">const</span> <span class="keywordtype">char</span> *b)
<a name="l02210"></a>02210 {
<a name="l02211"></a>02211    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#a12793cf64a2e55f7b94646b9c8fb2f5d" title="the full routine to compare extensions in rules.">ext_cmp</a>(a, b);
<a name="l02212"></a>02212 }
<a name="l02213"></a>02213 <span class="comment"></span>
<a name="l02214"></a>02214 <span class="comment">/*!</span>
<a name="l02215"></a>02215 <span class="comment"> * \internal</span>
<a name="l02216"></a>02216 <span class="comment"> * \brief used ast_extension_{match|close}</span>
<a name="l02217"></a>02217 <span class="comment"> * mode is as follows:</span>
<a name="l02218"></a>02218 <span class="comment"> * E_MATCH     success only on exact match</span>
<a name="l02219"></a>02219 <span class="comment"> * E_MATCHMORE success only on partial match (i.e. leftover digits in pattern)</span>
<a name="l02220"></a>02220 <span class="comment"> * E_CANMATCH  either of the above.</span>
<a name="l02221"></a>02221 <span class="comment"> * \retval 0 on no-match</span>
<a name="l02222"></a>02222 <span class="comment"> * \retval 1 on match</span>
<a name="l02223"></a>02223 <span class="comment"> * \retval 2 on early match.</span>
<a name="l02224"></a>02224 <span class="comment"> */</span>
<a name="l02225"></a>02225 
<a name="l02226"></a><a class="code" href="pbx_8c.html#aad00874b99ffc028615d6bfe93ae5496">02226</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#aad00874b99ffc028615d6bfe93ae5496">_extension_match_core</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *pattern, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keyword">enum</span> <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26be">ext_match_t</a> mode)
<a name="l02227"></a>02227 {
<a name="l02228"></a>02228    mode &amp;= <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea108ea5cb21cb0de3a1be976972c0a59c">E_MATCH_MASK</a>;   <span class="comment">/* only consider the relevant bits */</span>
<a name="l02229"></a>02229 
<a name="l02230"></a>02230 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02231"></a>02231 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;match core: pat: &apos;%s&apos;, dat: &apos;%s&apos;, mode=%d\n&quot;</span>, pattern, data, (<span class="keywordtype">int</span>)mode);
<a name="l02232"></a>02232 <span class="preprocessor">#endif</span>
<a name="l02233"></a>02233 <span class="preprocessor"></span>
<a name="l02234"></a>02234    <span class="keywordflow">if</span> ( (mode == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea2e605157e82dec388ffc89c1694fb7be">E_MATCH</a>) &amp;&amp; (pattern[0] == <span class="charliteral">&apos;_&apos;</span>) &amp;&amp; (!strcasecmp(pattern,data)) ) { <span class="comment">/* note: if this test is left out, then _x. will not match _x. !!! */</span>
<a name="l02235"></a>02235 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02236"></a>02236 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;return (1) - pattern matches pattern\n&quot;</span>);
<a name="l02237"></a>02237 <span class="preprocessor">#endif</span>
<a name="l02238"></a>02238 <span class="preprocessor"></span>      <span class="keywordflow">return</span> 1;
<a name="l02239"></a>02239    }
<a name="l02240"></a>02240 
<a name="l02241"></a>02241    <span class="keywordflow">if</span> (pattern[0] != <span class="charliteral">&apos;_&apos;</span>) { <span class="comment">/* not a pattern, try exact or partial match */</span>
<a name="l02242"></a>02242       <span class="keywordtype">int</span> ld = strlen(data), lp = strlen(pattern);
<a name="l02243"></a>02243 
<a name="l02244"></a>02244       <span class="keywordflow">if</span> (lp &lt; ld) {    <span class="comment">/* pattern too short, cannot match */</span>
<a name="l02245"></a>02245 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02246"></a>02246 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;return (0) - pattern too short, cannot match\n&quot;</span>);
<a name="l02247"></a>02247 <span class="preprocessor">#endif</span>
<a name="l02248"></a>02248 <span class="preprocessor"></span>         <span class="keywordflow">return</span> 0;
<a name="l02249"></a>02249       }
<a name="l02250"></a>02250       <span class="comment">/* depending on the mode, accept full or partial match or both */</span>
<a name="l02251"></a>02251       <span class="keywordflow">if</span> (mode == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea2e605157e82dec388ffc89c1694fb7be">E_MATCH</a>) {
<a name="l02252"></a>02252 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02253"></a>02253 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;return (!strcmp(%s,%s) when mode== E_MATCH)\n&quot;</span>, pattern, data);
<a name="l02254"></a>02254 <span class="preprocessor">#endif</span>
<a name="l02255"></a>02255 <span class="preprocessor"></span>         <span class="keywordflow">return</span> !strcmp(pattern, data); <span class="comment">/* 1 on match, 0 on fail */</span>
<a name="l02256"></a>02256       }
<a name="l02257"></a>02257       <span class="keywordflow">if</span> (ld == 0 || !strncasecmp(pattern, data, ld)) { <span class="comment">/* partial or full match */</span>
<a name="l02258"></a>02258 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02259"></a>02259 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;return (mode(%d) == E_MATCHMORE ? lp(%d) &gt; ld(%d) : 1)\n&quot;</span>, mode, lp, ld);
<a name="l02260"></a>02260 <span class="preprocessor">#endif</span>
<a name="l02261"></a>02261 <span class="preprocessor"></span>         <span class="keywordflow">return</span> (mode == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>) ? lp &gt; ld : 1; <span class="comment">/* XXX should consider &apos;!&apos; and &apos;/&apos; ? */</span>
<a name="l02262"></a>02262       } <span class="keywordflow">else</span> {
<a name="l02263"></a>02263 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02264"></a>02264 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;return (0) when ld(%d) &gt; 0 &amp;&amp; pattern(%s) != data(%s)\n&quot;</span>, ld, pattern, data);
<a name="l02265"></a>02265 <span class="preprocessor">#endif</span>
<a name="l02266"></a>02266 <span class="preprocessor"></span>         <span class="keywordflow">return</span> 0;
<a name="l02267"></a>02267       }
<a name="l02268"></a>02268    }
<a name="l02269"></a>02269    pattern++; <span class="comment">/* skip leading _ */</span>
<a name="l02270"></a>02270    <span class="comment">/*</span>
<a name="l02271"></a>02271 <span class="comment">    * XXX below we stop at &apos;/&apos; which is a separator for the CID info. However we should</span>
<a name="l02272"></a>02272 <span class="comment">    * not store &apos;/&apos; in the pattern at all. When we insure it, we can remove the checks.</span>
<a name="l02273"></a>02273 <span class="comment">    */</span>
<a name="l02274"></a>02274    <span class="keywordflow">while</span> (*data &amp;&amp; *pattern &amp;&amp; *pattern != <span class="charliteral">&apos;/&apos;</span>) {
<a name="l02275"></a>02275       <span class="keyword">const</span> <span class="keywordtype">char</span> *end;
<a name="l02276"></a>02276 
<a name="l02277"></a>02277       <span class="keywordflow">if</span> (*data == <span class="charliteral">&apos;-&apos;</span>) { <span class="comment">/* skip &apos;-&apos; in data (just a separator) */</span>
<a name="l02278"></a>02278          data++;
<a name="l02279"></a>02279          <span class="keywordflow">continue</span>;
<a name="l02280"></a>02280       }
<a name="l02281"></a>02281       <span class="keywordflow">switch</span> (toupper(*pattern)) {
<a name="l02282"></a>02282       <span class="keywordflow">case</span> <span class="charliteral">&apos;[&apos;</span>:   <span class="comment">/* a range */</span>
<a name="l02283"></a>02283          end = strchr(pattern+1, <span class="charliteral">&apos;]&apos;</span>); <span class="comment">/* XXX should deal with escapes ? */</span>
<a name="l02284"></a>02284          <span class="keywordflow">if</span> (end == NULL) {
<a name="l02285"></a>02285             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Wrong usage of [] in the extension\n&quot;</span>);
<a name="l02286"></a>02286             <span class="keywordflow">return</span> 0;   <span class="comment">/* unconditional failure */</span>
<a name="l02287"></a>02287          }
<a name="l02288"></a>02288          <span class="keywordflow">for</span> (pattern++; pattern != end; pattern++) {
<a name="l02289"></a>02289             <span class="keywordflow">if</span> (pattern+2 &lt; end &amp;&amp; pattern[1] == <span class="charliteral">&apos;-&apos;</span>) { <span class="comment">/* this is a range */</span>
<a name="l02290"></a>02290                <span class="keywordflow">if</span> (*data &gt;= pattern[0] &amp;&amp; *data &lt;= pattern[2])
<a name="l02291"></a>02291                   <span class="keywordflow">break</span>;   <span class="comment">/* match found */</span>
<a name="l02292"></a>02292                <span class="keywordflow">else</span> {
<a name="l02293"></a>02293                   pattern += 2; <span class="comment">/* skip a total of 3 chars */</span>
<a name="l02294"></a>02294                   <span class="keywordflow">continue</span>;
<a name="l02295"></a>02295                }
<a name="l02296"></a>02296             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*data == pattern[0])
<a name="l02297"></a>02297                <span class="keywordflow">break</span>;   <span class="comment">/* match found */</span>
<a name="l02298"></a>02298          }
<a name="l02299"></a>02299          <span class="keywordflow">if</span> (pattern == end) {
<a name="l02300"></a>02300 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02301"></a>02301 <span class="preprocessor"></span>            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;return (0) when pattern==end\n&quot;</span>);
<a name="l02302"></a>02302 <span class="preprocessor">#endif</span>
<a name="l02303"></a>02303 <span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
<a name="l02304"></a>02304          }
<a name="l02305"></a>02305          pattern = end; <span class="comment">/* skip and continue */</span>
<a name="l02306"></a>02306          <span class="keywordflow">break</span>;
<a name="l02307"></a>02307       <span class="keywordflow">case</span> <span class="charliteral">&apos;N&apos;</span>:
<a name="l02308"></a>02308          <span class="keywordflow">if</span> (*data &lt; &apos;2&apos; || *data &gt; <span class="charliteral">&apos;9&apos;</span>) {
<a name="l02309"></a>02309 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02310"></a>02310 <span class="preprocessor"></span>            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;return (0) N is matched\n&quot;</span>);
<a name="l02311"></a>02311 <span class="preprocessor">#endif</span>
<a name="l02312"></a>02312 <span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
<a name="l02313"></a>02313          }
<a name="l02314"></a>02314          <span class="keywordflow">break</span>;
<a name="l02315"></a>02315       <span class="keywordflow">case</span> <span class="charliteral">&apos;X&apos;</span>:
<a name="l02316"></a>02316          <span class="keywordflow">if</span> (*data &lt; &apos;0&apos; || *data &gt; <span class="charliteral">&apos;9&apos;</span>) {
<a name="l02317"></a>02317 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02318"></a>02318 <span class="preprocessor"></span>            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;return (0) X is matched\n&quot;</span>);
<a name="l02319"></a>02319 <span class="preprocessor">#endif</span>
<a name="l02320"></a>02320 <span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
<a name="l02321"></a>02321          }
<a name="l02322"></a>02322          <span class="keywordflow">break</span>;
<a name="l02323"></a>02323       <span class="keywordflow">case</span> <span class="charliteral">&apos;Z&apos;</span>:
<a name="l02324"></a>02324          <span class="keywordflow">if</span> (*data &lt; &apos;1&apos; || *data &gt; <span class="charliteral">&apos;9&apos;</span>) {
<a name="l02325"></a>02325 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02326"></a>02326 <span class="preprocessor"></span>            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;return (0) Z is matched\n&quot;</span>);
<a name="l02327"></a>02327 <span class="preprocessor">#endif</span>
<a name="l02328"></a>02328 <span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
<a name="l02329"></a>02329          }
<a name="l02330"></a>02330          <span class="keywordflow">break</span>;
<a name="l02331"></a>02331       <span class="keywordflow">case</span> <span class="charliteral">&apos;.&apos;</span>:   <span class="comment">/* Must match, even with more digits */</span>
<a name="l02332"></a>02332 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02333"></a>02333 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;return (1) when &apos;.&apos; is matched\n&quot;</span>);
<a name="l02334"></a>02334 <span class="preprocessor">#endif</span>
<a name="l02335"></a>02335 <span class="preprocessor"></span>         <span class="keywordflow">return</span> 1;
<a name="l02336"></a>02336       <span class="keywordflow">case</span> <span class="charliteral">&apos;!&apos;</span>:   <span class="comment">/* Early match */</span>
<a name="l02337"></a>02337 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02338"></a>02338 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;return (2) when &apos;!&apos; is matched\n&quot;</span>);
<a name="l02339"></a>02339 <span class="preprocessor">#endif</span>
<a name="l02340"></a>02340 <span class="preprocessor"></span>         <span class="keywordflow">return</span> 2;
<a name="l02341"></a>02341       <span class="keywordflow">case</span> <span class="charliteral">&apos; &apos;</span>:
<a name="l02342"></a>02342       <span class="keywordflow">case</span> <span class="charliteral">&apos;-&apos;</span>:   <span class="comment">/* Ignore these in patterns */</span>
<a name="l02343"></a>02343          data--; <span class="comment">/* compensate the final data++ */</span>
<a name="l02344"></a>02344          <span class="keywordflow">break</span>;
<a name="l02345"></a>02345       <span class="keywordflow">default</span>:
<a name="l02346"></a>02346          <span class="keywordflow">if</span> (*data != *pattern) {
<a name="l02347"></a>02347 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02348"></a>02348 <span class="preprocessor"></span>            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;return (0) when *data(%c) != *pattern(%c)\n&quot;</span>, *data, *pattern);
<a name="l02349"></a>02349 <span class="preprocessor">#endif</span>
<a name="l02350"></a>02350 <span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
<a name="l02351"></a>02351          }
<a name="l02352"></a>02352       }
<a name="l02353"></a>02353       data++;
<a name="l02354"></a>02354       pattern++;
<a name="l02355"></a>02355    }
<a name="l02356"></a>02356    <span class="keywordflow">if</span> (*data)        <span class="comment">/* data longer than pattern, no match */</span> {
<a name="l02357"></a>02357 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02358"></a>02358 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;return (0) when data longer than pattern\n&quot;</span>);
<a name="l02359"></a>02359 <span class="preprocessor">#endif</span>
<a name="l02360"></a>02360 <span class="preprocessor"></span>      <span class="keywordflow">return</span> 0;
<a name="l02361"></a>02361    }
<a name="l02362"></a>02362 
<a name="l02363"></a>02363    <span class="comment">/*</span>
<a name="l02364"></a>02364 <span class="comment">    * match so far, but ran off the end of the data.</span>
<a name="l02365"></a>02365 <span class="comment">    * Depending on what is next, determine match or not.</span>
<a name="l02366"></a>02366 <span class="comment">    */</span>
<a name="l02367"></a>02367    <span class="keywordflow">if</span> (*pattern == <span class="charliteral">&apos;\0&apos;</span> || *pattern == <span class="charliteral">&apos;/&apos;</span>) {   <span class="comment">/* exact match */</span>
<a name="l02368"></a>02368 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02369"></a>02369 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;at end, return (%d) in &apos;exact match&apos;\n&quot;</span>, (mode==<a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>) ? 0 : 1);
<a name="l02370"></a>02370 <span class="preprocessor">#endif</span>
<a name="l02371"></a>02371 <span class="preprocessor"></span>      <span class="keywordflow">return</span> (mode == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>) ? 0 : 1;  <span class="comment">/* this is a failure for E_MATCHMORE */</span>
<a name="l02372"></a>02372    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*pattern == <span class="charliteral">&apos;!&apos;</span>)   {     <span class="comment">/* early match */</span>
<a name="l02373"></a>02373 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02374"></a>02374 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;at end, return (2) when &apos;!&apos; is matched\n&quot;</span>);
<a name="l02375"></a>02375 <span class="preprocessor">#endif</span>
<a name="l02376"></a>02376 <span class="preprocessor"></span>      <span class="keywordflow">return</span> 2;
<a name="l02377"></a>02377    } <span class="keywordflow">else</span> {                <span class="comment">/* partial match */</span>
<a name="l02378"></a>02378 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02379"></a>02379 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;at end, return (%d) which deps on E_MATCH\n&quot;</span>, (mode == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea2e605157e82dec388ffc89c1694fb7be">E_MATCH</a>) ? 0 : 1);
<a name="l02380"></a>02380 <span class="preprocessor">#endif</span>
<a name="l02381"></a>02381 <span class="preprocessor"></span>      <span class="keywordflow">return</span> (mode == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea2e605157e82dec388ffc89c1694fb7be">E_MATCH</a>) ? 0 : 1;   <span class="comment">/* this is a failure for E_MATCH */</span>
<a name="l02382"></a>02382    }
<a name="l02383"></a>02383 }
<a name="l02384"></a>02384 
<a name="l02385"></a>02385 <span class="comment">/*</span>
<a name="l02386"></a>02386 <span class="comment"> * Wrapper around _extension_match_core() to do performance measurement</span>
<a name="l02387"></a>02387 <span class="comment"> * using the profiling code.</span>
<a name="l02388"></a>02388 <span class="comment"> */</span>
<a name="l02389"></a><a class="code" href="pbx_8c.html#aef34845bd9203c43797706dc4edc05d7">02389</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#aef34845bd9203c43797706dc4edc05d7">extension_match_core</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *pattern, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keyword">enum</span> <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26be">ext_match_t</a> mode)
<a name="l02390"></a>02390 {
<a name="l02391"></a>02391    <span class="keywordtype">int</span> i;
<a name="l02392"></a>02392    <span class="keyword">static</span> <span class="keywordtype">int</span> prof_id = -2;   <span class="comment">/* marker for &apos;unallocated&apos; id */</span>
<a name="l02393"></a>02393    <span class="keywordflow">if</span> (prof_id == -2) {
<a name="l02394"></a>02394       prof_id = <a class="code" href="asterisk_8h.html#a075573924d385edb22dd8dedbd433256" title="support for event profiling">ast_add_profile</a>(<span class="stringliteral">&quot;ext_match&quot;</span>, 0);
<a name="l02395"></a>02395    }
<a name="l02396"></a>02396    <a class="code" href="asterisk_8h.html#a84666fa713cf20e8bc7e2d8524a10ce0">ast_mark</a>(prof_id, 1);
<a name="l02397"></a>02397    i = <a class="code" href="pbx_8c.html#aad00874b99ffc028615d6bfe93ae5496">_extension_match_core</a>(pattern, data, mode);
<a name="l02398"></a>02398    <a class="code" href="asterisk_8h.html#a84666fa713cf20e8bc7e2d8524a10ce0">ast_mark</a>(prof_id, 0);
<a name="l02399"></a>02399    <span class="keywordflow">return</span> i;
<a name="l02400"></a>02400 }
<a name="l02401"></a>02401 
<a name="l02402"></a><a class="code" href="pbx_8c.html#a594f1f57f847b59c1d8aeef4b0e3a337">02402</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a94cf2f099462a906620b5566871af797" title="Determine if a given extension matches a given pattern (in NXX format).">ast_extension_match</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *pattern, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)
<a name="l02403"></a>02403 {
<a name="l02404"></a>02404    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#aef34845bd9203c43797706dc4edc05d7">extension_match_core</a>(pattern, data, <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea2e605157e82dec388ffc89c1694fb7be">E_MATCH</a>);
<a name="l02405"></a>02405 }
<a name="l02406"></a>02406 
<a name="l02407"></a><a class="code" href="pbx_8c.html#a83192a0099558f6a539fdb4e065ff99d">02407</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a83192a0099558f6a539fdb4e065ff99d">ast_extension_close</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *pattern, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> needmore)
<a name="l02408"></a>02408 {
<a name="l02409"></a>02409    <span class="keywordflow">if</span> (needmore != <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a> &amp;&amp; needmore != <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea413c09377a892aa154e7669cbdaf27ba">E_CANMATCH</a>)
<a name="l02410"></a>02410       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;invalid argument %d\n&quot;</span>, needmore);
<a name="l02411"></a>02411    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#aef34845bd9203c43797706dc4edc05d7">extension_match_core</a>(pattern, data, needmore);
<a name="l02412"></a>02412 }
<a name="l02413"></a>02413 
<a name="l02414"></a><a class="code" href="structfake__context.html">02414</a> <span class="keyword">struct </span><a class="code" href="structfake__context.html">fake_context</a> <span class="comment">/* this struct is purely for matching in the hashtab */</span>
<a name="l02415"></a>02415 {
<a name="l02416"></a><a class="code" href="structfake__context.html#ace4e0066a5b24f84b90536e9906619f6">02416</a>    <a class="code" href="lock_8h.html#af7598796d461f7dcb95cea6be65806f8">ast_rwlock_t</a> <a class="code" href="app__meetme_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>;
<a name="l02417"></a><a class="code" href="structfake__context.html#a6611ebb8017b475186f83b2a62bc25d2">02417</a>    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *root;
<a name="l02418"></a><a class="code" href="structfake__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">02418</a>    <span class="keyword">struct </span><a class="code" href="structast__hashtab.html">ast_hashtab</a> *root_table;
<a name="l02419"></a><a class="code" href="structfake__context.html#a2fa7eba1ccec8820c766879753569da0">02419</a>    <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *pattern_tree;
<a name="l02420"></a><a class="code" href="structfake__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">02420</a>    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="structast__sw.html#a9dba44603dc55a347a5cbe388aeac9f0">next</a>;
<a name="l02421"></a><a class="code" href="structfake__context.html#abaa8691efe3e8fe26f5930720bfd8edb">02421</a>    <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *includes;
<a name="l02422"></a><a class="code" href="structfake__context.html#aedb0afcd332920e51d2f82860f794347">02422</a>    <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ignorepats;
<a name="l02423"></a><a class="code" href="structfake__context.html#aa05090666ce7a4905fe1b56b4fdd3be3">02423</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>;
<a name="l02424"></a><a class="code" href="structfake__context.html#a6022c8a609170c7365fb96e83cb2df48">02424</a>    <span class="keywordtype">int</span> refcount;
<a name="l02425"></a><a class="code" href="structfake__context.html#ae59b83ffcc6f20181a385cffbb6cabcb">02425</a>    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a>) alts;
<a name="l02426"></a><a class="code" href="structfake__context.html#a34eb63008d294b713376e64bb2a7b2ef">02426</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> macrolock;
<a name="l02427"></a><a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">02427</a>    <span class="keywordtype">char</span> name[256];
<a name="l02428"></a>02428 };
<a name="l02429"></a>02429 
<a name="l02430"></a><a class="code" href="pbx_8c.html#a2af2d2771e5347b18454a05dbc98e35f">02430</a> struct <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="pbx_8h.html#a2af2d2771e5347b18454a05dbc98e35f" title="Find a context.">ast_context_find</a>(const <span class="keywordtype">char</span> *name)
<a name="l02431"></a>02431 {
<a name="l02432"></a>02432    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *tmp = NULL;
<a name="l02433"></a>02433    <span class="keyword">struct </span><a class="code" href="structfake__context.html">fake_context</a> item;
<a name="l02434"></a>02434 
<a name="l02435"></a>02435    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(item.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, name, <span class="keyword">sizeof</span>(item.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>));
<a name="l02436"></a>02436 
<a name="l02437"></a>02437    <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l02438"></a>02438    <span class="keywordflow">if</span>( <a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a> ) {
<a name="l02439"></a>02439       tmp = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>,&amp;item);
<a name="l02440"></a>02440    } <span class="keywordflow">else</span> {
<a name="l02441"></a>02441       <span class="keywordflow">while</span> ( (tmp = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(tmp)) ) {
<a name="l02442"></a>02442          <span class="keywordflow">if</span> (!name || !strcasecmp(name, tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>)) {
<a name="l02443"></a>02443             <span class="keywordflow">break</span>;
<a name="l02444"></a>02444          }
<a name="l02445"></a>02445       }
<a name="l02446"></a>02446    }
<a name="l02447"></a>02447    <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l02448"></a>02448    <span class="keywordflow">return</span> tmp;
<a name="l02449"></a>02449 }
<a name="l02450"></a>02450 
<a name="l02451"></a><a class="code" href="pbx_8c.html#aa2d7a93c24186594d8c09e904fa17132">02451</a> <span class="preprocessor">#define STATUS_NO_CONTEXT  1</span>
<a name="l02452"></a><a class="code" href="pbx_8c.html#a53e8d9faad7e0156772e9559df5f8c2e">02452</a> <span class="preprocessor"></span><span class="preprocessor">#define STATUS_NO_EXTENSION   2</span>
<a name="l02453"></a><a class="code" href="pbx_8c.html#ab6422b4f1e9de4cb16307bd081b8706b">02453</a> <span class="preprocessor"></span><span class="preprocessor">#define STATUS_NO_PRIORITY 3</span>
<a name="l02454"></a><a class="code" href="pbx_8c.html#a5062f2413e9425755149f855577b602f">02454</a> <span class="preprocessor"></span><span class="preprocessor">#define STATUS_NO_LABEL    4</span>
<a name="l02455"></a><a class="code" href="pbx_8c.html#ae56fdb340b23940f7a64ed2e37c1774a">02455</a> <span class="preprocessor"></span><span class="preprocessor">#define STATUS_SUCCESS     5</span>
<a name="l02456"></a>02456 <span class="preprocessor"></span>
<a name="l02457"></a><a class="code" href="pbx_8c.html#aa387123ad981d4889f47275234042a2e">02457</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#aa387123ad981d4889f47275234042a2e">matchcid</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *cidpattern, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid)
<a name="l02458"></a>02458 {
<a name="l02459"></a>02459    <span class="comment">/* If the Caller*ID pattern is empty, then we&apos;re matching NO Caller*ID, so</span>
<a name="l02460"></a>02460 <span class="comment">      failing to get a number should count as a match, otherwise not */</span>
<a name="l02461"></a>02461 
<a name="l02462"></a>02462    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(callerid)) {
<a name="l02463"></a>02463       <span class="keywordflow">return</span> <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cidpattern) ? 1 : 0;
<a name="l02464"></a>02464    }
<a name="l02465"></a>02465 
<a name="l02466"></a>02466    <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a94cf2f099462a906620b5566871af797" title="Determine if a given extension matches a given pattern (in NXX format).">ast_extension_match</a>(cidpattern, callerid);
<a name="l02467"></a>02467 }
<a name="l02468"></a>02468 
<a name="l02469"></a><a class="code" href="pbx_8c.html#a63e03245dc48558e55da8890b3dbb87e">02469</a> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="pbx_8h.html#a63e03245dc48558e55da8890b3dbb87e">pbx_find_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan,
<a name="l02470"></a>02470    <span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *bypass, <span class="keyword">struct</span> <a class="code" href="structpbx__find__info.html">pbx_find_info</a> *q,
<a name="l02471"></a>02471    <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority,
<a name="l02472"></a>02472    <span class="keyword">const</span> <span class="keywordtype">char</span> *label, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keyword">enum</span> <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26be">ext_match_t</a> action)
<a name="l02473"></a>02473 {
<a name="l02474"></a>02474    <span class="keywordtype">int</span> x, res;
<a name="l02475"></a>02475    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *tmp = NULL;
<a name="l02476"></a>02476    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e = NULL, *eroot = NULL;
<a name="l02477"></a>02477    <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *i = NULL;
<a name="l02478"></a>02478    <span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *sw = NULL;
<a name="l02479"></a>02479    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> pattern = {NULL, };
<a name="l02480"></a>02480    <span class="keyword">struct </span><a class="code" href="structscoreboard.html">scoreboard</a> score = {0, };
<a name="l02481"></a>02481    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *tmpdata = NULL;
<a name="l02482"></a>02482 
<a name="l02483"></a>02483    pattern.<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a> = label;
<a name="l02484"></a>02484    pattern.<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = priority;
<a name="l02485"></a>02485 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02486"></a>02486 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Looking for cont/ext/prio/label/action = %s/%s/%d/%s/%d\n&quot;</span>, context, exten, priority, label, (<span class="keywordtype">int</span>) action);
<a name="l02487"></a>02487 <span class="preprocessor">#endif</span>
<a name="l02488"></a>02488 <span class="preprocessor"></span>
<a name="l02489"></a>02489    <span class="comment">/* Initialize status if appropriate */</span>
<a name="l02490"></a>02490    <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structpbx__find__info.html#a31dd453024f17e9e35717368cf8c87fb">stacklen</a> == 0) {
<a name="l02491"></a>02491       q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="extconf_8h.html#aa2d7a93c24186594d8c09e904fa17132">STATUS_NO_CONTEXT</a>;
<a name="l02492"></a>02492       q-&gt;<a class="code" href="structpbx__find__info.html#a3215a7f1fa2be1b8f6872b5b388b55a8">swo</a> = NULL;
<a name="l02493"></a>02493       q-&gt;<a class="code" href="structpbx__find__info.html#ae4950db1dbfff8459a712737063b61aa">data</a> = NULL;
<a name="l02494"></a>02494       q-&gt;<a class="code" href="structpbx__find__info.html#a71796127253dfc9a1830ede1904c653b">foundcontext</a> = NULL;
<a name="l02495"></a>02495    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structpbx__find__info.html#a31dd453024f17e9e35717368cf8c87fb">stacklen</a> &gt;= <a class="code" href="extconf_8h.html#a05848c0de74d85dc2fb259f332d33f25">AST_PBX_MAX_STACK</a>) {
<a name="l02496"></a>02496       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum PBX stack exceeded\n&quot;</span>);
<a name="l02497"></a>02497       <span class="keywordflow">return</span> NULL;
<a name="l02498"></a>02498    }
<a name="l02499"></a>02499 
<a name="l02500"></a>02500    <span class="comment">/* Check first to see if we&apos;ve already been checked */</span>
<a name="l02501"></a>02501    <span class="keywordflow">for</span> (x = 0; x &lt; q-&gt;<a class="code" href="structpbx__find__info.html#a31dd453024f17e9e35717368cf8c87fb">stacklen</a>; x++) {
<a name="l02502"></a>02502       <span class="keywordflow">if</span> (!strcasecmp(q-&gt;<a class="code" href="structpbx__find__info.html#a5316dcae577cc913943c7a2b6e00c6da">incstack</a>[x], context))
<a name="l02503"></a>02503          <span class="keywordflow">return</span> NULL;
<a name="l02504"></a>02504    }
<a name="l02505"></a>02505 
<a name="l02506"></a>02506    <span class="keywordflow">if</span> (bypass) { <span class="comment">/* bypass means we only look there */</span>
<a name="l02507"></a>02507       tmp = bypass;
<a name="l02508"></a>02508    } <span class="keywordflow">else</span> {      <span class="comment">/* look in contexts */</span>
<a name="l02509"></a>02509       <span class="keyword">struct </span><a class="code" href="structfake__context.html">fake_context</a> item;
<a name="l02510"></a>02510 
<a name="l02511"></a>02511       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(item.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, context, <span class="keyword">sizeof</span>(item.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>));
<a name="l02512"></a>02512 
<a name="l02513"></a>02513       tmp = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>, &amp;item);
<a name="l02514"></a>02514 <span class="preprocessor">#ifdef NOTNOW</span>
<a name="l02515"></a>02515 <span class="preprocessor"></span>      tmp = NULL;
<a name="l02516"></a>02516       <span class="keywordflow">while</span> ((tmp = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(tmp)) ) {
<a name="l02517"></a>02517          <span class="keywordflow">if</span> (!strcmp(tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, context)) {
<a name="l02518"></a>02518             <span class="keywordflow">break</span>;
<a name="l02519"></a>02519          }
<a name="l02520"></a>02520       }
<a name="l02521"></a>02521 <span class="preprocessor">#endif</span>
<a name="l02522"></a>02522 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (!tmp) {
<a name="l02523"></a>02523          <span class="keywordflow">return</span> NULL;
<a name="l02524"></a>02524       }
<a name="l02525"></a>02525    }
<a name="l02526"></a>02526 
<a name="l02527"></a>02527    <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> &lt; <a class="code" href="extconf_8h.html#a53e8d9faad7e0156772e9559df5f8c2e">STATUS_NO_EXTENSION</a>)
<a name="l02528"></a>02528       q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="extconf_8h.html#a53e8d9faad7e0156772e9559df5f8c2e">STATUS_NO_EXTENSION</a>;
<a name="l02529"></a>02529 
<a name="l02530"></a>02530    <span class="comment">/* Do a search for matching extension */</span>
<a name="l02531"></a>02531 
<a name="l02532"></a>02532    eroot = NULL;
<a name="l02533"></a>02533    score.<a class="code" href="structscoreboard.html#a4de425bb2743e2e19c2e954dfe1f0bf8">total_specificity</a> = 0;
<a name="l02534"></a>02534    score.<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> = 0;
<a name="l02535"></a>02535    score.<a class="code" href="structscoreboard.html#a411afdaaca990dd80881e20637dc44af">total_length</a> = 0;
<a name="l02536"></a>02536    <span class="keywordflow">if</span> (!tmp-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a> &amp;&amp; tmp-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>) {
<a name="l02537"></a>02537       <a class="code" href="pbx_8c.html#a705ac1563ea8e4c1e3f369e6ad952fda">create_match_char_tree</a>(tmp);
<a name="l02538"></a>02538 <span class="preprocessor">#ifdef NEED_DEBUG</span>
<a name="l02539"></a>02539 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Tree Created in context %s:\n&quot;</span>, context);
<a name="l02540"></a>02540       <a class="code" href="pbx_8c.html#a45d3d0857a56e9ec039a20350bbb7d7f">log_match_char_tree</a>(tmp-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>,<span class="stringliteral">&quot; &quot;</span>);
<a name="l02541"></a>02541 <span class="preprocessor">#endif</span>
<a name="l02542"></a>02542 <span class="preprocessor"></span>   }
<a name="l02543"></a>02543 <span class="preprocessor">#ifdef NEED_DEBUG</span>
<a name="l02544"></a>02544 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;The Trie we are searching in:\n&quot;</span>);
<a name="l02545"></a>02545    <a class="code" href="pbx_8c.html#a45d3d0857a56e9ec039a20350bbb7d7f">log_match_char_tree</a>(tmp-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>, <span class="stringliteral">&quot;::  &quot;</span>);
<a name="l02546"></a>02546 <span class="preprocessor">#endif</span>
<a name="l02547"></a>02547 <span class="preprocessor"></span>
<a name="l02548"></a>02548    <span class="keywordflow">do</span> {
<a name="l02549"></a>02549       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="pbx_8c.html#a8f600ca9999b2d9c3d64cbcdb503895c">overrideswitch</a>)) {
<a name="l02550"></a>02550          <span class="keywordtype">char</span> *osw = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="pbx_8c.html#a8f600ca9999b2d9c3d64cbcdb503895c">overrideswitch</a>), *name;
<a name="l02551"></a>02551          <span class="keyword">struct </span><a class="code" href="structast__switch.html">ast_switch</a> *asw;
<a name="l02552"></a>02552          <a class="code" href="pbx_8h.html#a93ee7200f8a12fa56224b85d2483693d" title="All switch functions have the same interface, so define a type for them.">ast_switch_f</a> *aswf = NULL;
<a name="l02553"></a>02553          <span class="keywordtype">char</span> *datap;
<a name="l02554"></a>02554          <span class="keywordtype">int</span> <a class="code" href="structast__sw.html#a4e3f077fec8b035a2678e7740f366dea">eval</a> = 0;
<a name="l02555"></a>02555 
<a name="l02556"></a>02556          name = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;osw, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l02557"></a>02557          asw = <a class="code" href="pbx_8c.html#a7b44c1c9eafe43b4400fd90794078cef">pbx_findswitch</a>(name);
<a name="l02558"></a>02558 
<a name="l02559"></a>02559          <span class="keywordflow">if</span> (!asw) {
<a name="l02560"></a>02560             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such switch &apos;%s&apos;\n&quot;</span>, name);
<a name="l02561"></a>02561             <span class="keywordflow">break</span>;
<a name="l02562"></a>02562          }
<a name="l02563"></a>02563 
<a name="l02564"></a>02564          <span class="keywordflow">if</span> (osw &amp;&amp; strchr(osw, <span class="charliteral">&apos;$&apos;</span>)) {
<a name="l02565"></a>02565             eval = 1;
<a name="l02566"></a>02566          }
<a name="l02567"></a>02567 
<a name="l02568"></a>02568          <span class="keywordflow">if</span> (eval &amp;&amp; !(tmpdata = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="pbx_8c.html#a34c5d02998c18d892113d659590cd28e">switch_data</a>, 512))) {
<a name="l02569"></a>02569             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t evaluate overrideswitch?!&quot;</span>);
<a name="l02570"></a>02570             <span class="keywordflow">break</span>;
<a name="l02571"></a>02571          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (eval) {
<a name="l02572"></a>02572             <span class="comment">/* Substitute variables now */</span>
<a name="l02573"></a>02573             <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(chan, osw, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(tmpdata), <a class="code" href="strings_8h.html#ab9726d03e7f9f4746876d71bea28de33" title="Returns the current maximum length (without reallocation) of the current buffer.">ast_str_size</a>(tmpdata));
<a name="l02574"></a>02574             datap = <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(tmpdata);
<a name="l02575"></a>02575          } <span class="keywordflow">else</span> {
<a name="l02576"></a>02576             datap = osw;
<a name="l02577"></a>02577          }
<a name="l02578"></a>02578 
<a name="l02579"></a>02579          <span class="comment">/* equivalent of extension_match_core() at the switch level */</span>
<a name="l02580"></a>02580          <span class="keywordflow">if</span> (action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea413c09377a892aa154e7669cbdaf27ba">E_CANMATCH</a>)
<a name="l02581"></a>02581             aswf = asw-&gt;<a class="code" href="structast__switch.html#a0d48d66b2172f7ea362a20ae01640053">canmatch</a>;
<a name="l02582"></a>02582          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>)
<a name="l02583"></a>02583             aswf = asw-&gt;<a class="code" href="structast__switch.html#a89b178ebf5ac0c92ab2ac79ae939f27e">matchmore</a>;
<a name="l02584"></a>02584          <span class="keywordflow">else</span> <span class="comment">/* action == E_MATCH */</span>
<a name="l02585"></a>02585             aswf = asw-&gt;<a class="code" href="structast__switch.html#ad4ed18d92b082c9ce55f73a5b7979068">exists</a>;
<a name="l02586"></a>02586          <span class="keywordflow">if</span> (!aswf) {
<a name="l02587"></a>02587             res = 0;
<a name="l02588"></a>02588          } <span class="keywordflow">else</span> {
<a name="l02589"></a>02589             <span class="keywordflow">if</span> (chan) {
<a name="l02590"></a>02590                <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(chan);
<a name="l02591"></a>02591             }
<a name="l02592"></a>02592             res = aswf(chan, context, exten, priority, callerid, datap);
<a name="l02593"></a>02593             <span class="keywordflow">if</span> (chan) {
<a name="l02594"></a>02594                <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l02595"></a>02595             }
<a name="l02596"></a>02596          }
<a name="l02597"></a>02597          <span class="keywordflow">if</span> (res) {  <span class="comment">/* Got a match */</span>
<a name="l02598"></a>02598             q-&gt;<a class="code" href="structpbx__find__info.html#a3215a7f1fa2be1b8f6872b5b388b55a8">swo</a> = asw;
<a name="l02599"></a>02599             q-&gt;<a class="code" href="structpbx__find__info.html#ae4950db1dbfff8459a712737063b61aa">data</a> = datap;
<a name="l02600"></a>02600             q-&gt;<a class="code" href="structpbx__find__info.html#a71796127253dfc9a1830ede1904c653b">foundcontext</a> = context;
<a name="l02601"></a>02601             <span class="comment">/* XXX keep status = STATUS_NO_CONTEXT ? */</span>
<a name="l02602"></a>02602             <span class="keywordflow">return</span> NULL;
<a name="l02603"></a>02603          }
<a name="l02604"></a>02604       }
<a name="l02605"></a>02605    } <span class="keywordflow">while</span> (0);
<a name="l02606"></a>02606 
<a name="l02607"></a>02607    <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#a3a7600857afccfa4f7a5c55dcaec8407">extenpatternmatchnew</a>) {
<a name="l02608"></a>02608       <a class="code" href="pbx_8c.html#a2c64874adba109557bade6a7cbfd1eea">new_find_extension</a>(exten, &amp;score, tmp-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>, 0, 0, callerid, label, action);
<a name="l02609"></a>02609       eroot = score.<a class="code" href="structscoreboard.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>;
<a name="l02610"></a>02610 
<a name="l02611"></a>02611       <span class="keywordflow">if</span> (score.<a class="code" href="structscoreboard.html#a58353d0395200b159f144de279d0a9b2">last_char</a> == <span class="charliteral">&apos;!&apos;</span> &amp;&amp; action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>) {
<a name="l02612"></a>02612          <span class="comment">/* We match an extension ending in &apos;!&apos;.</span>
<a name="l02613"></a>02613 <span class="comment">          * The decision in this case is final and is NULL (no match).</span>
<a name="l02614"></a>02614 <span class="comment">          */</span>
<a name="l02615"></a>02615 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02616"></a>02616 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Returning MATCHMORE NULL with exclamation point.\n&quot;</span>);
<a name="l02617"></a>02617 <span class="preprocessor">#endif</span>
<a name="l02618"></a>02618 <span class="preprocessor"></span>         <span class="keywordflow">return</span> NULL;
<a name="l02619"></a>02619       }
<a name="l02620"></a>02620 
<a name="l02621"></a>02621       <span class="keywordflow">if</span> (!eroot &amp;&amp; (action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea413c09377a892aa154e7669cbdaf27ba">E_CANMATCH</a> || action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>) &amp;&amp; score.<a class="code" href="structscoreboard.html#afd6db51221fa39c96b9469fa115db1cb">canmatch_exten</a>) {
<a name="l02622"></a>02622          q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="extconf_8h.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;
<a name="l02623"></a>02623 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02624"></a>02624 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Returning CANMATCH exten %s\n&quot;</span>, score.<a class="code" href="structscoreboard.html#afd6db51221fa39c96b9469fa115db1cb">canmatch_exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l02625"></a>02625 <span class="preprocessor">#endif</span>
<a name="l02626"></a>02626 <span class="preprocessor"></span>         <span class="keywordflow">return</span> score.<a class="code" href="structscoreboard.html#afd6db51221fa39c96b9469fa115db1cb">canmatch_exten</a>;
<a name="l02627"></a>02627       }
<a name="l02628"></a>02628 
<a name="l02629"></a>02629       <span class="keywordflow">if</span> ((action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a> || action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea413c09377a892aa154e7669cbdaf27ba">E_CANMATCH</a>)  &amp;&amp; eroot) {
<a name="l02630"></a>02630          <span class="keywordflow">if</span> (score.<a class="code" href="structscoreboard.html#ae6f7c8319cca7a79bdab95ecfa8b57eb">node</a>) {
<a name="l02631"></a>02631             <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *z = <a class="code" href="pbx_8c.html#ae41a2e0750d89ec626fd85b4f24d1e5d">trie_find_next_match</a>(score.<a class="code" href="structscoreboard.html#ae6f7c8319cca7a79bdab95ecfa8b57eb">node</a>);
<a name="l02632"></a>02632             <span class="keywordflow">if</span> (z) {
<a name="l02633"></a>02633 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02634"></a>02634 <span class="preprocessor"></span>               <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Returning CANMATCH/MATCHMORE next_match exten %s\n&quot;</span>, z-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l02635"></a>02635 <span class="preprocessor">#endif</span>
<a name="l02636"></a>02636 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> {
<a name="l02637"></a>02637                <span class="keywordflow">if</span> (score.<a class="code" href="structscoreboard.html#afd6db51221fa39c96b9469fa115db1cb">canmatch_exten</a>) {
<a name="l02638"></a>02638 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02639"></a>02639 <span class="preprocessor"></span>                  <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Returning CANMATCH/MATCHMORE canmatchmatch exten %s(%p)\n&quot;</span>, score.<a class="code" href="structscoreboard.html#afd6db51221fa39c96b9469fa115db1cb">canmatch_exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, score.<a class="code" href="structscoreboard.html#afd6db51221fa39c96b9469fa115db1cb">canmatch_exten</a>);
<a name="l02640"></a>02640 <span class="preprocessor">#endif</span>
<a name="l02641"></a>02641 <span class="preprocessor"></span>                  <span class="keywordflow">return</span> score.<a class="code" href="structscoreboard.html#afd6db51221fa39c96b9469fa115db1cb">canmatch_exten</a>;
<a name="l02642"></a>02642                } <span class="keywordflow">else</span> {
<a name="l02643"></a>02643 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02644"></a>02644 <span class="preprocessor"></span>                  <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Returning CANMATCH/MATCHMORE next_match exten NULL\n&quot;</span>);
<a name="l02645"></a>02645 <span class="preprocessor">#endif</span>
<a name="l02646"></a>02646 <span class="preprocessor"></span>               }
<a name="l02647"></a>02647             }
<a name="l02648"></a>02648             <span class="keywordflow">return</span> z;
<a name="l02649"></a>02649          }
<a name="l02650"></a>02650 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02651"></a>02651 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Returning CANMATCH/MATCHMORE NULL (no next_match)\n&quot;</span>);
<a name="l02652"></a>02652 <span class="preprocessor">#endif</span>
<a name="l02653"></a>02653 <span class="preprocessor"></span>         <span class="keywordflow">return</span> NULL;  <span class="comment">/* according to the code, complete matches are null matches in MATCHMORE mode */</span>
<a name="l02654"></a>02654       }
<a name="l02655"></a>02655 
<a name="l02656"></a>02656       <span class="keywordflow">if</span> (eroot) {
<a name="l02657"></a>02657          <span class="comment">/* found entry, now look for the right priority */</span>
<a name="l02658"></a>02658          <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> &lt; <a class="code" href="extconf_8h.html#ab6422b4f1e9de4cb16307bd081b8706b">STATUS_NO_PRIORITY</a>)
<a name="l02659"></a>02659             q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="extconf_8h.html#ab6422b4f1e9de4cb16307bd081b8706b">STATUS_NO_PRIORITY</a>;
<a name="l02660"></a>02660          e = NULL;
<a name="l02661"></a>02661          <span class="keywordflow">if</span> (action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7b10ab7b3dd6af9d933dbb03dd183eb5">E_FINDLABEL</a> &amp;&amp; label ) {
<a name="l02662"></a>02662             <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> &lt; <a class="code" href="extconf_8h.html#a5062f2413e9425755149f855577b602f">STATUS_NO_LABEL</a>)
<a name="l02663"></a>02663                q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="extconf_8h.html#a5062f2413e9425755149f855577b602f">STATUS_NO_LABEL</a>;
<a name="l02664"></a>02664             e = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(eroot-&gt;peer_label_table, &amp;pattern);
<a name="l02665"></a>02665          } <span class="keywordflow">else</span> {
<a name="l02666"></a>02666             e = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(eroot-&gt;peer_table, &amp;pattern);
<a name="l02667"></a>02667          }
<a name="l02668"></a>02668          <span class="keywordflow">if</span> (e) { <span class="comment">/* found a valid match */</span>
<a name="l02669"></a>02669             q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="extconf_8h.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;
<a name="l02670"></a>02670             q-&gt;<a class="code" href="structpbx__find__info.html#a71796127253dfc9a1830ede1904c653b">foundcontext</a> = context;
<a name="l02671"></a>02671 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02672"></a>02672 <span class="preprocessor"></span>            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Returning complete match of exten %s\n&quot;</span>, e-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l02673"></a>02673 <span class="preprocessor">#endif</span>
<a name="l02674"></a>02674 <span class="preprocessor"></span>            <span class="keywordflow">return</span> e;
<a name="l02675"></a>02675          }
<a name="l02676"></a>02676       }
<a name="l02677"></a>02677    } <span class="keywordflow">else</span> {   <span class="comment">/* the old/current default exten pattern match algorithm */</span>
<a name="l02678"></a>02678 
<a name="l02679"></a>02679       <span class="comment">/* scan the list trying to match extension and CID */</span>
<a name="l02680"></a>02680       eroot = NULL;
<a name="l02681"></a>02681       <span class="keywordflow">while</span> ( (eroot = <a class="code" href="pbx_8h.html#aa63685577f3479dcf31a9e77b2ff05a7">ast_walk_context_extensions</a>(tmp, eroot)) ) {
<a name="l02682"></a>02682          <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">match</a> = <a class="code" href="pbx_8c.html#aef34845bd9203c43797706dc4edc05d7">extension_match_core</a>(eroot-&gt;exten, exten, action);
<a name="l02683"></a>02683          <span class="comment">/* 0 on fail, 1 on match, 2 on earlymatch */</span>
<a name="l02684"></a>02684 
<a name="l02685"></a>02685          <span class="keywordflow">if</span> (!match || (eroot-&gt;matchcid &amp;&amp; !<a class="code" href="pbx_8c.html#aa387123ad981d4889f47275234042a2e">matchcid</a>(eroot-&gt;cidmatch, callerid)))
<a name="l02686"></a>02686             <span class="keywordflow">continue</span>;   <span class="comment">/* keep trying */</span>
<a name="l02687"></a>02687          <span class="keywordflow">if</span> (match == 2 &amp;&amp; action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>) {
<a name="l02688"></a>02688             <span class="comment">/* We match an extension ending in &apos;!&apos;.</span>
<a name="l02689"></a>02689 <span class="comment">             * The decision in this case is final and is NULL (no match).</span>
<a name="l02690"></a>02690 <span class="comment">             */</span>
<a name="l02691"></a>02691             <span class="keywordflow">return</span> NULL;
<a name="l02692"></a>02692          }
<a name="l02693"></a>02693          <span class="comment">/* found entry, now look for the right priority */</span>
<a name="l02694"></a>02694          <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> &lt; <a class="code" href="extconf_8h.html#ab6422b4f1e9de4cb16307bd081b8706b">STATUS_NO_PRIORITY</a>)
<a name="l02695"></a>02695             q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="extconf_8h.html#ab6422b4f1e9de4cb16307bd081b8706b">STATUS_NO_PRIORITY</a>;
<a name="l02696"></a>02696          e = NULL;
<a name="l02697"></a>02697          <span class="keywordflow">if</span> (action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7b10ab7b3dd6af9d933dbb03dd183eb5">E_FINDLABEL</a> &amp;&amp; label ) {
<a name="l02698"></a>02698             <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> &lt; <a class="code" href="extconf_8h.html#a5062f2413e9425755149f855577b602f">STATUS_NO_LABEL</a>)
<a name="l02699"></a>02699                q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="extconf_8h.html#a5062f2413e9425755149f855577b602f">STATUS_NO_LABEL</a>;
<a name="l02700"></a>02700             e = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(eroot-&gt;peer_label_table, &amp;pattern);
<a name="l02701"></a>02701          } <span class="keywordflow">else</span> {
<a name="l02702"></a>02702             e = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(eroot-&gt;peer_table, &amp;pattern);
<a name="l02703"></a>02703          }
<a name="l02704"></a>02704 <span class="preprocessor">#ifdef NOTNOW</span>
<a name="l02705"></a>02705 <span class="preprocessor"></span>         <span class="keywordflow">while</span> ( (e = <a class="code" href="pbx_8h.html#a6772ce6e8de86d4b6c382dbf68ea4755">ast_walk_extension_priorities</a>(eroot, e)) ) {
<a name="l02706"></a>02706             <span class="comment">/* Match label or priority */</span>
<a name="l02707"></a>02707             <span class="keywordflow">if</span> (action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7b10ab7b3dd6af9d933dbb03dd183eb5">E_FINDLABEL</a>) {
<a name="l02708"></a>02708                <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> &lt; <a class="code" href="extconf_8h.html#a5062f2413e9425755149f855577b602f">STATUS_NO_LABEL</a>)
<a name="l02709"></a>02709                   q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="extconf_8h.html#a5062f2413e9425755149f855577b602f">STATUS_NO_LABEL</a>;
<a name="l02710"></a>02710                <span class="keywordflow">if</span> (label &amp;&amp; e-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a> &amp;&amp; !strcmp(label, e-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>))
<a name="l02711"></a>02711                   <span class="keywordflow">break</span>;   <span class="comment">/* found it */</span>
<a name="l02712"></a>02712             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> == priority) {
<a name="l02713"></a>02713                <span class="keywordflow">break</span>;   <span class="comment">/* found it */</span>
<a name="l02714"></a>02714             } <span class="comment">/* else keep searching */</span>
<a name="l02715"></a>02715          }
<a name="l02716"></a>02716 <span class="preprocessor">#endif</span>
<a name="l02717"></a>02717 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (e) { <span class="comment">/* found a valid match */</span>
<a name="l02718"></a>02718             q-&gt;<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="extconf_8h.html#ae56fdb340b23940f7a64ed2e37c1774a">STATUS_SUCCESS</a>;
<a name="l02719"></a>02719             q-&gt;<a class="code" href="structpbx__find__info.html#a71796127253dfc9a1830ede1904c653b">foundcontext</a> = context;
<a name="l02720"></a>02720             <span class="keywordflow">return</span> e;
<a name="l02721"></a>02721          }
<a name="l02722"></a>02722       }
<a name="l02723"></a>02723    }
<a name="l02724"></a>02724 
<a name="l02725"></a>02725    <span class="comment">/* Check alternative switches */</span>
<a name="l02726"></a>02726    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;tmp-&gt;<a class="code" href="structast__context.html#a1a88e64f1d400d544879fb192cb155e7">alts</a>, sw, list) {
<a name="l02727"></a>02727       <span class="keyword">struct </span><a class="code" href="structast__switch.html">ast_switch</a> *asw = <a class="code" href="pbx_8c.html#a7b44c1c9eafe43b4400fd90794078cef">pbx_findswitch</a>(sw-&gt;<a class="code" href="structast__sw.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l02728"></a>02728       <a class="code" href="pbx_8h.html#a93ee7200f8a12fa56224b85d2483693d" title="All switch functions have the same interface, so define a type for them.">ast_switch_f</a> *aswf = NULL;
<a name="l02729"></a>02729       <span class="keywordtype">char</span> *datap;
<a name="l02730"></a>02730 
<a name="l02731"></a>02731       <span class="keywordflow">if</span> (!asw) {
<a name="l02732"></a>02732          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such switch &apos;%s&apos;\n&quot;</span>, sw-&gt;<a class="code" href="structast__sw.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l02733"></a>02733          <span class="keywordflow">continue</span>;
<a name="l02734"></a>02734       }
<a name="l02735"></a>02735 
<a name="l02736"></a>02736       <span class="comment">/* Substitute variables now */</span>
<a name="l02737"></a>02737       <span class="keywordflow">if</span> (sw-&gt;<a class="code" href="structast__sw.html#a4e3f077fec8b035a2678e7740f366dea">eval</a>) {
<a name="l02738"></a>02738          <span class="keywordflow">if</span> (!(tmpdata = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="pbx_8c.html#a34c5d02998c18d892113d659590cd28e">switch_data</a>, 512))) {
<a name="l02739"></a>02739             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t evaluate switch?!&quot;</span>);
<a name="l02740"></a>02740             <span class="keywordflow">continue</span>;
<a name="l02741"></a>02741          }
<a name="l02742"></a>02742          <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(chan, sw-&gt;<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(tmpdata), <a class="code" href="strings_8h.html#ab9726d03e7f9f4746876d71bea28de33" title="Returns the current maximum length (without reallocation) of the current buffer.">ast_str_size</a>(tmpdata));
<a name="l02743"></a>02743       }
<a name="l02744"></a>02744 
<a name="l02745"></a>02745       <span class="comment">/* equivalent of extension_match_core() at the switch level */</span>
<a name="l02746"></a>02746       <span class="keywordflow">if</span> (action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea413c09377a892aa154e7669cbdaf27ba">E_CANMATCH</a>)
<a name="l02747"></a>02747          aswf = asw-&gt;<a class="code" href="structast__switch.html#a0d48d66b2172f7ea362a20ae01640053">canmatch</a>;
<a name="l02748"></a>02748       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>)
<a name="l02749"></a>02749          aswf = asw-&gt;<a class="code" href="structast__switch.html#a89b178ebf5ac0c92ab2ac79ae939f27e">matchmore</a>;
<a name="l02750"></a>02750       <span class="keywordflow">else</span> <span class="comment">/* action == E_MATCH */</span>
<a name="l02751"></a>02751          aswf = asw-&gt;<a class="code" href="structast__switch.html#ad4ed18d92b082c9ce55f73a5b7979068">exists</a>;
<a name="l02752"></a>02752       datap = sw-&gt;<a class="code" href="structast__sw.html#a4e3f077fec8b035a2678e7740f366dea">eval</a> ? <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(tmpdata) : sw-&gt;<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a>;
<a name="l02753"></a>02753       <span class="keywordflow">if</span> (!aswf)
<a name="l02754"></a>02754          res = 0;
<a name="l02755"></a>02755       <span class="keywordflow">else</span> {
<a name="l02756"></a>02756          <span class="keywordflow">if</span> (chan)
<a name="l02757"></a>02757             <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(chan);
<a name="l02758"></a>02758          res = aswf(chan, context, exten, priority, callerid, datap);
<a name="l02759"></a>02759          <span class="keywordflow">if</span> (chan)
<a name="l02760"></a>02760             <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l02761"></a>02761       }
<a name="l02762"></a>02762       <span class="keywordflow">if</span> (res) {  <span class="comment">/* Got a match */</span>
<a name="l02763"></a>02763          q-&gt;<a class="code" href="structpbx__find__info.html#a3215a7f1fa2be1b8f6872b5b388b55a8">swo</a> = asw;
<a name="l02764"></a>02764          q-&gt;<a class="code" href="structpbx__find__info.html#ae4950db1dbfff8459a712737063b61aa">data</a> = datap;
<a name="l02765"></a>02765          q-&gt;<a class="code" href="structpbx__find__info.html#a71796127253dfc9a1830ede1904c653b">foundcontext</a> = context;
<a name="l02766"></a>02766          <span class="comment">/* XXX keep status = STATUS_NO_CONTEXT ? */</span>
<a name="l02767"></a>02767          <span class="keywordflow">return</span> NULL;
<a name="l02768"></a>02768       }
<a name="l02769"></a>02769    }
<a name="l02770"></a>02770    q-&gt;<a class="code" href="structpbx__find__info.html#a5316dcae577cc913943c7a2b6e00c6da">incstack</a>[q-&gt;<a class="code" href="structpbx__find__info.html#a31dd453024f17e9e35717368cf8c87fb">stacklen</a>++] = tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>;   <span class="comment">/* Setup the stack */</span>
<a name="l02771"></a>02771    <span class="comment">/* Now try any includes we have in this context */</span>
<a name="l02772"></a>02772    <span class="keywordflow">for</span> (i = tmp-&gt;<a class="code" href="structast__context.html#abaa8691efe3e8fe26f5930720bfd8edb">includes</a>; i; i = i-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a>) {
<a name="l02773"></a>02773       <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#a6a57ed16bf75bd443baa0c8a7ad74a1a">include_valid</a>(i)) {
<a name="l02774"></a>02774          <span class="keywordflow">if</span> ((e = <a class="code" href="pbx_8h.html#a63e03245dc48558e55da8890b3dbb87e">pbx_find_extension</a>(chan, bypass, q, i-&gt;<a class="code" href="structast__include.html#a0fc4d731325a10cc181d26c7e5549b40">rname</a>, exten, priority, label, callerid, action))) {
<a name="l02775"></a>02775 <span class="preprocessor">#ifdef NEED_DEBUG_HERE</span>
<a name="l02776"></a>02776 <span class="preprocessor"></span>            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Returning recursive match of %s\n&quot;</span>, e-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l02777"></a>02777 <span class="preprocessor">#endif</span>
<a name="l02778"></a>02778 <span class="preprocessor"></span>            <span class="keywordflow">return</span> e;
<a name="l02779"></a>02779          }
<a name="l02780"></a>02780          <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structpbx__find__info.html#a3215a7f1fa2be1b8f6872b5b388b55a8">swo</a>)
<a name="l02781"></a>02781             <span class="keywordflow">return</span> NULL;
<a name="l02782"></a>02782       }
<a name="l02783"></a>02783    }
<a name="l02784"></a>02784    <span class="keywordflow">return</span> NULL;
<a name="l02785"></a>02785 }
<a name="l02786"></a>02786 <span class="comment"></span>
<a name="l02787"></a>02787 <span class="comment">/*!</span>
<a name="l02788"></a>02788 <span class="comment"> * \brief extract offset:length from variable name.</span>
<a name="l02789"></a>02789 <span class="comment"> * \return 1 if there is a offset:length part, which is</span>
<a name="l02790"></a>02790 <span class="comment"> * trimmed off (values go into variables)</span>
<a name="l02791"></a>02791 <span class="comment"> */</span>
<a name="l02792"></a><a class="code" href="pbx_8c.html#ac280b071ffa8f9e016cc011d77c41a86">02792</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#ac280b071ffa8f9e016cc011d77c41a86" title="extract offset:length from variable name.">parse_variable_name</a>(<span class="keywordtype">char</span> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, <span class="keywordtype">int</span> *offset, <span class="keywordtype">int</span> *length, <span class="keywordtype">int</span> *isfunc)
<a name="l02793"></a>02793 {
<a name="l02794"></a>02794    <span class="keywordtype">int</span> parens = 0;
<a name="l02795"></a>02795 
<a name="l02796"></a>02796    *offset = 0;
<a name="l02797"></a>02797    *length = INT_MAX;
<a name="l02798"></a>02798    *isfunc = 0;
<a name="l02799"></a>02799    <span class="keywordflow">for</span> (; *var; var++) {
<a name="l02800"></a>02800       <span class="keywordflow">if</span> (*var == <span class="charliteral">&apos;(&apos;</span>) {
<a name="l02801"></a>02801          (*isfunc)++;
<a name="l02802"></a>02802          parens++;
<a name="l02803"></a>02803       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*var == <span class="charliteral">&apos;)&apos;</span>) {
<a name="l02804"></a>02804          parens--;
<a name="l02805"></a>02805       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*var == <span class="charliteral">&apos;:&apos;</span> &amp;&amp; parens == 0) {
<a name="l02806"></a>02806          *var++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02807"></a>02807          sscanf(var, <span class="stringliteral">&quot;%30d:%30d&quot;</span>, offset, length);
<a name="l02808"></a>02808          <span class="keywordflow">return</span> 1; <span class="comment">/* offset:length valid */</span>
<a name="l02809"></a>02809       }
<a name="l02810"></a>02810    }
<a name="l02811"></a>02811    <span class="keywordflow">return</span> 0;
<a name="l02812"></a>02812 }
<a name="l02813"></a>02813 <span class="comment"></span>
<a name="l02814"></a>02814 <span class="comment">/*!</span>
<a name="l02815"></a>02815 <span class="comment"> *\brief takes a substring. It is ok to call with value == workspace.</span>
<a name="l02816"></a>02816 <span class="comment"> * \param value</span>
<a name="l02817"></a>02817 <span class="comment"> * \param offset &lt; 0 means start from the end of the string and set the beginning</span>
<a name="l02818"></a>02818 <span class="comment"> *   to be that many characters back.</span>
<a name="l02819"></a>02819 <span class="comment"> * \param length is the length of the substring, a value less than 0 means to leave</span>
<a name="l02820"></a>02820 <span class="comment"> * that many off the end.</span>
<a name="l02821"></a>02821 <span class="comment"> * \param workspace</span>
<a name="l02822"></a>02822 <span class="comment"> * \param workspace_len</span>
<a name="l02823"></a>02823 <span class="comment"> * Always return a copy in workspace.</span>
<a name="l02824"></a>02824 <span class="comment"> */</span>
<a name="l02825"></a><a class="code" href="pbx_8c.html#ac79353a3cba653bbeea7eabd8e4d073c">02825</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#ac79353a3cba653bbeea7eabd8e4d073c" title="takes a substring. It is ok to call with value == workspace.">substring</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *value, <span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> length, <span class="keywordtype">char</span> *workspace, <span class="keywordtype">size_t</span> workspace_len)
<a name="l02826"></a>02826 {
<a name="l02827"></a>02827    <span class="keywordtype">char</span> *ret = workspace;
<a name="l02828"></a>02828    <span class="keywordtype">int</span> lr;  <span class="comment">/* length of the input string after the copy */</span>
<a name="l02829"></a>02829 
<a name="l02830"></a>02830    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(workspace, value, workspace_len); <span class="comment">/* always make a copy */</span>
<a name="l02831"></a>02831 
<a name="l02832"></a>02832    lr = strlen(ret); <span class="comment">/* compute length after copy, so we never go out of the workspace */</span>
<a name="l02833"></a>02833 
<a name="l02834"></a>02834    <span class="comment">/* Quick check if no need to do anything */</span>
<a name="l02835"></a>02835    <span class="keywordflow">if</span> (offset == 0 &amp;&amp; length &gt;= lr) <span class="comment">/* take the whole string */</span>
<a name="l02836"></a>02836       <span class="keywordflow">return</span> ret;
<a name="l02837"></a>02837 
<a name="l02838"></a>02838    <span class="keywordflow">if</span> (offset &lt; 0)   {  <span class="comment">/* translate negative offset into positive ones */</span>
<a name="l02839"></a>02839       offset = lr + offset;
<a name="l02840"></a>02840       <span class="keywordflow">if</span> (offset &lt; 0) <span class="comment">/* If the negative offset was greater than the length of the string, just start at the beginning */</span>
<a name="l02841"></a>02841          offset = 0;
<a name="l02842"></a>02842    }
<a name="l02843"></a>02843 
<a name="l02844"></a>02844    <span class="comment">/* too large offset result in empty string so we know what to return */</span>
<a name="l02845"></a>02845    <span class="keywordflow">if</span> (offset &gt;= lr)
<a name="l02846"></a>02846       <span class="keywordflow">return</span> ret + lr;  <span class="comment">/* the final &apos;\0&apos; */</span>
<a name="l02847"></a>02847 
<a name="l02848"></a>02848    ret += offset;    <span class="comment">/* move to the start position */</span>
<a name="l02849"></a>02849    <span class="keywordflow">if</span> (length &gt;= 0 &amp;&amp; length &lt; lr - offset)  <span class="comment">/* truncate if necessary */</span>
<a name="l02850"></a>02850       ret[length] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02851"></a>02851    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (length &lt; 0) {
<a name="l02852"></a>02852       <span class="keywordflow">if</span> (lr &gt; offset - length) <span class="comment">/* After we remove from the front and from the rear, is there anything left? */</span>
<a name="l02853"></a>02853          ret[lr + length - offset] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02854"></a>02854       <span class="keywordflow">else</span>
<a name="l02855"></a>02855          ret[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02856"></a>02856    }
<a name="l02857"></a>02857 
<a name="l02858"></a>02858    <span class="keywordflow">return</span> ret;
<a name="l02859"></a>02859 }
<a name="l02860"></a>02860 <span class="comment"></span>
<a name="l02861"></a>02861 <span class="comment">/*! \brief  Support for Asterisk built-in variables in the dialplan</span>
<a name="l02862"></a>02862 <span class="comment"></span>
<a name="l02863"></a>02863 <span class="comment">\note See also</span>
<a name="l02864"></a>02864 <span class="comment">   - \ref AstVar  Channel variables</span>
<a name="l02865"></a>02865 <span class="comment">   - \ref AstCauses The HANGUPCAUSE variable</span>
<a name="l02866"></a>02866 <span class="comment"> */</span>
<a name="l02867"></a><a class="code" href="pbx_8c.html#aaf906a18ba2dcd53c35f59869757521f">02867</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8h.html#aaf906a18ba2dcd53c35f59869757521f" title="Retrieve the value of a builtin variable or variable from the channel variable stack...">pbx_retrieve_variable</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, <span class="keywordtype">char</span> **ret, <span class="keywordtype">char</span> *workspace, <span class="keywordtype">int</span> workspacelen, <span class="keyword">struct</span> varshead *headp)
<a name="l02868"></a>02868 {
<a name="l02869"></a>02869    <span class="keyword">const</span> <span class="keywordtype">char</span> not_found = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02870"></a>02870    <span class="keywordtype">char</span> *tmpvar;
<a name="l02871"></a>02871    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>; <span class="comment">/* the result */</span>
<a name="l02872"></a>02872    <span class="keywordtype">int</span> offset, length;
<a name="l02873"></a>02873    <span class="keywordtype">int</span> i, need_substring;
<a name="l02874"></a>02874    <span class="keyword">struct </span>varshead *places[2] = { headp, &amp;<a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a> };  <span class="comment">/* list of places where we may look */</span>
<a name="l02875"></a>02875 
<a name="l02876"></a>02876    <span class="keywordflow">if</span> (c) {
<a name="l02877"></a>02877       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(c);
<a name="l02878"></a>02878       places[0] = &amp;c-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a>;
<a name="l02879"></a>02879    }
<a name="l02880"></a>02880    <span class="comment">/*</span>
<a name="l02881"></a>02881 <span class="comment">    * Make a copy of var because parse_variable_name() modifies the string.</span>
<a name="l02882"></a>02882 <span class="comment">    * Then if called directly, we might need to run substring() on the result;</span>
<a name="l02883"></a>02883 <span class="comment">    * remember this for later in &apos;need_substring&apos;, &apos;offset&apos; and &apos;length&apos;</span>
<a name="l02884"></a>02884 <span class="comment">    */</span>
<a name="l02885"></a>02885    tmpvar = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(var); <span class="comment">/* parse_variable_name modifies the string */</span>
<a name="l02886"></a>02886    need_substring = <a class="code" href="pbx_8c.html#ac280b071ffa8f9e016cc011d77c41a86" title="extract offset:length from variable name.">parse_variable_name</a>(tmpvar, &amp;offset, &amp;length, &amp;i <span class="comment">/* ignored */</span>);
<a name="l02887"></a>02887 
<a name="l02888"></a>02888    <span class="comment">/*</span>
<a name="l02889"></a>02889 <span class="comment">    * Look first into predefined variables, then into variable lists.</span>
<a name="l02890"></a>02890 <span class="comment">    * Variable &apos;s&apos; points to the result, according to the following rules:</span>
<a name="l02891"></a>02891 <span class="comment">    * s == &amp;not_found (set at the beginning) means that we did not find a</span>
<a name="l02892"></a>02892 <span class="comment">    * matching variable and need to look into more places.</span>
<a name="l02893"></a>02893 <span class="comment">    * If s != &amp;not_found, s is a valid result string as follows:</span>
<a name="l02894"></a>02894 <span class="comment">    * s = NULL if the variable does not have a value;</span>
<a name="l02895"></a>02895 <span class="comment">    * you typically do this when looking for an unset predefined variable.</span>
<a name="l02896"></a>02896 <span class="comment">    * s = workspace if the result has been assembled there;</span>
<a name="l02897"></a>02897 <span class="comment">    * typically done when the result is built e.g. with an snprintf(),</span>
<a name="l02898"></a>02898 <span class="comment">    * so we don&apos;t need to do an additional copy.</span>
<a name="l02899"></a>02899 <span class="comment">    * s != workspace in case we have a string, that needs to be copied</span>
<a name="l02900"></a>02900 <span class="comment">    * (the ast_copy_string is done once for all at the end).</span>
<a name="l02901"></a>02901 <span class="comment">    * Typically done when the result is already available in some string.</span>
<a name="l02902"></a>02902 <span class="comment">    */</span>
<a name="l02903"></a>02903    s = &amp;not_found;   <span class="comment">/* default value */</span>
<a name="l02904"></a>02904    <span class="keywordflow">if</span> (c) { <span class="comment">/* This group requires a valid channel */</span>
<a name="l02905"></a>02905       <span class="comment">/* Names with common parts are looked up a piece at a time using strncmp. */</span>
<a name="l02906"></a>02906       <span class="keywordflow">if</span> (!strncmp(var, <span class="stringliteral">&quot;CALL&quot;</span>, 4)) {
<a name="l02907"></a>02907          <span class="keywordflow">if</span> (!strncmp(var + 4, <span class="stringliteral">&quot;ING&quot;</span>, 3)) {
<a name="l02908"></a>02908             <span class="keywordflow">if</span> (!strcmp(var + 7, <span class="stringliteral">&quot;PRES&quot;</span>)) {        <span class="comment">/* CALLINGPRES */</span>
<a name="l02909"></a>02909                snprintf(workspace, workspacelen, <span class="stringliteral">&quot;%d&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a5674af3fa5ce1dd1fe052be1477d4110">cid_pres</a>);
<a name="l02910"></a>02910                s = workspace;
<a name="l02911"></a>02911             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var + 7, <span class="stringliteral">&quot;ANI2&quot;</span>)) {    <span class="comment">/* CALLINGANI2 */</span>
<a name="l02912"></a>02912                snprintf(workspace, workspacelen, <span class="stringliteral">&quot;%d&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a9540aaac76be952860ef25d607eb33fb">cid_ani2</a>);
<a name="l02913"></a>02913                s = workspace;
<a name="l02914"></a>02914             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var + 7, <span class="stringliteral">&quot;TON&quot;</span>)) {     <span class="comment">/* CALLINGTON */</span>
<a name="l02915"></a>02915                snprintf(workspace, workspacelen, <span class="stringliteral">&quot;%d&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aff456ca48d31a9813584e799064cf88e">cid_ton</a>);
<a name="l02916"></a>02916                s = workspace;
<a name="l02917"></a>02917             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var + 7, <span class="stringliteral">&quot;TNS&quot;</span>)) {     <span class="comment">/* CALLINGTNS */</span>
<a name="l02918"></a>02918                snprintf(workspace, workspacelen, <span class="stringliteral">&quot;%d&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aae7e57d784da2bfe6b85cb36516edca0">cid_tns</a>);
<a name="l02919"></a>02919                s = workspace;
<a name="l02920"></a>02920             }
<a name="l02921"></a>02921          }
<a name="l02922"></a>02922       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var, <span class="stringliteral">&quot;HINT&quot;</span>)) {
<a name="l02923"></a>02923          s = <a class="code" href="pbx_8h.html#ac778ac642def88a06e5d59e11a964c43" title="If an extension hint exists, return non-zero.">ast_get_hint</a>(workspace, workspacelen, NULL, 0, c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>) ? workspace : NULL;
<a name="l02924"></a>02924       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var, <span class="stringliteral">&quot;HINTNAME&quot;</span>)) {
<a name="l02925"></a>02925          s = <a class="code" href="pbx_8h.html#ac778ac642def88a06e5d59e11a964c43" title="If an extension hint exists, return non-zero.">ast_get_hint</a>(NULL, 0, workspace, workspacelen, c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>) ? workspace : NULL;
<a name="l02926"></a>02926       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var, <span class="stringliteral">&quot;EXTEN&quot;</span>)) {
<a name="l02927"></a>02927          s = c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>;
<a name="l02928"></a>02928       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var, <span class="stringliteral">&quot;CONTEXT&quot;</span>)) {
<a name="l02929"></a>02929          s = c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l02930"></a>02930       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var, <span class="stringliteral">&quot;PRIORITY&quot;</span>)) {
<a name="l02931"></a>02931          snprintf(workspace, workspacelen, <span class="stringliteral">&quot;%d&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l02932"></a>02932          s = workspace;
<a name="l02933"></a>02933       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var, <span class="stringliteral">&quot;CHANNEL&quot;</span>)) {
<a name="l02934"></a>02934          s = c-&gt;name;
<a name="l02935"></a>02935       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var, <span class="stringliteral">&quot;UNIQUEID&quot;</span>)) {
<a name="l02936"></a>02936          s = c-&gt;uniqueid;
<a name="l02937"></a>02937       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var, <span class="stringliteral">&quot;HANGUPCAUSE&quot;</span>)) {
<a name="l02938"></a>02938          snprintf(workspace, workspacelen, <span class="stringliteral">&quot;%d&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a>);
<a name="l02939"></a>02939          s = workspace;
<a name="l02940"></a>02940       }
<a name="l02941"></a>02941    }
<a name="l02942"></a>02942    <span class="keywordflow">if</span> (s == &amp;not_found) { <span class="comment">/* look for more */</span>
<a name="l02943"></a>02943       <span class="keywordflow">if</span> (!strcmp(var, <span class="stringliteral">&quot;EPOCH&quot;</span>)) {
<a name="l02944"></a>02944          snprintf(workspace, workspacelen, <span class="stringliteral">&quot;%u&quot;</span>,(<span class="keywordtype">int</span>)time(NULL));
<a name="l02945"></a>02945          s = workspace;
<a name="l02946"></a>02946       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var, <span class="stringliteral">&quot;SYSTEMNAME&quot;</span>)) {
<a name="l02947"></a>02947          s = <a class="code" href="paths_8h.html#ab9f9346c7a41bdf3720f7b1ed02ec703">ast_config_AST_SYSTEM_NAME</a>;
<a name="l02948"></a>02948       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(var, <span class="stringliteral">&quot;ENTITYID&quot;</span>)) {
<a name="l02949"></a>02949          <a class="code" href="utils_8h.html#a8ebf6841073ea2a063a0c86a5092a85b">ast_eid_to_str</a>(workspace, workspacelen, &amp;<a class="code" href="utils_8h.html#ad5db11fa27352e2b9a3c669adc76955f" title="Global EID.">ast_eid_default</a>);
<a name="l02950"></a>02950          s = workspace;
<a name="l02951"></a>02951       }
<a name="l02952"></a>02952    }
<a name="l02953"></a>02953    <span class="comment">/* if not found, look into chanvars or global vars */</span>
<a name="l02954"></a>02954    <span class="keywordflow">for</span> (i = 0; s == &amp;not_found &amp;&amp; i &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(places); i++) {
<a name="l02955"></a>02955       <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *variables;
<a name="l02956"></a>02956       <span class="keywordflow">if</span> (!places[i])
<a name="l02957"></a>02957          <span class="keywordflow">continue</span>;
<a name="l02958"></a>02958       <span class="keywordflow">if</span> (places[i] == &amp;<a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a>)
<a name="l02959"></a>02959          <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l02960"></a>02960       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(places[i], variables, entries) {
<a name="l02961"></a>02961          <span class="keywordflow">if</span> (!strcasecmp(<a class="code" href="chanvars_8h.html#a356a31cd608ec07d3668dcd589be49d8">ast_var_name</a>(variables), var)) {
<a name="l02962"></a>02962             s = <a class="code" href="chanvars_8h.html#a8e0081172db71c5021d20706c50d959c">ast_var_value</a>(variables);
<a name="l02963"></a>02963             <span class="keywordflow">break</span>;
<a name="l02964"></a>02964          }
<a name="l02965"></a>02965       }
<a name="l02966"></a>02966       <span class="keywordflow">if</span> (places[i] == &amp;<a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a>)
<a name="l02967"></a>02967          <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l02968"></a>02968    }
<a name="l02969"></a>02969    <span class="keywordflow">if</span> (s == &amp;not_found || s == NULL)
<a name="l02970"></a>02970       *ret = NULL;
<a name="l02971"></a>02971    <span class="keywordflow">else</span> {
<a name="l02972"></a>02972       <span class="keywordflow">if</span> (s != workspace)
<a name="l02973"></a>02973          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(workspace, s, workspacelen);
<a name="l02974"></a>02974       *ret = workspace;
<a name="l02975"></a>02975       <span class="keywordflow">if</span> (need_substring)
<a name="l02976"></a>02976          *ret = <a class="code" href="pbx_8c.html#ac79353a3cba653bbeea7eabd8e4d073c" title="takes a substring. It is ok to call with value == workspace.">substring</a>(*ret, offset, length, workspace, workspacelen);
<a name="l02977"></a>02977    }
<a name="l02978"></a>02978 
<a name="l02979"></a>02979    <span class="keywordflow">if</span> (c)
<a name="l02980"></a>02980       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c);
<a name="l02981"></a>02981 }
<a name="l02982"></a>02982 
<a name="l02983"></a><a class="code" href="pbx_8c.html#a5f96a9ab4c6286c63c25ba5dee36c4ec">02983</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a5f96a9ab4c6286c63c25ba5dee36c4ec">exception_store_free</a>(<span class="keywordtype">void</span> *data)
<a name="l02984"></a>02984 {
<a name="l02985"></a>02985    <span class="keyword">struct </span><a class="code" href="structpbx__exception.html">pbx_exception</a> *exception = data;
<a name="l02986"></a>02986    <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(exception);
<a name="l02987"></a>02987    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(exception);
<a name="l02988"></a>02988 }
<a name="l02989"></a>02989 
<a name="l02990"></a><a class="code" href="pbx_8c.html#a805b54680c64fe964e8326102f6d540a">02990</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__datastore__info.html" title="Structure for a data store type.">ast_datastore_info</a> <a class="code" href="pbx_8c.html#a805b54680c64fe964e8326102f6d540a">exception_store_info</a> = {
<a name="l02991"></a>02991    .<a class="code" href="structast__datastore__info.html#a763fd8db6bba8fbbbc113ca0d61c47c2">type</a> = <span class="stringliteral">&quot;EXCEPTION&quot;</span>,
<a name="l02992"></a>02992    .destroy = <a class="code" href="pbx_8c.html#a5f96a9ab4c6286c63c25ba5dee36c4ec">exception_store_free</a>,
<a name="l02993"></a>02993 };
<a name="l02994"></a>02994 
<a name="l02995"></a><a class="code" href="pbx_8c.html#aa3b8dfc28304a77eee3596c6fa29810f">02995</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#abc705e1c806491af6419892a1237d920">pbx_builtin_raise_exception</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *vreason)
<a name="l02996"></a>02996 {
<a name="l02997"></a>02997    <span class="keyword">const</span> <span class="keywordtype">char</span> *reason = vreason;
<a name="l02998"></a>02998    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *ds = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;<a class="code" href="pbx_8c.html#a805b54680c64fe964e8326102f6d540a">exception_store_info</a>, NULL);
<a name="l02999"></a>02999    <span class="keyword">struct </span><a class="code" href="structpbx__exception.html">pbx_exception</a> *exception = NULL;
<a name="l03000"></a>03000 
<a name="l03001"></a>03001    <span class="keywordflow">if</span> (!ds) {
<a name="l03002"></a>03002       ds = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="pbx_8c.html#a805b54680c64fe964e8326102f6d540a">exception_store_info</a>, NULL);
<a name="l03003"></a>03003       <span class="keywordflow">if</span> (!ds)
<a name="l03004"></a>03004          <span class="keywordflow">return</span> -1;
<a name="l03005"></a>03005       exception = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structpbx__exception.html">pbx_exception</a>));
<a name="l03006"></a>03006       <span class="keywordflow">if</span> (!exception) {
<a name="l03007"></a>03007          <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(ds);
<a name="l03008"></a>03008          <span class="keywordflow">return</span> -1;
<a name="l03009"></a>03009       }
<a name="l03010"></a>03010       <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(exception, 128)) {
<a name="l03011"></a>03011          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(exception);
<a name="l03012"></a>03012          <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(ds);
<a name="l03013"></a>03013          <span class="keywordflow">return</span> -1;
<a name="l03014"></a>03014       }
<a name="l03015"></a>03015       ds-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = exception;
<a name="l03016"></a>03016       <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(chan, ds);
<a name="l03017"></a>03017    } <span class="keywordflow">else</span>
<a name="l03018"></a>03018       exception = ds-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l03019"></a>03019 
<a name="l03020"></a>03020    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(exception, reason, reason);
<a name="l03021"></a>03021    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(exception, context, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l03022"></a>03022    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(exception, exten, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>);
<a name="l03023"></a>03023    exception-&gt;<a class="code" href="structpbx__exception.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>;
<a name="l03024"></a>03024    <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(chan, <span class="stringliteral">&quot;e&quot;</span>, 0);
<a name="l03025"></a>03025    <span class="keywordflow">return</span> 0;
<a name="l03026"></a>03026 }
<a name="l03027"></a>03027 
<a name="l03028"></a><a class="code" href="pbx_8c.html#a28214486cef68144f99f63097be8a1d5">03028</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a28214486cef68144f99f63097be8a1d5">acf_exception_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> buflen)
<a name="l03029"></a>03029 {
<a name="l03030"></a>03030    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *ds = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;<a class="code" href="pbx_8c.html#a805b54680c64fe964e8326102f6d540a">exception_store_info</a>, NULL);
<a name="l03031"></a>03031    <span class="keyword">struct </span><a class="code" href="structpbx__exception.html">pbx_exception</a> *exception = NULL;
<a name="l03032"></a>03032    <span class="keywordflow">if</span> (!ds || !ds-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>)
<a name="l03033"></a>03033       <span class="keywordflow">return</span> -1;
<a name="l03034"></a>03034    exception = ds-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l03035"></a>03035    <span class="keywordflow">if</span> (!strcasecmp(data, <span class="stringliteral">&quot;REASON&quot;</span>))
<a name="l03036"></a>03036       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, exception-&gt;<a class="code" href="structpbx__exception.html#af9968f5aac9a0d889c0506368ea1e649">reason</a>, buflen);
<a name="l03037"></a>03037    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(data, <span class="stringliteral">&quot;CONTEXT&quot;</span>))
<a name="l03038"></a>03038       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, exception-&gt;<a class="code" href="structpbx__exception.html#a7faec841658b88ad0cfbc684853acad3">context</a>, buflen);
<a name="l03039"></a>03039    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(data, <span class="stringliteral">&quot;EXTEN&quot;</span>, 5))
<a name="l03040"></a>03040       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, exception-&gt;<a class="code" href="structpbx__exception.html#aaee31f4cc48985167efcd38ab252dac8">exten</a>, buflen);
<a name="l03041"></a>03041    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(data, <span class="stringliteral">&quot;PRIORITY&quot;</span>))
<a name="l03042"></a>03042       snprintf(buf, buflen, <span class="stringliteral">&quot;%d&quot;</span>, exception-&gt;<a class="code" href="structpbx__exception.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l03043"></a>03043    <span class="keywordflow">else</span>
<a name="l03044"></a>03044       <span class="keywordflow">return</span> -1;
<a name="l03045"></a>03045    <span class="keywordflow">return</span> 0;
<a name="l03046"></a>03046 }
<a name="l03047"></a>03047 
<a name="l03048"></a><a class="code" href="pbx_8c.html#ae51d2f255e1f2ea7fb24e6033a9cba94">03048</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="pbx_8c.html#ae51d2f255e1f2ea7fb24e6033a9cba94">exception_function</a> = {
<a name="l03049"></a>03049    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;EXCEPTION&quot;</span>,
<a name="l03050"></a>03050    .read = <a class="code" href="pbx_8c.html#a28214486cef68144f99f63097be8a1d5">acf_exception_read</a>,
<a name="l03051"></a>03051 };
<a name="l03052"></a>03052 
<a name="l03053"></a><a class="code" href="pbx_8c.html#acfa4ef71bd45e5cb9fa95ea3564ce3fb">03053</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#acfa4ef71bd45e5cb9fa95ea3564ce3fb">handle_show_functions</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l03054"></a>03054 {
<a name="l03055"></a>03055    <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> *acf;
<a name="l03056"></a>03056    <span class="keywordtype">int</span> count_acf = 0;
<a name="l03057"></a>03057    <span class="keywordtype">int</span> like = 0;
<a name="l03058"></a>03058 
<a name="l03059"></a>03059    <span class="keywordflow">switch</span> (cmd) {
<a name="l03060"></a>03060    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03061"></a>03061       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show functions [like]&quot;</span>;
<a name="l03062"></a>03062       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03063"></a>03063          <span class="stringliteral">&quot;Usage: core show functions [like &lt;text&gt;]\n&quot;</span>
<a name="l03064"></a>03064          <span class="stringliteral">&quot;       List builtin functions, optionally only those matching a given string\n&quot;</span>;
<a name="l03065"></a>03065       <span class="keywordflow">return</span> NULL;
<a name="l03066"></a>03066    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03067"></a>03067       <span class="keywordflow">return</span> NULL;
<a name="l03068"></a>03068    }
<a name="l03069"></a>03069 
<a name="l03070"></a>03070    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 5 &amp;&amp; (!strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;like&quot;</span>)) ) {
<a name="l03071"></a>03071       like = 1;
<a name="l03072"></a>03072    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3) {
<a name="l03073"></a>03073       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l03074"></a>03074    }
<a name="l03075"></a>03075 
<a name="l03076"></a>03076    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s Custom Functions:\n--------------------------------------------------------------------------------\n&quot;</span>, like ? <span class="stringliteral">&quot;Matching&quot;</span> : <span class="stringliteral">&quot;Installed&quot;</span>);
<a name="l03077"></a>03077 
<a name="l03078"></a>03078    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>);
<a name="l03079"></a>03079    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>, acf, <a class="code" href="structast__custom__function.html#afdf1f4a1680938ef9b90fbe3ecafbca4">acflist</a>) {
<a name="l03080"></a>03080       <span class="keywordflow">if</span> (!like || strstr(acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4])) {
<a name="l03081"></a>03081          count_acf++;
<a name="l03082"></a>03082          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-20.20s  %-35.35s  %s\n&quot;</span>,
<a name="l03083"></a>03083             <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;&quot;</span>),
<a name="l03084"></a>03084             <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;syntax, <span class="stringliteral">&quot;&quot;</span>),
<a name="l03085"></a>03085             <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;synopsis, <span class="stringliteral">&quot;&quot;</span>));
<a name="l03086"></a>03086       }
<a name="l03087"></a>03087    }
<a name="l03088"></a>03088    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>);
<a name="l03089"></a>03089 
<a name="l03090"></a>03090    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d %scustom functions installed.\n&quot;</span>, count_acf, like ? <span class="stringliteral">&quot;matching &quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l03091"></a>03091 
<a name="l03092"></a>03092    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03093"></a>03093 }
<a name="l03094"></a>03094 
<a name="l03095"></a><a class="code" href="pbx_8c.html#ab517469d7957ff803505b3390a3edaa0">03095</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#ab517469d7957ff803505b3390a3edaa0">handle_show_function</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l03096"></a>03096 {
<a name="l03097"></a>03097    <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> *acf;
<a name="l03098"></a>03098    <span class="comment">/* Maximum number of characters added by terminal coloring is 22 */</span>
<a name="l03099"></a>03099    <span class="keywordtype">char</span> infotitle[64 + <a class="code" href="pbx_8h.html#a3414b82af9b33fe907c9377c5c73c453">AST_MAX_APP</a> + 22], syntitle[40], destitle[40], argtitle[40], seealsotitle[40];
<a name="l03100"></a>03100    <span class="keywordtype">char</span> info[64 + <a class="code" href="pbx_8h.html#a3414b82af9b33fe907c9377c5c73c453">AST_MAX_APP</a>], *<a class="code" href="app__externalivr_8c.html#afa26529a1480355101f5b6d883a7d37e">synopsis</a> = NULL, *<a class="code" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = NULL, *seealso = NULL;
<a name="l03101"></a>03101    <span class="keywordtype">char</span> stxtitle[40], *syntax = NULL, *arguments = NULL;
<a name="l03102"></a>03102    <span class="keywordtype">int</span> syntax_size, description_size, synopsis_size, arguments_size, seealso_size;
<a name="l03103"></a>03103    <span class="keywordtype">char</span> *ret = NULL;
<a name="l03104"></a>03104    <span class="keywordtype">int</span> which = 0;
<a name="l03105"></a>03105    <span class="keywordtype">int</span> wordlen;
<a name="l03106"></a>03106 
<a name="l03107"></a>03107    <span class="keywordflow">switch</span> (cmd) {
<a name="l03108"></a>03108    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03109"></a>03109       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show function&quot;</span>;
<a name="l03110"></a>03110       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03111"></a>03111          <span class="stringliteral">&quot;Usage: core show function &lt;function&gt;\n&quot;</span>
<a name="l03112"></a>03112          <span class="stringliteral">&quot;       Describe a particular dialplan function.\n&quot;</span>;
<a name="l03113"></a>03113       <span class="keywordflow">return</span> NULL;
<a name="l03114"></a>03114    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03115"></a>03115       wordlen = strlen(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>);
<a name="l03116"></a>03116       <span class="comment">/* case-insensitive for convenience in this &apos;complete&apos; function */</span>
<a name="l03117"></a>03117       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>);
<a name="l03118"></a>03118       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>, acf, <a class="code" href="structast__custom__function.html#afdf1f4a1680938ef9b90fbe3ecafbca4">acflist</a>) {
<a name="l03119"></a>03119          <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, wordlen) &amp;&amp; ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>) {
<a name="l03120"></a>03120             ret = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03121"></a>03121             <span class="keywordflow">break</span>;
<a name="l03122"></a>03122          }
<a name="l03123"></a>03123       }
<a name="l03124"></a>03124       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>);
<a name="l03125"></a>03125 
<a name="l03126"></a>03126       <span class="keywordflow">return</span> ret;
<a name="l03127"></a>03127    }
<a name="l03128"></a>03128 
<a name="l03129"></a>03129    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 4) {
<a name="l03130"></a>03130       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l03131"></a>03131    }
<a name="l03132"></a>03132 
<a name="l03133"></a>03133    <span class="keywordflow">if</span> (!(acf = <a class="code" href="pbx_8h.html#a5e0f8c2ce2a3c8994648254799a0c3b7">ast_custom_function_find</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]))) {
<a name="l03134"></a>03134       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No function by that name registered.\n&quot;</span>);
<a name="l03135"></a>03135       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l03136"></a>03136    }
<a name="l03137"></a>03137 
<a name="l03138"></a>03138    syntax_size = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;syntax, <span class="stringliteral">&quot;Not Available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l03139"></a>03139    <span class="keywordflow">if</span> (!(syntax = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(syntax_size))) {
<a name="l03140"></a>03140       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Memory allocation failure!\n&quot;</span>);
<a name="l03141"></a>03141       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l03142"></a>03142    }
<a name="l03143"></a>03143 
<a name="l03144"></a>03144    snprintf(info, <span class="keyword">sizeof</span>(info), <span class="stringliteral">&quot;\n  -= Info about function &apos;%s&apos; =- \n\n&quot;</span>, acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03145"></a>03145    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(infotitle, info, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, <span class="keyword">sizeof</span>(infotitle));
<a name="l03146"></a>03146    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(syntitle, <span class="stringliteral">&quot;[Synopsis]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, 40);
<a name="l03147"></a>03147    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(destitle, <span class="stringliteral">&quot;[Description]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, 40);
<a name="l03148"></a>03148    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(stxtitle, <span class="stringliteral">&quot;[Syntax]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, 40);
<a name="l03149"></a>03149    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(argtitle, <span class="stringliteral">&quot;[Arguments]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, 40);
<a name="l03150"></a>03150    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(seealsotitle, <span class="stringliteral">&quot;[See Also]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, 40);
<a name="l03151"></a>03151    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(syntax, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;syntax, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, syntax_size);
<a name="l03152"></a>03152 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l03153"></a>03153 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (acf-&gt;<a class="code" href="structast__custom__function.html#aa871ca3c361d229d4e37edf3c6016cc1">docsrc</a> == <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3a24212840b7b1b0e9c1eebc8cfd89ab3e">AST_XML_DOC</a>) {
<a name="l03154"></a>03154       arguments = <a class="code" href="xmldoc_8h.html#a637de870dfc83d0694f588c5a814ce38" title="Colorize and put delimiters (instead of tags) to the xmldoc output.">ast_xmldoc_printable</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;arguments, <span class="stringliteral">&quot;Not available&quot;</span>), 1);
<a name="l03155"></a>03155       synopsis = <a class="code" href="xmldoc_8h.html#a637de870dfc83d0694f588c5a814ce38" title="Colorize and put delimiters (instead of tags) to the xmldoc output.">ast_xmldoc_printable</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;synopsis, <span class="stringliteral">&quot;Not available&quot;</span>), 1);
<a name="l03156"></a>03156       description = <a class="code" href="xmldoc_8h.html#a637de870dfc83d0694f588c5a814ce38" title="Colorize and put delimiters (instead of tags) to the xmldoc output.">ast_xmldoc_printable</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;desc, <span class="stringliteral">&quot;Not available&quot;</span>), 1);
<a name="l03157"></a>03157       seealso = <a class="code" href="xmldoc_8h.html#a637de870dfc83d0694f588c5a814ce38" title="Colorize and put delimiters (instead of tags) to the xmldoc output.">ast_xmldoc_printable</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;seealso, <span class="stringliteral">&quot;Not available&quot;</span>), 1);
<a name="l03158"></a>03158    } <span class="keywordflow">else</span>
<a name="l03159"></a>03159 <span class="preprocessor">#endif</span>
<a name="l03160"></a>03160 <span class="preprocessor"></span>   {
<a name="l03161"></a>03161       synopsis_size = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;synopsis, <span class="stringliteral">&quot;Not Available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l03162"></a>03162       synopsis = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(synopsis_size);
<a name="l03163"></a>03163 
<a name="l03164"></a>03164       description_size = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;desc, <span class="stringliteral">&quot;Not Available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l03165"></a>03165       description = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(description_size);
<a name="l03166"></a>03166 
<a name="l03167"></a>03167       arguments_size = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;arguments, <span class="stringliteral">&quot;Not Available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l03168"></a>03168       arguments = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(arguments_size);
<a name="l03169"></a>03169 
<a name="l03170"></a>03170       seealso_size = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;seealso, <span class="stringliteral">&quot;Not Available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l03171"></a>03171       seealso = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(seealso_size);
<a name="l03172"></a>03172 
<a name="l03173"></a>03173       <span class="comment">/* check allocated memory. */</span>
<a name="l03174"></a>03174       <span class="keywordflow">if</span> (!synopsis || !description || !arguments || !seealso) {
<a name="l03175"></a>03175          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(synopsis);
<a name="l03176"></a>03176          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(description);
<a name="l03177"></a>03177          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(arguments);
<a name="l03178"></a>03178          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(seealso);
<a name="l03179"></a>03179          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(syntax);
<a name="l03180"></a>03180          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l03181"></a>03181       }
<a name="l03182"></a>03182 
<a name="l03183"></a>03183       <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(arguments, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;arguments, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, arguments_size);
<a name="l03184"></a>03184       <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(synopsis, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;synopsis, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, synopsis_size);
<a name="l03185"></a>03185       <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(description, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;desc, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, description_size);
<a name="l03186"></a>03186       <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(seealso, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acf-&gt;seealso, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, seealso_size);
<a name="l03187"></a>03187    }
<a name="l03188"></a>03188 
<a name="l03189"></a>03189    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s%s%s\n\n%s%s\n\n%s%s\n\n%s%s\n\n%s%s\n&quot;</span>,
<a name="l03190"></a>03190          infotitle, syntitle, synopsis, destitle, description,
<a name="l03191"></a>03191          stxtitle, syntax, argtitle, arguments, seealsotitle, seealso);
<a name="l03192"></a>03192 
<a name="l03193"></a>03193    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(arguments);
<a name="l03194"></a>03194    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(synopsis);
<a name="l03195"></a>03195    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(description);
<a name="l03196"></a>03196    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(seealso);
<a name="l03197"></a>03197    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(syntax);
<a name="l03198"></a>03198 
<a name="l03199"></a>03199    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03200"></a>03200 }
<a name="l03201"></a>03201 
<a name="l03202"></a><a class="code" href="pbx_8c.html#a5e0f8c2ce2a3c8994648254799a0c3b7">03202</a> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> *<a class="code" href="pbx_8h.html#a5e0f8c2ce2a3c8994648254799a0c3b7">ast_custom_function_find</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l03203"></a>03203 {
<a name="l03204"></a>03204    <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> *acf = NULL;
<a name="l03205"></a>03205 
<a name="l03206"></a>03206    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>);
<a name="l03207"></a>03207    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>, acf, <a class="code" href="structast__custom__function.html#afdf1f4a1680938ef9b90fbe3ecafbca4">acflist</a>) {
<a name="l03208"></a>03208       <span class="keywordflow">if</span> (!strcmp(name, acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>))
<a name="l03209"></a>03209          <span class="keywordflow">break</span>;
<a name="l03210"></a>03210    }
<a name="l03211"></a>03211    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>);
<a name="l03212"></a>03212 
<a name="l03213"></a>03213    <span class="keywordflow">return</span> acf;
<a name="l03214"></a>03214 }
<a name="l03215"></a>03215 
<a name="l03216"></a><a class="code" href="pbx_8c.html#a965977ea9a3144bc203e0ce7a64680a1">03216</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(<span class="keyword">struct</span> <a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> *acf)
<a name="l03217"></a>03217 {
<a name="l03218"></a>03218    <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> *cur;
<a name="l03219"></a>03219 
<a name="l03220"></a>03220    <span class="keywordflow">if</span> (!acf) {
<a name="l03221"></a>03221       <span class="keywordflow">return</span> -1;
<a name="l03222"></a>03222    }
<a name="l03223"></a>03223 
<a name="l03224"></a>03224    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>);
<a name="l03225"></a>03225    <span class="keywordflow">if</span> ((cur = <a class="code" href="linkedlists_8h.html#a6091f0518f8b6f443fd9f5150f3ac407">AST_RWLIST_REMOVE</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>, acf, <a class="code" href="structast__custom__function.html#afdf1f4a1680938ef9b90fbe3ecafbca4">acflist</a>))) {
<a name="l03226"></a>03226       <span class="keywordflow">if</span> (cur-&gt;<a class="code" href="structast__custom__function.html#aa871ca3c361d229d4e37edf3c6016cc1">docsrc</a> == <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3a24212840b7b1b0e9c1eebc8cfd89ab3e">AST_XML_DOC</a>) {
<a name="l03227"></a>03227          <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(acf);
<a name="l03228"></a>03228       }
<a name="l03229"></a>03229       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Unregistered custom function %s\n&quot;</span>, cur-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03230"></a>03230    }
<a name="l03231"></a>03231    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>);
<a name="l03232"></a>03232 
<a name="l03233"></a>03233    <span class="keywordflow">return</span> cur ? 0 : -1;
<a name="l03234"></a>03234 }
<a name="l03235"></a>03235 <span class="comment"></span>
<a name="l03236"></a>03236 <span class="comment">/*! \internal</span>
<a name="l03237"></a>03237 <span class="comment"> *  \brief Retrieve the XML documentation of a specified ast_custom_function,</span>
<a name="l03238"></a>03238 <span class="comment"> *         and populate ast_custom_function string fields.</span>
<a name="l03239"></a>03239 <span class="comment"> *  \param acf ast_custom_function structure with empty &apos;desc&apos; and &apos;synopsis&apos;</span>
<a name="l03240"></a>03240 <span class="comment"> *             but with a function &apos;name&apos;.</span>
<a name="l03241"></a>03241 <span class="comment"> *  \retval -1 On error.</span>
<a name="l03242"></a>03242 <span class="comment"> *  \retval 0 On succes.</span>
<a name="l03243"></a>03243 <span class="comment"> */</span>
<a name="l03244"></a><a class="code" href="pbx_8c.html#a65ccacb4a7ea0a0b3a043beb8b9c4cb2">03244</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a65ccacb4a7ea0a0b3a043beb8b9c4cb2">acf_retrieve_docs</a>(<span class="keyword">struct</span> <a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> *acf)
<a name="l03245"></a>03245 {
<a name="l03246"></a>03246 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l03247"></a>03247 <span class="preprocessor"></span>   <span class="keywordtype">char</span> *tmpxml;
<a name="l03248"></a>03248 
<a name="l03249"></a>03249    <span class="comment">/* Let&apos;s try to find it in the Documentation XML */</span>
<a name="l03250"></a>03250    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(acf-&gt;desc) || !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(acf-&gt;synopsis)) {
<a name="l03251"></a>03251       <span class="keywordflow">return</span> 0;
<a name="l03252"></a>03252    }
<a name="l03253"></a>03253 
<a name="l03254"></a>03254    <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(acf, 128)) {
<a name="l03255"></a>03255       <span class="keywordflow">return</span> -1;
<a name="l03256"></a>03256    }
<a name="l03257"></a>03257 
<a name="l03258"></a>03258    <span class="comment">/* load synopsis */</span>
<a name="l03259"></a>03259    tmpxml = <a class="code" href="xmldoc_8h.html#a92ab99fc2fa8a31c591531b36d391e3f" title="Generate synopsis documentation from XML.">ast_xmldoc_build_synopsis</a>(<span class="stringliteral">&quot;function&quot;</span>, acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03260"></a>03260    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(acf, <a class="code" href="app__externalivr_8c.html#afa26529a1480355101f5b6d883a7d37e">synopsis</a>, tmpxml);
<a name="l03261"></a>03261    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmpxml);
<a name="l03262"></a>03262 
<a name="l03263"></a>03263    <span class="comment">/* load description */</span>
<a name="l03264"></a>03264    tmpxml = <a class="code" href="xmldoc_8h.html#a7e6109ee5ae553d1fb3b6e7a7c4617f9" title="Generate description documentation from XML.">ast_xmldoc_build_description</a>(<span class="stringliteral">&quot;function&quot;</span>, acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03265"></a>03265    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(acf, <a class="code" href="channel_8c.html#a710bce51374aba96ab04912897666c35">desc</a>, tmpxml);
<a name="l03266"></a>03266    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmpxml);
<a name="l03267"></a>03267 
<a name="l03268"></a>03268    <span class="comment">/* load syntax */</span>
<a name="l03269"></a>03269    tmpxml = <a class="code" href="xmldoc_8h.html#a54a5b2e3ff1b6b6f06d9bab70e70c924" title="Get the syntax for a specified application or function.">ast_xmldoc_build_syntax</a>(<span class="stringliteral">&quot;function&quot;</span>, acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03270"></a>03270    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(acf, syntax, tmpxml);
<a name="l03271"></a>03271    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmpxml);
<a name="l03272"></a>03272 
<a name="l03273"></a>03273    <span class="comment">/* load arguments */</span>
<a name="l03274"></a>03274    tmpxml = <a class="code" href="xmldoc_8h.html#a54ea6bbcddbb8ef17051136a73227847" title="Generate the [arguments] tag based on type of node (&amp;#39;application&amp;#39;, &amp;#39;function&amp;#39;...">ast_xmldoc_build_arguments</a>(<span class="stringliteral">&quot;function&quot;</span>, acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03275"></a>03275    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(acf, arguments, tmpxml);
<a name="l03276"></a>03276    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmpxml);
<a name="l03277"></a>03277 
<a name="l03278"></a>03278    <span class="comment">/* load seealso */</span>
<a name="l03279"></a>03279    tmpxml = <a class="code" href="xmldoc_8h.html#a51987b5bfa995cc9b76c81dd1a1d6ad4" title="Parse the &amp;lt;see-also&amp;gt; node content.">ast_xmldoc_build_seealso</a>(<span class="stringliteral">&quot;function&quot;</span>, acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03280"></a>03280    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(acf, seealso, tmpxml);
<a name="l03281"></a>03281    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmpxml);
<a name="l03282"></a>03282 
<a name="l03283"></a>03283    acf-&gt;<a class="code" href="structast__custom__function.html#aa871ca3c361d229d4e37edf3c6016cc1">docsrc</a> = <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3a24212840b7b1b0e9c1eebc8cfd89ab3e">AST_XML_DOC</a>;
<a name="l03284"></a>03284 <span class="preprocessor">#endif</span>
<a name="l03285"></a>03285 <span class="preprocessor"></span>
<a name="l03286"></a>03286    <span class="keywordflow">return</span> 0;
<a name="l03287"></a>03287 }
<a name="l03288"></a>03288 
<a name="l03289"></a><a class="code" href="pbx_8c.html#aad8771c7e3b2170a749946f1a8b758aa">03289</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aad8771c7e3b2170a749946f1a8b758aa" title="Register a custom function.">__ast_custom_function_register</a>(<span class="keyword">struct</span> <a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> *acf, <span class="keyword">struct</span> <a class="code" href="structast__module.html">ast_module</a> *<a class="code" href="structast__custom__function.html#a782aff512368932b8d71b3633f88cb04">mod</a>)
<a name="l03290"></a>03290 {
<a name="l03291"></a>03291    <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> *cur;
<a name="l03292"></a>03292    <span class="keywordtype">char</span> tmps[80];
<a name="l03293"></a>03293 
<a name="l03294"></a>03294    <span class="keywordflow">if</span> (!acf) {
<a name="l03295"></a>03295       <span class="keywordflow">return</span> -1;
<a name="l03296"></a>03296    }
<a name="l03297"></a>03297 
<a name="l03298"></a>03298    acf-&gt;<a class="code" href="structast__custom__function.html#a782aff512368932b8d71b3633f88cb04">mod</a> = mod;
<a name="l03299"></a>03299    acf-&gt;<a class="code" href="structast__custom__function.html#aa871ca3c361d229d4e37edf3c6016cc1">docsrc</a> = <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3a7273ed64a1fd4a93692986eac376124a">AST_STATIC_DOC</a>;
<a name="l03300"></a>03300 
<a name="l03301"></a>03301    <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#a65ccacb4a7ea0a0b3a043beb8b9c4cb2">acf_retrieve_docs</a>(acf)) {
<a name="l03302"></a>03302       <span class="keywordflow">return</span> -1;
<a name="l03303"></a>03303    }
<a name="l03304"></a>03304 
<a name="l03305"></a>03305    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>);
<a name="l03306"></a>03306 
<a name="l03307"></a>03307    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>, cur, <a class="code" href="structast__custom__function.html#afdf1f4a1680938ef9b90fbe3ecafbca4">acflist</a>) {
<a name="l03308"></a>03308       <span class="keywordflow">if</span> (!strcmp(acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, cur-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)) {
<a name="l03309"></a>03309          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Function %s already registered.\n&quot;</span>, acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03310"></a>03310          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>);
<a name="l03311"></a>03311          <span class="keywordflow">return</span> -1;
<a name="l03312"></a>03312       }
<a name="l03313"></a>03313    }
<a name="l03314"></a>03314 
<a name="l03315"></a>03315    <span class="comment">/* Store in alphabetical order */</span>
<a name="l03316"></a>03316    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>, cur, <a class="code" href="structast__custom__function.html#afdf1f4a1680938ef9b90fbe3ecafbca4">acflist</a>) {
<a name="l03317"></a>03317       <span class="keywordflow">if</span> (strcasecmp(acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, cur-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>) &lt; 0) {
<a name="l03318"></a>03318          <a class="code" href="linkedlists_8h.html#acf8253a64f9a4e2170454f4bf0559e33">AST_RWLIST_INSERT_BEFORE_CURRENT</a>(acf, <a class="code" href="structast__custom__function.html#afdf1f4a1680938ef9b90fbe3ecafbca4">acflist</a>);
<a name="l03319"></a>03319          <span class="keywordflow">break</span>;
<a name="l03320"></a>03320       }
<a name="l03321"></a>03321    }
<a name="l03322"></a>03322    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l03323"></a>03323 
<a name="l03324"></a>03324    <span class="keywordflow">if</span> (!cur) {
<a name="l03325"></a>03325       <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>, acf, <a class="code" href="structast__custom__function.html#afdf1f4a1680938ef9b90fbe3ecafbca4">acflist</a>);
<a name="l03326"></a>03326    }
<a name="l03327"></a>03327 
<a name="l03328"></a>03328    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structacf__root.html">acf_root</a>);
<a name="l03329"></a>03329 
<a name="l03330"></a>03330    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Registered custom function &apos;%s&apos;\n&quot;</span>, <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmps, acf-&gt;<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <a class="code" href="term_8h.html#a23aeefae76b2cacc1a6162de88c3fff0">COLOR_BRCYAN</a>, 0, <span class="keyword">sizeof</span>(tmps)));
<a name="l03331"></a>03331 
<a name="l03332"></a>03332    <span class="keywordflow">return</span> 0;
<a name="l03333"></a>03333 }
<a name="l03334"></a>03334 <span class="comment"></span>
<a name="l03335"></a>03335 <span class="comment">/*! \brief return a pointer to the arguments of the function,</span>
<a name="l03336"></a>03336 <span class="comment"> * and terminates the function name with &apos;\\0&apos;</span>
<a name="l03337"></a>03337 <span class="comment"> */</span>
<a name="l03338"></a><a class="code" href="pbx_8c.html#a2d0f37f8baa5d6fcf93cf4fab6342c36">03338</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a2d0f37f8baa5d6fcf93cf4fab6342c36" title="return a pointer to the arguments of the function, and terminates the function name...">func_args</a>(<span class="keywordtype">char</span> *function)
<a name="l03339"></a>03339 {
<a name="l03340"></a>03340    <span class="keywordtype">char</span> *args = strchr(function, <span class="charliteral">&apos;(&apos;</span>);
<a name="l03341"></a>03341 
<a name="l03342"></a>03342    <span class="keywordflow">if</span> (!args) {
<a name="l03343"></a>03343       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Function &apos;%s&apos; doesn&apos;t contain parentheses.  Assuming null argument.\n&quot;</span>, function);
<a name="l03344"></a>03344    } <span class="keywordflow">else</span> {
<a name="l03345"></a>03345       <span class="keywordtype">char</span> *p;
<a name="l03346"></a>03346       *args++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03347"></a>03347       <span class="keywordflow">if</span> ((p = strrchr(args, <span class="charliteral">&apos;)&apos;</span>))) {
<a name="l03348"></a>03348          *p = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03349"></a>03349       } <span class="keywordflow">else</span> {
<a name="l03350"></a>03350          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t find trailing parenthesis for function &apos;%s(%s&apos;?\n&quot;</span>, function, args);
<a name="l03351"></a>03351       }
<a name="l03352"></a>03352    }
<a name="l03353"></a>03353    <span class="keywordflow">return</span> args;
<a name="l03354"></a>03354 }
<a name="l03355"></a>03355 
<a name="l03356"></a><a class="code" href="pbx_8c.html#aa4e9618aa036a586af7d7663afd9b507">03356</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aa4e9618aa036a586af7d7663afd9b507" title="executes a read operation on a function">ast_func_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *function, <span class="keywordtype">char</span> *workspace, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l03357"></a>03357 {
<a name="l03358"></a>03358    <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531" title="Utility function to copy a file.">copy</a> = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(function);
<a name="l03359"></a>03359    <span class="keywordtype">char</span> *args = <a class="code" href="pbx_8c.html#a2d0f37f8baa5d6fcf93cf4fab6342c36" title="return a pointer to the arguments of the function, and terminates the function name...">func_args</a>(copy);
<a name="l03360"></a>03360    <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> *acfptr = <a class="code" href="pbx_8h.html#a5e0f8c2ce2a3c8994648254799a0c3b7">ast_custom_function_find</a>(copy);
<a name="l03361"></a>03361 
<a name="l03362"></a>03362    <span class="keywordflow">if</span> (acfptr == NULL)
<a name="l03363"></a>03363       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Function %s not registered\n&quot;</span>, copy);
<a name="l03364"></a>03364    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!acfptr-&gt;<a class="code" href="structast__custom__function.html#a0e793527a2a61bb88fa61f3a7c88b65f">read</a>)
<a name="l03365"></a>03365       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Function %s cannot be read\n&quot;</span>, copy);
<a name="l03366"></a>03366    <span class="keywordflow">else</span> {
<a name="l03367"></a>03367       <span class="keywordtype">int</span> res;
<a name="l03368"></a>03368       <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u = NULL;
<a name="l03369"></a>03369       <span class="keywordflow">if</span> (acfptr-&gt;<a class="code" href="structast__custom__function.html#a782aff512368932b8d71b3633f88cb04">mod</a>)
<a name="l03370"></a>03370          u = <a class="code" href="module_8h.html#ad315d50d0a7d61cb9feac19223fff8c0">__ast_module_user_add</a>(acfptr-&gt;<a class="code" href="structast__custom__function.html#a782aff512368932b8d71b3633f88cb04">mod</a>, chan);
<a name="l03371"></a>03371       res = acfptr-&gt;<a class="code" href="structast__custom__function.html#a0e793527a2a61bb88fa61f3a7c88b65f">read</a>(chan, copy, args, workspace, len);
<a name="l03372"></a>03372       <span class="keywordflow">if</span> (acfptr-&gt;<a class="code" href="structast__custom__function.html#a782aff512368932b8d71b3633f88cb04">mod</a> &amp;&amp; u)
<a name="l03373"></a>03373          <a class="code" href="module_8h.html#aee5ac94e279928d1d1f7b6aafb62ec7a">__ast_module_user_remove</a>(acfptr-&gt;<a class="code" href="structast__custom__function.html#a782aff512368932b8d71b3633f88cb04">mod</a>, u);
<a name="l03374"></a>03374       <span class="keywordflow">return</span> res;
<a name="l03375"></a>03375    }
<a name="l03376"></a>03376    <span class="keywordflow">return</span> -1;
<a name="l03377"></a>03377 }
<a name="l03378"></a>03378 
<a name="l03379"></a><a class="code" href="pbx_8c.html#ae70e64cdf669396c88ea8eda900b0b3b">03379</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#ae70e64cdf669396c88ea8eda900b0b3b" title="executes a write operation on a function">ast_func_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *function, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l03380"></a>03380 {
<a name="l03381"></a>03381    <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531" title="Utility function to copy a file.">copy</a> = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(function);
<a name="l03382"></a>03382    <span class="keywordtype">char</span> *args = <a class="code" href="pbx_8c.html#a2d0f37f8baa5d6fcf93cf4fab6342c36" title="return a pointer to the arguments of the function, and terminates the function name...">func_args</a>(copy);
<a name="l03383"></a>03383    <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> *acfptr = <a class="code" href="pbx_8h.html#a5e0f8c2ce2a3c8994648254799a0c3b7">ast_custom_function_find</a>(copy);
<a name="l03384"></a>03384 
<a name="l03385"></a>03385    <span class="keywordflow">if</span> (acfptr == NULL)
<a name="l03386"></a>03386       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Function %s not registered\n&quot;</span>, copy);
<a name="l03387"></a>03387    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!acfptr-&gt;<a class="code" href="structast__custom__function.html#a1d0ca9a282b63162660f551d833f57cf">write</a>)
<a name="l03388"></a>03388       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Function %s cannot be written to\n&quot;</span>, copy);
<a name="l03389"></a>03389    <span class="keywordflow">else</span> {
<a name="l03390"></a>03390       <span class="keywordtype">int</span> res;
<a name="l03391"></a>03391       <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u = NULL;
<a name="l03392"></a>03392       <span class="keywordflow">if</span> (acfptr-&gt;<a class="code" href="structast__custom__function.html#a782aff512368932b8d71b3633f88cb04">mod</a>)
<a name="l03393"></a>03393          u = <a class="code" href="module_8h.html#ad315d50d0a7d61cb9feac19223fff8c0">__ast_module_user_add</a>(acfptr-&gt;<a class="code" href="structast__custom__function.html#a782aff512368932b8d71b3633f88cb04">mod</a>, chan);
<a name="l03394"></a>03394       res = acfptr-&gt;<a class="code" href="structast__custom__function.html#a1d0ca9a282b63162660f551d833f57cf">write</a>(chan, copy, args, value);
<a name="l03395"></a>03395       <span class="keywordflow">if</span> (acfptr-&gt;<a class="code" href="structast__custom__function.html#a782aff512368932b8d71b3633f88cb04">mod</a> &amp;&amp; u)
<a name="l03396"></a>03396          <a class="code" href="module_8h.html#aee5ac94e279928d1d1f7b6aafb62ec7a">__ast_module_user_remove</a>(acfptr-&gt;<a class="code" href="structast__custom__function.html#a782aff512368932b8d71b3633f88cb04">mod</a>, u);
<a name="l03397"></a>03397       <span class="keywordflow">return</span> res;
<a name="l03398"></a>03398    }
<a name="l03399"></a>03399 
<a name="l03400"></a>03400    <span class="keywordflow">return</span> -1;
<a name="l03401"></a>03401 }
<a name="l03402"></a>03402 
<a name="l03403"></a><a class="code" href="pbx_8c.html#a0806f58609bc84a2479d87318fc7b252">03403</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8h.html#a4019ca376e3f30f3cd342e29d3145742">pbx_substitute_variables_helper_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">struct</span> varshead *headp, <span class="keyword">const</span> <span class="keywordtype">char</span> *cp1, <span class="keywordtype">char</span> *cp2, <span class="keywordtype">int</span> count, <span class="keywordtype">size_t</span> *used)
<a name="l03404"></a>03404 {
<a name="l03405"></a>03405    <span class="comment">/* Substitutes variables into cp2, based on string cp1, cp2 NO LONGER NEEDS TO BE ZEROED OUT!!!!  */</span>
<a name="l03406"></a>03406    <span class="keywordtype">char</span> *cp4;
<a name="l03407"></a>03407    <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp, *whereweare, *orig_cp2 = cp2;
<a name="l03408"></a>03408    <span class="keywordtype">int</span> length, offset, offset2, isfunction;
<a name="l03409"></a>03409    <span class="keywordtype">char</span> *workspace = NULL;
<a name="l03410"></a>03410    <span class="keywordtype">char</span> *ltmp = NULL, *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a> = NULL;
<a name="l03411"></a>03411    <span class="keywordtype">char</span> *nextvar, *nextexp, *nextthing;
<a name="l03412"></a>03412    <span class="keywordtype">char</span> *vars, *vare;
<a name="l03413"></a>03413    <span class="keywordtype">int</span> pos, brackets, needsub, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l03414"></a>03414 
<a name="l03415"></a>03415    *cp2 = 0; <span class="comment">/* just in case nothing ends up there */</span>
<a name="l03416"></a>03416    whereweare=tmp=cp1;
<a name="l03417"></a>03417    <span class="keywordflow">while</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(whereweare) &amp;&amp; count) {
<a name="l03418"></a>03418       <span class="comment">/* Assume we&apos;re copying the whole remaining string */</span>
<a name="l03419"></a>03419       pos = strlen(whereweare);
<a name="l03420"></a>03420       nextvar = NULL;
<a name="l03421"></a>03421       nextexp = NULL;
<a name="l03422"></a>03422       nextthing = strchr(whereweare, <span class="charliteral">&apos;$&apos;</span>);
<a name="l03423"></a>03423       <span class="keywordflow">if</span> (nextthing) {
<a name="l03424"></a>03424          <span class="keywordflow">switch</span> (nextthing[1]) {
<a name="l03425"></a>03425          <span class="keywordflow">case</span> <span class="charliteral">&apos;{&apos;</span>:
<a name="l03426"></a>03426             nextvar = nextthing;
<a name="l03427"></a>03427             pos = nextvar - whereweare;
<a name="l03428"></a>03428             <span class="keywordflow">break</span>;
<a name="l03429"></a>03429          <span class="keywordflow">case</span> <span class="charliteral">&apos;[&apos;</span>:
<a name="l03430"></a>03430             nextexp = nextthing;
<a name="l03431"></a>03431             pos = nextexp - whereweare;
<a name="l03432"></a>03432             <span class="keywordflow">break</span>;
<a name="l03433"></a>03433          <span class="keywordflow">default</span>:
<a name="l03434"></a>03434             pos = 1;
<a name="l03435"></a>03435          }
<a name="l03436"></a>03436       }
<a name="l03437"></a>03437 
<a name="l03438"></a>03438       <span class="keywordflow">if</span> (pos) {
<a name="l03439"></a>03439          <span class="comment">/* Can&apos;t copy more than &apos;count&apos; bytes */</span>
<a name="l03440"></a>03440          <span class="keywordflow">if</span> (pos &gt; count)
<a name="l03441"></a>03441             pos = count;
<a name="l03442"></a>03442 
<a name="l03443"></a>03443          <span class="comment">/* Copy that many bytes */</span>
<a name="l03444"></a>03444          memcpy(cp2, whereweare, pos);
<a name="l03445"></a>03445 
<a name="l03446"></a>03446          count -= pos;
<a name="l03447"></a>03447          cp2 += pos;
<a name="l03448"></a>03448          whereweare += pos;
<a name="l03449"></a>03449          *cp2 = 0;
<a name="l03450"></a>03450       }
<a name="l03451"></a>03451 
<a name="l03452"></a>03452       <span class="keywordflow">if</span> (nextvar) {
<a name="l03453"></a>03453          <span class="comment">/* We have a variable.  Find the start and end, and determine</span>
<a name="l03454"></a>03454 <span class="comment">            if we are going to have to recursively call ourselves on the</span>
<a name="l03455"></a>03455 <span class="comment">            contents */</span>
<a name="l03456"></a>03456          vars = vare = nextvar + 2;
<a name="l03457"></a>03457          brackets = 1;
<a name="l03458"></a>03458          needsub = 0;
<a name="l03459"></a>03459 
<a name="l03460"></a>03460          <span class="comment">/* Find the end of it */</span>
<a name="l03461"></a>03461          <span class="keywordflow">while</span> (brackets &amp;&amp; *vare) {
<a name="l03462"></a>03462             <span class="keywordflow">if</span> ((vare[0] == <span class="charliteral">&apos;$&apos;</span>) &amp;&amp; (vare[1] == <span class="charliteral">&apos;{&apos;</span>)) {
<a name="l03463"></a>03463                needsub++;
<a name="l03464"></a>03464             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vare[0] == <span class="charliteral">&apos;{&apos;</span>) {
<a name="l03465"></a>03465                brackets++;
<a name="l03466"></a>03466             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vare[0] == <span class="charliteral">&apos;}&apos;</span>) {
<a name="l03467"></a>03467                brackets--;
<a name="l03468"></a>03468             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((vare[0] == <span class="charliteral">&apos;$&apos;</span>) &amp;&amp; (vare[1] == <span class="charliteral">&apos;[&apos;</span>))
<a name="l03469"></a>03469                needsub++;
<a name="l03470"></a>03470             vare++;
<a name="l03471"></a>03471          }
<a name="l03472"></a>03472          <span class="keywordflow">if</span> (brackets)
<a name="l03473"></a>03473             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error in extension logic (missing &apos;}&apos;)\n&quot;</span>);
<a name="l03474"></a>03474          len = vare - vars - 1;
<a name="l03475"></a>03475 
<a name="l03476"></a>03476          <span class="comment">/* Skip totally over variable string */</span>
<a name="l03477"></a>03477          whereweare += (len + 3);
<a name="l03478"></a>03478 
<a name="l03479"></a>03479          <span class="keywordflow">if</span> (!var)
<a name="l03480"></a>03480             var = alloca(<a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a>);
<a name="l03481"></a>03481 
<a name="l03482"></a>03482          <span class="comment">/* Store variable name (and truncate) */</span>
<a name="l03483"></a>03483          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(var, vars, len + 1);
<a name="l03484"></a>03484 
<a name="l03485"></a>03485          <span class="comment">/* Substitute if necessary */</span>
<a name="l03486"></a>03486          <span class="keywordflow">if</span> (needsub) {
<a name="l03487"></a>03487             <span class="keywordtype">size_t</span> used;
<a name="l03488"></a>03488             <span class="keywordflow">if</span> (!ltmp)
<a name="l03489"></a>03489                ltmp = alloca(<a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a>);
<a name="l03490"></a>03490 
<a name="l03491"></a>03491             <a class="code" href="pbx_8h.html#a4019ca376e3f30f3cd342e29d3145742">pbx_substitute_variables_helper_full</a>(c, headp, var, ltmp, <a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a> - 1, &amp;used);
<a name="l03492"></a>03492             vars = ltmp;
<a name="l03493"></a>03493          } <span class="keywordflow">else</span> {
<a name="l03494"></a>03494             vars = var;
<a name="l03495"></a>03495          }
<a name="l03496"></a>03496 
<a name="l03497"></a>03497          <span class="keywordflow">if</span> (!workspace)
<a name="l03498"></a>03498             workspace = alloca(<a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a>);
<a name="l03499"></a>03499 
<a name="l03500"></a>03500          workspace[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03501"></a>03501 
<a name="l03502"></a>03502          <a class="code" href="pbx_8c.html#ac280b071ffa8f9e016cc011d77c41a86" title="extract offset:length from variable name.">parse_variable_name</a>(vars, &amp;offset, &amp;offset2, &amp;isfunction);
<a name="l03503"></a>03503          <span class="keywordflow">if</span> (isfunction) {
<a name="l03504"></a>03504             <span class="comment">/* Evaluate function */</span>
<a name="l03505"></a>03505             <span class="keywordflow">if</span> (c || !headp)
<a name="l03506"></a>03506                cp4 = <a class="code" href="pbx_8h.html#aa4e9618aa036a586af7d7663afd9b507" title="executes a read operation on a function">ast_func_read</a>(c, vars, workspace, <a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a>) ? NULL : workspace;
<a name="l03507"></a>03507             <span class="keywordflow">else</span> {
<a name="l03508"></a>03508                <span class="keyword">struct </span>varshead old;
<a name="l03509"></a>03509                <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *bogus = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Bogus/%p&quot;</span>, vars);
<a name="l03510"></a>03510                <span class="keywordflow">if</span> (bogus) {
<a name="l03511"></a>03511                   memcpy(&amp;old, &amp;bogus-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a>, <span class="keyword">sizeof</span>(old));
<a name="l03512"></a>03512                   memcpy(&amp;bogus-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a>, headp, <span class="keyword">sizeof</span>(bogus-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a>));
<a name="l03513"></a>03513                   cp4 = <a class="code" href="pbx_8h.html#aa4e9618aa036a586af7d7663afd9b507" title="executes a read operation on a function">ast_func_read</a>(bogus, vars, workspace, <a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a>) ? NULL : workspace;
<a name="l03514"></a>03514                   <span class="comment">/* Don&apos;t deallocate the varshead that was passed in */</span>
<a name="l03515"></a>03515                   memcpy(&amp;bogus-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a>, &amp;old, <span class="keyword">sizeof</span>(bogus-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a>));
<a name="l03516"></a>03516                   <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>(bogus);
<a name="l03517"></a>03517                } <span class="keywordflow">else</span>
<a name="l03518"></a>03518                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to allocate bogus channel for variable substitution.  Function results may be blank.\n&quot;</span>);
<a name="l03519"></a>03519             }
<a name="l03520"></a>03520             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Function result is &apos;%s&apos;\n&quot;</span>, cp4 ? cp4 : <span class="stringliteral">&quot;(null)&quot;</span>);
<a name="l03521"></a>03521          } <span class="keywordflow">else</span> {
<a name="l03522"></a>03522             <span class="comment">/* Retrieve variable value */</span>
<a name="l03523"></a>03523             <a class="code" href="pbx_8h.html#aaf906a18ba2dcd53c35f59869757521f" title="Retrieve the value of a builtin variable or variable from the channel variable stack...">pbx_retrieve_variable</a>(c, vars, &amp;cp4, workspace, <a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a>, headp);
<a name="l03524"></a>03524          }
<a name="l03525"></a>03525          <span class="keywordflow">if</span> (cp4) {
<a name="l03526"></a>03526             cp4 = <a class="code" href="pbx_8c.html#ac79353a3cba653bbeea7eabd8e4d073c" title="takes a substring. It is ok to call with value == workspace.">substring</a>(cp4, offset, offset2, workspace, <a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a>);
<a name="l03527"></a>03527 
<a name="l03528"></a>03528             length = strlen(cp4);
<a name="l03529"></a>03529             <span class="keywordflow">if</span> (length &gt; count)
<a name="l03530"></a>03530                length = count;
<a name="l03531"></a>03531             memcpy(cp2, cp4, length);
<a name="l03532"></a>03532             count -= length;
<a name="l03533"></a>03533             cp2 += length;
<a name="l03534"></a>03534             *cp2 = 0;
<a name="l03535"></a>03535          }
<a name="l03536"></a>03536       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nextexp) {
<a name="l03537"></a>03537          <span class="comment">/* We have an expression.  Find the start and end, and determine</span>
<a name="l03538"></a>03538 <span class="comment">            if we are going to have to recursively call ourselves on the</span>
<a name="l03539"></a>03539 <span class="comment">            contents */</span>
<a name="l03540"></a>03540          vars = vare = nextexp + 2;
<a name="l03541"></a>03541          brackets = 1;
<a name="l03542"></a>03542          needsub = 0;
<a name="l03543"></a>03543 
<a name="l03544"></a>03544          <span class="comment">/* Find the end of it */</span>
<a name="l03545"></a>03545          <span class="keywordflow">while</span> (brackets &amp;&amp; *vare) {
<a name="l03546"></a>03546             <span class="keywordflow">if</span> ((vare[0] == <span class="charliteral">&apos;$&apos;</span>) &amp;&amp; (vare[1] == <span class="charliteral">&apos;[&apos;</span>)) {
<a name="l03547"></a>03547                needsub++;
<a name="l03548"></a>03548                brackets++;
<a name="l03549"></a>03549                vare++;
<a name="l03550"></a>03550             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vare[0] == <span class="charliteral">&apos;[&apos;</span>) {
<a name="l03551"></a>03551                brackets++;
<a name="l03552"></a>03552             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vare[0] == <span class="charliteral">&apos;]&apos;</span>) {
<a name="l03553"></a>03553                brackets--;
<a name="l03554"></a>03554             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((vare[0] == <span class="charliteral">&apos;$&apos;</span>) &amp;&amp; (vare[1] == <span class="charliteral">&apos;{&apos;</span>)) {
<a name="l03555"></a>03555                needsub++;
<a name="l03556"></a>03556                vare++;
<a name="l03557"></a>03557             }
<a name="l03558"></a>03558             vare++;
<a name="l03559"></a>03559          }
<a name="l03560"></a>03560          <span class="keywordflow">if</span> (brackets)
<a name="l03561"></a>03561             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error in extension logic (missing &apos;]&apos;)\n&quot;</span>);
<a name="l03562"></a>03562          len = vare - vars - 1;
<a name="l03563"></a>03563 
<a name="l03564"></a>03564          <span class="comment">/* Skip totally over expression */</span>
<a name="l03565"></a>03565          whereweare += (len + 3);
<a name="l03566"></a>03566 
<a name="l03567"></a>03567          <span class="keywordflow">if</span> (!var)
<a name="l03568"></a>03568             var = alloca(<a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a>);
<a name="l03569"></a>03569 
<a name="l03570"></a>03570          <span class="comment">/* Store variable name (and truncate) */</span>
<a name="l03571"></a>03571          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(var, vars, len + 1);
<a name="l03572"></a>03572 
<a name="l03573"></a>03573          <span class="comment">/* Substitute if necessary */</span>
<a name="l03574"></a>03574          <span class="keywordflow">if</span> (needsub) {
<a name="l03575"></a>03575             <span class="keywordtype">size_t</span> used;
<a name="l03576"></a>03576             <span class="keywordflow">if</span> (!ltmp)
<a name="l03577"></a>03577                ltmp = alloca(<a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a>);
<a name="l03578"></a>03578 
<a name="l03579"></a>03579             <a class="code" href="pbx_8h.html#a4019ca376e3f30f3cd342e29d3145742">pbx_substitute_variables_helper_full</a>(c, headp, var, ltmp, <a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a> - 1, &amp;used);
<a name="l03580"></a>03580             vars = ltmp;
<a name="l03581"></a>03581          } <span class="keywordflow">else</span> {
<a name="l03582"></a>03582             vars = var;
<a name="l03583"></a>03583          }
<a name="l03584"></a>03584 
<a name="l03585"></a>03585          length = <a class="code" href="ast__expr_8h.html#a7aefd8d0694c8f4241d64ffaf5145b4c">ast_expr</a>(vars, cp2, count, c);
<a name="l03586"></a>03586 
<a name="l03587"></a>03587          <span class="keywordflow">if</span> (length) {
<a name="l03588"></a>03588             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Expression result is &apos;%s&apos;\n&quot;</span>, cp2);
<a name="l03589"></a>03589             count -= length;
<a name="l03590"></a>03590             cp2 += length;
<a name="l03591"></a>03591             *cp2 = 0;
<a name="l03592"></a>03592          }
<a name="l03593"></a>03593       }
<a name="l03594"></a>03594    }
<a name="l03595"></a>03595    *used = cp2 - orig_cp2;
<a name="l03596"></a>03596 }
<a name="l03597"></a>03597 
<a name="l03598"></a><a class="code" href="pbx_8c.html#a3eac2009888ce9c4a108e882d02cb04d">03598</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *cp1, <span class="keywordtype">char</span> *cp2, <span class="keywordtype">int</span> count)
<a name="l03599"></a>03599 {
<a name="l03600"></a>03600    <span class="keywordtype">size_t</span> used;
<a name="l03601"></a>03601    <a class="code" href="pbx_8h.html#a4019ca376e3f30f3cd342e29d3145742">pbx_substitute_variables_helper_full</a>(c, (c) ? &amp;c-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a> : NULL, cp1, cp2, count, &amp;used);
<a name="l03602"></a>03602 }
<a name="l03603"></a>03603 
<a name="l03604"></a><a class="code" href="pbx_8c.html#a2b3355625306d4b98ca8047cd2245459">03604</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8h.html#a2b3355625306d4b98ca8047cd2245459">pbx_substitute_variables_varshead</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a> *headp, <span class="keyword">const</span> <span class="keywordtype">char</span> *cp1, <span class="keywordtype">char</span> *cp2, <span class="keywordtype">int</span> count)
<a name="l03605"></a>03605 {
<a name="l03606"></a>03606    <span class="keywordtype">size_t</span> used;
<a name="l03607"></a>03607    <a class="code" href="pbx_8h.html#a4019ca376e3f30f3cd342e29d3145742">pbx_substitute_variables_helper_full</a>(NULL, headp, cp1, cp2, count, &amp;used);
<a name="l03608"></a>03608 }
<a name="l03609"></a>03609 
<a name="l03610"></a><a class="code" href="pbx_8c.html#afa08db8e3849cf7420f0027fadc50c2b">03610</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#afa08db8e3849cf7420f0027fadc50c2b">pbx_substitute_variables</a>(<span class="keywordtype">char</span> *passdata, <span class="keywordtype">int</span> datalen, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e)
<a name="l03611"></a>03611 {
<a name="l03612"></a>03612    <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp;
<a name="l03613"></a>03613 
<a name="l03614"></a>03614    <span class="comment">/* Nothing more to do */</span>
<a name="l03615"></a>03615    <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a>) {
<a name="l03616"></a>03616       *passdata = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03617"></a>03617       <span class="keywordflow">return</span>;
<a name="l03618"></a>03618    }
<a name="l03619"></a>03619 
<a name="l03620"></a>03620    <span class="comment">/* No variables or expressions in e-&gt;data, so why scan it? */</span>
<a name="l03621"></a>03621    <span class="keywordflow">if</span> ((!(tmp = strchr(e-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a>, <span class="charliteral">&apos;$&apos;</span>))) || (!strstr(tmp, <span class="stringliteral">&quot;${&quot;</span>) &amp;&amp; !strstr(tmp, <span class="stringliteral">&quot;$[&quot;</span>))) {
<a name="l03622"></a>03622       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(passdata, e-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a>, datalen);
<a name="l03623"></a>03623       <span class="keywordflow">return</span>;
<a name="l03624"></a>03624    }
<a name="l03625"></a>03625 
<a name="l03626"></a>03626    <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(c, e-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a>, passdata, datalen - 1);
<a name="l03627"></a>03627 }
<a name="l03628"></a>03628 <span class="comment"></span>
<a name="l03629"></a>03629 <span class="comment">/*!</span>
<a name="l03630"></a>03630 <span class="comment"> * \brief The return value depends on the action:</span>
<a name="l03631"></a>03631 <span class="comment"> *</span>
<a name="l03632"></a>03632 <span class="comment"> * E_MATCH, E_CANMATCH, E_MATCHMORE require a real match,</span>
<a name="l03633"></a>03633 <span class="comment"> * and return 0 on failure, -1 on match;</span>
<a name="l03634"></a>03634 <span class="comment"> * E_FINDLABEL maps the label to a priority, and returns</span>
<a name="l03635"></a>03635 <span class="comment"> * the priority on success, ... XXX</span>
<a name="l03636"></a>03636 <span class="comment"> * E_SPAWN, spawn an application,</span>
<a name="l03637"></a>03637 <span class="comment"> *</span>
<a name="l03638"></a>03638 <span class="comment"> * \retval 0 on success.</span>
<a name="l03639"></a>03639 <span class="comment"> * \retval  -1 on failure.</span>
<a name="l03640"></a>03640 <span class="comment"> *</span>
<a name="l03641"></a>03641 <span class="comment"> * \note The channel is auto-serviced in this function, because doing an extension</span>
<a name="l03642"></a>03642 <span class="comment"> * match may block for a long time.  For example, if the lookup has to use a network</span>
<a name="l03643"></a>03643 <span class="comment"> * dialplan switch, such as DUNDi or IAX2, it may take a while.  However, the channel</span>
<a name="l03644"></a>03644 <span class="comment"> * auto-service code will queue up any important signalling frames to be processed</span>
<a name="l03645"></a>03645 <span class="comment"> * after this is done.</span>
<a name="l03646"></a>03646 <span class="comment"> */</span>
<a name="l03647"></a><a class="code" href="pbx_8c.html#ae381d99bea85b43f022470b64171018d">03647</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#ae381d99bea85b43f022470b64171018d" title="The return value depends on the action:.">pbx_extension_helper</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con,
<a name="l03648"></a>03648   <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority,
<a name="l03649"></a>03649   <span class="keyword">const</span> <span class="keywordtype">char</span> *label, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keyword">enum</span> <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26be">ext_match_t</a> action, <span class="keywordtype">int</span> *found, <span class="keywordtype">int</span> combined_find_spawn)
<a name="l03650"></a>03650 {
<a name="l03651"></a>03651    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e;
<a name="l03652"></a>03652    <span class="keyword">struct </span>ast_app *<a class="code" href="adsistub_8c.html#ad194d73de26c0d836555e029d245493d">app</a>;
<a name="l03653"></a>03653    <span class="keywordtype">int</span> res;
<a name="l03654"></a>03654    <span class="keyword">struct </span><a class="code" href="structpbx__find__info.html">pbx_find_info</a> q = { .<a class="code" href="structpbx__find__info.html#a31dd453024f17e9e35717368cf8c87fb">stacklen</a> = 0 }; <span class="comment">/* the rest is reset in pbx_find_extension */</span>
<a name="l03655"></a>03655    <span class="keywordtype">char</span> passdata[<a class="code" href="pbx_8c.html#ab07357218392804a25091a0a5d03d260">EXT_DATA_SIZE</a>];
<a name="l03656"></a>03656 
<a name="l03657"></a>03657    <span class="keywordtype">int</span> matching_action = (action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea2e605157e82dec388ffc89c1694fb7be">E_MATCH</a> || action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea413c09377a892aa154e7669cbdaf27ba">E_CANMATCH</a> || action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>);
<a name="l03658"></a>03658 
<a name="l03659"></a>03659    <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l03660"></a>03660    <span class="keywordflow">if</span> (found)
<a name="l03661"></a>03661       *found = 0;
<a name="l03662"></a>03662 
<a name="l03663"></a>03663    e = <a class="code" href="pbx_8h.html#a63e03245dc48558e55da8890b3dbb87e">pbx_find_extension</a>(c, con, &amp;q, context, exten, priority, label, callerid, action);
<a name="l03664"></a>03664    <span class="keywordflow">if</span> (e) {
<a name="l03665"></a>03665       <span class="keywordflow">if</span> (found)
<a name="l03666"></a>03666          *found = 1;
<a name="l03667"></a>03667       <span class="keywordflow">if</span> (matching_action) {
<a name="l03668"></a>03668          <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l03669"></a>03669          <span class="keywordflow">return</span> -1;  <span class="comment">/* success, we found it */</span>
<a name="l03670"></a>03670       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (action == <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7b10ab7b3dd6af9d933dbb03dd183eb5">E_FINDLABEL</a>) { <span class="comment">/* map the label to a priority */</span>
<a name="l03671"></a>03671          res = e-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>;
<a name="l03672"></a>03672          <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l03673"></a>03673          <span class="keywordflow">return</span> res; <span class="comment">/* the priority we were looking for */</span>
<a name="l03674"></a>03674       } <span class="keywordflow">else</span> { <span class="comment">/* spawn */</span>
<a name="l03675"></a>03675          <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structast__exten.html#a595b923ccb74fb5923f3de8bc77adc50">cached_app</a>)
<a name="l03676"></a>03676             e-&gt;<a class="code" href="structast__exten.html#a595b923ccb74fb5923f3de8bc77adc50">cached_app</a> = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(e-&gt;<a class="code" href="structast__exten.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">app</a>);
<a name="l03677"></a>03677          app = e-&gt;<a class="code" href="structast__exten.html#a595b923ccb74fb5923f3de8bc77adc50">cached_app</a>;
<a name="l03678"></a>03678          <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l03679"></a>03679          <span class="keywordflow">if</span> (!app) {
<a name="l03680"></a>03680             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No application &apos;%s&apos; for extension (%s, %s, %d)\n&quot;</span>, e-&gt;<a class="code" href="structast__exten.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">app</a>, context, exten, priority);
<a name="l03681"></a>03681             <span class="keywordflow">return</span> -1;
<a name="l03682"></a>03682          }
<a name="l03683"></a>03683          <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a> != context)
<a name="l03684"></a>03684             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, context, <span class="keyword">sizeof</span>(c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l03685"></a>03685          <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a> != exten)
<a name="l03686"></a>03686             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, exten, <span class="keyword">sizeof</span>(c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l03687"></a>03687          c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = priority;
<a name="l03688"></a>03688          <a class="code" href="pbx_8c.html#afa08db8e3849cf7420f0027fadc50c2b">pbx_substitute_variables</a>(passdata, <span class="keyword">sizeof</span>(passdata), c, e);
<a name="l03689"></a>03689 <span class="preprocessor">#ifdef CHANNEL_TRACE</span>
<a name="l03690"></a>03690 <span class="preprocessor"></span>         ast_channel_trace_update(c);
<a name="l03691"></a>03691 <span class="preprocessor">#endif</span>
<a name="l03692"></a>03692 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Launching &apos;%s&apos;\n&quot;</span>, app-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l03693"></a>03693          <span class="keywordflow">if</span> (<a class="code" href="logger_8h.html#a7d52159deec8b3179d27fcb4d39c30d2">VERBOSITY_ATLEAST</a>(3)) {
<a name="l03694"></a>03694             <span class="keywordtype">char</span> tmp[80], tmp2[80], tmp3[<a class="code" href="pbx_8c.html#ab07357218392804a25091a0a5d03d260">EXT_DATA_SIZE</a>];
<a name="l03695"></a>03695             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Executing [%s@%s:%d] %s(\&quot;%s\&quot;, \&quot;%s\&quot;) %s\n&quot;</span>,
<a name="l03696"></a>03696                exten, context, priority,
<a name="l03697"></a>03697                <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmp, app-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, <a class="code" href="term_8h.html#a23aeefae76b2cacc1a6162de88c3fff0">COLOR_BRCYAN</a>, 0, <span class="keyword">sizeof</span>(tmp)),
<a name="l03698"></a>03698                <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmp2, c-&gt;name, <a class="code" href="term_8h.html#aee88b2ffd7fd2128fe38896cffb1a71a">COLOR_BRMAGENTA</a>, 0, <span class="keyword">sizeof</span>(tmp2)),
<a name="l03699"></a>03699                <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmp3, passdata, <a class="code" href="term_8h.html#aee88b2ffd7fd2128fe38896cffb1a71a">COLOR_BRMAGENTA</a>, 0, <span class="keyword">sizeof</span>(tmp3)),
<a name="l03700"></a>03700                <span class="stringliteral">&quot;in new stack&quot;</span>);
<a name="l03701"></a>03701          }
<a name="l03702"></a>03702          <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ad602e069591b527f28e36dd472425e7e">EVENT_FLAG_DIALPLAN</a>, <span class="stringliteral">&quot;Newexten&quot;</span>,
<a name="l03703"></a>03703                <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l03704"></a>03704                <span class="stringliteral">&quot;Context: %s\r\n&quot;</span>
<a name="l03705"></a>03705                <span class="stringliteral">&quot;Extension: %s\r\n&quot;</span>
<a name="l03706"></a>03706                <span class="stringliteral">&quot;Priority: %d\r\n&quot;</span>
<a name="l03707"></a>03707                <span class="stringliteral">&quot;Application: %s\r\n&quot;</span>
<a name="l03708"></a>03708                <span class="stringliteral">&quot;AppData: %s\r\n&quot;</span>
<a name="l03709"></a>03709                <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>,
<a name="l03710"></a>03710                c-&gt;name, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, app-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, passdata, c-&gt;uniqueid);
<a name="l03711"></a>03711          <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(c, app, passdata);  <span class="comment">/* 0 on success, -1 on failure */</span>
<a name="l03712"></a>03712       }
<a name="l03713"></a>03713    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (q.<a class="code" href="structpbx__find__info.html#a3215a7f1fa2be1b8f6872b5b388b55a8">swo</a>) {  <span class="comment">/* not found here, but in another switch */</span>
<a name="l03714"></a>03714       <span class="keywordflow">if</span> (found)
<a name="l03715"></a>03715          *found = 1;
<a name="l03716"></a>03716       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l03717"></a>03717       <span class="keywordflow">if</span> (matching_action) {
<a name="l03718"></a>03718          <span class="keywordflow">return</span> -1;
<a name="l03719"></a>03719       } <span class="keywordflow">else</span> {
<a name="l03720"></a>03720          <span class="keywordflow">if</span> (!q.<a class="code" href="structpbx__find__info.html#a3215a7f1fa2be1b8f6872b5b388b55a8">swo</a>-&gt;<a class="code" href="structast__switch.html#a337fb873db5926c0fcb60a6bf56240e4">exec</a>) {
<a name="l03721"></a>03721             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No execution engine for switch %s\n&quot;</span>, q.<a class="code" href="structpbx__find__info.html#a3215a7f1fa2be1b8f6872b5b388b55a8">swo</a>-&gt;<a class="code" href="structast__switch.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03722"></a>03722             res = -1;
<a name="l03723"></a>03723          }
<a name="l03724"></a>03724          <span class="keywordflow">return</span> q.<a class="code" href="structpbx__find__info.html#a3215a7f1fa2be1b8f6872b5b388b55a8">swo</a>-&gt;<a class="code" href="structast__switch.html#a337fb873db5926c0fcb60a6bf56240e4">exec</a>(c, q.<a class="code" href="structpbx__find__info.html#a71796127253dfc9a1830ede1904c653b">foundcontext</a> ? q.<a class="code" href="structpbx__find__info.html#a71796127253dfc9a1830ede1904c653b">foundcontext</a> : context, exten, priority, callerid, q.<a class="code" href="structpbx__find__info.html#ae4950db1dbfff8459a712737063b61aa">data</a>);
<a name="l03725"></a>03725       }
<a name="l03726"></a>03726    } <span class="keywordflow">else</span> { <span class="comment">/* not found anywhere, see what happened */</span>
<a name="l03727"></a>03727       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l03728"></a>03728       <span class="comment">/* Using S_OR here because Solaris doesn&apos;t like NULL being passed to ast_log */</span>
<a name="l03729"></a>03729       <span class="keywordflow">switch</span> (q.<a class="code" href="structpbx__find__info.html#a6e27f49150e9a14580fb313cc2777e00">status</a>) {
<a name="l03730"></a>03730       <span class="keywordflow">case</span> <a class="code" href="extconf_8h.html#aa2d7a93c24186594d8c09e904fa17132">STATUS_NO_CONTEXT</a>:
<a name="l03731"></a>03731          <span class="keywordflow">if</span> (!matching_action &amp;&amp; !combined_find_spawn)
<a name="l03732"></a>03732             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Cannot find extension context &apos;%s&apos;\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(context, <span class="stringliteral">&quot;&quot;</span>));
<a name="l03733"></a>03733          <span class="keywordflow">break</span>;
<a name="l03734"></a>03734       <span class="keywordflow">case</span> <a class="code" href="extconf_8h.html#a53e8d9faad7e0156772e9559df5f8c2e">STATUS_NO_EXTENSION</a>:
<a name="l03735"></a>03735          <span class="keywordflow">if</span> (!matching_action &amp;&amp; !combined_find_spawn)
<a name="l03736"></a>03736             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Cannot find extension &apos;%s&apos; in context &apos;%s&apos;\n&quot;</span>, exten, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(context, <span class="stringliteral">&quot;&quot;</span>));
<a name="l03737"></a>03737          <span class="keywordflow">break</span>;
<a name="l03738"></a>03738       <span class="keywordflow">case</span> <a class="code" href="extconf_8h.html#ab6422b4f1e9de4cb16307bd081b8706b">STATUS_NO_PRIORITY</a>:
<a name="l03739"></a>03739          <span class="keywordflow">if</span> (!matching_action &amp;&amp; !combined_find_spawn)
<a name="l03740"></a>03740             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No such priority %d in extension &apos;%s&apos; in context &apos;%s&apos;\n&quot;</span>, priority, exten, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(context, <span class="stringliteral">&quot;&quot;</span>));
<a name="l03741"></a>03741          <span class="keywordflow">break</span>;
<a name="l03742"></a>03742       <span class="keywordflow">case</span> <a class="code" href="extconf_8h.html#a5062f2413e9425755149f855577b602f">STATUS_NO_LABEL</a>:
<a name="l03743"></a>03743          <span class="keywordflow">if</span> (context &amp;&amp; !combined_find_spawn)
<a name="l03744"></a>03744             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No such label &apos;%s&apos; in extension &apos;%s&apos; in context &apos;%s&apos;\n&quot;</span>, label, exten, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(context, <span class="stringliteral">&quot;&quot;</span>));
<a name="l03745"></a>03745          <span class="keywordflow">break</span>;
<a name="l03746"></a>03746       <span class="keywordflow">default</span>:
<a name="l03747"></a>03747          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Shouldn&apos;t happen!\n&quot;</span>);
<a name="l03748"></a>03748       }
<a name="l03749"></a>03749 
<a name="l03750"></a>03750       <span class="keywordflow">return</span> (matching_action) ? 0 : -1;
<a name="l03751"></a>03751    }
<a name="l03752"></a>03752 }
<a name="l03753"></a>03753 <span class="comment"></span>
<a name="l03754"></a>03754 <span class="comment">/*! \brief Find hint for given extension in context */</span>
<a name="l03755"></a><a class="code" href="pbx_8c.html#ad121506517c1a92626d906f787f17358">03755</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="pbx_8c.html#ad121506517c1a92626d906f787f17358" title="Find hint for given extension in context.">ast_hint_extension_nolock</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten)
<a name="l03756"></a>03756 {
<a name="l03757"></a>03757    <span class="keyword">struct </span><a class="code" href="structpbx__find__info.html">pbx_find_info</a> q = { .<a class="code" href="structpbx__find__info.html#a31dd453024f17e9e35717368cf8c87fb">stacklen</a> = 0 }; <span class="comment">/* the rest is set in pbx_find_context */</span>
<a name="l03758"></a>03758    <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a63e03245dc48558e55da8890b3dbb87e">pbx_find_extension</a>(c, NULL, &amp;q, context, exten, <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>, NULL, <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea2e605157e82dec388ffc89c1694fb7be">E_MATCH</a>);
<a name="l03759"></a>03759 }
<a name="l03760"></a>03760 
<a name="l03761"></a><a class="code" href="pbx_8c.html#a666d27d15c01c2b36dd8523a0146ba40">03761</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="pbx_8c.html#a666d27d15c01c2b36dd8523a0146ba40">ast_hint_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten)
<a name="l03762"></a>03762 {
<a name="l03763"></a>03763    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e;
<a name="l03764"></a>03764    <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l03765"></a>03765    e = <a class="code" href="pbx_8c.html#ad121506517c1a92626d906f787f17358" title="Find hint for given extension in context.">ast_hint_extension_nolock</a>(c, context, exten);
<a name="l03766"></a>03766    <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l03767"></a>03767    <span class="keywordflow">return</span> e;
<a name="l03768"></a>03768 }
<a name="l03769"></a>03769 
<a name="l03770"></a><a class="code" href="pbx_8c.html#a3aa0b9f1691104cb6214ba66c5dc3a30">03770</a> <span class="keyword">enum</span> <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625f" title="Extension states.">ast_extension_states</a> <a class="code" href="pbx_8h.html#a3aa0b9f1691104cb6214ba66c5dc3a30" title="Map devstate to an extension state.">ast_devstate_to_extenstate</a>(<span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> devstate)
<a name="l03771"></a>03771 {
<a name="l03772"></a>03772    <span class="keywordflow">switch</span> (devstate) {
<a name="l03773"></a>03773    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea6b7416bea92d3bc5ee8e36f0a484cdc1">AST_DEVICE_ONHOLD</a>:
<a name="l03774"></a>03774       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa83180bb058ded006c01229431fc887f9">AST_EXTENSION_ONHOLD</a>;
<a name="l03775"></a>03775    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeab43afabf5bcd4ad1f531ad78c48ccb6f">AST_DEVICE_BUSY</a>:
<a name="l03776"></a>03776       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fad62d357f0ccde2a718c374a0a4af2b98">AST_EXTENSION_BUSY</a>;
<a name="l03777"></a>03777    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>:
<a name="l03778"></a>03778    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>:
<a name="l03779"></a>03779    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>:
<a name="l03780"></a>03780       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa5820eb407f3a3dbc5046c97ad43ee1f3">AST_EXTENSION_UNAVAILABLE</a>;
<a name="l03781"></a>03781    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea17b87dfa3f4de5909b401017e229091d">AST_DEVICE_RINGINUSE</a>:
<a name="l03782"></a>03782       <span class="keywordflow">return</span> (<a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa47e9214860b5f9b887945f7cd1baec1a">AST_EXTENSION_INUSE</a> | <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa4063bf4e94e14df04126be6f08cc7bfc">AST_EXTENSION_RINGING</a>);
<a name="l03783"></a>03783    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea76d91d5d654cfa3edafb2afbe3e09b46">AST_DEVICE_RINGING</a>:
<a name="l03784"></a>03784       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa4063bf4e94e14df04126be6f08cc7bfc">AST_EXTENSION_RINGING</a>;
<a name="l03785"></a>03785    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>:
<a name="l03786"></a>03786       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa47e9214860b5f9b887945f7cd1baec1a">AST_EXTENSION_INUSE</a>;
<a name="l03787"></a>03787    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>:
<a name="l03788"></a>03788       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa435abb1e907b1cee83ec44d2d77866e6">AST_EXTENSION_NOT_INUSE</a>;
<a name="l03789"></a>03789    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeaf790c1f212837af8d2db5193228102d7">AST_DEVICE_TOTAL</a>: <span class="comment">/* not a device state, included for completeness */</span>
<a name="l03790"></a>03790       <span class="keywordflow">break</span>;
<a name="l03791"></a>03791    }
<a name="l03792"></a>03792 
<a name="l03793"></a>03793    <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa435abb1e907b1cee83ec44d2d77866e6">AST_EXTENSION_NOT_INUSE</a>;
<a name="l03794"></a>03794 }
<a name="l03795"></a>03795 <span class="comment"></span>
<a name="l03796"></a>03796 <span class="comment">/*! \brief Check state of extension by using hints */</span>
<a name="l03797"></a><a class="code" href="pbx_8c.html#a1ffd31790fbd06b1fcf1b44fd1333034">03797</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a1ffd31790fbd06b1fcf1b44fd1333034" title="Check state of extension by using hints.">ast_extension_state2</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e)
<a name="l03798"></a>03798 {
<a name="l03799"></a>03799    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *hint = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="pbx_8c.html#ac5308f5883751f800daddb3dfbdd7480">extensionstate_buf</a>, 16);
<a name="l03800"></a>03800    <span class="keywordtype">char</span> *cur, *rest;
<a name="l03801"></a>03801    <span class="keyword">struct </span><a class="code" href="structast__devstate__aggregate.html" title="You shouldn&amp;#39;t care about the contents of this struct.">ast_devstate_aggregate</a> agg;
<a name="l03802"></a>03802 
<a name="l03803"></a>03803    <span class="keywordflow">if</span> (!e)
<a name="l03804"></a>03804       <span class="keywordflow">return</span> -1;
<a name="l03805"></a>03805 
<a name="l03806"></a>03806    <a class="code" href="devicestate_8h.html#a65ebe8f28497b09769ab9edeb4eb9b86" title="Initialize aggregate device state.">ast_devstate_aggregate_init</a>(&amp;agg);
<a name="l03807"></a>03807 
<a name="l03808"></a>03808    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;hint, 0, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(e));
<a name="l03809"></a>03809 
<a name="l03810"></a>03810    rest = <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(hint);  <span class="comment">/* One or more devices separated with a &amp; character */</span>
<a name="l03811"></a>03811 
<a name="l03812"></a>03812    <span class="keywordflow">while</span> ( (cur = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;rest, <span class="stringliteral">&quot;&amp;&quot;</span>)) ) {
<a name="l03813"></a>03813       <a class="code" href="devicestate_8h.html#a45534707838d05125f409430b371854a" title="Add a device state to the aggregate device state.">ast_devstate_aggregate_add</a>(&amp;agg, <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a>(cur));
<a name="l03814"></a>03814    }
<a name="l03815"></a>03815 
<a name="l03816"></a>03816    <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a3aa0b9f1691104cb6214ba66c5dc3a30" title="Map devstate to an extension state.">ast_devstate_to_extenstate</a>(<a class="code" href="devicestate_8h.html#a852d7e936d4385c3bb903812de5d6403" title="Get the aggregate device state result.">ast_devstate_aggregate_result</a>(&amp;agg));
<a name="l03817"></a>03817 }
<a name="l03818"></a>03818 <span class="comment"></span>
<a name="l03819"></a>03819 <span class="comment">/*! \brief Return extension_state as string */</span>
<a name="l03820"></a><a class="code" href="pbx_8c.html#a3261603753916b98888a5a5fc1d505c3">03820</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#a3261603753916b98888a5a5fc1d505c3" title="Return string representation of the state of an extension.">ast_extension_state2str</a>(<span class="keywordtype">int</span> extension_state)
<a name="l03821"></a>03821 {
<a name="l03822"></a>03822    <span class="keywordtype">int</span> i;
<a name="l03823"></a>03823 
<a name="l03824"></a>03824    <span class="keywordflow">for</span> (i = 0; (i &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="pbx_8c.html#a56ab82243e18b6c036a9bb41725dd549">extension_states</a>)); i++) {
<a name="l03825"></a>03825       <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#a56ab82243e18b6c036a9bb41725dd549">extension_states</a>[i].extension_state == extension_state)
<a name="l03826"></a>03826          <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#a56ab82243e18b6c036a9bb41725dd549">extension_states</a>[i].<a class="code" href="structcfextension__states.html#aecfd3170c3d94608e5e5c038085fdf3f">text</a>;
<a name="l03827"></a>03827    }
<a name="l03828"></a>03828    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Unknown&quot;</span>;
<a name="l03829"></a>03829 }
<a name="l03830"></a>03830 <span class="comment"></span>
<a name="l03831"></a>03831 <span class="comment">/*! \brief Check extension state for an extension by using hint */</span>
<a name="l03832"></a><a class="code" href="pbx_8c.html#aed6cfe76441ef995ab80609020a9990c">03832</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aed6cfe76441ef995ab80609020a9990c" title="Uses hint and devicestate callback to get the state of an extension.">ast_extension_state</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten)
<a name="l03833"></a>03833 {
<a name="l03834"></a>03834    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e;
<a name="l03835"></a>03835 
<a name="l03836"></a>03836    <span class="keywordflow">if</span> (!(e = <a class="code" href="pbx_8c.html#a666d27d15c01c2b36dd8523a0146ba40">ast_hint_extension</a>(c, context, exten))) {  <span class="comment">/* Do we have a hint for this extension ? */</span>
<a name="l03837"></a>03837       <span class="keywordflow">return</span> -1;                   <span class="comment">/* No hint, return -1 */</span>
<a name="l03838"></a>03838    }
<a name="l03839"></a>03839 
<a name="l03840"></a>03840    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#a1ffd31790fbd06b1fcf1b44fd1333034" title="Check state of extension by using hints.">ast_extension_state2</a>(e);  <span class="comment">/* Check all devices in the hint */</span>
<a name="l03841"></a>03841 }
<a name="l03842"></a>03842 
<a name="l03843"></a><a class="code" href="pbx_8c.html#a3abd8b8b4dd20de2436440a2b1993dc0">03843</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a3abd8b8b4dd20de2436440a2b1993dc0">handle_statechange</a>(<span class="keywordtype">void</span> *datap)
<a name="l03844"></a>03844 {
<a name="l03845"></a>03845    <span class="keyword">struct </span>ast_hint *hint;
<a name="l03846"></a>03846    <span class="keyword">struct </span><a class="code" href="structstatechange.html">statechange</a> *sc = datap;
<a name="l03847"></a>03847 
<a name="l03848"></a>03848    <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l03849"></a>03849    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l03850"></a>03850 
<a name="l03851"></a>03851    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structhints.html">hints</a>, hint, list) {
<a name="l03852"></a>03852       <span class="keyword">struct </span>ast_state_cb *cblist;
<a name="l03853"></a>03853       <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l03854"></a>03854       <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a> = buf;
<a name="l03855"></a>03855       <span class="keywordtype">char</span> *cur;
<a name="l03856"></a>03856       <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>;
<a name="l03857"></a>03857 
<a name="l03858"></a>03858       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>), <span class="keyword">sizeof</span>(buf));
<a name="l03859"></a>03859       <span class="keywordflow">while</span> ( (cur = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;parse, <span class="stringliteral">&quot;&amp;&quot;</span>)) ) {
<a name="l03860"></a>03860          <span class="keywordflow">if</span> (!strcasecmp(cur, sc-&gt;<a class="code" href="structstatechange.html#afe67fe8a593b86ec431b116b7b4162d7">dev</a>)) {
<a name="l03861"></a>03861             <span class="keywordflow">break</span>;
<a name="l03862"></a>03862          }
<a name="l03863"></a>03863       }
<a name="l03864"></a>03864       <span class="keywordflow">if</span> (!cur) {
<a name="l03865"></a>03865          <span class="keywordflow">continue</span>;
<a name="l03866"></a>03866       }
<a name="l03867"></a>03867 
<a name="l03868"></a>03868       <span class="comment">/* Get device state for this hint */</span>
<a name="l03869"></a>03869       state = <a class="code" href="pbx_8c.html#a1ffd31790fbd06b1fcf1b44fd1333034" title="Check state of extension by using hints.">ast_extension_state2</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>);
<a name="l03870"></a>03870 
<a name="l03871"></a>03871       <span class="keywordflow">if</span> ((state == -1) || (state == hint-&gt;<a class="code" href="structast__hint.html#a0078d2e3ae10f15d7634c01199f33d4f">laststate</a>)) {
<a name="l03872"></a>03872          <span class="keywordflow">continue</span>;
<a name="l03873"></a>03873       }
<a name="l03874"></a>03874 
<a name="l03875"></a>03875       <span class="comment">/* Device state changed since last check - notify the watchers */</span>
<a name="l03876"></a>03876 
<a name="l03877"></a>03877       <span class="comment">/* For general callbacks */</span>
<a name="l03878"></a>03878       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structstatecbs.html">statecbs</a>, cblist, entry) {
<a name="l03879"></a>03879          cblist-&gt;<a class="code" href="structast__state__cb.html#a51f35e8871a0e589626a6c24024a2e17">callback</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a7733606f3f625c2782402ba971995641">parent</a>-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, state, cblist-&gt;<a class="code" href="structast__state__cb.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l03880"></a>03880       }
<a name="l03881"></a>03881 
<a name="l03882"></a>03882       <span class="comment">/* For extension callbacks */</span>
<a name="l03883"></a>03883       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;hint-&gt;<a class="code" href="structast__hint.html#aa3e3352bf7668925eba2e02ccdaf017a">callbacks</a>, cblist, entry) {
<a name="l03884"></a>03884          cblist-&gt;<a class="code" href="structast__state__cb.html#a51f35e8871a0e589626a6c24024a2e17">callback</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a7733606f3f625c2782402ba971995641">parent</a>-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, state, cblist-&gt;<a class="code" href="structast__state__cb.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l03885"></a>03885       }
<a name="l03886"></a>03886 
<a name="l03887"></a>03887       hint-&gt;<a class="code" href="structast__hint.html#a0078d2e3ae10f15d7634c01199f33d4f">laststate</a> = state;   <span class="comment">/* record we saw the change */</span>
<a name="l03888"></a>03888    }
<a name="l03889"></a>03889    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l03890"></a>03890    <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l03891"></a>03891    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sc);
<a name="l03892"></a>03892    <span class="keywordflow">return</span> 0;
<a name="l03893"></a>03893 }
<a name="l03894"></a>03894 <span class="comment"></span>
<a name="l03895"></a>03895 <span class="comment">/*! \brief  Add watcher for extension states */</span>
<a name="l03896"></a><a class="code" href="pbx_8c.html#aa3a30d0a841ee2bc0d87af763a99629f">03896</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aa3a30d0a841ee2bc0d87af763a99629f" title="Registers a state change callback.">ast_extension_state_add</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten,
<a name="l03897"></a>03897              <a class="code" href="pbx_8h.html#aa158b092800168cef19ea3fdd5b47538" title="Typedef for devicestate and hint callbacks.">ast_state_cb_type</a> callback, <span class="keywordtype">void</span> *data)
<a name="l03898"></a>03898 {
<a name="l03899"></a>03899    <span class="keyword">struct </span>ast_hint *hint;
<a name="l03900"></a>03900    <span class="keyword">struct </span>ast_state_cb *cblist;
<a name="l03901"></a>03901    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e;
<a name="l03902"></a>03902 
<a name="l03903"></a>03903    <span class="comment">/* If there&apos;s no context and extension:  add callback to statecbs list */</span>
<a name="l03904"></a>03904    <span class="keywordflow">if</span> (!context &amp;&amp; !exten) {
<a name="l03905"></a>03905       <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l03906"></a>03906 
<a name="l03907"></a>03907       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structstatecbs.html">statecbs</a>, cblist, entry) {
<a name="l03908"></a>03908          <span class="keywordflow">if</span> (cblist-&gt;<a class="code" href="structast__state__cb.html#a51f35e8871a0e589626a6c24024a2e17">callback</a> == callback) {
<a name="l03909"></a>03909             cblist-&gt;<a class="code" href="structast__state__cb.html#a735984d41155bc1032e09bece8f8d66d">data</a> = data;
<a name="l03910"></a>03910             <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l03911"></a>03911             <span class="keywordflow">return</span> 0;
<a name="l03912"></a>03912          }
<a name="l03913"></a>03913       }
<a name="l03914"></a>03914 
<a name="l03915"></a>03915       <span class="comment">/* Now insert the callback */</span>
<a name="l03916"></a>03916       <span class="keywordflow">if</span> (!(cblist = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*cblist)))) {
<a name="l03917"></a>03917          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l03918"></a>03918          <span class="keywordflow">return</span> -1;
<a name="l03919"></a>03919       }
<a name="l03920"></a>03920       cblist-&gt;<a class="code" href="structast__state__cb.html#a7441ef0865bcb3db9b8064dd7375c1ea">id</a> = 0;
<a name="l03921"></a>03921       cblist-&gt;<a class="code" href="structast__state__cb.html#a51f35e8871a0e589626a6c24024a2e17">callback</a> = callback;
<a name="l03922"></a>03922       cblist-&gt;<a class="code" href="structast__state__cb.html#a735984d41155bc1032e09bece8f8d66d">data</a> = data;
<a name="l03923"></a>03923 
<a name="l03924"></a>03924       <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;<a class="code" href="structstatecbs.html">statecbs</a>, cblist, entry);
<a name="l03925"></a>03925 
<a name="l03926"></a>03926       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l03927"></a>03927 
<a name="l03928"></a>03928       <span class="keywordflow">return</span> 0;
<a name="l03929"></a>03929    }
<a name="l03930"></a>03930 
<a name="l03931"></a>03931    <span class="keywordflow">if</span> (!context || !exten)
<a name="l03932"></a>03932       <span class="keywordflow">return</span> -1;
<a name="l03933"></a>03933 
<a name="l03934"></a>03934    <span class="comment">/* This callback type is for only one hint, so get the hint */</span>
<a name="l03935"></a>03935    e = <a class="code" href="pbx_8c.html#a666d27d15c01c2b36dd8523a0146ba40">ast_hint_extension</a>(NULL, context, exten);
<a name="l03936"></a>03936    <span class="keywordflow">if</span> (!e) {
<a name="l03937"></a>03937       <span class="keywordflow">return</span> -1;
<a name="l03938"></a>03938    }
<a name="l03939"></a>03939 
<a name="l03940"></a>03940    <span class="comment">/* If this is a pattern, dynamically create a new extension for this</span>
<a name="l03941"></a>03941 <span class="comment">    * particular match.  Note that this will only happen once for each</span>
<a name="l03942"></a>03942 <span class="comment">    * individual extension, because the pattern will no longer match first.</span>
<a name="l03943"></a>03943 <span class="comment">    */</span>
<a name="l03944"></a>03944    <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>[0] == <span class="charliteral">&apos;_&apos;</span>) {
<a name="l03945"></a>03945       <a class="code" href="pbx_8h.html#a07176e8d314eb68b3b50279fafa11390" title="Add and extension to an extension context.">ast_add_extension</a>(e-&gt;<a class="code" href="structast__exten.html#a7733606f3f625c2782402ba971995641">parent</a>-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, 0, exten, e-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, e-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>,
<a name="l03946"></a>03946          e-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> ? e-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a> : NULL, e-&gt;<a class="code" href="structast__exten.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">app</a>, <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(e-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a>), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>,
<a name="l03947"></a>03947          e-&gt;<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>);
<a name="l03948"></a>03948       e = <a class="code" href="pbx_8c.html#a666d27d15c01c2b36dd8523a0146ba40">ast_hint_extension</a>(NULL, context, exten);
<a name="l03949"></a>03949       <span class="keywordflow">if</span> (!e || e-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>[0] == <span class="charliteral">&apos;_&apos;</span>) {
<a name="l03950"></a>03950          <span class="keywordflow">return</span> -1;
<a name="l03951"></a>03951       }
<a name="l03952"></a>03952    }
<a name="l03953"></a>03953 
<a name="l03954"></a>03954    <span class="comment">/* Find the hint in the list of hints */</span>
<a name="l03955"></a>03955    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l03956"></a>03956 
<a name="l03957"></a>03957    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structhints.html">hints</a>, hint, list) {
<a name="l03958"></a>03958       <span class="keywordflow">if</span> (hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> == e)
<a name="l03959"></a>03959          <span class="keywordflow">break</span>;
<a name="l03960"></a>03960    }
<a name="l03961"></a>03961 
<a name="l03962"></a>03962    <span class="keywordflow">if</span> (!hint) {
<a name="l03963"></a>03963       <span class="comment">/* We have no hint, sorry */</span>
<a name="l03964"></a>03964       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l03965"></a>03965       <span class="keywordflow">return</span> -1;
<a name="l03966"></a>03966    }
<a name="l03967"></a>03967 
<a name="l03968"></a>03968    <span class="comment">/* Now insert the callback in the callback list  */</span>
<a name="l03969"></a>03969    <span class="keywordflow">if</span> (!(cblist = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*cblist)))) {
<a name="l03970"></a>03970       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l03971"></a>03971       <span class="keywordflow">return</span> -1;
<a name="l03972"></a>03972    }
<a name="l03973"></a>03973 
<a name="l03974"></a>03974    cblist-&gt;<a class="code" href="structast__state__cb.html#a7441ef0865bcb3db9b8064dd7375c1ea">id</a> = <a class="code" href="pbx_8c.html#a70382561daaa758a201b7a711d566e24">stateid</a>++;    <span class="comment">/* Unique ID for this callback */</span>
<a name="l03975"></a>03975    cblist-&gt;<a class="code" href="structast__state__cb.html#a51f35e8871a0e589626a6c24024a2e17">callback</a> = callback;  <span class="comment">/* Pointer to callback routine */</span>
<a name="l03976"></a>03976    cblist-&gt;<a class="code" href="structast__state__cb.html#a735984d41155bc1032e09bece8f8d66d">data</a> = data;    <span class="comment">/* Data for the callback */</span>
<a name="l03977"></a>03977 
<a name="l03978"></a>03978    <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;hint-&gt;<a class="code" href="structast__hint.html#aa3e3352bf7668925eba2e02ccdaf017a">callbacks</a>, cblist, entry);
<a name="l03979"></a>03979 
<a name="l03980"></a>03980    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l03981"></a>03981 
<a name="l03982"></a>03982    <span class="keywordflow">return</span> cblist-&gt;<a class="code" href="structast__state__cb.html#a7441ef0865bcb3db9b8064dd7375c1ea">id</a>;
<a name="l03983"></a>03983 }
<a name="l03984"></a>03984 <span class="comment"></span>
<a name="l03985"></a>03985 <span class="comment">/*! \brief Remove a watcher from the callback list */</span>
<a name="l03986"></a><a class="code" href="pbx_8c.html#a6740b689b39aa1503d1b858daf730873">03986</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a6740b689b39aa1503d1b858daf730873" title="Deletes a registered state change callback by ID.">ast_extension_state_del</a>(<span class="keywordtype">int</span> <span class="keywordtype">id</span>, <a class="code" href="pbx_8h.html#aa158b092800168cef19ea3fdd5b47538" title="Typedef for devicestate and hint callbacks.">ast_state_cb_type</a> callback)
<a name="l03987"></a>03987 {
<a name="l03988"></a>03988    <span class="keyword">struct </span>ast_state_cb *p_cur = NULL;
<a name="l03989"></a>03989    <span class="keywordtype">int</span> ret = -1;
<a name="l03990"></a>03990 
<a name="l03991"></a>03991    <span class="keywordflow">if</span> (!<span class="keywordtype">id</span> &amp;&amp; !callback)
<a name="l03992"></a>03992       <span class="keywordflow">return</span> -1;
<a name="l03993"></a>03993 
<a name="l03994"></a>03994    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l03995"></a>03995 
<a name="l03996"></a>03996    <span class="keywordflow">if</span> (!<span class="keywordtype">id</span>) {  <span class="comment">/* id == 0 is a callback without extension */</span>
<a name="l03997"></a>03997       <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structstatecbs.html">statecbs</a>, p_cur, entry) {
<a name="l03998"></a>03998          <span class="keywordflow">if</span> (p_cur-&gt;<a class="code" href="structast__state__cb.html#a51f35e8871a0e589626a6c24024a2e17">callback</a> == callback) {
<a name="l03999"></a>03999             <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entry);
<a name="l04000"></a>04000             <span class="keywordflow">break</span>;
<a name="l04001"></a>04001          }
<a name="l04002"></a>04002       }
<a name="l04003"></a>04003       <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l04004"></a>04004    } <span class="keywordflow">else</span> { <span class="comment">/* callback with extension, find the callback based on ID */</span>
<a name="l04005"></a>04005       <span class="keyword">struct </span>ast_hint *hint;
<a name="l04006"></a>04006       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structhints.html">hints</a>, hint, list) {
<a name="l04007"></a>04007          <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;hint-&gt;<a class="code" href="structast__hint.html#aa3e3352bf7668925eba2e02ccdaf017a">callbacks</a>, p_cur, entry) {
<a name="l04008"></a>04008             <span class="keywordflow">if</span> (p_cur-&gt;<a class="code" href="structast__state__cb.html#a7441ef0865bcb3db9b8064dd7375c1ea">id</a> == <span class="keywordtype">id</span>) {
<a name="l04009"></a>04009                <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entry);
<a name="l04010"></a>04010                <span class="keywordflow">break</span>;
<a name="l04011"></a>04011             }
<a name="l04012"></a>04012          }
<a name="l04013"></a>04013          <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l04014"></a>04014 
<a name="l04015"></a>04015          <span class="keywordflow">if</span> (p_cur)
<a name="l04016"></a>04016             <span class="keywordflow">break</span>;
<a name="l04017"></a>04017       }
<a name="l04018"></a>04018    }
<a name="l04019"></a>04019 
<a name="l04020"></a>04020    <span class="keywordflow">if</span> (p_cur) {
<a name="l04021"></a>04021       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(p_cur);
<a name="l04022"></a>04022    }
<a name="l04023"></a>04023 
<a name="l04024"></a>04024    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l04025"></a>04025 
<a name="l04026"></a>04026    <span class="keywordflow">return</span> ret;
<a name="l04027"></a>04027 }
<a name="l04028"></a>04028 
<a name="l04029"></a>04029 <span class="comment"></span>
<a name="l04030"></a>04030 <span class="comment">/*! \brief Add hint to hint list, check initial extension state; the hints had better be WRLOCKED already! */</span>
<a name="l04031"></a><a class="code" href="pbx_8c.html#a2258db148055b53f6647cbcfb20f5e8e">04031</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a2258db148055b53f6647cbcfb20f5e8e" title="Add hint to hint list, check initial extension state; the hints had better be WRLOCKED...">ast_add_hint_nolock</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e)
<a name="l04032"></a>04032 {
<a name="l04033"></a>04033    <span class="keyword">struct </span>ast_hint *hint;
<a name="l04034"></a>04034 
<a name="l04035"></a>04035    <span class="keywordflow">if</span> (!e)
<a name="l04036"></a>04036       <span class="keywordflow">return</span> -1;
<a name="l04037"></a>04037 
<a name="l04038"></a>04038    <span class="comment">/* Search if hint exists, do nothing */</span>
<a name="l04039"></a>04039    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structhints.html">hints</a>, hint, list) {
<a name="l04040"></a>04040       <span class="keywordflow">if</span> (hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> == e) {
<a name="l04041"></a>04041          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;HINTS: Not re-adding existing hint %s: %s\n&quot;</span>, <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e), <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(e));
<a name="l04042"></a>04042          <span class="keywordflow">return</span> -1;
<a name="l04043"></a>04043       }
<a name="l04044"></a>04044    }
<a name="l04045"></a>04045 
<a name="l04046"></a>04046    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;HINTS: Adding hint %s: %s\n&quot;</span>, <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e), <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(e));
<a name="l04047"></a>04047 
<a name="l04048"></a>04048    <span class="keywordflow">if</span> (!(hint = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*hint)))) {
<a name="l04049"></a>04049       <span class="keywordflow">return</span> -1;
<a name="l04050"></a>04050    }
<a name="l04051"></a>04051    <span class="comment">/* Initialize and insert new item at the top */</span>
<a name="l04052"></a>04052    hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> = e;
<a name="l04053"></a>04053    hint-&gt;<a class="code" href="structast__hint.html#a0078d2e3ae10f15d7634c01199f33d4f">laststate</a> = <a class="code" href="pbx_8c.html#a1ffd31790fbd06b1fcf1b44fd1333034" title="Check state of extension by using hints.">ast_extension_state2</a>(e);
<a name="l04054"></a>04054    <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;<a class="code" href="structhints.html">hints</a>, hint, list);
<a name="l04055"></a>04055 
<a name="l04056"></a>04056    <span class="keywordflow">return</span> 0;
<a name="l04057"></a>04057 }
<a name="l04058"></a>04058 <span class="comment"></span>
<a name="l04059"></a>04059 <span class="comment">/*! \brief Add hint to hint list, check initial extension state */</span>
<a name="l04060"></a><a class="code" href="pbx_8c.html#ae46143d88ad157ae0e848c7167891fa1">04060</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#ae46143d88ad157ae0e848c7167891fa1" title="Add hint to hint list, check initial extension state.">ast_add_hint</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e)
<a name="l04061"></a>04061 {
<a name="l04062"></a>04062    <span class="keywordtype">int</span> ret;
<a name="l04063"></a>04063 
<a name="l04064"></a>04064    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l04065"></a>04065    ret = <a class="code" href="pbx_8c.html#a2258db148055b53f6647cbcfb20f5e8e" title="Add hint to hint list, check initial extension state; the hints had better be WRLOCKED...">ast_add_hint_nolock</a>(e);
<a name="l04066"></a>04066    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l04067"></a>04067 
<a name="l04068"></a>04068    <span class="keywordflow">return</span> ret;
<a name="l04069"></a>04069 }
<a name="l04070"></a>04070 <span class="comment"></span>
<a name="l04071"></a>04071 <span class="comment">/*! \brief Change hint for an extension */</span>
<a name="l04072"></a><a class="code" href="pbx_8c.html#adfb9d0de487a52af57ed7953508cee82">04072</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#adfb9d0de487a52af57ed7953508cee82" title="Change hint for an extension.">ast_change_hint</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *oe, <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *ne)
<a name="l04073"></a>04073 {
<a name="l04074"></a>04074    <span class="keyword">struct </span>ast_hint *hint;
<a name="l04075"></a>04075    <span class="keywordtype">int</span> res = -1;
<a name="l04076"></a>04076 
<a name="l04077"></a>04077    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l04078"></a>04078    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structhints.html">hints</a>, hint, list) {
<a name="l04079"></a>04079       <span class="keywordflow">if</span> (hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> == oe) {
<a name="l04080"></a>04080          hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> = ne;
<a name="l04081"></a>04081          res = 0;
<a name="l04082"></a>04082          <span class="keywordflow">break</span>;
<a name="l04083"></a>04083       }
<a name="l04084"></a>04084    }
<a name="l04085"></a>04085    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l04086"></a>04086 
<a name="l04087"></a>04087    <span class="keywordflow">return</span> res;
<a name="l04088"></a>04088 }
<a name="l04089"></a>04089 <span class="comment"></span>
<a name="l04090"></a>04090 <span class="comment">/*! \brief Remove hint from extension */</span>
<a name="l04091"></a><a class="code" href="pbx_8c.html#a8fcc10d31d51afba693ef9a4cb162c6a">04091</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a8fcc10d31d51afba693ef9a4cb162c6a" title="Remove hint from extension.">ast_remove_hint</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e)
<a name="l04092"></a>04092 {
<a name="l04093"></a>04093    <span class="comment">/* Cleanup the Notifys if hint is removed */</span>
<a name="l04094"></a>04094    <span class="keyword">struct </span>ast_hint *hint;
<a name="l04095"></a>04095    <span class="keyword">struct </span>ast_state_cb *cblist;
<a name="l04096"></a>04096    <span class="keywordtype">int</span> res = -1;
<a name="l04097"></a>04097 
<a name="l04098"></a>04098    <span class="keywordflow">if</span> (!e)
<a name="l04099"></a>04099       <span class="keywordflow">return</span> -1;
<a name="l04100"></a>04100 
<a name="l04101"></a>04101    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structhints.html">hints</a>, hint, list) {
<a name="l04102"></a>04102       <span class="keywordflow">if</span> (hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> != e)
<a name="l04103"></a>04103          <span class="keywordflow">continue</span>;
<a name="l04104"></a>04104 
<a name="l04105"></a>04105       <span class="keywordflow">while</span> ((cblist = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;hint-&gt;<a class="code" href="structast__hint.html#aa3e3352bf7668925eba2e02ccdaf017a">callbacks</a>, entry))) {
<a name="l04106"></a>04106          <span class="comment">/* Notify with -1 and remove all callbacks */</span>
<a name="l04107"></a>04107          cblist-&gt;<a class="code" href="structast__state__cb.html#a51f35e8871a0e589626a6c24024a2e17">callback</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a7733606f3f625c2782402ba971995641">parent</a>-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>,
<a name="l04108"></a>04108             <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625faf53cb090b99fb8e952c8151990bd4192">AST_EXTENSION_DEACTIVATED</a>, cblist-&gt;<a class="code" href="structast__state__cb.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l04109"></a>04109          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cblist);
<a name="l04110"></a>04110       }
<a name="l04111"></a>04111 
<a name="l04112"></a>04112       <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(list);
<a name="l04113"></a>04113       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(hint);
<a name="l04114"></a>04114 
<a name="l04115"></a>04115       res = 0;
<a name="l04116"></a>04116 
<a name="l04117"></a>04117       <span class="keywordflow">break</span>;
<a name="l04118"></a>04118    }
<a name="l04119"></a>04119    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l04120"></a>04120 
<a name="l04121"></a>04121    <span class="keywordflow">return</span> res;
<a name="l04122"></a>04122 }
<a name="l04123"></a>04123 
<a name="l04124"></a>04124 <span class="comment"></span>
<a name="l04125"></a>04125 <span class="comment">/*! \brief Get hint for channel */</span>
<a name="l04126"></a><a class="code" href="pbx_8c.html#ac778ac642def88a06e5d59e11a964c43">04126</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#ac778ac642def88a06e5d59e11a964c43" title="If an extension hint exists, return non-zero.">ast_get_hint</a>(<span class="keywordtype">char</span> *hint, <span class="keywordtype">int</span> hintsize, <span class="keywordtype">char</span> *name, <span class="keywordtype">int</span> namesize, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten)
<a name="l04127"></a>04127 {
<a name="l04128"></a>04128    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e = <a class="code" href="pbx_8c.html#a666d27d15c01c2b36dd8523a0146ba40">ast_hint_extension</a>(c, context, exten);
<a name="l04129"></a>04129 
<a name="l04130"></a>04130    <span class="keywordflow">if</span> (e) {
<a name="l04131"></a>04131       <span class="keywordflow">if</span> (hint)
<a name="l04132"></a>04132          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(hint, <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(e), hintsize);
<a name="l04133"></a>04133       <span class="keywordflow">if</span> (name) {
<a name="l04134"></a>04134          <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp = <a class="code" href="pbx_8h.html#ac0a6c0c39796f36864868365d8989f02">ast_get_extension_app_data</a>(e);
<a name="l04135"></a>04135          <span class="keywordflow">if</span> (tmp)
<a name="l04136"></a>04136             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(name, tmp, namesize);
<a name="l04137"></a>04137       }
<a name="l04138"></a>04138       <span class="keywordflow">return</span> -1;
<a name="l04139"></a>04139    }
<a name="l04140"></a>04140    <span class="keywordflow">return</span> 0;
<a name="l04141"></a>04141 }
<a name="l04142"></a>04142 
<a name="l04143"></a><a class="code" href="pbx_8c.html#a64a5b8fdc919806135ad427aca9e71b7">04143</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid)
<a name="l04144"></a>04144 {
<a name="l04145"></a>04145    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#ae381d99bea85b43f022470b64171018d" title="The return value depends on the action:.">pbx_extension_helper</a>(c, NULL, context, exten, priority, NULL, callerid, <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea2e605157e82dec388ffc89c1694fb7be">E_MATCH</a>, 0, 0);
<a name="l04146"></a>04146 }
<a name="l04147"></a>04147 
<a name="l04148"></a><a class="code" href="pbx_8c.html#a0be9518646cf9aca4878b313cc02e901">04148</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a0be9518646cf9aca4878b313cc02e901" title="Find the priority of an extension that has the specified label.">ast_findlabel_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keyword">const</span> <span class="keywordtype">char</span> *label, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid)
<a name="l04149"></a>04149 {
<a name="l04150"></a>04150    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#ae381d99bea85b43f022470b64171018d" title="The return value depends on the action:.">pbx_extension_helper</a>(c, NULL, context, exten, 0, label, callerid, <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7b10ab7b3dd6af9d933dbb03dd183eb5">E_FINDLABEL</a>, 0, 0);
<a name="l04151"></a>04151 }
<a name="l04152"></a>04152 
<a name="l04153"></a><a class="code" href="pbx_8c.html#aa3c47773f118e7775a5c052dbb4bb3aa">04153</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aa3c47773f118e7775a5c052dbb4bb3aa" title="Find the priority of an extension that has the specified label.">ast_findlabel_extension2</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keyword">const</span> <span class="keywordtype">char</span> *label, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid)
<a name="l04154"></a>04154 {
<a name="l04155"></a>04155    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#ae381d99bea85b43f022470b64171018d" title="The return value depends on the action:.">pbx_extension_helper</a>(c, con, NULL, exten, 0, label, callerid, <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7b10ab7b3dd6af9d933dbb03dd183eb5">E_FINDLABEL</a>, 0, 0);
<a name="l04156"></a>04156 }
<a name="l04157"></a>04157 
<a name="l04158"></a><a class="code" href="pbx_8c.html#a93f9868530c1e8a9d9d367d1ead8782e">04158</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a93f9868530c1e8a9d9d367d1ead8782e" title="Looks for a valid matching extension.">ast_canmatch_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid)
<a name="l04159"></a>04159 {
<a name="l04160"></a>04160    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#ae381d99bea85b43f022470b64171018d" title="The return value depends on the action:.">pbx_extension_helper</a>(c, NULL, context, exten, priority, NULL, callerid, <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea413c09377a892aa154e7669cbdaf27ba">E_CANMATCH</a>, 0, 0);
<a name="l04161"></a>04161 }
<a name="l04162"></a>04162 
<a name="l04163"></a><a class="code" href="pbx_8c.html#ac359af75b9494f50904583d2168a7577">04163</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#ac359af75b9494f50904583d2168a7577" title="Looks to see if adding anything to this extension might match something. (exists...">ast_matchmore_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid)
<a name="l04164"></a>04164 {
<a name="l04165"></a>04165    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#ae381d99bea85b43f022470b64171018d" title="The return value depends on the action:.">pbx_extension_helper</a>(c, NULL, context, exten, priority, NULL, callerid, <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>, 0, 0);
<a name="l04166"></a>04166 }
<a name="l04167"></a>04167 
<a name="l04168"></a><a class="code" href="pbx_8c.html#a94ca71e502d95d1cb0a815072e059aee">04168</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a94ca71e502d95d1cb0a815072e059aee" title="Launch a new extension (i.e. new stack).">ast_spawn_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keywordtype">int</span> *found, <span class="keywordtype">int</span> combined_find_spawn)
<a name="l04169"></a>04169 {
<a name="l04170"></a>04170    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#ae381d99bea85b43f022470b64171018d" title="The return value depends on the action:.">pbx_extension_helper</a>(c, NULL, context, exten, priority, NULL, callerid, <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea8f986496ee140e4c7167ae25ad28d0ee">E_SPAWN</a>, found, combined_find_spawn);
<a name="l04171"></a>04171 }
<a name="l04172"></a>04172 <span class="comment"></span>
<a name="l04173"></a>04173 <span class="comment">/*! helper function to set extension and priority */</span>
<a name="l04174"></a><a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">04174</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> pri)
<a name="l04175"></a>04175 {
<a name="l04176"></a>04176    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(c);
<a name="l04177"></a>04177    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, exten, <span class="keyword">sizeof</span>(c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l04178"></a>04178    c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = pri;
<a name="l04179"></a>04179    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c);
<a name="l04180"></a>04180 }
<a name="l04181"></a>04181 <span class="comment"></span>
<a name="l04182"></a>04182 <span class="comment">/*!</span>
<a name="l04183"></a>04183 <span class="comment"> * \brief collect digits from the channel into the buffer.</span>
<a name="l04184"></a>04184 <span class="comment"> * \param waittime is in milliseconds</span>
<a name="l04185"></a>04185 <span class="comment"> * \retval 0 on timeout or done.</span>
<a name="l04186"></a>04186 <span class="comment"> * \retval -1 on error.</span>
<a name="l04187"></a>04187 <span class="comment">*/</span>
<a name="l04188"></a><a class="code" href="pbx_8c.html#aed1020578edff9baad853fc543464432">04188</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#aed1020578edff9baad853fc543464432" title="collect digits from the channel into the buffer.">collect_digits</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">int</span> waittime, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> buflen, <span class="keywordtype">int</span> pos)
<a name="l04189"></a>04189 {
<a name="l04190"></a>04190    <span class="keywordtype">int</span> digit;
<a name="l04191"></a>04191 
<a name="l04192"></a>04192    buf[pos] = <span class="charliteral">&apos;\0&apos;</span>;  <span class="comment">/* make sure it is properly terminated */</span>
<a name="l04193"></a>04193    <span class="keywordflow">while</span> (<a class="code" href="pbx_8h.html#ac359af75b9494f50904583d2168a7577" title="Looks to see if adding anything to this extension might match something. (exists...">ast_matchmore_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, buf, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04194"></a>04194       <span class="comment">/* As long as we&apos;re willing to wait, and as long as it&apos;s not defined,</span>
<a name="l04195"></a>04195 <span class="comment">         keep reading digits until we can&apos;t possibly get a right answer anymore.  */</span>
<a name="l04196"></a>04196       digit = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(c, waittime);
<a name="l04197"></a>04197       <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> == <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a085c0c603de12dc2474a17a92e1cb5a4">AST_SOFTHANGUP_ASYNCGOTO</a>) {
<a name="l04198"></a>04198          c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> = 0;
<a name="l04199"></a>04199       } <span class="keywordflow">else</span> {
<a name="l04200"></a>04200          <span class="keywordflow">if</span> (!digit) <span class="comment">/* No entry */</span>
<a name="l04201"></a>04201             <span class="keywordflow">break</span>;
<a name="l04202"></a>04202          <span class="keywordflow">if</span> (digit &lt; 0) <span class="comment">/* Error, maybe a  hangup */</span>
<a name="l04203"></a>04203             <span class="keywordflow">return</span> -1;
<a name="l04204"></a>04204          <span class="keywordflow">if</span> (pos &lt; buflen - 1) { <span class="comment">/* XXX maybe error otherwise ? */</span>
<a name="l04205"></a>04205             buf[pos++] = digit;
<a name="l04206"></a>04206             buf[pos] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04207"></a>04207          }
<a name="l04208"></a>04208          waittime = c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a>;
<a name="l04209"></a>04209       }
<a name="l04210"></a>04210    }
<a name="l04211"></a>04211    <span class="keywordflow">return</span> 0;
<a name="l04212"></a>04212 }
<a name="l04213"></a>04213 
<a name="l04214"></a><a class="code" href="pbx_8c.html#ab203ba8e71a7c11736a40f7967ba1fdf">04214</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735" title="The result codes when starting the PBX on a channel with.">ast_pbx_result</a> <a class="code" href="pbx_8c.html#ab203ba8e71a7c11736a40f7967ba1fdf">__ast_pbx_run</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c,
<a name="l04215"></a>04215       <span class="keyword">struct</span> <a class="code" href="structast__pbx__args.html" title="Options for ast_pbx_run().">ast_pbx_args</a> *args)
<a name="l04216"></a>04216 {
<a name="l04217"></a>04217    <span class="keywordtype">int</span> found = 0; <span class="comment">/* set if we find at least one match */</span>
<a name="l04218"></a>04218    <span class="keywordtype">int</span> res = 0;
<a name="l04219"></a>04219    <span class="keywordtype">int</span> autoloopflag;
<a name="l04220"></a>04220    <span class="keywordtype">int</span> error = 0;    <span class="comment">/* set an error conditions */</span>
<a name="l04221"></a>04221 
<a name="l04222"></a>04222    <span class="comment">/* A little initial setup here */</span>
<a name="l04223"></a>04223    <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>) {
<a name="l04224"></a>04224       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s already has PBX structure??\n&quot;</span>, c-&gt;name);
<a name="l04225"></a>04225       <span class="comment">/* XXX and now what ? */</span>
<a name="l04226"></a>04226       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>);
<a name="l04227"></a>04227    }
<a name="l04228"></a>04228    <span class="keywordflow">if</span> (!(c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a> = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>))))
<a name="l04229"></a>04229       <span class="keywordflow">return</span> -1;
<a name="l04230"></a>04230    <span class="comment">/* Set reasonable defaults */</span>
<a name="l04231"></a>04231    c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a765bfb11e07b0f90c235c9af9d7f46fa">rtimeoutms</a> = 10000;
<a name="l04232"></a>04232    c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a> = 5000;
<a name="l04233"></a>04233 
<a name="l04234"></a>04234    autoloopflag = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a5ff4f7a94a36fcc2b8628186cb643d4b">AST_FLAG_IN_AUTOLOOP</a>);   <span class="comment">/* save value to restore at the end */</span>
<a name="l04235"></a>04235    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a5ff4f7a94a36fcc2b8628186cb643d4b">AST_FLAG_IN_AUTOLOOP</a>);
<a name="l04236"></a>04236 
<a name="l04237"></a>04237    <span class="comment">/* Start by trying whatever the channel is set to */</span>
<a name="l04238"></a>04238    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04239"></a>04239       <span class="comment">/* If not successful fall back to &apos;s&apos; */</span>
<a name="l04240"></a>04240       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Starting %s at %s,%s,%d failed so falling back to exten &apos;s&apos;\n&quot;</span>, c-&gt;name, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l04241"></a>04241       <span class="comment">/* XXX the original code used the existing priority in the call to</span>
<a name="l04242"></a>04242 <span class="comment">       * ast_exists_extension(), and reset it to 1 afterwards.</span>
<a name="l04243"></a>04243 <span class="comment">       * I believe the correct thing is to set it to 1 immediately.</span>
<a name="l04244"></a>04244 <span class="comment">       */</span>
<a name="l04245"></a>04245       <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(c, <span class="stringliteral">&quot;s&quot;</span>, 1);
<a name="l04246"></a>04246       <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04247"></a>04247          <span class="comment">/* JK02: And finally back to default if everything else failed */</span>
<a name="l04248"></a>04248          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Starting %s at %s,%s,%d still failed so falling back to context &apos;default&apos;\n&quot;</span>, c-&gt;name, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l04249"></a>04249          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;default&quot;</span>, <span class="keyword">sizeof</span>(c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l04250"></a>04250       }
<a name="l04251"></a>04251    }
<a name="l04252"></a>04252    <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>) {
<a name="l04253"></a>04253       <span class="comment">/* allow CDR variables that have been collected after channel was created to be visible during call */</span>
<a name="l04254"></a>04254       <a class="code" href="cdr_8h.html#a92b2e3b685887b48d228f7546ae1a9f1">ast_cdr_update</a>(c);
<a name="l04255"></a>04255    }
<a name="l04256"></a>04256    <span class="keywordflow">for</span> (;;) {
<a name="l04257"></a>04257       <span class="keywordtype">char</span> dst_exten[256]; <span class="comment">/* buffer to accumulate digits */</span>
<a name="l04258"></a>04258       <span class="keywordtype">int</span> pos = 0;      <span class="comment">/* XXX should check bounds */</span>
<a name="l04259"></a>04259       <span class="keywordtype">int</span> digit = 0;
<a name="l04260"></a>04260       <span class="keywordtype">int</span> invalid = 0;
<a name="l04261"></a>04261       <span class="keywordtype">int</span> timeout = 0;
<a name="l04262"></a>04262 
<a name="l04263"></a>04263       <span class="comment">/* loop on priorities in this context/exten */</span>
<a name="l04264"></a>04264       <span class="keywordflow">while</span> ( !(res = <a class="code" href="pbx_8h.html#a94ca71e502d95d1cb0a815072e059aee" title="Launch a new extension (i.e. new stack).">ast_spawn_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, &amp;found,1))) {
<a name="l04265"></a>04265          <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> == <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a90cd950abc1c22b0701a476bdd6cc246">AST_SOFTHANGUP_TIMEOUT</a> &amp;&amp; <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;T&quot;</span>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04266"></a>04266             <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(c, <span class="stringliteral">&quot;T&quot;</span>, 0); <span class="comment">/* 0 will become 1 with the c-&gt;priority++; at the end */</span>
<a name="l04267"></a>04267             <span class="comment">/* If the AbsoluteTimeout is not reset to 0, we&apos;ll get an infinite loop */</span>
<a name="l04268"></a>04268             memset(&amp;c-&gt;<a class="code" href="structast__channel.html#a645928dea02ce2132b83e7e61ef5b80a">whentohangup</a>, 0, <span class="keyword">sizeof</span>(c-&gt;<a class="code" href="structast__channel.html#a645928dea02ce2132b83e7e61ef5b80a">whentohangup</a>));
<a name="l04269"></a>04269             c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> &amp;= ~<a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a90cd950abc1c22b0701a476bdd6cc246">AST_SOFTHANGUP_TIMEOUT</a>;
<a name="l04270"></a>04270          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> == <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a90cd950abc1c22b0701a476bdd6cc246">AST_SOFTHANGUP_TIMEOUT</a> &amp;&amp; <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;e&quot;</span>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04271"></a>04271             <a class="code" href="pbx_8h.html#abc705e1c806491af6419892a1237d920">pbx_builtin_raise_exception</a>(c, <span class="stringliteral">&quot;ABSOLUTETIMEOUT&quot;</span>);
<a name="l04272"></a>04272             <span class="comment">/* If the AbsoluteTimeout is not reset to 0, we&apos;ll get an infinite loop */</span>
<a name="l04273"></a>04273             memset(&amp;c-&gt;<a class="code" href="structast__channel.html#a645928dea02ce2132b83e7e61ef5b80a">whentohangup</a>, 0, <span class="keyword">sizeof</span>(c-&gt;<a class="code" href="structast__channel.html#a645928dea02ce2132b83e7e61ef5b80a">whentohangup</a>));
<a name="l04274"></a>04274             c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> &amp;= ~<a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a90cd950abc1c22b0701a476bdd6cc246">AST_SOFTHANGUP_TIMEOUT</a>;
<a name="l04275"></a>04275          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> == <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a085c0c603de12dc2474a17a92e1cb5a4">AST_SOFTHANGUP_ASYNCGOTO</a>) {
<a name="l04276"></a>04276             c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> = 0;
<a name="l04277"></a>04277             <span class="keywordflow">continue</span>;
<a name="l04278"></a>04278          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(c)) {
<a name="l04279"></a>04279             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Extension %s, priority %d returned normally even though call was hung up\n&quot;</span>,
<a name="l04280"></a>04280                c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l04281"></a>04281             error = 1;
<a name="l04282"></a>04282             <span class="keywordflow">break</span>;
<a name="l04283"></a>04283          }
<a name="l04284"></a>04284          c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>++;
<a name="l04285"></a>04285       } <span class="comment">/* end while  - from here on we can use &apos;break&apos; to go out */</span>
<a name="l04286"></a>04286       <span class="keywordflow">if</span> (found &amp;&amp; res) {
<a name="l04287"></a>04287          <span class="comment">/* Something bad happened, or a hangup has been requested. */</span>
<a name="l04288"></a>04288          <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;0123456789ABCDEF*#&quot;</span>, res)) {
<a name="l04289"></a>04289             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Oooh, got something to jump out with (&apos;%c&apos;)!\n&quot;</span>, res);
<a name="l04290"></a>04290             pos = 0;
<a name="l04291"></a>04291             dst_exten[pos++] = digit = res;
<a name="l04292"></a>04292             dst_exten[pos] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04293"></a>04293          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == <a class="code" href="pbx_8h.html#a653bef57d41c00d6b1f79c94fe19ec7b">AST_PBX_INCOMPLETE</a>) {
<a name="l04294"></a>04294             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Spawn extension (%s,%s,%d) exited INCOMPLETE on &apos;%s&apos;\n&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, c-&gt;name);
<a name="l04295"></a>04295             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Spawn extension (%s, %s, %d) exited INCOMPLETE on &apos;%s&apos;\n&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, c-&gt;name);
<a name="l04296"></a>04296 
<a name="l04297"></a>04297             <span class="comment">/* Don&apos;t cycle on incomplete - this will happen if the only extension that matches is our &quot;incomplete&quot; extension */</span>
<a name="l04298"></a>04298             <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#ac359af75b9494f50904583d2168a7577" title="Looks to see if adding anything to this extension might match something. (exists...">ast_matchmore_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04299"></a>04299                invalid = 1;
<a name="l04300"></a>04300             } <span class="keywordflow">else</span> {
<a name="l04301"></a>04301                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dst_exten, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(dst_exten));
<a name="l04302"></a>04302                digit = 1;
<a name="l04303"></a>04303                pos = strlen(dst_exten);
<a name="l04304"></a>04304             }
<a name="l04305"></a>04305          } <span class="keywordflow">else</span> {
<a name="l04306"></a>04306             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Spawn extension (%s,%s,%d) exited non-zero on &apos;%s&apos;\n&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, c-&gt;name);
<a name="l04307"></a>04307             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Spawn extension (%s, %s, %d) exited non-zero on &apos;%s&apos;\n&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, c-&gt;name);
<a name="l04308"></a>04308 
<a name="l04309"></a>04309             <span class="keywordflow">if</span> ((res == <a class="code" href="pbx_8h.html#aabc320b5f03ccc254bde047d2e2ec0e0">AST_PBX_ERROR</a>) &amp;&amp; <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;e&quot;</span>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04310"></a>04310                <span class="comment">/* if we are already on the &apos;e&apos; exten, don&apos;t jump to it again */</span>
<a name="l04311"></a>04311                <span class="keywordflow">if</span> (!strcmp(c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="stringliteral">&quot;e&quot;</span>)) {
<a name="l04312"></a>04312                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Spawn extension (%s, %s, %d) exited ERROR while already on &apos;e&apos; exten on &apos;%s&apos;\n&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, c-&gt;name);
<a name="l04313"></a>04313                   error = 1;
<a name="l04314"></a>04314                } <span class="keywordflow">else</span> {
<a name="l04315"></a>04315                   <a class="code" href="pbx_8h.html#abc705e1c806491af6419892a1237d920">pbx_builtin_raise_exception</a>(c, <span class="stringliteral">&quot;ERROR&quot;</span>);
<a name="l04316"></a>04316                   <span class="keywordflow">continue</span>;
<a name="l04317"></a>04317                }
<a name="l04318"></a>04318             }
<a name="l04319"></a>04319 
<a name="l04320"></a>04320             <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> == <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a085c0c603de12dc2474a17a92e1cb5a4">AST_SOFTHANGUP_ASYNCGOTO</a>) {
<a name="l04321"></a>04321                c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> = 0;
<a name="l04322"></a>04322                <span class="keywordflow">continue</span>;
<a name="l04323"></a>04323             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> == <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a90cd950abc1c22b0701a476bdd6cc246">AST_SOFTHANGUP_TIMEOUT</a> &amp;&amp; <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;T&quot;</span>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04324"></a>04324                <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(c, <span class="stringliteral">&quot;T&quot;</span>, 1);
<a name="l04325"></a>04325                <span class="comment">/* If the AbsoluteTimeout is not reset to 0, we&apos;ll get an infinite loop */</span>
<a name="l04326"></a>04326                memset(&amp;c-&gt;<a class="code" href="structast__channel.html#a645928dea02ce2132b83e7e61ef5b80a">whentohangup</a>, 0, <span class="keyword">sizeof</span>(c-&gt;<a class="code" href="structast__channel.html#a645928dea02ce2132b83e7e61ef5b80a">whentohangup</a>));
<a name="l04327"></a>04327                c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> &amp;= ~<a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a90cd950abc1c22b0701a476bdd6cc246">AST_SOFTHANGUP_TIMEOUT</a>;
<a name="l04328"></a>04328                <span class="keywordflow">continue</span>;
<a name="l04329"></a>04329             } <span class="keywordflow">else</span> {
<a name="l04330"></a>04330                <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l04331"></a>04331                   <a class="code" href="cdr_8h.html#a92b2e3b685887b48d228f7546ae1a9f1">ast_cdr_update</a>(c);
<a name="l04332"></a>04332                error = 1;
<a name="l04333"></a>04333                <span class="keywordflow">break</span>;
<a name="l04334"></a>04334             }
<a name="l04335"></a>04335          }
<a name="l04336"></a>04336       }
<a name="l04337"></a>04337       <span class="keywordflow">if</span> (error)
<a name="l04338"></a>04338          <span class="keywordflow">break</span>;
<a name="l04339"></a>04339 <span class="comment"></span>
<a name="l04340"></a>04340 <span class="comment">      /*!\note</span>
<a name="l04341"></a>04341 <span class="comment">       * We get here on a failure of some kind:  non-existing extension or</span>
<a name="l04342"></a>04342 <span class="comment">       * hangup.  We have options, here.  We can either catch the failure</span>
<a name="l04343"></a>04343 <span class="comment">       * and continue, or we can drop out entirely. */</span>
<a name="l04344"></a>04344 
<a name="l04345"></a>04345       <span class="keywordflow">if</span> (invalid || !<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {<span class="comment"></span>
<a name="l04346"></a>04346 <span class="comment">         /*!\note</span>
<a name="l04347"></a>04347 <span class="comment">          * If there is no match at priority 1, it is not a valid extension anymore.</span>
<a name="l04348"></a>04348 <span class="comment">          * Try to continue at &quot;i&quot; (for invalid) or &quot;e&quot; (for exception) or exit if</span>
<a name="l04349"></a>04349 <span class="comment">          * neither exist.</span>
<a name="l04350"></a>04350 <span class="comment">          */</span>
<a name="l04351"></a>04351          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;i&quot;</span>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04352"></a>04352             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Sent into invalid extension &apos;%s&apos; in context &apos;%s&apos; on %s\n&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;name);
<a name="l04353"></a>04353             <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(c, <span class="stringliteral">&quot;INVALID_EXTEN&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>);
<a name="l04354"></a>04354             <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(c, <span class="stringliteral">&quot;i&quot;</span>, 1);
<a name="l04355"></a>04355          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;e&quot;</span>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04356"></a>04356             <a class="code" href="pbx_8h.html#abc705e1c806491af6419892a1237d920">pbx_builtin_raise_exception</a>(c, <span class="stringliteral">&quot;INVALID&quot;</span>);
<a name="l04357"></a>04357          } <span class="keywordflow">else</span> {
<a name="l04358"></a>04358             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; sent into invalid extension &apos;%s&apos; in context &apos;%s&apos;, but no invalid handler\n&quot;</span>,
<a name="l04359"></a>04359                c-&gt;name, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l04360"></a>04360             error = 1; <span class="comment">/* we know what to do with it */</span>
<a name="l04361"></a>04361             <span class="keywordflow">break</span>;
<a name="l04362"></a>04362          }
<a name="l04363"></a>04363       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> == <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a90cd950abc1c22b0701a476bdd6cc246">AST_SOFTHANGUP_TIMEOUT</a>) {
<a name="l04364"></a>04364          <span class="comment">/* If we get this far with AST_SOFTHANGUP_TIMEOUT, then we know that the &quot;T&quot; extension is next. */</span>
<a name="l04365"></a>04365          c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> = 0;
<a name="l04366"></a>04366       } <span class="keywordflow">else</span> { <span class="comment">/* keypress received, get more digits for a full extension */</span>
<a name="l04367"></a>04367          <span class="keywordtype">int</span> waittime = 0;
<a name="l04368"></a>04368          <span class="keywordflow">if</span> (digit)
<a name="l04369"></a>04369             waittime = c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a>;
<a name="l04370"></a>04370          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="pbx_8c.html#a5f7ea48b3f8614ef9314e5aece1f1bc3">autofallthrough</a>)
<a name="l04371"></a>04371             waittime = c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a765bfb11e07b0f90c235c9af9d7f46fa">rtimeoutms</a>;
<a name="l04372"></a>04372          <span class="keywordflow">if</span> (!waittime) {
<a name="l04373"></a>04373             <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(c, <span class="stringliteral">&quot;DIALSTATUS&quot;</span>);
<a name="l04374"></a>04374             <span class="keywordflow">if</span> (!status)
<a name="l04375"></a>04375                status = <span class="stringliteral">&quot;UNKNOWN&quot;</span>;
<a name="l04376"></a>04376             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Auto fallthrough, channel &apos;%s&apos; status is &apos;%s&apos;\n&quot;</span>, c-&gt;name, status);
<a name="l04377"></a>04377             <span class="keywordflow">if</span> (!strcasecmp(status, <span class="stringliteral">&quot;CONGESTION&quot;</span>))
<a name="l04378"></a>04378                res = <a class="code" href="group__applications.html#ga5f356581010a6f1ed24407db1758cdc2">pbx_builtin_congestion</a>(c, <span class="stringliteral">&quot;10&quot;</span>);
<a name="l04379"></a>04379             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(status, <span class="stringliteral">&quot;CHANUNAVAIL&quot;</span>))
<a name="l04380"></a>04380                res = <a class="code" href="group__applications.html#ga5f356581010a6f1ed24407db1758cdc2">pbx_builtin_congestion</a>(c, <span class="stringliteral">&quot;10&quot;</span>);
<a name="l04381"></a>04381             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(status, <span class="stringliteral">&quot;BUSY&quot;</span>))
<a name="l04382"></a>04382                res = <a class="code" href="group__applications.html#gafdd3cfad2a2fa9180649782c8794b01f">pbx_builtin_busy</a>(c, <span class="stringliteral">&quot;10&quot;</span>);
<a name="l04383"></a>04383             error = 1; <span class="comment">/* XXX disable message */</span>
<a name="l04384"></a>04384             <span class="keywordflow">break</span>;   <span class="comment">/* exit from the &apos;for&apos; loop */</span>
<a name="l04385"></a>04385          }
<a name="l04386"></a>04386 
<a name="l04387"></a>04387          <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#aed1020578edff9baad853fc543464432" title="collect digits from the channel into the buffer.">collect_digits</a>(c, waittime, dst_exten, <span class="keyword">sizeof</span>(dst_exten), pos))
<a name="l04388"></a>04388             <span class="keywordflow">break</span>;
<a name="l04389"></a>04389          <span class="keywordflow">if</span> (res == <a class="code" href="pbx_8h.html#a653bef57d41c00d6b1f79c94fe19ec7b">AST_PBX_INCOMPLETE</a> &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(&amp;dst_exten[pos]))
<a name="l04390"></a>04390             timeout = 1;
<a name="l04391"></a>04391          <span class="keywordflow">if</span> (!timeout &amp;&amp; <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, dst_exten, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) <span class="comment">/* Prepare the next cycle */</span>
<a name="l04392"></a>04392             <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(c, dst_exten, 1);
<a name="l04393"></a>04393          <span class="keywordflow">else</span> {
<a name="l04394"></a>04394             <span class="comment">/* No such extension */</span>
<a name="l04395"></a>04395             <span class="keywordflow">if</span> (!timeout &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(dst_exten)) {
<a name="l04396"></a>04396                <span class="comment">/* An invalid extension */</span>
<a name="l04397"></a>04397                <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;i&quot;</span>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04398"></a>04398                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Invalid extension &apos;%s&apos; in context &apos;%s&apos; on %s\n&quot;</span>, dst_exten, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;name);
<a name="l04399"></a>04399                   <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(c, <span class="stringliteral">&quot;INVALID_EXTEN&quot;</span>, dst_exten);
<a name="l04400"></a>04400                   <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(c, <span class="stringliteral">&quot;i&quot;</span>, 1);
<a name="l04401"></a>04401                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;e&quot;</span>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04402"></a>04402                   <a class="code" href="pbx_8h.html#abc705e1c806491af6419892a1237d920">pbx_builtin_raise_exception</a>(c, <span class="stringliteral">&quot;INVALID&quot;</span>);
<a name="l04403"></a>04403                } <span class="keywordflow">else</span> {
<a name="l04404"></a>04404                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid extension &apos;%s&apos;, but no rule &apos;i&apos; in context &apos;%s&apos;\n&quot;</span>, dst_exten, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l04405"></a>04405                   found = 1; <span class="comment">/* XXX disable message */</span>
<a name="l04406"></a>04406                   <span class="keywordflow">break</span>;
<a name="l04407"></a>04407                }
<a name="l04408"></a>04408             } <span class="keywordflow">else</span> {
<a name="l04409"></a>04409                <span class="comment">/* A simple timeout */</span>
<a name="l04410"></a>04410                <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;t&quot;</span>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04411"></a>04411                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Timeout on %s\n&quot;</span>, c-&gt;name);
<a name="l04412"></a>04412                   <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(c, <span class="stringliteral">&quot;t&quot;</span>, 1);
<a name="l04413"></a>04413                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;e&quot;</span>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04414"></a>04414                   <a class="code" href="pbx_8h.html#abc705e1c806491af6419892a1237d920">pbx_builtin_raise_exception</a>(c, <span class="stringliteral">&quot;RESPONSETIMEOUT&quot;</span>);
<a name="l04415"></a>04415                } <span class="keywordflow">else</span> {
<a name="l04416"></a>04416                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Timeout, but no rule &apos;t&apos; in context &apos;%s&apos;\n&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l04417"></a>04417                   found = 1; <span class="comment">/* XXX disable message */</span>
<a name="l04418"></a>04418                   <span class="keywordflow">break</span>;
<a name="l04419"></a>04419                }
<a name="l04420"></a>04420             }
<a name="l04421"></a>04421          }
<a name="l04422"></a>04422          <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>) {
<a name="l04423"></a>04423             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;CDR updated on %s\n&quot;</span>,c-&gt;name);
<a name="l04424"></a>04424             <a class="code" href="cdr_8h.html#a92b2e3b685887b48d228f7546ae1a9f1">ast_cdr_update</a>(c);
<a name="l04425"></a>04425          }
<a name="l04426"></a>04426       }
<a name="l04427"></a>04427    }
<a name="l04428"></a>04428 
<a name="l04429"></a>04429    <span class="keywordflow">if</span> (!found &amp;&amp; !error) {
<a name="l04430"></a>04430       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Don&apos;t know what to do with &apos;%s&apos;\n&quot;</span>, c-&gt;name);
<a name="l04431"></a>04431    }
<a name="l04432"></a>04432 
<a name="l04433"></a>04433    <span class="keywordflow">if</span> (!args || !args-&gt;<a class="code" href="structast__pbx__args.html#a0449b0be05342e431e60937c47fc52f7">no_hangup_chan</a>) {
<a name="l04434"></a>04434       <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(c, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709aeeafae6abd77156800ec76b0ff7d3867">AST_SOFTHANGUP_APPUNLOAD</a>);
<a name="l04435"></a>04435    }
<a name="l04436"></a>04436 
<a name="l04437"></a>04437    <span class="keywordflow">if</span> ((!args || !args-&gt;<a class="code" href="structast__pbx__args.html#a0449b0be05342e431e60937c47fc52f7">no_hangup_chan</a>) &amp;&amp;
<a name="l04438"></a>04438          !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a3f96b2798b1f93fa27bc2dff7dfd9a26">AST_FLAG_BRIDGE_HANGUP_RUN</a>) &amp;&amp;
<a name="l04439"></a>04439          <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;h&quot;</span>, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l04440"></a>04440       <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(c, <span class="stringliteral">&quot;h&quot;</span>, 1);
<a name="l04441"></a>04441       <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> &amp;&amp; <a class="code" href="options_8h.html#ac4df5fcd7bf0175ad37e2da65e91e75b">ast_opt_end_cdr_before_h_exten</a>) {
<a name="l04442"></a>04442          <a class="code" href="cdr_8h.html#a9884cbdaef20e9f266bc2220772bf52b" title="End a call.">ast_cdr_end</a>(c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l04443"></a>04443       }
<a name="l04444"></a>04444       <span class="keywordflow">while</span> ((res = <a class="code" href="pbx_8h.html#a94ca71e502d95d1cb0a815072e059aee" title="Launch a new extension (i.e. new stack).">ast_spawn_extension</a>(c, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, &amp;found, 1)) == 0) {
<a name="l04445"></a>04445          c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>++;
<a name="l04446"></a>04446       }
<a name="l04447"></a>04447       <span class="keywordflow">if</span> (found &amp;&amp; res) {
<a name="l04448"></a>04448          <span class="comment">/* Something bad happened, or a hangup has been requested. */</span>
<a name="l04449"></a>04449          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Spawn extension (%s,%s,%d) exited non-zero on &apos;%s&apos;\n&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, c-&gt;name);
<a name="l04450"></a>04450          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Spawn extension (%s, %s, %d) exited non-zero on &apos;%s&apos;\n&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, c-&gt;name);
<a name="l04451"></a>04451       }
<a name="l04452"></a>04452    }
<a name="l04453"></a>04453    <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(c, autoloopflag, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a5ff4f7a94a36fcc2b8628186cb643d4b">AST_FLAG_IN_AUTOLOOP</a>);
<a name="l04454"></a>04454    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a3f96b2798b1f93fa27bc2dff7dfd9a26">AST_FLAG_BRIDGE_HANGUP_RUN</a>); <span class="comment">/* from one round to the next, make sure this gets cleared */</span>
<a name="l04455"></a>04455    <a class="code" href="pbx_8c.html#a1a7e2b65d9fc687fe40a8dbcefa7bc4e">pbx_destroy</a>(c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>);
<a name="l04456"></a>04456    c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a> = NULL;
<a name="l04457"></a>04457 
<a name="l04458"></a>04458    <span class="keywordflow">if</span> (!args || !args-&gt;<a class="code" href="structast__pbx__args.html#a0449b0be05342e431e60937c47fc52f7">no_hangup_chan</a>) {
<a name="l04459"></a>04459       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(c);
<a name="l04460"></a>04460    }
<a name="l04461"></a>04461 
<a name="l04462"></a>04462    <span class="keywordflow">return</span> 0;
<a name="l04463"></a>04463 }
<a name="l04464"></a>04464 <span class="comment"></span>
<a name="l04465"></a>04465 <span class="comment">/*!</span>
<a name="l04466"></a>04466 <span class="comment"> * \brief Increase call count for channel</span>
<a name="l04467"></a>04467 <span class="comment"> * \retval 0 on success</span>
<a name="l04468"></a>04468 <span class="comment"> * \retval non-zero if a configured limit (maxcalls, maxload, minmemfree) was reached </span>
<a name="l04469"></a>04469 <span class="comment">*/</span>
<a name="l04470"></a><a class="code" href="pbx_8c.html#a829520d1350a9bfcd02e2106e5a22a24">04470</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a829520d1350a9bfcd02e2106e5a22a24" title="Increase call count for channel.">increase_call_count</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c)
<a name="l04471"></a>04471 {
<a name="l04472"></a>04472    <span class="keywordtype">int</span> failed = 0;
<a name="l04473"></a>04473    <span class="keywordtype">double</span> curloadavg;
<a name="l04474"></a>04474 <span class="preprocessor">#if defined(HAVE_SYSINFO)</span>
<a name="l04475"></a>04475 <span class="preprocessor"></span>   <span class="keywordtype">long</span> curfreemem;
<a name="l04476"></a>04476    <span class="keyword">struct </span>sysinfo sys_info;
<a name="l04477"></a>04477 <span class="preprocessor">#endif</span>
<a name="l04478"></a>04478 <span class="preprocessor"></span>
<a name="l04479"></a>04479    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="pbx_8c.html#a55c3f21eda54c35107729cd65e482aec">maxcalllock</a>);
<a name="l04480"></a>04480    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga3e1a333df2c22351f326bbfcc509edf3">option_maxcalls</a>) {
<a name="l04481"></a>04481       <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#a098053e0fabe1ebd3f0b70fd7c9f8a71">countcalls</a> &gt;= <a class="code" href="group__main__options.html#ga3e1a333df2c22351f326bbfcc509edf3">option_maxcalls</a>) {
<a name="l04482"></a>04482          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum call limit of %d calls exceeded by &apos;%s&apos;!\n&quot;</span>, <a class="code" href="group__main__options.html#ga3e1a333df2c22351f326bbfcc509edf3">option_maxcalls</a>, c-&gt;name);
<a name="l04483"></a>04483          failed = -1;
<a name="l04484"></a>04484       }
<a name="l04485"></a>04485    }
<a name="l04486"></a>04486    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga58e23258cc1956eab5063c9380e1be9f">option_maxload</a>) {
<a name="l04487"></a>04487       <a class="code" href="agi_2strcompat_8c.html#a40e0da58ab6964e3264b90f79ad6d476" title="Return something that won&amp;#39;t cancel the call, but still return -1, in case we...">getloadavg</a>(&amp;curloadavg, 1);
<a name="l04488"></a>04488       <span class="keywordflow">if</span> (curloadavg &gt;= <a class="code" href="group__main__options.html#ga58e23258cc1956eab5063c9380e1be9f">option_maxload</a>) {
<a name="l04489"></a>04489          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum loadavg limit of %f load exceeded by &apos;%s&apos; (currently %f)!\n&quot;</span>, <a class="code" href="group__main__options.html#ga58e23258cc1956eab5063c9380e1be9f">option_maxload</a>, c-&gt;name, curloadavg);
<a name="l04490"></a>04490          failed = -1;
<a name="l04491"></a>04491       }
<a name="l04492"></a>04492    }
<a name="l04493"></a>04493 <span class="preprocessor">#if defined(HAVE_SYSINFO)</span>
<a name="l04494"></a>04494 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (option_minmemfree) {
<a name="l04495"></a>04495       <span class="keywordflow">if</span> (!sysinfo(&amp;sys_info)) {
<a name="l04496"></a>04496          <span class="comment">/* make sure that the free system memory is above the configured low watermark</span>
<a name="l04497"></a>04497 <span class="comment">          * convert the amount of freeram from mem_units to MB */</span>
<a name="l04498"></a>04498          curfreemem = sys_info.freeram / sys_info.mem_unit;
<a name="l04499"></a>04499          curfreemem /= 1024 * 1024;
<a name="l04500"></a>04500          <span class="keywordflow">if</span> (curfreemem &lt; option_minmemfree) {
<a name="l04501"></a>04501             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Available system memory (~%ldMB) is below the configured low watermark (%ldMB)\n&quot;</span>, curfreemem, option_minmemfree);
<a name="l04502"></a>04502             failed = -1;
<a name="l04503"></a>04503          }
<a name="l04504"></a>04504       }
<a name="l04505"></a>04505    }
<a name="l04506"></a>04506 <span class="preprocessor">#endif</span>
<a name="l04507"></a>04507 <span class="preprocessor"></span>
<a name="l04508"></a>04508    <span class="keywordflow">if</span> (!failed) {
<a name="l04509"></a>04509       <a class="code" href="pbx_8c.html#a098053e0fabe1ebd3f0b70fd7c9f8a71">countcalls</a>++;
<a name="l04510"></a>04510       <a class="code" href="pbx_8c.html#a078330b9a32065ec6a0c0731c06719cd">totalcalls</a>++;
<a name="l04511"></a>04511    }
<a name="l04512"></a>04512    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="pbx_8c.html#a55c3f21eda54c35107729cd65e482aec">maxcalllock</a>);
<a name="l04513"></a>04513 
<a name="l04514"></a>04514    <span class="keywordflow">return</span> failed;
<a name="l04515"></a>04515 }
<a name="l04516"></a>04516 
<a name="l04517"></a><a class="code" href="pbx_8c.html#a3bf2bd297c32c358066446ceb1f4551b">04517</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a3bf2bd297c32c358066446ceb1f4551b">decrease_call_count</a>(<span class="keywordtype">void</span>)
<a name="l04518"></a>04518 {
<a name="l04519"></a>04519    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="pbx_8c.html#a55c3f21eda54c35107729cd65e482aec">maxcalllock</a>);
<a name="l04520"></a>04520    <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#a098053e0fabe1ebd3f0b70fd7c9f8a71">countcalls</a> &gt; 0)
<a name="l04521"></a>04521       <a class="code" href="pbx_8c.html#a098053e0fabe1ebd3f0b70fd7c9f8a71">countcalls</a>--;
<a name="l04522"></a>04522    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="pbx_8c.html#a55c3f21eda54c35107729cd65e482aec">maxcalllock</a>);
<a name="l04523"></a>04523 }
<a name="l04524"></a>04524 
<a name="l04525"></a><a class="code" href="pbx_8c.html#ae25a2122becbf9b94f5d55bc86753fea">04525</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#ae25a2122becbf9b94f5d55bc86753fea">destroy_exten</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e)
<a name="l04526"></a>04526 {
<a name="l04527"></a>04527    <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> == <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>)
<a name="l04528"></a>04528       <a class="code" href="pbx_8c.html#a8fcc10d31d51afba693ef9a4cb162c6a" title="Remove hint from extension.">ast_remove_hint</a>(e);
<a name="l04529"></a>04529 
<a name="l04530"></a>04530    <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>)
<a name="l04531"></a>04531       <a class="code" href="hashtab_8h.html#a6103589badf8d9440a0cece2802c4c3a" title="This func will free the hash table and all its memory.">ast_hashtab_destroy</a>(e-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>,0);
<a name="l04532"></a>04532    <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>)
<a name="l04533"></a>04533       <a class="code" href="hashtab_8h.html#a6103589badf8d9440a0cece2802c4c3a" title="This func will free the hash table and all its memory.">ast_hashtab_destroy</a>(e-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>, 0);
<a name="l04534"></a>04534    <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__exten.html#ad11dc8dd7d18a2cf6451b32ea529221c">datad</a>)
<a name="l04535"></a>04535       e-&gt;<a class="code" href="structast__exten.html#ad11dc8dd7d18a2cf6451b32ea529221c">datad</a>(e-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l04536"></a>04536    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(e);
<a name="l04537"></a>04537 }
<a name="l04538"></a>04538 
<a name="l04539"></a><a class="code" href="pbx_8c.html#a61bf09bfdadba04e51d6576aa014e097">04539</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="pbx_8c.html#a61bf09bfdadba04e51d6576aa014e097">pbx_thread</a>(<span class="keywordtype">void</span> *data)
<a name="l04540"></a>04540 {
<a name="l04541"></a>04541    <span class="comment">/* Oh joyeous kernel, we&apos;re a new thread, with nothing to do but</span>
<a name="l04542"></a>04542 <span class="comment">      answer this channel and get it going.</span>
<a name="l04543"></a>04543 <span class="comment">   */</span>
<a name="l04544"></a>04544    <span class="comment">/* NOTE:</span>
<a name="l04545"></a>04545 <span class="comment">      The launcher of this function _MUST_ increment &apos;countcalls&apos;</span>
<a name="l04546"></a>04546 <span class="comment">      before invoking the function; it will be decremented when the</span>
<a name="l04547"></a>04547 <span class="comment">      PBX has finished running on the channel</span>
<a name="l04548"></a>04548 <span class="comment">    */</span>
<a name="l04549"></a>04549    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c = data;
<a name="l04550"></a>04550 
<a name="l04551"></a>04551    <a class="code" href="pbx_8c.html#ab203ba8e71a7c11736a40f7967ba1fdf">__ast_pbx_run</a>(c, NULL);
<a name="l04552"></a>04552    <a class="code" href="pbx_8c.html#a3bf2bd297c32c358066446ceb1f4551b">decrease_call_count</a>();
<a name="l04553"></a>04553 
<a name="l04554"></a>04554    pthread_exit(NULL);
<a name="l04555"></a>04555 
<a name="l04556"></a>04556    <span class="keywordflow">return</span> NULL;
<a name="l04557"></a>04557 }
<a name="l04558"></a>04558 
<a name="l04559"></a><a class="code" href="pbx_8c.html#a9a937fbb3b5f4e68880a9c5714a29ce5">04559</a> <span class="keyword">enum</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735" title="The result codes when starting the PBX on a channel with.">ast_pbx_result</a> <a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c)
<a name="l04560"></a>04560 {
<a name="l04561"></a>04561    pthread_t t;
<a name="l04562"></a>04562 
<a name="l04563"></a>04563    <span class="keywordflow">if</span> (!c) {
<a name="l04564"></a>04564       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Asked to start thread on NULL channel?\n&quot;</span>);
<a name="l04565"></a>04565       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735a4a46cde728f5cd375af4f2d5b1542490">AST_PBX_FAILED</a>;
<a name="l04566"></a>04566    }
<a name="l04567"></a>04567 
<a name="l04568"></a>04568    <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#a829520d1350a9bfcd02e2106e5a22a24" title="Increase call count for channel.">increase_call_count</a>(c))
<a name="l04569"></a>04569       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735ab69a419c47206542956e9d933b6605f5">AST_PBX_CALL_LIMIT</a>;
<a name="l04570"></a>04570 
<a name="l04571"></a>04571    <span class="comment">/* Start a new thread, and get something handling this channel. */</span>
<a name="l04572"></a>04572    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a832647380b1f97e7ac1b4492f8816d46">ast_pthread_create_detached</a>(&amp;t, NULL, <a class="code" href="pbx_8c.html#a61bf09bfdadba04e51d6576aa014e097">pbx_thread</a>, c)) {
<a name="l04573"></a>04573       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to create new channel thread\n&quot;</span>);
<a name="l04574"></a>04574       <a class="code" href="pbx_8c.html#a3bf2bd297c32c358066446ceb1f4551b">decrease_call_count</a>();
<a name="l04575"></a>04575       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735a4a46cde728f5cd375af4f2d5b1542490">AST_PBX_FAILED</a>;
<a name="l04576"></a>04576    }
<a name="l04577"></a>04577 
<a name="l04578"></a>04578    <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735ae1482e87c137b03ef9f9c17cf4fb5ec4">AST_PBX_SUCCESS</a>;
<a name="l04579"></a>04579 }
<a name="l04580"></a>04580 
<a name="l04581"></a><a class="code" href="pbx_8c.html#a2c502c100b8b4791d9efe395e08d620b">04581</a> <span class="keyword">enum</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735" title="The result codes when starting the PBX on a channel with.">ast_pbx_result</a> <a class="code" href="pbx_8h.html#a2c502c100b8b4791d9efe395e08d620b" title="Execute the PBX in the current thread.">ast_pbx_run_args</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">struct</span> <a class="code" href="structast__pbx__args.html" title="Options for ast_pbx_run().">ast_pbx_args</a> *args)
<a name="l04582"></a>04582 {
<a name="l04583"></a>04583    <span class="keyword">enum</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735" title="The result codes when starting the PBX on a channel with.">ast_pbx_result</a> res = <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735ae1482e87c137b03ef9f9c17cf4fb5ec4">AST_PBX_SUCCESS</a>;
<a name="l04584"></a>04584 
<a name="l04585"></a>04585    <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#a829520d1350a9bfcd02e2106e5a22a24" title="Increase call count for channel.">increase_call_count</a>(c)) {
<a name="l04586"></a>04586       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735ab69a419c47206542956e9d933b6605f5">AST_PBX_CALL_LIMIT</a>;
<a name="l04587"></a>04587    }
<a name="l04588"></a>04588 
<a name="l04589"></a>04589    res = <a class="code" href="pbx_8c.html#ab203ba8e71a7c11736a40f7967ba1fdf">__ast_pbx_run</a>(c, args);
<a name="l04590"></a>04590 
<a name="l04591"></a>04591    <a class="code" href="pbx_8c.html#a3bf2bd297c32c358066446ceb1f4551b">decrease_call_count</a>();
<a name="l04592"></a>04592 
<a name="l04593"></a>04593    <span class="keywordflow">return</span> res;
<a name="l04594"></a>04594 }
<a name="l04595"></a>04595 
<a name="l04596"></a><a class="code" href="pbx_8c.html#a44b6406c9220f7f2b610ac712369f405">04596</a> <span class="keyword">enum</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735" title="The result codes when starting the PBX on a channel with.">ast_pbx_result</a> <a class="code" href="pbx_8h.html#a44b6406c9220f7f2b610ac712369f405" title="Execute the PBX in the current thread.">ast_pbx_run</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c)
<a name="l04597"></a>04597 {
<a name="l04598"></a>04598    <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a2c502c100b8b4791d9efe395e08d620b" title="Execute the PBX in the current thread.">ast_pbx_run_args</a>(c, NULL);
<a name="l04599"></a>04599 }
<a name="l04600"></a>04600 
<a name="l04601"></a><a class="code" href="pbx_8c.html#a52a37e9e2d9a1482ef5b7d91001b61ac">04601</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a52a37e9e2d9a1482ef5b7d91001b61ac" title="Retrieve the number of active calls.">ast_active_calls</a>(<span class="keywordtype">void</span>)
<a name="l04602"></a>04602 {
<a name="l04603"></a>04603    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#a098053e0fabe1ebd3f0b70fd7c9f8a71">countcalls</a>;
<a name="l04604"></a>04604 }
<a name="l04605"></a>04605 
<a name="l04606"></a><a class="code" href="pbx_8c.html#a6cd4c64e374623ea3393fbc5d580f68e">04606</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a6cd4c64e374623ea3393fbc5d580f68e" title="Retrieve the total number of calls processed through the PBX since last restart.">ast_processed_calls</a>(<span class="keywordtype">void</span>)
<a name="l04607"></a>04607 {
<a name="l04608"></a>04608    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#a078330b9a32065ec6a0c0731c06719cd">totalcalls</a>;
<a name="l04609"></a>04609 }
<a name="l04610"></a>04610 
<a name="l04611"></a><a class="code" href="pbx_8c.html#aeb0407c693573096981db1a00fab4eb8">04611</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aeb0407c693573096981db1a00fab4eb8">pbx_set_autofallthrough</a>(<span class="keywordtype">int</span> newval)
<a name="l04612"></a>04612 {
<a name="l04613"></a>04613    <span class="keywordtype">int</span> oldval = <a class="code" href="pbx_8c.html#a5f7ea48b3f8614ef9314e5aece1f1bc3">autofallthrough</a>;
<a name="l04614"></a>04614    <a class="code" href="pbx_8c.html#a5f7ea48b3f8614ef9314e5aece1f1bc3">autofallthrough</a> = newval;
<a name="l04615"></a>04615    <span class="keywordflow">return</span> oldval;
<a name="l04616"></a>04616 }
<a name="l04617"></a>04617 
<a name="l04618"></a><a class="code" href="pbx_8c.html#a86a7469073a22661d4db7086245c5b18">04618</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a86a7469073a22661d4db7086245c5b18">pbx_set_extenpatternmatchnew</a>(<span class="keywordtype">int</span> newval)
<a name="l04619"></a>04619 {
<a name="l04620"></a>04620    <span class="keywordtype">int</span> oldval = <a class="code" href="pbx_8c.html#a3a7600857afccfa4f7a5c55dcaec8407">extenpatternmatchnew</a>;
<a name="l04621"></a>04621    <a class="code" href="pbx_8c.html#a3a7600857afccfa4f7a5c55dcaec8407">extenpatternmatchnew</a> = newval;
<a name="l04622"></a>04622    <span class="keywordflow">return</span> oldval;
<a name="l04623"></a>04623 }
<a name="l04624"></a>04624 
<a name="l04625"></a><a class="code" href="pbx_8c.html#a7a46e2644221be6cb7ca7ba2723006cd">04625</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8h.html#a7a46e2644221be6cb7ca7ba2723006cd">pbx_set_overrideswitch</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *newval)
<a name="l04626"></a>04626 {
<a name="l04627"></a>04627    <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#a8f600ca9999b2d9c3d64cbcdb503895c">overrideswitch</a>) {
<a name="l04628"></a>04628       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<a class="code" href="pbx_8c.html#a8f600ca9999b2d9c3d64cbcdb503895c">overrideswitch</a>);
<a name="l04629"></a>04629    }
<a name="l04630"></a>04630    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(newval)) {
<a name="l04631"></a>04631       <a class="code" href="pbx_8c.html#a8f600ca9999b2d9c3d64cbcdb503895c">overrideswitch</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(newval);
<a name="l04632"></a>04632    } <span class="keywordflow">else</span> {
<a name="l04633"></a>04633       <a class="code" href="pbx_8c.html#a8f600ca9999b2d9c3d64cbcdb503895c">overrideswitch</a> = NULL;
<a name="l04634"></a>04634    }
<a name="l04635"></a>04635 }
<a name="l04636"></a>04636 <span class="comment"></span>
<a name="l04637"></a>04637 <span class="comment">/*!</span>
<a name="l04638"></a>04638 <span class="comment"> * \brief lookup for a context with a given name,</span>
<a name="l04639"></a>04639 <span class="comment"> * \retval found context or NULL if not found.</span>
<a name="l04640"></a>04640 <span class="comment">*/</span>
<a name="l04641"></a><a class="code" href="pbx_8c.html#afe651dadb8edf2c2b82e988134fe71de">04641</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="pval_8h.html#a939b5867de88d9d61eb4999402805027">find_context</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context)
<a name="l04642"></a>04642 {
<a name="l04643"></a>04643    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = NULL;
<a name="l04644"></a>04644    <span class="keyword">struct </span><a class="code" href="structfake__context.html">fake_context</a> item;
<a name="l04645"></a>04645 
<a name="l04646"></a>04646    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(item.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, context, <span class="keyword">sizeof</span>(item.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>));
<a name="l04647"></a>04647 
<a name="l04648"></a>04648    c = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>,&amp;item);
<a name="l04649"></a>04649 
<a name="l04650"></a>04650    <span class="keywordflow">return</span> c;
<a name="l04651"></a>04651 }
<a name="l04652"></a>04652 <span class="comment"></span>
<a name="l04653"></a>04653 <span class="comment">/*!</span>
<a name="l04654"></a>04654 <span class="comment"> * \brief lookup for a context with a given name,</span>
<a name="l04655"></a>04655 <span class="comment"> * \retval with conlock held if found.</span>
<a name="l04656"></a>04656 <span class="comment"> * \retval NULL if not found.</span>
<a name="l04657"></a>04657 <span class="comment">*/</span>
<a name="l04658"></a><a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e">04658</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e" title="lookup for a context with a given name,">find_context_locked</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context)
<a name="l04659"></a>04659 {
<a name="l04660"></a>04660    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = NULL;
<a name="l04661"></a>04661    <span class="keyword">struct </span><a class="code" href="structfake__context.html">fake_context</a> item;
<a name="l04662"></a>04662 
<a name="l04663"></a>04663    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(item.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, context, <span class="keyword">sizeof</span>(item.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>));
<a name="l04664"></a>04664 
<a name="l04665"></a>04665    <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l04666"></a>04666    c = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>,&amp;item);
<a name="l04667"></a>04667 
<a name="l04668"></a>04668 <span class="preprocessor">#ifdef NOTNOW</span>
<a name="l04669"></a>04669 <span class="preprocessor"></span>
<a name="l04670"></a>04670    <span class="keywordflow">while</span> ( (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)) ) {
<a name="l04671"></a>04671       <span class="keywordflow">if</span> (!strcmp(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), context))
<a name="l04672"></a>04672          <span class="keywordflow">return</span> c;
<a name="l04673"></a>04673    }
<a name="l04674"></a>04674 <span class="preprocessor">#endif</span>
<a name="l04675"></a>04675 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (!c)
<a name="l04676"></a>04676       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l04677"></a>04677 
<a name="l04678"></a>04678    <span class="keywordflow">return</span> c;
<a name="l04679"></a>04679 }
<a name="l04680"></a>04680 <span class="comment"></span>
<a name="l04681"></a>04681 <span class="comment">/*!</span>
<a name="l04682"></a>04682 <span class="comment"> * \brief Remove included contexts.</span>
<a name="l04683"></a>04683 <span class="comment"> * This function locks contexts list by &amp;conlist, search for the right context</span>
<a name="l04684"></a>04684 <span class="comment"> * structure, leave context list locked and call ast_context_remove_include2</span>
<a name="l04685"></a>04685 <span class="comment"> * which removes include, unlock contexts list and return ...</span>
<a name="l04686"></a>04686 <span class="comment">*/</span>
<a name="l04687"></a><a class="code" href="pbx_8c.html#acec5cab19e772712434bf03875b57e9a">04687</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#acec5cab19e772712434bf03875b57e9a" title="Remove a context include.">ast_context_remove_include</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *include, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l04688"></a>04688 {
<a name="l04689"></a>04689    <span class="keywordtype">int</span> ret = -1;
<a name="l04690"></a>04690    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = <a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e" title="lookup for a context with a given name,">find_context_locked</a>(context);
<a name="l04691"></a>04691 
<a name="l04692"></a>04692    <span class="keywordflow">if</span> (c) {
<a name="l04693"></a>04693       <span class="comment">/* found, remove include from this context ... */</span>
<a name="l04694"></a>04694       ret = <a class="code" href="pbx_8h.html#a8c23053e0d4d87545a93ec837a19b908" title="Removes an include by an ast_context structure.">ast_context_remove_include2</a>(c, include, registrar);
<a name="l04695"></a>04695       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l04696"></a>04696    }
<a name="l04697"></a>04697    <span class="keywordflow">return</span> ret;
<a name="l04698"></a>04698 }
<a name="l04699"></a>04699 <span class="comment"></span>
<a name="l04700"></a>04700 <span class="comment">/*!</span>
<a name="l04701"></a>04701 <span class="comment"> * \brief Locks context, remove included contexts, unlocks context.</span>
<a name="l04702"></a>04702 <span class="comment"> * When we call this function, &amp;conlock lock must be locked, because when</span>
<a name="l04703"></a>04703 <span class="comment"> * we giving *con argument, some process can remove/change this context</span>
<a name="l04704"></a>04704 <span class="comment"> * and after that there can be segfault.</span>
<a name="l04705"></a>04705 <span class="comment"> *</span>
<a name="l04706"></a>04706 <span class="comment"> * \retval 0 on success.</span>
<a name="l04707"></a>04707 <span class="comment"> * \retval -1 on failure.</span>
<a name="l04708"></a>04708 <span class="comment"> */</span>
<a name="l04709"></a><a class="code" href="pbx_8c.html#a8c23053e0d4d87545a93ec837a19b908">04709</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a8c23053e0d4d87545a93ec837a19b908" title="Removes an include by an ast_context structure.">ast_context_remove_include2</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *include, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l04710"></a>04710 {
<a name="l04711"></a>04711    <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *i, *pi = NULL;
<a name="l04712"></a>04712    <span class="keywordtype">int</span> ret = -1;
<a name="l04713"></a>04713 
<a name="l04714"></a>04714    <a class="code" href="pbx_8h.html#a2c961dcbdcade8fac28960ed67c89bd2" title="Write locks a given context.">ast_wrlock_context</a>(con);
<a name="l04715"></a>04715 
<a name="l04716"></a>04716    <span class="comment">/* find our include */</span>
<a name="l04717"></a>04717    <span class="keywordflow">for</span> (i = con-&gt;<a class="code" href="structast__context.html#abaa8691efe3e8fe26f5930720bfd8edb">includes</a>; i; pi = i, i = i-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a>) {
<a name="l04718"></a>04718       <span class="keywordflow">if</span> (!strcmp(i-&gt;<a class="code" href="structast__include.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, include) &amp;&amp;
<a name="l04719"></a>04719             (!registrar || !strcmp(i-&gt;<a class="code" href="structast__include.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>, registrar))) {
<a name="l04720"></a>04720          <span class="comment">/* remove from list */</span>
<a name="l04721"></a>04721          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Removing inclusion of context &apos;%s&apos; in context &apos;%s; registrar=%s&apos;\n&quot;</span>, include, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(con), registrar);
<a name="l04722"></a>04722          <span class="keywordflow">if</span> (pi)
<a name="l04723"></a>04723             pi-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a> = i-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a>;
<a name="l04724"></a>04724          <span class="keywordflow">else</span>
<a name="l04725"></a>04725             con-&gt;<a class="code" href="structast__context.html#abaa8691efe3e8fe26f5930720bfd8edb">includes</a> = i-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a>;
<a name="l04726"></a>04726          <span class="comment">/* free include and return */</span>
<a name="l04727"></a>04727          <a class="code" href="pbx_8h.html#a2bc52adc4f80137db9161ed499f82a00" title="Deallocates memory structures associated with a timing bitmap.">ast_destroy_timing</a>(&amp;(i-&gt;<a class="code" href="structast__include.html#a137134920b381175bea34c57d2565f91">timing</a>));
<a name="l04728"></a>04728          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(i);
<a name="l04729"></a>04729          ret = 0;
<a name="l04730"></a>04730          <span class="keywordflow">break</span>;
<a name="l04731"></a>04731       }
<a name="l04732"></a>04732    }
<a name="l04733"></a>04733 
<a name="l04734"></a>04734    <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l04735"></a>04735 
<a name="l04736"></a>04736    <span class="keywordflow">return</span> ret;
<a name="l04737"></a>04737 }
<a name="l04738"></a>04738 <span class="comment"></span>
<a name="l04739"></a>04739 <span class="comment">/*!</span>
<a name="l04740"></a>04740 <span class="comment"> * \note This function locks contexts list by &amp;conlist, search for the rigt context</span>
<a name="l04741"></a>04741 <span class="comment"> * structure, leave context list locked and call ast_context_remove_switch2</span>
<a name="l04742"></a>04742 <span class="comment"> * which removes switch, unlock contexts list and return ...</span>
<a name="l04743"></a>04743 <span class="comment"> */</span>
<a name="l04744"></a><a class="code" href="pbx_8c.html#a9800750a3fb79caa282c98556473f392">04744</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a9800750a3fb79caa282c98556473f392" title="Remove a switch.">ast_context_remove_switch</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *sw, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l04745"></a>04745 {
<a name="l04746"></a>04746    <span class="keywordtype">int</span> ret = -1; <span class="comment">/* default error return */</span>
<a name="l04747"></a>04747    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = <a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e" title="lookup for a context with a given name,">find_context_locked</a>(context);
<a name="l04748"></a>04748 
<a name="l04749"></a>04749    <span class="keywordflow">if</span> (c) {
<a name="l04750"></a>04750       <span class="comment">/* remove switch from this context ... */</span>
<a name="l04751"></a>04751       ret = <a class="code" href="pbx_8h.html#a23a51e49bea958a8d27c61f2a51931d9" title="This function locks given context, removes switch, unlock context and return.">ast_context_remove_switch2</a>(c, sw, data, registrar);
<a name="l04752"></a>04752       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l04753"></a>04753    }
<a name="l04754"></a>04754    <span class="keywordflow">return</span> ret;
<a name="l04755"></a>04755 }
<a name="l04756"></a>04756 <span class="comment"></span>
<a name="l04757"></a>04757 <span class="comment">/*!</span>
<a name="l04758"></a>04758 <span class="comment"> * \brief This function locks given context, removes switch, unlock context and</span>
<a name="l04759"></a>04759 <span class="comment"> * return.</span>
<a name="l04760"></a>04760 <span class="comment"> * \note When we call this function, &amp;conlock lock must be locked, because when</span>
<a name="l04761"></a>04761 <span class="comment"> * we giving *con argument, some process can remove/change this context</span>
<a name="l04762"></a>04762 <span class="comment"> * and after that there can be segfault.</span>
<a name="l04763"></a>04763 <span class="comment"> *</span>
<a name="l04764"></a>04764 <span class="comment"> */</span>
<a name="l04765"></a><a class="code" href="pbx_8c.html#a23a51e49bea958a8d27c61f2a51931d9">04765</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a23a51e49bea958a8d27c61f2a51931d9" title="This function locks given context, removes switch, unlock context and return.">ast_context_remove_switch2</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *sw, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l04766"></a>04766 {
<a name="l04767"></a>04767    <span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *i;
<a name="l04768"></a>04768    <span class="keywordtype">int</span> ret = -1;
<a name="l04769"></a>04769 
<a name="l04770"></a>04770    <a class="code" href="pbx_8h.html#a2c961dcbdcade8fac28960ed67c89bd2" title="Write locks a given context.">ast_wrlock_context</a>(con);
<a name="l04771"></a>04771 
<a name="l04772"></a>04772    <span class="comment">/* walk switches */</span>
<a name="l04773"></a>04773    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;con-&gt;<a class="code" href="structast__context.html#a1a88e64f1d400d544879fb192cb155e7">alts</a>, i, list) {
<a name="l04774"></a>04774       <span class="keywordflow">if</span> (!strcmp(i-&gt;<a class="code" href="structast__sw.html#a5ac083a645d964373f022d03df4849c8">name</a>, sw) &amp;&amp; !strcmp(i-&gt;<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a>, data) &amp;&amp;
<a name="l04775"></a>04775          (!registrar || !strcmp(i-&gt;<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>, registrar))) {
<a name="l04776"></a>04776          <span class="comment">/* found, remove from list */</span>
<a name="l04777"></a>04777          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Removing switch &apos;%s&apos; from context &apos;%s; registrar=%s&apos;\n&quot;</span>, sw, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(con), registrar);
<a name="l04778"></a>04778          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l04779"></a>04779          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(i); <span class="comment">/* free switch and return */</span>
<a name="l04780"></a>04780          ret = 0;
<a name="l04781"></a>04781          <span class="keywordflow">break</span>;
<a name="l04782"></a>04782       }
<a name="l04783"></a>04783    }
<a name="l04784"></a>04784    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l04785"></a>04785 
<a name="l04786"></a>04786    <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l04787"></a>04787 
<a name="l04788"></a>04788    <span class="keywordflow">return</span> ret;
<a name="l04789"></a>04789 }
<a name="l04790"></a>04790 
<a name="l04791"></a>04791 <span class="comment">/*</span>
<a name="l04792"></a>04792 <span class="comment"> * \note This functions lock contexts list, search for the right context,</span>
<a name="l04793"></a>04793 <span class="comment"> * call ast_context_remove_extension2, unlock contexts list and return.</span>
<a name="l04794"></a>04794 <span class="comment"> * In this function we are using</span>
<a name="l04795"></a>04795 <span class="comment"> */</span>
<a name="l04796"></a><a class="code" href="pbx_8c.html#a721c6ba091102f155a586e09b2a526bf">04796</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a721c6ba091102f155a586e09b2a526bf" title="Simply remove extension from context.">ast_context_remove_extension</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *extension, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l04797"></a>04797 {
<a name="l04798"></a>04798    <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a85ffdbb47cc54f8d125b4276d6bd3170">ast_context_remove_extension_callerid</a>(context, extension, priority, NULL, 0, registrar);
<a name="l04799"></a>04799 }
<a name="l04800"></a>04800 
<a name="l04801"></a><a class="code" href="pbx_8c.html#aea78542f089fbd63ff25147631b96e51">04801</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a85ffdbb47cc54f8d125b4276d6bd3170">ast_context_remove_extension_callerid</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *extension, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keywordtype">int</span> matchcallerid, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l04802"></a>04802 {
<a name="l04803"></a>04803    <span class="keywordtype">int</span> ret = -1; <span class="comment">/* default error return */</span>
<a name="l04804"></a>04804    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = <a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e" title="lookup for a context with a given name,">find_context_locked</a>(context);
<a name="l04805"></a>04805 
<a name="l04806"></a>04806    <span class="keywordflow">if</span> (c) { <span class="comment">/* ... remove extension ... */</span>
<a name="l04807"></a>04807       ret = <a class="code" href="pbx_8h.html#abb8840d8ea2dd143fa4f606d048ad6b7">ast_context_remove_extension_callerid2</a>(c, extension, priority, callerid, matchcallerid, registrar, 1);
<a name="l04808"></a>04808       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l04809"></a>04809    }
<a name="l04810"></a>04810    <span class="keywordflow">return</span> ret;
<a name="l04811"></a>04811 }
<a name="l04812"></a>04812 <span class="comment"></span>
<a name="l04813"></a>04813 <span class="comment">/*!</span>
<a name="l04814"></a>04814 <span class="comment"> * \brief This functionc locks given context, search for the right extension and</span>
<a name="l04815"></a>04815 <span class="comment"> * fires out all peer in this extensions with given priority. If priority</span>
<a name="l04816"></a>04816 <span class="comment"> * is set to 0, all peers are removed. After that, unlock context and</span>
<a name="l04817"></a>04817 <span class="comment"> * return.</span>
<a name="l04818"></a>04818 <span class="comment"> * \note When do you want to call this function, make sure that &amp;conlock is locked,</span>
<a name="l04819"></a>04819 <span class="comment"> * because some process can handle with your *con context before you lock</span>
<a name="l04820"></a>04820 <span class="comment"> * it.</span>
<a name="l04821"></a>04821 <span class="comment"> *</span>
<a name="l04822"></a>04822 <span class="comment"> */</span>
<a name="l04823"></a><a class="code" href="pbx_8c.html#a25dad382feec89a9bbc6c5284bb30e25">04823</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a25dad382feec89a9bbc6c5284bb30e25" title="This functionc locks given context, search for the right extension and fires out...">ast_context_remove_extension2</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *extension, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>, <span class="keywordtype">int</span> already_locked)
<a name="l04824"></a>04824 {
<a name="l04825"></a>04825    <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#abb8840d8ea2dd143fa4f606d048ad6b7">ast_context_remove_extension_callerid2</a>(con, extension, priority, NULL, 0, registrar, already_locked);
<a name="l04826"></a>04826 }
<a name="l04827"></a>04827 
<a name="l04828"></a><a class="code" href="pbx_8c.html#a938a84cd1446c1da1e45b2269c36c9e3">04828</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#abb8840d8ea2dd143fa4f606d048ad6b7">ast_context_remove_extension_callerid2</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *extension, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keywordtype">int</span> matchcallerid, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>, <span class="keywordtype">int</span> already_locked)
<a name="l04829"></a>04829 {
<a name="l04830"></a>04830    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *exten, *prev_exten = NULL;
<a name="l04831"></a>04831    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>;
<a name="l04832"></a>04832    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> ex, *exten2, *exten3;
<a name="l04833"></a>04833    <span class="keywordtype">char</span> dummy_name[1024];
<a name="l04834"></a>04834    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *previous_peer = NULL;
<a name="l04835"></a>04835    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *next_peer = NULL;
<a name="l04836"></a>04836    <span class="keywordtype">int</span> found = 0;
<a name="l04837"></a>04837 
<a name="l04838"></a>04838    <span class="keywordflow">if</span> (!already_locked)
<a name="l04839"></a>04839       <a class="code" href="pbx_8h.html#a2c961dcbdcade8fac28960ed67c89bd2" title="Write locks a given context.">ast_wrlock_context</a>(con);
<a name="l04840"></a>04840 
<a name="l04841"></a>04841    <span class="comment">/* Handle this is in the new world */</span>
<a name="l04842"></a>04842 
<a name="l04843"></a>04843    <span class="comment">/* FIXME For backwards compatibility, if callerid==NULL, then remove ALL</span>
<a name="l04844"></a>04844 <span class="comment">    * peers, not just those matching the callerid. */</span>
<a name="l04845"></a>04845 <span class="preprocessor">#ifdef NEED_DEBUG</span>
<a name="l04846"></a>04846 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3,<span class="stringliteral">&quot;Removing %s/%s/%d%s%s from trees, registrar=%s\n&quot;</span>, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, extension, priority, matchcallerid ? <span class="stringliteral">&quot;/&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, matchcallerid ? callerid : <span class="stringliteral">&quot;&quot;</span>, registrar);
<a name="l04847"></a>04847 <span class="preprocessor">#endif</span>
<a name="l04848"></a>04848 <span class="preprocessor"></span><span class="preprocessor">#ifdef CONTEXT_DEBUG</span>
<a name="l04849"></a>04849 <span class="preprocessor"></span>   check_contexts(__FILE__, __LINE__);
<a name="l04850"></a>04850 <span class="preprocessor">#endif</span>
<a name="l04851"></a>04851 <span class="preprocessor"></span>   <span class="comment">/* find this particular extension */</span>
<a name="l04852"></a>04852    ex.<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a> = dummy_name;
<a name="l04853"></a>04853    ex.<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> = matchcallerid &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(callerid); <span class="comment">/* don&apos;t say match if there&apos;s no callerid */</span>
<a name="l04854"></a>04854    ex.<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a> = callerid;
<a name="l04855"></a>04855    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dummy_name, extension, <span class="keyword">sizeof</span>(dummy_name));
<a name="l04856"></a>04856    exten = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, &amp;ex);
<a name="l04857"></a>04857    <span class="keywordflow">if</span> (exten) {
<a name="l04858"></a>04858       <span class="keywordflow">if</span> (priority == 0) {
<a name="l04859"></a>04859          exten2 = <a class="code" href="hashtab_8h.html#a71bd19ff2f6fad1cf5e01f9b8cad6f66" title="Hash the object and then compare ptrs in bucket list instead of calling the compare...">ast_hashtab_remove_this_object</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, exten);
<a name="l04860"></a>04860          <span class="keywordflow">if</span> (!exten2)
<a name="l04861"></a>04861             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Trying to delete the exten %s from context %s, but could not remove from the root_table\n&quot;</span>, extension, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l04862"></a>04862          <span class="keywordflow">if</span> (con-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>) {
<a name="l04863"></a>04863             <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a> = <a class="code" href="pbx_8c.html#aa638cd9d03f5d710b6a320ffda6d6392">add_exten_to_pattern_tree</a>(con, exten, 1);
<a name="l04864"></a>04864 
<a name="l04865"></a>04865             <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>) { <span class="comment">/* this test for safety purposes */</span>
<a name="l04866"></a>04866                x-&gt;<a class="code" href="structmatch__char.html#a3cb0d95aa820737d010fdfaccac92ec3">deleted</a> = 1; <span class="comment">/* with this marked as deleted, it will never show up in the scoreboard, and therefore never be found */</span>
<a name="l04867"></a>04867                x-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> = 0; <span class="comment">/* get rid of what will become a bad pointer */</span>
<a name="l04868"></a>04868             } <span class="keywordflow">else</span> {
<a name="l04869"></a>04869                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,<span class="stringliteral">&quot;Trying to delete an exten from a context, but the pattern tree node returned isn&apos;t a full extension\n&quot;</span>);
<a name="l04870"></a>04870             }
<a name="l04871"></a>04871          }
<a name="l04872"></a>04872       } <span class="keywordflow">else</span> {
<a name="l04873"></a>04873          ex.<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = priority;
<a name="l04874"></a>04874          exten2 = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(exten-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>, &amp;ex);
<a name="l04875"></a>04875          <span class="keywordflow">if</span> (exten2) {
<a name="l04876"></a>04876 
<a name="l04877"></a>04877             <span class="keywordflow">if</span> (exten2-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>) { <span class="comment">/* if this exten has a label, remove that, too */</span>
<a name="l04878"></a>04878                exten3 = <a class="code" href="hashtab_8h.html#a71bd19ff2f6fad1cf5e01f9b8cad6f66" title="Hash the object and then compare ptrs in bucket list instead of calling the compare...">ast_hashtab_remove_this_object</a>(exten-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>,exten2);
<a name="l04879"></a>04879                <span class="keywordflow">if</span> (!exten3)
<a name="l04880"></a>04880                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Did not remove this priority label (%d/%s) from the peer_label_table of context %s, extension %s!\n&quot;</span>, priority, exten2-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, exten2-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l04881"></a>04881             }
<a name="l04882"></a>04882 
<a name="l04883"></a>04883             exten3 = <a class="code" href="hashtab_8h.html#a71bd19ff2f6fad1cf5e01f9b8cad6f66" title="Hash the object and then compare ptrs in bucket list instead of calling the compare...">ast_hashtab_remove_this_object</a>(exten-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>, exten2);
<a name="l04884"></a>04884             <span class="keywordflow">if</span> (!exten3)
<a name="l04885"></a>04885                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Did not remove this priority (%d) from the peer_table of context %s, extension %s!\n&quot;</span>, priority, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, exten2-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l04886"></a>04886             <span class="keywordflow">if</span> (exten2 == exten &amp;&amp; exten2-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>) {
<a name="l04887"></a>04887                exten2 = <a class="code" href="hashtab_8h.html#a71bd19ff2f6fad1cf5e01f9b8cad6f66" title="Hash the object and then compare ptrs in bucket list instead of calling the compare...">ast_hashtab_remove_this_object</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, exten);
<a name="l04888"></a>04888                <a class="code" href="hashtab_8h.html#af3e13ed429193a2bf4f0b9d93ac5d7c1" title="Insert without checking.">ast_hashtab_insert_immediate</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, exten2-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>);
<a name="l04889"></a>04889             }
<a name="l04890"></a>04890             <span class="keywordflow">if</span> (<a class="code" href="hashtab_8h.html#ac3452d3a8bca5b4f2611bb96b7a44f31" title="Returns the number of elements stored in the hashtab.">ast_hashtab_size</a>(exten-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>) == 0) {
<a name="l04891"></a>04891                <span class="comment">/* well, if the last priority of an exten is to be removed,</span>
<a name="l04892"></a>04892 <span class="comment">                  then, the extension is removed, too! */</span>
<a name="l04893"></a>04893                exten3 = <a class="code" href="hashtab_8h.html#a71bd19ff2f6fad1cf5e01f9b8cad6f66" title="Hash the object and then compare ptrs in bucket list instead of calling the compare...">ast_hashtab_remove_this_object</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, exten);
<a name="l04894"></a>04894                <span class="keywordflow">if</span> (!exten3)
<a name="l04895"></a>04895                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Did not remove this exten (%s) from the context root_table (%s) (priority %d)\n&quot;</span>, exten-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, priority);
<a name="l04896"></a>04896                <span class="keywordflow">if</span> (con-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>) {
<a name="l04897"></a>04897                   <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a> = <a class="code" href="pbx_8c.html#aa638cd9d03f5d710b6a320ffda6d6392">add_exten_to_pattern_tree</a>(con, exten, 1);
<a name="l04898"></a>04898                   <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>) { <span class="comment">/* this test for safety purposes */</span>
<a name="l04899"></a>04899                      x-&gt;<a class="code" href="structmatch__char.html#a3cb0d95aa820737d010fdfaccac92ec3">deleted</a> = 1; <span class="comment">/* with this marked as deleted, it will never show up in the scoreboard, and therefore never be found */</span>
<a name="l04900"></a>04900                      x-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> = 0; <span class="comment">/* get rid of what will become a bad pointer */</span>
<a name="l04901"></a>04901                   }
<a name="l04902"></a>04902                }
<a name="l04903"></a>04903             }
<a name="l04904"></a>04904          } <span class="keywordflow">else</span> {
<a name="l04905"></a>04905             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Could not find priority %d of exten %s in context %s!\n&quot;</span>,
<a name="l04906"></a>04906                   priority, exten-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l04907"></a>04907          }
<a name="l04908"></a>04908       }
<a name="l04909"></a>04909    } <span class="keywordflow">else</span> {
<a name="l04910"></a>04910       <span class="comment">/* hmmm? this exten is not in this pattern tree? */</span>
<a name="l04911"></a>04911       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,<span class="stringliteral">&quot;Cannot find extension %s in root_table in context %s\n&quot;</span>,
<a name="l04912"></a>04912             extension, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l04913"></a>04913    }
<a name="l04914"></a>04914 <span class="preprocessor">#ifdef NEED_DEBUG</span>
<a name="l04915"></a>04915 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (con-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>) {
<a name="l04916"></a>04916       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;match char tree after exten removal:\n&quot;</span>);
<a name="l04917"></a>04917       <a class="code" href="pbx_8c.html#a45d3d0857a56e9ec039a20350bbb7d7f">log_match_char_tree</a>(con-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>, <span class="stringliteral">&quot; &quot;</span>);
<a name="l04918"></a>04918    }
<a name="l04919"></a>04919 <span class="preprocessor">#endif</span>
<a name="l04920"></a>04920 <span class="preprocessor"></span>
<a name="l04921"></a>04921    <span class="comment">/* scan the extension list to find first matching extension-registrar */</span>
<a name="l04922"></a>04922    <span class="keywordflow">for</span> (exten = con-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a>; exten; prev_exten = exten, exten = exten-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>) {
<a name="l04923"></a>04923       <span class="keywordflow">if</span> (!strcmp(exten-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, extension) &amp;&amp;
<a name="l04924"></a>04924          (!registrar || !strcmp(exten-&gt;<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>, registrar)) &amp;&amp;
<a name="l04925"></a>04925          (!matchcallerid || (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(callerid) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(exten-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>) &amp;&amp; !strcmp(exten-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>, callerid)) || (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(callerid) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(exten-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>))))
<a name="l04926"></a>04926          <span class="keywordflow">break</span>;
<a name="l04927"></a>04927    }
<a name="l04928"></a>04928    <span class="keywordflow">if</span> (!exten) {
<a name="l04929"></a>04929       <span class="comment">/* we can&apos;t find right extension */</span>
<a name="l04930"></a>04930       <span class="keywordflow">if</span> (!already_locked)
<a name="l04931"></a>04931          <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l04932"></a>04932       <span class="keywordflow">return</span> -1;
<a name="l04933"></a>04933    }
<a name="l04934"></a>04934 
<a name="l04935"></a>04935    <span class="comment">/* scan the priority list to remove extension with exten-&gt;priority == priority */</span>
<a name="l04936"></a>04936    <span class="keywordflow">for</span> (peer = exten, next_peer = exten-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> ? exten-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> : exten-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>;
<a name="l04937"></a>04937        peer &amp;&amp; !strcmp(peer-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, extension) &amp;&amp; (!matchcallerid || (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(callerid) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>) &amp;&amp; !strcmp(peer-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>,callerid)) || (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(callerid) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>)));
<a name="l04938"></a>04938          peer = next_peer, next_peer = next_peer ? (next_peer-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> ? next_peer-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> : next_peer-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>) : NULL) {
<a name="l04939"></a>04939       <span class="keywordflow">if</span> ((priority == 0 || peer-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> == priority) &amp;&amp;
<a name="l04940"></a>04940             (!callerid || !matchcallerid || (matchcallerid &amp;&amp; !strcmp(peer-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>, callerid))) &amp;&amp;
<a name="l04941"></a>04941             (!registrar || !strcmp(peer-&gt;<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>, registrar) )) {
<a name="l04942"></a>04942          found = 1;
<a name="l04943"></a>04943 
<a name="l04944"></a>04944          <span class="comment">/* we are first priority extension? */</span>
<a name="l04945"></a>04945          <span class="keywordflow">if</span> (!previous_peer) {
<a name="l04946"></a>04946             <span class="comment">/*</span>
<a name="l04947"></a>04947 <span class="comment">             * We are first in the priority chain, so must update the extension chain.</span>
<a name="l04948"></a>04948 <span class="comment">             * The next node is either the next priority or the next extension</span>
<a name="l04949"></a>04949 <span class="comment">             */</span>
<a name="l04950"></a>04950             <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *next_node = peer-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> ? peer-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> : peer-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>;
<a name="l04951"></a>04951             <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>) {
<a name="l04952"></a>04952                <span class="comment">/* move the peer_table and peer_label_table down to the next peer, if</span>
<a name="l04953"></a>04953 <span class="comment">                  it is there */</span>
<a name="l04954"></a>04954                peer-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a> = peer-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>;
<a name="l04955"></a>04955                peer-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a> = peer-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>;
<a name="l04956"></a>04956                peer-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a> = NULL;
<a name="l04957"></a>04957                peer-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a> = NULL;
<a name="l04958"></a>04958             }
<a name="l04959"></a>04959             <span class="keywordflow">if</span> (!prev_exten) {   <span class="comment">/* change the root... */</span>
<a name="l04960"></a>04960                con-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a> = next_node;
<a name="l04961"></a>04961             } <span class="keywordflow">else</span> {
<a name="l04962"></a>04962                prev_exten-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a> = next_node; <span class="comment">/* unlink */</span>
<a name="l04963"></a>04963             }
<a name="l04964"></a>04964             <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>)   { <span class="comment">/* update the new head of the pri list */</span>
<a name="l04965"></a>04965                peer-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a> = peer-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>;
<a name="l04966"></a>04966             }
<a name="l04967"></a>04967          } <span class="keywordflow">else</span> { <span class="comment">/* easy, we are not first priority in extension */</span>
<a name="l04968"></a>04968             previous_peer-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> = peer-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>;
<a name="l04969"></a>04969          }
<a name="l04970"></a>04970 
<a name="l04971"></a>04971          <span class="comment">/* now, free whole priority extension */</span>
<a name="l04972"></a>04972          <a class="code" href="pbx_8c.html#ae25a2122becbf9b94f5d55bc86753fea">destroy_exten</a>(peer);
<a name="l04973"></a>04973       } <span class="keywordflow">else</span> {
<a name="l04974"></a>04974          previous_peer = peer;
<a name="l04975"></a>04975       }
<a name="l04976"></a>04976    }
<a name="l04977"></a>04977    <span class="keywordflow">if</span> (!already_locked)
<a name="l04978"></a>04978       <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l04979"></a>04979    <span class="keywordflow">return</span> found ? 0 : -1;
<a name="l04980"></a>04980 }
<a name="l04981"></a>04981 
<a name="l04982"></a>04982 <span class="comment"></span>
<a name="l04983"></a>04983 <span class="comment">/*!</span>
<a name="l04984"></a>04984 <span class="comment"> * \note This function locks contexts list by &amp;conlist, searches for the right context</span>
<a name="l04985"></a>04985 <span class="comment"> * structure, and locks the macrolock mutex in that context.</span>
<a name="l04986"></a>04986 <span class="comment"> * macrolock is used to limit a macro to be executed by one call at a time.</span>
<a name="l04987"></a>04987 <span class="comment"> */</span>
<a name="l04988"></a><a class="code" href="pbx_8c.html#a3bad7413f0be95e52f6a473ddb130fe1">04988</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a0425cd7146d66b6ae06f16ddfd53307a" title="locks the macrolock in the given given context">ast_context_lockmacro</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context)
<a name="l04989"></a>04989 {
<a name="l04990"></a>04990    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = NULL;
<a name="l04991"></a>04991    <span class="keywordtype">int</span> ret = -1;
<a name="l04992"></a>04992    <span class="keyword">struct </span><a class="code" href="structfake__context.html">fake_context</a> item;
<a name="l04993"></a>04993 
<a name="l04994"></a>04994    <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l04995"></a>04995 
<a name="l04996"></a>04996    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(item.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, context, <span class="keyword">sizeof</span>(item.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>));
<a name="l04997"></a>04997 
<a name="l04998"></a>04998    c = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>,&amp;item);
<a name="l04999"></a>04999    <span class="keywordflow">if</span> (c)
<a name="l05000"></a>05000       ret = 0;
<a name="l05001"></a>05001 
<a name="l05002"></a>05002 
<a name="l05003"></a>05003 <span class="preprocessor">#ifdef NOTNOW</span>
<a name="l05004"></a>05004 <span class="preprocessor"></span>
<a name="l05005"></a>05005    <span class="keywordflow">while</span> ((c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c))) {
<a name="l05006"></a>05006       <span class="keywordflow">if</span> (!strcmp(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), context)) {
<a name="l05007"></a>05007          ret = 0;
<a name="l05008"></a>05008          <span class="keywordflow">break</span>;
<a name="l05009"></a>05009       }
<a name="l05010"></a>05010    }
<a name="l05011"></a>05011 
<a name="l05012"></a>05012 <span class="preprocessor">#endif</span>
<a name="l05013"></a>05013 <span class="preprocessor"></span>   <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l05014"></a>05014 
<a name="l05015"></a>05015    <span class="comment">/* if we found context, lock macrolock */</span>
<a name="l05016"></a>05016    <span class="keywordflow">if</span> (ret == 0) {
<a name="l05017"></a>05017       ret = <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;c-&gt;<a class="code" href="structast__context.html#a34eb63008d294b713376e64bb2a7b2ef">macrolock</a>);
<a name="l05018"></a>05018    }
<a name="l05019"></a>05019 
<a name="l05020"></a>05020    <span class="keywordflow">return</span> ret;
<a name="l05021"></a>05021 }
<a name="l05022"></a>05022 <span class="comment"></span>
<a name="l05023"></a>05023 <span class="comment">/*!</span>
<a name="l05024"></a>05024 <span class="comment"> * \note This function locks contexts list by &amp;conlist, searches for the right context</span>
<a name="l05025"></a>05025 <span class="comment"> * structure, and unlocks the macrolock mutex in that context.</span>
<a name="l05026"></a>05026 <span class="comment"> * macrolock is used to limit a macro to be executed by one call at a time.</span>
<a name="l05027"></a>05027 <span class="comment"> */</span>
<a name="l05028"></a><a class="code" href="pbx_8c.html#a27922d2f06d4030fc13ed69587c4c189">05028</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a0cb6fe63e51dd357d3146a1f1c64bd95" title="Unlocks the macrolock in the given context.">ast_context_unlockmacro</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context)
<a name="l05029"></a>05029 {
<a name="l05030"></a>05030    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = NULL;
<a name="l05031"></a>05031    <span class="keywordtype">int</span> ret = -1;
<a name="l05032"></a>05032    <span class="keyword">struct </span><a class="code" href="structfake__context.html">fake_context</a> item;
<a name="l05033"></a>05033 
<a name="l05034"></a>05034    <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l05035"></a>05035 
<a name="l05036"></a>05036    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(item.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, context, <span class="keyword">sizeof</span>(item.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>));
<a name="l05037"></a>05037 
<a name="l05038"></a>05038    c = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>,&amp;item);
<a name="l05039"></a>05039    <span class="keywordflow">if</span> (c)
<a name="l05040"></a>05040       ret = 0;
<a name="l05041"></a>05041 <span class="preprocessor">#ifdef NOTNOW</span>
<a name="l05042"></a>05042 <span class="preprocessor"></span>
<a name="l05043"></a>05043    <span class="keywordflow">while</span> ((c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c))) {
<a name="l05044"></a>05044       <span class="keywordflow">if</span> (!strcmp(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), context)) {
<a name="l05045"></a>05045          ret = 0;
<a name="l05046"></a>05046          <span class="keywordflow">break</span>;
<a name="l05047"></a>05047       }
<a name="l05048"></a>05048    }
<a name="l05049"></a>05049 
<a name="l05050"></a>05050 <span class="preprocessor">#endif</span>
<a name="l05051"></a>05051 <span class="preprocessor"></span>   <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l05052"></a>05052 
<a name="l05053"></a>05053    <span class="comment">/* if we found context, unlock macrolock */</span>
<a name="l05054"></a>05054    <span class="keywordflow">if</span> (ret == 0) {
<a name="l05055"></a>05055       ret = <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;c-&gt;<a class="code" href="structast__context.html#a34eb63008d294b713376e64bb2a7b2ef">macrolock</a>);
<a name="l05056"></a>05056    }
<a name="l05057"></a>05057 
<a name="l05058"></a>05058    <span class="keywordflow">return</span> ret;
<a name="l05059"></a>05059 }
<a name="l05060"></a>05060 <span class="comment"></span>
<a name="l05061"></a>05061 <span class="comment">/*! \brief Dynamically register a new dial plan application */</span>
<a name="l05062"></a><a class="code" href="pbx_8c.html#a6814b6d7b0a7d23c41df65124eb77171">05062</a> <span class="keywordtype">int</span> <a class="code" href="module_8h.html#a6814b6d7b0a7d23c41df65124eb77171" title="Register an application.">ast_register_application2</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#ad194d73de26c0d836555e029d245493d">app</a>, <span class="keywordtype">int</span> (*execute)(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *), <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__externalivr_8c.html#afa26529a1480355101f5b6d883a7d37e">synopsis</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a>, <span class="keywordtype">void</span> *mod)
<a name="l05063"></a>05063 {
<a name="l05064"></a>05064    <span class="keyword">struct </span>ast_app *tmp, *cur = NULL;
<a name="l05065"></a>05065    <span class="keywordtype">char</span> tmps[80];
<a name="l05066"></a>05066    <span class="keywordtype">int</span> length, res;
<a name="l05067"></a>05067 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l05068"></a>05068 <span class="preprocessor"></span>   <span class="keywordtype">char</span> *tmpxml;
<a name="l05069"></a>05069 <span class="preprocessor">#endif</span>
<a name="l05070"></a>05070 <span class="preprocessor"></span>
<a name="l05071"></a>05071    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l05072"></a>05072    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structapps.html">apps</a>, tmp, list) {
<a name="l05073"></a>05073       <span class="keywordflow">if</span> (!(res = strcasecmp(app, tmp-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>))) {
<a name="l05074"></a>05074          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Already have an application &apos;%s&apos;\n&quot;</span>, app);
<a name="l05075"></a>05075          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l05076"></a>05076          <span class="keywordflow">return</span> -1;
<a name="l05077"></a>05077       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &lt; 0)
<a name="l05078"></a>05078          <span class="keywordflow">break</span>;
<a name="l05079"></a>05079    }
<a name="l05080"></a>05080 
<a name="l05081"></a>05081    length = <span class="keyword">sizeof</span>(*tmp) + strlen(app) + 1;
<a name="l05082"></a>05082 
<a name="l05083"></a>05083    <span class="keywordflow">if</span> (!(tmp = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, length))) {
<a name="l05084"></a>05084       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l05085"></a>05085       <span class="keywordflow">return</span> -1;
<a name="l05086"></a>05086    }
<a name="l05087"></a>05087 
<a name="l05088"></a>05088    <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(tmp, 128)) {
<a name="l05089"></a>05089       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l05090"></a>05090       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05091"></a>05091       <span class="keywordflow">return</span> -1;
<a name="l05092"></a>05092    }
<a name="l05093"></a>05093 
<a name="l05094"></a>05094 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l05095"></a>05095 <span class="preprocessor"></span>   <span class="comment">/* Try to lookup the docs in our XML documentation database */</span>
<a name="l05096"></a>05096    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(synopsis) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(description)) {
<a name="l05097"></a>05097       <span class="comment">/* load synopsis */</span>
<a name="l05098"></a>05098       tmpxml = <a class="code" href="xmldoc_8h.html#a92ab99fc2fa8a31c591531b36d391e3f" title="Generate synopsis documentation from XML.">ast_xmldoc_build_synopsis</a>(<span class="stringliteral">&quot;application&quot;</span>, app);
<a name="l05099"></a>05099       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, synopsis, tmpxml);
<a name="l05100"></a>05100       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmpxml);
<a name="l05101"></a>05101 
<a name="l05102"></a>05102       <span class="comment">/* load description */</span>
<a name="l05103"></a>05103       tmpxml = <a class="code" href="xmldoc_8h.html#a7e6109ee5ae553d1fb3b6e7a7c4617f9" title="Generate description documentation from XML.">ast_xmldoc_build_description</a>(<span class="stringliteral">&quot;application&quot;</span>, app);
<a name="l05104"></a>05104       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, description, tmpxml);
<a name="l05105"></a>05105       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmpxml);
<a name="l05106"></a>05106 
<a name="l05107"></a>05107       <span class="comment">/* load syntax */</span>
<a name="l05108"></a>05108       tmpxml = <a class="code" href="xmldoc_8h.html#a54a5b2e3ff1b6b6f06d9bab70e70c924" title="Get the syntax for a specified application or function.">ast_xmldoc_build_syntax</a>(<span class="stringliteral">&quot;application&quot;</span>, app);
<a name="l05109"></a>05109       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, <a class="code" href="structast__app.html#ac72ddaf7b92092136fc38629a809c87a">syntax</a>, tmpxml);
<a name="l05110"></a>05110       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmpxml);
<a name="l05111"></a>05111 
<a name="l05112"></a>05112       <span class="comment">/* load arguments */</span>
<a name="l05113"></a>05113       tmpxml = <a class="code" href="xmldoc_8h.html#a54ea6bbcddbb8ef17051136a73227847" title="Generate the [arguments] tag based on type of node (&amp;#39;application&amp;#39;, &amp;#39;function&amp;#39;...">ast_xmldoc_build_arguments</a>(<span class="stringliteral">&quot;application&quot;</span>, app);
<a name="l05114"></a>05114       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, <a class="code" href="structast__app.html#ad3d4ea338fb9552532c6828f6c312c57">arguments</a>, tmpxml);
<a name="l05115"></a>05115       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmpxml);
<a name="l05116"></a>05116 
<a name="l05117"></a>05117       <span class="comment">/* load seealso */</span>
<a name="l05118"></a>05118       tmpxml = <a class="code" href="xmldoc_8h.html#a51987b5bfa995cc9b76c81dd1a1d6ad4" title="Parse the &amp;lt;see-also&amp;gt; node content.">ast_xmldoc_build_seealso</a>(<span class="stringliteral">&quot;application&quot;</span>, app);
<a name="l05119"></a>05119       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, <a class="code" href="structast__app.html#ac07925c5773daffa1e00486fbb9ef495">seealso</a>, tmpxml);
<a name="l05120"></a>05120       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmpxml);
<a name="l05121"></a>05121       tmp-&gt;<a class="code" href="structast__app.html#aa871ca3c361d229d4e37edf3c6016cc1">docsrc</a> = <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3a24212840b7b1b0e9c1eebc8cfd89ab3e">AST_XML_DOC</a>;
<a name="l05122"></a>05122    } <span class="keywordflow">else</span> {
<a name="l05123"></a>05123 <span class="preprocessor">#endif</span>
<a name="l05124"></a>05124 <span class="preprocessor"></span>      <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, synopsis, synopsis);
<a name="l05125"></a>05125       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, description, description);
<a name="l05126"></a>05126       tmp-&gt;<a class="code" href="structast__app.html#aa871ca3c361d229d4e37edf3c6016cc1">docsrc</a> = <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3a7273ed64a1fd4a93692986eac376124a">AST_STATIC_DOC</a>;
<a name="l05127"></a>05127 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l05128"></a>05128 <span class="preprocessor"></span>   }
<a name="l05129"></a>05129 <span class="preprocessor">#endif</span>
<a name="l05130"></a>05130 <span class="preprocessor"></span>
<a name="l05131"></a>05131    strcpy(tmp-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, app);
<a name="l05132"></a>05132    tmp-&gt;<a class="code" href="structast__app.html#aaa273c19af19ad4f2f0cd376bd1b5f8f">execute</a> = <a class="code" href="structast__app.html#aaa273c19af19ad4f2f0cd376bd1b5f8f">execute</a>;
<a name="l05133"></a>05133    tmp-&gt;<a class="code" href="structast__app.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">module</a> = mod;
<a name="l05134"></a>05134 
<a name="l05135"></a>05135    <span class="comment">/* Store in alphabetical order */</span>
<a name="l05136"></a>05136    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structapps.html">apps</a>, cur, list) {
<a name="l05137"></a>05137       <span class="keywordflow">if</span> (strcasecmp(tmp-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, cur-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>) &lt; 0) {
<a name="l05138"></a>05138          <a class="code" href="linkedlists_8h.html#acf8253a64f9a4e2170454f4bf0559e33">AST_RWLIST_INSERT_BEFORE_CURRENT</a>(tmp, list);
<a name="l05139"></a>05139          <span class="keywordflow">break</span>;
<a name="l05140"></a>05140       }
<a name="l05141"></a>05141    }
<a name="l05142"></a>05142    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l05143"></a>05143    <span class="keywordflow">if</span> (!cur)
<a name="l05144"></a>05144       <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;<a class="code" href="structapps.html">apps</a>, tmp, list);
<a name="l05145"></a>05145 
<a name="l05146"></a>05146    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Registered application &apos;%s&apos;\n&quot;</span>, <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmps, tmp-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, <a class="code" href="term_8h.html#a23aeefae76b2cacc1a6162de88c3fff0">COLOR_BRCYAN</a>, 0, <span class="keyword">sizeof</span>(tmps)));
<a name="l05147"></a>05147 
<a name="l05148"></a>05148    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l05149"></a>05149 
<a name="l05150"></a>05150    <span class="keywordflow">return</span> 0;
<a name="l05151"></a>05151 }
<a name="l05152"></a>05152 
<a name="l05153"></a>05153 <span class="comment">/*</span>
<a name="l05154"></a>05154 <span class="comment"> * Append to the list. We don&apos;t have a tail pointer because we need</span>
<a name="l05155"></a>05155 <span class="comment"> * to scan the list anyways to check for duplicates during insertion.</span>
<a name="l05156"></a>05156 <span class="comment"> */</span>
<a name="l05157"></a><a class="code" href="pbx_8c.html#a5297fa9c52ff50da5b08c7217d9251b4">05157</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a5297fa9c52ff50da5b08c7217d9251b4" title="Register an alternative dialplan switch.">ast_register_switch</a>(<span class="keyword">struct</span> <a class="code" href="structast__switch.html">ast_switch</a> *sw)
<a name="l05158"></a>05158 {
<a name="l05159"></a>05159    <span class="keyword">struct </span><a class="code" href="structast__switch.html">ast_switch</a> *tmp;
<a name="l05160"></a>05160 
<a name="l05161"></a>05161    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structswitches.html">switches</a>);
<a name="l05162"></a>05162    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structswitches.html">switches</a>, tmp, list) {
<a name="l05163"></a>05163       <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__switch.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, sw-&gt;<a class="code" href="structast__switch.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)) {
<a name="l05164"></a>05164          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structswitches.html">switches</a>);
<a name="l05165"></a>05165          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Switch &apos;%s&apos; already found\n&quot;</span>, sw-&gt;<a class="code" href="structast__switch.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l05166"></a>05166          <span class="keywordflow">return</span> -1;
<a name="l05167"></a>05167       }
<a name="l05168"></a>05168    }
<a name="l05169"></a>05169    <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;<a class="code" href="structswitches.html">switches</a>, sw, list);
<a name="l05170"></a>05170    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structswitches.html">switches</a>);
<a name="l05171"></a>05171 
<a name="l05172"></a>05172    <span class="keywordflow">return</span> 0;
<a name="l05173"></a>05173 }
<a name="l05174"></a>05174 
<a name="l05175"></a><a class="code" href="pbx_8c.html#a4b11d763a689cb0df33a4a16c9d89ef3">05175</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8h.html#a4b11d763a689cb0df33a4a16c9d89ef3" title="Unregister an alternative switch.">ast_unregister_switch</a>(<span class="keyword">struct</span> <a class="code" href="structast__switch.html">ast_switch</a> *sw)
<a name="l05176"></a>05176 {
<a name="l05177"></a>05177    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structswitches.html">switches</a>);
<a name="l05178"></a>05178    <a class="code" href="linkedlists_8h.html#a6091f0518f8b6f443fd9f5150f3ac407">AST_RWLIST_REMOVE</a>(&amp;<a class="code" href="structswitches.html">switches</a>, sw, list);
<a name="l05179"></a>05179    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structswitches.html">switches</a>);
<a name="l05180"></a>05180 }
<a name="l05181"></a>05181 
<a name="l05182"></a>05182 <span class="comment">/*</span>
<a name="l05183"></a>05183 <span class="comment"> * Help for CLI commands ...</span>
<a name="l05184"></a>05184 <span class="comment"> */</span>
<a name="l05185"></a>05185 
<a name="l05186"></a><a class="code" href="pbx_8c.html#aa94d17bd73cb159dc928df900a10f88f">05186</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#aa94d17bd73cb159dc928df900a10f88f">print_app_docs</a>(<span class="keyword">struct</span> ast_app *aa, <span class="keywordtype">int</span> fd)
<a name="l05187"></a>05187 {
<a name="l05188"></a>05188    <span class="comment">/* Maximum number of characters added by terminal coloring is 22 */</span>
<a name="l05189"></a>05189    <span class="keywordtype">char</span> infotitle[64 + <a class="code" href="pbx_8h.html#a3414b82af9b33fe907c9377c5c73c453">AST_MAX_APP</a> + 22], syntitle[40], destitle[40], stxtitle[40], argtitle[40];
<a name="l05190"></a>05190    <span class="keywordtype">char</span> seealsotitle[40];
<a name="l05191"></a>05191    <span class="keywordtype">char</span> info[64 + <a class="code" href="pbx_8h.html#a3414b82af9b33fe907c9377c5c73c453">AST_MAX_APP</a>], *<a class="code" href="app__externalivr_8c.html#afa26529a1480355101f5b6d883a7d37e">synopsis</a> = NULL, *<a class="code" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = NULL, *syntax = NULL, *arguments = NULL;
<a name="l05192"></a>05192    <span class="keywordtype">char</span> *seealso = NULL;
<a name="l05193"></a>05193    <span class="keywordtype">int</span> syntax_size, synopsis_size, description_size, arguments_size, seealso_size;
<a name="l05194"></a>05194 
<a name="l05195"></a>05195    snprintf(info, <span class="keyword">sizeof</span>(info), <span class="stringliteral">&quot;\n  -= Info about application &apos;%s&apos; =- \n\n&quot;</span>, aa-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l05196"></a>05196    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(infotitle, info, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, <span class="keyword">sizeof</span>(infotitle));
<a name="l05197"></a>05197 
<a name="l05198"></a>05198    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(syntitle, <span class="stringliteral">&quot;[Synopsis]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, 40);
<a name="l05199"></a>05199    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(destitle, <span class="stringliteral">&quot;[Description]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, 40);
<a name="l05200"></a>05200    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(stxtitle, <span class="stringliteral">&quot;[Syntax]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, 40);
<a name="l05201"></a>05201    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(argtitle, <span class="stringliteral">&quot;[Arguments]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, 40);
<a name="l05202"></a>05202    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(seealsotitle, <span class="stringliteral">&quot;[See Also]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, 40);
<a name="l05203"></a>05203 
<a name="l05204"></a>05204 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l05205"></a>05205 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (aa-&gt;<a class="code" href="structast__app.html#aa871ca3c361d229d4e37edf3c6016cc1">docsrc</a> == <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3a24212840b7b1b0e9c1eebc8cfd89ab3e">AST_XML_DOC</a>) {
<a name="l05206"></a>05206       description = <a class="code" href="xmldoc_8h.html#a637de870dfc83d0694f588c5a814ce38" title="Colorize and put delimiters (instead of tags) to the xmldoc output.">ast_xmldoc_printable</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#a76f76ee5f847833b202461d55b23c17a">description</a>, <span class="stringliteral">&quot;Not available&quot;</span>), 1);
<a name="l05207"></a>05207       arguments = <a class="code" href="xmldoc_8h.html#a637de870dfc83d0694f588c5a814ce38" title="Colorize and put delimiters (instead of tags) to the xmldoc output.">ast_xmldoc_printable</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#ad3d4ea338fb9552532c6828f6c312c57">arguments</a>, <span class="stringliteral">&quot;Not available&quot;</span>), 1);
<a name="l05208"></a>05208       synopsis = <a class="code" href="xmldoc_8h.html#a637de870dfc83d0694f588c5a814ce38" title="Colorize and put delimiters (instead of tags) to the xmldoc output.">ast_xmldoc_printable</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#aa403beb670a3277f542647cc9aa22137">synopsis</a>, <span class="stringliteral">&quot;Not available&quot;</span>), 1);
<a name="l05209"></a>05209       seealso = <a class="code" href="xmldoc_8h.html#a637de870dfc83d0694f588c5a814ce38" title="Colorize and put delimiters (instead of tags) to the xmldoc output.">ast_xmldoc_printable</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#ac07925c5773daffa1e00486fbb9ef495">seealso</a>, <span class="stringliteral">&quot;Not available&quot;</span>), 1);
<a name="l05210"></a>05210 
<a name="l05211"></a>05211       <span class="keywordflow">if</span> (!synopsis || !description || !arguments || !seealso) {
<a name="l05212"></a>05212          <span class="keywordflow">goto</span> return_cleanup;
<a name="l05213"></a>05213       }
<a name="l05214"></a>05214    } <span class="keywordflow">else</span>
<a name="l05215"></a>05215 <span class="preprocessor">#endif</span>
<a name="l05216"></a>05216 <span class="preprocessor"></span>   {
<a name="l05217"></a>05217       synopsis_size = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#aa403beb670a3277f542647cc9aa22137">synopsis</a>, <span class="stringliteral">&quot;Not Available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l05218"></a>05218       synopsis = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(synopsis_size);
<a name="l05219"></a>05219 
<a name="l05220"></a>05220       description_size = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#a76f76ee5f847833b202461d55b23c17a">description</a>, <span class="stringliteral">&quot;Not Available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l05221"></a>05221       description = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(description_size);
<a name="l05222"></a>05222 
<a name="l05223"></a>05223       arguments_size = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#ad3d4ea338fb9552532c6828f6c312c57">arguments</a>, <span class="stringliteral">&quot;Not Available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l05224"></a>05224       arguments = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(arguments_size);
<a name="l05225"></a>05225 
<a name="l05226"></a>05226       seealso_size = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#ac07925c5773daffa1e00486fbb9ef495">seealso</a>, <span class="stringliteral">&quot;Not Available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l05227"></a>05227       seealso = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(seealso_size);
<a name="l05228"></a>05228 
<a name="l05229"></a>05229       <span class="keywordflow">if</span> (!synopsis || !description || !arguments || !seealso) {
<a name="l05230"></a>05230          <span class="keywordflow">goto</span> return_cleanup;
<a name="l05231"></a>05231       }
<a name="l05232"></a>05232 
<a name="l05233"></a>05233       <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(synopsis, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#aa403beb670a3277f542647cc9aa22137">synopsis</a>, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, synopsis_size);
<a name="l05234"></a>05234       <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(description, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#a76f76ee5f847833b202461d55b23c17a">description</a>, <span class="stringliteral">&quot;Not available&quot;</span>),   <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, description_size);
<a name="l05235"></a>05235       <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(arguments, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#ad3d4ea338fb9552532c6828f6c312c57">arguments</a>, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, arguments_size);
<a name="l05236"></a>05236       <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(seealso, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#ac07925c5773daffa1e00486fbb9ef495">seealso</a>, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, seealso_size);
<a name="l05237"></a>05237    }
<a name="l05238"></a>05238 
<a name="l05239"></a>05239    <span class="comment">/* Handle the syntax the same for both XML and raw docs */</span>
<a name="l05240"></a>05240    syntax_size = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#ac72ddaf7b92092136fc38629a809c87a">syntax</a>, <span class="stringliteral">&quot;Not Available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l05241"></a>05241    <span class="keywordflow">if</span> (!(syntax = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(syntax_size))) {
<a name="l05242"></a>05242       <span class="keywordflow">goto</span> return_cleanup;
<a name="l05243"></a>05243    }
<a name="l05244"></a>05244    <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(syntax, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(aa-&gt;<a class="code" href="structast__app.html#ac72ddaf7b92092136fc38629a809c87a">syntax</a>, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, syntax_size);
<a name="l05245"></a>05245 
<a name="l05246"></a>05246    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s%s%s\n\n%s%s\n\n%s%s\n\n%s%s\n\n%s%s\n&quot;</span>,
<a name="l05247"></a>05247          infotitle, syntitle, synopsis, destitle, description,
<a name="l05248"></a>05248          stxtitle, syntax, argtitle, arguments, seealsotitle, seealso);
<a name="l05249"></a>05249 
<a name="l05250"></a>05250 return_cleanup:
<a name="l05251"></a>05251    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(description);
<a name="l05252"></a>05252    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(arguments);
<a name="l05253"></a>05253    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(synopsis);
<a name="l05254"></a>05254    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(seealso);
<a name="l05255"></a>05255    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(syntax);
<a name="l05256"></a>05256 }
<a name="l05257"></a>05257 
<a name="l05258"></a>05258 <span class="comment">/*</span>
<a name="l05259"></a>05259 <span class="comment"> * \brief &apos;show application&apos; CLI command implementation function...</span>
<a name="l05260"></a>05260 <span class="comment"> */</span>
<a name="l05261"></a><a class="code" href="pbx_8c.html#ad6c3fdc0a614d26cd94782971d5772da">05261</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#ad6c3fdc0a614d26cd94782971d5772da">handle_show_application</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l05262"></a>05262 {
<a name="l05263"></a>05263    <span class="keyword">struct </span>ast_app *aa;
<a name="l05264"></a>05264    <span class="keywordtype">int</span> app, no_registered_app = 1;
<a name="l05265"></a>05265    <span class="keywordtype">char</span> *ret = NULL;
<a name="l05266"></a>05266    <span class="keywordtype">int</span> which = 0;
<a name="l05267"></a>05267    <span class="keywordtype">int</span> wordlen;
<a name="l05268"></a>05268 
<a name="l05269"></a>05269    <span class="keywordflow">switch</span> (cmd) {
<a name="l05270"></a>05270    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l05271"></a>05271       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show application&quot;</span>;
<a name="l05272"></a>05272       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l05273"></a>05273          <span class="stringliteral">&quot;Usage: core show application &lt;application&gt; [&lt;application&gt; [&lt;application&gt; [...]]]\n&quot;</span>
<a name="l05274"></a>05274          <span class="stringliteral">&quot;       Describes a particular application.\n&quot;</span>;
<a name="l05275"></a>05275       <span class="keywordflow">return</span> NULL;
<a name="l05276"></a>05276    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l05277"></a>05277       <span class="comment">/*</span>
<a name="l05278"></a>05278 <span class="comment">       * There is a possibility to show informations about more than one</span>
<a name="l05279"></a>05279 <span class="comment">       * application at one time. You can type &apos;show application Dial Echo&apos; and</span>
<a name="l05280"></a>05280 <span class="comment">       * you will see informations about these two applications ...</span>
<a name="l05281"></a>05281 <span class="comment">       */</span>
<a name="l05282"></a>05282       wordlen = strlen(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>);
<a name="l05283"></a>05283       <span class="comment">/* return the n-th [partial] matching entry */</span>
<a name="l05284"></a>05284       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l05285"></a>05285       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structapps.html">apps</a>, aa, list) {
<a name="l05286"></a>05286          <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, aa-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, wordlen) &amp;&amp; ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>) {
<a name="l05287"></a>05287             ret = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(aa-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l05288"></a>05288             <span class="keywordflow">break</span>;
<a name="l05289"></a>05289          }
<a name="l05290"></a>05290       }
<a name="l05291"></a>05291       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l05292"></a>05292 
<a name="l05293"></a>05293       <span class="keywordflow">return</span> ret;
<a name="l05294"></a>05294    }
<a name="l05295"></a>05295 
<a name="l05296"></a>05296    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 4) {
<a name="l05297"></a>05297       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l05298"></a>05298    }
<a name="l05299"></a>05299 
<a name="l05300"></a>05300    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l05301"></a>05301    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structapps.html">apps</a>, aa, list) {
<a name="l05302"></a>05302       <span class="comment">/* Check for each app that was supplied as an argument */</span>
<a name="l05303"></a>05303       <span class="keywordflow">for</span> (app = 3; app &lt; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>; app++) {
<a name="l05304"></a>05304          <span class="keywordflow">if</span> (strcasecmp(aa-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[app])) {
<a name="l05305"></a>05305             <span class="keywordflow">continue</span>;
<a name="l05306"></a>05306          }
<a name="l05307"></a>05307 
<a name="l05308"></a>05308          <span class="comment">/* We found it! */</span>
<a name="l05309"></a>05309          no_registered_app = 0;
<a name="l05310"></a>05310 
<a name="l05311"></a>05311          <a class="code" href="pbx_8c.html#aa94d17bd73cb159dc928df900a10f88f">print_app_docs</a>(aa, a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>);
<a name="l05312"></a>05312       }
<a name="l05313"></a>05313    }
<a name="l05314"></a>05314    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l05315"></a>05315 
<a name="l05316"></a>05316    <span class="comment">/* we found at least one app? no? */</span>
<a name="l05317"></a>05317    <span class="keywordflow">if</span> (no_registered_app) {
<a name="l05318"></a>05318       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Your application(s) is (are) not registered\n&quot;</span>);
<a name="l05319"></a>05319       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l05320"></a>05320    }
<a name="l05321"></a>05321 
<a name="l05322"></a>05322    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l05323"></a>05323 }
<a name="l05324"></a>05324 <span class="comment"></span>
<a name="l05325"></a>05325 <span class="comment">/*! \brief  handle_show_hints: CLI support for listing registered dial plan hints */</span>
<a name="l05326"></a><a class="code" href="pbx_8c.html#a6a6ee2e0a596361065c15a8795b7ea3d">05326</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a6a6ee2e0a596361065c15a8795b7ea3d" title="handle_show_hints: CLI support for listing registered dial plan hints">handle_show_hints</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l05327"></a>05327 {
<a name="l05328"></a>05328    <span class="keyword">struct </span>ast_hint *hint;
<a name="l05329"></a>05329    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a> = 0;
<a name="l05330"></a>05330    <span class="keywordtype">int</span> watchers;
<a name="l05331"></a>05331    <span class="keyword">struct </span>ast_state_cb *watcher;
<a name="l05332"></a>05332 
<a name="l05333"></a>05333    <span class="keywordflow">switch</span> (cmd) {
<a name="l05334"></a>05334    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l05335"></a>05335       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show hints&quot;</span>;
<a name="l05336"></a>05336       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l05337"></a>05337          <span class="stringliteral">&quot;Usage: core show hints\n&quot;</span>
<a name="l05338"></a>05338          <span class="stringliteral">&quot;       List registered hints\n&quot;</span>;
<a name="l05339"></a>05339       <span class="keywordflow">return</span> NULL;
<a name="l05340"></a>05340    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l05341"></a>05341       <span class="keywordflow">return</span> NULL;
<a name="l05342"></a>05342    }
<a name="l05343"></a>05343 
<a name="l05344"></a>05344    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l05345"></a>05345    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a0044f6572f50a89049b3b5272e51b0e7">AST_RWLIST_EMPTY</a>(&amp;<a class="code" href="structhints.html">hints</a>)) {
<a name="l05346"></a>05346       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There are no registered dialplan hints\n&quot;</span>);
<a name="l05347"></a>05347       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l05348"></a>05348       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l05349"></a>05349    }
<a name="l05350"></a>05350    <span class="comment">/* ... we have hints ... */</span>
<a name="l05351"></a>05351    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n    -= Registered Asterisk Dial Plan Hints =-\n&quot;</span>);
<a name="l05352"></a>05352    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structhints.html">hints</a>, hint, list) {
<a name="l05353"></a>05353       watchers = 0;
<a name="l05354"></a>05354       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;hint-&gt;<a class="code" href="structast__hint.html#aa3e3352bf7668925eba2e02ccdaf017a">callbacks</a>, watcher, entry) {
<a name="l05355"></a>05355          watchers++;
<a name="l05356"></a>05356       }
<a name="l05357"></a>05357       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;   %20s@%-20.20s: %-20.20s  State:%-15.15s Watchers %2d\n&quot;</span>,
<a name="l05358"></a>05358          <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>),
<a name="l05359"></a>05359          <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(<a class="code" href="pbx_8h.html#a65bb6651308bdad136b637965835cb82">ast_get_extension_context</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>)),
<a name="l05360"></a>05360          <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>),
<a name="l05361"></a>05361          <a class="code" href="pbx_8h.html#a3261603753916b98888a5a5fc1d505c3" title="Return string representation of the state of an extension.">ast_extension_state2str</a>(hint-&gt;<a class="code" href="structast__hint.html#a0078d2e3ae10f15d7634c01199f33d4f">laststate</a>), watchers);
<a name="l05362"></a>05362       num++;
<a name="l05363"></a>05363    }
<a name="l05364"></a>05364    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;----------------\n&quot;</span>);
<a name="l05365"></a>05365    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;- %d hints registered\n&quot;</span>, num);
<a name="l05366"></a>05366    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l05367"></a>05367    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l05368"></a>05368 }
<a name="l05369"></a>05369 <span class="comment"></span>
<a name="l05370"></a>05370 <span class="comment">/*! \brief autocomplete for CLI command &apos;core show hint&apos; */</span>
<a name="l05371"></a><a class="code" href="pbx_8c.html#a80774ac6048ab3b7b8a722bb25fd15b3">05371</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a80774ac6048ab3b7b8a722bb25fd15b3" title="autocomplete for CLI command &amp;#39;core show hint&amp;#39;">complete_core_show_hint</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l05372"></a>05372 {
<a name="l05373"></a>05373    <span class="keyword">struct </span>ast_hint *hint;
<a name="l05374"></a>05374    <span class="keywordtype">char</span> *ret = NULL;
<a name="l05375"></a>05375    <span class="keywordtype">int</span> which = 0;
<a name="l05376"></a>05376    <span class="keywordtype">int</span> wordlen;
<a name="l05377"></a>05377 
<a name="l05378"></a>05378    <span class="keywordflow">if</span> (pos != 3)
<a name="l05379"></a>05379       <span class="keywordflow">return</span> NULL;
<a name="l05380"></a>05380 
<a name="l05381"></a>05381    wordlen = strlen(word);
<a name="l05382"></a>05382 
<a name="l05383"></a>05383    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l05384"></a>05384    <span class="comment">/* walk through all hints */</span>
<a name="l05385"></a>05385    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structhints.html">hints</a>, hint, list) {
<a name="l05386"></a>05386       <span class="keywordflow">if</span> (!strncasecmp(word, <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>), wordlen) &amp;&amp; ++which &gt; state) {
<a name="l05387"></a>05387          ret = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>));
<a name="l05388"></a>05388          <span class="keywordflow">break</span>;
<a name="l05389"></a>05389       }
<a name="l05390"></a>05390    }
<a name="l05391"></a>05391    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l05392"></a>05392 
<a name="l05393"></a>05393    <span class="keywordflow">return</span> ret;
<a name="l05394"></a>05394 }
<a name="l05395"></a>05395 <span class="comment"></span>
<a name="l05396"></a>05396 <span class="comment">/*! \brief  handle_show_hint: CLI support for listing registered dial plan hint */</span>
<a name="l05397"></a><a class="code" href="pbx_8c.html#a6ede44bb54442c1980e3d2e91da4b4bd">05397</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a6ede44bb54442c1980e3d2e91da4b4bd" title="handle_show_hint: CLI support for listing registered dial plan hint">handle_show_hint</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l05398"></a>05398 {
<a name="l05399"></a>05399    <span class="keyword">struct </span>ast_hint *hint;
<a name="l05400"></a>05400    <span class="keywordtype">int</span> watchers;
<a name="l05401"></a>05401    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a> = 0, extenlen;
<a name="l05402"></a>05402    <span class="keyword">struct </span>ast_state_cb *watcher;
<a name="l05403"></a>05403 
<a name="l05404"></a>05404    <span class="keywordflow">switch</span> (cmd) {
<a name="l05405"></a>05405    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l05406"></a>05406       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show hint&quot;</span>;
<a name="l05407"></a>05407       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l05408"></a>05408          <span class="stringliteral">&quot;Usage: core show hint &lt;exten&gt;\n&quot;</span>
<a name="l05409"></a>05409          <span class="stringliteral">&quot;       List registered hint\n&quot;</span>;
<a name="l05410"></a>05410       <span class="keywordflow">return</span> NULL;
<a name="l05411"></a>05411    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l05412"></a>05412       <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#a80774ac6048ab3b7b8a722bb25fd15b3" title="autocomplete for CLI command &amp;#39;core show hint&amp;#39;">complete_core_show_hint</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l05413"></a>05413    }
<a name="l05414"></a>05414 
<a name="l05415"></a>05415    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 4)
<a name="l05416"></a>05416       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l05417"></a>05417 
<a name="l05418"></a>05418    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l05419"></a>05419    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a0044f6572f50a89049b3b5272e51b0e7">AST_RWLIST_EMPTY</a>(&amp;<a class="code" href="structhints.html">hints</a>)) {
<a name="l05420"></a>05420       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There are no registered dialplan hints\n&quot;</span>);
<a name="l05421"></a>05421       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l05422"></a>05422       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l05423"></a>05423    }
<a name="l05424"></a>05424    extenlen = strlen(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l05425"></a>05425    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structhints.html">hints</a>, hint, list) {
<a name="l05426"></a>05426       <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>), a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], extenlen)) {
<a name="l05427"></a>05427          watchers = 0;
<a name="l05428"></a>05428          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;hint-&gt;<a class="code" href="structast__hint.html#aa3e3352bf7668925eba2e02ccdaf017a">callbacks</a>, watcher, entry) {
<a name="l05429"></a>05429             watchers++;
<a name="l05430"></a>05430          }
<a name="l05431"></a>05431          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;   %20s@%-20.20s: %-20.20s  State:%-15.15s Watchers %2d\n&quot;</span>,
<a name="l05432"></a>05432             <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>),
<a name="l05433"></a>05433             <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(<a class="code" href="pbx_8h.html#a65bb6651308bdad136b637965835cb82">ast_get_extension_context</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>)),
<a name="l05434"></a>05434             <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>),
<a name="l05435"></a>05435             <a class="code" href="pbx_8h.html#a3261603753916b98888a5a5fc1d505c3" title="Return string representation of the state of an extension.">ast_extension_state2str</a>(hint-&gt;<a class="code" href="structast__hint.html#a0078d2e3ae10f15d7634c01199f33d4f">laststate</a>), watchers);
<a name="l05436"></a>05436          num++;
<a name="l05437"></a>05437       }
<a name="l05438"></a>05438    }
<a name="l05439"></a>05439    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l05440"></a>05440    <span class="keywordflow">if</span> (!num)
<a name="l05441"></a>05441       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No hints matching extension %s\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l05442"></a>05442    <span class="keywordflow">else</span>
<a name="l05443"></a>05443       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d hint%s matching extension %s\n&quot;</span>, num, (num!=1 ? <span class="stringliteral">&quot;s&quot;</span>:<span class="stringliteral">&quot;&quot;</span>), a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l05444"></a>05444    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l05445"></a>05445 }
<a name="l05446"></a>05446 
<a name="l05447"></a>05447 <span class="comment"></span>
<a name="l05448"></a>05448 <span class="comment">/*! \brief  handle_show_switches: CLI support for listing registered dial plan switches */</span>
<a name="l05449"></a><a class="code" href="pbx_8c.html#ab60040f3a7c86b47c2b7475892d55852">05449</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#ab60040f3a7c86b47c2b7475892d55852" title="handle_show_switches: CLI support for listing registered dial plan switches">handle_show_switches</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l05450"></a>05450 {
<a name="l05451"></a>05451    <span class="keyword">struct </span><a class="code" href="structast__switch.html">ast_switch</a> *sw;
<a name="l05452"></a>05452 
<a name="l05453"></a>05453    <span class="keywordflow">switch</span> (cmd) {
<a name="l05454"></a>05454    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l05455"></a>05455       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show switches&quot;</span>;
<a name="l05456"></a>05456       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l05457"></a>05457          <span class="stringliteral">&quot;Usage: core show switches\n&quot;</span>
<a name="l05458"></a>05458          <span class="stringliteral">&quot;       List registered switches\n&quot;</span>;
<a name="l05459"></a>05459       <span class="keywordflow">return</span> NULL;
<a name="l05460"></a>05460    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l05461"></a>05461       <span class="keywordflow">return</span> NULL;
<a name="l05462"></a>05462    }
<a name="l05463"></a>05463 
<a name="l05464"></a>05464    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structswitches.html">switches</a>);
<a name="l05465"></a>05465 
<a name="l05466"></a>05466    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a0044f6572f50a89049b3b5272e51b0e7">AST_RWLIST_EMPTY</a>(&amp;<a class="code" href="structswitches.html">switches</a>)) {
<a name="l05467"></a>05467       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structswitches.html">switches</a>);
<a name="l05468"></a>05468       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There are no registered alternative switches\n&quot;</span>);
<a name="l05469"></a>05469       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l05470"></a>05470    }
<a name="l05471"></a>05471 
<a name="l05472"></a>05472    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n    -= Registered Asterisk Alternative Switches =-\n&quot;</span>);
<a name="l05473"></a>05473    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structswitches.html">switches</a>, sw, list)
<a name="l05474"></a>05474       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s: %s\n&quot;</span>, sw-&gt;<a class="code" href="structast__switch.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, sw-&gt;<a class="code" href="structast__switch.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a>);
<a name="l05475"></a>05475 
<a name="l05476"></a>05476    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structswitches.html">switches</a>);
<a name="l05477"></a>05477 
<a name="l05478"></a>05478    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l05479"></a>05479 }
<a name="l05480"></a>05480 
<a name="l05481"></a><a class="code" href="pbx_8c.html#a3fd3a2a72933c9a81547a7c1fab6d5f0">05481</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a3fd3a2a72933c9a81547a7c1fab6d5f0">handle_show_applications</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l05482"></a>05482 {
<a name="l05483"></a>05483    <span class="keyword">struct </span>ast_app *aa;
<a name="l05484"></a>05484    <span class="keywordtype">int</span> like = 0, describing = 0;
<a name="l05485"></a>05485    <span class="keywordtype">int</span> total_match = 0;    <span class="comment">/* Number of matches in like clause */</span>
<a name="l05486"></a>05486    <span class="keywordtype">int</span> total_apps = 0;     <span class="comment">/* Number of apps registered */</span>
<a name="l05487"></a>05487    <span class="keyword">static</span> <span class="keywordtype">char</span>* choices[] = { <span class="stringliteral">&quot;like&quot;</span>, <span class="stringliteral">&quot;describing&quot;</span>, NULL };
<a name="l05488"></a>05488 
<a name="l05489"></a>05489    <span class="keywordflow">switch</span> (cmd) {
<a name="l05490"></a>05490    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l05491"></a>05491       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show applications [like|describing]&quot;</span>;
<a name="l05492"></a>05492       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l05493"></a>05493          <span class="stringliteral">&quot;Usage: core show applications [{like|describing} &lt;text&gt;]\n&quot;</span>
<a name="l05494"></a>05494          <span class="stringliteral">&quot;       List applications which are currently available.\n&quot;</span>
<a name="l05495"></a>05495          <span class="stringliteral">&quot;       If &apos;like&apos;, &lt;text&gt; will be a substring of the app name\n&quot;</span>
<a name="l05496"></a>05496          <span class="stringliteral">&quot;       If &apos;describing&apos;, &lt;text&gt; will be a substring of the description\n&quot;</span>;
<a name="l05497"></a>05497       <span class="keywordflow">return</span> NULL;
<a name="l05498"></a>05498    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l05499"></a>05499       <span class="keywordflow">return</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> != 3) ? NULL : <a class="code" href="cli_8h.html#a7d198ac45b2d75bb30eb773582caf89f">ast_cli_complete</a>(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, choices, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l05500"></a>05500    }
<a name="l05501"></a>05501 
<a name="l05502"></a>05502    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l05503"></a>05503 
<a name="l05504"></a>05504    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a0044f6572f50a89049b3b5272e51b0e7">AST_RWLIST_EMPTY</a>(&amp;<a class="code" href="structapps.html">apps</a>)) {
<a name="l05505"></a>05505       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There are no registered applications\n&quot;</span>);
<a name="l05506"></a>05506       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l05507"></a>05507       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l05508"></a>05508    }
<a name="l05509"></a>05509 
<a name="l05510"></a>05510    <span class="comment">/* core list applications like &lt;keyword&gt; */</span>
<a name="l05511"></a>05511    <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 5) &amp;&amp; (!strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;like&quot;</span>))) {
<a name="l05512"></a>05512       like = 1;
<a name="l05513"></a>05513    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 4) &amp;&amp; (!strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;describing&quot;</span>))) {
<a name="l05514"></a>05514       describing = 1;
<a name="l05515"></a>05515    }
<a name="l05516"></a>05516 
<a name="l05517"></a>05517    <span class="comment">/* core list applications describing &lt;keyword1&gt; [&lt;keyword2&gt;] [...] */</span>
<a name="l05518"></a>05518    <span class="keywordflow">if</span> ((!like) &amp;&amp; (!describing)) {
<a name="l05519"></a>05519       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;    -= Registered Asterisk Applications =-\n&quot;</span>);
<a name="l05520"></a>05520    } <span class="keywordflow">else</span> {
<a name="l05521"></a>05521       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;    -= Matching Asterisk Applications =-\n&quot;</span>);
<a name="l05522"></a>05522    }
<a name="l05523"></a>05523 
<a name="l05524"></a>05524    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structapps.html">apps</a>, aa, list) {
<a name="l05525"></a>05525       <span class="keywordtype">int</span> printapp = 0;
<a name="l05526"></a>05526       total_apps++;
<a name="l05527"></a>05527       <span class="keywordflow">if</span> (like) {
<a name="l05528"></a>05528          <span class="keywordflow">if</span> (<a class="code" href="agi_2strcompat_8c.html#ae9229017a4501f8d6a637b4498cfed2e">strcasestr</a>(aa-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4])) {
<a name="l05529"></a>05529             printapp = 1;
<a name="l05530"></a>05530             total_match++;
<a name="l05531"></a>05531          }
<a name="l05532"></a>05532       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (describing) {
<a name="l05533"></a>05533          <span class="keywordflow">if</span> (aa-&gt;<a class="code" href="structast__app.html#a76f76ee5f847833b202461d55b23c17a">description</a>) {
<a name="l05534"></a>05534             <span class="comment">/* Match all words on command line */</span>
<a name="l05535"></a>05535             <span class="keywordtype">int</span> i;
<a name="l05536"></a>05536             printapp = 1;
<a name="l05537"></a>05537             <span class="keywordflow">for</span> (i = 4; i &lt; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>; i++) {
<a name="l05538"></a>05538                <span class="keywordflow">if</span> (!<a class="code" href="agi_2strcompat_8c.html#ae9229017a4501f8d6a637b4498cfed2e">strcasestr</a>(aa-&gt;<a class="code" href="structast__app.html#a76f76ee5f847833b202461d55b23c17a">description</a>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[i])) {
<a name="l05539"></a>05539                   printapp = 0;
<a name="l05540"></a>05540                } <span class="keywordflow">else</span> {
<a name="l05541"></a>05541                   total_match++;
<a name="l05542"></a>05542                }
<a name="l05543"></a>05543             }
<a name="l05544"></a>05544          }
<a name="l05545"></a>05545       } <span class="keywordflow">else</span> {
<a name="l05546"></a>05546          printapp = 1;
<a name="l05547"></a>05547       }
<a name="l05548"></a>05548 
<a name="l05549"></a>05549       <span class="keywordflow">if</span> (printapp) {
<a name="l05550"></a>05550          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;  %20s: %s\n&quot;</span>, aa-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, aa-&gt;<a class="code" href="structast__app.html#aa403beb670a3277f542647cc9aa22137">synopsis</a> ? aa-&gt;<a class="code" href="structast__app.html#aa403beb670a3277f542647cc9aa22137">synopsis</a> : <span class="stringliteral">&quot;&lt;Synopsis not available&gt;&quot;</span>);
<a name="l05551"></a>05551       }
<a name="l05552"></a>05552    }
<a name="l05553"></a>05553    <span class="keywordflow">if</span> ((!like) &amp;&amp; (!describing)) {
<a name="l05554"></a>05554       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;    -= %d Applications Registered =-\n&quot;</span>,total_apps);
<a name="l05555"></a>05555    } <span class="keywordflow">else</span> {
<a name="l05556"></a>05556       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;    -= %d Applications Matching =-\n&quot;</span>,total_match);
<a name="l05557"></a>05557    }
<a name="l05558"></a>05558 
<a name="l05559"></a>05559    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l05560"></a>05560 
<a name="l05561"></a>05561    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l05562"></a>05562 }
<a name="l05563"></a>05563 
<a name="l05564"></a>05564 <span class="comment">/*</span>
<a name="l05565"></a>05565 <span class="comment"> * &apos;show dialplan&apos; CLI command implementation functions ...</span>
<a name="l05566"></a>05566 <span class="comment"> */</span>
<a name="l05567"></a><a class="code" href="pbx_8c.html#a10a361ce7021a2921db6c07fad34b0cf">05567</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a10a361ce7021a2921db6c07fad34b0cf">complete_show_dialplan_context</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> pos,
<a name="l05568"></a>05568    <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l05569"></a>05569 {
<a name="l05570"></a>05570    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = NULL;
<a name="l05571"></a>05571    <span class="keywordtype">char</span> *ret = NULL;
<a name="l05572"></a>05572    <span class="keywordtype">int</span> which = 0;
<a name="l05573"></a>05573    <span class="keywordtype">int</span> wordlen;
<a name="l05574"></a>05574 
<a name="l05575"></a>05575    <span class="comment">/* we are do completion of [exten@]context on second position only */</span>
<a name="l05576"></a>05576    <span class="keywordflow">if</span> (pos != 2)
<a name="l05577"></a>05577       <span class="keywordflow">return</span> NULL;
<a name="l05578"></a>05578 
<a name="l05579"></a>05579    <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l05580"></a>05580 
<a name="l05581"></a>05581    wordlen = strlen(word);
<a name="l05582"></a>05582 
<a name="l05583"></a>05583    <span class="comment">/* walk through all contexts and return the n-th match */</span>
<a name="l05584"></a>05584    <span class="keywordflow">while</span> ( (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)) ) {
<a name="l05585"></a>05585       <span class="keywordflow">if</span> (!strncasecmp(word, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), wordlen) &amp;&amp; ++which &gt; state) {
<a name="l05586"></a>05586          ret = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c));
<a name="l05587"></a>05587          <span class="keywordflow">break</span>;
<a name="l05588"></a>05588       }
<a name="l05589"></a>05589    }
<a name="l05590"></a>05590 
<a name="l05591"></a>05591    <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l05592"></a>05592 
<a name="l05593"></a>05593    <span class="keywordflow">return</span> ret;
<a name="l05594"></a>05594 }
<a name="l05595"></a>05595 <span class="comment"></span>
<a name="l05596"></a>05596 <span class="comment">/*! \brief Counters for the show dialplan manager command */</span>
<a name="l05597"></a><a class="code" href="structdialplan__counters.html">05597</a> <span class="keyword">struct </span><a class="code" href="structdialplan__counters.html" title="Counters for the show dialplan manager command.">dialplan_counters</a> {
<a name="l05598"></a><a class="code" href="structdialplan__counters.html#a0446d0ce125ccdc21db9b3007292115c">05598</a>    <span class="keywordtype">int</span> total_items;
<a name="l05599"></a><a class="code" href="structdialplan__counters.html#a3e221cee3977709c69000542b0e8253b">05599</a>    <span class="keywordtype">int</span> total_context;
<a name="l05600"></a><a class="code" href="structdialplan__counters.html#a8a1205d5763afe73383c436bf789451b">05600</a>    <span class="keywordtype">int</span> total_exten;
<a name="l05601"></a><a class="code" href="structdialplan__counters.html#ad20b944aba8713eac8e63cf3eba770b9">05601</a>    <span class="keywordtype">int</span> total_prio;
<a name="l05602"></a><a class="code" href="structdialplan__counters.html#a3f947ad80dce92dd50952d6633061166">05602</a>    <span class="keywordtype">int</span> context_existence;
<a name="l05603"></a><a class="code" href="structdialplan__counters.html#ad4ee98222efd50240dfd8e745a46b38e">05603</a>    <span class="keywordtype">int</span> extension_existence;
<a name="l05604"></a>05604 };
<a name="l05605"></a>05605 <span class="comment"></span>
<a name="l05606"></a>05606 <span class="comment">/*! \brief helper function to print an extension */</span>
<a name="l05607"></a><a class="code" href="pbx_8c.html#a95e73ba35332c4ae9accb2ca3329ea41">05607</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a95e73ba35332c4ae9accb2ca3329ea41" title="helper function to print an extension">print_ext</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e, <span class="keywordtype">char</span> * <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> buflen)
<a name="l05608"></a>05608 {
<a name="l05609"></a>05609    <span class="keywordtype">int</span> prio = <a class="code" href="pbx_8h.html#a1662981db35d4125afaf6de98b2ba52f">ast_get_extension_priority</a>(e);
<a name="l05610"></a>05610    <span class="keywordflow">if</span> (prio == <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>) {
<a name="l05611"></a>05611       snprintf(buf, buflen, <span class="stringliteral">&quot;hint: %s&quot;</span>,
<a name="l05612"></a>05612          <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(e));
<a name="l05613"></a>05613    } <span class="keywordflow">else</span> {
<a name="l05614"></a>05614       snprintf(buf, buflen, <span class="stringliteral">&quot;%d. %s(%s)&quot;</span>,
<a name="l05615"></a>05615          prio, <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(e),
<a name="l05616"></a>05616          (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="pbx_8h.html#ac0a6c0c39796f36864868365d8989f02">ast_get_extension_app_data</a>(e)) ? (<span class="keywordtype">char</span> *)<a class="code" href="pbx_8h.html#ac0a6c0c39796f36864868365d8989f02">ast_get_extension_app_data</a>(e) : <span class="stringliteral">&quot;&quot;</span>));
<a name="l05617"></a>05617    }
<a name="l05618"></a>05618 }
<a name="l05619"></a>05619 
<a name="l05620"></a>05620 <span class="comment">/* XXX not verified */</span>
<a name="l05621"></a><a class="code" href="pbx_8c.html#ad4834904a3720903687da7be4e20f37d">05621</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#ad4834904a3720903687da7be4e20f37d">show_dialplan_helper</a>(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keyword">struct</span> <a class="code" href="structdialplan__counters.html" title="Counters for the show dialplan manager command.">dialplan_counters</a> *dpc, <span class="keyword">struct</span> <a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *rinclude, <span class="keywordtype">int</span> includecount, <span class="keyword">const</span> <span class="keywordtype">char</span> *includes[])
<a name="l05622"></a>05622 {
<a name="l05623"></a>05623    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = NULL;
<a name="l05624"></a>05624    <span class="keywordtype">int</span> res = 0, old_total_exten = dpc-&gt;<a class="code" href="structdialplan__counters.html#a8a1205d5763afe73383c436bf789451b">total_exten</a>;
<a name="l05625"></a>05625 
<a name="l05626"></a>05626    <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l05627"></a>05627 
<a name="l05628"></a>05628    <span class="comment">/* walk all contexts ... */</span>
<a name="l05629"></a>05629    <span class="keywordflow">while</span> ( (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)) ) {
<a name="l05630"></a>05630       <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e;
<a name="l05631"></a>05631       <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *i;
<a name="l05632"></a>05632       <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ip;
<a name="l05633"></a>05633       <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256], buf2[256];
<a name="l05634"></a>05634       <span class="keywordtype">int</span> context_info_printed = 0;
<a name="l05635"></a>05635 
<a name="l05636"></a>05636       <span class="keywordflow">if</span> (context &amp;&amp; strcmp(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), context))
<a name="l05637"></a>05637          <span class="keywordflow">continue</span>;   <span class="comment">/* skip this one, name doesn&apos;t match */</span>
<a name="l05638"></a>05638 
<a name="l05639"></a>05639       dpc-&gt;<a class="code" href="structdialplan__counters.html#a3f947ad80dce92dd50952d6633061166">context_existence</a> = 1;
<a name="l05640"></a>05640 
<a name="l05641"></a>05641       <a class="code" href="pbx_8h.html#af1a624244a07626a8f70843005206c95" title="Read locks a given context.">ast_rdlock_context</a>(c);
<a name="l05642"></a>05642 
<a name="l05643"></a>05643       <span class="comment">/* are we looking for exten too? if yes, we print context</span>
<a name="l05644"></a>05644 <span class="comment">       * only if we find our extension.</span>
<a name="l05645"></a>05645 <span class="comment">       * Otherwise print context even if empty ?</span>
<a name="l05646"></a>05646 <span class="comment">       * XXX i am not sure how the rinclude is handled.</span>
<a name="l05647"></a>05647 <span class="comment">       * I think it ought to go inside.</span>
<a name="l05648"></a>05648 <span class="comment">       */</span>
<a name="l05649"></a>05649       <span class="keywordflow">if</span> (!exten) {
<a name="l05650"></a>05650          dpc-&gt;<a class="code" href="structdialplan__counters.html#a3e221cee3977709c69000542b0e8253b">total_context</a>++;
<a name="l05651"></a>05651          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;[ Context &apos;%s&apos; created by &apos;%s&apos; ]\n&quot;</span>,
<a name="l05652"></a>05652             <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), <a class="code" href="pbx_8h.html#a9df0a5d301454fe924172cf89c7165a4">ast_get_context_registrar</a>(c));
<a name="l05653"></a>05653          context_info_printed = 1;
<a name="l05654"></a>05654       }
<a name="l05655"></a>05655 
<a name="l05656"></a>05656       <span class="comment">/* walk extensions ... */</span>
<a name="l05657"></a>05657       e = NULL;
<a name="l05658"></a>05658       <span class="keywordflow">while</span> ( (e = <a class="code" href="pbx_8h.html#aa63685577f3479dcf31a9e77b2ff05a7">ast_walk_context_extensions</a>(c, e)) ) {
<a name="l05659"></a>05659          <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *p;
<a name="l05660"></a>05660 
<a name="l05661"></a>05661          <span class="keywordflow">if</span> (exten &amp;&amp; !<a class="code" href="pbx_8h.html#a94cf2f099462a906620b5566871af797" title="Determine if a given extension matches a given pattern (in NXX format).">ast_extension_match</a>(<a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e), exten))
<a name="l05662"></a>05662             <span class="keywordflow">continue</span>;   <span class="comment">/* skip, extension match failed */</span>
<a name="l05663"></a>05663 
<a name="l05664"></a>05664          dpc-&gt;<a class="code" href="structdialplan__counters.html#ad4ee98222efd50240dfd8e745a46b38e">extension_existence</a> = 1;
<a name="l05665"></a>05665 
<a name="l05666"></a>05666          <span class="comment">/* may we print context info? */</span>
<a name="l05667"></a>05667          <span class="keywordflow">if</span> (!context_info_printed) {
<a name="l05668"></a>05668             dpc-&gt;<a class="code" href="structdialplan__counters.html#a3e221cee3977709c69000542b0e8253b">total_context</a>++;
<a name="l05669"></a>05669             <span class="keywordflow">if</span> (rinclude) { <span class="comment">/* TODO Print more info about rinclude */</span>
<a name="l05670"></a>05670                <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;[ Included context &apos;%s&apos; created by &apos;%s&apos; ]\n&quot;</span>,
<a name="l05671"></a>05671                   <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), <a class="code" href="pbx_8h.html#a9df0a5d301454fe924172cf89c7165a4">ast_get_context_registrar</a>(c));
<a name="l05672"></a>05672             } <span class="keywordflow">else</span> {
<a name="l05673"></a>05673                <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;[ Context &apos;%s&apos; created by &apos;%s&apos; ]\n&quot;</span>,
<a name="l05674"></a>05674                   <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), <a class="code" href="pbx_8h.html#a9df0a5d301454fe924172cf89c7165a4">ast_get_context_registrar</a>(c));
<a name="l05675"></a>05675             }
<a name="l05676"></a>05676             context_info_printed = 1;
<a name="l05677"></a>05677          }
<a name="l05678"></a>05678          dpc-&gt;<a class="code" href="structdialplan__counters.html#ad20b944aba8713eac8e63cf3eba770b9">total_prio</a>++;
<a name="l05679"></a>05679 
<a name="l05680"></a>05680          <span class="comment">/* write extension name and first peer */</span>
<a name="l05681"></a>05681          <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a>)
<a name="l05682"></a>05682             snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;&apos;%s&apos; (CID match &apos;%s&apos;) =&gt; &quot;</span>, <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e), e-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>);
<a name="l05683"></a>05683          <span class="keywordflow">else</span>
<a name="l05684"></a>05684             snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;&apos;%s&apos; =&gt;&quot;</span>, <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e));
<a name="l05685"></a>05685 
<a name="l05686"></a>05686          <a class="code" href="pbx_8c.html#a95e73ba35332c4ae9accb2ca3329ea41" title="helper function to print an extension">print_ext</a>(e, buf2, <span class="keyword">sizeof</span>(buf2));
<a name="l05687"></a>05687 
<a name="l05688"></a>05688          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;  %-17s %-45s [%s]\n&quot;</span>, buf, buf2,
<a name="l05689"></a>05689             <a class="code" href="pbx_8h.html#a7f23f7c798d61e68c32b21d3e0cd15a2">ast_get_extension_registrar</a>(e));
<a name="l05690"></a>05690 
<a name="l05691"></a>05691          dpc-&gt;<a class="code" href="structdialplan__counters.html#a8a1205d5763afe73383c436bf789451b">total_exten</a>++;
<a name="l05692"></a>05692          <span class="comment">/* walk next extension peers */</span>
<a name="l05693"></a>05693          p = e;   <span class="comment">/* skip the first one, we already got it */</span>
<a name="l05694"></a>05694          <span class="keywordflow">while</span> ( (p = <a class="code" href="pbx_8h.html#a6772ce6e8de86d4b6c382dbf68ea4755">ast_walk_extension_priorities</a>(e, p)) ) {
<a name="l05695"></a>05695             <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a> = <a class="code" href="pbx_8h.html#a266960fe6aa4db1066ed0b012fb7eb62">ast_get_extension_label</a>(p);
<a name="l05696"></a>05696             dpc-&gt;<a class="code" href="structdialplan__counters.html#ad20b944aba8713eac8e63cf3eba770b9">total_prio</a>++;
<a name="l05697"></a>05697             <span class="keywordflow">if</span> (el)
<a name="l05698"></a>05698                snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;   [%s]&quot;</span>, el);
<a name="l05699"></a>05699             <span class="keywordflow">else</span>
<a name="l05700"></a>05700                buf[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05701"></a>05701             <a class="code" href="pbx_8c.html#a95e73ba35332c4ae9accb2ca3329ea41" title="helper function to print an extension">print_ext</a>(p, buf2, <span class="keyword">sizeof</span>(buf2));
<a name="l05702"></a>05702 
<a name="l05703"></a>05703             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,<span class="stringliteral">&quot;  %-17s %-45s [%s]\n&quot;</span>, buf, buf2,
<a name="l05704"></a>05704                <a class="code" href="pbx_8h.html#a7f23f7c798d61e68c32b21d3e0cd15a2">ast_get_extension_registrar</a>(p));
<a name="l05705"></a>05705          }
<a name="l05706"></a>05706       }
<a name="l05707"></a>05707 
<a name="l05708"></a>05708       <span class="comment">/* walk included and write info ... */</span>
<a name="l05709"></a>05709       i = NULL;
<a name="l05710"></a>05710       <span class="keywordflow">while</span> ( (i = <a class="code" href="pbx_8h.html#a142de6e0271ada6b306f2f7420a3fd77">ast_walk_context_includes</a>(c, i)) ) {
<a name="l05711"></a>05711          snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;&apos;%s&apos;&quot;</span>, <a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(i));
<a name="l05712"></a>05712          <span class="keywordflow">if</span> (exten) {
<a name="l05713"></a>05713             <span class="comment">/* Check all includes for the requested extension */</span>
<a name="l05714"></a>05714             <span class="keywordflow">if</span> (includecount &gt;= <a class="code" href="extconf_8h.html#a05848c0de74d85dc2fb259f332d33f25">AST_PBX_MAX_STACK</a>) {
<a name="l05715"></a>05715                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum include depth exceeded!\n&quot;</span>);
<a name="l05716"></a>05716             } <span class="keywordflow">else</span> {
<a name="l05717"></a>05717                <span class="keywordtype">int</span> dupe = 0;
<a name="l05718"></a>05718                <span class="keywordtype">int</span> x;
<a name="l05719"></a>05719                <span class="keywordflow">for</span> (x = 0; x &lt; includecount; x++) {
<a name="l05720"></a>05720                   <span class="keywordflow">if</span> (!strcasecmp(includes[x], <a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(i))) {
<a name="l05721"></a>05721                      dupe++;
<a name="l05722"></a>05722                      <span class="keywordflow">break</span>;
<a name="l05723"></a>05723                   }
<a name="l05724"></a>05724                }
<a name="l05725"></a>05725                <span class="keywordflow">if</span> (!dupe) {
<a name="l05726"></a>05726                   includes[includecount] = <a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(i);
<a name="l05727"></a>05727                   <a class="code" href="pbx_8c.html#ad4834904a3720903687da7be4e20f37d">show_dialplan_helper</a>(fd, <a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(i), exten, dpc, i, includecount + 1, includes);
<a name="l05728"></a>05728                } <span class="keywordflow">else</span> {
<a name="l05729"></a>05729                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Avoiding circular include of %s within %s\n&quot;</span>, <a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(i), context);
<a name="l05730"></a>05730                }
<a name="l05731"></a>05731             }
<a name="l05732"></a>05732          } <span class="keywordflow">else</span> {
<a name="l05733"></a>05733             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;  Include =&gt;        %-45s [%s]\n&quot;</span>,
<a name="l05734"></a>05734                buf, <a class="code" href="pbx_8h.html#a7a9aa5cd362edc7d593196f57686c2b9">ast_get_include_registrar</a>(i));
<a name="l05735"></a>05735          }
<a name="l05736"></a>05736       }
<a name="l05737"></a>05737 
<a name="l05738"></a>05738       <span class="comment">/* walk ignore patterns and write info ... */</span>
<a name="l05739"></a>05739       ip = NULL;
<a name="l05740"></a>05740       <span class="keywordflow">while</span> ( (ip = <a class="code" href="pbx_8h.html#a0e9dbe4e0003f65b67c78979f2fbfa8e">ast_walk_context_ignorepats</a>(c, ip)) ) {
<a name="l05741"></a>05741          <span class="keyword">const</span> <span class="keywordtype">char</span> *ipname = <a class="code" href="pbx_8h.html#a0c324514fc22df9cc5b32ceb68006e79">ast_get_ignorepat_name</a>(ip);
<a name="l05742"></a>05742          <span class="keywordtype">char</span> ignorepat[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l05743"></a>05743          snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;&apos;%s&apos;&quot;</span>, ipname);
<a name="l05744"></a>05744          snprintf(ignorepat, <span class="keyword">sizeof</span>(ignorepat), <span class="stringliteral">&quot;_%s.&quot;</span>, ipname);
<a name="l05745"></a>05745          <span class="keywordflow">if</span> (!exten || <a class="code" href="pbx_8h.html#a94cf2f099462a906620b5566871af797" title="Determine if a given extension matches a given pattern (in NXX format).">ast_extension_match</a>(ignorepat, exten)) {
<a name="l05746"></a>05746             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;  Ignore pattern =&gt; %-45s [%s]\n&quot;</span>,
<a name="l05747"></a>05747                buf, <a class="code" href="pbx_8h.html#a1a219215514e9ed08ff67cc02c2dd1d3">ast_get_ignorepat_registrar</a>(ip));
<a name="l05748"></a>05748          }
<a name="l05749"></a>05749       }
<a name="l05750"></a>05750       <span class="keywordflow">if</span> (!rinclude) {
<a name="l05751"></a>05751          <span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *sw = NULL;
<a name="l05752"></a>05752          <span class="keywordflow">while</span> ( (sw = <a class="code" href="pbx_8h.html#a64653e3c5cdfab48075b4001bd74655d">ast_walk_context_switches</a>(c, sw)) ) {
<a name="l05753"></a>05753             snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;&apos;%s/%s&apos;&quot;</span>,
<a name="l05754"></a>05754                <a class="code" href="pbx_8h.html#a87693eca302936ade0be97cab21e4f56">ast_get_switch_name</a>(sw),
<a name="l05755"></a>05755                <a class="code" href="pbx_8h.html#accdca3b300f8f1ff523872bd3a129adc">ast_get_switch_data</a>(sw));
<a name="l05756"></a>05756             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;  Alt. Switch =&gt;    %-45s [%s]\n&quot;</span>,
<a name="l05757"></a>05757                buf, <a class="code" href="pbx_8h.html#a1361d2a84278cee910c8ca0c7964c84c">ast_get_switch_registrar</a>(sw));
<a name="l05758"></a>05758          }
<a name="l05759"></a>05759       }
<a name="l05760"></a>05760 
<a name="l05761"></a>05761       <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(c);
<a name="l05762"></a>05762 
<a name="l05763"></a>05763       <span class="comment">/* if we print something in context, make an empty line */</span>
<a name="l05764"></a>05764       <span class="keywordflow">if</span> (context_info_printed)
<a name="l05765"></a>05765          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l05766"></a>05766    }
<a name="l05767"></a>05767    <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l05768"></a>05768 
<a name="l05769"></a>05769    <span class="keywordflow">return</span> (dpc-&gt;<a class="code" href="structdialplan__counters.html#a8a1205d5763afe73383c436bf789451b">total_exten</a> == old_total_exten) ? -1 : res;
<a name="l05770"></a>05770 }
<a name="l05771"></a>05771 
<a name="l05772"></a><a class="code" href="pbx_8c.html#a9ccbd387b4acc01572f585c55633c417">05772</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a9ccbd387b4acc01572f585c55633c417">show_debug_helper</a>(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keyword">struct</span> <a class="code" href="structdialplan__counters.html" title="Counters for the show dialplan manager command.">dialplan_counters</a> *dpc, <span class="keyword">struct</span> <a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *rinclude, <span class="keywordtype">int</span> includecount, <span class="keyword">const</span> <span class="keywordtype">char</span> *includes[])
<a name="l05773"></a>05773 {
<a name="l05774"></a>05774    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = NULL;
<a name="l05775"></a>05775    <span class="keywordtype">int</span> res = 0, old_total_exten = dpc-&gt;<a class="code" href="structdialplan__counters.html#a8a1205d5763afe73383c436bf789451b">total_exten</a>;
<a name="l05776"></a>05776 
<a name="l05777"></a>05777    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,<span class="stringliteral">&quot;\n     In-mem exten Trie for Fast Extension Pattern Matching:\n\n&quot;</span>);
<a name="l05778"></a>05778 
<a name="l05779"></a>05779    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,<span class="stringliteral">&quot;\n           Explanation: Node Contents Format = &lt;char(s) to match&gt;:&lt;pattern?&gt;:&lt;specif&gt;:[matched extension]\n&quot;</span>);
<a name="l05780"></a>05780    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,    <span class="stringliteral">&quot;                        Where &lt;char(s) to match&gt; is a set of chars, any one of which should match the current character\n&quot;</span>);
<a name="l05781"></a>05781    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,    <span class="stringliteral">&quot;                              &lt;pattern?&gt;: Y if this a pattern match (eg. _XZN[5-7]), N otherwise\n&quot;</span>);
<a name="l05782"></a>05782    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,    <span class="stringliteral">&quot;                              &lt;specif&gt;: an assigned &apos;exactness&apos; number for this matching char. The lower the number, the more exact the match\n&quot;</span>);
<a name="l05783"></a>05783    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,    <span class="stringliteral">&quot;                              [matched exten]: If all chars matched to this point, which extension this matches. In form: EXTEN:&lt;exten string&gt;\n&quot;</span>);
<a name="l05784"></a>05784    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,    <span class="stringliteral">&quot;                        In general, you match a trie node to a string character, from left to right. All possible matching chars\n&quot;</span>);
<a name="l05785"></a>05785    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,    <span class="stringliteral">&quot;                        are in a string vertically, separated by an unbroken string of &apos;+&apos; characters.\n\n&quot;</span>);
<a name="l05786"></a>05786    <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l05787"></a>05787 
<a name="l05788"></a>05788    <span class="comment">/* walk all contexts ... */</span>
<a name="l05789"></a>05789    <span class="keywordflow">while</span> ( (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)) ) {
<a name="l05790"></a>05790       <span class="keywordtype">int</span> context_info_printed = 0;
<a name="l05791"></a>05791 
<a name="l05792"></a>05792       <span class="keywordflow">if</span> (context &amp;&amp; strcmp(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), context))
<a name="l05793"></a>05793          <span class="keywordflow">continue</span>;   <span class="comment">/* skip this one, name doesn&apos;t match */</span>
<a name="l05794"></a>05794 
<a name="l05795"></a>05795       dpc-&gt;<a class="code" href="structdialplan__counters.html#a3f947ad80dce92dd50952d6633061166">context_existence</a> = 1;
<a name="l05796"></a>05796 
<a name="l05797"></a>05797       <span class="keywordflow">if</span> (!c-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>)
<a name="l05798"></a>05798          <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(NULL, c-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, <span class="stringliteral">&quot;s&quot;</span>, 1, <span class="stringliteral">&quot;&quot;</span>); <span class="comment">/* do this to force the trie to built, if it is not already */</span>
<a name="l05799"></a>05799 
<a name="l05800"></a>05800       <a class="code" href="pbx_8h.html#af1a624244a07626a8f70843005206c95" title="Read locks a given context.">ast_rdlock_context</a>(c);
<a name="l05801"></a>05801 
<a name="l05802"></a>05802       dpc-&gt;<a class="code" href="structdialplan__counters.html#a3e221cee3977709c69000542b0e8253b">total_context</a>++;
<a name="l05803"></a>05803       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;[ Context &apos;%s&apos; created by &apos;%s&apos; ]\n&quot;</span>,
<a name="l05804"></a>05804          <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), <a class="code" href="pbx_8h.html#a9df0a5d301454fe924172cf89c7165a4">ast_get_context_registrar</a>(c));
<a name="l05805"></a>05805       context_info_printed = 1;
<a name="l05806"></a>05806 
<a name="l05807"></a>05807       <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>)
<a name="l05808"></a>05808       {
<a name="l05809"></a>05809          <a class="code" href="pbx_8c.html#a36264871dfb05b0e331f7a6f19049ab6">cli_match_char_tree</a>(c-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>, <span class="stringliteral">&quot; &quot;</span>, fd);
<a name="l05810"></a>05810       } <span class="keywordflow">else</span> {
<a name="l05811"></a>05811          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,<span class="stringliteral">&quot;\n     No Pattern Trie present. Perhaps the context is empty...or there is trouble...\n\n&quot;</span>);
<a name="l05812"></a>05812       }
<a name="l05813"></a>05813 
<a name="l05814"></a>05814       <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(c);
<a name="l05815"></a>05815 
<a name="l05816"></a>05816       <span class="comment">/* if we print something in context, make an empty line */</span>
<a name="l05817"></a>05817       <span class="keywordflow">if</span> (context_info_printed)
<a name="l05818"></a>05818          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l05819"></a>05819    }
<a name="l05820"></a>05820    <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l05821"></a>05821 
<a name="l05822"></a>05822    <span class="keywordflow">return</span> (dpc-&gt;<a class="code" href="structdialplan__counters.html#a8a1205d5763afe73383c436bf789451b">total_exten</a> == old_total_exten) ? -1 : res;
<a name="l05823"></a>05823 }
<a name="l05824"></a>05824 
<a name="l05825"></a><a class="code" href="pbx_8c.html#acf5505fa44483212103cce849e530e1c">05825</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#acf5505fa44483212103cce849e530e1c">handle_show_dialplan</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l05826"></a>05826 {
<a name="l05827"></a>05827    <span class="keywordtype">char</span> *exten = NULL, *context = NULL;
<a name="l05828"></a>05828    <span class="comment">/* Variables used for different counters */</span>
<a name="l05829"></a>05829    <span class="keyword">struct </span><a class="code" href="structdialplan__counters.html" title="Counters for the show dialplan manager command.">dialplan_counters</a> counters;
<a name="l05830"></a>05830    <span class="keyword">const</span> <span class="keywordtype">char</span> *incstack[<a class="code" href="extconf_8h.html#a05848c0de74d85dc2fb259f332d33f25">AST_PBX_MAX_STACK</a>];
<a name="l05831"></a>05831 
<a name="l05832"></a>05832    <span class="keywordflow">switch</span> (cmd) {
<a name="l05833"></a>05833    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l05834"></a>05834       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan show&quot;</span>;
<a name="l05835"></a>05835       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l05836"></a>05836          <span class="stringliteral">&quot;Usage: dialplan show [[exten@]context]\n&quot;</span>
<a name="l05837"></a>05837          <span class="stringliteral">&quot;       Show dialplan\n&quot;</span>;
<a name="l05838"></a>05838       <span class="keywordflow">return</span> NULL;
<a name="l05839"></a>05839    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l05840"></a>05840       <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#a10a361ce7021a2921db6c07fad34b0cf">complete_show_dialplan_context</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l05841"></a>05841    }
<a name="l05842"></a>05842 
<a name="l05843"></a>05843    memset(&amp;counters, 0, <span class="keyword">sizeof</span>(counters));
<a name="l05844"></a>05844 
<a name="l05845"></a>05845    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 2 &amp;&amp; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l05846"></a>05846       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l05847"></a>05847 
<a name="l05848"></a>05848    <span class="comment">/* we obtain [exten@]context? if yes, split them ... */</span>
<a name="l05849"></a>05849    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3) {
<a name="l05850"></a>05850       <span class="keywordflow">if</span> (strchr(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], <span class="charliteral">&apos;@&apos;</span>)) {   <span class="comment">/* split into exten &amp; context */</span>
<a name="l05851"></a>05851          context = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);
<a name="l05852"></a>05852          exten = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;context, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l05853"></a>05853          <span class="comment">/* change empty strings to NULL */</span>
<a name="l05854"></a>05854          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(exten))
<a name="l05855"></a>05855             exten = NULL;
<a name="l05856"></a>05856       } <span class="keywordflow">else</span> { <span class="comment">/* no &apos;@&apos; char, only context given */</span>
<a name="l05857"></a>05857          context = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2];
<a name="l05858"></a>05858       }
<a name="l05859"></a>05859       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(context))
<a name="l05860"></a>05860          context = NULL;
<a name="l05861"></a>05861    }
<a name="l05862"></a>05862    <span class="comment">/* else Show complete dial plan, context and exten are NULL */</span>
<a name="l05863"></a>05863    <a class="code" href="pbx_8c.html#ad4834904a3720903687da7be4e20f37d">show_dialplan_helper</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, context, exten, &amp;counters, NULL, 0, incstack);
<a name="l05864"></a>05864 
<a name="l05865"></a>05865    <span class="comment">/* check for input failure and throw some error messages */</span>
<a name="l05866"></a>05866    <span class="keywordflow">if</span> (context &amp;&amp; !counters.<a class="code" href="structdialplan__counters.html#a3f947ad80dce92dd50952d6633061166">context_existence</a>) {
<a name="l05867"></a>05867       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There is no existence of &apos;%s&apos; context\n&quot;</span>, context);
<a name="l05868"></a>05868       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l05869"></a>05869    }
<a name="l05870"></a>05870 
<a name="l05871"></a>05871    <span class="keywordflow">if</span> (exten &amp;&amp; !counters.<a class="code" href="structdialplan__counters.html#ad4ee98222efd50240dfd8e745a46b38e">extension_existence</a>) {
<a name="l05872"></a>05872       <span class="keywordflow">if</span> (context)
<a name="l05873"></a>05873          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There is no existence of %s@%s extension\n&quot;</span>,
<a name="l05874"></a>05874             exten, context);
<a name="l05875"></a>05875       <span class="keywordflow">else</span>
<a name="l05876"></a>05876          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,
<a name="l05877"></a>05877             <span class="stringliteral">&quot;There is no existence of &apos;%s&apos; extension in all contexts\n&quot;</span>,
<a name="l05878"></a>05878             exten);
<a name="l05879"></a>05879       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l05880"></a>05880    }
<a name="l05881"></a>05881 
<a name="l05882"></a>05882    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;-= %d %s (%d %s) in %d %s. =-\n&quot;</span>,
<a name="l05883"></a>05883             counters.<a class="code" href="structdialplan__counters.html#a8a1205d5763afe73383c436bf789451b">total_exten</a>, counters.<a class="code" href="structdialplan__counters.html#a8a1205d5763afe73383c436bf789451b">total_exten</a> == 1 ? <span class="stringliteral">&quot;extension&quot;</span> : <span class="stringliteral">&quot;extensions&quot;</span>,
<a name="l05884"></a>05884             counters.<a class="code" href="structdialplan__counters.html#ad20b944aba8713eac8e63cf3eba770b9">total_prio</a>, counters.<a class="code" href="structdialplan__counters.html#ad20b944aba8713eac8e63cf3eba770b9">total_prio</a> == 1 ? <span class="stringliteral">&quot;priority&quot;</span> : <span class="stringliteral">&quot;priorities&quot;</span>,
<a name="l05885"></a>05885             counters.<a class="code" href="structdialplan__counters.html#a3e221cee3977709c69000542b0e8253b">total_context</a>, counters.<a class="code" href="structdialplan__counters.html#a3e221cee3977709c69000542b0e8253b">total_context</a> == 1 ? <span class="stringliteral">&quot;context&quot;</span> : <span class="stringliteral">&quot;contexts&quot;</span>);
<a name="l05886"></a>05886 
<a name="l05887"></a>05887    <span class="comment">/* everything ok */</span>
<a name="l05888"></a>05888    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l05889"></a>05889 }
<a name="l05890"></a>05890 <span class="comment"></span>
<a name="l05891"></a>05891 <span class="comment">/*! \brief Send ack once */</span>
<a name="l05892"></a><a class="code" href="pbx_8c.html#a69b3642bb638524be829a44a1b1219db">05892</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a69b3642bb638524be829a44a1b1219db" title="Send ack once.">handle_debug_dialplan</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l05893"></a>05893 {
<a name="l05894"></a>05894    <span class="keywordtype">char</span> *exten = NULL, *context = NULL;
<a name="l05895"></a>05895    <span class="comment">/* Variables used for different counters */</span>
<a name="l05896"></a>05896    <span class="keyword">struct </span><a class="code" href="structdialplan__counters.html" title="Counters for the show dialplan manager command.">dialplan_counters</a> counters;
<a name="l05897"></a>05897    <span class="keyword">const</span> <span class="keywordtype">char</span> *incstack[<a class="code" href="extconf_8h.html#a05848c0de74d85dc2fb259f332d33f25">AST_PBX_MAX_STACK</a>];
<a name="l05898"></a>05898 
<a name="l05899"></a>05899    <span class="keywordflow">switch</span> (cmd) {
<a name="l05900"></a>05900    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l05901"></a>05901       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan debug&quot;</span>;
<a name="l05902"></a>05902       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l05903"></a>05903          <span class="stringliteral">&quot;Usage: dialplan debug [context]\n&quot;</span>
<a name="l05904"></a>05904          <span class="stringliteral">&quot;       Show dialplan context Trie(s). Usually only useful to folks debugging the deep internals of the fast pattern matcher\n&quot;</span>;
<a name="l05905"></a>05905       <span class="keywordflow">return</span> NULL;
<a name="l05906"></a>05906    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l05907"></a>05907       <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#a10a361ce7021a2921db6c07fad34b0cf">complete_show_dialplan_context</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l05908"></a>05908    }
<a name="l05909"></a>05909 
<a name="l05910"></a>05910    memset(&amp;counters, 0, <span class="keyword">sizeof</span>(counters));
<a name="l05911"></a>05911 
<a name="l05912"></a>05912    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 2 &amp;&amp; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l05913"></a>05913       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l05914"></a>05914 
<a name="l05915"></a>05915    <span class="comment">/* we obtain [exten@]context? if yes, split them ... */</span>
<a name="l05916"></a>05916    <span class="comment">/* note: we ignore the exten totally here .... */</span>
<a name="l05917"></a>05917    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3) {
<a name="l05918"></a>05918       <span class="keywordflow">if</span> (strchr(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], <span class="charliteral">&apos;@&apos;</span>)) {   <span class="comment">/* split into exten &amp; context */</span>
<a name="l05919"></a>05919          context = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);
<a name="l05920"></a>05920          exten = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;context, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l05921"></a>05921          <span class="comment">/* change empty strings to NULL */</span>
<a name="l05922"></a>05922          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(exten))
<a name="l05923"></a>05923             exten = NULL;
<a name="l05924"></a>05924       } <span class="keywordflow">else</span> { <span class="comment">/* no &apos;@&apos; char, only context given */</span>
<a name="l05925"></a>05925          context = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2];
<a name="l05926"></a>05926       }
<a name="l05927"></a>05927       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(context))
<a name="l05928"></a>05928          context = NULL;
<a name="l05929"></a>05929    }
<a name="l05930"></a>05930    <span class="comment">/* else Show complete dial plan, context and exten are NULL */</span>
<a name="l05931"></a>05931    <a class="code" href="pbx_8c.html#a9ccbd387b4acc01572f585c55633c417">show_debug_helper</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, context, exten, &amp;counters, NULL, 0, incstack);
<a name="l05932"></a>05932 
<a name="l05933"></a>05933    <span class="comment">/* check for input failure and throw some error messages */</span>
<a name="l05934"></a>05934    <span class="keywordflow">if</span> (context &amp;&amp; !counters.<a class="code" href="structdialplan__counters.html#a3f947ad80dce92dd50952d6633061166">context_existence</a>) {
<a name="l05935"></a>05935       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There is no existence of &apos;%s&apos; context\n&quot;</span>, context);
<a name="l05936"></a>05936       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l05937"></a>05937    }
<a name="l05938"></a>05938 
<a name="l05939"></a>05939 
<a name="l05940"></a>05940    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;-= %d %s. =-\n&quot;</span>,
<a name="l05941"></a>05941          counters.<a class="code" href="structdialplan__counters.html#a3e221cee3977709c69000542b0e8253b">total_context</a>, counters.<a class="code" href="structdialplan__counters.html#a3e221cee3977709c69000542b0e8253b">total_context</a> == 1 ? <span class="stringliteral">&quot;context&quot;</span> : <span class="stringliteral">&quot;contexts&quot;</span>);
<a name="l05942"></a>05942 
<a name="l05943"></a>05943    <span class="comment">/* everything ok */</span>
<a name="l05944"></a>05944    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l05945"></a>05945 }
<a name="l05946"></a>05946 <span class="comment"></span>
<a name="l05947"></a>05947 <span class="comment">/*! \brief Send ack once */</span>
<a name="l05948"></a><a class="code" href="pbx_8c.html#a70046ced091cbd83caccdba9e719cbce">05948</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a70046ced091cbd83caccdba9e719cbce" title="Send ack once.">manager_dpsendack</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l05949"></a>05949 {
<a name="l05950"></a>05950    <a class="code" href="group__Group__AMI.html#ga0ee6ee1f4d200f711e2983bffe770a72" title="Send ack in manager list transaction.">astman_send_listack</a>(s, m, <span class="stringliteral">&quot;DialPlan list will follow&quot;</span>, <span class="stringliteral">&quot;start&quot;</span>);
<a name="l05951"></a>05951 }
<a name="l05952"></a>05952 <span class="comment"></span>
<a name="l05953"></a>05953 <span class="comment">/*! \brief Show dialplan extensions</span>
<a name="l05954"></a>05954 <span class="comment"> * XXX this function is similar but not exactly the same as the CLI&apos;s</span>
<a name="l05955"></a>05955 <span class="comment"> * show dialplan. Must check whether the difference is intentional or not.</span>
<a name="l05956"></a>05956 <span class="comment"> */</span>
<a name="l05957"></a><a class="code" href="pbx_8c.html#a039a90f8fc481843e3ec0a4a7ab14a74">05957</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a039a90f8fc481843e3ec0a4a7ab14a74" title="Show dialplan extensions XXX this function is similar but not exactly the same as...">manager_show_dialplan_helper</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m,
<a name="l05958"></a>05958                <span class="keyword">const</span> <span class="keywordtype">char</span> *actionidtext, <span class="keyword">const</span> <span class="keywordtype">char</span> *context,
<a name="l05959"></a>05959                <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keyword">struct</span> <a class="code" href="structdialplan__counters.html" title="Counters for the show dialplan manager command.">dialplan_counters</a> *dpc,
<a name="l05960"></a>05960                <span class="keyword">struct</span> <a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *rinclude)
<a name="l05961"></a>05961 {
<a name="l05962"></a>05962    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c;
<a name="l05963"></a>05963    <span class="keywordtype">int</span> res = 0, old_total_exten = dpc-&gt;<a class="code" href="structdialplan__counters.html#a8a1205d5763afe73383c436bf789451b">total_exten</a>;
<a name="l05964"></a>05964 
<a name="l05965"></a>05965    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(exten))
<a name="l05966"></a>05966       exten = NULL;
<a name="l05967"></a>05967    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(context))
<a name="l05968"></a>05968       context = NULL;
<a name="l05969"></a>05969 
<a name="l05970"></a>05970    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;manager_show_dialplan: Context: -%s- Extension: -%s-\n&quot;</span>, context, exten);
<a name="l05971"></a>05971 
<a name="l05972"></a>05972    <span class="comment">/* try to lock contexts */</span>
<a name="l05973"></a>05973    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l05974"></a>05974       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Failed to lock contexts&quot;</span>);
<a name="l05975"></a>05975       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to lock contexts list for manager: listdialplan\n&quot;</span>);
<a name="l05976"></a>05976       <span class="keywordflow">return</span> -1;
<a name="l05977"></a>05977    }
<a name="l05978"></a>05978 
<a name="l05979"></a>05979    c = NULL;      <span class="comment">/* walk all contexts ... */</span>
<a name="l05980"></a>05980    <span class="keywordflow">while</span> ( (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)) ) {
<a name="l05981"></a>05981       <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e;
<a name="l05982"></a>05982       <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *i;
<a name="l05983"></a>05983       <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ip;
<a name="l05984"></a>05984 
<a name="l05985"></a>05985       <span class="keywordflow">if</span> (context &amp;&amp; strcmp(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), context) != 0)
<a name="l05986"></a>05986          <span class="keywordflow">continue</span>;   <span class="comment">/* not the name we want */</span>
<a name="l05987"></a>05987 
<a name="l05988"></a>05988       dpc-&gt;<a class="code" href="structdialplan__counters.html#a3f947ad80dce92dd50952d6633061166">context_existence</a> = 1;
<a name="l05989"></a>05989 
<a name="l05990"></a>05990       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;manager_show_dialplan: Found Context: %s \n&quot;</span>, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c));
<a name="l05991"></a>05991 
<a name="l05992"></a>05992       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#af1a624244a07626a8f70843005206c95" title="Read locks a given context.">ast_rdlock_context</a>(c)) {  <span class="comment">/* failed to lock */</span>
<a name="l05993"></a>05993          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;manager_show_dialplan: Failed to lock context\n&quot;</span>);
<a name="l05994"></a>05994          <span class="keywordflow">continue</span>;
<a name="l05995"></a>05995       }
<a name="l05996"></a>05996 
<a name="l05997"></a>05997       <span class="comment">/* XXX note- an empty context is not printed */</span>
<a name="l05998"></a>05998       e = NULL;      <span class="comment">/* walk extensions in context  */</span>
<a name="l05999"></a>05999       <span class="keywordflow">while</span> ( (e = <a class="code" href="pbx_8h.html#aa63685577f3479dcf31a9e77b2ff05a7">ast_walk_context_extensions</a>(c, e)) ) {
<a name="l06000"></a>06000          <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *p;
<a name="l06001"></a>06001 
<a name="l06002"></a>06002          <span class="comment">/* looking for extension? is this our extension? */</span>
<a name="l06003"></a>06003          <span class="keywordflow">if</span> (exten &amp;&amp; !<a class="code" href="pbx_8h.html#a94cf2f099462a906620b5566871af797" title="Determine if a given extension matches a given pattern (in NXX format).">ast_extension_match</a>(<a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e), exten)) {
<a name="l06004"></a>06004             <span class="comment">/* not the one we are looking for, continue */</span>
<a name="l06005"></a>06005             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;manager_show_dialplan: Skipping extension %s\n&quot;</span>, <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e));
<a name="l06006"></a>06006             <span class="keywordflow">continue</span>;
<a name="l06007"></a>06007          }
<a name="l06008"></a>06008          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;manager_show_dialplan: Found Extension: %s \n&quot;</span>, <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e));
<a name="l06009"></a>06009 
<a name="l06010"></a>06010          dpc-&gt;<a class="code" href="structdialplan__counters.html#ad4ee98222efd50240dfd8e745a46b38e">extension_existence</a> = 1;
<a name="l06011"></a>06011 
<a name="l06012"></a>06012          <span class="comment">/* may we print context info? */</span>
<a name="l06013"></a>06013          dpc-&gt;<a class="code" href="structdialplan__counters.html#a3e221cee3977709c69000542b0e8253b">total_context</a>++;
<a name="l06014"></a>06014          dpc-&gt;<a class="code" href="structdialplan__counters.html#a8a1205d5763afe73383c436bf789451b">total_exten</a>++;
<a name="l06015"></a>06015 
<a name="l06016"></a>06016          p = NULL;      <span class="comment">/* walk next extension peers */</span>
<a name="l06017"></a>06017          <span class="keywordflow">while</span> ( (p = <a class="code" href="pbx_8h.html#a6772ce6e8de86d4b6c382dbf68ea4755">ast_walk_extension_priorities</a>(e, p)) ) {
<a name="l06018"></a>06018             <span class="keywordtype">int</span> prio = <a class="code" href="pbx_8h.html#a1662981db35d4125afaf6de98b2ba52f">ast_get_extension_priority</a>(p);
<a name="l06019"></a>06019 
<a name="l06020"></a>06020             dpc-&gt;<a class="code" href="structdialplan__counters.html#ad20b944aba8713eac8e63cf3eba770b9">total_prio</a>++;
<a name="l06021"></a>06021             <span class="keywordflow">if</span> (!dpc-&gt;<a class="code" href="structdialplan__counters.html#a0446d0ce125ccdc21db9b3007292115c">total_items</a>++)
<a name="l06022"></a>06022                <a class="code" href="pbx_8c.html#a70046ced091cbd83caccdba9e719cbce" title="Send ack once.">manager_dpsendack</a>(s, m);
<a name="l06023"></a>06023             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: ListDialplan\r\n%s&quot;</span>, actionidtext);
<a name="l06024"></a>06024             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Context: %s\r\nExtension: %s\r\n&quot;</span>, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e) );
<a name="l06025"></a>06025 
<a name="l06026"></a>06026             <span class="comment">/* XXX maybe make this conditional, if p != e ? */</span>
<a name="l06027"></a>06027             <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a266960fe6aa4db1066ed0b012fb7eb62">ast_get_extension_label</a>(p))
<a name="l06028"></a>06028                <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;ExtensionLabel: %s\r\n&quot;</span>, <a class="code" href="pbx_8h.html#a266960fe6aa4db1066ed0b012fb7eb62">ast_get_extension_label</a>(p));
<a name="l06029"></a>06029 
<a name="l06030"></a>06030             <span class="keywordflow">if</span> (prio == <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>) {
<a name="l06031"></a>06031                <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Priority: hint\r\nApplication: %s\r\n&quot;</span>, <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(p));
<a name="l06032"></a>06032             } <span class="keywordflow">else</span> {
<a name="l06033"></a>06033                <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Priority: %d\r\nApplication: %s\r\nAppData: %s\r\n&quot;</span>, prio, <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(p), (<span class="keywordtype">char</span> *) <a class="code" href="pbx_8h.html#ac0a6c0c39796f36864868365d8989f02">ast_get_extension_app_data</a>(p));
<a name="l06034"></a>06034             }
<a name="l06035"></a>06035             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Registrar: %s\r\n\r\n&quot;</span>, <a class="code" href="pbx_8h.html#a7f23f7c798d61e68c32b21d3e0cd15a2">ast_get_extension_registrar</a>(e));
<a name="l06036"></a>06036          }
<a name="l06037"></a>06037       }
<a name="l06038"></a>06038 
<a name="l06039"></a>06039       i = NULL;      <span class="comment">/* walk included and write info ... */</span>
<a name="l06040"></a>06040       <span class="keywordflow">while</span> ( (i = <a class="code" href="pbx_8h.html#a142de6e0271ada6b306f2f7420a3fd77">ast_walk_context_includes</a>(c, i)) ) {
<a name="l06041"></a>06041          <span class="keywordflow">if</span> (exten) {
<a name="l06042"></a>06042             <span class="comment">/* Check all includes for the requested extension */</span>
<a name="l06043"></a>06043             <a class="code" href="pbx_8c.html#a039a90f8fc481843e3ec0a4a7ab14a74" title="Show dialplan extensions XXX this function is similar but not exactly the same as...">manager_show_dialplan_helper</a>(s, m, actionidtext, <a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(i), exten, dpc, i);
<a name="l06044"></a>06044          } <span class="keywordflow">else</span> {
<a name="l06045"></a>06045             <span class="keywordflow">if</span> (!dpc-&gt;<a class="code" href="structdialplan__counters.html#a0446d0ce125ccdc21db9b3007292115c">total_items</a>++)
<a name="l06046"></a>06046                <a class="code" href="pbx_8c.html#a70046ced091cbd83caccdba9e719cbce" title="Send ack once.">manager_dpsendack</a>(s, m);
<a name="l06047"></a>06047             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: ListDialplan\r\n%s&quot;</span>, actionidtext);
<a name="l06048"></a>06048             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Context: %s\r\nIncludeContext: %s\r\nRegistrar: %s\r\n&quot;</span>, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), <a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(i), <a class="code" href="pbx_8h.html#a7a9aa5cd362edc7d593196f57686c2b9">ast_get_include_registrar</a>(i));
<a name="l06049"></a>06049             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;\r\n&quot;</span>);
<a name="l06050"></a>06050             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;manager_show_dialplan: Found Included context: %s \n&quot;</span>, <a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(i));
<a name="l06051"></a>06051          }
<a name="l06052"></a>06052       }
<a name="l06053"></a>06053 
<a name="l06054"></a>06054       ip = NULL;  <span class="comment">/* walk ignore patterns and write info ... */</span>
<a name="l06055"></a>06055       <span class="keywordflow">while</span> ( (ip = <a class="code" href="pbx_8h.html#a0e9dbe4e0003f65b67c78979f2fbfa8e">ast_walk_context_ignorepats</a>(c, ip)) ) {
<a name="l06056"></a>06056          <span class="keyword">const</span> <span class="keywordtype">char</span> *ipname = <a class="code" href="pbx_8h.html#a0c324514fc22df9cc5b32ceb68006e79">ast_get_ignorepat_name</a>(ip);
<a name="l06057"></a>06057          <span class="keywordtype">char</span> ignorepat[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l06058"></a>06058 
<a name="l06059"></a>06059          snprintf(ignorepat, <span class="keyword">sizeof</span>(ignorepat), <span class="stringliteral">&quot;_%s.&quot;</span>, ipname);
<a name="l06060"></a>06060          <span class="keywordflow">if</span> (!exten || <a class="code" href="pbx_8h.html#a94cf2f099462a906620b5566871af797" title="Determine if a given extension matches a given pattern (in NXX format).">ast_extension_match</a>(ignorepat, exten)) {
<a name="l06061"></a>06061             <span class="keywordflow">if</span> (!dpc-&gt;<a class="code" href="structdialplan__counters.html#a0446d0ce125ccdc21db9b3007292115c">total_items</a>++)
<a name="l06062"></a>06062                <a class="code" href="pbx_8c.html#a70046ced091cbd83caccdba9e719cbce" title="Send ack once.">manager_dpsendack</a>(s, m);
<a name="l06063"></a>06063             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: ListDialplan\r\n%s&quot;</span>, actionidtext);
<a name="l06064"></a>06064             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Context: %s\r\nIgnorePattern: %s\r\nRegistrar: %s\r\n&quot;</span>, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), ipname, <a class="code" href="pbx_8h.html#a1a219215514e9ed08ff67cc02c2dd1d3">ast_get_ignorepat_registrar</a>(ip));
<a name="l06065"></a>06065             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;\r\n&quot;</span>);
<a name="l06066"></a>06066          }
<a name="l06067"></a>06067       }
<a name="l06068"></a>06068       <span class="keywordflow">if</span> (!rinclude) {
<a name="l06069"></a>06069          <span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *sw = NULL;
<a name="l06070"></a>06070          <span class="keywordflow">while</span> ( (sw = <a class="code" href="pbx_8h.html#a64653e3c5cdfab48075b4001bd74655d">ast_walk_context_switches</a>(c, sw)) ) {
<a name="l06071"></a>06071             <span class="keywordflow">if</span> (!dpc-&gt;<a class="code" href="structdialplan__counters.html#a0446d0ce125ccdc21db9b3007292115c">total_items</a>++)
<a name="l06072"></a>06072                <a class="code" href="pbx_8c.html#a70046ced091cbd83caccdba9e719cbce" title="Send ack once.">manager_dpsendack</a>(s, m);
<a name="l06073"></a>06073             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: ListDialplan\r\n%s&quot;</span>, actionidtext);
<a name="l06074"></a>06074             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Context: %s\r\nSwitch: %s/%s\r\nRegistrar: %s\r\n&quot;</span>, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), <a class="code" href="pbx_8h.html#a87693eca302936ade0be97cab21e4f56">ast_get_switch_name</a>(sw), <a class="code" href="pbx_8h.html#accdca3b300f8f1ff523872bd3a129adc">ast_get_switch_data</a>(sw), <a class="code" href="pbx_8h.html#a1361d2a84278cee910c8ca0c7964c84c">ast_get_switch_registrar</a>(sw));  
<a name="l06075"></a>06075             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;\r\n&quot;</span>);
<a name="l06076"></a>06076             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;manager_show_dialplan: Found Switch : %s \n&quot;</span>, <a class="code" href="pbx_8h.html#a87693eca302936ade0be97cab21e4f56">ast_get_switch_name</a>(sw));
<a name="l06077"></a>06077          }
<a name="l06078"></a>06078       }
<a name="l06079"></a>06079 
<a name="l06080"></a>06080       <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(c);
<a name="l06081"></a>06081    }
<a name="l06082"></a>06082    <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l06083"></a>06083 
<a name="l06084"></a>06084    <span class="keywordflow">if</span> (dpc-&gt;<a class="code" href="structdialplan__counters.html#a8a1205d5763afe73383c436bf789451b">total_exten</a> == old_total_exten) {
<a name="l06085"></a>06085       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;manager_show_dialplan: Found nothing new\n&quot;</span>);
<a name="l06086"></a>06086       <span class="comment">/* Nothing new under the sun */</span>
<a name="l06087"></a>06087       <span class="keywordflow">return</span> -1;
<a name="l06088"></a>06088    } <span class="keywordflow">else</span> {
<a name="l06089"></a>06089       <span class="keywordflow">return</span> res;
<a name="l06090"></a>06090    }
<a name="l06091"></a>06091 }
<a name="l06092"></a>06092 <span class="comment"></span>
<a name="l06093"></a>06093 <span class="comment">/*! \brief  Manager listing of dial plan */</span>
<a name="l06094"></a><a class="code" href="pbx_8c.html#a08cb2466bf2b7844066c2e1f62a298db">06094</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a08cb2466bf2b7844066c2e1f62a298db" title="Manager listing of dial plan.">manager_show_dialplan</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06095"></a>06095 {
<a name="l06096"></a>06096    <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, *context;
<a name="l06097"></a>06097    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l06098"></a>06098    <span class="keywordtype">char</span> idtext[256];
<a name="l06099"></a>06099    <span class="keywordtype">int</span> res;
<a name="l06100"></a>06100 
<a name="l06101"></a>06101    <span class="comment">/* Variables used for different counters */</span>
<a name="l06102"></a>06102    <span class="keyword">struct </span><a class="code" href="structdialplan__counters.html" title="Counters for the show dialplan manager command.">dialplan_counters</a> counters;
<a name="l06103"></a>06103 
<a name="l06104"></a>06104    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l06105"></a>06105       snprintf(idtext, <span class="keyword">sizeof</span>(idtext), <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, <span class="keywordtype">id</span>);
<a name="l06106"></a>06106    <span class="keywordflow">else</span>
<a name="l06107"></a>06107       idtext[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l06108"></a>06108 
<a name="l06109"></a>06109    memset(&amp;counters, 0, <span class="keyword">sizeof</span>(counters));
<a name="l06110"></a>06110 
<a name="l06111"></a>06111    exten = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Extension&quot;</span>);
<a name="l06112"></a>06112    context = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Context&quot;</span>);
<a name="l06113"></a>06113 
<a name="l06114"></a>06114    res = <a class="code" href="pbx_8c.html#a039a90f8fc481843e3ec0a4a7ab14a74" title="Show dialplan extensions XXX this function is similar but not exactly the same as...">manager_show_dialplan_helper</a>(s, m, idtext, context, exten, &amp;counters, NULL);
<a name="l06115"></a>06115 
<a name="l06116"></a>06116    <span class="keywordflow">if</span> (context &amp;&amp; !counters.<a class="code" href="structdialplan__counters.html#a3f947ad80dce92dd50952d6633061166">context_existence</a>) {
<a name="l06117"></a>06117       <span class="keywordtype">char</span> errorbuf[BUFSIZ];
<a name="l06118"></a>06118 
<a name="l06119"></a>06119       snprintf(errorbuf, <span class="keyword">sizeof</span>(errorbuf), <span class="stringliteral">&quot;Did not find context %s&quot;</span>, context);
<a name="l06120"></a>06120       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, errorbuf);
<a name="l06121"></a>06121       <span class="keywordflow">return</span> 0;
<a name="l06122"></a>06122    }
<a name="l06123"></a>06123    <span class="keywordflow">if</span> (exten &amp;&amp; !counters.<a class="code" href="structdialplan__counters.html#ad4ee98222efd50240dfd8e745a46b38e">extension_existence</a>) {
<a name="l06124"></a>06124       <span class="keywordtype">char</span> errorbuf[BUFSIZ];
<a name="l06125"></a>06125 
<a name="l06126"></a>06126       <span class="keywordflow">if</span> (context)
<a name="l06127"></a>06127          snprintf(errorbuf, <span class="keyword">sizeof</span>(errorbuf), <span class="stringliteral">&quot;Did not find extension %s@%s&quot;</span>, exten, context);
<a name="l06128"></a>06128       <span class="keywordflow">else</span>
<a name="l06129"></a>06129          snprintf(errorbuf, <span class="keyword">sizeof</span>(errorbuf), <span class="stringliteral">&quot;Did not find extension %s in any context&quot;</span>, exten);
<a name="l06130"></a>06130       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, errorbuf);
<a name="l06131"></a>06131       <span class="keywordflow">return</span> 0;
<a name="l06132"></a>06132    }
<a name="l06133"></a>06133 
<a name="l06134"></a>06134    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a36fb89c2a73755209133b6c73fe92e54">EVENT_FLAG_CONFIG</a>, <span class="stringliteral">&quot;ShowDialPlanComplete&quot;</span>,
<a name="l06135"></a>06135       <span class="stringliteral">&quot;EventList: Complete\r\n&quot;</span>
<a name="l06136"></a>06136       <span class="stringliteral">&quot;ListItems: %d\r\n&quot;</span>
<a name="l06137"></a>06137       <span class="stringliteral">&quot;ListExtensions: %d\r\n&quot;</span>
<a name="l06138"></a>06138       <span class="stringliteral">&quot;ListPriorities: %d\r\n&quot;</span>
<a name="l06139"></a>06139       <span class="stringliteral">&quot;ListContexts: %d\r\n&quot;</span>
<a name="l06140"></a>06140       <span class="stringliteral">&quot;%s&quot;</span>
<a name="l06141"></a>06141       <span class="stringliteral">&quot;\r\n&quot;</span>, counters.<a class="code" href="structdialplan__counters.html#a0446d0ce125ccdc21db9b3007292115c">total_items</a>, counters.<a class="code" href="structdialplan__counters.html#a8a1205d5763afe73383c436bf789451b">total_exten</a>, counters.<a class="code" href="structdialplan__counters.html#ad20b944aba8713eac8e63cf3eba770b9">total_prio</a>, counters.<a class="code" href="structdialplan__counters.html#a3e221cee3977709c69000542b0e8253b">total_context</a>, idtext);
<a name="l06142"></a>06142 
<a name="l06143"></a>06143    <span class="comment">/* everything ok */</span>
<a name="l06144"></a>06144    <span class="keywordflow">return</span> 0;
<a name="l06145"></a>06145 }
<a name="l06146"></a>06146 
<a name="l06147"></a><a class="code" href="pbx_8c.html#a17bcde67ea91a1acfecbf3d718e86e82">06147</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="pbx_8c.html#a17bcde67ea91a1acfecbf3d718e86e82">mandescr_show_dialplan</a>[] =
<a name="l06148"></a>06148 <span class="stringliteral">&quot;Description: Show dialplan contexts and extensions.\n&quot;</span>
<a name="l06149"></a>06149 <span class="stringliteral">&quot;Be aware that showing the full dialplan may take a lot of capacity\n&quot;</span>
<a name="l06150"></a>06150 <span class="stringliteral">&quot;Variables: \n&quot;</span>
<a name="l06151"></a>06151 <span class="stringliteral">&quot; ActionID: &lt;id&gt;     Action ID for this AMI transaction (optional)\n&quot;</span>
<a name="l06152"></a>06152 <span class="stringliteral">&quot; Extension: &lt;extension&gt;   Extension (Optional)\n&quot;</span>
<a name="l06153"></a>06153 <span class="stringliteral">&quot; Context: &lt;context&gt;    Context (Optional)\n&quot;</span>
<a name="l06154"></a>06154 <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06155"></a>06155 <span class="comment"></span>
<a name="l06156"></a>06156 <span class="comment">/*! \brief CLI support for listing global variables in a parseable way */</span>
<a name="l06157"></a><a class="code" href="pbx_8c.html#ae90f4cb1a7197e24f95f5161ccac7f97">06157</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#ae90f4cb1a7197e24f95f5161ccac7f97" title="CLI support for listing global variables in a parseable way.">handle_show_globals</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06158"></a>06158 {
<a name="l06159"></a>06159    <span class="keywordtype">int</span> i = 0;
<a name="l06160"></a>06160    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *newvariable;
<a name="l06161"></a>06161 
<a name="l06162"></a>06162    <span class="keywordflow">switch</span> (cmd) {
<a name="l06163"></a>06163    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06164"></a>06164       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan show globals&quot;</span>;
<a name="l06165"></a>06165       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06166"></a>06166          <span class="stringliteral">&quot;Usage: dialplan show globals\n&quot;</span>
<a name="l06167"></a>06167          <span class="stringliteral">&quot;       List current global dialplan variables and their values\n&quot;</span>;
<a name="l06168"></a>06168       <span class="keywordflow">return</span> NULL;
<a name="l06169"></a>06169    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06170"></a>06170       <span class="keywordflow">return</span> NULL;
<a name="l06171"></a>06171    }
<a name="l06172"></a>06172 
<a name="l06173"></a>06173    <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l06174"></a>06174    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a> (&amp;<a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a>, newvariable, entries) {
<a name="l06175"></a>06175       i++;
<a name="l06176"></a>06176       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;   %s=%s\n&quot;</span>, <a class="code" href="chanvars_8h.html#a356a31cd608ec07d3668dcd589be49d8">ast_var_name</a>(newvariable), <a class="code" href="chanvars_8h.html#a8e0081172db71c5021d20706c50d959c">ast_var_value</a>(newvariable));
<a name="l06177"></a>06177    }
<a name="l06178"></a>06178    <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l06179"></a>06179    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n    -- %d variable(s)\n&quot;</span>, i);
<a name="l06180"></a>06180 
<a name="l06181"></a>06181    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06182"></a>06182 }
<a name="l06183"></a>06183 
<a name="l06184"></a>06184 <span class="preprocessor">#ifdef AST_DEVMODE</span>
<a name="l06185"></a>06185 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">char</span> *handle_show_device2extenstate(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06186"></a>06186 {
<a name="l06187"></a>06187    <span class="keyword">struct </span><a class="code" href="structast__devstate__aggregate.html" title="You shouldn&amp;#39;t care about the contents of this struct.">ast_devstate_aggregate</a> agg;
<a name="l06188"></a>06188    <span class="keywordtype">int</span> i, j, exten, combined;
<a name="l06189"></a>06189 
<a name="l06190"></a>06190    <span class="keywordflow">switch</span> (cmd) {
<a name="l06191"></a>06191    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06192"></a>06192       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show device2extenstate&quot;</span>;
<a name="l06193"></a>06193       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06194"></a>06194          <span class="stringliteral">&quot;Usage: core show device2extenstate\n&quot;</span>
<a name="l06195"></a>06195          <span class="stringliteral">&quot;       Lists device state to extension state combinations.\n&quot;</span>;
<a name="l06196"></a>06196    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06197"></a>06197       <span class="keywordflow">return</span> NULL;
<a name="l06198"></a>06198    }
<a name="l06199"></a>06199    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeaf790c1f212837af8d2db5193228102d7">AST_DEVICE_TOTAL</a>; i++) {
<a name="l06200"></a>06200       <span class="keywordflow">for</span> (j = 0; j &lt; AST_DEVICE_TOTAL; j++) {
<a name="l06201"></a>06201          <a class="code" href="devicestate_8h.html#a65ebe8f28497b09769ab9edeb4eb9b86" title="Initialize aggregate device state.">ast_devstate_aggregate_init</a>(&amp;agg);
<a name="l06202"></a>06202          <a class="code" href="devicestate_8h.html#a45534707838d05125f409430b371854a" title="Add a device state to the aggregate device state.">ast_devstate_aggregate_add</a>(&amp;agg, i);
<a name="l06203"></a>06203          <a class="code" href="devicestate_8h.html#a45534707838d05125f409430b371854a" title="Add a device state to the aggregate device state.">ast_devstate_aggregate_add</a>(&amp;agg, j);
<a name="l06204"></a>06204          combined = <a class="code" href="devicestate_8h.html#a852d7e936d4385c3bb903812de5d6403" title="Get the aggregate device state result.">ast_devstate_aggregate_result</a>(&amp;agg);
<a name="l06205"></a>06205          exten = <a class="code" href="pbx_8h.html#a3aa0b9f1691104cb6214ba66c5dc3a30" title="Map devstate to an extension state.">ast_devstate_to_extenstate</a>(combined);
<a name="l06206"></a>06206          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n Exten:%14s  CombinedDevice:%12s  Dev1:%12s  Dev2:%12s&quot;</span>, <a class="code" href="pbx_8h.html#a3261603753916b98888a5a5fc1d505c3" title="Return string representation of the state of an extension.">ast_extension_state2str</a>(exten), <a class="code" href="devicestate_8h.html#a6190de57ac370315e51f2c46724d5b10" title="Convert device state to text string that is easier to parse.">ast_devstate_str</a>(combined), <a class="code" href="devicestate_8h.html#a6190de57ac370315e51f2c46724d5b10" title="Convert device state to text string that is easier to parse.">ast_devstate_str</a>(j), <a class="code" href="devicestate_8h.html#a6190de57ac370315e51f2c46724d5b10" title="Convert device state to text string that is easier to parse.">ast_devstate_str</a>(i));
<a name="l06207"></a>06207       }
<a name="l06208"></a>06208    }
<a name="l06209"></a>06209    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l06210"></a>06210    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06211"></a>06211 }
<a name="l06212"></a>06212 <span class="preprocessor">#endif</span>
<a name="l06213"></a>06213 <span class="preprocessor"></span><span class="comment"></span>
<a name="l06214"></a>06214 <span class="comment">/*! \brief CLI support for listing chanvar&apos;s variables in a parseable way */</span>
<a name="l06215"></a><a class="code" href="pbx_8c.html#a1d4380f7c591f9f66b4757368513ecf1">06215</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a1d4380f7c591f9f66b4757368513ecf1" title="CLI support for listing chanvar&amp;#39;s variables in a parseable way.">handle_show_chanvar</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06216"></a>06216 {
<a name="l06217"></a>06217    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan = NULL;
<a name="l06218"></a>06218    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *vars = <a class="code" href="strings_8h.html#a7fc844c12b769ccded05e7514036e241">ast_str_alloca</a>(BUFSIZ * 4); <span class="comment">/* XXX large because we might have lots of channel vars */</span>
<a name="l06219"></a>06219 
<a name="l06220"></a>06220    <span class="keywordflow">switch</span> (cmd) {
<a name="l06221"></a>06221    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06222"></a>06222       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan show chanvar&quot;</span>;
<a name="l06223"></a>06223       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06224"></a>06224          <span class="stringliteral">&quot;Usage: dialplan show chanvar &lt;channel&gt;\n&quot;</span>
<a name="l06225"></a>06225          <span class="stringliteral">&quot;       List current channel variables and their values\n&quot;</span>;
<a name="l06226"></a>06226       <span class="keywordflow">return</span> NULL;
<a name="l06227"></a>06227    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06228"></a>06228       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a3a116acde8f18aa530e5b4a6df420273" title="Command completion for the list of active channels.">ast_complete_channels</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, 3);
<a name="l06229"></a>06229    }
<a name="l06230"></a>06230 
<a name="l06231"></a>06231    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1)
<a name="l06232"></a>06232       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06233"></a>06233 
<a name="l06234"></a>06234    <span class="keywordflow">if</span> (!(chan = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>]))) {
<a name="l06235"></a>06235       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; not found\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>]);
<a name="l06236"></a>06236       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06237"></a>06237    }
<a name="l06238"></a>06238 
<a name="l06239"></a>06239    <a class="code" href="pbx_8h.html#a847dc86089ce693d89a534512f16dad1" title="Create a human-readable string, specifying all variables and their corresponding...">pbx_builtin_serialize_variables</a>(chan, &amp;vars);
<a name="l06240"></a>06240    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a99409c17a1d20e1c3dc00039b7925a2d" title="Returns the current length of the string stored within buf.">ast_str_strlen</a>(vars)) {
<a name="l06241"></a>06241       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\nVariables for channel %s:\n%s\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>], <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(vars));
<a name="l06242"></a>06242    }
<a name="l06243"></a>06243    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l06244"></a>06244    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06245"></a>06245 }
<a name="l06246"></a>06246 
<a name="l06247"></a><a class="code" href="pbx_8c.html#a7fb8fa714c96d126a4b34a19234b6b90">06247</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a7fb8fa714c96d126a4b34a19234b6b90">handle_set_global</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06248"></a>06248 {
<a name="l06249"></a>06249    <span class="keywordflow">switch</span> (cmd) {
<a name="l06250"></a>06250    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06251"></a>06251       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan set global&quot;</span>;
<a name="l06252"></a>06252       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06253"></a>06253          <span class="stringliteral">&quot;Usage: dialplan set global &lt;name&gt; &lt;value&gt;\n&quot;</span>
<a name="l06254"></a>06254          <span class="stringliteral">&quot;       Set global dialplan variable &lt;name&gt; to &lt;value&gt;\n&quot;</span>;
<a name="l06255"></a>06255       <span class="keywordflow">return</span> NULL;
<a name="l06256"></a>06256    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06257"></a>06257       <span class="keywordflow">return</span> NULL;
<a name="l06258"></a>06258    }
<a name="l06259"></a>06259 
<a name="l06260"></a>06260    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 2)
<a name="l06261"></a>06261       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06262"></a>06262 
<a name="l06263"></a>06263    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(NULL, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4]);
<a name="l06264"></a>06264    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n    -- Global variable &apos;%s&apos; set to &apos;%s&apos;\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4]);
<a name="l06265"></a>06265 
<a name="l06266"></a>06266    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06267"></a>06267 }
<a name="l06268"></a>06268 
<a name="l06269"></a><a class="code" href="pbx_8c.html#a1c06ca3ff35ad931f2e45bd8c77a28b4">06269</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a1c06ca3ff35ad931f2e45bd8c77a28b4">handle_set_chanvar</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06270"></a>06270 {
<a name="l06271"></a>06271    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan;
<a name="l06272"></a>06272    <span class="keyword">const</span> <span class="keywordtype">char</span> *chan_name, *var_name, *var_value;
<a name="l06273"></a>06273 
<a name="l06274"></a>06274    <span class="keywordflow">switch</span> (cmd) {
<a name="l06275"></a>06275    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06276"></a>06276       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan set chanvar&quot;</span>;
<a name="l06277"></a>06277       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06278"></a>06278          <span class="stringliteral">&quot;Usage: dialplan set chanvar &lt;channel&gt; &lt;varname&gt; &lt;value&gt;\n&quot;</span>
<a name="l06279"></a>06279          <span class="stringliteral">&quot;       Set channel variable &lt;varname&gt; to &lt;value&gt;\n&quot;</span>;
<a name="l06280"></a>06280       <span class="keywordflow">return</span> NULL;
<a name="l06281"></a>06281    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06282"></a>06282       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a3a116acde8f18aa530e5b4a6df420273" title="Command completion for the list of active channels.">ast_complete_channels</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, 3);
<a name="l06283"></a>06283    }
<a name="l06284"></a>06284 
<a name="l06285"></a>06285    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 3)
<a name="l06286"></a>06286       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06287"></a>06287 
<a name="l06288"></a>06288    chan_name = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>];
<a name="l06289"></a>06289    var_name = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1];
<a name="l06290"></a>06290    var_value = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 2];
<a name="l06291"></a>06291 
<a name="l06292"></a>06292    <span class="keywordflow">if</span> (!(chan = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(chan_name))) {
<a name="l06293"></a>06293       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; not found\n&quot;</span>, chan_name);
<a name="l06294"></a>06294       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06295"></a>06295    }
<a name="l06296"></a>06296 
<a name="l06297"></a>06297    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, var_name, var_value);
<a name="l06298"></a>06298    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l06299"></a>06299    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n    -- Channel variable &apos;%s&apos; set to &apos;%s&apos; for &apos;%s&apos;\n&quot;</span>,  var_name, var_value, chan_name);
<a name="l06300"></a>06300 
<a name="l06301"></a>06301    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06302"></a>06302 }
<a name="l06303"></a>06303 
<a name="l06304"></a><a class="code" href="pbx_8c.html#a590d00dd2b4c421d55b9fa2b1943cedd">06304</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a590d00dd2b4c421d55b9fa2b1943cedd">handle_set_extenpatternmatchnew</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06305"></a>06305 {
<a name="l06306"></a>06306    <span class="keywordtype">int</span> oldval = 0;
<a name="l06307"></a>06307 
<a name="l06308"></a>06308    <span class="keywordflow">switch</span> (cmd) {
<a name="l06309"></a>06309    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06310"></a>06310       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan set extenpatternmatchnew true&quot;</span>;
<a name="l06311"></a>06311       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06312"></a>06312          <span class="stringliteral">&quot;Usage: dialplan set extenpatternmatchnew true|false\n&quot;</span>
<a name="l06313"></a>06313          <span class="stringliteral">&quot;       Use the NEW extension pattern matching algorithm, true or false.\n&quot;</span>;
<a name="l06314"></a>06314       <span class="keywordflow">return</span> NULL;
<a name="l06315"></a>06315    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06316"></a>06316       <span class="keywordflow">return</span> NULL;
<a name="l06317"></a>06317    }
<a name="l06318"></a>06318 
<a name="l06319"></a>06319    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l06320"></a>06320       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06321"></a>06321 
<a name="l06322"></a>06322    oldval =  <a class="code" href="pbx_8h.html#a86a7469073a22661d4db7086245c5b18">pbx_set_extenpatternmatchnew</a>(1);
<a name="l06323"></a>06323 
<a name="l06324"></a>06324    <span class="keywordflow">if</span> (oldval)
<a name="l06325"></a>06325       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n    -- Still using the NEW pattern match algorithm for extension names in the dialplan.\n&quot;</span>);
<a name="l06326"></a>06326    <span class="keywordflow">else</span>
<a name="l06327"></a>06327       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n    -- Switched to using the NEW pattern match algorithm for extension names in the dialplan.\n&quot;</span>);
<a name="l06328"></a>06328 
<a name="l06329"></a>06329    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06330"></a>06330 }
<a name="l06331"></a>06331 
<a name="l06332"></a><a class="code" href="pbx_8c.html#acd4647df41127a333e9fe3f6a90e14d5">06332</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#acd4647df41127a333e9fe3f6a90e14d5">handle_unset_extenpatternmatchnew</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06333"></a>06333 {
<a name="l06334"></a>06334    <span class="keywordtype">int</span> oldval = 0;
<a name="l06335"></a>06335 
<a name="l06336"></a>06336    <span class="keywordflow">switch</span> (cmd) {
<a name="l06337"></a>06337    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06338"></a>06338       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan set extenpatternmatchnew false&quot;</span>;
<a name="l06339"></a>06339       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06340"></a>06340          <span class="stringliteral">&quot;Usage: dialplan set extenpatternmatchnew true|false\n&quot;</span>
<a name="l06341"></a>06341          <span class="stringliteral">&quot;       Use the NEW extension pattern matching algorithm, true or false.\n&quot;</span>;
<a name="l06342"></a>06342       <span class="keywordflow">return</span> NULL;
<a name="l06343"></a>06343    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06344"></a>06344       <span class="keywordflow">return</span> NULL;
<a name="l06345"></a>06345    }
<a name="l06346"></a>06346 
<a name="l06347"></a>06347    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l06348"></a>06348       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06349"></a>06349 
<a name="l06350"></a>06350    oldval =  <a class="code" href="pbx_8h.html#a86a7469073a22661d4db7086245c5b18">pbx_set_extenpatternmatchnew</a>(0);
<a name="l06351"></a>06351 
<a name="l06352"></a>06352    <span class="keywordflow">if</span> (!oldval)
<a name="l06353"></a>06353       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n    -- Still using the OLD pattern match algorithm for extension names in the dialplan.\n&quot;</span>);
<a name="l06354"></a>06354    <span class="keywordflow">else</span>
<a name="l06355"></a>06355       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n    -- Switched to using the OLD pattern match algorithm for extension names in the dialplan.\n&quot;</span>);
<a name="l06356"></a>06356 
<a name="l06357"></a>06357    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06358"></a>06358 }
<a name="l06359"></a>06359 
<a name="l06360"></a>06360 <span class="comment">/*</span>
<a name="l06361"></a>06361 <span class="comment"> * CLI entries for upper commands ...</span>
<a name="l06362"></a>06362 <span class="comment"> */</span>
<a name="l06363"></a><a class="code" href="pbx_8c.html#ac7dafac1c16b8b484834c54b532e5d66">06363</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="pbx_8c.html#ac7dafac1c16b8b484834c54b532e5d66">pbx_cli</a>[] = {
<a name="l06364"></a>06364    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#a3fd3a2a72933c9a81547a7c1fab6d5f0">handle_show_applications</a>, <span class="stringliteral">&quot;Shows registered dialplan applications&quot;</span>),
<a name="l06365"></a>06365    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#acfa4ef71bd45e5cb9fa95ea3564ce3fb">handle_show_functions</a>, <span class="stringliteral">&quot;Shows registered dialplan functions&quot;</span>),
<a name="l06366"></a>06366    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#ab60040f3a7c86b47c2b7475892d55852" title="handle_show_switches: CLI support for listing registered dial plan switches">handle_show_switches</a>, <span class="stringliteral">&quot;Show alternative switches&quot;</span>),
<a name="l06367"></a>06367    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#a6a6ee2e0a596361065c15a8795b7ea3d" title="handle_show_hints: CLI support for listing registered dial plan hints">handle_show_hints</a>, <span class="stringliteral">&quot;Show dialplan hints&quot;</span>),
<a name="l06368"></a>06368    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#a6ede44bb54442c1980e3d2e91da4b4bd" title="handle_show_hint: CLI support for listing registered dial plan hint">handle_show_hint</a>, <span class="stringliteral">&quot;Show dialplan hint&quot;</span>),
<a name="l06369"></a>06369    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#ae90f4cb1a7197e24f95f5161ccac7f97" title="CLI support for listing global variables in a parseable way.">handle_show_globals</a>, <span class="stringliteral">&quot;Show global dialplan variables&quot;</span>),
<a name="l06370"></a>06370 <span class="preprocessor">#ifdef AST_DEVMODE</span>
<a name="l06371"></a>06371 <span class="preprocessor"></span>   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(handle_show_device2extenstate, <span class="stringliteral">&quot;Show expected exten state from multiple device states&quot;</span>),
<a name="l06372"></a>06372 <span class="preprocessor">#endif</span>
<a name="l06373"></a>06373 <span class="preprocessor"></span>   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#a1d4380f7c591f9f66b4757368513ecf1" title="CLI support for listing chanvar&amp;#39;s variables in a parseable way.">handle_show_chanvar</a>, <span class="stringliteral">&quot;Show channel variables&quot;</span>),
<a name="l06374"></a>06374    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#ab517469d7957ff803505b3390a3edaa0">handle_show_function</a>, <span class="stringliteral">&quot;Describe a specific dialplan function&quot;</span>),
<a name="l06375"></a>06375    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#ad6c3fdc0a614d26cd94782971d5772da">handle_show_application</a>, <span class="stringliteral">&quot;Describe a specific dialplan application&quot;</span>),
<a name="l06376"></a>06376    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#a7fb8fa714c96d126a4b34a19234b6b90">handle_set_global</a>, <span class="stringliteral">&quot;Set global dialplan variable&quot;</span>),
<a name="l06377"></a>06377    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#a1c06ca3ff35ad931f2e45bd8c77a28b4">handle_set_chanvar</a>, <span class="stringliteral">&quot;Set a channel variable&quot;</span>),
<a name="l06378"></a>06378    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#acf5505fa44483212103cce849e530e1c">handle_show_dialplan</a>, <span class="stringliteral">&quot;Show dialplan&quot;</span>),
<a name="l06379"></a>06379    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#a69b3642bb638524be829a44a1b1219db" title="Send ack once.">handle_debug_dialplan</a>, <span class="stringliteral">&quot;Show fast extension pattern matching data structures&quot;</span>),
<a name="l06380"></a>06380    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#acd4647df41127a333e9fe3f6a90e14d5">handle_unset_extenpatternmatchnew</a>, <span class="stringliteral">&quot;Use the Old extension pattern matching algorithm.&quot;</span>),
<a name="l06381"></a>06381    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx_8c.html#a590d00dd2b4c421d55b9fa2b1943cedd">handle_set_extenpatternmatchnew</a>, <span class="stringliteral">&quot;Use the New extension pattern matching algorithm.&quot;</span>),
<a name="l06382"></a>06382 };
<a name="l06383"></a>06383 
<a name="l06384"></a><a class="code" href="pbx_8c.html#a7d988d7cc30a609acec6a05c07546cbb">06384</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a7d988d7cc30a609acec6a05c07546cbb">unreference_cached_app</a>(<span class="keyword">struct</span> ast_app *app)
<a name="l06385"></a>06385 {
<a name="l06386"></a>06386    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *context = NULL;
<a name="l06387"></a>06387    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *eroot = NULL, *e = NULL;
<a name="l06388"></a>06388 
<a name="l06389"></a>06389    <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l06390"></a>06390    <span class="keywordflow">while</span> ((context = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(context))) {
<a name="l06391"></a>06391       <span class="keywordflow">while</span> ((eroot = <a class="code" href="pbx_8h.html#aa63685577f3479dcf31a9e77b2ff05a7">ast_walk_context_extensions</a>(context, eroot))) {
<a name="l06392"></a>06392          <span class="keywordflow">while</span> ((e = <a class="code" href="pbx_8h.html#a6772ce6e8de86d4b6c382dbf68ea4755">ast_walk_extension_priorities</a>(eroot, e))) {
<a name="l06393"></a>06393             <span class="keywordflow">if</span> (e-&gt;cached_app == app)
<a name="l06394"></a>06394                e-&gt;cached_app = NULL;
<a name="l06395"></a>06395          }
<a name="l06396"></a>06396       }
<a name="l06397"></a>06397    }
<a name="l06398"></a>06398    <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l06399"></a>06399 
<a name="l06400"></a>06400    <span class="keywordflow">return</span>;
<a name="l06401"></a>06401 }
<a name="l06402"></a>06402 
<a name="l06403"></a><a class="code" href="pbx_8c.html#ad2ca15621101154f29748cf1dac3c3cf">06403</a> <span class="keywordtype">int</span> <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *app)
<a name="l06404"></a>06404 {
<a name="l06405"></a>06405    <span class="keyword">struct </span>ast_app *tmp;
<a name="l06406"></a>06406 
<a name="l06407"></a>06407    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l06408"></a>06408    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structapps.html">apps</a>, tmp, list) {
<a name="l06409"></a>06409       <span class="keywordflow">if</span> (!strcasecmp(app, tmp-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>)) {
<a name="l06410"></a>06410          <a class="code" href="pbx_8c.html#a7d988d7cc30a609acec6a05c07546cbb">unreference_cached_app</a>(tmp);
<a name="l06411"></a>06411          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(list);
<a name="l06412"></a>06412          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Unregistered application &apos;%s&apos;\n&quot;</span>, tmp-&gt;<a class="code" href="structast__app.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l06413"></a>06413          <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(tmp);
<a name="l06414"></a>06414          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l06415"></a>06415          <span class="keywordflow">break</span>;
<a name="l06416"></a>06416       }
<a name="l06417"></a>06417    }
<a name="l06418"></a>06418    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l06419"></a>06419    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structapps.html">apps</a>);
<a name="l06420"></a>06420 
<a name="l06421"></a>06421    <span class="keywordflow">return</span> tmp ? 0 : -1;
<a name="l06422"></a>06422 }
<a name="l06423"></a>06423 
<a name="l06424"></a><a class="code" href="pbx_8c.html#a8a07400b41b3302edf8aef9f53644698">06424</a> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> **extcontexts, <span class="keyword">struct</span> <a class="code" href="structast__hashtab.html">ast_hashtab</a> *exttable, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l06425"></a>06425 {
<a name="l06426"></a>06426    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *tmp, **<a class="code" href="pbx__config_8c.html#a71549c9ba7fb62eeb7c04b697e716543">local_contexts</a>;
<a name="l06427"></a>06427    <span class="keyword">struct </span><a class="code" href="structfake__context.html">fake_context</a> search;
<a name="l06428"></a>06428    <span class="keywordtype">int</span> length = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a>) + strlen(name) + 1;
<a name="l06429"></a>06429 
<a name="l06430"></a>06430    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>) {
<a name="l06431"></a>06431       <a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a> = <a class="code" href="hashtab_8h.html#a85701d44df4ea1e746bde709a91a4192" title="Create the hashtable list.">ast_hashtab_create</a>(17,
<a name="l06432"></a>06432                                  <a class="code" href="pbx_8h.html#a20a2f5668173430437db02cdd0acc9f3" title="hashtable functions for contexts">ast_hashtab_compare_contexts</a>,
<a name="l06433"></a>06433                                  <a class="code" href="hashtab_8h.html#aef63906caa0b965e9c8d8561600038e9" title="Determines if a table resize should occur using the Java algorithm (if the table...">ast_hashtab_resize_java</a>,
<a name="l06434"></a>06434                                  <a class="code" href="hashtab_8h.html#a743bfd52a8c9eb5d939ff5944758d846" title="Create a prime number roughly 2x the current table size.">ast_hashtab_newsize_java</a>,
<a name="l06435"></a>06435                                  <a class="code" href="pbx_8h.html#a56461864a4e21b14e753b78f9ac7afb7">ast_hashtab_hash_contexts</a>,
<a name="l06436"></a>06436                                  0);
<a name="l06437"></a>06437    }
<a name="l06438"></a>06438 
<a name="l06439"></a>06439    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(search.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, name, <span class="keyword">sizeof</span>(search.<a class="code" href="structfake__context.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>));
<a name="l06440"></a>06440    <span class="keywordflow">if</span> (!extcontexts) {
<a name="l06441"></a>06441       <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l06442"></a>06442       local_contexts = &amp;<a class="code" href="pbx_8c.html#aae85d5aab50f2d1b8392d6df276f2561">contexts</a>;
<a name="l06443"></a>06443       tmp = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>, &amp;search);
<a name="l06444"></a>06444       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l06445"></a>06445       <span class="keywordflow">if</span> (tmp) {
<a name="l06446"></a>06446          tmp-&gt;<a class="code" href="structast__context.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a>++;
<a name="l06447"></a>06447          <span class="keywordflow">return</span> tmp;
<a name="l06448"></a>06448       }
<a name="l06449"></a>06449    } <span class="keywordflow">else</span> { <span class="comment">/* local contexts just in a linked list; search there for the new context; slow, linear search, but not frequent */</span>
<a name="l06450"></a>06450       local_contexts = extcontexts;
<a name="l06451"></a>06451       tmp = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(exttable, &amp;search);
<a name="l06452"></a>06452       <span class="keywordflow">if</span> (tmp) {
<a name="l06453"></a>06453          tmp-&gt;<a class="code" href="structast__context.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a>++;
<a name="l06454"></a>06454          <span class="keywordflow">return</span> tmp;
<a name="l06455"></a>06455       }
<a name="l06456"></a>06456    }
<a name="l06457"></a>06457 
<a name="l06458"></a>06458    <span class="keywordflow">if</span> ((tmp = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, length))) {
<a name="l06459"></a>06459       <a class="code" href="lock_8h.html#aeae3552501126e03a4fa95f4acd0ee67">ast_rwlock_init</a>(&amp;tmp-&gt;<a class="code" href="structast__context.html#ace4e0066a5b24f84b90536e9906619f6">lock</a>);
<a name="l06460"></a>06460       <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;tmp-&gt;<a class="code" href="structast__context.html#a34eb63008d294b713376e64bb2a7b2ef">macrolock</a>);
<a name="l06461"></a>06461       strcpy(tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, name);
<a name="l06462"></a>06462       tmp-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a> = NULL;
<a name="l06463"></a>06463       tmp-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a> = NULL;
<a name="l06464"></a>06464       tmp-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(registrar);
<a name="l06465"></a>06465       tmp-&gt;<a class="code" href="structast__context.html#abaa8691efe3e8fe26f5930720bfd8edb">includes</a> = NULL;
<a name="l06466"></a>06466       tmp-&gt;<a class="code" href="structast__context.html#aedb0afcd332920e51d2f82860f794347">ignorepats</a> = NULL;
<a name="l06467"></a>06467       tmp-&gt;<a class="code" href="structast__context.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a> = 1;
<a name="l06468"></a>06468    } <span class="keywordflow">else</span> {
<a name="l06469"></a>06469       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Danger! We failed to allocate a context for %s!\n&quot;</span>, name);
<a name="l06470"></a>06470       <span class="keywordflow">return</span> NULL;
<a name="l06471"></a>06471    }
<a name="l06472"></a>06472 
<a name="l06473"></a>06473    <span class="keywordflow">if</span> (!extcontexts) {
<a name="l06474"></a>06474       <a class="code" href="pbx_8h.html#a18c87dac5f7f4368c11b67d8026adc22" title="Write locks the context list.">ast_wrlock_contexts</a>();
<a name="l06475"></a>06475       tmp-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a> = *local_contexts;
<a name="l06476"></a>06476       *local_contexts = tmp;
<a name="l06477"></a>06477       <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>, tmp); <span class="comment">/*put this context into the tree */</span>
<a name="l06478"></a>06478       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l06479"></a>06479       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Registered context &apos;%s&apos;(%p) in table %p registrar: %s\n&quot;</span>, tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, tmp, <a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>, registrar);
<a name="l06480"></a>06480       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Registered extension context &apos;%s&apos; (%p) in table %p; registrar: %s\n&quot;</span>, tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, tmp, <a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>, registrar);
<a name="l06481"></a>06481    } <span class="keywordflow">else</span> {
<a name="l06482"></a>06482       tmp-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a> = *local_contexts;
<a name="l06483"></a>06483       <span class="keywordflow">if</span> (exttable)
<a name="l06484"></a>06484          <a class="code" href="hashtab_8h.html#af3e13ed429193a2bf4f0b9d93ac5d7c1" title="Insert without checking.">ast_hashtab_insert_immediate</a>(exttable, tmp); <span class="comment">/*put this context into the tree */</span>
<a name="l06485"></a>06485 
<a name="l06486"></a>06486       *local_contexts = tmp;
<a name="l06487"></a>06487       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Registered context &apos;%s&apos;(%p) in local table %p; registrar: %s\n&quot;</span>, tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, tmp, exttable, registrar);
<a name="l06488"></a>06488       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Registered extension context &apos;%s&apos; (%p) in local table %p; registrar: %s\n&quot;</span>, tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, tmp, exttable, registrar);
<a name="l06489"></a>06489    }
<a name="l06490"></a>06490    <span class="keywordflow">return</span> tmp;
<a name="l06491"></a>06491 }
<a name="l06492"></a>06492 
<a name="l06493"></a>06493 <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a06e285124697319566d67b82c25aba19">__ast_context_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *list, <span class="keyword">struct</span> <a class="code" href="structast__hashtab.html">ast_hashtab</a> *contexttab, <span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>);
<a name="l06494"></a>06494 
<a name="l06495"></a><a class="code" href="structstore__hint.html">06495</a> <span class="keyword">struct </span><a class="code" href="structstore__hint.html">store_hint</a> {
<a name="l06496"></a><a class="code" href="structstore__hint.html#a1f27749679e8054ef014a38569492895">06496</a>    <span class="keywordtype">char</span> *context;
<a name="l06497"></a><a class="code" href="structstore__hint.html#a9c2cb8c1611452928af0def998e36335">06497</a>    <span class="keywordtype">char</span> *exten;
<a name="l06498"></a><a class="code" href="structstore__hint.html#a72cb6fc63a95612b6884d7fddd990b6d">06498</a>    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, ast_state_cb) callbacks;
<a name="l06499"></a><a class="code" href="structstore__hint.html#a0078d2e3ae10f15d7634c01199f33d4f">06499</a>    <span class="keywordtype">int</span> laststate;
<a name="l06500"></a><a class="code" href="structstore__hint.html#a98a65d0ca099fd79881b59738d69b298">06500</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structstore__hint.html">store_hint</a>) list;
<a name="l06501"></a><a class="code" href="structstore__hint.html#a29de267eb7d80d77d2aeeb3b347bd7db">06501</a>    <span class="keywordtype">char</span> data[1];
<a name="l06502"></a>06502 };
<a name="l06503"></a>06503 
<a name="l06504"></a><a class="code" href="structstore__hints.html#adf04f66344e3fb0a6f6a69bf39d19902">06504</a> <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(<a class="code" href="structstore__hints.html">store_hints</a>, <a class="code" href="structstore__hint.html">store_hint</a>);
<a name="l06505"></a>06505 
<a name="l06506"></a><a class="code" href="pbx_8c.html#a59daa69d081df63e2454d50279185f45">06506</a> static <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a59daa69d081df63e2454d50279185f45">context_merge_incls_swits_igps_other_registrars</a>(struct <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *new, struct <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *old, const <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l06507"></a>06507 {
<a name="l06508"></a>06508    <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *i;
<a name="l06509"></a>06509    <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ip;
<a name="l06510"></a>06510    <span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *sw;
<a name="l06511"></a>06511 
<a name="l06512"></a>06512    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;merging incls/swits/igpats from old(%s) to new(%s) context, registrar = %s\n&quot;</span>, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(old), <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(<span class="keyword">new</span>), registrar);
<a name="l06513"></a>06513    <span class="comment">/* copy in the includes, switches, and ignorepats */</span>
<a name="l06514"></a>06514    <span class="comment">/* walk through includes */</span>
<a name="l06515"></a>06515    <span class="keywordflow">for</span> (i = NULL; (i = <a class="code" href="pbx_8h.html#a142de6e0271ada6b306f2f7420a3fd77">ast_walk_context_includes</a>(old, i)) ; ) {
<a name="l06516"></a>06516       <span class="keywordflow">if</span> (strcmp(<a class="code" href="pbx_8h.html#a7a9aa5cd362edc7d593196f57686c2b9">ast_get_include_registrar</a>(i), registrar) == 0)
<a name="l06517"></a>06517          <span class="keywordflow">continue</span>; <span class="comment">/* not mine */</span>
<a name="l06518"></a>06518       <a class="code" href="pbx_8h.html#aceaa74fb91df5e8f7892f59953ff6283" title="Add a context include.">ast_context_add_include2</a>(<span class="keyword">new</span>, <a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(i), <a class="code" href="pbx_8h.html#a7a9aa5cd362edc7d593196f57686c2b9">ast_get_include_registrar</a>(i));
<a name="l06519"></a>06519    }
<a name="l06520"></a>06520 
<a name="l06521"></a>06521    <span class="comment">/* walk through switches */</span>
<a name="l06522"></a>06522    <span class="keywordflow">for</span> (sw = NULL; (sw = <a class="code" href="pbx_8h.html#a64653e3c5cdfab48075b4001bd74655d">ast_walk_context_switches</a>(old, sw)) ; ) {
<a name="l06523"></a>06523       <span class="keywordflow">if</span> (strcmp(<a class="code" href="pbx_8h.html#a1361d2a84278cee910c8ca0c7964c84c">ast_get_switch_registrar</a>(sw), registrar) == 0)
<a name="l06524"></a>06524          <span class="keywordflow">continue</span>; <span class="comment">/* not mine */</span>
<a name="l06525"></a>06525       <a class="code" href="pbx_8h.html#a98b8af4a068416ee570f9d78cb9af724" title="Adds a switch (first param is a ast_context).">ast_context_add_switch2</a>(<span class="keyword">new</span>, <a class="code" href="pbx_8h.html#a87693eca302936ade0be97cab21e4f56">ast_get_switch_name</a>(sw), <a class="code" href="pbx_8h.html#accdca3b300f8f1ff523872bd3a129adc">ast_get_switch_data</a>(sw), <a class="code" href="pbx_8h.html#af947a04e100465f0c03b870129ba3e48">ast_get_switch_eval</a>(sw), <a class="code" href="pbx_8h.html#a1361d2a84278cee910c8ca0c7964c84c">ast_get_switch_registrar</a>(sw));
<a name="l06526"></a>06526    }
<a name="l06527"></a>06527 
<a name="l06528"></a>06528    <span class="comment">/* walk thru ignorepats ... */</span>
<a name="l06529"></a>06529    <span class="keywordflow">for</span> (ip = NULL; (ip = <a class="code" href="pbx_8h.html#a0e9dbe4e0003f65b67c78979f2fbfa8e">ast_walk_context_ignorepats</a>(old, ip)); ) {
<a name="l06530"></a>06530       <span class="keywordflow">if</span> (strcmp(<a class="code" href="pbx_8h.html#a1a219215514e9ed08ff67cc02c2dd1d3">ast_get_ignorepat_registrar</a>(ip), registrar) == 0)
<a name="l06531"></a>06531          <span class="keywordflow">continue</span>; <span class="comment">/* not mine */</span>
<a name="l06532"></a>06532       <a class="code" href="pbx_8h.html#a82c040aa706c09bd6294b2333a2a0587">ast_context_add_ignorepat2</a>(<span class="keyword">new</span>, <a class="code" href="pbx_8h.html#a0c324514fc22df9cc5b32ceb68006e79">ast_get_ignorepat_name</a>(ip), <a class="code" href="pbx_8h.html#a1a219215514e9ed08ff67cc02c2dd1d3">ast_get_ignorepat_registrar</a>(ip));
<a name="l06533"></a>06533    }
<a name="l06534"></a>06534 }
<a name="l06535"></a>06535 
<a name="l06536"></a>06536 
<a name="l06537"></a>06537 <span class="comment">/* the purpose of this routine is to duplicate a context, with all its substructure,</span>
<a name="l06538"></a>06538 <span class="comment">   except for any extens that have a matching registrar */</span>
<a name="l06539"></a><a class="code" href="pbx_8c.html#a68752b8c650f91f9f3e36d6ce36bba2e">06539</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a68752b8c650f91f9f3e36d6ce36bba2e">context_merge</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> **extcontexts, <span class="keyword">struct</span> <a class="code" href="structast__hashtab.html">ast_hashtab</a> *exttable, <span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l06540"></a>06540 {
<a name="l06541"></a>06541    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<span class="keyword">new</span> = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(exttable, context); <span class="comment">/* is there a match in the new set? */</span>
<a name="l06542"></a>06542    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *exten_item, *prio_item, *new_exten_item, *new_prio_item;
<a name="l06543"></a>06543    <span class="keyword">struct </span><a class="code" href="structast__hashtab__iter.html" title="an iterator for traversing the buckets">ast_hashtab_iter</a> *exten_iter;
<a name="l06544"></a>06544    <span class="keyword">struct </span><a class="code" href="structast__hashtab__iter.html" title="an iterator for traversing the buckets">ast_hashtab_iter</a> *prio_iter;
<a name="l06545"></a>06545    <span class="keywordtype">int</span> insert_count = 0;
<a name="l06546"></a>06546    <span class="keywordtype">int</span> <a class="code" href="devicestate_8c.html#abd2135e6f8a41bc900933b1985d97165">first</a> = 1;
<a name="l06547"></a>06547 
<a name="l06548"></a>06548    <span class="comment">/* We&apos;ll traverse all the extensions/prios, and see which are not registrar&apos;d with</span>
<a name="l06549"></a>06549 <span class="comment">      the current registrar, and copy them to the new context. If the new context does not</span>
<a name="l06550"></a>06550 <span class="comment">      exist, we&apos;ll create it &quot;on demand&quot;. If no items are in this context to copy, then we&apos;ll</span>
<a name="l06551"></a>06551 <span class="comment">      only create the empty matching context if the old one meets the criteria */</span>
<a name="l06552"></a>06552 
<a name="l06553"></a>06553    <span class="keywordflow">if</span> (context-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>) {
<a name="l06554"></a>06554       exten_iter = <a class="code" href="hashtab_8h.html#ac5a19bffadbbd4eb31f190e576f88512" title="Gives an iterator to hastable.">ast_hashtab_start_traversal</a>(context-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>);
<a name="l06555"></a>06555       <span class="keywordflow">while</span> ((exten_item=<a class="code" href="hashtab_8h.html#a43983b6169e9a0f9af48cca5cf9d3197" title="Gets the next object in the list, advances iter one step returns null on end of traversal...">ast_hashtab_next</a>(exten_iter))) {
<a name="l06556"></a>06556          <span class="keywordflow">if</span> (<span class="keyword">new</span>) {
<a name="l06557"></a>06557             new_exten_item = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(new-&gt;root_table, exten_item);
<a name="l06558"></a>06558          } <span class="keywordflow">else</span> {
<a name="l06559"></a>06559             new_exten_item = NULL;
<a name="l06560"></a>06560          }
<a name="l06561"></a>06561          prio_iter = <a class="code" href="hashtab_8h.html#ac5a19bffadbbd4eb31f190e576f88512" title="Gives an iterator to hastable.">ast_hashtab_start_traversal</a>(exten_item-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>);
<a name="l06562"></a>06562          <span class="keywordflow">while</span> ((prio_item=<a class="code" href="hashtab_8h.html#a43983b6169e9a0f9af48cca5cf9d3197" title="Gets the next object in the list, advances iter one step returns null on end of traversal...">ast_hashtab_next</a>(prio_iter))) {
<a name="l06563"></a>06563             <span class="keywordtype">int</span> res1;
<a name="l06564"></a>06564             <span class="keywordtype">char</span> *dupdstr;
<a name="l06565"></a>06565 
<a name="l06566"></a>06566             <span class="keywordflow">if</span> (new_exten_item) {
<a name="l06567"></a>06567                new_prio_item = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(new_exten_item-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>, prio_item);
<a name="l06568"></a>06568             } <span class="keywordflow">else</span> {
<a name="l06569"></a>06569                new_prio_item = NULL;
<a name="l06570"></a>06570             }
<a name="l06571"></a>06571             <span class="keywordflow">if</span> (strcmp(prio_item-&gt;<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>,registrar) == 0) {
<a name="l06572"></a>06572                <span class="keywordflow">continue</span>;
<a name="l06573"></a>06573             }
<a name="l06574"></a>06574             <span class="comment">/* make sure the new context exists, so we have somewhere to stick this exten/prio */</span>
<a name="l06575"></a>06575             <span class="keywordflow">if</span> (!<span class="keyword">new</span>) {
<a name="l06576"></a>06576                <span class="keyword">new</span> = <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(extcontexts, exttable, context-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, prio_item-&gt;<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>); <span class="comment">/* a new context created via priority from a different context in the old dialplan, gets its registrar from the prio&apos;s registrar */</span>
<a name="l06577"></a>06577             }
<a name="l06578"></a>06578 
<a name="l06579"></a>06579             <span class="comment">/* copy in the includes, switches, and ignorepats */</span>
<a name="l06580"></a>06580             <span class="keywordflow">if</span> (first) { <span class="comment">/* but, only need to do this once */</span>
<a name="l06581"></a>06581                <a class="code" href="pbx_8c.html#a59daa69d081df63e2454d50279185f45">context_merge_incls_swits_igps_other_registrars</a>(<span class="keyword">new</span>, context, registrar);
<a name="l06582"></a>06582                first = 0;
<a name="l06583"></a>06583             }
<a name="l06584"></a>06584 
<a name="l06585"></a>06585             <span class="keywordflow">if</span> (!<span class="keyword">new</span>) {
<a name="l06586"></a>06586                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Could not allocate a new context for %s in merge_and_delete! Danger!\n&quot;</span>, context-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l06587"></a>06587                <span class="keywordflow">return</span>; <span class="comment">/* no sense continuing. */</span>
<a name="l06588"></a>06588             }
<a name="l06589"></a>06589             <span class="comment">/* we will not replace existing entries in the new context with stuff from the old context.</span>
<a name="l06590"></a>06590 <span class="comment">               but, if this is because of some sort of registrar conflict, we ought to say something... */</span>
<a name="l06591"></a>06591 
<a name="l06592"></a>06592             dupdstr = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(prio_item-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l06593"></a>06593 
<a name="l06594"></a>06594             res1 = <a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(<span class="keyword">new</span>, 0, prio_item-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, prio_item-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, prio_item-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>, 
<a name="l06595"></a>06595                                 prio_item-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> ? prio_item-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a> : NULL, prio_item-&gt;<a class="code" href="structast__exten.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">app</a>, dupdstr, prio_item-&gt;<a class="code" href="structast__exten.html#ad11dc8dd7d18a2cf6451b32ea529221c">datad</a>, prio_item-&gt;<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>);
<a name="l06596"></a>06596             <span class="keywordflow">if</span> (!res1 &amp;&amp; new_exten_item &amp;&amp; new_prio_item){
<a name="l06597"></a>06597                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3,<span class="stringliteral">&quot;Dropping old dialplan item %s/%s/%d [%s(%s)] (registrar=%s) due to conflict with new dialplan\n&quot;</span>,
<a name="l06598"></a>06598                      context-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, prio_item-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, prio_item-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, prio_item-&gt;<a class="code" href="structast__exten.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">app</a>, (<span class="keywordtype">char</span>*)prio_item-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a>, prio_item-&gt;<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>);
<a name="l06599"></a>06599             } <span class="keywordflow">else</span> {
<a name="l06600"></a>06600                <span class="comment">/* we do NOT pass the priority data from the old to the new -- we pass a copy of it, so no changes to the current dialplan take place,</span>
<a name="l06601"></a>06601 <span class="comment">                and no double frees take place, either! */</span>
<a name="l06602"></a>06602                insert_count++;
<a name="l06603"></a>06603             }
<a name="l06604"></a>06604          }
<a name="l06605"></a>06605          <a class="code" href="hashtab_8h.html#a9c804e9bfc8355c25197187f0c6d0265" title="end the traversal, free the iterator, unlock if necc.">ast_hashtab_end_traversal</a>(prio_iter);
<a name="l06606"></a>06606       }
<a name="l06607"></a>06607       <a class="code" href="hashtab_8h.html#a9c804e9bfc8355c25197187f0c6d0265" title="end the traversal, free the iterator, unlock if necc.">ast_hashtab_end_traversal</a>(exten_iter);
<a name="l06608"></a>06608    }
<a name="l06609"></a>06609 
<a name="l06610"></a>06610    <span class="keywordflow">if</span> (!insert_count &amp;&amp; !<span class="keyword">new</span> &amp;&amp; (strcmp(context-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>, registrar) != 0 ||
<a name="l06611"></a>06611         (strcmp(context-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>, registrar) == 0 &amp;&amp; context-&gt;<a class="code" href="structast__context.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a> &gt; 1))) {
<a name="l06612"></a>06612       <span class="comment">/* we could have given it the registrar of the other module who incremented the refcount,</span>
<a name="l06613"></a>06613 <span class="comment">         but that&apos;s not available, so we give it the registrar we know about */</span>
<a name="l06614"></a>06614       <span class="keyword">new</span> = <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(extcontexts, exttable, context-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, context-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l06615"></a>06615 
<a name="l06616"></a>06616       <span class="comment">/* copy in the includes, switches, and ignorepats */</span>
<a name="l06617"></a>06617       <a class="code" href="pbx_8c.html#a59daa69d081df63e2454d50279185f45">context_merge_incls_swits_igps_other_registrars</a>(<span class="keyword">new</span>, context, registrar);
<a name="l06618"></a>06618    }
<a name="l06619"></a>06619 }
<a name="l06620"></a>06620 
<a name="l06621"></a>06621 
<a name="l06622"></a>06622 <span class="comment">/* XXX this does not check that multiple contexts are merged */</span>
<a name="l06623"></a><a class="code" href="pbx_8c.html#a833a703b21d8f6bcb9f68e57185bca67">06623</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8h.html#a833a703b21d8f6bcb9f68e57185bca67" title="Merge the temporary contexts into a global contexts list and delete from the global...">ast_merge_contexts_and_delete</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> **extcontexts, <span class="keyword">struct</span> <a class="code" href="structast__hashtab.html">ast_hashtab</a> *exttable, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l06624"></a>06624 {
<a name="l06625"></a>06625    <span class="keywordtype">double</span> ft;
<a name="l06626"></a>06626    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *tmp, *oldcontextslist;
<a name="l06627"></a>06627    <span class="keyword">struct </span><a class="code" href="structast__hashtab.html">ast_hashtab</a> *oldtable;
<a name="l06628"></a>06628    <span class="keyword">struct </span><a class="code" href="structstore__hints.html">store_hints</a> store = <a class="code" href="linkedlists_8h.html#a312e85d30d91d1db3ad0573c37c3f0cf" title="Defines initial values for a declaration of AST_LIST_HEAD.">AST_LIST_HEAD_INIT_VALUE</a>;
<a name="l06629"></a>06629    <span class="keyword">struct </span><a class="code" href="structstore__hint.html">store_hint</a> *<span class="keyword">this</span>;
<a name="l06630"></a>06630    <span class="keyword">struct </span>ast_hint *hint;
<a name="l06631"></a>06631    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *exten;
<a name="l06632"></a>06632    <span class="keywordtype">int</span> length;
<a name="l06633"></a>06633    <span class="keyword">struct </span>ast_state_cb *thiscb;
<a name="l06634"></a>06634    <span class="keyword">struct </span><a class="code" href="structast__hashtab__iter.html" title="an iterator for traversing the buckets">ast_hashtab_iter</a> *iter;
<a name="l06635"></a>06635 
<a name="l06636"></a>06636    <span class="comment">/* it is very important that this function hold the hint list lock _and_ the conlock</span>
<a name="l06637"></a>06637 <span class="comment">      during its operation; not only do we need to ensure that the list of contexts</span>
<a name="l06638"></a>06638 <span class="comment">      and extensions does not change, but also that no hint callbacks (watchers) are</span>
<a name="l06639"></a>06639 <span class="comment">      added or removed during the merge/delete process</span>
<a name="l06640"></a>06640 <span class="comment"></span>
<a name="l06641"></a>06641 <span class="comment">      in addition, the locks _must_ be taken in this order, because there are already</span>
<a name="l06642"></a>06642 <span class="comment">      other code paths that use this order</span>
<a name="l06643"></a>06643 <span class="comment">   */</span>
<a name="l06644"></a>06644 
<a name="l06645"></a>06645    <span class="keyword">struct </span>timeval begintime, writelocktime, endlocktime, enddeltime;
<a name="l06646"></a>06646    <span class="keywordtype">int</span> wrlock_ver;
<a name="l06647"></a>06647 
<a name="l06648"></a>06648    begintime = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l06649"></a>06649    <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>();
<a name="l06650"></a>06650    iter = <a class="code" href="hashtab_8h.html#ac5a19bffadbbd4eb31f190e576f88512" title="Gives an iterator to hastable.">ast_hashtab_start_traversal</a>(<a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>);
<a name="l06651"></a>06651    <span class="keywordflow">while</span> ((tmp = <a class="code" href="hashtab_8h.html#a43983b6169e9a0f9af48cca5cf9d3197" title="Gets the next object in the list, advances iter one step returns null on end of traversal...">ast_hashtab_next</a>(iter))) {
<a name="l06652"></a>06652       <a class="code" href="pbx_8c.html#a68752b8c650f91f9f3e36d6ce36bba2e">context_merge</a>(extcontexts, exttable, tmp, registrar);
<a name="l06653"></a>06653    }
<a name="l06654"></a>06654    <a class="code" href="hashtab_8h.html#a9c804e9bfc8355c25197187f0c6d0265" title="end the traversal, free the iterator, unlock if necc.">ast_hashtab_end_traversal</a>(iter);
<a name="l06655"></a>06655    wrlock_ver = <a class="code" href="pbx_8h.html#a4e6adb9c7783644ea993758d9c7e28c8">ast_wrlock_contexts_version</a>();
<a name="l06656"></a>06656 
<a name="l06657"></a>06657    <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>(); <span class="comment">/* this feels real retarded, but you must do</span>
<a name="l06658"></a>06658 <span class="comment">                       what you must do If this isn&apos;t done, the following </span>
<a name="l06659"></a>06659 <span class="comment">                        wrlock is a guraranteed deadlock */</span>
<a name="l06660"></a>06660    <a class="code" href="pbx_8h.html#a18c87dac5f7f4368c11b67d8026adc22" title="Write locks the context list.">ast_wrlock_contexts</a>();
<a name="l06661"></a>06661    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a4e6adb9c7783644ea993758d9c7e28c8">ast_wrlock_contexts_version</a>() &gt; wrlock_ver+1) {
<a name="l06662"></a>06662       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,<span class="stringliteral">&quot;==================!!!!!!!!!!!!!!!Something changed the contexts in the middle of merging contexts!\n&quot;</span>);
<a name="l06663"></a>06663    }
<a name="l06664"></a>06664 
<a name="l06665"></a>06665    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l06666"></a>06666    writelocktime = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l06667"></a>06667 
<a name="l06668"></a>06668    <span class="comment">/* preserve all watchers for hints */</span>
<a name="l06669"></a>06669    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structhints.html">hints</a>, hint, list) {
<a name="l06670"></a>06670       <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;hint-&gt;<a class="code" href="structast__hint.html#aa3e3352bf7668925eba2e02ccdaf017a">callbacks</a>)) {
<a name="l06671"></a>06671          length = strlen(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>) + strlen(hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a7733606f3f625c2782402ba971995641">parent</a>-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>) + 2 + <span class="keyword">sizeof</span>(*this);
<a name="l06672"></a>06672          <span class="keywordflow">if</span> (!(<span class="keyword">this</span> = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, length)))
<a name="l06673"></a>06673             <span class="keywordflow">continue</span>;
<a name="l06674"></a>06674          <span class="comment">/* this removes all the callbacks from the hint into this. */</span>
<a name="l06675"></a>06675          <a class="code" href="linkedlists_8h.html#ad66405f1d0b9e1fb484643d9a36e94ed" title="Appends a whole list to the tail of a list.">AST_LIST_APPEND_LIST</a>(&amp;this-&gt;callbacks, &amp;hint-&gt;<a class="code" href="structast__hint.html#aa3e3352bf7668925eba2e02ccdaf017a">callbacks</a>, entry);
<a name="l06676"></a>06676          this-&gt;laststate = hint-&gt;<a class="code" href="structast__hint.html#a0078d2e3ae10f15d7634c01199f33d4f">laststate</a>;
<a name="l06677"></a>06677          this-&gt;context = this-&gt;data;
<a name="l06678"></a>06678          strcpy(this-&gt;data, hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a7733606f3f625c2782402ba971995641">parent</a>-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l06679"></a>06679          this-&gt;exten = this-&gt;data + strlen(this-&gt;context) + 1;
<a name="l06680"></a>06680          strcpy(this-&gt;exten, hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l06681"></a>06681          <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;store, <span class="keyword">this</span>, list);
<a name="l06682"></a>06682       }
<a name="l06683"></a>06683    }
<a name="l06684"></a>06684 
<a name="l06685"></a>06685    <span class="comment">/* save the old table and list */</span>
<a name="l06686"></a>06686    oldtable = <a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>;
<a name="l06687"></a>06687    oldcontextslist = <a class="code" href="pbx_8c.html#aae85d5aab50f2d1b8392d6df276f2561">contexts</a>;
<a name="l06688"></a>06688 
<a name="l06689"></a>06689    <span class="comment">/* move in the new table and list */</span>
<a name="l06690"></a>06690    <a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a> = exttable;
<a name="l06691"></a>06691    <a class="code" href="pbx_8c.html#aae85d5aab50f2d1b8392d6df276f2561">contexts</a> = *extcontexts;
<a name="l06692"></a>06692 
<a name="l06693"></a>06693    <span class="comment">/* restore the watchers for hints that can be found; notify those that</span>
<a name="l06694"></a>06694 <span class="comment">      cannot be restored</span>
<a name="l06695"></a>06695 <span class="comment">   */</span>
<a name="l06696"></a>06696    <span class="keywordflow">while</span> ((<span class="keyword">this</span> = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;store, list))) {
<a name="l06697"></a>06697       <span class="keyword">struct </span><a class="code" href="structpbx__find__info.html">pbx_find_info</a> q = { .<a class="code" href="structpbx__find__info.html#a31dd453024f17e9e35717368cf8c87fb">stacklen</a> = 0 };
<a name="l06698"></a>06698       exten = <a class="code" href="pbx_8h.html#a63e03245dc48558e55da8890b3dbb87e">pbx_find_extension</a>(NULL, NULL, &amp;q, this-&gt;context, this-&gt;exten, <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>, NULL, <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea2e605157e82dec388ffc89c1694fb7be">E_MATCH</a>);
<a name="l06699"></a>06699       <span class="comment">/* If this is a pattern, dynamically create a new extension for this</span>
<a name="l06700"></a>06700 <span class="comment">       * particular match.  Note that this will only happen once for each</span>
<a name="l06701"></a>06701 <span class="comment">       * individual extension, because the pattern will no longer match first.</span>
<a name="l06702"></a>06702 <span class="comment">       */</span>
<a name="l06703"></a>06703       <span class="keywordflow">if</span> (exten &amp;&amp; exten-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>[0] == <span class="charliteral">&apos;_&apos;</span>) {
<a name="l06704"></a>06704          <a class="code" href="pbx_8c.html#a62350bf22ada5eec5dcb16986c1909b9">ast_add_extension_nolock</a>(exten-&gt;<a class="code" href="structast__exten.html#a7733606f3f625c2782402ba971995641">parent</a>-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, 0, this-&gt;exten, <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>, NULL,
<a name="l06705"></a>06705             0, exten-&gt;<a class="code" href="structast__exten.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">app</a>, <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(exten-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a>), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, exten-&gt;<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>);
<a name="l06706"></a>06706          <span class="comment">/* rwlocks are not recursive locks */</span>
<a name="l06707"></a>06707          exten = <a class="code" href="pbx_8c.html#ad121506517c1a92626d906f787f17358" title="Find hint for given extension in context.">ast_hint_extension_nolock</a>(NULL, this-&gt;context, this-&gt;exten);
<a name="l06708"></a>06708       }
<a name="l06709"></a>06709 
<a name="l06710"></a>06710       <span class="comment">/* Find the hint in the list of hints */</span>
<a name="l06711"></a>06711       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structhints.html">hints</a>, hint, list) {
<a name="l06712"></a>06712          <span class="keywordflow">if</span> (hint-&gt;<a class="code" href="structast__hint.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> == exten)
<a name="l06713"></a>06713             <span class="keywordflow">break</span>;
<a name="l06714"></a>06714       }
<a name="l06715"></a>06715       <span class="keywordflow">if</span> (!exten || !hint) {
<a name="l06716"></a>06716          <span class="comment">/* this hint has been removed, notify the watchers */</span>
<a name="l06717"></a>06717          <span class="keywordflow">while</span> ((thiscb = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;this-&gt;callbacks, entry))) {
<a name="l06718"></a>06718             thiscb-&gt;<a class="code" href="structast__state__cb.html#a51f35e8871a0e589626a6c24024a2e17">callback</a>(this-&gt;context, this-&gt;exten, <a class="code" href="pbx_8h.html#a7e545df4a5f38ef25616c7bdf55d625fa3e2a2f5572580f74e94b6d5e80261ea7">AST_EXTENSION_REMOVED</a>, thiscb-&gt;<a class="code" href="structast__state__cb.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l06719"></a>06719             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(thiscb);
<a name="l06720"></a>06720          }
<a name="l06721"></a>06721       } <span class="keywordflow">else</span> {
<a name="l06722"></a>06722          <a class="code" href="linkedlists_8h.html#ad66405f1d0b9e1fb484643d9a36e94ed" title="Appends a whole list to the tail of a list.">AST_LIST_APPEND_LIST</a>(&amp;hint-&gt;<a class="code" href="structast__hint.html#aa3e3352bf7668925eba2e02ccdaf017a">callbacks</a>, &amp;this-&gt;<a class="code" href="structast__hint.html#aa3e3352bf7668925eba2e02ccdaf017a">callbacks</a>, entry);
<a name="l06723"></a>06723          hint-&gt;<a class="code" href="structast__hint.html#a0078d2e3ae10f15d7634c01199f33d4f">laststate</a> = this-&gt;laststate;
<a name="l06724"></a>06724       }
<a name="l06725"></a>06725       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<span class="keyword">this</span>);
<a name="l06726"></a>06726    }
<a name="l06727"></a>06727 
<a name="l06728"></a>06728    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhints.html">hints</a>);
<a name="l06729"></a>06729    <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l06730"></a>06730    endlocktime = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l06731"></a>06731 
<a name="l06732"></a>06732    <span class="comment">/* the old list and hashtab no longer are relevant, delete them while the rest of asterisk</span>
<a name="l06733"></a>06733 <span class="comment">      is now freely using the new stuff instead */</span>
<a name="l06734"></a>06734 
<a name="l06735"></a>06735    <a class="code" href="hashtab_8h.html#a6103589badf8d9440a0cece2802c4c3a" title="This func will free the hash table and all its memory.">ast_hashtab_destroy</a>(oldtable, NULL);
<a name="l06736"></a>06736 
<a name="l06737"></a>06737    <span class="keywordflow">for</span> (tmp = oldcontextslist; tmp; ) {
<a name="l06738"></a>06738       <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="structast__sw.html#a9dba44603dc55a347a5cbe388aeac9f0">next</a>;  <span class="comment">/* next starting point */</span>
<a name="l06739"></a>06739       next = tmp-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a>;
<a name="l06740"></a>06740       <a class="code" href="pbx_8c.html#af51adb9b78f628397d7b0c1781b6d79e">__ast_internal_context_destroy</a>(tmp);
<a name="l06741"></a>06741       tmp = next;
<a name="l06742"></a>06742    }
<a name="l06743"></a>06743    enddeltime = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l06744"></a>06744 
<a name="l06745"></a>06745    ft = <a class="code" href="time_8h.html#a140711bcdd1612c6baafc3e92c54caa1" title="Computes the difference (in microseconds) between two struct timeval instances.">ast_tvdiff_us</a>(writelocktime, begintime);
<a name="l06746"></a>06746    ft /= 1000000.0;
<a name="l06747"></a>06747    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3,<span class="stringliteral">&quot;Time to scan old dialplan and merge leftovers back into the new: %8.6f sec\n&quot;</span>, ft);
<a name="l06748"></a>06748 
<a name="l06749"></a>06749    ft = <a class="code" href="time_8h.html#a140711bcdd1612c6baafc3e92c54caa1" title="Computes the difference (in microseconds) between two struct timeval instances.">ast_tvdiff_us</a>(endlocktime, writelocktime);
<a name="l06750"></a>06750    ft /= 1000000.0;
<a name="l06751"></a>06751    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3,<span class="stringliteral">&quot;Time to restore hints and swap in new dialplan: %8.6f sec\n&quot;</span>, ft);
<a name="l06752"></a>06752 
<a name="l06753"></a>06753    ft = <a class="code" href="time_8h.html#a140711bcdd1612c6baafc3e92c54caa1" title="Computes the difference (in microseconds) between two struct timeval instances.">ast_tvdiff_us</a>(enddeltime, endlocktime);
<a name="l06754"></a>06754    ft /= 1000000.0;
<a name="l06755"></a>06755    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3,<span class="stringliteral">&quot;Time to delete the old dialplan: %8.6f sec\n&quot;</span>, ft);
<a name="l06756"></a>06756 
<a name="l06757"></a>06757    ft = <a class="code" href="time_8h.html#a140711bcdd1612c6baafc3e92c54caa1" title="Computes the difference (in microseconds) between two struct timeval instances.">ast_tvdiff_us</a>(enddeltime, begintime);
<a name="l06758"></a>06758    ft /= 1000000.0;
<a name="l06759"></a>06759    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3,<span class="stringliteral">&quot;Total time merge_contexts_delete: %8.6f sec\n&quot;</span>, ft);
<a name="l06760"></a>06760    <span class="keywordflow">return</span>;
<a name="l06761"></a>06761 }
<a name="l06762"></a>06762 
<a name="l06763"></a>06763 <span class="comment">/*</span>
<a name="l06764"></a>06764 <span class="comment"> * errno values</span>
<a name="l06765"></a>06765 <span class="comment"> *  EBUSY  - can&apos;t lock</span>
<a name="l06766"></a>06766 <span class="comment"> *  ENOENT - no existence of context</span>
<a name="l06767"></a>06767 <span class="comment"> */</span>
<a name="l06768"></a><a class="code" href="pbx_8c.html#a3903111827b675ec313e56a28ac80cf9">06768</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a3903111827b675ec313e56a28ac80cf9" title="Add a context include.">ast_context_add_include</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *include, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l06769"></a>06769 {
<a name="l06770"></a>06770    <span class="keywordtype">int</span> ret = -1;
<a name="l06771"></a>06771    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = <a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e" title="lookup for a context with a given name,">find_context_locked</a>(context);
<a name="l06772"></a>06772 
<a name="l06773"></a>06773    <span class="keywordflow">if</span> (c) {
<a name="l06774"></a>06774       ret = <a class="code" href="pbx_8h.html#aceaa74fb91df5e8f7892f59953ff6283" title="Add a context include.">ast_context_add_include2</a>(c, include, registrar);
<a name="l06775"></a>06775       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l06776"></a>06776    }
<a name="l06777"></a>06777    <span class="keywordflow">return</span> ret;
<a name="l06778"></a>06778 }
<a name="l06779"></a>06779 <span class="comment"></span>
<a name="l06780"></a>06780 <span class="comment">/*! \brief Helper for get_range.</span>
<a name="l06781"></a>06781 <span class="comment"> * return the index of the matching entry, starting from 1.</span>
<a name="l06782"></a>06782 <span class="comment"> * If names is not supplied, try numeric values.</span>
<a name="l06783"></a>06783 <span class="comment"> */</span>
<a name="l06784"></a><a class="code" href="pbx_8c.html#a0516dabfdacca8be905322314b4dd2cf">06784</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a0516dabfdacca8be905322314b4dd2cf" title="Helper for get_range. return the index of the matching entry, starting from 1. If...">lookup_name</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">char</span> *<span class="keyword">const</span> names[], <span class="keywordtype">int</span> max)
<a name="l06785"></a>06785 {
<a name="l06786"></a>06786    <span class="keywordtype">int</span> i;
<a name="l06787"></a>06787 
<a name="l06788"></a>06788    <span class="keywordflow">if</span> (names &amp;&amp; *s &gt; <span class="charliteral">&apos;9&apos;</span>) {
<a name="l06789"></a>06789       <span class="keywordflow">for</span> (i = 0; names[i]; i++) {
<a name="l06790"></a>06790          <span class="keywordflow">if</span> (!strcasecmp(s, names[i])) {
<a name="l06791"></a>06791             <span class="keywordflow">return</span> i;
<a name="l06792"></a>06792          }
<a name="l06793"></a>06793       }
<a name="l06794"></a>06794    }
<a name="l06795"></a>06795 
<a name="l06796"></a>06796    <span class="comment">/* Allow months and weekdays to be specified as numbers, as well */</span>
<a name="l06797"></a>06797    <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">&quot;%2d&quot;</span>, &amp;i) == 1 &amp;&amp; i &gt;= 1 &amp;&amp; i &lt;= max) {
<a name="l06798"></a>06798       <span class="comment">/* What the array offset would have been: &quot;1&quot; would be at offset 0 */</span>
<a name="l06799"></a>06799       <span class="keywordflow">return</span> i - 1;
<a name="l06800"></a>06800    }
<a name="l06801"></a>06801    <span class="keywordflow">return</span> -1; <span class="comment">/* error return */</span>
<a name="l06802"></a>06802 }
<a name="l06803"></a>06803 <span class="comment"></span>
<a name="l06804"></a>06804 <span class="comment">/*! \brief helper function to return a range up to max (7, 12, 31 respectively).</span>
<a name="l06805"></a>06805 <span class="comment"> * names, if supplied, is an array of names that should be mapped to numbers.</span>
<a name="l06806"></a>06806 <span class="comment"> */</span>
<a name="l06807"></a><a class="code" href="pbx_8c.html#a77d85ac80b9171604f30e87a2382cdd0">06807</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <a class="code" href="pbx_8c.html#a77d85ac80b9171604f30e87a2382cdd0" title="helper function to return a range up to max (7, 12, 31 respectively). names, if supplied...">get_range</a>(<span class="keywordtype">char</span> *src, <span class="keywordtype">int</span> max, <span class="keywordtype">char</span> *<span class="keyword">const</span> names[], <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)
<a name="l06808"></a>06808 {
<a name="l06809"></a>06809    <span class="keywordtype">int</span> start, end; <span class="comment">/* start and ending position */</span>
<a name="l06810"></a>06810    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mask = 0;
<a name="l06811"></a>06811    <span class="keywordtype">char</span> *part;
<a name="l06812"></a>06812 
<a name="l06813"></a>06813    <span class="comment">/* Check for whole range */</span>
<a name="l06814"></a>06814    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(src) || !strcmp(src, <span class="stringliteral">&quot;*&quot;</span>)) {
<a name="l06815"></a>06815       <span class="keywordflow">return</span> (1 &lt;&lt; max) - 1;
<a name="l06816"></a>06816    }
<a name="l06817"></a>06817 
<a name="l06818"></a>06818    <span class="keywordflow">while</span> ((part = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;src, <span class="stringliteral">&quot;&amp;&quot;</span>))) {
<a name="l06819"></a>06819       <span class="comment">/* Get start and ending position */</span>
<a name="l06820"></a>06820       <span class="keywordtype">char</span> *endpart = strchr(part, <span class="charliteral">&apos;-&apos;</span>);
<a name="l06821"></a>06821       <span class="keywordflow">if</span> (endpart) {
<a name="l06822"></a>06822          *endpart++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l06823"></a>06823       }
<a name="l06824"></a>06824       <span class="comment">/* Find the start */</span>
<a name="l06825"></a>06825       <span class="keywordflow">if</span> ((start = <a class="code" href="pbx_8c.html#a0516dabfdacca8be905322314b4dd2cf" title="Helper for get_range. return the index of the matching entry, starting from 1. If...">lookup_name</a>(part, names, max)) &lt; 0) {
<a name="l06826"></a>06826          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid %s &apos;%s&apos;, skipping element\n&quot;</span>, msg, part);
<a name="l06827"></a>06827          <span class="keywordflow">continue</span>;
<a name="l06828"></a>06828       }
<a name="l06829"></a>06829       <span class="keywordflow">if</span> (endpart) { <span class="comment">/* find end of range */</span>
<a name="l06830"></a>06830          <span class="keywordflow">if</span> ((end = <a class="code" href="pbx_8c.html#a0516dabfdacca8be905322314b4dd2cf" title="Helper for get_range. return the index of the matching entry, starting from 1. If...">lookup_name</a>(endpart, names, max)) &lt; 0) {
<a name="l06831"></a>06831             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid end %s &apos;%s&apos;, skipping element\n&quot;</span>, msg, endpart);
<a name="l06832"></a>06832             <span class="keywordflow">continue</span>;
<a name="l06833"></a>06833          }
<a name="l06834"></a>06834       } <span class="keywordflow">else</span> {
<a name="l06835"></a>06835          end = start;
<a name="l06836"></a>06836       }
<a name="l06837"></a>06837       <span class="comment">/* Fill the mask. Remember that ranges are cyclic */</span>
<a name="l06838"></a>06838       mask |= (1 &lt;&lt; end);   <span class="comment">/* initialize with last element */</span>
<a name="l06839"></a>06839       <span class="keywordflow">while</span> (start != end) {
<a name="l06840"></a>06840          mask |= (1 &lt;&lt; start);
<a name="l06841"></a>06841          <span class="keywordflow">if</span> (++start &gt;= max) {
<a name="l06842"></a>06842             start = 0;
<a name="l06843"></a>06843          }
<a name="l06844"></a>06844       }
<a name="l06845"></a>06845    }
<a name="l06846"></a>06846    <span class="keywordflow">return</span> mask;
<a name="l06847"></a>06847 }
<a name="l06848"></a>06848 <span class="comment"></span>
<a name="l06849"></a>06849 <span class="comment">/*! \brief store a bitmask of valid times, one bit each 1 minute */</span>
<a name="l06850"></a><a class="code" href="pbx_8c.html#a75160d417c742f4c432dbccbc6d14d4a">06850</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a75160d417c742f4c432dbccbc6d14d4a" title="store a bitmask of valid times, one bit each 1 minute">get_timerange</a>(<span class="keyword">struct</span> <a class="code" href="structast__timing.html">ast_timing</a> *i, <span class="keywordtype">char</span> *times)
<a name="l06851"></a>06851 {
<a name="l06852"></a>06852    <span class="keywordtype">char</span> *endpart, *part;
<a name="l06853"></a>06853    <span class="keywordtype">int</span> x;
<a name="l06854"></a>06854    <span class="keywordtype">int</span> st_h, st_m;
<a name="l06855"></a>06855    <span class="keywordtype">int</span> endh, endm;
<a name="l06856"></a>06856    <span class="keywordtype">int</span> minute_start, minute_end;
<a name="l06857"></a>06857 
<a name="l06858"></a>06858    <span class="comment">/* start disabling all times, fill the fields with 0&apos;s, as they may contain garbage */</span>
<a name="l06859"></a>06859    memset(i-&gt;<a class="code" href="structast__timing.html#a51894ab93df62f69a337f1703444c872">minmask</a>, 0, <span class="keyword">sizeof</span>(i-&gt;<a class="code" href="structast__timing.html#a51894ab93df62f69a337f1703444c872">minmask</a>));
<a name="l06860"></a>06860 
<a name="l06861"></a>06861    <span class="comment">/* 1-minute per bit */</span>
<a name="l06862"></a>06862    <span class="comment">/* Star is all times */</span>
<a name="l06863"></a>06863    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(times) || !strcmp(times, <span class="stringliteral">&quot;*&quot;</span>)) {
<a name="l06864"></a>06864       <span class="comment">/* 48, because each hour takes 2 integers; 30 bits each */</span>
<a name="l06865"></a>06865       <span class="keywordflow">for</span> (x = 0; x &lt; 48; x++) {
<a name="l06866"></a>06866          i-&gt;<a class="code" href="structast__timing.html#a51894ab93df62f69a337f1703444c872">minmask</a>[x] = 0x3fffffff; <span class="comment">/* 30 bits */</span>
<a name="l06867"></a>06867       }
<a name="l06868"></a>06868       <span class="keywordflow">return</span>;
<a name="l06869"></a>06869    }
<a name="l06870"></a>06870    <span class="comment">/* Otherwise expect a range */</span>
<a name="l06871"></a>06871    <span class="keywordflow">while</span> ((part = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;times, <span class="stringliteral">&quot;&amp;&quot;</span>))) {
<a name="l06872"></a>06872       <span class="keywordflow">if</span> (!(endpart = strchr(part, <span class="charliteral">&apos;-&apos;</span>))) {
<a name="l06873"></a>06873          <span class="keywordflow">if</span> (sscanf(part, <span class="stringliteral">&quot;%2d:%2d&quot;</span>, &amp;st_h, &amp;st_m) != 2 || st_h &lt; 0 || st_h &gt; 23 || st_m &lt; 0 || st_m &gt; 59) {
<a name="l06874"></a>06874             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s isn&apos;t a valid time.\n&quot;</span>, part);
<a name="l06875"></a>06875             <span class="keywordflow">continue</span>;
<a name="l06876"></a>06876          }
<a name="l06877"></a>06877          i-&gt;<a class="code" href="structast__timing.html#a51894ab93df62f69a337f1703444c872">minmask</a>[st_h * 2 + (st_m &gt;= 30 ? 1 : 0)] |= (1 &lt;&lt; (st_m % 30));
<a name="l06878"></a>06878          <span class="keywordflow">continue</span>;
<a name="l06879"></a>06879       }
<a name="l06880"></a>06880       *endpart++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l06881"></a>06881       <span class="comment">/* why skip non digits? Mostly to skip spaces */</span>
<a name="l06882"></a>06882       <span class="keywordflow">while</span> (*endpart &amp;&amp; !isdigit(*endpart)) {
<a name="l06883"></a>06883          endpart++;
<a name="l06884"></a>06884       }
<a name="l06885"></a>06885       <span class="keywordflow">if</span> (!*endpart) {
<a name="l06886"></a>06886          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid time range starting with &apos;%s-&apos;.\n&quot;</span>, part);
<a name="l06887"></a>06887          <span class="keywordflow">continue</span>;
<a name="l06888"></a>06888       }
<a name="l06889"></a>06889       <span class="keywordflow">if</span> (sscanf(part, <span class="stringliteral">&quot;%2d:%2d&quot;</span>, &amp;st_h, &amp;st_m) != 2 || st_h &lt; 0 || st_h &gt; 23 || st_m &lt; 0 || st_m &gt; 59) {
<a name="l06890"></a>06890          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;&apos;%s&apos; isn&apos;t a valid start time.\n&quot;</span>, part);
<a name="l06891"></a>06891          <span class="keywordflow">continue</span>;
<a name="l06892"></a>06892       }
<a name="l06893"></a>06893       <span class="keywordflow">if</span> (sscanf(endpart, <span class="stringliteral">&quot;%2d:%2d&quot;</span>, &amp;endh, &amp;endm) != 2 || endh &lt; 0 || endh &gt; 23 || endm &lt; 0 || endm &gt; 59) {
<a name="l06894"></a>06894          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;&apos;%s&apos; isn&apos;t a valid end time.\n&quot;</span>, endpart);
<a name="l06895"></a>06895          <span class="keywordflow">continue</span>;
<a name="l06896"></a>06896       }
<a name="l06897"></a>06897       minute_start = st_h * 60 + st_m;
<a name="l06898"></a>06898       minute_end = endh * 60 + endm;
<a name="l06899"></a>06899       <span class="comment">/* Go through the time and enable each appropriate bit */</span>
<a name="l06900"></a>06900       <span class="keywordflow">for</span> (x = minute_start; x != minute_end; x = (x + 1) % (24 * 60)) {
<a name="l06901"></a>06901          i-&gt;<a class="code" href="structast__timing.html#a51894ab93df62f69a337f1703444c872">minmask</a>[x / 30] |= (1 &lt;&lt; (x % 30));
<a name="l06902"></a>06902       }
<a name="l06903"></a>06903       <span class="comment">/* Do the last one */</span>
<a name="l06904"></a>06904       i-&gt;<a class="code" href="structast__timing.html#a51894ab93df62f69a337f1703444c872">minmask</a>[x / 30] |= (1 &lt;&lt; (x % 30));
<a name="l06905"></a>06905    }
<a name="l06906"></a>06906    <span class="comment">/* All done */</span>
<a name="l06907"></a>06907    <span class="keywordflow">return</span>;
<a name="l06908"></a>06908 }
<a name="l06909"></a>06909 
<a name="l06910"></a><a class="code" href="pbx_8c.html#a0cf0c4efde69b8309ac3a154d157d7ea">06910</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a0cf0c4efde69b8309ac3a154d157d7ea">days</a>[] =
<a name="l06911"></a>06911 {
<a name="l06912"></a>06912    <span class="stringliteral">&quot;sun&quot;</span>,
<a name="l06913"></a>06913    <span class="stringliteral">&quot;mon&quot;</span>,
<a name="l06914"></a>06914    <span class="stringliteral">&quot;tue&quot;</span>,
<a name="l06915"></a>06915    <span class="stringliteral">&quot;wed&quot;</span>,
<a name="l06916"></a>06916    <span class="stringliteral">&quot;thu&quot;</span>,
<a name="l06917"></a>06917    <span class="stringliteral">&quot;fri&quot;</span>,
<a name="l06918"></a>06918    <span class="stringliteral">&quot;sat&quot;</span>,
<a name="l06919"></a>06919    NULL,
<a name="l06920"></a>06920 };
<a name="l06921"></a>06921 
<a name="l06922"></a><a class="code" href="pbx_8c.html#a9878e6d5a52b0b77dd7857ae80601910">06922</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8c.html#a9878e6d5a52b0b77dd7857ae80601910">months</a>[] =
<a name="l06923"></a>06923 {
<a name="l06924"></a>06924    <span class="stringliteral">&quot;jan&quot;</span>,
<a name="l06925"></a>06925    <span class="stringliteral">&quot;feb&quot;</span>,
<a name="l06926"></a>06926    <span class="stringliteral">&quot;mar&quot;</span>,
<a name="l06927"></a>06927    <span class="stringliteral">&quot;apr&quot;</span>,
<a name="l06928"></a>06928    <span class="stringliteral">&quot;may&quot;</span>,
<a name="l06929"></a>06929    <span class="stringliteral">&quot;jun&quot;</span>,
<a name="l06930"></a>06930    <span class="stringliteral">&quot;jul&quot;</span>,
<a name="l06931"></a>06931    <span class="stringliteral">&quot;aug&quot;</span>,
<a name="l06932"></a>06932    <span class="stringliteral">&quot;sep&quot;</span>,
<a name="l06933"></a>06933    <span class="stringliteral">&quot;oct&quot;</span>,
<a name="l06934"></a>06934    <span class="stringliteral">&quot;nov&quot;</span>,
<a name="l06935"></a>06935    <span class="stringliteral">&quot;dec&quot;</span>,
<a name="l06936"></a>06936    NULL,
<a name="l06937"></a>06937 };
<a name="l06938"></a>06938 
<a name="l06939"></a><a class="code" href="pbx_8c.html#a04c290d1ad80a377481175f85697cd40">06939</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a018549fd5d5470b676da92f6034b7347" title="Construct a timing bitmap, for use in time-based conditionals.">ast_build_timing</a>(<span class="keyword">struct</span> <a class="code" href="structast__timing.html">ast_timing</a> *i, <span class="keyword">const</span> <span class="keywordtype">char</span> *info_in)
<a name="l06940"></a>06940 {
<a name="l06941"></a>06941    <span class="keywordtype">char</span> *info_save, *info;
<a name="l06942"></a>06942    <span class="keywordtype">int</span> j, num_fields, last_sep = -1;
<a name="l06943"></a>06943 
<a name="l06944"></a>06944    <span class="comment">/* Check for empty just in case */</span>
<a name="l06945"></a>06945    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(info_in)) {
<a name="l06946"></a>06946       <span class="keywordflow">return</span> 0;
<a name="l06947"></a>06947    }
<a name="l06948"></a>06948 
<a name="l06949"></a>06949    <span class="comment">/* make a copy just in case we were passed a static string */</span>
<a name="l06950"></a>06950    info_save = info = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(info_in);
<a name="l06951"></a>06951 
<a name="l06952"></a>06952    <span class="comment">/* count the number of fields in the timespec */</span>
<a name="l06953"></a>06953    <span class="keywordflow">for</span> (j = 0, num_fields = 1; info[j] != <span class="charliteral">&apos;\0&apos;</span>; j++) {
<a name="l06954"></a>06954       <span class="keywordflow">if</span> (info[j] == <span class="charliteral">&apos;,&apos;</span>) {
<a name="l06955"></a>06955          last_sep = j;
<a name="l06956"></a>06956          num_fields++;
<a name="l06957"></a>06957       }
<a name="l06958"></a>06958    }
<a name="l06959"></a>06959 
<a name="l06960"></a>06960    <span class="comment">/* save the timezone, if it is specified */</span>
<a name="l06961"></a>06961    <span class="keywordflow">if</span> (num_fields == 5) {
<a name="l06962"></a>06962       i-&gt;<a class="code" href="structast__timing.html#a18b6f7534e9068b65611571b05db0eee">timezone</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(info + last_sep + 1);
<a name="l06963"></a>06963    } <span class="keywordflow">else</span> {
<a name="l06964"></a>06964       i-&gt;<a class="code" href="structast__timing.html#a18b6f7534e9068b65611571b05db0eee">timezone</a> = NULL;
<a name="l06965"></a>06965    }
<a name="l06966"></a>06966 
<a name="l06967"></a>06967    <span class="comment">/* Assume everything except time */</span>
<a name="l06968"></a>06968    i-&gt;<a class="code" href="structast__timing.html#a3fdc5726e142f466b67b8feea4da21cf">monthmask</a> = 0xfff;   <span class="comment">/* 12 bits */</span>
<a name="l06969"></a>06969    i-&gt;<a class="code" href="structast__timing.html#a53851cc9d2020ded355f2a52e0d32238">daymask</a> = 0x7fffffffU; <span class="comment">/* 31 bits */</span>
<a name="l06970"></a>06970    i-&gt;<a class="code" href="structast__timing.html#a88d1a72894c612b57b2d2160f8ffadce">dowmask</a> = 0x7f; <span class="comment">/* 7 bits */</span>
<a name="l06971"></a>06971    <span class="comment">/* on each call, use strsep() to move info to the next argument */</span>
<a name="l06972"></a>06972    <a class="code" href="pbx_8c.html#a75160d417c742f4c432dbccbc6d14d4a" title="store a bitmask of valid times, one bit each 1 minute">get_timerange</a>(i, <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;info, <span class="stringliteral">&quot;|,&quot;</span>));
<a name="l06973"></a>06973    <span class="keywordflow">if</span> (info)
<a name="l06974"></a>06974       i-&gt;<a class="code" href="structast__timing.html#a88d1a72894c612b57b2d2160f8ffadce">dowmask</a> = <a class="code" href="pbx_8c.html#a77d85ac80b9171604f30e87a2382cdd0" title="helper function to return a range up to max (7, 12, 31 respectively). names, if supplied...">get_range</a>(<a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;info, <span class="stringliteral">&quot;|,&quot;</span>), 7, <a class="code" href="pbx_8c.html#a0cf0c4efde69b8309ac3a154d157d7ea">days</a>, <span class="stringliteral">&quot;day of week&quot;</span>);
<a name="l06975"></a>06975    <span class="keywordflow">if</span> (info)
<a name="l06976"></a>06976       i-&gt;<a class="code" href="structast__timing.html#a53851cc9d2020ded355f2a52e0d32238">daymask</a> = <a class="code" href="pbx_8c.html#a77d85ac80b9171604f30e87a2382cdd0" title="helper function to return a range up to max (7, 12, 31 respectively). names, if supplied...">get_range</a>(<a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;info, <span class="stringliteral">&quot;|,&quot;</span>), 31, NULL, <span class="stringliteral">&quot;day&quot;</span>);
<a name="l06977"></a>06977    <span class="keywordflow">if</span> (info)
<a name="l06978"></a>06978       i-&gt;<a class="code" href="structast__timing.html#a3fdc5726e142f466b67b8feea4da21cf">monthmask</a> = <a class="code" href="pbx_8c.html#a77d85ac80b9171604f30e87a2382cdd0" title="helper function to return a range up to max (7, 12, 31 respectively). names, if supplied...">get_range</a>(<a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;info, <span class="stringliteral">&quot;|,&quot;</span>), 12, <a class="code" href="pbx_8c.html#a9878e6d5a52b0b77dd7857ae80601910">months</a>, <span class="stringliteral">&quot;month&quot;</span>);
<a name="l06979"></a>06979    <span class="keywordflow">return</span> 1;
<a name="l06980"></a>06980 }
<a name="l06981"></a>06981 
<a name="l06982"></a><a class="code" href="pbx_8c.html#a17b7d6ec799c60a8fda825cf59aea7eb">06982</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a17b7d6ec799c60a8fda825cf59aea7eb" title="Evaluate a pre-constructed bitmap as to whether the current time falls within the...">ast_check_timing</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__timing.html">ast_timing</a> *i)
<a name="l06983"></a>06983 {
<a name="l06984"></a>06984    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l06985"></a>06985    <span class="keyword">struct </span>timeval now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l06986"></a>06986 
<a name="l06987"></a>06987    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;tm, i-&gt;<a class="code" href="structast__timing.html#a18b6f7534e9068b65611571b05db0eee">timezone</a>);
<a name="l06988"></a>06988 
<a name="l06989"></a>06989    <span class="comment">/* If it&apos;s not the right month, return */</span>
<a name="l06990"></a>06990    <span class="keywordflow">if</span> (!(i-&gt;<a class="code" href="structast__timing.html#a3fdc5726e142f466b67b8feea4da21cf">monthmask</a> &amp; (1 &lt;&lt; tm.<a class="code" href="structast__tm.html#ada983deda100b604bee5716512453658">tm_mon</a>)))
<a name="l06991"></a>06991       <span class="keywordflow">return</span> 0;
<a name="l06992"></a>06992 
<a name="l06993"></a>06993    <span class="comment">/* If it&apos;s not that time of the month.... */</span>
<a name="l06994"></a>06994    <span class="comment">/* Warning, tm_mday has range 1..31! */</span>
<a name="l06995"></a>06995    <span class="keywordflow">if</span> (!(i-&gt;<a class="code" href="structast__timing.html#a53851cc9d2020ded355f2a52e0d32238">daymask</a> &amp; (1 &lt;&lt; (tm.<a class="code" href="structast__tm.html#a02048604d30b880033311cf542d63f92">tm_mday</a>-1))))
<a name="l06996"></a>06996       <span class="keywordflow">return</span> 0;
<a name="l06997"></a>06997 
<a name="l06998"></a>06998    <span class="comment">/* If it&apos;s not the right day of the week */</span>
<a name="l06999"></a>06999    <span class="keywordflow">if</span> (!(i-&gt;<a class="code" href="structast__timing.html#a88d1a72894c612b57b2d2160f8ffadce">dowmask</a> &amp; (1 &lt;&lt; tm.<a class="code" href="structast__tm.html#a4412571b90746a85cae9b8841c44c59c">tm_wday</a>)))
<a name="l07000"></a>07000       <span class="keywordflow">return</span> 0;
<a name="l07001"></a>07001 
<a name="l07002"></a>07002    <span class="comment">/* Sanity check the hour just to be safe */</span>
<a name="l07003"></a>07003    <span class="keywordflow">if</span> ((tm.<a class="code" href="structast__tm.html#a4d171061df9e012fcfbd1172b8440d5f">tm_hour</a> &lt; 0) || (tm.<a class="code" href="structast__tm.html#a4d171061df9e012fcfbd1172b8440d5f">tm_hour</a> &gt; 23)) {
<a name="l07004"></a>07004       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Insane time...\n&quot;</span>);
<a name="l07005"></a>07005       <span class="keywordflow">return</span> 0;
<a name="l07006"></a>07006    }
<a name="l07007"></a>07007 
<a name="l07008"></a>07008    <span class="comment">/* Now the tough part, we calculate if it fits</span>
<a name="l07009"></a>07009 <span class="comment">      in the right time based on min/hour */</span>
<a name="l07010"></a>07010    <span class="keywordflow">if</span> (!(i-&gt;<a class="code" href="structast__timing.html#a51894ab93df62f69a337f1703444c872">minmask</a>[tm.<a class="code" href="structast__tm.html#a4d171061df9e012fcfbd1172b8440d5f">tm_hour</a> * 2 + (tm.<a class="code" href="structast__tm.html#a987fa9280fe4cd6c6b8f77409f1c1504">tm_min</a> &gt;= 30 ? 1 : 0)] &amp; (1 &lt;&lt; (tm.<a class="code" href="structast__tm.html#a987fa9280fe4cd6c6b8f77409f1c1504">tm_min</a> &gt;= 30 ? tm.<a class="code" href="structast__tm.html#a987fa9280fe4cd6c6b8f77409f1c1504">tm_min</a> - 30 : tm.<a class="code" href="structast__tm.html#a987fa9280fe4cd6c6b8f77409f1c1504">tm_min</a>))))
<a name="l07011"></a>07011       <span class="keywordflow">return</span> 0;
<a name="l07012"></a>07012 
<a name="l07013"></a>07013    <span class="comment">/* If we got this far, then we&apos;re good */</span>
<a name="l07014"></a>07014    <span class="keywordflow">return</span> 1;
<a name="l07015"></a>07015 }
<a name="l07016"></a>07016 
<a name="l07017"></a><a class="code" href="pbx_8c.html#a2bc52adc4f80137db9161ed499f82a00">07017</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a2bc52adc4f80137db9161ed499f82a00" title="Deallocates memory structures associated with a timing bitmap.">ast_destroy_timing</a>(<span class="keyword">struct</span> <a class="code" href="structast__timing.html">ast_timing</a> *i)
<a name="l07018"></a>07018 {
<a name="l07019"></a>07019    <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structast__timing.html#a18b6f7534e9068b65611571b05db0eee">timezone</a>) {
<a name="l07020"></a>07020       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(i-&gt;<a class="code" href="structast__timing.html#a18b6f7534e9068b65611571b05db0eee">timezone</a>);
<a name="l07021"></a>07021       i-&gt;<a class="code" href="structast__timing.html#a18b6f7534e9068b65611571b05db0eee">timezone</a> = NULL;
<a name="l07022"></a>07022    }
<a name="l07023"></a>07023    <span class="keywordflow">return</span> 0;
<a name="l07024"></a>07024 }
<a name="l07025"></a>07025 <span class="comment">/*</span>
<a name="l07026"></a>07026 <span class="comment"> * errno values</span>
<a name="l07027"></a>07027 <span class="comment"> *  ENOMEM - out of memory</span>
<a name="l07028"></a>07028 <span class="comment"> *  EBUSY  - can&apos;t lock</span>
<a name="l07029"></a>07029 <span class="comment"> *  EEXIST - already included</span>
<a name="l07030"></a>07030 <span class="comment"> *  EINVAL - there is no existence of context for inclusion</span>
<a name="l07031"></a>07031 <span class="comment"> */</span>
<a name="l07032"></a><a class="code" href="pbx_8c.html#a90e52fc3dabf4f71fd8110bda8fd1393">07032</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aceaa74fb91df5e8f7892f59953ff6283" title="Add a context include.">ast_context_add_include2</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *value,
<a name="l07033"></a>07033    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l07034"></a>07034 {
<a name="l07035"></a>07035    <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *new_include;
<a name="l07036"></a>07036    <span class="keywordtype">char</span> *c;
<a name="l07037"></a>07037    <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *i, *il = NULL; <span class="comment">/* include, include_last */</span>
<a name="l07038"></a>07038    <span class="keywordtype">int</span> length;
<a name="l07039"></a>07039    <span class="keywordtype">char</span> *p;
<a name="l07040"></a>07040 
<a name="l07041"></a>07041    length = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a>);
<a name="l07042"></a>07042    length += 2 * (strlen(value) + 1);
<a name="l07043"></a>07043 
<a name="l07044"></a>07044    <span class="comment">/* allocate new include structure ... */</span>
<a name="l07045"></a>07045    <span class="keywordflow">if</span> (!(new_include = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, length)))
<a name="l07046"></a>07046       <span class="keywordflow">return</span> -1;
<a name="l07047"></a>07047    <span class="comment">/* Fill in this structure. Use &apos;p&apos; for assignments, as the fields</span>
<a name="l07048"></a>07048 <span class="comment">    * in the structure are &apos;const char *&apos;</span>
<a name="l07049"></a>07049 <span class="comment">    */</span>
<a name="l07050"></a>07050    p = new_include-&gt;<a class="code" href="structast__include.html#a7af2365ea6fa5bbbf507c1666e946824">stuff</a>;
<a name="l07051"></a>07051    new_include-&gt;<a class="code" href="structast__include.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = p;
<a name="l07052"></a>07052    strcpy(p, value);
<a name="l07053"></a>07053    p += strlen(value) + 1;
<a name="l07054"></a>07054    new_include-&gt;<a class="code" href="structast__include.html#a0fc4d731325a10cc181d26c7e5549b40">rname</a> = p;
<a name="l07055"></a>07055    strcpy(p, value);
<a name="l07056"></a>07056    <span class="comment">/* Strip off timing info, and process if it is there */</span>
<a name="l07057"></a>07057    <span class="keywordflow">if</span> ( (c = strchr(p, <span class="charliteral">&apos;,&apos;</span>)) ) {
<a name="l07058"></a>07058       *c++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l07059"></a>07059       new_include-&gt;<a class="code" href="structast__include.html#a5e1a4fa8d4d02bae74f72169ade15143">hastime</a> = <a class="code" href="pbx_8h.html#a018549fd5d5470b676da92f6034b7347" title="Construct a timing bitmap, for use in time-based conditionals.">ast_build_timing</a>(&amp;(new_include-&gt;<a class="code" href="structast__include.html#a137134920b381175bea34c57d2565f91">timing</a>), c);
<a name="l07060"></a>07060    }
<a name="l07061"></a>07061    new_include-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a>      = NULL;
<a name="l07062"></a>07062    new_include-&gt;<a class="code" href="structast__include.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a> = registrar;
<a name="l07063"></a>07063 
<a name="l07064"></a>07064    <a class="code" href="pbx_8h.html#a2c961dcbdcade8fac28960ed67c89bd2" title="Write locks a given context.">ast_wrlock_context</a>(con);
<a name="l07065"></a>07065 
<a name="l07066"></a>07066    <span class="comment">/* ... go to last include and check if context is already included too... */</span>
<a name="l07067"></a>07067    <span class="keywordflow">for</span> (i = con-&gt;<a class="code" href="structast__context.html#abaa8691efe3e8fe26f5930720bfd8edb">includes</a>; i; i = i-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a>) {
<a name="l07068"></a>07068       <span class="keywordflow">if</span> (!strcasecmp(i-&gt;<a class="code" href="structast__include.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, new_include-&gt;<a class="code" href="structast__include.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)) {
<a name="l07069"></a>07069          <a class="code" href="pbx_8h.html#a2bc52adc4f80137db9161ed499f82a00" title="Deallocates memory structures associated with a timing bitmap.">ast_destroy_timing</a>(&amp;(new_include-&gt;<a class="code" href="structast__include.html#a137134920b381175bea34c57d2565f91">timing</a>));
<a name="l07070"></a>07070          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(new_include);
<a name="l07071"></a>07071          <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l07072"></a>07072          <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EEXIST;
<a name="l07073"></a>07073          <span class="keywordflow">return</span> -1;
<a name="l07074"></a>07074       }
<a name="l07075"></a>07075       il = i;
<a name="l07076"></a>07076    }
<a name="l07077"></a>07077 
<a name="l07078"></a>07078    <span class="comment">/* ... include new context into context list, unlock, return */</span>
<a name="l07079"></a>07079    <span class="keywordflow">if</span> (il)
<a name="l07080"></a>07080       il-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a> = new_include;
<a name="l07081"></a>07081    <span class="keywordflow">else</span>
<a name="l07082"></a>07082       con-&gt;<a class="code" href="structast__context.html#abaa8691efe3e8fe26f5930720bfd8edb">includes</a> = new_include;
<a name="l07083"></a>07083    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Including context &apos;%s&apos; in context &apos;%s&apos;\n&quot;</span>, new_include-&gt;<a class="code" href="structast__include.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(con));
<a name="l07084"></a>07084 
<a name="l07085"></a>07085    <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l07086"></a>07086 
<a name="l07087"></a>07087    <span class="keywordflow">return</span> 0;
<a name="l07088"></a>07088 }
<a name="l07089"></a>07089 
<a name="l07090"></a>07090 <span class="comment">/*</span>
<a name="l07091"></a>07091 <span class="comment"> * errno values</span>
<a name="l07092"></a>07092 <span class="comment"> *  EBUSY  - can&apos;t lock</span>
<a name="l07093"></a>07093 <span class="comment"> *  ENOENT - no existence of context</span>
<a name="l07094"></a>07094 <span class="comment"> */</span>
<a name="l07095"></a><a class="code" href="pbx_8c.html#a7677cd4c8e3a0c3d205f412e396a7d5c">07095</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a7677cd4c8e3a0c3d205f412e396a7d5c" title="Add a switch.">ast_context_add_switch</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *sw, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> <a class="code" href="structast__sw.html#a4e3f077fec8b035a2678e7740f366dea">eval</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l07096"></a>07096 {
<a name="l07097"></a>07097    <span class="keywordtype">int</span> ret = -1;
<a name="l07098"></a>07098    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = <a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e" title="lookup for a context with a given name,">find_context_locked</a>(context);
<a name="l07099"></a>07099 
<a name="l07100"></a>07100    <span class="keywordflow">if</span> (c) { <span class="comment">/* found, add switch to this context */</span>
<a name="l07101"></a>07101       ret = <a class="code" href="pbx_8h.html#a98b8af4a068416ee570f9d78cb9af724" title="Adds a switch (first param is a ast_context).">ast_context_add_switch2</a>(c, sw, data, eval, registrar);
<a name="l07102"></a>07102       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l07103"></a>07103    }
<a name="l07104"></a>07104    <span class="keywordflow">return</span> ret;
<a name="l07105"></a>07105 }
<a name="l07106"></a>07106 
<a name="l07107"></a>07107 <span class="comment">/*</span>
<a name="l07108"></a>07108 <span class="comment"> * errno values</span>
<a name="l07109"></a>07109 <span class="comment"> *  ENOMEM - out of memory</span>
<a name="l07110"></a>07110 <span class="comment"> *  EBUSY  - can&apos;t lock</span>
<a name="l07111"></a>07111 <span class="comment"> *  EEXIST - already included</span>
<a name="l07112"></a>07112 <span class="comment"> *  EINVAL - there is no existence of context for inclusion</span>
<a name="l07113"></a>07113 <span class="comment"> */</span>
<a name="l07114"></a><a class="code" href="pbx_8c.html#ae27dd9f761219046877675635073cfc3">07114</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a98b8af4a068416ee570f9d78cb9af724" title="Adds a switch (first param is a ast_context).">ast_context_add_switch2</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *value,
<a name="l07115"></a>07115    <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> <a class="code" href="structast__sw.html#a4e3f077fec8b035a2678e7740f366dea">eval</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l07116"></a>07116 {
<a name="l07117"></a>07117    <span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *new_sw;
<a name="l07118"></a>07118    <span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *i;
<a name="l07119"></a>07119    <span class="keywordtype">int</span> length;
<a name="l07120"></a>07120    <span class="keywordtype">char</span> *p;
<a name="l07121"></a>07121 
<a name="l07122"></a>07122    length = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a>);
<a name="l07123"></a>07123    length += strlen(value) + 1;
<a name="l07124"></a>07124    <span class="keywordflow">if</span> (data)
<a name="l07125"></a>07125       length += strlen(data);
<a name="l07126"></a>07126    length++;
<a name="l07127"></a>07127 
<a name="l07128"></a>07128    <span class="comment">/* allocate new sw structure ... */</span>
<a name="l07129"></a>07129    <span class="keywordflow">if</span> (!(new_sw = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, length)))
<a name="l07130"></a>07130       <span class="keywordflow">return</span> -1;
<a name="l07131"></a>07131    <span class="comment">/* ... fill in this structure ... */</span>
<a name="l07132"></a>07132    p = new_sw-&gt;<a class="code" href="structast__sw.html#a7af2365ea6fa5bbbf507c1666e946824">stuff</a>;
<a name="l07133"></a>07133    new_sw-&gt;<a class="code" href="structast__sw.html#a5ac083a645d964373f022d03df4849c8">name</a> = p;
<a name="l07134"></a>07134    strcpy(new_sw-&gt;<a class="code" href="structast__sw.html#a5ac083a645d964373f022d03df4849c8">name</a>, value);
<a name="l07135"></a>07135    p += strlen(value) + 1;
<a name="l07136"></a>07136    new_sw-&gt;<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a> = p;
<a name="l07137"></a>07137    <span class="keywordflow">if</span> (data) {
<a name="l07138"></a>07138       strcpy(new_sw-&gt;<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a>, data);
<a name="l07139"></a>07139       p += strlen(data) + 1;
<a name="l07140"></a>07140    } <span class="keywordflow">else</span> {
<a name="l07141"></a>07141       strcpy(new_sw-&gt;<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l07142"></a>07142       p++;
<a name="l07143"></a>07143    }
<a name="l07144"></a>07144    new_sw-&gt;<a class="code" href="structast__sw.html#a4e3f077fec8b035a2678e7740f366dea">eval</a>     = eval;
<a name="l07145"></a>07145    new_sw-&gt;<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a> = registrar;
<a name="l07146"></a>07146 
<a name="l07147"></a>07147    <span class="comment">/* ... try to lock this context ... */</span>
<a name="l07148"></a>07148    <a class="code" href="pbx_8h.html#a2c961dcbdcade8fac28960ed67c89bd2" title="Write locks a given context.">ast_wrlock_context</a>(con);
<a name="l07149"></a>07149 
<a name="l07150"></a>07150    <span class="comment">/* ... go to last sw and check if context is already swd too... */</span>
<a name="l07151"></a>07151    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;con-&gt;<a class="code" href="structast__context.html#a1a88e64f1d400d544879fb192cb155e7">alts</a>, i, list) {
<a name="l07152"></a>07152       <span class="keywordflow">if</span> (!strcasecmp(i-&gt;<a class="code" href="structast__sw.html#a5ac083a645d964373f022d03df4849c8">name</a>, new_sw-&gt;<a class="code" href="structast__sw.html#a5ac083a645d964373f022d03df4849c8">name</a>) &amp;&amp; !strcasecmp(i-&gt;<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a>, new_sw-&gt;<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a>)) {
<a name="l07153"></a>07153          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(new_sw);
<a name="l07154"></a>07154          <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l07155"></a>07155          <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EEXIST;
<a name="l07156"></a>07156          <span class="keywordflow">return</span> -1;
<a name="l07157"></a>07157       }
<a name="l07158"></a>07158    }
<a name="l07159"></a>07159 
<a name="l07160"></a>07160    <span class="comment">/* ... sw new context into context list, unlock, return */</span>
<a name="l07161"></a>07161    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;con-&gt;<a class="code" href="structast__context.html#a1a88e64f1d400d544879fb192cb155e7">alts</a>, new_sw, list);
<a name="l07162"></a>07162 
<a name="l07163"></a>07163    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Including switch &apos;%s/%s&apos; in context &apos;%s&apos;\n&quot;</span>, new_sw-&gt;<a class="code" href="structast__sw.html#a5ac083a645d964373f022d03df4849c8">name</a>, new_sw-&gt;<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a>, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(con));
<a name="l07164"></a>07164 
<a name="l07165"></a>07165    <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l07166"></a>07166 
<a name="l07167"></a>07167    <span class="keywordflow">return</span> 0;
<a name="l07168"></a>07168 }
<a name="l07169"></a>07169 
<a name="l07170"></a>07170 <span class="comment">/*</span>
<a name="l07171"></a>07171 <span class="comment"> * EBUSY  - can&apos;t lock</span>
<a name="l07172"></a>07172 <span class="comment"> * ENOENT - there is not context existence</span>
<a name="l07173"></a>07173 <span class="comment"> */</span>
<a name="l07174"></a><a class="code" href="pbx_8c.html#a08e43dc093c586991af4e2f86fa14f2e">07174</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a08e43dc093c586991af4e2f86fa14f2e">ast_context_remove_ignorepat</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *ignorepat, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l07175"></a>07175 {
<a name="l07176"></a>07176    <span class="keywordtype">int</span> ret = -1;
<a name="l07177"></a>07177    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = <a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e" title="lookup for a context with a given name,">find_context_locked</a>(context);
<a name="l07178"></a>07178 
<a name="l07179"></a>07179    <span class="keywordflow">if</span> (c) {
<a name="l07180"></a>07180       ret = <a class="code" href="pbx_8h.html#a3c599ffe1436debbdccd45a28685b567">ast_context_remove_ignorepat2</a>(c, ignorepat, registrar);
<a name="l07181"></a>07181       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l07182"></a>07182    }
<a name="l07183"></a>07183    <span class="keywordflow">return</span> ret;
<a name="l07184"></a>07184 }
<a name="l07185"></a>07185 
<a name="l07186"></a><a class="code" href="pbx_8c.html#a3c599ffe1436debbdccd45a28685b567">07186</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a3c599ffe1436debbdccd45a28685b567">ast_context_remove_ignorepat2</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *ignorepat, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l07187"></a>07187 {
<a name="l07188"></a>07188    <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ip, *ipl = NULL;
<a name="l07189"></a>07189 
<a name="l07190"></a>07190    <a class="code" href="pbx_8h.html#a2c961dcbdcade8fac28960ed67c89bd2" title="Write locks a given context.">ast_wrlock_context</a>(con);
<a name="l07191"></a>07191 
<a name="l07192"></a>07192    <span class="keywordflow">for</span> (ip = con-&gt;<a class="code" href="structast__context.html#aedb0afcd332920e51d2f82860f794347">ignorepats</a>; ip; ip = ip-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a>) {
<a name="l07193"></a>07193       <span class="keywordflow">if</span> (!strcmp(ip-&gt;<a class="code" href="structast__ignorepat.html#a22c50d97e30c98ae5e62eaed74605c78">pattern</a>, ignorepat) &amp;&amp;
<a name="l07194"></a>07194          (!registrar || (registrar == ip-&gt;<a class="code" href="structast__ignorepat.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>))) {
<a name="l07195"></a>07195          <span class="keywordflow">if</span> (ipl) {
<a name="l07196"></a>07196             ipl-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a> = ip-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a>;
<a name="l07197"></a>07197             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ip);
<a name="l07198"></a>07198          } <span class="keywordflow">else</span> {
<a name="l07199"></a>07199             con-&gt;<a class="code" href="structast__context.html#aedb0afcd332920e51d2f82860f794347">ignorepats</a> = ip-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a>;
<a name="l07200"></a>07200             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ip);
<a name="l07201"></a>07201          }
<a name="l07202"></a>07202          <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l07203"></a>07203          <span class="keywordflow">return</span> 0;
<a name="l07204"></a>07204       }
<a name="l07205"></a>07205       ipl = ip;
<a name="l07206"></a>07206    }
<a name="l07207"></a>07207 
<a name="l07208"></a>07208    <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l07209"></a>07209    <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l07210"></a>07210    <span class="keywordflow">return</span> -1;
<a name="l07211"></a>07211 }
<a name="l07212"></a>07212 
<a name="l07213"></a>07213 <span class="comment">/*</span>
<a name="l07214"></a>07214 <span class="comment"> * EBUSY - can&apos;t lock</span>
<a name="l07215"></a>07215 <span class="comment"> * ENOENT - there is no existence of context</span>
<a name="l07216"></a>07216 <span class="comment"> */</span>
<a name="l07217"></a><a class="code" href="pbx_8c.html#a323f8eb5d2722c6fff9467eff52ae4b5">07217</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a24d57cdfe3409c388e4b81b67ecdee70" title="Add an ignorepat.">ast_context_add_ignorepat</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *value, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l07218"></a>07218 {
<a name="l07219"></a>07219    <span class="keywordtype">int</span> ret = -1;
<a name="l07220"></a>07220    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = <a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e" title="lookup for a context with a given name,">find_context_locked</a>(context);
<a name="l07221"></a>07221 
<a name="l07222"></a>07222    <span class="keywordflow">if</span> (c) {
<a name="l07223"></a>07223       ret = <a class="code" href="pbx_8h.html#a82c040aa706c09bd6294b2333a2a0587">ast_context_add_ignorepat2</a>(c, value, registrar);
<a name="l07224"></a>07224       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l07225"></a>07225    }
<a name="l07226"></a>07226    <span class="keywordflow">return</span> ret;
<a name="l07227"></a>07227 }
<a name="l07228"></a>07228 
<a name="l07229"></a><a class="code" href="pbx_8c.html#a665b695dd4aabc37e95f1971e84f700d">07229</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a82c040aa706c09bd6294b2333a2a0587">ast_context_add_ignorepat2</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *value, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l07230"></a>07230 {
<a name="l07231"></a>07231    <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ignorepat, *ignorepatc, *ignorepatl = NULL;
<a name="l07232"></a>07232    <span class="keywordtype">int</span> length;
<a name="l07233"></a>07233    <span class="keywordtype">char</span> *<a class="code" href="structast__ignorepat.html#a22c50d97e30c98ae5e62eaed74605c78">pattern</a>;
<a name="l07234"></a>07234    length = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a>);
<a name="l07235"></a>07235    length += strlen(value) + 1;
<a name="l07236"></a>07236    <span class="keywordflow">if</span> (!(ignorepat = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, length)))
<a name="l07237"></a>07237       <span class="keywordflow">return</span> -1;
<a name="l07238"></a>07238    <span class="comment">/* The cast to char * is because we need to write the initial value.</span>
<a name="l07239"></a>07239 <span class="comment">    * The field is not supposed to be modified otherwise.  Also, gcc 4.2</span>
<a name="l07240"></a>07240 <span class="comment">    * sees the cast as dereferencing a type-punned pointer and warns about</span>
<a name="l07241"></a>07241 <span class="comment">    * it.  This is the workaround (we&apos;re telling gcc, yes, that&apos;s really</span>
<a name="l07242"></a>07242 <span class="comment">    * what we wanted to do).</span>
<a name="l07243"></a>07243 <span class="comment">    */</span>
<a name="l07244"></a>07244    pattern = (<span class="keywordtype">char</span> *) ignorepat-&gt;<a class="code" href="structast__ignorepat.html#a22c50d97e30c98ae5e62eaed74605c78">pattern</a>;
<a name="l07245"></a>07245    strcpy(pattern, value);
<a name="l07246"></a>07246    ignorepat-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a> = NULL;
<a name="l07247"></a>07247    ignorepat-&gt;<a class="code" href="structast__ignorepat.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a> = registrar;
<a name="l07248"></a>07248    <a class="code" href="pbx_8h.html#a2c961dcbdcade8fac28960ed67c89bd2" title="Write locks a given context.">ast_wrlock_context</a>(con);
<a name="l07249"></a>07249    <span class="keywordflow">for</span> (ignorepatc = con-&gt;<a class="code" href="structast__context.html#aedb0afcd332920e51d2f82860f794347">ignorepats</a>; ignorepatc; ignorepatc = ignorepatc-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a>) {
<a name="l07250"></a>07250       ignorepatl = ignorepatc;
<a name="l07251"></a>07251       <span class="keywordflow">if</span> (!strcasecmp(ignorepatc-&gt;<a class="code" href="structast__ignorepat.html#a22c50d97e30c98ae5e62eaed74605c78">pattern</a>, value)) {
<a name="l07252"></a>07252          <span class="comment">/* Already there */</span>
<a name="l07253"></a>07253          <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l07254"></a>07254          <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EEXIST;
<a name="l07255"></a>07255          <span class="keywordflow">return</span> -1;
<a name="l07256"></a>07256       }
<a name="l07257"></a>07257    }
<a name="l07258"></a>07258    <span class="keywordflow">if</span> (ignorepatl)
<a name="l07259"></a>07259       ignorepatl-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a> = ignorepat;
<a name="l07260"></a>07260    <span class="keywordflow">else</span>
<a name="l07261"></a>07261       con-&gt;<a class="code" href="structast__context.html#aedb0afcd332920e51d2f82860f794347">ignorepats</a> = ignorepat;
<a name="l07262"></a>07262    <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l07263"></a>07263    <span class="keywordflow">return</span> 0;
<a name="l07264"></a>07264 
<a name="l07265"></a>07265 }
<a name="l07266"></a>07266 
<a name="l07267"></a><a class="code" href="pbx_8c.html#aa73d176ed4f1ce51e5db6beafba45fe3">07267</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aa73d176ed4f1ce51e5db6beafba45fe3" title="Checks to see if a number should be ignored.">ast_ignore_pattern</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__ignorepat.html#a22c50d97e30c98ae5e62eaed74605c78">pattern</a>)
<a name="l07268"></a>07268 {
<a name="l07269"></a>07269    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con = <a class="code" href="pbx_8h.html#a2af2d2771e5347b18454a05dbc98e35f" title="Find a context.">ast_context_find</a>(context);
<a name="l07270"></a>07270    <span class="keywordflow">if</span> (con) {
<a name="l07271"></a>07271       <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *pat;
<a name="l07272"></a>07272       <span class="keywordflow">for</span> (pat = con-&gt;<a class="code" href="structast__context.html#aedb0afcd332920e51d2f82860f794347">ignorepats</a>; pat; pat = pat-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a>) {
<a name="l07273"></a>07273          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a94cf2f099462a906620b5566871af797" title="Determine if a given extension matches a given pattern (in NXX format).">ast_extension_match</a>(pat-&gt;<a class="code" href="structast__ignorepat.html#a22c50d97e30c98ae5e62eaed74605c78">pattern</a>, pattern))
<a name="l07274"></a>07274             <span class="keywordflow">return</span> 1;
<a name="l07275"></a>07275       }
<a name="l07276"></a>07276    }
<a name="l07277"></a>07277 
<a name="l07278"></a>07278    <span class="keywordflow">return</span> 0;
<a name="l07279"></a>07279 }
<a name="l07280"></a>07280 
<a name="l07281"></a>07281 <span class="comment">/*</span>
<a name="l07282"></a>07282 <span class="comment"> * ast_add_extension_nolock -- use only in situations where the conlock is already held</span>
<a name="l07283"></a>07283 <span class="comment"> * ENOENT  - no existence of context</span>
<a name="l07284"></a>07284 <span class="comment"> *</span>
<a name="l07285"></a>07285 <span class="comment"> */</span>
<a name="l07286"></a><a class="code" href="pbx_8c.html#a62350bf22ada5eec5dcb16986c1909b9">07286</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a62350bf22ada5eec5dcb16986c1909b9">ast_add_extension_nolock</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keywordtype">int</span> replace, <span class="keyword">const</span> <span class="keywordtype">char</span> *extension,
<a name="l07287"></a>07287    <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *label, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid,
<a name="l07288"></a>07288    <span class="keyword">const</span> <span class="keywordtype">char</span> *application, <span class="keywordtype">void</span> *data, <span class="keywordtype">void</span> (*datad)(<span class="keywordtype">void</span> *), <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l07289"></a>07289 {
<a name="l07290"></a>07290    <span class="keywordtype">int</span> ret = -1;
<a name="l07291"></a>07291    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = <a class="code" href="pval_8h.html#a939b5867de88d9d61eb4999402805027">find_context</a>(context);
<a name="l07292"></a>07292 
<a name="l07293"></a>07293    <span class="keywordflow">if</span> (c) {
<a name="l07294"></a>07294       ret = <a class="code" href="pbx_8c.html#adb069bbd2459e4cc80cf858655d0c62f" title="Does all the work of ast_add_extension2, but adds two args, to determine if context...">ast_add_extension2_lockopt</a>(c, replace, extension, priority, label, callerid,
<a name="l07295"></a>07295          application, data, datad, registrar, 0, 0);
<a name="l07296"></a>07296    }
<a name="l07297"></a>07297 
<a name="l07298"></a>07298    <span class="keywordflow">return</span> ret;
<a name="l07299"></a>07299 }
<a name="l07300"></a>07300 <span class="comment">/*</span>
<a name="l07301"></a>07301 <span class="comment"> * EBUSY   - can&apos;t lock</span>
<a name="l07302"></a>07302 <span class="comment"> * ENOENT  - no existence of context</span>
<a name="l07303"></a>07303 <span class="comment"> *</span>
<a name="l07304"></a>07304 <span class="comment"> */</span>
<a name="l07305"></a><a class="code" href="pbx_8c.html#a07176e8d314eb68b3b50279fafa11390">07305</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a07176e8d314eb68b3b50279fafa11390" title="Add and extension to an extension context.">ast_add_extension</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keywordtype">int</span> replace, <span class="keyword">const</span> <span class="keywordtype">char</span> *extension,
<a name="l07306"></a>07306    <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *label, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid,
<a name="l07307"></a>07307    <span class="keyword">const</span> <span class="keywordtype">char</span> *application, <span class="keywordtype">void</span> *data, <span class="keywordtype">void</span> (*datad)(<span class="keywordtype">void</span> *), <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l07308"></a>07308 {
<a name="l07309"></a>07309    <span class="keywordtype">int</span> ret = -1;
<a name="l07310"></a>07310    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = <a class="code" href="pbx_8c.html#ad3380fed080cd2af7c01774b9fa9086e" title="lookup for a context with a given name,">find_context_locked</a>(context);
<a name="l07311"></a>07311 
<a name="l07312"></a>07312    <span class="keywordflow">if</span> (c) {
<a name="l07313"></a>07313       ret = <a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(c, replace, extension, priority, label, callerid,
<a name="l07314"></a>07314          application, data, datad, registrar);
<a name="l07315"></a>07315       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l07316"></a>07316    }
<a name="l07317"></a>07317 
<a name="l07318"></a>07318    <span class="keywordflow">return</span> ret;
<a name="l07319"></a>07319 }
<a name="l07320"></a>07320 
<a name="l07321"></a><a class="code" href="pbx_8c.html#a9f840db4b5ef461ac2c0c975a57c9e89">07321</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a9f840db4b5ef461ac2c0c975a57c9e89">ast_explicit_goto</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority)
<a name="l07322"></a>07322 {
<a name="l07323"></a>07323    <span class="keywordflow">if</span> (!chan)
<a name="l07324"></a>07324       <span class="keywordflow">return</span> -1;
<a name="l07325"></a>07325 
<a name="l07326"></a>07326    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l07327"></a>07327 
<a name="l07328"></a>07328    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(context))
<a name="l07329"></a>07329       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, context, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l07330"></a>07330    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(exten))
<a name="l07331"></a>07331       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, exten, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l07332"></a>07332    <span class="keywordflow">if</span> (priority &gt; -1) {
<a name="l07333"></a>07333       chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = priority;
<a name="l07334"></a>07334       <span class="comment">/* see flag description in channel.h for explanation */</span>
<a name="l07335"></a>07335       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a5ff4f7a94a36fcc2b8628186cb643d4b">AST_FLAG_IN_AUTOLOOP</a>))
<a name="l07336"></a>07336          chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>--;
<a name="l07337"></a>07337    }
<a name="l07338"></a>07338 
<a name="l07339"></a>07339    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l07340"></a>07340 
<a name="l07341"></a>07341    <span class="keywordflow">return</span> 0;
<a name="l07342"></a>07342 }
<a name="l07343"></a>07343 
<a name="l07344"></a><a class="code" href="pbx_8c.html#ae0ba2eb966a9e3376de61d30513f7302">07344</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#ae0ba2eb966a9e3376de61d30513f7302" title="Set the channel to next execute the specified dialplan location.">ast_async_goto</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority)
<a name="l07345"></a>07345 {
<a name="l07346"></a>07346    <span class="keywordtype">int</span> res = 0;
<a name="l07347"></a>07347 
<a name="l07348"></a>07348    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l07349"></a>07349 
<a name="l07350"></a>07350    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>) { <span class="comment">/* This channel is currently in the PBX */</span>
<a name="l07351"></a>07351       <a class="code" href="pbx_8h.html#a9f840db4b5ef461ac2c0c975a57c9e89">ast_explicit_goto</a>(chan, context, exten, priority + 1);
<a name="l07352"></a>07352       <a class="code" href="channel_8h.html#ae90da1877e143b996d202d4c88a9c862" title="Softly hangup up a channel (no channel lock).">ast_softhangup_nolock</a>(chan, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a085c0c603de12dc2474a17a92e1cb5a4">AST_SOFTHANGUP_ASYNCGOTO</a>);
<a name="l07353"></a>07353    } <span class="keywordflow">else</span> {
<a name="l07354"></a>07354       <span class="comment">/* In order to do it when the channel doesn&apos;t really exist within</span>
<a name="l07355"></a>07355 <span class="comment">         the PBX, we have to make a new channel, masquerade, and start the PBX</span>
<a name="l07356"></a>07356 <span class="comment">         at the new location */</span>
<a name="l07357"></a>07357       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *tmpchan = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a>, 0, 0, chan-&gt;accountcode, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan-&gt;<a class="code" href="structast__channel.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>, <span class="stringliteral">&quot;AsyncGoto/%s&quot;</span>, chan-&gt;name);
<a name="l07358"></a>07358       <span class="keywordflow">if</span> (!tmpchan) {
<a name="l07359"></a>07359          res = -1;
<a name="l07360"></a>07360       } <span class="keywordflow">else</span> {
<a name="l07361"></a>07361          <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>) {
<a name="l07362"></a>07362             <a class="code" href="cdr_8h.html#a0a672ffbd29adf8622596a36ccb25e65" title="Discard and free a CDR record.">ast_cdr_discard</a>(tmpchan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l07363"></a>07363             tmpchan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> = <a class="code" href="cdr_8h.html#a7e8acc90934bc4647dd675a251d9e6ab" title="Duplicate a record.">ast_cdr_dup</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);  <span class="comment">/* share the love */</span>
<a name="l07364"></a>07364          }
<a name="l07365"></a>07365          <span class="comment">/* Make formats okay */</span>
<a name="l07366"></a>07366          tmpchan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = chan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l07367"></a>07367          tmpchan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l07368"></a>07368          <span class="comment">/* Setup proper location */</span>
<a name="l07369"></a>07369          <a class="code" href="pbx_8h.html#a9f840db4b5ef461ac2c0c975a57c9e89">ast_explicit_goto</a>(tmpchan,
<a name="l07370"></a>07370             <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(context, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(exten, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>), priority);
<a name="l07371"></a>07371 
<a name="l07372"></a>07372          <span class="comment">/* Masquerade into temp channel */</span>
<a name="l07373"></a>07373          <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a84fa04f019436467dc17f9bdd5341dce" title="Weird function made for call transfers.">ast_channel_masquerade</a>(tmpchan, chan)) {
<a name="l07374"></a>07374             <span class="comment">/* Failed to set up the masquerade.  It&apos;s probably chan_local</span>
<a name="l07375"></a>07375 <span class="comment">             * in the middle of optimizing itself out.  Sad. :( */</span>
<a name="l07376"></a>07376             <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tmpchan);
<a name="l07377"></a>07377             tmpchan = NULL;
<a name="l07378"></a>07378             res = -1;
<a name="l07379"></a>07379          } <span class="keywordflow">else</span> {
<a name="l07380"></a>07380             <span class="comment">/* Grab the locks and get going */</span>
<a name="l07381"></a>07381             <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(tmpchan);
<a name="l07382"></a>07382             <a class="code" href="channel_8h.html#ab26f03fb10f1b2e8e52bfbbb1ee02f78" title="Start masquerading a channel XXX This is a seriously whacked out operation. We&amp;#39;re...">ast_do_masquerade</a>(tmpchan);
<a name="l07383"></a>07383             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(tmpchan);
<a name="l07384"></a>07384             <span class="comment">/* Start the PBX going on our stolen channel */</span>
<a name="l07385"></a>07385             <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(tmpchan)) {
<a name="l07386"></a>07386                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to start PBX on %s\n&quot;</span>, tmpchan-&gt;name);
<a name="l07387"></a>07387                <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tmpchan);
<a name="l07388"></a>07388                res = -1;
<a name="l07389"></a>07389             }
<a name="l07390"></a>07390          }
<a name="l07391"></a>07391       }
<a name="l07392"></a>07392    }
<a name="l07393"></a>07393    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l07394"></a>07394    <span class="keywordflow">return</span> res;
<a name="l07395"></a>07395 }
<a name="l07396"></a>07396 
<a name="l07397"></a><a class="code" href="pbx_8c.html#aef0dcef11ca2f5e3a4093598724ff086">07397</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aa43c73d212f6a5c3256cc90a7d7980a1" title="Set the channel to next execute the specified dialplan location.">ast_async_goto_by_name</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *channame, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority)
<a name="l07398"></a>07398 {
<a name="l07399"></a>07399    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan;
<a name="l07400"></a>07400    <span class="keywordtype">int</span> res = -1;
<a name="l07401"></a>07401 
<a name="l07402"></a>07402    chan = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(channame);
<a name="l07403"></a>07403    <span class="keywordflow">if</span> (chan) {
<a name="l07404"></a>07404       res = <a class="code" href="pbx_8h.html#ae0ba2eb966a9e3376de61d30513f7302" title="Set the channel to next execute the specified dialplan location.">ast_async_goto</a>(chan, context, exten, priority);
<a name="l07405"></a>07405       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l07406"></a>07406    }
<a name="l07407"></a>07407    <span class="keywordflow">return</span> res;
<a name="l07408"></a>07408 }
<a name="l07409"></a>07409 <span class="comment"></span>
<a name="l07410"></a>07410 <span class="comment">/*! \brief copy a string skipping whitespace */</span>
<a name="l07411"></a><a class="code" href="pbx_8c.html#a5491b0cd4bc064e0849dd342e938533f">07411</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a5491b0cd4bc064e0849dd342e938533f" title="copy a string skipping whitespace">ext_strncpy</a>(<span class="keywordtype">char</span> *dst, <span class="keyword">const</span> <span class="keywordtype">char</span> *src, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l07412"></a>07412 {
<a name="l07413"></a>07413    <span class="keywordtype">int</span> count = 0;
<a name="l07414"></a>07414    <span class="keywordtype">int</span> insquares = 0;
<a name="l07415"></a>07415 
<a name="l07416"></a>07416    <span class="keywordflow">while</span> (*src &amp;&amp; (count &lt; len - 1)) {
<a name="l07417"></a>07417       <span class="keywordflow">if</span> (*src == <span class="charliteral">&apos;[&apos;</span>) {
<a name="l07418"></a>07418          insquares = 1;
<a name="l07419"></a>07419       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*src == <span class="charliteral">&apos;]&apos;</span>) {
<a name="l07420"></a>07420          insquares = 0;
<a name="l07421"></a>07421       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*src == <span class="charliteral">&apos; &apos;</span> &amp;&amp; !insquares) {
<a name="l07422"></a>07422          src++;
<a name="l07423"></a>07423          <span class="keywordflow">continue</span>;
<a name="l07424"></a>07424       }
<a name="l07425"></a>07425       *dst = *src;
<a name="l07426"></a>07426       dst++;
<a name="l07427"></a>07427       src++;
<a name="l07428"></a>07428       count++;
<a name="l07429"></a>07429    }
<a name="l07430"></a>07430    *dst = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l07431"></a>07431 
<a name="l07432"></a>07432    <span class="keywordflow">return</span> count;
<a name="l07433"></a>07433 }
<a name="l07434"></a>07434 <span class="comment"></span>
<a name="l07435"></a>07435 <span class="comment">/*!</span>
<a name="l07436"></a>07436 <span class="comment"> * \brief add the extension in the priority chain.</span>
<a name="l07437"></a>07437 <span class="comment"> * \retval 0 on success.</span>
<a name="l07438"></a>07438 <span class="comment"> * \retval -1 on failure.</span>
<a name="l07439"></a>07439 <span class="comment">*/</span>
<a name="l07440"></a><a class="code" href="pbx_8c.html#a8dccdc57f455edf71d4ff733d442730e">07440</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a8dccdc57f455edf71d4ff733d442730e" title="add the extension in the priority chain.">add_pri</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *tmp,
<a name="l07441"></a>07441    <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e, <span class="keywordtype">int</span> replace)
<a name="l07442"></a>07442 {
<a name="l07443"></a>07443    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#a828413e4b0e9b9f0e6936f35e633b015" title="add the extension in the priority chain.">add_pri_lockopt</a>(con, tmp, el, e, replace, 1);
<a name="l07444"></a>07444 }
<a name="l07445"></a>07445 <span class="comment"></span>
<a name="l07446"></a>07446 <span class="comment">/*!</span>
<a name="l07447"></a>07447 <span class="comment"> * \brief add the extension in the priority chain.</span>
<a name="l07448"></a>07448 <span class="comment"> * \retval 0 on success.</span>
<a name="l07449"></a>07449 <span class="comment"> * \retval -1 on failure.</span>
<a name="l07450"></a>07450 <span class="comment">*/</span>
<a name="l07451"></a><a class="code" href="pbx_8c.html#a828413e4b0e9b9f0e6936f35e633b015">07451</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a828413e4b0e9b9f0e6936f35e633b015" title="add the extension in the priority chain.">add_pri_lockopt</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *tmp,
<a name="l07452"></a>07452    <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e, <span class="keywordtype">int</span> replace, <span class="keywordtype">int</span> lockhints)
<a name="l07453"></a>07453 {
<a name="l07454"></a>07454    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *ep;
<a name="l07455"></a>07455    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *eh=e;
<a name="l07456"></a>07456 
<a name="l07457"></a>07457    <span class="keywordflow">for</span> (ep = NULL; e ; ep = e, e = e-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>) {
<a name="l07458"></a>07458       <span class="keywordflow">if</span> (e-&gt;priority &gt;= tmp-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>)
<a name="l07459"></a>07459          <span class="keywordflow">break</span>;
<a name="l07460"></a>07460    }
<a name="l07461"></a>07461    <span class="keywordflow">if</span> (!e) {   <span class="comment">/* go at the end, and ep is surely set because the list is not empty */</span>
<a name="l07462"></a>07462       <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(eh-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>, tmp);
<a name="l07463"></a>07463 
<a name="l07464"></a>07464       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>) {
<a name="l07465"></a>07465          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(eh-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>, tmp);
<a name="l07466"></a>07466       }
<a name="l07467"></a>07467       ep-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> = tmp;
<a name="l07468"></a>07468       <span class="keywordflow">return</span> 0;   <span class="comment">/* success */</span>
<a name="l07469"></a>07469    }
<a name="l07470"></a>07470    <span class="keywordflow">if</span> (e-&gt;priority == tmp-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>) {
<a name="l07471"></a>07471       <span class="comment">/* Can&apos;t have something exactly the same.  Is this a</span>
<a name="l07472"></a>07472 <span class="comment">         replacement?  If so, replace, otherwise, bonk. */</span>
<a name="l07473"></a>07473       <span class="keywordflow">if</span> (!replace) {
<a name="l07474"></a>07474          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to register extension &apos;%s&apos;, priority %d in &apos;%s&apos;, already in use\n&quot;</span>, tmp-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, tmp-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l07475"></a>07475          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#ad11dc8dd7d18a2cf6451b32ea529221c">datad</a>) {
<a name="l07476"></a>07476             tmp-&gt;<a class="code" href="structast__exten.html#ad11dc8dd7d18a2cf6451b32ea529221c">datad</a>(tmp-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l07477"></a>07477             <span class="comment">/* if you free this, null it out */</span>
<a name="l07478"></a>07478             tmp-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a> = NULL;
<a name="l07479"></a>07479          }
<a name="l07480"></a>07480 
<a name="l07481"></a>07481          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l07482"></a>07482          <span class="keywordflow">return</span> -1;
<a name="l07483"></a>07483       }
<a name="l07484"></a>07484       <span class="comment">/* we are replacing e, so copy the link fields and then update</span>
<a name="l07485"></a>07485 <span class="comment">       * whoever pointed to e to point to us</span>
<a name="l07486"></a>07486 <span class="comment">       */</span>
<a name="l07487"></a>07487       tmp-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a> = e-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>; <span class="comment">/* not meaningful if we are not first in the peer list */</span>
<a name="l07488"></a>07488       tmp-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> = e-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>; <span class="comment">/* always meaningful */</span>
<a name="l07489"></a>07489       <span class="keywordflow">if</span> (ep)  {     <span class="comment">/* We&apos;re in the peer list, just insert ourselves */</span>
<a name="l07490"></a>07490          <a class="code" href="hashtab_8h.html#a313b62d20344c2c85461dd4ed893017c" title="Looks up the object, removes the corresponding bucket.">ast_hashtab_remove_object_via_lookup</a>(eh-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>,e);
<a name="l07491"></a>07491 
<a name="l07492"></a>07492          <span class="keywordflow">if</span> (e-&gt;label) {
<a name="l07493"></a>07493             <a class="code" href="hashtab_8h.html#a313b62d20344c2c85461dd4ed893017c" title="Looks up the object, removes the corresponding bucket.">ast_hashtab_remove_object_via_lookup</a>(eh-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>,e);
<a name="l07494"></a>07494          }
<a name="l07495"></a>07495 
<a name="l07496"></a>07496          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(eh-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>,tmp);
<a name="l07497"></a>07497          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>) {
<a name="l07498"></a>07498             <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(eh-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>,tmp);
<a name="l07499"></a>07499          }
<a name="l07500"></a>07500 
<a name="l07501"></a>07501          ep-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> = tmp;
<a name="l07502"></a>07502       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (el) {     <span class="comment">/* We&apos;re the first extension. Take over e&apos;s functions */</span>
<a name="l07503"></a>07503          <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a> = <a class="code" href="pbx_8c.html#aa638cd9d03f5d710b6a320ffda6d6392">add_exten_to_pattern_tree</a>(con, e, 1);
<a name="l07504"></a>07504          tmp-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a> = e-&gt;peer_table;
<a name="l07505"></a>07505          tmp-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a> = e-&gt;peer_label_table;
<a name="l07506"></a>07506          <a class="code" href="hashtab_8h.html#a313b62d20344c2c85461dd4ed893017c" title="Looks up the object, removes the corresponding bucket.">ast_hashtab_remove_object_via_lookup</a>(tmp-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>,e);
<a name="l07507"></a>07507          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(tmp-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>,tmp);
<a name="l07508"></a>07508          <span class="keywordflow">if</span> (e-&gt;label) {
<a name="l07509"></a>07509             <a class="code" href="hashtab_8h.html#a313b62d20344c2c85461dd4ed893017c" title="Looks up the object, removes the corresponding bucket.">ast_hashtab_remove_object_via_lookup</a>(tmp-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>, e);
<a name="l07510"></a>07510          }
<a name="l07511"></a>07511          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>) {
<a name="l07512"></a>07512             <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(tmp-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>, tmp);
<a name="l07513"></a>07513          }
<a name="l07514"></a>07514 
<a name="l07515"></a>07515          <a class="code" href="hashtab_8h.html#a313b62d20344c2c85461dd4ed893017c" title="Looks up the object, removes the corresponding bucket.">ast_hashtab_remove_object_via_lookup</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, e);
<a name="l07516"></a>07516          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, tmp);
<a name="l07517"></a>07517          el-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a> = tmp;
<a name="l07518"></a>07518          <span class="comment">/* The pattern trie points to this exten; replace the pointer,</span>
<a name="l07519"></a>07519 <span class="comment">            and all will be well */</span>
<a name="l07520"></a>07520          <span class="keywordflow">if</span> (x) { <span class="comment">/* if the trie isn&apos;t formed yet, don&apos;t sweat this */</span>
<a name="l07521"></a>07521             <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>) { <span class="comment">/* this test for safety purposes */</span>
<a name="l07522"></a>07522                x-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> = tmp; <span class="comment">/* replace what would become a bad pointer */</span>
<a name="l07523"></a>07523             } <span class="keywordflow">else</span> {
<a name="l07524"></a>07524                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Trying to delete an exten from a context, but the pattern tree node returned isn&apos;t an extension\n&quot;</span>);
<a name="l07525"></a>07525             }
<a name="l07526"></a>07526          }
<a name="l07527"></a>07527       } <span class="keywordflow">else</span> {       <span class="comment">/* We&apos;re the very first extension.  */</span>
<a name="l07528"></a>07528          <span class="keyword">struct </span><a class="code" href="structmatch__char.html" title="match_char: forms a syntax tree for quick matching of extension patterns">match_char</a> *<a class="code" href="structmatch__char.html#a87d9da60be62fb1a74b56404c392bf74">x</a> = <a class="code" href="pbx_8c.html#aa638cd9d03f5d710b6a320ffda6d6392">add_exten_to_pattern_tree</a>(con, e, 1);
<a name="l07529"></a>07529          <a class="code" href="hashtab_8h.html#a313b62d20344c2c85461dd4ed893017c" title="Looks up the object, removes the corresponding bucket.">ast_hashtab_remove_object_via_lookup</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, e);
<a name="l07530"></a>07530          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, tmp);
<a name="l07531"></a>07531          tmp-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a> = e-&gt;peer_table;
<a name="l07532"></a>07532          tmp-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a> = e-&gt;peer_label_table;
<a name="l07533"></a>07533          <a class="code" href="hashtab_8h.html#a313b62d20344c2c85461dd4ed893017c" title="Looks up the object, removes the corresponding bucket.">ast_hashtab_remove_object_via_lookup</a>(tmp-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>, e);
<a name="l07534"></a>07534          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(tmp-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>, tmp);
<a name="l07535"></a>07535          <span class="keywordflow">if</span> (e-&gt;label) {
<a name="l07536"></a>07536             <a class="code" href="hashtab_8h.html#a313b62d20344c2c85461dd4ed893017c" title="Looks up the object, removes the corresponding bucket.">ast_hashtab_remove_object_via_lookup</a>(tmp-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>, e);
<a name="l07537"></a>07537          }
<a name="l07538"></a>07538          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>) {
<a name="l07539"></a>07539             <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(tmp-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>, tmp);
<a name="l07540"></a>07540          }
<a name="l07541"></a>07541 
<a name="l07542"></a>07542          <a class="code" href="hashtab_8h.html#a313b62d20344c2c85461dd4ed893017c" title="Looks up the object, removes the corresponding bucket.">ast_hashtab_remove_object_via_lookup</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, e);
<a name="l07543"></a>07543          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, tmp);
<a name="l07544"></a>07544          con-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a> = tmp;
<a name="l07545"></a>07545          <span class="comment">/* The pattern trie points to this exten; replace the pointer,</span>
<a name="l07546"></a>07546 <span class="comment">            and all will be well */</span>
<a name="l07547"></a>07547          <span class="keywordflow">if</span> (x) { <span class="comment">/* if the trie isn&apos;t formed yet; no problem */</span>
<a name="l07548"></a>07548             <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a>) { <span class="comment">/* this test for safety purposes */</span>
<a name="l07549"></a>07549                x-&gt;<a class="code" href="structmatch__char.html#afc8cfd0aed370c037cd78797da3313e7">exten</a> = tmp; <span class="comment">/* replace what would become a bad pointer */</span>
<a name="l07550"></a>07550             } <span class="keywordflow">else</span> {
<a name="l07551"></a>07551                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Trying to delete an exten from a context, but the pattern tree node returned isn&apos;t an extension\n&quot;</span>);
<a name="l07552"></a>07552             }
<a name="l07553"></a>07553          }
<a name="l07554"></a>07554       }
<a name="l07555"></a>07555       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> == <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>)
<a name="l07556"></a>07556          <a class="code" href="pbx_8c.html#adfb9d0de487a52af57ed7953508cee82" title="Change hint for an extension.">ast_change_hint</a>(e,tmp);
<a name="l07557"></a>07557       <span class="comment">/* Destroy the old one */</span>
<a name="l07558"></a>07558       <span class="keywordflow">if</span> (e-&gt;datad)
<a name="l07559"></a>07559          e-&gt;datad(e-&gt;data);
<a name="l07560"></a>07560       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(e);
<a name="l07561"></a>07561    } <span class="keywordflow">else</span> { <span class="comment">/* Slip ourselves in just before e */</span>
<a name="l07562"></a>07562       tmp-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> = e;
<a name="l07563"></a>07563       tmp-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a> = e-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>; <span class="comment">/* extension chain, or NULL if e is not the first extension */</span>
<a name="l07564"></a>07564       <span class="keywordflow">if</span> (ep) {         <span class="comment">/* Easy enough, we&apos;re just in the peer list */</span>
<a name="l07565"></a>07565          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>) {
<a name="l07566"></a>07566             <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(eh-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>, tmp);
<a name="l07567"></a>07567          }
<a name="l07568"></a>07568          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(eh-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>, tmp);
<a name="l07569"></a>07569          ep-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> = tmp;
<a name="l07570"></a>07570       } <span class="keywordflow">else</span> {       <span class="comment">/* we are the first in some peer list, so link in the ext list */</span>
<a name="l07571"></a>07571          tmp-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a> = e-&gt;peer_table;
<a name="l07572"></a>07572          tmp-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a> = e-&gt;peer_label_table;
<a name="l07573"></a>07573          e-&gt;peer_table = 0;
<a name="l07574"></a>07574          e-&gt;peer_label_table = 0;
<a name="l07575"></a>07575          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(tmp-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>, tmp);
<a name="l07576"></a>07576          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>) {
<a name="l07577"></a>07577             <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(tmp-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>, tmp);
<a name="l07578"></a>07578          }
<a name="l07579"></a>07579          <a class="code" href="hashtab_8h.html#a313b62d20344c2c85461dd4ed893017c" title="Looks up the object, removes the corresponding bucket.">ast_hashtab_remove_object_via_lookup</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, e);
<a name="l07580"></a>07580          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, tmp);
<a name="l07581"></a>07581          <span class="keywordflow">if</span> (el)
<a name="l07582"></a>07582             el-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a> = tmp;   <span class="comment">/* in the middle... */</span>
<a name="l07583"></a>07583          <span class="keywordflow">else</span>
<a name="l07584"></a>07584             con-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a> = tmp; <span class="comment">/* ... or at the head */</span>
<a name="l07585"></a>07585          e-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a> = NULL;   <span class="comment">/* e is no more at the head, so e-&gt;next must be reset */</span>
<a name="l07586"></a>07586       }
<a name="l07587"></a>07587       <span class="comment">/* And immediately return success. */</span>
<a name="l07588"></a>07588       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> == <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>) {
<a name="l07589"></a>07589          <span class="keywordflow">if</span> (lockhints) {
<a name="l07590"></a>07590             <a class="code" href="pbx_8c.html#ae46143d88ad157ae0e848c7167891fa1" title="Add hint to hint list, check initial extension state.">ast_add_hint</a>(tmp);
<a name="l07591"></a>07591          } <span class="keywordflow">else</span> {
<a name="l07592"></a>07592             <a class="code" href="pbx_8c.html#a2258db148055b53f6647cbcfb20f5e8e" title="Add hint to hint list, check initial extension state; the hints had better be WRLOCKED...">ast_add_hint_nolock</a>(tmp);
<a name="l07593"></a>07593          }
<a name="l07594"></a>07594       }
<a name="l07595"></a>07595    }
<a name="l07596"></a>07596    <span class="keywordflow">return</span> 0;
<a name="l07597"></a>07597 }
<a name="l07598"></a>07598 <span class="comment"></span>
<a name="l07599"></a>07599 <span class="comment">/*! \brief</span>
<a name="l07600"></a>07600 <span class="comment"> * Main interface to add extensions to the list for out context.</span>
<a name="l07601"></a>07601 <span class="comment"> *</span>
<a name="l07602"></a>07602 <span class="comment"> * We sort extensions in order of matching preference, so that we can</span>
<a name="l07603"></a>07603 <span class="comment"> * stop the search as soon as we find a suitable match.</span>
<a name="l07604"></a>07604 <span class="comment"> * This ordering also takes care of wildcards such as &apos;.&apos; (meaning</span>
<a name="l07605"></a>07605 <span class="comment"> * &quot;one or more of any character&quot;) and &apos;!&apos; (which is &apos;earlymatch&apos;,</span>
<a name="l07606"></a>07606 <span class="comment"> * meaning &quot;zero or more of any character&quot; but also impacts the</span>
<a name="l07607"></a>07607 <span class="comment"> * return value from CANMATCH and EARLYMATCH.</span>
<a name="l07608"></a>07608 <span class="comment"> *</span>
<a name="l07609"></a>07609 <span class="comment"> * The extension match rules defined in the devmeeting 2006.05.05 are</span>
<a name="l07610"></a>07610 <span class="comment"> * quite simple: WE SELECT THE LONGEST MATCH.</span>
<a name="l07611"></a>07611 <span class="comment"> * In detail, &quot;longest&quot; means the number of matched characters in</span>
<a name="l07612"></a>07612 <span class="comment"> * the extension. In case of ties (e.g. _XXX and 333) in the length</span>
<a name="l07613"></a>07613 <span class="comment"> * of a pattern, we give priority to entries with the smallest cardinality</span>
<a name="l07614"></a>07614 <span class="comment"> * (e.g, [5-9] comes before [2-8] before the former has only 5 elements,</span>
<a name="l07615"></a>07615 <span class="comment"> * while the latter has 7, etc.</span>
<a name="l07616"></a>07616 <span class="comment"> * In case of same cardinality, the first element in the range counts.</span>
<a name="l07617"></a>07617 <span class="comment"> * If we still have a tie, any final &apos;!&apos; will make this as a possibly</span>
<a name="l07618"></a>07618 <span class="comment"> * less specific pattern.</span>
<a name="l07619"></a>07619 <span class="comment"> *</span>
<a name="l07620"></a>07620 <span class="comment"> * EBUSY - can&apos;t lock</span>
<a name="l07621"></a>07621 <span class="comment"> * EEXIST - extension with the same priority exist and no replace is set</span>
<a name="l07622"></a>07622 <span class="comment"> *</span>
<a name="l07623"></a>07623 <span class="comment"> */</span>
<a name="l07624"></a><a class="code" href="pbx_8c.html#a8790db69940f3c32c2d7943ee73f2180">07624</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con,
<a name="l07625"></a>07625    <span class="keywordtype">int</span> replace, <span class="keyword">const</span> <span class="keywordtype">char</span> *extension, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *label, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid,
<a name="l07626"></a>07626    <span class="keyword">const</span> <span class="keywordtype">char</span> *application, <span class="keywordtype">void</span> *data, <span class="keywordtype">void</span> (*datad)(<span class="keywordtype">void</span> *),
<a name="l07627"></a>07627    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l07628"></a>07628 {
<a name="l07629"></a>07629    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#adb069bbd2459e4cc80cf858655d0c62f" title="Does all the work of ast_add_extension2, but adds two args, to determine if context...">ast_add_extension2_lockopt</a>(con, replace, extension, priority, label, callerid, application, data, datad, registrar, 1, 1);
<a name="l07630"></a>07630 }
<a name="l07631"></a>07631 <span class="comment"></span>
<a name="l07632"></a>07632 <span class="comment">/*! \brief</span>
<a name="l07633"></a>07633 <span class="comment"> * Does all the work of ast_add_extension2, but adds two args, to determine if</span>
<a name="l07634"></a>07634 <span class="comment"> * context and hint locking should be done. In merge_and_delete, we need to do</span>
<a name="l07635"></a>07635 <span class="comment"> * this without locking, as the locks are already held.</span>
<a name="l07636"></a>07636 <span class="comment"> */</span>
<a name="l07637"></a><a class="code" href="pbx_8c.html#adb069bbd2459e4cc80cf858655d0c62f">07637</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#adb069bbd2459e4cc80cf858655d0c62f" title="Does all the work of ast_add_extension2, but adds two args, to determine if context...">ast_add_extension2_lockopt</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con,
<a name="l07638"></a>07638    <span class="keywordtype">int</span> replace, <span class="keyword">const</span> <span class="keywordtype">char</span> *extension, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *label, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid,
<a name="l07639"></a>07639    <span class="keyword">const</span> <span class="keywordtype">char</span> *application, <span class="keywordtype">void</span> *data, <span class="keywordtype">void</span> (*datad)(<span class="keywordtype">void</span> *),
<a name="l07640"></a>07640    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>, <span class="keywordtype">int</span> lockconts, <span class="keywordtype">int</span> lockhints)
<a name="l07641"></a>07641 {
<a name="l07642"></a>07642    <span class="comment">/*</span>
<a name="l07643"></a>07643 <span class="comment">    * Sort extensions (or patterns) according to the rules indicated above.</span>
<a name="l07644"></a>07644 <span class="comment">    * These are implemented by the function ext_cmp()).</span>
<a name="l07645"></a>07645 <span class="comment">    * All priorities for the same ext/pattern/cid are kept in a list,</span>
<a name="l07646"></a>07646 <span class="comment">    * using the &apos;peer&apos; field  as a link field..</span>
<a name="l07647"></a>07647 <span class="comment">    */</span>
<a name="l07648"></a>07648    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *tmp, *tmp2, *e, *<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a> = NULL;
<a name="l07649"></a>07649    <span class="keywordtype">int</span> res;
<a name="l07650"></a>07650    <span class="keywordtype">int</span> length;
<a name="l07651"></a>07651    <span class="keywordtype">char</span> *p;
<a name="l07652"></a>07652    <span class="keywordtype">char</span> expand_buf[<a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a>];
<a name="l07653"></a>07653    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> dummy_exten = {0};
<a name="l07654"></a>07654    <span class="keywordtype">char</span> dummy_name[1024];
<a name="l07655"></a>07655 
<a name="l07656"></a>07656    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(extension)) {
<a name="l07657"></a>07657       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;You have to be kidding-- add exten &apos;&apos; to context %s? Figure out a name and call me back. Action ignored.\n&quot;</span>,
<a name="l07658"></a>07658             con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l07659"></a>07659       <span class="keywordflow">return</span> -1;
<a name="l07660"></a>07660    }
<a name="l07661"></a>07661 
<a name="l07662"></a>07662    <span class="comment">/* If we are adding a hint evalulate in variables and global variables */</span>
<a name="l07663"></a>07663    <span class="keywordflow">if</span> (priority == <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a> &amp;&amp; strstr(application, <span class="stringliteral">&quot;${&quot;</span>) &amp;&amp; !strstr(extension, <span class="stringliteral">&quot;_&quot;</span>)) {
<a name="l07664"></a>07664       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> c = {0, };
<a name="l07665"></a>07665 
<a name="l07666"></a>07666       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(c.<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, extension, <span class="keyword">sizeof</span>(c.<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l07667"></a>07667       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(c.<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, <span class="keyword">sizeof</span>(c.<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l07668"></a>07668       <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(&amp;c, application, expand_buf, <span class="keyword">sizeof</span>(expand_buf));
<a name="l07669"></a>07669       application = expand_buf;
<a name="l07670"></a>07670    }
<a name="l07671"></a>07671 
<a name="l07672"></a>07672    length = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a>);
<a name="l07673"></a>07673    length += strlen(extension) + 1;
<a name="l07674"></a>07674    length += strlen(application) + 1;
<a name="l07675"></a>07675    <span class="keywordflow">if</span> (label)
<a name="l07676"></a>07676       length += strlen(label) + 1;
<a name="l07677"></a>07677    <span class="keywordflow">if</span> (callerid)
<a name="l07678"></a>07678       length += strlen(callerid) + 1;
<a name="l07679"></a>07679    <span class="keywordflow">else</span>
<a name="l07680"></a>07680       length ++;  <span class="comment">/* just the &apos;\0&apos; */</span>
<a name="l07681"></a>07681 
<a name="l07682"></a>07682    <span class="comment">/* Be optimistic:  Build the extension structure first */</span>
<a name="l07683"></a>07683    <span class="keywordflow">if</span> (!(tmp = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, length)))
<a name="l07684"></a>07684       <span class="keywordflow">return</span> -1;
<a name="l07685"></a>07685 
<a name="l07686"></a>07686    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(label)) <span class="comment">/* let&apos;s turn empty labels to a null ptr */</span>
<a name="l07687"></a>07687       label = 0;
<a name="l07688"></a>07688 
<a name="l07689"></a>07689    <span class="comment">/* use p as dst in assignments, as the fields are const char * */</span>
<a name="l07690"></a>07690    p = tmp-&gt;<a class="code" href="structast__exten.html#a7af2365ea6fa5bbbf507c1666e946824">stuff</a>;
<a name="l07691"></a>07691    <span class="keywordflow">if</span> (label) {
<a name="l07692"></a>07692       tmp-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a> = p;
<a name="l07693"></a>07693       strcpy(p, label);
<a name="l07694"></a>07694       p += strlen(label) + 1;
<a name="l07695"></a>07695    }
<a name="l07696"></a>07696    tmp-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a> = p;
<a name="l07697"></a>07697    p += <a class="code" href="pbx_8c.html#a5491b0cd4bc064e0849dd342e938533f" title="copy a string skipping whitespace">ext_strncpy</a>(p, extension, strlen(extension) + 1) + 1;
<a name="l07698"></a>07698    tmp-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = priority;
<a name="l07699"></a>07699    tmp-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a> = p;   <span class="comment">/* but use p for assignments below */</span>
<a name="l07700"></a>07700 
<a name="l07701"></a>07701    <span class="comment">/* Blank callerid and NULL callerid are two SEPARATE things.  Do NOT confuse the two!!! */</span>
<a name="l07702"></a>07702    <span class="keywordflow">if</span> (callerid) {
<a name="l07703"></a>07703       p += <a class="code" href="pbx_8c.html#a5491b0cd4bc064e0849dd342e938533f" title="copy a string skipping whitespace">ext_strncpy</a>(p, callerid, strlen(callerid) + 1) + 1;
<a name="l07704"></a>07704       tmp-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> = 1;
<a name="l07705"></a>07705    } <span class="keywordflow">else</span> {
<a name="l07706"></a>07706       *p++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l07707"></a>07707       tmp-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> = 0;
<a name="l07708"></a>07708    }
<a name="l07709"></a>07709    tmp-&gt;<a class="code" href="structast__exten.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">app</a> = p;
<a name="l07710"></a>07710    strcpy(p, application);
<a name="l07711"></a>07711    tmp-&gt;<a class="code" href="structast__exten.html#a7733606f3f625c2782402ba971995641">parent</a> = con;
<a name="l07712"></a>07712    tmp-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a> = data;
<a name="l07713"></a>07713    tmp-&gt;<a class="code" href="structast__exten.html#ad11dc8dd7d18a2cf6451b32ea529221c">datad</a> = <a class="code" href="structast__exten.html#ad11dc8dd7d18a2cf6451b32ea529221c">datad</a>;
<a name="l07714"></a>07714    tmp-&gt;<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a> = registrar;
<a name="l07715"></a>07715 
<a name="l07716"></a>07716    <span class="keywordflow">if</span> (lockconts) {
<a name="l07717"></a>07717       <a class="code" href="pbx_8h.html#a2c961dcbdcade8fac28960ed67c89bd2" title="Write locks a given context.">ast_wrlock_context</a>(con);
<a name="l07718"></a>07718    }
<a name="l07719"></a>07719 
<a name="l07720"></a>07720    <span class="keywordflow">if</span> (con-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>) { <span class="comment">/* usually, on initial load, the pattern_tree isn&apos;t formed until the first find_exten; so if we are adding</span>
<a name="l07721"></a>07721 <span class="comment">                        an extension, and the trie exists, then we need to incrementally add this pattern to it. */</span>
<a name="l07722"></a>07722       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dummy_name, extension, <span class="keyword">sizeof</span>(dummy_name));
<a name="l07723"></a>07723       dummy_exten.<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a> = dummy_name;
<a name="l07724"></a>07724       dummy_exten.<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> = 0;
<a name="l07725"></a>07725       dummy_exten.<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a> = 0;
<a name="l07726"></a>07726       tmp2 = <a class="code" href="hashtab_8h.html#a78b1f7bc201afd020f6270378173bb79" title="Lookup this object in the hash table.">ast_hashtab_lookup</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, &amp;dummy_exten);
<a name="l07727"></a>07727       <span class="keywordflow">if</span> (!tmp2) {
<a name="l07728"></a>07728          <span class="comment">/* hmmm, not in the trie; */</span>
<a name="l07729"></a>07729          <a class="code" href="pbx_8c.html#aa638cd9d03f5d710b6a320ffda6d6392">add_exten_to_pattern_tree</a>(con, tmp, 0);
<a name="l07730"></a>07730          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, tmp); <span class="comment">/* for the sake of completeness */</span>
<a name="l07731"></a>07731       }
<a name="l07732"></a>07732    }
<a name="l07733"></a>07733    res = 0; <span class="comment">/* some compilers will think it is uninitialized otherwise */</span>
<a name="l07734"></a>07734    <span class="keywordflow">for</span> (e = con-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a>; e; el = e, e = e-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>) {   <span class="comment">/* scan the extension list */</span>
<a name="l07735"></a>07735       res = <a class="code" href="pbx_8c.html#a12793cf64a2e55f7b94646b9c8fb2f5d" title="the full routine to compare extensions in rules.">ext_cmp</a>(e-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, tmp-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l07736"></a>07736       <span class="keywordflow">if</span> (res == 0) { <span class="comment">/* extension match, now look at cidmatch */</span>
<a name="l07737"></a>07737          <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> &amp;&amp; !tmp-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a>)
<a name="l07738"></a>07738             res = 0;
<a name="l07739"></a>07739          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> &amp;&amp; !e-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a>)
<a name="l07740"></a>07740             res = 1;
<a name="l07741"></a>07741          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> &amp;&amp; !tmp-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a>)
<a name="l07742"></a>07742             res = -1;
<a name="l07743"></a>07743          <span class="keywordflow">else</span>
<a name="l07744"></a>07744             res = <a class="code" href="pbx_8c.html#a12793cf64a2e55f7b94646b9c8fb2f5d" title="the full routine to compare extensions in rules.">ext_cmp</a>(e-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>, tmp-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>);
<a name="l07745"></a>07745       }
<a name="l07746"></a>07746       <span class="keywordflow">if</span> (res &gt;= 0)
<a name="l07747"></a>07747          <span class="keywordflow">break</span>;
<a name="l07748"></a>07748    }
<a name="l07749"></a>07749    <span class="keywordflow">if</span> (e &amp;&amp; res == 0) { <span class="comment">/* exact match, insert in the pri chain */</span>
<a name="l07750"></a>07750       res = <a class="code" href="pbx_8c.html#a8dccdc57f455edf71d4ff733d442730e" title="add the extension in the priority chain.">add_pri</a>(con, tmp, el, e, replace);
<a name="l07751"></a>07751       <span class="keywordflow">if</span> (lockconts) {
<a name="l07752"></a>07752          <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l07753"></a>07753       }
<a name="l07754"></a>07754       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l07755"></a>07755          <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EEXIST;   <span class="comment">/* XXX do we care ? */</span>
<a name="l07756"></a>07756          <span class="keywordflow">return</span> 0; <span class="comment">/* XXX should we return -1 maybe ? */</span>
<a name="l07757"></a>07757       }
<a name="l07758"></a>07758    } <span class="keywordflow">else</span> {
<a name="l07759"></a>07759       <span class="comment">/*</span>
<a name="l07760"></a>07760 <span class="comment">       * not an exact match, this is the first entry with this pattern,</span>
<a name="l07761"></a>07761 <span class="comment">       * so insert in the main list right before &apos;e&apos; (if any)</span>
<a name="l07762"></a>07762 <span class="comment">       */</span>
<a name="l07763"></a>07763       tmp-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a> = e;
<a name="l07764"></a>07764       <span class="keywordflow">if</span> (el) {  <span class="comment">/* there is another exten already in this context */</span>
<a name="l07765"></a>07765          el-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a> = tmp;
<a name="l07766"></a>07766          tmp-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a> = <a class="code" href="hashtab_8h.html#a85701d44df4ea1e746bde709a91a4192" title="Create the hashtable list.">ast_hashtab_create</a>(13,
<a name="l07767"></a>07767                      <a class="code" href="pbx_8c.html#a312597f1da31dcefbf18f31335f7295c">hashtab_compare_exten_numbers</a>,
<a name="l07768"></a>07768                      <a class="code" href="hashtab_8h.html#aef63906caa0b965e9c8d8561600038e9" title="Determines if a table resize should occur using the Java algorithm (if the table...">ast_hashtab_resize_java</a>,
<a name="l07769"></a>07769                      <a class="code" href="hashtab_8h.html#a743bfd52a8c9eb5d939ff5944758d846" title="Create a prime number roughly 2x the current table size.">ast_hashtab_newsize_java</a>,
<a name="l07770"></a>07770                      <a class="code" href="pbx_8c.html#a4ee70a9380daf9be2bf681becb1a69c3">hashtab_hash_priority</a>,
<a name="l07771"></a>07771                      0);
<a name="l07772"></a>07772          tmp-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a> = <a class="code" href="hashtab_8h.html#a85701d44df4ea1e746bde709a91a4192" title="Create the hashtable list.">ast_hashtab_create</a>(7,
<a name="l07773"></a>07773                         <a class="code" href="pbx_8c.html#aad72a88ef3aa3258d69475cd14f274d0">hashtab_compare_exten_labels</a>,
<a name="l07774"></a>07774                         <a class="code" href="hashtab_8h.html#aef63906caa0b965e9c8d8561600038e9" title="Determines if a table resize should occur using the Java algorithm (if the table...">ast_hashtab_resize_java</a>,
<a name="l07775"></a>07775                         <a class="code" href="hashtab_8h.html#a743bfd52a8c9eb5d939ff5944758d846" title="Create a prime number roughly 2x the current table size.">ast_hashtab_newsize_java</a>,
<a name="l07776"></a>07776                         <a class="code" href="pbx_8c.html#ae4a0bd08dbd3bc22fc65de969d3bfa45">hashtab_hash_labels</a>,
<a name="l07777"></a>07777                         0);
<a name="l07778"></a>07778          <span class="keywordflow">if</span> (label) {
<a name="l07779"></a>07779             <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(tmp-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>, tmp);
<a name="l07780"></a>07780          }
<a name="l07781"></a>07781          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(tmp-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>, tmp);
<a name="l07782"></a>07782       } <span class="keywordflow">else</span> {  <span class="comment">/* this is the first exten in this context */</span>
<a name="l07783"></a>07783          <span class="keywordflow">if</span> (!con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>)
<a name="l07784"></a>07784             con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a> = <a class="code" href="hashtab_8h.html#a85701d44df4ea1e746bde709a91a4192" title="Create the hashtable list.">ast_hashtab_create</a>(27,
<a name="l07785"></a>07785                                        <a class="code" href="pbx_8c.html#a01a31156d536b161d4c400af885a6b23">hashtab_compare_extens</a>,
<a name="l07786"></a>07786                                        <a class="code" href="hashtab_8h.html#aef63906caa0b965e9c8d8561600038e9" title="Determines if a table resize should occur using the Java algorithm (if the table...">ast_hashtab_resize_java</a>,
<a name="l07787"></a>07787                                        <a class="code" href="hashtab_8h.html#a743bfd52a8c9eb5d939ff5944758d846" title="Create a prime number roughly 2x the current table size.">ast_hashtab_newsize_java</a>,
<a name="l07788"></a>07788                                        <a class="code" href="pbx_8c.html#a46084c800c9b3dbe1f2b57e2d2b62304">hashtab_hash_extens</a>,
<a name="l07789"></a>07789                                        0);
<a name="l07790"></a>07790          con-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a> = tmp;
<a name="l07791"></a>07791          con-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a>-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a> = <a class="code" href="hashtab_8h.html#a85701d44df4ea1e746bde709a91a4192" title="Create the hashtable list.">ast_hashtab_create</a>(13,
<a name="l07792"></a>07792                         <a class="code" href="pbx_8c.html#a312597f1da31dcefbf18f31335f7295c">hashtab_compare_exten_numbers</a>,
<a name="l07793"></a>07793                         <a class="code" href="hashtab_8h.html#aef63906caa0b965e9c8d8561600038e9" title="Determines if a table resize should occur using the Java algorithm (if the table...">ast_hashtab_resize_java</a>,
<a name="l07794"></a>07794                         <a class="code" href="hashtab_8h.html#a743bfd52a8c9eb5d939ff5944758d846" title="Create a prime number roughly 2x the current table size.">ast_hashtab_newsize_java</a>,
<a name="l07795"></a>07795                         <a class="code" href="pbx_8c.html#a4ee70a9380daf9be2bf681becb1a69c3">hashtab_hash_priority</a>,
<a name="l07796"></a>07796                         0);
<a name="l07797"></a>07797          con-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a>-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a> = <a class="code" href="hashtab_8h.html#a85701d44df4ea1e746bde709a91a4192" title="Create the hashtable list.">ast_hashtab_create</a>(7,
<a name="l07798"></a>07798                            <a class="code" href="pbx_8c.html#aad72a88ef3aa3258d69475cd14f274d0">hashtab_compare_exten_labels</a>,
<a name="l07799"></a>07799                            <a class="code" href="hashtab_8h.html#aef63906caa0b965e9c8d8561600038e9" title="Determines if a table resize should occur using the Java algorithm (if the table...">ast_hashtab_resize_java</a>,
<a name="l07800"></a>07800                            <a class="code" href="hashtab_8h.html#a743bfd52a8c9eb5d939ff5944758d846" title="Create a prime number roughly 2x the current table size.">ast_hashtab_newsize_java</a>,
<a name="l07801"></a>07801                            <a class="code" href="pbx_8c.html#ae4a0bd08dbd3bc22fc65de969d3bfa45">hashtab_hash_labels</a>,
<a name="l07802"></a>07802                            0);
<a name="l07803"></a>07803          <span class="keywordflow">if</span> (label) {
<a name="l07804"></a>07804             <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(con-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a>-&gt;<a class="code" href="structast__exten.html#a10c9abe707a81a9cabd06ee4b53ac0fe">peer_label_table</a>, tmp);
<a name="l07805"></a>07805          }
<a name="l07806"></a>07806          <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(con-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a>-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>, tmp);
<a name="l07807"></a>07807 
<a name="l07808"></a>07808       }
<a name="l07809"></a>07809       <a class="code" href="hashtab_8h.html#afc129daca552e4483e6990a1e37d7e51" title="Check and insert new object only if it is not there.">ast_hashtab_insert_safe</a>(con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, tmp);
<a name="l07810"></a>07810       <span class="keywordflow">if</span> (lockconts) {
<a name="l07811"></a>07811          <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(con);
<a name="l07812"></a>07812       }
<a name="l07813"></a>07813       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> == <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>) {
<a name="l07814"></a>07814          <span class="keywordflow">if</span> (lockhints) {
<a name="l07815"></a>07815             <a class="code" href="pbx_8c.html#ae46143d88ad157ae0e848c7167891fa1" title="Add hint to hint list, check initial extension state.">ast_add_hint</a>(tmp);
<a name="l07816"></a>07816          } <span class="keywordflow">else</span> {
<a name="l07817"></a>07817             <a class="code" href="pbx_8c.html#a2258db148055b53f6647cbcfb20f5e8e" title="Add hint to hint list, check initial extension state; the hints had better be WRLOCKED...">ast_add_hint_nolock</a>(tmp);
<a name="l07818"></a>07818          }
<a name="l07819"></a>07819       }
<a name="l07820"></a>07820    }
<a name="l07821"></a>07821    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>) {
<a name="l07822"></a>07822       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a>) {
<a name="l07823"></a>07823          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Added extension &apos;%s&apos; priority %d (CID match &apos;%s&apos;) to %s (%p)\n&quot;</span>,
<a name="l07824"></a>07824                  tmp-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, tmp-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, tmp-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, con);
<a name="l07825"></a>07825       } <span class="keywordflow">else</span> {
<a name="l07826"></a>07826          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Added extension &apos;%s&apos; priority %d to %s (%p)\n&quot;</span>,
<a name="l07827"></a>07827                  tmp-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, tmp-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, con);
<a name="l07828"></a>07828       }
<a name="l07829"></a>07829    }
<a name="l07830"></a>07830 
<a name="l07831"></a>07831    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a>) {
<a name="l07832"></a>07832       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Added extension &apos;%s&apos; priority %d (CID match &apos;%s&apos;) to %s (%p)\n&quot;</span>,
<a name="l07833"></a>07833              tmp-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, tmp-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, tmp-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, con);
<a name="l07834"></a>07834    } <span class="keywordflow">else</span> {
<a name="l07835"></a>07835       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Added extension &apos;%s&apos; priority %d to %s (%p)\n&quot;</span>,
<a name="l07836"></a>07836              tmp-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, tmp-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, con);
<a name="l07837"></a>07837    }
<a name="l07838"></a>07838 
<a name="l07839"></a>07839    <span class="keywordflow">return</span> 0;
<a name="l07840"></a>07840 }
<a name="l07841"></a>07841 
<a name="l07842"></a><a class="code" href="structasync__stat.html">07842</a> <span class="keyword">struct </span><a class="code" href="structasync__stat.html">async_stat</a> {
<a name="l07843"></a><a class="code" href="structasync__stat.html#a1ad90c6e2b5f6774919078d93f443e30">07843</a>    pthread_t p;
<a name="l07844"></a><a class="code" href="structasync__stat.html#a84d1435c5b8d387806714ea7079304b7">07844</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan;
<a name="l07845"></a><a class="code" href="structasync__stat.html#ac25ea00ee3f082df06e0cf468cbde240">07845</a>    <span class="keywordtype">char</span> context[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>];
<a name="l07846"></a><a class="code" href="structasync__stat.html#a78d4847658b695383d849efd12399b38">07846</a>    <span class="keywordtype">char</span> exten[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l07847"></a><a class="code" href="structasync__stat.html#acec9ce2df15222151ad66fcb1d74eb9f">07847</a>    <span class="keywordtype">int</span> priority;
<a name="l07848"></a><a class="code" href="structasync__stat.html#a493b57f443cc38b3d3df9c1e584d9d82">07848</a>    <span class="keywordtype">int</span> timeout;
<a name="l07849"></a><a class="code" href="structasync__stat.html#aec08c35c18f813f66ece0fe52fed7a6d">07849</a>    <span class="keywordtype">char</span> app[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l07850"></a><a class="code" href="structasync__stat.html#a365df2111e505119a9cc91ea9e6d43bd">07850</a>    <span class="keywordtype">char</span> appdata[1024];
<a name="l07851"></a>07851 };
<a name="l07852"></a>07852 
<a name="l07853"></a><a class="code" href="pbx_8c.html#a4f84706d30062086de7265597688040f">07853</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="pbx_8c.html#a4f84706d30062086de7265597688040f">async_wait</a>(<span class="keywordtype">void</span> *data)
<a name="l07854"></a>07854 {
<a name="l07855"></a>07855    <span class="keyword">struct </span><a class="code" href="structasync__stat.html">async_stat</a> *as = data;
<a name="l07856"></a>07856    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan = as-&gt;<a class="code" href="structasync__stat.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l07857"></a>07857    <span class="keywordtype">int</span> timeout = as-&gt;<a class="code" href="structasync__stat.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>;
<a name="l07858"></a>07858    <span class="keywordtype">int</span> res;
<a name="l07859"></a>07859    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l07860"></a>07860    <span class="keyword">struct </span>ast_app *app;
<a name="l07861"></a>07861 
<a name="l07862"></a>07862    <span class="keywordflow">while</span> (timeout &amp;&amp; (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)) {
<a name="l07863"></a>07863       res = <a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, timeout);
<a name="l07864"></a>07864       <span class="keywordflow">if</span> (res &lt; 1)
<a name="l07865"></a>07865          <span class="keywordflow">break</span>;
<a name="l07866"></a>07866       <span class="keywordflow">if</span> (timeout &gt; -1)
<a name="l07867"></a>07867          timeout = res;
<a name="l07868"></a>07868       f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan);
<a name="l07869"></a>07869       <span class="keywordflow">if</span> (!f)
<a name="l07870"></a>07870          <span class="keywordflow">break</span>;
<a name="l07871"></a>07871       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>) {
<a name="l07872"></a>07872          <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a387635982df3d2edb669a1eece92c875">AST_CONTROL_BUSY</a>)  ||
<a name="l07873"></a>07873              (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a850bb06a1702741c93a3fd67cc9637ab">AST_CONTROL_CONGESTION</a>) ) {
<a name="l07874"></a>07874             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l07875"></a>07875             <span class="keywordflow">break</span>;
<a name="l07876"></a>07876          }
<a name="l07877"></a>07877       }
<a name="l07878"></a>07878       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l07879"></a>07879    }
<a name="l07880"></a>07880    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l07881"></a>07881       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(as-&gt;<a class="code" href="structasync__stat.html#aec08c35c18f813f66ece0fe52fed7a6d">app</a>)) {
<a name="l07882"></a>07882          app = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(as-&gt;<a class="code" href="structasync__stat.html#aec08c35c18f813f66ece0fe52fed7a6d">app</a>);
<a name="l07883"></a>07883          <span class="keywordflow">if</span> (app) {
<a name="l07884"></a>07884             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Launching %s(%s) on %s\n&quot;</span>, as-&gt;<a class="code" href="structasync__stat.html#aec08c35c18f813f66ece0fe52fed7a6d">app</a>, as-&gt;<a class="code" href="structasync__stat.html#a365df2111e505119a9cc91ea9e6d43bd">appdata</a>, chan-&gt;name);
<a name="l07885"></a>07885             <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(chan, app, as-&gt;<a class="code" href="structasync__stat.html#a365df2111e505119a9cc91ea9e6d43bd">appdata</a>);
<a name="l07886"></a>07886          } <span class="keywordflow">else</span>
<a name="l07887"></a>07887             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such application &apos;%s&apos;\n&quot;</span>, as-&gt;<a class="code" href="structasync__stat.html#aec08c35c18f813f66ece0fe52fed7a6d">app</a>);
<a name="l07888"></a>07888       } <span class="keywordflow">else</span> {
<a name="l07889"></a>07889          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(as-&gt;<a class="code" href="structasync__stat.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>))
<a name="l07890"></a>07890             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, as-&gt;<a class="code" href="structasync__stat.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l07891"></a>07891          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(as-&gt;<a class="code" href="structasync__stat.html#a78d4847658b695383d849efd12399b38">exten</a>))
<a name="l07892"></a>07892             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, as-&gt;<a class="code" href="structasync__stat.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l07893"></a>07893          <span class="keywordflow">if</span> (as-&gt;<a class="code" href="structasync__stat.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> &gt; 0)
<a name="l07894"></a>07894             chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = as-&gt;<a class="code" href="structasync__stat.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>;
<a name="l07895"></a>07895          <span class="comment">/* Run the PBX */</span>
<a name="l07896"></a>07896          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a44b6406c9220f7f2b610ac712369f405" title="Execute the PBX in the current thread.">ast_pbx_run</a>(chan)) {
<a name="l07897"></a>07897             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to start PBX on %s\n&quot;</span>, chan-&gt;name);
<a name="l07898"></a>07898          } <span class="keywordflow">else</span> {
<a name="l07899"></a>07899             <span class="comment">/* PBX will have taken care of this */</span>
<a name="l07900"></a>07900             chan = NULL;
<a name="l07901"></a>07901          }
<a name="l07902"></a>07902       }
<a name="l07903"></a>07903    }
<a name="l07904"></a>07904    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(as);
<a name="l07905"></a>07905    <span class="keywordflow">if</span> (chan)
<a name="l07906"></a>07906       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l07907"></a>07907    <span class="keywordflow">return</span> NULL;
<a name="l07908"></a>07908 }
<a name="l07909"></a>07909 <span class="comment"></span>
<a name="l07910"></a>07910 <span class="comment">/*!</span>
<a name="l07911"></a>07911 <span class="comment"> * \brief Function to post an empty cdr after a spool call fails.</span>
<a name="l07912"></a>07912 <span class="comment"> * \note This function posts an empty cdr for a failed spool call</span>
<a name="l07913"></a>07913 <span class="comment">*/</span>
<a name="l07914"></a><a class="code" href="pbx_8c.html#a5a3064670e827b600404223a674d8bd1">07914</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a5a3064670e827b600404223a674d8bd1" title="Function to post an empty cdr after a spool call fails.">ast_pbx_outgoing_cdr_failed</a>(<span class="keywordtype">void</span>)
<a name="l07915"></a>07915 {
<a name="l07916"></a>07916    <span class="comment">/* allocate a channel */</span>
<a name="l07917"></a>07917    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l07918"></a>07918 
<a name="l07919"></a>07919    <span class="keywordflow">if</span> (!chan)
<a name="l07920"></a>07920       <span class="keywordflow">return</span> -1;  <span class="comment">/* failure */</span>
<a name="l07921"></a>07921 
<a name="l07922"></a>07922    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>) {
<a name="l07923"></a>07923       <span class="comment">/* allocation of the cdr failed */</span>
<a name="l07924"></a>07924       <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>(chan);   <span class="comment">/* free the channel */</span>
<a name="l07925"></a>07925       <span class="keywordflow">return</span> -1;                <span class="comment">/* return failure */</span>
<a name="l07926"></a>07926    }
<a name="l07927"></a>07927 
<a name="l07928"></a>07928    <span class="comment">/* allocation of the cdr was successful */</span>
<a name="l07929"></a>07929    <a class="code" href="cdr_8h.html#a551fbacb2f2b4caaf57243c601c28a83" title="Initialize based on a channel.">ast_cdr_init</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, chan);  <span class="comment">/* initialize our channel&apos;s cdr */</span>
<a name="l07930"></a>07930    <a class="code" href="cdr_8h.html#af788ef701483a64b77656f272843bcd4" title="Start a call.">ast_cdr_start</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);       <span class="comment">/* record the start and stop time */</span>
<a name="l07931"></a>07931    <a class="code" href="cdr_8h.html#a9884cbdaef20e9f266bc2220772bf52b" title="End a call.">ast_cdr_end</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l07932"></a>07932    <a class="code" href="cdr_8h.html#acdce2d9d0af5180090b70149ce18e554" title="Fail a call.">ast_cdr_failed</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);      <span class="comment">/* set the status to failed */</span>
<a name="l07933"></a>07933    <a class="code" href="cdr_8h.html#aaac5bba86e430704119f70df937701f8" title="Detaches the detail record for posting (and freeing) either now or at a later time...">ast_cdr_detach</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);      <span class="comment">/* post and free the record */</span>
<a name="l07934"></a>07934    chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> = NULL;
<a name="l07935"></a>07935    <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>(chan);         <span class="comment">/* free the channel */</span>
<a name="l07936"></a>07936 
<a name="l07937"></a>07937    <span class="keywordflow">return</span> 0;  <span class="comment">/* success */</span>
<a name="l07938"></a>07938 }
<a name="l07939"></a>07939 
<a name="l07940"></a><a class="code" href="pbx_8c.html#a5eae4dd649422c79ba5e2a320ab949ab">07940</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a7705e0c38bd69f8dceb03861f7527b60">ast_pbx_outgoing_exten</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> timeout, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority, <span class="keywordtype">int</span> *reason, <span class="keywordtype">int</span> synchronous, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *vars, <span class="keyword">const</span> <span class="keywordtype">char</span> *account, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> **channel)
<a name="l07941"></a>07941 {
<a name="l07942"></a>07942    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan;
<a name="l07943"></a>07943    <span class="keyword">struct </span><a class="code" href="structasync__stat.html">async_stat</a> *as;
<a name="l07944"></a>07944    <span class="keywordtype">int</span> res = -1, cdr_res = -1;
<a name="l07945"></a>07945    <span class="keyword">struct </span><a class="code" href="structoutgoing__helper.html">outgoing_helper</a> oh;
<a name="l07946"></a>07946 
<a name="l07947"></a>07947    <span class="keywordflow">if</span> (synchronous) {
<a name="l07948"></a>07948       oh.<a class="code" href="structoutgoing__helper.html#a94f090d1fb5c71712726fcdf025b9ace">context</a> = context;
<a name="l07949"></a>07949       oh.<a class="code" href="structoutgoing__helper.html#a762fadb5a38f004f5f4adf71176448e9">exten</a> = exten;
<a name="l07950"></a>07950       oh.<a class="code" href="structoutgoing__helper.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = priority;
<a name="l07951"></a>07951       oh.<a class="code" href="structoutgoing__helper.html#a1032774a59971af0f3555668407e7ec7">cid_num</a> = cid_num;
<a name="l07952"></a>07952       oh.<a class="code" href="structoutgoing__helper.html#a556b8c8508e4a08eb0b212664622306c">cid_name</a> = cid_name;
<a name="l07953"></a>07953       oh.<a class="code" href="structoutgoing__helper.html#a54735dbbeb30eacadc7e823d15cf03c6">account</a> = account;
<a name="l07954"></a>07954       oh.<a class="code" href="structoutgoing__helper.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = vars;
<a name="l07955"></a>07955       oh.<a class="code" href="structoutgoing__helper.html#aa4cddc3382d2056a04f09429ea360703">parent_channel</a> = NULL;
<a name="l07956"></a>07956 
<a name="l07957"></a>07957       chan = <a class="code" href="channel_8h.html#ad95519a1a1059cd3561ec5ae6c9a2e93" title="Request a channel of a given type, with data as optional information used by the...">__ast_request_and_dial</a>(type, format, data, timeout, reason, cid_num, cid_name, &amp;oh);
<a name="l07958"></a>07958       <span class="keywordflow">if</span> (channel) {
<a name="l07959"></a>07959          *channel = chan;
<a name="l07960"></a>07960          <span class="keywordflow">if</span> (chan)
<a name="l07961"></a>07961             <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l07962"></a>07962       }
<a name="l07963"></a>07963       <span class="keywordflow">if</span> (chan) {
<a name="l07964"></a>07964          <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l07965"></a>07965                res = 0;
<a name="l07966"></a>07966             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Channel %s was answered.\n&quot;</span>, chan-&gt;name);
<a name="l07967"></a>07967 
<a name="l07968"></a>07968             <span class="keywordflow">if</span> (synchronous &gt; 1) {
<a name="l07969"></a>07969                <span class="keywordflow">if</span> (channel)
<a name="l07970"></a>07970                   <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l07971"></a>07971                <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a44b6406c9220f7f2b610ac712369f405" title="Execute the PBX in the current thread.">ast_pbx_run</a>(chan)) {
<a name="l07972"></a>07972                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to run PBX on %s\n&quot;</span>, chan-&gt;name);
<a name="l07973"></a>07973                   <span class="keywordflow">if</span> (channel)
<a name="l07974"></a>07974                      *channel = NULL;
<a name="l07975"></a>07975                   <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l07976"></a>07976                   chan = NULL;
<a name="l07977"></a>07977                   res = -1;
<a name="l07978"></a>07978                }
<a name="l07979"></a>07979             } <span class="keywordflow">else</span> {
<a name="l07980"></a>07980                <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(chan)) {
<a name="l07981"></a>07981                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to start PBX on %s\n&quot;</span>, chan-&gt;name);
<a name="l07982"></a>07982                   <span class="keywordflow">if</span> (channel) {
<a name="l07983"></a>07983                      *channel = NULL;
<a name="l07984"></a>07984                      <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l07985"></a>07985                   }
<a name="l07986"></a>07986                   <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l07987"></a>07987                   res = -1;
<a name="l07988"></a>07988                }
<a name="l07989"></a>07989                chan = NULL;
<a name="l07990"></a>07990             }
<a name="l07991"></a>07991          } <span class="keywordflow">else</span> {
<a name="l07992"></a>07992             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Channel %s was never answered.\n&quot;</span>, chan-&gt;name);
<a name="l07993"></a>07993 
<a name="l07994"></a>07994             <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>) { <span class="comment">/* update the cdr */</span>
<a name="l07995"></a>07995                <span class="comment">/* here we update the status of the call, which sould be busy.</span>
<a name="l07996"></a>07996 <span class="comment">                * if that fails then we set the status to failed */</span>
<a name="l07997"></a>07997                <span class="keywordflow">if</span> (<a class="code" href="cdr_8h.html#a5468ad8b7a45f1f976728be1b23dde47" title="Save the result of the call based on the AST_CAUSE_*.">ast_cdr_disposition</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, chan-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a>))
<a name="l07998"></a>07998                   <a class="code" href="cdr_8h.html#acdce2d9d0af5180090b70149ce18e554" title="Fail a call.">ast_cdr_failed</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l07999"></a>07999             }
<a name="l08000"></a>08000 
<a name="l08001"></a>08001             <span class="keywordflow">if</span> (channel) {
<a name="l08002"></a>08002                *channel = NULL;
<a name="l08003"></a>08003                <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l08004"></a>08004             }
<a name="l08005"></a>08005             <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l08006"></a>08006             chan = NULL;
<a name="l08007"></a>08007          }
<a name="l08008"></a>08008       }
<a name="l08009"></a>08009 
<a name="l08010"></a>08010       <span class="keywordflow">if</span> (res &lt; 0) { <span class="comment">/* the call failed for some reason */</span>
<a name="l08011"></a>08011          <span class="keywordflow">if</span> (*reason == 0) { <span class="comment">/* if the call failed (not busy or no answer)</span>
<a name="l08012"></a>08012 <span class="comment">                        * update the cdr with the failed message */</span>
<a name="l08013"></a>08013             cdr_res = <a class="code" href="pbx_8c.html#a5a3064670e827b600404223a674d8bd1" title="Function to post an empty cdr after a spool call fails.">ast_pbx_outgoing_cdr_failed</a>();
<a name="l08014"></a>08014             <span class="keywordflow">if</span> (cdr_res != 0) {
<a name="l08015"></a>08015                res = cdr_res;
<a name="l08016"></a>08016                <span class="keywordflow">goto</span> outgoing_exten_cleanup;
<a name="l08017"></a>08017             }
<a name="l08018"></a>08018          }
<a name="l08019"></a>08019 
<a name="l08020"></a>08020          <span class="comment">/* create a fake channel and execute the &quot;failed&quot; extension (if it exists) within the requested context */</span>
<a name="l08021"></a>08021          <span class="comment">/* check if &quot;failed&quot; exists */</span>
<a name="l08022"></a>08022          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, context, <span class="stringliteral">&quot;failed&quot;</span>, 1, NULL)) {
<a name="l08023"></a>08023             chan = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;OutgoingSpoolFailed&quot;</span>);
<a name="l08024"></a>08024             <span class="keywordflow">if</span> (chan) {
<a name="l08025"></a>08025                <span class="keywordtype">char</span> failed_reason[4] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l08026"></a>08026                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(context))
<a name="l08027"></a>08027                   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, context, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l08028"></a>08028                <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(chan, <span class="stringliteral">&quot;failed&quot;</span>, 1);
<a name="l08029"></a>08029                <a class="code" href="channel_8h.html#a5b14bfe21364dd8f73d45f15cf313524" title="adds a list of channel variables to a channel">ast_set_variables</a>(chan, vars);
<a name="l08030"></a>08030                snprintf(failed_reason, <span class="keyword">sizeof</span>(failed_reason), <span class="stringliteral">&quot;%d&quot;</span>, *reason);
<a name="l08031"></a>08031                <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;REASON&quot;</span>, failed_reason);
<a name="l08032"></a>08032                <span class="keywordflow">if</span> (account)
<a name="l08033"></a>08033                   <a class="code" href="cdr_8h.html#af6bbc762c1482a5489a761733d785813" title="Set account code, will generate AMI event.">ast_cdr_setaccount</a>(chan, account);
<a name="l08034"></a>08034                <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a44b6406c9220f7f2b610ac712369f405" title="Execute the PBX in the current thread.">ast_pbx_run</a>(chan)) {
<a name="l08035"></a>08035                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to run PBX on %s\n&quot;</span>, chan-&gt;name);
<a name="l08036"></a>08036                   <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l08037"></a>08037                }
<a name="l08038"></a>08038                chan = NULL;
<a name="l08039"></a>08039             }
<a name="l08040"></a>08040          }
<a name="l08041"></a>08041       }
<a name="l08042"></a>08042    } <span class="keywordflow">else</span> {
<a name="l08043"></a>08043       <span class="keywordflow">if</span> (!(as = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*as)))) {
<a name="l08044"></a>08044          res = -1;
<a name="l08045"></a>08045          <span class="keywordflow">goto</span> outgoing_exten_cleanup;
<a name="l08046"></a>08046       }
<a name="l08047"></a>08047       chan = <a class="code" href="channel_8h.html#a24294594867068bcff6adad3fb868a25" title="Request a channel of a given type, with data as optional information used by the...">ast_request_and_dial</a>(type, format, data, timeout, reason, cid_num, cid_name);
<a name="l08048"></a>08048       <span class="keywordflow">if</span> (channel) {
<a name="l08049"></a>08049          *channel = chan;
<a name="l08050"></a>08050          <span class="keywordflow">if</span> (chan)
<a name="l08051"></a>08051             <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l08052"></a>08052       }
<a name="l08053"></a>08053       <span class="keywordflow">if</span> (!chan) {
<a name="l08054"></a>08054          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(as);
<a name="l08055"></a>08055          res = -1;
<a name="l08056"></a>08056          <span class="keywordflow">goto</span> outgoing_exten_cleanup;
<a name="l08057"></a>08057       }
<a name="l08058"></a>08058       as-&gt;<a class="code" href="structasync__stat.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = chan;
<a name="l08059"></a>08059       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(as-&gt;<a class="code" href="structasync__stat.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, context, <span class="keyword">sizeof</span>(as-&gt;<a class="code" href="structasync__stat.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l08060"></a>08060       <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(as-&gt;<a class="code" href="structasync__stat.html#a84d1435c5b8d387806714ea7079304b7">chan</a>,  exten, priority);
<a name="l08061"></a>08061       as-&gt;<a class="code" href="structasync__stat.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> = timeout;
<a name="l08062"></a>08062       <a class="code" href="channel_8h.html#a5b14bfe21364dd8f73d45f15cf313524" title="adds a list of channel variables to a channel">ast_set_variables</a>(chan, vars);
<a name="l08063"></a>08063       <span class="keywordflow">if</span> (account)
<a name="l08064"></a>08064          <a class="code" href="cdr_8h.html#af6bbc762c1482a5489a761733d785813" title="Set account code, will generate AMI event.">ast_cdr_setaccount</a>(chan, account);
<a name="l08065"></a>08065       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a832647380b1f97e7ac1b4492f8816d46">ast_pthread_create_detached</a>(&amp;as-&gt;<a class="code" href="structasync__stat.html#a1ad90c6e2b5f6774919078d93f443e30">p</a>, NULL, <a class="code" href="pbx_8c.html#a4f84706d30062086de7265597688040f">async_wait</a>, as)) {
<a name="l08066"></a>08066          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to start async wait\n&quot;</span>);
<a name="l08067"></a>08067          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(as);
<a name="l08068"></a>08068          <span class="keywordflow">if</span> (channel) {
<a name="l08069"></a>08069             *channel = NULL;
<a name="l08070"></a>08070             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l08071"></a>08071          }
<a name="l08072"></a>08072          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l08073"></a>08073          res = -1;
<a name="l08074"></a>08074          <span class="keywordflow">goto</span> outgoing_exten_cleanup;
<a name="l08075"></a>08075       }
<a name="l08076"></a>08076       res = 0;
<a name="l08077"></a>08077    }
<a name="l08078"></a>08078 outgoing_exten_cleanup:
<a name="l08079"></a>08079    <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(vars);
<a name="l08080"></a>08080    <span class="keywordflow">return</span> res;
<a name="l08081"></a>08081 }
<a name="l08082"></a>08082 
<a name="l08083"></a><a class="code" href="structapp__tmp.html">08083</a> <span class="keyword">struct </span><a class="code" href="structapp__tmp.html">app_tmp</a> {
<a name="l08084"></a><a class="code" href="structapp__tmp.html#a92669f702fa7ba792683dc1775f54b3a">08084</a>    <span class="keywordtype">char</span> app[256];
<a name="l08085"></a><a class="code" href="structapp__tmp.html#a8014e17e1c0d6bbf7ec1aec8d167a963">08085</a>    <span class="keywordtype">char</span> data[256];
<a name="l08086"></a><a class="code" href="structapp__tmp.html#a84d1435c5b8d387806714ea7079304b7">08086</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan;
<a name="l08087"></a><a class="code" href="structapp__tmp.html#aa49d6a06775253352589280dc7f30018">08087</a>    pthread_t t;
<a name="l08088"></a>08088 };
<a name="l08089"></a>08089 <span class="comment"></span>
<a name="l08090"></a>08090 <span class="comment">/*! \brief run the application and free the descriptor once done */</span>
<a name="l08091"></a><a class="code" href="pbx_8c.html#a9c507fd424bcfbe9d23caf2dd3457168">08091</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="pbx_8c.html#a9c507fd424bcfbe9d23caf2dd3457168" title="run the application and free the descriptor once done">ast_pbx_run_app</a>(<span class="keywordtype">void</span> *data)
<a name="l08092"></a>08092 {
<a name="l08093"></a>08093    <span class="keyword">struct </span><a class="code" href="structapp__tmp.html">app_tmp</a> *tmp = data;
<a name="l08094"></a>08094    <span class="keyword">struct </span>ast_app *app;
<a name="l08095"></a>08095    app = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(tmp-&gt;<a class="code" href="structapp__tmp.html#a92669f702fa7ba792683dc1775f54b3a">app</a>);
<a name="l08096"></a>08096    <span class="keywordflow">if</span> (app) {
<a name="l08097"></a>08097       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Launching %s(%s) on %s\n&quot;</span>, tmp-&gt;<a class="code" href="structapp__tmp.html#a92669f702fa7ba792683dc1775f54b3a">app</a>, tmp-&gt;<a class="code" href="structapp__tmp.html#a8014e17e1c0d6bbf7ec1aec8d167a963">data</a>, tmp-&gt;<a class="code" href="structapp__tmp.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l08098"></a>08098       <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(tmp-&gt;<a class="code" href="structapp__tmp.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, app, tmp-&gt;<a class="code" href="structapp__tmp.html#a8014e17e1c0d6bbf7ec1aec8d167a963">data</a>);
<a name="l08099"></a>08099    } <span class="keywordflow">else</span>
<a name="l08100"></a>08100       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such application &apos;%s&apos;\n&quot;</span>, tmp-&gt;<a class="code" href="structapp__tmp.html#a92669f702fa7ba792683dc1775f54b3a">app</a>);
<a name="l08101"></a>08101    <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tmp-&gt;<a class="code" href="structapp__tmp.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l08102"></a>08102    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l08103"></a>08103    <span class="keywordflow">return</span> NULL;
<a name="l08104"></a>08104 }
<a name="l08105"></a>08105 
<a name="l08106"></a><a class="code" href="pbx_8c.html#aea01d232e2d4b9037de13541e0048642">08106</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#ade584ae5e3eafb878535626ebe79e26d">ast_pbx_outgoing_app</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> timeout, <span class="keyword">const</span> <span class="keywordtype">char</span> *app, <span class="keyword">const</span> <span class="keywordtype">char</span> *appdata, <span class="keywordtype">int</span> *reason, <span class="keywordtype">int</span> synchronous, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *vars, <span class="keyword">const</span> <span class="keywordtype">char</span> *account, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> **locked_channel)
<a name="l08107"></a>08107 {
<a name="l08108"></a>08108    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan;
<a name="l08109"></a>08109    <span class="keyword">struct </span><a class="code" href="structapp__tmp.html">app_tmp</a> *tmp;
<a name="l08110"></a>08110    <span class="keywordtype">int</span> res = -1, cdr_res = -1;
<a name="l08111"></a>08111    <span class="keyword">struct </span><a class="code" href="structoutgoing__helper.html">outgoing_helper</a> oh;
<a name="l08112"></a>08112 
<a name="l08113"></a>08113    memset(&amp;oh, 0, <span class="keyword">sizeof</span>(oh));
<a name="l08114"></a>08114    oh.<a class="code" href="structoutgoing__helper.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = vars;
<a name="l08115"></a>08115    oh.<a class="code" href="structoutgoing__helper.html#a54735dbbeb30eacadc7e823d15cf03c6">account</a> = account;
<a name="l08116"></a>08116 
<a name="l08117"></a>08117    <span class="keywordflow">if</span> (locked_channel)
<a name="l08118"></a>08118       *locked_channel = NULL;
<a name="l08119"></a>08119    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(app)) {
<a name="l08120"></a>08120       res = -1;
<a name="l08121"></a>08121       <span class="keywordflow">goto</span> outgoing_app_cleanup;
<a name="l08122"></a>08122    }
<a name="l08123"></a>08123    <span class="keywordflow">if</span> (synchronous) {
<a name="l08124"></a>08124       chan = <a class="code" href="channel_8h.html#ad95519a1a1059cd3561ec5ae6c9a2e93" title="Request a channel of a given type, with data as optional information used by the...">__ast_request_and_dial</a>(type, format, data, timeout, reason, cid_num, cid_name, &amp;oh);
<a name="l08125"></a>08125       <span class="keywordflow">if</span> (chan) {
<a name="l08126"></a>08126          <a class="code" href="channel_8h.html#a5b14bfe21364dd8f73d45f15cf313524" title="adds a list of channel variables to a channel">ast_set_variables</a>(chan, vars);
<a name="l08127"></a>08127          <span class="keywordflow">if</span> (account)
<a name="l08128"></a>08128             <a class="code" href="cdr_8h.html#af6bbc762c1482a5489a761733d785813" title="Set account code, will generate AMI event.">ast_cdr_setaccount</a>(chan, account);
<a name="l08129"></a>08129          <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l08130"></a>08130             res = 0;
<a name="l08131"></a>08131             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Channel %s was answered.\n&quot;</span>, chan-&gt;name);
<a name="l08132"></a>08132             tmp = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tmp));
<a name="l08133"></a>08133             <span class="keywordflow">if</span> (!tmp)
<a name="l08134"></a>08134                res = -1;
<a name="l08135"></a>08135             <span class="keywordflow">else</span> {
<a name="l08136"></a>08136                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structapp__tmp.html#a92669f702fa7ba792683dc1775f54b3a">app</a>, app, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structapp__tmp.html#a92669f702fa7ba792683dc1775f54b3a">app</a>));
<a name="l08137"></a>08137                <span class="keywordflow">if</span> (appdata)
<a name="l08138"></a>08138                   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structapp__tmp.html#a8014e17e1c0d6bbf7ec1aec8d167a963">data</a>, appdata, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structapp__tmp.html#a8014e17e1c0d6bbf7ec1aec8d167a963">data</a>));
<a name="l08139"></a>08139                tmp-&gt;<a class="code" href="structapp__tmp.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = chan;
<a name="l08140"></a>08140                <span class="keywordflow">if</span> (synchronous &gt; 1) {
<a name="l08141"></a>08141                   <span class="keywordflow">if</span> (locked_channel)
<a name="l08142"></a>08142                      <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l08143"></a>08143                   <a class="code" href="pbx_8c.html#a9c507fd424bcfbe9d23caf2dd3457168" title="run the application and free the descriptor once done">ast_pbx_run_app</a>(tmp);
<a name="l08144"></a>08144                } <span class="keywordflow">else</span> {
<a name="l08145"></a>08145                   <span class="keywordflow">if</span> (locked_channel)
<a name="l08146"></a>08146                      <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l08147"></a>08147                   <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a832647380b1f97e7ac1b4492f8816d46">ast_pthread_create_detached</a>(&amp;tmp-&gt;<a class="code" href="structapp__tmp.html#aa49d6a06775253352589280dc7f30018">t</a>, NULL, <a class="code" href="pbx_8c.html#a9c507fd424bcfbe9d23caf2dd3457168" title="run the application and free the descriptor once done">ast_pbx_run_app</a>, tmp)) {
<a name="l08148"></a>08148                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to spawn execute thread on %s: %s\n&quot;</span>, chan-&gt;name, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l08149"></a>08149                      <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l08150"></a>08150                      <span class="keywordflow">if</span> (locked_channel)
<a name="l08151"></a>08151                         <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l08152"></a>08152                      <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l08153"></a>08153                      res = -1;
<a name="l08154"></a>08154                   } <span class="keywordflow">else</span> {
<a name="l08155"></a>08155                      <span class="keywordflow">if</span> (locked_channel)
<a name="l08156"></a>08156                         *locked_channel = chan;
<a name="l08157"></a>08157                   }
<a name="l08158"></a>08158                }
<a name="l08159"></a>08159             }
<a name="l08160"></a>08160          } <span class="keywordflow">else</span> {
<a name="l08161"></a>08161             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Channel %s was never answered.\n&quot;</span>, chan-&gt;name);
<a name="l08162"></a>08162             <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>) { <span class="comment">/* update the cdr */</span>
<a name="l08163"></a>08163                <span class="comment">/* here we update the status of the call, which sould be busy.</span>
<a name="l08164"></a>08164 <span class="comment">                * if that fails then we set the status to failed */</span>
<a name="l08165"></a>08165                <span class="keywordflow">if</span> (<a class="code" href="cdr_8h.html#a5468ad8b7a45f1f976728be1b23dde47" title="Save the result of the call based on the AST_CAUSE_*.">ast_cdr_disposition</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, chan-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a>))
<a name="l08166"></a>08166                   <a class="code" href="cdr_8h.html#acdce2d9d0af5180090b70149ce18e554" title="Fail a call.">ast_cdr_failed</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l08167"></a>08167             }
<a name="l08168"></a>08168             <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l08169"></a>08169          }
<a name="l08170"></a>08170       }
<a name="l08171"></a>08171 
<a name="l08172"></a>08172       <span class="keywordflow">if</span> (res &lt; 0) { <span class="comment">/* the call failed for some reason */</span>
<a name="l08173"></a>08173          <span class="keywordflow">if</span> (*reason == 0) { <span class="comment">/* if the call failed (not busy or no answer)</span>
<a name="l08174"></a>08174 <span class="comment">                        * update the cdr with the failed message */</span>
<a name="l08175"></a>08175             cdr_res = <a class="code" href="pbx_8c.html#a5a3064670e827b600404223a674d8bd1" title="Function to post an empty cdr after a spool call fails.">ast_pbx_outgoing_cdr_failed</a>();
<a name="l08176"></a>08176             <span class="keywordflow">if</span> (cdr_res != 0) {
<a name="l08177"></a>08177                res = cdr_res;
<a name="l08178"></a>08178                <span class="keywordflow">goto</span> outgoing_app_cleanup;
<a name="l08179"></a>08179             }
<a name="l08180"></a>08180          }
<a name="l08181"></a>08181       }
<a name="l08182"></a>08182 
<a name="l08183"></a>08183    } <span class="keywordflow">else</span> {
<a name="l08184"></a>08184       <span class="keyword">struct </span><a class="code" href="structasync__stat.html">async_stat</a> *as;
<a name="l08185"></a>08185       <span class="keywordflow">if</span> (!(as = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*as)))) {
<a name="l08186"></a>08186          res = -1;
<a name="l08187"></a>08187          <span class="keywordflow">goto</span> outgoing_app_cleanup;
<a name="l08188"></a>08188       }
<a name="l08189"></a>08189       chan = <a class="code" href="channel_8h.html#ad95519a1a1059cd3561ec5ae6c9a2e93" title="Request a channel of a given type, with data as optional information used by the...">__ast_request_and_dial</a>(type, format, data, timeout, reason, cid_num, cid_name, &amp;oh);
<a name="l08190"></a>08190       <span class="keywordflow">if</span> (!chan) {
<a name="l08191"></a>08191          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(as);
<a name="l08192"></a>08192          res = -1;
<a name="l08193"></a>08193          <span class="keywordflow">goto</span> outgoing_app_cleanup;
<a name="l08194"></a>08194       }
<a name="l08195"></a>08195       as-&gt;<a class="code" href="structasync__stat.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = chan;
<a name="l08196"></a>08196       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(as-&gt;<a class="code" href="structasync__stat.html#aec08c35c18f813f66ece0fe52fed7a6d">app</a>, app, <span class="keyword">sizeof</span>(as-&gt;<a class="code" href="structasync__stat.html#aec08c35c18f813f66ece0fe52fed7a6d">app</a>));
<a name="l08197"></a>08197       <span class="keywordflow">if</span> (appdata)
<a name="l08198"></a>08198          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(as-&gt;<a class="code" href="structasync__stat.html#a365df2111e505119a9cc91ea9e6d43bd">appdata</a>,  appdata, <span class="keyword">sizeof</span>(as-&gt;<a class="code" href="structasync__stat.html#a365df2111e505119a9cc91ea9e6d43bd">appdata</a>));
<a name="l08199"></a>08199       as-&gt;<a class="code" href="structasync__stat.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> = timeout;
<a name="l08200"></a>08200       <a class="code" href="channel_8h.html#a5b14bfe21364dd8f73d45f15cf313524" title="adds a list of channel variables to a channel">ast_set_variables</a>(chan, vars);
<a name="l08201"></a>08201       <span class="keywordflow">if</span> (account)
<a name="l08202"></a>08202          <a class="code" href="cdr_8h.html#af6bbc762c1482a5489a761733d785813" title="Set account code, will generate AMI event.">ast_cdr_setaccount</a>(chan, account);
<a name="l08203"></a>08203       <span class="comment">/* Start a new thread, and get something handling this channel. */</span>
<a name="l08204"></a>08204       <span class="keywordflow">if</span> (locked_channel)
<a name="l08205"></a>08205          <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l08206"></a>08206       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a832647380b1f97e7ac1b4492f8816d46">ast_pthread_create_detached</a>(&amp;as-&gt;<a class="code" href="structasync__stat.html#a1ad90c6e2b5f6774919078d93f443e30">p</a>, NULL, <a class="code" href="pbx_8c.html#a4f84706d30062086de7265597688040f">async_wait</a>, as)) {
<a name="l08207"></a>08207          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to start async wait\n&quot;</span>);
<a name="l08208"></a>08208          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(as);
<a name="l08209"></a>08209          <span class="keywordflow">if</span> (locked_channel)
<a name="l08210"></a>08210             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l08211"></a>08211          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l08212"></a>08212          res = -1;
<a name="l08213"></a>08213          <span class="keywordflow">goto</span> outgoing_app_cleanup;
<a name="l08214"></a>08214       } <span class="keywordflow">else</span> {
<a name="l08215"></a>08215          <span class="keywordflow">if</span> (locked_channel)
<a name="l08216"></a>08216             *locked_channel = chan;
<a name="l08217"></a>08217       }
<a name="l08218"></a>08218       res = 0;
<a name="l08219"></a>08219    }
<a name="l08220"></a>08220 outgoing_app_cleanup:
<a name="l08221"></a>08221    <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(vars);
<a name="l08222"></a>08222    <span class="keywordflow">return</span> res;
<a name="l08223"></a>08223 }
<a name="l08224"></a>08224 
<a name="l08225"></a>08225 <span class="comment">/* this is the guts of destroying a context --</span>
<a name="l08226"></a>08226 <span class="comment">   freeing up the structure, traversing and destroying the</span>
<a name="l08227"></a>08227 <span class="comment">   extensions, switches, ignorepats, includes, etc. etc. */</span>
<a name="l08228"></a>08228 
<a name="l08229"></a><a class="code" href="pbx_8c.html#af51adb9b78f628397d7b0c1781b6d79e">08229</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#af51adb9b78f628397d7b0c1781b6d79e">__ast_internal_context_destroy</a>( <span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con)
<a name="l08230"></a>08230 {
<a name="l08231"></a>08231    <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *tmpi;
<a name="l08232"></a>08232    <span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *sw;
<a name="l08233"></a>08233    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e, *<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, *en;
<a name="l08234"></a>08234    <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ipi;
<a name="l08235"></a>08235    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *tmp = con;
<a name="l08236"></a>08236 
<a name="l08237"></a>08237    <span class="keywordflow">for</span> (tmpi = tmp-&gt;<a class="code" href="structast__context.html#abaa8691efe3e8fe26f5930720bfd8edb">includes</a>; tmpi; ) { <span class="comment">/* Free includes */</span>
<a name="l08238"></a>08238       <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *tmpil = tmpi;
<a name="l08239"></a>08239       tmpi = tmpi-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a>;
<a name="l08240"></a>08240       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmpil);
<a name="l08241"></a>08241    }
<a name="l08242"></a>08242    <span class="keywordflow">for</span> (ipi = tmp-&gt;<a class="code" href="structast__context.html#aedb0afcd332920e51d2f82860f794347">ignorepats</a>; ipi; ) { <span class="comment">/* Free ignorepats */</span>
<a name="l08243"></a>08243       <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ipl = ipi;
<a name="l08244"></a>08244       ipi = ipi-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a>;
<a name="l08245"></a>08245       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ipl);
<a name="l08246"></a>08246    }
<a name="l08247"></a>08247    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>)
<a name="l08248"></a>08248       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l08249"></a>08249 
<a name="l08250"></a>08250    <span class="comment">/* destroy the hash tabs */</span>
<a name="l08251"></a>08251    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>) {
<a name="l08252"></a>08252       <a class="code" href="hashtab_8h.html#a6103589badf8d9440a0cece2802c4c3a" title="This func will free the hash table and all its memory.">ast_hashtab_destroy</a>(tmp-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>, 0);
<a name="l08253"></a>08253    }
<a name="l08254"></a>08254    <span class="comment">/* and destroy the pattern tree */</span>
<a name="l08255"></a>08255    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>)
<a name="l08256"></a>08256       <a class="code" href="pbx_8c.html#a3900cc7c8183ab6a7316f5dbc2b955ed">destroy_pattern_tree</a>(tmp-&gt;<a class="code" href="structast__context.html#a2fa7eba1ccec8820c766879753569da0">pattern_tree</a>);
<a name="l08257"></a>08257 
<a name="l08258"></a>08258    <span class="keywordflow">while</span> ((sw = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;tmp-&gt;<a class="code" href="structast__context.html#a1a88e64f1d400d544879fb192cb155e7">alts</a>, list)))
<a name="l08259"></a>08259       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sw);
<a name="l08260"></a>08260    <span class="keywordflow">for</span> (e = tmp-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a>; e;) {
<a name="l08261"></a>08261       <span class="keywordflow">for</span> (en = e-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>; en;) {
<a name="l08262"></a>08262          el = en;
<a name="l08263"></a>08263          en = en-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a>;
<a name="l08264"></a>08264          <a class="code" href="pbx_8c.html#ae25a2122becbf9b94f5d55bc86753fea">destroy_exten</a>(el);
<a name="l08265"></a>08265       }
<a name="l08266"></a>08266       el = e;
<a name="l08267"></a>08267       e = e-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>;
<a name="l08268"></a>08268       <a class="code" href="pbx_8c.html#ae25a2122becbf9b94f5d55bc86753fea">destroy_exten</a>(el);
<a name="l08269"></a>08269    }
<a name="l08270"></a>08270    tmp-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a> = NULL;
<a name="l08271"></a>08271    <a class="code" href="lock_8h.html#aa1e308479619b6e2a20c7b27479cafa9">ast_rwlock_destroy</a>(&amp;tmp-&gt;<a class="code" href="structast__context.html#ace4e0066a5b24f84b90536e9906619f6">lock</a>);
<a name="l08272"></a>08272    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l08273"></a>08273 }
<a name="l08274"></a>08274 
<a name="l08275"></a>08275 
<a name="l08276"></a><a class="code" href="pbx_8c.html#a06e285124697319566d67b82c25aba19">08276</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a06e285124697319566d67b82c25aba19">__ast_context_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *list, <span class="keyword">struct</span> <a class="code" href="structast__hashtab.html">ast_hashtab</a> *contexttab, <span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l08277"></a>08277 {
<a name="l08278"></a>08278    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *tmp, *tmpl=NULL;
<a name="l08279"></a>08279    <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *exten_item, *prio_item;
<a name="l08280"></a>08280 
<a name="l08281"></a>08281    <span class="keywordflow">for</span> (tmp = list; tmp; ) {
<a name="l08282"></a>08282       <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="structast__sw.html#a9dba44603dc55a347a5cbe388aeac9f0">next</a> = NULL; <span class="comment">/* next starting point */</span>
<a name="l08283"></a>08283          <span class="comment">/* The following code used to skip forward to the next</span>
<a name="l08284"></a>08284 <span class="comment">            context with matching registrar, but this didn&apos;t</span>
<a name="l08285"></a>08285 <span class="comment">            make sense; individual priorities registrar&apos;d to</span>
<a name="l08286"></a>08286 <span class="comment">            the matching registrar could occur in any context! */</span>
<a name="l08287"></a>08287       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Investigate ctx %s %s\n&quot;</span>, tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, tmp-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l08288"></a>08288       <span class="keywordflow">if</span> (con) {
<a name="l08289"></a>08289          <span class="keywordflow">for</span> (; tmp; tmpl = tmp, tmp = tmp-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a>) { <span class="comment">/* skip to the matching context */</span>
<a name="l08290"></a>08290             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;check ctx %s %s\n&quot;</span>, tmp-&gt;name, tmp-&gt;registrar);
<a name="l08291"></a>08291             <span class="keywordflow">if</span> ( !strcasecmp(tmp-&gt;name, con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>) ) {
<a name="l08292"></a>08292                <span class="keywordflow">break</span>;   <span class="comment">/* found it */</span>
<a name="l08293"></a>08293             }
<a name="l08294"></a>08294          }
<a name="l08295"></a>08295       }
<a name="l08296"></a>08296 
<a name="l08297"></a>08297       <span class="keywordflow">if</span> (!tmp)   <span class="comment">/* not found, we are done */</span>
<a name="l08298"></a>08298          <span class="keywordflow">break</span>;
<a name="l08299"></a>08299       <a class="code" href="pbx_8h.html#a2c961dcbdcade8fac28960ed67c89bd2" title="Write locks a given context.">ast_wrlock_context</a>(tmp);
<a name="l08300"></a>08300 
<a name="l08301"></a>08301       <span class="keywordflow">if</span> (registrar) {
<a name="l08302"></a>08302          <span class="comment">/* then search thru and remove any extens that match registrar. */</span>
<a name="l08303"></a>08303          <span class="keyword">struct </span><a class="code" href="structast__hashtab__iter.html" title="an iterator for traversing the buckets">ast_hashtab_iter</a> *exten_iter;
<a name="l08304"></a>08304          <span class="keyword">struct </span><a class="code" href="structast__hashtab__iter.html" title="an iterator for traversing the buckets">ast_hashtab_iter</a> *prio_iter;
<a name="l08305"></a>08305          <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ip, *ipl = NULL, *ipn = NULL;
<a name="l08306"></a>08306          <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *i, *pi = NULL, *ni = NULL;
<a name="l08307"></a>08307          <span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *sw = NULL;
<a name="l08308"></a>08308 
<a name="l08309"></a>08309          <span class="comment">/* remove any ignorepats whose registrar matches */</span>
<a name="l08310"></a>08310          <span class="keywordflow">for</span> (ip = tmp-&gt;<a class="code" href="structast__context.html#aedb0afcd332920e51d2f82860f794347">ignorepats</a>; ip; ip = ipn) {
<a name="l08311"></a>08311             ipn = ip-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a>;
<a name="l08312"></a>08312             <span class="keywordflow">if</span> (!strcmp(ip-&gt;<a class="code" href="structast__ignorepat.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>, registrar)) {
<a name="l08313"></a>08313                <span class="keywordflow">if</span> (ipl) {
<a name="l08314"></a>08314                   ipl-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a> = ip-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a>;
<a name="l08315"></a>08315                   <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ip);
<a name="l08316"></a>08316                   <span class="keywordflow">continue</span>; <span class="comment">/* don&apos;t change ipl */</span>
<a name="l08317"></a>08317                } <span class="keywordflow">else</span> {
<a name="l08318"></a>08318                   tmp-&gt;<a class="code" href="structast__context.html#aedb0afcd332920e51d2f82860f794347">ignorepats</a> = ip-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a>;
<a name="l08319"></a>08319                   <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ip);
<a name="l08320"></a>08320                   <span class="keywordflow">continue</span>; <span class="comment">/* don&apos;t change ipl */</span>
<a name="l08321"></a>08321                }
<a name="l08322"></a>08322             }
<a name="l08323"></a>08323             ipl = ip;
<a name="l08324"></a>08324          }
<a name="l08325"></a>08325          <span class="comment">/* remove any includes whose registrar matches */</span>
<a name="l08326"></a>08326          <span class="keywordflow">for</span> (i = tmp-&gt;<a class="code" href="structast__context.html#abaa8691efe3e8fe26f5930720bfd8edb">includes</a>; i; i = ni) {
<a name="l08327"></a>08327             ni = i-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a>;
<a name="l08328"></a>08328             <span class="keywordflow">if</span> (strcmp(i-&gt;<a class="code" href="structast__include.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>, registrar) == 0) {
<a name="l08329"></a>08329                <span class="comment">/* remove from list */</span>
<a name="l08330"></a>08330                <span class="keywordflow">if</span> (pi) {
<a name="l08331"></a>08331                   pi-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a> = i-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a>;
<a name="l08332"></a>08332                   <span class="comment">/* free include */</span>
<a name="l08333"></a>08333                   <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(i);
<a name="l08334"></a>08334                   <span class="keywordflow">continue</span>; <span class="comment">/* don&apos;t change pi */</span>
<a name="l08335"></a>08335                } <span class="keywordflow">else</span> {
<a name="l08336"></a>08336                   tmp-&gt;<a class="code" href="structast__context.html#abaa8691efe3e8fe26f5930720bfd8edb">includes</a> = i-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a>;
<a name="l08337"></a>08337                   <span class="comment">/* free include */</span>
<a name="l08338"></a>08338                   <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(i);
<a name="l08339"></a>08339                   <span class="keywordflow">continue</span>; <span class="comment">/* don&apos;t change pi */</span>
<a name="l08340"></a>08340                }
<a name="l08341"></a>08341             }
<a name="l08342"></a>08342             pi = i;
<a name="l08343"></a>08343          }
<a name="l08344"></a>08344          <span class="comment">/* remove any switches whose registrar matches */</span>
<a name="l08345"></a>08345          <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;tmp-&gt;<a class="code" href="structast__context.html#a1a88e64f1d400d544879fb192cb155e7">alts</a>, sw, list) {
<a name="l08346"></a>08346             <span class="keywordflow">if</span> (strcmp(sw-&gt;<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>,registrar) == 0) {
<a name="l08347"></a>08347                <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l08348"></a>08348                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sw);
<a name="l08349"></a>08349             }
<a name="l08350"></a>08350          }
<a name="l08351"></a>08351          <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l08352"></a>08352 
<a name="l08353"></a>08353          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>) { <span class="comment">/* it is entirely possible that the context is EMPTY */</span>
<a name="l08354"></a>08354             exten_iter = <a class="code" href="hashtab_8h.html#ac5a19bffadbbd4eb31f190e576f88512" title="Gives an iterator to hastable.">ast_hashtab_start_traversal</a>(tmp-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>);
<a name="l08355"></a>08355             <span class="keywordflow">while</span> ((exten_item=<a class="code" href="hashtab_8h.html#a43983b6169e9a0f9af48cca5cf9d3197" title="Gets the next object in the list, advances iter one step returns null on end of traversal...">ast_hashtab_next</a>(exten_iter))) {
<a name="l08356"></a>08356                prio_iter = <a class="code" href="hashtab_8h.html#ac5a19bffadbbd4eb31f190e576f88512" title="Gives an iterator to hastable.">ast_hashtab_start_traversal</a>(exten_item-&gt;<a class="code" href="structast__exten.html#a11a2e693c2355642149ba92ac86db8f9">peer_table</a>);
<a name="l08357"></a>08357                <span class="keywordflow">while</span> ((prio_item=<a class="code" href="hashtab_8h.html#a43983b6169e9a0f9af48cca5cf9d3197" title="Gets the next object in the list, advances iter one step returns null on end of traversal...">ast_hashtab_next</a>(prio_iter))) {
<a name="l08358"></a>08358                   <span class="keywordflow">if</span> (!prio_item-&gt;<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a> || strcmp(prio_item-&gt;<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>, registrar) != 0) {
<a name="l08359"></a>08359                      <span class="keywordflow">continue</span>;
<a name="l08360"></a>08360                   }
<a name="l08361"></a>08361                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Remove %s/%s/%d, registrar=%s; con=%s(%p); con-&gt;root=%p\n&quot;</span>,
<a name="l08362"></a>08362                          tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, prio_item-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, prio_item-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, registrar, con? con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a> : <span class="stringliteral">&quot;&lt;nil&gt;&quot;</span>, con, con? con-&gt;<a class="code" href="structast__context.html#ab89d9c8c0b08ae6e239f17da8f25a7b3">root_table</a>: NULL);
<a name="l08363"></a>08363                   <span class="comment">/* set matchcid to 1 to insure we get a direct match, and NULL registrar to make sure no wildcarding is done */</span>
<a name="l08364"></a>08364                   <a class="code" href="pbx_8h.html#abb8840d8ea2dd143fa4f606d048ad6b7">ast_context_remove_extension_callerid2</a>(tmp, prio_item-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a>, prio_item-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, prio_item-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>, 1, NULL, 1);
<a name="l08365"></a>08365                }
<a name="l08366"></a>08366                <a class="code" href="hashtab_8h.html#a9c804e9bfc8355c25197187f0c6d0265" title="end the traversal, free the iterator, unlock if necc.">ast_hashtab_end_traversal</a>(prio_iter);
<a name="l08367"></a>08367             }
<a name="l08368"></a>08368             <a class="code" href="hashtab_8h.html#a9c804e9bfc8355c25197187f0c6d0265" title="end the traversal, free the iterator, unlock if necc.">ast_hashtab_end_traversal</a>(exten_iter);
<a name="l08369"></a>08369          }
<a name="l08370"></a>08370 
<a name="l08371"></a>08371          <span class="comment">/* delete the context if it&apos;s registrar matches, is empty, has refcount of 1, */</span>
<a name="l08372"></a>08372          <span class="comment">/* it&apos;s not empty, if it has includes, ignorepats, or switches that are registered from</span>
<a name="l08373"></a>08373 <span class="comment">            another registrar. It&apos;s not empty if there are any extensions */</span>
<a name="l08374"></a>08374          <span class="keywordflow">if</span> (strcmp(tmp-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>, registrar) == 0 &amp;&amp; tmp-&gt;<a class="code" href="structast__context.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a> &lt; 2 &amp;&amp; !tmp-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a> &amp;&amp; !tmp-&gt;<a class="code" href="structast__context.html#aedb0afcd332920e51d2f82860f794347">ignorepats</a> &amp;&amp; !tmp-&gt;<a class="code" href="structast__context.html#abaa8691efe3e8fe26f5930720bfd8edb">includes</a> &amp;&amp; <a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;tmp-&gt;<a class="code" href="structast__context.html#a1a88e64f1d400d544879fb192cb155e7">alts</a>)) {
<a name="l08375"></a>08375             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;delete ctx %s %s\n&quot;</span>, tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, tmp-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l08376"></a>08376             <a class="code" href="hashtab_8h.html#a71bd19ff2f6fad1cf5e01f9b8cad6f66" title="Hash the object and then compare ptrs in bucket list instead of calling the compare...">ast_hashtab_remove_this_object</a>(contexttab, tmp);
<a name="l08377"></a>08377 
<a name="l08378"></a>08378             next = tmp-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a>;
<a name="l08379"></a>08379             <span class="keywordflow">if</span> (tmpl)
<a name="l08380"></a>08380                tmpl-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a> = next;
<a name="l08381"></a>08381             <span class="keywordflow">else</span>
<a name="l08382"></a>08382                <a class="code" href="pbx_8c.html#aae85d5aab50f2d1b8392d6df276f2561">contexts</a> = next;
<a name="l08383"></a>08383             <span class="comment">/* Okay, now we&apos;re safe to let it go -- in a sense, we were</span>
<a name="l08384"></a>08384 <span class="comment">               ready to let it go as soon as we locked it. */</span>
<a name="l08385"></a>08385             <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(tmp);
<a name="l08386"></a>08386             <a class="code" href="pbx_8c.html#af51adb9b78f628397d7b0c1781b6d79e">__ast_internal_context_destroy</a>(tmp);
<a name="l08387"></a>08387          } <span class="keywordflow">else</span> {
<a name="l08388"></a>08388             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;Couldn&apos;t delete ctx %s/%s; refc=%d; tmp.root=%p\n&quot;</span>, tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, tmp-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>,
<a name="l08389"></a>08389                     tmp-&gt;<a class="code" href="structast__context.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a>, tmp-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a>);
<a name="l08390"></a>08390             <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(tmp);
<a name="l08391"></a>08391             next = tmp-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a>;
<a name="l08392"></a>08392             tmpl = tmp;
<a name="l08393"></a>08393          }
<a name="l08394"></a>08394       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (con) {
<a name="l08395"></a>08395          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Deleting context %s registrar=%s\n&quot;</span>, tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, tmp-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l08396"></a>08396          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;delete ctx %s %s\n&quot;</span>, tmp-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, tmp-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l08397"></a>08397          <a class="code" href="hashtab_8h.html#a71bd19ff2f6fad1cf5e01f9b8cad6f66" title="Hash the object and then compare ptrs in bucket list instead of calling the compare...">ast_hashtab_remove_this_object</a>(contexttab, tmp);
<a name="l08398"></a>08398 
<a name="l08399"></a>08399          next = tmp-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a>;
<a name="l08400"></a>08400          <span class="keywordflow">if</span> (tmpl)
<a name="l08401"></a>08401             tmpl-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a> = next;
<a name="l08402"></a>08402          <span class="keywordflow">else</span>
<a name="l08403"></a>08403             <a class="code" href="pbx_8c.html#aae85d5aab50f2d1b8392d6df276f2561">contexts</a> = next;
<a name="l08404"></a>08404          <span class="comment">/* Okay, now we&apos;re safe to let it go -- in a sense, we were</span>
<a name="l08405"></a>08405 <span class="comment">            ready to let it go as soon as we locked it. */</span>
<a name="l08406"></a>08406          <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(tmp);
<a name="l08407"></a>08407          <a class="code" href="pbx_8c.html#af51adb9b78f628397d7b0c1781b6d79e">__ast_internal_context_destroy</a>(tmp);
<a name="l08408"></a>08408       }
<a name="l08409"></a>08409 
<a name="l08410"></a>08410       <span class="comment">/* if we have a specific match, we are done, otherwise continue */</span>
<a name="l08411"></a>08411       tmp = con ? NULL : next;
<a name="l08412"></a>08412    }
<a name="l08413"></a>08413 }
<a name="l08414"></a>08414 
<a name="l08415"></a><a class="code" href="pbx_8c.html#a9546b830c22c693a2baed08e48569401">08415</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8h.html#a9546b830c22c693a2baed08e48569401" title="Destroy a context (matches the specified context (or ANY context if NULL).">ast_context_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a>)
<a name="l08416"></a>08416 {
<a name="l08417"></a>08417    <a class="code" href="pbx_8h.html#a18c87dac5f7f4368c11b67d8026adc22" title="Write locks the context list.">ast_wrlock_contexts</a>();
<a name="l08418"></a>08418    <a class="code" href="pbx_8c.html#a06e285124697319566d67b82c25aba19">__ast_context_destroy</a>(<a class="code" href="pbx_8c.html#aae85d5aab50f2d1b8392d6df276f2561">contexts</a>, <a class="code" href="pbx_8c.html#a4571322b2dc5414f61e4f3fe7af2331c">contexts_table</a>, con,registrar);
<a name="l08419"></a>08419    <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l08420"></a>08420 }
<a name="l08421"></a>08421 
<a name="l08422"></a><a class="code" href="pbx_8c.html#ab75080c1a163039879284089415e416f">08422</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#ab75080c1a163039879284089415e416f">wait_for_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08423"></a>08423 {
<a name="l08424"></a>08424    <span class="keywordtype">int</span> res;
<a name="l08425"></a>08425    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l08426"></a>08426    <span class="keywordtype">double</span> waitsec;
<a name="l08427"></a>08427    <span class="keywordtype">int</span> waittime;
<a name="l08428"></a>08428 
<a name="l08429"></a>08429    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data) || (sscanf(data, <span class="stringliteral">&quot;%30lg&quot;</span>, &amp;waitsec) != 1) || (waitsec &lt; 0))
<a name="l08430"></a>08430       waitsec = -1;
<a name="l08431"></a>08431    <span class="keywordflow">if</span> (waitsec &gt; -1) {
<a name="l08432"></a>08432       waittime = waitsec * 1000.0;
<a name="l08433"></a>08433       <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(chan, waittime);
<a name="l08434"></a>08434    } <span class="keywordflow">else</span> <span class="keywordflow">do</span> {
<a name="l08435"></a>08435       res = <a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, -1);
<a name="l08436"></a>08436       <span class="keywordflow">if</span> (res &lt; 0)
<a name="l08437"></a>08437          <span class="keywordflow">return</span>;
<a name="l08438"></a>08438       f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan);
<a name="l08439"></a>08439       <span class="keywordflow">if</span> (f)
<a name="l08440"></a>08440          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l08441"></a>08441    } <span class="keywordflow">while</span>(f);
<a name="l08442"></a>08442 }
<a name="l08443"></a>08443 <span class="comment"></span>
<a name="l08444"></a>08444 <span class="comment">/*!</span>
<a name="l08445"></a>08445 <span class="comment"> * \ingroup applications</span>
<a name="l08446"></a>08446 <span class="comment"> */</span>
<a name="l08447"></a><a class="code" href="group__applications.html#ga8511a318e816998621739771aaab5a1f">08447</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga8511a318e816998621739771aaab5a1f">pbx_builtin_proceeding</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08448"></a>08448 {
<a name="l08449"></a>08449    <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a50b7fe33bba67b74dd7b746539e81000">AST_CONTROL_PROCEEDING</a>);
<a name="l08450"></a>08450    <span class="keywordflow">return</span> 0;
<a name="l08451"></a>08451 }
<a name="l08452"></a>08452 <span class="comment"></span>
<a name="l08453"></a>08453 <span class="comment">/*!</span>
<a name="l08454"></a>08454 <span class="comment"> * \ingroup applications</span>
<a name="l08455"></a>08455 <span class="comment"> */</span>
<a name="l08456"></a><a class="code" href="group__applications.html#ga0afd7cd1dcef243a218c70fe30551b15">08456</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga0afd7cd1dcef243a218c70fe30551b15">pbx_builtin_progress</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08457"></a>08457 {
<a name="l08458"></a>08458    <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a1a461c5e737ed6ed7c8cb0f78557a6fd">AST_CONTROL_PROGRESS</a>);
<a name="l08459"></a>08459    <span class="keywordflow">return</span> 0;
<a name="l08460"></a>08460 }
<a name="l08461"></a>08461 <span class="comment"></span>
<a name="l08462"></a>08462 <span class="comment">/*!</span>
<a name="l08463"></a>08463 <span class="comment"> * \ingroup applications</span>
<a name="l08464"></a>08464 <span class="comment"> */</span>
<a name="l08465"></a><a class="code" href="group__applications.html#ga9dadf39fac4d7bf36c38ce43bef6e8bc">08465</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga9dadf39fac4d7bf36c38ce43bef6e8bc">pbx_builtin_ringing</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08466"></a>08466 {
<a name="l08467"></a>08467    <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>);
<a name="l08468"></a>08468    <span class="keywordflow">return</span> 0;
<a name="l08469"></a>08469 }
<a name="l08470"></a>08470 <span class="comment"></span>
<a name="l08471"></a>08471 <span class="comment">/*!</span>
<a name="l08472"></a>08472 <span class="comment"> * \ingroup applications</span>
<a name="l08473"></a>08473 <span class="comment"> */</span>
<a name="l08474"></a><a class="code" href="group__applications.html#gafdd3cfad2a2fa9180649782c8794b01f">08474</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#gafdd3cfad2a2fa9180649782c8794b01f">pbx_builtin_busy</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08475"></a>08475 {
<a name="l08476"></a>08476    <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a387635982df3d2edb669a1eece92c875">AST_CONTROL_BUSY</a>);
<a name="l08477"></a>08477    <span class="comment">/* Don&apos;t change state of an UP channel, just indicate</span>
<a name="l08478"></a>08478 <span class="comment">      busy in audio */</span>
<a name="l08479"></a>08479    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l08480"></a>08480       <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(chan, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa00d313d1a4f4502932f1c10bd619591">AST_STATE_BUSY</a>);
<a name="l08481"></a>08481       <a class="code" href="cdr_8h.html#a4df18ef44f74b2dce240ca02a9c22ddf" title="Busy a call.">ast_cdr_busy</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l08482"></a>08482    }
<a name="l08483"></a>08483    <a class="code" href="pbx_8c.html#ab75080c1a163039879284089415e416f">wait_for_hangup</a>(chan, data);
<a name="l08484"></a>08484    <span class="keywordflow">return</span> -1;
<a name="l08485"></a>08485 }
<a name="l08486"></a>08486 <span class="comment"></span>
<a name="l08487"></a>08487 <span class="comment">/*!</span>
<a name="l08488"></a>08488 <span class="comment"> * \ingroup applications</span>
<a name="l08489"></a>08489 <span class="comment"> */</span>
<a name="l08490"></a><a class="code" href="group__applications.html#ga5f356581010a6f1ed24407db1758cdc2">08490</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga5f356581010a6f1ed24407db1758cdc2">pbx_builtin_congestion</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08491"></a>08491 {
<a name="l08492"></a>08492    <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a850bb06a1702741c93a3fd67cc9637ab">AST_CONTROL_CONGESTION</a>);
<a name="l08493"></a>08493    <span class="comment">/* Don&apos;t change state of an UP channel, just indicate</span>
<a name="l08494"></a>08494 <span class="comment">      congestion in audio */</span>
<a name="l08495"></a>08495    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)
<a name="l08496"></a>08496       <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(chan, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa00d313d1a4f4502932f1c10bd619591">AST_STATE_BUSY</a>);
<a name="l08497"></a>08497    <a class="code" href="pbx_8c.html#ab75080c1a163039879284089415e416f">wait_for_hangup</a>(chan, data);
<a name="l08498"></a>08498    <span class="keywordflow">return</span> -1;
<a name="l08499"></a>08499 }
<a name="l08500"></a>08500 <span class="comment"></span>
<a name="l08501"></a>08501 <span class="comment">/*!</span>
<a name="l08502"></a>08502 <span class="comment"> * \ingroup applications</span>
<a name="l08503"></a>08503 <span class="comment"> */</span>
<a name="l08504"></a><a class="code" href="group__applications.html#ga07e7e350a58c79e93f784ca58ee57988">08504</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga07e7e350a58c79e93f784ca58ee57988">pbx_builtin_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08505"></a>08505 {
<a name="l08506"></a>08506    <span class="keywordtype">int</span> delay = 0;
<a name="l08507"></a>08507    <span class="keywordtype">int</span> answer_cdr = 1;
<a name="l08508"></a>08508    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l08509"></a>08509    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l08510"></a>08510       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(delay);
<a name="l08511"></a>08511       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(answer_cdr);
<a name="l08512"></a>08512    );
<a name="l08513"></a>08513 
<a name="l08514"></a>08514    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l08515"></a>08515       <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#a5457ba5b9d85a5167027716d84449f1f" title="Answer a channel, with a selectable delay before returning.">__ast_answer</a>(chan, 0, 1);
<a name="l08516"></a>08516    }
<a name="l08517"></a>08517 
<a name="l08518"></a>08518    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l08519"></a>08519 
<a name="l08520"></a>08520    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l08521"></a>08521 
<a name="l08522"></a>08522    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.delay) &amp;&amp; (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>))
<a name="l08523"></a>08523       delay = atoi(data);
<a name="l08524"></a>08524 
<a name="l08525"></a>08525    <span class="keywordflow">if</span> (delay &lt; 0) {
<a name="l08526"></a>08526       delay = 0;
<a name="l08527"></a>08527    }
<a name="l08528"></a>08528 
<a name="l08529"></a>08529    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.answer_cdr) &amp;&amp; !strcasecmp(args.answer_cdr, <span class="stringliteral">&quot;nocdr&quot;</span>)) {
<a name="l08530"></a>08530       answer_cdr = 0;
<a name="l08531"></a>08531    }
<a name="l08532"></a>08532 
<a name="l08533"></a>08533    <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#a5457ba5b9d85a5167027716d84449f1f" title="Answer a channel, with a selectable delay before returning.">__ast_answer</a>(chan, delay, answer_cdr);
<a name="l08534"></a>08534 }
<a name="l08535"></a>08535 
<a name="l08536"></a><a class="code" href="pbx_8c.html#a65ca23cfe7ba11aea248fca6caf43da3">08536</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a65ca23cfe7ba11aea248fca6caf43da3">pbx_builtin_incomplete</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08537"></a>08537 {
<a name="l08538"></a>08538    <span class="keywordtype">char</span> *options = data;
<a name="l08539"></a>08539    <span class="keywordtype">int</span> answer = 1;
<a name="l08540"></a>08540 
<a name="l08541"></a>08541    <span class="comment">/* Some channels can receive DTMF in unanswered state; some cannot */</span>
<a name="l08542"></a>08542    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(options) &amp;&amp; strchr(options, <span class="charliteral">&apos;n&apos;</span>)) {
<a name="l08543"></a>08543       answer = 0;
<a name="l08544"></a>08544    }
<a name="l08545"></a>08545 
<a name="l08546"></a>08546    <span class="comment">/* If the channel is hungup, stop waiting */</span>
<a name="l08547"></a>08547    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) {
<a name="l08548"></a>08548       <span class="keywordflow">return</span> -1;
<a name="l08549"></a>08549    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a> &amp;&amp; answer) {
<a name="l08550"></a>08550       <a class="code" href="channel_8h.html#a5457ba5b9d85a5167027716d84449f1f" title="Answer a channel, with a selectable delay before returning.">__ast_answer</a>(chan, 0, 1);
<a name="l08551"></a>08551    }
<a name="l08552"></a>08552 
<a name="l08553"></a>08553    <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a653bef57d41c00d6b1f79c94fe19ec7b">AST_PBX_INCOMPLETE</a>;
<a name="l08554"></a>08554 }
<a name="l08555"></a>08555 
<a name="l08556"></a>08556 <a class="code" href="app_8h.html#a520a3c6b7d57903d9a616051da1a019d" title="Declares an array of options for an application.">AST_APP_OPTIONS</a>(<a class="code" href="pbx_8c.html#ad35970bca312826e185d7cc0c8285abe">resetcdr_opts</a>, {
<a name="l08557"></a>08557    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;w&apos;</span>, <a class="code" href="cdr_8h.html#ab7d9caea71bea12314af4b117a35c3f9">AST_CDR_FLAG_POSTED</a>),
<a name="l08558"></a>08558    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;a&apos;</span>, <a class="code" href="cdr_8h.html#ad19495bac7dec6a99190f93e21965da6">AST_CDR_FLAG_LOCKED</a>),
<a name="l08559"></a>08559    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;v&apos;</span>, <a class="code" href="cdr_8h.html#a441ba62cb48c35234960641c94f2363b">AST_CDR_FLAG_KEEP_VARS</a>),
<a name="l08560"></a>08560    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;e&apos;</span>, <a class="code" href="cdr_8h.html#a171c14e04cc5b9f62279f8e8d5f0aaa1">AST_CDR_FLAG_POST_ENABLE</a>),
<a name="l08561"></a><a class="code" href="pbx_8c.html#ad35970bca312826e185d7cc0c8285abe">08561</a> });
<a name="l08562"></a>08562 <span class="comment"></span>
<a name="l08563"></a>08563 <span class="comment">/*!</span>
<a name="l08564"></a>08564 <span class="comment"> * \ingroup applications</span>
<a name="l08565"></a>08565 <span class="comment"> */</span>
<a name="l08566"></a><a class="code" href="group__applications.html#ga2f1090aa1e3405c842bedae424db5b20">08566</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga2f1090aa1e3405c842bedae424db5b20">pbx_builtin_resetcdr</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08567"></a>08567 {
<a name="l08568"></a>08568    <span class="keywordtype">char</span> *args;
<a name="l08569"></a>08569    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> flags = { 0 };
<a name="l08570"></a>08570 
<a name="l08571"></a>08571    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l08572"></a>08572       args = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l08573"></a>08573       <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(<a class="code" href="pbx_8c.html#ad35970bca312826e185d7cc0c8285abe">resetcdr_opts</a>, &amp;flags, NULL, args);
<a name="l08574"></a>08574    }
<a name="l08575"></a>08575 
<a name="l08576"></a>08576    <a class="code" href="cdr_8h.html#a70abe6f1e79dda51a858cee326a90d8e" title="Reset the detail record, optionally posting it first.">ast_cdr_reset</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, &amp;flags);
<a name="l08577"></a>08577 
<a name="l08578"></a>08578    <span class="keywordflow">return</span> 0;
<a name="l08579"></a>08579 }
<a name="l08580"></a>08580 <span class="comment"></span>
<a name="l08581"></a>08581 <span class="comment">/*!</span>
<a name="l08582"></a>08582 <span class="comment"> * \ingroup applications</span>
<a name="l08583"></a>08583 <span class="comment"> */</span>
<a name="l08584"></a><a class="code" href="group__applications.html#gab695b2eba5ced025a2eb04fbdd87475f">08584</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#gab695b2eba5ced025a2eb04fbdd87475f">pbx_builtin_setamaflags</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08585"></a>08585 {
<a name="l08586"></a>08586    <span class="comment">/* Copy the AMA Flags as specified */</span>
<a name="l08587"></a>08587    <a class="code" href="cdr_8h.html#a801a6c8fd5cf3c9960c1167920ce7bf1" title="Set AMA flags for channel.">ast_cdr_setamaflags</a>(chan, data ? data : <span class="stringliteral">&quot;&quot;</span>);
<a name="l08588"></a>08588    <span class="keywordflow">return</span> 0;
<a name="l08589"></a>08589 }
<a name="l08590"></a>08590 <span class="comment"></span>
<a name="l08591"></a>08591 <span class="comment">/*!</span>
<a name="l08592"></a>08592 <span class="comment"> * \ingroup applications</span>
<a name="l08593"></a>08593 <span class="comment"> */</span>
<a name="l08594"></a><a class="code" href="group__applications.html#ga30a1a1a976e72e564e7babdbbe26ca7c">08594</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga30a1a1a976e72e564e7babdbbe26ca7c">pbx_builtin_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08595"></a>08595 {
<a name="l08596"></a>08596    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l08597"></a>08597       <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>;
<a name="l08598"></a>08598       <span class="keywordtype">char</span> *endptr;
<a name="l08599"></a>08599 
<a name="l08600"></a>08600       <span class="keywordflow">if</span> ((cause = <a class="code" href="channel_8h.html#a058d07bbed187a4548f2667a8404f2c4" title="Convert a symbolic hangup cause to number.">ast_str2cause</a>(data)) &gt; -1) {
<a name="l08601"></a>08601          chan-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a> = cause;
<a name="l08602"></a>08602          <span class="keywordflow">return</span> -1;
<a name="l08603"></a>08603       }
<a name="l08604"></a>08604 
<a name="l08605"></a>08605       cause = strtol((<span class="keyword">const</span> <span class="keywordtype">char</span> *) data, &amp;endptr, 10);
<a name="l08606"></a>08606       <span class="keywordflow">if</span> (cause != 0 || (data != endptr)) {
<a name="l08607"></a>08607          chan-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a> = cause;
<a name="l08608"></a>08608          <span class="keywordflow">return</span> -1;
<a name="l08609"></a>08609       }
<a name="l08610"></a>08610 
<a name="l08611"></a>08611       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid cause given to Hangup(): \&quot;%s\&quot;\n&quot;</span>, (<span class="keywordtype">char</span> *) data);
<a name="l08612"></a>08612    }
<a name="l08613"></a>08613 
<a name="l08614"></a>08614    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a>) {
<a name="l08615"></a>08615       chan-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a> = <a class="code" href="causes_8h.html#af2235eb1c27925e4020ce286255d165f">AST_CAUSE_NORMAL_CLEARING</a>;
<a name="l08616"></a>08616    }
<a name="l08617"></a>08617 
<a name="l08618"></a>08618    <span class="keywordflow">return</span> -1;
<a name="l08619"></a>08619 }
<a name="l08620"></a>08620 <span class="comment"></span>
<a name="l08621"></a>08621 <span class="comment">/*!</span>
<a name="l08622"></a>08622 <span class="comment"> * \ingroup applications</span>
<a name="l08623"></a>08623 <span class="comment"> */</span>
<a name="l08624"></a><a class="code" href="group__applications.html#ga71db5198713c09e6b55360f5ced0212e">08624</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga71db5198713c09e6b55360f5ced0212e">pbx_builtin_gotoiftime</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08625"></a>08625 {
<a name="l08626"></a>08626    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, *ts, *branch1, *branch2, *branch;
<a name="l08627"></a>08627    <span class="keyword">struct </span><a class="code" href="structast__timing.html">ast_timing</a> timing;
<a name="l08628"></a>08628 
<a name="l08629"></a>08629    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l08630"></a>08630       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;GotoIfTime requires an argument:\n  &lt;time range&gt;,&lt;days of week&gt;,&lt;days of month&gt;,&lt;months&gt;[,&lt;timezone&gt;]?&apos;labeliftrue&apos;:&apos;labeliffalse&apos;\n&quot;</span>);
<a name="l08631"></a>08631       <span class="keywordflow">return</span> -1;
<a name="l08632"></a>08632    }
<a name="l08633"></a>08633 
<a name="l08634"></a>08634    ts = s = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l08635"></a>08635 
<a name="l08636"></a>08636    <span class="comment">/* Separate the Goto path */</span>
<a name="l08637"></a>08637    <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;ts, <span class="stringliteral">&quot;?&quot;</span>);
<a name="l08638"></a>08638    branch1 = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;ts,<span class="stringliteral">&quot;:&quot;</span>);
<a name="l08639"></a>08639    branch2 = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;ts,<span class="stringliteral">&quot;&quot;</span>);
<a name="l08640"></a>08640 
<a name="l08641"></a>08641    <span class="comment">/* struct ast_include include contained garbage here, fixed by zeroing it on get_timerange */</span>
<a name="l08642"></a>08642    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a018549fd5d5470b676da92f6034b7347" title="Construct a timing bitmap, for use in time-based conditionals.">ast_build_timing</a>(&amp;timing, s) &amp;&amp; <a class="code" href="pbx_8h.html#a17b7d6ec799c60a8fda825cf59aea7eb" title="Evaluate a pre-constructed bitmap as to whether the current time falls within the...">ast_check_timing</a>(&amp;timing))
<a name="l08643"></a>08643       branch = branch1;
<a name="l08644"></a>08644    <span class="keywordflow">else</span>
<a name="l08645"></a>08645       branch = branch2;
<a name="l08646"></a>08646    <a class="code" href="pbx_8h.html#a2bc52adc4f80137db9161ed499f82a00" title="Deallocates memory structures associated with a timing bitmap.">ast_destroy_timing</a>(&amp;timing);
<a name="l08647"></a>08647 
<a name="l08648"></a>08648    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(branch)) {
<a name="l08649"></a>08649       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Not taking any branch\n&quot;</span>);
<a name="l08650"></a>08650       <span class="keywordflow">return</span> 0;
<a name="l08651"></a>08651    }
<a name="l08652"></a>08652 
<a name="l08653"></a>08653    <span class="keywordflow">return</span> <a class="code" href="group__applications.html#gae51321ae79f6f8a85cfbfe8d033a2df6">pbx_builtin_goto</a>(chan, branch);
<a name="l08654"></a>08654 }
<a name="l08655"></a>08655 <span class="comment"></span>
<a name="l08656"></a>08656 <span class="comment">/*!</span>
<a name="l08657"></a>08657 <span class="comment"> * \ingroup applications</span>
<a name="l08658"></a>08658 <span class="comment"> */</span>
<a name="l08659"></a><a class="code" href="group__applications.html#gaa259135ffd279c9afc70b476ee0b4cd6">08659</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#gaa259135ffd279c9afc70b476ee0b4cd6">pbx_builtin_execiftime</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08660"></a>08660 {
<a name="l08661"></a>08661    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, *appname;
<a name="l08662"></a>08662    <span class="keyword">struct </span><a class="code" href="structast__timing.html">ast_timing</a> timing;
<a name="l08663"></a>08663    <span class="keyword">struct </span>ast_app *app;
<a name="l08664"></a>08664    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *usage = <span class="stringliteral">&quot;ExecIfTime requires an argument:\n  &lt;time range&gt;,&lt;days of week&gt;,&lt;days of month&gt;,&lt;months&gt;[,&lt;timezone&gt;]?&lt;appname&gt;[(&lt;appargs&gt;)]&quot;</span>;
<a name="l08665"></a>08665 
<a name="l08666"></a>08666    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l08667"></a>08667       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, usage);
<a name="l08668"></a>08668       <span class="keywordflow">return</span> -1;
<a name="l08669"></a>08669    }
<a name="l08670"></a>08670 
<a name="l08671"></a>08671    appname = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l08672"></a>08672 
<a name="l08673"></a>08673    s = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;appname, <span class="stringliteral">&quot;?&quot;</span>); <span class="comment">/* Separate the timerange and application name/data */</span>
<a name="l08674"></a>08674    <span class="keywordflow">if</span> (!appname) {   <span class="comment">/* missing application */</span>
<a name="l08675"></a>08675       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, usage);
<a name="l08676"></a>08676       <span class="keywordflow">return</span> -1;
<a name="l08677"></a>08677    }
<a name="l08678"></a>08678 
<a name="l08679"></a>08679    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a018549fd5d5470b676da92f6034b7347" title="Construct a timing bitmap, for use in time-based conditionals.">ast_build_timing</a>(&amp;timing, s)) {
<a name="l08680"></a>08680       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid Time Spec: %s\nCorrect usage: %s\n&quot;</span>, s, usage);
<a name="l08681"></a>08681       <a class="code" href="pbx_8h.html#a2bc52adc4f80137db9161ed499f82a00" title="Deallocates memory structures associated with a timing bitmap.">ast_destroy_timing</a>(&amp;timing);
<a name="l08682"></a>08682       <span class="keywordflow">return</span> -1;
<a name="l08683"></a>08683    }
<a name="l08684"></a>08684 
<a name="l08685"></a>08685    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a17b7d6ec799c60a8fda825cf59aea7eb" title="Evaluate a pre-constructed bitmap as to whether the current time falls within the...">ast_check_timing</a>(&amp;timing))  { <span class="comment">/* outside the valid time window, just return */</span>
<a name="l08686"></a>08686       <a class="code" href="pbx_8h.html#a2bc52adc4f80137db9161ed499f82a00" title="Deallocates memory structures associated with a timing bitmap.">ast_destroy_timing</a>(&amp;timing);
<a name="l08687"></a>08687       <span class="keywordflow">return</span> 0;
<a name="l08688"></a>08688    }
<a name="l08689"></a>08689    <a class="code" href="pbx_8h.html#a2bc52adc4f80137db9161ed499f82a00" title="Deallocates memory structures associated with a timing bitmap.">ast_destroy_timing</a>(&amp;timing);
<a name="l08690"></a>08690 
<a name="l08691"></a>08691    <span class="comment">/* now split appname(appargs) */</span>
<a name="l08692"></a>08692    <span class="keywordflow">if</span> ((s = strchr(appname, <span class="charliteral">&apos;(&apos;</span>))) {
<a name="l08693"></a>08693       <span class="keywordtype">char</span> *e;
<a name="l08694"></a>08694       *s++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08695"></a>08695       <span class="keywordflow">if</span> ((e = strrchr(s, <span class="charliteral">&apos;)&apos;</span>)))
<a name="l08696"></a>08696          *e = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08697"></a>08697       <span class="keywordflow">else</span>
<a name="l08698"></a>08698          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to find closing parenthesis\n&quot;</span>);
<a name="l08699"></a>08699    }
<a name="l08700"></a>08700 
<a name="l08701"></a>08701 
<a name="l08702"></a>08702    <span class="keywordflow">if</span> ((app = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(appname))) {
<a name="l08703"></a>08703       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(chan, app, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(s, <span class="stringliteral">&quot;&quot;</span>));
<a name="l08704"></a>08704    } <span class="keywordflow">else</span> {
<a name="l08705"></a>08705       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot locate application %s\n&quot;</span>, appname);
<a name="l08706"></a>08706       <span class="keywordflow">return</span> -1;
<a name="l08707"></a>08707    }
<a name="l08708"></a>08708 }
<a name="l08709"></a>08709 <span class="comment"></span>
<a name="l08710"></a>08710 <span class="comment">/*!</span>
<a name="l08711"></a>08711 <span class="comment"> * \ingroup applications</span>
<a name="l08712"></a>08712 <span class="comment"> */</span>
<a name="l08713"></a><a class="code" href="group__applications.html#ga68501e1e569b1d53a6bba41cc1d20a90">08713</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga68501e1e569b1d53a6bba41cc1d20a90">pbx_builtin_wait</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08714"></a>08714 {
<a name="l08715"></a>08715    <span class="keywordtype">double</span> <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l08716"></a>08716    <span class="keywordtype">int</span> ms;
<a name="l08717"></a>08717 
<a name="l08718"></a>08718    <span class="comment">/* Wait for &quot;n&quot; seconds */</span>
<a name="l08719"></a>08719    <span class="keywordflow">if</span> (data &amp;&amp; (s = atof(data)) &gt; 0.0) {
<a name="l08720"></a>08720       ms = s * 1000.0;
<a name="l08721"></a>08721       <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(chan, ms);
<a name="l08722"></a>08722    }
<a name="l08723"></a>08723    <span class="keywordflow">return</span> 0;
<a name="l08724"></a>08724 }
<a name="l08725"></a>08725 <span class="comment"></span>
<a name="l08726"></a>08726 <span class="comment">/*!</span>
<a name="l08727"></a>08727 <span class="comment"> * \ingroup applications</span>
<a name="l08728"></a>08728 <span class="comment"> */</span>
<a name="l08729"></a><a class="code" href="group__applications.html#ga0c007df1099e478f13cdde9876a7f9df">08729</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#ga0c007df1099e478f13cdde9876a7f9df">pbx_builtin_waitexten</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08730"></a>08730 {
<a name="l08731"></a>08731    <span class="keywordtype">int</span> ms, res;
<a name="l08732"></a>08732    <span class="keywordtype">double</span> <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l08733"></a>08733    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> flags = {0};
<a name="l08734"></a>08734    <span class="keywordtype">char</span> *opts[1] = { NULL };
<a name="l08735"></a>08735    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l08736"></a>08736    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l08737"></a>08737       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(timeout);
<a name="l08738"></a>08738       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l08739"></a>08739    );
<a name="l08740"></a>08740 
<a name="l08741"></a>08741    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l08742"></a>08742       parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l08743"></a>08743       <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l08744"></a>08744    } <span class="keywordflow">else</span>
<a name="l08745"></a>08745       memset(&amp;args, 0, <span class="keyword">sizeof</span>(args));
<a name="l08746"></a>08746 
<a name="l08747"></a>08747    <span class="keywordflow">if</span> (args.options)
<a name="l08748"></a>08748       <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(<a class="code" href="pbx_8c.html#a89c4b430fb75cf73d9aac833701ee3e2">waitexten_opts</a>, &amp;flags, opts, args.options);
<a name="l08749"></a>08749 
<a name="l08750"></a>08750    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="pbx_8c.html#a0e259130f0ff2cd87950ae18493ce7c1">WAITEXTEN_MOH</a>) &amp;&amp; !opts[0] ) {
<a name="l08751"></a>08751       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;The &apos;m&apos; option has been specified for WaitExten without a class.\n&quot;</span>); 
<a name="l08752"></a>08752    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="pbx_8c.html#a0e259130f0ff2cd87950ae18493ce7c1">WAITEXTEN_MOH</a>)) {
<a name="l08753"></a>08753       <a class="code" href="channel_8h.html#aa8c3522af1bc639cbd5b38f5fdf171fa" title="Indicates condition of channel, with payload.">ast_indicate_data</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(opts[0], NULL), strlen(opts[0]));
<a name="l08754"></a>08754    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="pbx_8c.html#a359267485801a1ea1e310520cf44e698">WAITEXTEN_DIALTONE</a>)) {
<a name="l08755"></a>08755       <span class="keyword">struct </span><a class="code" href="structast__tone__zone__sound.html" title="Description of a tone.">ast_tone_zone_sound</a> *ts = <a class="code" href="indications_8h.html#a516be2823557000dcd4be685a44d1d09" title="Locate a tone zone sound.">ast_get_indication_tone</a>(chan-&gt;<a class="code" href="structast__channel.html#a3b50931566324162ca5ebdd52fb5874c">zone</a>, <span class="stringliteral">&quot;dial&quot;</span>);
<a name="l08756"></a>08756       <span class="keywordflow">if</span> (ts) {
<a name="l08757"></a>08757          <a class="code" href="app__rpt_8c.html#a544e8a1dd4a986b00754103dda6a7d3b">ast_playtones_start</a>(chan, 0, ts-&gt;<a class="code" href="structast__tone__zone__sound.html#a8f64897c7ccc5c13f276d1d07c4e7095" title="Description of a tone.">data</a>, 0);
<a name="l08758"></a>08758          ts = <a class="code" href="indications_8h.html#a8b52ace68f21c0ac24414f038471647d" title="Release a reference to an ast_tone_zone_sound.">ast_tone_zone_sound_unref</a>(ts);
<a name="l08759"></a>08759       } <span class="keywordflow">else</span> {
<a name="l08760"></a>08760          <a class="code" href="channel_8h.html#a45670e7ba068c0e69745fc44e2084046">ast_tonepair_start</a>(chan, 350, 440, 0, 0);
<a name="l08761"></a>08761       }
<a name="l08762"></a>08762    }
<a name="l08763"></a>08763    <span class="comment">/* Wait for &quot;n&quot; seconds */</span>
<a name="l08764"></a>08764    <span class="keywordflow">if</span> (args.timeout &amp;&amp; (s = atof(args.timeout)) &gt; 0)
<a name="l08765"></a>08765        ms = s * 1000.0;
<a name="l08766"></a>08766    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>)
<a name="l08767"></a>08767       ms = chan-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a765bfb11e07b0f90c235c9af9d7f46fa">rtimeoutms</a>;
<a name="l08768"></a>08768    <span class="keywordflow">else</span>
<a name="l08769"></a>08769       ms = 10000;
<a name="l08770"></a>08770 
<a name="l08771"></a>08771    res = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, ms);
<a name="l08772"></a>08772    <span class="keywordflow">if</span> (!res) {
<a name="l08773"></a>08773       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> + 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l08774"></a>08774          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Timeout on %s, continuing...\n&quot;</span>, chan-&gt;name);
<a name="l08775"></a>08775       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> == <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a90cd950abc1c22b0701a476bdd6cc246">AST_SOFTHANGUP_TIMEOUT</a>) {
<a name="l08776"></a>08776          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Call timeout on %s, checking for &apos;T&apos;\n&quot;</span>, chan-&gt;name);
<a name="l08777"></a>08777          res = -1;
<a name="l08778"></a>08778       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;t&quot;</span>, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l08779"></a>08779          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Timeout on %s, going to &apos;t&apos;\n&quot;</span>, chan-&gt;name);
<a name="l08780"></a>08780          <a class="code" href="pbx_8c.html#ae269f012897ae046fe6e785ba8521c88">set_ext_pri</a>(chan, <span class="stringliteral">&quot;t&quot;</span>, 0); <span class="comment">/* 0 will become 1, next time through the loop */</span>
<a name="l08781"></a>08781       } <span class="keywordflow">else</span> {
<a name="l08782"></a>08782          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Timeout but no rule &apos;t&apos; in context &apos;%s&apos;\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l08783"></a>08783          res = -1;
<a name="l08784"></a>08784       }
<a name="l08785"></a>08785    }
<a name="l08786"></a>08786 
<a name="l08787"></a>08787    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="pbx_8c.html#a0e259130f0ff2cd87950ae18493ce7c1">WAITEXTEN_MOH</a>))
<a name="l08788"></a>08788       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>);
<a name="l08789"></a>08789    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="pbx_8c.html#a359267485801a1ea1e310520cf44e698">WAITEXTEN_DIALTONE</a>))
<a name="l08790"></a>08790       <a class="code" href="app__rpt_8c.html#a9d5be069b7060d326a213f5d60b8dc77">ast_playtones_stop</a>(chan);
<a name="l08791"></a>08791 
<a name="l08792"></a>08792    <span class="keywordflow">return</span> res;
<a name="l08793"></a>08793 }
<a name="l08794"></a>08794 <span class="comment"></span>
<a name="l08795"></a>08795 <span class="comment">/*!</span>
<a name="l08796"></a>08796 <span class="comment"> * \ingroup applications</span>
<a name="l08797"></a>08797 <span class="comment"> */</span>
<a name="l08798"></a><a class="code" href="group__applications.html#gaab32a9f46cfa10fd991f16c6a7dc0f41">08798</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#gaab32a9f46cfa10fd991f16c6a7dc0f41">pbx_builtin_background</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08799"></a>08799 {
<a name="l08800"></a>08800    <span class="keywordtype">int</span> res = 0;
<a name="l08801"></a>08801    <span class="keywordtype">int</span> mres = 0;
<a name="l08802"></a>08802    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> flags = {0};
<a name="l08803"></a>08803    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>, exten[2] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l08804"></a>08804    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l08805"></a>08805       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(filename);
<a name="l08806"></a>08806       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l08807"></a>08807       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(lang);
<a name="l08808"></a>08808       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(context);
<a name="l08809"></a>08809    );
<a name="l08810"></a>08810 
<a name="l08811"></a>08811    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l08812"></a>08812       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Background requires an argument (filename)\n&quot;</span>);
<a name="l08813"></a>08813       <span class="keywordflow">return</span> -1;
<a name="l08814"></a>08814    }
<a name="l08815"></a>08815 
<a name="l08816"></a>08816    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l08817"></a>08817 
<a name="l08818"></a>08818    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l08819"></a>08819 
<a name="l08820"></a>08820    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.lang))
<a name="l08821"></a>08821       args.lang = (<span class="keywordtype">char</span> *)chan-&gt;language; <span class="comment">/* XXX this is const */</span>
<a name="l08822"></a>08822 
<a name="l08823"></a>08823    if (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.context)) {
<a name="l08824"></a>08824       <span class="keyword">const</span> <span class="keywordtype">char</span> *context;
<a name="l08825"></a>08825       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l08826"></a>08826       <span class="keywordflow">if</span> ((context = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;MACRO_CONTEXT&quot;</span>))) {
<a name="l08827"></a>08827          args.context = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(context);
<a name="l08828"></a>08828       } <span class="keywordflow">else</span> {
<a name="l08829"></a>08829          args.context = chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l08830"></a>08830       }
<a name="l08831"></a>08831       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l08832"></a>08832    }
<a name="l08833"></a>08833 
<a name="l08834"></a>08834    <span class="keywordflow">if</span> (args.options) {
<a name="l08835"></a>08835       <span class="keywordflow">if</span> (!strcasecmp(args.options, <span class="stringliteral">&quot;skip&quot;</span>))
<a name="l08836"></a>08836          flags.<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a> = <a class="code" href="pbx_8c.html#a95d317328467a30745a66647d2d232b1">BACKGROUND_SKIP</a>;
<a name="l08837"></a>08837       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(args.options, <span class="stringliteral">&quot;noanswer&quot;</span>))
<a name="l08838"></a>08838          flags.<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a> = <a class="code" href="pbx_8c.html#a248fc16b454bba0625d03d7d51efab8a">BACKGROUND_NOANSWER</a>;
<a name="l08839"></a>08839       <span class="keywordflow">else</span>
<a name="l08840"></a>08840          <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(<a class="code" href="pbx_8c.html#a7d8f03c22efbc83c74240c45229c1ce9">background_opts</a>, &amp;flags, NULL, args.options);
<a name="l08841"></a>08841    }
<a name="l08842"></a>08842 
<a name="l08843"></a>08843    <span class="comment">/* Answer if need be */</span>
<a name="l08844"></a>08844    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l08845"></a>08845       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="pbx_8c.html#a95d317328467a30745a66647d2d232b1">BACKGROUND_SKIP</a>)) {
<a name="l08846"></a>08846          <span class="keywordflow">goto</span> done;
<a name="l08847"></a>08847       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="pbx_8c.html#a248fc16b454bba0625d03d7d51efab8a">BACKGROUND_NOANSWER</a>)) {
<a name="l08848"></a>08848          res = <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l08849"></a>08849       }
<a name="l08850"></a>08850    }
<a name="l08851"></a>08851 
<a name="l08852"></a>08852    <span class="keywordflow">if</span> (!res) {
<a name="l08853"></a>08853       <span class="keywordtype">char</span> *back = args.filename;
<a name="l08854"></a>08854       <span class="keywordtype">char</span> *front;
<a name="l08855"></a>08855 
<a name="l08856"></a>08856       <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);      <span class="comment">/* Stop anything playing */</span>
<a name="l08857"></a>08857       <span class="comment">/* Stream the list of files */</span>
<a name="l08858"></a>08858       <span class="keywordflow">while</span> (!res &amp;&amp; (front = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;back, <span class="stringliteral">&quot;&amp;&quot;</span>)) ) {
<a name="l08859"></a>08859          <span class="keywordflow">if</span> ( (res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, front, args.lang)) ) {
<a name="l08860"></a>08860             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;ast_streamfile failed on %s for %s\n&quot;</span>, chan-&gt;name, (<span class="keywordtype">char</span>*)data);
<a name="l08861"></a>08861             res = 0;
<a name="l08862"></a>08862             mres = 1;
<a name="l08863"></a>08863             <span class="keywordflow">break</span>;
<a name="l08864"></a>08864          }
<a name="l08865"></a>08865          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="pbx_8c.html#a90814d9147f1b02a8e33667d6400c43d">BACKGROUND_PLAYBACK</a>)) {
<a name="l08866"></a>08866             res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l08867"></a>08867          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="pbx_8c.html#a9e2cebe13600680593a802b3189f0b27">BACKGROUND_MATCHEXTEN</a>)) {
<a name="l08868"></a>08868             res = <a class="code" href="file_8h.html#ae6eb4e1e4576abe04a4b185688f6690c" title="Waits for a stream to stop or digit matching a valid one digit exten to be pressed...">ast_waitstream_exten</a>(chan, args.<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l08869"></a>08869          } <span class="keywordflow">else</span> {
<a name="l08870"></a>08870             res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l08871"></a>08871          }
<a name="l08872"></a>08872          <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l08873"></a>08873       }
<a name="l08874"></a>08874    }
<a name="l08875"></a>08875 
<a name="l08876"></a>08876    <span class="comment">/*</span>
<a name="l08877"></a>08877 <span class="comment">    * If the single digit DTMF is an extension in the specified context, then</span>
<a name="l08878"></a>08878 <span class="comment">    * go there and signal no DTMF.  Otherwise, we should exit with that DTMF.</span>
<a name="l08879"></a>08879 <span class="comment">    * If we&apos;re in Macro, we&apos;ll exit and seek that DTMF as the beginning of an</span>
<a name="l08880"></a>08880 <span class="comment">    * extension in the Macro&apos;s calling context.  If we&apos;re not in Macro, then</span>
<a name="l08881"></a>08881 <span class="comment">    * we&apos;ll simply seek that extension in the calling context.  Previously,</span>
<a name="l08882"></a>08882 <span class="comment">    * someone complained about the behavior as it related to the interior of a</span>
<a name="l08883"></a>08883 <span class="comment">    * Gosub routine, and the fix (#14011) inadvertently broke FreePBX</span>
<a name="l08884"></a>08884 <span class="comment">    * (#14940).  This change should fix both of these situations, but with the</span>
<a name="l08885"></a>08885 <span class="comment">    * possible incompatibility that if a single digit extension does not exist</span>
<a name="l08886"></a>08886 <span class="comment">    * (but a longer extension COULD have matched), it would have previously</span>
<a name="l08887"></a>08887 <span class="comment">    * gone immediately to the &quot;i&quot; extension, but will now need to wait for a</span>
<a name="l08888"></a>08888 <span class="comment">    * timeout.</span>
<a name="l08889"></a>08889 <span class="comment">    *</span>
<a name="l08890"></a>08890 <span class="comment">    * Later, we had to add a flag to disable this workaround, because AGI</span>
<a name="l08891"></a>08891 <span class="comment">    * users can EXEC Background and reasonably expect that the DTMF code will</span>
<a name="l08892"></a>08892 <span class="comment">    * be returned (see #16434).</span>
<a name="l08893"></a>08893 <span class="comment">    */</span>
<a name="l08894"></a>08894    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ad3827e45a36d53f7570b8cd2ed8fad67">AST_FLAG_DISABLE_WORKAROUNDS</a>) &amp;&amp;
<a name="l08895"></a>08895          (exten[0] = res) &amp;&amp;
<a name="l08896"></a>08896          <a class="code" href="pbx_8h.html#a93f9868530c1e8a9d9d367d1ead8782e" title="Looks for a valid matching extension.">ast_canmatch_extension</a>(chan, args.<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, exten, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>) &amp;&amp;
<a name="l08897"></a>08897          !<a class="code" href="pbx_8h.html#ac359af75b9494f50904583d2168a7577" title="Looks to see if adding anything to this extension might match something. (exists...">ast_matchmore_extension</a>(chan, args.<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, exten, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l08898"></a>08898       snprintf(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>), <span class="stringliteral">&quot;%c&quot;</span>, res);
<a name="l08899"></a>08899       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, args.context, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l08900"></a>08900       chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 0;
<a name="l08901"></a>08901       res = 0;
<a name="l08902"></a>08902    }
<a name="l08903"></a>08903 done:
<a name="l08904"></a>08904    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;BACKGROUNDSTATUS&quot;</span>, mres ? <span class="stringliteral">&quot;FAILED&quot;</span> : <span class="stringliteral">&quot;SUCCESS&quot;</span>);
<a name="l08905"></a>08905    <span class="keywordflow">return</span> res;
<a name="l08906"></a>08906 }
<a name="l08907"></a>08907 <span class="comment"></span>
<a name="l08908"></a>08908 <span class="comment">/*! Goto</span>
<a name="l08909"></a>08909 <span class="comment"> * \ingroup applications</span>
<a name="l08910"></a>08910 <span class="comment"> */</span>
<a name="l08911"></a><a class="code" href="group__applications.html#gae51321ae79f6f8a85cfbfe8d033a2df6">08911</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#gae51321ae79f6f8a85cfbfe8d033a2df6">pbx_builtin_goto</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l08912"></a>08912 {
<a name="l08913"></a>08913    <span class="keywordtype">int</span> res = <a class="code" href="pbx_8h.html#ae9b65b0515d88371a5293dd354bfd92f">ast_parseable_goto</a>(chan, data);
<a name="l08914"></a>08914    <span class="keywordflow">if</span> (!res)
<a name="l08915"></a>08915       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Goto (%s,%s,%d)\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> + 1);
<a name="l08916"></a>08916    <span class="keywordflow">return</span> res;
<a name="l08917"></a>08917 }
<a name="l08918"></a>08918 
<a name="l08919"></a>08919 
<a name="l08920"></a><a class="code" href="pbx_8c.html#a847dc86089ce693d89a534512f16dad1">08920</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a847dc86089ce693d89a534512f16dad1" title="Create a human-readable string, specifying all variables and their corresponding...">pbx_builtin_serialize_variables</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> **<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)
<a name="l08921"></a>08921 {
<a name="l08922"></a>08922    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *variables;
<a name="l08923"></a>08923    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *<a class="code" href="structval.html">val</a>;
<a name="l08924"></a>08924    <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ac7af894858cf396a219d632f40afdc8d">total</a> = 0;
<a name="l08925"></a>08925 
<a name="l08926"></a>08926    <span class="keywordflow">if</span> (!chan)
<a name="l08927"></a>08927       <span class="keywordflow">return</span> 0;
<a name="l08928"></a>08928 
<a name="l08929"></a>08929    <a class="code" href="strings_8h.html#a7820deea616cbb2e28f16d518de91c80" title="Reset the content of a dynamic string. Useful before a series of ast_str_append.">ast_str_reset</a>(*buf);
<a name="l08930"></a>08930 
<a name="l08931"></a>08931    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l08932"></a>08932 
<a name="l08933"></a>08933    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a>, variables, entries) {
<a name="l08934"></a>08934       <span class="keywordflow">if</span> ((var = <a class="code" href="chanvars_8h.html#a356a31cd608ec07d3668dcd589be49d8">ast_var_name</a>(variables)) &amp;&amp; (val = <a class="code" href="chanvars_8h.html#a8e0081172db71c5021d20706c50d959c">ast_var_value</a>(variables))
<a name="l08935"></a>08935          <span class="comment">/* &amp;&amp; !ast_strlen_zero(var) &amp;&amp; !ast_strlen_zero(val) */</span>
<a name="l08936"></a>08936          ) {
<a name="l08937"></a>08937          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(buf, 0, <span class="stringliteral">&quot;%s=%s\n&quot;</span>, var, val) &lt; 0) {
<a name="l08938"></a>08938             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Data Buffer Size Exceeded!\n&quot;</span>);
<a name="l08939"></a>08939             <span class="keywordflow">break</span>;
<a name="l08940"></a>08940          } <span class="keywordflow">else</span>
<a name="l08941"></a>08941             total++;
<a name="l08942"></a>08942       } <span class="keywordflow">else</span>
<a name="l08943"></a>08943          <span class="keywordflow">break</span>;
<a name="l08944"></a>08944    }
<a name="l08945"></a>08945 
<a name="l08946"></a>08946    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l08947"></a>08947 
<a name="l08948"></a>08948    <span class="keywordflow">return</span> total;
<a name="l08949"></a>08949 }
<a name="l08950"></a>08950 
<a name="l08951"></a><a class="code" href="pbx_8c.html#a98c5425b90ec7c5e136a40f529170b1b">08951</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l08952"></a>08952 {
<a name="l08953"></a>08953    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *variables;
<a name="l08954"></a>08954    <span class="keyword">const</span> <span class="keywordtype">char</span> *ret = NULL;
<a name="l08955"></a>08955    <span class="keywordtype">int</span> i;
<a name="l08956"></a>08956    <span class="keyword">struct </span>varshead *places[2] = { NULL, &amp;<a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a> };
<a name="l08957"></a>08957 
<a name="l08958"></a>08958    <span class="keywordflow">if</span> (!name)
<a name="l08959"></a>08959       <span class="keywordflow">return</span> NULL;
<a name="l08960"></a>08960 
<a name="l08961"></a>08961    <span class="keywordflow">if</span> (chan) {
<a name="l08962"></a>08962       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l08963"></a>08963       places[0] = &amp;chan-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a>;
<a name="l08964"></a>08964    }
<a name="l08965"></a>08965 
<a name="l08966"></a>08966    <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
<a name="l08967"></a>08967       <span class="keywordflow">if</span> (!places[i])
<a name="l08968"></a>08968          <span class="keywordflow">continue</span>;
<a name="l08969"></a>08969       <span class="keywordflow">if</span> (places[i] == &amp;<a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a>)
<a name="l08970"></a>08970          <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l08971"></a>08971       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(places[i], variables, entries) {
<a name="l08972"></a>08972          <span class="keywordflow">if</span> (!strcmp(name, <a class="code" href="chanvars_8h.html#a356a31cd608ec07d3668dcd589be49d8">ast_var_name</a>(variables))) {
<a name="l08973"></a>08973             ret = <a class="code" href="chanvars_8h.html#a8e0081172db71c5021d20706c50d959c">ast_var_value</a>(variables);
<a name="l08974"></a>08974             <span class="keywordflow">break</span>;
<a name="l08975"></a>08975          }
<a name="l08976"></a>08976       }
<a name="l08977"></a>08977       <span class="keywordflow">if</span> (places[i] == &amp;<a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a>)
<a name="l08978"></a>08978          <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l08979"></a>08979       <span class="keywordflow">if</span> (ret)
<a name="l08980"></a>08980          <span class="keywordflow">break</span>;
<a name="l08981"></a>08981    }
<a name="l08982"></a>08982 
<a name="l08983"></a>08983    <span class="keywordflow">if</span> (chan)
<a name="l08984"></a>08984       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l08985"></a>08985 
<a name="l08986"></a>08986    <span class="keywordflow">return</span> ret;
<a name="l08987"></a>08987 }
<a name="l08988"></a>08988 
<a name="l08989"></a><a class="code" href="pbx_8c.html#a9e00ba1268d8792b95063aeedd9244ea">08989</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8h.html#a9e00ba1268d8792b95063aeedd9244ea" title="Add a variable to the channel variable stack, without removing any previously set...">pbx_builtin_pushvar_helper</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l08990"></a>08990 {
<a name="l08991"></a>08991    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *newvariable;
<a name="l08992"></a>08992    <span class="keyword">struct </span>varshead *headp;
<a name="l08993"></a>08993 
<a name="l08994"></a>08994    <span class="keywordflow">if</span> (name[strlen(name)-1] == <span class="charliteral">&apos;)&apos;</span>) {
<a name="l08995"></a>08995       <span class="keywordtype">char</span> *function = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(name);
<a name="l08996"></a>08996 
<a name="l08997"></a>08997       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot push a value onto a function\n&quot;</span>);
<a name="l08998"></a>08998       <a class="code" href="pbx_8h.html#ae70e64cdf669396c88ea8eda900b0b3b" title="executes a write operation on a function">ast_func_write</a>(chan, function, value);
<a name="l08999"></a>08999       <span class="keywordflow">return</span>;
<a name="l09000"></a>09000    }
<a name="l09001"></a>09001 
<a name="l09002"></a>09002    <span class="keywordflow">if</span> (chan) {
<a name="l09003"></a>09003       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l09004"></a>09004       headp = &amp;chan-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a>;
<a name="l09005"></a>09005    } <span class="keywordflow">else</span> {
<a name="l09006"></a>09006       <a class="code" href="lock_8h.html#a952527792bba2a323118ae911f9aa1f7">ast_rwlock_wrlock</a>(&amp;<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l09007"></a>09007       headp = &amp;<a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a>;
<a name="l09008"></a>09008    }
<a name="l09009"></a>09009 
<a name="l09010"></a>09010    <span class="keywordflow">if</span> (value) {
<a name="l09011"></a>09011       <span class="keywordflow">if</span> (headp == &amp;<a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a>)
<a name="l09012"></a>09012          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Setting global variable &apos;%s&apos; to &apos;%s&apos;\n&quot;</span>, name, value);
<a name="l09013"></a>09013       newvariable = <a class="code" href="chanvars_8h.html#a8ea2b5a29fa275115c7ed27a593b727d">ast_var_assign</a>(name, value);
<a name="l09014"></a>09014       <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(headp, newvariable, entries);
<a name="l09015"></a>09015    }
<a name="l09016"></a>09016 
<a name="l09017"></a>09017    <span class="keywordflow">if</span> (chan)
<a name="l09018"></a>09018       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l09019"></a>09019    <span class="keywordflow">else</span>
<a name="l09020"></a>09020       <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l09021"></a>09021 }
<a name="l09022"></a>09022 
<a name="l09023"></a><a class="code" href="pbx_8c.html#ac74f20f5a5f022a60fdf2db0dc84889c">09023</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l09024"></a>09024 {
<a name="l09025"></a>09025    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *newvariable;
<a name="l09026"></a>09026    <span class="keyword">struct </span>varshead *headp;
<a name="l09027"></a>09027    <span class="keyword">const</span> <span class="keywordtype">char</span> *nametail = name;
<a name="l09028"></a>09028 
<a name="l09029"></a>09029    <span class="keywordflow">if</span> (name[strlen(name) - 1] == <span class="charliteral">&apos;)&apos;</span>) {
<a name="l09030"></a>09030       <span class="keywordtype">char</span> *function = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(name);
<a name="l09031"></a>09031 
<a name="l09032"></a>09032       <a class="code" href="pbx_8h.html#ae70e64cdf669396c88ea8eda900b0b3b" title="executes a write operation on a function">ast_func_write</a>(chan, function, value);
<a name="l09033"></a>09033       <span class="keywordflow">return</span>;
<a name="l09034"></a>09034    }
<a name="l09035"></a>09035 
<a name="l09036"></a>09036    <span class="keywordflow">if</span> (chan) {
<a name="l09037"></a>09037       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l09038"></a>09038       headp = &amp;chan-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a>;
<a name="l09039"></a>09039    } <span class="keywordflow">else</span> {
<a name="l09040"></a>09040       <a class="code" href="lock_8h.html#a952527792bba2a323118ae911f9aa1f7">ast_rwlock_wrlock</a>(&amp;<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l09041"></a>09041       headp = &amp;<a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a>;
<a name="l09042"></a>09042    }
<a name="l09043"></a>09043 
<a name="l09044"></a>09044    <span class="comment">/* For comparison purposes, we have to strip leading underscores */</span>
<a name="l09045"></a>09045    <span class="keywordflow">if</span> (*nametail == <span class="charliteral">&apos;_&apos;</span>) {
<a name="l09046"></a>09046       nametail++;
<a name="l09047"></a>09047       <span class="keywordflow">if</span> (*nametail == <span class="charliteral">&apos;_&apos;</span>)
<a name="l09048"></a>09048          nametail++;
<a name="l09049"></a>09049    }
<a name="l09050"></a>09050 
<a name="l09051"></a>09051    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(headp, newvariable, entries) {
<a name="l09052"></a>09052       <span class="keywordflow">if</span> (strcasecmp(<a class="code" href="chanvars_8h.html#a356a31cd608ec07d3668dcd589be49d8">ast_var_name</a>(newvariable), nametail) == 0) {
<a name="l09053"></a>09053          <span class="comment">/* there is already such a variable, delete it */</span>
<a name="l09054"></a>09054          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entries);
<a name="l09055"></a>09055          <a class="code" href="chanvars_8h.html#a52aaa758ed30031250c2d356b993c6d9">ast_var_delete</a>(newvariable);
<a name="l09056"></a>09056          <span class="keywordflow">break</span>;
<a name="l09057"></a>09057       }
<a name="l09058"></a>09058    }
<a name="l09059"></a>09059    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l09060"></a>09060 
<a name="l09061"></a>09061    <span class="keywordflow">if</span> (value) {
<a name="l09062"></a>09062       <span class="keywordflow">if</span> (headp == &amp;<a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a>)
<a name="l09063"></a>09063          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Setting global variable &apos;%s&apos; to &apos;%s&apos;\n&quot;</span>, name, value);
<a name="l09064"></a>09064       newvariable = <a class="code" href="chanvars_8h.html#a8ea2b5a29fa275115c7ed27a593b727d">ast_var_assign</a>(name, value);
<a name="l09065"></a>09065       <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(headp, newvariable, entries);
<a name="l09066"></a>09066       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ad602e069591b527f28e36dd472425e7e">EVENT_FLAG_DIALPLAN</a>, <span class="stringliteral">&quot;VarSet&quot;</span>,
<a name="l09067"></a>09067          <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l09068"></a>09068          <span class="stringliteral">&quot;Variable: %s\r\n&quot;</span>
<a name="l09069"></a>09069          <span class="stringliteral">&quot;Value: %s\r\n&quot;</span>
<a name="l09070"></a>09070          <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>,
<a name="l09071"></a>09071          chan ? chan-&gt;name : <span class="stringliteral">&quot;none&quot;</span>, name, value,
<a name="l09072"></a>09072          chan ? chan-&gt;uniqueid : <span class="stringliteral">&quot;none&quot;</span>);
<a name="l09073"></a>09073    }
<a name="l09074"></a>09074 
<a name="l09075"></a>09075    <span class="keywordflow">if</span> (chan)
<a name="l09076"></a>09076       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l09077"></a>09077    <span class="keywordflow">else</span>
<a name="l09078"></a>09078       <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l09079"></a>09079 }
<a name="l09080"></a>09080 
<a name="l09081"></a><a class="code" href="pbx_8c.html#a36336615358c61bccb14b0e47d154769">09081</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aa2489c1ea3b067f827ad20abf363cdcd" title="Parse and set a single channel variable, where the name and value are separated with...">pbx_builtin_setvar</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l09082"></a>09082 {
<a name="l09083"></a>09083    <span class="keywordtype">char</span> *name, *value, *mydata;
<a name="l09084"></a>09084 
<a name="l09085"></a>09085    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#ae1b271c99d5fa3676962041210536327">ast_compat_app_set</a>) {
<a name="l09086"></a>09086       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#a990bfc8582dc017423d8518bcc110a2c" title="Parse and set multiple channel variables, where the pairs are separated by the &amp;#39;...">pbx_builtin_setvar_multiple</a>(chan, data);
<a name="l09087"></a>09087    }
<a name="l09088"></a>09088 
<a name="l09089"></a>09089    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l09090"></a>09090       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Set requires one variable name/value pair.\n&quot;</span>);
<a name="l09091"></a>09091       <span class="keywordflow">return</span> 0;
<a name="l09092"></a>09092    }
<a name="l09093"></a>09093 
<a name="l09094"></a>09094    mydata = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l09095"></a>09095    name = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;mydata, <span class="stringliteral">&quot;=&quot;</span>);
<a name="l09096"></a>09096    value = mydata;
<a name="l09097"></a>09097    <span class="keywordflow">if</span> (strchr(name, <span class="charliteral">&apos; &apos;</span>))
<a name="l09098"></a>09098       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Please avoid unnecessary spaces on variables as it may lead to unexpected results (&apos;%s&apos; set to &apos;%s&apos;).\n&quot;</span>, name, mydata);
<a name="l09099"></a>09099 
<a name="l09100"></a>09100    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, name, value);
<a name="l09101"></a>09101    <span class="keywordflow">return</span>(0);
<a name="l09102"></a>09102 }
<a name="l09103"></a>09103 
<a name="l09104"></a><a class="code" href="pbx_8c.html#aaecddd36470b58a55241e6a6ad7c837e">09104</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a990bfc8582dc017423d8518bcc110a2c" title="Parse and set multiple channel variables, where the pairs are separated by the &amp;#39;...">pbx_builtin_setvar_multiple</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *vdata)
<a name="l09105"></a>09105 {
<a name="l09106"></a>09106    <span class="keywordtype">char</span> *data;
<a name="l09107"></a>09107    <span class="keywordtype">int</span> x;
<a name="l09108"></a>09108    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l09109"></a>09109       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(pair)[24];
<a name="l09110"></a>09110    );
<a name="l09111"></a>09111    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(pair,
<a name="l09112"></a>09112       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(name);
<a name="l09113"></a>09113       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(value);
<a name="l09114"></a>09114    );
<a name="l09115"></a>09115 
<a name="l09116"></a>09116    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vdata)) {
<a name="l09117"></a>09117       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;MSet requires at least one variable name/value pair.\n&quot;</span>);
<a name="l09118"></a>09118       <span class="keywordflow">return</span> 0;
<a name="l09119"></a>09119    }
<a name="l09120"></a>09120 
<a name="l09121"></a>09121    data = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(vdata);
<a name="l09122"></a>09122    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, data);
<a name="l09123"></a>09123 
<a name="l09124"></a>09124    <span class="keywordflow">for</span> (x = 0; x &lt; args.argc; x++) {
<a name="l09125"></a>09125       <a class="code" href="app_8h.html#accfcb380df76a64251d88ef49c2dd4e3" title="Performs the &amp;#39;nonstandard&amp;#39; argument separation process for an application...">AST_NONSTANDARD_APP_ARGS</a>(pair, args.pair[x], <span class="charliteral">&apos;=&apos;</span>);
<a name="l09126"></a>09126       <span class="keywordflow">if</span> (pair.argc == 2) {
<a name="l09127"></a>09127          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, pair.name, pair.value);
<a name="l09128"></a>09128          <span class="keywordflow">if</span> (strchr(pair.name, <span class="charliteral">&apos; &apos;</span>))
<a name="l09129"></a>09129             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Please avoid unnecessary spaces on variables as it may lead to unexpected results (&apos;%s&apos; set to &apos;%s&apos;).\n&quot;</span>, pair.name, pair.value);
<a name="l09130"></a>09130       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!chan) {
<a name="l09131"></a>09131          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;MSet: ignoring entry &apos;%s&apos; with no &apos;=&apos;\n&quot;</span>, pair.name);
<a name="l09132"></a>09132       } <span class="keywordflow">else</span> {
<a name="l09133"></a>09133          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;MSet: ignoring entry &apos;%s&apos; with no &apos;=&apos; (in %s@%s:%d\n&quot;</span>, pair.name, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l09134"></a>09134       }
<a name="l09135"></a>09135    }
<a name="l09136"></a>09136 
<a name="l09137"></a>09137    <span class="keywordflow">return</span> 0;
<a name="l09138"></a>09138 }
<a name="l09139"></a>09139 
<a name="l09140"></a><a class="code" href="pbx_8c.html#ae4f48a51cb2dca6080d6d8488b41d4f9">09140</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#ae4f48a51cb2dca6080d6d8488b41d4f9">pbx_builtin_importvar</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l09141"></a>09141 {
<a name="l09142"></a>09142    <span class="keywordtype">char</span> *name;
<a name="l09143"></a>09143    <span class="keywordtype">char</span> *value;
<a name="l09144"></a>09144    <span class="keywordtype">char</span> *channel;
<a name="l09145"></a>09145    <span class="keywordtype">char</span> tmp[<a class="code" href="pbx_8c.html#ae1761f6ffd7763505cd891d3314cd7e4">VAR_BUF_SIZE</a>];
<a name="l09146"></a>09146    <span class="keyword">static</span> <span class="keywordtype">int</span> deprecation_warning = 0;
<a name="l09147"></a>09147 
<a name="l09148"></a>09148    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l09149"></a>09149       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Ignoring, since there is no variable to set\n&quot;</span>);
<a name="l09150"></a>09150       <span class="keywordflow">return</span> 0;
<a name="l09151"></a>09151    }
<a name="l09152"></a>09152    tmp[0] = 0;
<a name="l09153"></a>09153    <span class="keywordflow">if</span> (!deprecation_warning) {
<a name="l09154"></a>09154       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;ImportVar is deprecated.  Please use Set(varname=${IMPORT(channel,variable)}) instead.\n&quot;</span>);
<a name="l09155"></a>09155       deprecation_warning = 1;
<a name="l09156"></a>09156    }
<a name="l09157"></a>09157 
<a name="l09158"></a>09158    value = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l09159"></a>09159    name = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;value,<span class="stringliteral">&quot;=&quot;</span>);
<a name="l09160"></a>09160    channel = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;value,<span class="stringliteral">&quot;,&quot;</span>);
<a name="l09161"></a>09161    <span class="keywordflow">if</span> (channel &amp;&amp; value &amp;&amp; name) { <span class="comment">/*! \todo XXX should do !ast_strlen_zero(..) of the args ? */</span>
<a name="l09162"></a>09162       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan2 = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(channel);
<a name="l09163"></a>09163       <span class="keywordflow">if</span> (chan2) {
<a name="l09164"></a>09164          <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = alloca(strlen(value) + 4);
<a name="l09165"></a>09165          <span class="keywordflow">if</span> (s) {
<a name="l09166"></a>09166             sprintf(s, <span class="stringliteral">&quot;${%s}&quot;</span>, value);
<a name="l09167"></a>09167             <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(chan2, s, tmp, <span class="keyword">sizeof</span>(tmp) - 1);
<a name="l09168"></a>09168          }
<a name="l09169"></a>09169          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan2);
<a name="l09170"></a>09170       }
<a name="l09171"></a>09171       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, name, tmp);
<a name="l09172"></a>09172    }
<a name="l09173"></a>09173 
<a name="l09174"></a>09174    <span class="keywordflow">return</span>(0);
<a name="l09175"></a>09175 }
<a name="l09176"></a>09176 
<a name="l09177"></a><a class="code" href="pbx_8c.html#afde9dbe9cdcad8b299a374c07001ac0c">09177</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#afde9dbe9cdcad8b299a374c07001ac0c">pbx_builtin_noop</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l09178"></a>09178 {
<a name="l09179"></a>09179    <span class="keywordflow">return</span> 0;
<a name="l09180"></a>09180 }
<a name="l09181"></a>09181 
<a name="l09182"></a><a class="code" href="pbx_8c.html#a92a606276589c513842f0cd7e455126b">09182</a> <span class="keywordtype">void</span> <a class="code" href="pbx_8h.html#a92a606276589c513842f0cd7e455126b">pbx_builtin_clear_globals</a>(<span class="keywordtype">void</span>)
<a name="l09183"></a>09183 {
<a name="l09184"></a>09184    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *vardata;
<a name="l09185"></a>09185 
<a name="l09186"></a>09186    <a class="code" href="lock_8h.html#a952527792bba2a323118ae911f9aa1f7">ast_rwlock_wrlock</a>(&amp;<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l09187"></a>09187    <span class="keywordflow">while</span> ((vardata = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;<a class="code" href="pbx_8c.html#aec3689c71194f8504dafc644005a97db">globals</a>, entries)))
<a name="l09188"></a>09188       <a class="code" href="chanvars_8h.html#a52aaa758ed30031250c2d356b993c6d9">ast_var_delete</a>(vardata);
<a name="l09189"></a>09189    <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="pbx_8c.html#a3bbd0f743b066c2670d7301b078f6510">globalslock</a>);
<a name="l09190"></a>09190 }
<a name="l09191"></a>09191 
<a name="l09192"></a><a class="code" href="pbx_8c.html#ac8447d16749d15c783e1dff4d8f8e495">09192</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#ac8447d16749d15c783e1dff4d8f8e495" title="Evaluate a condition.">pbx_checkcondition</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *condition)
<a name="l09193"></a>09193 {
<a name="l09194"></a>09194    <span class="keywordtype">int</span> res;
<a name="l09195"></a>09195    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(condition)) {                <span class="comment">/* NULL or empty strings are false */</span>
<a name="l09196"></a>09196       <span class="keywordflow">return</span> 0;
<a name="l09197"></a>09197    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(condition, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;res) == 1) { <span class="comment">/* Numbers are evaluated for truth */</span>
<a name="l09198"></a>09198       <span class="keywordflow">return</span> res;
<a name="l09199"></a>09199    } <span class="keywordflow">else</span> {                                         <span class="comment">/* Strings are true */</span>
<a name="l09200"></a>09200       <span class="keywordflow">return</span> 1;
<a name="l09201"></a>09201    }
<a name="l09202"></a>09202 }
<a name="l09203"></a>09203 
<a name="l09204"></a><a class="code" href="pbx_8c.html#a948dfb362e060b3fe11e1944087d559d">09204</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a948dfb362e060b3fe11e1944087d559d">pbx_builtin_gotoif</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l09205"></a>09205 {
<a name="l09206"></a>09206    <span class="keywordtype">char</span> *condition, *branch1, *branch2, *branch;
<a name="l09207"></a>09207    <span class="keywordtype">char</span> *stringp;
<a name="l09208"></a>09208 
<a name="l09209"></a>09209    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l09210"></a>09210       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Ignoring, since there is no variable to check\n&quot;</span>);
<a name="l09211"></a>09211       <span class="keywordflow">return</span> 0;
<a name="l09212"></a>09212    }
<a name="l09213"></a>09213 
<a name="l09214"></a>09214    stringp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l09215"></a>09215    condition = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp,<span class="stringliteral">&quot;?&quot;</span>);
<a name="l09216"></a>09216    branch1 = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp,<span class="stringliteral">&quot;:&quot;</span>);
<a name="l09217"></a>09217    branch2 = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp,<span class="stringliteral">&quot;&quot;</span>);
<a name="l09218"></a>09218    branch = <a class="code" href="pbx_8h.html#ac8447d16749d15c783e1dff4d8f8e495" title="Evaluate a condition.">pbx_checkcondition</a>(condition) ? branch1 : branch2;
<a name="l09219"></a>09219 
<a name="l09220"></a>09220    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(branch)) {
<a name="l09221"></a>09221       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Not taking any branch\n&quot;</span>);
<a name="l09222"></a>09222       <span class="keywordflow">return</span> 0;
<a name="l09223"></a>09223    }
<a name="l09224"></a>09224 
<a name="l09225"></a>09225    <span class="keywordflow">return</span> <a class="code" href="group__applications.html#gae51321ae79f6f8a85cfbfe8d033a2df6">pbx_builtin_goto</a>(chan, branch);
<a name="l09226"></a>09226 }
<a name="l09227"></a>09227 
<a name="l09228"></a><a class="code" href="pbx_8c.html#a061e43c8e74d19fd03e12bb1077de9bd">09228</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a061e43c8e74d19fd03e12bb1077de9bd">pbx_builtin_saynumber</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l09229"></a>09229 {
<a name="l09230"></a>09230    <span class="keywordtype">char</span> tmp[256];
<a name="l09231"></a>09231    <span class="keywordtype">char</span> *<a class="code" href="structnumber.html" title="Number structure.">number</a> = tmp;
<a name="l09232"></a>09232    <span class="keywordtype">char</span> *options;
<a name="l09233"></a>09233 
<a name="l09234"></a>09234    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l09235"></a>09235       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SayNumber requires an argument (number)\n&quot;</span>);
<a name="l09236"></a>09236       <span class="keywordflow">return</span> -1;
<a name="l09237"></a>09237    }
<a name="l09238"></a>09238    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, data, <span class="keyword">sizeof</span>(tmp));
<a name="l09239"></a>09239    <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;number, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l09240"></a>09240    options = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;number, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l09241"></a>09241    <span class="keywordflow">if</span> (options) {
<a name="l09242"></a>09242       <span class="keywordflow">if</span> ( strcasecmp(options, <span class="stringliteral">&quot;f&quot;</span>) &amp;&amp; strcasecmp(options, <span class="stringliteral">&quot;m&quot;</span>) &amp;&amp;
<a name="l09243"></a>09243          strcasecmp(options, <span class="stringliteral">&quot;c&quot;</span>) &amp;&amp; strcasecmp(options, <span class="stringliteral">&quot;n&quot;</span>) ) {
<a name="l09244"></a>09244          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SayNumber gender option is either &apos;f&apos;, &apos;m&apos;, &apos;c&apos; or &apos;n&apos;\n&quot;</span>);
<a name="l09245"></a>09245          <span class="keywordflow">return</span> -1;
<a name="l09246"></a>09246       }
<a name="l09247"></a>09247    }
<a name="l09248"></a>09248 
<a name="l09249"></a>09249    <span class="keywordflow">if</span> (<a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, atoi(tmp), <span class="stringliteral">&quot;&quot;</span>, chan-&gt;language, options)) {
<a name="l09250"></a>09250       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;We were unable to say the number %s, is it too large?\n&quot;</span>, tmp);
<a name="l09251"></a>09251    }
<a name="l09252"></a>09252 
<a name="l09253"></a>09253    <span class="keywordflow">return</span> 0;
<a name="l09254"></a>09254 }
<a name="l09255"></a>09255 
<a name="l09256"></a><a class="code" href="pbx_8c.html#aa19185bb6342008244943fc600124945">09256</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#aa19185bb6342008244943fc600124945">pbx_builtin_saydigits</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l09257"></a>09257 {
<a name="l09258"></a>09258    <span class="keywordtype">int</span> res = 0;
<a name="l09259"></a>09259 
<a name="l09260"></a>09260    <span class="keywordflow">if</span> (data)
<a name="l09261"></a>09261       res = <a class="code" href="say_8h.html#ac8bd6c34b6aa664adb9ebfab68a500ce" title="says digits of a string">ast_say_digit_str</a>(chan, data, <span class="stringliteral">&quot;&quot;</span>, chan-&gt;language);
<a name="l09262"></a>09262    <span class="keywordflow">return</span> res;
<a name="l09263"></a>09263 }
<a name="l09264"></a>09264 
<a name="l09265"></a><a class="code" href="pbx_8c.html#a972e4233e7b77a15acd2a741a9c7bc95">09265</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a972e4233e7b77a15acd2a741a9c7bc95">pbx_builtin_saycharacters</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l09266"></a>09266 {
<a name="l09267"></a>09267    <span class="keywordtype">int</span> res = 0;
<a name="l09268"></a>09268 
<a name="l09269"></a>09269    <span class="keywordflow">if</span> (data)
<a name="l09270"></a>09270       res = <a class="code" href="say_8h.html#a5a2049959851520fd46c332fc127e9a5">ast_say_character_str</a>(chan, data, <span class="stringliteral">&quot;&quot;</span>, chan-&gt;language);
<a name="l09271"></a>09271    <span class="keywordflow">return</span> res;
<a name="l09272"></a>09272 }
<a name="l09273"></a>09273 
<a name="l09274"></a><a class="code" href="pbx_8c.html#a3d9d3a454980053f0dbe6d62b37ddba1">09274</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a3d9d3a454980053f0dbe6d62b37ddba1">pbx_builtin_sayphonetic</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l09275"></a>09275 {
<a name="l09276"></a>09276    <span class="keywordtype">int</span> res = 0;
<a name="l09277"></a>09277 
<a name="l09278"></a>09278    <span class="keywordflow">if</span> (data)
<a name="l09279"></a>09279       res = <a class="code" href="say_8h.html#a54c9f1229af7be8d0dbf8819f9bf115e">ast_say_phonetic_str</a>(chan, data, <span class="stringliteral">&quot;&quot;</span>, chan-&gt;language);
<a name="l09280"></a>09280    <span class="keywordflow">return</span> res;
<a name="l09281"></a>09281 }
<a name="l09282"></a>09282 
<a name="l09283"></a><a class="code" href="pbx_8c.html#a6fb2c0a540b83365dcdc10b470116e82">09283</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx_8c.html#a6fb2c0a540b83365dcdc10b470116e82">device_state_cb</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__event.html" title="An event.">ast_event</a> *event, <span class="keywordtype">void</span> *unused)
<a name="l09284"></a>09284 {
<a name="l09285"></a>09285    <span class="keyword">const</span> <span class="keywordtype">char</span> *device;
<a name="l09286"></a>09286    <span class="keyword">struct </span><a class="code" href="structstatechange.html">statechange</a> *sc;
<a name="l09287"></a>09287 
<a name="l09288"></a>09288    device = <a class="code" href="event_8h.html#a0cfdd21162f4795714da583c31477151" title="Get the value of an information element that has a string payload.">ast_event_get_ie_str</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a675632af9f21fe7696772885593140e3" title="Device Name Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: STR.">AST_EVENT_IE_DEVICE</a>);
<a name="l09289"></a>09289    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(device)) {
<a name="l09290"></a>09290       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Received invalid event that had no device IE\n&quot;</span>);
<a name="l09291"></a>09291       <span class="keywordflow">return</span>;
<a name="l09292"></a>09292    }
<a name="l09293"></a>09293 
<a name="l09294"></a>09294    <span class="keywordflow">if</span> (!(sc = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*sc) + strlen(device) + 1)))
<a name="l09295"></a>09295       <span class="keywordflow">return</span>;
<a name="l09296"></a>09296    strcpy(sc-&gt;<a class="code" href="structstatechange.html#afe67fe8a593b86ec431b116b7b4162d7">dev</a>, device);
<a name="l09297"></a>09297    <span class="keywordflow">if</span> (<a class="code" href="taskprocessor_8h.html#a815e690b2db467f47655ebaa5d85fb69" title="Push a task into the specified taskprocessor queue and signal the taskprocessor thread...">ast_taskprocessor_push</a>(device_state_tps, <a class="code" href="pbx_8c.html#a3abd8b8b4dd20de2436440a2b1993dc0">handle_statechange</a>, sc) &lt; 0) {
<a name="l09298"></a>09298       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sc);
<a name="l09299"></a>09299    }
<a name="l09300"></a>09300 }
<a name="l09301"></a>09301 
<a name="l09302"></a><a class="code" href="pbx_8c.html#ab9a2fcd7b22827d129fc37fc2777c6f4">09302</a> <span class="keywordtype">int</span> <a class="code" href="__private_8h.html#ab9a2fcd7b22827d129fc37fc2777c6f4">load_pbx</a>(<span class="keywordtype">void</span>)
<a name="l09303"></a>09303 {
<a name="l09304"></a>09304    <span class="keywordtype">int</span> x;
<a name="l09305"></a>09305 
<a name="l09306"></a>09306    <span class="comment">/* Initialize the PBX */</span>
<a name="l09307"></a>09307    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;Asterisk PBX Core Initializing\n&quot;</span>);
<a name="l09308"></a>09308    <span class="keywordflow">if</span> (!(device_state_tps = <a class="code" href="taskprocessor_8h.html#a3d670ce6d9ed07b5db0dae8d2c11d275" title="Get a reference to a taskprocessor with the specified name and create the taskprocessor...">ast_taskprocessor_get</a>(<span class="stringliteral">&quot;pbx-core&quot;</span>, 0))) {
<a name="l09309"></a>09309       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;failed to create pbx-core taskprocessor\n&quot;</span>);
<a name="l09310"></a>09310    }
<a name="l09311"></a>09311 
<a name="l09312"></a>09312    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;Registering builtin applications:\n&quot;</span>);
<a name="l09313"></a>09313    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="pbx_8c.html#ac7dafac1c16b8b484834c54b532e5d66">pbx_cli</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="pbx_8c.html#ac7dafac1c16b8b484834c54b532e5d66">pbx_cli</a>));
<a name="l09314"></a>09314    <a class="code" href="pbx_8h.html#aad8771c7e3b2170a749946f1a8b758aa" title="Register a custom function.">__ast_custom_function_register</a>(&amp;<a class="code" href="pbx_8c.html#ae51d2f255e1f2ea7fb24e6033a9cba94">exception_function</a>, NULL);
<a name="l09315"></a>09315 
<a name="l09316"></a>09316    <span class="comment">/* Register builtin applications */</span>
<a name="l09317"></a>09317    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="pbx_8c.html#a5b85032a1e719d9b83d5699fd350134e" title="Declaration of builtin applications.">builtins</a>); x++) {
<a name="l09318"></a>09318       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;[%s]\n&quot;</span>, <a class="code" href="pbx_8c.html#a5b85032a1e719d9b83d5699fd350134e" title="Declaration of builtin applications.">builtins</a>[x].name);
<a name="l09319"></a>09319       <span class="keywordflow">if</span> (<a class="code" href="module_8h.html#a6814b6d7b0a7d23c41df65124eb77171" title="Register an application.">ast_register_application2</a>(<a class="code" href="pbx_8c.html#a5b85032a1e719d9b83d5699fd350134e" title="Declaration of builtin applications.">builtins</a>[x].name, <a class="code" href="pbx_8c.html#a5b85032a1e719d9b83d5699fd350134e" title="Declaration of builtin applications.">builtins</a>[x].execute, NULL, NULL, NULL)) {
<a name="l09320"></a>09320          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to register builtin application &apos;%s&apos;\n&quot;</span>, <a class="code" href="pbx_8c.html#a5b85032a1e719d9b83d5699fd350134e" title="Declaration of builtin applications.">builtins</a>[x].name);
<a name="l09321"></a>09321          <span class="keywordflow">return</span> -1;
<a name="l09322"></a>09322       }
<a name="l09323"></a>09323    }
<a name="l09324"></a>09324 
<a name="l09325"></a>09325    <span class="comment">/* Register manager application */</span>
<a name="l09326"></a>09326    <a class="code" href="group__Group__AMI.html#ga332bf7ef48f67d63d849dd9febb18fb2" title="Register a manager command with the manager interface.">ast_manager_register2</a>(<span class="stringliteral">&quot;ShowDialPlan&quot;</span>, <a class="code" href="manager_8h.html#a36fb89c2a73755209133b6c73fe92e54">EVENT_FLAG_CONFIG</a> | <a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <a class="code" href="pbx_8c.html#a08cb2466bf2b7844066c2e1f62a298db" title="Manager listing of dial plan.">manager_show_dialplan</a>, <span class="stringliteral">&quot;List dialplan&quot;</span>, <a class="code" href="pbx_8c.html#a17bcde67ea91a1acfecbf3d718e86e82">mandescr_show_dialplan</a>);
<a name="l09327"></a>09327 
<a name="l09328"></a>09328    <span class="keywordflow">if</span> (!(<a class="code" href="pbx_8c.html#a51ca11f2c73a7d856c3d3ca3e45fbc31" title="Subscription for device state change events.">device_state_sub</a> = <a class="code" href="event_8h.html#a517ac17630e7658463b66b309a6ce78f" title="Subscribe to events.">ast_event_subscribe</a>(<a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa8900374a138e7dbbc9da893f27923846">AST_EVENT_DEVICE_STATE</a>, <a class="code" href="pbx_8c.html#a6fb2c0a540b83365dcdc10b470116e82">device_state_cb</a>, NULL,
<a name="l09329"></a>09329          <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a04c78c1362e97d548344c354001c151f">AST_EVENT_IE_END</a>))) {
<a name="l09330"></a>09330       <span class="keywordflow">return</span> -1;
<a name="l09331"></a>09331    }
<a name="l09332"></a>09332 
<a name="l09333"></a>09333    <span class="keywordflow">return</span> 0;
<a name="l09334"></a>09334 }
<a name="l09335"></a><a class="code" href="pbx_8c.html#ac28a7ad3697ac6c336e4aa198cf3b890">09335</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#ac28a7ad3697ac6c336e4aa198cf3b890">conlock_wrlock_version</a> = 0;
<a name="l09336"></a>09336 
<a name="l09337"></a><a class="code" href="pbx_8c.html#a4e6adb9c7783644ea993758d9c7e28c8">09337</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a4e6adb9c7783644ea993758d9c7e28c8">ast_wrlock_contexts_version</a>(<span class="keywordtype">void</span>)
<a name="l09338"></a>09338 {
<a name="l09339"></a>09339    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#ac28a7ad3697ac6c336e4aa198cf3b890">conlock_wrlock_version</a>;
<a name="l09340"></a>09340 }
<a name="l09341"></a>09341 
<a name="l09342"></a>09342 <span class="comment">/*</span>
<a name="l09343"></a>09343 <span class="comment"> * Lock context list functions ...</span>
<a name="l09344"></a>09344 <span class="comment"> */</span>
<a name="l09345"></a><a class="code" href="pbx_8c.html#ac04ffd5cd493ca52d17885d1c4477089">09345</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a18c87dac5f7f4368c11b67d8026adc22" title="Write locks the context list.">ast_wrlock_contexts</a>()
<a name="l09346"></a>09346 {
<a name="l09347"></a>09347    <span class="keywordtype">int</span> res = <a class="code" href="lock_8h.html#a952527792bba2a323118ae911f9aa1f7">ast_rwlock_wrlock</a>(&amp;<a class="code" href="pbx_8c.html#aa0a1f2323798ac5928ae23d6fb55449e">conlock</a>);
<a name="l09348"></a>09348    <span class="keywordflow">if</span> (!res)
<a name="l09349"></a>09349       <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;<a class="code" href="pbx_8c.html#ac28a7ad3697ac6c336e4aa198cf3b890">conlock_wrlock_version</a>, 1);
<a name="l09350"></a>09350    <span class="keywordflow">return</span> res;
<a name="l09351"></a>09351 }
<a name="l09352"></a>09352 
<a name="l09353"></a><a class="code" href="pbx_8c.html#a3c2e5cea004f359e7906cd7a545e0918">09353</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()
<a name="l09354"></a>09354 {
<a name="l09355"></a>09355    <span class="keywordflow">return</span> <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;<a class="code" href="pbx_8c.html#aa0a1f2323798ac5928ae23d6fb55449e">conlock</a>);
<a name="l09356"></a>09356 }
<a name="l09357"></a>09357 
<a name="l09358"></a><a class="code" href="pbx_8c.html#a5a5d97bf481f8dbc2a9315f4fcb62fa6">09358</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>()
<a name="l09359"></a>09359 {
<a name="l09360"></a>09360    <span class="keywordflow">return</span> <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="pbx_8c.html#aa0a1f2323798ac5928ae23d6fb55449e">conlock</a>);
<a name="l09361"></a>09361 }
<a name="l09362"></a>09362 
<a name="l09363"></a>09363 <span class="comment">/*</span>
<a name="l09364"></a>09364 <span class="comment"> * Lock context ...</span>
<a name="l09365"></a>09365 <span class="comment"> */</span>
<a name="l09366"></a><a class="code" href="pbx_8c.html#a2c961dcbdcade8fac28960ed67c89bd2">09366</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a2c961dcbdcade8fac28960ed67c89bd2" title="Write locks a given context.">ast_wrlock_context</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con)
<a name="l09367"></a>09367 {
<a name="l09368"></a>09368    <span class="keywordflow">return</span> <a class="code" href="lock_8h.html#a952527792bba2a323118ae911f9aa1f7">ast_rwlock_wrlock</a>(&amp;con-&gt;<a class="code" href="structast__context.html#ace4e0066a5b24f84b90536e9906619f6">lock</a>);
<a name="l09369"></a>09369 }
<a name="l09370"></a>09370 
<a name="l09371"></a><a class="code" href="pbx_8c.html#af1a624244a07626a8f70843005206c95">09371</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#af1a624244a07626a8f70843005206c95" title="Read locks a given context.">ast_rdlock_context</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con)
<a name="l09372"></a>09372 {
<a name="l09373"></a>09373    <span class="keywordflow">return</span> <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;con-&gt;<a class="code" href="structast__context.html#ace4e0066a5b24f84b90536e9906619f6">lock</a>);
<a name="l09374"></a>09374 }
<a name="l09375"></a>09375 
<a name="l09376"></a><a class="code" href="pbx_8c.html#a805796e4728845bff70c4caf5b224308">09376</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con)
<a name="l09377"></a>09377 {
<a name="l09378"></a>09378    <span class="keywordflow">return</span> <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;con-&gt;<a class="code" href="structast__context.html#ace4e0066a5b24f84b90536e9906619f6">lock</a>);
<a name="l09379"></a>09379 }
<a name="l09380"></a>09380 
<a name="l09381"></a>09381 <span class="comment">/*</span>
<a name="l09382"></a>09382 <span class="comment"> * Name functions ...</span>
<a name="l09383"></a>09383 <span class="comment"> */</span>
<a name="l09384"></a><a class="code" href="pbx_8c.html#aa42372790072cff15f75c674917115b0">09384</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con)
<a name="l09385"></a>09385 {
<a name="l09386"></a>09386    <span class="keywordflow">return</span> con ? con-&gt;<a class="code" href="structast__context.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a> : NULL;
<a name="l09387"></a>09387 }
<a name="l09388"></a>09388 
<a name="l09389"></a><a class="code" href="pbx_8c.html#a65bb6651308bdad136b637965835cb82">09389</a> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="pbx_8h.html#a65bb6651308bdad136b637965835cb82">ast_get_extension_context</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *exten)
<a name="l09390"></a>09390 {
<a name="l09391"></a>09391    <span class="keywordflow">return</span> exten ? exten-&gt;<a class="code" href="structast__exten.html#a7733606f3f625c2782402ba971995641">parent</a> : NULL;
<a name="l09392"></a>09392 }
<a name="l09393"></a>09393 
<a name="l09394"></a><a class="code" href="pbx_8c.html#a6fb940c1fd9c74b9d573e0a91bb23697">09394</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *exten)
<a name="l09395"></a>09395 {
<a name="l09396"></a>09396    <span class="keywordflow">return</span> exten ? exten-&gt;<a class="code" href="structast__exten.html#a9c2cb8c1611452928af0def998e36335">exten</a> : NULL;
<a name="l09397"></a>09397 }
<a name="l09398"></a>09398 
<a name="l09399"></a><a class="code" href="pbx_8c.html#a54aae627e24c46cfd1ce479ddfa0f3d2">09399</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#a266960fe6aa4db1066ed0b012fb7eb62">ast_get_extension_label</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *exten)
<a name="l09400"></a>09400 {
<a name="l09401"></a>09401    <span class="keywordflow">return</span> exten ? exten-&gt;<a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a> : NULL;
<a name="l09402"></a>09402 }
<a name="l09403"></a>09403 
<a name="l09404"></a><a class="code" href="pbx_8c.html#a2868df0a39ca4a8cf87f06029f9e2ffb">09404</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(<span class="keyword">struct</span> <a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *inc)
<a name="l09405"></a>09405 {
<a name="l09406"></a>09406    <span class="keywordflow">return</span> inc ? inc-&gt;<a class="code" href="structast__include.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> : NULL;
<a name="l09407"></a>09407 }
<a name="l09408"></a>09408 
<a name="l09409"></a><a class="code" href="pbx_8c.html#a0c324514fc22df9cc5b32ceb68006e79">09409</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#a0c324514fc22df9cc5b32ceb68006e79">ast_get_ignorepat_name</a>(<span class="keyword">struct</span> <a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ip)
<a name="l09410"></a>09410 {
<a name="l09411"></a>09411    <span class="keywordflow">return</span> ip ? ip-&gt;<a class="code" href="structast__ignorepat.html#a22c50d97e30c98ae5e62eaed74605c78">pattern</a> : NULL;
<a name="l09412"></a>09412 }
<a name="l09413"></a>09413 
<a name="l09414"></a><a class="code" href="pbx_8c.html#a1662981db35d4125afaf6de98b2ba52f">09414</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a1662981db35d4125afaf6de98b2ba52f">ast_get_extension_priority</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *exten)
<a name="l09415"></a>09415 {
<a name="l09416"></a>09416    <span class="keywordflow">return</span> exten ? exten-&gt;<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> : -1;
<a name="l09417"></a>09417 }
<a name="l09418"></a>09418 
<a name="l09419"></a>09419 <span class="comment">/*</span>
<a name="l09420"></a>09420 <span class="comment"> * Registrar info functions ...</span>
<a name="l09421"></a>09421 <span class="comment"> */</span>
<a name="l09422"></a><a class="code" href="pbx_8c.html#a9df0a5d301454fe924172cf89c7165a4">09422</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#a9df0a5d301454fe924172cf89c7165a4">ast_get_context_registrar</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c)
<a name="l09423"></a>09423 {
<a name="l09424"></a>09424    <span class="keywordflow">return</span> c ? c-&gt;<a class="code" href="structast__context.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a> : NULL;
<a name="l09425"></a>09425 }
<a name="l09426"></a>09426 
<a name="l09427"></a><a class="code" href="pbx_8c.html#a7f23f7c798d61e68c32b21d3e0cd15a2">09427</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#a7f23f7c798d61e68c32b21d3e0cd15a2">ast_get_extension_registrar</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e)
<a name="l09428"></a>09428 {
<a name="l09429"></a>09429    <span class="keywordflow">return</span> e ? e-&gt;<a class="code" href="structast__exten.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a> : NULL;
<a name="l09430"></a>09430 }
<a name="l09431"></a>09431 
<a name="l09432"></a><a class="code" href="pbx_8c.html#a7a9aa5cd362edc7d593196f57686c2b9">09432</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#a7a9aa5cd362edc7d593196f57686c2b9">ast_get_include_registrar</a>(<span class="keyword">struct</span> <a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *i)
<a name="l09433"></a>09433 {
<a name="l09434"></a>09434    <span class="keywordflow">return</span> i ? i-&gt;<a class="code" href="structast__include.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a> : NULL;
<a name="l09435"></a>09435 }
<a name="l09436"></a>09436 
<a name="l09437"></a><a class="code" href="pbx_8c.html#a1a219215514e9ed08ff67cc02c2dd1d3">09437</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#a1a219215514e9ed08ff67cc02c2dd1d3">ast_get_ignorepat_registrar</a>(<span class="keyword">struct</span> <a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ip)
<a name="l09438"></a>09438 {
<a name="l09439"></a>09439    <span class="keywordflow">return</span> ip ? ip-&gt;<a class="code" href="structast__ignorepat.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a> : NULL;
<a name="l09440"></a>09440 }
<a name="l09441"></a>09441 
<a name="l09442"></a><a class="code" href="pbx_8c.html#a26c679c70c1a8dd0968579be0c1755ab">09442</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a26c679c70c1a8dd0968579be0c1755ab">ast_get_extension_matchcid</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e)
<a name="l09443"></a>09443 {
<a name="l09444"></a>09444    <span class="keywordflow">return</span> e ? e-&gt;<a class="code" href="structast__exten.html#af0803fced1d4ccfbc6ec4d8577d30525">matchcid</a> : 0;
<a name="l09445"></a>09445 }
<a name="l09446"></a>09446 
<a name="l09447"></a><a class="code" href="pbx_8c.html#aee004b6fcfccea3fa6acf9b7264f42c9">09447</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#aee004b6fcfccea3fa6acf9b7264f42c9">ast_get_extension_cidmatch</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e)
<a name="l09448"></a>09448 {
<a name="l09449"></a>09449    <span class="keywordflow">return</span> e ? e-&gt;<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a> : NULL;
<a name="l09450"></a>09450 }
<a name="l09451"></a>09451 
<a name="l09452"></a><a class="code" href="pbx_8c.html#a6594bb017b4d4fe1bc42370cc32ec974">09452</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e)
<a name="l09453"></a>09453 {
<a name="l09454"></a>09454    <span class="keywordflow">return</span> e ? e-&gt;<a class="code" href="structast__exten.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">app</a> : NULL;
<a name="l09455"></a>09455 }
<a name="l09456"></a>09456 
<a name="l09457"></a><a class="code" href="pbx_8c.html#ac0a6c0c39796f36864868365d8989f02">09457</a> <span class="keywordtype">void</span> *<a class="code" href="pbx_8h.html#ac0a6c0c39796f36864868365d8989f02">ast_get_extension_app_data</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e)
<a name="l09458"></a>09458 {
<a name="l09459"></a>09459    <span class="keywordflow">return</span> e ? e-&gt;<a class="code" href="structast__exten.html#a735984d41155bc1032e09bece8f8d66d">data</a> : NULL;
<a name="l09460"></a>09460 }
<a name="l09461"></a>09461 
<a name="l09462"></a><a class="code" href="pbx_8c.html#a87693eca302936ade0be97cab21e4f56">09462</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#a87693eca302936ade0be97cab21e4f56">ast_get_switch_name</a>(<span class="keyword">struct</span> <a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *sw)
<a name="l09463"></a>09463 {
<a name="l09464"></a>09464    <span class="keywordflow">return</span> sw ? sw-&gt;<a class="code" href="structast__sw.html#a5ac083a645d964373f022d03df4849c8">name</a> : NULL;
<a name="l09465"></a>09465 }
<a name="l09466"></a>09466 
<a name="l09467"></a><a class="code" href="pbx_8c.html#accdca3b300f8f1ff523872bd3a129adc">09467</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#accdca3b300f8f1ff523872bd3a129adc">ast_get_switch_data</a>(<span class="keyword">struct</span> <a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *sw)
<a name="l09468"></a>09468 {
<a name="l09469"></a>09469    <span class="keywordflow">return</span> sw ? sw-&gt;<a class="code" href="structast__sw.html#a91a70b77df95bd8b0830b49a094c2acb">data</a> : NULL;
<a name="l09470"></a>09470 }
<a name="l09471"></a>09471 
<a name="l09472"></a><a class="code" href="pbx_8c.html#af947a04e100465f0c03b870129ba3e48">09472</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#af947a04e100465f0c03b870129ba3e48">ast_get_switch_eval</a>(<span class="keyword">struct</span> <a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *sw)
<a name="l09473"></a>09473 {
<a name="l09474"></a>09474    <span class="keywordflow">return</span> sw-&gt;<a class="code" href="structast__sw.html#a4e3f077fec8b035a2678e7740f366dea">eval</a>;
<a name="l09475"></a>09475 }
<a name="l09476"></a>09476 
<a name="l09477"></a><a class="code" href="pbx_8c.html#a1361d2a84278cee910c8ca0c7964c84c">09477</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx_8h.html#a1361d2a84278cee910c8ca0c7964c84c">ast_get_switch_registrar</a>(<span class="keyword">struct</span> <a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *sw)
<a name="l09478"></a>09478 {
<a name="l09479"></a>09479    <span class="keywordflow">return</span> sw ? sw-&gt;<a class="code" href="structast__sw.html#aa05090666ce7a4905fe1b56b4fdd3be3">registrar</a> : NULL;
<a name="l09480"></a>09480 }
<a name="l09481"></a>09481 
<a name="l09482"></a>09482 <span class="comment">/*</span>
<a name="l09483"></a>09483 <span class="comment"> * Walking functions ...</span>
<a name="l09484"></a>09484 <span class="comment"> */</span>
<a name="l09485"></a><a class="code" href="pbx_8c.html#a4cd5282ca555370652a7304c0c7ea4c4">09485</a> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con)
<a name="l09486"></a>09486 {
<a name="l09487"></a>09487    <span class="keywordflow">return</span> con ? con-&gt;<a class="code" href="structast__context.html#a0d9eeadf3cb7b27fdcf4f70247dceec6">next</a> : <a class="code" href="pbx_8c.html#aae85d5aab50f2d1b8392d6df276f2561">contexts</a>;
<a name="l09488"></a>09488 }
<a name="l09489"></a>09489 
<a name="l09490"></a><a class="code" href="pbx_8c.html#a505ce4b1d8e816a6163f064bc27bc2d6">09490</a> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="pbx_8h.html#aa63685577f3479dcf31a9e77b2ff05a7">ast_walk_context_extensions</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con,
<a name="l09491"></a>09491    <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *exten)
<a name="l09492"></a>09492 {
<a name="l09493"></a>09493    <span class="keywordflow">if</span> (!exten)
<a name="l09494"></a>09494       <span class="keywordflow">return</span> con ? con-&gt;<a class="code" href="structast__context.html#a6611ebb8017b475186f83b2a62bc25d2">root</a> : NULL;
<a name="l09495"></a>09495    <span class="keywordflow">else</span>
<a name="l09496"></a>09496       <span class="keywordflow">return</span> exten-&gt;<a class="code" href="structast__exten.html#a559687cbebb609d8efb545c78d6c216f">next</a>;
<a name="l09497"></a>09497 }
<a name="l09498"></a>09498 
<a name="l09499"></a><a class="code" href="pbx_8c.html#a64653e3c5cdfab48075b4001bd74655d">09499</a> <span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *<a class="code" href="pbx_8h.html#a64653e3c5cdfab48075b4001bd74655d">ast_walk_context_switches</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con,
<a name="l09500"></a>09500    <span class="keyword">struct</span> <a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *sw)
<a name="l09501"></a>09501 {
<a name="l09502"></a>09502    <span class="keywordflow">if</span> (!sw)
<a name="l09503"></a>09503       <span class="keywordflow">return</span> con ? <a class="code" href="linkedlists_8h.html#adf1959c5c03a3a706da97ad2f49617e5" title="Returns the first entry contained in a list.">AST_LIST_FIRST</a>(&amp;con-&gt;<a class="code" href="structast__context.html#a1a88e64f1d400d544879fb192cb155e7">alts</a>) : NULL;
<a name="l09504"></a>09504    <span class="keywordflow">else</span>
<a name="l09505"></a>09505       <span class="keywordflow">return</span> <a class="code" href="linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6" title="Returns the next entry in the list after the given entry.">AST_LIST_NEXT</a>(sw, list);
<a name="l09506"></a>09506 }
<a name="l09507"></a>09507 
<a name="l09508"></a><a class="code" href="pbx_8c.html#a6772ce6e8de86d4b6c382dbf68ea4755">09508</a> <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="pbx_8h.html#a6772ce6e8de86d4b6c382dbf68ea4755">ast_walk_extension_priorities</a>(<span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *exten,
<a name="l09509"></a>09509    <span class="keyword">struct</span> <a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *priority)
<a name="l09510"></a>09510 {
<a name="l09511"></a>09511    <span class="keywordflow">return</span> priority ? priority-&gt;<a class="code" href="structast__exten.html#a82ac0c5fa68c0f0aafe79462d3b36eee">peer</a> : exten;
<a name="l09512"></a>09512 }
<a name="l09513"></a>09513 
<a name="l09514"></a><a class="code" href="pbx_8c.html#a142de6e0271ada6b306f2f7420a3fd77">09514</a> <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *<a class="code" href="pbx_8h.html#a142de6e0271ada6b306f2f7420a3fd77">ast_walk_context_includes</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con,
<a name="l09515"></a>09515    <span class="keyword">struct</span> <a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *inc)
<a name="l09516"></a>09516 {
<a name="l09517"></a>09517    <span class="keywordflow">if</span> (!inc)
<a name="l09518"></a>09518       <span class="keywordflow">return</span> con ? con-&gt;<a class="code" href="structast__context.html#abaa8691efe3e8fe26f5930720bfd8edb">includes</a> : NULL;
<a name="l09519"></a>09519    <span class="keywordflow">else</span>
<a name="l09520"></a>09520       <span class="keywordflow">return</span> inc-&gt;<a class="code" href="structast__include.html#ad21fd2a65c1cfe0ed6a0aa46f40c2083">next</a>;
<a name="l09521"></a>09521 }
<a name="l09522"></a>09522 
<a name="l09523"></a><a class="code" href="pbx_8c.html#a0e9dbe4e0003f65b67c78979f2fbfa8e">09523</a> <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *<a class="code" href="pbx_8h.html#a0e9dbe4e0003f65b67c78979f2fbfa8e">ast_walk_context_ignorepats</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con,
<a name="l09524"></a>09524    <span class="keyword">struct</span> <a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ip)
<a name="l09525"></a>09525 {
<a name="l09526"></a>09526    <span class="keywordflow">if</span> (!ip)
<a name="l09527"></a>09527       <span class="keywordflow">return</span> con ? con-&gt;<a class="code" href="structast__context.html#aedb0afcd332920e51d2f82860f794347">ignorepats</a> : NULL;
<a name="l09528"></a>09528    <span class="keywordflow">else</span>
<a name="l09529"></a>09529       <span class="keywordflow">return</span> ip-&gt;<a class="code" href="structast__ignorepat.html#a8ffe03069b70f493ab982ba43faced7f">next</a>;
<a name="l09530"></a>09530 }
<a name="l09531"></a>09531 
<a name="l09532"></a><a class="code" href="pbx_8c.html#aca6b16b4b7433a12e65103a2f1ab8028">09532</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aca6b16b4b7433a12e65103a2f1ab8028" title="Verifies includes in an ast_contect structure.">ast_context_verify_includes</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con)
<a name="l09533"></a>09533 {
<a name="l09534"></a>09534    <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *inc = NULL;
<a name="l09535"></a>09535    <span class="keywordtype">int</span> res = 0;
<a name="l09536"></a>09536 
<a name="l09537"></a>09537    <span class="keywordflow">while</span> ( (inc = <a class="code" href="pbx_8h.html#a142de6e0271ada6b306f2f7420a3fd77">ast_walk_context_includes</a>(con, inc)) ) {
<a name="l09538"></a>09538       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a2af2d2771e5347b18454a05dbc98e35f" title="Find a context.">ast_context_find</a>(inc-&gt;<a class="code" href="structast__include.html#a0fc4d731325a10cc181d26c7e5549b40">rname</a>))
<a name="l09539"></a>09539          <span class="keywordflow">continue</span>;
<a name="l09540"></a>09540 
<a name="l09541"></a>09541       res = -1;
<a name="l09542"></a>09542       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Context &apos;%s&apos; tries to include nonexistent context &apos;%s&apos;\n&quot;</span>,
<a name="l09543"></a>09543          <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(con), inc-&gt;<a class="code" href="structast__include.html#a0fc4d731325a10cc181d26c7e5549b40">rname</a>);
<a name="l09544"></a>09544       <span class="keywordflow">break</span>;
<a name="l09545"></a>09545    }
<a name="l09546"></a>09546 
<a name="l09547"></a>09547    <span class="keywordflow">return</span> res;
<a name="l09548"></a>09548 }
<a name="l09549"></a>09549 
<a name="l09550"></a>09550 
<a name="l09551"></a><a class="code" href="pbx_8c.html#a5c2ad0729efb2f13f192ee283f6f13c2">09551</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#a5c2ad0729efb2f13f192ee283f6f13c2">__ast_goto_if_exists</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority, <span class="keywordtype">int</span> async)
<a name="l09552"></a>09552 {
<a name="l09553"></a>09553    int (*goto_func)(<span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority);
<a name="l09554"></a>09554 
<a name="l09555"></a>09555    <span class="keywordflow">if</span> (!chan)
<a name="l09556"></a>09556       <span class="keywordflow">return</span> -2;
<a name="l09557"></a>09557 
<a name="l09558"></a>09558    <span class="keywordflow">if</span> (context == NULL)
<a name="l09559"></a>09559       context = chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l09560"></a>09560    <span class="keywordflow">if</span> (exten == NULL)
<a name="l09561"></a>09561       exten = chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>;
<a name="l09562"></a>09562 
<a name="l09563"></a>09563    goto_func = (async) ? <a class="code" href="pbx_8h.html#ae0ba2eb966a9e3376de61d30513f7302" title="Set the channel to next execute the specified dialplan location.">ast_async_goto</a> : <a class="code" href="pbx_8h.html#a9f840db4b5ef461ac2c0c975a57c9e89">ast_explicit_goto</a>;
<a name="l09564"></a>09564    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, context, exten, priority, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>))
<a name="l09565"></a>09565       <span class="keywordflow">return</span> goto_func(chan, context, exten, priority);
<a name="l09566"></a>09566    <span class="keywordflow">else</span>
<a name="l09567"></a>09567       <span class="keywordflow">return</span> -3;
<a name="l09568"></a>09568 }
<a name="l09569"></a>09569 
<a name="l09570"></a><a class="code" href="pbx_8c.html#a8f7166f50cb9642179c9b321b8143f55">09570</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a8f7166f50cb9642179c9b321b8143f55">ast_goto_if_exists</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span>* context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority)
<a name="l09571"></a>09571 {
<a name="l09572"></a>09572    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#a5c2ad0729efb2f13f192ee283f6f13c2">__ast_goto_if_exists</a>(chan, context, exten, priority, 0);
<a name="l09573"></a>09573 }
<a name="l09574"></a>09574 
<a name="l09575"></a><a class="code" href="pbx_8c.html#a281fc61f41a1be7fdd6c620372c4510b">09575</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#a281fc61f41a1be7fdd6c620372c4510b">ast_async_goto_if_exists</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> * context, <span class="keyword">const</span> <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> priority)
<a name="l09576"></a>09576 {
<a name="l09577"></a>09577    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#a5c2ad0729efb2f13f192ee283f6f13c2">__ast_goto_if_exists</a>(chan, context, exten, priority, 1);
<a name="l09578"></a>09578 }
<a name="l09579"></a>09579 
<a name="l09580"></a><a class="code" href="pbx_8c.html#aa18771ce9668fbafeb630ce5c802e6f8">09580</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx_8c.html#aa18771ce9668fbafeb630ce5c802e6f8">pbx_parseable_goto</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *goto_string, <span class="keywordtype">int</span> async)
<a name="l09581"></a>09581 {
<a name="l09582"></a>09582    <span class="keywordtype">char</span> *exten, *pri, *context;
<a name="l09583"></a>09583    <span class="keywordtype">char</span> *stringp;
<a name="l09584"></a>09584    <span class="keywordtype">int</span> ipri;
<a name="l09585"></a>09585    <span class="keywordtype">int</span> mode = 0;
<a name="l09586"></a>09586 
<a name="l09587"></a>09587    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(goto_string)) {
<a name="l09588"></a>09588       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Goto requires an argument ([[context,]extension,]priority)\n&quot;</span>);
<a name="l09589"></a>09589       <span class="keywordflow">return</span> -1;
<a name="l09590"></a>09590    }
<a name="l09591"></a>09591    stringp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(goto_string);
<a name="l09592"></a>09592    context = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>); <span class="comment">/* guaranteed non-null */</span>
<a name="l09593"></a>09593    exten = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l09594"></a>09594    pri = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l09595"></a>09595    <span class="keywordflow">if</span> (!exten) {  <span class="comment">/* Only a priority in this one */</span>
<a name="l09596"></a>09596       pri = context;
<a name="l09597"></a>09597       exten = NULL;
<a name="l09598"></a>09598       context = NULL;
<a name="l09599"></a>09599    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pri) {   <span class="comment">/* Only an extension and priority in this one */</span>
<a name="l09600"></a>09600       pri = exten;
<a name="l09601"></a>09601       exten = context;
<a name="l09602"></a>09602       context = NULL;
<a name="l09603"></a>09603    }
<a name="l09604"></a>09604    <span class="keywordflow">if</span> (*pri == <span class="charliteral">&apos;+&apos;</span>) {
<a name="l09605"></a>09605       mode = 1;
<a name="l09606"></a>09606       pri++;
<a name="l09607"></a>09607    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*pri == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l09608"></a>09608       mode = -1;
<a name="l09609"></a>09609       pri++;
<a name="l09610"></a>09610    }
<a name="l09611"></a>09611    <span class="keywordflow">if</span> (sscanf(pri, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;ipri) != 1) {
<a name="l09612"></a>09612       <span class="keywordflow">if</span> ((ipri = <a class="code" href="pbx_8h.html#a0be9518646cf9aca4878b313cc02e901" title="Find the priority of an extension that has the specified label.">ast_findlabel_extension</a>(chan, context ? context : chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, exten ? exten : chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>,
<a name="l09613"></a>09613          pri, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) &lt; 1) {
<a name="l09614"></a>09614          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Priority &apos;%s&apos; must be a number &gt; 0, or valid label\n&quot;</span>, pri);
<a name="l09615"></a>09615          <span class="keywordflow">return</span> -1;
<a name="l09616"></a>09616       } <span class="keywordflow">else</span>
<a name="l09617"></a>09617          mode = 0;
<a name="l09618"></a>09618    }
<a name="l09619"></a>09619    <span class="comment">/* At this point we have a priority and maybe an extension and a context */</span>
<a name="l09620"></a>09620 
<a name="l09621"></a>09621    <span class="keywordflow">if</span> (mode)
<a name="l09622"></a>09622       ipri = chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> + (ipri * mode);
<a name="l09623"></a>09623 
<a name="l09624"></a>09624    <span class="keywordflow">if</span> (async)
<a name="l09625"></a>09625       <a class="code" href="pbx_8h.html#ae0ba2eb966a9e3376de61d30513f7302" title="Set the channel to next execute the specified dialplan location.">ast_async_goto</a>(chan, context, exten, ipri);
<a name="l09626"></a>09626    <span class="keywordflow">else</span>
<a name="l09627"></a>09627       <a class="code" href="pbx_8h.html#a9f840db4b5ef461ac2c0c975a57c9e89">ast_explicit_goto</a>(chan, context, exten, ipri);
<a name="l09628"></a>09628 
<a name="l09629"></a>09629    <span class="keywordflow">return</span> 0;
<a name="l09630"></a>09630 
<a name="l09631"></a>09631 }
<a name="l09632"></a>09632 
<a name="l09633"></a><a class="code" href="pbx_8c.html#ae9b65b0515d88371a5293dd354bfd92f">09633</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#ae9b65b0515d88371a5293dd354bfd92f">ast_parseable_goto</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *goto_string)
<a name="l09634"></a>09634 {
<a name="l09635"></a>09635    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#aa18771ce9668fbafeb630ce5c802e6f8">pbx_parseable_goto</a>(chan, goto_string, 0);
<a name="l09636"></a>09636 }
<a name="l09637"></a>09637 
<a name="l09638"></a><a class="code" href="pbx_8c.html#aa2caee9cd93973d6f2bc806b34f564d6">09638</a> <span class="keywordtype">int</span> <a class="code" href="pbx_8h.html#aa2caee9cd93973d6f2bc806b34f564d6">ast_async_parseable_goto</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *goto_string)
<a name="l09639"></a>09639 {
<a name="l09640"></a>09640    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#aa18771ce9668fbafeb630ce5c802e6f8">pbx_parseable_goto</a>(chan, goto_string, 1);
<a name="l09641"></a>09641 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:44 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
