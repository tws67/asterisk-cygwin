<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:34 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_0ca6ff3bf6b340411b2c6edd15b1a34d.html">channels</a>
  </div>
</div>
<div class="contents">
<h1>chan_phone.c</h1><a href="chan__phone_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2005, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Generic Linux Telephony Interface driver</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> * </span>
<a name="l00025"></a>00025 <span class="comment"> * \ingroup channel_drivers</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">/*** MODULEINFO</span>
<a name="l00029"></a>00029 <span class="comment">   &lt;depend&gt;ixjuser&lt;/depend&gt;</span>
<a name="l00030"></a>00030 <span class="comment"> ***/</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 218219 $&quot;</span>)
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#ifdef HAVE_LINUX_COMPILER_H</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#include &lt;linux/compiler.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#endif</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">#include &lt;linux/telephony.h&gt;</span>
<a name="l00047"></a>00047 <span class="comment">/* Still use some IXJ specific stuff */</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;linux/version.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;linux/ixjuser.h&gt;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="callerid_8h.html" title="CallerID (and other GR30) management and generation Includes code and algorithms...">asterisk/callerid.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="causes_8h.html" title="Internal Asterisk hangup causes.">asterisk/causes.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="stringfields_8h.html" title="String fields in structures.">asterisk/stringfields.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="musiconhold_8h.html" title="Music on hold handling.">asterisk/musiconhold.h</a>&quot;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="chan__phone_8h.html" title="8-bit raw data">chan_phone.h</a>&quot;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="preprocessor">#ifdef QTI_PHONEJACK_TJ_PCI   </span><span class="comment">/* check for the newer quicknet driver v.3.1.0 which has this symbol */</span>
<a name="l00065"></a>00065 <span class="preprocessor">#define QNDRV_VER 310</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00067"></a><a class="code" href="chan__phone_8c.html#a595bb85454e48634bf7dc6b4a8be7b54">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define QNDRV_VER 100</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>
<a name="l00070"></a>00070 <span class="preprocessor">#if QNDRV_VER &gt; 100</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span><span class="preprocessor">#ifdef __linux__</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#define IXJ_PHONE_RING_START(x)  ioctl(p-&gt;fd, PHONE_RING_START, &amp;x);</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* FreeBSD and others */</span>
<a name="l00074"></a>00074 <span class="preprocessor">#define IXJ_PHONE_RING_START(x)  ioctl(p-&gt;fd, PHONE_RING_START, x);</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* __linux__ */</span>
<a name="l00076"></a>00076 <span class="preprocessor">#else </span><span class="comment">/* older driver */</span>
<a name="l00077"></a><a class="code" href="chan__phone_8c.html#a154bf8a83c81815b418875a067126911">00077</a> <span class="preprocessor">#define IXJ_PHONE_RING_START(x)  ioctl(p-&gt;fd, PHONE_RING_START, &amp;x);</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>
<a name="l00080"></a><a class="code" href="chan__phone_8c.html#a08dcb0799ab1e624d5d13fc03b525a6b">00080</a> <span class="preprocessor">#define DEFAULT_CALLER_ID &quot;Unknown&quot;</span>
<a name="l00081"></a><a class="code" href="chan__phone_8c.html#ab7836ec2839f81ee5198577026db5e52">00081</a> <span class="preprocessor"></span><span class="preprocessor">#define PHONE_MAX_BUF 480</span>
<a name="l00082"></a><a class="code" href="chan__phone_8c.html#ae242ab0e0a91e95de561944085dbdf20">00082</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_GAIN 0x100</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span>
<a name="l00084"></a><a class="code" href="chan__phone_8c.html#a71535bf985a1a06d548fd73a0a0ec32c">00084</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#adb02bb3719cdf90c200c1ca30caa26a2">tdesc</a>[] = <span class="stringliteral">&quot;Standard Linux Telephony API Driver&quot;</span>;
<a name="l00085"></a><a class="code" href="chan__phone_8c.html#a9ee8d742a1fbcff45f97842b92952610">00085</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="chan__phone_8c.html#a9ee8d742a1fbcff45f97842b92952610">config</a>[] = <span class="stringliteral">&quot;phone.conf&quot;</span>;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="comment">/* Default context for dialtone mode */</span>
<a name="l00088"></a><a class="code" href="chan__phone_8c.html#a579ca8125bbf48d9ce8691d522f99933">00088</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__phone_8c.html#a579ca8125bbf48d9ce8691d522f99933">context</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>] = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="comment">/* Default language */</span>
<a name="l00091"></a><a class="code" href="chan__phone_8c.html#adf416dc058363e2fd5750c77e2d78bee">00091</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__phone_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>[<a class="code" href="channel_8h.html#a9238c3318ae8d3bea2cbbe1d1e459eb7">MAX_LANGUAGE</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="chan__phone_8c.html#a48143a8246272fcff2ecff56f73a41e2">00093</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a48143a8246272fcff2ecff56f73a41e2">echocancel</a> = AEC_OFF;
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="chan__phone_8c.html#a39dbabe71fc136ab40c57638a9c5bdc3">00095</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a39dbabe71fc136ab40c57638a9c5bdc3">silencesupression</a> = 0;
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="chan__phone_8c.html#ad8bc4ba18c7318c701839cc0f3ba7f4c">00097</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#ad8bc4ba18c7318c701839cc0f3ba7f4c">prefformat</a> = <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a> | <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a> | <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a> | <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="comment">/* Protect the interface list (of phone_pvt&apos;s) */</span>
<a name="l00100"></a>00100 <a class="code" href="lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a>(iflock);
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 <span class="comment">/* Protect the monitoring thread, so only one process can kill or start it, and not</span>
<a name="l00103"></a>00103 <span class="comment">   when it&apos;s doing something critical. */</span>
<a name="l00104"></a>00104 <a class="code" href="lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a>(monlock);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="comment">/* Boolean value whether the monitoring thread shall continue. */</span>
<a name="l00107"></a><a class="code" href="chan__phone_8c.html#a4e40373706bcf5cdb9409dac3166d280">00107</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a4e40373706bcf5cdb9409dac3166d280">monitor</a>;
<a name="l00108"></a>00108    
<a name="l00109"></a>00109 <span class="comment">/* This is the thread for the monitor which checks for input on the channels</span>
<a name="l00110"></a>00110 <span class="comment">   which are not currently in use.  */</span>
<a name="l00111"></a><a class="code" href="chan__phone_8c.html#afbd6fc6e0ab3c1a04a518f19c21d4503">00111</a> <span class="keyword">static</span> pthread_t <a class="code" href="chan__phone_8c.html#afbd6fc6e0ab3c1a04a518f19c21d4503">monitor_thread</a> = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a83af94bb19a421cb25ca02d16fa5ba9c">restart_monitor</a>(<span class="keywordtype">void</span>);
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="comment">/* The private structures of the Phone Jack channels are linked for</span>
<a name="l00116"></a>00116 <span class="comment">   selecting outgoing channels */</span>
<a name="l00117"></a>00117    
<a name="l00118"></a><a class="code" href="chan__phone_8c.html#a2d67ba815c41bccc3dd5f6f6219b0421">00118</a> <span class="preprocessor">#define MODE_DIALTONE   1</span>
<a name="l00119"></a><a class="code" href="chan__phone_8c.html#acb566a1c37288668abf7c94e9e281bb0">00119</a> <span class="preprocessor"></span><span class="preprocessor">#define MODE_IMMEDIATE  2</span>
<a name="l00120"></a><a class="code" href="chan__phone_8c.html#a2c3c6a75812e99c888b368db385c0da4">00120</a> <span class="preprocessor"></span><span class="preprocessor">#define MODE_FXO  3</span>
<a name="l00121"></a><a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">00121</a> <span class="preprocessor"></span><span class="preprocessor">#define MODE_FXS        4</span>
<a name="l00122"></a><a class="code" href="chan__phone_8c.html#ae367b5b2a7a6a101de88045711b1548d">00122</a> <span class="preprocessor"></span><span class="preprocessor">#define MODE_SIGMA      5</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>
<a name="l00124"></a><a class="code" href="structphone__pvt.html">00124</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> {
<a name="l00125"></a><a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">00125</a>    <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;                    <span class="comment">/* Raw file descriptor for this device */</span>
<a name="l00126"></a><a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">00126</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>;    <span class="comment">/* Channel we belong to, possibly NULL */</span>
<a name="l00127"></a><a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">00127</a>    <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a>;                  <span class="comment">/* Is this in the  */</span>
<a name="l00128"></a><a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">00128</a>    <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a>;               <span class="comment">/* Last output format */</span>
<a name="l00129"></a><a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">00129</a>    <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a>;             <span class="comment">/* Last input format */</span>
<a name="l00130"></a><a class="code" href="structphone__pvt.html#a67a142c7a94ad8de02e972ed71b524df">00130</a>    <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#a67a142c7a94ad8de02e972ed71b524df">ministate</a>;             <span class="comment">/* Miniature state, for dialtone mode */</span>
<a name="l00131"></a><a class="code" href="structphone__pvt.html#a57552521ec2b1ee61736dc07b6c9e551">00131</a>    <span class="keywordtype">char</span> <a class="code" href="structphone__pvt.html#a57552521ec2b1ee61736dc07b6c9e551">dev</a>[256];             <span class="comment">/* Device name */</span>
<a name="l00132"></a><a class="code" href="structphone__pvt.html#af08f0f23f8bd67717c44fcf0e2089b93">00132</a>    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *<a class="code" href="structphone__pvt.html#af08f0f23f8bd67717c44fcf0e2089b93">next</a>;       <span class="comment">/* Next channel in list */</span>
<a name="l00133"></a><a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">00133</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> <a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>;       <span class="comment">/* Frame */</span>
<a name="l00134"></a><a class="code" href="structphone__pvt.html#a2f17a14e895a96fcf358194c2a09e863">00134</a>    <span class="keywordtype">char</span> <a class="code" href="structphone__pvt.html#a2f17a14e895a96fcf358194c2a09e863">offset</a>[<a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>];
<a name="l00135"></a><a class="code" href="structphone__pvt.html#a753269930706da4888a0312a67461c5e">00135</a>    <span class="keywordtype">char</span> <a class="code" href="structphone__pvt.html#a753269930706da4888a0312a67461c5e">buf</a>[<a class="code" href="chan__phone_8c.html#ab7836ec2839f81ee5198577026db5e52">PHONE_MAX_BUF</a>];               <span class="comment">/* Static buffer for reading frames */</span>
<a name="l00136"></a><a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">00136</a>    <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a>;
<a name="l00137"></a><a class="code" href="structphone__pvt.html#ad683a45ac7cdd8373dbbfb54bcc8f84e">00137</a>    <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#ad683a45ac7cdd8373dbbfb54bcc8f84e">dialtone</a>;
<a name="l00138"></a><a class="code" href="structphone__pvt.html#a709429a6031e18717677d5254d38586f">00138</a>    <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#a709429a6031e18717677d5254d38586f">txgain</a>, <a class="code" href="structphone__pvt.html#a80d0395aae5582433d6b02af3f8c270a">rxgain</a>;             <span class="comment">/* gain control for playing, recording  */</span>
<a name="l00139"></a>00139                            <span class="comment">/* 0x100 - 1.0, 0x200 - 2.0, 0x80 - 0.5 */</span>
<a name="l00140"></a><a class="code" href="structphone__pvt.html#aa8cf781c811971f235168779e567b632">00140</a>    <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#aa8cf781c811971f235168779e567b632">cpt</a>;                <span class="comment">/* Call Progress Tone playing? */</span>
<a name="l00141"></a><a class="code" href="structphone__pvt.html#a39dbabe71fc136ab40c57638a9c5bdc3">00141</a>    <span class="keywordtype">int</span> silencesupression;
<a name="l00142"></a><a class="code" href="structphone__pvt.html#a579ca8125bbf48d9ce8691d522f99933">00142</a>    <span class="keywordtype">char</span> context[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l00143"></a><a class="code" href="structphone__pvt.html#acf43630e808d686cb2560d2e5da821b0">00143</a>    <span class="keywordtype">char</span> <a class="code" href="structphone__pvt.html#acf43630e808d686cb2560d2e5da821b0">obuf</a>[<a class="code" href="chan__phone_8c.html#ab7836ec2839f81ee5198577026db5e52">PHONE_MAX_BUF</a> * 2];
<a name="l00144"></a><a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">00144</a>    <span class="keywordtype">char</span> <a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l00145"></a><a class="code" href="structphone__pvt.html#adf416dc058363e2fd5750c77e2d78bee">00145</a>    <span class="keywordtype">char</span> language[<a class="code" href="channel_8h.html#a9238c3318ae8d3bea2cbbe1d1e459eb7">MAX_LANGUAGE</a>];
<a name="l00146"></a><a class="code" href="structphone__pvt.html#a29e973bd94bfbaf59d939bd1bc988c32">00146</a>    <span class="keywordtype">char</span> <a class="code" href="structphone__pvt.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l00147"></a><a class="code" href="structphone__pvt.html#ade5a89f9bee15a492c760ec1765a292d">00147</a>    <span class="keywordtype">char</span> <a class="code" href="structphone__pvt.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l00148"></a>00148 } *<a class="code" href="chan__dahdi_8c.html#a38bc838f6d206eef6a7a7ca87f5848e7">iflist</a> = NULL;
<a name="l00149"></a>00149 
<a name="l00150"></a><a class="code" href="chan__phone_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">00150</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__phone_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l00151"></a><a class="code" href="chan__phone_8c.html#ade5a89f9bee15a492c760ec1765a292d">00151</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__phone_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__phone_8c.html#aa0757010d14c805c4fae22146bbf8c8c">phone_request</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="keywordtype">int</span> *<a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>);
<a name="l00154"></a>00154 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#abb910319091bc3fea6139d9c0b4501dd">phone_digit_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> digit);
<a name="l00155"></a>00155 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a1b25ea9be4f583b6660f89db116af48f">phone_digit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> digit, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration);
<a name="l00156"></a>00156 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#ada161f6a633590a5da6ed73d3c526cdf">phone_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> timeout);
<a name="l00157"></a>00157 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a7abe9df8ccd6f70a64528842ac5fa0ea">phone_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast);
<a name="l00158"></a>00158 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#aa23aef3b9df80c1b39b211ff866857b6">phone_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast);
<a name="l00159"></a>00159 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="chan__phone_8c.html#a239570850552fcb0d293ea6aaa235761">phone_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast);
<a name="l00160"></a>00160 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a9b30978466aa45f7d140a7600655cd4a">phone_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *frame);
<a name="l00161"></a>00161 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="chan__phone_8c.html#aee288e217e27db44d1988718ec6ce82f">phone_exception</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast);
<a name="l00162"></a>00162 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a043036f0b3c10569fa232cc531d53f4a">phone_send_text</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>);
<a name="l00163"></a>00163 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a3a52c2b48e640d9e6845c3569d781c51">phone_fixup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *old, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<span class="keyword">new</span>);
<a name="l00164"></a>00164 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#af072f87b7c2e316ab41b093299ab8ab1">phone_indicate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">int</span> condition, <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">size_t</span> <a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l00165"></a>00165 
<a name="l00166"></a><a class="code" href="chan__phone_8c.html#a58a4638dc375f9facde9ef5ab627168e">00166</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html" title="Structure to describe a channel &amp;quot;technology&amp;quot;, ie a channel driver See for...">ast_channel_tech</a> <a class="code" href="chan__phone_8c.html#a58a4638dc375f9facde9ef5ab627168e">phone_tech</a> = {
<a name="l00167"></a>00167    .<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a> = <span class="stringliteral">&quot;Phone&quot;</span>,
<a name="l00168"></a>00168    .description = tdesc,
<a name="l00169"></a>00169    .capabilities = <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a> | <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a> | <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a> | <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>,
<a name="l00170"></a>00170    .requester = <a class="code" href="chan__phone_8c.html#aa0757010d14c805c4fae22146bbf8c8c">phone_request</a>,
<a name="l00171"></a>00171    .send_digit_begin = <a class="code" href="chan__phone_8c.html#abb910319091bc3fea6139d9c0b4501dd">phone_digit_begin</a>,
<a name="l00172"></a>00172    .send_digit_end = <a class="code" href="chan__phone_8c.html#a1b25ea9be4f583b6660f89db116af48f">phone_digit_end</a>,
<a name="l00173"></a>00173    .call = <a class="code" href="chan__phone_8c.html#ada161f6a633590a5da6ed73d3c526cdf">phone_call</a>,
<a name="l00174"></a>00174    .hangup = <a class="code" href="chan__phone_8c.html#a7abe9df8ccd6f70a64528842ac5fa0ea">phone_hangup</a>,
<a name="l00175"></a>00175    .answer = <a class="code" href="chan__phone_8c.html#aa23aef3b9df80c1b39b211ff866857b6">phone_answer</a>,
<a name="l00176"></a>00176    .read = <a class="code" href="chan__phone_8c.html#a239570850552fcb0d293ea6aaa235761">phone_read</a>,
<a name="l00177"></a>00177    .write = <a class="code" href="chan__phone_8c.html#a9b30978466aa45f7d140a7600655cd4a">phone_write</a>,
<a name="l00178"></a>00178    .exception = <a class="code" href="chan__phone_8c.html#aee288e217e27db44d1988718ec6ce82f">phone_exception</a>,
<a name="l00179"></a>00179    .indicate = <a class="code" href="chan__phone_8c.html#af072f87b7c2e316ab41b093299ab8ab1">phone_indicate</a>,
<a name="l00180"></a>00180    .fixup = <a class="code" href="chan__phone_8c.html#a3a52c2b48e640d9e6845c3569d781c51">phone_fixup</a>
<a name="l00181"></a>00181 };
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="chan__phone_8c.html#aa0fe3f995b3c6e94593ab8e92175012f">00183</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html" title="Structure to describe a channel &amp;quot;technology&amp;quot;, ie a channel driver See for...">ast_channel_tech</a> <a class="code" href="chan__phone_8c.html#aa0fe3f995b3c6e94593ab8e92175012f">phone_tech_fxs</a> = {
<a name="l00184"></a>00184    .<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a> = <span class="stringliteral">&quot;Phone&quot;</span>,
<a name="l00185"></a>00185    .description = tdesc,
<a name="l00186"></a>00186    .requester = <a class="code" href="chan__phone_8c.html#aa0757010d14c805c4fae22146bbf8c8c">phone_request</a>,
<a name="l00187"></a>00187    .send_digit_begin = <a class="code" href="chan__phone_8c.html#abb910319091bc3fea6139d9c0b4501dd">phone_digit_begin</a>,
<a name="l00188"></a>00188    .send_digit_end = <a class="code" href="chan__phone_8c.html#a1b25ea9be4f583b6660f89db116af48f">phone_digit_end</a>,
<a name="l00189"></a>00189    .call = <a class="code" href="chan__phone_8c.html#ada161f6a633590a5da6ed73d3c526cdf">phone_call</a>,
<a name="l00190"></a>00190    .hangup = <a class="code" href="chan__phone_8c.html#a7abe9df8ccd6f70a64528842ac5fa0ea">phone_hangup</a>,
<a name="l00191"></a>00191    .answer = <a class="code" href="chan__phone_8c.html#aa23aef3b9df80c1b39b211ff866857b6">phone_answer</a>,
<a name="l00192"></a>00192    .read = <a class="code" href="chan__phone_8c.html#a239570850552fcb0d293ea6aaa235761">phone_read</a>,
<a name="l00193"></a>00193    .write = <a class="code" href="chan__phone_8c.html#a9b30978466aa45f7d140a7600655cd4a">phone_write</a>,
<a name="l00194"></a>00194    .exception = <a class="code" href="chan__phone_8c.html#aee288e217e27db44d1988718ec6ce82f">phone_exception</a>,
<a name="l00195"></a>00195    .write_video = <a class="code" href="chan__phone_8c.html#a9b30978466aa45f7d140a7600655cd4a">phone_write</a>,
<a name="l00196"></a>00196    .send_text = <a class="code" href="chan__phone_8c.html#a043036f0b3c10569fa232cc531d53f4a">phone_send_text</a>,
<a name="l00197"></a>00197    .indicate = <a class="code" href="chan__phone_8c.html#af072f87b7c2e316ab41b093299ab8ab1">phone_indicate</a>,
<a name="l00198"></a>00198    .fixup = <a class="code" href="chan__phone_8c.html#a3a52c2b48e640d9e6845c3569d781c51">phone_fixup</a>
<a name="l00199"></a>00199 };
<a name="l00200"></a>00200 
<a name="l00201"></a><a class="code" href="chan__phone_8c.html#a9997b95495fecbbdac1f8a753ee9b3d2">00201</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html" title="Structure to describe a channel &amp;quot;technology&amp;quot;, ie a channel driver See for...">ast_channel_tech</a> *<a class="code" href="chan__phone_8c.html#a9997b95495fecbbdac1f8a753ee9b3d2">cur_tech</a>;
<a name="l00202"></a>00202 
<a name="l00203"></a><a class="code" href="chan__phone_8c.html#af072f87b7c2e316ab41b093299ab8ab1">00203</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#af072f87b7c2e316ab41b093299ab8ab1">phone_indicate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">int</span> condition, <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> datalen)
<a name="l00204"></a>00204 {
<a name="l00205"></a>00205    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *p = chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00206"></a>00206    <span class="keywordtype">int</span> res=-1;
<a name="l00207"></a>00207    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Requested indication %d on channel %s\n&quot;</span>, condition, chan-&gt;name);
<a name="l00208"></a>00208    <span class="keywordflow">switch</span>(condition) {
<a name="l00209"></a>00209    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ae8f2cd460fdc81e0a774434fa002e4bf">AST_CONTROL_FLASH</a>:
<a name="l00210"></a>00210       ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, IXJCTL_PSTN_SET_STATE, PSTN_ON_HOOK);
<a name="l00211"></a>00211       usleep(320000);
<a name="l00212"></a>00212       ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, IXJCTL_PSTN_SET_STATE, PSTN_OFF_HOOK);
<a name="l00213"></a>00213          p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> = -1;
<a name="l00214"></a>00214          res = 0;
<a name="l00215"></a>00215          <span class="keywordflow">break</span>;
<a name="l00216"></a>00216    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>:
<a name="l00217"></a>00217       <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(chan, data, NULL);
<a name="l00218"></a>00218       <span class="keywordflow">break</span>;
<a name="l00219"></a>00219    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>:
<a name="l00220"></a>00220       <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l00221"></a>00221       <span class="keywordflow">break</span>;
<a name="l00222"></a>00222    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a009e81151b19671f42b5e84ab6a619f4">AST_CONTROL_SRCUPDATE</a>:
<a name="l00223"></a>00223       res = 0;
<a name="l00224"></a>00224       <span class="keywordflow">break</span>;
<a name="l00225"></a>00225    <span class="keywordflow">default</span>:
<a name="l00226"></a>00226       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Condition %d is not supported on channel %s\n&quot;</span>, condition, chan-&gt;name);
<a name="l00227"></a>00227    }
<a name="l00228"></a>00228    <span class="keywordflow">return</span> res;
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 
<a name="l00231"></a><a class="code" href="chan__phone_8c.html#a3a52c2b48e640d9e6845c3569d781c51">00231</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a3a52c2b48e640d9e6845c3569d781c51">phone_fixup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *old, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<span class="keyword">new</span>)
<a name="l00232"></a>00232 {
<a name="l00233"></a>00233    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *pvt = old-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00234"></a>00234    <span class="keywordflow">if</span> (pvt &amp;&amp; pvt-&gt;<a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> == old)
<a name="l00235"></a>00235       pvt-&gt;<a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = <span class="keyword">new</span>;
<a name="l00236"></a>00236    <span class="keywordflow">return</span> 0;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a><a class="code" href="chan__phone_8c.html#abb910319091bc3fea6139d9c0b4501dd">00239</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#abb910319091bc3fea6139d9c0b4501dd">phone_digit_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> digit)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241    <span class="comment">/* XXX Modify this callback to let Asterisk support controlling the length of DTMF */</span>
<a name="l00242"></a>00242    <span class="keywordflow">return</span> 0;
<a name="l00243"></a>00243 }
<a name="l00244"></a>00244 
<a name="l00245"></a><a class="code" href="chan__phone_8c.html#a1b25ea9be4f583b6660f89db116af48f">00245</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a1b25ea9be4f583b6660f89db116af48f">phone_digit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> digit, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration)
<a name="l00246"></a>00246 {
<a name="l00247"></a>00247    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *p;
<a name="l00248"></a>00248    <span class="keywordtype">int</span> outdigit;
<a name="l00249"></a>00249    p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00250"></a>00250    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Dialed %c\n&quot;</span>, digit);
<a name="l00251"></a>00251    <span class="keywordflow">switch</span>(digit) {
<a name="l00252"></a>00252    <span class="keywordflow">case</span> <span class="charliteral">&apos;0&apos;</span>:
<a name="l00253"></a>00253    <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>:
<a name="l00254"></a>00254    <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>:
<a name="l00255"></a>00255    <span class="keywordflow">case</span> <span class="charliteral">&apos;3&apos;</span>:
<a name="l00256"></a>00256    <span class="keywordflow">case</span> <span class="charliteral">&apos;4&apos;</span>:
<a name="l00257"></a>00257    <span class="keywordflow">case</span> <span class="charliteral">&apos;5&apos;</span>:
<a name="l00258"></a>00258    <span class="keywordflow">case</span> <span class="charliteral">&apos;6&apos;</span>:
<a name="l00259"></a>00259    <span class="keywordflow">case</span> <span class="charliteral">&apos;7&apos;</span>:
<a name="l00260"></a>00260    <span class="keywordflow">case</span> <span class="charliteral">&apos;8&apos;</span>:
<a name="l00261"></a>00261    <span class="keywordflow">case</span> <span class="charliteral">&apos;9&apos;</span>:
<a name="l00262"></a>00262       outdigit = digit - <span class="charliteral">&apos;0&apos;</span>;
<a name="l00263"></a>00263       <span class="keywordflow">break</span>;
<a name="l00264"></a>00264    <span class="keywordflow">case</span> <span class="charliteral">&apos;*&apos;</span>:
<a name="l00265"></a>00265       outdigit = 11;
<a name="l00266"></a>00266       <span class="keywordflow">break</span>;
<a name="l00267"></a>00267    <span class="keywordflow">case</span> <span class="charliteral">&apos;#&apos;</span>:
<a name="l00268"></a>00268       outdigit = 12;
<a name="l00269"></a>00269       <span class="keywordflow">break</span>;
<a name="l00270"></a>00270    <span class="keywordflow">case</span> <span class="charliteral">&apos;f&apos;</span>:   <span class="comment">/*flash*/</span>
<a name="l00271"></a>00271    <span class="keywordflow">case</span> <span class="charliteral">&apos;F&apos;</span>:
<a name="l00272"></a>00272       ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, IXJCTL_PSTN_SET_STATE, PSTN_ON_HOOK);
<a name="l00273"></a>00273       usleep(320000);
<a name="l00274"></a>00274       ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, IXJCTL_PSTN_SET_STATE, PSTN_OFF_HOOK);
<a name="l00275"></a>00275       p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> = -1;
<a name="l00276"></a>00276       <span class="keywordflow">return</span> 0;
<a name="l00277"></a>00277    <span class="keywordflow">default</span>:
<a name="l00278"></a>00278       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown digit &apos;%c&apos;\n&quot;</span>, digit);
<a name="l00279"></a>00279       <span class="keywordflow">return</span> -1;
<a name="l00280"></a>00280    }
<a name="l00281"></a>00281    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Dialed %d\n&quot;</span>, outdigit);
<a name="l00282"></a>00282    ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_TONE, outdigit);
<a name="l00283"></a>00283    p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> = -1;
<a name="l00284"></a>00284    <span class="keywordflow">return</span> 0;
<a name="l00285"></a>00285 }
<a name="l00286"></a>00286 
<a name="l00287"></a><a class="code" href="chan__phone_8c.html#ada161f6a633590a5da6ed73d3c526cdf">00287</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#ada161f6a633590a5da6ed73d3c526cdf">phone_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> timeout)
<a name="l00288"></a>00288 {
<a name="l00289"></a>00289    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *p;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291    PHONE_CID cid;
<a name="l00292"></a>00292    <span class="keyword">struct </span>timeval UtcTime = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00293"></a>00293    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l00294"></a>00294    <span class="keywordtype">int</span> start;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;UtcTime, &amp;tm, NULL);
<a name="l00297"></a>00297 
<a name="l00298"></a>00298    memset(&amp;cid, 0, <span class="keyword">sizeof</span>(PHONE_CID));
<a name="l00299"></a>00299    <span class="keywordflow">if</span>(&amp;tm != NULL) {
<a name="l00300"></a>00300       snprintf(cid.month, <span class="keyword">sizeof</span>(cid.month), <span class="stringliteral">&quot;%02d&quot;</span>,(tm.<a class="code" href="structast__tm.html#ada983deda100b604bee5716512453658">tm_mon</a> + 1));
<a name="l00301"></a>00301       snprintf(cid.day, <span class="keyword">sizeof</span>(cid.day),     <span class="stringliteral">&quot;%02d&quot;</span>, tm.<a class="code" href="structast__tm.html#a02048604d30b880033311cf542d63f92">tm_mday</a>);
<a name="l00302"></a>00302       snprintf(cid.hour, <span class="keyword">sizeof</span>(cid.hour),   <span class="stringliteral">&quot;%02d&quot;</span>, tm.<a class="code" href="structast__tm.html#a4d171061df9e012fcfbd1172b8440d5f">tm_hour</a>);
<a name="l00303"></a>00303       snprintf(cid.min, <span class="keyword">sizeof</span>(cid.min),     <span class="stringliteral">&quot;%02d&quot;</span>, tm.<a class="code" href="structast__tm.html#a987fa9280fe4cd6c6b8f77409f1c1504">tm_min</a>);
<a name="l00304"></a>00304    }
<a name="l00305"></a>00305    <span class="comment">/* the standard format of ast-&gt;callerid is:  &quot;name&quot; &lt;number&gt;, but not always complete */</span>
<a name="l00306"></a>00306    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(ast-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>))
<a name="l00307"></a>00307       strcpy(cid.name, <a class="code" href="chan__phone_8c.html#a08dcb0799ab1e624d5d13fc03b525a6b">DEFAULT_CALLER_ID</a>);
<a name="l00308"></a>00308    <span class="keywordflow">else</span>
<a name="l00309"></a>00309       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cid.name, ast-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="keyword">sizeof</span>(cid.name));
<a name="l00310"></a>00310 
<a name="l00311"></a>00311    <span class="keywordflow">if</span> (ast-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>) 
<a name="l00312"></a>00312       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cid.number, ast-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="keyword">sizeof</span>(cid.number));
<a name="l00313"></a>00313 
<a name="l00314"></a>00314    p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316    <span class="keywordflow">if</span> ((ast-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>) &amp;&amp; (ast-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660addb60fd97b55a4aea24f992e30fe3c84">AST_STATE_RESERVED</a>)) {
<a name="l00317"></a>00317       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;phone_call called on %s, neither down nor reserved\n&quot;</span>, ast-&gt;name);
<a name="l00318"></a>00318       <span class="keywordflow">return</span> -1;
<a name="l00319"></a>00319    }
<a name="l00320"></a>00320    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Ringing %s on %s (%d)\n&quot;</span>, dest, ast-&gt;name, ast-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[0]);
<a name="l00321"></a>00321 
<a name="l00322"></a>00322    start = <a class="code" href="chan__phone_8c.html#a154bf8a83c81815b418875a067126911">IXJ_PHONE_RING_START</a>(cid);
<a name="l00323"></a>00323    <span class="keywordflow">if</span> (start == -1)
<a name="l00324"></a>00324       <span class="keywordflow">return</span> -1;
<a name="l00325"></a>00325    
<a name="l00326"></a>00326    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> == <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a>) {
<a name="l00327"></a>00327       <span class="keywordtype">char</span> *digit = strchr(dest, <span class="charliteral">&apos;/&apos;</span>);
<a name="l00328"></a>00328       <span class="keywordflow">if</span> (digit)
<a name="l00329"></a>00329       {
<a name="l00330"></a>00330         digit++;
<a name="l00331"></a>00331         <span class="keywordflow">while</span> (*digit)
<a name="l00332"></a>00332           <a class="code" href="chan__phone_8c.html#a1b25ea9be4f583b6660f89db116af48f">phone_digit_end</a>(ast, *digit++, 0);
<a name="l00333"></a>00333       }
<a name="l00334"></a>00334    }
<a name="l00335"></a>00335  
<a name="l00336"></a>00336    <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(ast, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a5bf03bd84f434acaeefdacb0096e1baa">AST_STATE_RINGING</a>);
<a name="l00337"></a>00337    <a class="code" href="channel_8h.html#a60f9d2b0ab8b7a839902313321163b28" title="Queue a control frame with payload.">ast_queue_control</a>(ast, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>);
<a name="l00338"></a>00338    <span class="keywordflow">return</span> 0;
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a><a class="code" href="chan__phone_8c.html#a7abe9df8ccd6f70a64528842ac5fa0ea">00341</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a7abe9df8ccd6f70a64528842ac5fa0ea">phone_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast)
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *p;
<a name="l00344"></a>00344    p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00345"></a>00345    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;phone_hangup(%s)\n&quot;</span>, ast-&gt;name);
<a name="l00346"></a>00346    <span class="keywordflow">if</span> (!ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>) {
<a name="l00347"></a>00347       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Asked to hangup channel not connected\n&quot;</span>);
<a name="l00348"></a>00348       <span class="keywordflow">return</span> 0;
<a name="l00349"></a>00349    }
<a name="l00350"></a>00350    <span class="comment">/* XXX Is there anything we can do to really hang up except stop recording? */</span>
<a name="l00351"></a>00351    <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(ast, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>);
<a name="l00352"></a>00352    <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP))
<a name="l00353"></a>00353       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to stop recording\n&quot;</span>);
<a name="l00354"></a>00354    <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_STOP))
<a name="l00355"></a>00355       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to stop playing\n&quot;</span>);
<a name="l00356"></a>00356    <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_RING_STOP))
<a name="l00357"></a>00357       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to stop ringing\n&quot;</span>);
<a name="l00358"></a>00358    <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_CPT_STOP))
<a name="l00359"></a>00359       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to stop sounds\n&quot;</span>);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361    <span class="comment">/* If it&apos;s an FXO, hang them up */</span>
<a name="l00362"></a>00362    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> == <a class="code" href="chan__phone_8c.html#a2c3c6a75812e99c888b368db385c0da4">MODE_FXO</a>) {
<a name="l00363"></a>00363       <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PSTN_SET_STATE, PSTN_ON_HOOK))
<a name="l00364"></a>00364          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;ioctl(PHONE_PSTN_SET_STATE) failed on %s (%s)\n&quot;</span>,ast-&gt;name, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00365"></a>00365    }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367    <span class="comment">/* If they&apos;re off hook, give a busy signal */</span>
<a name="l00368"></a>00368    <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_HOOKSTATE)) {
<a name="l00369"></a>00369       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Got hunghup, giving busy signal\n&quot;</span>);
<a name="l00370"></a>00370       ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_BUSY);
<a name="l00371"></a>00371       p-&gt;<a class="code" href="structphone__pvt.html#aa8cf781c811971f235168779e567b632">cpt</a> = 1;
<a name="l00372"></a>00372    }
<a name="l00373"></a>00373    p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> = -1;
<a name="l00374"></a>00374    p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> = -1;
<a name="l00375"></a>00375    p-&gt;<a class="code" href="structphone__pvt.html#a67a142c7a94ad8de02e972ed71b524df">ministate</a> = 0;
<a name="l00376"></a>00376    p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a> = 0;
<a name="l00377"></a>00377    p-&gt;<a class="code" href="structphone__pvt.html#ad683a45ac7cdd8373dbbfb54bcc8f84e">dialtone</a> = 0;
<a name="l00378"></a>00378    memset(p-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>, 0, <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>));
<a name="l00379"></a>00379    ((<span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *)(ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>))-&gt;<a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = NULL;
<a name="l00380"></a>00380    <a class="code" href="module_8h.html#ac65fa15b16dbc563a2424af744ab003d">ast_module_unref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l00381"></a>00381    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Hungup &apos;%s&apos;\n&quot;</span>, ast-&gt;name);
<a name="l00382"></a>00382    ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = NULL;
<a name="l00383"></a>00383    <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(ast, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>);
<a name="l00384"></a>00384    <a class="code" href="chan__phone_8c.html#a83af94bb19a421cb25ca02d16fa5ba9c">restart_monitor</a>();
<a name="l00385"></a>00385    <span class="keywordflow">return</span> 0;
<a name="l00386"></a>00386 }
<a name="l00387"></a>00387 
<a name="l00388"></a><a class="code" href="chan__phone_8c.html#a237f2178493a2f229d717e32102a3f20">00388</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a237f2178493a2f229d717e32102a3f20">phone_setup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast)
<a name="l00389"></a>00389 {
<a name="l00390"></a>00390    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *p;
<a name="l00391"></a>00391    p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00392"></a>00392    ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_CPT_STOP);
<a name="l00393"></a>00393    <span class="comment">/* Nothing to answering really, just start recording */</span>
<a name="l00394"></a>00394    <span class="keywordflow">if</span> (ast-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a> == <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>) {
<a name="l00395"></a>00395       <span class="comment">/* Prefer g729 */</span>
<a name="l00396"></a>00396       ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l00397"></a>00397       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> != <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>) {
<a name="l00398"></a>00398          p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> = <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>;
<a name="l00399"></a>00399          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_CODEC, G729)) {
<a name="l00400"></a>00400             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to set codec to g729\n&quot;</span>);
<a name="l00401"></a>00401             <span class="keywordflow">return</span> -1;
<a name="l00402"></a>00402          }
<a name="l00403"></a>00403       }
<a name="l00404"></a>00404         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ast-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a> == <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a>) {
<a name="l00405"></a>00405       ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l00406"></a>00406       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> != <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a>) {
<a name="l00407"></a>00407          p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> = <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a>;
<a name="l00408"></a>00408          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_CODEC, G723_63)) {
<a name="l00409"></a>00409             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to set codec to g723.1\n&quot;</span>);
<a name="l00410"></a>00410             <span class="keywordflow">return</span> -1;
<a name="l00411"></a>00411          }
<a name="l00412"></a>00412       }
<a name="l00413"></a>00413    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ast-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a> == <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>) {
<a name="l00414"></a>00414       ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l00415"></a>00415       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> != <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>) {
<a name="l00416"></a>00416          p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l00417"></a>00417          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_CODEC, LINEAR16)) {
<a name="l00418"></a>00418             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to set codec to signed linear 16\n&quot;</span>);
<a name="l00419"></a>00419             <span class="keywordflow">return</span> -1;
<a name="l00420"></a>00420          }
<a name="l00421"></a>00421       }
<a name="l00422"></a>00422    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ast-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a> == <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>) {
<a name="l00423"></a>00423       ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l00424"></a>00424       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> != <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>) {
<a name="l00425"></a>00425          p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> = <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>;
<a name="l00426"></a>00426          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_CODEC, ULAW)) {
<a name="l00427"></a>00427             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to set codec to uLaw\n&quot;</span>);
<a name="l00428"></a>00428             <span class="keywordflow">return</span> -1;
<a name="l00429"></a>00429          }
<a name="l00430"></a>00430       }
<a name="l00431"></a>00431    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> == <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a>) {
<a name="l00432"></a>00432       ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l00433"></a>00433       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> != ast-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a>) {
<a name="l00434"></a>00434          p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> = ast-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a>;
<a name="l00435"></a>00435          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_CODEC, ast-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a>)) {
<a name="l00436"></a>00436             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to set codec to %d\n&quot;</span>, 
<a name="l00437"></a>00437                ast-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a>);
<a name="l00438"></a>00438             <span class="keywordflow">return</span> -1;
<a name="l00439"></a>00439          }
<a name="l00440"></a>00440       }
<a name="l00441"></a>00441    } <span class="keywordflow">else</span> {
<a name="l00442"></a>00442       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t do format %s\n&quot;</span>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(ast-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a>));
<a name="l00443"></a>00443       <span class="keywordflow">return</span> -1;
<a name="l00444"></a>00444    }
<a name="l00445"></a>00445    <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_START)) {
<a name="l00446"></a>00446       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to start recording\n&quot;</span>);
<a name="l00447"></a>00447       <span class="keywordflow">return</span> -1;
<a name="l00448"></a>00448    }
<a name="l00449"></a>00449    <span class="comment">/* set the DTMF times (the default is too short) */</span>
<a name="l00450"></a>00450    ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_SET_TONE_ON_TIME, 300);
<a name="l00451"></a>00451    ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_SET_TONE_OFF_TIME, 200);
<a name="l00452"></a>00452    <span class="keywordflow">return</span> 0;
<a name="l00453"></a>00453 }
<a name="l00454"></a>00454 
<a name="l00455"></a><a class="code" href="chan__phone_8c.html#aa23aef3b9df80c1b39b211ff866857b6">00455</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#aa23aef3b9df80c1b39b211ff866857b6">phone_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast)
<a name="l00456"></a>00456 {
<a name="l00457"></a>00457    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *p;
<a name="l00458"></a>00458    p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00459"></a>00459    <span class="comment">/* In case it&apos;s a LineJack, take it off hook */</span>
<a name="l00460"></a>00460    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> == <a class="code" href="chan__phone_8c.html#a2c3c6a75812e99c888b368db385c0da4">MODE_FXO</a>) {
<a name="l00461"></a>00461       <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PSTN_SET_STATE, PSTN_OFF_HOOK))
<a name="l00462"></a>00462          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;ioctl(PHONE_PSTN_SET_STATE) failed on %s (%s)\n&quot;</span>, ast-&gt;name, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00463"></a>00463       <span class="keywordflow">else</span>
<a name="l00464"></a>00464          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Took linejack off hook\n&quot;</span>);
<a name="l00465"></a>00465    }
<a name="l00466"></a>00466    <a class="code" href="chan__phone_8c.html#a237f2178493a2f229d717e32102a3f20">phone_setup</a>(ast);
<a name="l00467"></a>00467    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;phone_answer(%s)\n&quot;</span>, ast-&gt;name);
<a name="l00468"></a>00468    ast-&gt;<a class="code" href="structast__channel.html#a358fd14658a0c5276190e48f1b1f251a">rings</a> = 0;
<a name="l00469"></a>00469    <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(ast, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>);
<a name="l00470"></a>00470    <span class="keywordflow">return</span> 0;
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 <span class="preprocessor">#if 0</span>
<a name="l00474"></a>00474 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">char</span> phone_2digit(<span class="keywordtype">char</span> c)
<a name="l00475"></a>00475 {
<a name="l00476"></a>00476    <span class="keywordflow">if</span> (c == 12)
<a name="l00477"></a>00477       <span class="keywordflow">return</span> <span class="charliteral">&apos;#&apos;</span>;
<a name="l00478"></a>00478    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == 11)
<a name="l00479"></a>00479       <span class="keywordflow">return</span> <span class="charliteral">&apos;*&apos;</span>;
<a name="l00480"></a>00480    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &lt; 10) &amp;&amp; (c &gt;= 0))
<a name="l00481"></a>00481       <span class="keywordflow">return</span> <span class="charliteral">&apos;0&apos;</span> + c - 1;
<a name="l00482"></a>00482    <span class="keywordflow">else</span>
<a name="l00483"></a>00483       <span class="keywordflow">return</span> <span class="charliteral">&apos;?&apos;</span>;
<a name="l00484"></a>00484 }
<a name="l00485"></a>00485 <span class="preprocessor">#endif</span>
<a name="l00486"></a>00486 <span class="preprocessor"></span>
<a name="l00487"></a><a class="code" href="chan__phone_8c.html#aee288e217e27db44d1988718ec6ce82f">00487</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a>  *<a class="code" href="chan__phone_8c.html#aee288e217e27db44d1988718ec6ce82f">phone_exception</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast)
<a name="l00488"></a>00488 {
<a name="l00489"></a>00489    <span class="keywordtype">int</span> res;
<a name="l00490"></a>00490    <span class="keyword">union </span>telephony_exception phonee;
<a name="l00491"></a>00491    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00492"></a>00492    <span class="keywordtype">char</span> digit;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494    <span class="comment">/* Some nice norms */</span>
<a name="l00495"></a>00495    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = 0;
<a name="l00496"></a>00496    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = 0;
<a name="l00497"></a>00497    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> =  NULL;
<a name="l00498"></a>00498    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a> = <span class="stringliteral">&quot;Phone&quot;</span>;
<a name="l00499"></a>00499    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = 0;
<a name="l00500"></a>00500    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#aed16590d48f41d89f31e0cf347f5cd99">mallocd</a>=0;
<a name="l00501"></a>00501    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a> = <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0,0);
<a name="l00502"></a>00502    
<a name="l00503"></a>00503    phonee.bytes = ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_EXCEPTION);
<a name="l00504"></a>00504    <span class="keywordflow">if</span> (phonee.bits.dtmf_ready)  {
<a name="l00505"></a>00505       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;phone_exception(): DTMF\n&quot;</span>);
<a name="l00506"></a>00506    
<a name="l00507"></a>00507       <span class="comment">/* We&apos;ve got a digit -- Just handle this nicely and easily */</span>
<a name="l00508"></a>00508       digit =  ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_GET_DTMF_ASCII);
<a name="l00509"></a>00509       p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = digit;
<a name="l00510"></a>00510       p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>;
<a name="l00511"></a>00511       <span class="keywordflow">return</span> &amp;p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>;
<a name="l00512"></a>00512    }
<a name="l00513"></a>00513    <span class="keywordflow">if</span> (phonee.bits.hookstate) {
<a name="l00514"></a>00514       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Hookstate changed\n&quot;</span>);
<a name="l00515"></a>00515       res = ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_HOOKSTATE);
<a name="l00516"></a>00516       <span class="comment">/* See if we&apos;ve gone on hook, if so, notify by returning NULL */</span>
<a name="l00517"></a>00517       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;New hookstate: %d\n&quot;</span>, res);
<a name="l00518"></a>00518       <span class="keywordflow">if</span> (!res &amp;&amp; (p-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> != <a class="code" href="chan__phone_8c.html#a2c3c6a75812e99c888b368db385c0da4">MODE_FXO</a>))
<a name="l00519"></a>00519          <span class="keywordflow">return</span> NULL;
<a name="l00520"></a>00520       <span class="keywordflow">else</span> {
<a name="l00521"></a>00521          <span class="keywordflow">if</span> (ast-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a5bf03bd84f434acaeefdacb0096e1baa">AST_STATE_RINGING</a>) {
<a name="l00522"></a>00522             <span class="comment">/* They&apos;ve picked up the phone */</span>
<a name="l00523"></a>00523             p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>;
<a name="l00524"></a>00524             p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a9e3135920bd5bdbfd8c57fdaaa6b1dbe">AST_CONTROL_ANSWER</a>;
<a name="l00525"></a>00525             <a class="code" href="chan__phone_8c.html#a237f2178493a2f229d717e32102a3f20">phone_setup</a>(ast);
<a name="l00526"></a>00526             <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(ast, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>);
<a name="l00527"></a>00527             <span class="keywordflow">return</span> &amp;p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>;
<a name="l00528"></a>00528          }  <span class="keywordflow">else</span> 
<a name="l00529"></a>00529             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Got off hook in weird state %d\n&quot;</span>, ast-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a>);
<a name="l00530"></a>00530       }
<a name="l00531"></a>00531    }
<a name="l00532"></a>00532 <span class="preprocessor">#if 1</span>
<a name="l00533"></a>00533 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (phonee.bits.pstn_ring)
<a name="l00534"></a>00534       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Unit is ringing\n&quot;</span>);
<a name="l00535"></a>00535    <span class="keywordflow">if</span> (phonee.bits.caller_id) {
<a name="l00536"></a>00536       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;We have caller ID\n&quot;</span>);
<a name="l00537"></a>00537    }
<a name="l00538"></a>00538    <span class="keywordflow">if</span> (phonee.bits.pstn_wink)
<a name="l00539"></a>00539       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Detected Wink\n&quot;</span>);
<a name="l00540"></a>00540 <span class="preprocessor">#endif</span>
<a name="l00541"></a>00541 <span class="preprocessor"></span>   <span class="comment">/* Strange -- nothing there.. */</span>
<a name="l00542"></a>00542    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a29ff71f9d5c7927906ebd437fe372056">AST_FRAME_NULL</a>;
<a name="l00543"></a>00543    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = 0;
<a name="l00544"></a>00544    <span class="keywordflow">return</span> &amp;p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>;
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00547"></a><a class="code" href="chan__phone_8c.html#a239570850552fcb0d293ea6aaa235761">00547</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a>  *<a class="code" href="chan__phone_8c.html#a239570850552fcb0d293ea6aaa235761">phone_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast)
<a name="l00548"></a>00548 {
<a name="l00549"></a>00549    <span class="keywordtype">int</span> res;
<a name="l00550"></a>00550    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00551"></a>00551    
<a name="l00552"></a>00552 
<a name="l00553"></a>00553    <span class="comment">/* Some nice norms */</span>
<a name="l00554"></a>00554    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = 0;
<a name="l00555"></a>00555    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = 0;
<a name="l00556"></a>00556    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> =  NULL;
<a name="l00557"></a>00557    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a> = <span class="stringliteral">&quot;Phone&quot;</span>;
<a name="l00558"></a>00558    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = 0;
<a name="l00559"></a>00559    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#aed16590d48f41d89f31e0cf347f5cd99">mallocd</a>=0;
<a name="l00560"></a>00560    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a> = <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0,0);
<a name="l00561"></a>00561 
<a name="l00562"></a>00562    <span class="comment">/* Try to read some data... */</span>
<a name="l00563"></a>00563    <a class="code" href="channel_8h.html#a3a5d847510a477edda3d0bc1459709f4">CHECK_BLOCKING</a>(ast);
<a name="l00564"></a>00564    res = read(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, p-&gt;<a class="code" href="structphone__pvt.html#a753269930706da4888a0312a67461c5e">buf</a>, <a class="code" href="chan__phone_8c.html#ab7836ec2839f81ee5198577026db5e52">PHONE_MAX_BUF</a>);
<a name="l00565"></a>00565    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(ast, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ab5b2bec9425dd0cfc789d96ef229cb3a">AST_FLAG_BLOCKING</a>);
<a name="l00566"></a>00566    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00567"></a>00567 <span class="preprocessor">#if 0</span>
<a name="l00568"></a>00568 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EAGAIN) {
<a name="l00569"></a>00569          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Null frame received\n&quot;</span>);
<a name="l00570"></a>00570          p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a29ff71f9d5c7927906ebd437fe372056">AST_FRAME_NULL</a>;
<a name="l00571"></a>00571          p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = 0;
<a name="l00572"></a>00572          <span class="keywordflow">return</span> &amp;p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>;
<a name="l00573"></a>00573       }
<a name="l00574"></a>00574 <span class="preprocessor">#endif</span>
<a name="l00575"></a>00575 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error reading: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00576"></a>00576       <span class="keywordflow">return</span> NULL;
<a name="l00577"></a>00577    }
<a name="l00578"></a>00578    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = p-&gt;<a class="code" href="structphone__pvt.html#a753269930706da4888a0312a67461c5e">buf</a>;
<a name="l00579"></a>00579    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> != <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a>)
<a name="l00580"></a>00580    <span class="keywordflow">switch</span>(p-&gt;<a class="code" href="structphone__pvt.html#a753269930706da4888a0312a67461c5e">buf</a>[0] &amp; 0x3) {
<a name="l00581"></a>00581    <span class="keywordflow">case</span> <span class="charliteral">&apos;0&apos;</span>:
<a name="l00582"></a>00582    <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>:
<a name="l00583"></a>00583       <span class="comment">/* Normal */</span>
<a name="l00584"></a>00584       <span class="keywordflow">break</span>;
<a name="l00585"></a>00585    <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>:
<a name="l00586"></a>00586    <span class="keywordflow">case</span> <span class="charliteral">&apos;3&apos;</span>:
<a name="l00587"></a>00587       <span class="comment">/* VAD/CNG, only send two words */</span>
<a name="l00588"></a>00588       res = 4;
<a name="l00589"></a>00589       <span class="keywordflow">break</span>;
<a name="l00590"></a>00590    }
<a name="l00591"></a>00591    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = 240;
<a name="l00592"></a>00592    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = res;
<a name="l00593"></a>00593    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> &lt;= <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a> ?
<a name="l00594"></a>00594                           <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a> : 
<a name="l00595"></a>00595            p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> &lt;= <a class="code" href="frame_8h.html#a66201142be0584b5741786416aa3e446">AST_FORMAT_PNG</a> ? <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a6c9398ee8989239124295d096a87bf32">AST_FRAME_IMAGE</a> 
<a name="l00596"></a>00596            : <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>;
<a name="l00597"></a>00597    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a>;
<a name="l00598"></a>00598    p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>;
<a name="l00599"></a>00599    <span class="comment">/* Byteswap from little-endian to native-endian */</span>
<a name="l00600"></a>00600    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>)
<a name="l00601"></a>00601       <a class="code" href="frame_8h.html#aaf462b0134f5e50cf6f671622fa40003">ast_frame_byteswap_le</a>(&amp;p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>);
<a name="l00602"></a>00602    <span class="keywordflow">return</span> &amp;p-&gt;<a class="code" href="structphone__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>;
<a name="l00603"></a>00603 }
<a name="l00604"></a>00604 
<a name="l00605"></a><a class="code" href="chan__phone_8c.html#a8e9be4ef55dc935a5a791e66867038f5">00605</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a8e9be4ef55dc935a5a791e66867038f5">phone_write_buf</a>(<span class="keyword">struct</span> <a class="code" href="structphone__pvt.html">phone_pvt</a> *p, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keywordtype">int</span> frlen, <span class="keywordtype">int</span> swap)
<a name="l00606"></a>00606 {
<a name="l00607"></a>00607    <span class="keywordtype">int</span> res;
<a name="l00608"></a>00608    <span class="comment">/* Store as much of the buffer as we can, then write fixed frames */</span>
<a name="l00609"></a>00609    <span class="keywordtype">int</span> space = <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structphone__pvt.html#acf43630e808d686cb2560d2e5da821b0">obuf</a>) - p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a>;
<a name="l00610"></a>00610    <span class="comment">/* Make sure we have enough buffer space to store the frame */</span>
<a name="l00611"></a>00611    if (space &lt; len)
<a name="l00612"></a>00612       len = space;
<a name="l00613"></a>00613    <span class="keywordflow">if</span> (swap)
<a name="l00614"></a>00614       <a class="code" href="frame_8h.html#ad3313ac3c6813594f1ea408e26505be7">ast_swapcopy_samples</a>(p-&gt;<a class="code" href="structphone__pvt.html#acf43630e808d686cb2560d2e5da821b0">obuf</a>+p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a>, buf, len/2);
<a name="l00615"></a>00615    <span class="keywordflow">else</span>
<a name="l00616"></a>00616       memcpy(p-&gt;<a class="code" href="structphone__pvt.html#acf43630e808d686cb2560d2e5da821b0">obuf</a> + p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a>, buf, len);
<a name="l00617"></a>00617    p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a> += len;
<a name="l00618"></a>00618    <span class="keywordflow">while</span>(p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a> &gt; frlen) {
<a name="l00619"></a>00619       res = write(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, p-&gt;<a class="code" href="structphone__pvt.html#acf43630e808d686cb2560d2e5da821b0">obuf</a>, frlen);
<a name="l00620"></a>00620       <span class="keywordflow">if</span> (res != frlen) {
<a name="l00621"></a>00621          <span class="keywordflow">if</span> (res &lt; 1) {
<a name="l00622"></a>00622 <span class="comment">/*</span>
<a name="l00623"></a>00623 <span class="comment"> * Card is in non-blocking mode now and it works well now, but there are</span>
<a name="l00624"></a>00624 <span class="comment"> * lot of messages like this. So, this message is temporarily disabled.</span>
<a name="l00625"></a>00625 <span class="comment"> */</span>
<a name="l00626"></a>00626             <span class="keywordflow">return</span> 0;
<a name="l00627"></a>00627          } <span class="keywordflow">else</span> {
<a name="l00628"></a>00628             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Only wrote %d of %d bytes\n&quot;</span>, res, frlen);
<a name="l00629"></a>00629          }
<a name="l00630"></a>00630       }
<a name="l00631"></a>00631       p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a> -= frlen;
<a name="l00632"></a>00632       <span class="comment">/* Move memory if necessary */</span>
<a name="l00633"></a>00633       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a>) 
<a name="l00634"></a>00634          memmove(p-&gt;<a class="code" href="structphone__pvt.html#acf43630e808d686cb2560d2e5da821b0">obuf</a>, p-&gt;<a class="code" href="structphone__pvt.html#acf43630e808d686cb2560d2e5da821b0">obuf</a> + frlen, p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a>);
<a name="l00635"></a>00635    }
<a name="l00636"></a>00636    <span class="keywordflow">return</span> len;
<a name="l00637"></a>00637 }
<a name="l00638"></a>00638 
<a name="l00639"></a><a class="code" href="chan__phone_8c.html#a043036f0b3c10569fa232cc531d53f4a">00639</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a043036f0b3c10569fa232cc531d53f4a">phone_send_text</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>)
<a name="l00640"></a>00640 {
<a name="l00641"></a>00641     <span class="keywordtype">int</span> length = strlen(text);
<a name="l00642"></a>00642     <span class="keywordflow">return</span> <a class="code" href="chan__phone_8c.html#a8e9be4ef55dc935a5a791e66867038f5">phone_write_buf</a>(ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>, text, length, length, 0) == 
<a name="l00643"></a>00643            length ? 0 : -1;
<a name="l00644"></a>00644 }
<a name="l00645"></a>00645 
<a name="l00646"></a><a class="code" href="chan__phone_8c.html#a9b30978466aa45f7d140a7600655cd4a">00646</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a9b30978466aa45f7d140a7600655cd4a">phone_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *frame)
<a name="l00647"></a>00647 {
<a name="l00648"></a>00648    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00649"></a>00649    <span class="keywordtype">int</span> res;
<a name="l00650"></a>00650    <span class="keywordtype">int</span> maxfr=0;
<a name="l00651"></a>00651    <span class="keywordtype">char</span> *pos;
<a name="l00652"></a>00652    <span class="keywordtype">int</span> sofar;
<a name="l00653"></a>00653    <span class="keywordtype">int</span> expected;
<a name="l00654"></a>00654    <span class="keywordtype">int</span> codecset = 0;
<a name="l00655"></a>00655    <span class="keywordtype">char</span> tmpbuf[4];
<a name="l00656"></a>00656    <span class="comment">/* Write a frame of (presumably voice) data */</span>
<a name="l00657"></a>00657    <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a> &amp;&amp; p-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> != <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a>) {
<a name="l00658"></a>00658       <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a6c9398ee8989239124295d096a87bf32">AST_FRAME_IMAGE</a>)
<a name="l00659"></a>00659          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Don&apos;t know what to do with  frame type &apos;%d&apos;\n&quot;</span>, frame-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>);
<a name="l00660"></a>00660       <span class="keywordflow">return</span> 0;
<a name="l00661"></a>00661    }
<a name="l00662"></a>00662    <span class="keywordflow">if</span> (!(frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp;
<a name="l00663"></a>00663       (<a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a> | <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a> | <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a> | <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>)) &amp;&amp; 
<a name="l00664"></a>00664        p-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> != <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a>) {
<a name="l00665"></a>00665       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot handle frames in %d format\n&quot;</span>, frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00666"></a>00666       <span class="keywordflow">return</span> -1;
<a name="l00667"></a>00667    }
<a name="l00668"></a>00668 <span class="preprocessor">#if 0</span>
<a name="l00669"></a>00669 <span class="preprocessor"></span>   <span class="comment">/* If we&apos;re not in up mode, go into up mode now */</span>
<a name="l00670"></a>00670    <span class="keywordflow">if</span> (ast-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l00671"></a>00671       <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(ast, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>);
<a name="l00672"></a>00672       <a class="code" href="chan__phone_8c.html#a237f2178493a2f229d717e32102a3f20">phone_setup</a>(ast);
<a name="l00673"></a>00673    }
<a name="l00674"></a>00674 <span class="preprocessor">#else</span>
<a name="l00675"></a>00675 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (ast-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l00676"></a>00676       <span class="comment">/* Don&apos;t try tos end audio on-hook */</span>
<a name="l00677"></a>00677       <span class="keywordflow">return</span> 0;
<a name="l00678"></a>00678    }
<a name="l00679"></a>00679 <span class="preprocessor">#endif   </span>
<a name="l00680"></a>00680 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>) {
<a name="l00681"></a>00681       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> != <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>) {
<a name="l00682"></a>00682          ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_STOP);
<a name="l00683"></a>00683          ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l00684"></a>00684          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_CODEC, G729)) {
<a name="l00685"></a>00685             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set G729 mode\n&quot;</span>);
<a name="l00686"></a>00686             <span class="keywordflow">return</span> -1;
<a name="l00687"></a>00687          }
<a name="l00688"></a>00688          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_CODEC, G729)) {
<a name="l00689"></a>00689             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set G729 mode\n&quot;</span>);
<a name="l00690"></a>00690             <span class="keywordflow">return</span> -1;
<a name="l00691"></a>00691          }
<a name="l00692"></a>00692          p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> = <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>;
<a name="l00693"></a>00693          p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> = <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>;
<a name="l00694"></a>00694          <span class="comment">/* Reset output buffer */</span>
<a name="l00695"></a>00695          p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a> = 0;
<a name="l00696"></a>00696          codecset = 1;
<a name="l00697"></a>00697       }
<a name="l00698"></a>00698       <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> &gt; 80) {
<a name="l00699"></a>00699          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Frame size too large for G.729 (%d bytes)\n&quot;</span>, frame-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l00700"></a>00700          <span class="keywordflow">return</span> -1;
<a name="l00701"></a>00701       }
<a name="l00702"></a>00702       maxfr = 80;
<a name="l00703"></a>00703         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a>) {
<a name="l00704"></a>00704       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> != <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a>) {
<a name="l00705"></a>00705          ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_STOP);
<a name="l00706"></a>00706          ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l00707"></a>00707          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_CODEC, G723_63)) {
<a name="l00708"></a>00708             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set G723.1 mode\n&quot;</span>);
<a name="l00709"></a>00709             <span class="keywordflow">return</span> -1;
<a name="l00710"></a>00710          }
<a name="l00711"></a>00711          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_CODEC, G723_63)) {
<a name="l00712"></a>00712             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set G723.1 mode\n&quot;</span>);
<a name="l00713"></a>00713             <span class="keywordflow">return</span> -1;
<a name="l00714"></a>00714          }
<a name="l00715"></a>00715          p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> = <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a>;
<a name="l00716"></a>00716          p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> = <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a>;
<a name="l00717"></a>00717          <span class="comment">/* Reset output buffer */</span>
<a name="l00718"></a>00718          p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a> = 0;
<a name="l00719"></a>00719          codecset = 1;
<a name="l00720"></a>00720       }
<a name="l00721"></a>00721       <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> &gt; 24) {
<a name="l00722"></a>00722          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Frame size too large for G.723.1 (%d bytes)\n&quot;</span>, frame-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l00723"></a>00723          <span class="keywordflow">return</span> -1;
<a name="l00724"></a>00724       }
<a name="l00725"></a>00725       maxfr = 24;
<a name="l00726"></a>00726    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>) {
<a name="l00727"></a>00727       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> != <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>) {
<a name="l00728"></a>00728          ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_STOP);
<a name="l00729"></a>00729          ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l00730"></a>00730          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_CODEC, LINEAR16)) {
<a name="l00731"></a>00731             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set 16-bit linear mode\n&quot;</span>);
<a name="l00732"></a>00732             <span class="keywordflow">return</span> -1;
<a name="l00733"></a>00733          }
<a name="l00734"></a>00734          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_CODEC, LINEAR16)) {
<a name="l00735"></a>00735             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set 16-bit linear mode\n&quot;</span>);
<a name="l00736"></a>00736             <span class="keywordflow">return</span> -1;
<a name="l00737"></a>00737          }
<a name="l00738"></a>00738          p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l00739"></a>00739          p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l00740"></a>00740          codecset = 1;
<a name="l00741"></a>00741          <span class="comment">/* Reset output buffer */</span>
<a name="l00742"></a>00742          p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a> = 0;
<a name="l00743"></a>00743       }
<a name="l00744"></a>00744       maxfr = 480;
<a name="l00745"></a>00745    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>) {
<a name="l00746"></a>00746       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> != <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>) {
<a name="l00747"></a>00747          ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_STOP);
<a name="l00748"></a>00748          ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l00749"></a>00749          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_CODEC, ULAW)) {
<a name="l00750"></a>00750             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set uLaw mode\n&quot;</span>);
<a name="l00751"></a>00751             <span class="keywordflow">return</span> -1;
<a name="l00752"></a>00752          }
<a name="l00753"></a>00753          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_CODEC, ULAW)) {
<a name="l00754"></a>00754             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set uLaw mode\n&quot;</span>);
<a name="l00755"></a>00755             <span class="keywordflow">return</span> -1;
<a name="l00756"></a>00756          }
<a name="l00757"></a>00757          p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> = <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>;
<a name="l00758"></a>00758          p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> = <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>;
<a name="l00759"></a>00759          codecset = 1;
<a name="l00760"></a>00760          <span class="comment">/* Reset output buffer */</span>
<a name="l00761"></a>00761          p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a> = 0;
<a name="l00762"></a>00762       }
<a name="l00763"></a>00763       maxfr = 240;
<a name="l00764"></a>00764    } <span class="keywordflow">else</span> {
<a name="l00765"></a>00765       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> != frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) {
<a name="l00766"></a>00766          ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_STOP);
<a name="l00767"></a>00767          ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l00768"></a>00768          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_CODEC, frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>)) {
<a name="l00769"></a>00769             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set %d mode\n&quot;</span>,
<a name="l00770"></a>00770                frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00771"></a>00771             <span class="keywordflow">return</span> -1;
<a name="l00772"></a>00772          }
<a name="l00773"></a>00773          <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_CODEC, frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>)) {
<a name="l00774"></a>00774             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set %d mode\n&quot;</span>,
<a name="l00775"></a>00775                frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00776"></a>00776             <span class="keywordflow">return</span> -1;
<a name="l00777"></a>00777          }
<a name="l00778"></a>00778          p-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> = frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l00779"></a>00779          p-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> = frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l00780"></a>00780          codecset = 1;
<a name="l00781"></a>00781          <span class="comment">/* Reset output buffer */</span>
<a name="l00782"></a>00782          p-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a> = 0;
<a name="l00783"></a>00783       }
<a name="l00784"></a>00784       maxfr = 480;
<a name="l00785"></a>00785    }
<a name="l00786"></a>00786    <span class="keywordflow">if</span> (codecset) {
<a name="l00787"></a>00787       ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_DEPTH, 3);
<a name="l00788"></a>00788       ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_DEPTH, 3);
<a name="l00789"></a>00789       <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_START)) {
<a name="l00790"></a>00790          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to start playback\n&quot;</span>);
<a name="l00791"></a>00791          <span class="keywordflow">return</span> -1;
<a name="l00792"></a>00792       }
<a name="l00793"></a>00793       <span class="keywordflow">if</span> (ioctl(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_START)) {
<a name="l00794"></a>00794          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to start recording\n&quot;</span>);
<a name="l00795"></a>00795          <span class="keywordflow">return</span> -1;
<a name="l00796"></a>00796       }
<a name="l00797"></a>00797    }
<a name="l00798"></a>00798    <span class="comment">/* If we get here, we have a frame of Appropriate data */</span>
<a name="l00799"></a>00799    sofar = 0;
<a name="l00800"></a>00800    pos = frame-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>;
<a name="l00801"></a>00801    <span class="keywordflow">while</span>(sofar &lt; frame-&gt;datalen) {
<a name="l00802"></a>00802       <span class="comment">/* Write in no more than maxfr sized frames */</span>
<a name="l00803"></a>00803       expected = frame-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> - sofar;
<a name="l00804"></a>00804       <span class="keywordflow">if</span> (maxfr &lt; expected)
<a name="l00805"></a>00805          expected = maxfr;
<a name="l00806"></a>00806       <span class="comment">/* XXX Internet Phone Jack does not handle the 4-byte VAD frame properly! XXX </span>
<a name="l00807"></a>00807 <span class="comment">         we have to pad it to 24 bytes still.  */</span>
<a name="l00808"></a>00808       <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> == 4) {
<a name="l00809"></a>00809          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a39dbabe71fc136ab40c57638a9c5bdc3">silencesupression</a>) {
<a name="l00810"></a>00810             memcpy(tmpbuf, frame-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, 4);
<a name="l00811"></a>00811             expected = 24;
<a name="l00812"></a>00812             res = <a class="code" href="chan__phone_8c.html#a8e9be4ef55dc935a5a791e66867038f5">phone_write_buf</a>(p, tmpbuf, expected, maxfr, 0);
<a name="l00813"></a>00813          }
<a name="l00814"></a>00814          res = 4;
<a name="l00815"></a>00815          expected=4;
<a name="l00816"></a>00816       } <span class="keywordflow">else</span> {
<a name="l00817"></a>00817          <span class="keywordtype">int</span> swap = 0;
<a name="l00818"></a>00818 <span class="preprocessor">#if __BYTE_ORDER == __BIG_ENDIAN</span>
<a name="l00819"></a>00819 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>)
<a name="l00820"></a>00820             swap = 1; <span class="comment">/* Swap big-endian samples to little-endian as we copy */</span>
<a name="l00821"></a>00821 <span class="preprocessor">#endif</span>
<a name="l00822"></a>00822 <span class="preprocessor"></span>         res = <a class="code" href="chan__phone_8c.html#a8e9be4ef55dc935a5a791e66867038f5">phone_write_buf</a>(p, pos, expected, maxfr, swap);
<a name="l00823"></a>00823       }
<a name="l00824"></a>00824       <span class="keywordflow">if</span> (res != expected) {
<a name="l00825"></a>00825          <span class="keywordflow">if</span> ((<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EAGAIN) &amp;&amp; (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EINTR)) {
<a name="l00826"></a>00826             <span class="keywordflow">if</span> (res &lt; 0) 
<a name="l00827"></a>00827                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Write returned error (%s)\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00828"></a>00828    <span class="comment">/*</span>
<a name="l00829"></a>00829 <span class="comment">    * Card is in non-blocking mode now and it works well now, but there are</span>
<a name="l00830"></a>00830 <span class="comment">    * lot of messages like this. So, this message is temporarily disabled.</span>
<a name="l00831"></a>00831 <span class="comment">    */</span>
<a name="l00832"></a>00832 <span class="preprocessor">#if 0</span>
<a name="l00833"></a>00833 <span class="preprocessor"></span>            <span class="keywordflow">else</span>
<a name="l00834"></a>00834                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Only wrote %d of %d bytes\n&quot;</span>, res, frame-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l00835"></a>00835 <span class="preprocessor">#endif</span>
<a name="l00836"></a>00836 <span class="preprocessor"></span>            <span class="keywordflow">return</span> -1;
<a name="l00837"></a>00837          } <span class="keywordflow">else</span> <span class="comment">/* Pretend it worked */</span>
<a name="l00838"></a>00838             res = expected;
<a name="l00839"></a>00839       }
<a name="l00840"></a>00840       sofar += res;
<a name="l00841"></a>00841       pos += res;
<a name="l00842"></a>00842    }
<a name="l00843"></a>00843    <span class="keywordflow">return</span> 0;
<a name="l00844"></a>00844 }
<a name="l00845"></a>00845 
<a name="l00846"></a><a class="code" href="chan__phone_8c.html#a16a0d0b8d729d26374dec9b51e2e6f16">00846</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__phone_8c.html#a16a0d0b8d729d26374dec9b51e2e6f16">phone_new</a>(<span class="keyword">struct</span> <a class="code" href="structphone__pvt.html">phone_pvt</a> *i, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>, <span class="keywordtype">char</span> *cntx)
<a name="l00847"></a>00847 {
<a name="l00848"></a>00848    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *tmp;
<a name="l00849"></a>00849    <span class="keyword">struct </span>phone_codec_data queried_codec;
<a name="l00850"></a>00850    tmp = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(1, state, i-&gt;<a class="code" href="structphone__pvt.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, i-&gt;<a class="code" href="structphone__pvt.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, <span class="stringliteral">&quot;&quot;</span>, i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>, i-&gt;<a class="code" href="structphone__pvt.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, 0, <span class="stringliteral">&quot;Phone/%s&quot;</span>, i-&gt;<a class="code" href="structphone__pvt.html#a57552521ec2b1ee61736dc07b6c9e551">dev</a> + 5);
<a name="l00851"></a>00851    <span class="keywordflow">if</span> (tmp) {
<a name="l00852"></a>00852       tmp-&gt;tech = cur_tech;
<a name="l00853"></a>00853       <a class="code" href="channel_8h.html#aca37ca2f3d55a223d26617329ed48a3e">ast_channel_set_fd</a>(tmp, 0, i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>);
<a name="l00854"></a>00854       <span class="comment">/* XXX Switching formats silently causes kernel panics XXX */</span>
<a name="l00855"></a>00855       <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> == <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a> &amp;&amp;
<a name="l00856"></a>00856           ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_QUERY_CODEC, &amp;queried_codec) == 0) {
<a name="l00857"></a>00857          <span class="keywordflow">if</span> (queried_codec.type == LINEAR16)
<a name="l00858"></a>00858             tmp-&gt;nativeformats =
<a name="l00859"></a>00859             tmp-&gt;rawreadformat =
<a name="l00860"></a>00860             tmp-&gt;rawwriteformat =
<a name="l00861"></a>00861             <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l00862"></a>00862          <span class="keywordflow">else</span> {
<a name="l00863"></a>00863             tmp-&gt;nativeformats =
<a name="l00864"></a>00864             tmp-&gt;rawreadformat =
<a name="l00865"></a>00865             tmp-&gt;rawwriteformat =
<a name="l00866"></a>00866             prefformat &amp; ~<a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l00867"></a>00867          }
<a name="l00868"></a>00868       }
<a name="l00869"></a>00869       <span class="keywordflow">else</span> {
<a name="l00870"></a>00870          tmp-&gt;nativeformats = prefformat;
<a name="l00871"></a>00871          tmp-&gt;rawreadformat = prefformat;
<a name="l00872"></a>00872          tmp-&gt;rawwriteformat = prefformat;
<a name="l00873"></a>00873       }
<a name="l00874"></a>00874       <span class="comment">/* no need to call ast_setstate: the channel_alloc already did its job */</span>
<a name="l00875"></a>00875       <span class="keywordflow">if</span> (state == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>)
<a name="l00876"></a>00876          tmp-&gt;rings = 1;
<a name="l00877"></a>00877       tmp-&gt;tech_pvt = i;
<a name="l00878"></a>00878       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;context, cntx, <span class="keyword">sizeof</span>(tmp-&gt;context));
<a name="l00879"></a>00879       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>))
<a name="l00880"></a>00880          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;exten, i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>, <span class="keyword">sizeof</span>(tmp-&gt;exten));
<a name="l00881"></a>00881       <span class="keywordflow">else</span>
<a name="l00882"></a>00882          strcpy(tmp-&gt;exten, <span class="stringliteral">&quot;s&quot;</span>);
<a name="l00883"></a>00883       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(i-&gt;<a class="code" href="structphone__pvt.html#adf416dc058363e2fd5750c77e2d78bee">language</a>))
<a name="l00884"></a>00884          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, language, i-&gt;<a class="code" href="structphone__pvt.html#adf416dc058363e2fd5750c77e2d78bee">language</a>);
<a name="l00885"></a>00885 
<a name="l00886"></a>00886       <span class="comment">/* Don&apos;t use ast_set_callerid() here because it will</span>
<a name="l00887"></a>00887 <span class="comment">       * generate a NewCallerID event before the NewChannel event */</span>
<a name="l00888"></a>00888       tmp-&gt;cid.cid_ani = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(i-&gt;<a class="code" href="structphone__pvt.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>);
<a name="l00889"></a>00889 
<a name="l00890"></a>00890       i-&gt;<a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = tmp;
<a name="l00891"></a>00891       <a class="code" href="module_8h.html#aa08fcee0b390e15532dd03803c8728c4">ast_module_ref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l00892"></a>00892       <span class="keywordflow">if</span> (state != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>) {
<a name="l00893"></a>00893          <span class="keywordflow">if</span> (state == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>) {
<a name="l00894"></a>00894             ioctl(tmp-&gt;fds[0], PHONE_RINGBACK);
<a name="l00895"></a>00895             i-&gt;<a class="code" href="structphone__pvt.html#aa8cf781c811971f235168779e567b632">cpt</a> = 1;
<a name="l00896"></a>00896          }
<a name="l00897"></a>00897          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(tmp)) {
<a name="l00898"></a>00898             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to start PBX on %s\n&quot;</span>, tmp-&gt;name);
<a name="l00899"></a>00899             <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tmp);
<a name="l00900"></a>00900          }
<a name="l00901"></a>00901       }
<a name="l00902"></a>00902    } <span class="keywordflow">else</span>
<a name="l00903"></a>00903       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate channel structure\n&quot;</span>);
<a name="l00904"></a>00904    <span class="keywordflow">return</span> tmp;
<a name="l00905"></a>00905 }
<a name="l00906"></a>00906 
<a name="l00907"></a><a class="code" href="chan__phone_8c.html#a68ea8b5ffb23c4ecdf08f83598f0bdff">00907</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__phone_8c.html#a68ea8b5ffb23c4ecdf08f83598f0bdff">phone_mini_packet</a>(<span class="keyword">struct</span> <a class="code" href="structphone__pvt.html">phone_pvt</a> *i)
<a name="l00908"></a>00908 {
<a name="l00909"></a>00909    <span class="keywordtype">int</span> res;
<a name="l00910"></a>00910    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[1024];
<a name="l00911"></a>00911    <span class="comment">/* Ignore stuff we read... */</span>
<a name="l00912"></a>00912    res = read(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, buf, <span class="keyword">sizeof</span>(buf));
<a name="l00913"></a>00913    <span class="keywordflow">if</span> (res &lt; 1) {
<a name="l00914"></a>00914       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Read returned %d: %s\n&quot;</span>, res, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00915"></a>00915       <span class="keywordflow">return</span>;
<a name="l00916"></a>00916    }
<a name="l00917"></a>00917 }
<a name="l00918"></a>00918 
<a name="l00919"></a><a class="code" href="chan__phone_8c.html#a01f82823f4f0c79bc08ee79d75385905">00919</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__phone_8c.html#a01f82823f4f0c79bc08ee79d75385905">phone_check_exception</a>(<span class="keyword">struct</span> <a class="code" href="structphone__pvt.html">phone_pvt</a> *i)
<a name="l00920"></a>00920 {
<a name="l00921"></a>00921    <span class="keywordtype">int</span> offhook=0;
<a name="l00922"></a>00922    <span class="keywordtype">char</span> digit[2] = {0 , 0};
<a name="l00923"></a>00923    <span class="keyword">union </span>telephony_exception phonee;
<a name="l00924"></a>00924    <span class="comment">/* XXX Do something XXX */</span>
<a name="l00925"></a>00925 <span class="preprocessor">#if 0</span>
<a name="l00926"></a>00926 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Exception!\n&quot;</span>);
<a name="l00927"></a>00927 <span class="preprocessor">#endif</span>
<a name="l00928"></a>00928 <span class="preprocessor"></span>   phonee.bytes = ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_EXCEPTION);
<a name="l00929"></a>00929    <span class="keywordflow">if</span> (phonee.bits.dtmf_ready)  {
<a name="l00930"></a>00930       digit[0] = ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_GET_DTMF_ASCII);
<a name="l00931"></a>00931       <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> == <a class="code" href="chan__phone_8c.html#a2d67ba815c41bccc3dd5f6f6219b0421">MODE_DIALTONE</a> || i-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> == <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a> || i-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> == <a class="code" href="chan__phone_8c.html#ae367b5b2a7a6a101de88045711b1548d">MODE_SIGMA</a>) {
<a name="l00932"></a>00932          ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_STOP);
<a name="l00933"></a>00933          ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l00934"></a>00934          ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_CPT_STOP);
<a name="l00935"></a>00935          i-&gt;<a class="code" href="structphone__pvt.html#ad683a45ac7cdd8373dbbfb54bcc8f84e">dialtone</a> = 0;
<a name="l00936"></a>00936          <span class="keywordflow">if</span> (strlen(i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>) &lt; <a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a> - 1)
<a name="l00937"></a>00937             strncat(i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>, digit, <span class="keyword">sizeof</span>(i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>) - strlen(i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>) - 1);
<a name="l00938"></a>00938          <span class="keywordflow">if</span> ((i-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> != <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a> ||
<a name="l00939"></a>00939               !(phonee.bytes = ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_EXCEPTION)) ||
<a name="l00940"></a>00940               !phonee.bits.dtmf_ready) &amp;&amp;
<a name="l00941"></a>00941              <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(NULL, i-&gt;<a class="code" href="structphone__pvt.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>, 1, i-&gt;<a class="code" href="structphone__pvt.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>)) {
<a name="l00942"></a>00942             <span class="comment">/* It&apos;s a valid extension in its context, get moving! */</span>
<a name="l00943"></a>00943             <a class="code" href="chan__phone_8c.html#a16a0d0b8d729d26374dec9b51e2e6f16">phone_new</a>(i, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>, i-&gt;<a class="code" href="structphone__pvt.html#a579ca8125bbf48d9ce8691d522f99933">context</a>);
<a name="l00944"></a>00944             <span class="comment">/* No need to restart monitor, we are the monitor */</span>
<a name="l00945"></a>00945          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a93f9868530c1e8a9d9d367d1ead8782e" title="Looks for a valid matching extension.">ast_canmatch_extension</a>(NULL, i-&gt;<a class="code" href="structphone__pvt.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>, 1, i-&gt;<a class="code" href="structphone__pvt.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>)) {
<a name="l00946"></a>00946             <span class="comment">/* There is nothing in the specified extension that can match anymore.</span>
<a name="l00947"></a>00947 <span class="comment">               Try the default */</span>
<a name="l00948"></a>00948             <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(NULL, <span class="stringliteral">&quot;default&quot;</span>, i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>, 1, i-&gt;<a class="code" href="structphone__pvt.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>)) {
<a name="l00949"></a>00949                <span class="comment">/* Check the default, too... */</span>
<a name="l00950"></a>00950                <a class="code" href="chan__phone_8c.html#a16a0d0b8d729d26374dec9b51e2e6f16">phone_new</a>(i, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>, <span class="stringliteral">&quot;default&quot;</span>);
<a name="l00951"></a>00951                <span class="comment">/* XXX This should probably be justified better XXX */</span>
<a name="l00952"></a>00952             }  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a93f9868530c1e8a9d9d367d1ead8782e" title="Looks for a valid matching extension.">ast_canmatch_extension</a>(NULL, <span class="stringliteral">&quot;default&quot;</span>, i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>, 1, i-&gt;<a class="code" href="structphone__pvt.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>)) {
<a name="l00953"></a>00953                <span class="comment">/* It&apos;s not a valid extension, give a busy signal */</span>
<a name="l00954"></a>00954                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s can&apos;t match anything in %s or default\n&quot;</span>, i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>, i-&gt;<a class="code" href="structphone__pvt.html#a579ca8125bbf48d9ce8691d522f99933">context</a>);
<a name="l00955"></a>00955                ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_BUSY);
<a name="l00956"></a>00956                i-&gt;<a class="code" href="structphone__pvt.html#aa8cf781c811971f235168779e567b632">cpt</a> = 1;
<a name="l00957"></a>00957             }
<a name="l00958"></a>00958          }
<a name="l00959"></a>00959 <span class="preprocessor">#if 0</span>
<a name="l00960"></a>00960 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Extension is %s\n&quot;</span>, i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>);
<a name="l00961"></a>00961 <span class="preprocessor">#endif</span>
<a name="l00962"></a>00962 <span class="preprocessor"></span>      }
<a name="l00963"></a>00963    }
<a name="l00964"></a>00964    <span class="keywordflow">if</span> (phonee.bits.hookstate) {
<a name="l00965"></a>00965       offhook = ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_HOOKSTATE);
<a name="l00966"></a>00966       <span class="keywordflow">if</span> (offhook) {
<a name="l00967"></a>00967          <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> == <a class="code" href="chan__phone_8c.html#acb566a1c37288668abf7c94e9e281bb0">MODE_IMMEDIATE</a>) {
<a name="l00968"></a>00968             <a class="code" href="chan__phone_8c.html#a16a0d0b8d729d26374dec9b51e2e6f16">phone_new</a>(i, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>, i-&gt;<a class="code" href="structphone__pvt.html#a579ca8125bbf48d9ce8691d522f99933">context</a>);
<a name="l00969"></a>00969          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> == <a class="code" href="chan__phone_8c.html#a2d67ba815c41bccc3dd5f6f6219b0421">MODE_DIALTONE</a>) {
<a name="l00970"></a>00970             <a class="code" href="module_8h.html#aa08fcee0b390e15532dd03803c8728c4">ast_module_ref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l00971"></a>00971             <span class="comment">/* Reset the extension */</span>
<a name="l00972"></a>00972             i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00973"></a>00973             <span class="comment">/* Play the dialtone */</span>
<a name="l00974"></a>00974             i-&gt;<a class="code" href="structphone__pvt.html#ad683a45ac7cdd8373dbbfb54bcc8f84e">dialtone</a>++;
<a name="l00975"></a>00975             ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_STOP);
<a name="l00976"></a>00976             ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_CODEC, ULAW);
<a name="l00977"></a>00977             ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_START);
<a name="l00978"></a>00978             i-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> = -1;
<a name="l00979"></a>00979          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> == <a class="code" href="chan__phone_8c.html#ae367b5b2a7a6a101de88045711b1548d">MODE_SIGMA</a>) {
<a name="l00980"></a>00980             <a class="code" href="module_8h.html#aa08fcee0b390e15532dd03803c8728c4">ast_module_ref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l00981"></a>00981             <span class="comment">/* Reset the extension */</span>
<a name="l00982"></a>00982             i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00983"></a>00983             <span class="comment">/* Play the dialtone */</span>
<a name="l00984"></a>00984             i-&gt;<a class="code" href="structphone__pvt.html#ad683a45ac7cdd8373dbbfb54bcc8f84e">dialtone</a>++;
<a name="l00985"></a>00985             ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_DIALTONE);
<a name="l00986"></a>00986          }
<a name="l00987"></a>00987       } <span class="keywordflow">else</span> {
<a name="l00988"></a>00988          <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structphone__pvt.html#ad683a45ac7cdd8373dbbfb54bcc8f84e">dialtone</a>)
<a name="l00989"></a>00989             <a class="code" href="module_8h.html#ac65fa15b16dbc563a2424af744ab003d">ast_module_unref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l00990"></a>00990          memset(i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>, 0, <span class="keyword">sizeof</span>(i-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>));
<a name="l00991"></a>00991          <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structphone__pvt.html#aa8cf781c811971f235168779e567b632">cpt</a>)
<a name="l00992"></a>00992          {
<a name="l00993"></a>00993             ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_CPT_STOP);
<a name="l00994"></a>00994             i-&gt;<a class="code" href="structphone__pvt.html#aa8cf781c811971f235168779e567b632">cpt</a> = 0;
<a name="l00995"></a>00995          }
<a name="l00996"></a>00996          ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_STOP);
<a name="l00997"></a>00997          ioctl(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l00998"></a>00998          i-&gt;<a class="code" href="structphone__pvt.html#ad683a45ac7cdd8373dbbfb54bcc8f84e">dialtone</a> = 0;
<a name="l00999"></a>00999          i-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> = -1;
<a name="l01000"></a>01000       }
<a name="l01001"></a>01001    }
<a name="l01002"></a>01002    <span class="keywordflow">if</span> (phonee.bits.pstn_ring) {
<a name="l01003"></a>01003       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Unit is ringing\n&quot;</span>);
<a name="l01004"></a>01004       <a class="code" href="chan__phone_8c.html#a16a0d0b8d729d26374dec9b51e2e6f16">phone_new</a>(i, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>, i-&gt;<a class="code" href="structphone__pvt.html#a579ca8125bbf48d9ce8691d522f99933">context</a>);
<a name="l01005"></a>01005    }
<a name="l01006"></a>01006    <span class="keywordflow">if</span> (phonee.bits.caller_id)
<a name="l01007"></a>01007       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;We have caller ID\n&quot;</span>);
<a name="l01008"></a>01008    
<a name="l01009"></a>01009    
<a name="l01010"></a>01010 }
<a name="l01011"></a>01011 
<a name="l01012"></a><a class="code" href="chan__phone_8c.html#a02d8db6086b4a18353b82ebcad631ff6">01012</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="chan__phone_8c.html#a02d8db6086b4a18353b82ebcad631ff6">do_monitor</a>(<span class="keywordtype">void</span> *data)
<a name="l01013"></a>01013 {
<a name="l01014"></a>01014    fd_set rfds, efds;
<a name="l01015"></a>01015    <span class="keywordtype">int</span> n, res;
<a name="l01016"></a>01016    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *i;
<a name="l01017"></a>01017    <span class="keywordtype">int</span> tonepos = 0;
<a name="l01018"></a>01018    <span class="comment">/* The tone we&apos;re playing this round */</span>
<a name="l01019"></a>01019    <span class="keyword">struct </span>timeval wait = {0,0};
<a name="l01020"></a>01020    <span class="keywordtype">int</span> dotone;
<a name="l01021"></a>01021    <span class="comment">/* This thread monitors all the frame relay interfaces which are not yet in use</span>
<a name="l01022"></a>01022 <span class="comment">      (and thus do not have a separate thread) indefinitely */</span>
<a name="l01023"></a>01023    <span class="keywordflow">while</span> (monitor) {
<a name="l01024"></a>01024       <span class="comment">/* Don&apos;t let anybody kill us right away.  Nobody should lock the interface list</span>
<a name="l01025"></a>01025 <span class="comment">         and wait for the monitor list, but the other way around is okay. */</span>
<a name="l01026"></a>01026       <span class="comment">/* Lock the interface list */</span>
<a name="l01027"></a>01027       <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iflock)) {
<a name="l01028"></a>01028          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to grab interface lock\n&quot;</span>);
<a name="l01029"></a>01029          <span class="keywordflow">return</span> NULL;
<a name="l01030"></a>01030       }
<a name="l01031"></a>01031       <span class="comment">/* Build the stuff we&apos;re going to select on, that is the socket of every</span>
<a name="l01032"></a>01032 <span class="comment">         phone_pvt that does not have an associated owner channel */</span>
<a name="l01033"></a>01033       n = -1;
<a name="l01034"></a>01034       FD_ZERO(&amp;rfds);
<a name="l01035"></a>01035       FD_ZERO(&amp;efds);
<a name="l01036"></a>01036       i = <a class="code" href="chan__dahdi_8c.html#a38bc838f6d206eef6a7a7ca87f5848e7">iflist</a>;
<a name="l01037"></a>01037       dotone = 0;
<a name="l01038"></a>01038       <span class="keywordflow">while</span> (i) {
<a name="l01039"></a>01039          <span class="keywordflow">if</span> (FD_ISSET(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, &amp;rfds)) 
<a name="l01040"></a>01040             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Descriptor %d appears twice (%s)?\n&quot;</span>, i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, i-&gt;<a class="code" href="structphone__pvt.html#a57552521ec2b1ee61736dc07b6c9e551">dev</a>);
<a name="l01041"></a>01041          <span class="keywordflow">if</span> (!i-&gt;<a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l01042"></a>01042             <span class="comment">/* This needs to be watched, as it lacks an owner */</span>
<a name="l01043"></a>01043             FD_SET(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, &amp;rfds);
<a name="l01044"></a>01044             FD_SET(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, &amp;efds);
<a name="l01045"></a>01045             <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a> &gt; n)
<a name="l01046"></a>01046                n = i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;
<a name="l01047"></a>01047             <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structphone__pvt.html#ad683a45ac7cdd8373dbbfb54bcc8f84e">dialtone</a> &amp;&amp; i-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> != <a class="code" href="chan__phone_8c.html#ae367b5b2a7a6a101de88045711b1548d">MODE_SIGMA</a>) {
<a name="l01048"></a>01048                <span class="comment">/* Remember we&apos;re going to have to come back and play</span>
<a name="l01049"></a>01049 <span class="comment">                  more dialtones */</span>
<a name="l01050"></a>01050                <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(wait)) {
<a name="l01051"></a>01051                   <span class="comment">/* If we&apos;re due for a dialtone, play one */</span>
<a name="l01052"></a>01052                   <span class="keywordflow">if</span> (write(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__phone_8h.html#affcf7d4058e8136a2854fb1c32a03f74">DialTone</a> + tonepos, 240) != 240)
<a name="l01053"></a>01053                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Dial tone write error\n&quot;</span>);
<a name="l01054"></a>01054                }
<a name="l01055"></a>01055                dotone++;
<a name="l01056"></a>01056             }
<a name="l01057"></a>01057          }
<a name="l01058"></a>01058          
<a name="l01059"></a>01059          i = i-&gt;<a class="code" href="structphone__pvt.html#af08f0f23f8bd67717c44fcf0e2089b93">next</a>;
<a name="l01060"></a>01060       }
<a name="l01061"></a>01061       <span class="comment">/* Okay, now that we know what to do, release the interface lock */</span>
<a name="l01062"></a>01062       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iflock);
<a name="l01063"></a>01063 
<a name="l01064"></a>01064       <span class="comment">/* Wait indefinitely for something to happen */</span>
<a name="l01065"></a>01065       <span class="keywordflow">if</span> (dotone &amp;&amp; i &amp;&amp; i-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> != <a class="code" href="chan__phone_8c.html#ae367b5b2a7a6a101de88045711b1548d">MODE_SIGMA</a>) {
<a name="l01066"></a>01066          <span class="comment">/* If we&apos;re ready to recycle the time, set it to 30 ms */</span>
<a name="l01067"></a>01067          tonepos += 240;
<a name="l01068"></a>01068          <span class="keywordflow">if</span> (tonepos &gt;= <span class="keyword">sizeof</span>(<a class="code" href="chan__phone_8h.html#affcf7d4058e8136a2854fb1c32a03f74">DialTone</a>))
<a name="l01069"></a>01069                tonepos = 0;
<a name="l01070"></a>01070          <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(wait)) {
<a name="l01071"></a>01071             wait = <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(30000, 0);
<a name="l01072"></a>01072          }
<a name="l01073"></a>01073          res = <a class="code" href="channel_8h.html#a056ed4f99440f01c251b2e8ca4501a56" title="Waits for activity on a group of channels.">ast_select</a>(n + 1, &amp;rfds, NULL, &amp;efds, &amp;wait);
<a name="l01074"></a>01074       } <span class="keywordflow">else</span> {
<a name="l01075"></a>01075          res = <a class="code" href="channel_8h.html#a056ed4f99440f01c251b2e8ca4501a56" title="Waits for activity on a group of channels.">ast_select</a>(n + 1, &amp;rfds, NULL, &amp;efds, NULL);
<a name="l01076"></a>01076          wait = <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0,0);
<a name="l01077"></a>01077          tonepos = 0;
<a name="l01078"></a>01078       }
<a name="l01079"></a>01079       <span class="comment">/* Okay, select has finished.  Let&apos;s see what happened.  */</span>
<a name="l01080"></a>01080       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01081"></a>01081          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;select return %d: %s\n&quot;</span>, res, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01082"></a>01082          <span class="keywordflow">continue</span>;
<a name="l01083"></a>01083       }
<a name="l01084"></a>01084       <span class="comment">/* If there are no fd&apos;s changed, just continue, it&apos;s probably time</span>
<a name="l01085"></a>01085 <span class="comment">         to play some more dialtones */</span>
<a name="l01086"></a>01086       <span class="keywordflow">if</span> (!res)
<a name="l01087"></a>01087          <span class="keywordflow">continue</span>;
<a name="l01088"></a>01088       <span class="comment">/* Alright, lock the interface list again, and let&apos;s look and see what has</span>
<a name="l01089"></a>01089 <span class="comment">         happened */</span>
<a name="l01090"></a>01090       <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iflock)) {
<a name="l01091"></a>01091          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to lock the interface list\n&quot;</span>);
<a name="l01092"></a>01092          <span class="keywordflow">continue</span>;
<a name="l01093"></a>01093       }
<a name="l01094"></a>01094 
<a name="l01095"></a>01095       i = <a class="code" href="chan__dahdi_8c.html#a38bc838f6d206eef6a7a7ca87f5848e7">iflist</a>;
<a name="l01096"></a>01096       <span class="keywordflow">for</span>(; i; i=i-&gt;<a class="code" href="structphone__pvt.html#af08f0f23f8bd67717c44fcf0e2089b93">next</a>) {
<a name="l01097"></a>01097          <span class="keywordflow">if</span> (FD_ISSET(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, &amp;rfds)) {
<a name="l01098"></a>01098             <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l01099"></a>01099                <span class="keywordflow">continue</span>;
<a name="l01100"></a>01100             }
<a name="l01101"></a>01101             <a class="code" href="chan__phone_8c.html#a68ea8b5ffb23c4ecdf08f83598f0bdff">phone_mini_packet</a>(i);
<a name="l01102"></a>01102          }
<a name="l01103"></a>01103          <span class="keywordflow">if</span> (FD_ISSET(i-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, &amp;efds)) {
<a name="l01104"></a>01104             <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l01105"></a>01105                <span class="keywordflow">continue</span>;
<a name="l01106"></a>01106             }
<a name="l01107"></a>01107             <a class="code" href="chan__phone_8c.html#a01f82823f4f0c79bc08ee79d75385905">phone_check_exception</a>(i);
<a name="l01108"></a>01108          }
<a name="l01109"></a>01109       }
<a name="l01110"></a>01110       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iflock);
<a name="l01111"></a>01111    }
<a name="l01112"></a>01112    <span class="keywordflow">return</span> NULL;
<a name="l01113"></a>01113    
<a name="l01114"></a>01114 }
<a name="l01115"></a>01115 
<a name="l01116"></a><a class="code" href="chan__phone_8c.html#a83af94bb19a421cb25ca02d16fa5ba9c">01116</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a83af94bb19a421cb25ca02d16fa5ba9c">restart_monitor</a>()
<a name="l01117"></a>01117 {
<a name="l01118"></a>01118    <span class="comment">/* If we&apos;re supposed to be stopped -- stay stopped */</span>
<a name="l01119"></a>01119    <span class="keywordflow">if</span> (monitor_thread == <a class="code" href="lock_8h.html#a873a83eb8196323194aac2bea23d794e">AST_PTHREADT_STOP</a>)
<a name="l01120"></a>01120       <span class="keywordflow">return</span> 0;
<a name="l01121"></a>01121    <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;monlock)) {
<a name="l01122"></a>01122       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to lock monitor\n&quot;</span>);
<a name="l01123"></a>01123       <span class="keywordflow">return</span> -1;
<a name="l01124"></a>01124    }
<a name="l01125"></a>01125    <span class="keywordflow">if</span> (monitor_thread == pthread_self()) {
<a name="l01126"></a>01126       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;monlock);
<a name="l01127"></a>01127       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot kill myself\n&quot;</span>);
<a name="l01128"></a>01128       <span class="keywordflow">return</span> -1;
<a name="l01129"></a>01129    }
<a name="l01130"></a>01130    <span class="keywordflow">if</span> (monitor_thread != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) {
<a name="l01131"></a>01131       <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iflock)) {
<a name="l01132"></a>01132          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;monlock);
<a name="l01133"></a>01133          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to lock the interface list\n&quot;</span>);
<a name="l01134"></a>01134          <span class="keywordflow">return</span> -1;
<a name="l01135"></a>01135       }
<a name="l01136"></a>01136       monitor = 0;
<a name="l01137"></a>01137       <span class="keywordflow">while</span> (pthread_kill(monitor_thread, SIGURG) == 0)
<a name="l01138"></a>01138          sched_yield();
<a name="l01139"></a>01139       pthread_join(monitor_thread, NULL);
<a name="l01140"></a>01140       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iflock);
<a name="l01141"></a>01141    }
<a name="l01142"></a>01142    monitor = 1;
<a name="l01143"></a>01143    <span class="comment">/* Start a new monitor */</span>
<a name="l01144"></a>01144    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;monitor_thread, NULL, <a class="code" href="chan__phone_8c.html#a02d8db6086b4a18353b82ebcad631ff6">do_monitor</a>, NULL) &lt; 0) {
<a name="l01145"></a>01145       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;monlock);
<a name="l01146"></a>01146       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to start monitor thread.\n&quot;</span>);
<a name="l01147"></a>01147       <span class="keywordflow">return</span> -1;
<a name="l01148"></a>01148    }
<a name="l01149"></a>01149    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;monlock);
<a name="l01150"></a>01150    <span class="keywordflow">return</span> 0;
<a name="l01151"></a>01151 }
<a name="l01152"></a>01152 
<a name="l01153"></a><a class="code" href="chan__phone_8c.html#a7d3982e30dbcd64c2a60d28fe264d389">01153</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *<a class="code" href="chan__phone_8c.html#a7d3982e30dbcd64c2a60d28fe264d389">mkif</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *iface, <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a>, <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#a709429a6031e18717677d5254d38586f">txgain</a>, <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#a80d0395aae5582433d6b02af3f8c270a">rxgain</a>)
<a name="l01154"></a>01154 {
<a name="l01155"></a>01155    <span class="comment">/* Make a phone_pvt structure for this interface */</span>
<a name="l01156"></a>01156    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *tmp;
<a name="l01157"></a>01157    <span class="keywordtype">int</span> flags;  
<a name="l01158"></a>01158    
<a name="l01159"></a>01159    tmp = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tmp));
<a name="l01160"></a>01160    <span class="keywordflow">if</span> (tmp) {
<a name="l01161"></a>01161       tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = open(iface, O_RDWR);
<a name="l01162"></a>01162       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a> &lt; 0) {
<a name="l01163"></a>01163          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open &apos;%s&apos;\n&quot;</span>, iface);
<a name="l01164"></a>01164          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l01165"></a>01165          <span class="keywordflow">return</span> NULL;
<a name="l01166"></a>01166       }
<a name="l01167"></a>01167       <span class="keywordflow">if</span> (mode == <a class="code" href="chan__phone_8c.html#a2c3c6a75812e99c888b368db385c0da4">MODE_FXO</a>) {
<a name="l01168"></a>01168          <span class="keywordflow">if</span> (ioctl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, IXJCTL_PORT, PORT_PSTN)) {
<a name="l01169"></a>01169             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Unable to set port to PSTN\n&quot;</span>);
<a name="l01170"></a>01170          }
<a name="l01171"></a>01171       } <span class="keywordflow">else</span> {
<a name="l01172"></a>01172          <span class="keywordflow">if</span> (ioctl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, IXJCTL_PORT, PORT_POTS)) 
<a name="l01173"></a>01173              <span class="keywordflow">if</span> (mode != <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a>)
<a name="l01174"></a>01174                   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Unable to set port to POTS\n&quot;</span>);
<a name="l01175"></a>01175       }
<a name="l01176"></a>01176       ioctl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_STOP);
<a name="l01177"></a>01177       ioctl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_STOP);
<a name="l01178"></a>01178       ioctl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_RING_STOP);
<a name="l01179"></a>01179       ioctl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_CPT_STOP);
<a name="l01180"></a>01180       <span class="keywordflow">if</span> (ioctl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PSTN_SET_STATE, PSTN_ON_HOOK))
<a name="l01181"></a>01181          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;ioctl(PHONE_PSTN_SET_STATE) failed on %s (%s)\n&quot;</span>,iface, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01182"></a>01182       <span class="keywordflow">if</span> (echocancel != AEC_OFF)
<a name="l01183"></a>01183          ioctl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, IXJCTL_AEC_START, echocancel);
<a name="l01184"></a>01184       <span class="keywordflow">if</span> (silencesupression) 
<a name="l01185"></a>01185          tmp-&gt;<a class="code" href="structphone__pvt.html#a39dbabe71fc136ab40c57638a9c5bdc3">silencesupression</a> = 1;
<a name="l01186"></a>01186 <span class="preprocessor">#ifdef PHONE_VAD</span>
<a name="l01187"></a>01187 <span class="preprocessor"></span>      ioctl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_VAD, tmp-&gt;<a class="code" href="structphone__pvt.html#a39dbabe71fc136ab40c57638a9c5bdc3">silencesupression</a>);
<a name="l01188"></a>01188 <span class="preprocessor">#endif</span>
<a name="l01189"></a>01189 <span class="preprocessor"></span>      tmp-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> = mode;
<a name="l01190"></a>01190       flags = fcntl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, F_GETFL);
<a name="l01191"></a>01191       fcntl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, F_SETFL, flags | O_NONBLOCK);
<a name="l01192"></a>01192       tmp-&gt;<a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = NULL;
<a name="l01193"></a>01193       tmp-&gt;<a class="code" href="structphone__pvt.html#a571d0f5603b91445e5f3d115f3967fe4">lastformat</a> = -1;
<a name="l01194"></a>01194       tmp-&gt;<a class="code" href="structphone__pvt.html#abbf82e72dad36ef1f927b194c40e8845">lastinput</a> = -1;
<a name="l01195"></a>01195       tmp-&gt;<a class="code" href="structphone__pvt.html#a67a142c7a94ad8de02e972ed71b524df">ministate</a> = 0;
<a name="l01196"></a>01196       memset(tmp-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>, 0, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structphone__pvt.html#a1ad093b5bae14543eb7fe9f409d9c83b">ext</a>));
<a name="l01197"></a>01197       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structphone__pvt.html#adf416dc058363e2fd5750c77e2d78bee">language</a>, language, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structphone__pvt.html#adf416dc058363e2fd5750c77e2d78bee">language</a>));
<a name="l01198"></a>01198       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structphone__pvt.html#a57552521ec2b1ee61736dc07b6c9e551">dev</a>, iface, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structphone__pvt.html#a57552521ec2b1ee61736dc07b6c9e551">dev</a>));
<a name="l01199"></a>01199       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structphone__pvt.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, context, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structphone__pvt.html#a579ca8125bbf48d9ce8691d522f99933">context</a>));
<a name="l01200"></a>01200       tmp-&gt;<a class="code" href="structphone__pvt.html#af08f0f23f8bd67717c44fcf0e2089b93">next</a> = NULL;
<a name="l01201"></a>01201       tmp-&gt;<a class="code" href="structphone__pvt.html#a3ace32e19f38d9d6e61f7730e05b578c">obuflen</a> = 0;
<a name="l01202"></a>01202       tmp-&gt;<a class="code" href="structphone__pvt.html#ad683a45ac7cdd8373dbbfb54bcc8f84e">dialtone</a> = 0;
<a name="l01203"></a>01203       tmp-&gt;<a class="code" href="structphone__pvt.html#aa8cf781c811971f235168779e567b632">cpt</a> = 0;
<a name="l01204"></a>01204       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structphone__pvt.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, cid_num, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structphone__pvt.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>));
<a name="l01205"></a>01205       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structphone__pvt.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, cid_name, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structphone__pvt.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>));
<a name="l01206"></a>01206       tmp-&gt;<a class="code" href="structphone__pvt.html#a709429a6031e18717677d5254d38586f">txgain</a> = txgain;
<a name="l01207"></a>01207       ioctl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_PLAY_VOLUME, tmp-&gt;<a class="code" href="structphone__pvt.html#a709429a6031e18717677d5254d38586f">txgain</a>);
<a name="l01208"></a>01208       tmp-&gt;<a class="code" href="structphone__pvt.html#a80d0395aae5582433d6b02af3f8c270a">rxgain</a> = rxgain;
<a name="l01209"></a>01209       ioctl(tmp-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, PHONE_REC_VOLUME, tmp-&gt;<a class="code" href="structphone__pvt.html#a80d0395aae5582433d6b02af3f8c270a">rxgain</a>);
<a name="l01210"></a>01210    }
<a name="l01211"></a>01211    <span class="keywordflow">return</span> tmp;
<a name="l01212"></a>01212 }
<a name="l01213"></a>01213 
<a name="l01214"></a><a class="code" href="chan__phone_8c.html#aa0757010d14c805c4fae22146bbf8c8c">01214</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__phone_8c.html#aa0757010d14c805c4fae22146bbf8c8c">phone_request</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="keywordtype">int</span> *<a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>)
<a name="l01215"></a>01215 {
<a name="l01216"></a>01216    <span class="keywordtype">int</span> oldformat;
<a name="l01217"></a>01217    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *p;
<a name="l01218"></a>01218    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *tmp = NULL;
<a name="l01219"></a>01219    <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a> = data;
<a name="l01220"></a>01220 
<a name="l01221"></a>01221    <span class="comment">/* Search for an unowned channel */</span>
<a name="l01222"></a>01222    <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iflock)) {
<a name="l01223"></a>01223       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to lock interface list???\n&quot;</span>);
<a name="l01224"></a>01224       <span class="keywordflow">return</span> NULL;
<a name="l01225"></a>01225    }
<a name="l01226"></a>01226    p = <a class="code" href="chan__dahdi_8c.html#a38bc838f6d206eef6a7a7ca87f5848e7">iflist</a>;
<a name="l01227"></a>01227    <span class="keywordflow">while</span>(p) {
<a name="l01228"></a>01228       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> == <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a> ||
<a name="l01229"></a>01229           format &amp; (<a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a> | <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a> | <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a> | <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>)) {
<a name="l01230"></a>01230           <span class="keywordtype">size_t</span> length = strlen(p-&gt;<a class="code" href="structphone__pvt.html#a57552521ec2b1ee61736dc07b6c9e551">dev</a> + 5);
<a name="l01231"></a>01231          <span class="keywordflow">if</span> (strncmp(name, p-&gt;<a class="code" href="structphone__pvt.html#a57552521ec2b1ee61736dc07b6c9e551">dev</a> + 5, length) == 0 &amp;&amp;
<a name="l01232"></a>01232              !isalnum(name[length])) {
<a name="l01233"></a>01233              <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l01234"></a>01234                      tmp = <a class="code" href="chan__phone_8c.html#a16a0d0b8d729d26374dec9b51e2e6f16">phone_new</a>(p, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, p-&gt;<a class="code" href="structphone__pvt.html#a579ca8125bbf48d9ce8691d522f99933">context</a>);
<a name="l01235"></a>01235                      <span class="keywordflow">break</span>;
<a name="l01236"></a>01236                 } <span class="keywordflow">else</span>
<a name="l01237"></a>01237                      *cause = <a class="code" href="causes_8h.html#ae009c193522491f7de7ea28b23f20868">AST_CAUSE_BUSY</a>;
<a name="l01238"></a>01238             }
<a name="l01239"></a>01239       }
<a name="l01240"></a>01240       p = p-&gt;<a class="code" href="structphone__pvt.html#af08f0f23f8bd67717c44fcf0e2089b93">next</a>;
<a name="l01241"></a>01241    }
<a name="l01242"></a>01242    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iflock);
<a name="l01243"></a>01243    <a class="code" href="chan__phone_8c.html#a83af94bb19a421cb25ca02d16fa5ba9c">restart_monitor</a>();
<a name="l01244"></a>01244    <span class="keywordflow">if</span> (tmp == NULL) {
<a name="l01245"></a>01245       oldformat = format;
<a name="l01246"></a>01246       format &amp;= (<a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a> | <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a> | <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a> | <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>);
<a name="l01247"></a>01247       <span class="keywordflow">if</span> (!format) {
<a name="l01248"></a>01248          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Asked to get a channel of unsupported format &apos;%d&apos;\n&quot;</span>, oldformat);
<a name="l01249"></a>01249          <span class="keywordflow">return</span> NULL;
<a name="l01250"></a>01250       }
<a name="l01251"></a>01251    }
<a name="l01252"></a>01252    <span class="keywordflow">return</span> tmp;
<a name="l01253"></a>01253 }
<a name="l01254"></a>01254 
<a name="l01255"></a>01255 <span class="comment">/* parse gain value from config file */</span>
<a name="l01256"></a><a class="code" href="chan__phone_8c.html#aadd579145c3e1c8659cff2fc5e00976c">01256</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#aadd579145c3e1c8659cff2fc5e00976c">parse_gain_value</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *gain_type, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l01257"></a>01257 {
<a name="l01258"></a>01258    <span class="keywordtype">float</span> gain;
<a name="l01259"></a>01259 
<a name="l01260"></a>01260    <span class="comment">/* try to scan number */</span>
<a name="l01261"></a>01261    <span class="keywordflow">if</span> (sscanf(value, <span class="stringliteral">&quot;%30f&quot;</span>, &amp;gain) != 1)
<a name="l01262"></a>01262    {
<a name="l01263"></a>01263       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid %s value &apos;%s&apos; in &apos;%s&apos; config\n&quot;</span>,
<a name="l01264"></a>01264          value, gain_type, config);
<a name="l01265"></a>01265       <span class="keywordflow">return</span> <a class="code" href="chan__phone_8c.html#ae242ab0e0a91e95de561944085dbdf20">DEFAULT_GAIN</a>;
<a name="l01266"></a>01266    }
<a name="l01267"></a>01267 
<a name="l01268"></a>01268    <span class="comment">/* multiplicate gain by 1.0 gain value */</span> 
<a name="l01269"></a>01269    gain = gain * (float)<a class="code" href="chan__phone_8c.html#ae242ab0e0a91e95de561944085dbdf20">DEFAULT_GAIN</a>;
<a name="l01270"></a>01270 
<a name="l01271"></a>01271    <span class="comment">/* percentage? */</span>
<a name="l01272"></a>01272    <span class="keywordflow">if</span> (value[strlen(value) - 1] == <span class="charliteral">&apos;%&apos;</span>)
<a name="l01273"></a>01273       <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)(gain / (float)100);
<a name="l01274"></a>01274 
<a name="l01275"></a>01275    <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)gain;
<a name="l01276"></a>01276 }
<a name="l01277"></a>01277 
<a name="l01278"></a><a class="code" href="chan__phone_8c.html#a2fd806029fe936c297e52d2236092fc0">01278</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a2fd806029fe936c297e52d2236092fc0">__unload_module</a>(<span class="keywordtype">void</span>)
<a name="l01279"></a>01279 {
<a name="l01280"></a>01280    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *p, *pl;
<a name="l01281"></a>01281    <span class="comment">/* First, take us out of the channel loop */</span>
<a name="l01282"></a>01282    <span class="keywordflow">if</span> (cur_tech)
<a name="l01283"></a>01283       <a class="code" href="channel_8h.html#a53b708b7fc71dcbcd33acae0ad4d7ef8" title="Unregister a channel technology.">ast_channel_unregister</a>(cur_tech);
<a name="l01284"></a>01284    <span class="keywordflow">if</span> (!<a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iflock)) {
<a name="l01285"></a>01285       <span class="comment">/* Hangup all interfaces if they have an owner */</span>
<a name="l01286"></a>01286       p = <a class="code" href="chan__dahdi_8c.html#a38bc838f6d206eef6a7a7ca87f5848e7">iflist</a>;
<a name="l01287"></a>01287       <span class="keywordflow">while</span>(p) {
<a name="l01288"></a>01288          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)
<a name="l01289"></a>01289             <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(p-&gt;<a class="code" href="structphone__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709aeeafae6abd77156800ec76b0ff7d3867">AST_SOFTHANGUP_APPUNLOAD</a>);
<a name="l01290"></a>01290          p = p-&gt;<a class="code" href="structphone__pvt.html#af08f0f23f8bd67717c44fcf0e2089b93">next</a>;
<a name="l01291"></a>01291       }
<a name="l01292"></a>01292       <a class="code" href="chan__dahdi_8c.html#a38bc838f6d206eef6a7a7ca87f5848e7">iflist</a> = NULL;
<a name="l01293"></a>01293       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iflock);
<a name="l01294"></a>01294    } <span class="keywordflow">else</span> {
<a name="l01295"></a>01295       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to lock the monitor\n&quot;</span>);
<a name="l01296"></a>01296       <span class="keywordflow">return</span> -1;
<a name="l01297"></a>01297    }
<a name="l01298"></a>01298    <span class="keywordflow">if</span> (!<a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;monlock)) {
<a name="l01299"></a>01299       <span class="keywordflow">if</span> (monitor_thread &gt; <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) {
<a name="l01300"></a>01300          monitor = 0;
<a name="l01301"></a>01301          <span class="keywordflow">while</span> (pthread_kill(monitor_thread, SIGURG) == 0)
<a name="l01302"></a>01302             sched_yield();
<a name="l01303"></a>01303          pthread_join(monitor_thread, NULL);
<a name="l01304"></a>01304       }
<a name="l01305"></a>01305       monitor_thread = <a class="code" href="lock_8h.html#a873a83eb8196323194aac2bea23d794e">AST_PTHREADT_STOP</a>;
<a name="l01306"></a>01306       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;monlock);
<a name="l01307"></a>01307    } <span class="keywordflow">else</span> {
<a name="l01308"></a>01308       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to lock the monitor\n&quot;</span>);
<a name="l01309"></a>01309       <span class="keywordflow">return</span> -1;
<a name="l01310"></a>01310    }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312    <span class="keywordflow">if</span> (!<a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iflock)) {
<a name="l01313"></a>01313       <span class="comment">/* Destroy all the interfaces and free their memory */</span>
<a name="l01314"></a>01314       p = <a class="code" href="chan__dahdi_8c.html#a38bc838f6d206eef6a7a7ca87f5848e7">iflist</a>;
<a name="l01315"></a>01315       <span class="keywordflow">while</span>(p) {
<a name="l01316"></a>01316          <span class="comment">/* Close the socket, assuming it&apos;s real */</span>
<a name="l01317"></a>01317          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a> &gt; -1)
<a name="l01318"></a>01318             close(p-&gt;<a class="code" href="structphone__pvt.html#a6f8059414f0228f0256115e024eeed4b">fd</a>);
<a name="l01319"></a>01319          pl = p;
<a name="l01320"></a>01320          p = p-&gt;<a class="code" href="structphone__pvt.html#af08f0f23f8bd67717c44fcf0e2089b93">next</a>;
<a name="l01321"></a>01321          <span class="comment">/* Free associated memory */</span>
<a name="l01322"></a>01322          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(pl);
<a name="l01323"></a>01323       }
<a name="l01324"></a>01324       <a class="code" href="chan__dahdi_8c.html#a38bc838f6d206eef6a7a7ca87f5848e7">iflist</a> = NULL;
<a name="l01325"></a>01325       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iflock);
<a name="l01326"></a>01326    } <span class="keywordflow">else</span> {
<a name="l01327"></a>01327       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to lock the monitor\n&quot;</span>);
<a name="l01328"></a>01328       <span class="keywordflow">return</span> -1;
<a name="l01329"></a>01329    }
<a name="l01330"></a>01330       
<a name="l01331"></a>01331    <span class="keywordflow">return</span> 0;
<a name="l01332"></a>01332 }
<a name="l01333"></a>01333 
<a name="l01334"></a><a class="code" href="chan__phone_8c.html#ad09fa931f468002152a3cc2d5ce25eae">01334</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l01335"></a>01335 {
<a name="l01336"></a>01336    <span class="keywordflow">return</span> <a class="code" href="chan__phone_8c.html#a2fd806029fe936c297e52d2236092fc0">__unload_module</a>();
<a name="l01337"></a>01337 }
<a name="l01338"></a>01338 
<a name="l01339"></a><a class="code" href="chan__phone_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">01339</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l01340"></a>01340 {
<a name="l01341"></a>01341    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l01342"></a>01342    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l01343"></a>01343    <span class="keyword">struct </span><a class="code" href="structphone__pvt.html">phone_pvt</a> *tmp;
<a name="l01344"></a>01344    <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#a1ea5d0cb93f22f7d0fdf804bd68c3326">mode</a> = <a class="code" href="chan__phone_8c.html#acb566a1c37288668abf7c94e9e281bb0">MODE_IMMEDIATE</a>;
<a name="l01345"></a>01345    <span class="keywordtype">int</span> <a class="code" href="structphone__pvt.html#a709429a6031e18717677d5254d38586f">txgain</a> = <a class="code" href="chan__phone_8c.html#ae242ab0e0a91e95de561944085dbdf20">DEFAULT_GAIN</a>, <a class="code" href="structphone__pvt.html#a80d0395aae5582433d6b02af3f8c270a">rxgain</a> = <a class="code" href="chan__phone_8c.html#ae242ab0e0a91e95de561944085dbdf20">DEFAULT_GAIN</a>; <span class="comment">/* default gain 1.0 */</span>
<a name="l01346"></a>01346    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { 0 };
<a name="l01347"></a>01347 
<a name="l01348"></a>01348    <span class="keywordflow">if</span> ((cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(config, config_flags)) == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l01349"></a>01349       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file %s is in an invalid format.  Aborting.\n&quot;</span>, config);
<a name="l01350"></a>01350       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01351"></a>01351    }
<a name="l01352"></a>01352 
<a name="l01353"></a>01353    <span class="comment">/* We *must* have a config file otherwise stop immediately */</span>
<a name="l01354"></a>01354    <span class="keywordflow">if</span> (!cfg) {
<a name="l01355"></a>01355       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to load config %s\n&quot;</span>, config);
<a name="l01356"></a>01356       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01357"></a>01357    }
<a name="l01358"></a>01358    <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iflock)) {
<a name="l01359"></a>01359       <span class="comment">/* It&apos;s a little silly to lock it, but we mind as well just to be sure */</span>
<a name="l01360"></a>01360       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to lock interface list???\n&quot;</span>);
<a name="l01361"></a>01361       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l01362"></a>01362    }
<a name="l01363"></a>01363    v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;interfaces&quot;</span>);
<a name="l01364"></a>01364    <span class="keywordflow">while</span>(v) {
<a name="l01365"></a>01365       <span class="comment">/* Create the interface list */</span>
<a name="l01366"></a>01366       <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;device&quot;</span>)) {
<a name="l01367"></a>01367             tmp = <a class="code" href="chan__phone_8c.html#a7d3982e30dbcd64c2a60d28fe264d389">mkif</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, mode, txgain, rxgain);
<a name="l01368"></a>01368             <span class="keywordflow">if</span> (tmp) {
<a name="l01369"></a>01369                tmp-&gt;<a class="code" href="structphone__pvt.html#af08f0f23f8bd67717c44fcf0e2089b93">next</a> = <a class="code" href="chan__dahdi_8c.html#a38bc838f6d206eef6a7a7ca87f5848e7">iflist</a>;
<a name="l01370"></a>01370                <a class="code" href="chan__dahdi_8c.html#a38bc838f6d206eef6a7a7ca87f5848e7">iflist</a> = tmp;
<a name="l01371"></a>01371                
<a name="l01372"></a>01372             } <span class="keywordflow">else</span> {
<a name="l01373"></a>01373                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to register channel &apos;%s&apos;\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01374"></a>01374                <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01375"></a>01375                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iflock);
<a name="l01376"></a>01376                <a class="code" href="chan__phone_8c.html#a2fd806029fe936c297e52d2236092fc0">__unload_module</a>();
<a name="l01377"></a>01377                <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l01378"></a>01378             }
<a name="l01379"></a>01379       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;silencesupression&quot;</span>)) {
<a name="l01380"></a>01380          silencesupression = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01381"></a>01381       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;language&quot;</span>)) {
<a name="l01382"></a>01382          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(language, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(language));
<a name="l01383"></a>01383       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;callerid&quot;</span>)) {
<a name="l01384"></a>01384          <a class="code" href="callerid_8h.html#af33ee38631fe79ab21d91bcd0634903a">ast_callerid_split</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, cid_name, <span class="keyword">sizeof</span>(cid_name), cid_num, <span class="keyword">sizeof</span>(cid_num));
<a name="l01385"></a>01385       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mode&quot;</span>)) {
<a name="l01386"></a>01386          <span class="keywordflow">if</span> (!strncasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;di&quot;</span>, 2)) 
<a name="l01387"></a>01387             mode = <a class="code" href="chan__phone_8c.html#a2d67ba815c41bccc3dd5f6f6219b0421">MODE_DIALTONE</a>;
<a name="l01388"></a>01388          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;sig&quot;</span>, 3))
<a name="l01389"></a>01389             mode = <a class="code" href="chan__phone_8c.html#ae367b5b2a7a6a101de88045711b1548d">MODE_SIGMA</a>;
<a name="l01390"></a>01390          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;im&quot;</span>, 2))
<a name="l01391"></a>01391             mode = <a class="code" href="chan__phone_8c.html#acb566a1c37288668abf7c94e9e281bb0">MODE_IMMEDIATE</a>;
<a name="l01392"></a>01392          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;fxs&quot;</span>, 3)) {
<a name="l01393"></a>01393             mode = <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a>;
<a name="l01394"></a>01394             prefformat = 0x01ff0000; <span class="comment">/* All non-voice */</span>
<a name="l01395"></a>01395          }
<a name="l01396"></a>01396          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;fx&quot;</span>, 2))
<a name="l01397"></a>01397             mode = <a class="code" href="chan__phone_8c.html#a2c3c6a75812e99c888b368db385c0da4">MODE_FXO</a>;
<a name="l01398"></a>01398          <span class="keywordflow">else</span>
<a name="l01399"></a>01399             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown mode: %s\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01400"></a>01400       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;context&quot;</span>)) {
<a name="l01401"></a>01401          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(context, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(context));
<a name="l01402"></a>01402       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;format&quot;</span>)) {
<a name="l01403"></a>01403          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;g729&quot;</span>)) {
<a name="l01404"></a>01404             prefformat = <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>;
<a name="l01405"></a>01405                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;g723.1&quot;</span>)) {
<a name="l01406"></a>01406             prefformat = <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a>;
<a name="l01407"></a>01407          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;slinear&quot;</span>)) {
<a name="l01408"></a>01408             <span class="keywordflow">if</span> (mode == <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a>)
<a name="l01409"></a>01409                 prefformat |= <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l01410"></a>01410             <span class="keywordflow">else</span> prefformat = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l01411"></a>01411          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;ulaw&quot;</span>)) {
<a name="l01412"></a>01412             prefformat = <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>;
<a name="l01413"></a>01413          } <span class="keywordflow">else</span>
<a name="l01414"></a>01414             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown format &apos;%s&apos;\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01415"></a>01415       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;echocancel&quot;</span>)) {
<a name="l01416"></a>01416          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;off&quot;</span>)) {
<a name="l01417"></a>01417             echocancel = AEC_OFF;
<a name="l01418"></a>01418          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;low&quot;</span>)) {
<a name="l01419"></a>01419             echocancel = AEC_LOW;
<a name="l01420"></a>01420          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;medium&quot;</span>)) {
<a name="l01421"></a>01421             echocancel = AEC_MED;
<a name="l01422"></a>01422          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;high&quot;</span>)) {
<a name="l01423"></a>01423             echocancel = AEC_HIGH;
<a name="l01424"></a>01424          } <span class="keywordflow">else</span> 
<a name="l01425"></a>01425             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown echo cancellation &apos;%s&apos;\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01426"></a>01426       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;txgain&quot;</span>)) {
<a name="l01427"></a>01427          txgain = <a class="code" href="chan__phone_8c.html#aadd579145c3e1c8659cff2fc5e00976c">parse_gain_value</a>(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01428"></a>01428       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;rxgain&quot;</span>)) {
<a name="l01429"></a>01429          rxgain = <a class="code" href="chan__phone_8c.html#aadd579145c3e1c8659cff2fc5e00976c">parse_gain_value</a>(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01430"></a>01430       }  
<a name="l01431"></a>01431       v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l01432"></a>01432    }
<a name="l01433"></a>01433    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iflock);
<a name="l01434"></a>01434 
<a name="l01435"></a>01435    <span class="keywordflow">if</span> (mode == <a class="code" href="chan__phone_8c.html#a64e0b6d445f7b701a00b2767f49030d1">MODE_FXS</a>) {
<a name="l01436"></a>01436       phone_tech_fxs.<a class="code" href="structast__channel__tech.html#a9461ee266923070466f95a76158f65cd">capabilities</a> = prefformat;
<a name="l01437"></a>01437       cur_tech = &amp;phone_tech_fxs;
<a name="l01438"></a>01438    } <span class="keywordflow">else</span>
<a name="l01439"></a>01439       cur_tech = (<span class="keyword">struct </span><a class="code" href="structast__channel__tech.html" title="Structure to describe a channel &amp;quot;technology&amp;quot;, ie a channel driver See for...">ast_channel_tech</a> *) &amp;phone_tech;
<a name="l01440"></a>01440 
<a name="l01441"></a>01441    <span class="comment">/* Make sure we can register our Adtranphone channel type */</span>
<a name="l01442"></a>01442 
<a name="l01443"></a>01443    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#ab5f3776fda943e52820ceeee5835c1b4" title="Register a channel technology (a new channel driver) Called by a channel module to...">ast_channel_register</a>(cur_tech)) {
<a name="l01444"></a>01444       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to register channel class &apos;Phone&apos;\n&quot;</span>);
<a name="l01445"></a>01445       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01446"></a>01446       <a class="code" href="chan__phone_8c.html#a2fd806029fe936c297e52d2236092fc0">__unload_module</a>();
<a name="l01447"></a>01447       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l01448"></a>01448    }
<a name="l01449"></a>01449    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01450"></a>01450    <span class="comment">/* And start the monitor for the first time */</span>
<a name="l01451"></a>01451    <a class="code" href="chan__phone_8c.html#a83af94bb19a421cb25ca02d16fa5ba9c">restart_monitor</a>();
<a name="l01452"></a>01452    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l01453"></a>01453 }
<a name="l01454"></a>01454 
<a name="l01455"></a>01455 <a class="code" href="module_8h.html#a70ea6b2dde349dfaae4d21d93b9a5683">AST_MODULE_INFO_STANDARD</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <span class="stringliteral">&quot;Linux Telephony API Support&quot;</span>);
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:34 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
