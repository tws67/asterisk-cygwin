<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:45 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_318a70d4e812a718d9ecaeea98fff199.html">res</a>
  </div>
</div>
<div class="contents">
<h1>res_agi.c</h1><a href="res__agi_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief AGI - the Asterisk Gateway Interface</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * \todo Convert the rest of the AGI commands over to XML documentation</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 246199 $&quot;</span>)
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="paths_8h.html" title="Asterisk file paths, configured in asterisk.conf.">asterisk/paths.h</a>&quot;</span>   <span class="comment">/* use many ast_config_AST_*_DIR */</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="network_8h.html" title="Wrapper for network related headers, masking differences between various operating...">asterisk/network.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="astdb_8h.html" title="Persistant data storage (akin to *doze registry).">asterisk/astdb.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="callerid_8h.html" title="CallerID (and other GR30) management and generation Includes code and algorithms...">asterisk/callerid.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="image_8h.html" title="General Asterisk channel definitions for image handling.">asterisk/image.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="say_8h.html" title="Say numbers and dates (maybe words one day too).">asterisk/say.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="dsp_8h.html" title="Convenient Signal Processing routines.">asterisk/dsp.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="musiconhold_8h.html" title="Music on hold handling.">asterisk/musiconhold.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="strings_8h.html" title="String manipulation functions.">asterisk/strings.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="ast__version_8h.html" title="Asterisk version information.">asterisk/ast_version.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="speech_8h.html" title="Generic Speech Recognition API.">asterisk/speech.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="features_8h.html" title="Call Parking and Pickup API Includes code and algorithms from the Zapata library...">asterisk/features.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="term_8h.html" title="Handy terminal functions for vt* terms.">asterisk/term.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="xmldoc_8h.html" title="Asterisk XML Documentation API.">asterisk/xmldoc.h</a>&quot;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a><a class="code" href="res__agi_8c.html#a805616595a796949ade4a78edc628f99">00064</a> <span class="preprocessor">#define AST_API_MODULE</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="agi_8h.html" title="AGI Extension interfaces - Asterisk Gateway Interface.">asterisk/agi.h</a>&quot;</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="comment">/*** DOCUMENTATION</span>
<a name="l00068"></a>00068 <span class="comment">   &lt;agi name=&quot;answer&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00069"></a>00069 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00070"></a>00070 <span class="comment">         Answer channel</span>
<a name="l00071"></a>00071 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00072"></a>00072 <span class="comment">      &lt;syntax /&gt;</span>
<a name="l00073"></a>00073 <span class="comment">      &lt;description&gt;</span>
<a name="l00074"></a>00074 <span class="comment">         &lt;para&gt;Answers channel if not already in answer state. Returns &lt;literal&gt;-1&lt;/literal&gt; on</span>
<a name="l00075"></a>00075 <span class="comment">         channel failure, or &lt;literal&gt;0&lt;/literal&gt; if successful.&lt;/para&gt;</span>
<a name="l00076"></a>00076 <span class="comment">      &lt;/description&gt;</span>
<a name="l00077"></a>00077 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00078"></a>00078 <span class="comment">         &lt;ref type=&quot;agi&quot;&gt;hangup&lt;/ref&gt;</span>
<a name="l00079"></a>00079 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00080"></a>00080 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00081"></a>00081 <span class="comment">   &lt;agi name=&quot;asyncagi break&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00082"></a>00082 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00083"></a>00083 <span class="comment">         Interrupts Async AGI</span>
<a name="l00084"></a>00084 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00085"></a>00085 <span class="comment">      &lt;syntax /&gt;</span>
<a name="l00086"></a>00086 <span class="comment">      &lt;description&gt;</span>
<a name="l00087"></a>00087 <span class="comment">         &lt;para&gt;Interrupts expected flow of Async AGI commands and returns control to previous source</span>
<a name="l00088"></a>00088 <span class="comment">         (typically, the PBX dialplan).&lt;/para&gt;</span>
<a name="l00089"></a>00089 <span class="comment">      &lt;/description&gt;</span>
<a name="l00090"></a>00090 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00091"></a>00091 <span class="comment">         &lt;ref type=&quot;agi&quot;&gt;hangup&lt;/ref&gt;</span>
<a name="l00092"></a>00092 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00093"></a>00093 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00094"></a>00094 <span class="comment">   &lt;agi name=&quot;channel status&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00095"></a>00095 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00096"></a>00096 <span class="comment">         Returns status of the connected channel.</span>
<a name="l00097"></a>00097 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00098"></a>00098 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00099"></a>00099 <span class="comment">         &lt;parameter name=&quot;channelname&quot; /&gt;</span>
<a name="l00100"></a>00100 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00101"></a>00101 <span class="comment">      &lt;description&gt;</span>
<a name="l00102"></a>00102 <span class="comment">         &lt;para&gt;Returns the status of the specified &lt;replaceable&gt;channelname&lt;/replaceable&gt;.</span>
<a name="l00103"></a>00103 <span class="comment">         If no channel name is given then returns the status of the current channel.&lt;/para&gt;</span>
<a name="l00104"></a>00104 <span class="comment">         &lt;para&gt;Return values:&lt;/para&gt;</span>
<a name="l00105"></a>00105 <span class="comment">         &lt;enumlist&gt;</span>
<a name="l00106"></a>00106 <span class="comment">            &lt;enum name=&quot;0&quot;&gt;</span>
<a name="l00107"></a>00107 <span class="comment">               &lt;para&gt;Channel is down and available.&lt;/para&gt;</span>
<a name="l00108"></a>00108 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00109"></a>00109 <span class="comment">            &lt;enum name=&quot;1&quot;&gt;</span>
<a name="l00110"></a>00110 <span class="comment">               &lt;para&gt;Channel is down, but reserved.&lt;/para&gt;</span>
<a name="l00111"></a>00111 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00112"></a>00112 <span class="comment">            &lt;enum name=&quot;2&quot;&gt;</span>
<a name="l00113"></a>00113 <span class="comment">               &lt;para&gt;Channel is off hook.&lt;/para&gt;</span>
<a name="l00114"></a>00114 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00115"></a>00115 <span class="comment">            &lt;enum name=&quot;3&quot;&gt;</span>
<a name="l00116"></a>00116 <span class="comment">               &lt;para&gt;Digits (or equivalent) have been dialed.&lt;/para&gt;</span>
<a name="l00117"></a>00117 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00118"></a>00118 <span class="comment">            &lt;enum name=&quot;4&quot;&gt;</span>
<a name="l00119"></a>00119 <span class="comment">               &lt;para&gt;Line is ringing.&lt;/para&gt;</span>
<a name="l00120"></a>00120 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00121"></a>00121 <span class="comment">            &lt;enum name=&quot;5&quot;&gt;</span>
<a name="l00122"></a>00122 <span class="comment">               &lt;para&gt;Remote end is ringing.&lt;/para&gt;</span>
<a name="l00123"></a>00123 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00124"></a>00124 <span class="comment">            &lt;enum name=&quot;6&quot;&gt;</span>
<a name="l00125"></a>00125 <span class="comment">               &lt;para&gt;Line is up.&lt;/para&gt;</span>
<a name="l00126"></a>00126 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00127"></a>00127 <span class="comment">            &lt;enum name=&quot;7&quot;&gt;</span>
<a name="l00128"></a>00128 <span class="comment">               &lt;para&gt;Line is busy.&lt;/para&gt;</span>
<a name="l00129"></a>00129 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00130"></a>00130 <span class="comment">         &lt;/enumlist&gt;</span>
<a name="l00131"></a>00131 <span class="comment">      &lt;/description&gt;</span>
<a name="l00132"></a>00132 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00133"></a>00133 <span class="comment">   &lt;agi name=&quot;database del&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00134"></a>00134 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00135"></a>00135 <span class="comment">         Removes database key/value</span>
<a name="l00136"></a>00136 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00137"></a>00137 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00138"></a>00138 <span class="comment">         &lt;parameter name=&quot;family&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00139"></a>00139 <span class="comment">         &lt;parameter name=&quot;key&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00140"></a>00140 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00141"></a>00141 <span class="comment">      &lt;description&gt;</span>
<a name="l00142"></a>00142 <span class="comment">         &lt;para&gt;Deletes an entry in the Asterisk database for a given</span>
<a name="l00143"></a>00143 <span class="comment">         &lt;replaceable&gt;family&lt;/replaceable&gt; and &lt;replaceable&gt;key&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00144"></a>00144 <span class="comment">         &lt;para&gt;Returns &lt;literal&gt;1&lt;/literal&gt; if successful, &lt;literal&gt;0&lt;/literal&gt;</span>
<a name="l00145"></a>00145 <span class="comment">         otherwise.&lt;/para&gt;</span>
<a name="l00146"></a>00146 <span class="comment">      &lt;/description&gt;</span>
<a name="l00147"></a>00147 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00148"></a>00148 <span class="comment">   &lt;agi name=&quot;database deltree&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00149"></a>00149 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00150"></a>00150 <span class="comment">         Removes database keytree/value</span>
<a name="l00151"></a>00151 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00152"></a>00152 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00153"></a>00153 <span class="comment">         &lt;parameter name=&quot;family&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00154"></a>00154 <span class="comment">         &lt;parameter name=&quot;keytree&quot; /&gt;</span>
<a name="l00155"></a>00155 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00156"></a>00156 <span class="comment">      &lt;description&gt;</span>
<a name="l00157"></a>00157 <span class="comment">         &lt;para&gt;Deletes a &lt;replaceable&gt;family&lt;/replaceable&gt; or specific &lt;replaceable&gt;keytree&lt;/replaceable&gt;</span>
<a name="l00158"></a>00158 <span class="comment">         within a &lt;replaceable&gt;family&lt;/replaceable&gt; in the Asterisk database.&lt;/para&gt;</span>
<a name="l00159"></a>00159 <span class="comment">         &lt;para&gt;Returns &lt;literal&gt;1&lt;/literal&gt; if successful, &lt;literal&gt;0&lt;/literal&gt; otherwise.&lt;/para&gt;</span>
<a name="l00160"></a>00160 <span class="comment">      &lt;/description&gt;</span>
<a name="l00161"></a>00161 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00162"></a>00162 <span class="comment">   &lt;agi name=&quot;database get&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00163"></a>00163 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00164"></a>00164 <span class="comment">         Gets database value</span>
<a name="l00165"></a>00165 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00166"></a>00166 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00167"></a>00167 <span class="comment">         &lt;parameter name=&quot;family&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00168"></a>00168 <span class="comment">         &lt;parameter name=&quot;key&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00169"></a>00169 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00170"></a>00170 <span class="comment">      &lt;description&gt;</span>
<a name="l00171"></a>00171 <span class="comment">         &lt;para&gt;Retrieves an entry in the Asterisk database for a given &lt;replaceable&gt;family&lt;/replaceable&gt;</span>
<a name="l00172"></a>00172 <span class="comment">         and &lt;replaceable&gt;key&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00173"></a>00173 <span class="comment">         &lt;para&gt;Returns &lt;literal&gt;0&lt;/literal&gt; if &lt;replaceable&gt;key&lt;/replaceable&gt; is not set.</span>
<a name="l00174"></a>00174 <span class="comment">         Returns &lt;literal&gt;1&lt;/literal&gt; if &lt;replaceable&gt;key&lt;/replaceable&gt; is set and returns the variable</span>
<a name="l00175"></a>00175 <span class="comment">         in parenthesis.&lt;/para&gt;</span>
<a name="l00176"></a>00176 <span class="comment">         &lt;para&gt;Example return code: 200 result=1 (testvariable)&lt;/para&gt;</span>
<a name="l00177"></a>00177 <span class="comment">      &lt;/description&gt;</span>
<a name="l00178"></a>00178 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00179"></a>00179 <span class="comment">   &lt;agi name=&quot;database put&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00180"></a>00180 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00181"></a>00181 <span class="comment">         Adds/updates database value</span>
<a name="l00182"></a>00182 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00183"></a>00183 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00184"></a>00184 <span class="comment">         &lt;parameter name=&quot;family&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00185"></a>00185 <span class="comment">         &lt;parameter name=&quot;key&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00186"></a>00186 <span class="comment">         &lt;parameter name=&quot;value&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00187"></a>00187 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00188"></a>00188 <span class="comment">      &lt;description&gt;</span>
<a name="l00189"></a>00189 <span class="comment">         &lt;para&gt;Adds or updates an entry in the Asterisk database for a given</span>
<a name="l00190"></a>00190 <span class="comment">         &lt;replaceable&gt;family&lt;/replaceable&gt;, &lt;replaceable&gt;key&lt;/replaceable&gt;, and</span>
<a name="l00191"></a>00191 <span class="comment">         &lt;replaceable&gt;value&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00192"></a>00192 <span class="comment">         &lt;para&gt;Returns &lt;literal&gt;1&lt;/literal&gt; if successful, &lt;literal&gt;0&lt;/literal&gt; otherwise.&lt;/para&gt;</span>
<a name="l00193"></a>00193 <span class="comment">      &lt;/description&gt;</span>
<a name="l00194"></a>00194 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00195"></a>00195 <span class="comment">   &lt;agi name=&quot;exec&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00196"></a>00196 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00197"></a>00197 <span class="comment">         Executes a given Application</span>
<a name="l00198"></a>00198 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00199"></a>00199 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00200"></a>00200 <span class="comment">         &lt;parameter name=&quot;application&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00201"></a>00201 <span class="comment">         &lt;parameter name=&quot;options&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00202"></a>00202 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00203"></a>00203 <span class="comment">      &lt;description&gt;</span>
<a name="l00204"></a>00204 <span class="comment">         &lt;para&gt;Executes &lt;replaceable&gt;application&lt;/replaceable&gt; with given</span>
<a name="l00205"></a>00205 <span class="comment">         &lt;replaceable&gt;options&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00206"></a>00206 <span class="comment">         &lt;para&gt;Returns whatever the &lt;replaceable&gt;application&lt;/replaceable&gt; returns, or</span>
<a name="l00207"></a>00207 <span class="comment">         &lt;literal&gt;-2&lt;/literal&gt; on failure to find &lt;replaceable&gt;application&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00208"></a>00208 <span class="comment">      &lt;/description&gt;</span>
<a name="l00209"></a>00209 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00210"></a>00210 <span class="comment">   &lt;agi name=&quot;get data&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00211"></a>00211 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00212"></a>00212 <span class="comment">         Prompts for DTMF on a channel</span>
<a name="l00213"></a>00213 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00214"></a>00214 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00215"></a>00215 <span class="comment">         &lt;parameter name=&quot;file&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00216"></a>00216 <span class="comment">         &lt;parameter name=&quot;timeout&quot; /&gt;</span>
<a name="l00217"></a>00217 <span class="comment">         &lt;parameter name=&quot;maxdigits&quot; /&gt;</span>
<a name="l00218"></a>00218 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00219"></a>00219 <span class="comment">      &lt;description&gt;</span>
<a name="l00220"></a>00220 <span class="comment">         &lt;para&gt;Stream the given &lt;replaceable&gt;file&lt;/replaceable&gt;, and receive DTMF data.&lt;/para&gt;</span>
<a name="l00221"></a>00221 <span class="comment">         &lt;para&gt;Returns the digits received from the channel at the other end.&lt;/para&gt;</span>
<a name="l00222"></a>00222 <span class="comment">      &lt;/description&gt;</span>
<a name="l00223"></a>00223 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00224"></a>00224 <span class="comment">   &lt;agi name=&quot;get full variable&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00225"></a>00225 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00226"></a>00226 <span class="comment">         Evaluates a channel expression</span>
<a name="l00227"></a>00227 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00228"></a>00228 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00229"></a>00229 <span class="comment">         &lt;parameter name=&quot;variablename&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00230"></a>00230 <span class="comment">         &lt;parameter name=&quot;channel name&quot; /&gt;</span>
<a name="l00231"></a>00231 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00232"></a>00232 <span class="comment">      &lt;description&gt;</span>
<a name="l00233"></a>00233 <span class="comment">         &lt;para&gt;Returns &lt;literal&gt;0&lt;/literal&gt; if &lt;replaceable&gt;variablename&lt;/replaceable&gt; is not set</span>
<a name="l00234"></a>00234 <span class="comment">         or channel does not exist. Returns &lt;literal&gt;1&lt;/literal&gt; if &lt;replaceable&gt;variablename&lt;/replaceable&gt;</span>
<a name="l00235"></a>00235 <span class="comment">         is set and returns the variable in parenthesis. Understands complex variable names and builtin</span>
<a name="l00236"></a>00236 <span class="comment">         variables, unlike GET VARIABLE.&lt;/para&gt;</span>
<a name="l00237"></a>00237 <span class="comment">         &lt;para&gt;Example return code: 200 result=1 (testvariable)&lt;/para&gt;</span>
<a name="l00238"></a>00238 <span class="comment">      &lt;/description&gt;</span>
<a name="l00239"></a>00239 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00240"></a>00240 <span class="comment">   &lt;agi name=&quot;get option&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00241"></a>00241 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00242"></a>00242 <span class="comment">         Stream file, prompt for DTMF, with timeout.</span>
<a name="l00243"></a>00243 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00244"></a>00244 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00245"></a>00245 <span class="comment">         &lt;parameter name=&quot;filename&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00246"></a>00246 <span class="comment">         &lt;parameter name=&quot;escape_digits&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00247"></a>00247 <span class="comment">         &lt;parameter name=&quot;timeout&quot; /&gt;</span>
<a name="l00248"></a>00248 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00249"></a>00249 <span class="comment">      &lt;description&gt;</span>
<a name="l00250"></a>00250 <span class="comment">         &lt;para&gt;Behaves similar to STREAM FILE but used with a timeout option.&lt;/para&gt;</span>
<a name="l00251"></a>00251 <span class="comment">      &lt;/description&gt;</span>
<a name="l00252"></a>00252 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00253"></a>00253 <span class="comment">         &lt;ref type=&quot;agi&quot;&gt;stream file&lt;/ref&gt;</span>
<a name="l00254"></a>00254 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00255"></a>00255 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00256"></a>00256 <span class="comment">   &lt;agi name=&quot;get variable&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00257"></a>00257 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00258"></a>00258 <span class="comment">         Gets a channel variable.</span>
<a name="l00259"></a>00259 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00260"></a>00260 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00261"></a>00261 <span class="comment">         &lt;parameter name=&quot;variablename&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00262"></a>00262 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00263"></a>00263 <span class="comment">      &lt;description&gt;</span>
<a name="l00264"></a>00264 <span class="comment">         &lt;para&gt;Returns &lt;literal&gt;0&lt;/literal&gt; if &lt;replaceable&gt;variablename&lt;/replaceable&gt; is not set.</span>
<a name="l00265"></a>00265 <span class="comment">         Returns &lt;literal&gt;1&lt;/literal&gt; if &lt;replaceable&gt;variablename&lt;/replaceable&gt; is set and returns</span>
<a name="l00266"></a>00266 <span class="comment">         the variable in parentheses.&lt;/para&gt;</span>
<a name="l00267"></a>00267 <span class="comment">         &lt;para&gt;Example return code: 200 result=1 (testvariable)&lt;/para&gt;</span>
<a name="l00268"></a>00268 <span class="comment">      &lt;/description&gt;</span>
<a name="l00269"></a>00269 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00270"></a>00270 <span class="comment">   &lt;agi name=&quot;hangup&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00271"></a>00271 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00272"></a>00272 <span class="comment">         Hangup the current channel.</span>
<a name="l00273"></a>00273 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00274"></a>00274 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00275"></a>00275 <span class="comment">         &lt;parameter name=&quot;channelname&quot; /&gt;</span>
<a name="l00276"></a>00276 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00277"></a>00277 <span class="comment">      &lt;description&gt;</span>
<a name="l00278"></a>00278 <span class="comment">         &lt;para&gt;Hangs up the specified channel. If no channel name is given, hangs</span>
<a name="l00279"></a>00279 <span class="comment">         up the current channel&lt;/para&gt;</span>
<a name="l00280"></a>00280 <span class="comment">      &lt;/description&gt;</span>
<a name="l00281"></a>00281 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00282"></a>00282 <span class="comment">   &lt;agi name=&quot;noop&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00283"></a>00283 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00284"></a>00284 <span class="comment">         Does nothing.</span>
<a name="l00285"></a>00285 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00286"></a>00286 <span class="comment">      &lt;syntax /&gt;</span>
<a name="l00287"></a>00287 <span class="comment">      &lt;description&gt;</span>
<a name="l00288"></a>00288 <span class="comment">         &lt;para&gt;Does nothing.&lt;/para&gt;</span>
<a name="l00289"></a>00289 <span class="comment">      &lt;/description&gt;</span>
<a name="l00290"></a>00290 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00291"></a>00291 <span class="comment">   &lt;agi name=&quot;set music&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00292"></a>00292 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00293"></a>00293 <span class="comment">         Enable/Disable Music on hold generator</span>
<a name="l00294"></a>00294 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00295"></a>00295 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00296"></a>00296 <span class="comment">         &lt;parameter required=&quot;true&quot;&gt;</span>
<a name="l00297"></a>00297 <span class="comment">            &lt;enumlist&gt;</span>
<a name="l00298"></a>00298 <span class="comment">               &lt;enum&gt;</span>
<a name="l00299"></a>00299 <span class="comment">                  &lt;parameter name=&quot;on&quot; literal=&quot;true&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00300"></a>00300 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00301"></a>00301 <span class="comment">               &lt;enum&gt;</span>
<a name="l00302"></a>00302 <span class="comment">                  &lt;parameter name=&quot;off&quot; literal=&quot;true&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00303"></a>00303 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00304"></a>00304 <span class="comment">            &lt;/enumlist&gt;</span>
<a name="l00305"></a>00305 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00306"></a>00306 <span class="comment">         &lt;parameter name=&quot;class&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00307"></a>00307 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00308"></a>00308 <span class="comment">      &lt;description&gt;</span>
<a name="l00309"></a>00309 <span class="comment">         &lt;para&gt;Enables/Disables the music on hold generator. If &lt;replaceable&gt;class&lt;/replaceable&gt;</span>
<a name="l00310"></a>00310 <span class="comment">         is not specified, then the &lt;literal&gt;default&lt;/literal&gt; music on hold class will be</span>
<a name="l00311"></a>00311 <span class="comment">         used.&lt;/para&gt;</span>
<a name="l00312"></a>00312 <span class="comment">         &lt;para&gt;Always returns &lt;literal&gt;0&lt;/literal&gt;.&lt;/para&gt;</span>
<a name="l00313"></a>00313 <span class="comment">      &lt;/description&gt;</span>
<a name="l00314"></a>00314 <span class="comment">   &lt;/agi&gt;</span>
<a name="l00315"></a>00315 <span class="comment"> ***/</span>
<a name="l00316"></a>00316 
<a name="l00317"></a><a class="code" href="res__agi_8c.html#a29b7451465deac204c5f7cb1f9c6e1fc">00317</a> <span class="preprocessor">#define MAX_ARGS 128</span>
<a name="l00318"></a><a class="code" href="res__agi_8c.html#a1eb73c104b484cf18752169509cebfe2">00318</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_CMD_LEN 80</span>
<a name="l00319"></a><a class="code" href="res__agi_8c.html#aafc38adf75f284d5cf7e6f11a55bb29f">00319</a> <span class="preprocessor"></span><span class="preprocessor">#define AGI_NANDFS_RETRY 3</span>
<a name="l00320"></a><a class="code" href="res__agi_8c.html#acac9c67d43a9e0d04c732fc06665f6dd">00320</a> <span class="preprocessor"></span><span class="preprocessor">#define AGI_BUF_LEN 2048</span>
<a name="l00321"></a>00321 <span class="preprocessor"></span>
<a name="l00322"></a><a class="code" href="res__agi_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">00322</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a> = <span class="stringliteral">&quot;AGI&quot;</span>;
<a name="l00323"></a>00323 
<a name="l00324"></a><a class="code" href="res__agi_8c.html#a04c472070a5f7bb59a453e5243bbcd8d">00324</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#a04c472070a5f7bb59a453e5243bbcd8d">eapp</a> = <span class="stringliteral">&quot;EAGI&quot;</span>;
<a name="l00325"></a>00325 
<a name="l00326"></a><a class="code" href="res__agi_8c.html#a88932dc53060370d87a1bed5af51d968">00326</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#a88932dc53060370d87a1bed5af51d968">deadapp</a> = <span class="stringliteral">&quot;DeadAGI&quot;</span>;
<a name="l00327"></a>00327 
<a name="l00328"></a><a class="code" href="res__agi_8c.html#a1539fbb78128c8c72e41d1e9d2c09351">00328</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#a1539fbb78128c8c72e41d1e9d2c09351">synopsis</a> = <span class="stringliteral">&quot;Executes an AGI compliant application&quot;</span>;
<a name="l00329"></a><a class="code" href="res__agi_8c.html#ad7871432eecaf382b04237f853d57367">00329</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#ad7871432eecaf382b04237f853d57367">esynopsis</a> = <span class="stringliteral">&quot;Executes an EAGI compliant application&quot;</span>;
<a name="l00330"></a><a class="code" href="res__agi_8c.html#ae6253df1d3ec199246c82cd7e5a22af5">00330</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#ae6253df1d3ec199246c82cd7e5a22af5">deadsynopsis</a> = <span class="stringliteral">&quot;Executes AGI on a hungup channel&quot;</span>;
<a name="l00331"></a>00331 
<a name="l00332"></a><a class="code" href="res__agi_8c.html#a877f822586004ea40111a93db702cf15">00332</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#a877f822586004ea40111a93db702cf15">descrip</a> =
<a name="l00333"></a>00333 <span class="stringliteral">&quot;  [E|Dead]AGI(command,args): Executes an Asterisk Gateway Interface compliant\n&quot;</span>
<a name="l00334"></a>00334 <span class="stringliteral">&quot;program on a channel. AGI allows Asterisk to launch external programs written\n&quot;</span>
<a name="l00335"></a>00335 <span class="stringliteral">&quot;in any language to control a telephony channel, play audio, read DTMF digits,\n&quot;</span>
<a name="l00336"></a>00336 <span class="stringliteral">&quot;etc. by communicating with the AGI protocol on stdin and stdout.\n&quot;</span>
<a name="l00337"></a>00337 <span class="stringliteral">&quot;  As of 1.6.0, this channel will not stop dialplan execution on hangup inside\n&quot;</span>
<a name="l00338"></a>00338 <span class="stringliteral">&quot;of this application. Dialplan execution will continue normally, even upon\n&quot;</span>
<a name="l00339"></a>00339 <span class="stringliteral">&quot;hangup until the AGI application signals a desire to stop (either by exiting\n&quot;</span>
<a name="l00340"></a>00340 <span class="stringliteral">&quot;or, in the case of a net script, by closing the connection).\n&quot;</span>
<a name="l00341"></a>00341 <span class="stringliteral">&quot;  A locally executed AGI script will receive SIGHUP on hangup from the channel\n&quot;</span>
<a name="l00342"></a>00342 <span class="stringliteral">&quot;except when using DeadAGI. A fast AGI server will correspondingly receive a\n&quot;</span>
<a name="l00343"></a>00343 <span class="stringliteral">&quot;HANGUP in OOB data. Both of these signals may be disabled by setting the\n&quot;</span>
<a name="l00344"></a>00344 <span class="stringliteral">&quot;AGISIGHUP channel variable to \&quot;no\&quot; before executing the AGI application.\n&quot;</span>
<a name="l00345"></a>00345 <span class="stringliteral">&quot;  Using &apos;EAGI&apos; provides enhanced AGI, with incoming audio available out of band\n&quot;</span>
<a name="l00346"></a>00346 <span class="stringliteral">&quot;on file descriptor 3.\n\n&quot;</span>
<a name="l00347"></a>00347 <span class="stringliteral">&quot;  Use the CLI command &apos;agi show commnands&apos; to list available agi commands.\n&quot;</span>
<a name="l00348"></a>00348 <span class="stringliteral">&quot;  This application sets the following channel variable upon completion:\n&quot;</span>
<a name="l00349"></a>00349 <span class="stringliteral">&quot;     AGISTATUS      The status of the attempt to the run the AGI script\n&quot;</span>
<a name="l00350"></a>00350 <span class="stringliteral">&quot;                    text string, one of SUCCESS | FAILURE | NOTFOUND | HANGUP\n&quot;</span>;
<a name="l00351"></a>00351 
<a name="l00352"></a><a class="code" href="res__agi_8c.html#a9e4d6534e259785ec604fa072e049325">00352</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a9e4d6534e259785ec604fa072e049325">agidebug</a> = 0;
<a name="l00353"></a>00353 
<a name="l00354"></a><a class="code" href="res__agi_8c.html#af528891ceae298f0adb4f75de973e843">00354</a> <span class="preprocessor">#define TONE_BLOCK_SIZE 200</span>
<a name="l00355"></a>00355 <span class="preprocessor"></span>
<a name="l00356"></a>00356 <span class="comment">/* Max time to connect to an AGI remote host */</span>
<a name="l00357"></a><a class="code" href="res__agi_8c.html#a7b35d7eb31c6eba73c2e1fb493621d7c">00357</a> <span class="preprocessor">#define MAX_AGI_CONNECT 2000</span>
<a name="l00358"></a>00358 <span class="preprocessor"></span>
<a name="l00359"></a><a class="code" href="res__agi_8c.html#acc5c6270557bf6ddf0ddf1952d9c600a">00359</a> <span class="preprocessor">#define AGI_PORT 4573</span>
<a name="l00360"></a>00360 <span class="preprocessor"></span>
<a name="l00361"></a><a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1">00361</a> <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1">agi_result</a> {
<a name="l00362"></a><a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">00362</a>    <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a> = -1,
<a name="l00363"></a><a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a493daf1d6c06bbf4b17b36929cc51fd8">00363</a>    <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a493daf1d6c06bbf4b17b36929cc51fd8">AGI_RESULT_SUCCESS</a>,
<a name="l00364"></a><a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1aac30d4ae19361cc243414b0ec32cbb78">00364</a>    <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1aac30d4ae19361cc243414b0ec32cbb78">AGI_RESULT_SUCCESS_FAST</a>,
<a name="l00365"></a><a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a97eab5e05f42bf8b5da0575a67e10d7c">00365</a>    <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a97eab5e05f42bf8b5da0575a67e10d7c">AGI_RESULT_SUCCESS_ASYNC</a>,
<a name="l00366"></a><a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1ac0f8286bb33122eee66cbe710f3f5ada">00366</a>    <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1ac0f8286bb33122eee66cbe710f3f5ada">AGI_RESULT_NOTFOUND</a>,
<a name="l00367"></a><a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a3efef4607e59ada98318f948f398d8fe">00367</a>    <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a3efef4607e59ada98318f948f398d8fe">AGI_RESULT_HANGUP</a>,
<a name="l00368"></a>00368 };
<a name="l00369"></a>00369 
<a name="l00370"></a>00370 <span class="keyword">static</span> <a class="code" href="structagi__command.html">agi_command</a> *<a class="code" href="res__agi_8c.html#ace45cfd0b2306ec060fa4a788b976125">find_command</a>(<span class="keywordtype">char</span> *cmds[], <span class="keywordtype">int</span> exact);
<a name="l00371"></a>00371 
<a name="l00372"></a><a class="code" href="res__agi_8c.html#a80c30395a4c4fa9d8164ebc3608010e6">00372</a> <a class="code" href="threadstorage_8h.html#ac268c0a8272ec11e73269392507fb1a6" title="Define a thread storage variable.">AST_THREADSTORAGE</a>(<a class="code" href="res__agi_8c.html#a80c30395a4c4fa9d8164ebc3608010e6">agi_buf</a>);
<a name="l00373"></a><a class="code" href="res__agi_8c.html#aac3502538abd25c04158ea6d06c182d6">00373</a> <span class="preprocessor">#define AGI_BUF_INITSIZE 256</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span>
<a name="l00375"></a><a class="code" href="res__agi_8c.html#a2c8f3e7f1de36bf5a7fc539c84177f82">00375</a> <span class="keywordtype">int</span> <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(<span class="keywordtype">int</span> fd, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> *fmt, ...)
<a name="l00376"></a>00376 {
<a name="l00377"></a>00377    <span class="keywordtype">int</span> res = 0;
<a name="l00378"></a>00378    va_list ap;
<a name="l00379"></a>00379    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381    <span class="keywordflow">if</span> (!(buf = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__agi_8c.html#a80c30395a4c4fa9d8164ebc3608010e6">agi_buf</a>, <a class="code" href="res__agi_8c.html#aac3502538abd25c04158ea6d06c182d6">AGI_BUF_INITSIZE</a>)))
<a name="l00382"></a>00382       <span class="keywordflow">return</span> -1;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384    va_start(ap, fmt);
<a name="l00385"></a>00385    res = <a class="code" href="strings_8h.html#a7ce3f97dd6d3f76f92304c1f5066c77b" title="Set a dynamic string from a va_list.">ast_str_set_va</a>(&amp;buf, 0, fmt, ap);
<a name="l00386"></a>00386    va_end(ap);
<a name="l00387"></a>00387 
<a name="l00388"></a>00388    <span class="keywordflow">if</span> (res == -1) {
<a name="l00389"></a>00389       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory\n&quot;</span>);
<a name="l00390"></a>00390       <span class="keywordflow">return</span> -1;
<a name="l00391"></a>00391    }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393    <span class="keywordflow">if</span> (agidebug) {
<a name="l00394"></a>00394       <span class="keywordflow">if</span> (chan) {
<a name="l00395"></a>00395          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;&lt;%s&gt;AGI Tx &gt;&gt; %s&quot;</span>, chan-&gt;name, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l00396"></a>00396       } <span class="keywordflow">else</span> {
<a name="l00397"></a>00397          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;AGI Tx &gt;&gt; %s&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l00398"></a>00398       }
<a name="l00399"></a>00399    }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401    <span class="keywordflow">return</span> <a class="code" href="utils_8h.html#a38faf2987c375335b2773964aabf69b3" title="Try to write string, but wait no more than ms milliseconds before timing out.">ast_carefulwrite</a>(fd, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf), <a class="code" href="strings_8h.html#a99409c17a1d20e1c3dc00039b7925a2d" title="Returns the current length of the string stored within buf.">ast_str_strlen</a>(buf), 100);
<a name="l00402"></a>00402 }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 <span class="comment">/* linked list of AGI commands ready to be executed by Async AGI */</span>
<a name="l00405"></a><a class="code" href="structagi__cmd.html">00405</a> <span class="keyword">struct </span><a class="code" href="structagi__cmd.html">agi_cmd</a> {
<a name="l00406"></a><a class="code" href="structagi__cmd.html#a3fe154717b79d32dd6366ce4b0cb6b38">00406</a>    <span class="keywordtype">char</span> *<a class="code" href="structagi__cmd.html#a3fe154717b79d32dd6366ce4b0cb6b38">cmd_buffer</a>;
<a name="l00407"></a><a class="code" href="structagi__cmd.html#a550a7cedad446097b6e55bbd744412b1">00407</a>    <span class="keywordtype">char</span> *<a class="code" href="structagi__cmd.html#a550a7cedad446097b6e55bbd744412b1">cmd_id</a>;
<a name="l00408"></a><a class="code" href="structagi__cmd.html#aec2b5d55d8074563221766320dd1e718">00408</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structagi__cmd.html">agi_cmd</a>) <a class="code" href="structagi__cmd.html#aaeeadc04cdbb8d93863df75e6337d1f6">entry</a>;
<a name="l00409"></a>00409 };
<a name="l00410"></a>00410 
<a name="l00411"></a><a class="code" href="res__agi_8c.html#aeb2a37e60e82e5519f36a120c2bae28e">00411</a> static <span class="keywordtype">void</span> <a class="code" href="res__agi_8c.html#aeb2a37e60e82e5519f36a120c2bae28e">free_agi_cmd</a>(struct <a class="code" href="structagi__cmd.html">agi_cmd</a> *cmd)
<a name="l00412"></a>00412 {
<a name="l00413"></a>00413    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmd-&gt;cmd_buffer);
<a name="l00414"></a>00414    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmd-&gt;cmd_id);
<a name="l00415"></a>00415    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmd);
<a name="l00416"></a>00416 }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418 <span class="comment">/* AGI datastore destructor */</span>
<a name="l00419"></a><a class="code" href="res__agi_8c.html#a2ae8b32514354ab1dd2b62121ed88593">00419</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__agi_8c.html#a2ae8b32514354ab1dd2b62121ed88593">agi_destroy_commands_cb</a>(<span class="keywordtype">void</span> *data)
<a name="l00420"></a>00420 {
<a name="l00421"></a>00421    <span class="keyword">struct </span><a class="code" href="structagi__cmd.html">agi_cmd</a> *cmd;
<a name="l00422"></a>00422    <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structagi__cmd.html">agi_cmd</a>) *chan_cmds = data;
<a name="l00423"></a>00423    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(chan_cmds);
<a name="l00424"></a>00424    <span class="keywordflow">while</span> ( (cmd = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(chan_cmds, <a class="code" href="structagi__cmd.html#aaeeadc04cdbb8d93863df75e6337d1f6">entry</a>)) ) {
<a name="l00425"></a>00425       <a class="code" href="res__agi_8c.html#aeb2a37e60e82e5519f36a120c2bae28e">free_agi_cmd</a>(cmd);
<a name="l00426"></a>00426    }
<a name="l00427"></a>00427    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(chan_cmds);
<a name="l00428"></a>00428    <a class="code" href="linkedlists_8h.html#a47bafe663a14b91827082787d7654d7c" title="Destroys a list head structure.">AST_LIST_HEAD_DESTROY</a>(chan_cmds);
<a name="l00429"></a>00429    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(chan_cmds);
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 <span class="comment">/* channel datastore to keep the queue of AGI commands in the channel */</span>
<a name="l00433"></a><a class="code" href="res__agi_8c.html#a8fdf1233d60c1110ae3858a92db126eb">00433</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__datastore__info.html" title="Structure for a data store type.">ast_datastore_info</a> <a class="code" href="res__agi_8c.html#a8fdf1233d60c1110ae3858a92db126eb">agi_commands_datastore_info</a> = {
<a name="l00434"></a>00434    .<a class="code" href="structast__datastore__info.html#a763fd8db6bba8fbbbc113ca0d61c47c2">type</a> = <span class="stringliteral">&quot;AsyncAGI&quot;</span>,
<a name="l00435"></a>00435    .destroy = <a class="code" href="res__agi_8c.html#a2ae8b32514354ab1dd2b62121ed88593">agi_destroy_commands_cb</a>
<a name="l00436"></a>00436 };
<a name="l00437"></a>00437 
<a name="l00438"></a><a class="code" href="res__agi_8c.html#a42c60934f0bbb01ff8af32cfae299baa">00438</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a42c60934f0bbb01ff8af32cfae299baa">mandescr_asyncagi</a>[] =
<a name="l00439"></a>00439 <span class="stringliteral">&quot;Description: Add an AGI command to the execute queue of the channel in Async AGI\n&quot;</span>
<a name="l00440"></a>00440 <span class="stringliteral">&quot;Variables:\n&quot;</span>
<a name="l00441"></a>00441 <span class="stringliteral">&quot;  *Channel: Channel that is currently in Async AGI\n&quot;</span>
<a name="l00442"></a>00442 <span class="stringliteral">&quot;  *Command: Application to execute\n&quot;</span>
<a name="l00443"></a>00443 <span class="stringliteral">&quot;   CommandID: comand id. This will be sent back in CommandID header of AsyncAGI exec event notification\n&quot;</span>
<a name="l00444"></a>00444 <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00445"></a>00445 
<a name="l00446"></a><a class="code" href="res__agi_8c.html#adff9e0250880d89a311bdbdd7b33ed88">00446</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structagi__cmd.html">agi_cmd</a> *<a class="code" href="res__agi_8c.html#adff9e0250880d89a311bdbdd7b33ed88">get_agi_cmd</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)
<a name="l00447"></a>00447 {
<a name="l00448"></a>00448    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *store;
<a name="l00449"></a>00449    <span class="keyword">struct </span><a class="code" href="structagi__cmd.html">agi_cmd</a> *cmd;
<a name="l00450"></a>00450    <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structagi__cmd.html">agi_cmd</a>) *<a class="code" href="structagi__commands.html">agi_commands</a>;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00453"></a>00453    store = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;<a class="code" href="res__agi_8c.html#a8fdf1233d60c1110ae3858a92db126eb">agi_commands_datastore_info</a>, NULL);
<a name="l00454"></a>00454    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00455"></a>00455    <span class="keywordflow">if</span> (!store) {
<a name="l00456"></a>00456       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Hu? datastore disappeared at Async AGI on Channel %s!\n&quot;</span>, chan-&gt;name);
<a name="l00457"></a>00457       <span class="keywordflow">return</span> NULL;
<a name="l00458"></a>00458    }
<a name="l00459"></a>00459    <a class="code" href="structagi__commands.html">agi_commands</a> = store-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00460"></a>00460    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l00461"></a>00461    cmd = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(<a class="code" href="structagi__commands.html">agi_commands</a>, <a class="code" href="structagi__cmd.html#aaeeadc04cdbb8d93863df75e6337d1f6">entry</a>);
<a name="l00462"></a>00462    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l00463"></a>00463    <span class="keywordflow">return</span> cmd;
<a name="l00464"></a>00464 }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466 <span class="comment">/* channel is locked when calling this one either from the CLI or manager thread */</span>
<a name="l00467"></a><a class="code" href="res__agi_8c.html#a76d81c59eb3c123fe6e6c483b410394d">00467</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a76d81c59eb3c123fe6e6c483b410394d">add_agi_cmd</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd_buff, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structagi__cmd.html#a550a7cedad446097b6e55bbd744412b1">cmd_id</a>)
<a name="l00468"></a>00468 {
<a name="l00469"></a>00469    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *store;
<a name="l00470"></a>00470    <span class="keyword">struct </span><a class="code" href="structagi__cmd.html">agi_cmd</a> *cmd;
<a name="l00471"></a>00471    <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structagi__cmd.html">agi_cmd</a>) *<a class="code" href="structagi__commands.html">agi_commands</a>;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473    store = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;<a class="code" href="res__agi_8c.html#a8fdf1233d60c1110ae3858a92db126eb">agi_commands_datastore_info</a>, NULL);
<a name="l00474"></a>00474    <span class="keywordflow">if</span> (!store) {
<a name="l00475"></a>00475       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel %s is not at Async AGI.\n&quot;</span>, chan-&gt;name);
<a name="l00476"></a>00476       <span class="keywordflow">return</span> -1;
<a name="l00477"></a>00477    }
<a name="l00478"></a>00478    <a class="code" href="structagi__commands.html">agi_commands</a> = store-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00479"></a>00479    cmd = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*cmd));
<a name="l00480"></a>00480    <span class="keywordflow">if</span> (!cmd) {
<a name="l00481"></a>00481       <span class="keywordflow">return</span> -1;
<a name="l00482"></a>00482    }
<a name="l00483"></a>00483    cmd-&gt;<a class="code" href="structagi__cmd.html#a3fe154717b79d32dd6366ce4b0cb6b38">cmd_buffer</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(cmd_buff);
<a name="l00484"></a>00484    <span class="keywordflow">if</span> (!cmd-&gt;<a class="code" href="structagi__cmd.html#a3fe154717b79d32dd6366ce4b0cb6b38">cmd_buffer</a>) {
<a name="l00485"></a>00485       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmd);
<a name="l00486"></a>00486       <span class="keywordflow">return</span> -1;
<a name="l00487"></a>00487    }
<a name="l00488"></a>00488    cmd-&gt;<a class="code" href="structagi__cmd.html#a550a7cedad446097b6e55bbd744412b1">cmd_id</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(cmd_id);
<a name="l00489"></a>00489    <span class="keywordflow">if</span> (!cmd-&gt;<a class="code" href="structagi__cmd.html#a550a7cedad446097b6e55bbd744412b1">cmd_id</a>) {
<a name="l00490"></a>00490       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmd-&gt;<a class="code" href="structagi__cmd.html#a3fe154717b79d32dd6366ce4b0cb6b38">cmd_buffer</a>);
<a name="l00491"></a>00491       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmd);
<a name="l00492"></a>00492       <span class="keywordflow">return</span> -1;
<a name="l00493"></a>00493    }
<a name="l00494"></a>00494    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l00495"></a>00495    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(<a class="code" href="structagi__commands.html">agi_commands</a>, cmd, <a class="code" href="structagi__cmd.html#aaeeadc04cdbb8d93863df75e6337d1f6">entry</a>);
<a name="l00496"></a>00496    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l00497"></a>00497    <span class="keywordflow">return</span> 0;
<a name="l00498"></a>00498 }
<a name="l00499"></a>00499 
<a name="l00500"></a><a class="code" href="res__agi_8c.html#a9383e938a35233f3b55a3c93a1e8ccca">00500</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a9383e938a35233f3b55a3c93a1e8ccca">add_to_agi</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)
<a name="l00501"></a>00501 {
<a name="l00502"></a>00502    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *datastore;
<a name="l00503"></a>00503    <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structagi__cmd.html">agi_cmd</a>) *agi_cmds_list;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505    <span class="comment">/* check if already on AGI */</span>
<a name="l00506"></a>00506    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00507"></a>00507    datastore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;<a class="code" href="res__agi_8c.html#a8fdf1233d60c1110ae3858a92db126eb">agi_commands_datastore_info</a>, NULL);
<a name="l00508"></a>00508    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00509"></a>00509    <span class="keywordflow">if</span> (datastore) {
<a name="l00510"></a>00510       <span class="comment">/* we already have an AGI datastore, let&apos;s just</span>
<a name="l00511"></a>00511 <span class="comment">         return success */</span>
<a name="l00512"></a>00512       <span class="keywordflow">return</span> 0;
<a name="l00513"></a>00513    }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515    <span class="comment">/* the channel has never been on Async AGI,</span>
<a name="l00516"></a>00516 <span class="comment">      let&apos;s allocate it&apos;s datastore */</span>
<a name="l00517"></a>00517    datastore = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="res__agi_8c.html#a8fdf1233d60c1110ae3858a92db126eb">agi_commands_datastore_info</a>, <span class="stringliteral">&quot;AGI&quot;</span>);
<a name="l00518"></a>00518    <span class="keywordflow">if</span> (!datastore) {
<a name="l00519"></a>00519       <span class="keywordflow">return</span> -1;
<a name="l00520"></a>00520    }
<a name="l00521"></a>00521    agi_cmds_list = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*agi_cmds_list));
<a name="l00522"></a>00522    <span class="keywordflow">if</span> (!agi_cmds_list) {
<a name="l00523"></a>00523       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to allocate Async AGI commands list.\n&quot;</span>);
<a name="l00524"></a>00524       <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(datastore);
<a name="l00525"></a>00525       <span class="keywordflow">return</span> -1;
<a name="l00526"></a>00526    }
<a name="l00527"></a>00527    datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = agi_cmds_list;
<a name="l00528"></a>00528    <a class="code" href="linkedlists_8h.html#a6f42d3bf45cc9af6f794d9d1cf8c45ca" title="Initializes a list head structure.">AST_LIST_HEAD_INIT</a>(agi_cmds_list);
<a name="l00529"></a>00529    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00530"></a>00530    <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(chan, datastore);
<a name="l00531"></a>00531    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00532"></a>00532    <span class="keywordflow">return</span> 0;
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 <span class="comment"></span>
<a name="l00535"></a>00535 <span class="comment">/*!</span>
<a name="l00536"></a>00536 <span class="comment"> * \brief CLI command to add applications to execute in Async AGI</span>
<a name="l00537"></a>00537 <span class="comment"> * \param e</span>
<a name="l00538"></a>00538 <span class="comment"> * \param cmd</span>
<a name="l00539"></a>00539 <span class="comment"> * \param a</span>
<a name="l00540"></a>00540 <span class="comment"> *</span>
<a name="l00541"></a>00541 <span class="comment"> * \retval CLI_SUCCESS on success</span>
<a name="l00542"></a>00542 <span class="comment"> * \retval NULL when init or tab completion is used</span>
<a name="l00543"></a>00543 <span class="comment">*/</span>
<a name="l00544"></a><a class="code" href="res__agi_8c.html#a034905bb151521b05105619714ea3e71">00544</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#a034905bb151521b05105619714ea3e71" title="CLI command to add applications to execute in Async AGI.">handle_cli_agi_add_cmd</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00545"></a>00545 {
<a name="l00546"></a>00546    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00547"></a>00547    <span class="keywordflow">switch</span> (cmd) {
<a name="l00548"></a>00548    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00549"></a>00549       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;agi exec&quot;</span>;
<a name="l00550"></a>00550       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = <span class="stringliteral">&quot;Usage: agi exec &lt;channel name&gt; &lt;app and arguments&gt; [id]\n&quot;</span>
<a name="l00551"></a>00551             <span class="stringliteral">&quot;       Add AGI command to the execute queue of the specified channel in Async AGI\n&quot;</span>;
<a name="l00552"></a>00552       <span class="keywordflow">return</span> NULL;
<a name="l00553"></a>00553    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00554"></a>00554       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 2)
<a name="l00555"></a>00555          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a3a116acde8f18aa530e5b4a6df420273" title="Command completion for the list of active channels.">ast_complete_channels</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, 2);
<a name="l00556"></a>00556       <span class="keywordflow">return</span> NULL;
<a name="l00557"></a>00557    }
<a name="l00558"></a>00558 
<a name="l00559"></a>00559    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 4)
<a name="l00560"></a>00560       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00561"></a>00561    chan = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);
<a name="l00562"></a>00562    <span class="keywordflow">if</span> (!chan) {
<a name="l00563"></a>00563       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel %s does not exists or cannot lock it\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);
<a name="l00564"></a>00564       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00565"></a>00565    }
<a name="l00566"></a>00566    <span class="keywordflow">if</span> (<a class="code" href="res__agi_8c.html#a76d81c59eb3c123fe6e6c483b410394d">add_agi_cmd</a>(chan, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 4 ? a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4] : <span class="stringliteral">&quot;&quot;</span>))) {
<a name="l00567"></a>00567       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;failed to add AGI command to queue of channel %s\n&quot;</span>, chan-&gt;name);
<a name="l00568"></a>00568       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00569"></a>00569       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00570"></a>00570    }
<a name="l00571"></a>00571    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Added AGI command to channel %s queue\n&quot;</span>, chan-&gt;name);
<a name="l00572"></a>00572    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00573"></a>00573    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00574"></a>00574 }
<a name="l00575"></a>00575 <span class="comment"></span>
<a name="l00576"></a>00576 <span class="comment">/*!</span>
<a name="l00577"></a>00577 <span class="comment"> * \brief Add a new command to execute by the Async AGI application</span>
<a name="l00578"></a>00578 <span class="comment"> * \param s</span>
<a name="l00579"></a>00579 <span class="comment"> * \param m</span>
<a name="l00580"></a>00580 <span class="comment"> *</span>
<a name="l00581"></a>00581 <span class="comment"> * It will append the application to the specified channel&apos;s queue</span>
<a name="l00582"></a>00582 <span class="comment"> * if the channel is not inside Async AGI application it will return an error</span>
<a name="l00583"></a>00583 <span class="comment"> * \retval 0 on success or incorrect use</span>
<a name="l00584"></a>00584 <span class="comment"> * \retval 1 on failure to add the command ( most likely because the channel</span>
<a name="l00585"></a>00585 <span class="comment"> * is not in Async AGI loop )</span>
<a name="l00586"></a>00586 <span class="comment">*/</span>
<a name="l00587"></a><a class="code" href="res__agi_8c.html#aa22a76ef4f33c70bc5f7099136a30727">00587</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#aa22a76ef4f33c70bc5f7099136a30727" title="Add a new command to execute by the Async AGI application.">action_add_agi_cmd</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l00588"></a>00588 {
<a name="l00589"></a>00589    <span class="keyword">const</span> <span class="keywordtype">char</span> *channel = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Channel&quot;</span>);
<a name="l00590"></a>00590    <span class="keyword">const</span> <span class="keywordtype">char</span> *cmdbuff = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Command&quot;</span>);
<a name="l00591"></a>00591    <span class="keyword">const</span> <span class="keywordtype">char</span> *cmdid   = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;CommandID&quot;</span>);
<a name="l00592"></a>00592    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00593"></a>00593    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256];
<a name="l00594"></a>00594    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(channel) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cmdbuff)) {
<a name="l00595"></a>00595       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Both, Channel and Command are *required*&quot;</span>);
<a name="l00596"></a>00596       <span class="keywordflow">return</span> 0;
<a name="l00597"></a>00597    }
<a name="l00598"></a>00598    chan = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(channel);
<a name="l00599"></a>00599    <span class="keywordflow">if</span> (!chan) {
<a name="l00600"></a>00600       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;Channel %s does not exists or cannot get its lock&quot;</span>, channel);
<a name="l00601"></a>00601       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, buf);
<a name="l00602"></a>00602       <span class="keywordflow">return</span> 0;
<a name="l00603"></a>00603    }
<a name="l00604"></a>00604    <span class="keywordflow">if</span> (<a class="code" href="res__agi_8c.html#a76d81c59eb3c123fe6e6c483b410394d">add_agi_cmd</a>(chan, cmdbuff, cmdid)) {
<a name="l00605"></a>00605       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;Failed to add AGI command to channel %s queue&quot;</span>, chan-&gt;name);
<a name="l00606"></a>00606       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, buf);
<a name="l00607"></a>00607       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00608"></a>00608       <span class="keywordflow">return</span> 0;
<a name="l00609"></a>00609    }
<a name="l00610"></a>00610    <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Added AGI command to queue&quot;</span>);
<a name="l00611"></a>00611    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00612"></a>00612    <span class="keywordflow">return</span> 0;
<a name="l00613"></a>00613 }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ac9faf2222a97b9abbab8430992c8da2f">agi_handle_command</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> dead);
<a name="l00616"></a>00616 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__agi_8c.html#a1a91f6f01be62db91c4a91250f3d513d">setup_env</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> *request, <span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> enhanced, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]);
<a name="l00617"></a><a class="code" href="res__agi_8c.html#af2be964118127fcbb3cca296c2a3252c">00617</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1">agi_result</a> <a class="code" href="res__agi_8c.html#af2be964118127fcbb3cca296c2a3252c">launch_asyncagi</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> *argv[], <span class="keywordtype">int</span> *efd)
<a name="l00618"></a>00618 {
<a name="l00619"></a>00619 <span class="comment">/* This buffer sizes might cause truncation if the AGI command writes more data</span>
<a name="l00620"></a>00620 <span class="comment">   than AGI_BUF_SIZE as result. But let&apos;s be serious, is there an AGI command</span>
<a name="l00621"></a>00621 <span class="comment">   that writes a response larger than 1024 bytes?, I don&apos;t think so, most of</span>
<a name="l00622"></a>00622 <span class="comment">   them are just result=blah stuff. However probably if GET VARIABLE is called</span>
<a name="l00623"></a>00623 <span class="comment">   and the variable has large amount of data, that could be a problem. We could</span>
<a name="l00624"></a>00624 <span class="comment">   make this buffers dynamic, but let&apos;s leave that as a second step.</span>
<a name="l00625"></a>00625 <span class="comment"></span>
<a name="l00626"></a>00626 <span class="comment">   AMI_BUF_SIZE is twice AGI_BUF_SIZE just for the sake of choosing a safe</span>
<a name="l00627"></a>00627 <span class="comment">   number. Some characters of AGI buf will be url encoded to be sent to manager</span>
<a name="l00628"></a>00628 <span class="comment">   clients.  An URL encoded character will take 3 bytes, but again, to cause</span>
<a name="l00629"></a>00629 <span class="comment">   truncation more than about 70% of the AGI buffer should be URL encoded for</span>
<a name="l00630"></a>00630 <span class="comment">   that to happen.  Not likely at all.</span>
<a name="l00631"></a>00631 <span class="comment"></span>
<a name="l00632"></a>00632 <span class="comment">   On the other hand. I wonder if read() could eventually return less data than</span>
<a name="l00633"></a>00633 <span class="comment">   the amount already available in the pipe? If so, how to deal with that?</span>
<a name="l00634"></a>00634 <span class="comment">   So far, my tests on Linux have not had any problems.</span>
<a name="l00635"></a>00635 <span class="comment"> */</span>
<a name="l00636"></a>00636 <span class="preprocessor">#define AGI_BUF_SIZE 1024</span>
<a name="l00637"></a>00637 <span class="preprocessor"></span><span class="preprocessor">#define AMI_BUF_SIZE 2048</span>
<a name="l00638"></a>00638 <span class="preprocessor"></span>   <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00639"></a>00639    <span class="keyword">struct </span><a class="code" href="structagi__cmd.html">agi_cmd</a> *cmd;
<a name="l00640"></a>00640    <span class="keywordtype">int</span> res, fds[2];
<a name="l00641"></a>00641    <span class="keywordtype">int</span> timeout = 100;
<a name="l00642"></a>00642    <span class="keywordtype">char</span> agi_buffer[<a class="code" href="res__agi_8c.html#aa2bed8203ffc925f64cf3b48cd3a2910">AGI_BUF_SIZE</a> + 1];
<a name="l00643"></a>00643    <span class="keywordtype">char</span> ami_buffer[<a class="code" href="res__agi_8c.html#a1bf7e6988af21440def19908daafd708">AMI_BUF_SIZE</a>];
<a name="l00644"></a>00644    <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1">agi_result</a> returnstatus = <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a97eab5e05f42bf8b5da0575a67e10d7c">AGI_RESULT_SUCCESS_ASYNC</a>;
<a name="l00645"></a>00645    <a class="code" href="structagi__state.html">AGI</a> async_agi;
<a name="l00646"></a>00646 
<a name="l00647"></a>00647    <span class="keywordflow">if</span> (efd) {
<a name="l00648"></a>00648       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Async AGI does not support Enhanced AGI yet\n&quot;</span>);
<a name="l00649"></a>00649       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00650"></a>00650    }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652    <span class="comment">/* add AsyncAGI datastore to the channel */</span>
<a name="l00653"></a>00653    <span class="keywordflow">if</span> (<a class="code" href="res__agi_8c.html#a9383e938a35233f3b55a3c93a1e8ccca">add_to_agi</a>(chan)) {
<a name="l00654"></a>00654       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;failed to start Async AGI on channel %s\n&quot;</span>, chan-&gt;name);
<a name="l00655"></a>00655       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00656"></a>00656    }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658    <span class="comment">/* this pipe allows us to create a &quot;fake&quot; AGI struct to use</span>
<a name="l00659"></a>00659 <span class="comment">      the AGI commands */</span>
<a name="l00660"></a>00660    res = pipe(fds);
<a name="l00661"></a>00661    <span class="keywordflow">if</span> (res) {
<a name="l00662"></a>00662       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;failed to create Async AGI pipe\n&quot;</span>);
<a name="l00663"></a>00663       <span class="comment">/* intentionally do not remove datastore, added with</span>
<a name="l00664"></a>00664 <span class="comment">         add_to_agi(), from channel. It will be removed when</span>
<a name="l00665"></a>00665 <span class="comment">         the channel is hung up anyways */</span>
<a name="l00666"></a>00666       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00667"></a>00667    }
<a name="l00668"></a>00668 
<a name="l00669"></a>00669    <span class="comment">/* handlers will get the pipe write fd and we read the AGI responses</span>
<a name="l00670"></a>00670 <span class="comment">      from the pipe read fd */</span>
<a name="l00671"></a>00671    async_agi.<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = fds[1];
<a name="l00672"></a>00672    async_agi.<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a> = fds[1];
<a name="l00673"></a>00673    async_agi.<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a> = -1; <span class="comment">/* no audio support */</span>
<a name="l00674"></a>00674    async_agi.<a class="code" href="structagi__state.html#aa9106f15c17bda42c4e5dc9e0fd96572">fast</a> = 0;
<a name="l00675"></a>00675    async_agi.<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a> = NULL;
<a name="l00676"></a>00676 
<a name="l00677"></a>00677    <span class="comment">/* notify possible manager users of a new channel ready to</span>
<a name="l00678"></a>00678 <span class="comment">      receive commands */</span>
<a name="l00679"></a>00679    <a class="code" href="res__agi_8c.html#a1a91f6f01be62db91c4a91250f3d513d">setup_env</a>(chan, <span class="stringliteral">&quot;async&quot;</span>, fds[1], 0, 0, NULL);
<a name="l00680"></a>00680    <span class="comment">/* read the environment */</span>
<a name="l00681"></a>00681    res = read(fds[0], agi_buffer, <a class="code" href="res__agi_8c.html#aa2bed8203ffc925f64cf3b48cd3a2910">AGI_BUF_SIZE</a>);
<a name="l00682"></a>00682    <span class="keywordflow">if</span> (!res) {
<a name="l00683"></a>00683       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;failed to read from Async AGI pipe on channel %s\n&quot;</span>, chan-&gt;name);
<a name="l00684"></a>00684       returnstatus = <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00685"></a>00685       <span class="keywordflow">goto</span> <a class="code" href="pbx__gtkconsole_8c.html#a1a178011116b4794df2c3dd41be5e9ed">quit</a>;
<a name="l00686"></a>00686    }
<a name="l00687"></a>00687    agi_buffer[res] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00688"></a>00688    <span class="comment">/* encode it and send it thru the manager so whoever is going to take</span>
<a name="l00689"></a>00689 <span class="comment">      care of AGI commands on this channel can decide which AGI commands</span>
<a name="l00690"></a>00690 <span class="comment">      to execute based on the setup info */</span>
<a name="l00691"></a>00691    <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(agi_buffer, ami_buffer, <a class="code" href="res__agi_8c.html#a1bf7e6988af21440def19908daafd708">AMI_BUF_SIZE</a>, 1);
<a name="l00692"></a>00692    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ac7370fe764f1305cdb3c543d3964d5ed">EVENT_FLAG_AGI</a>, <span class="stringliteral">&quot;AsyncAGI&quot;</span>, <span class="stringliteral">&quot;SubEvent: Start\r\nChannel: %s\r\nEnv: %s\r\n&quot;</span>, chan-&gt;name, ami_buffer);
<a name="l00693"></a>00693    <span class="keywordflow">while</span> (1) {
<a name="l00694"></a>00694       <span class="comment">/* bail out if we need to hangup */</span>
<a name="l00695"></a>00695       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) {
<a name="l00696"></a>00696          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;ast_check_hangup returned true on chan %s\n&quot;</span>, chan-&gt;name);
<a name="l00697"></a>00697          <span class="keywordflow">break</span>;
<a name="l00698"></a>00698       }
<a name="l00699"></a>00699       <span class="comment">/* retrieve a command</span>
<a name="l00700"></a>00700 <span class="comment">         (commands are added via the manager or the cli threads) */</span>
<a name="l00701"></a>00701       cmd = <a class="code" href="res__agi_8c.html#adff9e0250880d89a311bdbdd7b33ed88">get_agi_cmd</a>(chan);
<a name="l00702"></a>00702       <span class="keywordflow">if</span> (cmd) {
<a name="l00703"></a>00703          <span class="comment">/* OK, we have a command, let&apos;s call the</span>
<a name="l00704"></a>00704 <span class="comment">            command handler. */</span>
<a name="l00705"></a>00705          res = <a class="code" href="res__agi_8c.html#ac9faf2222a97b9abbab8430992c8da2f">agi_handle_command</a>(chan, &amp;async_agi, cmd-&gt;<a class="code" href="structagi__cmd.html#a3fe154717b79d32dd6366ce4b0cb6b38">cmd_buffer</a>, 0);
<a name="l00706"></a>00706          <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00707"></a>00707             <a class="code" href="res__agi_8c.html#aeb2a37e60e82e5519f36a120c2bae28e">free_agi_cmd</a>(cmd);
<a name="l00708"></a>00708             <span class="keywordflow">break</span>;
<a name="l00709"></a>00709          }
<a name="l00710"></a>00710          <span class="comment">/* the command handler must have written to our fake</span>
<a name="l00711"></a>00711 <span class="comment">            AGI struct fd (the pipe), let&apos;s read the response */</span>
<a name="l00712"></a>00712          res = read(fds[0], agi_buffer, <a class="code" href="res__agi_8c.html#aa2bed8203ffc925f64cf3b48cd3a2910">AGI_BUF_SIZE</a>);
<a name="l00713"></a>00713          <span class="keywordflow">if</span> (!res) {
<a name="l00714"></a>00714             returnstatus = <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00715"></a>00715             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;failed to read from AsyncAGI pipe on channel %s\n&quot;</span>, chan-&gt;name);
<a name="l00716"></a>00716             <a class="code" href="res__agi_8c.html#aeb2a37e60e82e5519f36a120c2bae28e">free_agi_cmd</a>(cmd);
<a name="l00717"></a>00717             <span class="keywordflow">break</span>;
<a name="l00718"></a>00718          }
<a name="l00719"></a>00719          <span class="comment">/* we have a response, let&apos;s send the response thru the</span>
<a name="l00720"></a>00720 <span class="comment">            manager. Include the CommandID if it was specified</span>
<a name="l00721"></a>00721 <span class="comment">            when the command was added */</span>
<a name="l00722"></a>00722          agi_buffer[res] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00723"></a>00723          <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(agi_buffer, ami_buffer, <a class="code" href="res__agi_8c.html#a1bf7e6988af21440def19908daafd708">AMI_BUF_SIZE</a>, 1);
<a name="l00724"></a>00724          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cmd-&gt;<a class="code" href="structagi__cmd.html#a550a7cedad446097b6e55bbd744412b1">cmd_id</a>))
<a name="l00725"></a>00725             <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ac7370fe764f1305cdb3c543d3964d5ed">EVENT_FLAG_AGI</a>, <span class="stringliteral">&quot;AsyncAGI&quot;</span>, <span class="stringliteral">&quot;SubEvent: Exec\r\nChannel: %s\r\nResult: %s\r\n&quot;</span>, chan-&gt;name, ami_buffer);
<a name="l00726"></a>00726          <span class="keywordflow">else</span>
<a name="l00727"></a>00727             <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ac7370fe764f1305cdb3c543d3964d5ed">EVENT_FLAG_AGI</a>, <span class="stringliteral">&quot;AsyncAGI&quot;</span>, <span class="stringliteral">&quot;SubEvent: Exec\r\nChannel: %s\r\nCommandID: %s\r\nResult: %s\r\n&quot;</span>, chan-&gt;name, cmd-&gt;<a class="code" href="structagi__cmd.html#a550a7cedad446097b6e55bbd744412b1">cmd_id</a>, ami_buffer);
<a name="l00728"></a>00728          <a class="code" href="res__agi_8c.html#aeb2a37e60e82e5519f36a120c2bae28e">free_agi_cmd</a>(cmd);
<a name="l00729"></a>00729       } <span class="keywordflow">else</span> {
<a name="l00730"></a>00730          <span class="comment">/* no command so far, wait a bit for a frame to read */</span>
<a name="l00731"></a>00731          res = <a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, timeout);
<a name="l00732"></a>00732          <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00733"></a>00733             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;ast_waitfor returned &lt;= 0 on chan %s\n&quot;</span>, chan-&gt;name);
<a name="l00734"></a>00734             <span class="keywordflow">break</span>;
<a name="l00735"></a>00735          }
<a name="l00736"></a>00736          <span class="keywordflow">if</span> (res == 0)
<a name="l00737"></a>00737             <span class="keywordflow">continue</span>;
<a name="l00738"></a>00738          f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan);
<a name="l00739"></a>00739          <span class="keywordflow">if</span> (!f) {
<a name="l00740"></a>00740             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;No frame read on channel %s, going out ...\n&quot;</span>, chan-&gt;name);
<a name="l00741"></a>00741             returnstatus = <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a3efef4607e59ada98318f948f398d8fe">AGI_RESULT_HANGUP</a>;
<a name="l00742"></a>00742             <span class="keywordflow">break</span>;
<a name="l00743"></a>00743          }
<a name="l00744"></a>00744          <span class="comment">/* is there any other frame we should care about</span>
<a name="l00745"></a>00745 <span class="comment">            besides AST_CONTROL_HANGUP? */</span>
<a name="l00746"></a>00746          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a> &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa7dac1c1896ab418c2ff351aae707fba">AST_CONTROL_HANGUP</a>) {
<a name="l00747"></a>00747             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Got HANGUP frame on channel %s, going out ...\n&quot;</span>, chan-&gt;name);
<a name="l00748"></a>00748             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00749"></a>00749             <span class="keywordflow">break</span>;
<a name="l00750"></a>00750          }
<a name="l00751"></a>00751          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00752"></a>00752       }
<a name="l00753"></a>00753    }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755    <span class="keywordflow">if</span> (async_agi.<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>) {
<a name="l00756"></a>00756       <a class="code" href="speech_8h.html#a7ebc9d3250a75a2cb7ee2f7c15eb8228" title="Destroy a speech structure.">ast_speech_destroy</a>(async_agi.<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>);
<a name="l00757"></a>00757    }
<a name="l00758"></a>00758 <a class="code" href="pbx__gtkconsole_8c.html#a1a178011116b4794df2c3dd41be5e9ed">quit</a>:
<a name="l00759"></a>00759    <span class="comment">/* notify manager users this channel cannot be</span>
<a name="l00760"></a>00760 <span class="comment">      controlled anymore by Async AGI */</span>
<a name="l00761"></a>00761    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ac7370fe764f1305cdb3c543d3964d5ed">EVENT_FLAG_AGI</a>, <span class="stringliteral">&quot;AsyncAGI&quot;</span>, <span class="stringliteral">&quot;SubEvent: End\r\nChannel: %s\r\n&quot;</span>, chan-&gt;name);
<a name="l00762"></a>00762 
<a name="l00763"></a>00763    <span class="comment">/* close the pipe */</span>
<a name="l00764"></a>00764    close(fds[0]);
<a name="l00765"></a>00765    close(fds[1]);
<a name="l00766"></a>00766 
<a name="l00767"></a>00767    <span class="comment">/* intentionally don&apos;t get rid of the datastore. So commands can be</span>
<a name="l00768"></a>00768 <span class="comment">      still in the queue in case AsyncAGI gets called again.</span>
<a name="l00769"></a>00769 <span class="comment">      Datastore destructor will be called on channel destroy anyway  */</span>
<a name="l00770"></a>00770 
<a name="l00771"></a>00771    <span class="keywordflow">return</span> returnstatus;
<a name="l00772"></a>00772 
<a name="l00773"></a>00773 <span class="preprocessor">#undef AGI_BUF_SIZE</span>
<a name="l00774"></a>00774 <span class="preprocessor"></span><span class="preprocessor">#undef AMI_BUF_SIZE</span>
<a name="l00775"></a>00775 <span class="preprocessor"></span>}
<a name="l00776"></a>00776 
<a name="l00777"></a>00777 <span class="comment">/* launch_netscript: The fastagi handler.</span>
<a name="l00778"></a>00778 <span class="comment">   FastAGI defaults to port 4573 */</span>
<a name="l00779"></a><a class="code" href="res__agi_8c.html#a9d461b14f56d2069489239192a391446">00779</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1">agi_result</a> <a class="code" href="res__agi_8c.html#a9d461b14f56d2069489239192a391446">launch_netscript</a>(<span class="keywordtype">char</span> *agiurl, <span class="keywordtype">char</span> *argv[], <span class="keywordtype">int</span> *fds, <span class="keywordtype">int</span> *efd, <span class="keywordtype">int</span> *opid)
<a name="l00780"></a>00780 {
<a name="l00781"></a>00781    <span class="keywordtype">int</span> <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, flags, res, port = <a class="code" href="res__agi_8c.html#acc5c6270557bf6ddf0ddf1952d9c600a">AGI_PORT</a>;
<a name="l00782"></a>00782    <span class="keyword">struct </span>pollfd pfds[1];
<a name="l00783"></a>00783    <span class="keywordtype">char</span> *host, *c, *script = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00784"></a>00784    <span class="keyword">struct </span>sockaddr_in addr_in;
<a name="l00785"></a>00785    <span class="keyword">struct </span>hostent *<a class="code" href="chan__skinny_8c.html#aa0f575fa3882aa394cc287edba645a35">hp</a>;
<a name="l00786"></a>00786    <span class="keyword">struct </span><a class="code" href="structast__hostent.html">ast_hostent</a> ahp;
<a name="l00787"></a>00787 
<a name="l00788"></a>00788    <span class="comment">/* agiusl is &quot;agi://host.domain[:port][/script/name]&quot; */</span>
<a name="l00789"></a>00789    host = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(agiurl + 6);  <span class="comment">/* Remove agi:// */</span>
<a name="l00790"></a>00790    <span class="comment">/* Strip off any script name */</span>
<a name="l00791"></a>00791    <span class="keywordflow">if</span> ((c = strchr(host, <span class="charliteral">&apos;/&apos;</span>))) {
<a name="l00792"></a>00792       *c = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00793"></a>00793       c++;
<a name="l00794"></a>00794       script = c;
<a name="l00795"></a>00795    }
<a name="l00796"></a>00796    <span class="keywordflow">if</span> ((c = strchr(host, <span class="charliteral">&apos;:&apos;</span>))) {
<a name="l00797"></a>00797       *c = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00798"></a>00798       c++;
<a name="l00799"></a>00799       port = atoi(c);
<a name="l00800"></a>00800    }
<a name="l00801"></a>00801    <span class="keywordflow">if</span> (efd) {
<a name="l00802"></a>00802       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;AGI URI&apos;s don&apos;t support Enhanced AGI yet\n&quot;</span>);
<a name="l00803"></a>00803       <span class="keywordflow">return</span> -1;
<a name="l00804"></a>00804    }
<a name="l00805"></a>00805    <span class="keywordflow">if</span> (!(hp = <a class="code" href="utils_8h.html#ad3b63ee1041593219ef0765b28d70442" title="Thread-safe gethostbyname function to use in Asterisk.">ast_gethostbyname</a>(host, &amp;ahp))) {
<a name="l00806"></a>00806       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to locate host &apos;%s&apos;\n&quot;</span>, host);
<a name="l00807"></a>00807       <span class="keywordflow">return</span> -1;
<a name="l00808"></a>00808    }
<a name="l00809"></a>00809    <span class="keywordflow">if</span> ((s = socket(AF_INET, SOCK_STREAM, 0)) &lt; 0) {
<a name="l00810"></a>00810       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create socket: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00811"></a>00811       <span class="keywordflow">return</span> -1;
<a name="l00812"></a>00812    }
<a name="l00813"></a>00813    <span class="keywordflow">if</span> ((flags = fcntl(s, F_GETFL)) &lt; 0) {
<a name="l00814"></a>00814       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Fcntl(F_GETFL) failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00815"></a>00815       close(s);
<a name="l00816"></a>00816       <span class="keywordflow">return</span> -1;
<a name="l00817"></a>00817    }
<a name="l00818"></a>00818    <span class="keywordflow">if</span> (fcntl(s, F_SETFL, flags | O_NONBLOCK) &lt; 0) {
<a name="l00819"></a>00819       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Fnctl(F_SETFL) failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00820"></a>00820       close(s);
<a name="l00821"></a>00821       <span class="keywordflow">return</span> -1;
<a name="l00822"></a>00822    }
<a name="l00823"></a>00823    memset(&amp;addr_in, 0, <span class="keyword">sizeof</span>(addr_in));
<a name="l00824"></a>00824    addr_in.sin_family = AF_INET;
<a name="l00825"></a>00825    addr_in.sin_port = htons(port);
<a name="l00826"></a>00826    memcpy(&amp;addr_in.sin_addr, hp-&gt;h_addr, <span class="keyword">sizeof</span>(addr_in.sin_addr));
<a name="l00827"></a>00827    <span class="keywordflow">if</span> (connect(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr_in, <span class="keyword">sizeof</span>(addr_in)) &amp;&amp; (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EINPROGRESS)) {
<a name="l00828"></a>00828       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Connect failed with unexpected error: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00829"></a>00829       close(s);
<a name="l00830"></a>00830       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00831"></a>00831    }
<a name="l00832"></a>00832 
<a name="l00833"></a>00833    pfds[0].fd = s;
<a name="l00834"></a>00834    pfds[0].events = POLLOUT;
<a name="l00835"></a>00835    <span class="keywordflow">while</span> ((res = <a class="code" href="poll-compat_8h.html#a5a0c58fa8311e94cd0ed34382aa822f9">ast_poll</a>(pfds, 1, <a class="code" href="res__agi_8c.html#a7b35d7eb31c6eba73c2e1fb493621d7c">MAX_AGI_CONNECT</a>)) != 1) {
<a name="l00836"></a>00836       <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EINTR) {
<a name="l00837"></a>00837          <span class="keywordflow">if</span> (!res) {
<a name="l00838"></a>00838             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;FastAGI connection to &apos;%s&apos; timed out after MAX_AGI_CONNECT (%d) milliseconds.\n&quot;</span>,
<a name="l00839"></a>00839                agiurl, <a class="code" href="res__agi_8c.html#a7b35d7eb31c6eba73c2e1fb493621d7c">MAX_AGI_CONNECT</a>);
<a name="l00840"></a>00840          } <span class="keywordflow">else</span>
<a name="l00841"></a>00841             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Connect to &apos;%s&apos; failed: %s\n&quot;</span>, agiurl, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00842"></a>00842          close(s);
<a name="l00843"></a>00843          <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00844"></a>00844       }
<a name="l00845"></a>00845    }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847    <span class="keywordflow">if</span> (<a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(s, NULL, <span class="stringliteral">&quot;agi_network: yes\n&quot;</span>) &lt; 0) {
<a name="l00848"></a>00848       <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EINTR) {
<a name="l00849"></a>00849          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Connect to &apos;%s&apos; failed: %s\n&quot;</span>, agiurl, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00850"></a>00850          close(s);
<a name="l00851"></a>00851          <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00852"></a>00852       }
<a name="l00853"></a>00853    }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855    <span class="comment">/* If we have a script parameter, relay it to the fastagi server */</span>
<a name="l00856"></a>00856    <span class="comment">/* Script parameters take the form of: AGI(agi://my.example.com/?extension=${EXTEN}) */</span>
<a name="l00857"></a>00857    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(script))
<a name="l00858"></a>00858       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(s, NULL, <span class="stringliteral">&quot;agi_network_script: %s\n&quot;</span>, script);
<a name="l00859"></a>00859 
<a name="l00860"></a>00860    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;Wow, connected!\n&quot;</span>);
<a name="l00861"></a>00861    fds[0] = s;
<a name="l00862"></a>00862    fds[1] = s;
<a name="l00863"></a>00863    *opid = -1;
<a name="l00864"></a>00864    <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1aac30d4ae19361cc243414b0ec32cbb78">AGI_RESULT_SUCCESS_FAST</a>;
<a name="l00865"></a>00865 }
<a name="l00866"></a>00866 
<a name="l00867"></a><a class="code" href="res__agi_8c.html#ac400fa6a1c0082145b9e21b6c12b002a">00867</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1">agi_result</a> <a class="code" href="res__agi_8c.html#ac400fa6a1c0082145b9e21b6c12b002a">launch_script</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> *script, <span class="keywordtype">char</span> *argv[], <span class="keywordtype">int</span> *fds, <span class="keywordtype">int</span> *efd, <span class="keywordtype">int</span> *opid)
<a name="l00868"></a>00868 {
<a name="l00869"></a>00869    <span class="keywordtype">char</span> tmp[256];
<a name="l00870"></a>00870    <span class="keywordtype">int</span> pid, toast[2], fromast[2], audio[2], res;
<a name="l00871"></a>00871    <span class="keyword">struct </span>stat st;
<a name="l00872"></a>00872 
<a name="l00873"></a>00873    <span class="keywordflow">if</span> (!strncasecmp(script, <span class="stringliteral">&quot;agi://&quot;</span>, 6))
<a name="l00874"></a>00874       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#a9d461b14f56d2069489239192a391446">launch_netscript</a>(script, argv, fds, efd, opid);
<a name="l00875"></a>00875    <span class="keywordflow">if</span> (!strncasecmp(script, <span class="stringliteral">&quot;agi:async&quot;</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">&quot;agi:async&quot;</span>)-1))
<a name="l00876"></a>00876       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#af2be964118127fcbb3cca296c2a3252c">launch_asyncagi</a>(chan, argv, efd);
<a name="l00877"></a>00877 
<a name="l00878"></a>00878    <span class="keywordflow">if</span> (script[0] != <span class="charliteral">&apos;/&apos;</span>) {
<a name="l00879"></a>00879       snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="paths_8h.html#a9b39aef5b661559fc470307cb315a417">ast_config_AST_AGI_DIR</a>, script);
<a name="l00880"></a>00880       script = tmp;
<a name="l00881"></a>00881    }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883    <span class="comment">/* Before even trying let&apos;s see if the file actually exists */</span>
<a name="l00884"></a>00884    <span class="keywordflow">if</span> (stat(script, &amp;st)) {
<a name="l00885"></a>00885       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to execute &apos;%s&apos;: File does not exist.\n&quot;</span>, script);
<a name="l00886"></a>00886       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1ac0f8286bb33122eee66cbe710f3f5ada">AGI_RESULT_NOTFOUND</a>;
<a name="l00887"></a>00887    }
<a name="l00888"></a>00888 
<a name="l00889"></a>00889    <span class="keywordflow">if</span> (pipe(toast)) {
<a name="l00890"></a>00890       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create toast pipe: %s\n&quot;</span>,strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00891"></a>00891       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00892"></a>00892    }
<a name="l00893"></a>00893    <span class="keywordflow">if</span> (pipe(fromast)) {
<a name="l00894"></a>00894       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;unable to create fromast pipe: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00895"></a>00895       close(toast[0]);
<a name="l00896"></a>00896       close(toast[1]);
<a name="l00897"></a>00897       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00898"></a>00898    }
<a name="l00899"></a>00899    <span class="keywordflow">if</span> (efd) {
<a name="l00900"></a>00900       <span class="keywordflow">if</span> (pipe(audio)) {
<a name="l00901"></a>00901          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;unable to create audio pipe: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00902"></a>00902          close(fromast[0]);
<a name="l00903"></a>00903          close(fromast[1]);
<a name="l00904"></a>00904          close(toast[0]);
<a name="l00905"></a>00905          close(toast[1]);
<a name="l00906"></a>00906          <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00907"></a>00907       }
<a name="l00908"></a>00908       res = fcntl(audio[1], F_GETFL);
<a name="l00909"></a>00909       <span class="keywordflow">if</span> (res &gt; -1)
<a name="l00910"></a>00910          res = fcntl(audio[1], F_SETFL, res | O_NONBLOCK);
<a name="l00911"></a>00911       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00912"></a>00912          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;unable to set audio pipe parameters: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00913"></a>00913          close(fromast[0]);
<a name="l00914"></a>00914          close(fromast[1]);
<a name="l00915"></a>00915          close(toast[0]);
<a name="l00916"></a>00916          close(toast[1]);
<a name="l00917"></a>00917          close(audio[0]);
<a name="l00918"></a>00918          close(audio[1]);
<a name="l00919"></a>00919          <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00920"></a>00920       }
<a name="l00921"></a>00921    }
<a name="l00922"></a>00922 
<a name="l00923"></a>00923    <span class="keywordflow">if</span> ((pid = <a class="code" href="app_8h.html#a7a4c7e208ffc4d11a1918beb0e920ec0" title="Common routine to safely fork without a chance of a signal handler firing badly in...">ast_safe_fork</a>(1)) &lt; 0) {
<a name="l00924"></a>00924       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to fork(): %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00925"></a>00925       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l00926"></a>00926    }
<a name="l00927"></a>00927    <span class="keywordflow">if</span> (!pid) {
<a name="l00928"></a>00928       <span class="comment">/* Pass paths to AGI via environmental variables */</span>
<a name="l00929"></a>00929       <a class="code" href="agi_2strcompat_8c.html#a1c8b16a3abcb4dc450a0a62b42c554dd">setenv</a>(<span class="stringliteral">&quot;AST_CONFIG_DIR&quot;</span>, <a class="code" href="paths_8h.html#a7d3836e5581e433c9f5edd30300cc187">ast_config_AST_CONFIG_DIR</a>, 1);
<a name="l00930"></a>00930       <a class="code" href="agi_2strcompat_8c.html#a1c8b16a3abcb4dc450a0a62b42c554dd">setenv</a>(<span class="stringliteral">&quot;AST_CONFIG_FILE&quot;</span>, <a class="code" href="paths_8h.html#adea5f0a0a8720d1dbb47ca434fe78778">ast_config_AST_CONFIG_FILE</a>, 1);
<a name="l00931"></a>00931       <a class="code" href="agi_2strcompat_8c.html#a1c8b16a3abcb4dc450a0a62b42c554dd">setenv</a>(<span class="stringliteral">&quot;AST_MODULE_DIR&quot;</span>, <a class="code" href="paths_8h.html#a5852d8e3bf5485c09b0f3d2c2375eec3">ast_config_AST_MODULE_DIR</a>, 1);
<a name="l00932"></a>00932       <a class="code" href="agi_2strcompat_8c.html#a1c8b16a3abcb4dc450a0a62b42c554dd">setenv</a>(<span class="stringliteral">&quot;AST_SPOOL_DIR&quot;</span>, <a class="code" href="paths_8h.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">ast_config_AST_SPOOL_DIR</a>, 1);
<a name="l00933"></a>00933       <a class="code" href="agi_2strcompat_8c.html#a1c8b16a3abcb4dc450a0a62b42c554dd">setenv</a>(<span class="stringliteral">&quot;AST_MONITOR_DIR&quot;</span>, <a class="code" href="paths_8h.html#ae8b54021bf362dc04d5783fa3b4b4abd">ast_config_AST_MONITOR_DIR</a>, 1);
<a name="l00934"></a>00934       <a class="code" href="agi_2strcompat_8c.html#a1c8b16a3abcb4dc450a0a62b42c554dd">setenv</a>(<span class="stringliteral">&quot;AST_VAR_DIR&quot;</span>, <a class="code" href="paths_8h.html#ab6e1cd3d774ab1b31836a8777d3a812d">ast_config_AST_VAR_DIR</a>, 1);
<a name="l00935"></a>00935       <a class="code" href="agi_2strcompat_8c.html#a1c8b16a3abcb4dc450a0a62b42c554dd">setenv</a>(<span class="stringliteral">&quot;AST_DATA_DIR&quot;</span>, <a class="code" href="paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a>, 1);
<a name="l00936"></a>00936       <a class="code" href="agi_2strcompat_8c.html#a1c8b16a3abcb4dc450a0a62b42c554dd">setenv</a>(<span class="stringliteral">&quot;AST_LOG_DIR&quot;</span>, <a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a>, 1);
<a name="l00937"></a>00937       <a class="code" href="agi_2strcompat_8c.html#a1c8b16a3abcb4dc450a0a62b42c554dd">setenv</a>(<span class="stringliteral">&quot;AST_AGI_DIR&quot;</span>, <a class="code" href="paths_8h.html#a9b39aef5b661559fc470307cb315a417">ast_config_AST_AGI_DIR</a>, 1);
<a name="l00938"></a>00938       <a class="code" href="agi_2strcompat_8c.html#a1c8b16a3abcb4dc450a0a62b42c554dd">setenv</a>(<span class="stringliteral">&quot;AST_KEY_DIR&quot;</span>, <a class="code" href="paths_8h.html#a0334adace37c0e8de8ea89c8651336a2">ast_config_AST_KEY_DIR</a>, 1);
<a name="l00939"></a>00939       <a class="code" href="agi_2strcompat_8c.html#a1c8b16a3abcb4dc450a0a62b42c554dd">setenv</a>(<span class="stringliteral">&quot;AST_RUN_DIR&quot;</span>, <a class="code" href="paths_8h.html#a6014e29009d7db30e546a244c2cc95b6">ast_config_AST_RUN_DIR</a>, 1);
<a name="l00940"></a>00940 
<a name="l00941"></a>00941       <span class="comment">/* Don&apos;t run AGI scripts with realtime priority -- it causes audio stutter */</span>
<a name="l00942"></a>00942       <a class="code" href="asterisk_8h.html#ad649acedd512a45c748a440e78a281c9" title="We set ourselves to a high priority, that we might pre-empt everything else. If your...">ast_set_priority</a>(0);
<a name="l00943"></a>00943 
<a name="l00944"></a>00944       <span class="comment">/* Redirect stdin and out, provide enhanced audio channel if desired */</span>
<a name="l00945"></a>00945       dup2(fromast[0], STDIN_FILENO);
<a name="l00946"></a>00946       dup2(toast[1], STDOUT_FILENO);
<a name="l00947"></a>00947       <span class="keywordflow">if</span> (efd)
<a name="l00948"></a>00948          dup2(audio[0], STDERR_FILENO + 1);
<a name="l00949"></a>00949       <span class="keywordflow">else</span>
<a name="l00950"></a>00950          close(STDERR_FILENO + 1);
<a name="l00951"></a>00951 
<a name="l00952"></a>00952       <span class="comment">/* Close everything but stdin/out/error */</span>
<a name="l00953"></a>00953       <a class="code" href="app_8h.html#afcbfdd6dfc8c5f0f549b0a5d7e263e97" title="Common routine for child processes, to close all fds prior to exec(2).">ast_close_fds_above_n</a>(STDERR_FILENO + 1);
<a name="l00954"></a>00954 
<a name="l00955"></a>00955       <span class="comment">/* Execute script */</span>
<a name="l00956"></a>00956       <span class="comment">/* XXX argv should be deprecated in favor of passing agi_argX paramaters */</span>
<a name="l00957"></a>00957       execv(script, argv);
<a name="l00958"></a>00958       <span class="comment">/* Can&apos;t use ast_log since FD&apos;s are closed */</span>
<a name="l00959"></a>00959       <a class="code" href="logger_8h.html#abe937354501761e17f2d2163d1f8ac87">ast_child_verbose</a>(1, <span class="stringliteral">&quot;Failed to execute &apos;%s&apos;: %s&quot;</span>, script, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00960"></a>00960       <span class="comment">/* Special case to set status of AGI to failure */</span>
<a name="l00961"></a>00961       fprintf(stdout, <span class="stringliteral">&quot;failure\n&quot;</span>);
<a name="l00962"></a>00962       fflush(stdout);
<a name="l00963"></a>00963       _exit(1);
<a name="l00964"></a>00964    }
<a name="l00965"></a>00965    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Launched AGI Script %s\n&quot;</span>, script);
<a name="l00966"></a>00966    fds[0] = toast[0];
<a name="l00967"></a>00967    fds[1] = fromast[1];
<a name="l00968"></a>00968    <span class="keywordflow">if</span> (efd)
<a name="l00969"></a>00969       *efd = audio[1];
<a name="l00970"></a>00970    <span class="comment">/* close what we&apos;re not using in the parent */</span>
<a name="l00971"></a>00971    close(toast[1]);
<a name="l00972"></a>00972    close(fromast[0]);
<a name="l00973"></a>00973 
<a name="l00974"></a>00974    <span class="keywordflow">if</span> (efd)
<a name="l00975"></a>00975       close(audio[0]);
<a name="l00976"></a>00976 
<a name="l00977"></a>00977    *opid = pid;
<a name="l00978"></a>00978    <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a493daf1d6c06bbf4b17b36929cc51fd8">AGI_RESULT_SUCCESS</a>;
<a name="l00979"></a>00979 }
<a name="l00980"></a>00980 
<a name="l00981"></a><a class="code" href="res__agi_8c.html#a1a91f6f01be62db91c4a91250f3d513d">00981</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__agi_8c.html#a1a91f6f01be62db91c4a91250f3d513d">setup_env</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> *request, <span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> enhanced, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00982"></a>00982 {
<a name="l00983"></a>00983    <span class="keywordtype">int</span> count;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985    <span class="comment">/* Print initial environment, with agi_request always being the first</span>
<a name="l00986"></a>00986 <span class="comment">      thing */</span>
<a name="l00987"></a>00987    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_request: %s\n&quot;</span>, request);
<a name="l00988"></a>00988    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_channel: %s\n&quot;</span>, chan-&gt;name);
<a name="l00989"></a>00989    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_language: %s\n&quot;</span>, chan-&gt;language);
<a name="l00990"></a>00990    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_type: %s\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a>);
<a name="l00991"></a>00991    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_uniqueid: %s\n&quot;</span>, chan-&gt;uniqueid);
<a name="l00992"></a>00992    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_version: %s\n&quot;</span>, <a class="code" href="ast__version_8h.html#a7765c608aea948584928643ab3963b2a" title="Retrieve the Asterisk version string.">ast_get_version</a>());
<a name="l00993"></a>00993 
<a name="l00994"></a>00994    <span class="comment">/* ANI/DNIS */</span>
<a name="l00995"></a>00995    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_callerid: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;unknown&quot;</span>));
<a name="l00996"></a>00996    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_calleridname: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;unknown&quot;</span>));
<a name="l00997"></a>00997    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_callingpres: %d\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a5674af3fa5ce1dd1fe052be1477d4110">cid_pres</a>);
<a name="l00998"></a>00998    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_callingani2: %d\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a9540aaac76be952860ef25d607eb33fb">cid_ani2</a>);
<a name="l00999"></a>00999    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_callington: %d\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aff456ca48d31a9813584e799064cf88e">cid_ton</a>);
<a name="l01000"></a>01000    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_callingtns: %d\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aae7e57d784da2bfe6b85cb36516edca0">cid_tns</a>);
<a name="l01001"></a>01001    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_dnid: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aa54ab157f47ac529034d524781e2a7e2">cid_dnid</a>, <span class="stringliteral">&quot;unknown&quot;</span>));
<a name="l01002"></a>01002    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_rdnis: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a4791c5f3aedc8782678867a1741f4131">cid_rdnis</a>, <span class="stringliteral">&quot;unknown&quot;</span>));
<a name="l01003"></a>01003 
<a name="l01004"></a>01004    <span class="comment">/* Context information */</span>
<a name="l01005"></a>01005    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_context: %s\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l01006"></a>01006    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_extension: %s\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>);
<a name="l01007"></a>01007    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_priority: %d\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l01008"></a>01008    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_enhanced: %s\n&quot;</span>, enhanced ? <span class="stringliteral">&quot;1.0&quot;</span> : <span class="stringliteral">&quot;0.0&quot;</span>);
<a name="l01009"></a>01009 
<a name="l01010"></a>01010    <span class="comment">/* User information */</span>
<a name="l01011"></a>01011    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_accountcode: %s\n&quot;</span>, chan-&gt;accountcode ? chan-&gt;accountcode : <span class="stringliteral">&quot;&quot;</span>);
<a name="l01012"></a>01012    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_threadid: %ld\n&quot;</span>, (<span class="keywordtype">long</span>)pthread_self());
<a name="l01013"></a>01013 
<a name="l01014"></a>01014    <span class="comment">/* Send any parameters to the fastagi server that have been passed via the agi application */</span>
<a name="l01015"></a>01015    <span class="comment">/* Agi application paramaters take the form of: AGI(/path/to/example/script|${EXTEN}) */</span>
<a name="l01016"></a>01016    <span class="keywordflow">for</span>(count = 1; count &lt; argc; count++)
<a name="l01017"></a>01017       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;agi_arg_%d: %s\n&quot;</span>, count, argv[count]);
<a name="l01018"></a>01018 
<a name="l01019"></a>01019    <span class="comment">/* End with empty return */</span>
<a name="l01020"></a>01020    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(fd, chan, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01021"></a>01021 }
<a name="l01022"></a>01022 
<a name="l01023"></a><a class="code" href="res__agi_8c.html#afe5c19dc69f816c4f76553ca8d2b6f20">01023</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#afe5c19dc69f816c4f76553ca8d2b6f20">handle_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01024"></a>01024 {
<a name="l01025"></a>01025    <span class="keywordtype">int</span> res = 0;
<a name="l01026"></a>01026 
<a name="l01027"></a>01027    <span class="comment">/* Answer the channel */</span>
<a name="l01028"></a>01028    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)
<a name="l01029"></a>01029       res = <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l01030"></a>01030 
<a name="l01031"></a>01031    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01032"></a>01032    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01033"></a>01033 }
<a name="l01034"></a>01034 
<a name="l01035"></a><a class="code" href="res__agi_8c.html#a51738a4a076899d4ba624791cbd0ab98">01035</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a51738a4a076899d4ba624791cbd0ab98">handle_asyncagi_break</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01036"></a>01036 {
<a name="l01037"></a>01037    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l01038"></a>01038    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01039"></a>01039 }
<a name="l01040"></a>01040 
<a name="l01041"></a><a class="code" href="res__agi_8c.html#adc0a2ed0bc1cb5489b1cdbd4ef5e87cc">01041</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#adc0a2ed0bc1cb5489b1cdbd4ef5e87cc">handle_waitfordigit</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01042"></a>01042 {
<a name="l01043"></a>01043    <span class="keywordtype">int</span> res, to;
<a name="l01044"></a>01044 
<a name="l01045"></a>01045    <span class="keywordflow">if</span> (argc != 4)
<a name="l01046"></a>01046       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01047"></a>01047    <span class="keywordflow">if</span> (sscanf(argv[3], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;to) != 1)
<a name="l01048"></a>01048       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01049"></a>01049    res = <a class="code" href="channel_8h.html#af4725a9cfbacf4db094408fe1406f0ef" title="Wait for a digit Same as ast_waitfordigit() with audio fd for outputting read audio...">ast_waitfordigit_full</a>(chan, to, agi-&gt;<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>);
<a name="l01050"></a>01050    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01051"></a>01051    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01052"></a>01052 }
<a name="l01053"></a>01053 
<a name="l01054"></a><a class="code" href="res__agi_8c.html#a71153bd075d3ba38ae33e7f6b8038650">01054</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a71153bd075d3ba38ae33e7f6b8038650">handle_sendtext</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01055"></a>01055 {
<a name="l01056"></a>01056    <span class="keywordtype">int</span> res;
<a name="l01057"></a>01057 
<a name="l01058"></a>01058    <span class="keywordflow">if</span> (argc != 3)
<a name="l01059"></a>01059       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01060"></a>01060 
<a name="l01061"></a>01061    <span class="comment">/* At the moment, the parser (perhaps broken) returns with</span>
<a name="l01062"></a>01062 <span class="comment">      the last argument PLUS the newline at the end of the input</span>
<a name="l01063"></a>01063 <span class="comment">      buffer. This probably needs to be fixed, but I wont do that</span>
<a name="l01064"></a>01064 <span class="comment">      because other stuff may break as a result. The right way</span>
<a name="l01065"></a>01065 <span class="comment">      would probably be to strip off the trailing newline before</span>
<a name="l01066"></a>01066 <span class="comment">      parsing, then here, add a newline at the end of the string</span>
<a name="l01067"></a>01067 <span class="comment">      before sending it to ast_sendtext --DUDE */</span>
<a name="l01068"></a>01068    res = <a class="code" href="channel_8h.html#a83631e0dc02a50802cf857caa3fdc1d7" title="Sends text to a channel.">ast_sendtext</a>(chan, argv[2]);
<a name="l01069"></a>01069    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01070"></a>01070    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01071"></a>01071 }
<a name="l01072"></a>01072 
<a name="l01073"></a><a class="code" href="res__agi_8c.html#a866c844d1c95c6551c49b81570f6468e">01073</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a866c844d1c95c6551c49b81570f6468e">handle_recvchar</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01074"></a>01074 {
<a name="l01075"></a>01075    <span class="keywordtype">int</span> res;
<a name="l01076"></a>01076 
<a name="l01077"></a>01077    <span class="keywordflow">if</span> (argc != 3)
<a name="l01078"></a>01078       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01079"></a>01079 
<a name="l01080"></a>01080    res = <a class="code" href="channel_8h.html#a5d6470615a8701722e9d3c6c6fca01d0" title="Receives a text character from a channel.">ast_recvchar</a>(chan,atoi(argv[2]));
<a name="l01081"></a>01081    <span class="keywordflow">if</span> (res == 0) {
<a name="l01082"></a>01082       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d (timeout)\n&quot;</span>, res);
<a name="l01083"></a>01083       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01084"></a>01084    }
<a name="l01085"></a>01085    <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l01086"></a>01086       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01087"></a>01087       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01088"></a>01088    }
<a name="l01089"></a>01089    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d (hangup)\n&quot;</span>, res);
<a name="l01090"></a>01090    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01091"></a>01091 }
<a name="l01092"></a>01092 
<a name="l01093"></a><a class="code" href="res__agi_8c.html#a83e64425b9d0b626c30409ca3543f4fb">01093</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a83e64425b9d0b626c30409ca3543f4fb">handle_recvtext</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01094"></a>01094 {
<a name="l01095"></a>01095    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l01096"></a>01096 
<a name="l01097"></a>01097    <span class="keywordflow">if</span> (argc != 3)
<a name="l01098"></a>01098       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01099"></a>01099 
<a name="l01100"></a>01100    buf = <a class="code" href="channel_8h.html#abb507e6b148bf773fb546ac5c931f264" title="Receives a text string from a channel Read a string of text from a channel.">ast_recvtext</a>(chan, atoi(argv[2]));
<a name="l01101"></a>01101    <span class="keywordflow">if</span> (buf) {
<a name="l01102"></a>01102       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1 (%s)\n&quot;</span>, buf);
<a name="l01103"></a>01103       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buf);
<a name="l01104"></a>01104    } <span class="keywordflow">else</span> {
<a name="l01105"></a>01105       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=-1\n&quot;</span>);
<a name="l01106"></a>01106    }
<a name="l01107"></a>01107    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01108"></a>01108 }
<a name="l01109"></a>01109 
<a name="l01110"></a><a class="code" href="res__agi_8c.html#a7649d1dc982e052d5f8afdf07e68e01a">01110</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a7649d1dc982e052d5f8afdf07e68e01a">handle_tddmode</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01111"></a>01111 {
<a name="l01112"></a>01112    <span class="keywordtype">int</span> res, x;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114    <span class="keywordflow">if</span> (argc != 3)
<a name="l01115"></a>01115       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01116"></a>01116 
<a name="l01117"></a>01117    <span class="keywordflow">if</span> (!strncasecmp(argv[2],<span class="stringliteral">&quot;on&quot;</span>,2)) {
<a name="l01118"></a>01118       x = 1;
<a name="l01119"></a>01119    } <span class="keywordflow">else</span>  {
<a name="l01120"></a>01120       x = 0;
<a name="l01121"></a>01121    }
<a name="l01122"></a>01122    <span class="keywordflow">if</span> (!strncasecmp(argv[2],<span class="stringliteral">&quot;mate&quot;</span>,4))  {
<a name="l01123"></a>01123       x = 2;
<a name="l01124"></a>01124    }
<a name="l01125"></a>01125    <span class="keywordflow">if</span> (!strncasecmp(argv[2],<span class="stringliteral">&quot;tdd&quot;</span>,3)) {
<a name="l01126"></a>01126       x = 1;
<a name="l01127"></a>01127    }
<a name="l01128"></a>01128    res = <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(chan, <a class="code" href="frame_8h.html#aa27da183a0551e3f9497a8064e24b0b6">AST_OPTION_TDD</a>, &amp;x, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 0);
<a name="l01129"></a>01129    <span class="keywordflow">if</span> (res != <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>) {
<a name="l01130"></a>01130       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l01131"></a>01131    } <span class="keywordflow">else</span> {
<a name="l01132"></a>01132       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l01133"></a>01133    }
<a name="l01134"></a>01134    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01135"></a>01135 }
<a name="l01136"></a>01136 
<a name="l01137"></a><a class="code" href="res__agi_8c.html#ae356fce1531686c8dee319ecf327fbde">01137</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ae356fce1531686c8dee319ecf327fbde">handle_sendimage</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01138"></a>01138 {
<a name="l01139"></a>01139    <span class="keywordtype">int</span> res;
<a name="l01140"></a>01140 
<a name="l01141"></a>01141    <span class="keywordflow">if</span> (argc != 3) {
<a name="l01142"></a>01142       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01143"></a>01143    }
<a name="l01144"></a>01144 
<a name="l01145"></a>01145    res = <a class="code" href="image_8h.html#af93445907a412f2fa3e8add93a296b1f" title="Sends an image.">ast_send_image</a>(chan, argv[2]);
<a name="l01146"></a>01146    <span class="keywordflow">if</span> (!<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) {
<a name="l01147"></a>01147       res = 0;
<a name="l01148"></a>01148    }
<a name="l01149"></a>01149    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01150"></a>01150    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01151"></a>01151 }
<a name="l01152"></a>01152 
<a name="l01153"></a><a class="code" href="res__agi_8c.html#a372e9e6882d7691f1bcabe1f1022ad77">01153</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a372e9e6882d7691f1bcabe1f1022ad77">handle_controlstreamfile</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01154"></a>01154 {
<a name="l01155"></a>01155    <span class="keywordtype">int</span> res = 0, <a class="code" href="app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">skipms</a> = 3000;
<a name="l01156"></a>01156    <span class="keywordtype">char</span> *fwd = <span class="stringliteral">&quot;#&quot;</span>, *rev = <span class="stringliteral">&quot;*&quot;</span>, *suspend = NULL, *<a class="code" href="res__ais_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a> = NULL; <span class="comment">/* Default values */</span>
<a name="l01157"></a>01157 
<a name="l01158"></a>01158    <span class="keywordflow">if</span> (argc &lt; 5 || argc &gt; 9) {
<a name="l01159"></a>01159       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01160"></a>01160    }
<a name="l01161"></a>01161 
<a name="l01162"></a>01162    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(argv[4])) {
<a name="l01163"></a>01163       stop = argv[4];
<a name="l01164"></a>01164    }
<a name="l01165"></a>01165 
<a name="l01166"></a>01166    <span class="keywordflow">if</span> ((argc &gt; 5) &amp;&amp; (sscanf(argv[5], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;<a class="code" href="app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">skipms</a>) != 1)) {
<a name="l01167"></a>01167       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01168"></a>01168    }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170    <span class="keywordflow">if</span> (argc &gt; 6 &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(argv[6])) {
<a name="l01171"></a>01171       fwd = argv[6];
<a name="l01172"></a>01172    }
<a name="l01173"></a>01173 
<a name="l01174"></a>01174    <span class="keywordflow">if</span> (argc &gt; 7 &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(argv[7])) {
<a name="l01175"></a>01175       rev = argv[7];
<a name="l01176"></a>01176    }
<a name="l01177"></a>01177 
<a name="l01178"></a>01178    <span class="keywordflow">if</span> (argc &gt; 8 &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(argv[8])) {
<a name="l01179"></a>01179       suspend = argv[8];
<a name="l01180"></a>01180    }
<a name="l01181"></a>01181 
<a name="l01182"></a>01182    res = <a class="code" href="app_8h.html#a3405b1282cefdceebba734b8e756c55d" title="Stream a file with fast forward, pause, reverse, restart.">ast_control_streamfile</a>(chan, argv[3], fwd, rev, stop, suspend, NULL, <a class="code" href="app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">skipms</a>, NULL);
<a name="l01183"></a>01183 
<a name="l01184"></a>01184    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01185"></a>01185 
<a name="l01186"></a>01186    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01187"></a>01187 }
<a name="l01188"></a>01188 
<a name="l01189"></a><a class="code" href="res__agi_8c.html#aff6ffa19d4e9193b102f700a8b6a8c72">01189</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#aff6ffa19d4e9193b102f700a8b6a8c72">handle_streamfile</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01190"></a>01190 {
<a name="l01191"></a>01191    <span class="keywordtype">int</span> res, vres;
<a name="l01192"></a>01192    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs, *<a class="code" href="structast__filestream.html#a084d8f087c50442f51245ec3333abac4">vfs</a>;
<a name="l01193"></a>01193    <span class="keywordtype">long</span> sample_offset = 0, max_length;
<a name="l01194"></a>01194    <span class="keywordtype">char</span> *edigits = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01195"></a>01195 
<a name="l01196"></a>01196    <span class="keywordflow">if</span> (argc &lt; 4 || argc &gt; 5)
<a name="l01197"></a>01197       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01198"></a>01198 
<a name="l01199"></a>01199    <span class="keywordflow">if</span> (argv[3])
<a name="l01200"></a>01200       edigits = argv[3];
<a name="l01201"></a>01201 
<a name="l01202"></a>01202    <span class="keywordflow">if</span> ((argc &gt; 4) &amp;&amp; (sscanf(argv[4], <span class="stringliteral">&quot;%30ld&quot;</span>, &amp;sample_offset) != 1))
<a name="l01203"></a>01203       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01204"></a>01204 
<a name="l01205"></a>01205    <span class="keywordflow">if</span> (!(fs = <a class="code" href="file_8h.html#ad85c951fa1d6988d2d7e169833a951a8" title="Opens stream for use in seeking, playing.">ast_openstream</a>(chan, argv[2], chan-&gt;language))) {
<a name="l01206"></a>01206       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d endpos=%ld\n&quot;</span>, 0, sample_offset);
<a name="l01207"></a>01207       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01208"></a>01208    }
<a name="l01209"></a>01209 
<a name="l01210"></a>01210    <span class="keywordflow">if</span> ((vfs = <a class="code" href="file_8h.html#aeed49fff2d6008a89f996230988d944d" title="Opens stream for use in seeking, playing.">ast_openvstream</a>(chan, argv[2], chan-&gt;language)))
<a name="l01211"></a>01211       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Ooh, found a video stream, too\n&quot;</span>);
<a name="l01212"></a>01212 
<a name="l01213"></a>01213    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Playing &apos;%s&apos; (escape_digits=%s) (sample_offset %ld)\n&quot;</span>, argv[2], edigits, sample_offset);
<a name="l01214"></a>01214 
<a name="l01215"></a>01215    <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(fs, 0, SEEK_END);
<a name="l01216"></a>01216    max_length = <a class="code" href="file_8h.html#a01771a318e7adea51499040f27b4278a" title="Tell where we are in a stream.">ast_tellstream</a>(fs);
<a name="l01217"></a>01217    <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(fs, sample_offset, SEEK_SET);
<a name="l01218"></a>01218    res = <a class="code" href="file_8h.html#a618e3120b6d019312ef2d617d9f14571" title="Applys a open stream to a channel.">ast_applystream</a>(chan, fs);
<a name="l01219"></a>01219    <span class="keywordflow">if</span> (vfs)
<a name="l01220"></a>01220       vres = <a class="code" href="file_8h.html#a618e3120b6d019312ef2d617d9f14571" title="Applys a open stream to a channel.">ast_applystream</a>(chan, vfs);
<a name="l01221"></a>01221    <a class="code" href="file_8h.html#ad59224750b8b617f9590b28b88457b14" title="Play a open stream on a channel.">ast_playstream</a>(fs);
<a name="l01222"></a>01222    <span class="keywordflow">if</span> (vfs)
<a name="l01223"></a>01223       <a class="code" href="file_8h.html#ad59224750b8b617f9590b28b88457b14" title="Play a open stream on a channel.">ast_playstream</a>(vfs);
<a name="l01224"></a>01224 
<a name="l01225"></a>01225    res = <a class="code" href="file_8h.html#a3089874cd5223053f670c8499e911ec4">ast_waitstream_full</a>(chan, argv[3], agi-&gt;<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>);
<a name="l01226"></a>01226    <span class="comment">/* this is to check for if ast_waitstream closed the stream, we probably are at</span>
<a name="l01227"></a>01227 <span class="comment">    * the end of the stream, return that amount, else check for the amount */</span>
<a name="l01228"></a>01228    sample_offset = (chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>) ? <a class="code" href="file_8h.html#a01771a318e7adea51499040f27b4278a" title="Tell where we are in a stream.">ast_tellstream</a>(fs) : max_length;
<a name="l01229"></a>01229    <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l01230"></a>01230    <span class="keywordflow">if</span> (res == 1) {
<a name="l01231"></a>01231       <span class="comment">/* Stop this command, don&apos;t print a result line, as there is a new command */</span>
<a name="l01232"></a>01232       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01233"></a>01233    }
<a name="l01234"></a>01234    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d endpos=%ld\n&quot;</span>, res, sample_offset);
<a name="l01235"></a>01235    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01236"></a>01236 }
<a name="l01237"></a>01237 <span class="comment"></span>
<a name="l01238"></a>01238 <span class="comment">/*! \brief get option - really similar to the handle_streamfile, but with a timeout */</span>
<a name="l01239"></a><a class="code" href="res__agi_8c.html#ad336eed63ffe88efeafeb588afc7313b">01239</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ad336eed63ffe88efeafeb588afc7313b" title="get option - really similar to the handle_streamfile, but with a timeout">handle_getoption</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01240"></a>01240 {
<a name="l01241"></a>01241    <span class="keywordtype">int</span> res, vres;
<a name="l01242"></a>01242    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs, *<a class="code" href="structast__filestream.html#a084d8f087c50442f51245ec3333abac4">vfs</a>;
<a name="l01243"></a>01243    <span class="keywordtype">long</span> sample_offset = 0, max_length;
<a name="l01244"></a>01244    <span class="keywordtype">int</span> timeout = 0;
<a name="l01245"></a>01245    <span class="keywordtype">char</span> *edigits = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01246"></a>01246 
<a name="l01247"></a>01247    <span class="keywordflow">if</span> ( argc &lt; 4 || argc &gt; 5 )
<a name="l01248"></a>01248       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01249"></a>01249 
<a name="l01250"></a>01250    <span class="keywordflow">if</span> ( argv[3] )
<a name="l01251"></a>01251       edigits = argv[3];
<a name="l01252"></a>01252 
<a name="l01253"></a>01253    <span class="keywordflow">if</span> ( argc == 5 )
<a name="l01254"></a>01254       timeout = atoi(argv[4]);
<a name="l01255"></a>01255    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a>) {
<a name="l01256"></a>01256       <span class="comment">/* by default dtimeout is set to 5sec */</span>
<a name="l01257"></a>01257       timeout = chan-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a>; <span class="comment">/* in msec */</span>
<a name="l01258"></a>01258    }
<a name="l01259"></a>01259 
<a name="l01260"></a>01260    <span class="keywordflow">if</span> (!(fs = <a class="code" href="file_8h.html#ad85c951fa1d6988d2d7e169833a951a8" title="Opens stream for use in seeking, playing.">ast_openstream</a>(chan, argv[2], chan-&gt;language))) {
<a name="l01261"></a>01261       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d endpos=%ld\n&quot;</span>, 0, sample_offset);
<a name="l01262"></a>01262       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open %s\n&quot;</span>, argv[2]);
<a name="l01263"></a>01263       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01264"></a>01264    }
<a name="l01265"></a>01265 
<a name="l01266"></a>01266    <span class="keywordflow">if</span> ((vfs = <a class="code" href="file_8h.html#aeed49fff2d6008a89f996230988d944d" title="Opens stream for use in seeking, playing.">ast_openvstream</a>(chan, argv[2], chan-&gt;language)))
<a name="l01267"></a>01267       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Ooh, found a video stream, too\n&quot;</span>);
<a name="l01268"></a>01268 
<a name="l01269"></a>01269    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Playing &apos;%s&apos; (escape_digits=%s) (timeout %d)\n&quot;</span>, argv[2], edigits, timeout);
<a name="l01270"></a>01270 
<a name="l01271"></a>01271    <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(fs, 0, SEEK_END);
<a name="l01272"></a>01272    max_length = <a class="code" href="file_8h.html#a01771a318e7adea51499040f27b4278a" title="Tell where we are in a stream.">ast_tellstream</a>(fs);
<a name="l01273"></a>01273    <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(fs, sample_offset, SEEK_SET);
<a name="l01274"></a>01274    res = <a class="code" href="file_8h.html#a618e3120b6d019312ef2d617d9f14571" title="Applys a open stream to a channel.">ast_applystream</a>(chan, fs);
<a name="l01275"></a>01275    <span class="keywordflow">if</span> (vfs)
<a name="l01276"></a>01276       vres = <a class="code" href="file_8h.html#a618e3120b6d019312ef2d617d9f14571" title="Applys a open stream to a channel.">ast_applystream</a>(chan, vfs);
<a name="l01277"></a>01277    <a class="code" href="file_8h.html#ad59224750b8b617f9590b28b88457b14" title="Play a open stream on a channel.">ast_playstream</a>(fs);
<a name="l01278"></a>01278    <span class="keywordflow">if</span> (vfs)
<a name="l01279"></a>01279       <a class="code" href="file_8h.html#ad59224750b8b617f9590b28b88457b14" title="Play a open stream on a channel.">ast_playstream</a>(vfs);
<a name="l01280"></a>01280 
<a name="l01281"></a>01281    res = <a class="code" href="file_8h.html#a3089874cd5223053f670c8499e911ec4">ast_waitstream_full</a>(chan, argv[3], agi-&gt;<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>);
<a name="l01282"></a>01282    <span class="comment">/* this is to check for if ast_waitstream closed the stream, we probably are at</span>
<a name="l01283"></a>01283 <span class="comment">    * the end of the stream, return that amount, else check for the amount */</span>
<a name="l01284"></a>01284    sample_offset = (chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>)?<a class="code" href="file_8h.html#a01771a318e7adea51499040f27b4278a" title="Tell where we are in a stream.">ast_tellstream</a>(fs):max_length;
<a name="l01285"></a>01285    <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l01286"></a>01286    <span class="keywordflow">if</span> (res == 1) {
<a name="l01287"></a>01287       <span class="comment">/* Stop this command, don&apos;t print a result line, as there is a new command */</span>
<a name="l01288"></a>01288       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01289"></a>01289    }
<a name="l01290"></a>01290 
<a name="l01291"></a>01291    <span class="comment">/* If the user didnt press a key, wait for digitTimeout*/</span>
<a name="l01292"></a>01292    <span class="keywordflow">if</span> (res == 0 ) {
<a name="l01293"></a>01293       res = <a class="code" href="channel_8h.html#af4725a9cfbacf4db094408fe1406f0ef" title="Wait for a digit Same as ast_waitfordigit() with audio fd for outputting read audio...">ast_waitfordigit_full</a>(chan, timeout, agi-&gt;<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>);
<a name="l01294"></a>01294       <span class="comment">/* Make sure the new result is in the escape digits of the GET OPTION */</span>
<a name="l01295"></a>01295       <span class="keywordflow">if</span> ( !strchr(edigits,res) )
<a name="l01296"></a>01296          res=0;
<a name="l01297"></a>01297    }
<a name="l01298"></a>01298 
<a name="l01299"></a>01299    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d endpos=%ld\n&quot;</span>, res, sample_offset);
<a name="l01300"></a>01300    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01301"></a>01301 }
<a name="l01302"></a>01302 
<a name="l01303"></a>01303 
<a name="l01304"></a>01304 
<a name="l01305"></a>01305 <span class="comment"></span>
<a name="l01306"></a>01306 <span class="comment">/*! \brief Say number in various language syntaxes */</span>
<a name="l01307"></a>01307 <span class="comment">/* While waiting, we&apos;re sending a NULL.  */</span>
<a name="l01308"></a><a class="code" href="res__agi_8c.html#a4e230af03a45bed22262f047f2ffe07c">01308</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a4e230af03a45bed22262f047f2ffe07c" title="Say number in various language syntaxes.">handle_saynumber</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01309"></a>01309 {
<a name="l01310"></a>01310    <span class="keywordtype">int</span> res, <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>;
<a name="l01311"></a>01311 
<a name="l01312"></a>01312    <span class="keywordflow">if</span> (argc &lt; 4 || argc &gt; 5)
<a name="l01313"></a>01313       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01314"></a>01314    <span class="keywordflow">if</span> (sscanf(argv[2], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;num) != 1)
<a name="l01315"></a>01315       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01316"></a>01316    res = <a class="code" href="say_8h.html#af2f2a53bc36d82082a80daebac5d9d0f">ast_say_number_full</a>(chan, num, argv[3], chan-&gt;language, argc &gt; 4 ? argv[4] : NULL, agi-&gt;<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>);
<a name="l01317"></a>01317    <span class="keywordflow">if</span> (res == 1)
<a name="l01318"></a>01318       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01319"></a>01319    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01320"></a>01320    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01321"></a>01321 }
<a name="l01322"></a>01322 
<a name="l01323"></a><a class="code" href="res__agi_8c.html#a754118d4d92df25df6938380ba397675">01323</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a754118d4d92df25df6938380ba397675">handle_saydigits</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01324"></a>01324 {
<a name="l01325"></a>01325    <span class="keywordtype">int</span> res, <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>;
<a name="l01326"></a>01326 
<a name="l01327"></a>01327    <span class="keywordflow">if</span> (argc != 4)
<a name="l01328"></a>01328       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01329"></a>01329    <span class="keywordflow">if</span> (sscanf(argv[2], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;num) != 1)
<a name="l01330"></a>01330       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01331"></a>01331 
<a name="l01332"></a>01332    res = <a class="code" href="say_8h.html#a921b263824a296812f264716e68ab129">ast_say_digit_str_full</a>(chan, argv[2], argv[3], chan-&gt;language, agi-&gt;<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>);
<a name="l01333"></a>01333    <span class="keywordflow">if</span> (res == 1) <span class="comment">/* New command */</span>
<a name="l01334"></a>01334       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01335"></a>01335    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01336"></a>01336    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01337"></a>01337 }
<a name="l01338"></a>01338 
<a name="l01339"></a><a class="code" href="res__agi_8c.html#afaa4473133532930dea75eed6cf2c301">01339</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#afaa4473133532930dea75eed6cf2c301">handle_sayalpha</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01340"></a>01340 {
<a name="l01341"></a>01341    <span class="keywordtype">int</span> res;
<a name="l01342"></a>01342 
<a name="l01343"></a>01343    <span class="keywordflow">if</span> (argc != 4)
<a name="l01344"></a>01344       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01345"></a>01345 
<a name="l01346"></a>01346    res = <a class="code" href="say_8h.html#ade1ca4dd1fef967c239d62fad0795332">ast_say_character_str_full</a>(chan, argv[2], argv[3], chan-&gt;language, agi-&gt;<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>);
<a name="l01347"></a>01347    <span class="keywordflow">if</span> (res == 1) <span class="comment">/* New command */</span>
<a name="l01348"></a>01348       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01349"></a>01349    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01350"></a>01350    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01351"></a>01351 }
<a name="l01352"></a>01352 
<a name="l01353"></a><a class="code" href="res__agi_8c.html#a7c2126dcf54cbc49d261a6bb35af26f7">01353</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a7c2126dcf54cbc49d261a6bb35af26f7">handle_saydate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01354"></a>01354 {
<a name="l01355"></a>01355    <span class="keywordtype">int</span> res, <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>;
<a name="l01356"></a>01356 
<a name="l01357"></a>01357    <span class="keywordflow">if</span> (argc != 4)
<a name="l01358"></a>01358       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01359"></a>01359    <span class="keywordflow">if</span> (sscanf(argv[2], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;num) != 1)
<a name="l01360"></a>01360       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01361"></a>01361    res = <a class="code" href="say_8h.html#a521f1068d36ad21d7c67d28287d18aad">ast_say_date</a>(chan, num, argv[3], chan-&gt;language);
<a name="l01362"></a>01362    <span class="keywordflow">if</span> (res == 1)
<a name="l01363"></a>01363       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01364"></a>01364    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01365"></a>01365    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01366"></a>01366 }
<a name="l01367"></a>01367 
<a name="l01368"></a><a class="code" href="res__agi_8c.html#a0e5a9125fe9315646e18af0dda940367">01368</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a0e5a9125fe9315646e18af0dda940367">handle_saytime</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01369"></a>01369 {
<a name="l01370"></a>01370    <span class="keywordtype">int</span> res, <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>;
<a name="l01371"></a>01371 
<a name="l01372"></a>01372    <span class="keywordflow">if</span> (argc != 4)
<a name="l01373"></a>01373       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01374"></a>01374    <span class="keywordflow">if</span> (sscanf(argv[2], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;num) != 1)
<a name="l01375"></a>01375       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01376"></a>01376    res = <a class="code" href="say_8h.html#a8f8b5df12bf05242a5dfad6dd73065a7">ast_say_time</a>(chan, num, argv[3], chan-&gt;language);
<a name="l01377"></a>01377    <span class="keywordflow">if</span> (res == 1)
<a name="l01378"></a>01378       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01379"></a>01379    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01380"></a>01380    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01381"></a>01381 }
<a name="l01382"></a>01382 
<a name="l01383"></a><a class="code" href="res__agi_8c.html#ab71e48111abdbd828dbb95bbeed5fd9c">01383</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ab71e48111abdbd828dbb95bbeed5fd9c">handle_saydatetime</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01384"></a>01384 {
<a name="l01385"></a>01385    <span class="keywordtype">int</span> res = 0;
<a name="l01386"></a>01386    time_t unixtime;
<a name="l01387"></a>01387    <span class="keywordtype">char</span> *<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, *zone = NULL;
<a name="l01388"></a>01388 
<a name="l01389"></a>01389    <span class="keywordflow">if</span> (argc &lt; 4)
<a name="l01390"></a>01390       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01391"></a>01391 
<a name="l01392"></a>01392    <span class="keywordflow">if</span> (argc &gt; 4) {
<a name="l01393"></a>01393       format = argv[4];
<a name="l01394"></a>01394    } <span class="keywordflow">else</span> {
<a name="l01395"></a>01395       <span class="comment">/* XXX this doesn&apos;t belong here, but in the &apos;say&apos; module */</span>
<a name="l01396"></a>01396       <span class="keywordflow">if</span> (!strcasecmp(chan-&gt;language, <span class="stringliteral">&quot;de&quot;</span>)) {
<a name="l01397"></a>01397          format = <span class="stringliteral">&quot;A dBY HMS&quot;</span>;
<a name="l01398"></a>01398       } <span class="keywordflow">else</span> {
<a name="l01399"></a>01399          format = <span class="stringliteral">&quot;ABdY &apos;digits/at&apos; IMp&quot;</span>;
<a name="l01400"></a>01400       }
<a name="l01401"></a>01401    }
<a name="l01402"></a>01402 
<a name="l01403"></a>01403    <span class="keywordflow">if</span> (argc &gt; 5 &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(argv[5]))
<a name="l01404"></a>01404       zone = argv[5];
<a name="l01405"></a>01405 
<a name="l01406"></a>01406    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a3b5457e5f5679935093d94b0f788769e" title="get values from config variables.">ast_get_time_t</a>(argv[2], &amp;unixtime, 0, NULL))
<a name="l01407"></a>01407       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01408"></a>01408 
<a name="l01409"></a>01409    res = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>(chan, unixtime, argv[3], chan-&gt;language, format, zone);
<a name="l01410"></a>01410    <span class="keywordflow">if</span> (res == 1)
<a name="l01411"></a>01411       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01412"></a>01412 
<a name="l01413"></a>01413    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01414"></a>01414    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01415"></a>01415 }
<a name="l01416"></a>01416 
<a name="l01417"></a><a class="code" href="res__agi_8c.html#a10bb90c656d717992f9071582a5d9378">01417</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a10bb90c656d717992f9071582a5d9378">handle_sayphonetic</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01418"></a>01418 {
<a name="l01419"></a>01419    <span class="keywordtype">int</span> res;
<a name="l01420"></a>01420 
<a name="l01421"></a>01421    <span class="keywordflow">if</span> (argc != 4)
<a name="l01422"></a>01422       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01423"></a>01423 
<a name="l01424"></a>01424    res = <a class="code" href="say_8h.html#ae361dc17d977422a2fffcb661f8a9a09">ast_say_phonetic_str_full</a>(chan, argv[2], argv[3], chan-&gt;language, agi-&gt;<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>);
<a name="l01425"></a>01425    <span class="keywordflow">if</span> (res == 1) <span class="comment">/* New command */</span>
<a name="l01426"></a>01426       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01427"></a>01427    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01428"></a>01428    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01429"></a>01429 }
<a name="l01430"></a>01430 
<a name="l01431"></a><a class="code" href="res__agi_8c.html#a5c46b8157087eb4c448264b980767b1f">01431</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a5c46b8157087eb4c448264b980767b1f">handle_getdata</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01432"></a>01432 {
<a name="l01433"></a>01433    <span class="keywordtype">int</span> res, max, timeout;
<a name="l01434"></a>01434    <span class="keywordtype">char</span> data[1024];
<a name="l01435"></a>01435 
<a name="l01436"></a>01436    <span class="keywordflow">if</span> (argc &lt; 3)
<a name="l01437"></a>01437       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01438"></a>01438    <span class="keywordflow">if</span> (argc &gt;= 4)
<a name="l01439"></a>01439       timeout = atoi(argv[3]);
<a name="l01440"></a>01440    <span class="keywordflow">else</span>
<a name="l01441"></a>01441       timeout = 0;
<a name="l01442"></a>01442    <span class="keywordflow">if</span> (argc &gt;= 5)
<a name="l01443"></a>01443       max = atoi(argv[4]);
<a name="l01444"></a>01444    <span class="keywordflow">else</span>
<a name="l01445"></a>01445       max = 1024;
<a name="l01446"></a>01446    res = <a class="code" href="app_8h.html#a9fc880ff0cd0b42ef6212b43deb4b98f" title="Full version with audiofd and controlfd. NOTE: returns &amp;#39;2&amp;#39; on ctrlfd available...">ast_app_getdata_full</a>(chan, argv[2], data, max, timeout, agi-&gt;<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>);
<a name="l01447"></a>01447    <span class="keywordflow">if</span> (res == 2)        <span class="comment">/* New command */</span>
<a name="l01448"></a>01448       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01449"></a>01449    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == 1)
<a name="l01450"></a>01450       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%s (timeout)\n&quot;</span>, data);
<a name="l01451"></a>01451    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &lt; 0 )
<a name="l01452"></a>01452       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=-1\n&quot;</span>);
<a name="l01453"></a>01453    <span class="keywordflow">else</span>
<a name="l01454"></a>01454       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%s\n&quot;</span>, data);
<a name="l01455"></a>01455    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01456"></a>01456 }
<a name="l01457"></a>01457 
<a name="l01458"></a><a class="code" href="res__agi_8c.html#ae65221b6965dabc63f4d61e881d21bc2">01458</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ae65221b6965dabc63f4d61e881d21bc2">handle_setcontext</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01459"></a>01459 {
<a name="l01460"></a>01460 
<a name="l01461"></a>01461    <span class="keywordflow">if</span> (argc != 3)
<a name="l01462"></a>01462       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01463"></a>01463    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, argv[2], <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l01464"></a>01464    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l01465"></a>01465    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01466"></a>01466 }
<a name="l01467"></a>01467 
<a name="l01468"></a><a class="code" href="res__agi_8c.html#a1be98b425c01f5782fc734060fac7b86">01468</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a1be98b425c01f5782fc734060fac7b86">handle_setextension</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01469"></a>01469 {
<a name="l01470"></a>01470    <span class="keywordflow">if</span> (argc != 3)
<a name="l01471"></a>01471       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01472"></a>01472    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, argv[2], <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l01473"></a>01473    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l01474"></a>01474    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01475"></a>01475 }
<a name="l01476"></a>01476 
<a name="l01477"></a><a class="code" href="res__agi_8c.html#a89a5c005b9bba62bec6c26c20a760d1e">01477</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a89a5c005b9bba62bec6c26c20a760d1e">handle_setpriority</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01478"></a>01478 {
<a name="l01479"></a>01479    <span class="keywordtype">int</span> pri;
<a name="l01480"></a>01480 
<a name="l01481"></a>01481    <span class="keywordflow">if</span> (argc != 3)
<a name="l01482"></a>01482       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01483"></a>01483 
<a name="l01484"></a>01484    <span class="keywordflow">if</span> (sscanf(argv[2], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;pri) != 1) {
<a name="l01485"></a>01485       <span class="keywordflow">if</span> ((pri = <a class="code" href="pbx_8h.html#a0be9518646cf9aca4878b313cc02e901" title="Find the priority of an extension that has the specified label.">ast_findlabel_extension</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, argv[2], chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) &lt; 1)
<a name="l01486"></a>01486          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01487"></a>01487    }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489    <a class="code" href="pbx_8h.html#a9f840db4b5ef461ac2c0c975a57c9e89">ast_explicit_goto</a>(chan, NULL, NULL, pri);
<a name="l01490"></a>01490    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l01491"></a>01491    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01492"></a>01492 }
<a name="l01493"></a>01493 
<a name="l01494"></a><a class="code" href="res__agi_8c.html#a66b879cca37c8e5deb34986dbb6ff144">01494</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a66b879cca37c8e5deb34986dbb6ff144">handle_recordfile</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01495"></a>01495 {
<a name="l01496"></a>01496    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs;
<a name="l01497"></a>01497    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l01498"></a>01498    <span class="keyword">struct </span>timeval start;
<a name="l01499"></a>01499    <span class="keywordtype">long</span> sample_offset = 0;
<a name="l01500"></a>01500    <span class="keywordtype">int</span> res = 0;
<a name="l01501"></a>01501    <span class="keywordtype">int</span> ms;
<a name="l01502"></a>01502 
<a name="l01503"></a>01503    <span class="keyword">struct </span><a class="code" href="structast__dsp.html">ast_dsp</a> *sildet=NULL;         <span class="comment">/* silence detector dsp */</span>
<a name="l01504"></a>01504    <span class="keywordtype">int</span> <a class="code" href="structast__dsp.html#a37f3ccbb8c8ee286cec59a4b0340e924">totalsilence</a> = 0;
<a name="l01505"></a>01505    <span class="keywordtype">int</span> dspsilence = 0;
<a name="l01506"></a>01506    <span class="keywordtype">int</span> silence = 0;                <span class="comment">/* amount of silence to allow */</span>
<a name="l01507"></a>01507    <span class="keywordtype">int</span> gotsilence = 0;             <span class="comment">/* did we timeout for silence? */</span>
<a name="l01508"></a>01508    <span class="keywordtype">char</span> *silencestr = NULL;
<a name="l01509"></a>01509    <span class="keywordtype">int</span> rfmt = 0;
<a name="l01510"></a>01510 
<a name="l01511"></a>01511    <span class="comment">/* XXX EAGI FIXME XXX */</span>
<a name="l01512"></a>01512 
<a name="l01513"></a>01513    <span class="keywordflow">if</span> (argc &lt; 6)
<a name="l01514"></a>01514       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01515"></a>01515    <span class="keywordflow">if</span> (sscanf(argv[5], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;ms) != 1)
<a name="l01516"></a>01516       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01517"></a>01517 
<a name="l01518"></a>01518    <span class="keywordflow">if</span> (argc &gt; 6)
<a name="l01519"></a>01519       silencestr = strchr(argv[6],<span class="charliteral">&apos;s&apos;</span>);
<a name="l01520"></a>01520    <span class="keywordflow">if</span> ((argc &gt; 7) &amp;&amp; (!silencestr))
<a name="l01521"></a>01521       silencestr = strchr(argv[7],<span class="charliteral">&apos;s&apos;</span>);
<a name="l01522"></a>01522    <span class="keywordflow">if</span> ((argc &gt; 8) &amp;&amp; (!silencestr))
<a name="l01523"></a>01523       silencestr = strchr(argv[8],<span class="charliteral">&apos;s&apos;</span>);
<a name="l01524"></a>01524 
<a name="l01525"></a>01525    <span class="keywordflow">if</span> (silencestr) {
<a name="l01526"></a>01526       <span class="keywordflow">if</span> (strlen(silencestr) &gt; 2) {
<a name="l01527"></a>01527          <span class="keywordflow">if</span> ((silencestr[0] == <span class="charliteral">&apos;s&apos;</span>) &amp;&amp; (silencestr[1] == <span class="charliteral">&apos;=&apos;</span>)) {
<a name="l01528"></a>01528             silencestr++;
<a name="l01529"></a>01529             silencestr++;
<a name="l01530"></a>01530             <span class="keywordflow">if</span> (silencestr)
<a name="l01531"></a>01531                silence = atoi(silencestr);
<a name="l01532"></a>01532             <span class="keywordflow">if</span> (silence &gt; 0)
<a name="l01533"></a>01533                silence *= 1000;
<a name="l01534"></a>01534          }
<a name="l01535"></a>01535       }
<a name="l01536"></a>01536    }
<a name="l01537"></a>01537 
<a name="l01538"></a>01538    <span class="keywordflow">if</span> (silence &gt; 0) {
<a name="l01539"></a>01539       rfmt = chan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l01540"></a>01540       res = <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(chan, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>);
<a name="l01541"></a>01541       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01542"></a>01542          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set to linear mode, giving up\n&quot;</span>);
<a name="l01543"></a>01543          <span class="keywordflow">return</span> -1;
<a name="l01544"></a>01544       }
<a name="l01545"></a>01545       sildet = <a class="code" href="dsp_8h.html#a0a60e93006c8e1ca8fda922ae0e0da2c">ast_dsp_new</a>();
<a name="l01546"></a>01546       <span class="keywordflow">if</span> (!sildet) {
<a name="l01547"></a>01547          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create silence detector :(\n&quot;</span>);
<a name="l01548"></a>01548          <span class="keywordflow">return</span> -1;
<a name="l01549"></a>01549       }
<a name="l01550"></a>01550       <a class="code" href="dsp_8h.html#a06a0b883127ba1f853e9e0fa5f29d81b" title="Set threshold value for silence.">ast_dsp_set_threshold</a>(sildet, <a class="code" href="dsp_8h.html#aab28c68838eaed4e0c89460a4e554cca" title="Get silence threshold from dsp.conf.">ast_dsp_get_threshold_from_settings</a>(<a class="code" href="dsp_8h.html#a11a8ce2b7eba2230cab37aad708d9abfa40278495f8621707b864e57e1110d20f">THRESHOLD_SILENCE</a>));
<a name="l01551"></a>01551    }
<a name="l01552"></a>01552    
<a name="l01553"></a>01553    <span class="comment">/* backward compatibility, if no offset given, arg[6] would have been</span>
<a name="l01554"></a>01554 <span class="comment">    * caught below and taken to be a beep, else if it is a digit then it is a</span>
<a name="l01555"></a>01555 <span class="comment">    * offset */</span>
<a name="l01556"></a>01556    <span class="keywordflow">if</span> ((argc &gt;6) &amp;&amp; (sscanf(argv[6], <span class="stringliteral">&quot;%30ld&quot;</span>, &amp;sample_offset) != 1) &amp;&amp; (!strchr(argv[6], <span class="charliteral">&apos;=&apos;</span>)))
<a name="l01557"></a>01557       res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;beep&quot;</span>, chan-&gt;language);
<a name="l01558"></a>01558 
<a name="l01559"></a>01559    <span class="keywordflow">if</span> ((argc &gt; 7) &amp;&amp; (!strchr(argv[7], <span class="charliteral">&apos;=&apos;</span>)))
<a name="l01560"></a>01560       res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;beep&quot;</span>, chan-&gt;language);
<a name="l01561"></a>01561 
<a name="l01562"></a>01562    <span class="keywordflow">if</span> (!res)
<a name="l01563"></a>01563       res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, argv[4]);
<a name="l01564"></a>01564    <span class="keywordflow">if</span> (res) {
<a name="l01565"></a>01565       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d (randomerror) endpos=%ld\n&quot;</span>, res, sample_offset);
<a name="l01566"></a>01566    } <span class="keywordflow">else</span> {
<a name="l01567"></a>01567       fs = <a class="code" href="file_8h.html#a964f8ef393c07609d7b9e02937faed52" title="Starts writing a file.">ast_writefile</a>(argv[2], argv[3], NULL, O_CREAT | O_WRONLY | (sample_offset ? O_APPEND : 0), 0, <a class="code" href="asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>);
<a name="l01568"></a>01568       <span class="keywordflow">if</span> (!fs) {
<a name="l01569"></a>01569          res = -1;
<a name="l01570"></a>01570          <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d (writefile)\n&quot;</span>, res);
<a name="l01571"></a>01571          <span class="keywordflow">if</span> (sildet)
<a name="l01572"></a>01572             <a class="code" href="dsp_8h.html#a0a57a1e374549eb2705068688f4046db">ast_dsp_free</a>(sildet);
<a name="l01573"></a>01573          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01574"></a>01574       }
<a name="l01575"></a>01575 
<a name="l01576"></a>01576       <span class="comment">/* Request a video update */</span>
<a name="l01577"></a>01577       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a417bc8ac5817cc1525a3b530abfc1528">AST_CONTROL_VIDUPDATE</a>);
<a name="l01578"></a>01578 
<a name="l01579"></a>01579       chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> = fs;
<a name="l01580"></a>01580       <a class="code" href="file_8h.html#a618e3120b6d019312ef2d617d9f14571" title="Applys a open stream to a channel.">ast_applystream</a>(chan,fs);
<a name="l01581"></a>01581       <span class="comment">/* really should have checks */</span>
<a name="l01582"></a>01582       <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(fs, sample_offset, SEEK_SET);
<a name="l01583"></a>01583       <a class="code" href="file_8h.html#aa647ac352a00b559131f90ffffea2c3c" title="Trunc stream at current location.">ast_truncstream</a>(fs);
<a name="l01584"></a>01584 
<a name="l01585"></a>01585       start = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l01586"></a>01586       <span class="keywordflow">while</span> ((ms &lt; 0) || <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), start) &lt; ms) {
<a name="l01587"></a>01587          res = <a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, ms - <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), start));
<a name="l01588"></a>01588          <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01589"></a>01589             <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(fs);
<a name="l01590"></a>01590             <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d (waitfor) endpos=%ld\n&quot;</span>, res,sample_offset);
<a name="l01591"></a>01591             <span class="keywordflow">if</span> (sildet)
<a name="l01592"></a>01592                <a class="code" href="dsp_8h.html#a0a57a1e374549eb2705068688f4046db">ast_dsp_free</a>(sildet);
<a name="l01593"></a>01593             <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01594"></a>01594          }
<a name="l01595"></a>01595          f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan);
<a name="l01596"></a>01596          <span class="keywordflow">if</span> (!f) {
<a name="l01597"></a>01597             <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d (hangup) endpos=%ld\n&quot;</span>, -1, sample_offset);
<a name="l01598"></a>01598             <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(fs);
<a name="l01599"></a>01599             <span class="keywordflow">if</span> (sildet)
<a name="l01600"></a>01600                <a class="code" href="dsp_8h.html#a0a57a1e374549eb2705068688f4046db">ast_dsp_free</a>(sildet);
<a name="l01601"></a>01601             <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l01602"></a>01602          }
<a name="l01603"></a>01603          <span class="keywordflow">switch</span>(f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>) {
<a name="l01604"></a>01604          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>:
<a name="l01605"></a>01605             <span class="keywordflow">if</span> (strchr(argv[4], f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>)) {
<a name="l01606"></a>01606                <span class="comment">/* This is an interrupting chracter, so rewind to chop off any small</span>
<a name="l01607"></a>01607 <span class="comment">                  amount of DTMF that may have been recorded</span>
<a name="l01608"></a>01608 <span class="comment">               */</span>
<a name="l01609"></a>01609                <a class="code" href="file_8h.html#a4c7c02a659b09bb06dd63e1f42692666" title="Rewind stream ms.">ast_stream_rewind</a>(fs, 200);
<a name="l01610"></a>01610                <a class="code" href="file_8h.html#aa647ac352a00b559131f90ffffea2c3c" title="Trunc stream at current location.">ast_truncstream</a>(fs);
<a name="l01611"></a>01611                sample_offset = <a class="code" href="file_8h.html#a01771a318e7adea51499040f27b4278a" title="Tell where we are in a stream.">ast_tellstream</a>(fs);
<a name="l01612"></a>01612                <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d (dtmf) endpos=%ld\n&quot;</span>, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, sample_offset);
<a name="l01613"></a>01613                <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(fs);
<a name="l01614"></a>01614                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l01615"></a>01615                <span class="keywordflow">if</span> (sildet)
<a name="l01616"></a>01616                   <a class="code" href="dsp_8h.html#a0a57a1e374549eb2705068688f4046db">ast_dsp_free</a>(sildet);
<a name="l01617"></a>01617                <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01618"></a>01618             }
<a name="l01619"></a>01619             <span class="keywordflow">break</span>;
<a name="l01620"></a>01620          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>:
<a name="l01621"></a>01621             <a class="code" href="file_8h.html#a3608386b919ef0949d2858cdeb02d12e" title="Writes a frame to a stream.">ast_writestream</a>(fs, f);
<a name="l01622"></a>01622             <span class="comment">/* this is a safe place to check progress since we know that fs</span>
<a name="l01623"></a>01623 <span class="comment">             * is valid after a write, and it will then have our current</span>
<a name="l01624"></a>01624 <span class="comment">             * location */</span>
<a name="l01625"></a>01625             sample_offset = <a class="code" href="file_8h.html#a01771a318e7adea51499040f27b4278a" title="Tell where we are in a stream.">ast_tellstream</a>(fs);
<a name="l01626"></a>01626             <span class="keywordflow">if</span> (silence &gt; 0) {
<a name="l01627"></a>01627                dspsilence = 0;
<a name="l01628"></a>01628                <a class="code" href="dsp_8h.html#a3f3b67988bffb3addfbc8a4688fa466d" title="Return non-zero if this is silence. Updates &amp;quot;totalsilence&amp;quot; with the total...">ast_dsp_silence</a>(sildet, f, &amp;dspsilence);
<a name="l01629"></a>01629                <span class="keywordflow">if</span> (dspsilence) {
<a name="l01630"></a>01630                   totalsilence = dspsilence;
<a name="l01631"></a>01631                } <span class="keywordflow">else</span> {
<a name="l01632"></a>01632                   totalsilence = 0;
<a name="l01633"></a>01633                }
<a name="l01634"></a>01634                <span class="keywordflow">if</span> (totalsilence &gt; silence) {
<a name="l01635"></a>01635                   <span class="comment">/* Ended happily with silence */</span>
<a name="l01636"></a>01636                   gotsilence = 1;
<a name="l01637"></a>01637                   <span class="keywordflow">break</span>;
<a name="l01638"></a>01638                }
<a name="l01639"></a>01639             }
<a name="l01640"></a>01640             <span class="keywordflow">break</span>;
<a name="l01641"></a>01641          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>:
<a name="l01642"></a>01642             <a class="code" href="file_8h.html#a3608386b919ef0949d2858cdeb02d12e" title="Writes a frame to a stream.">ast_writestream</a>(fs, f);
<a name="l01643"></a>01643          <span class="keywordflow">default</span>:
<a name="l01644"></a>01644             <span class="comment">/* Ignore all other frames */</span>
<a name="l01645"></a>01645             <span class="keywordflow">break</span>;
<a name="l01646"></a>01646          }
<a name="l01647"></a>01647          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l01648"></a>01648          <span class="keywordflow">if</span> (gotsilence)
<a name="l01649"></a>01649             <span class="keywordflow">break</span>;
<a name="l01650"></a>01650       }
<a name="l01651"></a>01651 
<a name="l01652"></a>01652       <span class="keywordflow">if</span> (gotsilence) {
<a name="l01653"></a>01653          <a class="code" href="file_8h.html#a4c7c02a659b09bb06dd63e1f42692666" title="Rewind stream ms.">ast_stream_rewind</a>(fs, silence-1000);
<a name="l01654"></a>01654          <a class="code" href="file_8h.html#aa647ac352a00b559131f90ffffea2c3c" title="Trunc stream at current location.">ast_truncstream</a>(fs);
<a name="l01655"></a>01655          sample_offset = <a class="code" href="file_8h.html#a01771a318e7adea51499040f27b4278a" title="Tell where we are in a stream.">ast_tellstream</a>(fs);
<a name="l01656"></a>01656       }
<a name="l01657"></a>01657       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d (timeout) endpos=%ld\n&quot;</span>, res, sample_offset);
<a name="l01658"></a>01658       <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(fs);
<a name="l01659"></a>01659    }
<a name="l01660"></a>01660 
<a name="l01661"></a>01661    <span class="keywordflow">if</span> (silence &gt; 0) {
<a name="l01662"></a>01662       res = <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(chan, rfmt);
<a name="l01663"></a>01663       <span class="keywordflow">if</span> (res)
<a name="l01664"></a>01664          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to restore read format on &apos;%s&apos;\n&quot;</span>, chan-&gt;name);
<a name="l01665"></a>01665       <a class="code" href="dsp_8h.html#a0a57a1e374549eb2705068688f4046db">ast_dsp_free</a>(sildet);
<a name="l01666"></a>01666    }
<a name="l01667"></a>01667 
<a name="l01668"></a>01668    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01669"></a>01669 }
<a name="l01670"></a>01670 
<a name="l01671"></a><a class="code" href="res__agi_8c.html#a57d1651f16788371d53f053f5280ac0b">01671</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a57d1651f16788371d53f053f5280ac0b">handle_autohangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01672"></a>01672 {
<a name="l01673"></a>01673    <span class="keywordtype">double</span> timeout;
<a name="l01674"></a>01674    <span class="keyword">struct </span>timeval whentohangup = { 0, 0 };
<a name="l01675"></a>01675 
<a name="l01676"></a>01676    <span class="keywordflow">if</span> (argc != 3)
<a name="l01677"></a>01677       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01678"></a>01678    <span class="keywordflow">if</span> (sscanf(argv[2], <span class="stringliteral">&quot;%30lf&quot;</span>, &amp;timeout) != 1)
<a name="l01679"></a>01679       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01680"></a>01680    <span class="keywordflow">if</span> (timeout &lt; 0)
<a name="l01681"></a>01681       timeout = 0;
<a name="l01682"></a>01682    <span class="keywordflow">if</span> (timeout) {
<a name="l01683"></a>01683       whentohangup.tv_sec = timeout;
<a name="l01684"></a>01684       whentohangup.tv_usec = (timeout - whentohangup.tv_sec) * 1000000.0;
<a name="l01685"></a>01685    }
<a name="l01686"></a>01686    <a class="code" href="channel_8h.html#ac03c2ec5ac8e7a6ef9c5d92f91880927" title="Set when to hang a channel up.">ast_channel_setwhentohangup_tv</a>(chan, whentohangup);
<a name="l01687"></a>01687    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l01688"></a>01688    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01689"></a>01689 }
<a name="l01690"></a>01690 
<a name="l01691"></a><a class="code" href="res__agi_8c.html#ada29f1c23db7954bcc004090294f048e">01691</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ada29f1c23db7954bcc004090294f048e">handle_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01692"></a>01692 {
<a name="l01693"></a>01693    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c;
<a name="l01694"></a>01694 
<a name="l01695"></a>01695    <span class="keywordflow">if</span> (argc == 1) {
<a name="l01696"></a>01696       <span class="comment">/* no argument: hangup the current channel */</span>
<a name="l01697"></a>01697       <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(chan,<a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2b3b711afc65059c4b51008c9fbc7aee">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l01698"></a>01698       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l01699"></a>01699       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01700"></a>01700    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc == 2) {
<a name="l01701"></a>01701       <span class="comment">/* one argument: look for info on the specified channel */</span>
<a name="l01702"></a>01702       c = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(argv[1]);
<a name="l01703"></a>01703       <span class="keywordflow">if</span> (c) {
<a name="l01704"></a>01704          <span class="comment">/* we have a matching channel */</span>
<a name="l01705"></a>01705          <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(c,<a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2b3b711afc65059c4b51008c9fbc7aee">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l01706"></a>01706          <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l01707"></a>01707          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c);
<a name="l01708"></a>01708          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01709"></a>01709       }
<a name="l01710"></a>01710       <span class="comment">/* if we get this far no channel name matched the argument given */</span>
<a name="l01711"></a>01711       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=-1\n&quot;</span>);
<a name="l01712"></a>01712       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01713"></a>01713    } <span class="keywordflow">else</span> {
<a name="l01714"></a>01714       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01715"></a>01715    }
<a name="l01716"></a>01716 }
<a name="l01717"></a>01717 
<a name="l01718"></a><a class="code" href="res__agi_8c.html#a62164f6c04cfc139708f6a3567387123">01718</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a62164f6c04cfc139708f6a3567387123">handle_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01719"></a>01719 {
<a name="l01720"></a>01720    <span class="keywordtype">int</span> res, workaround;
<a name="l01721"></a>01721    <span class="keyword">struct </span><a class="code" href="structast__app.html" title="ast_app: A registered application">ast_app</a> *app_to_exec;
<a name="l01722"></a>01722 
<a name="l01723"></a>01723    <span class="keywordflow">if</span> (argc &lt; 2)
<a name="l01724"></a>01724       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01725"></a>01725 
<a name="l01726"></a>01726    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;AGI Script Executing Application: (%s) Options: (%s)\n&quot;</span>, argv[1], argc &gt;= 3 ? argv[2] : <span class="stringliteral">&quot;&quot;</span>);
<a name="l01727"></a>01727 
<a name="l01728"></a>01728    <span class="keywordflow">if</span> ((app_to_exec = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(argv[1]))) {
<a name="l01729"></a>01729       <span class="keywordflow">if</span>(!strcasecmp(argv[1], <a class="code" href="features_8h.html#a27355650e25223abaafd62101216f2b8">PARK_APP_NAME</a>)) {
<a name="l01730"></a>01730          <a class="code" href="features_8h.html#a70a2de2bf789996ae5e66142294ca18f" title="Park a call via a masqueraded channel.">ast_masq_park_call</a>(chan, NULL, 0, NULL);
<a name="l01731"></a>01731       }
<a name="l01732"></a>01732       <span class="keywordflow">if</span> (!(workaround = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ad3827e45a36d53f7570b8cd2ed8fad67">AST_FLAG_DISABLE_WORKAROUNDS</a>))) {
<a name="l01733"></a>01733          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ad3827e45a36d53f7570b8cd2ed8fad67">AST_FLAG_DISABLE_WORKAROUNDS</a>);
<a name="l01734"></a>01734       }
<a name="l01735"></a>01735       <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a111ff8457487144bdd2170f507229f7c">ast_compat_res_agi</a> &amp;&amp; argc &gt;= 3 &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(argv[2])) {
<a name="l01736"></a>01736          <span class="keywordtype">char</span> *compat = alloca(strlen(argv[2]) * 2 + 1), *cptr, *vptr;
<a name="l01737"></a>01737          <span class="keywordflow">for</span> (cptr = compat, vptr = argv[2]; *vptr; vptr++) {
<a name="l01738"></a>01738             <span class="keywordflow">if</span> (*vptr == <span class="charliteral">&apos;,&apos;</span>) {
<a name="l01739"></a>01739                *cptr++ = <span class="charliteral">&apos;\\&apos;</span>;
<a name="l01740"></a>01740                *cptr++ = <span class="charliteral">&apos;,&apos;</span>;
<a name="l01741"></a>01741             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*vptr == <span class="charliteral">&apos;|&apos;</span>) {
<a name="l01742"></a>01742                *cptr++ = <span class="charliteral">&apos;,&apos;</span>;
<a name="l01743"></a>01743             } <span class="keywordflow">else</span> {
<a name="l01744"></a>01744                *cptr++ = *vptr;
<a name="l01745"></a>01745             }
<a name="l01746"></a>01746          }
<a name="l01747"></a>01747          *cptr = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01748"></a>01748          res = <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(chan, app_to_exec, compat);
<a name="l01749"></a>01749       } <span class="keywordflow">else</span> {
<a name="l01750"></a>01750          res = <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(chan, app_to_exec, argc == 2 ? <span class="stringliteral">&quot;&quot;</span> : argv[2]);
<a name="l01751"></a>01751       }
<a name="l01752"></a>01752       <span class="keywordflow">if</span> (!workaround) {
<a name="l01753"></a>01753          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ad3827e45a36d53f7570b8cd2ed8fad67">AST_FLAG_DISABLE_WORKAROUNDS</a>);
<a name="l01754"></a>01754       }
<a name="l01755"></a>01755    } <span class="keywordflow">else</span> {
<a name="l01756"></a>01756       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find application (%s)\n&quot;</span>, argv[1]);
<a name="l01757"></a>01757       res = -2;
<a name="l01758"></a>01758    }
<a name="l01759"></a>01759    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, res);
<a name="l01760"></a>01760 
<a name="l01761"></a>01761    <span class="comment">/* Even though this is wrong, users are depending upon this result. */</span>
<a name="l01762"></a>01762    <span class="keywordflow">return</span> res;
<a name="l01763"></a>01763 }
<a name="l01764"></a>01764 
<a name="l01765"></a><a class="code" href="res__agi_8c.html#a9b9bb8b5320daee1cee272e0ff50b224">01765</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a9b9bb8b5320daee1cee272e0ff50b224">handle_setcallerid</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01766"></a>01766 {
<a name="l01767"></a>01767    <span class="keywordtype">char</span> tmp[256]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l01768"></a>01768    <span class="keywordtype">char</span> *l = NULL, *n = NULL;
<a name="l01769"></a>01769 
<a name="l01770"></a>01770    <span class="keywordflow">if</span> (argv[2]) {
<a name="l01771"></a>01771       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, argv[2], <span class="keyword">sizeof</span>(tmp));
<a name="l01772"></a>01772       <a class="code" href="callerid_8h.html#a39e03ca4e8df3a1d2c75e888d76201df" title="Destructively parse inbuf into name and location (or number) Parses callerid stream...">ast_callerid_parse</a>(tmp, &amp;n, &amp;l);
<a name="l01773"></a>01773       <span class="keywordflow">if</span> (l)
<a name="l01774"></a>01774          <a class="code" href="callerid_8h.html#a6a61669b28d0f994e44db5e3baab6ef2" title="Shrink a phone number in place to just digits (more accurately it just removes ()&amp;#39;s...">ast_shrink_phone_number</a>(l);
<a name="l01775"></a>01775       <span class="keywordflow">else</span>
<a name="l01776"></a>01776          l = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01777"></a>01777       <span class="keywordflow">if</span> (!n)
<a name="l01778"></a>01778          n = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01779"></a>01779       <a class="code" href="channel_8h.html#a88d833a56ea7de33e230281c5c12b75d" title="Set caller ID number, name and ANI.">ast_set_callerid</a>(chan, l, n, NULL);
<a name="l01780"></a>01780    }
<a name="l01781"></a>01781 
<a name="l01782"></a>01782    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l01783"></a>01783    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01784"></a>01784 }
<a name="l01785"></a>01785 
<a name="l01786"></a><a class="code" href="res__agi_8c.html#a6c290a2d507657929ba5bfe06d823631">01786</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a6c290a2d507657929ba5bfe06d823631">handle_channelstatus</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01787"></a>01787 {
<a name="l01788"></a>01788    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c;
<a name="l01789"></a>01789    <span class="keywordflow">if</span> (argc == 2) {
<a name="l01790"></a>01790       <span class="comment">/* no argument: supply info on the current channel */</span>
<a name="l01791"></a>01791       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a>);
<a name="l01792"></a>01792       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01793"></a>01793    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc == 3) {
<a name="l01794"></a>01794       <span class="comment">/* one argument: look for info on the specified channel */</span>
<a name="l01795"></a>01795       c = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(argv[2]);
<a name="l01796"></a>01796       <span class="keywordflow">if</span> (c) {
<a name="l01797"></a>01797          <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%d\n&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a>);
<a name="l01798"></a>01798          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c);
<a name="l01799"></a>01799          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01800"></a>01800       }
<a name="l01801"></a>01801       <span class="comment">/* if we get this far no channel name matched the argument given */</span>
<a name="l01802"></a>01802       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=-1\n&quot;</span>);
<a name="l01803"></a>01803       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01804"></a>01804    } <span class="keywordflow">else</span> {
<a name="l01805"></a>01805       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01806"></a>01806    }
<a name="l01807"></a>01807 }
<a name="l01808"></a>01808 
<a name="l01809"></a><a class="code" href="res__agi_8c.html#a17db4294de5b3dc66985210146dfaa63">01809</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a17db4294de5b3dc66985210146dfaa63">handle_setvariable</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01810"></a>01810 {
<a name="l01811"></a>01811    <span class="keywordflow">if</span> (argv[3])
<a name="l01812"></a>01812       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, argv[2], argv[3]);
<a name="l01813"></a>01813 
<a name="l01814"></a>01814    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l01815"></a>01815    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01816"></a>01816 }
<a name="l01817"></a>01817 
<a name="l01818"></a><a class="code" href="res__agi_8c.html#ac6275c707a3d7deab5971022228bfc2e">01818</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ac6275c707a3d7deab5971022228bfc2e">handle_getvariable</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01819"></a>01819 {
<a name="l01820"></a>01820    <span class="keywordtype">char</span> *ret;
<a name="l01821"></a>01821    <span class="keywordtype">char</span> tempstr[1024];
<a name="l01822"></a>01822 
<a name="l01823"></a>01823    <span class="keywordflow">if</span> (argc != 3)
<a name="l01824"></a>01824       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01825"></a>01825 
<a name="l01826"></a>01826    <span class="comment">/* check if we want to execute an ast_custom_function */</span>
<a name="l01827"></a>01827    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(argv[2]) &amp;&amp; (argv[2][strlen(argv[2]) - 1] == <span class="charliteral">&apos;)&apos;</span>)) {
<a name="l01828"></a>01828       ret = <a class="code" href="pbx_8h.html#aa4e9618aa036a586af7d7663afd9b507" title="executes a read operation on a function">ast_func_read</a>(chan, argv[2], tempstr, <span class="keyword">sizeof</span>(tempstr)) ? NULL : tempstr;
<a name="l01829"></a>01829    } <span class="keywordflow">else</span> {
<a name="l01830"></a>01830       <a class="code" href="pbx_8h.html#aaf906a18ba2dcd53c35f59869757521f" title="Retrieve the value of a builtin variable or variable from the channel variable stack...">pbx_retrieve_variable</a>(chan, argv[2], &amp;ret, tempstr, <span class="keyword">sizeof</span>(tempstr), NULL);
<a name="l01831"></a>01831    }
<a name="l01832"></a>01832 
<a name="l01833"></a>01833    <span class="keywordflow">if</span> (ret)
<a name="l01834"></a>01834       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1 (%s)\n&quot;</span>, ret);
<a name="l01835"></a>01835    <span class="keywordflow">else</span>
<a name="l01836"></a>01836       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l01837"></a>01837 
<a name="l01838"></a>01838    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01839"></a>01839 }
<a name="l01840"></a>01840 
<a name="l01841"></a><a class="code" href="res__agi_8c.html#a25eaec741ff1967f5f684779a1b752cf">01841</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a25eaec741ff1967f5f684779a1b752cf">handle_getvariablefull</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01842"></a>01842 {
<a name="l01843"></a>01843    <span class="keywordtype">char</span> tmp[4096];
<a name="l01844"></a>01844    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan2=NULL;
<a name="l01845"></a>01845 
<a name="l01846"></a>01846    <span class="keywordflow">if</span> ((argc != 4) &amp;&amp; (argc != 5))
<a name="l01847"></a>01847       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01848"></a>01848    <span class="keywordflow">if</span> (argc == 5) {
<a name="l01849"></a>01849       chan2 = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(argv[4]);
<a name="l01850"></a>01850    } <span class="keywordflow">else</span> {
<a name="l01851"></a>01851       chan2 = chan;
<a name="l01852"></a>01852    }
<a name="l01853"></a>01853    <span class="keywordflow">if</span> (chan2) {
<a name="l01854"></a>01854       <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(chan2, argv[3], tmp, <span class="keyword">sizeof</span>(tmp) - 1);
<a name="l01855"></a>01855       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1 (%s)\n&quot;</span>, tmp);
<a name="l01856"></a>01856    } <span class="keywordflow">else</span> {
<a name="l01857"></a>01857       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l01858"></a>01858    }
<a name="l01859"></a>01859    <span class="keywordflow">if</span> (chan2 &amp;&amp; (chan2 != chan))
<a name="l01860"></a>01860       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan2);
<a name="l01861"></a>01861    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01862"></a>01862 }
<a name="l01863"></a>01863 
<a name="l01864"></a><a class="code" href="res__agi_8c.html#a3ca4d957caec4001d39b9e5367d99544">01864</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a3ca4d957caec4001d39b9e5367d99544">handle_verbose</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01865"></a>01865 {
<a name="l01866"></a>01866    <span class="keywordtype">int</span> level = 0;
<a name="l01867"></a>01867 
<a name="l01868"></a>01868    <span class="keywordflow">if</span> (argc &lt; 2)
<a name="l01869"></a>01869       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01870"></a>01870 
<a name="l01871"></a>01871    <span class="keywordflow">if</span> (argv[2])
<a name="l01872"></a>01872       sscanf(argv[2], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;level);
<a name="l01873"></a>01873 
<a name="l01874"></a>01874    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(level, <span class="stringliteral">&quot;%s: %s\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, argv[1]);
<a name="l01875"></a>01875 
<a name="l01876"></a>01876    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l01877"></a>01877 
<a name="l01878"></a>01878    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01879"></a>01879 }
<a name="l01880"></a>01880 
<a name="l01881"></a><a class="code" href="res__agi_8c.html#abe50f564bc9e5d6808d6ff132e187531">01881</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#abe50f564bc9e5d6808d6ff132e187531">handle_dbget</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01882"></a>01882 {
<a name="l01883"></a>01883    <span class="keywordtype">int</span> res;
<a name="l01884"></a>01884    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l01885"></a>01885 
<a name="l01886"></a>01886    <span class="keywordflow">if</span> (argc != 4)
<a name="l01887"></a>01887       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01888"></a>01888 
<a name="l01889"></a>01889    <span class="keywordflow">if</span> (!(buf = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(16))) {
<a name="l01890"></a>01890       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=-1\n&quot;</span>);
<a name="l01891"></a>01891       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01892"></a>01892    }
<a name="l01893"></a>01893 
<a name="l01894"></a>01894    <span class="keywordflow">do</span> {
<a name="l01895"></a>01895       res = <a class="code" href="astdb_8h.html#a48033762bf6ab77f15dd72277a1fe7fa" title="Get key value specified by family/key.">ast_db_get</a>(argv[2], argv[3], <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf), <a class="code" href="strings_8h.html#ab9726d03e7f9f4746876d71bea28de33" title="Returns the current maximum length (without reallocation) of the current buffer.">ast_str_size</a>(buf));
<a name="l01896"></a>01896       <a class="code" href="strings_8h.html#a8887fcac1220a7528e88efc16f751415" title="Update the length of the buffer, after using ast_str merely as a buffer.">ast_str_update</a>(buf);
<a name="l01897"></a>01897       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a99409c17a1d20e1c3dc00039b7925a2d" title="Returns the current length of the string stored within buf.">ast_str_strlen</a>(buf) &lt; <a class="code" href="strings_8h.html#ab9726d03e7f9f4746876d71bea28de33" title="Returns the current maximum length (without reallocation) of the current buffer.">ast_str_size</a>(buf) - 1) {
<a name="l01898"></a>01898          <span class="keywordflow">break</span>;
<a name="l01899"></a>01899       }
<a name="l01900"></a>01900       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a7f20a4560b028f55b5d723f02f5830cb">ast_str_make_space</a>(&amp;buf, <a class="code" href="strings_8h.html#ab9726d03e7f9f4746876d71bea28de33" title="Returns the current maximum length (without reallocation) of the current buffer.">ast_str_size</a>(buf) * 2)) {
<a name="l01901"></a>01901          <span class="keywordflow">break</span>;
<a name="l01902"></a>01902       }
<a name="l01903"></a>01903    } <span class="keywordflow">while</span> (1);
<a name="l01904"></a>01904    
<a name="l01905"></a>01905    <span class="keywordflow">if</span> (res)
<a name="l01906"></a>01906       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l01907"></a>01907    <span class="keywordflow">else</span>
<a name="l01908"></a>01908       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1 (%s)\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l01909"></a>01909 
<a name="l01910"></a>01910    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buf);
<a name="l01911"></a>01911    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01912"></a>01912 }
<a name="l01913"></a>01913 
<a name="l01914"></a><a class="code" href="res__agi_8c.html#a308e0a3880b16b88e14ac26b54a49498">01914</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a308e0a3880b16b88e14ac26b54a49498">handle_dbput</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01915"></a>01915 {
<a name="l01916"></a>01916    <span class="keywordtype">int</span> res;
<a name="l01917"></a>01917 
<a name="l01918"></a>01918    <span class="keywordflow">if</span> (argc != 5)
<a name="l01919"></a>01919       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01920"></a>01920    res = <a class="code" href="astdb_8h.html#a0f14f6bff4f412c88b50aba34d3a5e35" title="Store value addressed by family/key.">ast_db_put</a>(argv[2], argv[3], argv[4]);
<a name="l01921"></a>01921    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%c\n&quot;</span>, res ? <span class="charliteral">&apos;0&apos;</span> : <span class="charliteral">&apos;1&apos;</span>);
<a name="l01922"></a>01922    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01923"></a>01923 }
<a name="l01924"></a>01924 
<a name="l01925"></a><a class="code" href="res__agi_8c.html#ae5a6242275fd959441f37b6a9dd90a37">01925</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ae5a6242275fd959441f37b6a9dd90a37">handle_dbdel</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01926"></a>01926 {
<a name="l01927"></a>01927    <span class="keywordtype">int</span> res;
<a name="l01928"></a>01928 
<a name="l01929"></a>01929    <span class="keywordflow">if</span> (argc != 4)
<a name="l01930"></a>01930       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01931"></a>01931    res = <a class="code" href="astdb_8h.html#a71e8d5ab1757b184683a99125d1c8160" title="Delete entry in astdb.">ast_db_del</a>(argv[2], argv[3]);
<a name="l01932"></a>01932    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%c\n&quot;</span>, res ? <span class="charliteral">&apos;0&apos;</span> : <span class="charliteral">&apos;1&apos;</span>);
<a name="l01933"></a>01933    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01934"></a>01934 }
<a name="l01935"></a>01935 
<a name="l01936"></a><a class="code" href="res__agi_8c.html#ad2313e4cec06d8ac0d02cb815ffa24b6">01936</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ad2313e4cec06d8ac0d02cb815ffa24b6">handle_dbdeltree</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01937"></a>01937 {
<a name="l01938"></a>01938    <span class="keywordtype">int</span> res;
<a name="l01939"></a>01939 
<a name="l01940"></a>01940    <span class="keywordflow">if</span> ((argc &lt; 3) || (argc &gt; 4))
<a name="l01941"></a>01941       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01942"></a>01942    <span class="keywordflow">if</span> (argc == 4)
<a name="l01943"></a>01943       res = <a class="code" href="astdb_8h.html#af251d986cfe884ffd5ca864531253f62" title="Delete a whole family (for some reason also called &amp;quot;tree&amp;quot;.">ast_db_deltree</a>(argv[2], argv[3]);
<a name="l01944"></a>01944    <span class="keywordflow">else</span>
<a name="l01945"></a>01945       res = <a class="code" href="astdb_8h.html#af251d986cfe884ffd5ca864531253f62" title="Delete a whole family (for some reason also called &amp;quot;tree&amp;quot;.">ast_db_deltree</a>(argv[2], NULL);
<a name="l01946"></a>01946 
<a name="l01947"></a>01947    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=%c\n&quot;</span>, res ? <span class="charliteral">&apos;0&apos;</span> : <span class="charliteral">&apos;1&apos;</span>);
<a name="l01948"></a>01948    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01949"></a>01949 }
<a name="l01950"></a>01950 
<a name="l01951"></a><a class="code" href="res__agi_8c.html#ac7a0ac6d2a6cc6e05e9feecd79cb4523">01951</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#ac7a0ac6d2a6cc6e05e9feecd79cb4523">handle_cli_agi_debug</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01952"></a>01952 {
<a name="l01953"></a>01953    <span class="keywordflow">switch</span> (cmd) {
<a name="l01954"></a>01954    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01955"></a>01955       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;agi set debug [on|off]&quot;</span>;
<a name="l01956"></a>01956       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01957"></a>01957          <span class="stringliteral">&quot;Usage: agi set debug [on|off]\n&quot;</span>
<a name="l01958"></a>01958          <span class="stringliteral">&quot;       Enables/disables dumping of AGI transactions for\n&quot;</span>
<a name="l01959"></a>01959          <span class="stringliteral">&quot;       debugging purposes.\n&quot;</span>;
<a name="l01960"></a>01960       <span class="keywordflow">return</span> NULL;
<a name="l01961"></a>01961 
<a name="l01962"></a>01962    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01963"></a>01963       <span class="keywordflow">return</span> NULL;
<a name="l01964"></a>01964    }
<a name="l01965"></a>01965 
<a name="l01966"></a>01966    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01967"></a>01967       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01968"></a>01968 
<a name="l01969"></a>01969    <span class="keywordflow">if</span> (strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;off&quot;</span>, 3) == 0) {
<a name="l01970"></a>01970       agidebug = 0;
<a name="l01971"></a>01971    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;on&quot;</span>, 2) == 0) {
<a name="l01972"></a>01972       agidebug = 1;
<a name="l01973"></a>01973    } <span class="keywordflow">else</span> {
<a name="l01974"></a>01974       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01975"></a>01975    }
<a name="l01976"></a>01976    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;AGI Debugging %sabled\n&quot;</span>, agidebug ? <span class="stringliteral">&quot;En&quot;</span> : <span class="stringliteral">&quot;Dis&quot;</span>);
<a name="l01977"></a>01977    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01978"></a>01978 }
<a name="l01979"></a>01979 
<a name="l01980"></a><a class="code" href="res__agi_8c.html#a111b477f514c4a036835f569b3d9e910">01980</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a111b477f514c4a036835f569b3d9e910">handle_noop</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> arg, <span class="keywordtype">char</span> *argv[])
<a name="l01981"></a>01981 {
<a name="l01982"></a>01982    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l01983"></a>01983    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01984"></a>01984 }
<a name="l01985"></a>01985 
<a name="l01986"></a><a class="code" href="res__agi_8c.html#a40cb547da440ea7e6a660a6e7ca38800">01986</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a40cb547da440ea7e6a660a6e7ca38800">handle_setmusic</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01987"></a>01987 {
<a name="l01988"></a>01988    <span class="keywordflow">if</span> (argc &lt; 3) {
<a name="l01989"></a>01989       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01990"></a>01990    }
<a name="l01991"></a>01991    <span class="keywordflow">if</span> (!strncasecmp(argv[2], <span class="stringliteral">&quot;on&quot;</span>, 2))
<a name="l01992"></a>01992       <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(chan, argc &gt; 3 ? argv[3] : NULL, NULL);
<a name="l01993"></a>01993    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(argv[2], <span class="stringliteral">&quot;off&quot;</span>, 3))
<a name="l01994"></a>01994       <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l01995"></a>01995    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l01996"></a>01996    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01997"></a>01997 }
<a name="l01998"></a>01998 
<a name="l01999"></a><a class="code" href="res__agi_8c.html#aa90bee612c39726accbc5b634f6e0fce">01999</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#aa90bee612c39726accbc5b634f6e0fce">handle_speechcreate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l02000"></a>02000 {
<a name="l02001"></a>02001    <span class="comment">/* If a structure already exists, return an error */</span>
<a name="l02002"></a>02002         <span class="keywordflow">if</span> (agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>) {
<a name="l02003"></a>02003       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02004"></a>02004       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02005"></a>02005    }
<a name="l02006"></a>02006 
<a name="l02007"></a>02007    <span class="keywordflow">if</span> ((agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a> = <a class="code" href="speech_8h.html#a9726ca4d597edf9114a7ecd66a15d109" title="Create a new speech structure.">ast_speech_new</a>(argv[2], <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>)))
<a name="l02008"></a>02008       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l02009"></a>02009    <span class="keywordflow">else</span>
<a name="l02010"></a>02010       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02011"></a>02011 
<a name="l02012"></a>02012    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02013"></a>02013 }
<a name="l02014"></a>02014 
<a name="l02015"></a><a class="code" href="res__agi_8c.html#a5e46049a3abd911b172286812c4cb2ad">02015</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a5e46049a3abd911b172286812c4cb2ad">handle_speechset</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l02016"></a>02016 {
<a name="l02017"></a>02017    <span class="comment">/* Check for minimum arguments */</span>
<a name="l02018"></a>02018         <span class="keywordflow">if</span> (argc != 3)
<a name="l02019"></a>02019       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l02020"></a>02020 
<a name="l02021"></a>02021    <span class="comment">/* Check to make sure speech structure exists */</span>
<a name="l02022"></a>02022    <span class="keywordflow">if</span> (!agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>) {
<a name="l02023"></a>02023       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02024"></a>02024       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02025"></a>02025    }
<a name="l02026"></a>02026 
<a name="l02027"></a>02027    <a class="code" href="speech_8h.html#a442071046a5de90b17cf50e2a6d876dc" title="Change an engine specific attribute.">ast_speech_change</a>(agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>, argv[2], argv[3]);
<a name="l02028"></a>02028    <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l02029"></a>02029 
<a name="l02030"></a>02030    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02031"></a>02031 }
<a name="l02032"></a>02032 
<a name="l02033"></a><a class="code" href="res__agi_8c.html#a97859236d1f099fde3f3cbe49627d033">02033</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a97859236d1f099fde3f3cbe49627d033">handle_speechdestroy</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l02034"></a>02034 {
<a name="l02035"></a>02035    <span class="keywordflow">if</span> (agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>) {
<a name="l02036"></a>02036       <a class="code" href="speech_8h.html#a7ebc9d3250a75a2cb7ee2f7c15eb8228" title="Destroy a speech structure.">ast_speech_destroy</a>(agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>);
<a name="l02037"></a>02037       agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a> = NULL;
<a name="l02038"></a>02038       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l02039"></a>02039    } <span class="keywordflow">else</span> {
<a name="l02040"></a>02040       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02041"></a>02041    }
<a name="l02042"></a>02042 
<a name="l02043"></a>02043    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02044"></a>02044 }
<a name="l02045"></a>02045 
<a name="l02046"></a><a class="code" href="res__agi_8c.html#a5998b1d3d4f3940e0c038762d8eab934">02046</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a5998b1d3d4f3940e0c038762d8eab934">handle_speechloadgrammar</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l02047"></a>02047 {
<a name="l02048"></a>02048    <span class="keywordflow">if</span> (argc != 5)
<a name="l02049"></a>02049       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l02050"></a>02050 
<a name="l02051"></a>02051    <span class="keywordflow">if</span> (!agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>) {
<a name="l02052"></a>02052       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02053"></a>02053       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02054"></a>02054    }
<a name="l02055"></a>02055 
<a name="l02056"></a>02056    <span class="keywordflow">if</span> (<a class="code" href="speech_8h.html#a90c7880a7eac78890ad0db613f43375a" title="Load a grammar on a speech structure (not globally).">ast_speech_grammar_load</a>(agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>, argv[3], argv[4]))
<a name="l02057"></a>02057       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02058"></a>02058    <span class="keywordflow">else</span>
<a name="l02059"></a>02059       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l02060"></a>02060 
<a name="l02061"></a>02061    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02062"></a>02062 }
<a name="l02063"></a>02063 
<a name="l02064"></a><a class="code" href="res__agi_8c.html#a2ea45faeeea820383d07481d0c6ce6b2">02064</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a2ea45faeeea820383d07481d0c6ce6b2">handle_speechunloadgrammar</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l02065"></a>02065 {
<a name="l02066"></a>02066    <span class="keywordflow">if</span> (argc != 4)
<a name="l02067"></a>02067       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l02068"></a>02068 
<a name="l02069"></a>02069    <span class="keywordflow">if</span> (!agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>) {
<a name="l02070"></a>02070       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02071"></a>02071       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02072"></a>02072    }
<a name="l02073"></a>02073 
<a name="l02074"></a>02074    <span class="keywordflow">if</span> (<a class="code" href="speech_8h.html#acff9d3cbd70f85f2cd8b4b84cb697495" title="Unload a grammar.">ast_speech_grammar_unload</a>(agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>, argv[3]))
<a name="l02075"></a>02075       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02076"></a>02076    <span class="keywordflow">else</span>
<a name="l02077"></a>02077       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l02078"></a>02078 
<a name="l02079"></a>02079    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02080"></a>02080 }
<a name="l02081"></a>02081 
<a name="l02082"></a><a class="code" href="res__agi_8c.html#a033d17c0578c97da0710a8dbac34c9fe">02082</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a033d17c0578c97da0710a8dbac34c9fe">handle_speechactivategrammar</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l02083"></a>02083 {
<a name="l02084"></a>02084    <span class="keywordflow">if</span> (argc != 4)
<a name="l02085"></a>02085       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l02086"></a>02086 
<a name="l02087"></a>02087    <span class="keywordflow">if</span> (!agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>) {
<a name="l02088"></a>02088       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02089"></a>02089       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02090"></a>02090    }
<a name="l02091"></a>02091 
<a name="l02092"></a>02092    <span class="keywordflow">if</span> (<a class="code" href="speech_8h.html#a88aa8a73affd3787320c45acb6068ec5" title="Activate a grammar on a speech structure.">ast_speech_grammar_activate</a>(agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>, argv[3]))
<a name="l02093"></a>02093       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02094"></a>02094    <span class="keywordflow">else</span>
<a name="l02095"></a>02095       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l02096"></a>02096 
<a name="l02097"></a>02097    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02098"></a>02098 }
<a name="l02099"></a>02099 
<a name="l02100"></a><a class="code" href="res__agi_8c.html#abada370b956947183a8db08c90a21d48">02100</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#abada370b956947183a8db08c90a21d48">handle_speechdeactivategrammar</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l02101"></a>02101 {
<a name="l02102"></a>02102    <span class="keywordflow">if</span> (argc != 4)
<a name="l02103"></a>02103       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l02104"></a>02104 
<a name="l02105"></a>02105    <span class="keywordflow">if</span> (!agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>) {
<a name="l02106"></a>02106       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02107"></a>02107       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02108"></a>02108    }
<a name="l02109"></a>02109 
<a name="l02110"></a>02110    <span class="keywordflow">if</span> (<a class="code" href="speech_8h.html#a748ecd47b9c348af10cdb6d49c670643" title="Deactivate a grammar on a speech structure.">ast_speech_grammar_deactivate</a>(agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>, argv[3]))
<a name="l02111"></a>02111       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02112"></a>02112    <span class="keywordflow">else</span>
<a name="l02113"></a>02113       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1\n&quot;</span>);
<a name="l02114"></a>02114 
<a name="l02115"></a>02115    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02116"></a>02116 }
<a name="l02117"></a>02117 
<a name="l02118"></a><a class="code" href="res__agi_8c.html#a858a0c285f521084ef968a81472e5458">02118</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a858a0c285f521084ef968a81472e5458">speech_streamfile</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang, <span class="keywordtype">int</span> offset)
<a name="l02119"></a>02119 {
<a name="l02120"></a>02120    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs = NULL;
<a name="l02121"></a>02121 
<a name="l02122"></a>02122    <span class="keywordflow">if</span> (!(fs = <a class="code" href="file_8h.html#ad85c951fa1d6988d2d7e169833a951a8" title="Opens stream for use in seeking, playing.">ast_openstream</a>(chan, filename, preflang)))
<a name="l02123"></a>02123       <span class="keywordflow">return</span> -1;
<a name="l02124"></a>02124 
<a name="l02125"></a>02125    <span class="keywordflow">if</span> (offset)
<a name="l02126"></a>02126       <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(fs, offset, SEEK_SET);
<a name="l02127"></a>02127 
<a name="l02128"></a>02128    <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a618e3120b6d019312ef2d617d9f14571" title="Applys a open stream to a channel.">ast_applystream</a>(chan, fs))
<a name="l02129"></a>02129       <span class="keywordflow">return</span> -1;
<a name="l02130"></a>02130 
<a name="l02131"></a>02131    <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ad59224750b8b617f9590b28b88457b14" title="Play a open stream on a channel.">ast_playstream</a>(fs))
<a name="l02132"></a>02132       <span class="keywordflow">return</span> -1;
<a name="l02133"></a>02133 
<a name="l02134"></a>02134    <span class="keywordflow">return</span> 0;
<a name="l02135"></a>02135 }
<a name="l02136"></a>02136 
<a name="l02137"></a><a class="code" href="res__agi_8c.html#ac7c1ef3ec14b081e99818e7b3b3b53ef">02137</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ac7c1ef3ec14b081e99818e7b3b3b53ef">handle_speechrecognize</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l02138"></a>02138 {
<a name="l02139"></a>02139    <span class="keyword">struct </span><a class="code" href="structast__speech.html">ast_speech</a> *speech = agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>;
<a name="l02140"></a>02140    <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a299365a3d8977a6c410c6cd924e33136">prompt</a>, dtmf = 0, tmp[4096] = <span class="stringliteral">&quot;&quot;</span>, *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a> = tmp;
<a name="l02141"></a>02141    <span class="keywordtype">int</span> timeout = 0, offset = 0, old_read_format = 0, res = 0, i = 0;
<a name="l02142"></a>02142    <span class="keywordtype">long</span> current_offset = 0;
<a name="l02143"></a>02143    <span class="keyword">const</span> <span class="keywordtype">char</span> *reason = NULL;
<a name="l02144"></a>02144    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *fr = NULL;
<a name="l02145"></a>02145    <span class="keyword">struct </span><a class="code" href="structast__speech__result.html">ast_speech_result</a> *result = NULL;
<a name="l02146"></a>02146    <span class="keywordtype">size_t</span> left = <span class="keyword">sizeof</span>(tmp);
<a name="l02147"></a>02147    time_t start = 0, current;
<a name="l02148"></a>02148 
<a name="l02149"></a>02149    <span class="keywordflow">if</span> (argc &lt; 4)
<a name="l02150"></a>02150       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l02151"></a>02151 
<a name="l02152"></a>02152    <span class="keywordflow">if</span> (!speech) {
<a name="l02153"></a>02153       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02154"></a>02154       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02155"></a>02155    }
<a name="l02156"></a>02156 
<a name="l02157"></a>02157    prompt = argv[2];
<a name="l02158"></a>02158    timeout = atoi(argv[3]);
<a name="l02159"></a>02159 
<a name="l02160"></a>02160    <span class="comment">/* If offset is specified then convert from text to integer */</span>
<a name="l02161"></a>02161    <span class="keywordflow">if</span> (argc == 5)
<a name="l02162"></a>02162       offset = atoi(argv[4]);
<a name="l02163"></a>02163 
<a name="l02164"></a>02164    <span class="comment">/* We want frames coming in signed linear */</span>
<a name="l02165"></a>02165    old_read_format = chan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l02166"></a>02166    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(chan, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>)) {
<a name="l02167"></a>02167       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0\n&quot;</span>);
<a name="l02168"></a>02168       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02169"></a>02169    }
<a name="l02170"></a>02170 
<a name="l02171"></a>02171    <span class="comment">/* Setup speech structure */</span>
<a name="l02172"></a>02172    <span class="keywordflow">if</span> (speech-&gt;<a class="code" href="structast__speech.html#a89f234133d3efe315836311cbf21c64b">state</a> == <a class="code" href="speech_8h.html#ad00266cfb9f168bb819ab079f04b9fccaae5f488f35a7f67e2e4627cbe8cde42e">AST_SPEECH_STATE_NOT_READY</a> || speech-&gt;<a class="code" href="structast__speech.html#a89f234133d3efe315836311cbf21c64b">state</a> == <a class="code" href="speech_8h.html#ad00266cfb9f168bb819ab079f04b9fcca391d9b14c01f4da04e8c8536392e1708">AST_SPEECH_STATE_DONE</a>) {
<a name="l02173"></a>02173       <a class="code" href="speech_8h.html#abbf9d09efade60713aeba70e516cbbe5" title="Change state of a speech structure.">ast_speech_change_state</a>(speech, <a class="code" href="speech_8h.html#ad00266cfb9f168bb819ab079f04b9fccaae5f488f35a7f67e2e4627cbe8cde42e">AST_SPEECH_STATE_NOT_READY</a>);
<a name="l02174"></a>02174       <a class="code" href="speech_8h.html#a35ee983d0c54de09ca8d3ffd1223c9ae" title="Indicate to the speech engine that audio is now going to start being written.">ast_speech_start</a>(speech);
<a name="l02175"></a>02175    }
<a name="l02176"></a>02176 
<a name="l02177"></a>02177    <span class="comment">/* Start playing prompt */</span>
<a name="l02178"></a>02178    <a class="code" href="res__agi_8c.html#a858a0c285f521084ef968a81472e5458">speech_streamfile</a>(chan, prompt, chan-&gt;language, offset);
<a name="l02179"></a>02179 
<a name="l02180"></a>02180    <span class="comment">/* Go into loop reading in frames, passing to speech thingy, checking for hangup, all that jazz */</span>
<a name="l02181"></a>02181    <span class="keywordflow">while</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(reason)) {
<a name="l02182"></a>02182       <span class="comment">/* Run scheduled items */</span>
<a name="l02183"></a>02183                 <a class="code" href="sched_8h.html#a2867b39106061847a8508bf49e38f420" title="Runs the queue.">ast_sched_runq</a>(chan-&gt;<a class="code" href="structast__channel.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>);
<a name="l02184"></a>02184 
<a name="l02185"></a>02185       <span class="comment">/* See maximum time of waiting */</span>
<a name="l02186"></a>02186       <span class="keywordflow">if</span> ((res = <a class="code" href="sched_8h.html#a64797d66b6051095debfcdb7f790e605" title="Determines number of seconds until the next outstanding event to take place Determine...">ast_sched_wait</a>(chan-&gt;<a class="code" href="structast__channel.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>)) &lt; 0)
<a name="l02187"></a>02187          res = 1000;
<a name="l02188"></a>02188 
<a name="l02189"></a>02189       <span class="comment">/* Wait for frame */</span>
<a name="l02190"></a>02190       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, res) &gt; 0) {
<a name="l02191"></a>02191          <span class="keywordflow">if</span> (!(fr = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan))) {
<a name="l02192"></a>02192             reason = <span class="stringliteral">&quot;hangup&quot;</span>;
<a name="l02193"></a>02193             <span class="keywordflow">break</span>;
<a name="l02194"></a>02194          }
<a name="l02195"></a>02195       }
<a name="l02196"></a>02196 
<a name="l02197"></a>02197       <span class="comment">/* Perform timeout check */</span>
<a name="l02198"></a>02198       <span class="keywordflow">if</span> ((timeout &gt; 0) &amp;&amp; (start &gt; 0)) {
<a name="l02199"></a>02199          time(&amp;current);
<a name="l02200"></a>02200          <span class="keywordflow">if</span> ((current - start) &gt;= timeout) {
<a name="l02201"></a>02201             reason = <span class="stringliteral">&quot;timeout&quot;</span>;
<a name="l02202"></a>02202             <span class="keywordflow">if</span> (fr)
<a name="l02203"></a>02203                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l02204"></a>02204             <span class="keywordflow">break</span>;
<a name="l02205"></a>02205          }
<a name="l02206"></a>02206       }
<a name="l02207"></a>02207 
<a name="l02208"></a>02208       <span class="comment">/* Check the speech structure for any changes */</span>
<a name="l02209"></a>02209       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;speech-&gt;<a class="code" href="structast__speech.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02210"></a>02210 
<a name="l02211"></a>02211       <span class="comment">/* See if we need to quiet the audio stream playback */</span>
<a name="l02212"></a>02212       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(speech, <a class="code" href="speech_8h.html#afa3ec79b3c936aaa74aa6b54ddfacb77a4199180a8b7c0b860d869eb05e3788cf">AST_SPEECH_QUIET</a>) &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>) {
<a name="l02213"></a>02213          current_offset = <a class="code" href="file_8h.html#a01771a318e7adea51499040f27b4278a" title="Tell where we are in a stream.">ast_tellstream</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>);
<a name="l02214"></a>02214          <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l02215"></a>02215          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(speech, <a class="code" href="speech_8h.html#afa3ec79b3c936aaa74aa6b54ddfacb77a4199180a8b7c0b860d869eb05e3788cf">AST_SPEECH_QUIET</a>);
<a name="l02216"></a>02216       }
<a name="l02217"></a>02217 
<a name="l02218"></a>02218       <span class="comment">/* Check each state */</span>
<a name="l02219"></a>02219       <span class="keywordflow">switch</span> (speech-&gt;<a class="code" href="structast__speech.html#a89f234133d3efe315836311cbf21c64b">state</a>) {
<a name="l02220"></a>02220       <span class="keywordflow">case</span> <a class="code" href="speech_8h.html#ad00266cfb9f168bb819ab079f04b9fcca604726916ee0089820cf89082f3b092f">AST_SPEECH_STATE_READY</a>:
<a name="l02221"></a>02221          <span class="comment">/* If the stream is done, start timeout calculation */</span>
<a name="l02222"></a>02222          <span class="keywordflow">if</span> ((timeout &gt; 0) &amp;&amp; start == 0 &amp;&amp; ((!chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>) || (chan-&gt;<a class="code" href="structast__channel.html#a7de986d04c859684e7754ac888e18532">streamid</a> == -1 &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#a66e8b9811d596825d60c6a58e0b307a4">timingfunc</a> == NULL))) {
<a name="l02223"></a>02223             <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l02224"></a>02224             time(&amp;start);
<a name="l02225"></a>02225          }
<a name="l02226"></a>02226          <span class="comment">/* Write audio frame data into speech engine if possible */</span>
<a name="l02227"></a>02227          <span class="keywordflow">if</span> (fr &amp;&amp; fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>)
<a name="l02228"></a>02228             <a class="code" href="speech_8h.html#a4ae1a7f76105b9f218161faed71590e4" title="Write audio to the speech engine.">ast_speech_write</a>(speech, fr-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, fr-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l02229"></a>02229          <span class="keywordflow">break</span>;
<a name="l02230"></a>02230       <span class="keywordflow">case</span> <a class="code" href="speech_8h.html#ad00266cfb9f168bb819ab079f04b9fccab25d197057f8858ca88fc66814403f2f">AST_SPEECH_STATE_WAIT</a>:
<a name="l02231"></a>02231          <span class="comment">/* Cue waiting sound if not already playing */</span>
<a name="l02232"></a>02232          <span class="keywordflow">if</span> ((!chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>) || (chan-&gt;<a class="code" href="structast__channel.html#a7de986d04c859684e7754ac888e18532">streamid</a> == -1 &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#a66e8b9811d596825d60c6a58e0b307a4">timingfunc</a> == NULL)) {
<a name="l02233"></a>02233             <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l02234"></a>02234             <span class="comment">/* If a processing sound exists, or is not none - play it */</span>
<a name="l02235"></a>02235             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(speech-&gt;<a class="code" href="structast__speech.html#a40e56819be5b8279e0eb05561d5c1f9a">processing_sound</a>) &amp;&amp; strcasecmp(speech-&gt;<a class="code" href="structast__speech.html#a40e56819be5b8279e0eb05561d5c1f9a">processing_sound</a>, <span class="stringliteral">&quot;none&quot;</span>))
<a name="l02236"></a>02236                <a class="code" href="res__agi_8c.html#a858a0c285f521084ef968a81472e5458">speech_streamfile</a>(chan, speech-&gt;<a class="code" href="structast__speech.html#a40e56819be5b8279e0eb05561d5c1f9a">processing_sound</a>, chan-&gt;language, 0);
<a name="l02237"></a>02237          }
<a name="l02238"></a>02238          <span class="keywordflow">break</span>;
<a name="l02239"></a>02239       <span class="keywordflow">case</span> <a class="code" href="speech_8h.html#ad00266cfb9f168bb819ab079f04b9fcca391d9b14c01f4da04e8c8536392e1708">AST_SPEECH_STATE_DONE</a>:
<a name="l02240"></a>02240          <span class="comment">/* Get the results */</span>
<a name="l02241"></a>02241          speech-&gt;<a class="code" href="structast__speech.html#af339908db8f5c3797e8a6684027a300c">results</a> = <a class="code" href="speech_8h.html#a982ace0eabd45d35786070ff32687c64" title="Get speech recognition results.">ast_speech_results_get</a>(speech);
<a name="l02242"></a>02242          <span class="comment">/* Change state to not ready */</span>
<a name="l02243"></a>02243          <a class="code" href="speech_8h.html#abbf9d09efade60713aeba70e516cbbe5" title="Change state of a speech structure.">ast_speech_change_state</a>(speech, <a class="code" href="speech_8h.html#ad00266cfb9f168bb819ab079f04b9fccaae5f488f35a7f67e2e4627cbe8cde42e">AST_SPEECH_STATE_NOT_READY</a>);
<a name="l02244"></a>02244          reason = <span class="stringliteral">&quot;speech&quot;</span>;
<a name="l02245"></a>02245          <span class="keywordflow">break</span>;
<a name="l02246"></a>02246       <span class="keywordflow">default</span>:
<a name="l02247"></a>02247          <span class="keywordflow">break</span>;
<a name="l02248"></a>02248       }
<a name="l02249"></a>02249       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;speech-&gt;<a class="code" href="structast__speech.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02250"></a>02250 
<a name="l02251"></a>02251       <span class="comment">/* Check frame for DTMF or hangup */</span>
<a name="l02252"></a>02252       <span class="keywordflow">if</span> (fr) {
<a name="l02253"></a>02253          <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) {
<a name="l02254"></a>02254             reason = <span class="stringliteral">&quot;dtmf&quot;</span>;
<a name="l02255"></a>02255             dtmf = fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l02256"></a>02256          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a> &amp;&amp; fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa7dac1c1896ab418c2ff351aae707fba">AST_CONTROL_HANGUP</a>) {
<a name="l02257"></a>02257             reason = <span class="stringliteral">&quot;hangup&quot;</span>;
<a name="l02258"></a>02258          }
<a name="l02259"></a>02259          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l02260"></a>02260       }
<a name="l02261"></a>02261    }
<a name="l02262"></a>02262 
<a name="l02263"></a>02263    <span class="keywordflow">if</span> (!strcasecmp(reason, <span class="stringliteral">&quot;speech&quot;</span>)) {
<a name="l02264"></a>02264       <span class="comment">/* Build string containing speech results */</span>
<a name="l02265"></a>02265                 <span class="keywordflow">for</span> (result = speech-&gt;<a class="code" href="structast__speech.html#af339908db8f5c3797e8a6684027a300c">results</a>; result; result = <a class="code" href="linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6" title="Returns the next entry in the list after the given entry.">AST_LIST_NEXT</a>(result, <a class="code" href="structast__speech__result.html#a0a75d2d90ad065a6294ccd0f1a2277a4">list</a>)) {
<a name="l02266"></a>02266          <span class="comment">/* Build result string */</span>
<a name="l02267"></a>02267          <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, &amp;left, <span class="stringliteral">&quot;%sscore%d=%d text%d=\&quot;%s\&quot; grammar%d=%s&quot;</span>, (i &gt; 0 ? <span class="stringliteral">&quot; &quot;</span> : <span class="stringliteral">&quot;&quot;</span>), i, result-&gt;<a class="code" href="structast__speech__result.html#aef160b7437d94056f1dc59646cd5b87d">score</a>, i, result-&gt;<a class="code" href="structast__speech__result.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>, i, result-&gt;<a class="code" href="structast__speech__result.html#a87785573be04a91c0d79c9f3b61976ad">grammar</a>);
<a name="l02268"></a>02268                         <span class="comment">/* Increment result count */</span>
<a name="l02269"></a>02269          i++;
<a name="l02270"></a>02270       }
<a name="l02271"></a>02271                 <span class="comment">/* Print out */</span>
<a name="l02272"></a>02272       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1 (speech) endpos=%ld results=%d %s\n&quot;</span>, current_offset, i, tmp);
<a name="l02273"></a>02273    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(reason, <span class="stringliteral">&quot;dtmf&quot;</span>)) {
<a name="l02274"></a>02274       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1 (digit) digit=%c endpos=%ld\n&quot;</span>, dtmf, current_offset);
<a name="l02275"></a>02275    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(reason, <span class="stringliteral">&quot;hangup&quot;</span>) || !strcasecmp(reason, <span class="stringliteral">&quot;timeout&quot;</span>)) {
<a name="l02276"></a>02276       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=1 (%s) endpos=%ld\n&quot;</span>, reason, current_offset);
<a name="l02277"></a>02277    } <span class="keywordflow">else</span> {
<a name="l02278"></a>02278       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;200 result=0 endpos=%ld\n&quot;</span>, current_offset);
<a name="l02279"></a>02279    }
<a name="l02280"></a>02280 
<a name="l02281"></a>02281    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l02282"></a>02282 }
<a name="l02283"></a>02283 
<a name="l02284"></a><a class="code" href="res__agi_8c.html#af5263f6b78d68e625388b486379f541c">02284</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#af5263f6b78d68e625388b486379f541c">usage_verbose</a>[] =
<a name="l02285"></a>02285 <span class="stringliteral">&quot; Usage: VERBOSE &lt;message&gt; &lt;level&gt;\n&quot;</span>
<a name="l02286"></a>02286 <span class="stringliteral">&quot;  Sends &lt;message&gt; to the console via verbose message system.\n&quot;</span>
<a name="l02287"></a>02287 <span class="stringliteral">&quot; &lt;level&gt; is the the verbose level (1-4)\n&quot;</span>
<a name="l02288"></a>02288 <span class="stringliteral">&quot; Always returns 1.\n&quot;</span>;
<a name="l02289"></a>02289 
<a name="l02290"></a><a class="code" href="res__agi_8c.html#a59fc0c44b51e39c4cdec26612a381e6a">02290</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a59fc0c44b51e39c4cdec26612a381e6a">usage_setvariable</a>[] =
<a name="l02291"></a>02291 <span class="stringliteral">&quot; Usage: SET VARIABLE &lt;variablename&gt; &lt;value&gt;\n&quot;</span>;
<a name="l02292"></a>02292 
<a name="l02293"></a><a class="code" href="res__agi_8c.html#a40e890b2cbc8187072a2cfca5ae4e263">02293</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a40e890b2cbc8187072a2cfca5ae4e263">usage_setcallerid</a>[] =
<a name="l02294"></a>02294 <span class="stringliteral">&quot; Usage: SET CALLERID &lt;number&gt;\n&quot;</span>
<a name="l02295"></a>02295 <span class="stringliteral">&quot;  Changes the callerid of the current channel.\n&quot;</span>;
<a name="l02296"></a>02296 
<a name="l02297"></a><a class="code" href="res__agi_8c.html#ad729d6ad5e5798b648147967431999c1">02297</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#ad729d6ad5e5798b648147967431999c1">usage_waitfordigit</a>[] =
<a name="l02298"></a>02298 <span class="stringliteral">&quot; Usage: WAIT FOR DIGIT &lt;timeout&gt;\n&quot;</span>
<a name="l02299"></a>02299 <span class="stringliteral">&quot;  Waits up to &apos;timeout&apos; milliseconds for channel to receive a DTMF digit.\n&quot;</span>
<a name="l02300"></a>02300 <span class="stringliteral">&quot; Returns -1 on channel failure, 0 if no digit is received in the timeout, or\n&quot;</span>
<a name="l02301"></a>02301 <span class="stringliteral">&quot; the numerical value of the ascii of the digit if one is received.  Use -1\n&quot;</span>
<a name="l02302"></a>02302 <span class="stringliteral">&quot; for the timeout value if you desire the call to block indefinitely.\n&quot;</span>;
<a name="l02303"></a>02303 
<a name="l02304"></a><a class="code" href="res__agi_8c.html#a456be233325e85a8ca8f5c0954745cc2">02304</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a456be233325e85a8ca8f5c0954745cc2">usage_sendtext</a>[] =
<a name="l02305"></a>02305 <span class="stringliteral">&quot; Usage: SEND TEXT \&quot;&lt;text to send&gt;\&quot;\n&quot;</span>
<a name="l02306"></a>02306 <span class="stringliteral">&quot;  Sends the given text on a channel. Most channels do not support the\n&quot;</span>
<a name="l02307"></a>02307 <span class="stringliteral">&quot; transmission of text.  Returns 0 if text is sent, or if the channel does not\n&quot;</span>
<a name="l02308"></a>02308 <span class="stringliteral">&quot; support text transmission.  Returns -1 only on error/hangup.  Text\n&quot;</span>
<a name="l02309"></a>02309 <span class="stringliteral">&quot; consisting of greater than one word should be placed in quotes since the\n&quot;</span>
<a name="l02310"></a>02310 <span class="stringliteral">&quot; command only accepts a single argument.\n&quot;</span>;
<a name="l02311"></a>02311 
<a name="l02312"></a><a class="code" href="res__agi_8c.html#a4b838e255a69bc3fe8951c3e6ebd45a4">02312</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a4b838e255a69bc3fe8951c3e6ebd45a4">usage_recvchar</a>[] =
<a name="l02313"></a>02313 <span class="stringliteral">&quot; Usage: RECEIVE CHAR &lt;timeout&gt;\n&quot;</span>
<a name="l02314"></a>02314 <span class="stringliteral">&quot;  Receives a character of text on a channel. Specify timeout to be the\n&quot;</span>
<a name="l02315"></a>02315 <span class="stringliteral">&quot; maximum time to wait for input in milliseconds, or 0 for infinite. Most channels\n&quot;</span>
<a name="l02316"></a>02316 <span class="stringliteral">&quot; do not support the reception of text. Returns the decimal value of the character\n&quot;</span>
<a name="l02317"></a>02317 <span class="stringliteral">&quot; if one is received, or 0 if the channel does not support text reception.  Returns\n&quot;</span>
<a name="l02318"></a>02318 <span class="stringliteral">&quot; -1 only on error/hangup.\n&quot;</span>;
<a name="l02319"></a>02319 
<a name="l02320"></a><a class="code" href="res__agi_8c.html#a687e190e7136f1839f2d7b6cd816c876">02320</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a687e190e7136f1839f2d7b6cd816c876">usage_recvtext</a>[] =
<a name="l02321"></a>02321 <span class="stringliteral">&quot; Usage: RECEIVE TEXT &lt;timeout&gt;\n&quot;</span>
<a name="l02322"></a>02322 <span class="stringliteral">&quot;  Receives a string of text on a channel. Specify timeout to be the\n&quot;</span>
<a name="l02323"></a>02323 <span class="stringliteral">&quot; maximum time to wait for input in milliseconds, or 0 for infinite. Most channels\n&quot;</span>
<a name="l02324"></a>02324 <span class="stringliteral">&quot; do not support the reception of text. Returns -1 for failure or 1 for success, and the string in parentheses.\n&quot;</span>;
<a name="l02325"></a>02325 
<a name="l02326"></a><a class="code" href="res__agi_8c.html#a847c58942e8868705cd6a061a390dbf5">02326</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a847c58942e8868705cd6a061a390dbf5">usage_tddmode</a>[] =
<a name="l02327"></a>02327 <span class="stringliteral">&quot; Usage: TDD MODE &lt;on|off&gt;\n&quot;</span>
<a name="l02328"></a>02328 <span class="stringliteral">&quot;  Enable/Disable TDD transmission/reception on a channel. Returns 1 if\n&quot;</span>
<a name="l02329"></a>02329 <span class="stringliteral">&quot; successful, or 0 if channel is not TDD-capable.\n&quot;</span>;
<a name="l02330"></a>02330 
<a name="l02331"></a><a class="code" href="res__agi_8c.html#ac6d835401808b243239f6823f3159ce8">02331</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#ac6d835401808b243239f6823f3159ce8">usage_sendimage</a>[] =
<a name="l02332"></a>02332 <span class="stringliteral">&quot; Usage: SEND IMAGE &lt;image&gt;\n&quot;</span>
<a name="l02333"></a>02333 <span class="stringliteral">&quot;  Sends the given image on a channel. Most channels do not support the\n&quot;</span>
<a name="l02334"></a>02334 <span class="stringliteral">&quot; transmission of images. Returns 0 if image is sent, or if the channel does not\n&quot;</span>
<a name="l02335"></a>02335 <span class="stringliteral">&quot; support image transmission.  Returns -1 only on error/hangup. Image names\n&quot;</span>
<a name="l02336"></a>02336 <span class="stringliteral">&quot; should not include extensions.\n&quot;</span>;
<a name="l02337"></a>02337 
<a name="l02338"></a><a class="code" href="res__agi_8c.html#a6315bd9fb68ee24479b31060b9c8b5d6">02338</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a6315bd9fb68ee24479b31060b9c8b5d6">usage_streamfile</a>[] =
<a name="l02339"></a>02339 <span class="stringliteral">&quot; Usage: STREAM FILE &lt;filename&gt; &lt;escape digits&gt; [sample offset]\n&quot;</span>
<a name="l02340"></a>02340 <span class="stringliteral">&quot;  Send the given file, allowing playback to be interrupted by the given\n&quot;</span>
<a name="l02341"></a>02341 <span class="stringliteral">&quot; digits, if any. Use double quotes for the digits if you wish none to be\n&quot;</span>
<a name="l02342"></a>02342 <span class="stringliteral">&quot; permitted. If sample offset is provided then the audio will seek to sample\n&quot;</span>
<a name="l02343"></a>02343 <span class="stringliteral">&quot; offset before play starts.  Returns 0 if playback completes without a digit\n&quot;</span>
<a name="l02344"></a>02344 <span class="stringliteral">&quot; being pressed, or the ASCII numerical value of the digit if one was pressed,\n&quot;</span>
<a name="l02345"></a>02345 <span class="stringliteral">&quot; or -1 on error or if the channel was disconnected. Remember, the file\n&quot;</span>
<a name="l02346"></a>02346 <span class="stringliteral">&quot; extension must not be included in the filename.\n&quot;</span>;
<a name="l02347"></a>02347 
<a name="l02348"></a><a class="code" href="res__agi_8c.html#ad53e15e6497497ebb28343c8ff8eb937">02348</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#ad53e15e6497497ebb28343c8ff8eb937">usage_controlstreamfile</a>[] =
<a name="l02349"></a>02349 <span class="stringliteral">&quot; Usage: CONTROL STREAM FILE &lt;filename&gt; &lt;escape digits&gt; [skipms] [ffchar] [rewchr] [pausechr]\n&quot;</span>
<a name="l02350"></a>02350 <span class="stringliteral">&quot;  Send the given file, allowing playback to be controled by the given\n&quot;</span>
<a name="l02351"></a>02351 <span class="stringliteral">&quot; digits, if any. Use double quotes for the digits if you wish none to be\n&quot;</span>
<a name="l02352"></a>02352 <span class="stringliteral">&quot; permitted.  Returns 0 if playback completes without a digit\n&quot;</span>
<a name="l02353"></a>02353 <span class="stringliteral">&quot; being pressed, or the ASCII numerical value of the digit if one was pressed,\n&quot;</span>
<a name="l02354"></a>02354 <span class="stringliteral">&quot; or -1 on error or if the channel was disconnected. Remember, the file\n&quot;</span>
<a name="l02355"></a>02355 <span class="stringliteral">&quot; extension must not be included in the filename.\n\n&quot;</span>
<a name="l02356"></a>02356 <span class="stringliteral">&quot; Note: ffchar and rewchar default to * and # respectively.\n&quot;</span>;
<a name="l02357"></a>02357 
<a name="l02358"></a><a class="code" href="res__agi_8c.html#af9adb1daab141c760f228cb5af3485cf">02358</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#af9adb1daab141c760f228cb5af3485cf">usage_saynumber</a>[] =
<a name="l02359"></a>02359 <span class="stringliteral">&quot; Usage: SAY NUMBER &lt;number&gt; &lt;escape digits&gt; [gender]\n&quot;</span>
<a name="l02360"></a>02360 <span class="stringliteral">&quot;  Say a given number, returning early if any of the given DTMF digits\n&quot;</span>
<a name="l02361"></a>02361 <span class="stringliteral">&quot; are received on the channel.  Returns 0 if playback completes without a digit\n&quot;</span>
<a name="l02362"></a>02362 <span class="stringliteral">&quot; being pressed, or the ASCII numerical value of the digit if one was pressed or\n&quot;</span>
<a name="l02363"></a>02363 <span class="stringliteral">&quot; -1 on error/hangup.\n&quot;</span>;
<a name="l02364"></a>02364 
<a name="l02365"></a><a class="code" href="res__agi_8c.html#ac57dfc375420c5985888c83782a5a539">02365</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#ac57dfc375420c5985888c83782a5a539">usage_saydigits</a>[] =
<a name="l02366"></a>02366 <span class="stringliteral">&quot; Usage: SAY DIGITS &lt;number&gt; &lt;escape digits&gt;\n&quot;</span>
<a name="l02367"></a>02367 <span class="stringliteral">&quot;  Say a given digit string, returning early if any of the given DTMF digits\n&quot;</span>
<a name="l02368"></a>02368 <span class="stringliteral">&quot; are received on the channel. Returns 0 if playback completes without a digit\n&quot;</span>
<a name="l02369"></a>02369 <span class="stringliteral">&quot; being pressed, or the ASCII numerical value of the digit if one was pressed or\n&quot;</span>
<a name="l02370"></a>02370 <span class="stringliteral">&quot; -1 on error/hangup.\n&quot;</span>;
<a name="l02371"></a>02371 
<a name="l02372"></a><a class="code" href="res__agi_8c.html#a00f49171dbc74944464bc6896a9777f8">02372</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a00f49171dbc74944464bc6896a9777f8">usage_sayalpha</a>[] =
<a name="l02373"></a>02373 <span class="stringliteral">&quot; Usage: SAY ALPHA &lt;number&gt; &lt;escape digits&gt;\n&quot;</span>
<a name="l02374"></a>02374 <span class="stringliteral">&quot;  Say a given character string, returning early if any of the given DTMF digits\n&quot;</span>
<a name="l02375"></a>02375 <span class="stringliteral">&quot; are received on the channel. Returns 0 if playback completes without a digit\n&quot;</span>
<a name="l02376"></a>02376 <span class="stringliteral">&quot; being pressed, or the ASCII numerical value of the digit if one was pressed or\n&quot;</span>
<a name="l02377"></a>02377 <span class="stringliteral">&quot; -1 on error/hangup.\n&quot;</span>;
<a name="l02378"></a>02378 
<a name="l02379"></a><a class="code" href="res__agi_8c.html#a249b56fd642a31dd4b1a66314cfe8380">02379</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a249b56fd642a31dd4b1a66314cfe8380">usage_saydate</a>[] =
<a name="l02380"></a>02380 <span class="stringliteral">&quot; Usage: SAY DATE &lt;date&gt; &lt;escape digits&gt;\n&quot;</span>
<a name="l02381"></a>02381 <span class="stringliteral">&quot;  Say a given date, returning early if any of the given DTMF digits are\n&quot;</span>
<a name="l02382"></a>02382 <span class="stringliteral">&quot; received on the channel.  &lt;date&gt; is number of seconds elapsed since 00:00:00\n&quot;</span>
<a name="l02383"></a>02383 <span class="stringliteral">&quot; on January 1, 1970, Coordinated Universal Time (UTC). Returns 0 if playback\n&quot;</span>
<a name="l02384"></a>02384 <span class="stringliteral">&quot; completes without a digit being pressed, or the ASCII numerical value of the\n&quot;</span>
<a name="l02385"></a>02385 <span class="stringliteral">&quot; digit if one was pressed or -1 on error/hangup.\n&quot;</span>;
<a name="l02386"></a>02386 
<a name="l02387"></a><a class="code" href="res__agi_8c.html#a02805db2c1498aaacb88b684af334047">02387</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a02805db2c1498aaacb88b684af334047">usage_saytime</a>[] =
<a name="l02388"></a>02388 <span class="stringliteral">&quot; Usage: SAY TIME &lt;time&gt; &lt;escape digits&gt;\n&quot;</span>
<a name="l02389"></a>02389 <span class="stringliteral">&quot;  Say a given time, returning early if any of the given DTMF digits are\n&quot;</span>
<a name="l02390"></a>02390 <span class="stringliteral">&quot; received on the channel.  &lt;time&gt; is number of seconds elapsed since 00:00:00\n&quot;</span>
<a name="l02391"></a>02391 <span class="stringliteral">&quot; on January 1, 1970, Coordinated Universal Time (UTC). Returns 0 if playback\n&quot;</span>
<a name="l02392"></a>02392 <span class="stringliteral">&quot; completes without a digit being pressed, or the ASCII numerical value of the\n&quot;</span>
<a name="l02393"></a>02393 <span class="stringliteral">&quot; digit if one was pressed or -1 on error/hangup.\n&quot;</span>;
<a name="l02394"></a>02394 
<a name="l02395"></a><a class="code" href="res__agi_8c.html#a92d8359ab94116cba1f32caa57bfae32">02395</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a92d8359ab94116cba1f32caa57bfae32">usage_saydatetime</a>[] =
<a name="l02396"></a>02396 <span class="stringliteral">&quot; Usage: SAY DATETIME &lt;time&gt; &lt;escape digits&gt; [format] [timezone]\n&quot;</span>
<a name="l02397"></a>02397 <span class="stringliteral">&quot;  Say a given time, returning early if any of the given DTMF digits are\n&quot;</span>
<a name="l02398"></a>02398 <span class="stringliteral">&quot; received on the channel.  &lt;time&gt; is number of seconds elapsed since 00:00:00\n&quot;</span>
<a name="l02399"></a>02399 <span class="stringliteral">&quot; on January 1, 1970, Coordinated Universal Time (UTC). [format] is the format\n&quot;</span>
<a name="l02400"></a>02400 <span class="stringliteral">&quot; the time should be said in.  See voicemail.conf (defaults to \&quot;ABdY\n&quot;</span>
<a name="l02401"></a>02401 <span class="stringliteral">&quot; &apos;digits/at&apos; IMp\&quot;).  Acceptable values for [timezone] can be found in\n&quot;</span>
<a name="l02402"></a>02402 <span class="stringliteral">&quot; /usr/share/zoneinfo.  Defaults to machine default. Returns 0 if playback\n&quot;</span>
<a name="l02403"></a>02403 <span class="stringliteral">&quot; completes without a digit being pressed, or the ASCII numerical value of the\n&quot;</span>
<a name="l02404"></a>02404 <span class="stringliteral">&quot; digit if one was pressed or -1 on error/hangup.\n&quot;</span>;
<a name="l02405"></a>02405 
<a name="l02406"></a><a class="code" href="res__agi_8c.html#a303fbfbb9590054c0ab92fc8dbacf56e">02406</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a303fbfbb9590054c0ab92fc8dbacf56e">usage_sayphonetic</a>[] =
<a name="l02407"></a>02407 <span class="stringliteral">&quot; Usage: SAY PHONETIC &lt;string&gt; &lt;escape digits&gt;\n&quot;</span>
<a name="l02408"></a>02408 <span class="stringliteral">&quot;  Say a given character string with phonetics, returning early if any of the\n&quot;</span>
<a name="l02409"></a>02409 <span class="stringliteral">&quot; given DTMF digits are received on the channel. Returns 0 if playback\n&quot;</span>
<a name="l02410"></a>02410 <span class="stringliteral">&quot; completes without a digit pressed, the ASCII numerical value of the digit\n&quot;</span>
<a name="l02411"></a>02411 <span class="stringliteral">&quot; if one was pressed, or -1 on error/hangup.\n&quot;</span>;
<a name="l02412"></a>02412 
<a name="l02413"></a><a class="code" href="res__agi_8c.html#ade5cdf2986d099392487722326b88e83">02413</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#ade5cdf2986d099392487722326b88e83">usage_setcontext</a>[] =
<a name="l02414"></a>02414 <span class="stringliteral">&quot; Usage: SET CONTEXT &lt;desired context&gt;\n&quot;</span>
<a name="l02415"></a>02415 <span class="stringliteral">&quot;  Sets the context for continuation upon exiting the application.\n&quot;</span>;
<a name="l02416"></a>02416 
<a name="l02417"></a><a class="code" href="res__agi_8c.html#aab3cf033e8508967af0db03f629d5631">02417</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#aab3cf033e8508967af0db03f629d5631">usage_setextension</a>[] =
<a name="l02418"></a>02418 <span class="stringliteral">&quot; Usage: SET EXTENSION &lt;new extension&gt;\n&quot;</span>
<a name="l02419"></a>02419 <span class="stringliteral">&quot;  Changes the extension for continuation upon exiting the application.\n&quot;</span>;
<a name="l02420"></a>02420 
<a name="l02421"></a><a class="code" href="res__agi_8c.html#a2ed63140091526fb8ffff8e0d0d907fd">02421</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a2ed63140091526fb8ffff8e0d0d907fd">usage_setpriority</a>[] =
<a name="l02422"></a>02422 <span class="stringliteral">&quot; Usage: SET PRIORITY &lt;priority&gt;\n&quot;</span>
<a name="l02423"></a>02423 <span class="stringliteral">&quot;  Changes the priority for continuation upon exiting the application.\n&quot;</span>
<a name="l02424"></a>02424 <span class="stringliteral">&quot; The priority must be a valid priority or label.\n&quot;</span>;
<a name="l02425"></a>02425 
<a name="l02426"></a><a class="code" href="res__agi_8c.html#a0f84b3cef991e2a61a71ca1b54026ad5">02426</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a0f84b3cef991e2a61a71ca1b54026ad5">usage_recordfile</a>[] =
<a name="l02427"></a>02427 <span class="stringliteral">&quot; Usage: RECORD FILE &lt;filename&gt; &lt;format&gt; &lt;escape digits&gt; &lt;timeout&gt; \\\n&quot;</span>
<a name="l02428"></a>02428 <span class="stringliteral">&quot;                                          [offset samples] [BEEP] [s=silence]\n&quot;</span>
<a name="l02429"></a>02429 <span class="stringliteral">&quot;  Record to a file until a given dtmf digit in the sequence is received\n&quot;</span>
<a name="l02430"></a>02430 <span class="stringliteral">&quot; Returns -1 on hangup or error.  The format will specify what kind of file\n&quot;</span>
<a name="l02431"></a>02431 <span class="stringliteral">&quot; will be recorded.  The timeout is the maximum record time in milliseconds, or\n&quot;</span>
<a name="l02432"></a>02432 <span class="stringliteral">&quot; -1 for no timeout. \&quot;Offset samples\&quot; is optional, and, if provided, will seek\n&quot;</span>
<a name="l02433"></a>02433 <span class="stringliteral">&quot; to the offset without exceeding the end of the file.  \&quot;silence\&quot; is the number\n&quot;</span>
<a name="l02434"></a>02434 <span class="stringliteral">&quot; of seconds of silence allowed before the function returns despite the\n&quot;</span>
<a name="l02435"></a>02435 <span class="stringliteral">&quot; lack of dtmf digits or reaching timeout.  Silence value must be\n&quot;</span>
<a name="l02436"></a>02436 <span class="stringliteral">&quot; preceeded by \&quot;s=\&quot; and is also optional.\n&quot;</span>;
<a name="l02437"></a>02437 
<a name="l02438"></a><a class="code" href="res__agi_8c.html#aee6cff0937e4f945ad31a01df5d3ef71">02438</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#aee6cff0937e4f945ad31a01df5d3ef71">usage_autohangup</a>[] =
<a name="l02439"></a>02439 <span class="stringliteral">&quot; Usage: SET AUTOHANGUP &lt;time&gt;\n&quot;</span>
<a name="l02440"></a>02440 <span class="stringliteral">&quot;  Cause the channel to automatically hangup at &lt;time&gt; seconds in the\n&quot;</span>
<a name="l02441"></a>02441 <span class="stringliteral">&quot; future.  Of course it can be hungup before then as well. Setting to 0 will\n&quot;</span>
<a name="l02442"></a>02442 <span class="stringliteral">&quot; cause the autohangup feature to be disabled on this channel.\n&quot;</span>;
<a name="l02443"></a>02443 
<a name="l02444"></a><a class="code" href="res__agi_8c.html#a4e70c1ea391b59ba9041e1f5c6c7a8eb">02444</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a4e70c1ea391b59ba9041e1f5c6c7a8eb">usage_speechcreate</a>[] =
<a name="l02445"></a>02445 <span class="stringliteral">&quot; Usage: SPEECH CREATE &lt;engine&gt;\n&quot;</span>
<a name="l02446"></a>02446 <span class="stringliteral">&quot;       Create a speech object to be used by the other Speech AGI commands.\n&quot;</span>;
<a name="l02447"></a>02447 
<a name="l02448"></a><a class="code" href="res__agi_8c.html#ab141d81491570149c8b0acd1b2d14dc7">02448</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#ab141d81491570149c8b0acd1b2d14dc7">usage_speechset</a>[] =
<a name="l02449"></a>02449 <span class="stringliteral">&quot; Usage: SPEECH SET &lt;name&gt; &lt;value&gt;\n&quot;</span>
<a name="l02450"></a>02450 <span class="stringliteral">&quot;       Set an engine-specific setting.\n&quot;</span>;
<a name="l02451"></a>02451 
<a name="l02452"></a><a class="code" href="res__agi_8c.html#a78f9822db494a9c9b0da9566e1b8339f">02452</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a78f9822db494a9c9b0da9566e1b8339f">usage_speechdestroy</a>[] =
<a name="l02453"></a>02453 <span class="stringliteral">&quot; Usage: SPEECH DESTROY\n&quot;</span>
<a name="l02454"></a>02454 <span class="stringliteral">&quot;       Destroy the speech object created by SPEECH CREATE.\n&quot;</span>;
<a name="l02455"></a>02455 
<a name="l02456"></a><a class="code" href="res__agi_8c.html#a0a8e674d22b78c96d47fc32e897eae92">02456</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a0a8e674d22b78c96d47fc32e897eae92">usage_speechloadgrammar</a>[] =
<a name="l02457"></a>02457 <span class="stringliteral">&quot; Usage: SPEECH LOAD GRAMMAR &lt;grammar name&gt; &lt;path to grammar&gt;\n&quot;</span>
<a name="l02458"></a>02458 <span class="stringliteral">&quot;       Loads the specified grammar as the specified name.\n&quot;</span>;
<a name="l02459"></a>02459 
<a name="l02460"></a><a class="code" href="res__agi_8c.html#a910077e51bd02f73a9c0f5d0e012fc6e">02460</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a910077e51bd02f73a9c0f5d0e012fc6e">usage_speechunloadgrammar</a>[] =
<a name="l02461"></a>02461 <span class="stringliteral">&quot; Usage: SPEECH UNLOAD GRAMMAR &lt;grammar name&gt;\n&quot;</span>
<a name="l02462"></a>02462 <span class="stringliteral">&quot;       Unloads the specified grammar.\n&quot;</span>;
<a name="l02463"></a>02463 
<a name="l02464"></a><a class="code" href="res__agi_8c.html#ab5b602db609d4ab2f0952157f6965aef">02464</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#ab5b602db609d4ab2f0952157f6965aef">usage_speechactivategrammar</a>[] =
<a name="l02465"></a>02465 <span class="stringliteral">&quot; Usage: SPEECH ACTIVATE GRAMMAR &lt;grammar name&gt;\n&quot;</span>
<a name="l02466"></a>02466 <span class="stringliteral">&quot;       Activates the specified grammar on the speech object.\n&quot;</span>;
<a name="l02467"></a>02467 
<a name="l02468"></a><a class="code" href="res__agi_8c.html#a5c5e28526695137a7166643be59d37a9">02468</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a5c5e28526695137a7166643be59d37a9">usage_speechdeactivategrammar</a>[] =
<a name="l02469"></a>02469 <span class="stringliteral">&quot; Usage: SPEECH DEACTIVATE GRAMMAR &lt;grammar name&gt;\n&quot;</span>
<a name="l02470"></a>02470 <span class="stringliteral">&quot;       Deactivates the specified grammar on the speech object.\n&quot;</span>;
<a name="l02471"></a>02471 
<a name="l02472"></a><a class="code" href="res__agi_8c.html#a92fdf5fd3a78976f2d469dcd0f9832f1">02472</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a92fdf5fd3a78976f2d469dcd0f9832f1">usage_speechrecognize</a>[] =
<a name="l02473"></a>02473 <span class="stringliteral">&quot; Usage: SPEECH RECOGNIZE &lt;prompt&gt; &lt;timeout&gt; [&lt;offset&gt;]\n&quot;</span>
<a name="l02474"></a>02474 <span class="stringliteral">&quot;       Plays back given prompt while listening for speech and dtmf.\n&quot;</span>;
<a name="l02475"></a>02475 <span class="comment"></span>
<a name="l02476"></a>02476 <span class="comment">/*!</span>
<a name="l02477"></a>02477 <span class="comment"> * \brief AGI commands list</span>
<a name="l02478"></a>02478 <span class="comment"> */</span>
<a name="l02479"></a><a class="code" href="res__agi_8c.html#aaaa94f6da87a703160a7acb2fd67422d">02479</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structagi__command.html">agi_command</a> <a class="code" href="res__agi_8c.html#aaaa94f6da87a703160a7acb2fd67422d" title="AGI commands list.">commands</a>[] = {
<a name="l02480"></a>02480    { { <span class="stringliteral">&quot;answer&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#afe5c19dc69f816c4f76553ca8d2b6f20">handle_answer</a>, NULL, NULL, 0 },
<a name="l02481"></a>02481    { { <span class="stringliteral">&quot;asyncagi&quot;</span>, <span class="stringliteral">&quot;break&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a51738a4a076899d4ba624791cbd0ab98">handle_asyncagi_break</a>, NULL, NULL, 1 },
<a name="l02482"></a>02482    { { <span class="stringliteral">&quot;channel&quot;</span>, <span class="stringliteral">&quot;status&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a6c290a2d507657929ba5bfe06d823631">handle_channelstatus</a>, NULL, NULL, 0 },
<a name="l02483"></a>02483    { { <span class="stringliteral">&quot;database&quot;</span>, <span class="stringliteral">&quot;del&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#ae5a6242275fd959441f37b6a9dd90a37">handle_dbdel</a>, NULL, NULL, 1 },
<a name="l02484"></a>02484    { { <span class="stringliteral">&quot;database&quot;</span>, <span class="stringliteral">&quot;deltree&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#ad2313e4cec06d8ac0d02cb815ffa24b6">handle_dbdeltree</a>, NULL, NULL, 1 },
<a name="l02485"></a>02485    { { <span class="stringliteral">&quot;database&quot;</span>, <span class="stringliteral">&quot;get&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#abe50f564bc9e5d6808d6ff132e187531">handle_dbget</a>, NULL, NULL, 1 },
<a name="l02486"></a>02486    { { <span class="stringliteral">&quot;database&quot;</span>, <span class="stringliteral">&quot;put&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a308e0a3880b16b88e14ac26b54a49498">handle_dbput</a>, NULL, NULL, 1 },
<a name="l02487"></a>02487    { { <span class="stringliteral">&quot;exec&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a62164f6c04cfc139708f6a3567387123">handle_exec</a>, NULL, NULL, 1 },
<a name="l02488"></a>02488    { { <span class="stringliteral">&quot;get&quot;</span>, <span class="stringliteral">&quot;data&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a5c46b8157087eb4c448264b980767b1f">handle_getdata</a>, NULL, NULL, 0 },
<a name="l02489"></a>02489    { { <span class="stringliteral">&quot;get&quot;</span>, <span class="stringliteral">&quot;full&quot;</span>, <span class="stringliteral">&quot;variable&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a25eaec741ff1967f5f684779a1b752cf">handle_getvariablefull</a>, NULL, NULL, 1 },
<a name="l02490"></a>02490    { { <span class="stringliteral">&quot;get&quot;</span>, <span class="stringliteral">&quot;option&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#ad336eed63ffe88efeafeb588afc7313b" title="get option - really similar to the handle_streamfile, but with a timeout">handle_getoption</a>, NULL, NULL, 0 },
<a name="l02491"></a>02491    { { <span class="stringliteral">&quot;get&quot;</span>, <span class="stringliteral">&quot;variable&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#ac6275c707a3d7deab5971022228bfc2e">handle_getvariable</a>, NULL, NULL, 1 },
<a name="l02492"></a>02492    { { <span class="stringliteral">&quot;hangup&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#ada29f1c23db7954bcc004090294f048e">handle_hangup</a>, NULL, NULL, 0 },
<a name="l02493"></a>02493    { { <span class="stringliteral">&quot;noop&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a111b477f514c4a036835f569b3d9e910">handle_noop</a>, NULL, NULL, 1 },
<a name="l02494"></a>02494    { { <span class="stringliteral">&quot;receive&quot;</span>, <span class="stringliteral">&quot;char&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a866c844d1c95c6551c49b81570f6468e">handle_recvchar</a>, <span class="stringliteral">&quot;Receives one character from channels supporting it&quot;</span>, <a class="code" href="res__agi_8c.html#a4b838e255a69bc3fe8951c3e6ebd45a4">usage_recvchar</a> , 0 },
<a name="l02495"></a>02495    { { <span class="stringliteral">&quot;receive&quot;</span>, <span class="stringliteral">&quot;text&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a83e64425b9d0b626c30409ca3543f4fb">handle_recvtext</a>, <span class="stringliteral">&quot;Receives text from channels supporting it&quot;</span>, <a class="code" href="res__agi_8c.html#a687e190e7136f1839f2d7b6cd816c876">usage_recvtext</a> , 0 },
<a name="l02496"></a>02496    { { <span class="stringliteral">&quot;record&quot;</span>, <span class="stringliteral">&quot;file&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a66b879cca37c8e5deb34986dbb6ff144">handle_recordfile</a>, <span class="stringliteral">&quot;Records to a given file&quot;</span>, <a class="code" href="res__agi_8c.html#a0f84b3cef991e2a61a71ca1b54026ad5">usage_recordfile</a> , 0 },
<a name="l02497"></a>02497    { { <span class="stringliteral">&quot;say&quot;</span>, <span class="stringliteral">&quot;alpha&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#afaa4473133532930dea75eed6cf2c301">handle_sayalpha</a>, <span class="stringliteral">&quot;Says a given character string&quot;</span>, <a class="code" href="res__agi_8c.html#a00f49171dbc74944464bc6896a9777f8">usage_sayalpha</a> , 0 },
<a name="l02498"></a>02498    { { <span class="stringliteral">&quot;say&quot;</span>, <span class="stringliteral">&quot;digits&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a754118d4d92df25df6938380ba397675">handle_saydigits</a>, <span class="stringliteral">&quot;Says a given digit string&quot;</span>, <a class="code" href="res__agi_8c.html#ac57dfc375420c5985888c83782a5a539">usage_saydigits</a> , 0 },
<a name="l02499"></a>02499    { { <span class="stringliteral">&quot;say&quot;</span>, <span class="stringliteral">&quot;number&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a4e230af03a45bed22262f047f2ffe07c" title="Say number in various language syntaxes.">handle_saynumber</a>, <span class="stringliteral">&quot;Says a given number&quot;</span>, <a class="code" href="res__agi_8c.html#af9adb1daab141c760f228cb5af3485cf">usage_saynumber</a> , 0 },
<a name="l02500"></a>02500    { { <span class="stringliteral">&quot;say&quot;</span>, <span class="stringliteral">&quot;phonetic&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a10bb90c656d717992f9071582a5d9378">handle_sayphonetic</a>, <span class="stringliteral">&quot;Says a given character string with phonetics&quot;</span>, <a class="code" href="res__agi_8c.html#a303fbfbb9590054c0ab92fc8dbacf56e">usage_sayphonetic</a> , 0 },
<a name="l02501"></a>02501    { { <span class="stringliteral">&quot;say&quot;</span>, <span class="stringliteral">&quot;date&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a7c2126dcf54cbc49d261a6bb35af26f7">handle_saydate</a>, <span class="stringliteral">&quot;Says a given date&quot;</span>, <a class="code" href="res__agi_8c.html#a249b56fd642a31dd4b1a66314cfe8380">usage_saydate</a> , 0 },
<a name="l02502"></a>02502    { { <span class="stringliteral">&quot;say&quot;</span>, <span class="stringliteral">&quot;time&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a0e5a9125fe9315646e18af0dda940367">handle_saytime</a>, <span class="stringliteral">&quot;Says a given time&quot;</span>, <a class="code" href="res__agi_8c.html#a02805db2c1498aaacb88b684af334047">usage_saytime</a> , 0 },
<a name="l02503"></a>02503    { { <span class="stringliteral">&quot;say&quot;</span>, <span class="stringliteral">&quot;datetime&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#ab71e48111abdbd828dbb95bbeed5fd9c">handle_saydatetime</a>, <span class="stringliteral">&quot;Says a given time as specfied by the format given&quot;</span>, <a class="code" href="res__agi_8c.html#a92d8359ab94116cba1f32caa57bfae32">usage_saydatetime</a> , 0 },
<a name="l02504"></a>02504    { { <span class="stringliteral">&quot;send&quot;</span>, <span class="stringliteral">&quot;image&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#ae356fce1531686c8dee319ecf327fbde">handle_sendimage</a>, <span class="stringliteral">&quot;Sends images to channels supporting it&quot;</span>, <a class="code" href="res__agi_8c.html#ac6d835401808b243239f6823f3159ce8">usage_sendimage</a> , 0 },
<a name="l02505"></a>02505    { { <span class="stringliteral">&quot;send&quot;</span>, <span class="stringliteral">&quot;text&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a71153bd075d3ba38ae33e7f6b8038650">handle_sendtext</a>, <span class="stringliteral">&quot;Sends text to channels supporting it&quot;</span>, <a class="code" href="res__agi_8c.html#a456be233325e85a8ca8f5c0954745cc2">usage_sendtext</a> , 0 },
<a name="l02506"></a>02506    { { <span class="stringliteral">&quot;set&quot;</span>, <span class="stringliteral">&quot;autohangup&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a57d1651f16788371d53f053f5280ac0b">handle_autohangup</a>, <span class="stringliteral">&quot;Autohangup channel in some time&quot;</span>, <a class="code" href="res__agi_8c.html#aee6cff0937e4f945ad31a01df5d3ef71">usage_autohangup</a> , 0 },
<a name="l02507"></a>02507    { { <span class="stringliteral">&quot;set&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a9b9bb8b5320daee1cee272e0ff50b224">handle_setcallerid</a>, <span class="stringliteral">&quot;Sets callerid for the current channel&quot;</span>, <a class="code" href="res__agi_8c.html#a40e890b2cbc8187072a2cfca5ae4e263">usage_setcallerid</a> , 0 },
<a name="l02508"></a>02508    { { <span class="stringliteral">&quot;set&quot;</span>, <span class="stringliteral">&quot;context&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#ae65221b6965dabc63f4d61e881d21bc2">handle_setcontext</a>, <span class="stringliteral">&quot;Sets channel context&quot;</span>, <a class="code" href="res__agi_8c.html#ade5cdf2986d099392487722326b88e83">usage_setcontext</a> , 0 },
<a name="l02509"></a>02509    { { <span class="stringliteral">&quot;set&quot;</span>, <span class="stringliteral">&quot;extension&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a1be98b425c01f5782fc734060fac7b86">handle_setextension</a>, <span class="stringliteral">&quot;Changes channel extension&quot;</span>, <a class="code" href="res__agi_8c.html#aab3cf033e8508967af0db03f629d5631">usage_setextension</a> , 0 },
<a name="l02510"></a>02510    { { <span class="stringliteral">&quot;set&quot;</span>, <span class="stringliteral">&quot;music&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a40cb547da440ea7e6a660a6e7ca38800">handle_setmusic</a>, NULL, NULL, 0 },
<a name="l02511"></a>02511    { { <span class="stringliteral">&quot;set&quot;</span>, <span class="stringliteral">&quot;priority&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a89a5c005b9bba62bec6c26c20a760d1e">handle_setpriority</a>, <span class="stringliteral">&quot;Set channel dialplan priority&quot;</span>, <a class="code" href="res__agi_8c.html#a2ed63140091526fb8ffff8e0d0d907fd">usage_setpriority</a> , 0 },
<a name="l02512"></a>02512    { { <span class="stringliteral">&quot;set&quot;</span>, <span class="stringliteral">&quot;variable&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a17db4294de5b3dc66985210146dfaa63">handle_setvariable</a>, <span class="stringliteral">&quot;Sets a channel variable&quot;</span>, <a class="code" href="res__agi_8c.html#a59fc0c44b51e39c4cdec26612a381e6a">usage_setvariable</a> , 1 },
<a name="l02513"></a>02513    { { <span class="stringliteral">&quot;stream&quot;</span>, <span class="stringliteral">&quot;file&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#aff6ffa19d4e9193b102f700a8b6a8c72">handle_streamfile</a>, <span class="stringliteral">&quot;Sends audio file on channel&quot;</span>, <a class="code" href="res__agi_8c.html#a6315bd9fb68ee24479b31060b9c8b5d6">usage_streamfile</a> , 0 },
<a name="l02514"></a>02514    { { <span class="stringliteral">&quot;control&quot;</span>, <span class="stringliteral">&quot;stream&quot;</span>, <span class="stringliteral">&quot;file&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a372e9e6882d7691f1bcabe1f1022ad77">handle_controlstreamfile</a>, <span class="stringliteral">&quot;Sends audio file on channel and allows the listner to control the stream&quot;</span>, <a class="code" href="res__agi_8c.html#ad53e15e6497497ebb28343c8ff8eb937">usage_controlstreamfile</a> , 0 },
<a name="l02515"></a>02515    { { <span class="stringliteral">&quot;tdd&quot;</span>, <span class="stringliteral">&quot;mode&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a7649d1dc982e052d5f8afdf07e68e01a">handle_tddmode</a>, <span class="stringliteral">&quot;Toggles TDD mode (for the deaf)&quot;</span>, <a class="code" href="res__agi_8c.html#a847c58942e8868705cd6a061a390dbf5">usage_tddmode</a> , 0 },
<a name="l02516"></a>02516    { { <span class="stringliteral">&quot;verbose&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a3ca4d957caec4001d39b9e5367d99544">handle_verbose</a>, <span class="stringliteral">&quot;Logs a message to the asterisk verbose log&quot;</span>, <a class="code" href="res__agi_8c.html#af5263f6b78d68e625388b486379f541c">usage_verbose</a> , 1 },
<a name="l02517"></a>02517    { { <span class="stringliteral">&quot;wait&quot;</span>, <span class="stringliteral">&quot;for&quot;</span>, <span class="stringliteral">&quot;digit&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#adc0a2ed0bc1cb5489b1cdbd4ef5e87cc">handle_waitfordigit</a>, <span class="stringliteral">&quot;Waits for a digit to be pressed&quot;</span>, <a class="code" href="res__agi_8c.html#ad729d6ad5e5798b648147967431999c1">usage_waitfordigit</a> , 0 },
<a name="l02518"></a>02518    { { <span class="stringliteral">&quot;speech&quot;</span>, <span class="stringliteral">&quot;create&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#aa90bee612c39726accbc5b634f6e0fce">handle_speechcreate</a>, <span class="stringliteral">&quot;Creates a speech object&quot;</span>, <a class="code" href="res__agi_8c.html#a4e70c1ea391b59ba9041e1f5c6c7a8eb">usage_speechcreate</a>, 0 },
<a name="l02519"></a>02519    { { <span class="stringliteral">&quot;speech&quot;</span>, <span class="stringliteral">&quot;set&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a5e46049a3abd911b172286812c4cb2ad">handle_speechset</a>, <span class="stringliteral">&quot;Sets a speech engine setting&quot;</span>, <a class="code" href="res__agi_8c.html#ab141d81491570149c8b0acd1b2d14dc7">usage_speechset</a>, 0 },
<a name="l02520"></a>02520    { { <span class="stringliteral">&quot;speech&quot;</span>, <span class="stringliteral">&quot;destroy&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a97859236d1f099fde3f3cbe49627d033">handle_speechdestroy</a>, <span class="stringliteral">&quot;Destroys a speech object&quot;</span>, <a class="code" href="res__agi_8c.html#a78f9822db494a9c9b0da9566e1b8339f">usage_speechdestroy</a>, 1 },
<a name="l02521"></a>02521    { { <span class="stringliteral">&quot;speech&quot;</span>, <span class="stringliteral">&quot;load&quot;</span>, <span class="stringliteral">&quot;grammar&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a5998b1d3d4f3940e0c038762d8eab934">handle_speechloadgrammar</a>, <span class="stringliteral">&quot;Loads a grammar&quot;</span>, <a class="code" href="res__agi_8c.html#a0a8e674d22b78c96d47fc32e897eae92">usage_speechloadgrammar</a>, 0 },
<a name="l02522"></a>02522    { { <span class="stringliteral">&quot;speech&quot;</span>, <span class="stringliteral">&quot;unload&quot;</span>, <span class="stringliteral">&quot;grammar&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a2ea45faeeea820383d07481d0c6ce6b2">handle_speechunloadgrammar</a>, <span class="stringliteral">&quot;Unloads a grammar&quot;</span>, <a class="code" href="res__agi_8c.html#a910077e51bd02f73a9c0f5d0e012fc6e">usage_speechunloadgrammar</a>, 1 },
<a name="l02523"></a>02523    { { <span class="stringliteral">&quot;speech&quot;</span>, <span class="stringliteral">&quot;activate&quot;</span>, <span class="stringliteral">&quot;grammar&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#a033d17c0578c97da0710a8dbac34c9fe">handle_speechactivategrammar</a>, <span class="stringliteral">&quot;Activates a grammar&quot;</span>, <a class="code" href="res__agi_8c.html#ab5b602db609d4ab2f0952157f6965aef">usage_speechactivategrammar</a>, 0 },
<a name="l02524"></a>02524    { { <span class="stringliteral">&quot;speech&quot;</span>, <span class="stringliteral">&quot;deactivate&quot;</span>, <span class="stringliteral">&quot;grammar&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#abada370b956947183a8db08c90a21d48">handle_speechdeactivategrammar</a>, <span class="stringliteral">&quot;Deactivates a grammar&quot;</span>, <a class="code" href="res__agi_8c.html#a5c5e28526695137a7166643be59d37a9">usage_speechdeactivategrammar</a>, 0 },
<a name="l02525"></a>02525    { { <span class="stringliteral">&quot;speech&quot;</span>, <span class="stringliteral">&quot;recognize&quot;</span>, NULL }, <a class="code" href="res__agi_8c.html#ac7c1ef3ec14b081e99818e7b3b3b53ef">handle_speechrecognize</a>, <span class="stringliteral">&quot;Recognizes speech&quot;</span>, <a class="code" href="res__agi_8c.html#a92fdf5fd3a78976f2d469dcd0f9832f1">usage_speechrecognize</a>, 0 },
<a name="l02526"></a>02526 };
<a name="l02527"></a>02527 
<a name="l02528"></a><a class="code" href="structagi__commands.html#ace4e0066a5b24f84b90536e9906619f6">02528</a> <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structagi__commands.html">agi_commands</a>, <a class="code" href="structagi__command.html">agi_command</a>);
<a name="l02529"></a>02529 
<a name="l02530"></a><a class="code" href="res__agi_8c.html#ab1b1b3f1bd30a7daef013ba698a1ca72">02530</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#ab1b1b3f1bd30a7daef013ba698a1ca72">help_workhorse</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">match</a>[])
<a name="l02531"></a>02531 {
<a name="l02532"></a>02532    <span class="keywordtype">char</span> fullcmd[<a class="code" href="res__agi_8c.html#a1eb73c104b484cf18752169509cebfe2">MAX_CMD_LEN</a>], matchstr[<a class="code" href="res__agi_8c.html#a1eb73c104b484cf18752169509cebfe2">MAX_CMD_LEN</a>];
<a name="l02533"></a>02533    <span class="keyword">struct </span><a class="code" href="structagi__command.html">agi_command</a> *e;
<a name="l02534"></a>02534 
<a name="l02535"></a>02535    <span class="keywordflow">if</span> (match)
<a name="l02536"></a>02536       <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(matchstr, <span class="keyword">sizeof</span>(matchstr), match);
<a name="l02537"></a>02537 
<a name="l02538"></a>02538    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%5.5s %30.30s   %s\n&quot;</span>,<span class="stringliteral">&quot;Dead&quot;</span>,<span class="stringliteral">&quot;Command&quot;</span>,<span class="stringliteral">&quot;Description&quot;</span>);
<a name="l02539"></a>02539    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l02540"></a>02540    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>, e, list) {
<a name="l02541"></a>02541       <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>[0])
<a name="l02542"></a>02542          <span class="keywordflow">break</span>;
<a name="l02543"></a>02543       <span class="comment">/* Hide commands that start with &apos;_&apos; */</span>
<a name="l02544"></a>02544       <span class="keywordflow">if</span> ((e-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>[0])[0] == <span class="charliteral">&apos;_&apos;</span>)
<a name="l02545"></a>02545          <span class="keywordflow">continue</span>;
<a name="l02546"></a>02546       <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(fullcmd, <span class="keyword">sizeof</span>(fullcmd), e-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>);
<a name="l02547"></a>02547       <span class="keywordflow">if</span> (match &amp;&amp; strncasecmp(matchstr, fullcmd, strlen(matchstr)))
<a name="l02548"></a>02548          <span class="keywordflow">continue</span>;
<a name="l02549"></a>02549       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%5.5s %30.30s   %s\n&quot;</span>, e-&gt;<a class="code" href="structagi__command.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a> ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span> , fullcmd, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(e-&gt;<a class="code" href="structagi__command.html#a322a4c1fa51c3fb9a98f2d329a90ecfa">summary</a>, <span class="stringliteral">&quot;Not available&quot;</span>));
<a name="l02550"></a>02550    }
<a name="l02551"></a>02551    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l02552"></a>02552 
<a name="l02553"></a>02553    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02554"></a>02554 }
<a name="l02555"></a>02555 
<a name="l02556"></a><a class="code" href="res__agi_8c.html#a804e968a8501b438575e4a3f5225eb54">02556</a> <span class="keywordtype">int</span> <a class="code" href="agi_8h.html#afe81c085edf65781e742c210d04faee7" title="Registers an AGI command.">ast_agi_register</a>(<span class="keyword">struct</span> <a class="code" href="structast__module.html">ast_module</a> *<a class="code" href="structagi__command.html#a782aff512368932b8d71b3633f88cb04">mod</a>, <a class="code" href="structagi__command.html">agi_command</a> *cmd)
<a name="l02557"></a>02557 {
<a name="l02558"></a>02558    <span class="keywordtype">char</span> fullcmd[<a class="code" href="res__agi_8c.html#a1eb73c104b484cf18752169509cebfe2">MAX_CMD_LEN</a>];
<a name="l02559"></a>02559 
<a name="l02560"></a>02560    <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(fullcmd, <span class="keyword">sizeof</span>(fullcmd), cmd-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>);
<a name="l02561"></a>02561 
<a name="l02562"></a>02562    <span class="keywordflow">if</span> (!<a class="code" href="res__agi_8c.html#ace45cfd0b2306ec060fa4a788b976125">find_command</a>(cmd-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>,1)) {
<a name="l02563"></a>02563       cmd-&gt;<a class="code" href="structagi__command.html#aa871ca3c361d229d4e37edf3c6016cc1">docsrc</a> = <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3a7273ed64a1fd4a93692986eac376124a">AST_STATIC_DOC</a>;
<a name="l02564"></a>02564       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cmd-&gt;<a class="code" href="structagi__command.html#a322a4c1fa51c3fb9a98f2d329a90ecfa">summary</a>) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cmd-&gt;<a class="code" href="structagi__command.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a>)) {
<a name="l02565"></a>02565 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l02566"></a>02566 <span class="preprocessor"></span>         *((<span class="keywordtype">char</span> **) &amp;cmd-&gt;<a class="code" href="structagi__command.html#a322a4c1fa51c3fb9a98f2d329a90ecfa">summary</a>) = <a class="code" href="xmldoc_8h.html#a92ab99fc2fa8a31c591531b36d391e3f" title="Generate synopsis documentation from XML.">ast_xmldoc_build_synopsis</a>(<span class="stringliteral">&quot;agi&quot;</span>, fullcmd);
<a name="l02567"></a>02567          *((<span class="keywordtype">char</span> **) &amp;cmd-&gt;<a class="code" href="structagi__command.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a>) = <a class="code" href="xmldoc_8h.html#a7e6109ee5ae553d1fb3b6e7a7c4617f9" title="Generate description documentation from XML.">ast_xmldoc_build_description</a>(<span class="stringliteral">&quot;agi&quot;</span>, fullcmd);
<a name="l02568"></a>02568          *((<span class="keywordtype">char</span> **) &amp;cmd-&gt;<a class="code" href="structagi__command.html#affcabda568112959a0d397995e46eff0">syntax</a>) = <a class="code" href="xmldoc_8h.html#a54a5b2e3ff1b6b6f06d9bab70e70c924" title="Get the syntax for a specified application or function.">ast_xmldoc_build_syntax</a>(<span class="stringliteral">&quot;agi&quot;</span>, fullcmd);
<a name="l02569"></a>02569          *((<span class="keywordtype">char</span> **) &amp;cmd-&gt;<a class="code" href="structagi__command.html#a569b4bafa00f6a7b717316233cbb8f0d">seealso</a>) = <a class="code" href="xmldoc_8h.html#a51987b5bfa995cc9b76c81dd1a1d6ad4" title="Parse the &amp;lt;see-also&amp;gt; node content.">ast_xmldoc_build_seealso</a>(<span class="stringliteral">&quot;agi&quot;</span>, fullcmd);
<a name="l02570"></a>02570          *((<span class="keyword">enum</span> <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3" title="From where the documentation come from.">ast_doc_src</a> *) &amp;cmd-&gt;<a class="code" href="structagi__command.html#aa871ca3c361d229d4e37edf3c6016cc1">docsrc</a>) = <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3a24212840b7b1b0e9c1eebc8cfd89ab3e">AST_XML_DOC</a>;
<a name="l02571"></a>02571 <span class="preprocessor">#elif (!defined(HAVE_NULLSAFE_PRINTF))</span>
<a name="l02572"></a>02572 <span class="preprocessor"></span>         *((<span class="keywordtype">char</span> **) &amp;cmd-&gt;<a class="code" href="structagi__command.html#a322a4c1fa51c3fb9a98f2d329a90ecfa">summary</a>) = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;&quot;</span>);
<a name="l02573"></a>02573          *((<span class="keywordtype">char</span> **) &amp;cmd-&gt;<a class="code" href="structagi__command.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a>) = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;&quot;</span>);
<a name="l02574"></a>02574          *((<span class="keywordtype">char</span> **) &amp;cmd-&gt;<a class="code" href="structagi__command.html#affcabda568112959a0d397995e46eff0">syntax</a>) = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;&quot;</span>);
<a name="l02575"></a>02575          *((<span class="keywordtype">char</span> **) &amp;cmd-&gt;<a class="code" href="structagi__command.html#a569b4bafa00f6a7b717316233cbb8f0d">seealso</a>) = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;&quot;</span>);
<a name="l02576"></a>02576 <span class="preprocessor">#endif</span>
<a name="l02577"></a>02577 <span class="preprocessor"></span>      }
<a name="l02578"></a>02578 
<a name="l02579"></a>02579       cmd-&gt;<a class="code" href="structagi__command.html#a782aff512368932b8d71b3633f88cb04">mod</a> = mod;
<a name="l02580"></a>02580       <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l02581"></a>02581       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>, cmd, list);
<a name="l02582"></a>02582       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l02583"></a>02583       <span class="keywordflow">if</span> (mod != <a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self)
<a name="l02584"></a>02584          <a class="code" href="module_8h.html#aa08fcee0b390e15532dd03803c8728c4">ast_module_ref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l02585"></a>02585       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;AGI Command &apos;%s&apos; registered\n&quot;</span>,fullcmd);
<a name="l02586"></a>02586       <span class="keywordflow">return</span> 1;
<a name="l02587"></a>02587    } <span class="keywordflow">else</span> {
<a name="l02588"></a>02588       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Command already registered!\n&quot;</span>);
<a name="l02589"></a>02589       <span class="keywordflow">return</span> 0;
<a name="l02590"></a>02590    }
<a name="l02591"></a>02591 }
<a name="l02592"></a>02592 
<a name="l02593"></a><a class="code" href="res__agi_8c.html#a6b0a0ed34df434ec14745bf41cbc2b44">02593</a> <span class="keywordtype">int</span> <a class="code" href="agi_8h.html#a5c58e70045d4c8668cefc91a29578901" title="Unregisters an AGI command.">ast_agi_unregister</a>(<span class="keyword">struct</span> <a class="code" href="structast__module.html">ast_module</a> *<a class="code" href="structagi__command.html#a782aff512368932b8d71b3633f88cb04">mod</a>, <a class="code" href="structagi__command.html">agi_command</a> *cmd)
<a name="l02594"></a>02594 {
<a name="l02595"></a>02595    <span class="keyword">struct </span><a class="code" href="structagi__command.html">agi_command</a> *e;
<a name="l02596"></a>02596    <span class="keywordtype">int</span> unregistered = 0;
<a name="l02597"></a>02597    <span class="keywordtype">char</span> fullcmd[<a class="code" href="res__agi_8c.html#a1eb73c104b484cf18752169509cebfe2">MAX_CMD_LEN</a>];
<a name="l02598"></a>02598 
<a name="l02599"></a>02599    <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(fullcmd, <span class="keyword">sizeof</span>(fullcmd), cmd-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>);
<a name="l02600"></a>02600 
<a name="l02601"></a>02601    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l02602"></a>02602    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>, e, list) {
<a name="l02603"></a>02603       <span class="keywordflow">if</span> (cmd == e) {
<a name="l02604"></a>02604          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(list);
<a name="l02605"></a>02605          <span class="keywordflow">if</span> (mod != <a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self)
<a name="l02606"></a>02606             <a class="code" href="module_8h.html#ac65fa15b16dbc563a2424af744ab003d">ast_module_unref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l02607"></a>02607 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l02608"></a>02608 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structagi__command.html#aa871ca3c361d229d4e37edf3c6016cc1">docsrc</a> == <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3a24212840b7b1b0e9c1eebc8cfd89ab3e">AST_XML_DOC</a>) {
<a name="l02609"></a>02609             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(e-&gt;<a class="code" href="structagi__command.html#a322a4c1fa51c3fb9a98f2d329a90ecfa">summary</a>);
<a name="l02610"></a>02610             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(e-&gt;<a class="code" href="structagi__command.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a>);
<a name="l02611"></a>02611             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(e-&gt;<a class="code" href="structagi__command.html#affcabda568112959a0d397995e46eff0">syntax</a>);
<a name="l02612"></a>02612             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(e-&gt;<a class="code" href="structagi__command.html#a569b4bafa00f6a7b717316233cbb8f0d">seealso</a>);
<a name="l02613"></a>02613             e-&gt;<a class="code" href="structagi__command.html#a322a4c1fa51c3fb9a98f2d329a90ecfa">summary</a> = NULL, e-&gt;<a class="code" href="structagi__command.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a> = NULL;
<a name="l02614"></a>02614             e-&gt;<a class="code" href="structagi__command.html#affcabda568112959a0d397995e46eff0">syntax</a> = NULL, e-&gt;<a class="code" href="structagi__command.html#a569b4bafa00f6a7b717316233cbb8f0d">seealso</a> = NULL;
<a name="l02615"></a>02615          }
<a name="l02616"></a>02616 <span class="preprocessor">#endif</span>
<a name="l02617"></a>02617 <span class="preprocessor"></span>         unregistered=1;
<a name="l02618"></a>02618          <span class="keywordflow">break</span>;
<a name="l02619"></a>02619       }
<a name="l02620"></a>02620    }
<a name="l02621"></a>02621    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l02622"></a>02622    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l02623"></a>02623    <span class="keywordflow">if</span> (unregistered)
<a name="l02624"></a>02624       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;AGI Command &apos;%s&apos; unregistered\n&quot;</span>,fullcmd);
<a name="l02625"></a>02625    <span class="keywordflow">else</span>
<a name="l02626"></a>02626       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to unregister command: &apos;%s&apos;!\n&quot;</span>,fullcmd);
<a name="l02627"></a>02627    <span class="keywordflow">return</span> unregistered;
<a name="l02628"></a>02628 }
<a name="l02629"></a>02629 
<a name="l02630"></a><a class="code" href="res__agi_8c.html#af79c7793b8175d4e87795c624957bed5">02630</a> <span class="keywordtype">int</span> <a class="code" href="agi_8h.html#a8025b9327d8a870c7455a29355222b9c" title="Registers a group of AGI commands, provided as an array of struct agi_command entries...">ast_agi_register_multiple</a>(<span class="keyword">struct</span> <a class="code" href="structast__module.html">ast_module</a> *<a class="code" href="structagi__command.html#a782aff512368932b8d71b3633f88cb04">mod</a>, <span class="keyword">struct</span> <a class="code" href="structagi__command.html">agi_command</a> *cmd, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l02631"></a>02631 {
<a name="l02632"></a>02632    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, x = 0;
<a name="l02633"></a>02633 
<a name="l02634"></a>02634    <span class="keywordflow">for</span> (i = 0; i &lt; len; i++) {
<a name="l02635"></a>02635       <span class="keywordflow">if</span> (<a class="code" href="agi_8h.html#afe81c085edf65781e742c210d04faee7" title="Registers an AGI command.">ast_agi_register</a>(mod, cmd + i) == 1) {
<a name="l02636"></a>02636          x++;
<a name="l02637"></a>02637          <span class="keywordflow">continue</span>;
<a name="l02638"></a>02638       }
<a name="l02639"></a>02639 
<a name="l02640"></a>02640       <span class="comment">/* registration failed, unregister everything</span>
<a name="l02641"></a>02641 <span class="comment">         that had been registered up to that point</span>
<a name="l02642"></a>02642 <span class="comment">      */</span>
<a name="l02643"></a>02643       <span class="keywordflow">for</span> (; x &gt; 0; x--) {
<a name="l02644"></a>02644          <span class="comment">/* we are intentionally ignoring the</span>
<a name="l02645"></a>02645 <span class="comment">            result of ast_agi_unregister() here,</span>
<a name="l02646"></a>02646 <span class="comment">            but it should be safe to do so since</span>
<a name="l02647"></a>02647 <span class="comment">            we just registered these commands and</span>
<a name="l02648"></a>02648 <span class="comment">            the only possible way for unregistration</span>
<a name="l02649"></a>02649 <span class="comment">            to fail is if the command is not</span>
<a name="l02650"></a>02650 <span class="comment">            registered</span>
<a name="l02651"></a>02651 <span class="comment">         */</span>
<a name="l02652"></a>02652          (void) <a class="code" href="agi_8h.html#a5c58e70045d4c8668cefc91a29578901" title="Unregisters an AGI command.">ast_agi_unregister</a>(mod, cmd + x - 1);
<a name="l02653"></a>02653       }
<a name="l02654"></a>02654       <span class="keywordflow">return</span> -1;
<a name="l02655"></a>02655    }
<a name="l02656"></a>02656 
<a name="l02657"></a>02657    <span class="keywordflow">return</span> 0;
<a name="l02658"></a>02658 }
<a name="l02659"></a>02659 
<a name="l02660"></a><a class="code" href="res__agi_8c.html#ae9f2c928085a1aa358547b6a07720bbc">02660</a> <span class="keywordtype">int</span> <a class="code" href="agi_8h.html#ae36ca908f67e1d7daff5b42c29107ab8" title="Unregisters a group of AGI commands, provided as an array of struct agi_command entries...">ast_agi_unregister_multiple</a>(<span class="keyword">struct</span> <a class="code" href="structast__module.html">ast_module</a> *<a class="code" href="structagi__command.html#a782aff512368932b8d71b3633f88cb04">mod</a>, <span class="keyword">struct</span> <a class="code" href="structagi__command.html">agi_command</a> *cmd, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l02661"></a>02661 {
<a name="l02662"></a>02662    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l02663"></a>02663    <span class="keywordtype">int</span> res = 0;
<a name="l02664"></a>02664 
<a name="l02665"></a>02665    <span class="keywordflow">for</span> (i = 0; i &lt; len; i++) {
<a name="l02666"></a>02666       <span class="comment">/* remember whether any of the unregistration</span>
<a name="l02667"></a>02667 <span class="comment">         attempts failed... there is no recourse if</span>
<a name="l02668"></a>02668 <span class="comment">         any of them do</span>
<a name="l02669"></a>02669 <span class="comment">      */</span>
<a name="l02670"></a>02670       res |= <a class="code" href="agi_8h.html#a5c58e70045d4c8668cefc91a29578901" title="Unregisters an AGI command.">ast_agi_unregister</a>(mod, cmd + i);
<a name="l02671"></a>02671    }
<a name="l02672"></a>02672 
<a name="l02673"></a>02673    <span class="keywordflow">return</span> res;
<a name="l02674"></a>02674 }
<a name="l02675"></a>02675 
<a name="l02676"></a><a class="code" href="res__agi_8c.html#ace45cfd0b2306ec060fa4a788b976125">02676</a> <span class="keyword">static</span> <a class="code" href="structagi__command.html">agi_command</a> *<a class="code" href="res__agi_8c.html#ace45cfd0b2306ec060fa4a788b976125">find_command</a>(<span class="keywordtype">char</span> *cmds[], <span class="keywordtype">int</span> exact)
<a name="l02677"></a>02677 {
<a name="l02678"></a>02678    <span class="keywordtype">int</span> y, <a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">match</a>;
<a name="l02679"></a>02679    <span class="keyword">struct </span><a class="code" href="structagi__command.html">agi_command</a> *e;
<a name="l02680"></a>02680 
<a name="l02681"></a>02681    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l02682"></a>02682    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>, e, list) {
<a name="l02683"></a>02683       <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>[0])
<a name="l02684"></a>02684          <span class="keywordflow">break</span>;
<a name="l02685"></a>02685       <span class="comment">/* start optimistic */</span>
<a name="l02686"></a>02686       match = 1;
<a name="l02687"></a>02687       <span class="keywordflow">for</span> (y = 0; match &amp;&amp; cmds[y]; y++) {
<a name="l02688"></a>02688          <span class="comment">/* If there are no more words in the command (and we&apos;re looking for</span>
<a name="l02689"></a>02689 <span class="comment">            an exact match) or there is a difference between the two words,</span>
<a name="l02690"></a>02690 <span class="comment">            then this is not a match */</span>
<a name="l02691"></a>02691          <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>[y] &amp;&amp; !exact)
<a name="l02692"></a>02692             <span class="keywordflow">break</span>;
<a name="l02693"></a>02693          <span class="comment">/* don&apos;t segfault if the next part of a command doesn&apos;t exist */</span>
<a name="l02694"></a>02694          <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>[y]) {
<a name="l02695"></a>02695             <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l02696"></a>02696             <span class="keywordflow">return</span> NULL;
<a name="l02697"></a>02697          }
<a name="l02698"></a>02698          <span class="keywordflow">if</span> (strcasecmp(e-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>[y], cmds[y]))
<a name="l02699"></a>02699             match = 0;
<a name="l02700"></a>02700       }
<a name="l02701"></a>02701       <span class="comment">/* If more words are needed to complete the command then this is not</span>
<a name="l02702"></a>02702 <span class="comment">         a candidate (unless we&apos;re looking for a really inexact answer  */</span>
<a name="l02703"></a>02703       <span class="keywordflow">if</span> ((exact &gt; -1) &amp;&amp; e-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>[y])
<a name="l02704"></a>02704          match = 0;
<a name="l02705"></a>02705       <span class="keywordflow">if</span> (match) {
<a name="l02706"></a>02706          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l02707"></a>02707          <span class="keywordflow">return</span> e;
<a name="l02708"></a>02708       }
<a name="l02709"></a>02709    }
<a name="l02710"></a>02710    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l02711"></a>02711    <span class="keywordflow">return</span> NULL;
<a name="l02712"></a>02712 }
<a name="l02713"></a>02713 
<a name="l02714"></a><a class="code" href="res__agi_8c.html#a29deaf4449313c37a9a9106568f902e9">02714</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a29deaf4449313c37a9a9106568f902e9">parse_args</a>(<span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> *max, <span class="keywordtype">char</span> *argv[])
<a name="l02715"></a>02715 {
<a name="l02716"></a>02716    <span class="keywordtype">int</span> x = 0, quoted = 0, escaped = 0, whitespace = 1;
<a name="l02717"></a>02717    <span class="keywordtype">char</span> *cur;
<a name="l02718"></a>02718 
<a name="l02719"></a>02719    cur = s;
<a name="l02720"></a>02720    <span class="keywordflow">while</span>(*s) {
<a name="l02721"></a>02721       <span class="keywordflow">switch</span>(*s) {
<a name="l02722"></a>02722       <span class="keywordflow">case</span> <span class="charliteral">&apos;&quot;&apos;</span>:
<a name="l02723"></a>02723          <span class="comment">/* If it&apos;s escaped, put a literal quote */</span>
<a name="l02724"></a>02724          <span class="keywordflow">if</span> (escaped)
<a name="l02725"></a>02725             <span class="keywordflow">goto</span> normal;
<a name="l02726"></a>02726          <span class="keywordflow">else</span>
<a name="l02727"></a>02727             quoted = !quoted;
<a name="l02728"></a>02728          <span class="keywordflow">if</span> (quoted &amp;&amp; whitespace) {
<a name="l02729"></a>02729             <span class="comment">/* If we&apos;re starting a quote, coming off white space start a new word, too */</span>
<a name="l02730"></a>02730             argv[x++] = cur;
<a name="l02731"></a>02731             whitespace=0;
<a name="l02732"></a>02732          }
<a name="l02733"></a>02733          escaped = 0;
<a name="l02734"></a>02734       <span class="keywordflow">break</span>;
<a name="l02735"></a>02735       <span class="keywordflow">case</span> <span class="charliteral">&apos; &apos;</span>:
<a name="l02736"></a>02736       <span class="keywordflow">case</span> <span class="charliteral">&apos;\t&apos;</span>:
<a name="l02737"></a>02737          <span class="keywordflow">if</span> (!quoted &amp;&amp; !escaped) {
<a name="l02738"></a>02738             <span class="comment">/* If we&apos;re not quoted, mark this as whitespace, and</span>
<a name="l02739"></a>02739 <span class="comment">               end the previous argument */</span>
<a name="l02740"></a>02740             whitespace = 1;
<a name="l02741"></a>02741             *(cur++) = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02742"></a>02742          } <span class="keywordflow">else</span>
<a name="l02743"></a>02743             <span class="comment">/* Otherwise, just treat it as anything else */</span>
<a name="l02744"></a>02744             <span class="keywordflow">goto</span> normal;
<a name="l02745"></a>02745          <span class="keywordflow">break</span>;
<a name="l02746"></a>02746       <span class="keywordflow">case</span> <span class="charliteral">&apos;\\&apos;</span>:
<a name="l02747"></a>02747          <span class="comment">/* If we&apos;re escaped, print a literal, otherwise enable escaping */</span>
<a name="l02748"></a>02748          <span class="keywordflow">if</span> (escaped) {
<a name="l02749"></a>02749             <span class="keywordflow">goto</span> normal;
<a name="l02750"></a>02750          } <span class="keywordflow">else</span> {
<a name="l02751"></a>02751             escaped=1;
<a name="l02752"></a>02752          }
<a name="l02753"></a>02753          <span class="keywordflow">break</span>;
<a name="l02754"></a>02754       <span class="keywordflow">default</span>:
<a name="l02755"></a>02755 normal:
<a name="l02756"></a>02756          <span class="keywordflow">if</span> (whitespace) {
<a name="l02757"></a>02757             <span class="keywordflow">if</span> (x &gt;= <a class="code" href="app__macro_8c.html#a29b7451465deac204c5f7cb1f9c6e1fc">MAX_ARGS</a> -1) {
<a name="l02758"></a>02758                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Too many arguments, truncating\n&quot;</span>);
<a name="l02759"></a>02759                <span class="keywordflow">break</span>;
<a name="l02760"></a>02760             }
<a name="l02761"></a>02761             <span class="comment">/* Coming off of whitespace, start the next argument */</span>
<a name="l02762"></a>02762             argv[x++] = cur;
<a name="l02763"></a>02763             whitespace=0;
<a name="l02764"></a>02764          }
<a name="l02765"></a>02765          *(cur++) = *s;
<a name="l02766"></a>02766          escaped=0;
<a name="l02767"></a>02767       }
<a name="l02768"></a>02768       s++;
<a name="l02769"></a>02769    }
<a name="l02770"></a>02770    <span class="comment">/* Null terminate */</span>
<a name="l02771"></a>02771    *(cur++) = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02772"></a>02772    argv[x] = NULL;
<a name="l02773"></a>02773    *max = x;
<a name="l02774"></a>02774    <span class="keywordflow">return</span> 0;
<a name="l02775"></a>02775 }
<a name="l02776"></a>02776 
<a name="l02777"></a><a class="code" href="res__agi_8c.html#ac9faf2222a97b9abbab8430992c8da2f">02777</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ac9faf2222a97b9abbab8430992c8da2f">agi_handle_command</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> <a class="code" href="structagi__command.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a>)
<a name="l02778"></a>02778 {
<a name="l02779"></a>02779    <span class="keywordtype">char</span> *argv[<a class="code" href="app__macro_8c.html#a29b7451465deac204c5f7cb1f9c6e1fc">MAX_ARGS</a>];
<a name="l02780"></a>02780    <span class="keywordtype">int</span> argc = <a class="code" href="app__macro_8c.html#a29b7451465deac204c5f7cb1f9c6e1fc">MAX_ARGS</a>, res;
<a name="l02781"></a>02781    <a class="code" href="structagi__command.html">agi_command</a> *c;
<a name="l02782"></a>02782    <span class="keyword">const</span> <span class="keywordtype">char</span> *ami_res = <span class="stringliteral">&quot;Unknown Result&quot;</span>;
<a name="l02783"></a>02783    <span class="keywordtype">char</span> *ami_cmd = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(buf);
<a name="l02784"></a>02784    <span class="keywordtype">int</span> command_id = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>(), resultcode = 200;
<a name="l02785"></a>02785 
<a name="l02786"></a>02786    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ac7370fe764f1305cdb3c543d3964d5ed">EVENT_FLAG_AGI</a>, <span class="stringliteral">&quot;AGIExec&quot;</span>,
<a name="l02787"></a>02787          <span class="stringliteral">&quot;SubEvent: Start\r\n&quot;</span>
<a name="l02788"></a>02788          <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l02789"></a>02789          <span class="stringliteral">&quot;CommandId: %d\r\n&quot;</span>
<a name="l02790"></a>02790          <span class="stringliteral">&quot;Command: %s\r\n&quot;</span>, chan-&gt;name, command_id, ami_cmd);
<a name="l02791"></a>02791    <a class="code" href="res__agi_8c.html#a29deaf4449313c37a9a9106568f902e9">parse_args</a>(buf, &amp;argc, argv);
<a name="l02792"></a>02792    <span class="keywordflow">if</span> ((c = <a class="code" href="res__agi_8c.html#ace45cfd0b2306ec060fa4a788b976125">find_command</a>(argv, 0)) &amp;&amp; (!dead || (dead &amp;&amp; c-&gt;<a class="code" href="structagi__command.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a>))) {
<a name="l02793"></a>02793       <span class="comment">/* if this command wasnt registered by res_agi, be sure to usecount</span>
<a name="l02794"></a>02794 <span class="comment">      the module we are using */</span>
<a name="l02795"></a>02795       <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structagi__command.html#a782aff512368932b8d71b3633f88cb04">mod</a> != <a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self)
<a name="l02796"></a>02796          <a class="code" href="module_8h.html#aa08fcee0b390e15532dd03803c8728c4">ast_module_ref</a>(c-&gt;<a class="code" href="structagi__command.html#a782aff512368932b8d71b3633f88cb04">mod</a>);
<a name="l02797"></a>02797       <span class="comment">/* If the AGI command being executed is an actual application (using agi exec)</span>
<a name="l02798"></a>02798 <span class="comment">      the app field will be updated in pbx_exec via handle_exec */</span>
<a name="l02799"></a>02799       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> &amp;&amp; !<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan) &amp;&amp; strcasecmp(argv[0], <span class="stringliteral">&quot;EXEC&quot;</span>))
<a name="l02800"></a>02800          <a class="code" href="cdr_8h.html#a877162d212a320e7daec6aa7f695e9a8" title="Set the last executed application.">ast_cdr_setapp</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, <span class="stringliteral">&quot;AGI&quot;</span>, buf);
<a name="l02801"></a>02801 
<a name="l02802"></a>02802       res = c-&gt;<a class="code" href="structagi__command.html#a1cb96f931725134c528009d5378fa115">handler</a>(chan, agi, argc, argv);
<a name="l02803"></a>02803       <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structagi__command.html#a782aff512368932b8d71b3633f88cb04">mod</a> != <a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self)
<a name="l02804"></a>02804          <a class="code" href="module_8h.html#ac65fa15b16dbc563a2424af744ab003d">ast_module_unref</a>(c-&gt;<a class="code" href="structagi__command.html#a782aff512368932b8d71b3633f88cb04">mod</a>);
<a name="l02805"></a>02805       <span class="keywordflow">switch</span> (res) {
<a name="l02806"></a>02806       <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>: ami_res = <span class="stringliteral">&quot;Usage&quot;</span>; resultcode = 520; <span class="keywordflow">break</span>;
<a name="l02807"></a>02807       <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>: ami_res = <span class="stringliteral">&quot;Failure&quot;</span>; resultcode = -1; <span class="keywordflow">break</span>;
<a name="l02808"></a>02808       <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>: ami_res = <span class="stringliteral">&quot;Success&quot;</span>; resultcode = 200; <span class="keywordflow">break</span>;
<a name="l02809"></a>02809       }
<a name="l02810"></a>02810       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ac7370fe764f1305cdb3c543d3964d5ed">EVENT_FLAG_AGI</a>, <span class="stringliteral">&quot;AGIExec&quot;</span>,
<a name="l02811"></a>02811             <span class="stringliteral">&quot;SubEvent: End\r\n&quot;</span>
<a name="l02812"></a>02812             <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l02813"></a>02813             <span class="stringliteral">&quot;CommandId: %d\r\n&quot;</span>
<a name="l02814"></a>02814             <span class="stringliteral">&quot;Command: %s\r\n&quot;</span>
<a name="l02815"></a>02815             <span class="stringliteral">&quot;ResultCode: %d\r\n&quot;</span>
<a name="l02816"></a>02816             <span class="stringliteral">&quot;Result: %s\r\n&quot;</span>, chan-&gt;name, command_id, ami_cmd, resultcode, ami_res);
<a name="l02817"></a>02817       <span class="keywordflow">switch</span>(res) {
<a name="l02818"></a>02818       <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>:
<a name="l02819"></a>02819          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(c-&gt;<a class="code" href="structagi__command.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a>)) {
<a name="l02820"></a>02820             <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;520 Invalid command syntax.  Proper usage not available.\n&quot;</span>);
<a name="l02821"></a>02821          } <span class="keywordflow">else</span> {
<a name="l02822"></a>02822             <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;520-Invalid command syntax.  Proper usage follows:\n&quot;</span>);
<a name="l02823"></a>02823             <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;%s&quot;</span>, c-&gt;<a class="code" href="structagi__command.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a>);
<a name="l02824"></a>02824             <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;520 End of proper usage.\n&quot;</span>);
<a name="l02825"></a>02825          }
<a name="l02826"></a>02826          <span class="keywordflow">break</span>;
<a name="l02827"></a>02827       <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>:
<a name="l02828"></a>02828          <span class="comment">/* They&apos;ve already given the failure.  We&apos;ve been hung up on so handle this</span>
<a name="l02829"></a>02829 <span class="comment">            appropriately */</span>
<a name="l02830"></a>02830          <span class="keywordflow">return</span> -1;
<a name="l02831"></a>02831       }
<a name="l02832"></a>02832    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c = <a class="code" href="res__agi_8c.html#ace45cfd0b2306ec060fa4a788b976125">find_command</a>(argv, 0))) {
<a name="l02833"></a>02833       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;511 Command Not Permitted on a dead channel\n&quot;</span>);
<a name="l02834"></a>02834       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ac7370fe764f1305cdb3c543d3964d5ed">EVENT_FLAG_AGI</a>, <span class="stringliteral">&quot;AGIExec&quot;</span>,
<a name="l02835"></a>02835             <span class="stringliteral">&quot;SubEvent: End\r\n&quot;</span>
<a name="l02836"></a>02836             <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l02837"></a>02837             <span class="stringliteral">&quot;CommandId: %d\r\n&quot;</span>
<a name="l02838"></a>02838             <span class="stringliteral">&quot;Command: %s\r\n&quot;</span>
<a name="l02839"></a>02839             <span class="stringliteral">&quot;ResultCode: 511\r\n&quot;</span>
<a name="l02840"></a>02840             <span class="stringliteral">&quot;Result: Command not permitted on a dead channel\r\n&quot;</span>, chan-&gt;name, command_id, ami_cmd);
<a name="l02841"></a>02841    } <span class="keywordflow">else</span> {
<a name="l02842"></a>02842       <a class="code" href="agi_8h.html#a122c100fa81c2500a6d69afa642c2495" title="Sends a string of text to an application connected via AGI.">ast_agi_send</a>(agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, chan, <span class="stringliteral">&quot;510 Invalid or unknown command\n&quot;</span>);
<a name="l02843"></a>02843       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ac7370fe764f1305cdb3c543d3964d5ed">EVENT_FLAG_AGI</a>, <span class="stringliteral">&quot;AGIExec&quot;</span>,
<a name="l02844"></a>02844             <span class="stringliteral">&quot;SubEvent: End\r\n&quot;</span>
<a name="l02845"></a>02845             <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l02846"></a>02846             <span class="stringliteral">&quot;CommandId: %d\r\n&quot;</span>
<a name="l02847"></a>02847             <span class="stringliteral">&quot;Command: %s\r\n&quot;</span>
<a name="l02848"></a>02848             <span class="stringliteral">&quot;ResultCode: 510\r\n&quot;</span>
<a name="l02849"></a>02849             <span class="stringliteral">&quot;Result: Invalid or unknown command\r\n&quot;</span>, chan-&gt;name, command_id, ami_cmd);
<a name="l02850"></a>02850    }
<a name="l02851"></a>02851    <span class="keywordflow">return</span> 0;
<a name="l02852"></a>02852 }
<a name="l02853"></a><a class="code" href="res__agi_8c.html#a85e832090276a7a7c018400e2f70c853">02853</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1">agi_result</a> <a class="code" href="res__agi_8c.html#a85e832090276a7a7c018400e2f70c853">run_agi</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> *request, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> pid, <span class="keywordtype">int</span> *<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>, <span class="keywordtype">int</span> <a class="code" href="structagi__command.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a>, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l02854"></a>02854 {
<a name="l02855"></a>02855    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c;
<a name="l02856"></a>02856    <span class="keywordtype">int</span> outfd, ms, needhup = 0;
<a name="l02857"></a>02857    <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1">agi_result</a> returnstatus = <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a493daf1d6c06bbf4b17b36929cc51fd8">AGI_RESULT_SUCCESS</a>;
<a name="l02858"></a>02858    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l02859"></a>02859    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="res__agi_8c.html#acac9c67d43a9e0d04c732fc06665f6dd">AGI_BUF_LEN</a>];
<a name="l02860"></a>02860    <span class="keywordtype">char</span> *res = NULL;
<a name="l02861"></a>02861    FILE *readf;
<a name="l02862"></a>02862    <span class="comment">/* how many times we&apos;ll retry if ast_waitfor_nandfs will return without either</span>
<a name="l02863"></a>02863 <span class="comment">     channel or file descriptor in case select is interrupted by a system call (EINTR) */</span>
<a name="l02864"></a>02864    <span class="keywordtype">int</span> retry = <a class="code" href="res__agi_8c.html#aafc38adf75f284d5cf7e6f11a55bb29f">AGI_NANDFS_RETRY</a>;
<a name="l02865"></a>02865    <span class="keywordtype">int</span> send_sighup;
<a name="l02866"></a>02866    <span class="keyword">const</span> <span class="keywordtype">char</span> *sighup_str;
<a name="l02867"></a>02867    
<a name="l02868"></a>02868    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l02869"></a>02869    sighup_str = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGISIGHUP&quot;</span>);
<a name="l02870"></a>02870    send_sighup = <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(sighup_str) || !<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(sighup_str);
<a name="l02871"></a>02871    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l02872"></a>02872 
<a name="l02873"></a>02873    <span class="keywordflow">if</span> (!(readf = fdopen(agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>, <span class="stringliteral">&quot;r&quot;</span>))) {
<a name="l02874"></a>02874       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to fdopen file descriptor\n&quot;</span>);
<a name="l02875"></a>02875       <span class="keywordflow">if</span> (send_sighup &amp;&amp; pid &gt; -1)
<a name="l02876"></a>02876          kill(pid, SIGHUP);
<a name="l02877"></a>02877       close(agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>);
<a name="l02878"></a>02878       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l02879"></a>02879    }
<a name="l02880"></a>02880    
<a name="l02881"></a>02881    setlinebuf(readf);
<a name="l02882"></a>02882    <a class="code" href="res__agi_8c.html#a1a91f6f01be62db91c4a91250f3d513d">setup_env</a>(chan, request, agi-&gt;<a class="code" href="structagi__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, (agi-&gt;<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a> &gt; -1), argc, argv);
<a name="l02883"></a>02883    <span class="keywordflow">for</span> (;;) {
<a name="l02884"></a>02884       <span class="keywordflow">if</span> (needhup) {
<a name="l02885"></a>02885          needhup = 0;
<a name="l02886"></a>02886          dead = 1;
<a name="l02887"></a>02887          <span class="keywordflow">if</span> (send_sighup) {
<a name="l02888"></a>02888             <span class="keywordflow">if</span> (pid &gt; -1) {
<a name="l02889"></a>02889                kill(pid, SIGHUP);
<a name="l02890"></a>02890             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (agi-&gt;<a class="code" href="structagi__state.html#aa9106f15c17bda42c4e5dc9e0fd96572">fast</a>) {
<a name="l02891"></a>02891                send(agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>, <span class="stringliteral">&quot;HANGUP\n&quot;</span>, 7, MSG_OOB);
<a name="l02892"></a>02892             }
<a name="l02893"></a>02893          }
<a name="l02894"></a>02894       }
<a name="l02895"></a>02895       ms = -1;
<a name="l02896"></a>02896       c = <a class="code" href="channel_8h.html#a5e62602ca9e229304f60ab5c2b32e13b" title="Waits for activity on a group of channels.">ast_waitfor_nandfds</a>(&amp;chan, dead ? 0 : 1, &amp;agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>, 1, NULL, &amp;outfd, &amp;ms);
<a name="l02897"></a>02897       <span class="keywordflow">if</span> (c) {
<a name="l02898"></a>02898          retry = <a class="code" href="res__agi_8c.html#aafc38adf75f284d5cf7e6f11a55bb29f">AGI_NANDFS_RETRY</a>;
<a name="l02899"></a>02899          <span class="comment">/* Idle the channel until we get a command */</span>
<a name="l02900"></a>02900          f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(c);
<a name="l02901"></a>02901          <span class="keywordflow">if</span> (!f) {
<a name="l02902"></a>02902             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s hungup\n&quot;</span>, chan-&gt;name);
<a name="l02903"></a>02903             returnstatus = <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a3efef4607e59ada98318f948f398d8fe">AGI_RESULT_HANGUP</a>;
<a name="l02904"></a>02904             needhup = 1;
<a name="l02905"></a>02905             <span class="keywordflow">continue</span>;
<a name="l02906"></a>02906          } <span class="keywordflow">else</span> {
<a name="l02907"></a>02907             <span class="comment">/* If it&apos;s voice, write it to the audio pipe */</span>
<a name="l02908"></a>02908             <span class="keywordflow">if</span> ((agi-&gt;<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a> &gt; -1) &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>)) {
<a name="l02909"></a>02909                <span class="comment">/* Write, ignoring errors */</span>
<a name="l02910"></a>02910                <span class="keywordflow">if</span> (write(agi-&gt;<a class="code" href="structagi__state.html#a220009426c8518be4b294a02b1194906">audio</a>, f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>) &lt; 0) {
<a name="l02911"></a>02911                }
<a name="l02912"></a>02912             }
<a name="l02913"></a>02913             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l02914"></a>02914          }
<a name="l02915"></a>02915       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (outfd &gt; -1) {
<a name="l02916"></a>02916          <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = <span class="keyword">sizeof</span>(buf);
<a name="l02917"></a>02917          <span class="keywordtype">size_t</span> buflen = 0;
<a name="l02918"></a>02918 
<a name="l02919"></a>02919          retry = <a class="code" href="res__agi_8c.html#aafc38adf75f284d5cf7e6f11a55bb29f">AGI_NANDFS_RETRY</a>;
<a name="l02920"></a>02920          buf[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02921"></a>02921 
<a name="l02922"></a>02922          <span class="keywordflow">while</span> (buflen &lt; (len - 1)) {
<a name="l02923"></a>02923             res = fgets(buf + buflen, len, readf);
<a name="l02924"></a>02924             <span class="keywordflow">if</span> (feof(readf))
<a name="l02925"></a>02925                <span class="keywordflow">break</span>;
<a name="l02926"></a>02926             <span class="keywordflow">if</span> (ferror(readf) &amp;&amp; ((<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EINTR) &amp;&amp; (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EAGAIN)))
<a name="l02927"></a>02927                <span class="keywordflow">break</span>;
<a name="l02928"></a>02928             <span class="keywordflow">if</span> (res != NULL &amp;&amp; !agi-&gt;<a class="code" href="structagi__state.html#aa9106f15c17bda42c4e5dc9e0fd96572">fast</a>)
<a name="l02929"></a>02929                <span class="keywordflow">break</span>;
<a name="l02930"></a>02930             buflen = strlen(buf);
<a name="l02931"></a>02931             <span class="keywordflow">if</span> (buflen &amp;&amp; buf[buflen - 1] == <span class="charliteral">&apos;\n&apos;</span>)
<a name="l02932"></a>02932                <span class="keywordflow">break</span>;
<a name="l02933"></a>02933             len -= buflen;
<a name="l02934"></a>02934             <span class="keywordflow">if</span> (agidebug)
<a name="l02935"></a>02935                <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>( <span class="stringliteral">&quot;AGI Rx &lt;&lt; temp buffer %s - errno %s\n&quot;</span>, buf, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02936"></a>02936          }
<a name="l02937"></a>02937 
<a name="l02938"></a>02938          <span class="keywordflow">if</span> (!buf[0]) {
<a name="l02939"></a>02939             <span class="comment">/* Program terminated */</span>
<a name="l02940"></a>02940             <span class="keywordflow">if</span> (returnstatus) {
<a name="l02941"></a>02941                returnstatus = -1;
<a name="l02942"></a>02942             }
<a name="l02943"></a>02943             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;&lt;%s&gt;AGI Script %s completed, returning %d\n&quot;</span>, chan-&gt;name, request, returnstatus);
<a name="l02944"></a>02944             <span class="keywordflow">if</span> (pid &gt; 0)
<a name="l02945"></a>02945                waitpid(pid, status, 0);
<a name="l02946"></a>02946             <span class="comment">/* No need to kill the pid anymore, since they closed us */</span>
<a name="l02947"></a>02947             pid = -1;
<a name="l02948"></a>02948             <span class="keywordflow">break</span>;
<a name="l02949"></a>02949          }
<a name="l02950"></a>02950 
<a name="l02951"></a>02951          <span class="comment">/* Special case for inability to execute child process */</span>
<a name="l02952"></a>02952          <span class="keywordflow">if</span> (*buf &amp;&amp; strncasecmp(buf, <span class="stringliteral">&quot;failure&quot;</span>, 7) == 0) {
<a name="l02953"></a>02953             returnstatus = <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l02954"></a>02954             <span class="keywordflow">break</span>;
<a name="l02955"></a>02955          }
<a name="l02956"></a>02956 
<a name="l02957"></a>02957          <span class="comment">/* get rid of trailing newline, if any */</span>
<a name="l02958"></a>02958          <span class="keywordflow">if</span> (*buf &amp;&amp; buf[strlen(buf) - 1] == <span class="charliteral">&apos;\n&apos;</span>)
<a name="l02959"></a>02959             buf[strlen(buf) - 1] = 0;
<a name="l02960"></a>02960          <span class="keywordflow">if</span> (agidebug)
<a name="l02961"></a>02961             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;&lt;%s&gt;AGI Rx &lt;&lt; %s\n&quot;</span>, chan-&gt;name, buf);
<a name="l02962"></a>02962          returnstatus |= <a class="code" href="res__agi_8c.html#ac9faf2222a97b9abbab8430992c8da2f">agi_handle_command</a>(chan, agi, buf, dead);
<a name="l02963"></a>02963          <span class="comment">/* If the handle_command returns -1, we need to stop */</span>
<a name="l02964"></a>02964          <span class="keywordflow">if</span> (returnstatus &lt; 0) {
<a name="l02965"></a>02965             needhup = 1;
<a name="l02966"></a>02966             <span class="keywordflow">continue</span>;
<a name="l02967"></a>02967          }
<a name="l02968"></a>02968       } <span class="keywordflow">else</span> {
<a name="l02969"></a>02969          <span class="keywordflow">if</span> (--retry &lt;= 0) {
<a name="l02970"></a>02970             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No channel, no fd?\n&quot;</span>);
<a name="l02971"></a>02971             returnstatus = <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l02972"></a>02972             <span class="keywordflow">break</span>;
<a name="l02973"></a>02973          }
<a name="l02974"></a>02974       }
<a name="l02975"></a>02975    }
<a name="l02976"></a>02976    <span class="keywordflow">if</span> (agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>) {
<a name="l02977"></a>02977       <a class="code" href="speech_8h.html#a7ebc9d3250a75a2cb7ee2f7c15eb8228" title="Destroy a speech structure.">ast_speech_destroy</a>(agi-&gt;<a class="code" href="structagi__state.html#ada1cd33a25b7c7dfc19466d2bfc2645d">speech</a>);
<a name="l02978"></a>02978    }
<a name="l02979"></a>02979    <span class="comment">/* Notify process */</span>
<a name="l02980"></a>02980    <span class="keywordflow">if</span> (send_sighup) {
<a name="l02981"></a>02981       <span class="keywordflow">if</span> (pid &gt; -1) {
<a name="l02982"></a>02982          <span class="keywordflow">if</span> (kill(pid, SIGHUP)) {
<a name="l02983"></a>02983             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;unable to send SIGHUP to AGI process %d: %s\n&quot;</span>, pid, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02984"></a>02984          } <span class="keywordflow">else</span> { <span class="comment">/* Give the process a chance to die */</span>
<a name="l02985"></a>02985             usleep(1);
<a name="l02986"></a>02986          }
<a name="l02987"></a>02987          waitpid(pid, status, WNOHANG);
<a name="l02988"></a>02988       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (agi-&gt;<a class="code" href="structagi__state.html#aa9106f15c17bda42c4e5dc9e0fd96572">fast</a>) {
<a name="l02989"></a>02989          send(agi-&gt;<a class="code" href="structagi__state.html#a0f787778e7019ca3a8bdf0bd17b9efca">ctrl</a>, <span class="stringliteral">&quot;HANGUP\n&quot;</span>, 7, MSG_OOB);
<a name="l02990"></a>02990       }
<a name="l02991"></a>02991    }
<a name="l02992"></a>02992    fclose(readf);
<a name="l02993"></a>02993    <span class="keywordflow">return</span> returnstatus;
<a name="l02994"></a>02994 }
<a name="l02995"></a>02995 
<a name="l02996"></a><a class="code" href="res__agi_8c.html#a1b0d8b11441dae16714234648845d4cf">02996</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#a1b0d8b11441dae16714234648845d4cf">handle_cli_agi_show</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l02997"></a>02997 {
<a name="l02998"></a>02998    <span class="keyword">struct </span><a class="code" href="structagi__command.html">agi_command</a> *command;
<a name="l02999"></a>02999    <span class="keywordtype">char</span> fullcmd[<a class="code" href="res__agi_8c.html#a1eb73c104b484cf18752169509cebfe2">MAX_CMD_LEN</a>];
<a name="l03000"></a>03000    <span class="keywordtype">int</span> error = 0;
<a name="l03001"></a>03001 
<a name="l03002"></a>03002    <span class="keywordflow">switch</span> (cmd) {
<a name="l03003"></a>03003    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03004"></a>03004       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;agi show commands [topic]&quot;</span>;
<a name="l03005"></a>03005       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03006"></a>03006          <span class="stringliteral">&quot;Usage: agi show commands [topic] &lt;topic&gt;\n&quot;</span>
<a name="l03007"></a>03007          <span class="stringliteral">&quot;       When called with a topic as an argument, displays usage\n&quot;</span>
<a name="l03008"></a>03008          <span class="stringliteral">&quot;       information on the given command.  If called without a\n&quot;</span>
<a name="l03009"></a>03009          <span class="stringliteral">&quot;       topic, it provides a list of AGI commands.\n&quot;</span>;
<a name="l03010"></a>03010    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03011"></a>03011       <span class="keywordflow">return</span> NULL;
<a name="l03012"></a>03012    }
<a name="l03013"></a>03013    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1 || (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt;= e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> &amp;&amp; strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1], <span class="stringliteral">&quot;topic&quot;</span>)))
<a name="l03014"></a>03014       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l03015"></a>03015    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1) {
<a name="l03016"></a>03016       command = <a class="code" href="res__agi_8c.html#ace45cfd0b2306ec060fa4a788b976125">find_command</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> + e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>, 1);
<a name="l03017"></a>03017       <span class="keywordflow">if</span> (command) {
<a name="l03018"></a>03018          <span class="keywordtype">char</span> *synopsis = NULL, *<a class="code" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = NULL, *<a class="code" href="structagi__command.html#affcabda568112959a0d397995e46eff0">syntax</a> = NULL, *<a class="code" href="structagi__command.html#a569b4bafa00f6a7b717316233cbb8f0d">seealso</a> = NULL;
<a name="l03019"></a>03019          <span class="keywordtype">char</span> info[30 + <a class="code" href="res__agi_8c.html#a1eb73c104b484cf18752169509cebfe2">MAX_CMD_LEN</a>];              <span class="comment">/* &apos;-= Info about...&apos; */</span>
<a name="l03020"></a>03020          <span class="keywordtype">char</span> infotitle[30 + <a class="code" href="res__agi_8c.html#a1eb73c104b484cf18752169509cebfe2">MAX_CMD_LEN</a> + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>];  <span class="comment">/* &apos;-= Info about...&apos; with colors */</span>
<a name="l03021"></a>03021          <span class="keywordtype">char</span> syntitle[11 + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>];        <span class="comment">/* [Syntax]\n with colors */</span>
<a name="l03022"></a>03022          <span class="keywordtype">char</span> desctitle[15 + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>];       <span class="comment">/* [Description]\n with colors */</span>
<a name="l03023"></a>03023          <span class="keywordtype">char</span> deadtitle[13 + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>];       <span class="comment">/* [Runs Dead]\n with colors */</span>
<a name="l03024"></a>03024          <span class="keywordtype">char</span> deadcontent[3 + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>];      <span class="comment">/* &apos;Yes&apos; or &apos;No&apos; with colors */</span>
<a name="l03025"></a>03025          <span class="keywordtype">char</span> seealsotitle[12 + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>];    <span class="comment">/* [See Also]\n with colors */</span>
<a name="l03026"></a>03026          <span class="keywordtype">char</span> stxtitle[10 + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>];        <span class="comment">/* [Syntax]\n with colors */</span>
<a name="l03027"></a>03027          <span class="keywordtype">size_t</span> synlen, desclen, seealsolen, stxlen;
<a name="l03028"></a>03028 
<a name="l03029"></a>03029          <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(syntitle, <span class="stringliteral">&quot;[Synopsis]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, <span class="keyword">sizeof</span>(syntitle));
<a name="l03030"></a>03030          <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(desctitle, <span class="stringliteral">&quot;[Description]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, <span class="keyword">sizeof</span>(desctitle));
<a name="l03031"></a>03031          <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(deadtitle, <span class="stringliteral">&quot;[Runs Dead]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, <span class="keyword">sizeof</span>(deadtitle));
<a name="l03032"></a>03032          <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(seealsotitle, <span class="stringliteral">&quot;[See Also]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, <span class="keyword">sizeof</span>(seealsotitle));
<a name="l03033"></a>03033          <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(stxtitle, <span class="stringliteral">&quot;[Syntax]\n&quot;</span>, <a class="code" href="term_8h.html#a8deb0beccea721b35bdb1b4f7264fe75">COLOR_MAGENTA</a>, 0, <span class="keyword">sizeof</span>(stxtitle));
<a name="l03034"></a>03034          <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(deadcontent, command-&gt;<a class="code" href="structagi__command.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a> ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>, <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, <span class="keyword">sizeof</span>(deadcontent));
<a name="l03035"></a>03035 
<a name="l03036"></a>03036          <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(fullcmd, <span class="keyword">sizeof</span>(fullcmd), a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> + e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>);
<a name="l03037"></a>03037          snprintf(info, <span class="keyword">sizeof</span>(info), <span class="stringliteral">&quot;\n  -= Info about agi &apos;%s&apos; =- &quot;</span>, fullcmd);
<a name="l03038"></a>03038          <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(infotitle, info, <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, <span class="keyword">sizeof</span>(infotitle));
<a name="l03039"></a>03039 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l03040"></a>03040 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (command-&gt;<a class="code" href="structagi__command.html#aa871ca3c361d229d4e37edf3c6016cc1">docsrc</a> == <a class="code" href="pbx_8h.html#a8717a951656993c40bd851ebf50f58e3a24212840b7b1b0e9c1eebc8cfd89ab3e">AST_XML_DOC</a>) {
<a name="l03041"></a>03041             synopsis = <a class="code" href="xmldoc_8h.html#a637de870dfc83d0694f588c5a814ce38" title="Colorize and put delimiters (instead of tags) to the xmldoc output.">ast_xmldoc_printable</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(command-&gt;<a class="code" href="structagi__command.html#a322a4c1fa51c3fb9a98f2d329a90ecfa">summary</a>, <span class="stringliteral">&quot;Not available&quot;</span>), 1);
<a name="l03042"></a>03042             description = <a class="code" href="xmldoc_8h.html#a637de870dfc83d0694f588c5a814ce38" title="Colorize and put delimiters (instead of tags) to the xmldoc output.">ast_xmldoc_printable</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(command-&gt;<a class="code" href="structagi__command.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a>, <span class="stringliteral">&quot;Not available&quot;</span>), 1);
<a name="l03043"></a>03043             seealso = <a class="code" href="xmldoc_8h.html#a637de870dfc83d0694f588c5a814ce38" title="Colorize and put delimiters (instead of tags) to the xmldoc output.">ast_xmldoc_printable</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(command-&gt;<a class="code" href="structagi__command.html#a569b4bafa00f6a7b717316233cbb8f0d">seealso</a>, <span class="stringliteral">&quot;Not available&quot;</span>), 1);
<a name="l03044"></a>03044             <span class="keywordflow">if</span> (!seealso || !description || !synopsis) {
<a name="l03045"></a>03045                error = 1;
<a name="l03046"></a>03046                <span class="keywordflow">goto</span> return_cleanup;
<a name="l03047"></a>03047             }
<a name="l03048"></a>03048          } <span class="keywordflow">else</span>
<a name="l03049"></a>03049 <span class="preprocessor">#endif</span>
<a name="l03050"></a>03050 <span class="preprocessor"></span>         {
<a name="l03051"></a>03051             synlen = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(command-&gt;<a class="code" href="structagi__command.html#a322a4c1fa51c3fb9a98f2d329a90ecfa">summary</a>, <span class="stringliteral">&quot;Not available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l03052"></a>03052             synopsis = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(synlen);
<a name="l03053"></a>03053 
<a name="l03054"></a>03054             desclen = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(command-&gt;<a class="code" href="structagi__command.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a>, <span class="stringliteral">&quot;Not available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l03055"></a>03055             description = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(desclen);
<a name="l03056"></a>03056 
<a name="l03057"></a>03057             seealsolen = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(command-&gt;<a class="code" href="structagi__command.html#a569b4bafa00f6a7b717316233cbb8f0d">seealso</a>, <span class="stringliteral">&quot;Not available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l03058"></a>03058             seealso = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(seealsolen);
<a name="l03059"></a>03059 
<a name="l03060"></a>03060             <span class="keywordflow">if</span> (!synopsis || !description || !seealso) {
<a name="l03061"></a>03061                error = 1;
<a name="l03062"></a>03062                <span class="keywordflow">goto</span> return_cleanup;
<a name="l03063"></a>03063             }
<a name="l03064"></a>03064             <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(synopsis, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(command-&gt;<a class="code" href="structagi__command.html#a322a4c1fa51c3fb9a98f2d329a90ecfa">summary</a>, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, synlen);
<a name="l03065"></a>03065             <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(description, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(command-&gt;<a class="code" href="structagi__command.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a>, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, desclen);
<a name="l03066"></a>03066             <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(seealso, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(command-&gt;<a class="code" href="structagi__command.html#a569b4bafa00f6a7b717316233cbb8f0d">seealso</a>, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, seealsolen);
<a name="l03067"></a>03067          }
<a name="l03068"></a>03068 
<a name="l03069"></a>03069          stxlen = strlen(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(command-&gt;<a class="code" href="structagi__command.html#affcabda568112959a0d397995e46eff0">syntax</a>, <span class="stringliteral">&quot;Not available&quot;</span>)) + <a class="code" href="term_8h.html#ad133ecb973ac53154526e3255bfa2759" title="Maximum number of characters needed for a color escape sequence, plus a null char...">AST_TERM_MAX_ESCAPE_CHARS</a>;
<a name="l03070"></a>03070          syntax = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(stxlen);
<a name="l03071"></a>03071          <span class="keywordflow">if</span> (!syntax) {
<a name="l03072"></a>03072             error = 1;
<a name="l03073"></a>03073             <span class="keywordflow">goto</span> return_cleanup;
<a name="l03074"></a>03074          }
<a name="l03075"></a>03075          <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(syntax, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(command-&gt;<a class="code" href="structagi__command.html#affcabda568112959a0d397995e46eff0">syntax</a>, <span class="stringliteral">&quot;Not available&quot;</span>), <a class="code" href="term_8h.html#a82573859711fce56f1aa0a76b18a9b18">COLOR_CYAN</a>, 0, stxlen);
<a name="l03076"></a>03076 
<a name="l03077"></a>03077          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s\n\n%s%s\n\n%s%s\n\n%s%s\n\n%s%s\n\n%s%s\n\n&quot;</span>, infotitle, stxtitle, syntax,
<a name="l03078"></a>03078                desctitle, description, syntitle, synopsis, deadtitle, deadcontent,
<a name="l03079"></a>03079                seealsotitle, seealso);
<a name="l03080"></a>03080 return_cleanup:
<a name="l03081"></a>03081          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(synopsis);
<a name="l03082"></a>03082          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(description);
<a name="l03083"></a>03083          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(syntax);
<a name="l03084"></a>03084          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(seealso);
<a name="l03085"></a>03085       } <span class="keywordflow">else</span> {
<a name="l03086"></a>03086          <span class="keywordflow">if</span> (<a class="code" href="res__agi_8c.html#ace45cfd0b2306ec060fa4a788b976125">find_command</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> + e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>, -1)) {
<a name="l03087"></a>03087             <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#ab1b1b3f1bd30a7daef013ba698a1ca72">help_workhorse</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> + e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>);
<a name="l03088"></a>03088          } <span class="keywordflow">else</span> {
<a name="l03089"></a>03089             <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(fullcmd, <span class="keyword">sizeof</span>(fullcmd), a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> + e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>);
<a name="l03090"></a>03090             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No such command &apos;%s&apos;.\n&quot;</span>, fullcmd);
<a name="l03091"></a>03091          }
<a name="l03092"></a>03092       }
<a name="l03093"></a>03093    } <span class="keywordflow">else</span> {
<a name="l03094"></a>03094       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#ab1b1b3f1bd30a7daef013ba698a1ca72">help_workhorse</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, NULL);
<a name="l03095"></a>03095    }
<a name="l03096"></a>03096    <span class="keywordflow">return</span> (error ? <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a> : <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>);
<a name="l03097"></a>03097 }
<a name="l03098"></a>03098 <span class="comment"></span>
<a name="l03099"></a>03099 <span class="comment">/*! \brief Convert string to use HTML escaped characters</span>
<a name="l03100"></a>03100 <span class="comment">   \note Maybe this should be a generic function?</span>
<a name="l03101"></a>03101 <span class="comment">*/</span>
<a name="l03102"></a><a class="code" href="res__agi_8c.html#affb3399334791eb3ca41f76ad70296dc">03102</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__agi_8c.html#affb3399334791eb3ca41f76ad70296dc" title="Convert string to use HTML escaped characters.">write_html_escaped</a>(FILE *htmlfile, <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>)
<a name="l03103"></a>03103 {
<a name="l03104"></a>03104    <span class="keywordtype">char</span> *cur = str;
<a name="l03105"></a>03105 
<a name="l03106"></a>03106    <span class="keywordflow">while</span>(*cur) {
<a name="l03107"></a>03107       <span class="keywordflow">switch</span> (*cur) {
<a name="l03108"></a>03108       <span class="keywordflow">case</span> <span class="charliteral">&apos;&lt;&apos;</span>:
<a name="l03109"></a>03109          fprintf(htmlfile, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&amp;lt;&quot;</span>);
<a name="l03110"></a>03110          <span class="keywordflow">break</span>;
<a name="l03111"></a>03111       <span class="keywordflow">case</span> <span class="charliteral">&apos;&gt;&apos;</span>:
<a name="l03112"></a>03112          fprintf(htmlfile, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&amp;gt;&quot;</span>);
<a name="l03113"></a>03113          <span class="keywordflow">break</span>;
<a name="l03114"></a>03114       <span class="keywordflow">case</span> <span class="charliteral">&apos;&amp;&apos;</span>:
<a name="l03115"></a>03115          fprintf(htmlfile, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&amp;amp;&quot;</span>);
<a name="l03116"></a>03116          <span class="keywordflow">break</span>;
<a name="l03117"></a>03117       <span class="keywordflow">case</span> <span class="charliteral">&apos;&quot;&apos;</span>:
<a name="l03118"></a>03118          fprintf(htmlfile, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&amp;quot;&quot;</span>);
<a name="l03119"></a>03119          <span class="keywordflow">break</span>;
<a name="l03120"></a>03120       <span class="keywordflow">default</span>:
<a name="l03121"></a>03121          fprintf(htmlfile, <span class="stringliteral">&quot;%c&quot;</span>, *cur);
<a name="l03122"></a>03122          <span class="keywordflow">break</span>;
<a name="l03123"></a>03123       }
<a name="l03124"></a>03124       cur++;
<a name="l03125"></a>03125    }
<a name="l03126"></a>03126 
<a name="l03127"></a>03127    <span class="keywordflow">return</span>;
<a name="l03128"></a>03128 }
<a name="l03129"></a>03129 
<a name="l03130"></a><a class="code" href="res__agi_8c.html#a25aa3ca2e0fff2e71d97384bce85618e">03130</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a25aa3ca2e0fff2e71d97384bce85618e">write_htmldump</a>(<span class="keywordtype">char</span> *filename)
<a name="l03131"></a>03131 {
<a name="l03132"></a>03132    <span class="keyword">struct </span><a class="code" href="structagi__command.html">agi_command</a> *command;
<a name="l03133"></a>03133    <span class="keywordtype">char</span> fullcmd[<a class="code" href="res__agi_8c.html#a1eb73c104b484cf18752169509cebfe2">MAX_CMD_LEN</a>];
<a name="l03134"></a>03134    FILE *htmlfile;
<a name="l03135"></a>03135 
<a name="l03136"></a>03136    <span class="keywordflow">if</span> (!(htmlfile = fopen(filename, <span class="stringliteral">&quot;wt&quot;</span>)))
<a name="l03137"></a>03137       <span class="keywordflow">return</span> -1;
<a name="l03138"></a>03138 
<a name="l03139"></a>03139    fprintf(htmlfile, <span class="stringliteral">&quot;&lt;HTML&gt;\n&lt;HEAD&gt;\n&lt;TITLE&gt;AGI Commands&lt;/TITLE&gt;\n&lt;/HEAD&gt;\n&quot;</span>);
<a name="l03140"></a>03140    fprintf(htmlfile, <span class="stringliteral">&quot;&lt;BODY&gt;\n&lt;CENTER&gt;&lt;B&gt;&lt;H1&gt;AGI Commands&lt;/H1&gt;&lt;/B&gt;&lt;/CENTER&gt;\n\n&quot;</span>);
<a name="l03141"></a>03141    fprintf(htmlfile, <span class="stringliteral">&quot;&lt;TABLE BORDER=\&quot;0\&quot; CELLSPACING=\&quot;10\&quot;&gt;\n&quot;</span>);
<a name="l03142"></a>03142 
<a name="l03143"></a>03143    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l03144"></a>03144    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>, command, list) {
<a name="l03145"></a>03145 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l03146"></a>03146 <span class="preprocessor"></span>      <span class="keywordtype">char</span> *stringptmp;
<a name="l03147"></a>03147 <span class="preprocessor">#endif</span>
<a name="l03148"></a>03148 <span class="preprocessor"></span>      <span class="keywordtype">char</span> *tempstr, *stringp;
<a name="l03149"></a>03149 
<a name="l03150"></a>03150       <span class="keywordflow">if</span> (!command-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>[0])  <span class="comment">/* end ? */</span>
<a name="l03151"></a>03151          <span class="keywordflow">break</span>;
<a name="l03152"></a>03152       <span class="comment">/* Hide commands that start with &apos;_&apos; */</span>
<a name="l03153"></a>03153       <span class="keywordflow">if</span> ((command-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>[0])[0] == <span class="charliteral">&apos;_&apos;</span>)
<a name="l03154"></a>03154          <span class="keywordflow">continue</span>;
<a name="l03155"></a>03155       <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(fullcmd, <span class="keyword">sizeof</span>(fullcmd), command-&gt;<a class="code" href="structagi__command.html#a2039373e5e61dcdef31216c7ae2b7153">cmda</a>);
<a name="l03156"></a>03156 
<a name="l03157"></a>03157       fprintf(htmlfile, <span class="stringliteral">&quot;&lt;TR&gt;&lt;TD&gt;&lt;TABLE BORDER=\&quot;1\&quot; CELLPADDING=\&quot;5\&quot; WIDTH=\&quot;100%%\&quot;&gt;\n&quot;</span>);
<a name="l03158"></a>03158       fprintf(htmlfile, <span class="stringliteral">&quot;&lt;TR&gt;&lt;TH ALIGN=\&quot;CENTER\&quot;&gt;&lt;B&gt;%s - %s&lt;/B&gt;&lt;/TH&gt;&lt;/TR&gt;\n&quot;</span>, fullcmd, command-&gt;<a class="code" href="structagi__command.html#a322a4c1fa51c3fb9a98f2d329a90ecfa">summary</a>);
<a name="l03159"></a>03159 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l03160"></a>03160 <span class="preprocessor"></span>      stringptmp = <a class="code" href="xmldoc_8h.html#a637de870dfc83d0694f588c5a814ce38" title="Colorize and put delimiters (instead of tags) to the xmldoc output.">ast_xmldoc_printable</a>(command-&gt;<a class="code" href="structagi__command.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a>, 0);
<a name="l03161"></a>03161       stringp = stringptmp;
<a name="l03162"></a>03162 <span class="preprocessor">#else</span>
<a name="l03163"></a>03163 <span class="preprocessor"></span>      stringp = command-&gt;<a class="code" href="structagi__command.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a>;
<a name="l03164"></a>03164 <span class="preprocessor">#endif</span>
<a name="l03165"></a>03165 <span class="preprocessor"></span>      tempstr = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l03166"></a>03166 
<a name="l03167"></a>03167       fprintf(htmlfile, <span class="stringliteral">&quot;&lt;TR&gt;&lt;TD ALIGN=\&quot;CENTER\&quot;&gt;&quot;</span>);
<a name="l03168"></a>03168       <a class="code" href="res__agi_8c.html#affb3399334791eb3ca41f76ad70296dc" title="Convert string to use HTML escaped characters.">write_html_escaped</a>(htmlfile, tempstr);
<a name="l03169"></a>03169       fprintf(htmlfile, <span class="stringliteral">&quot;&lt;/TD&gt;&lt;/TR&gt;\n&quot;</span>);
<a name="l03170"></a>03170       fprintf(htmlfile, <span class="stringliteral">&quot;&lt;TR&gt;&lt;TD ALIGN=\&quot;CENTER\&quot;&gt;\n&quot;</span>);
<a name="l03171"></a>03171 
<a name="l03172"></a>03172       <span class="keywordflow">while</span> ((tempstr = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;\n&quot;</span>)) != NULL) {
<a name="l03173"></a>03173          <a class="code" href="res__agi_8c.html#affb3399334791eb3ca41f76ad70296dc" title="Convert string to use HTML escaped characters.">write_html_escaped</a>(htmlfile, tempstr);
<a name="l03174"></a>03174          fprintf(htmlfile, <span class="stringliteral">&quot;&lt;BR&gt;\n&quot;</span>);
<a name="l03175"></a>03175       }
<a name="l03176"></a>03176       fprintf(htmlfile, <span class="stringliteral">&quot;&lt;/TD&gt;&lt;/TR&gt;\n&quot;</span>);
<a name="l03177"></a>03177       fprintf(htmlfile, <span class="stringliteral">&quot;&lt;/TABLE&gt;&lt;/TD&gt;&lt;/TR&gt;\n\n&quot;</span>);
<a name="l03178"></a>03178 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l03179"></a>03179 <span class="preprocessor"></span>      <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(stringptmp);
<a name="l03180"></a>03180 <span class="preprocessor">#endif</span>
<a name="l03181"></a>03181 <span class="preprocessor"></span>   }
<a name="l03182"></a>03182    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structagi__commands.html">agi_commands</a>);
<a name="l03183"></a>03183    fprintf(htmlfile, <span class="stringliteral">&quot;&lt;/TABLE&gt;\n&lt;/BODY&gt;\n&lt;/HTML&gt;\n&quot;</span>);
<a name="l03184"></a>03184    fclose(htmlfile);
<a name="l03185"></a>03185    <span class="keywordflow">return</span> 0;
<a name="l03186"></a>03186 }
<a name="l03187"></a>03187 
<a name="l03188"></a><a class="code" href="res__agi_8c.html#a8f67d4734b2f69a4aebb922daeb2b0ca">03188</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#a8f67d4734b2f69a4aebb922daeb2b0ca">handle_cli_agi_dump_html</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l03189"></a>03189 {
<a name="l03190"></a>03190    <span class="keywordflow">switch</span> (cmd) {
<a name="l03191"></a>03191    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03192"></a>03192       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;agi dump html&quot;</span>;
<a name="l03193"></a>03193       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03194"></a>03194          <span class="stringliteral">&quot;Usage: agi dump html &lt;filename&gt;\n&quot;</span>
<a name="l03195"></a>03195          <span class="stringliteral">&quot;       Dumps the AGI command list in HTML format to the given\n&quot;</span>
<a name="l03196"></a>03196          <span class="stringliteral">&quot;       file.\n&quot;</span>;
<a name="l03197"></a>03197       <span class="keywordflow">return</span> NULL;
<a name="l03198"></a>03198    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03199"></a>03199       <span class="keywordflow">return</span> NULL;
<a name="l03200"></a>03200    }
<a name="l03201"></a>03201    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1)
<a name="l03202"></a>03202       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l03203"></a>03203 
<a name="l03204"></a>03204    <span class="keywordflow">if</span> (<a class="code" href="res__agi_8c.html#a25aa3ca2e0fff2e71d97384bce85618e">write_htmldump</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>]) &lt; 0) {
<a name="l03205"></a>03205       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Could not create file &apos;%s&apos;\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>]);
<a name="l03206"></a>03206       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l03207"></a>03207    }
<a name="l03208"></a>03208    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;AGI HTML commands dumped to: %s\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>]);
<a name="l03209"></a>03209    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03210"></a>03210 }
<a name="l03211"></a>03211 
<a name="l03212"></a><a class="code" href="res__agi_8c.html#aeead3c2cfa6aab26cb27b1d555adbde9">03212</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#aeead3c2cfa6aab26cb27b1d555adbde9">agi_exec_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> enhanced, <span class="keywordtype">int</span> <a class="code" href="structagi__command.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a>)
<a name="l03213"></a>03213 {
<a name="l03214"></a>03214    <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1">agi_result</a> res;
<a name="l03215"></a>03215    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="res__agi_8c.html#acac9c67d43a9e0d04c732fc06665f6dd">AGI_BUF_LEN</a>] = <span class="stringliteral">&quot;&quot;</span>, *tmp = buf;
<a name="l03216"></a>03216    <span class="keywordtype">int</span> fds[2], efd = -1, pid;
<a name="l03217"></a>03217    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l03218"></a>03218       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(arg)[<a class="code" href="app__macro_8c.html#a29b7451465deac204c5f7cb1f9c6e1fc">MAX_ARGS</a>];
<a name="l03219"></a>03219    );
<a name="l03220"></a>03220    <a class="code" href="structagi__state.html">AGI</a> agi;
<a name="l03221"></a>03221 
<a name="l03222"></a>03222    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l03223"></a>03223       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;AGI requires an argument (script)\n&quot;</span>);
<a name="l03224"></a>03224       <span class="keywordflow">return</span> -1;
<a name="l03225"></a>03225    }
<a name="l03226"></a>03226    <span class="keywordflow">if</span> (dead)
<a name="l03227"></a>03227       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Hungup channel detected, running agi in dead mode.\n&quot;</span>);
<a name="l03228"></a>03228    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, data, <span class="keyword">sizeof</span>(buf));
<a name="l03229"></a>03229    memset(&amp;agi, 0, <span class="keyword">sizeof</span>(agi));
<a name="l03230"></a>03230    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, tmp);
<a name="l03231"></a>03231    args.argv[args.argc] = NULL;
<a name="l03232"></a>03232 <span class="preprocessor">#if 0</span>
<a name="l03233"></a>03233 <span class="preprocessor"></span>    <span class="comment">/* Answer if need be */</span>
<a name="l03234"></a>03234    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l03235"></a>03235       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan))
<a name="l03236"></a>03236          <span class="keywordflow">return</span> -1;
<a name="l03237"></a>03237    }
<a name="l03238"></a>03238 <span class="preprocessor">#endif</span>
<a name="l03239"></a>03239 <span class="preprocessor"></span>   res = <a class="code" href="res__agi_8c.html#ac400fa6a1c0082145b9e21b6c12b002a">launch_script</a>(chan, args.argv[0], args.argv, fds, enhanced ? &amp;efd : NULL, &amp;pid);
<a name="l03240"></a>03240    <span class="comment">/* Async AGI do not require run_agi(), so just proceed if normal AGI</span>
<a name="l03241"></a>03241 <span class="comment">      or Fast AGI are setup with success. */</span>
<a name="l03242"></a>03242    <span class="keywordflow">if</span> (res == <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a493daf1d6c06bbf4b17b36929cc51fd8">AGI_RESULT_SUCCESS</a> || res == <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1aac30d4ae19361cc243414b0ec32cbb78">AGI_RESULT_SUCCESS_FAST</a>) {
<a name="l03243"></a>03243       <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 0;
<a name="l03244"></a>03244       agi.fd = fds[1];
<a name="l03245"></a>03245       agi.ctrl = fds[0];
<a name="l03246"></a>03246       agi.audio = efd;
<a name="l03247"></a>03247       agi.fast = (res == <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1aac30d4ae19361cc243414b0ec32cbb78">AGI_RESULT_SUCCESS_FAST</a>) ? 1 : 0;
<a name="l03248"></a>03248       res = <a class="code" href="res__agi_8c.html#a85e832090276a7a7c018400e2f70c853">run_agi</a>(chan, args.argv[0], &amp;agi, pid, &amp;status, dead, args.argc, args.argv);
<a name="l03249"></a>03249       <span class="comment">/* If the fork&apos;d process returns non-zero, set AGISTATUS to FAILURE */</span>
<a name="l03250"></a>03250       <span class="keywordflow">if</span> ((res == <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a493daf1d6c06bbf4b17b36929cc51fd8">AGI_RESULT_SUCCESS</a> || res == <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1aac30d4ae19361cc243414b0ec32cbb78">AGI_RESULT_SUCCESS_FAST</a>) &amp;&amp; status)
<a name="l03251"></a>03251          res = <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>;
<a name="l03252"></a>03252       <span class="keywordflow">if</span> (fds[1] != fds[0])
<a name="l03253"></a>03253          close(fds[1]);
<a name="l03254"></a>03254       <span class="keywordflow">if</span> (efd &gt; -1)
<a name="l03255"></a>03255          close(efd);
<a name="l03256"></a>03256    }
<a name="l03257"></a>03257    <a class="code" href="app_8h.html#a1044fae6847dc8986a212af0af492a23" title="Common routine to cleanup after fork&amp;#39;ed process is complete (if reaping was stopped)...">ast_safe_fork_cleanup</a>();
<a name="l03258"></a>03258 
<a name="l03259"></a>03259    <span class="keywordflow">switch</span> (res) {
<a name="l03260"></a>03260    <span class="keywordflow">case</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a493daf1d6c06bbf4b17b36929cc51fd8">AGI_RESULT_SUCCESS</a>:
<a name="l03261"></a>03261    <span class="keywordflow">case</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1aac30d4ae19361cc243414b0ec32cbb78">AGI_RESULT_SUCCESS_FAST</a>:
<a name="l03262"></a>03262    <span class="keywordflow">case</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a97eab5e05f42bf8b5da0575a67e10d7c">AGI_RESULT_SUCCESS_ASYNC</a>:
<a name="l03263"></a>03263       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;AGISTATUS&quot;</span>, <span class="stringliteral">&quot;SUCCESS&quot;</span>);
<a name="l03264"></a>03264       <span class="keywordflow">break</span>;
<a name="l03265"></a>03265    <span class="keywordflow">case</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a903160b240379ada59c275690cddd8af">AGI_RESULT_FAILURE</a>:
<a name="l03266"></a>03266       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;AGISTATUS&quot;</span>, <span class="stringliteral">&quot;FAILURE&quot;</span>);
<a name="l03267"></a>03267       <span class="keywordflow">break</span>;
<a name="l03268"></a>03268    <span class="keywordflow">case</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1ac0f8286bb33122eee66cbe710f3f5ada">AGI_RESULT_NOTFOUND</a>:
<a name="l03269"></a>03269       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;AGISTATUS&quot;</span>, <span class="stringliteral">&quot;NOTFOUND&quot;</span>);
<a name="l03270"></a>03270       <span class="keywordflow">break</span>;
<a name="l03271"></a>03271    <span class="keywordflow">case</span> <a class="code" href="res__agi_8c.html#abf2ce6b2eb38d1067cfda4f19081f5b1a3efef4607e59ada98318f948f398d8fe">AGI_RESULT_HANGUP</a>:
<a name="l03272"></a>03272       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;AGISTATUS&quot;</span>, <span class="stringliteral">&quot;HANGUP&quot;</span>);
<a name="l03273"></a>03273       <span class="keywordflow">return</span> -1;
<a name="l03274"></a>03274    }
<a name="l03275"></a>03275 
<a name="l03276"></a>03276    <span class="keywordflow">return</span> 0;
<a name="l03277"></a>03277 }
<a name="l03278"></a>03278 
<a name="l03279"></a><a class="code" href="res__agi_8c.html#a59f4001ae4d7684ff12fbe3703e3f6a9">03279</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a59f4001ae4d7684ff12fbe3703e3f6a9">agi_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l03280"></a>03280 {
<a name="l03281"></a>03281    <span class="keywordflow">if</span> (!<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan))
<a name="l03282"></a>03282       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#aeead3c2cfa6aab26cb27b1d555adbde9">agi_exec_full</a>(chan, data, 0, 0);
<a name="l03283"></a>03283    <span class="keywordflow">else</span>
<a name="l03284"></a>03284       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#aeead3c2cfa6aab26cb27b1d555adbde9">agi_exec_full</a>(chan, data, 0, 1);
<a name="l03285"></a>03285 }
<a name="l03286"></a>03286 
<a name="l03287"></a><a class="code" href="res__agi_8c.html#adf11b53378e372d372c3b44ca7422b6b">03287</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#adf11b53378e372d372c3b44ca7422b6b">eagi_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l03288"></a>03288 {
<a name="l03289"></a>03289    <span class="keywordtype">int</span> readformat, res;
<a name="l03290"></a>03290 
<a name="l03291"></a>03291    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) {
<a name="l03292"></a>03292       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;EAGI cannot be run on a dead/hungup channel, please use AGI.\n&quot;</span>);
<a name="l03293"></a>03293       <span class="keywordflow">return</span> 0;
<a name="l03294"></a>03294    }
<a name="l03295"></a>03295    readformat = chan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l03296"></a>03296    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(chan, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>)) {
<a name="l03297"></a>03297       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set channel &apos;%s&apos; to linear mode\n&quot;</span>, chan-&gt;name);
<a name="l03298"></a>03298       <span class="keywordflow">return</span> -1;
<a name="l03299"></a>03299    }
<a name="l03300"></a>03300    res = <a class="code" href="res__agi_8c.html#aeead3c2cfa6aab26cb27b1d555adbde9">agi_exec_full</a>(chan, data, 1, 0);
<a name="l03301"></a>03301    <span class="keywordflow">if</span> (!res) {
<a name="l03302"></a>03302       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(chan, readformat)) {
<a name="l03303"></a>03303          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to restore channel &apos;%s&apos; to format %s\n&quot;</span>, chan-&gt;name, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(readformat));
<a name="l03304"></a>03304       }
<a name="l03305"></a>03305    }
<a name="l03306"></a>03306    <span class="keywordflow">return</span> res;
<a name="l03307"></a>03307 }
<a name="l03308"></a>03308 
<a name="l03309"></a><a class="code" href="res__agi_8c.html#ac6446385098bc144186930c3e998721a">03309</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ac6446385098bc144186930c3e998721a">deadagi_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l03310"></a>03310 {
<a name="l03311"></a>03311    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;DeadAGI has been deprecated, please use AGI in all cases!\n&quot;</span>);
<a name="l03312"></a>03312    <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#a59f4001ae4d7684ff12fbe3703e3f6a9">agi_exec</a>(chan, data);
<a name="l03313"></a>03313 }
<a name="l03314"></a>03314 
<a name="l03315"></a><a class="code" href="res__agi_8c.html#a11397b735518c6d8ecf8d046cb627d92">03315</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="res__agi_8c.html#a11397b735518c6d8ecf8d046cb627d92">cli_agi</a>[] = {
<a name="l03316"></a>03316    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__agi_8c.html#a034905bb151521b05105619714ea3e71" title="CLI command to add applications to execute in Async AGI.">handle_cli_agi_add_cmd</a>,   <span class="stringliteral">&quot;Add AGI command to a channel in Async AGI&quot;</span>),
<a name="l03317"></a>03317    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__agi_8c.html#ac7a0ac6d2a6cc6e05e9feecd79cb4523">handle_cli_agi_debug</a>,     <span class="stringliteral">&quot;Enable/Disable AGI debugging&quot;</span>),
<a name="l03318"></a>03318    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__agi_8c.html#a1b0d8b11441dae16714234648845d4cf">handle_cli_agi_show</a>,      <span class="stringliteral">&quot;List AGI commands or specific help&quot;</span>),
<a name="l03319"></a>03319    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__agi_8c.html#a8f67d4734b2f69a4aebb922daeb2b0ca">handle_cli_agi_dump_html</a>, <span class="stringliteral">&quot;Dumps a list of AGI commands in HTML format&quot;</span>)
<a name="l03320"></a>03320 };
<a name="l03321"></a>03321 
<a name="l03322"></a><a class="code" href="res__agi_8c.html#ad09fa931f468002152a3cc2d5ce25eae">03322</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l03323"></a>03323 {
<a name="l03324"></a>03324    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(<a class="code" href="res__agi_8c.html#a11397b735518c6d8ecf8d046cb627d92">cli_agi</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="res__agi_8c.html#a11397b735518c6d8ecf8d046cb627d92">cli_agi</a>));
<a name="l03325"></a>03325    <span class="comment">/* we can safely ignore the result of ast_agi_unregister_multiple() here, since it cannot fail, as</span>
<a name="l03326"></a>03326 <span class="comment">      we know that these commands were registered by this module and are still registered</span>
<a name="l03327"></a>03327 <span class="comment">   */</span>
<a name="l03328"></a>03328    (void) <a class="code" href="agi_8h.html#ae36ca908f67e1d7daff5b42c29107ab8" title="Unregisters a group of AGI commands, provided as an array of struct agi_command entries...">ast_agi_unregister_multiple</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self, <a class="code" href="res__agi_8c.html#aaaa94f6da87a703160a7acb2fd67422d" title="AGI commands list.">commands</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="res__agi_8c.html#aaaa94f6da87a703160a7acb2fd67422d" title="AGI commands list.">commands</a>));
<a name="l03329"></a>03329    <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(eapp);
<a name="l03330"></a>03330    <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(deadapp);
<a name="l03331"></a>03331    <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;AGI&quot;</span>);
<a name="l03332"></a>03332    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app);
<a name="l03333"></a>03333 }
<a name="l03334"></a>03334 
<a name="l03335"></a><a class="code" href="res__agi_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">03335</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l03336"></a>03336 {
<a name="l03337"></a>03337    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="res__agi_8c.html#a11397b735518c6d8ecf8d046cb627d92">cli_agi</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="res__agi_8c.html#a11397b735518c6d8ecf8d046cb627d92">cli_agi</a>));
<a name="l03338"></a>03338    <span class="comment">/* we can safely ignore the result of ast_agi_register_multiple() here, since it cannot fail, as</span>
<a name="l03339"></a>03339 <span class="comment">      no other commands have been registered yet</span>
<a name="l03340"></a>03340 <span class="comment">   */</span>
<a name="l03341"></a>03341    (void) <a class="code" href="agi_8h.html#a8025b9327d8a870c7455a29355222b9c" title="Registers a group of AGI commands, provided as an array of struct agi_command entries...">ast_agi_register_multiple</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self, <a class="code" href="res__agi_8c.html#aaaa94f6da87a703160a7acb2fd67422d" title="AGI commands list.">commands</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="res__agi_8c.html#aaaa94f6da87a703160a7acb2fd67422d" title="AGI commands list.">commands</a>));
<a name="l03342"></a>03342    <a class="code" href="module_8h.html#aa47a7223480d23a864cf83fef0f8585e" title="Register an application.">ast_register_application</a>(deadapp, <a class="code" href="res__agi_8c.html#ac6446385098bc144186930c3e998721a">deadagi_exec</a>, deadsynopsis, descrip);
<a name="l03343"></a>03343    <a class="code" href="module_8h.html#aa47a7223480d23a864cf83fef0f8585e" title="Register an application.">ast_register_application</a>(eapp, <a class="code" href="res__agi_8c.html#adf11b53378e372d372c3b44ca7422b6b">eagi_exec</a>, esynopsis, descrip);
<a name="l03344"></a>03344    <a class="code" href="group__Group__AMI.html#ga332bf7ef48f67d63d849dd9febb18fb2" title="Register a manager command with the manager interface.">ast_manager_register2</a>(<span class="stringliteral">&quot;AGI&quot;</span>, <a class="code" href="manager_8h.html#ac7370fe764f1305cdb3c543d3964d5ed">EVENT_FLAG_AGI</a>, <a class="code" href="res__agi_8c.html#aa22a76ef4f33c70bc5f7099136a30727" title="Add a new command to execute by the Async AGI application.">action_add_agi_cmd</a>, <span class="stringliteral">&quot;Add an AGI command to execute by Async AGI&quot;</span>, <a class="code" href="res__agi_8c.html#a42c60934f0bbb01ff8af32cfae299baa">mandescr_asyncagi</a>);
<a name="l03345"></a>03345    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#aa47a7223480d23a864cf83fef0f8585e" title="Register an application.">ast_register_application</a>(app, <a class="code" href="res__agi_8c.html#a59f4001ae4d7684ff12fbe3703e3f6a9">agi_exec</a>, synopsis, descrip);
<a name="l03346"></a>03346 }
<a name="l03347"></a>03347 
<a name="l03348"></a>03348 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a835b27a90d895a488e4e14cc3d2dee8c">AST_MODFLAG_GLOBAL_SYMBOLS</a>, <span class="stringliteral">&quot;Asterisk Gateway Interface (AGI)&quot;</span>,
<a name="l03349"></a>03349       .load = <a class="code" href="res__agi_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>,
<a name="l03350"></a>03350       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l03351"></a><a class="code" href="res__agi_8c.html#ae25b9f3970870610911f8850897e8ead">03351</a>       );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:45 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
