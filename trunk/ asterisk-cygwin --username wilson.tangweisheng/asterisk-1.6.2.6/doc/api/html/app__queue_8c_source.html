<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:26 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_7739c4bd2a7c382676c2c912043775c7.html">apps</a>
  </div>
</div>
<div class="contents">
<h1>app_queue.c</h1><a href="app__queue_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief True call queues with optional send URL on answer</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * \arg Config in \ref Config_qu queues.conf</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * \par Development notes</span>
<a name="l00028"></a>00028 <span class="comment"> * \note 2004-11-25: Persistent Dynamic Members added by:</span>
<a name="l00029"></a>00029 <span class="comment"> *             NetNation Communications (www.netnation.com)</span>
<a name="l00030"></a>00030 <span class="comment"> *             Kevin Lindsay &lt;kevinl@netnation.com&gt;</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> *             Each dynamic agent in each queue is now stored in the astdb.</span>
<a name="l00033"></a>00033 <span class="comment"> *             When asterisk is restarted, each agent will be automatically</span>
<a name="l00034"></a>00034 <span class="comment"> *             readded into their recorded queues. This feature can be</span>
<a name="l00035"></a>00035 <span class="comment"> *             configured with the &apos;persistent_members=&lt;1|0&gt;&apos; setting in the</span>
<a name="l00036"></a>00036 <span class="comment"> *             &apos;[general]&apos; category in queues.conf. The default is on.</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> * \note 2004-06-04: Priorities in queues added by inAccess Networks (work funded by Hellas On Line (HOL) www.hol.gr).</span>
<a name="l00039"></a>00039 <span class="comment"> *</span>
<a name="l00040"></a>00040 <span class="comment"> * \note These features added by David C. Troy &lt;dave@toad.net&gt;:</span>
<a name="l00041"></a>00041 <span class="comment"> *    - Per-queue holdtime calculation</span>
<a name="l00042"></a>00042 <span class="comment"> *    - Estimated holdtime announcement</span>
<a name="l00043"></a>00043 <span class="comment"> *    - Position announcement</span>
<a name="l00044"></a>00044 <span class="comment"> *    - Abandoned/completed call counters</span>
<a name="l00045"></a>00045 <span class="comment"> *    - Failout timer passed as optional app parameter</span>
<a name="l00046"></a>00046 <span class="comment"> *    - Optional monitoring of calls, started when call is answered</span>
<a name="l00047"></a>00047 <span class="comment"> *</span>
<a name="l00048"></a>00048 <span class="comment"> * Patch Version 1.07 2003-12-24 01</span>
<a name="l00049"></a>00049 <span class="comment"> *</span>
<a name="l00050"></a>00050 <span class="comment"> * Added servicelevel statistic by Michiel Betel &lt;michiel@betel.nl&gt;</span>
<a name="l00051"></a>00051 <span class="comment"> * Added Priority jumping code for adding and removing queue members by Jonathan Stanton &lt;asterisk@doilooklikeicare.com&gt;</span>
<a name="l00052"></a>00052 <span class="comment"> *</span>
<a name="l00053"></a>00053 <span class="comment"> * Fixed to work with CVS as of 2004-02-25 and released as 1.07a</span>
<a name="l00054"></a>00054 <span class="comment"> * by Matthew Enger &lt;m.enger@xi.com.au&gt;</span>
<a name="l00055"></a>00055 <span class="comment"> *</span>
<a name="l00056"></a>00056 <span class="comment"> * \ingroup applications</span>
<a name="l00057"></a>00057 <span class="comment"> */</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">/*** MODULEINFO</span>
<a name="l00060"></a>00060 <span class="comment">   &lt;depend&gt;res_monitor&lt;/depend&gt;</span>
<a name="l00061"></a>00061 <span class="comment"> ***/</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 247737 $&quot;</span>)
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/signal.h&gt;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="linkedlists_8h.html" title="A set of macros to manage forward-linked lists.">asterisk/linkedlists.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="translate_8h.html" title="Support for translation of data formats. translate.c.">asterisk/translate.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="say_8h.html" title="Say numbers and dates (maybe words one day too).">asterisk/say.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="features_8h.html" title="Call Parking and Pickup API Includes code and algorithms from the Zapata library...">asterisk/features.h</a>&quot;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="musiconhold_8h.html" title="Music on hold handling.">asterisk/musiconhold.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00086"></a>00086 <span class="preprocessor">#include &quot;<a class="code" href="monitor_8h.html" title="Channel monitoring.">asterisk/monitor.h</a>&quot;</span>
<a name="l00087"></a>00087 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include &quot;<a class="code" href="causes_8h.html" title="Internal Asterisk hangup causes.">asterisk/causes.h</a>&quot;</span>
<a name="l00089"></a>00089 <span class="preprocessor">#include &quot;<a class="code" href="astdb_8h.html" title="Persistant data storage (akin to *doze registry).">asterisk/astdb.h</a>&quot;</span>
<a name="l00090"></a>00090 <span class="preprocessor">#include &quot;<a class="code" href="devicestate_8h.html" title="Device state management.">asterisk/devicestate.h</a>&quot;</span>
<a name="l00091"></a>00091 <span class="preprocessor">#include &quot;<a class="code" href="stringfields_8h.html" title="String fields in structures.">asterisk/stringfields.h</a>&quot;</span>
<a name="l00092"></a>00092 <span class="preprocessor">#include &quot;<a class="code" href="event_8h.html">asterisk/event.h</a>&quot;</span>
<a name="l00093"></a>00093 <span class="preprocessor">#include &quot;<a class="code" href="astobj2_8h.html">asterisk/astobj2.h</a>&quot;</span>
<a name="l00094"></a>00094 <span class="preprocessor">#include &quot;<a class="code" href="strings_8h.html" title="String manipulation functions.">asterisk/strings.h</a>&quot;</span>
<a name="l00095"></a>00095 <span class="preprocessor">#include &quot;<a class="code" href="global__datastores_8h.html" title="globally accessible channel datastores">asterisk/global_datastores.h</a>&quot;</span>
<a name="l00096"></a>00096 <span class="preprocessor">#include &quot;<a class="code" href="taskprocessor_8h.html" title="An API for managing task processing threads that can be shared across modules.">asterisk/taskprocessor.h</a>&quot;</span>
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="comment">/* Define, to debug reference counts on queues, without debugging reference counts on queue members */</span>
<a name="l00099"></a>00099 <span class="comment">/* #define REF_DEBUG_ONLY_QUEUES */</span>
<a name="l00100"></a>00100 <span class="comment"></span>
<a name="l00101"></a>00101 <span class="comment">/*!</span>
<a name="l00102"></a>00102 <span class="comment"> * \par Please read before modifying this file.</span>
<a name="l00103"></a>00103 <span class="comment"> * There are three locks which are regularly used</span>
<a name="l00104"></a>00104 <span class="comment"> * throughout this file, the queue list lock, the lock</span>
<a name="l00105"></a>00105 <span class="comment"> * for each individual queue, and the interface list lock.</span>
<a name="l00106"></a>00106 <span class="comment"> * Please be extra careful to always lock in the following order</span>
<a name="l00107"></a>00107 <span class="comment"> * 1) queue list lock</span>
<a name="l00108"></a>00108 <span class="comment"> * 2) individual queue lock</span>
<a name="l00109"></a>00109 <span class="comment"> * 3) interface list lock</span>
<a name="l00110"></a>00110 <span class="comment"> * This order has sort of &quot;evolved&quot; over the lifetime of this</span>
<a name="l00111"></a>00111 <span class="comment"> * application, but it is now in place this way, so please adhere</span>
<a name="l00112"></a>00112 <span class="comment"> * to this order!</span>
<a name="l00113"></a>00113 <span class="comment"> */</span>
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="comment">/*** DOCUMENTATION</span>
<a name="l00116"></a>00116 <span class="comment">   &lt;application name=&quot;Queue&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00117"></a>00117 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00118"></a>00118 <span class="comment">         Queue a call for a call queue.</span>
<a name="l00119"></a>00119 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00120"></a>00120 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00121"></a>00121 <span class="comment">         &lt;parameter name=&quot;queuename&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00122"></a>00122 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00123"></a>00123 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00124"></a>00124 <span class="comment">               &lt;option name=&quot;C&quot;&gt;</span>
<a name="l00125"></a>00125 <span class="comment">                  &lt;para&gt;Mark all calls as &quot;answered elsewhere&quot; when cancelled.&lt;/para&gt;</span>
<a name="l00126"></a>00126 <span class="comment">               &lt;/option&gt;</span>
<a name="l00127"></a>00127 <span class="comment">               &lt;option name=&quot;c&quot;&gt;</span>
<a name="l00128"></a>00128 <span class="comment">                  &lt;para&gt;Continue in the dialplan if the callee hangs up.&lt;/para&gt;</span>
<a name="l00129"></a>00129 <span class="comment">               &lt;/option&gt;</span>
<a name="l00130"></a>00130 <span class="comment">               &lt;option name=&quot;d&quot;&gt;</span>
<a name="l00131"></a>00131 <span class="comment">                  &lt;para&gt;data-quality (modem) call (minimum delay).&lt;/para&gt;</span>
<a name="l00132"></a>00132 <span class="comment">               &lt;/option&gt;</span>
<a name="l00133"></a>00133 <span class="comment">               &lt;option name=&quot;h&quot;&gt;</span>
<a name="l00134"></a>00134 <span class="comment">                  &lt;para&gt;Allow &lt;emphasis&gt;callee&lt;/emphasis&gt; to hang up by pressing &lt;literal&gt;*&lt;/literal&gt;.&lt;/para&gt;</span>
<a name="l00135"></a>00135 <span class="comment">               &lt;/option&gt;</span>
<a name="l00136"></a>00136 <span class="comment">               &lt;option name=&quot;H&quot;&gt;</span>
<a name="l00137"></a>00137 <span class="comment">                  &lt;para&gt;Allow &lt;emphasis&gt;caller&lt;/emphasis&gt; to hang up by pressing &lt;literal&gt;*&lt;/literal&gt;.&lt;/para&gt;</span>
<a name="l00138"></a>00138 <span class="comment">               &lt;/option&gt;</span>
<a name="l00139"></a>00139 <span class="comment">               &lt;option name=&quot;n&quot;&gt;</span>
<a name="l00140"></a>00140 <span class="comment">                  &lt;para&gt;No retries on the timeout; will exit this application and</span>
<a name="l00141"></a>00141 <span class="comment">                  go to the next step.&lt;/para&gt;</span>
<a name="l00142"></a>00142 <span class="comment">               &lt;/option&gt;</span>
<a name="l00143"></a>00143 <span class="comment">               &lt;option name=&quot;i&quot;&gt;</span>
<a name="l00144"></a>00144 <span class="comment">                  &lt;para&gt;Ignore call forward requests from queue members and do nothing</span>
<a name="l00145"></a>00145 <span class="comment">                  when they are requested.&lt;/para&gt;</span>
<a name="l00146"></a>00146 <span class="comment">               &lt;/option&gt;</span>
<a name="l00147"></a>00147 <span class="comment">               &lt;option name=&quot;r&quot;&gt;</span>
<a name="l00148"></a>00148 <span class="comment">                  &lt;para&gt;Ring instead of playing MOH. Periodic Announcements are still made, if applicable.&lt;/para&gt;</span>
<a name="l00149"></a>00149 <span class="comment">               &lt;/option&gt;</span>
<a name="l00150"></a>00150 <span class="comment">               &lt;option name=&quot;t&quot;&gt;</span>
<a name="l00151"></a>00151 <span class="comment">                  &lt;para&gt;Allow the &lt;emphasis&gt;called&lt;/emphasis&gt; user to transfer the calling user.&lt;/para&gt;</span>
<a name="l00152"></a>00152 <span class="comment">               &lt;/option&gt;</span>
<a name="l00153"></a>00153 <span class="comment">               &lt;option name=&quot;T&quot;&gt;</span>
<a name="l00154"></a>00154 <span class="comment">                  &lt;para&gt;Allow the &lt;emphasis&gt;calling&lt;/emphasis&gt; user to transfer the call.&lt;/para&gt;</span>
<a name="l00155"></a>00155 <span class="comment">               &lt;/option&gt;</span>
<a name="l00156"></a>00156 <span class="comment">               &lt;option name=&quot;w&quot;&gt;</span>
<a name="l00157"></a>00157 <span class="comment">                  &lt;para&gt;Allow the &lt;emphasis&gt;called&lt;/emphasis&gt; user to write the conversation to</span>
<a name="l00158"></a>00158 <span class="comment">                  disk via Monitor.&lt;/para&gt;</span>
<a name="l00159"></a>00159 <span class="comment">               &lt;/option&gt;</span>
<a name="l00160"></a>00160 <span class="comment">               &lt;option name=&quot;W&quot;&gt;</span>
<a name="l00161"></a>00161 <span class="comment">                  &lt;para&gt;Allow the &lt;emphasis&gt;calling&lt;/emphasis&gt; user to write the conversation to</span>
<a name="l00162"></a>00162 <span class="comment">                  disk via Monitor.&lt;/para&gt;</span>
<a name="l00163"></a>00163 <span class="comment">               &lt;/option&gt;</span>
<a name="l00164"></a>00164 <span class="comment">               &lt;option name=&quot;k&quot;&gt;</span>
<a name="l00165"></a>00165 <span class="comment">                  &lt;para&gt;Allow the &lt;emphasis&gt;called&lt;/emphasis&gt; party to enable parking of the call by sending</span>
<a name="l00166"></a>00166 <span class="comment">                  the DTMF sequence defined for call parking in &lt;filename&gt;features.conf&lt;/filename&gt;.&lt;/para&gt;</span>
<a name="l00167"></a>00167 <span class="comment">               &lt;/option&gt;</span>
<a name="l00168"></a>00168 <span class="comment">               &lt;option name=&quot;K&quot;&gt;</span>
<a name="l00169"></a>00169 <span class="comment">                  &lt;para&gt;Allow the &lt;emphasis&gt;calling&lt;/emphasis&gt; party to enable parking of the call by sending</span>
<a name="l00170"></a>00170 <span class="comment">                  the DTMF sequence defined for call parking in &lt;filename&gt;features.conf&lt;/filename&gt;.&lt;/para&gt;</span>
<a name="l00171"></a>00171 <span class="comment">               &lt;/option&gt;</span>
<a name="l00172"></a>00172 <span class="comment">               &lt;option name=&quot;x&quot;&gt;</span>
<a name="l00173"></a>00173 <span class="comment">                  &lt;para&gt;Allow the &lt;emphasis&gt;called&lt;/emphasis&gt; user to write the conversation</span>
<a name="l00174"></a>00174 <span class="comment">                  to disk via MixMonitor.&lt;/para&gt;</span>
<a name="l00175"></a>00175 <span class="comment">               &lt;/option&gt;</span>
<a name="l00176"></a>00176 <span class="comment">               &lt;option name=&quot;X&quot;&gt;</span>
<a name="l00177"></a>00177 <span class="comment">                  &lt;para&gt;Allow the &lt;emphasis&gt;calling&lt;/emphasis&gt; user to write the conversation to</span>
<a name="l00178"></a>00178 <span class="comment">                  disk via MixMonitor.&lt;/para&gt;</span>
<a name="l00179"></a>00179 <span class="comment">               &lt;/option&gt;</span>
<a name="l00180"></a>00180 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00181"></a>00181 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00182"></a>00182 <span class="comment">         &lt;parameter name=&quot;URL&quot;&gt;</span>
<a name="l00183"></a>00183 <span class="comment">            &lt;para&gt;&lt;replaceable&gt;URL&lt;/replaceable&gt; will be sent to the called party if the channel supports it.&lt;/para&gt;</span>
<a name="l00184"></a>00184 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00185"></a>00185 <span class="comment">         &lt;parameter name=&quot;announceoverride&quot; /&gt;</span>
<a name="l00186"></a>00186 <span class="comment">         &lt;parameter name=&quot;timeout&quot;&gt;</span>
<a name="l00187"></a>00187 <span class="comment">            &lt;para&gt;Will cause the queue to fail out after a specified number of</span>
<a name="l00188"></a>00188 <span class="comment">            seconds, checked between each &lt;filename&gt;queues.conf&lt;/filename&gt; &lt;replaceable&gt;timeout&lt;/replaceable&gt; and</span>
<a name="l00189"></a>00189 <span class="comment">            &lt;replaceable&gt;retry&lt;/replaceable&gt; cycle.&lt;/para&gt;</span>
<a name="l00190"></a>00190 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00191"></a>00191 <span class="comment">         &lt;parameter name=&quot;AGI&quot;&gt;</span>
<a name="l00192"></a>00192 <span class="comment">            &lt;para&gt;Will setup an AGI script to be executed on the calling party&apos;s channel once they are</span>
<a name="l00193"></a>00193 <span class="comment">            connected to a queue member.&lt;/para&gt;</span>
<a name="l00194"></a>00194 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00195"></a>00195 <span class="comment">         &lt;parameter name=&quot;macro&quot;&gt;</span>
<a name="l00196"></a>00196 <span class="comment">            &lt;para&gt;Will run a macro on the calling party&apos;s channel once they are connected to a queue member.&lt;/para&gt;</span>
<a name="l00197"></a>00197 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00198"></a>00198 <span class="comment">         &lt;parameter name=&quot;gosub&quot;&gt;</span>
<a name="l00199"></a>00199 <span class="comment">            &lt;para&gt;Will run a gosub on the calling party&apos;s channel once they are connected to a queue member.&lt;/para&gt;</span>
<a name="l00200"></a>00200 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00201"></a>00201 <span class="comment">         &lt;parameter name=&quot;rule&quot;&gt;</span>
<a name="l00202"></a>00202 <span class="comment">            &lt;para&gt;Will cause the queue&apos;s defaultrule to be overridden by the rule specified.&lt;/para&gt;</span>
<a name="l00203"></a>00203 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00204"></a>00204 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00205"></a>00205 <span class="comment">      &lt;description&gt;</span>
<a name="l00206"></a>00206 <span class="comment">         &lt;para&gt;In addition to transferring the call, a call may be parked and then picked</span>
<a name="l00207"></a>00207 <span class="comment">         up by another user.&lt;/para&gt;</span>
<a name="l00208"></a>00208 <span class="comment">         &lt;para&gt;This application will return to the dialplan if the queue does not exist, or</span>
<a name="l00209"></a>00209 <span class="comment">         any of the join options cause the caller to not enter the queue.&lt;/para&gt;</span>
<a name="l00210"></a>00210 <span class="comment">         &lt;para&gt;This application sets the following channel variable upon completion:&lt;/para&gt;</span>
<a name="l00211"></a>00211 <span class="comment">         &lt;variablelist&gt;</span>
<a name="l00212"></a>00212 <span class="comment">            &lt;variable name=&quot;QUEUESTATUS&quot;&gt;</span>
<a name="l00213"></a>00213 <span class="comment">               &lt;para&gt;The status of the call as a text string.&lt;/para&gt;</span>
<a name="l00214"></a>00214 <span class="comment">               &lt;value name=&quot;TIMEOUT&quot; /&gt;</span>
<a name="l00215"></a>00215 <span class="comment">               &lt;value name=&quot;FULL&quot; /&gt;</span>
<a name="l00216"></a>00216 <span class="comment">               &lt;value name=&quot;JOINEMPTY&quot; /&gt;</span>
<a name="l00217"></a>00217 <span class="comment">               &lt;value name=&quot;LEAVEEMPTY&quot; /&gt;</span>
<a name="l00218"></a>00218 <span class="comment">               &lt;value name=&quot;JOINUNAVAIL&quot; /&gt;</span>
<a name="l00219"></a>00219 <span class="comment">               &lt;value name=&quot;LEAVEUNAVAIL&quot; /&gt;</span>
<a name="l00220"></a>00220 <span class="comment">               &lt;value name=&quot;CONTINUE&quot; /&gt;</span>
<a name="l00221"></a>00221 <span class="comment">            &lt;/variable&gt;</span>
<a name="l00222"></a>00222 <span class="comment">         &lt;/variablelist&gt;</span>
<a name="l00223"></a>00223 <span class="comment">      &lt;/description&gt;</span>
<a name="l00224"></a>00224 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00225"></a>00225 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;AddQueueMember&lt;/ref&gt;</span>
<a name="l00226"></a>00226 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;RemoveQueueMember&lt;/ref&gt;</span>
<a name="l00227"></a>00227 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;PauseQueueMember&lt;/ref&gt;</span>
<a name="l00228"></a>00228 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;UnpauseQueueMember&lt;/ref&gt;</span>
<a name="l00229"></a>00229 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;AgentLogin&lt;/ref&gt;</span>
<a name="l00230"></a>00230 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;QUEUE_MEMBER_COUNT&lt;/ref&gt;</span>
<a name="l00231"></a>00231 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;QUEUE_MEMBER_LIST&lt;/ref&gt;</span>
<a name="l00232"></a>00232 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;QUEUE_WAITING_COUNT&lt;/ref&gt;</span>
<a name="l00233"></a>00233 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00234"></a>00234 <span class="comment">   &lt;/application&gt;</span>
<a name="l00235"></a>00235 <span class="comment">   &lt;application name=&quot;AddQueueMember&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00236"></a>00236 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00237"></a>00237 <span class="comment">         Dynamically adds queue members.</span>
<a name="l00238"></a>00238 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00239"></a>00239 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00240"></a>00240 <span class="comment">         &lt;parameter name=&quot;queuename&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00241"></a>00241 <span class="comment">         &lt;parameter name=&quot;interface&quot; /&gt;</span>
<a name="l00242"></a>00242 <span class="comment">         &lt;parameter name=&quot;penalty&quot; /&gt;</span>
<a name="l00243"></a>00243 <span class="comment">         &lt;parameter name=&quot;options&quot; /&gt;</span>
<a name="l00244"></a>00244 <span class="comment">         &lt;parameter name=&quot;membername&quot; /&gt;</span>
<a name="l00245"></a>00245 <span class="comment">         &lt;parameter name=&quot;stateinterface&quot; /&gt;</span>
<a name="l00246"></a>00246 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00247"></a>00247 <span class="comment">      &lt;description&gt;</span>
<a name="l00248"></a>00248 <span class="comment">         &lt;para&gt;Dynamically adds interface to an existing queue. If the interface is</span>
<a name="l00249"></a>00249 <span class="comment">         already in the queue it will return an error.&lt;/para&gt;</span>
<a name="l00250"></a>00250 <span class="comment">         &lt;para&gt;This application sets the following channel variable upon completion:&lt;/para&gt;</span>
<a name="l00251"></a>00251 <span class="comment">         &lt;variablelist&gt;</span>
<a name="l00252"></a>00252 <span class="comment">            &lt;variable name=&quot;AQMSTATUS&quot;&gt;</span>
<a name="l00253"></a>00253 <span class="comment">               &lt;para&gt;The status of the attempt to add a queue member as a text string.&lt;/para&gt;</span>
<a name="l00254"></a>00254 <span class="comment">               &lt;value name=&quot;ADDED&quot; /&gt;</span>
<a name="l00255"></a>00255 <span class="comment">               &lt;value name=&quot;MEMBERALREADY&quot; /&gt;</span>
<a name="l00256"></a>00256 <span class="comment">               &lt;value name=&quot;NOSUCHQUEUE&quot; /&gt;</span>
<a name="l00257"></a>00257 <span class="comment">            &lt;/variable&gt;</span>
<a name="l00258"></a>00258 <span class="comment">         &lt;/variablelist&gt;</span>
<a name="l00259"></a>00259 <span class="comment">      &lt;/description&gt;</span>
<a name="l00260"></a>00260 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00261"></a>00261 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;RemoveQueueMember&lt;/ref&gt;</span>
<a name="l00262"></a>00262 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;PauseQueueMember&lt;/ref&gt;</span>
<a name="l00263"></a>00263 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;UnpauseQueueMember&lt;/ref&gt;</span>
<a name="l00264"></a>00264 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;AgentLogin&lt;/ref&gt;</span>
<a name="l00265"></a>00265 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00266"></a>00266 <span class="comment">   &lt;/application&gt;</span>
<a name="l00267"></a>00267 <span class="comment">   &lt;application name=&quot;RemoveQueueMember&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00268"></a>00268 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00269"></a>00269 <span class="comment">         Dynamically removes queue members.</span>
<a name="l00270"></a>00270 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00271"></a>00271 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00272"></a>00272 <span class="comment">         &lt;parameter name=&quot;queuename&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00273"></a>00273 <span class="comment">         &lt;parameter name=&quot;interface&quot; /&gt;</span>
<a name="l00274"></a>00274 <span class="comment">         &lt;parameter name=&quot;options&quot; /&gt;</span>
<a name="l00275"></a>00275 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00276"></a>00276 <span class="comment">      &lt;description&gt;</span>
<a name="l00277"></a>00277 <span class="comment">         &lt;para&gt;If the interface is &lt;emphasis&gt;NOT&lt;/emphasis&gt; in the queue it will return an error.&lt;/para&gt;</span>
<a name="l00278"></a>00278 <span class="comment">         &lt;para&gt;This application sets the following channel variable upon completion:&lt;/para&gt;</span>
<a name="l00279"></a>00279 <span class="comment">         &lt;variablelist&gt;</span>
<a name="l00280"></a>00280 <span class="comment">            &lt;variable name=&quot;RQMSTATUS&quot;&gt;</span>
<a name="l00281"></a>00281 <span class="comment">               &lt;value name=&quot;REMOVED&quot; /&gt;</span>
<a name="l00282"></a>00282 <span class="comment">               &lt;value name=&quot;NOTINQUEUE&quot; /&gt;</span>
<a name="l00283"></a>00283 <span class="comment">               &lt;value name=&quot;NOSUCHQUEUE&quot; /&gt;</span>
<a name="l00284"></a>00284 <span class="comment">            &lt;/variable&gt;</span>
<a name="l00285"></a>00285 <span class="comment">         &lt;/variablelist&gt;</span>
<a name="l00286"></a>00286 <span class="comment">         &lt;para&gt;Example: RemoveQueueMember(techsupport,SIP/3000)&lt;/para&gt;</span>
<a name="l00287"></a>00287 <span class="comment">      &lt;/description&gt;</span>
<a name="l00288"></a>00288 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00289"></a>00289 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Queue&lt;/ref&gt;</span>
<a name="l00290"></a>00290 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;AddQueueMember&lt;/ref&gt;</span>
<a name="l00291"></a>00291 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;PauseQueueMember&lt;/ref&gt;</span>
<a name="l00292"></a>00292 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;UnpauseQueueMember&lt;/ref&gt;</span>
<a name="l00293"></a>00293 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00294"></a>00294 <span class="comment">   &lt;/application&gt;</span>
<a name="l00295"></a>00295 <span class="comment">   &lt;application name=&quot;PauseQueueMember&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00296"></a>00296 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00297"></a>00297 <span class="comment">         Pauses a queue member.</span>
<a name="l00298"></a>00298 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00299"></a>00299 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00300"></a>00300 <span class="comment">         &lt;parameter name=&quot;queuename&quot; /&gt;</span>
<a name="l00301"></a>00301 <span class="comment">         &lt;parameter name=&quot;interface&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00302"></a>00302 <span class="comment">         &lt;parameter name=&quot;options&quot; /&gt;</span>
<a name="l00303"></a>00303 <span class="comment">         &lt;parameter name=&quot;reason&quot;&gt;</span>
<a name="l00304"></a>00304 <span class="comment">            &lt;para&gt;Is used to add extra information to the appropriate queue_log entries and manager events.&lt;/para&gt;</span>
<a name="l00305"></a>00305 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00306"></a>00306 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00307"></a>00307 <span class="comment">      &lt;description&gt;</span>
<a name="l00308"></a>00308 <span class="comment">         &lt;para&gt;Pauses (blocks calls for) a queue member. The given interface will be paused in the given queue.</span>
<a name="l00309"></a>00309 <span class="comment">         This prevents any calls from being sent from the queue to the interface until it is</span>
<a name="l00310"></a>00310 <span class="comment">         unpaused with UnpauseQueueMember or the manager interface.  If no queuename is given,</span>
<a name="l00311"></a>00311 <span class="comment">         the interface is paused in every queue it is a member of. The application will fail if the</span>
<a name="l00312"></a>00312 <span class="comment">         interface is not found.&lt;/para&gt;</span>
<a name="l00313"></a>00313 <span class="comment">         &lt;para&gt;This application sets the following channel variable upon completion:&lt;/para&gt;</span>
<a name="l00314"></a>00314 <span class="comment">         &lt;variablelist&gt;</span>
<a name="l00315"></a>00315 <span class="comment">            &lt;variable name=&quot;PQMSTATUS&quot;&gt;</span>
<a name="l00316"></a>00316 <span class="comment">               &lt;para&gt;The status of the attempt to pause a queue member as a text string.&lt;/para&gt;</span>
<a name="l00317"></a>00317 <span class="comment">               &lt;value name=&quot;PAUSED&quot; /&gt;</span>
<a name="l00318"></a>00318 <span class="comment">               &lt;value name=&quot;NOTFOUND&quot; /&gt;</span>
<a name="l00319"></a>00319 <span class="comment">            &lt;/variable&gt;</span>
<a name="l00320"></a>00320 <span class="comment">         &lt;/variablelist&gt;</span>
<a name="l00321"></a>00321 <span class="comment">         &lt;para&gt;Example: PauseQueueMember(,SIP/3000)&lt;/para&gt;</span>
<a name="l00322"></a>00322 <span class="comment">      &lt;/description&gt;</span>
<a name="l00323"></a>00323 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00324"></a>00324 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;UnpauseQueueMember&lt;/ref&gt;</span>
<a name="l00325"></a>00325 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00326"></a>00326 <span class="comment">   &lt;/application&gt;</span>
<a name="l00327"></a>00327 <span class="comment">   &lt;application name=&quot;UnpauseQueueMember&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00328"></a>00328 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00329"></a>00329 <span class="comment">         Unpauses a queue member.      </span>
<a name="l00330"></a>00330 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00331"></a>00331 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00332"></a>00332 <span class="comment">         &lt;parameter name=&quot;queuename&quot; /&gt;</span>
<a name="l00333"></a>00333 <span class="comment">         &lt;parameter name=&quot;interface&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00334"></a>00334 <span class="comment">         &lt;parameter name=&quot;options&quot; /&gt;</span>
<a name="l00335"></a>00335 <span class="comment">         &lt;parameter name=&quot;reason&quot;&gt;</span>
<a name="l00336"></a>00336 <span class="comment">            &lt;para&gt;Is used to add extra information to the appropriate queue_log entries and manager events.&lt;/para&gt;</span>
<a name="l00337"></a>00337 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00338"></a>00338 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00339"></a>00339 <span class="comment">      &lt;description&gt;</span>
<a name="l00340"></a>00340 <span class="comment">         &lt;para&gt;Unpauses (resumes calls to) a queue member. This is the counterpart to &lt;literal&gt;PauseQueueMember()&lt;/literal&gt;</span>
<a name="l00341"></a>00341 <span class="comment">         and operates exactly the same way, except it unpauses instead of pausing the given interface.&lt;/para&gt;</span>
<a name="l00342"></a>00342 <span class="comment">         &lt;para&gt;This application sets the following channel variable upon completion:&lt;/para&gt;</span>
<a name="l00343"></a>00343 <span class="comment">         &lt;variablelist&gt;</span>
<a name="l00344"></a>00344 <span class="comment">            &lt;variable name=&quot;UPQMSTATUS&quot;&gt;</span>
<a name="l00345"></a>00345 <span class="comment">               &lt;para&gt;The status of the attempt to unpause a queue member as a text string.&lt;/para&gt;</span>
<a name="l00346"></a>00346 <span class="comment">               &lt;value name=&quot;UNPAUSED&quot; /&gt;</span>
<a name="l00347"></a>00347 <span class="comment">               &lt;value name=&quot;NOTFOUND&quot; /&gt;</span>
<a name="l00348"></a>00348 <span class="comment">            &lt;/variable&gt;</span>
<a name="l00349"></a>00349 <span class="comment">         &lt;/variablelist&gt;</span>
<a name="l00350"></a>00350 <span class="comment">         &lt;para&gt;Example: UnpauseQueueMember(,SIP/3000)&lt;/para&gt;</span>
<a name="l00351"></a>00351 <span class="comment">      &lt;/description&gt;</span>
<a name="l00352"></a>00352 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00353"></a>00353 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;PauseQueueMember&lt;/ref&gt;</span>
<a name="l00354"></a>00354 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00355"></a>00355 <span class="comment">   &lt;/application&gt;</span>
<a name="l00356"></a>00356 <span class="comment">   &lt;application name=&quot;QueueLog&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00357"></a>00357 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00358"></a>00358 <span class="comment">         Writes to the queue_log file.</span>
<a name="l00359"></a>00359 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00360"></a>00360 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00361"></a>00361 <span class="comment">         &lt;parameter name=&quot;queuename&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00362"></a>00362 <span class="comment">         &lt;parameter name=&quot;uniqueid&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00363"></a>00363 <span class="comment">         &lt;parameter name=&quot;agent&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00364"></a>00364 <span class="comment">         &lt;parameter name=&quot;event&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00365"></a>00365 <span class="comment">         &lt;parameter name=&quot;additionalinfo&quot; /&gt;</span>
<a name="l00366"></a>00366 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00367"></a>00367 <span class="comment">      &lt;description&gt;</span>
<a name="l00368"></a>00368 <span class="comment">         &lt;para&gt;Allows you to write your own events into the queue log.&lt;/para&gt;</span>
<a name="l00369"></a>00369 <span class="comment">         &lt;para&gt;Example: QueueLog(101,${UNIQUEID},${AGENT},WENTONBREAK,600)&lt;/para&gt;</span>
<a name="l00370"></a>00370 <span class="comment">      &lt;/description&gt;</span>
<a name="l00371"></a>00371 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00372"></a>00372 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Queue&lt;/ref&gt;</span>
<a name="l00373"></a>00373 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00374"></a>00374 <span class="comment">   &lt;/application&gt;</span>
<a name="l00375"></a>00375 <span class="comment">   &lt;function name=&quot;QUEUE_VARIABLES&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00376"></a>00376 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00377"></a>00377 <span class="comment">         Return Queue information in variables.</span>
<a name="l00378"></a>00378 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00379"></a>00379 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00380"></a>00380 <span class="comment">         &lt;parameter name=&quot;queuename&quot; required=&quot;true&quot;&gt;</span>
<a name="l00381"></a>00381 <span class="comment">            &lt;enumlist&gt;</span>
<a name="l00382"></a>00382 <span class="comment">               &lt;enum name=&quot;QUEUEMAX&quot;&gt;</span>
<a name="l00383"></a>00383 <span class="comment">                  &lt;para&gt;Maxmimum number of calls allowed.&lt;/para&gt;</span>
<a name="l00384"></a>00384 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00385"></a>00385 <span class="comment">               &lt;enum name=&quot;QUEUESTRATEGY&quot;&gt;</span>
<a name="l00386"></a>00386 <span class="comment">                  &lt;para&gt;The strategy of the queue.&lt;/para&gt;</span>
<a name="l00387"></a>00387 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00388"></a>00388 <span class="comment">               &lt;enum name=&quot;QUEUECALLS&quot;&gt;</span>
<a name="l00389"></a>00389 <span class="comment">                  &lt;para&gt;Number of calls currently in the queue.&lt;/para&gt;</span>
<a name="l00390"></a>00390 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00391"></a>00391 <span class="comment">               &lt;enum name=&quot;QUEUEHOLDTIME&quot;&gt;</span>
<a name="l00392"></a>00392 <span class="comment">                  &lt;para&gt;Current average hold time.&lt;/para&gt;</span>
<a name="l00393"></a>00393 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00394"></a>00394 <span class="comment">               &lt;enum name=&quot;QUEUECOMPLETED&quot;&gt;</span>
<a name="l00395"></a>00395 <span class="comment">                  &lt;para&gt;Number of completed calls for the queue.&lt;/para&gt;</span>
<a name="l00396"></a>00396 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00397"></a>00397 <span class="comment">               &lt;enum name=&quot;QUEUEABANDONED&quot;&gt;</span>
<a name="l00398"></a>00398 <span class="comment">                  &lt;para&gt;Number of abandoned calls.&lt;/para&gt;</span>
<a name="l00399"></a>00399 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00400"></a>00400 <span class="comment">               &lt;enum name=&quot;QUEUESRVLEVEL&quot;&gt;</span>
<a name="l00401"></a>00401 <span class="comment">                  &lt;para&gt;Queue service level.&lt;/para&gt;</span>
<a name="l00402"></a>00402 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00403"></a>00403 <span class="comment">               &lt;enum name=&quot;QUEUESRVLEVELPERF&quot;&gt;</span>
<a name="l00404"></a>00404 <span class="comment">                  &lt;para&gt;Current service level performance.&lt;/para&gt;</span>
<a name="l00405"></a>00405 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00406"></a>00406 <span class="comment">            &lt;/enumlist&gt;</span>
<a name="l00407"></a>00407 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00408"></a>00408 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00409"></a>00409 <span class="comment">      &lt;description&gt;</span>
<a name="l00410"></a>00410 <span class="comment">         &lt;para&gt;Makes the following queue variables available.&lt;/para&gt;</span>
<a name="l00411"></a>00411 <span class="comment">         &lt;para&gt;Returns &lt;literal&gt;0&lt;/literal&gt; if queue is found and setqueuevar is defined, &lt;literal&gt;-1&lt;/literal&gt; otherwise.&lt;/para&gt;</span>
<a name="l00412"></a>00412 <span class="comment">      &lt;/description&gt;</span>
<a name="l00413"></a>00413 <span class="comment">   &lt;/function&gt;</span>
<a name="l00414"></a>00414 <span class="comment">   &lt;function name=&quot;QUEUE_MEMBER&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00415"></a>00415 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00416"></a>00416 <span class="comment">         Count number of members answering a queue.</span>
<a name="l00417"></a>00417 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00418"></a>00418 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00419"></a>00419 <span class="comment">         &lt;parameter name=&quot;queuename&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00420"></a>00420 <span class="comment">         &lt;parameter name=&quot;option&quot; required=&quot;true&quot;&gt;</span>
<a name="l00421"></a>00421 <span class="comment">            &lt;enumlist&gt;</span>
<a name="l00422"></a>00422 <span class="comment">               &lt;enum name=&quot;logged&quot;&gt;</span>
<a name="l00423"></a>00423 <span class="comment">                  &lt;para&gt;Returns the number of logged-in members for the specified queue.&lt;/para&gt;</span>
<a name="l00424"></a>00424 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00425"></a>00425 <span class="comment">               &lt;enum name=&quot;free&quot;&gt;</span>
<a name="l00426"></a>00426 <span class="comment">                  &lt;para&gt;Returns the number of logged-in members for the specified queue available to take a call.&lt;/para&gt;</span>
<a name="l00427"></a>00427 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00428"></a>00428 <span class="comment">               &lt;enum name=&quot;count&quot;&gt;</span>
<a name="l00429"></a>00429 <span class="comment">                  &lt;para&gt;Returns the total number of members for the specified queue.&lt;/para&gt;</span>
<a name="l00430"></a>00430 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00431"></a>00431 <span class="comment">            &lt;/enumlist&gt;</span>
<a name="l00432"></a>00432 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00433"></a>00433 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00434"></a>00434 <span class="comment">      &lt;description&gt;</span>
<a name="l00435"></a>00435 <span class="comment">         &lt;para&gt;Returns the number of members currently associated with the specified &lt;replaceable&gt;queuename&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00436"></a>00436 <span class="comment">      &lt;/description&gt;</span>
<a name="l00437"></a>00437 <span class="comment">   &lt;/function&gt;</span>
<a name="l00438"></a>00438 <span class="comment">   &lt;function name=&quot;QUEUE_MEMBER_COUNT&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00439"></a>00439 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00440"></a>00440 <span class="comment">         Count number of members answering a queue.</span>
<a name="l00441"></a>00441 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00442"></a>00442 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00443"></a>00443 <span class="comment">         &lt;parameter name=&quot;queuename&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00444"></a>00444 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00445"></a>00445 <span class="comment">      &lt;description&gt;</span>
<a name="l00446"></a>00446 <span class="comment">         &lt;para&gt;Returns the number of members currently associated with the specified &lt;replaceable&gt;queuename&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00447"></a>00447 <span class="comment">         &lt;warning&gt;&lt;para&gt;This function has been deprecated in favor of the &lt;literal&gt;QUEUE_MEMBER()&lt;/literal&gt; function&lt;/para&gt;&lt;/warning&gt;</span>
<a name="l00448"></a>00448 <span class="comment">      &lt;/description&gt;</span>
<a name="l00449"></a>00449 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00450"></a>00450 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;QUEUE_MEMBER_LIST&lt;/ref&gt;</span>
<a name="l00451"></a>00451 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00452"></a>00452 <span class="comment">   &lt;/function&gt;</span>
<a name="l00453"></a>00453 <span class="comment">   &lt;function name=&quot;QUEUE_WAITING_COUNT&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00454"></a>00454 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00455"></a>00455 <span class="comment">         Count number of calls currently waiting in a queue.</span>
<a name="l00456"></a>00456 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00457"></a>00457 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00458"></a>00458 <span class="comment">         &lt;parameter name=&quot;queuename&quot; /&gt;</span>
<a name="l00459"></a>00459 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00460"></a>00460 <span class="comment">      &lt;description&gt;</span>
<a name="l00461"></a>00461 <span class="comment">         &lt;para&gt;Returns the number of callers currently waiting in the specified &lt;replaceable&gt;queuename&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00462"></a>00462 <span class="comment">      &lt;/description&gt;</span>
<a name="l00463"></a>00463 <span class="comment">   &lt;/function&gt;</span>
<a name="l00464"></a>00464 <span class="comment">   &lt;function name=&quot;QUEUE_MEMBER_LIST&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00465"></a>00465 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00466"></a>00466 <span class="comment">         Returns a list of interfaces on a queue.</span>
<a name="l00467"></a>00467 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00468"></a>00468 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00469"></a>00469 <span class="comment">         &lt;parameter name=&quot;queuename&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00470"></a>00470 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00471"></a>00471 <span class="comment">      &lt;description&gt;</span>
<a name="l00472"></a>00472 <span class="comment">         &lt;para&gt;Returns a comma-separated list of members associated with the specified &lt;replaceable&gt;queuename&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00473"></a>00473 <span class="comment">      &lt;/description&gt;</span>
<a name="l00474"></a>00474 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00475"></a>00475 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;QUEUE_MEMBER_COUNT&lt;/ref&gt;</span>
<a name="l00476"></a>00476 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00477"></a>00477 <span class="comment">   &lt;/function&gt;</span>
<a name="l00478"></a>00478 <span class="comment">   &lt;function name=&quot;QUEUE_MEMBER_PENALTY&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00479"></a>00479 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00480"></a>00480 <span class="comment">         Gets or sets queue members penalty.</span>
<a name="l00481"></a>00481 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00482"></a>00482 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00483"></a>00483 <span class="comment">         &lt;parameter name=&quot;queuename&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00484"></a>00484 <span class="comment">         &lt;parameter name=&quot;interface&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00485"></a>00485 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00486"></a>00486 <span class="comment">      &lt;description&gt;</span>
<a name="l00487"></a>00487 <span class="comment">         &lt;para&gt;Gets or sets queue members penalty.&lt;/para&gt;</span>
<a name="l00488"></a>00488 <span class="comment">      &lt;/description&gt;</span>
<a name="l00489"></a>00489 <span class="comment">   &lt;/function&gt;</span>
<a name="l00490"></a>00490 <span class="comment"></span>
<a name="l00491"></a>00491 <span class="comment"> ***/</span>
<a name="l00492"></a>00492 
<a name="l00493"></a>00493 <span class="keyword">enum</span> {
<a name="l00494"></a><a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">00494</a>    <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a> = 0,
<a name="l00495"></a><a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba5ecd46d3615498a0c1f620952b919855">00495</a>    <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba5ecd46d3615498a0c1f620952b919855">QUEUE_STRATEGY_LEASTRECENT</a>,
<a name="l00496"></a><a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba9b9caf74d13b75b846264a89d5aea9a4">00496</a>    <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba9b9caf74d13b75b846264a89d5aea9a4">QUEUE_STRATEGY_FEWESTCALLS</a>,
<a name="l00497"></a><a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba89db95f6e97c58cd5915abddc140df70">00497</a>    <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba89db95f6e97c58cd5915abddc140df70">QUEUE_STRATEGY_RANDOM</a>,
<a name="l00498"></a><a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba272ff295ebf6d216c1320a296908753a">00498</a>    <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba272ff295ebf6d216c1320a296908753a">QUEUE_STRATEGY_RRMEMORY</a>,
<a name="l00499"></a><a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba49bae9dfad805972b20763389a090d09">00499</a>    <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba49bae9dfad805972b20763389a090d09">QUEUE_STRATEGY_LINEAR</a>,
<a name="l00500"></a><a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebbaee8588c59bd53b91d0cebce5faca7a06">00500</a>    <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebbaee8588c59bd53b91d0cebce5faca7a06">QUEUE_STRATEGY_WRANDOM</a>
<a name="l00501"></a>00501 };
<a name="l00502"></a>00502 
<a name="l00503"></a><a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398">00503</a> <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398">queue_reload_mask</a> {
<a name="l00504"></a><a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398ab18e9313e34662b745beabef3ed7ca44">00504</a>    <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398ab18e9313e34662b745beabef3ed7ca44">QUEUE_RELOAD_PARAMETERS</a> = (1 &lt;&lt; 0),
<a name="l00505"></a><a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a4fc330b82c294649884cd4d189da8d5f">00505</a>    <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a4fc330b82c294649884cd4d189da8d5f">QUEUE_RELOAD_MEMBER</a> = (1 &lt;&lt; 1),
<a name="l00506"></a><a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a04da28a6a506fbc6dfce3f3da3569acc">00506</a>    <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a04da28a6a506fbc6dfce3f3da3569acc">QUEUE_RELOAD_RULES</a> = (1 &lt;&lt; 2),
<a name="l00507"></a><a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a845535b8e69c40b11c12b08740d1357c">00507</a>    <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a845535b8e69c40b11c12b08740d1357c">QUEUE_RESET_STATS</a> = (1 &lt;&lt; 3),
<a name="l00508"></a>00508 };
<a name="l00509"></a>00509 
<a name="l00510"></a><a class="code" href="structstrategy.html">00510</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structstrategy.html">strategy</a> {
<a name="l00511"></a><a class="code" href="structstrategy.html#acc89aafdc65ecd15f010b7c6fc295522">00511</a>    <span class="keywordtype">int</span> <a class="code" href="structstrategy.html">strategy</a>;
<a name="l00512"></a><a class="code" href="structstrategy.html#a8f8f80d37794cde9472343e4487ba3eb">00512</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structstrategy.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;
<a name="l00513"></a>00513 } <a class="code" href="app__queue_8c.html#a289169164125785d433a7e5c2c572052">strategies</a>[] = {
<a name="l00514"></a>00514    { <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>, <span class="stringliteral">&quot;ringall&quot;</span> },
<a name="l00515"></a>00515    { <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba5ecd46d3615498a0c1f620952b919855">QUEUE_STRATEGY_LEASTRECENT</a>, <span class="stringliteral">&quot;leastrecent&quot;</span> },
<a name="l00516"></a>00516    { <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba9b9caf74d13b75b846264a89d5aea9a4">QUEUE_STRATEGY_FEWESTCALLS</a>, <span class="stringliteral">&quot;fewestcalls&quot;</span> },
<a name="l00517"></a>00517    { <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba89db95f6e97c58cd5915abddc140df70">QUEUE_STRATEGY_RANDOM</a>, <span class="stringliteral">&quot;random&quot;</span> },
<a name="l00518"></a>00518    { <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba272ff295ebf6d216c1320a296908753a">QUEUE_STRATEGY_RRMEMORY</a>, <span class="stringliteral">&quot;rrmemory&quot;</span> },
<a name="l00519"></a>00519    { <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba272ff295ebf6d216c1320a296908753a">QUEUE_STRATEGY_RRMEMORY</a>, <span class="stringliteral">&quot;roundrobin&quot;</span> },
<a name="l00520"></a>00520    { <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba49bae9dfad805972b20763389a090d09">QUEUE_STRATEGY_LINEAR</a>, <span class="stringliteral">&quot;linear&quot;</span> },
<a name="l00521"></a>00521    { <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebbaee8588c59bd53b91d0cebce5faca7a06">QUEUE_STRATEGY_WRANDOM</a>, <span class="stringliteral">&quot;wrandom&quot;</span>},
<a name="l00522"></a>00522 };
<a name="l00523"></a>00523 
<a name="l00524"></a><a class="code" href="app__queue_8c.html#afe14f493867425a96c9a4d47b848b058">00524</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__taskprocessor.html" title="A ast_taskprocessor structure is a singleton by name.">ast_taskprocessor</a> *<a class="code" href="app__queue_8c.html#afe14f493867425a96c9a4d47b848b058">devicestate_tps</a>;
<a name="l00525"></a>00525 
<a name="l00526"></a><a class="code" href="app__queue_8c.html#a3f1683ed5a30b46922e3f88b7c716e04">00526</a> <span class="preprocessor">#define DEFAULT_RETRY      5</span>
<a name="l00527"></a><a class="code" href="app__queue_8c.html#aad2dd72565852b91c809cd4685833b17">00527</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_TIMEOUT    15</span>
<a name="l00528"></a><a class="code" href="app__queue_8c.html#ac483b545204943907eab26ae059e65dd">00528</a> <span class="preprocessor"></span><span class="preprocessor">#define RECHECK         1     </span><span class="comment">/*!&lt; Recheck every second to see we we&apos;re at the top yet */</span>
<a name="l00529"></a><a class="code" href="app__queue_8c.html#a2f5d1f6fb6cd3af5e8b07d19e4ab273a">00529</a> <span class="preprocessor">#define MAX_PERIODIC_ANNOUNCEMENTS 10           </span><span class="comment">/*!&lt; The maximum periodic announcements we can have */</span>
<a name="l00530"></a><a class="code" href="app__queue_8c.html#a679ea032e9e26f6e6e569769fb528722">00530</a> <span class="preprocessor">#define DEFAULT_MIN_ANNOUNCE_FREQUENCY 15       </span><span class="comment">/*!&lt; The minimum number of seconds between position announcements \</span>
<a name="l00531"></a>00531 <span class="comment">                                                     The default value of 15 provides backwards compatibility */</span>
<a name="l00532"></a><a class="code" href="app__queue_8c.html#a318c21ecadbe981df2771149df1ed361">00532</a> <span class="preprocessor">#define MAX_QUEUE_BUCKETS 53</span>
<a name="l00533"></a>00533 <span class="preprocessor"></span>
<a name="l00534"></a><a class="code" href="app__queue_8c.html#aaa42581c853cb64af155ddd19937d80e">00534</a> <span class="preprocessor">#define  RES_OKAY 0     </span><span class="comment">/*!&lt; Action completed */</span>
<a name="l00535"></a><a class="code" href="app__queue_8c.html#ae72ca8d43e1d9acf1dbfcbc18c98a3ae">00535</a> <span class="preprocessor">#define  RES_EXISTS  (-1)     </span><span class="comment">/*!&lt; Entry already exists */</span>
<a name="l00536"></a><a class="code" href="app__queue_8c.html#a662a43c452569dfc9f20d49a73498c64">00536</a> <span class="preprocessor">#define  RES_OUTOFMEMORY   (-2)     </span><span class="comment">/*!&lt; Out of memory */</span>
<a name="l00537"></a><a class="code" href="app__queue_8c.html#a88215ab017dd4ed8343d17918eacee81">00537</a> <span class="preprocessor">#define  RES_NOSUCHQUEUE   (-3)     </span><span class="comment">/*!&lt; No such queue */</span>
<a name="l00538"></a><a class="code" href="app__queue_8c.html#a447a632daaf1a56114da95816c12b8a5">00538</a> <span class="preprocessor">#define RES_NOT_DYNAMIC (-4)     </span><span class="comment">/*!&lt; Member is not dynamic */</span>
<a name="l00539"></a>00539 
<a name="l00540"></a><a class="code" href="app__queue_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">00540</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a> = <span class="stringliteral">&quot;Queue&quot;</span>;
<a name="l00541"></a>00541 
<a name="l00542"></a><a class="code" href="app__queue_8c.html#ae30d56b03bf5537faee32eec7856a2bf">00542</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#ae30d56b03bf5537faee32eec7856a2bf">app_aqm</a> = <span class="stringliteral">&quot;AddQueueMember&quot;</span> ;
<a name="l00543"></a>00543 
<a name="l00544"></a><a class="code" href="app__queue_8c.html#a5a66ec06a1a699e1b7827695ee7fa784">00544</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5a66ec06a1a699e1b7827695ee7fa784">app_rqm</a> = <span class="stringliteral">&quot;RemoveQueueMember&quot;</span> ;
<a name="l00545"></a>00545 
<a name="l00546"></a><a class="code" href="app__queue_8c.html#a280cd035294778a19581ae7941fd5d09">00546</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a280cd035294778a19581ae7941fd5d09">app_pqm</a> = <span class="stringliteral">&quot;PauseQueueMember&quot;</span> ;
<a name="l00547"></a>00547 
<a name="l00548"></a><a class="code" href="app__queue_8c.html#a96a36b017bb210c4a0ee72163d7d6baa">00548</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a96a36b017bb210c4a0ee72163d7d6baa">app_upqm</a> = <span class="stringliteral">&quot;UnpauseQueueMember&quot;</span> ;
<a name="l00549"></a>00549 
<a name="l00550"></a><a class="code" href="app__queue_8c.html#a499685f064d4f862700499819b42bb0a">00550</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a499685f064d4f862700499819b42bb0a">app_ql</a> = <span class="stringliteral">&quot;QueueLog&quot;</span> ;
<a name="l00551"></a>00551 <span class="comment"></span>
<a name="l00552"></a>00552 <span class="comment">/*! \brief Persistent Members astdb family */</span>
<a name="l00553"></a><a class="code" href="app__queue_8c.html#a69973b9bcbaa76c881bc5568b8b12f1a">00553</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a69973b9bcbaa76c881bc5568b8b12f1a" title="Persistent Members astdb family.">pm_family</a> = <span class="stringliteral">&quot;Queue/PersistentMembers&quot;</span>;
<a name="l00554"></a>00554 <span class="comment">/* The maximum length of each persistent member queue database entry */</span>
<a name="l00555"></a><a class="code" href="app__queue_8c.html#a84ed86bae7c71bb0b3a5d6db08b7aade">00555</a> <span class="preprocessor">#define PM_MAX_LEN 8192</span>
<a name="l00556"></a>00556 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00557"></a>00557 <span class="comment">/*! \brief queues.conf [general] option */</span>
<a name="l00558"></a><a class="code" href="app__queue_8c.html#a24b4217999f5510710cabfc8a8bc8c07">00558</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a24b4217999f5510710cabfc8a8bc8c07" title="queues.conf [general] option">queue_persistent_members</a> = 0;
<a name="l00559"></a>00559 <span class="comment"></span>
<a name="l00560"></a>00560 <span class="comment">/*! \brief queues.conf per-queue weight option */</span>
<a name="l00561"></a><a class="code" href="app__queue_8c.html#ade12aebf511dcd9862a12c4b25dc2216">00561</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ade12aebf511dcd9862a12c4b25dc2216" title="queues.conf per-queue weight option">use_weight</a> = 0;
<a name="l00562"></a>00562 <span class="comment"></span>
<a name="l00563"></a>00563 <span class="comment">/*! \brief queues.conf [general] option */</span>
<a name="l00564"></a><a class="code" href="app__queue_8c.html#ab20962f473e6a8976a3e4e23b90049cc">00564</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ab20962f473e6a8976a3e4e23b90049cc" title="queues.conf [general] option">autofill_default</a> = 0;
<a name="l00565"></a>00565 <span class="comment"></span>
<a name="l00566"></a>00566 <span class="comment">/*! \brief queues.conf [general] option */</span>
<a name="l00567"></a><a class="code" href="app__queue_8c.html#a255e617ba389793f7425d398afe9d557">00567</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a255e617ba389793f7425d398afe9d557" title="queues.conf [general] option">montype_default</a> = 0;
<a name="l00568"></a>00568 <span class="comment"></span>
<a name="l00569"></a>00569 <span class="comment">/*! \brief queues.conf [general] option */</span>
<a name="l00570"></a><a class="code" href="app__queue_8c.html#a8f2df6113ce7f6858cc4e533d6f0f4bf">00570</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a8f2df6113ce7f6858cc4e533d6f0f4bf" title="queues.conf [general] option">shared_lastcall</a> = 0;
<a name="l00571"></a>00571 <span class="comment"></span>
<a name="l00572"></a>00572 <span class="comment">/*! \brief Subscription to device state change events */</span>
<a name="l00573"></a><a class="code" href="app__queue_8c.html#a51ca11f2c73a7d856c3d3ca3e45fbc31">00573</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__event__sub.html" title="Event subscription.">ast_event_sub</a> *<a class="code" href="app__queue_8c.html#a51ca11f2c73a7d856c3d3ca3e45fbc31" title="Subscription to device state change events.">device_state_sub</a>;
<a name="l00574"></a>00574 <span class="comment"></span>
<a name="l00575"></a>00575 <span class="comment">/*! \brief queues.conf [general] option */</span>
<a name="l00576"></a><a class="code" href="app__queue_8c.html#ac74b177160ca0597a5878ddcb95d9579">00576</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ac74b177160ca0597a5878ddcb95d9579" title="queues.conf [general] option">update_cdr</a> = 0;
<a name="l00577"></a>00577 
<a name="l00578"></a><a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2">00578</a> <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2">queue_result</a> {
<a name="l00579"></a><a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a49a10204f0f100fb6ae669936e01a90c">00579</a>    <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a49a10204f0f100fb6ae669936e01a90c">QUEUE_UNKNOWN</a> = 0,
<a name="l00580"></a><a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2af24af6741501e58c5a32990e70a35a5d">00580</a>    <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2af24af6741501e58c5a32990e70a35a5d">QUEUE_TIMEOUT</a> = 1,
<a name="l00581"></a><a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2aed848300d343eb61491e3ddc2e562b9e">00581</a>    <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2aed848300d343eb61491e3ddc2e562b9e">QUEUE_JOINEMPTY</a> = 2,
<a name="l00582"></a><a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a96a1965ee856fa58fbd96bc5b0ffc101">00582</a>    <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a96a1965ee856fa58fbd96bc5b0ffc101">QUEUE_LEAVEEMPTY</a> = 3,
<a name="l00583"></a><a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2adcb9aca3157b3a850bae64788f6593cd">00583</a>    <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2adcb9aca3157b3a850bae64788f6593cd">QUEUE_JOINUNAVAIL</a> = 4,
<a name="l00584"></a><a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2aa4eb95a01ce1882ef6fe8fc0b7626e2b">00584</a>    <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2aa4eb95a01ce1882ef6fe8fc0b7626e2b">QUEUE_LEAVEUNAVAIL</a> = 5,
<a name="l00585"></a><a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a131d9c4fe1d72d7b5f8532708ae18285">00585</a>    <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a131d9c4fe1d72d7b5f8532708ae18285">QUEUE_FULL</a> = 6,
<a name="l00586"></a><a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a7d363853794316b276622be186ead6f0">00586</a>    <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a7d363853794316b276622be186ead6f0">QUEUE_CONTINUE</a> = 7,
<a name="l00587"></a>00587 };
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 <span class="keyword">const</span> <span class="keyword">struct </span>{
<a name="l00590"></a><a class="code" href="app__queue_8c.html#acd1f0e9b4730ec60f62cb0806cb06ef1">00590</a>    <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2">queue_result</a> <a class="code" href="app__queue_8c.html#acd1f0e9b4730ec60f62cb0806cb06ef1">id</a>;
<a name="l00591"></a><a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">00591</a>    <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>;
<a name="l00592"></a>00592 } <a class="code" href="app__queue_8c.html#a7985366bd7e04a1efe3363de28a60c63">queue_results</a>[] = {
<a name="l00593"></a>00593    { <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a49a10204f0f100fb6ae669936e01a90c">QUEUE_UNKNOWN</a>, <span class="stringliteral">&quot;UNKNOWN&quot;</span> },
<a name="l00594"></a>00594    { <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2af24af6741501e58c5a32990e70a35a5d">QUEUE_TIMEOUT</a>, <span class="stringliteral">&quot;TIMEOUT&quot;</span> },
<a name="l00595"></a>00595    { <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2aed848300d343eb61491e3ddc2e562b9e">QUEUE_JOINEMPTY</a>,<span class="stringliteral">&quot;JOINEMPTY&quot;</span> },
<a name="l00596"></a>00596    { <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a96a1965ee856fa58fbd96bc5b0ffc101">QUEUE_LEAVEEMPTY</a>, <span class="stringliteral">&quot;LEAVEEMPTY&quot;</span> },
<a name="l00597"></a>00597    { <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2adcb9aca3157b3a850bae64788f6593cd">QUEUE_JOINUNAVAIL</a>, <span class="stringliteral">&quot;JOINUNAVAIL&quot;</span> },
<a name="l00598"></a>00598    { <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2aa4eb95a01ce1882ef6fe8fc0b7626e2b">QUEUE_LEAVEUNAVAIL</a>, <span class="stringliteral">&quot;LEAVEUNAVAIL&quot;</span> },
<a name="l00599"></a>00599    { <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a131d9c4fe1d72d7b5f8532708ae18285">QUEUE_FULL</a>, <span class="stringliteral">&quot;FULL&quot;</span> },
<a name="l00600"></a>00600    { <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a7d363853794316b276622be186ead6f0">QUEUE_CONTINUE</a>, <span class="stringliteral">&quot;CONTINUE&quot;</span> },
<a name="l00601"></a>00601 };
<a name="l00602"></a>00602 
<a name="l00603"></a><a class="code" href="app__queue_8c.html#a452e8221d8fbd54db8c589265a09e844">00603</a> <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#a452e8221d8fbd54db8c589265a09e844">queue_timeout_priority</a> {
<a name="l00604"></a><a class="code" href="app__queue_8c.html#a452e8221d8fbd54db8c589265a09e844aabaf51de14755cf9b47a42c3cc460a87">00604</a>    <a class="code" href="app__queue_8c.html#a452e8221d8fbd54db8c589265a09e844aabaf51de14755cf9b47a42c3cc460a87">TIMEOUT_PRIORITY_APP</a>,
<a name="l00605"></a><a class="code" href="app__queue_8c.html#a452e8221d8fbd54db8c589265a09e844a94a7510a93b7241883228503227335af">00605</a>    <a class="code" href="app__queue_8c.html#a452e8221d8fbd54db8c589265a09e844a94a7510a93b7241883228503227335af">TIMEOUT_PRIORITY_CONF</a>,
<a name="l00606"></a>00606 };
<a name="l00607"></a>00607 <span class="comment"></span>
<a name="l00608"></a>00608 <span class="comment">/*! \brief We define a custom &quot;local user&quot; structure because we</span>
<a name="l00609"></a>00609 <span class="comment"> *  use it not only for keeping track of what is in use but</span>
<a name="l00610"></a>00610 <span class="comment"> *  also for keeping track of who we&apos;re dialing.</span>
<a name="l00611"></a>00611 <span class="comment"> *</span>
<a name="l00612"></a>00612 <span class="comment"> *  There are two &quot;links&quot; defined in this structure, q_next and call_next.</span>
<a name="l00613"></a>00613 <span class="comment"> *  q_next links ALL defined callattempt structures into a linked list. call_next is</span>
<a name="l00614"></a>00614 <span class="comment"> *  a link which allows for a subset of the callattempts to be traversed. This subset</span>
<a name="l00615"></a>00615 <span class="comment"> *  is used in wait_for_answer so that irrelevant callattempts are not traversed. This</span>
<a name="l00616"></a>00616 <span class="comment"> *  also is helpful so that queue logs are always accurate in the case where a call to </span>
<a name="l00617"></a>00617 <span class="comment"> *  a member times out, especially if using the ringall strategy. </span>
<a name="l00618"></a>00618 <span class="comment">*/</span>
<a name="l00619"></a>00619 
<a name="l00620"></a><a class="code" href="structcallattempt.html">00620</a> <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> {
<a name="l00621"></a><a class="code" href="structcallattempt.html#a9e0459b954643e4b37535fdcb0140326">00621</a>    <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *<a class="code" href="structcallattempt.html#a9e0459b954643e4b37535fdcb0140326">q_next</a>;
<a name="l00622"></a><a class="code" href="structcallattempt.html#a6babf4f66dfb83d62d08d3401f6e452b">00622</a>    <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *<a class="code" href="structcallattempt.html#a6babf4f66dfb83d62d08d3401f6e452b">call_next</a>;
<a name="l00623"></a><a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">00623</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l00624"></a><a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">00624</a>    <span class="keywordtype">char</span> <a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>[256];
<a name="l00625"></a><a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">00625</a>    <span class="keywordtype">int</span> <a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a>;
<a name="l00626"></a><a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">00626</a>    <span class="keywordtype">int</span> <a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a>;
<a name="l00627"></a><a class="code" href="structcallattempt.html#a0a56811891e1336d4eec52d3281854a9">00627</a>    <span class="keywordtype">int</span> <a class="code" href="structcallattempt.html#a0a56811891e1336d4eec52d3281854a9">oldstatus</a>;
<a name="l00628"></a><a class="code" href="structcallattempt.html#a33479a2976f279910df62bda3a3df62d">00628</a>    time_t <a class="code" href="structcallattempt.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>;
<a name="l00629"></a><a class="code" href="structcallattempt.html#ad666640d5cfd34a434cfa5347f50def4">00629</a>    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *<a class="code" href="structcallattempt.html#ad666640d5cfd34a434cfa5347f50def4">lastqueue</a>;
<a name="l00630"></a><a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">00630</a>    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *<a class="code" href="structmember.html">member</a>;
<a name="l00631"></a>00631 };
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 
<a name="l00634"></a><a class="code" href="structqueue__ent.html">00634</a> <span class="keyword">struct </span><a class="code" href="structqueue__ent.html">queue_ent</a> {
<a name="l00635"></a><a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">00635</a>    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>;             <span class="comment">/*!&lt; What queue is our parent */</span>
<a name="l00636"></a><a class="code" href="structqueue__ent.html#a0f66f061490edf209d9ff6e2f18be109">00636</a>    <span class="keywordtype">char</span> <a class="code" href="structqueue__ent.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>[80];                          <span class="comment">/*!&lt; Name of musiconhold to be used */</span>
<a name="l00637"></a><a class="code" href="structqueue__ent.html#a6b2f794058fc666c44aa8ea1c055c34a">00637</a>    <span class="keywordtype">char</span> <a class="code" href="structqueue__ent.html#a6b2f794058fc666c44aa8ea1c055c34a">announce</a>[80];                     <span class="comment">/*!&lt; Announcement to play for member when call is answered */</span>
<a name="l00638"></a><a class="code" href="structqueue__ent.html#ac25ea00ee3f082df06e0cf468cbde240">00638</a>    <span class="keywordtype">char</span> <a class="code" href="structqueue__ent.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>];         <span class="comment">/*!&lt; Context when user exits queue */</span>
<a name="l00639"></a><a class="code" href="structqueue__ent.html#a03f45477f89c1c873bd0ce9b508901ca">00639</a>    <span class="keywordtype">char</span> <a class="code" href="structqueue__ent.html#a03f45477f89c1c873bd0ce9b508901ca">digits</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];        <span class="comment">/*!&lt; Digits entered while in queue */</span>
<a name="l00640"></a><a class="code" href="structqueue__ent.html#a12851de4518c71edbf5c5adb40976629">00640</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a12851de4518c71edbf5c5adb40976629">valid_digits</a>;                      <span class="comment">/*!&lt; Digits entered correspond to valid extension. Exited */</span>
<a name="l00641"></a><a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">00641</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>;                               <span class="comment">/*!&lt; Where we are in the queue */</span>
<a name="l00642"></a><a class="code" href="structqueue__ent.html#a6f8e491cf1d80eb127fe0c10ebbfc659">00642</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a6f8e491cf1d80eb127fe0c10ebbfc659">prio</a>;                              <span class="comment">/*!&lt; Our priority */</span>
<a name="l00643"></a><a class="code" href="structqueue__ent.html#ac019537a959f6147cecffb126bb04381">00643</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#ac019537a959f6147cecffb126bb04381">last_pos_said</a>;                     <span class="comment">/*!&lt; Last position we told the user */</span>
<a name="l00644"></a><a class="code" href="structqueue__ent.html#a26f62e545090b51f4c7e8efbf2db8d6b">00644</a>    time_t <a class="code" href="structqueue__ent.html#a26f62e545090b51f4c7e8efbf2db8d6b">last_periodic_announce_time</a>;    <span class="comment">/*!&lt; The last time we played a periodic announcement */</span>
<a name="l00645"></a><a class="code" href="structqueue__ent.html#ac49f311625f4ec75469d1af3e7505a4b">00645</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#ac49f311625f4ec75469d1af3e7505a4b">last_periodic_announce_sound</a>;      <span class="comment">/*!&lt; The last periodic announcement we made */</span>
<a name="l00646"></a><a class="code" href="structqueue__ent.html#a1f8971bc7f04d9152056ed8aa4f36ef6">00646</a>    time_t <a class="code" href="structqueue__ent.html#a1f8971bc7f04d9152056ed8aa4f36ef6">last_pos</a>;                       <span class="comment">/*!&lt; Last time we told the user their position */</span>
<a name="l00647"></a><a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">00647</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>;                              <span class="comment">/*!&lt; Where we started in the queue */</span>
<a name="l00648"></a><a class="code" href="structqueue__ent.html#ab234be20f2e48f4f08d2d2c071b8ff55">00648</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#ab234be20f2e48f4f08d2d2c071b8ff55">handled</a>;                           <span class="comment">/*!&lt; Whether our call was handled */</span>
<a name="l00649"></a><a class="code" href="structqueue__ent.html#a79ec26d453dcd29aec17f5536233e849">00649</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a79ec26d453dcd29aec17f5536233e849">pending</a>;                           <span class="comment">/*!&lt; Non-zero if we are attempting to call a member */</span>
<a name="l00650"></a><a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">00650</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a>;                       <span class="comment">/*!&lt; Limit the members that can take this call to this penalty or lower */</span>
<a name="l00651"></a><a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">00651</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a>;                       <span class="comment">/*!&lt; Limit the members that can take this call to this penalty or higher */</span>
<a name="l00652"></a><a class="code" href="structqueue__ent.html#a51db7b9d0e86f2188b541b3d68459930">00652</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a51db7b9d0e86f2188b541b3d68459930">linpos</a>;                            <span class="comment">/*!&lt; If using linear strategy, what position are we at? */</span>
<a name="l00653"></a><a class="code" href="structqueue__ent.html#ab552667d2252975f206fb8a8af49888a">00653</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#ab552667d2252975f206fb8a8af49888a">linwrapped</a>;                        <span class="comment">/*!&lt; Is the linpos wrapped? */</span>
<a name="l00654"></a><a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">00654</a>    time_t <a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;                          <span class="comment">/*!&lt; When we started holding */</span>
<a name="l00655"></a><a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">00655</a>    time_t <a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a>;                         <span class="comment">/*!&lt; When this entry should expire (time out of queue) */</span>
<a name="l00656"></a><a class="code" href="structqueue__ent.html#a9edbd6d881ea6dd2b0b4d78c11723517">00656</a>    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a9edbd6d881ea6dd2b0b4d78c11723517">cancel_answered_elsewhere</a>;          <span class="comment">/*!&lt; Whether we should force the CAE flag on this call (C) option*/</span>
<a name="l00657"></a><a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">00657</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;              <span class="comment">/*!&lt; Our channel */</span>
<a name="l00658"></a>00658    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(,<a class="code" href="structpenalty__rule.html">penalty_rule</a>) qe_rules; <span class="comment">/*!&lt; Local copy of the queue&apos;s penalty rules */</span>
<a name="l00659"></a>00659    struct <a class="code" href="structpenalty__rule.html">penalty_rule</a> *pr;               <span class="comment">/*!&lt; Pointer to the next penalty rule to implement */</span>
<a name="l00660"></a>00660    struct <a class="code" href="structqueue__ent.html">queue_ent</a> *next;                <span class="comment">/*!&lt; The next queue entry */</span>
<a name="l00661"></a>00661 };
<a name="l00662"></a>00662 
<a name="l00663"></a><a class="code" href="structmember.html">00663</a> struct <a class="code" href="structmember.html">member</a> {
<a name="l00664"></a><a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">00664</a>    <span class="keywordtype">char</span> interface[80];                 <span class="comment">/*!&lt; Technology/Location to dial to reach this member*/</span>
<a name="l00665"></a><a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">00665</a>    <span class="keywordtype">char</span> state_interface[80];           <span class="comment">/*!&lt; Technology/Location from which to read devicestate changes */</span>
<a name="l00666"></a><a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">00666</a>    <span class="keywordtype">char</span> membername[80];                <span class="comment">/*!&lt; Member name to use in queue logs */</span>
<a name="l00667"></a><a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">00667</a>    <span class="keywordtype">int</span> penalty;                        <span class="comment">/*!&lt; Are we a last resort? */</span>
<a name="l00668"></a><a class="code" href="structmember.html#a5f1c773ac1d2f42241d25d73373885ab">00668</a>    <span class="keywordtype">int</span> calls;                          <span class="comment">/*!&lt; Number of calls serviced by this member */</span>
<a name="l00669"></a><a class="code" href="structmember.html#a44690a0a629211d7620ce0d55c412e9d">00669</a>    <span class="keywordtype">int</span> dynamic;                        <span class="comment">/*!&lt; Are we dynamically added? */</span>
<a name="l00670"></a><a class="code" href="structmember.html#aac1ae37fa4007496a50df75cf1f698c1">00670</a>    <span class="keywordtype">int</span> realtime;                       <span class="comment">/*!&lt; Is this member realtime? */</span>
<a name="l00671"></a><a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">00671</a>    <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>;                         <span class="comment">/*!&lt; Status of queue member */</span>
<a name="l00672"></a><a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">00672</a>    <span class="keywordtype">int</span> paused;                         <span class="comment">/*!&lt; Are we paused (not accepting calls)? */</span>
<a name="l00673"></a><a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">00673</a>    time_t lastcall;                    <span class="comment">/*!&lt; When last successful call was hungup */</span>
<a name="l00674"></a><a class="code" href="structmember.html#ad666640d5cfd34a434cfa5347f50def4">00674</a>    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *lastqueue;     <span class="comment">/*!&lt; Last queue we received a call */</span>
<a name="l00675"></a><a class="code" href="structmember.html#a1d67f434933f43ad9deb32da61dda2b6">00675</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structcall__queue.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a>:1;                <span class="comment">/*!&lt; Used to detect members deleted in realtime */</span>
<a name="l00676"></a><a class="code" href="structmember.html#a22ed1f20028b26f7ece35aeec695293f">00676</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> delme:1;               <span class="comment">/*!&lt; Flag to delete entry on reload */</span>
<a name="l00677"></a><a class="code" href="structmember.html#a5a242f61697cefa27ec3ce5082e2cd23">00677</a>    <span class="keywordtype">char</span> rt_uniqueid[80];               <span class="comment">/*!&lt; Unique id of realtime member entry */</span>
<a name="l00678"></a>00678 };
<a name="l00679"></a>00679 
<a name="l00680"></a><a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6">00680</a> <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6">empty_conditions</a> {
<a name="l00681"></a><a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a54be9f0e166d88bc3d740221060f14e4">00681</a>    <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a54be9f0e166d88bc3d740221060f14e4">QUEUE_EMPTY_PENALTY</a> = (1 &lt;&lt; 0),
<a name="l00682"></a><a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6af68e289850cc046b29075b71cc9b2d2c">00682</a>    <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6af68e289850cc046b29075b71cc9b2d2c">QUEUE_EMPTY_PAUSED</a> = (1 &lt;&lt; 1),
<a name="l00683"></a><a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a85b9e406efa42c21f44d6f5b3ae9b332">00683</a>    <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a85b9e406efa42c21f44d6f5b3ae9b332">QUEUE_EMPTY_INUSE</a> = (1 &lt;&lt; 2),
<a name="l00684"></a><a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a6dd24d66d8fcdf0a3444d28ec9c82ba2">00684</a>    <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a6dd24d66d8fcdf0a3444d28ec9c82ba2">QUEUE_EMPTY_RINGING</a> = (1 &lt;&lt; 3),
<a name="l00685"></a><a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6adfcf6310d20a8088a392ea40fa381e09">00685</a>    <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6adfcf6310d20a8088a392ea40fa381e09">QUEUE_EMPTY_UNAVAILABLE</a> = (1 &lt;&lt; 4),
<a name="l00686"></a><a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a1043fcafb4c428c3dfe5a3253485d7af">00686</a>    <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a1043fcafb4c428c3dfe5a3253485d7af">QUEUE_EMPTY_INVALID</a> = (1 &lt;&lt; 5),
<a name="l00687"></a><a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a1532fb860aed655673cca9f18f44a7d1">00687</a>    <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a1532fb860aed655673cca9f18f44a7d1">QUEUE_EMPTY_UNKNOWN</a> = (1 &lt;&lt; 6),
<a name="l00688"></a><a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6aec193cf33d944aed4807b36eefdbc1d1">00688</a>    <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6aec193cf33d944aed4807b36eefdbc1d1">QUEUE_EMPTY_WRAPUP</a> = (1 &lt;&lt; 7),
<a name="l00689"></a>00689 };
<a name="l00690"></a>00690 
<a name="l00691"></a>00691 <span class="comment">/* values used in multi-bit flags in call_queue */</span>
<a name="l00692"></a><a class="code" href="app__queue_8c.html#a8e57e0916b189a3a78e018cc14e8cb1b">00692</a> <span class="preprocessor">#define ANNOUNCEHOLDTIME_ALWAYS 1</span>
<a name="l00693"></a><a class="code" href="app__queue_8c.html#ab37e1a4dafc93b1ded1edabe9927cf26">00693</a> <span class="preprocessor"></span><span class="preprocessor">#define ANNOUNCEHOLDTIME_ONCE 2</span>
<a name="l00694"></a><a class="code" href="app__queue_8c.html#a533ee4344c442cf6da3e610598ecca75">00694</a> <span class="preprocessor"></span><span class="preprocessor">#define QUEUE_EVENT_VARIABLES 3</span>
<a name="l00695"></a>00695 <span class="preprocessor"></span>
<a name="l00696"></a><a class="code" href="structpenalty__rule.html">00696</a> <span class="keyword">struct </span><a class="code" href="structpenalty__rule.html">penalty_rule</a> {
<a name="l00697"></a><a class="code" href="structpenalty__rule.html#a42715f65f02da52edc5b22021d8ae670">00697</a>    <span class="keywordtype">int</span> time;                           <span class="comment">/*!&lt; Number of seconds that need to pass before applying this rule */</span>
<a name="l00698"></a><a class="code" href="structpenalty__rule.html#aff3c96df7d67617d6ee82fa1f257ff84">00698</a>    <span class="keywordtype">int</span> max_value;                      <span class="comment">/*!&lt; The amount specified in the penalty rule for max penalty */</span>
<a name="l00699"></a><a class="code" href="structpenalty__rule.html#a2b15eec5f0109b01f534046bb5c04666">00699</a>    <span class="keywordtype">int</span> min_value;                      <span class="comment">/*!&lt; The amount specified in the penalty rule for min penalty */</span>
<a name="l00700"></a><a class="code" href="structpenalty__rule.html#ae0778c688a39dcc28198f568176370eb">00700</a>    <span class="keywordtype">int</span> max_relative;                   <span class="comment">/*!&lt; Is the max adjustment relative? 1 for relative, 0 for absolute */</span>
<a name="l00701"></a><a class="code" href="structpenalty__rule.html#a790961d8e38a4dbcdd59e8c2b0a292b4">00701</a>    <span class="keywordtype">int</span> min_relative;                   <span class="comment">/*!&lt; Is the min adjustment relative? 1 for relative, 0 for absolute */</span>
<a name="l00702"></a>00702    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structpenalty__rule.html">penalty_rule</a>) list;  <span class="comment">/*!&lt; Next penalty_rule */</span>
<a name="l00703"></a>00703 };
<a name="l00704"></a>00704 
<a name="l00705"></a><a class="code" href="app__queue_8c.html#ae19c02c3c0ba9ca01d7ede746f736c45">00705</a> <span class="preprocessor">#define ANNOUNCEPOSITION_YES 1 </span><span class="comment">/*!&lt; We announce position */</span>
<a name="l00706"></a><a class="code" href="app__queue_8c.html#a52464c2ddf292a0a9c91cfc7481b0178">00706</a> <span class="preprocessor">#define ANNOUNCEPOSITION_NO 2 </span><span class="comment">/*!&lt; We don&apos;t announce position */</span>
<a name="l00707"></a><a class="code" href="app__queue_8c.html#a183dcea5fd32422d981d4705cd770b15">00707</a> <span class="preprocessor">#define ANNOUNCEPOSITION_MORE_THAN 3 </span><span class="comment">/*!&lt; We say &quot;Currently there are more than &lt;limit&gt;&quot; */</span>
<a name="l00708"></a><a class="code" href="app__queue_8c.html#a967650811eabe6b6373dddc731a286eb">00708</a> <span class="preprocessor">#define ANNOUNCEPOSITION_LIMIT 4 </span><span class="comment">/*!&lt; We not announce position more than &lt;limit&gt; */</span>
<a name="l00709"></a>00709 
<a name="l00710"></a><a class="code" href="structcall__queue.html">00710</a> <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> {
<a name="l00711"></a>00711    <a class="code" href="stringfields_8h.html#a061580e89c55282a7140fa3fdfd52b6d" title="Declare the fields needed in a structure.">AST_DECLARE_STRING_FIELDS</a>(<span class="comment"></span>
<a name="l00712"></a>00712 <span class="comment">      /*! Queue name */</span>
<a name="l00713"></a>00713       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);<span class="comment"></span>
<a name="l00714"></a>00714 <span class="comment">      /*! Music on Hold class */</span>
<a name="l00715"></a>00715       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="structqueue__ent.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>);<span class="comment"></span>
<a name="l00716"></a>00716 <span class="comment">      /*! Announcement to play when call is answered */</span>
<a name="l00717"></a>00717       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="structqueue__ent.html#a6b2f794058fc666c44aa8ea1c055c34a">announce</a>);<span class="comment"></span>
<a name="l00718"></a>00718 <span class="comment">      /*! Exit context */</span>
<a name="l00719"></a>00719       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="structqueue__ent.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);<span class="comment"></span>
<a name="l00720"></a>00720 <span class="comment">      /*! Macro to run upon member connection */</span>
<a name="l00721"></a>00721       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(membermacro);<span class="comment"></span>
<a name="l00722"></a>00722 <span class="comment">      /*! Gosub to run upon member connection */</span>
<a name="l00723"></a>00723       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(membergosub);<span class="comment"></span>
<a name="l00724"></a>00724 <span class="comment">      /*! Default rule to use if none specified in call to Queue() */</span>
<a name="l00725"></a>00725       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(defaultrule);<span class="comment"></span>
<a name="l00726"></a>00726 <span class="comment">      /*! Sound file: &quot;Your call is now first in line&quot; (def. queue-youarenext) */</span>
<a name="l00727"></a>00727       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(sound_next);<span class="comment"></span>
<a name="l00728"></a>00728 <span class="comment">      /*! Sound file: &quot;There are currently&quot; (def. queue-thereare) */</span>
<a name="l00729"></a>00729       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(sound_thereare);<span class="comment"></span>
<a name="l00730"></a>00730 <span class="comment">      /*! Sound file: &quot;calls waiting to speak to a representative.&quot; (def. queue-callswaiting) */</span>
<a name="l00731"></a>00731       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(sound_calls);<span class="comment"></span>
<a name="l00732"></a>00732 <span class="comment">      /*! Sound file: &quot;Currently there are more than&quot; (def. queue-quantity1) */</span>
<a name="l00733"></a>00733       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(queue_quantity1);<span class="comment"></span>
<a name="l00734"></a>00734 <span class="comment">      /*! Sound file: &quot;callers waiting to speak with a representative&quot; (def. queue-quantity2) */</span>
<a name="l00735"></a>00735       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(queue_quantity2);<span class="comment"></span>
<a name="l00736"></a>00736 <span class="comment">      /*! Sound file: &quot;The current estimated total holdtime is&quot; (def. queue-holdtime) */</span>
<a name="l00737"></a>00737       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(sound_holdtime);<span class="comment"></span>
<a name="l00738"></a>00738 <span class="comment">      /*! Sound file: &quot;minutes.&quot; (def. queue-minutes) */</span>
<a name="l00739"></a>00739       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(sound_minutes);<span class="comment"></span>
<a name="l00740"></a>00740 <span class="comment">      /*! Sound file: &quot;minute.&quot; (def. queue-minute) */</span>
<a name="l00741"></a>00741       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(sound_minute);<span class="comment"></span>
<a name="l00742"></a>00742 <span class="comment">      /*! Sound file: &quot;seconds.&quot; (def. queue-seconds) */</span>
<a name="l00743"></a>00743       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(sound_seconds);<span class="comment"></span>
<a name="l00744"></a>00744 <span class="comment">      /*! Sound file: &quot;Thank you for your patience.&quot; (def. queue-thankyou) */</span>
<a name="l00745"></a>00745       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(sound_thanks);<span class="comment"></span>
<a name="l00746"></a>00746 <span class="comment">      /*! Sound file: Custom announce for caller, no default */</span>
<a name="l00747"></a>00747       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(sound_callerannounce);<span class="comment"></span>
<a name="l00748"></a>00748 <span class="comment">      /*! Sound file: &quot;Hold time&quot; (def. queue-reporthold) */</span>
<a name="l00749"></a>00749       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(sound_reporthold);
<a name="l00750"></a>00750    );<span class="comment"></span>
<a name="l00751"></a>00751 <span class="comment">   /*! Sound files: Custom announce, no default */</span>
<a name="l00752"></a><a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">00752</a>    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sound_periodicannounce[<a class="code" href="app__queue_8c.html#a2f5d1f6fb6cd3af5e8b07d19e4ab273a">MAX_PERIODIC_ANNOUNCEMENTS</a>];
<a name="l00753"></a><a class="code" href="structcall__queue.html#a1d67f434933f43ad9deb32da61dda2b6">00753</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dead:1;
<a name="l00754"></a><a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">00754</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> eventwhencalled:2;
<a name="l00755"></a><a class="code" href="structcall__queue.html#a88ec6754dea8cb6d040f61a279b1c298">00755</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ringinuse:1;
<a name="l00756"></a><a class="code" href="structcall__queue.html#a0c5bcd98bca1c3085183ba1fc80195ed">00756</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> setinterfacevar:1;
<a name="l00757"></a><a class="code" href="structcall__queue.html#a32794c302b9a60821d519f6d4d1e7885">00757</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> setqueuevar:1;
<a name="l00758"></a><a class="code" href="structcall__queue.html#a23486e86a21295aa734885d335ae9c2f">00758</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> setqueueentryvar:1;
<a name="l00759"></a><a class="code" href="structcall__queue.html#a20ba21c586c791a31ef97102b4811a8f">00759</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> reportholdtime:1;
<a name="l00760"></a><a class="code" href="structcall__queue.html#ac3419e9b31cb1aebe3666439449bcecc">00760</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> wrapped:1;
<a name="l00761"></a><a class="code" href="structcall__queue.html#a24cf7a74d65e1d4f4b9bfd16455187fb">00761</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timeoutrestart:1;
<a name="l00762"></a><a class="code" href="structcall__queue.html#a1b9572151ecc081254a026796ef65d33">00762</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> announceholdtime:2;
<a name="l00763"></a><a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">00763</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> announceposition:3;
<a name="l00764"></a><a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">00764</a>    <span class="keywordtype">int</span> <a class="code" href="structstrategy.html">strategy</a>:4;
<a name="l00765"></a><a class="code" href="structcall__queue.html#a1cea13bb2b7ec038aa54d2c1f50ffc75">00765</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maskmemberstatus:1;
<a name="l00766"></a><a class="code" href="structcall__queue.html#a53e750a536c8270e37bbdd35a9def3d4">00766</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> realtime:1;
<a name="l00767"></a><a class="code" href="structcall__queue.html#a7dbc8370e15350314b041aad17f96706">00767</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> found:1;
<a name="l00768"></a><a class="code" href="structcall__queue.html#ab95f2fa73d00493b2fa1fc26eb37dc24">00768</a>    <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6">empty_conditions</a> joinempty;
<a name="l00769"></a><a class="code" href="structcall__queue.html#a77bab4023f1969460cc9c64baa39e016">00769</a>    <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6">empty_conditions</a> leavewhenempty;
<a name="l00770"></a><a class="code" href="structcall__queue.html#a336eac6939e5ebd50b2871148243dee6">00770</a>    <span class="keywordtype">int</span> announcepositionlimit;          <span class="comment">/*!&lt; How many positions we announce? */</span>
<a name="l00771"></a><a class="code" href="structcall__queue.html#a158e72e504d11a5f6cdfa8d25343adbb">00771</a>    <span class="keywordtype">int</span> announcefrequency;              <span class="comment">/*!&lt; How often to announce their position */</span>
<a name="l00772"></a><a class="code" href="structcall__queue.html#a7724cd5a7395de6d0cbc7f0a02b0c20a">00772</a>    <span class="keywordtype">int</span> minannouncefrequency;           <span class="comment">/*!&lt; The minimum number of seconds between position announcements (def. 15) */</span>
<a name="l00773"></a><a class="code" href="structcall__queue.html#a2a43a68cf8add918260068d677434132">00773</a>    <span class="keywordtype">int</span> periodicannouncefrequency;      <span class="comment">/*!&lt; How often to play periodic announcement */</span>
<a name="l00774"></a><a class="code" href="structcall__queue.html#a8e2c16675bb0afd19ebeabbcd4329681">00774</a>    <span class="keywordtype">int</span> numperiodicannounce;            <span class="comment">/*!&lt; The number of periodic announcements configured */</span>
<a name="l00775"></a><a class="code" href="structcall__queue.html#a3991228a9e7540246c6cc4cf42c0794d">00775</a>    <span class="keywordtype">int</span> randomperiodicannounce;         <span class="comment">/*!&lt; Are periodic announcments randomly chosen */</span>
<a name="l00776"></a><a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">00776</a>    <span class="keywordtype">int</span> roundingseconds;                <span class="comment">/*!&lt; How many seconds do we round to? */</span>
<a name="l00777"></a><a class="code" href="structcall__queue.html#aebac91dc9bbd110e44f8ffa9f2e697d1">00777</a>    <span class="keywordtype">int</span> holdtime;                       <span class="comment">/*!&lt; Current avg holdtime, based on an exponential average */</span>
<a name="l00778"></a><a class="code" href="structcall__queue.html#a080da53416fe93b51940797285eeee5c">00778</a>    <span class="keywordtype">int</span> talktime;                       <span class="comment">/*!&lt; Current avg talktime, based on the same exponential average */</span>
<a name="l00779"></a><a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">00779</a>    <span class="keywordtype">int</span> callscompleted;                 <span class="comment">/*!&lt; Number of queue calls completed */</span>
<a name="l00780"></a><a class="code" href="structcall__queue.html#a8c3a63527e11cef32f7e5aae9f3f270f">00780</a>    <span class="keywordtype">int</span> callsabandoned;                 <span class="comment">/*!&lt; Number of queue calls abandoned */</span>
<a name="l00781"></a><a class="code" href="structcall__queue.html#a6293d1622ff45ccac3a1679171376856">00781</a>    <span class="keywordtype">int</span> servicelevel;                   <span class="comment">/*!&lt; seconds setting for servicelevel*/</span>
<a name="l00782"></a><a class="code" href="structcall__queue.html#ad22c84b7016cae07c521dda4a74544f8">00782</a>    <span class="keywordtype">int</span> callscompletedinsl;             <span class="comment">/*!&lt; Number of calls answered with servicelevel*/</span>
<a name="l00783"></a><a class="code" href="structcall__queue.html#ab76c064ab44a836302512ee2adbb297e">00783</a>    <span class="keywordtype">char</span> monfmt[8];                     <span class="comment">/*!&lt; Format to use when recording calls */</span>
<a name="l00784"></a><a class="code" href="structcall__queue.html#a7ccaa047c703f95f5eaf0dd0a10670b5">00784</a>    <span class="keywordtype">int</span> montype;                        <span class="comment">/*!&lt; Monitor type  Monitor vs. MixMonitor */</span>
<a name="l00785"></a><a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">00785</a>    <span class="keywordtype">int</span> count;                          <span class="comment">/*!&lt; How many entries */</span>
<a name="l00786"></a><a class="code" href="structcall__queue.html#a245b5bee0d02a20222d815dbeaaac0fb">00786</a>    <span class="keywordtype">int</span> maxlen;                         <span class="comment">/*!&lt; Max number of entries */</span>
<a name="l00787"></a><a class="code" href="structcall__queue.html#a9298f7c0bf15cf275f4664d6959a6da6">00787</a>    <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a>;                     <span class="comment">/*!&lt; Wrapup Time */</span>
<a name="l00788"></a>00788 
<a name="l00789"></a><a class="code" href="structcall__queue.html#addf2eb79daee1e400c823a699b0f856b">00789</a>    <span class="keywordtype">int</span> retry;                          <span class="comment">/*!&lt; Retry calling everyone after this amount of time */</span>
<a name="l00790"></a><a class="code" href="structcall__queue.html#a493b57f443cc38b3d3df9c1e584d9d82">00790</a>    <span class="keywordtype">int</span> timeout;                        <span class="comment">/*!&lt; How long to wait for an answer */</span>
<a name="l00791"></a><a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">00791</a>    <span class="keywordtype">int</span> weight;                         <span class="comment">/*!&lt; Respective weight */</span>
<a name="l00792"></a><a class="code" href="structcall__queue.html#a4092d0238a0a8aa7aeaf503a7f0e6380">00792</a>    <span class="keywordtype">int</span> autopause;                      <span class="comment">/*!&lt; Auto pause queue members if they fail to answer */</span>
<a name="l00793"></a><a class="code" href="structcall__queue.html#af983858a2192f96c9a30e44467b87f61">00793</a>    <span class="keywordtype">int</span> timeoutpriority;                <span class="comment">/*!&lt; Do we allow a fraction of the timeout to occur for a ring? */</span>
<a name="l00794"></a>00794 
<a name="l00795"></a>00795    <span class="comment">/* Queue strategy things */</span>
<a name="l00796"></a><a class="code" href="structcall__queue.html#a0a7a994a2db49ad4569bfd6db242247b">00796</a>    <span class="keywordtype">int</span> rrpos;                          <span class="comment">/*!&lt; Round Robin - position */</span>
<a name="l00797"></a><a class="code" href="structcall__queue.html#adc032ac2dcea31bd708fc762f42c385e">00797</a>    <span class="keywordtype">int</span> memberdelay;                    <span class="comment">/*!&lt; Seconds to delay connecting member to caller */</span>
<a name="l00798"></a><a class="code" href="structcall__queue.html#a76e20f3c9df399ad87bb4e45c7419e99">00798</a>    <span class="keywordtype">int</span> autofill;                       <span class="comment">/*!&lt; Ignore the head call status and ring an available agent */</span>
<a name="l00799"></a>00799    
<a name="l00800"></a><a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">00800</a>    <span class="keyword">struct </span><a class="code" href="structao2__container.html">ao2_container</a> *members;             <span class="comment">/*!&lt; Head of the list of members */</span><span class="comment"></span>
<a name="l00801"></a>00801 <span class="comment">   /*! </span>
<a name="l00802"></a>00802 <span class="comment">    * \brief Number of members _logged in_</span>
<a name="l00803"></a>00803 <span class="comment">    * \note There will be members in the members container that are not logged</span>
<a name="l00804"></a>00804 <span class="comment">    *       in, so this can not simply be replaced with ao2_container_count(). </span>
<a name="l00805"></a>00805 <span class="comment">    */</span>
<a name="l00806"></a><a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f">00806</a>    <span class="keywordtype">int</span> membercount;
<a name="l00807"></a><a class="code" href="structcall__queue.html#a4cee904f94736300a8eba28cc5763bed">00807</a>    <span class="keyword">struct </span><a class="code" href="structqueue__ent.html">queue_ent</a> *head;             <span class="comment">/*!&lt; Head of the list of callers */</span>
<a name="l00808"></a>00808    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structcall__queue.html">call_queue</a>) list;    <span class="comment">/*!&lt; Next call queue */</span>
<a name="l00809"></a>00809    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structpenalty__rule.html">penalty_rule</a>) rules; <span class="comment">/*!&lt; The list of penalty rules to invoke */</span>
<a name="l00810"></a>00810 };
<a name="l00811"></a>00811 
<a name="l00812"></a><a class="code" href="structrule__list.html">00812</a> struct <a class="code" href="structrule__list.html">rule_list</a> {
<a name="l00813"></a><a class="code" href="structrule__list.html#a3777dbae63a15da001b2baa317a25149">00813</a>    <span class="keywordtype">char</span> <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>[80];
<a name="l00814"></a>00814    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(,<a class="code" href="structpenalty__rule.html">penalty_rule</a>) rules;
<a name="l00815"></a>00815    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(rule_list) list;
<a name="l00816"></a>00816 };
<a name="l00817"></a>00817 
<a name="l00818"></a>00818 <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(rule_lists, rule_list);
<a name="l00819"></a>00819 
<a name="l00820"></a><a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">00820</a> static struct <a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>;
<a name="l00821"></a>00821 
<a name="l00822"></a>00822 static <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#ad4d94a7a9e04ddf7984d69a8737221f9">update_realtime_members</a>(struct <a class="code" href="structcall__queue.html">call_queue</a> *q);
<a name="l00823"></a>00823 static <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a5d60239f838c9f941528fb426bcd2290">set_member_paused</a>(const <span class="keywordtype">char</span> *queuename, const <span class="keywordtype">char</span> *interface, const <span class="keywordtype">char</span> *reason, <span class="keywordtype">int</span> paused);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825 static <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a480e30e7b4e274a8165f678902b96b3a" title="Log an attended transfer when a queue caller channel is masqueraded.">queue_transfer_fixup</a>(<span class="keywordtype">void</span> *data, struct <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *old_chan, struct <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *new_chan); <span class="comment"></span>
<a name="l00826"></a>00826 <span class="comment">/*! \brief sets the QUEUESTATUS channel variable */</span>
<a name="l00827"></a><a class="code" href="app__queue_8c.html#a30fd2efd3517fe2537656bdd18a09c6f">00827</a> static <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a30fd2efd3517fe2537656bdd18a09c6f" title="sets the QUEUESTATUS channel variable">set_queue_result</a>(struct <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, enum <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2">queue_result</a> res)
<a name="l00828"></a>00828 {
<a name="l00829"></a>00829    <span class="keywordtype">int</span> i;
<a name="l00830"></a>00830 
<a name="l00831"></a>00831    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="app__queue_8c.html#a7985366bd7e04a1efe3363de28a60c63">queue_results</a>); i++) {
<a name="l00832"></a>00832       <span class="keywordflow">if</span> (<a class="code" href="app__queue_8c.html#a7985366bd7e04a1efe3363de28a60c63">queue_results</a>[i].<span class="keywordtype">id</span> == res) {
<a name="l00833"></a>00833          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;QUEUESTATUS&quot;</span>, <a class="code" href="app__queue_8c.html#a7985366bd7e04a1efe3363de28a60c63">queue_results</a>[i].<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>);
<a name="l00834"></a>00834          <span class="keywordflow">return</span>;
<a name="l00835"></a>00835       }
<a name="l00836"></a>00836    }
<a name="l00837"></a>00837 }
<a name="l00838"></a>00838 
<a name="l00839"></a><a class="code" href="app__queue_8c.html#a792b5d8a5231db2f05b08bd73d318ea5">00839</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a792b5d8a5231db2f05b08bd73d318ea5">int2strat</a>(<span class="keywordtype">int</span> <a class="code" href="structstrategy.html">strategy</a>)
<a name="l00840"></a>00840 {
<a name="l00841"></a>00841    <span class="keywordtype">int</span> x;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="app__queue_8c.html#a289169164125785d433a7e5c2c572052">strategies</a>); x++) {
<a name="l00844"></a>00844       <span class="keywordflow">if</span> (strategy == <a class="code" href="app__queue_8c.html#a289169164125785d433a7e5c2c572052">strategies</a>[x].strategy)
<a name="l00845"></a>00845          <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#a289169164125785d433a7e5c2c572052">strategies</a>[x].<a class="code" href="structstrategy.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;
<a name="l00846"></a>00846    }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>;
<a name="l00849"></a>00849 }
<a name="l00850"></a>00850 
<a name="l00851"></a><a class="code" href="app__queue_8c.html#aeee3b4385050286dedc0e20f247d428c">00851</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#aeee3b4385050286dedc0e20f247d428c">strat2int</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structstrategy.html">strategy</a>)
<a name="l00852"></a>00852 {
<a name="l00853"></a>00853    <span class="keywordtype">int</span> x;
<a name="l00854"></a>00854 
<a name="l00855"></a>00855    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="app__queue_8c.html#a289169164125785d433a7e5c2c572052">strategies</a>); x++) {
<a name="l00856"></a>00856       <span class="keywordflow">if</span> (!strcasecmp(strategy, <a class="code" href="app__queue_8c.html#a289169164125785d433a7e5c2c572052">strategies</a>[x].name))
<a name="l00857"></a>00857          <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#a289169164125785d433a7e5c2c572052">strategies</a>[x].strategy;
<a name="l00858"></a>00858    }
<a name="l00859"></a>00859 
<a name="l00860"></a>00860    <span class="keywordflow">return</span> -1;
<a name="l00861"></a>00861 }
<a name="l00862"></a>00862 
<a name="l00863"></a><a class="code" href="app__queue_8c.html#a9f81db529b7d97134601164c43a945f2">00863</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a9f81db529b7d97134601164c43a945f2">queue_hash_cb</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> flags)
<a name="l00864"></a>00864 {
<a name="l00865"></a>00865    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q = obj;
<a name="l00866"></a>00866 
<a name="l00867"></a>00867    <span class="keywordflow">return</span> <a class="code" href="strings_8h.html#ab08f8db2a7258e538a0da7417f58db58" title="Compute a hash value on a case-insensitive string.">ast_str_case_hash</a>(q-&gt;name);
<a name="l00868"></a>00868 }
<a name="l00869"></a>00869 
<a name="l00870"></a><a class="code" href="app__queue_8c.html#a9a488aa902d38d97f26bbfbb59a22e2b">00870</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a9a488aa902d38d97f26bbfbb59a22e2b">queue_cmp_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l00871"></a>00871 {
<a name="l00872"></a>00872    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q = obj, *q2 = arg;
<a name="l00873"></a>00873    <span class="keywordflow">return</span> !strcasecmp(q-&gt;name, q2-&gt;name) ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a> : 0;
<a name="l00874"></a>00874 }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876 <span class="preprocessor">#ifdef REF_DEBUG_ONLY_QUEUES</span>
<a name="l00877"></a>00877 <span class="preprocessor"></span><span class="preprocessor">#define queue_ref(a) __ao2_ref_debug(a,1,&quot;&quot;,__FILE__,__LINE__,__PRETTY_FUNCTION__)</span>
<a name="l00878"></a>00878 <span class="preprocessor"></span><span class="preprocessor">#define queue_unref(a)  __ao2_ref_debug(a,-1,&quot;&quot;,__FILE__,__LINE__,__PRETTY_FUNCTION__)</span>
<a name="l00879"></a>00879 <span class="preprocessor"></span><span class="preprocessor">#define queue_t_ref(a,b)   __ao2_ref_debug(a,1,b,__FILE__,__LINE__,__PRETTY_FUNCTION__)</span>
<a name="l00880"></a>00880 <span class="preprocessor"></span><span class="preprocessor">#define queue_t_unref(a,b) __ao2_ref_debug(a,-1,b,__FILE__,__LINE__,__PRETTY_FUNCTION__)</span>
<a name="l00881"></a>00881 <span class="preprocessor"></span><span class="preprocessor">#define queues_t_link(c,q,tag)   __ao2_link_debug(c,q,tag,__FILE__,__LINE__,__PRETTY_FUNCTION__)</span>
<a name="l00882"></a>00882 <span class="preprocessor"></span><span class="preprocessor">#define queues_t_unlink(c,q,tag) __ao2_unlink_debug(c,q,tag,__FILE__,__LINE__,__PRETTY_FUNCTION__)</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00884"></a><a class="code" href="app__queue_8c.html#a975930eef9239c04b8bb2453bafe0798">00884</a> <span class="preprocessor"></span><span class="preprocessor">#define queue_t_ref(a,b)   queue_ref(a)</span>
<a name="l00885"></a><a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">00885</a> <span class="preprocessor"></span><span class="preprocessor">#define queue_t_unref(a,b) queue_unref(a)</span>
<a name="l00886"></a><a class="code" href="app__queue_8c.html#a6d56dcc1f330ae7fe1b5a1ee832077c1">00886</a> <span class="preprocessor"></span><span class="preprocessor">#define queues_t_link(c,q,tag)   ao2_t_link(c,q,tag)</span>
<a name="l00887"></a><a class="code" href="app__queue_8c.html#a677f1c4c1a61e9e02d180803d8b8a008">00887</a> <span class="preprocessor"></span><span class="preprocessor">#define queues_t_unlink(c,q,tag) ao2_t_unlink(c,q,tag)</span>
<a name="l00888"></a><a class="code" href="app__queue_8c.html#a3674aa0abaec4bbd6f35a8094b118493">00888</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *<a class="code" href="app__queue_8c.html#a3674aa0abaec4bbd6f35a8094b118493">queue_ref</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q)
<a name="l00889"></a>00889 {
<a name="l00890"></a>00890    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(q, 1);
<a name="l00891"></a>00891    <span class="keywordflow">return</span> q;
<a name="l00892"></a>00892 }
<a name="l00893"></a>00893 
<a name="l00894"></a><a class="code" href="app__queue_8c.html#aa4c67d0629622e3bb3d1a8e7104da47e">00894</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *<a class="code" href="app__queue_8c.html#aa4c67d0629622e3bb3d1a8e7104da47e">queue_unref</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q)
<a name="l00895"></a>00895 {
<a name="l00896"></a>00896    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(q, -1);
<a name="l00897"></a>00897    <span class="keywordflow">return</span> q;
<a name="l00898"></a>00898 }
<a name="l00899"></a>00899 <span class="preprocessor">#endif</span>
<a name="l00900"></a>00900 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00901"></a>00901 <span class="comment">/*! \brief Set variables of queue */</span>
<a name="l00902"></a><a class="code" href="app__queue_8c.html#a1248fe33745c5cb9c87db6be0a25d138">00902</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a1248fe33745c5cb9c87db6be0a25d138" title="Set variables of queue.">set_queue_variables</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l00903"></a>00903 {
<a name="l00904"></a>00904    <span class="keywordtype">char</span> interfacevar[256]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00905"></a>00905    <span class="keywordtype">float</span> sl = 0;
<a name="l00906"></a>00906 
<a name="l00907"></a>00907    <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a32794c302b9a60821d519f6d4d1e7885">setqueuevar</a>) {
<a name="l00908"></a>00908       sl = 0;
<a name="l00909"></a>00909       <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a> &gt; 0) 
<a name="l00910"></a>00910          sl = 100 * ((float) q-&gt;<a class="code" href="structcall__queue.html#ad22c84b7016cae07c521dda4a74544f8">callscompletedinsl</a> / (<span class="keywordtype">float</span>) q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a>);
<a name="l00911"></a>00911 
<a name="l00912"></a>00912       snprintf(interfacevar, <span class="keyword">sizeof</span>(interfacevar),
<a name="l00913"></a>00913          <span class="stringliteral">&quot;QUEUENAME=%s,QUEUEMAX=%d,QUEUESTRATEGY=%s,QUEUECALLS=%d,QUEUEHOLDTIME=%d,QUEUETALKTIME=%d,QUEUECOMPLETED=%d,QUEUEABANDONED=%d,QUEUESRVLEVEL=%d,QUEUESRVLEVELPERF=%2.1f&quot;</span>,
<a name="l00914"></a>00914          q-&gt;name, q-&gt;<a class="code" href="structcall__queue.html#a245b5bee0d02a20222d815dbeaaac0fb">maxlen</a>, <a class="code" href="app__queue_8c.html#a792b5d8a5231db2f05b08bd73d318ea5">int2strat</a>(q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a>), q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>, q-&gt;<a class="code" href="structcall__queue.html#aebac91dc9bbd110e44f8ffa9f2e697d1">holdtime</a>, q-&gt;<a class="code" href="structcall__queue.html#a080da53416fe93b51940797285eeee5c">talktime</a>, q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a>, q-&gt;<a class="code" href="structcall__queue.html#a8c3a63527e11cef32f7e5aae9f3f270f">callsabandoned</a>,  q-&gt;<a class="code" href="structcall__queue.html#a6293d1622ff45ccac3a1679171376856">servicelevel</a>, sl);
<a name="l00915"></a>00915    
<a name="l00916"></a>00916       <a class="code" href="pbx_8h.html#a990bfc8582dc017423d8518bcc110a2c" title="Parse and set multiple channel variables, where the pairs are separated by the &amp;#39;...">pbx_builtin_setvar_multiple</a>(chan, interfacevar); 
<a name="l00917"></a>00917    }
<a name="l00918"></a>00918 }
<a name="l00919"></a>00919 <span class="comment"></span>
<a name="l00920"></a>00920 <span class="comment">/*! \brief Insert the &apos;new&apos; entry after the &apos;prev&apos; entry of queue &apos;q&apos; */</span>
<a name="l00921"></a><a class="code" href="app__queue_8c.html#ab2d834859be2c32442d2817935a0e3c7">00921</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#ab2d834859be2c32442d2817935a0e3c7" title="Insert the &amp;#39;new&amp;#39; entry after the &amp;#39;prev&amp;#39; entry of queue &amp;#39;q&amp;#39;...">insert_entry</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q, <span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *prev, <span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *<span class="keyword">new</span>, <span class="keywordtype">int</span> *<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>)
<a name="l00922"></a>00922 {
<a name="l00923"></a>00923    <span class="keyword">struct </span><a class="code" href="structqueue__ent.html">queue_ent</a> *cur;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925    <span class="keywordflow">if</span> (!q || !<span class="keyword">new</span>)
<a name="l00926"></a>00926       <span class="keywordflow">return</span>;
<a name="l00927"></a>00927    <span class="keywordflow">if</span> (prev) {
<a name="l00928"></a>00928       cur = prev-&gt;next;
<a name="l00929"></a>00929       prev-&gt;next = <span class="keyword">new</span>;
<a name="l00930"></a>00930    } <span class="keywordflow">else</span> {
<a name="l00931"></a>00931       cur = q-&gt;<a class="code" href="structcall__queue.html#a4cee904f94736300a8eba28cc5763bed">head</a>;
<a name="l00932"></a>00932       q-&gt;<a class="code" href="structcall__queue.html#a4cee904f94736300a8eba28cc5763bed">head</a> = <span class="keyword">new</span>;
<a name="l00933"></a>00933    }
<a name="l00934"></a>00934    <span class="keyword">new</span>-&gt;next = cur;
<a name="l00935"></a>00935 
<a name="l00936"></a>00936    <span class="comment">/* every queue_ent must have a reference to it&apos;s parent call_queue, this</span>
<a name="l00937"></a>00937 <span class="comment">    * reference does not go away until the end of the queue_ent&apos;s life, meaning</span>
<a name="l00938"></a>00938 <span class="comment">    * that even when the queue_ent leaves the call_queue this ref must remain. */</span>
<a name="l00939"></a>00939    <a class="code" href="app__queue_8c.html#a3674aa0abaec4bbd6f35a8094b118493">queue_ref</a>(q);
<a name="l00940"></a>00940    <span class="keyword">new</span>-&gt;parent = q;
<a name="l00941"></a>00941    <span class="keyword">new</span>-&gt;pos = ++(*pos);
<a name="l00942"></a>00942    <span class="keyword">new</span>-&gt;opos = *pos;
<a name="l00943"></a>00943 }
<a name="l00944"></a>00944 <span class="comment"></span>
<a name="l00945"></a>00945 <span class="comment">/*! \brief Check if members are available</span>
<a name="l00946"></a>00946 <span class="comment"> *</span>
<a name="l00947"></a>00947 <span class="comment"> * This function checks to see if members are available to be called. If any member</span>
<a name="l00948"></a>00948 <span class="comment"> * is available, the function immediately returns 0. If no members are available,</span>
<a name="l00949"></a>00949 <span class="comment"> * then -1 is returned.</span>
<a name="l00950"></a>00950 <span class="comment"> */</span>
<a name="l00951"></a><a class="code" href="app__queue_8c.html#ac038b08379d8bdb21a862f1bafe729d4">00951</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ac038b08379d8bdb21a862f1bafe729d4" title="Check if members are available.">get_member_status</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q, <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a>, <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a>, <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6">empty_conditions</a> conditions)
<a name="l00952"></a>00952 {
<a name="l00953"></a>00953    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *<a class="code" href="structmember.html">member</a>;
<a name="l00954"></a>00954    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l00955"></a>00955 
<a name="l00956"></a>00956    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l00957"></a>00957    mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l00958"></a>00958    <span class="keywordflow">for</span> (; (member = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter)); <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(member, -1)) {
<a name="l00959"></a>00959       <span class="keywordflow">if</span> ((max_penalty &amp;&amp; (member-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> &gt; max_penalty)) || (min_penalty &amp;&amp; (member-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> &lt; min_penalty))) {
<a name="l00960"></a>00960          <span class="keywordflow">if</span> (conditions &amp; <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a54be9f0e166d88bc3d740221060f14e4">QUEUE_EMPTY_PENALTY</a>) {
<a name="l00961"></a>00961             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;%s is unavailable because his penalty is not between %d and %d\n&quot;</span>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, min_penalty, max_penalty);
<a name="l00962"></a>00962             <span class="keywordflow">continue</span>;
<a name="l00963"></a>00963          }
<a name="l00964"></a>00964       }
<a name="l00965"></a>00965 
<a name="l00966"></a>00966       <span class="keywordflow">switch</span> (member-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a>) {
<a name="l00967"></a>00967       <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>:
<a name="l00968"></a>00968          <span class="keywordflow">if</span> (conditions &amp; <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a1043fcafb4c428c3dfe5a3253485d7af">QUEUE_EMPTY_INVALID</a>) {
<a name="l00969"></a>00969             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;%s is unavailable because his device state is &apos;invalid&apos;\n&quot;</span>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>);
<a name="l00970"></a>00970             <span class="keywordflow">break</span>;
<a name="l00971"></a>00971          }
<a name="l00972"></a>00972       <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>:
<a name="l00973"></a>00973          <span class="keywordflow">if</span> (conditions &amp; <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6adfcf6310d20a8088a392ea40fa381e09">QUEUE_EMPTY_UNAVAILABLE</a>) {
<a name="l00974"></a>00974             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;%s is unavailable because his device state is &apos;unavailable&apos;\n&quot;</span>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>);
<a name="l00975"></a>00975             <span class="keywordflow">break</span>;
<a name="l00976"></a>00976          }
<a name="l00977"></a>00977       <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>:
<a name="l00978"></a>00978          <span class="keywordflow">if</span> (conditions &amp; <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a85b9e406efa42c21f44d6f5b3ae9b332">QUEUE_EMPTY_INUSE</a>) {
<a name="l00979"></a>00979             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;%s is unavailable because his device state is &apos;inuse&apos;\n&quot;</span>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>);
<a name="l00980"></a>00980             <span class="keywordflow">break</span>;
<a name="l00981"></a>00981          }
<a name="l00982"></a>00982       <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>:
<a name="l00983"></a>00983          <span class="keywordflow">if</span> (conditions &amp; <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a1532fb860aed655673cca9f18f44a7d1">QUEUE_EMPTY_UNKNOWN</a>) {
<a name="l00984"></a>00984             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;%s is unavailable because his device state is &apos;unknown&apos;\n&quot;</span>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>);
<a name="l00985"></a>00985             <span class="keywordflow">break</span>;
<a name="l00986"></a>00986          }
<a name="l00987"></a>00987       <span class="keywordflow">default</span>:
<a name="l00988"></a>00988          <span class="keywordflow">if</span> (member-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a> &amp;&amp; (conditions &amp; <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6af68e289850cc046b29075b71cc9b2d2c">QUEUE_EMPTY_PAUSED</a>)) {
<a name="l00989"></a>00989             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;%s is unavailable because he is paused&apos;\n&quot;</span>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>);
<a name="l00990"></a>00990             <span class="keywordflow">break</span>;
<a name="l00991"></a>00991          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((conditions &amp; <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6aec193cf33d944aed4807b36eefdbc1d1">QUEUE_EMPTY_WRAPUP</a>) &amp;&amp; member-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a> &amp;&amp; q-&gt;<a class="code" href="structcall__queue.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> &amp;&amp; (time(NULL) - q-&gt;<a class="code" href="structcall__queue.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> &lt; member-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>)) {
<a name="l00992"></a>00992             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;%s is unavailable because it has only been %d seconds since his last call (wrapup time is %d)\n&quot;</span>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, (<span class="keywordtype">int</span>) (time(NULL) - member-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>), q-&gt;<a class="code" href="structcall__queue.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a>);
<a name="l00993"></a>00993             <span class="keywordflow">break</span>;
<a name="l00994"></a>00994          } <span class="keywordflow">else</span> {
<a name="l00995"></a>00995             <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l00996"></a>00996             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(member, -1);
<a name="l00997"></a>00997             <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l00998"></a>00998             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;%s is available.\n&quot;</span>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>);
<a name="l00999"></a>00999             <span class="keywordflow">return</span> 0;
<a name="l01000"></a>01000          }
<a name="l01001"></a>01001          <span class="keywordflow">break</span>;
<a name="l01002"></a>01002       }
<a name="l01003"></a>01003    }
<a name="l01004"></a>01004    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l01005"></a>01005 
<a name="l01006"></a>01006    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l01007"></a>01007    <span class="keywordflow">return</span> -1;
<a name="l01008"></a>01008 }
<a name="l01009"></a>01009 
<a name="l01010"></a><a class="code" href="structstatechange.html">01010</a> <span class="keyword">struct </span><a class="code" href="structstatechange.html">statechange</a> {
<a name="l01011"></a>01011    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structstatechange.html">statechange</a>) entry;
<a name="l01012"></a>01012    <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>;
<a name="l01013"></a>01013    <span class="keywordtype">char</span> dev[0];
<a name="l01014"></a>01014 };
<a name="l01015"></a>01015 <span class="comment"></span>
<a name="l01016"></a>01016 <span class="comment">/*! \brief set a member&apos;s status based on device state of that member&apos;s state_interface.</span>
<a name="l01017"></a>01017 <span class="comment"> *  </span>
<a name="l01018"></a>01018 <span class="comment"> * Lock interface list find sc, iterate through each queues queue_member list for member to</span>
<a name="l01019"></a>01019 <span class="comment"> * update state inside queues</span>
<a name="l01020"></a>01020 <span class="comment">*/</span>
<a name="l01021"></a><a class="code" href="app__queue_8c.html#a7e0cf32398ece87e80e92dffce3cda2c">01021</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a7e0cf32398ece87e80e92dffce3cda2c" title="set a member&amp;#39;s status based on device state of that member&amp;#39;s state_interface...">update_status</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q, <span class="keyword">struct</span> <a class="code" href="structmember.html">member</a> *m, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>)
<a name="l01022"></a>01022 {
<a name="l01023"></a>01023    m-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = status;
<a name="l01024"></a>01024 
<a name="l01025"></a>01025    <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a1cea13bb2b7ec038aa54d2c1f50ffc75">maskmemberstatus</a>)
<a name="l01026"></a>01026       <span class="keywordflow">return</span> 0;
<a name="l01027"></a>01027 
<a name="l01028"></a>01028    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;QueueMemberStatus&quot;</span>,
<a name="l01029"></a>01029       <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l01030"></a>01030       <span class="stringliteral">&quot;Location: %s\r\n&quot;</span>
<a name="l01031"></a>01031       <span class="stringliteral">&quot;MemberName: %s\r\n&quot;</span>
<a name="l01032"></a>01032       <span class="stringliteral">&quot;Membership: %s\r\n&quot;</span>
<a name="l01033"></a>01033       <span class="stringliteral">&quot;Penalty: %d\r\n&quot;</span>
<a name="l01034"></a>01034       <span class="stringliteral">&quot;CallsTaken: %d\r\n&quot;</span>
<a name="l01035"></a>01035       <span class="stringliteral">&quot;LastCall: %d\r\n&quot;</span>
<a name="l01036"></a>01036       <span class="stringliteral">&quot;Status: %d\r\n&quot;</span>
<a name="l01037"></a>01037       <span class="stringliteral">&quot;Paused: %d\r\n&quot;</span>,
<a name="l01038"></a>01038       q-&gt;name, m-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, m-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, m-&gt;<a class="code" href="structmember.html#a44690a0a629211d7620ce0d55c412e9d">dynamic</a> ? <span class="stringliteral">&quot;dynamic&quot;</span> : m-&gt;<a class="code" href="structmember.html#aac1ae37fa4007496a50df75cf1f698c1">realtime</a> ? <span class="stringliteral">&quot;realtime&quot;</span> : <span class="stringliteral">&quot;static&quot;</span>,
<a name="l01039"></a>01039       m-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>, m-&gt;<a class="code" href="structmember.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a>, (<span class="keywordtype">int</span>)m-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>, m-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a>, m-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a>
<a name="l01040"></a>01040    );
<a name="l01041"></a>01041 
<a name="l01042"></a>01042    <span class="keywordflow">return</span> 0;
<a name="l01043"></a>01043 }
<a name="l01044"></a>01044 <span class="comment"></span>
<a name="l01045"></a>01045 <span class="comment">/*! \brief set a member&apos;s status based on device state of that member&apos;s interface*/</span>
<a name="l01046"></a><a class="code" href="app__queue_8c.html#a3abd8b8b4dd20de2436440a2b1993dc0">01046</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a3abd8b8b4dd20de2436440a2b1993dc0" title="set a member&amp;#39;s status based on device state of that member&amp;#39;s interface">handle_statechange</a>(<span class="keywordtype">void</span> *datap)
<a name="l01047"></a>01047 {
<a name="l01048"></a>01048    <span class="keyword">struct </span><a class="code" href="structstatechange.html">statechange</a> *sc = datap;
<a name="l01049"></a>01049    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> miter, qiter;
<a name="l01050"></a>01050    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *m;
<a name="l01051"></a>01051    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l01052"></a>01052    <span class="keywordtype">char</span> interface[80], *slash_pos;
<a name="l01053"></a>01053    <span class="keywordtype">int</span> <a class="code" href="structcall__queue.html#a7dbc8370e15350314b041aad17f96706">found</a> = 0;
<a name="l01054"></a>01054 
<a name="l01055"></a>01055    qiter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, 0);
<a name="l01056"></a>01056    <span class="keywordflow">while</span> ((q = <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;qiter, <span class="stringliteral">&quot;Iterate over queues&quot;</span>))) {
<a name="l01057"></a>01057       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l01058"></a>01058 
<a name="l01059"></a>01059       miter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l01060"></a>01060       <span class="keywordflow">for</span> (; (m = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;miter)); <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1)) {
<a name="l01061"></a>01061          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(interface, m-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>, <span class="keyword">sizeof</span>(interface));
<a name="l01062"></a>01062 
<a name="l01063"></a>01063          <span class="keywordflow">if</span> ((slash_pos = strchr(interface, <span class="charliteral">&apos;/&apos;</span>)))
<a name="l01064"></a>01064             <span class="keywordflow">if</span> (!strncasecmp(interface, <span class="stringliteral">&quot;Local/&quot;</span>, 6) &amp;&amp; (slash_pos = strchr(slash_pos + 1, <span class="charliteral">&apos;/&apos;</span>)))
<a name="l01065"></a>01065                *slash_pos = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01066"></a>01066 
<a name="l01067"></a>01067          <span class="keywordflow">if</span> (!strcasecmp(interface, sc-&gt;<a class="code" href="structstatechange.html#afe67fe8a593b86ec431b116b7b4162d7">dev</a>)) {
<a name="l01068"></a>01068             found = 1;
<a name="l01069"></a>01069             <a class="code" href="app__queue_8c.html#a7e0cf32398ece87e80e92dffce3cda2c" title="set a member&amp;#39;s status based on device state of that member&amp;#39;s state_interface...">update_status</a>(q, m, sc-&gt;state);
<a name="l01070"></a>01070             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l01071"></a>01071             <span class="keywordflow">break</span>;
<a name="l01072"></a>01072          }
<a name="l01073"></a>01073       }
<a name="l01074"></a>01074       <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;miter);
<a name="l01075"></a>01075 
<a name="l01076"></a>01076       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l01077"></a>01077       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l01078"></a>01078    }
<a name="l01079"></a>01079    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;qiter);
<a name="l01080"></a>01080 
<a name="l01081"></a>01081    <span class="keywordflow">if</span> (found)
<a name="l01082"></a>01082       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Device &apos;%s&apos; changed to state &apos;%d&apos; (%s)\n&quot;</span>, sc-&gt;<a class="code" href="structstatechange.html#afe67fe8a593b86ec431b116b7b4162d7">dev</a>, sc-&gt;state, <a class="code" href="devicestate_8h.html#ac3a57910a6eb04d12d793fe3df796b8e" title="Find devicestate as text message for output.">ast_devstate2str</a>(sc-&gt;state));
<a name="l01083"></a>01083    <span class="keywordflow">else</span>
<a name="l01084"></a>01084       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Device &apos;%s&apos; changed to state &apos;%d&apos; (%s) but we don&apos;t care because they&apos;re not a member of any queue.\n&quot;</span>, sc-&gt;<a class="code" href="structstatechange.html#afe67fe8a593b86ec431b116b7b4162d7">dev</a>, sc-&gt;state, <a class="code" href="devicestate_8h.html#ac3a57910a6eb04d12d793fe3df796b8e" title="Find devicestate as text message for output.">ast_devstate2str</a>(sc-&gt;state));
<a name="l01085"></a>01085 
<a name="l01086"></a>01086    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sc);
<a name="l01087"></a>01087    <span class="keywordflow">return</span> 0;
<a name="l01088"></a>01088 }
<a name="l01089"></a>01089 
<a name="l01090"></a><a class="code" href="app__queue_8c.html#a6fb2c0a540b83365dcdc10b470116e82">01090</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a6fb2c0a540b83365dcdc10b470116e82">device_state_cb</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__event.html" title="An event.">ast_event</a> *event, <span class="keywordtype">void</span> *unused)
<a name="l01091"></a>01091 {
<a name="l01092"></a>01092    <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> <a class="code" href="structstate.html">state</a>;
<a name="l01093"></a>01093    <span class="keyword">const</span> <span class="keywordtype">char</span> *device;
<a name="l01094"></a>01094    <span class="keyword">struct </span><a class="code" href="structstatechange.html">statechange</a> *sc;
<a name="l01095"></a>01095    <span class="keywordtype">size_t</span> datapsize;
<a name="l01096"></a>01096 
<a name="l01097"></a>01097    state = <a class="code" href="event_8h.html#a317f6947b933acd0da82df6e9a4672e5" title="Get the value of an information element that has an integer payload.">ast_event_get_ie_uint</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a17f475640d923666e2c755e4985b61f8" title="Generic State IE Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: UINT The actual...">AST_EVENT_IE_STATE</a>);
<a name="l01098"></a>01098    device = <a class="code" href="event_8h.html#a0cfdd21162f4795714da583c31477151" title="Get the value of an information element that has a string payload.">ast_event_get_ie_str</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a675632af9f21fe7696772885593140e3" title="Device Name Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: STR.">AST_EVENT_IE_DEVICE</a>);
<a name="l01099"></a>01099 
<a name="l01100"></a>01100    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(device)) {
<a name="l01101"></a>01101       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Received invalid event that had no device IE\n&quot;</span>);
<a name="l01102"></a>01102       <span class="keywordflow">return</span>;
<a name="l01103"></a>01103    }
<a name="l01104"></a>01104    datapsize = <span class="keyword">sizeof</span>(*sc) + strlen(device) + 1;
<a name="l01105"></a>01105    <span class="keywordflow">if</span> (!(sc = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, datapsize))) {
<a name="l01106"></a>01106       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;failed to calloc a state change struct\n&quot;</span>);
<a name="l01107"></a>01107       <span class="keywordflow">return</span>;
<a name="l01108"></a>01108    }
<a name="l01109"></a>01109    sc-&gt;state = state;
<a name="l01110"></a>01110    strcpy(sc-&gt;<a class="code" href="structstatechange.html#afe67fe8a593b86ec431b116b7b4162d7">dev</a>, device);
<a name="l01111"></a>01111    <span class="keywordflow">if</span> (<a class="code" href="taskprocessor_8h.html#a815e690b2db467f47655ebaa5d85fb69" title="Push a task into the specified taskprocessor queue and signal the taskprocessor thread...">ast_taskprocessor_push</a>(devicestate_tps, <a class="code" href="app__queue_8c.html#a3abd8b8b4dd20de2436440a2b1993dc0" title="set a member&amp;#39;s status based on device state of that member&amp;#39;s interface">handle_statechange</a>, sc) &lt; 0) {
<a name="l01112"></a>01112       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sc);
<a name="l01113"></a>01113    }
<a name="l01114"></a>01114 }
<a name="l01115"></a>01115 <span class="comment"></span>
<a name="l01116"></a>01116 <span class="comment">/*! \brief allocate space for new queue member and set fields based on parameters passed */</span>
<a name="l01117"></a><a class="code" href="app__queue_8c.html#a8cfa1185143485f4531932cf8970555e">01117</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *<a class="code" href="app__queue_8c.html#a8cfa1185143485f4531932cf8970555e" title="allocate space for new queue member and set fields based on parameters passed">create_queue_member</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, <span class="keywordtype">int</span> <a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>, <span class="keywordtype">int</span> <a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>)
<a name="l01118"></a>01118 {
<a name="l01119"></a>01119    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *cur;
<a name="l01120"></a>01120    
<a name="l01121"></a>01121    <span class="keywordflow">if</span> ((cur = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*cur), NULL))) {
<a name="l01122"></a>01122       cur-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> = penalty;
<a name="l01123"></a>01123       cur-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a> = paused;
<a name="l01124"></a>01124       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cur-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, interface, <span class="keyword">sizeof</span>(cur-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>));
<a name="l01125"></a>01125       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(state_interface))
<a name="l01126"></a>01126          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cur-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>, state_interface, <span class="keyword">sizeof</span>(cur-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>));
<a name="l01127"></a>01127       <span class="keywordflow">else</span>
<a name="l01128"></a>01128          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cur-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>, interface, <span class="keyword">sizeof</span>(cur-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>));
<a name="l01129"></a>01129       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(membername))
<a name="l01130"></a>01130          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cur-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, membername, <span class="keyword">sizeof</span>(cur-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>));
<a name="l01131"></a>01131       <span class="keywordflow">else</span>
<a name="l01132"></a>01132          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cur-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, interface, <span class="keyword">sizeof</span>(cur-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>));
<a name="l01133"></a>01133       <span class="keywordflow">if</span> (!strchr(cur-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, <span class="charliteral">&apos;/&apos;</span>))
<a name="l01134"></a>01134          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No location at interface &apos;%s&apos;\n&quot;</span>, interface);
<a name="l01135"></a>01135       cur-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a>(cur-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>);
<a name="l01136"></a>01136    }
<a name="l01137"></a>01137 
<a name="l01138"></a>01138    <span class="keywordflow">return</span> cur;
<a name="l01139"></a>01139 }
<a name="l01140"></a>01140 
<a name="l01141"></a>01141 
<a name="l01142"></a><a class="code" href="app__queue_8c.html#afadb8ba08300e1949f925ea3da91d443">01142</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#afadb8ba08300e1949f925ea3da91d443">compress_char</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> c)
<a name="l01143"></a>01143 {
<a name="l01144"></a>01144    <span class="keywordflow">if</span> (c &lt; 32)
<a name="l01145"></a>01145       <span class="keywordflow">return</span> 0;
<a name="l01146"></a>01146    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c &gt; 96)
<a name="l01147"></a>01147       <span class="keywordflow">return</span> c - 64;
<a name="l01148"></a>01148    <span class="keywordflow">else</span>
<a name="l01149"></a>01149       <span class="keywordflow">return</span> c - 32;
<a name="l01150"></a>01150 }
<a name="l01151"></a>01151 
<a name="l01152"></a><a class="code" href="app__queue_8c.html#a663a7b1ad590cc3041706eb246d91ba7">01152</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a663a7b1ad590cc3041706eb246d91ba7">member_hash_fn</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> flags)
<a name="l01153"></a>01153 {
<a name="l01154"></a>01154    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *mem = obj;
<a name="l01155"></a>01155    <span class="keyword">const</span> <span class="keywordtype">char</span> *chname = strchr(mem-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, <span class="charliteral">&apos;/&apos;</span>);
<a name="l01156"></a>01156    <span class="keywordtype">int</span> ret = 0, i;
<a name="l01157"></a>01157    <span class="keywordflow">if</span> (!chname)
<a name="l01158"></a>01158       chname = mem-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>;
<a name="l01159"></a>01159    <span class="keywordflow">for</span> (i = 0; i &lt; 5 &amp;&amp; chname[i]; i++)
<a name="l01160"></a>01160       ret += <a class="code" href="app__queue_8c.html#afadb8ba08300e1949f925ea3da91d443">compress_char</a>(chname[i]) &lt;&lt; (i * 6);
<a name="l01161"></a>01161    <span class="keywordflow">return</span> ret;
<a name="l01162"></a>01162 }
<a name="l01163"></a>01163 
<a name="l01164"></a><a class="code" href="app__queue_8c.html#a6659861a3baff7381bdfe00d7b36c19a">01164</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a6659861a3baff7381bdfe00d7b36c19a">member_cmp_fn</a>(<span class="keywordtype">void</span> *obj1, <span class="keywordtype">void</span> *obj2, <span class="keywordtype">int</span> flags)
<a name="l01165"></a>01165 {
<a name="l01166"></a>01166    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *mem1 = obj1, *mem2 = obj2;
<a name="l01167"></a>01167    <span class="keywordflow">return</span> strcasecmp(mem1-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, mem2-&gt;interface) ? 0 : <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a>;
<a name="l01168"></a>01168 }
<a name="l01169"></a>01169 <span class="comment"></span>
<a name="l01170"></a>01170 <span class="comment">/*! </span>
<a name="l01171"></a>01171 <span class="comment"> * \brief Initialize Queue default values.</span>
<a name="l01172"></a>01172 <span class="comment"> * \note the queue&apos;s lock  must be held before executing this function</span>
<a name="l01173"></a>01173 <span class="comment">*/</span>
<a name="l01174"></a><a class="code" href="app__queue_8c.html#aa76378a6ff09ce40268e214fdae6a61d">01174</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#aa76378a6ff09ce40268e214fdae6a61d" title="Initialize Queue default values.">init_queue</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q)
<a name="l01175"></a>01175 {
<a name="l01176"></a>01176    <span class="keywordtype">int</span> i;
<a name="l01177"></a>01177    <span class="keyword">struct </span><a class="code" href="structpenalty__rule.html">penalty_rule</a> *pr_iter;
<a name="l01178"></a>01178 
<a name="l01179"></a>01179    q-&gt;<a class="code" href="structcall__queue.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a> = 0;
<a name="l01180"></a>01180    q-&gt;<a class="code" href="structcall__queue.html#addf2eb79daee1e400c823a699b0f856b">retry</a> = <a class="code" href="app__queue_8c.html#a3f1683ed5a30b46922e3f88b7c716e04">DEFAULT_RETRY</a>;
<a name="l01181"></a>01181    q-&gt;<a class="code" href="structcall__queue.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> = <a class="code" href="app__queue_8c.html#aad2dd72565852b91c809cd4685833b17">DEFAULT_TIMEOUT</a>;
<a name="l01182"></a>01182    q-&gt;<a class="code" href="structcall__queue.html#a245b5bee0d02a20222d815dbeaaac0fb">maxlen</a> = 0;
<a name="l01183"></a>01183    q-&gt;<a class="code" href="structcall__queue.html#a158e72e504d11a5f6cdfa8d25343adbb">announcefrequency</a> = 0;
<a name="l01184"></a>01184    q-&gt;<a class="code" href="structcall__queue.html#a7724cd5a7395de6d0cbc7f0a02b0c20a">minannouncefrequency</a> = <a class="code" href="app__queue_8c.html#a679ea032e9e26f6e6e569769fb528722">DEFAULT_MIN_ANNOUNCE_FREQUENCY</a>;
<a name="l01185"></a>01185    q-&gt;<a class="code" href="structcall__queue.html#a1b9572151ecc081254a026796ef65d33">announceholdtime</a> = 1;
<a name="l01186"></a>01186    q-&gt;<a class="code" href="structcall__queue.html#a336eac6939e5ebd50b2871148243dee6">announcepositionlimit</a> = 10; <span class="comment">/* Default 10 positions */</span>
<a name="l01187"></a>01187    q-&gt;<a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">announceposition</a> = <a class="code" href="app__queue_8c.html#ae19c02c3c0ba9ca01d7ede746f736c45">ANNOUNCEPOSITION_YES</a>; <span class="comment">/* Default yes */</span>
<a name="l01188"></a>01188    q-&gt;<a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">roundingseconds</a> = 0; <span class="comment">/* Default - don&apos;t announce seconds */</span>
<a name="l01189"></a>01189    q-&gt;<a class="code" href="structcall__queue.html#a6293d1622ff45ccac3a1679171376856">servicelevel</a> = 0;
<a name="l01190"></a>01190    q-&gt;<a class="code" href="structcall__queue.html#a88ec6754dea8cb6d040f61a279b1c298">ringinuse</a> = 1;
<a name="l01191"></a>01191    q-&gt;<a class="code" href="structcall__queue.html#a0c5bcd98bca1c3085183ba1fc80195ed">setinterfacevar</a> = 0;
<a name="l01192"></a>01192    q-&gt;<a class="code" href="structcall__queue.html#a32794c302b9a60821d519f6d4d1e7885">setqueuevar</a> = 0;
<a name="l01193"></a>01193    q-&gt;<a class="code" href="structcall__queue.html#a23486e86a21295aa734885d335ae9c2f">setqueueentryvar</a> = 0;
<a name="l01194"></a>01194    q-&gt;<a class="code" href="structcall__queue.html#a76e20f3c9df399ad87bb4e45c7419e99">autofill</a> = autofill_default;
<a name="l01195"></a>01195    q-&gt;<a class="code" href="structcall__queue.html#a7ccaa047c703f95f5eaf0dd0a10670b5">montype</a> = montype_default;
<a name="l01196"></a>01196    q-&gt;<a class="code" href="structcall__queue.html#ab76c064ab44a836302512ee2adbb297e">monfmt</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01197"></a>01197    q-&gt;<a class="code" href="structcall__queue.html#a20ba21c586c791a31ef97102b4811a8f">reportholdtime</a> = 0;
<a name="l01198"></a>01198    q-&gt;<a class="code" href="structcall__queue.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> = 0;
<a name="l01199"></a>01199    q-&gt;<a class="code" href="structcall__queue.html#ab95f2fa73d00493b2fa1fc26eb37dc24">joinempty</a> = 0;
<a name="l01200"></a>01200    q-&gt;<a class="code" href="structcall__queue.html#a77bab4023f1969460cc9c64baa39e016">leavewhenempty</a> = 0;
<a name="l01201"></a>01201    q-&gt;<a class="code" href="structcall__queue.html#adc032ac2dcea31bd708fc762f42c385e">memberdelay</a> = 0;
<a name="l01202"></a>01202    q-&gt;<a class="code" href="structcall__queue.html#a1cea13bb2b7ec038aa54d2c1f50ffc75">maskmemberstatus</a> = 0;
<a name="l01203"></a>01203    q-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a> = 0;
<a name="l01204"></a>01204    q-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a> = 0;
<a name="l01205"></a>01205    q-&gt;<a class="code" href="structcall__queue.html#a24cf7a74d65e1d4f4b9bfd16455187fb">timeoutrestart</a> = 0;
<a name="l01206"></a>01206    q-&gt;<a class="code" href="structcall__queue.html#a2a43a68cf8add918260068d677434132">periodicannouncefrequency</a> = 0;
<a name="l01207"></a>01207    q-&gt;<a class="code" href="structcall__queue.html#a3991228a9e7540246c6cc4cf42c0794d">randomperiodicannounce</a> = 0;
<a name="l01208"></a>01208    q-&gt;<a class="code" href="structcall__queue.html#a8e2c16675bb0afd19ebeabbcd4329681">numperiodicannounce</a> = 0;
<a name="l01209"></a>01209    q-&gt;<a class="code" href="structcall__queue.html#af983858a2192f96c9a30e44467b87f61">timeoutpriority</a> = <a class="code" href="app__queue_8c.html#a452e8221d8fbd54db8c589265a09e844aabaf51de14755cf9b47a42c3cc460a87">TIMEOUT_PRIORITY_APP</a>;
<a name="l01210"></a>01210    <span class="keywordflow">if</span> (!q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>) {
<a name="l01211"></a>01211       <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> == <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba49bae9dfad805972b20763389a090d09">QUEUE_STRATEGY_LINEAR</a>)
<a name="l01212"></a>01212          <span class="comment">/* linear strategy depends on order, so we have to place all members in a single bucket */</span>
<a name="l01213"></a>01213          q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a> = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(1, <a class="code" href="app__queue_8c.html#a663a7b1ad590cc3041706eb246d91ba7">member_hash_fn</a>, <a class="code" href="app__queue_8c.html#a6659861a3baff7381bdfe00d7b36c19a">member_cmp_fn</a>);
<a name="l01214"></a>01214       <span class="keywordflow">else</span>
<a name="l01215"></a>01215          q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a> = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(37, <a class="code" href="app__queue_8c.html#a663a7b1ad590cc3041706eb246d91ba7">member_hash_fn</a>, <a class="code" href="app__queue_8c.html#a6659861a3baff7381bdfe00d7b36c19a">member_cmp_fn</a>);
<a name="l01216"></a>01216    }
<a name="l01217"></a>01217    q-&gt;<a class="code" href="structcall__queue.html#a7dbc8370e15350314b041aad17f96706">found</a> = 1;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_next, <span class="stringliteral">&quot;queue-youarenext&quot;</span>);
<a name="l01220"></a>01220    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_thereare, <span class="stringliteral">&quot;queue-thereare&quot;</span>);
<a name="l01221"></a>01221    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_calls, <span class="stringliteral">&quot;queue-callswaiting&quot;</span>);
<a name="l01222"></a>01222    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, queue_quantity1, <span class="stringliteral">&quot;queue-quantity1&quot;</span>);
<a name="l01223"></a>01223    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, queue_quantity2, <span class="stringliteral">&quot;queue-quantity2&quot;</span>);
<a name="l01224"></a>01224    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_holdtime, <span class="stringliteral">&quot;queue-holdtime&quot;</span>);
<a name="l01225"></a>01225    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_minutes, <span class="stringliteral">&quot;queue-minutes&quot;</span>);
<a name="l01226"></a>01226    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_minute, <span class="stringliteral">&quot;queue-minute&quot;</span>);
<a name="l01227"></a>01227    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_seconds, <span class="stringliteral">&quot;queue-seconds&quot;</span>);
<a name="l01228"></a>01228    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_thanks, <span class="stringliteral">&quot;queue-thankyou&quot;</span>);
<a name="l01229"></a>01229    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_reporthold, <span class="stringliteral">&quot;queue-reporthold&quot;</span>);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231    <span class="keywordflow">if</span> ((q-&gt;<a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">sound_periodicannounce</a>[0] = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(32)))
<a name="l01232"></a>01232       <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;q-&gt;<a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">sound_periodicannounce</a>[0], 0, <span class="stringliteral">&quot;queue-periodic-announce&quot;</span>);
<a name="l01233"></a>01233 
<a name="l01234"></a>01234    <span class="keywordflow">for</span> (i = 1; i &lt; <a class="code" href="app__queue_8c.html#a2f5d1f6fb6cd3af5e8b07d19e4ab273a">MAX_PERIODIC_ANNOUNCEMENTS</a>; i++) {
<a name="l01235"></a>01235       <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">sound_periodicannounce</a>[i])
<a name="l01236"></a>01236          <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;q-&gt;<a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">sound_periodicannounce</a>[i], 0, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01237"></a>01237    }
<a name="l01238"></a>01238 
<a name="l01239"></a>01239    <span class="keywordflow">while</span> ((pr_iter = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;q-&gt;rules,list)))
<a name="l01240"></a>01240       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(pr_iter);
<a name="l01241"></a>01241 }
<a name="l01242"></a>01242 
<a name="l01243"></a><a class="code" href="app__queue_8c.html#a3f75910c35a627fb9d15d0024fe0c36b">01243</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a3f75910c35a627fb9d15d0024fe0c36b">clear_queue</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q)
<a name="l01244"></a>01244 {
<a name="l01245"></a>01245    q-&gt;<a class="code" href="structcall__queue.html#aebac91dc9bbd110e44f8ffa9f2e697d1">holdtime</a> = 0;
<a name="l01246"></a>01246    q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a> = 0;
<a name="l01247"></a>01247    q-&gt;<a class="code" href="structcall__queue.html#a8c3a63527e11cef32f7e5aae9f3f270f">callsabandoned</a> = 0;
<a name="l01248"></a>01248    q-&gt;<a class="code" href="structcall__queue.html#ad22c84b7016cae07c521dda4a74544f8">callscompletedinsl</a> = 0;
<a name="l01249"></a>01249    q-&gt;<a class="code" href="structcall__queue.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> = 0;
<a name="l01250"></a>01250    q-&gt;<a class="code" href="structcall__queue.html#a080da53416fe93b51940797285eeee5c">talktime</a> = 0;
<a name="l01251"></a>01251 
<a name="l01252"></a>01252    <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>) {
<a name="l01253"></a>01253       <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *mem;
<a name="l01254"></a>01254       <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l01255"></a>01255       <span class="keywordflow">while</span> ((mem = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l01256"></a>01256          mem-&gt;<a class="code" href="structmember.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a> = 0;
<a name="l01257"></a>01257          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l01258"></a>01258       }
<a name="l01259"></a>01259       <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l01260"></a>01260    }
<a name="l01261"></a>01261 }
<a name="l01262"></a>01262 <span class="comment"></span>
<a name="l01263"></a>01263 <span class="comment">/*! </span>
<a name="l01264"></a>01264 <span class="comment"> * \brief Change queue penalty by adding rule.</span>
<a name="l01265"></a>01265 <span class="comment"> *</span>
<a name="l01266"></a>01266 <span class="comment"> * Check rule for errors with time or fomatting, see if rule is relative to rest </span>
<a name="l01267"></a>01267 <span class="comment"> * of queue, iterate list of rules to find correct insertion point, insert and return.</span>
<a name="l01268"></a>01268 <span class="comment"> * \retval -1 on failure</span>
<a name="l01269"></a>01269 <span class="comment"> * \retval 0 on success </span>
<a name="l01270"></a>01270 <span class="comment"> * \note Call this with the rule_lists locked </span>
<a name="l01271"></a>01271 <span class="comment">*/</span>
<a name="l01272"></a><a class="code" href="app__queue_8c.html#ab7086bc4304099aec95794ea6ed63260">01272</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ab7086bc4304099aec95794ea6ed63260" title="Change queue penalty by adding rule.">insert_penaltychange</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *list_name, <span class="keyword">const</span> <span class="keywordtype">char</span> *content, <span class="keyword">const</span> <span class="keywordtype">int</span> linenum)
<a name="l01273"></a>01273 {
<a name="l01274"></a>01274    <span class="keywordtype">char</span> *timestr, *maxstr, *minstr, *contentdup;
<a name="l01275"></a>01275    <span class="keyword">struct </span><a class="code" href="structpenalty__rule.html">penalty_rule</a> *<a class="code" href="structrule.html">rule</a> = NULL, *rule_iter;
<a name="l01276"></a>01276    <span class="keyword">struct </span>rule_list *rl_iter;
<a name="l01277"></a>01277    <span class="keywordtype">int</span> penaltychangetime, inserted = 0;
<a name="l01278"></a>01278 
<a name="l01279"></a>01279    <span class="keywordflow">if</span> (!(rule = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*rule)))) {
<a name="l01280"></a>01280       <span class="keywordflow">return</span> -1;
<a name="l01281"></a>01281    }
<a name="l01282"></a>01282 
<a name="l01283"></a>01283    contentdup = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(content);
<a name="l01284"></a>01284    
<a name="l01285"></a>01285    <span class="keywordflow">if</span> (!(maxstr = strchr(contentdup, <span class="charliteral">&apos;,&apos;</span>))) {
<a name="l01286"></a>01286       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Improperly formatted penaltychange rule at line %d. Ignoring.\n&quot;</span>, linenum);
<a name="l01287"></a>01287       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(rule);
<a name="l01288"></a>01288       <span class="keywordflow">return</span> -1;
<a name="l01289"></a>01289    }
<a name="l01290"></a>01290 
<a name="l01291"></a>01291    *maxstr++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01292"></a>01292    timestr = contentdup;
<a name="l01293"></a>01293 
<a name="l01294"></a>01294    <span class="keywordflow">if</span> ((penaltychangetime = atoi(timestr)) &lt; 0) {
<a name="l01295"></a>01295       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Improper time parameter specified for penaltychange rule at line %d. Ignoring.\n&quot;</span>, linenum);
<a name="l01296"></a>01296       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(rule);
<a name="l01297"></a>01297       <span class="keywordflow">return</span> -1;
<a name="l01298"></a>01298    }
<a name="l01299"></a>01299 
<a name="l01300"></a>01300    rule-&gt;<a class="code" href="structpenalty__rule.html#a42715f65f02da52edc5b22021d8ae670">time</a> = penaltychangetime;
<a name="l01301"></a>01301 
<a name="l01302"></a>01302    <span class="keywordflow">if</span> ((minstr = strchr(maxstr,<span class="charliteral">&apos;,&apos;</span>)))
<a name="l01303"></a>01303       *minstr++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01304"></a>01304    
<a name="l01305"></a>01305    <span class="comment">/* The last check will evaluate true if either no penalty change is indicated for a given rule</span>
<a name="l01306"></a>01306 <span class="comment">    * OR if a min penalty change is indicated but no max penalty change is */</span>
<a name="l01307"></a>01307    <span class="keywordflow">if</span> (*maxstr == <span class="charliteral">&apos;+&apos;</span> || *maxstr == <span class="charliteral">&apos;-&apos;</span> || *maxstr == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01308"></a>01308       rule-&gt;<a class="code" href="structpenalty__rule.html#ae0778c688a39dcc28198f568176370eb">max_relative</a> = 1;
<a name="l01309"></a>01309    }
<a name="l01310"></a>01310 
<a name="l01311"></a>01311    rule-&gt;<a class="code" href="structpenalty__rule.html#aff3c96df7d67617d6ee82fa1f257ff84">max_value</a> = atoi(maxstr);
<a name="l01312"></a>01312 
<a name="l01313"></a>01313    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(minstr)) {
<a name="l01314"></a>01314       <span class="keywordflow">if</span> (*minstr == <span class="charliteral">&apos;+&apos;</span> || *minstr == <span class="charliteral">&apos;-&apos;</span>)
<a name="l01315"></a>01315          rule-&gt;<a class="code" href="structpenalty__rule.html#a790961d8e38a4dbcdd59e8c2b0a292b4">min_relative</a> = 1;
<a name="l01316"></a>01316       rule-&gt;<a class="code" href="structpenalty__rule.html#a2b15eec5f0109b01f534046bb5c04666">min_value</a> = atoi(minstr);
<a name="l01317"></a>01317    } <span class="keywordflow">else</span> <span class="comment">/*there was no minimum specified, so assume this means no change*/</span>
<a name="l01318"></a>01318       rule-&gt;<a class="code" href="structpenalty__rule.html#a790961d8e38a4dbcdd59e8c2b0a292b4">min_relative</a> = 1;
<a name="l01319"></a>01319 
<a name="l01320"></a>01320    <span class="comment">/*We have the rule made, now we need to insert it where it belongs*/</span>
<a name="l01321"></a>01321    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;rule_lists, rl_iter, list){
<a name="l01322"></a>01322       <span class="keywordflow">if</span> (strcasecmp(rl_iter-&gt;<a class="code" href="structrule__list.html#a3777dbae63a15da001b2baa317a25149">name</a>, list_name))
<a name="l01323"></a>01323          <span class="keywordflow">continue</span>;
<a name="l01324"></a>01324 
<a name="l01325"></a>01325       <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;rl_iter-&gt;rules, rule_iter, list) {
<a name="l01326"></a>01326          <span class="keywordflow">if</span> (rule-&gt;<a class="code" href="structpenalty__rule.html#a42715f65f02da52edc5b22021d8ae670">time</a> &lt; rule_iter-&gt;time) {
<a name="l01327"></a>01327             <a class="code" href="linkedlists_8h.html#a83227c4f8c836f0452b607507c55752f" title="Inserts a list entry before the current entry during a traversal.">AST_LIST_INSERT_BEFORE_CURRENT</a>(rule, list);
<a name="l01328"></a>01328             inserted = 1;
<a name="l01329"></a>01329             <span class="keywordflow">break</span>;
<a name="l01330"></a>01330          }
<a name="l01331"></a>01331       }
<a name="l01332"></a>01332       <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l01333"></a>01333    
<a name="l01334"></a>01334       <span class="keywordflow">if</span> (!inserted) {
<a name="l01335"></a>01335          <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;rl_iter-&gt;rules, rule, list);
<a name="l01336"></a>01336       }
<a name="l01337"></a>01337    }
<a name="l01338"></a>01338 
<a name="l01339"></a>01339    <span class="keywordflow">return</span> 0;
<a name="l01340"></a>01340 }
<a name="l01341"></a>01341 
<a name="l01342"></a><a class="code" href="app__queue_8c.html#a2faf444ec9b83e1847ac166c994ba3a8">01342</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a2faf444ec9b83e1847ac166c994ba3a8">parse_empty_options</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *value, <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6">empty_conditions</a> *empty, <span class="keywordtype">int</span> joinempty)
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344    <span class="keywordtype">char</span> *value_copy = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(value);
<a name="l01345"></a>01345    <span class="keywordtype">char</span> *option = NULL;
<a name="l01346"></a>01346    <span class="keywordflow">while</span> ((option = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;value_copy, <span class="stringliteral">&quot;,&quot;</span>))) {
<a name="l01347"></a>01347       <span class="keywordflow">if</span> (!strcasecmp(option, <span class="stringliteral">&quot;paused&quot;</span>)) {
<a name="l01348"></a>01348          *empty |= <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6af68e289850cc046b29075b71cc9b2d2c">QUEUE_EMPTY_PAUSED</a>;
<a name="l01349"></a>01349       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(option, <span class="stringliteral">&quot;penalty&quot;</span>)) {
<a name="l01350"></a>01350          *empty |= <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a54be9f0e166d88bc3d740221060f14e4">QUEUE_EMPTY_PENALTY</a>;
<a name="l01351"></a>01351       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(option, <span class="stringliteral">&quot;inuse&quot;</span>)) {
<a name="l01352"></a>01352          *empty |= <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a85b9e406efa42c21f44d6f5b3ae9b332">QUEUE_EMPTY_INUSE</a>;
<a name="l01353"></a>01353       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(option, <span class="stringliteral">&quot;ringing&quot;</span>)) {
<a name="l01354"></a>01354          *empty |= <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a6dd24d66d8fcdf0a3444d28ec9c82ba2">QUEUE_EMPTY_RINGING</a>;
<a name="l01355"></a>01355       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(option, <span class="stringliteral">&quot;invalid&quot;</span>)) {
<a name="l01356"></a>01356          *empty |= <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a1043fcafb4c428c3dfe5a3253485d7af">QUEUE_EMPTY_INVALID</a>;
<a name="l01357"></a>01357       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(option, <span class="stringliteral">&quot;wrapup&quot;</span>)) {
<a name="l01358"></a>01358          *empty |= <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6aec193cf33d944aed4807b36eefdbc1d1">QUEUE_EMPTY_WRAPUP</a>;
<a name="l01359"></a>01359       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(option, <span class="stringliteral">&quot;unavailable&quot;</span>)) {
<a name="l01360"></a>01360          *empty |= <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6adfcf6310d20a8088a392ea40fa381e09">QUEUE_EMPTY_UNAVAILABLE</a>;
<a name="l01361"></a>01361       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(option, <span class="stringliteral">&quot;unknown&quot;</span>)) {
<a name="l01362"></a>01362          *empty |= <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a1532fb860aed655673cca9f18f44a7d1">QUEUE_EMPTY_UNKNOWN</a>;
<a name="l01363"></a>01363       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(option, <span class="stringliteral">&quot;loose&quot;</span>)) {
<a name="l01364"></a>01364          *empty = (<a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a54be9f0e166d88bc3d740221060f14e4">QUEUE_EMPTY_PENALTY</a> | <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a1043fcafb4c428c3dfe5a3253485d7af">QUEUE_EMPTY_INVALID</a>);
<a name="l01365"></a>01365       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(option, <span class="stringliteral">&quot;strict&quot;</span>)) {
<a name="l01366"></a>01366          *empty = (<a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a54be9f0e166d88bc3d740221060f14e4">QUEUE_EMPTY_PENALTY</a> | <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a1043fcafb4c428c3dfe5a3253485d7af">QUEUE_EMPTY_INVALID</a> | <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6af68e289850cc046b29075b71cc9b2d2c">QUEUE_EMPTY_PAUSED</a> | <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6adfcf6310d20a8088a392ea40fa381e09">QUEUE_EMPTY_UNAVAILABLE</a>);
<a name="l01367"></a>01367       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(option) &amp;&amp; joinempty) || (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(option) &amp;&amp; !joinempty)) {
<a name="l01368"></a>01368          *empty = (<a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a54be9f0e166d88bc3d740221060f14e4">QUEUE_EMPTY_PENALTY</a> | <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6a1043fcafb4c428c3dfe5a3253485d7af">QUEUE_EMPTY_INVALID</a> | <a class="code" href="app__queue_8c.html#adc1ece01a39a4297ac0369feaba4bcb6af68e289850cc046b29075b71cc9b2d2c">QUEUE_EMPTY_PAUSED</a>);
<a name="l01369"></a>01369       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(option) &amp;&amp; !joinempty) || (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(option) &amp;&amp; joinempty)) {
<a name="l01370"></a>01370          *empty = 0;
<a name="l01371"></a>01371       } <span class="keywordflow">else</span> {
<a name="l01372"></a>01372          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown option %s for &apos;%s&apos;\n&quot;</span>, option, joinempty ? <span class="stringliteral">&quot;joinempty&quot;</span> : <span class="stringliteral">&quot;leavewhenempty&quot;</span>);
<a name="l01373"></a>01373       }
<a name="l01374"></a>01374    }
<a name="l01375"></a>01375 }
<a name="l01376"></a>01376 <span class="comment"></span>
<a name="l01377"></a>01377 <span class="comment">/*! \brief Configure a queue parameter.</span>
<a name="l01378"></a>01378 <span class="comment"> * </span>
<a name="l01379"></a>01379 <span class="comment"> * The failunknown flag is set for config files (and static realtime) to show</span>
<a name="l01380"></a>01380 <span class="comment"> * errors for unknown parameters. It is cleared for dynamic realtime to allow</span>
<a name="l01381"></a>01381 <span class="comment"> *  extra fields in the tables.</span>
<a name="l01382"></a>01382 <span class="comment"> * \note For error reporting, line number is passed for .conf static configuration,</span>
<a name="l01383"></a>01383 <span class="comment"> * for Realtime queues, linenum is -1.</span>
<a name="l01384"></a>01384 <span class="comment">*/</span>
<a name="l01385"></a><a class="code" href="app__queue_8c.html#a94baaee180e6f6ae082418dc78e7c7cf">01385</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a94baaee180e6f6ae082418dc78e7c7cf" title="Configure a queue parameter.">queue_set_param</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q, <span class="keyword">const</span> <span class="keywordtype">char</span> *param, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structval.html">val</a>, <span class="keywordtype">int</span> linenum, <span class="keywordtype">int</span> failunknown)
<a name="l01386"></a>01386 {
<a name="l01387"></a>01387    <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;musicclass&quot;</span>) || 
<a name="l01388"></a>01388       !strcasecmp(param, <span class="stringliteral">&quot;music&quot;</span>) || !strcasecmp(param, <span class="stringliteral">&quot;musiconhold&quot;</span>)) {
<a name="l01389"></a>01389       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, <a class="code" href="structqueue__ent.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>, val);
<a name="l01390"></a>01390    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;announce&quot;</span>)) {
<a name="l01391"></a>01391       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, <a class="code" href="structqueue__ent.html#a6b2f794058fc666c44aa8ea1c055c34a">announce</a>, val);
<a name="l01392"></a>01392    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;context&quot;</span>)) {
<a name="l01393"></a>01393       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, <a class="code" href="structqueue__ent.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, val);
<a name="l01394"></a>01394    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;timeout&quot;</span>)) {
<a name="l01395"></a>01395       q-&gt;<a class="code" href="structcall__queue.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> = atoi(val);
<a name="l01396"></a>01396       <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> &lt; 0)
<a name="l01397"></a>01397          q-&gt;<a class="code" href="structcall__queue.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> = <a class="code" href="app__queue_8c.html#aad2dd72565852b91c809cd4685833b17">DEFAULT_TIMEOUT</a>;
<a name="l01398"></a>01398    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;ringinuse&quot;</span>)) {
<a name="l01399"></a>01399       q-&gt;<a class="code" href="structcall__queue.html#a88ec6754dea8cb6d040f61a279b1c298">ringinuse</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l01400"></a>01400    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;setinterfacevar&quot;</span>)) {
<a name="l01401"></a>01401       q-&gt;<a class="code" href="structcall__queue.html#a0c5bcd98bca1c3085183ba1fc80195ed">setinterfacevar</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l01402"></a>01402    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;setqueuevar&quot;</span>)) {
<a name="l01403"></a>01403       q-&gt;<a class="code" href="structcall__queue.html#a32794c302b9a60821d519f6d4d1e7885">setqueuevar</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l01404"></a>01404    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;setqueueentryvar&quot;</span>)) {
<a name="l01405"></a>01405       q-&gt;<a class="code" href="structcall__queue.html#a23486e86a21295aa734885d335ae9c2f">setqueueentryvar</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l01406"></a>01406    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;monitor-format&quot;</span>)) {
<a name="l01407"></a>01407       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(q-&gt;<a class="code" href="structcall__queue.html#ab76c064ab44a836302512ee2adbb297e">monfmt</a>, val, <span class="keyword">sizeof</span>(q-&gt;<a class="code" href="structcall__queue.html#ab76c064ab44a836302512ee2adbb297e">monfmt</a>));
<a name="l01408"></a>01408    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;membermacro&quot;</span>)) {
<a name="l01409"></a>01409       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, membermacro, val);
<a name="l01410"></a>01410    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;membergosub&quot;</span>)) {
<a name="l01411"></a>01411       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, membergosub, val);
<a name="l01412"></a>01412    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;queue-youarenext&quot;</span>)) {
<a name="l01413"></a>01413       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_next, val);
<a name="l01414"></a>01414    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;queue-thereare&quot;</span>)) {
<a name="l01415"></a>01415       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_thereare, val);
<a name="l01416"></a>01416    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;queue-callswaiting&quot;</span>)) {
<a name="l01417"></a>01417       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_calls, val);
<a name="l01418"></a>01418    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;queue-quantity1&quot;</span>)) {
<a name="l01419"></a>01419       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, queue_quantity1, val);
<a name="l01420"></a>01420    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;queue-quantity2&quot;</span>)) {
<a name="l01421"></a>01421       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, queue_quantity2, val);
<a name="l01422"></a>01422    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;queue-holdtime&quot;</span>)) {
<a name="l01423"></a>01423       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_holdtime, val);
<a name="l01424"></a>01424    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;queue-minutes&quot;</span>)) {
<a name="l01425"></a>01425       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_minutes, val);
<a name="l01426"></a>01426    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;queue-minute&quot;</span>)) {
<a name="l01427"></a>01427       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_minute, val);
<a name="l01428"></a>01428    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;queue-seconds&quot;</span>)) {
<a name="l01429"></a>01429       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_seconds, val);
<a name="l01430"></a>01430    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;queue-thankyou&quot;</span>)) {
<a name="l01431"></a>01431       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_thanks, val);
<a name="l01432"></a>01432    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;queue-callerannounce&quot;</span>)) {
<a name="l01433"></a>01433       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_callerannounce, val);
<a name="l01434"></a>01434    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;queue-reporthold&quot;</span>)) {
<a name="l01435"></a>01435       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, sound_reporthold, val);
<a name="l01436"></a>01436    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;announce-frequency&quot;</span>)) {
<a name="l01437"></a>01437       q-&gt;<a class="code" href="structcall__queue.html#a158e72e504d11a5f6cdfa8d25343adbb">announcefrequency</a> = atoi(val);
<a name="l01438"></a>01438    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;min-announce-frequency&quot;</span>)) {
<a name="l01439"></a>01439       q-&gt;<a class="code" href="structcall__queue.html#a7724cd5a7395de6d0cbc7f0a02b0c20a">minannouncefrequency</a> = atoi(val);
<a name="l01440"></a>01440       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s=%s for queue &apos;%s&apos;\n&quot;</span>, param, val, q-&gt;name);
<a name="l01441"></a>01441    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;announce-round-seconds&quot;</span>)) {
<a name="l01442"></a>01442       q-&gt;<a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">roundingseconds</a> = atoi(val);
<a name="l01443"></a>01443       <span class="comment">/* Rounding to any other values just doesn&apos;t make sense... */</span>
<a name="l01444"></a>01444       <span class="keywordflow">if</span> (!(q-&gt;<a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">roundingseconds</a> == 0 || q-&gt;<a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">roundingseconds</a> == 5 || q-&gt;<a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">roundingseconds</a> == 10
<a name="l01445"></a>01445          || q-&gt;<a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">roundingseconds</a> == 15 || q-&gt;<a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">roundingseconds</a> == 20 || q-&gt;<a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">roundingseconds</a> == 30)) {
<a name="l01446"></a>01446          <span class="keywordflow">if</span> (linenum &gt;= 0) {
<a name="l01447"></a>01447             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;&apos;%s&apos; isn&apos;t a valid value for %s &quot;</span>
<a name="l01448"></a>01448                <span class="stringliteral">&quot;using 0 instead for queue &apos;%s&apos; at line %d of queues.conf\n&quot;</span>,
<a name="l01449"></a>01449                val, param, q-&gt;name, linenum);
<a name="l01450"></a>01450          } <span class="keywordflow">else</span> {
<a name="l01451"></a>01451             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;&apos;%s&apos; isn&apos;t a valid value for %s &quot;</span>
<a name="l01452"></a>01452                <span class="stringliteral">&quot;using 0 instead for queue &apos;%s&apos;\n&quot;</span>, val, param, q-&gt;name);
<a name="l01453"></a>01453          }
<a name="l01454"></a>01454          q-&gt;<a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">roundingseconds</a>=0;
<a name="l01455"></a>01455       }
<a name="l01456"></a>01456    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;announce-holdtime&quot;</span>)) {
<a name="l01457"></a>01457       <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;once&quot;</span>))
<a name="l01458"></a>01458          q-&gt;<a class="code" href="structcall__queue.html#a1b9572151ecc081254a026796ef65d33">announceholdtime</a> = <a class="code" href="app__queue_8c.html#ab37e1a4dafc93b1ded1edabe9927cf26">ANNOUNCEHOLDTIME_ONCE</a>;
<a name="l01459"></a>01459       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val))
<a name="l01460"></a>01460          q-&gt;<a class="code" href="structcall__queue.html#a1b9572151ecc081254a026796ef65d33">announceholdtime</a> = <a class="code" href="app__queue_8c.html#a8e57e0916b189a3a78e018cc14e8cb1b">ANNOUNCEHOLDTIME_ALWAYS</a>;
<a name="l01461"></a>01461       <span class="keywordflow">else</span>
<a name="l01462"></a>01462          q-&gt;<a class="code" href="structcall__queue.html#a1b9572151ecc081254a026796ef65d33">announceholdtime</a> = 0;
<a name="l01463"></a>01463    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;announce-position&quot;</span>)) {
<a name="l01464"></a>01464       <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;limit&quot;</span>))
<a name="l01465"></a>01465          q-&gt;<a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">announceposition</a> = <a class="code" href="app__queue_8c.html#a967650811eabe6b6373dddc731a286eb">ANNOUNCEPOSITION_LIMIT</a>;
<a name="l01466"></a>01466       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;more&quot;</span>))
<a name="l01467"></a>01467          q-&gt;<a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">announceposition</a> = <a class="code" href="app__queue_8c.html#a183dcea5fd32422d981d4705cd770b15">ANNOUNCEPOSITION_MORE_THAN</a>;
<a name="l01468"></a>01468       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val))
<a name="l01469"></a>01469          q-&gt;<a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">announceposition</a> = <a class="code" href="app__queue_8c.html#ae19c02c3c0ba9ca01d7ede746f736c45">ANNOUNCEPOSITION_YES</a>;
<a name="l01470"></a>01470       <span class="keywordflow">else</span>
<a name="l01471"></a>01471          q-&gt;<a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">announceposition</a> = <a class="code" href="app__queue_8c.html#a52464c2ddf292a0a9c91cfc7481b0178">ANNOUNCEPOSITION_NO</a>;
<a name="l01472"></a>01472    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;announce-position-limit&quot;</span>)) {
<a name="l01473"></a>01473       q-&gt;<a class="code" href="structcall__queue.html#a336eac6939e5ebd50b2871148243dee6">announcepositionlimit</a> = atoi(val);
<a name="l01474"></a>01474    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;periodic-announce&quot;</span>)) {
<a name="l01475"></a>01475       <span class="keywordflow">if</span> (strchr(val, <span class="charliteral">&apos;,&apos;</span>)) {
<a name="l01476"></a>01476          <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a> = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(val);
<a name="l01477"></a>01477          <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;
<a name="l01478"></a>01478 
<a name="l01479"></a>01479          <span class="keywordflow">while</span> ((s = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;buf, <span class="stringliteral">&quot;,|&quot;</span>))) {
<a name="l01480"></a>01480             <span class="keywordflow">if</span> (!q-&gt;<a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">sound_periodicannounce</a>[i])
<a name="l01481"></a>01481                q-&gt;<a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">sound_periodicannounce</a>[i] = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(16);
<a name="l01482"></a>01482             <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;q-&gt;<a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">sound_periodicannounce</a>[i], 0, <span class="stringliteral">&quot;%s&quot;</span>, s);
<a name="l01483"></a>01483             i++;
<a name="l01484"></a>01484             <span class="keywordflow">if</span> (i == <a class="code" href="app__queue_8c.html#a2f5d1f6fb6cd3af5e8b07d19e4ab273a">MAX_PERIODIC_ANNOUNCEMENTS</a>)
<a name="l01485"></a>01485                <span class="keywordflow">break</span>;
<a name="l01486"></a>01486          }
<a name="l01487"></a>01487          q-&gt;<a class="code" href="structcall__queue.html#a8e2c16675bb0afd19ebeabbcd4329681">numperiodicannounce</a> = i;
<a name="l01488"></a>01488       } <span class="keywordflow">else</span> {
<a name="l01489"></a>01489          <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;q-&gt;<a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">sound_periodicannounce</a>[0], 0, <span class="stringliteral">&quot;%s&quot;</span>, val);
<a name="l01490"></a>01490          q-&gt;<a class="code" href="structcall__queue.html#a8e2c16675bb0afd19ebeabbcd4329681">numperiodicannounce</a> = 1;
<a name="l01491"></a>01491       }
<a name="l01492"></a>01492    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;periodic-announce-frequency&quot;</span>)) {
<a name="l01493"></a>01493       q-&gt;<a class="code" href="structcall__queue.html#a2a43a68cf8add918260068d677434132">periodicannouncefrequency</a> = atoi(val);
<a name="l01494"></a>01494    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;random-periodic-announce&quot;</span>)) {
<a name="l01495"></a>01495       q-&gt;<a class="code" href="structcall__queue.html#a3991228a9e7540246c6cc4cf42c0794d">randomperiodicannounce</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l01496"></a>01496    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;retry&quot;</span>)) {
<a name="l01497"></a>01497       q-&gt;<a class="code" href="structcall__queue.html#addf2eb79daee1e400c823a699b0f856b">retry</a> = atoi(val);
<a name="l01498"></a>01498       <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#addf2eb79daee1e400c823a699b0f856b">retry</a> &lt;= 0)
<a name="l01499"></a>01499          q-&gt;<a class="code" href="structcall__queue.html#addf2eb79daee1e400c823a699b0f856b">retry</a> = <a class="code" href="app__queue_8c.html#a3f1683ed5a30b46922e3f88b7c716e04">DEFAULT_RETRY</a>;
<a name="l01500"></a>01500    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;wrapuptime&quot;</span>)) {
<a name="l01501"></a>01501       q-&gt;<a class="code" href="structcall__queue.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> = atoi(val);
<a name="l01502"></a>01502    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;autofill&quot;</span>)) {
<a name="l01503"></a>01503       q-&gt;<a class="code" href="structcall__queue.html#a76e20f3c9df399ad87bb4e45c7419e99">autofill</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l01504"></a>01504    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;monitor-type&quot;</span>)) {
<a name="l01505"></a>01505       <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;mixmonitor&quot;</span>))
<a name="l01506"></a>01506          q-&gt;<a class="code" href="structcall__queue.html#a7ccaa047c703f95f5eaf0dd0a10670b5">montype</a> = 1;
<a name="l01507"></a>01507    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;autopause&quot;</span>)) {
<a name="l01508"></a>01508       q-&gt;<a class="code" href="structcall__queue.html#a4092d0238a0a8aa7aeaf503a7f0e6380">autopause</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l01509"></a>01509    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;maxlen&quot;</span>)) {
<a name="l01510"></a>01510       q-&gt;<a class="code" href="structcall__queue.html#a245b5bee0d02a20222d815dbeaaac0fb">maxlen</a> = atoi(val);
<a name="l01511"></a>01511       <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a245b5bee0d02a20222d815dbeaaac0fb">maxlen</a> &lt; 0)
<a name="l01512"></a>01512          q-&gt;<a class="code" href="structcall__queue.html#a245b5bee0d02a20222d815dbeaaac0fb">maxlen</a> = 0;
<a name="l01513"></a>01513    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;servicelevel&quot;</span>)) {
<a name="l01514"></a>01514       q-&gt;<a class="code" href="structcall__queue.html#a6293d1622ff45ccac3a1679171376856">servicelevel</a>= atoi(val);
<a name="l01515"></a>01515    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;strategy&quot;</span>)) {
<a name="l01516"></a>01516       <span class="keywordtype">int</span> <a class="code" href="structstrategy.html">strategy</a>;
<a name="l01517"></a>01517 
<a name="l01518"></a>01518       <span class="comment">/* We are a static queue and already have set this, no need to do it again */</span>
<a name="l01519"></a>01519       <span class="keywordflow">if</span> (failunknown) {
<a name="l01520"></a>01520          <span class="keywordflow">return</span>;
<a name="l01521"></a>01521       }
<a name="l01522"></a>01522       strategy = <a class="code" href="app__queue_8c.html#aeee3b4385050286dedc0e20f247d428c">strat2int</a>(val);
<a name="l01523"></a>01523       <span class="keywordflow">if</span> (strategy &lt; 0) {
<a name="l01524"></a>01524          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;&apos;%s&apos; isn&apos;t a valid strategy for queue &apos;%s&apos;, using ringall instead\n&quot;</span>,
<a name="l01525"></a>01525             val, q-&gt;name);
<a name="l01526"></a>01526          q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> = <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>;
<a name="l01527"></a>01527       }
<a name="l01528"></a>01528       <span class="keywordflow">if</span> (strategy == q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a>) {
<a name="l01529"></a>01529          <span class="keywordflow">return</span>;
<a name="l01530"></a>01530       }
<a name="l01531"></a>01531       <span class="keywordflow">if</span> (strategy == <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba49bae9dfad805972b20763389a090d09">QUEUE_STRATEGY_LINEAR</a>) {
<a name="l01532"></a>01532          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Changing to the linear strategy currently requires asterisk to be restarted.\n&quot;</span>);
<a name="l01533"></a>01533          <span class="keywordflow">return</span>;
<a name="l01534"></a>01534       }
<a name="l01535"></a>01535       q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> = strategy;
<a name="l01536"></a>01536    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;joinempty&quot;</span>)) {
<a name="l01537"></a>01537       <a class="code" href="app__queue_8c.html#a2faf444ec9b83e1847ac166c994ba3a8">parse_empty_options</a>(val, &amp;q-&gt;<a class="code" href="structcall__queue.html#ab95f2fa73d00493b2fa1fc26eb37dc24">joinempty</a>, 1);
<a name="l01538"></a>01538    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;leavewhenempty&quot;</span>)) {
<a name="l01539"></a>01539       <a class="code" href="app__queue_8c.html#a2faf444ec9b83e1847ac166c994ba3a8">parse_empty_options</a>(val, &amp;q-&gt;<a class="code" href="structcall__queue.html#a77bab4023f1969460cc9c64baa39e016">leavewhenempty</a>, 0);
<a name="l01540"></a>01540    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;eventmemberstatus&quot;</span>)) {
<a name="l01541"></a>01541       q-&gt;<a class="code" href="structcall__queue.html#a1cea13bb2b7ec038aa54d2c1f50ffc75">maskmemberstatus</a> = !<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l01542"></a>01542    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;eventwhencalled&quot;</span>)) {
<a name="l01543"></a>01543       <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;vars&quot;</span>)) {
<a name="l01544"></a>01544          q-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a> = <a class="code" href="app__queue_8c.html#a533ee4344c442cf6da3e610598ecca75">QUEUE_EVENT_VARIABLES</a>;
<a name="l01545"></a>01545       } <span class="keywordflow">else</span> {
<a name="l01546"></a>01546          q-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val) ? 1 : 0;
<a name="l01547"></a>01547       }
<a name="l01548"></a>01548    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;reportholdtime&quot;</span>)) {
<a name="l01549"></a>01549       q-&gt;<a class="code" href="structcall__queue.html#a20ba21c586c791a31ef97102b4811a8f">reportholdtime</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l01550"></a>01550    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;memberdelay&quot;</span>)) {
<a name="l01551"></a>01551       q-&gt;<a class="code" href="structcall__queue.html#adc032ac2dcea31bd708fc762f42c385e">memberdelay</a> = atoi(val);
<a name="l01552"></a>01552    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;weight&quot;</span>)) {
<a name="l01553"></a>01553       q-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a> = atoi(val);
<a name="l01554"></a>01554    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;timeoutrestart&quot;</span>)) {
<a name="l01555"></a>01555       q-&gt;<a class="code" href="structcall__queue.html#a24cf7a74d65e1d4f4b9bfd16455187fb">timeoutrestart</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l01556"></a>01556    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;defaultrule&quot;</span>)) {
<a name="l01557"></a>01557       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, defaultrule, val);
<a name="l01558"></a>01558    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">&quot;timeoutpriority&quot;</span>)) {
<a name="l01559"></a>01559       <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;conf&quot;</span>)) {
<a name="l01560"></a>01560          q-&gt;<a class="code" href="structcall__queue.html#af983858a2192f96c9a30e44467b87f61">timeoutpriority</a> = <a class="code" href="app__queue_8c.html#a452e8221d8fbd54db8c589265a09e844a94a7510a93b7241883228503227335af">TIMEOUT_PRIORITY_CONF</a>;
<a name="l01561"></a>01561       } <span class="keywordflow">else</span> {
<a name="l01562"></a>01562          q-&gt;<a class="code" href="structcall__queue.html#af983858a2192f96c9a30e44467b87f61">timeoutpriority</a> = <a class="code" href="app__queue_8c.html#a452e8221d8fbd54db8c589265a09e844aabaf51de14755cf9b47a42c3cc460a87">TIMEOUT_PRIORITY_APP</a>;
<a name="l01563"></a>01563       }
<a name="l01564"></a>01564    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (failunknown) {
<a name="l01565"></a>01565       <span class="keywordflow">if</span> (linenum &gt;= 0) {
<a name="l01566"></a>01566          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown keyword in queue &apos;%s&apos;: %s at line %d of queues.conf\n&quot;</span>,
<a name="l01567"></a>01567             q-&gt;name, param, linenum);
<a name="l01568"></a>01568       } <span class="keywordflow">else</span> {
<a name="l01569"></a>01569          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown keyword in queue &apos;%s&apos;: %s\n&quot;</span>, q-&gt;name, param);
<a name="l01570"></a>01570       }
<a name="l01571"></a>01571    }
<a name="l01572"></a>01572 }
<a name="l01573"></a>01573 <span class="comment"></span>
<a name="l01574"></a>01574 <span class="comment">/*!</span>
<a name="l01575"></a>01575 <span class="comment"> * \brief Find rt member record to update otherwise create one.</span>
<a name="l01576"></a>01576 <span class="comment"> *</span>
<a name="l01577"></a>01577 <span class="comment"> * Search for member in queue, if found update penalty/paused state,</span>
<a name="l01578"></a>01578 <span class="comment"> * if no member exists create one flag it as a RT member and add to queue member list. </span>
<a name="l01579"></a>01579 <span class="comment">*/</span>
<a name="l01580"></a><a class="code" href="app__queue_8c.html#a53b38db7a432673d9a53fd0acd39d415">01580</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a53b38db7a432673d9a53fd0acd39d415" title="Find rt member record to update otherwise create one.">rt_handle_member_record</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q, <span class="keywordtype">char</span> *interface, <span class="keyword">const</span> <span class="keywordtype">char</span> *rt_uniqueid, <span class="keyword">const</span> <span class="keywordtype">char</span> *membername, <span class="keyword">const</span> <span class="keywordtype">char</span> *penalty_str, <span class="keyword">const</span> <span class="keywordtype">char</span> *paused_str, <span class="keyword">const</span> <span class="keywordtype">char</span>* state_interface)
<a name="l01581"></a>01581 {
<a name="l01582"></a>01582    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *m;
<a name="l01583"></a>01583    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l01584"></a>01584    <span class="keywordtype">int</span> penalty = 0;
<a name="l01585"></a>01585    <span class="keywordtype">int</span> paused  = 0;
<a name="l01586"></a>01586    <span class="keywordtype">int</span> found = 0;
<a name="l01587"></a>01587 
<a name="l01588"></a>01588    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(rt_uniqueid)) {
<a name="l01589"></a>01589       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Realtime field uniqueid is empty for member %s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(membername, <span class="stringliteral">&quot;NULL&quot;</span>));
<a name="l01590"></a>01590       <span class="keywordflow">return</span>;
<a name="l01591"></a>01591    }
<a name="l01592"></a>01592 
<a name="l01593"></a>01593    <span class="keywordflow">if</span> (penalty_str) {
<a name="l01594"></a>01594       penalty = atoi(penalty_str);
<a name="l01595"></a>01595       <span class="keywordflow">if</span> (penalty &lt; 0)
<a name="l01596"></a>01596          penalty = 0;
<a name="l01597"></a>01597    }
<a name="l01598"></a>01598 
<a name="l01599"></a>01599    <span class="keywordflow">if</span> (paused_str) {
<a name="l01600"></a>01600       paused = atoi(paused_str);
<a name="l01601"></a>01601       <span class="keywordflow">if</span> (paused &lt; 0)
<a name="l01602"></a>01602          paused = 0;
<a name="l01603"></a>01603    }
<a name="l01604"></a>01604 
<a name="l01605"></a>01605    <span class="comment">/* Find member by realtime uniqueid and update */</span>
<a name="l01606"></a>01606    mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l01607"></a>01607    <span class="keywordflow">while</span> ((m = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l01608"></a>01608       <span class="keywordflow">if</span> (!strcasecmp(m-&gt;<a class="code" href="structmember.html#a5a242f61697cefa27ec3ce5082e2cd23">rt_uniqueid</a>, rt_uniqueid)) {
<a name="l01609"></a>01609          m-&gt;<a class="code" href="structmember.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a> = 0;   <span class="comment">/* Do not delete this one. */</span>
<a name="l01610"></a>01610          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(m-&gt;<a class="code" href="structmember.html#a5a242f61697cefa27ec3ce5082e2cd23">rt_uniqueid</a>, rt_uniqueid, <span class="keyword">sizeof</span>(m-&gt;<a class="code" href="structmember.html#a5a242f61697cefa27ec3ce5082e2cd23">rt_uniqueid</a>));
<a name="l01611"></a>01611          <span class="keywordflow">if</span> (paused_str)
<a name="l01612"></a>01612             m-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a> = paused;
<a name="l01613"></a>01613          <span class="keywordflow">if</span> (strcasecmp(state_interface, m-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>)) {
<a name="l01614"></a>01614             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(m-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>, state_interface, <span class="keyword">sizeof</span>(m-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>));
<a name="l01615"></a>01615          }     
<a name="l01616"></a>01616          m-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> = penalty;
<a name="l01617"></a>01617          found = 1;
<a name="l01618"></a>01618          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l01619"></a>01619          <span class="keywordflow">break</span>;
<a name="l01620"></a>01620       }
<a name="l01621"></a>01621       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l01622"></a>01622    }
<a name="l01623"></a>01623    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l01624"></a>01624 
<a name="l01625"></a>01625    <span class="comment">/* Create a new member */</span>
<a name="l01626"></a>01626    <span class="keywordflow">if</span> (!found) {
<a name="l01627"></a>01627       <span class="keywordflow">if</span> ((m = <a class="code" href="app__queue_8c.html#a8cfa1185143485f4531932cf8970555e" title="allocate space for new queue member and set fields based on parameters passed">create_queue_member</a>(interface, membername, penalty, paused, state_interface))) {
<a name="l01628"></a>01628          m-&gt;<a class="code" href="structmember.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a> = 0;
<a name="l01629"></a>01629          m-&gt;<a class="code" href="structmember.html#aac1ae37fa4007496a50df75cf1f698c1">realtime</a> = 1;
<a name="l01630"></a>01630          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(m-&gt;<a class="code" href="structmember.html#a5a242f61697cefa27ec3ce5082e2cd23">rt_uniqueid</a>, rt_uniqueid, <span class="keyword">sizeof</span>(m-&gt;<a class="code" href="structmember.html#a5a242f61697cefa27ec3ce5082e2cd23">rt_uniqueid</a>));
<a name="l01631"></a>01631          <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(q-&gt;name, <span class="stringliteral">&quot;REALTIME&quot;</span>, m-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, <span class="stringliteral">&quot;ADDMEMBER&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01632"></a>01632          <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, m);
<a name="l01633"></a>01633          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l01634"></a>01634          m = NULL;
<a name="l01635"></a>01635          q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>++;
<a name="l01636"></a>01636       }
<a name="l01637"></a>01637    }
<a name="l01638"></a>01638 }
<a name="l01639"></a>01639 <span class="comment"></span>
<a name="l01640"></a>01640 <span class="comment">/*! \brief Iterate through queue&apos;s member list and delete them */</span>
<a name="l01641"></a><a class="code" href="app__queue_8c.html#a8821eb9b47e097bb4696445a321d5e4a">01641</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a8821eb9b47e097bb4696445a321d5e4a" title="Iterate through queue&amp;#39;s member list and delete them.">free_members</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q, <span class="keywordtype">int</span> all)
<a name="l01642"></a>01642 {
<a name="l01643"></a>01643    <span class="comment">/* Free non-dynamic members */</span>
<a name="l01644"></a>01644    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *cur;
<a name="l01645"></a>01645    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l01646"></a>01646 
<a name="l01647"></a>01647    <span class="keywordflow">while</span> ((cur = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l01648"></a>01648       <span class="keywordflow">if</span> (all || !cur-&gt;<a class="code" href="structmember.html#a44690a0a629211d7620ce0d55c412e9d">dynamic</a>) {
<a name="l01649"></a>01649          <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, cur);
<a name="l01650"></a>01650          q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>--;
<a name="l01651"></a>01651       }
<a name="l01652"></a>01652       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(cur, -1);
<a name="l01653"></a>01653    }
<a name="l01654"></a>01654    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l01655"></a>01655 }
<a name="l01656"></a>01656 <span class="comment"></span>
<a name="l01657"></a>01657 <span class="comment">/*! \brief Free queue&apos;s member list then its string fields */</span>
<a name="l01658"></a><a class="code" href="app__queue_8c.html#ae3a7c6d80cb3aad8b62a77b6b9a3946a">01658</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#ae3a7c6d80cb3aad8b62a77b6b9a3946a" title="Free queue&amp;#39;s member list then its string fields.">destroy_queue</a>(<span class="keywordtype">void</span> *<a class="code" href="structao2__iterator.html#aa919482768c0eac179575481f77e0fa3">obj</a>)
<a name="l01659"></a>01659 {
<a name="l01660"></a>01660    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q = obj;
<a name="l01661"></a>01661    <span class="keywordtype">int</span> i;
<a name="l01662"></a>01662 
<a name="l01663"></a>01663    <a class="code" href="app__queue_8c.html#a8821eb9b47e097bb4696445a321d5e4a" title="Iterate through queue&amp;#39;s member list and delete them.">free_members</a>(q, 1);
<a name="l01664"></a>01664    <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(q);
<a name="l01665"></a>01665    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="app__queue_8c.html#a2f5d1f6fb6cd3af5e8b07d19e4ab273a">MAX_PERIODIC_ANNOUNCEMENTS</a>; i++) {
<a name="l01666"></a>01666       <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">sound_periodicannounce</a>[i])
<a name="l01667"></a>01667          <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(q-&gt;<a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">sound_periodicannounce</a>[i]);
<a name="l01668"></a>01668    }
<a name="l01669"></a>01669    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, -1);
<a name="l01670"></a>01670 }
<a name="l01671"></a>01671 
<a name="l01672"></a><a class="code" href="app__queue_8c.html#a73f936847e6ad20cb842d03593dc47c4">01672</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *<a class="code" href="app__queue_8c.html#a73f936847e6ad20cb842d03593dc47c4">alloc_queue</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *queuename)
<a name="l01673"></a>01673 {
<a name="l01674"></a>01674    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l01675"></a>01675 
<a name="l01676"></a>01676    <span class="keywordflow">if</span> ((q = <a class="code" href="astobj2_8h.html#ad57326008c326db88dc36779741622b8" title="Allocate and initialize an object.">ao2_t_alloc</a>(<span class="keyword">sizeof</span>(*q), <a class="code" href="app__queue_8c.html#ae3a7c6d80cb3aad8b62a77b6b9a3946a" title="Free queue&amp;#39;s member list then its string fields.">destroy_queue</a>, <span class="stringliteral">&quot;Allocate queue&quot;</span>))) {
<a name="l01677"></a>01677       <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(q, 64)) {
<a name="l01678"></a>01678          <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;String field allocation failed&quot;</span>);
<a name="l01679"></a>01679          <span class="keywordflow">return</span> NULL;
<a name="l01680"></a>01680       }
<a name="l01681"></a>01681       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(q, name, queuename);
<a name="l01682"></a>01682    }
<a name="l01683"></a>01683    <span class="keywordflow">return</span> q;
<a name="l01684"></a>01684 }
<a name="l01685"></a>01685 <span class="comment"></span>
<a name="l01686"></a>01686 <span class="comment">/*!</span>
<a name="l01687"></a>01687 <span class="comment"> * \brief Reload a single queue via realtime.</span>
<a name="l01688"></a>01688 <span class="comment"> *</span>
<a name="l01689"></a>01689 <span class="comment"> * Check for statically defined queue first, check if deleted RT queue,</span>
<a name="l01690"></a>01690 <span class="comment"> * check for new RT queue, if queue vars are not defined init them with defaults.</span>
<a name="l01691"></a>01691 <span class="comment"> * reload RT queue vars, set RT queue members dead and reload them, return finished queue.</span>
<a name="l01692"></a>01692 <span class="comment"> * \retval the queue, </span>
<a name="l01693"></a>01693 <span class="comment"> * \retval NULL if it doesn&apos;t exist.</span>
<a name="l01694"></a>01694 <span class="comment"> * \note Should be called with the &quot;queues&quot; container locked. </span>
<a name="l01695"></a>01695 <span class="comment">*/</span>
<a name="l01696"></a><a class="code" href="app__queue_8c.html#ad3dd27f57e607377bad90d16cde6693b">01696</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *<a class="code" href="app__queue_8c.html#ad3dd27f57e607377bad90d16cde6693b" title="Reload a single queue via realtime.">find_queue_by_name_rt</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *queuename, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *queue_vars, <span class="keyword">struct</span> <a class="code" href="structast__config.html">ast_config</a> *member_config)
<a name="l01697"></a>01697 {
<a name="l01698"></a>01698    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l01699"></a>01699    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q, tmpq = {
<a name="l01700"></a>01700       .name = queuename,   
<a name="l01701"></a>01701    };
<a name="l01702"></a>01702    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *m;
<a name="l01703"></a>01703    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l01704"></a>01704    <span class="keywordtype">char</span> *interface = NULL;
<a name="l01705"></a>01705    <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp_name;
<a name="l01706"></a>01706    <span class="keywordtype">char</span> *tmp;
<a name="l01707"></a>01707    <span class="keywordtype">char</span> tmpbuf[64];  <span class="comment">/* Must be longer than the longest queue param name. */</span>
<a name="l01708"></a>01708 
<a name="l01709"></a>01709    <span class="comment">/* Static queues override realtime. */</span>
<a name="l01710"></a>01710    <span class="keywordflow">if</span> ((q = <a class="code" href="astobj2_8h.html#a804bb959fec31c062b3848316b8e80b1">ao2_t_find</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, &amp;tmpq, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>, <span class="stringliteral">&quot;Check if static queue exists&quot;</span>))) {
<a name="l01711"></a>01711       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l01712"></a>01712       <span class="keywordflow">if</span> (!q-&gt;<a class="code" href="structcall__queue.html#a53e750a536c8270e37bbdd35a9def3d4">realtime</a>) {
<a name="l01713"></a>01713          <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a>) {
<a name="l01714"></a>01714             <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l01715"></a>01715             <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Queue is dead; can&apos;t return it&quot;</span>);
<a name="l01716"></a>01716             <span class="keywordflow">return</span> NULL;
<a name="l01717"></a>01717          } <span class="keywordflow">else</span> {
<a name="l01718"></a>01718             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Static queue &apos;%s&apos; already exists. Not loading from realtime\n&quot;</span>, q-&gt;name);
<a name="l01719"></a>01719             <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l01720"></a>01720             <span class="keywordflow">return</span> q;
<a name="l01721"></a>01721          }
<a name="l01722"></a>01722       }
<a name="l01723"></a>01723    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!member_config)
<a name="l01724"></a>01724       <span class="comment">/* Not found in the list, and it&apos;s not realtime ... */</span>
<a name="l01725"></a>01725       <span class="keywordflow">return</span> NULL;
<a name="l01726"></a>01726 
<a name="l01727"></a>01727    <span class="comment">/* Check if queue is defined in realtime. */</span>
<a name="l01728"></a>01728    <span class="keywordflow">if</span> (!queue_vars) {
<a name="l01729"></a>01729       <span class="comment">/* Delete queue from in-core list if it has been deleted in realtime. */</span>
<a name="l01730"></a>01730       <span class="keywordflow">if</span> (q) {<span class="comment"></span>
<a name="l01731"></a>01731 <span class="comment">         /*! \note Hmm, can&apos;t seem to distinguish a DB failure from a not</span>
<a name="l01732"></a>01732 <span class="comment">            found condition... So we might delete an in-core queue</span>
<a name="l01733"></a>01733 <span class="comment">            in case of DB failure. */</span>
<a name="l01734"></a>01734          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Queue %s not found in realtime.\n&quot;</span>, queuename);
<a name="l01735"></a>01735 
<a name="l01736"></a>01736          q-&gt;<a class="code" href="structcall__queue.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a> = 1;
<a name="l01737"></a>01737          <span class="comment">/* Delete if unused (else will be deleted when last caller leaves). */</span>
<a name="l01738"></a>01738          <a class="code" href="app__queue_8c.html#a677f1c4c1a61e9e02d180803d8b8a008">queues_t_unlink</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, q, <span class="stringliteral">&quot;Unused; removing from container&quot;</span>);
<a name="l01739"></a>01739          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l01740"></a>01740          <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Queue is dead; can&apos;t return it&quot;</span>);
<a name="l01741"></a>01741       }
<a name="l01742"></a>01742       <span class="keywordflow">return</span> NULL;
<a name="l01743"></a>01743    }
<a name="l01744"></a>01744 
<a name="l01745"></a>01745    <span class="comment">/* Create a new queue if an in-core entry does not exist yet. */</span>
<a name="l01746"></a>01746    <span class="keywordflow">if</span> (!q) {
<a name="l01747"></a>01747       <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *tmpvar = NULL;
<a name="l01748"></a>01748       <span class="keywordflow">if</span> (!(q = <a class="code" href="app__queue_8c.html#a73f936847e6ad20cb842d03593dc47c4">alloc_queue</a>(queuename)))
<a name="l01749"></a>01749          <span class="keywordflow">return</span> NULL;
<a name="l01750"></a>01750       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l01751"></a>01751       <a class="code" href="app__queue_8c.html#a3f75910c35a627fb9d15d0024fe0c36b">clear_queue</a>(q);
<a name="l01752"></a>01752       q-&gt;<a class="code" href="structcall__queue.html#a53e750a536c8270e37bbdd35a9def3d4">realtime</a> = 1;
<a name="l01753"></a>01753       q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a> = 0;
<a name="l01754"></a>01754       <span class="comment">/*Before we initialize the queue, we need to set the strategy, so that linear strategy</span>
<a name="l01755"></a>01755 <span class="comment">       * will allocate the members properly</span>
<a name="l01756"></a>01756 <span class="comment">       */</span>
<a name="l01757"></a>01757       <span class="keywordflow">for</span> (tmpvar = queue_vars; tmpvar; tmpvar = tmpvar-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01758"></a>01758          <span class="keywordflow">if</span> (!strcasecmp(tmpvar-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;strategy&quot;</span>)) {
<a name="l01759"></a>01759             q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> = <a class="code" href="app__queue_8c.html#aeee3b4385050286dedc0e20f247d428c">strat2int</a>(tmpvar-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01760"></a>01760             <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> &lt; 0) {
<a name="l01761"></a>01761                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;&apos;%s&apos; isn&apos;t a valid strategy for queue &apos;%s&apos;, using ringall instead\n&quot;</span>,
<a name="l01762"></a>01762                tmpvar-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, q-&gt;name);
<a name="l01763"></a>01763                q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> = <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>;
<a name="l01764"></a>01764             }
<a name="l01765"></a>01765             <span class="keywordflow">break</span>;
<a name="l01766"></a>01766          }
<a name="l01767"></a>01767       }
<a name="l01768"></a>01768       <span class="comment">/* We traversed all variables and didn&apos;t find a strategy */</span>
<a name="l01769"></a>01769       <span class="keywordflow">if</span> (!tmpvar)
<a name="l01770"></a>01770          q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> = <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>;
<a name="l01771"></a>01771       <a class="code" href="app__queue_8c.html#a6d56dcc1f330ae7fe1b5a1ee832077c1">queues_t_link</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, q, <span class="stringliteral">&quot;Add queue to container&quot;</span>);
<a name="l01772"></a>01772    }
<a name="l01773"></a>01773    <a class="code" href="app__queue_8c.html#aa76378a6ff09ce40268e214fdae6a61d" title="Initialize Queue default values.">init_queue</a>(q);    <span class="comment">/* Ensure defaults for all parameters not set explicitly. */</span>
<a name="l01774"></a>01774 
<a name="l01775"></a>01775    memset(tmpbuf, 0, <span class="keyword">sizeof</span>(tmpbuf));
<a name="l01776"></a>01776    <span class="keywordflow">for</span> (v = queue_vars; v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01777"></a>01777       <span class="comment">/* Convert to dashes `-&apos; from underscores `_&apos; as the latter are more SQL friendly. */</span>
<a name="l01778"></a>01778       <span class="keywordflow">if</span> ((tmp = strchr(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="charliteral">&apos;_&apos;</span>))) {
<a name="l01779"></a>01779          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmpbuf, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="keyword">sizeof</span>(tmpbuf));
<a name="l01780"></a>01780          tmp_name = tmpbuf;
<a name="l01781"></a>01781          tmp = tmpbuf;
<a name="l01782"></a>01782          <span class="keywordflow">while</span> ((tmp = strchr(tmp, <span class="charliteral">&apos;_&apos;</span>)))
<a name="l01783"></a>01783             *tmp++ = <span class="charliteral">&apos;-&apos;</span>;
<a name="l01784"></a>01784       } <span class="keywordflow">else</span>
<a name="l01785"></a>01785          tmp_name = v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;
<a name="l01786"></a>01786 
<a name="l01787"></a>01787       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l01788"></a>01788          <span class="comment">/* Don&apos;t want to try to set the option if the value is empty */</span>
<a name="l01789"></a>01789          <a class="code" href="app__queue_8c.html#a94baaee180e6f6ae082418dc78e7c7cf" title="Configure a queue parameter.">queue_set_param</a>(q, tmp_name, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, -1, 0);
<a name="l01790"></a>01790       }
<a name="l01791"></a>01791    }
<a name="l01792"></a>01792 
<a name="l01793"></a>01793    <span class="comment">/* Temporarily set realtime members dead so we can detect deleted ones. </span>
<a name="l01794"></a>01794 <span class="comment">    * Also set the membercount correctly for realtime*/</span>
<a name="l01795"></a>01795    mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l01796"></a>01796    <span class="keywordflow">while</span> ((m = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l01797"></a>01797       q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>++;
<a name="l01798"></a>01798       <span class="keywordflow">if</span> (m-&gt;<a class="code" href="structmember.html#aac1ae37fa4007496a50df75cf1f698c1">realtime</a>)
<a name="l01799"></a>01799          m-&gt;<a class="code" href="structmember.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a> = 1;
<a name="l01800"></a>01800       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l01801"></a>01801    }
<a name="l01802"></a>01802    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l01803"></a>01803 
<a name="l01804"></a>01804    <span class="keywordflow">while</span> ((interface = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(member_config, interface))) {
<a name="l01805"></a>01805       <a class="code" href="app__queue_8c.html#a53b38db7a432673d9a53fd0acd39d415" title="Find rt member record to update otherwise create one.">rt_handle_member_record</a>(q, interface,
<a name="l01806"></a>01806          <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(member_config, interface, <span class="stringliteral">&quot;uniqueid&quot;</span>),
<a name="l01807"></a>01807          <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(member_config, interface, <span class="stringliteral">&quot;membername&quot;</span>),interface),
<a name="l01808"></a>01808          <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(member_config, interface, <span class="stringliteral">&quot;penalty&quot;</span>),
<a name="l01809"></a>01809          <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(member_config, interface, <span class="stringliteral">&quot;paused&quot;</span>),
<a name="l01810"></a>01810          <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(member_config, interface, <span class="stringliteral">&quot;state_interface&quot;</span>),interface));
<a name="l01811"></a>01811    }
<a name="l01812"></a>01812 
<a name="l01813"></a>01813    <span class="comment">/* Delete all realtime members that have been deleted in DB. */</span>
<a name="l01814"></a>01814    mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l01815"></a>01815    <span class="keywordflow">while</span> ((m = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l01816"></a>01816       <span class="keywordflow">if</span> (m-&gt;<a class="code" href="structmember.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a>) {
<a name="l01817"></a>01817          <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(q-&gt;name, <span class="stringliteral">&quot;REALTIME&quot;</span>, m-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, <span class="stringliteral">&quot;REMOVEMEMBER&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01818"></a>01818          <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, m);
<a name="l01819"></a>01819          q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>--;
<a name="l01820"></a>01820       }
<a name="l01821"></a>01821       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l01822"></a>01822    }
<a name="l01823"></a>01823    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l01824"></a>01824 
<a name="l01825"></a>01825    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l01826"></a>01826 
<a name="l01827"></a>01827    <span class="keywordflow">return</span> q;
<a name="l01828"></a>01828 }
<a name="l01829"></a>01829 
<a name="l01830"></a><a class="code" href="app__queue_8c.html#a9944f03f3b77344b38927628150d3ab7">01830</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *<a class="code" href="app__queue_8c.html#a9944f03f3b77344b38927628150d3ab7">load_realtime_queue</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *queuename)
<a name="l01831"></a>01831 {
<a name="l01832"></a>01832    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *queue_vars;
<a name="l01833"></a>01833    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *member_config = NULL;
<a name="l01834"></a>01834    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q = NULL, tmpq = {
<a name="l01835"></a>01835       .name = queuename,   
<a name="l01836"></a>01836    };
<a name="l01837"></a>01837    <span class="keywordtype">int</span> prev_weight = 0;
<a name="l01838"></a>01838 
<a name="l01839"></a>01839    <span class="comment">/* Find the queue in the in-core list first. */</span>
<a name="l01840"></a>01840    q = <a class="code" href="astobj2_8h.html#a804bb959fec31c062b3848316b8e80b1">ao2_t_find</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, &amp;tmpq, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>, <span class="stringliteral">&quot;Look for queue in memory first&quot;</span>);
<a name="l01841"></a>01841 
<a name="l01842"></a>01842    <span class="keywordflow">if</span> (!q || q-&gt;<a class="code" href="structcall__queue.html#a53e750a536c8270e37bbdd35a9def3d4">realtime</a>) {<span class="comment"></span>
<a name="l01843"></a>01843 <span class="comment">      /*! \note Load from realtime before taking the &quot;queues&quot; container lock, to avoid blocking all</span>
<a name="l01844"></a>01844 <span class="comment">         queue operations while waiting for the DB.</span>
<a name="l01845"></a>01845 <span class="comment"></span>
<a name="l01846"></a>01846 <span class="comment">         This will be two separate database transactions, so we might</span>
<a name="l01847"></a>01847 <span class="comment">         see queue parameters as they were before another process</span>
<a name="l01848"></a>01848 <span class="comment">         changed the queue and member list as it was after the change.</span>
<a name="l01849"></a>01849 <span class="comment">         Thus we might see an empty member list when a queue is</span>
<a name="l01850"></a>01850 <span class="comment">         deleted. In practise, this is unlikely to cause a problem. */</span>
<a name="l01851"></a>01851 
<a name="l01852"></a>01852       queue_vars = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;queues&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, queuename, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l01853"></a>01853       <span class="keywordflow">if</span> (queue_vars) {
<a name="l01854"></a>01854          member_config = <a class="code" href="config_8h.html#a29ff8cd717c0c0bac60abbd827fec409" title="Retrieve realtime configuration.">ast_load_realtime_multientry</a>(<span class="stringliteral">&quot;queue_members&quot;</span>, <span class="stringliteral">&quot;interface LIKE&quot;</span>, <span class="stringliteral">&quot;%&quot;</span>, <span class="stringliteral">&quot;queue_name&quot;</span>, queuename, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l01855"></a>01855          <span class="keywordflow">if</span> (!member_config) {
<a name="l01856"></a>01856             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;no queue_members defined in your config (extconfig.conf).\n&quot;</span>);
<a name="l01857"></a>01857             <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(queue_vars);
<a name="l01858"></a>01858             <span class="keywordflow">return</span> NULL;
<a name="l01859"></a>01859          }
<a name="l01860"></a>01860       }
<a name="l01861"></a>01861       <span class="keywordflow">if</span> (q) {
<a name="l01862"></a>01862          prev_weight = q-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a> ? 1 : 0;
<a name="l01863"></a>01863       }
<a name="l01864"></a>01864 
<a name="l01865"></a>01865       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l01866"></a>01866 
<a name="l01867"></a>01867       q = <a class="code" href="app__queue_8c.html#ad3dd27f57e607377bad90d16cde6693b" title="Reload a single queue via realtime.">find_queue_by_name_rt</a>(queuename, queue_vars, member_config);
<a name="l01868"></a>01868       <span class="keywordflow">if</span> (member_config) {
<a name="l01869"></a>01869          <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(member_config);
<a name="l01870"></a>01870       }
<a name="l01871"></a>01871       <span class="keywordflow">if</span> (queue_vars) {
<a name="l01872"></a>01872          <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(queue_vars);
<a name="l01873"></a>01873       }
<a name="l01874"></a>01874       <span class="comment">/* update the use_weight value if the queue&apos;s has gained or lost a weight */</span> 
<a name="l01875"></a>01875       <span class="keywordflow">if</span> (q) {
<a name="l01876"></a>01876          <span class="keywordflow">if</span> (!q-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a> &amp;&amp; prev_weight) {
<a name="l01877"></a>01877             <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;use_weight, -1);
<a name="l01878"></a>01878          }
<a name="l01879"></a>01879          <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a> &amp;&amp; !prev_weight) {
<a name="l01880"></a>01880             <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;use_weight, +1);
<a name="l01881"></a>01881          }
<a name="l01882"></a>01882       }
<a name="l01883"></a>01883       <span class="comment">/* Other cases will end up with the proper value for use_weight */</span>
<a name="l01884"></a>01884       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l01885"></a>01885 
<a name="l01886"></a>01886    } <span class="keywordflow">else</span> {
<a name="l01887"></a>01887       <a class="code" href="app__queue_8c.html#ad4d94a7a9e04ddf7984d69a8737221f9">update_realtime_members</a>(q);
<a name="l01888"></a>01888    }
<a name="l01889"></a>01889    <span class="keywordflow">return</span> q;
<a name="l01890"></a>01890 }
<a name="l01891"></a>01891 
<a name="l01892"></a><a class="code" href="app__queue_8c.html#abc63b07b1a30653be5a5f722ce7ee39c">01892</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#abc63b07b1a30653be5a5f722ce7ee39c">update_realtime_member_field</a>(<span class="keyword">struct</span> <a class="code" href="structmember.html">member</a> *mem, <span class="keyword">const</span> <span class="keywordtype">char</span> *queue_name, <span class="keyword">const</span> <span class="keywordtype">char</span> *field, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l01893"></a>01893 {
<a name="l01894"></a>01894    <span class="keywordtype">int</span> ret = -1;
<a name="l01895"></a>01895 
<a name="l01896"></a>01896    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mem-&gt;<a class="code" href="structmember.html#a5a242f61697cefa27ec3ce5082e2cd23">rt_uniqueid</a>))
<a name="l01897"></a>01897       <span class="keywordflow">return</span> ret;
<a name="l01898"></a>01898 
<a name="l01899"></a>01899    <span class="keywordflow">if</span> ((<a class="code" href="config_8h.html#ab845019b2f1bb324ff57e14192d62c39" title="Update realtime configuration.">ast_update_realtime</a>(<span class="stringliteral">&quot;queue_members&quot;</span>, <span class="stringliteral">&quot;uniqueid&quot;</span>, mem-&gt;<a class="code" href="structmember.html#a5a242f61697cefa27ec3ce5082e2cd23">rt_uniqueid</a>, field, value, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>)) &gt; 0)
<a name="l01900"></a>01900       ret = 0;
<a name="l01901"></a>01901 
<a name="l01902"></a>01902    <span class="keywordflow">return</span> ret;
<a name="l01903"></a>01903 }
<a name="l01904"></a>01904 
<a name="l01905"></a>01905 
<a name="l01906"></a><a class="code" href="app__queue_8c.html#ad4d94a7a9e04ddf7984d69a8737221f9">01906</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#ad4d94a7a9e04ddf7984d69a8737221f9">update_realtime_members</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q)
<a name="l01907"></a>01907 {
<a name="l01908"></a>01908    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *member_config = NULL;
<a name="l01909"></a>01909    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *m;
<a name="l01910"></a>01910    <span class="keywordtype">char</span> *<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a> = NULL;
<a name="l01911"></a>01911    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l01912"></a>01912 
<a name="l01913"></a>01913    <span class="keywordflow">if</span> (!(member_config = <a class="code" href="config_8h.html#a29ff8cd717c0c0bac60abbd827fec409" title="Retrieve realtime configuration.">ast_load_realtime_multientry</a>(<span class="stringliteral">&quot;queue_members&quot;</span>, <span class="stringliteral">&quot;interface LIKE&quot;</span>, <span class="stringliteral">&quot;%&quot;</span>, <span class="stringliteral">&quot;queue_name&quot;</span>, q-&gt;name , <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>))) {
<a name="l01914"></a>01914       <span class="comment">/*This queue doesn&apos;t have realtime members*/</span>
<a name="l01915"></a>01915       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Queue %s has no realtime members defined. No need for update\n&quot;</span>, q-&gt;name);
<a name="l01916"></a>01916       <span class="keywordflow">return</span>;
<a name="l01917"></a>01917    }
<a name="l01918"></a>01918 
<a name="l01919"></a>01919    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l01920"></a>01920    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l01921"></a>01921    
<a name="l01922"></a>01922    <span class="comment">/* Temporarily set realtime  members dead so we can detect deleted ones.*/</span> 
<a name="l01923"></a>01923    mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l01924"></a>01924    <span class="keywordflow">while</span> ((m = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l01925"></a>01925       <span class="keywordflow">if</span> (m-&gt;<a class="code" href="structmember.html#aac1ae37fa4007496a50df75cf1f698c1">realtime</a>)
<a name="l01926"></a>01926          m-&gt;<a class="code" href="structmember.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a> = 1;
<a name="l01927"></a>01927       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l01928"></a>01928    }
<a name="l01929"></a>01929    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l01930"></a>01930 
<a name="l01931"></a>01931    <span class="keywordflow">while</span> ((interface = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(member_config, interface))) {
<a name="l01932"></a>01932       <a class="code" href="app__queue_8c.html#a53b38db7a432673d9a53fd0acd39d415" title="Find rt member record to update otherwise create one.">rt_handle_member_record</a>(q, interface,
<a name="l01933"></a>01933          <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(member_config, interface, <span class="stringliteral">&quot;uniqueid&quot;</span>),
<a name="l01934"></a>01934          <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(member_config, interface, <span class="stringliteral">&quot;membername&quot;</span>), interface),
<a name="l01935"></a>01935          <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(member_config, interface, <span class="stringliteral">&quot;penalty&quot;</span>),
<a name="l01936"></a>01936          <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(member_config, interface, <span class="stringliteral">&quot;paused&quot;</span>),
<a name="l01937"></a>01937          <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(member_config, interface, <span class="stringliteral">&quot;state_interface&quot;</span>), interface));
<a name="l01938"></a>01938    }
<a name="l01939"></a>01939 
<a name="l01940"></a>01940    <span class="comment">/* Delete all realtime members that have been deleted in DB. */</span>
<a name="l01941"></a>01941    mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l01942"></a>01942    <span class="keywordflow">while</span> ((m = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l01943"></a>01943       <span class="keywordflow">if</span> (m-&gt;<a class="code" href="structmember.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a>) {
<a name="l01944"></a>01944          <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(q-&gt;name, <span class="stringliteral">&quot;REALTIME&quot;</span>, m-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, <span class="stringliteral">&quot;REMOVEMEMBER&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01945"></a>01945          <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, m);
<a name="l01946"></a>01946          q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>--;
<a name="l01947"></a>01947       }
<a name="l01948"></a>01948       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l01949"></a>01949    }
<a name="l01950"></a>01950    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l01951"></a>01951    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l01952"></a>01952    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l01953"></a>01953    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(member_config);
<a name="l01954"></a>01954 }
<a name="l01955"></a>01955 
<a name="l01956"></a><a class="code" href="app__queue_8c.html#aaf5770fac8f13bed203f66971d2cdc23">01956</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#aaf5770fac8f13bed203f66971d2cdc23">join_queue</a>(<span class="keywordtype">char</span> *queuename, <span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2">queue_result</a> *reason)
<a name="l01957"></a>01957 {
<a name="l01958"></a>01958    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l01959"></a>01959    <span class="keyword">struct </span><a class="code" href="structqueue__ent.html">queue_ent</a> *cur, *prev = NULL;
<a name="l01960"></a>01960    <span class="keywordtype">int</span> res = -1;
<a name="l01961"></a>01961    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a> = 0;
<a name="l01962"></a>01962    <span class="keywordtype">int</span> inserted = 0;
<a name="l01963"></a>01963 
<a name="l01964"></a>01964    <span class="keywordflow">if</span> (!(q = <a class="code" href="app__queue_8c.html#a9944f03f3b77344b38927628150d3ab7">load_realtime_queue</a>(queuename)))
<a name="l01965"></a>01965       <span class="keywordflow">return</span> res;
<a name="l01966"></a>01966 
<a name="l01967"></a>01967    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l01968"></a>01968    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l01969"></a>01969 
<a name="l01970"></a>01970    <span class="comment">/* This is our one */</span>
<a name="l01971"></a>01971    <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#ab95f2fa73d00493b2fa1fc26eb37dc24">joinempty</a>) {
<a name="l01972"></a>01972       <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 0;
<a name="l01973"></a>01973       <span class="keywordflow">if</span> ((status = <a class="code" href="app__queue_8c.html#ac038b08379d8bdb21a862f1bafe729d4" title="Check if members are available.">get_member_status</a>(q, qe-&gt;<a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a>, q-&gt;<a class="code" href="structcall__queue.html#ab95f2fa73d00493b2fa1fc26eb37dc24">joinempty</a>))) {
<a name="l01974"></a>01974          *reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2aed848300d343eb61491e3ddc2e562b9e">QUEUE_JOINEMPTY</a>;
<a name="l01975"></a>01975          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l01976"></a>01976          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l01977"></a>01977          <span class="keywordflow">return</span> res;
<a name="l01978"></a>01978       }
<a name="l01979"></a>01979    }
<a name="l01980"></a>01980    <span class="keywordflow">if</span> (*reason == <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a49a10204f0f100fb6ae669936e01a90c">QUEUE_UNKNOWN</a> &amp;&amp; q-&gt;<a class="code" href="structcall__queue.html#a245b5bee0d02a20222d815dbeaaac0fb">maxlen</a> &amp;&amp; (q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> &gt;= q-&gt;<a class="code" href="structcall__queue.html#a245b5bee0d02a20222d815dbeaaac0fb">maxlen</a>))
<a name="l01981"></a>01981       *reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a131d9c4fe1d72d7b5f8532708ae18285">QUEUE_FULL</a>;
<a name="l01982"></a>01982    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*reason == <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a49a10204f0f100fb6ae669936e01a90c">QUEUE_UNKNOWN</a>) {
<a name="l01983"></a>01983       <span class="comment">/* There&apos;s space for us, put us at the right position inside</span>
<a name="l01984"></a>01984 <span class="comment">       * the queue.</span>
<a name="l01985"></a>01985 <span class="comment">       * Take into account the priority of the calling user */</span>
<a name="l01986"></a>01986       inserted = 0;
<a name="l01987"></a>01987       prev = NULL;
<a name="l01988"></a>01988       cur = q-&gt;<a class="code" href="structcall__queue.html#a4cee904f94736300a8eba28cc5763bed">head</a>;
<a name="l01989"></a>01989       <span class="keywordflow">while</span> (cur) {
<a name="l01990"></a>01990          <span class="comment">/* We have higher priority than the current user, enter</span>
<a name="l01991"></a>01991 <span class="comment">          * before him, after all the other users with priority</span>
<a name="l01992"></a>01992 <span class="comment">          * higher or equal to our priority. */</span>
<a name="l01993"></a>01993          <span class="keywordflow">if</span> ((!inserted) &amp;&amp; (qe-&gt;<a class="code" href="structqueue__ent.html#a6f8e491cf1d80eb127fe0c10ebbfc659">prio</a> &gt; cur-&gt;<a class="code" href="structqueue__ent.html#a6f8e491cf1d80eb127fe0c10ebbfc659">prio</a>)) {
<a name="l01994"></a>01994             <a class="code" href="app__queue_8c.html#ab2d834859be2c32442d2817935a0e3c7" title="Insert the &amp;#39;new&amp;#39; entry after the &amp;#39;prev&amp;#39; entry of queue &amp;#39;q&amp;#39;...">insert_entry</a>(q, prev, qe, &amp;pos);
<a name="l01995"></a>01995             inserted = 1;
<a name="l01996"></a>01996          }
<a name="l01997"></a>01997          cur-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a> = ++pos;
<a name="l01998"></a>01998          prev = cur;
<a name="l01999"></a>01999          cur = cur-&gt;next;
<a name="l02000"></a>02000       }
<a name="l02001"></a>02001       <span class="comment">/* No luck, join at the end of the queue */</span>
<a name="l02002"></a>02002       <span class="keywordflow">if</span> (!inserted)
<a name="l02003"></a>02003          <a class="code" href="app__queue_8c.html#ab2d834859be2c32442d2817935a0e3c7" title="Insert the &amp;#39;new&amp;#39; entry after the &amp;#39;prev&amp;#39; entry of queue &amp;#39;q&amp;#39;...">insert_entry</a>(q, prev, qe, &amp;pos);
<a name="l02004"></a>02004       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>, q-&gt;moh, <span class="keyword">sizeof</span>(qe-&gt;<a class="code" href="structqueue__ent.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>));
<a name="l02005"></a>02005       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a6b2f794058fc666c44aa8ea1c055c34a">announce</a>, q-&gt;announce, <span class="keyword">sizeof</span>(qe-&gt;<a class="code" href="structqueue__ent.html#a6b2f794058fc666c44aa8ea1c055c34a">announce</a>));
<a name="l02006"></a>02006       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, q-&gt;context, <span class="keyword">sizeof</span>(qe-&gt;<a class="code" href="structqueue__ent.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l02007"></a>02007       q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>++;
<a name="l02008"></a>02008       res = 0;
<a name="l02009"></a>02009       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;Join&quot;</span>,
<a name="l02010"></a>02010          <span class="stringliteral">&quot;Channel: %s\r\nCallerIDNum: %s\r\nCallerIDName: %s\r\nQueue: %s\r\nPosition: %d\r\nCount: %d\r\nUniqueid: %s\r\n&quot;</span>,
<a name="l02011"></a>02011          qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name,
<a name="l02012"></a>02012          <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;unknown&quot;</span>), <span class="comment">/* XXX somewhere else it is &lt;unknown&gt; */</span>
<a name="l02013"></a>02013          <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;unknown&quot;</span>),
<a name="l02014"></a>02014          q-&gt;name, qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid );
<a name="l02015"></a>02015       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Queue &apos;%s&apos; Join, Channel &apos;%s&apos;, Position &apos;%d&apos;\n&quot;</span>, q-&gt;name, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a> );
<a name="l02016"></a>02016    }
<a name="l02017"></a>02017    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l02018"></a>02018    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l02019"></a>02019 
<a name="l02020"></a>02020    <span class="keywordflow">return</span> res;
<a name="l02021"></a>02021 }
<a name="l02022"></a>02022 
<a name="l02023"></a><a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">02023</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename)
<a name="l02024"></a>02024 {
<a name="l02025"></a>02025    <span class="keywordtype">int</span> res;
<a name="l02026"></a>02026 
<a name="l02027"></a>02027    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(filename)) {
<a name="l02028"></a>02028       <span class="keywordflow">return</span> 0;
<a name="l02029"></a>02029    }
<a name="l02030"></a>02030 
<a name="l02031"></a>02031    <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l02032"></a>02032 
<a name="l02033"></a>02033    res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, filename, chan-&gt;language);
<a name="l02034"></a>02034    <span class="keywordflow">if</span> (!res)
<a name="l02035"></a>02035       res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l02036"></a>02036 
<a name="l02037"></a>02037    <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l02038"></a>02038 
<a name="l02039"></a>02039    <span class="keywordflow">return</span> res;
<a name="l02040"></a>02040 }
<a name="l02041"></a>02041 <span class="comment"></span>
<a name="l02042"></a>02042 <span class="comment">/*!</span>
<a name="l02043"></a>02043 <span class="comment"> * \brief Check for valid exit from queue via goto</span>
<a name="l02044"></a>02044 <span class="comment"> * \retval 0 if failure</span>
<a name="l02045"></a>02045 <span class="comment"> * \retval 1 if successful</span>
<a name="l02046"></a>02046 <span class="comment">*/</span>
<a name="l02047"></a><a class="code" href="app__queue_8c.html#a4df5a56907979a04a511007899753456">02047</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a4df5a56907979a04a511007899753456" title="Check for valid exit from queue via goto.">valid_exit</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keywordtype">char</span> digit)
<a name="l02048"></a>02048 {
<a name="l02049"></a>02049    <span class="keywordtype">int</span> digitlen = strlen(qe-&gt;<a class="code" href="structqueue__ent.html#a03f45477f89c1c873bd0ce9b508901ca">digits</a>);
<a name="l02050"></a>02050 
<a name="l02051"></a>02051    <span class="comment">/* Prevent possible buffer overflow */</span>
<a name="l02052"></a>02052    <span class="keywordflow">if</span> (digitlen &lt; <span class="keyword">sizeof</span>(qe-&gt;<a class="code" href="structqueue__ent.html#a03f45477f89c1c873bd0ce9b508901ca">digits</a>) - 2) {
<a name="l02053"></a>02053       qe-&gt;<a class="code" href="structqueue__ent.html#a03f45477f89c1c873bd0ce9b508901ca">digits</a>[digitlen] = digit;
<a name="l02054"></a>02054       qe-&gt;<a class="code" href="structqueue__ent.html#a03f45477f89c1c873bd0ce9b508901ca">digits</a>[digitlen + 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02055"></a>02055    } <span class="keywordflow">else</span> {
<a name="l02056"></a>02056       qe-&gt;<a class="code" href="structqueue__ent.html#a03f45477f89c1c873bd0ce9b508901ca">digits</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02057"></a>02057       <span class="keywordflow">return</span> 0;
<a name="l02058"></a>02058    }
<a name="l02059"></a>02059 
<a name="l02060"></a>02060    <span class="comment">/* If there&apos;s no context to goto, short-circuit */</span>
<a name="l02061"></a>02061    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>))
<a name="l02062"></a>02062       <span class="keywordflow">return</span> 0;
<a name="l02063"></a>02063 
<a name="l02064"></a>02064    <span class="comment">/* If the extension is bad, then reset the digits to blank */</span>
<a name="l02065"></a>02065    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a93f9868530c1e8a9d9d367d1ead8782e" title="Looks for a valid matching extension.">ast_canmatch_extension</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a03f45477f89c1c873bd0ce9b508901ca">digits</a>, 1, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l02066"></a>02066       qe-&gt;<a class="code" href="structqueue__ent.html#a03f45477f89c1c873bd0ce9b508901ca">digits</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02067"></a>02067       <span class="keywordflow">return</span> 0;
<a name="l02068"></a>02068    }
<a name="l02069"></a>02069 
<a name="l02070"></a>02070    <span class="comment">/* We have an exact match */</span>
<a name="l02071"></a>02071    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a8f7166f50cb9642179c9b321b8143f55">ast_goto_if_exists</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a03f45477f89c1c873bd0ce9b508901ca">digits</a>, 1)) {
<a name="l02072"></a>02072       qe-&gt;<a class="code" href="structqueue__ent.html#a12851de4518c71edbf5c5adb40976629">valid_digits</a> = 1;
<a name="l02073"></a>02073       <span class="comment">/* Return 1 on a successful goto */</span>
<a name="l02074"></a>02074       <span class="keywordflow">return</span> 1;
<a name="l02075"></a>02075    }
<a name="l02076"></a>02076 
<a name="l02077"></a>02077    <span class="keywordflow">return</span> 0;
<a name="l02078"></a>02078 }
<a name="l02079"></a>02079 
<a name="l02080"></a><a class="code" href="app__queue_8c.html#ad395c86c08af4a1c22518966e9ead32f">02080</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ad395c86c08af4a1c22518966e9ead32f">say_position</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keywordtype">int</span> ringing)
<a name="l02081"></a>02081 {
<a name="l02082"></a>02082    <span class="keywordtype">int</span> res = 0, avgholdmins, avgholdsecs, announceposition = 0;
<a name="l02083"></a>02083    <span class="keywordtype">int</span> say_thanks = 1;
<a name="l02084"></a>02084    time_t now;
<a name="l02085"></a>02085 
<a name="l02086"></a>02086    <span class="comment">/* Let minannouncefrequency seconds pass between the start of each position announcement */</span>
<a name="l02087"></a>02087    time(&amp;now);
<a name="l02088"></a>02088    <span class="keywordflow">if</span> ((now - qe-&gt;<a class="code" href="structqueue__ent.html#a1f8971bc7f04d9152056ed8aa4f36ef6">last_pos</a>) &lt; qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a7724cd5a7395de6d0cbc7f0a02b0c20a">minannouncefrequency</a>)
<a name="l02089"></a>02089       <span class="keywordflow">return</span> 0;
<a name="l02090"></a>02090 
<a name="l02091"></a>02091    <span class="comment">/* If either our position has changed, or we are over the freq timer, say position */</span>
<a name="l02092"></a>02092    <span class="keywordflow">if</span> ((qe-&gt;<a class="code" href="structqueue__ent.html#ac019537a959f6147cecffb126bb04381">last_pos_said</a> == qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>) &amp;&amp; ((now - qe-&gt;<a class="code" href="structqueue__ent.html#a1f8971bc7f04d9152056ed8aa4f36ef6">last_pos</a>) &lt; qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a158e72e504d11a5f6cdfa8d25343adbb">announcefrequency</a>))
<a name="l02093"></a>02093       <span class="keywordflow">return</span> 0;
<a name="l02094"></a>02094 
<a name="l02095"></a>02095    <span class="keywordflow">if</span> (ringing) {
<a name="l02096"></a>02096       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>,-1);
<a name="l02097"></a>02097    } <span class="keywordflow">else</span> {
<a name="l02098"></a>02098       <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l02099"></a>02099    }
<a name="l02100"></a>02100 
<a name="l02101"></a>02101    <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">announceposition</a> == <a class="code" href="app__queue_8c.html#ae19c02c3c0ba9ca01d7ede746f736c45">ANNOUNCEPOSITION_YES</a> ||
<a name="l02102"></a>02102       qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">announceposition</a> == <a class="code" href="app__queue_8c.html#a183dcea5fd32422d981d4705cd770b15">ANNOUNCEPOSITION_MORE_THAN</a> ||
<a name="l02103"></a>02103       (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">announceposition</a> == <a class="code" href="app__queue_8c.html#a967650811eabe6b6373dddc731a286eb">ANNOUNCEPOSITION_LIMIT</a> &amp;&amp;
<a name="l02104"></a>02104       qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a> &lt;= qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a336eac6939e5ebd50b2871148243dee6">announcepositionlimit</a>))
<a name="l02105"></a>02105          announceposition = 1;
<a name="l02106"></a>02106 
<a name="l02107"></a>02107 
<a name="l02108"></a>02108    <span class="keywordflow">if</span> (announceposition == 1) {
<a name="l02109"></a>02109       <span class="comment">/* Say we&apos;re next, if we are */</span>
<a name="l02110"></a>02110       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 1) {
<a name="l02111"></a>02111          res = <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_next);
<a name="l02112"></a>02112          <span class="keywordflow">if</span> (res)
<a name="l02113"></a>02113             <span class="keywordflow">goto</span> playout;
<a name="l02114"></a>02114          <span class="keywordflow">else</span>
<a name="l02115"></a>02115             <span class="keywordflow">goto</span> posout;
<a name="l02116"></a>02116       } <span class="keywordflow">else</span> {
<a name="l02117"></a>02117          <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">announceposition</a> == <a class="code" href="app__queue_8c.html#a183dcea5fd32422d981d4705cd770b15">ANNOUNCEPOSITION_MORE_THAN</a> &amp;&amp; qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a> &gt; qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a336eac6939e5ebd50b2871148243dee6">announcepositionlimit</a>){
<a name="l02118"></a>02118             <span class="comment">/* More than Case*/</span>
<a name="l02119"></a>02119             res = <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;queue_quantity1);
<a name="l02120"></a>02120             <span class="keywordflow">if</span> (res)
<a name="l02121"></a>02121                <span class="keywordflow">goto</span> playout;
<a name="l02122"></a>02122             res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a336eac6939e5ebd50b2871148243dee6">announcepositionlimit</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language, NULL); <span class="comment">/* Needs gender */</span>
<a name="l02123"></a>02123             <span class="keywordflow">if</span> (res)
<a name="l02124"></a>02124                <span class="keywordflow">goto</span> playout;
<a name="l02125"></a>02125          } <span class="keywordflow">else</span> {
<a name="l02126"></a>02126             <span class="comment">/* Normal Case */</span>
<a name="l02127"></a>02127             res = <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_thereare);
<a name="l02128"></a>02128             <span class="keywordflow">if</span> (res)
<a name="l02129"></a>02129                <span class="keywordflow">goto</span> playout;
<a name="l02130"></a>02130             res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language, NULL); <span class="comment">/* Needs gender */</span>
<a name="l02131"></a>02131             <span class="keywordflow">if</span> (res)
<a name="l02132"></a>02132                <span class="keywordflow">goto</span> playout;
<a name="l02133"></a>02133          }
<a name="l02134"></a>02134          <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">announceposition</a> == <a class="code" href="app__queue_8c.html#a183dcea5fd32422d981d4705cd770b15">ANNOUNCEPOSITION_MORE_THAN</a> &amp;&amp; qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a> &gt; qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a336eac6939e5ebd50b2871148243dee6">announcepositionlimit</a>){
<a name="l02135"></a>02135             <span class="comment">/* More than Case*/</span>
<a name="l02136"></a>02136             res = <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;queue_quantity2);
<a name="l02137"></a>02137             <span class="keywordflow">if</span> (res)
<a name="l02138"></a>02138                <span class="keywordflow">goto</span> playout;
<a name="l02139"></a>02139          } <span class="keywordflow">else</span> {
<a name="l02140"></a>02140             res = <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_calls);
<a name="l02141"></a>02141             <span class="keywordflow">if</span> (res)
<a name="l02142"></a>02142                <span class="keywordflow">goto</span> playout;
<a name="l02143"></a>02143          }
<a name="l02144"></a>02144       }
<a name="l02145"></a>02145    }
<a name="l02146"></a>02146    <span class="comment">/* Round hold time to nearest minute */</span>
<a name="l02147"></a>02147    avgholdmins = abs(((qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#aebac91dc9bbd110e44f8ffa9f2e697d1">holdtime</a> + 30) - (now - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>)) / 60);
<a name="l02148"></a>02148 
<a name="l02149"></a>02149    <span class="comment">/* If they have specified a rounding then round the seconds as well */</span>
<a name="l02150"></a>02150    <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">roundingseconds</a>) {
<a name="l02151"></a>02151       avgholdsecs = (abs(((qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#aebac91dc9bbd110e44f8ffa9f2e697d1">holdtime</a> + 30) - (now - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>))) - 60 * avgholdmins) / qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">roundingseconds</a>;
<a name="l02152"></a>02152       avgholdsecs *= qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a8d528a59938ef4b2d91244482bef6302">roundingseconds</a>;
<a name="l02153"></a>02153    } <span class="keywordflow">else</span> {
<a name="l02154"></a>02154       avgholdsecs = 0;
<a name="l02155"></a>02155    }
<a name="l02156"></a>02156 
<a name="l02157"></a>02157    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Hold time for %s is %d minute(s) %d seconds\n&quot;</span>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name, avgholdmins, avgholdsecs);
<a name="l02158"></a>02158 
<a name="l02159"></a>02159    <span class="comment">/* If the hold time is &gt;1 min, if it&apos;s enabled, and if it&apos;s not</span>
<a name="l02160"></a>02160 <span class="comment">      supposed to be only once and we have already said it, say it */</span>
<a name="l02161"></a>02161     <span class="keywordflow">if</span> ((avgholdmins+avgholdsecs) &gt; 0 &amp;&amp; qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a1b9572151ecc081254a026796ef65d33">announceholdtime</a> &amp;&amp;
<a name="l02162"></a>02162         ((qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a1b9572151ecc081254a026796ef65d33">announceholdtime</a> == <a class="code" href="app__queue_8c.html#ab37e1a4dafc93b1ded1edabe9927cf26">ANNOUNCEHOLDTIME_ONCE</a> &amp;&amp; !qe-&gt;<a class="code" href="structqueue__ent.html#a1f8971bc7f04d9152056ed8aa4f36ef6">last_pos</a>) ||
<a name="l02163"></a>02163         !(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a1b9572151ecc081254a026796ef65d33">announceholdtime</a> == <a class="code" href="app__queue_8c.html#ab37e1a4dafc93b1ded1edabe9927cf26">ANNOUNCEHOLDTIME_ONCE</a>))) {
<a name="l02164"></a>02164       res = <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_holdtime);
<a name="l02165"></a>02165       <span class="keywordflow">if</span> (res)
<a name="l02166"></a>02166          <span class="keywordflow">goto</span> playout;
<a name="l02167"></a>02167 
<a name="l02168"></a>02168       <span class="keywordflow">if</span> (avgholdmins &gt;= 1) {
<a name="l02169"></a>02169          res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, avgholdmins, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language, NULL);
<a name="l02170"></a>02170          <span class="keywordflow">if</span> (res)
<a name="l02171"></a>02171             <span class="keywordflow">goto</span> playout;
<a name="l02172"></a>02172 
<a name="l02173"></a>02173          <span class="keywordflow">if</span> (avgholdmins == 1) {
<a name="l02174"></a>02174             res = <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_minute);
<a name="l02175"></a>02175             <span class="keywordflow">if</span> (res)
<a name="l02176"></a>02176                <span class="keywordflow">goto</span> playout;
<a name="l02177"></a>02177          } <span class="keywordflow">else</span> {
<a name="l02178"></a>02178             res = <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_minutes);
<a name="l02179"></a>02179             <span class="keywordflow">if</span> (res)
<a name="l02180"></a>02180                <span class="keywordflow">goto</span> playout;
<a name="l02181"></a>02181          }
<a name="l02182"></a>02182       }
<a name="l02183"></a>02183       <span class="keywordflow">if</span> (avgholdsecs &gt;= 1) {
<a name="l02184"></a>02184          res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, avgholdmins &gt; 1 ? avgholdsecs : avgholdmins * 60 + avgholdsecs, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language, NULL);
<a name="l02185"></a>02185          <span class="keywordflow">if</span> (res)
<a name="l02186"></a>02186             <span class="keywordflow">goto</span> playout;
<a name="l02187"></a>02187 
<a name="l02188"></a>02188          res = <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_seconds);
<a name="l02189"></a>02189          <span class="keywordflow">if</span> (res)
<a name="l02190"></a>02190             <span class="keywordflow">goto</span> playout;
<a name="l02191"></a>02191       }
<a name="l02192"></a>02192    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a1b9572151ecc081254a026796ef65d33">announceholdtime</a> &amp;&amp; !qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">announceposition</a>) {
<a name="l02193"></a>02193       say_thanks = 0;
<a name="l02194"></a>02194    }
<a name="l02195"></a>02195 
<a name="l02196"></a>02196 posout:
<a name="l02197"></a>02197    <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#aa5f94941fd815c8e5e37235a648ea91c">announceposition</a>) {
<a name="l02198"></a>02198       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Told %s in %s their queue position (which was %d)\n&quot;</span>,
<a name="l02199"></a>02199          qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name, qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>);
<a name="l02200"></a>02200    }
<a name="l02201"></a>02201    <span class="keywordflow">if</span> (say_thanks) {
<a name="l02202"></a>02202       res = <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_thanks);
<a name="l02203"></a>02203    }
<a name="l02204"></a>02204 playout:
<a name="l02205"></a>02205 
<a name="l02206"></a>02206    <span class="keywordflow">if</span> ((res &gt; 0 &amp;&amp; !<a class="code" href="app__queue_8c.html#a4df5a56907979a04a511007899753456" title="Check for valid exit from queue via goto.">valid_exit</a>(qe, res)))
<a name="l02207"></a>02207       res = 0;
<a name="l02208"></a>02208 
<a name="l02209"></a>02209    <span class="comment">/* Set our last_pos indicators */</span>
<a name="l02210"></a>02210    qe-&gt;<a class="code" href="structqueue__ent.html#a1f8971bc7f04d9152056ed8aa4f36ef6">last_pos</a> = now;
<a name="l02211"></a>02211    qe-&gt;<a class="code" href="structqueue__ent.html#ac019537a959f6147cecffb126bb04381">last_pos_said</a> = qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>;
<a name="l02212"></a>02212 
<a name="l02213"></a>02213    <span class="comment">/* Don&apos;t restart music on hold if we&apos;re about to exit the caller from the queue */</span>
<a name="l02214"></a>02214    <span class="keywordflow">if</span> (!res) {
<a name="l02215"></a>02215       <span class="keywordflow">if</span> (ringing) {
<a name="l02216"></a>02216          <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>);
<a name="l02217"></a>02217       } <span class="keywordflow">else</span> {
<a name="l02218"></a>02218          <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>, NULL);
<a name="l02219"></a>02219       }
<a name="l02220"></a>02220    }
<a name="l02221"></a>02221    <span class="keywordflow">return</span> res;
<a name="l02222"></a>02222 }
<a name="l02223"></a>02223 
<a name="l02224"></a><a class="code" href="app__queue_8c.html#a43d6ec3224724bd43cc280902fe22991">02224</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a43d6ec3224724bd43cc280902fe22991">recalc_holdtime</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keywordtype">int</span> newholdtime)
<a name="l02225"></a>02225 {
<a name="l02226"></a>02226    <span class="keywordtype">int</span> oldvalue;
<a name="l02227"></a>02227 
<a name="l02228"></a>02228    <span class="comment">/* Calculate holdtime using an exponential average */</span>
<a name="l02229"></a>02229    <span class="comment">/* Thanks to SRT for this contribution */</span>
<a name="l02230"></a>02230    <span class="comment">/* 2^2 (4) is the filter coefficient; a higher exponent would give old entries more weight */</span>
<a name="l02231"></a>02231 
<a name="l02232"></a>02232    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l02233"></a>02233    oldvalue = qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#aebac91dc9bbd110e44f8ffa9f2e697d1">holdtime</a>;
<a name="l02234"></a>02234    qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#aebac91dc9bbd110e44f8ffa9f2e697d1">holdtime</a> = (((oldvalue &lt;&lt; 2) - oldvalue) + newholdtime) &gt;&gt; 2;
<a name="l02235"></a>02235    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l02236"></a>02236 }
<a name="l02237"></a>02237 <span class="comment"></span>
<a name="l02238"></a>02238 <span class="comment">/*! \brief Caller leaving queue.</span>
<a name="l02239"></a>02239 <span class="comment"> * </span>
<a name="l02240"></a>02240 <span class="comment"> * Search the queue to find the leaving client, if found remove from queue</span>
<a name="l02241"></a>02241 <span class="comment"> * create manager event, move others up the queue.</span>
<a name="l02242"></a>02242 <span class="comment">*/</span>
<a name="l02243"></a><a class="code" href="app__queue_8c.html#a3135d5c6b468bef49c1e3fc5d7394f30">02243</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a3135d5c6b468bef49c1e3fc5d7394f30" title="Caller leaving queue.">leave_queue</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe)
<a name="l02244"></a>02244 {
<a name="l02245"></a>02245    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l02246"></a>02246    <span class="keyword">struct </span><a class="code" href="structqueue__ent.html">queue_ent</a> *current, *prev = NULL;
<a name="l02247"></a>02247    <span class="keyword">struct </span><a class="code" href="structpenalty__rule.html">penalty_rule</a> *pr_iter;
<a name="l02248"></a>02248    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a> = 0;
<a name="l02249"></a>02249 
<a name="l02250"></a>02250    <span class="keywordflow">if</span> (!(q = qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>))
<a name="l02251"></a>02251       <span class="keywordflow">return</span>;
<a name="l02252"></a>02252    <a class="code" href="app__queue_8c.html#a975930eef9239c04b8bb2453bafe0798">queue_t_ref</a>(q, <span class="stringliteral">&quot;Copy queue pointer from queue entry&quot;</span>);
<a name="l02253"></a>02253    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l02254"></a>02254 
<a name="l02255"></a>02255    prev = NULL;
<a name="l02256"></a>02256    <span class="keywordflow">for</span> (current = q-&gt;<a class="code" href="structcall__queue.html#a4cee904f94736300a8eba28cc5763bed">head</a>; current; current = current-&gt;next) {
<a name="l02257"></a>02257       <span class="keywordflow">if</span> (current == qe) {
<a name="l02258"></a>02258          q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>--;
<a name="l02259"></a>02259 
<a name="l02260"></a>02260          <span class="comment">/* Take us out of the queue */</span>
<a name="l02261"></a>02261          <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;Leave&quot;</span>,
<a name="l02262"></a>02262             <span class="stringliteral">&quot;Channel: %s\r\nQueue: %s\r\nCount: %d\r\nUniqueid: %s\r\n&quot;</span>,
<a name="l02263"></a>02263             qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, q-&gt;name,  q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid);
<a name="l02264"></a>02264          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Queue &apos;%s&apos; Leave, Channel &apos;%s&apos;\n&quot;</span>, q-&gt;name, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name );
<a name="l02265"></a>02265          <span class="comment">/* Take us out of the queue */</span>
<a name="l02266"></a>02266          <span class="keywordflow">if</span> (prev)
<a name="l02267"></a>02267             prev-&gt;next = current-&gt;next;
<a name="l02268"></a>02268          <span class="keywordflow">else</span>
<a name="l02269"></a>02269             q-&gt;<a class="code" href="structcall__queue.html#a4cee904f94736300a8eba28cc5763bed">head</a> = current-&gt;next;
<a name="l02270"></a>02270          <span class="comment">/* Free penalty rules */</span>
<a name="l02271"></a>02271          <span class="keywordflow">while</span> ((pr_iter = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;qe-&gt;qe_rules, list)))
<a name="l02272"></a>02272             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(pr_iter);
<a name="l02273"></a>02273       } <span class="keywordflow">else</span> {
<a name="l02274"></a>02274          <span class="comment">/* Renumber the people after us in the queue based on a new count */</span>
<a name="l02275"></a>02275          current-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a> = ++pos;
<a name="l02276"></a>02276          prev = current;
<a name="l02277"></a>02277       }
<a name="l02278"></a>02278    }
<a name="l02279"></a>02279    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l02280"></a>02280 
<a name="l02281"></a>02281    <span class="comment">/*If the queue is a realtime queue, check to see if it&apos;s still defined in real time*/</span>
<a name="l02282"></a>02282    <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a53e750a536c8270e37bbdd35a9def3d4">realtime</a>) {
<a name="l02283"></a>02283       <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l02284"></a>02284       <span class="keywordflow">if</span> (!(var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;queues&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, q-&gt;name, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>))) {
<a name="l02285"></a>02285          q-&gt;<a class="code" href="structcall__queue.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a> = 1;
<a name="l02286"></a>02286       } <span class="keywordflow">else</span> {
<a name="l02287"></a>02287          <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l02288"></a>02288       }
<a name="l02289"></a>02289    }
<a name="l02290"></a>02290 
<a name="l02291"></a>02291    <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a>) { 
<a name="l02292"></a>02292       <span class="comment">/* It&apos;s dead and nobody is in it, so kill it */</span>
<a name="l02293"></a>02293       <a class="code" href="app__queue_8c.html#a677f1c4c1a61e9e02d180803d8b8a008">queues_t_unlink</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, q, <span class="stringliteral">&quot;Queue is now dead; remove it from the container&quot;</span>);
<a name="l02294"></a>02294    }
<a name="l02295"></a>02295    <span class="comment">/* unref the explicit ref earlier in the function */</span>
<a name="l02296"></a>02296    <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Expire copied reference&quot;</span>);
<a name="l02297"></a>02297 }
<a name="l02298"></a>02298 <span class="comment"></span>
<a name="l02299"></a>02299 <span class="comment">/*! \brief Hang up a list of outgoing calls */</span>
<a name="l02300"></a><a class="code" href="app__queue_8c.html#a5c48dc0a23bd6fb868ee9b1508d47d4e">02300</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a5c48dc0a23bd6fb868ee9b1508d47d4e" title="Hang up a list of outgoing calls.">hangupcalls</a>(<span class="keyword">struct</span> <a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *<a class="code" href="structoutgoing.html">outgoing</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *exception, <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a9edbd6d881ea6dd2b0b4d78c11723517">cancel_answered_elsewhere</a>)
<a name="l02301"></a>02301 {
<a name="l02302"></a>02302    <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *oo;
<a name="l02303"></a>02303 
<a name="l02304"></a>02304    <span class="keywordflow">while</span> (outgoing) {
<a name="l02305"></a>02305       <span class="comment">/* If someone else answered the call we should indicate this in the CANCEL */</span>
<a name="l02306"></a>02306       <span class="comment">/* Hangup any existing lines we have open */</span>
<a name="l02307"></a>02307       <span class="keywordflow">if</span> (outgoing-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp; (outgoing-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> != exception)) {
<a name="l02308"></a>02308          <span class="keywordflow">if</span> (exception || cancel_answered_elsewhere)
<a name="l02309"></a>02309             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(outgoing-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ac2c6da6c29fad431dfb87caf552315d7">AST_FLAG_ANSWERED_ELSEWHERE</a>);
<a name="l02310"></a>02310          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(outgoing-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l02311"></a>02311       }
<a name="l02312"></a>02312       oo = outgoing;
<a name="l02313"></a>02313       outgoing = outgoing-&gt;<a class="code" href="structcallattempt.html#a9e0459b954643e4b37535fdcb0140326">q_next</a>;
<a name="l02314"></a>02314       <span class="keywordflow">if</span> (oo-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>)
<a name="l02315"></a>02315          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(oo-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>, -1);
<a name="l02316"></a>02316       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(oo);
<a name="l02317"></a>02317    }
<a name="l02318"></a>02318 }
<a name="l02319"></a>02319 <span class="comment"></span>
<a name="l02320"></a>02320 <span class="comment">/*!</span>
<a name="l02321"></a>02321 <span class="comment"> * \brief Get the number of members available to accept a call.</span>
<a name="l02322"></a>02322 <span class="comment"> *</span>
<a name="l02323"></a>02323 <span class="comment"> * \note The queue passed in should be locked prior to this function call</span>
<a name="l02324"></a>02324 <span class="comment"> *</span>
<a name="l02325"></a>02325 <span class="comment"> * \param[in] q The queue for which we are couting the number of available members</span>
<a name="l02326"></a>02326 <span class="comment"> * \return Return the number of available members in queue q</span>
<a name="l02327"></a>02327 <span class="comment"> */</span>
<a name="l02328"></a><a class="code" href="app__queue_8c.html#ab9873b95b03723c7f06d85b044b9e96c">02328</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ab9873b95b03723c7f06d85b044b9e96c" title="Get the number of members available to accept a call.">num_available_members</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q)
<a name="l02329"></a>02329 {
<a name="l02330"></a>02330    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *mem;
<a name="l02331"></a>02331    <span class="keywordtype">int</span> avl = 0;
<a name="l02332"></a>02332    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l02333"></a>02333 
<a name="l02334"></a>02334    mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l02335"></a>02335    <span class="keywordflow">while</span> ((mem = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l02336"></a>02336       <span class="keywordflow">switch</span> (mem-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a>) {
<a name="l02337"></a>02337       <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>:
<a name="l02338"></a>02338          <span class="keywordflow">if</span> (!q-&gt;<a class="code" href="structcall__queue.html#a88ec6754dea8cb6d040f61a279b1c298">ringinuse</a>)
<a name="l02339"></a>02339             <span class="keywordflow">break</span>;
<a name="l02340"></a>02340          <span class="comment">/* else fall through */</span>
<a name="l02341"></a>02341       <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>:
<a name="l02342"></a>02342       <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>:
<a name="l02343"></a>02343          <span class="keywordflow">if</span> (!mem-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a>) {
<a name="l02344"></a>02344             avl++;
<a name="l02345"></a>02345          }
<a name="l02346"></a>02346          <span class="keywordflow">break</span>;
<a name="l02347"></a>02347       }
<a name="l02348"></a>02348       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l02349"></a>02349 
<a name="l02350"></a>02350       <span class="comment">/* If autofill is not enabled or if the queue&apos;s strategy is ringall, then</span>
<a name="l02351"></a>02351 <span class="comment">       * we really don&apos;t care about the number of available members so much as we</span>
<a name="l02352"></a>02352 <span class="comment">       * do that there is at least one available.</span>
<a name="l02353"></a>02353 <span class="comment">       *</span>
<a name="l02354"></a>02354 <span class="comment">       * In fact, we purposely will return from this function stating that only</span>
<a name="l02355"></a>02355 <span class="comment">       * one member is available if either of those conditions hold. That way,</span>
<a name="l02356"></a>02356 <span class="comment">       * functions which determine what action to take based on the number of available</span>
<a name="l02357"></a>02357 <span class="comment">       * members will operate properly. The reasoning is that even if multiple</span>
<a name="l02358"></a>02358 <span class="comment">       * members are available, only the head caller can actually be serviced.</span>
<a name="l02359"></a>02359 <span class="comment">       */</span>
<a name="l02360"></a>02360       <span class="keywordflow">if</span> ((!q-&gt;<a class="code" href="structcall__queue.html#a76e20f3c9df399ad87bb4e45c7419e99">autofill</a> || q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> == <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>) &amp;&amp; avl) {
<a name="l02361"></a>02361          <span class="keywordflow">break</span>;
<a name="l02362"></a>02362       }
<a name="l02363"></a>02363    }
<a name="l02364"></a>02364    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l02365"></a>02365 
<a name="l02366"></a>02366    <span class="keywordflow">return</span> avl;
<a name="l02367"></a>02367 }
<a name="l02368"></a>02368 
<a name="l02369"></a>02369 <span class="comment">/* traverse all defined queues which have calls waiting and contain this member</span>
<a name="l02370"></a>02370 <span class="comment">   return 0 if no other queue has precedence (higher weight) or 1 if found  */</span>
<a name="l02371"></a><a class="code" href="app__queue_8c.html#a449c2a013ceb381a8f619d51fb609711">02371</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a449c2a013ceb381a8f619d51fb609711">compare_weight</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *rq, <span class="keyword">struct</span> <a class="code" href="structmember.html">member</a> *<a class="code" href="structmember.html">member</a>)
<a name="l02372"></a>02372 {
<a name="l02373"></a>02373    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l02374"></a>02374    <span class="keyword">struct </span>member *mem;
<a name="l02375"></a>02375    <span class="keywordtype">int</span> found = 0;
<a name="l02376"></a>02376    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> queue_iter;
<a name="l02377"></a>02377    
<a name="l02378"></a>02378    <span class="comment">/* q&apos;s lock and rq&apos;s lock already set by try_calling()</span>
<a name="l02379"></a>02379 <span class="comment">    * to solve deadlock */</span>
<a name="l02380"></a>02380    queue_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, 0);
<a name="l02381"></a>02381    <span class="keywordflow">while</span> ((q = <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;queue_iter, <span class="stringliteral">&quot;Iterate through queues&quot;</span>))) {
<a name="l02382"></a>02382       <span class="keywordflow">if</span> (q == rq) { <span class="comment">/* don&apos;t check myself, could deadlock */</span>
<a name="l02383"></a>02383          <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l02384"></a>02384          <span class="keywordflow">continue</span>;
<a name="l02385"></a>02385       }
<a name="l02386"></a>02386       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l02387"></a>02387       <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> &amp;&amp; q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>) {
<a name="l02388"></a>02388          <span class="keywordflow">if</span> ((mem = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, member, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>))) {
<a name="l02389"></a>02389             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Found matching member %s in queue &apos;%s&apos;\n&quot;</span>, mem-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, q-&gt;name);
<a name="l02390"></a>02390             <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a> &gt; rq-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a> &amp;&amp; q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> &gt;= <a class="code" href="app__queue_8c.html#ab9873b95b03723c7f06d85b044b9e96c" title="Get the number of members available to accept a call.">num_available_members</a>(q)) {
<a name="l02391"></a>02391                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Queue &apos;%s&apos; (weight %d, calls %d) is preferred over &apos;%s&apos; (weight %d, calls %d)\n&quot;</span>, q-&gt;name, q-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a>, q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>, rq-&gt;name, rq-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a>, rq-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>);
<a name="l02392"></a>02392                found = 1;
<a name="l02393"></a>02393             }
<a name="l02394"></a>02394             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l02395"></a>02395          }
<a name="l02396"></a>02396       }
<a name="l02397"></a>02397       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l02398"></a>02398       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l02399"></a>02399       <span class="keywordflow">if</span> (found) {
<a name="l02400"></a>02400          <span class="keywordflow">break</span>;
<a name="l02401"></a>02401       }
<a name="l02402"></a>02402    }
<a name="l02403"></a>02403    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;queue_iter);
<a name="l02404"></a>02404    <span class="keywordflow">return</span> found;
<a name="l02405"></a>02405 }
<a name="l02406"></a>02406 <span class="comment"></span>
<a name="l02407"></a>02407 <span class="comment">/*! \brief common hangup actions */</span>
<a name="l02408"></a><a class="code" href="app__queue_8c.html#a37f1ce6ab6c24242c99997e17ec4fc33">02408</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a37f1ce6ab6c24242c99997e17ec4fc33" title="common hangup actions">do_hang</a>(<span class="keyword">struct</span> <a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *o)
<a name="l02409"></a>02409 {
<a name="l02410"></a>02410    o-&gt;<a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a> = 0;
<a name="l02411"></a>02411    <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l02412"></a>02412    o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = NULL;
<a name="l02413"></a>02413 }
<a name="l02414"></a>02414 <span class="comment"></span>
<a name="l02415"></a>02415 <span class="comment">/*! \brief convert &quot;\n&quot; to &quot;\nVariable: &quot; ready for manager to use */</span>
<a name="l02416"></a><a class="code" href="app__queue_8c.html#a5f13e8661f3dfcdb919d8140a997cf7a">02416</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5f13e8661f3dfcdb919d8140a997cf7a" title="convert &amp;quot;\n&amp;quot; to &amp;quot;\nVariable: &amp;quot; ready for manager to use">vars2manager</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">char</span> *vars, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l02417"></a>02417 {
<a name="l02418"></a>02418    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a> = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;ast_str_thread_global_buf, len + 1);
<a name="l02419"></a>02419    <span class="keywordtype">char</span> *tmp;
<a name="l02420"></a>02420 
<a name="l02421"></a>02421    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a847dc86089ce693d89a534512f16dad1" title="Create a human-readable string, specifying all variables and their corresponding...">pbx_builtin_serialize_variables</a>(chan, &amp;buf)) {
<a name="l02422"></a>02422       <span class="keywordtype">int</span> i, j;
<a name="l02423"></a>02423 
<a name="l02424"></a>02424       <span class="comment">/* convert &quot;\n&quot; to &quot;\nVariable: &quot; */</span>
<a name="l02425"></a>02425       strcpy(vars, <span class="stringliteral">&quot;Variable: &quot;</span>);
<a name="l02426"></a>02426       tmp = <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf);
<a name="l02427"></a>02427 
<a name="l02428"></a>02428       <span class="keywordflow">for</span> (i = 0, j = 10; (i &lt; len - 1) &amp;&amp; (j &lt; len - 1); i++, j++) {
<a name="l02429"></a>02429          vars[j] = tmp[i];
<a name="l02430"></a>02430 
<a name="l02431"></a>02431          <span class="keywordflow">if</span> (tmp[i + 1] == <span class="charliteral">&apos;\0&apos;</span>)
<a name="l02432"></a>02432             <span class="keywordflow">break</span>;
<a name="l02433"></a>02433          <span class="keywordflow">if</span> (tmp[i] == <span class="charliteral">&apos;\n&apos;</span>) {
<a name="l02434"></a>02434             vars[j++] = <span class="charliteral">&apos;\r&apos;</span>;
<a name="l02435"></a>02435             vars[j++] = <span class="charliteral">&apos;\n&apos;</span>;
<a name="l02436"></a>02436 
<a name="l02437"></a>02437             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(&amp;(vars[j]), <span class="stringliteral">&quot;Variable: &quot;</span>, len - j);
<a name="l02438"></a>02438             j += 9;
<a name="l02439"></a>02439          }
<a name="l02440"></a>02440       }
<a name="l02441"></a>02441       <span class="keywordflow">if</span> (j &gt; len - 3)
<a name="l02442"></a>02442          j = len - 3;
<a name="l02443"></a>02443       vars[j++] = <span class="charliteral">&apos;\r&apos;</span>;
<a name="l02444"></a>02444       vars[j++] = <span class="charliteral">&apos;\n&apos;</span>;
<a name="l02445"></a>02445       vars[j] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02446"></a>02446    } <span class="keywordflow">else</span> {
<a name="l02447"></a>02447       <span class="comment">/* there are no channel variables; leave it blank */</span>
<a name="l02448"></a>02448       *vars = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02449"></a>02449    }
<a name="l02450"></a>02450    <span class="keywordflow">return</span> vars;
<a name="l02451"></a>02451 }
<a name="l02452"></a>02452 <span class="comment"></span>
<a name="l02453"></a>02453 <span class="comment">/*! </span>
<a name="l02454"></a>02454 <span class="comment"> * \brief Part 2 of ring_one</span>
<a name="l02455"></a>02455 <span class="comment"> *</span>
<a name="l02456"></a>02456 <span class="comment"> * Does error checking before attempting to request a channel and call a member. </span>
<a name="l02457"></a>02457 <span class="comment"> * This function is only called from ring_one(). </span>
<a name="l02458"></a>02458 <span class="comment"> * Failure can occur if:</span>
<a name="l02459"></a>02459 <span class="comment"> * - Agent on call</span>
<a name="l02460"></a>02460 <span class="comment"> * - Agent is paused</span>
<a name="l02461"></a>02461 <span class="comment"> * - Wrapup time not expired</span>
<a name="l02462"></a>02462 <span class="comment"> * - Priority by another queue</span>
<a name="l02463"></a>02463 <span class="comment"> *</span>
<a name="l02464"></a>02464 <span class="comment"> * \retval 1 on success to reach a free agent</span>
<a name="l02465"></a>02465 <span class="comment"> * \retval 0 on failure to get agent.</span>
<a name="l02466"></a>02466 <span class="comment"> */</span>
<a name="l02467"></a><a class="code" href="app__queue_8c.html#ac53cea8ee06b85c53f586133109f6ad7">02467</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ac53cea8ee06b85c53f586133109f6ad7" title="Part 2 of ring_one.">ring_entry</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keyword">struct</span> <a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *tmp, <span class="keywordtype">int</span> *busies)
<a name="l02468"></a>02468 {
<a name="l02469"></a>02469    <span class="keywordtype">int</span> res;
<a name="l02470"></a>02470    <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>;
<a name="l02471"></a>02471    <span class="keywordtype">char</span> tech[256];
<a name="l02472"></a>02472    <span class="keywordtype">char</span> *location;
<a name="l02473"></a>02473    <span class="keyword">const</span> <span class="keywordtype">char</span> *macrocontext, *macroexten;
<a name="l02474"></a>02474 
<a name="l02475"></a>02475    <span class="comment">/* on entry here, we know that tmp-&gt;chan == NULL */</span>
<a name="l02476"></a>02476    <span class="keywordflow">if</span> ((tmp-&gt;<a class="code" href="structcallattempt.html#ad666640d5cfd34a434cfa5347f50def4">lastqueue</a> &amp;&amp; tmp-&gt;<a class="code" href="structcallattempt.html#ad666640d5cfd34a434cfa5347f50def4">lastqueue</a>-&gt;<a class="code" href="structcall__queue.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> &amp;&amp; (time(NULL) - tmp-&gt;<a class="code" href="structcallattempt.html#a33479a2976f279910df62bda3a3df62d">lastcall</a> &lt; tmp-&gt;<a class="code" href="structcallattempt.html#ad666640d5cfd34a434cfa5347f50def4">lastqueue</a>-&gt;<a class="code" href="structcall__queue.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a>)) ||
<a name="l02477"></a>02477       (!tmp-&gt;<a class="code" href="structcallattempt.html#ad666640d5cfd34a434cfa5347f50def4">lastqueue</a> &amp;&amp; qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> &amp;&amp; (time(NULL) - tmp-&gt;<a class="code" href="structcallattempt.html#a33479a2976f279910df62bda3a3df62d">lastcall</a> &lt; qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a>))) {
<a name="l02478"></a>02478       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Wrapuptime not yet expired on queue %s for %s\n&quot;</span>, 
<a name="l02479"></a>02479             (tmp-&gt;<a class="code" href="structcallattempt.html#ad666640d5cfd34a434cfa5347f50def4">lastqueue</a> ? tmp-&gt;<a class="code" href="structcallattempt.html#ad666640d5cfd34a434cfa5347f50def4">lastqueue</a>-&gt;name : qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name), tmp-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>);
<a name="l02480"></a>02480       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l02481"></a>02481          <a class="code" href="cdr_8h.html#a4df18ef44f74b2dce240ca02a9c22ddf" title="Busy a call.">ast_cdr_busy</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l02482"></a>02482       tmp-&gt;<a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a> = 0;
<a name="l02483"></a>02483       (*busies)++;
<a name="l02484"></a>02484       <span class="keywordflow">return</span> 0;
<a name="l02485"></a>02485    }
<a name="l02486"></a>02486 
<a name="l02487"></a>02487    <span class="keywordflow">if</span> (!qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a88ec6754dea8cb6d040f61a279b1c298">ringinuse</a> &amp;&amp; (tmp-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> != <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>) &amp;&amp; (tmp-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> != <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>)) {
<a name="l02488"></a>02488       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s in use, can&apos;t receive call\n&quot;</span>, tmp-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>);
<a name="l02489"></a>02489       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l02490"></a>02490          <a class="code" href="cdr_8h.html#a4df18ef44f74b2dce240ca02a9c22ddf" title="Busy a call.">ast_cdr_busy</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l02491"></a>02491       tmp-&gt;<a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a> = 0;
<a name="l02492"></a>02492       <span class="keywordflow">return</span> 0;
<a name="l02493"></a>02493    }
<a name="l02494"></a>02494 
<a name="l02495"></a>02495    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a>) {
<a name="l02496"></a>02496       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s paused, can&apos;t receive call\n&quot;</span>, tmp-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>);
<a name="l02497"></a>02497       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l02498"></a>02498          <a class="code" href="cdr_8h.html#a4df18ef44f74b2dce240ca02a9c22ddf" title="Busy a call.">ast_cdr_busy</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l02499"></a>02499       tmp-&gt;<a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a> = 0;
<a name="l02500"></a>02500       <span class="keywordflow">return</span> 0;
<a name="l02501"></a>02501    }
<a name="l02502"></a>02502    <span class="keywordflow">if</span> (use_weight &amp;&amp; <a class="code" href="app__queue_8c.html#a449c2a013ceb381a8f619d51fb609711">compare_weight</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>,tmp-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>)) {
<a name="l02503"></a>02503       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Priority queue delaying call to %s:%s\n&quot;</span>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name, tmp-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>);
<a name="l02504"></a>02504       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l02505"></a>02505          <a class="code" href="cdr_8h.html#a4df18ef44f74b2dce240ca02a9c22ddf" title="Busy a call.">ast_cdr_busy</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l02506"></a>02506       tmp-&gt;<a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a> = 0;
<a name="l02507"></a>02507       (*busies)++;
<a name="l02508"></a>02508       <span class="keywordflow">return</span> 0;
<a name="l02509"></a>02509    }
<a name="l02510"></a>02510 
<a name="l02511"></a>02511    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tech, tmp-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>, <span class="keyword">sizeof</span>(tech));
<a name="l02512"></a>02512    <span class="keywordflow">if</span> ((location = strchr(tech, <span class="charliteral">&apos;/&apos;</span>)))
<a name="l02513"></a>02513       *location++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02514"></a>02514    <span class="keywordflow">else</span>
<a name="l02515"></a>02515       location = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02516"></a>02516 
<a name="l02517"></a>02517    <span class="comment">/* Request the peer */</span>
<a name="l02518"></a>02518    tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = <a class="code" href="channel_8h.html#a922b0c040026477b8e2020211abf604a" title="Requests a channel.">ast_request</a>(tech, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>, location, &amp;status);
<a name="l02519"></a>02519    <span class="keywordflow">if</span> (!tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {       <span class="comment">/* If we can&apos;t, just go on to the next call */</span>
<a name="l02520"></a>02520       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l02521"></a>02521          <a class="code" href="cdr_8h.html#a4df18ef44f74b2dce240ca02a9c22ddf" title="Busy a call.">ast_cdr_busy</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l02522"></a>02522       tmp-&gt;<a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a> = 0; 
<a name="l02523"></a>02523 
<a name="l02524"></a>02524       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l02525"></a>02525       <a class="code" href="app__queue_8c.html#a7e0cf32398ece87e80e92dffce3cda2c" title="set a member&amp;#39;s status based on device state of that member&amp;#39;s state_interface...">update_status</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, tmp-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>, <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a>(tmp-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>));
<a name="l02526"></a>02526       qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a0a7a994a2db49ad4569bfd6db242247b">rrpos</a>++;
<a name="l02527"></a>02527       qe-&gt;<a class="code" href="structqueue__ent.html#a51db7b9d0e86f2188b541b3d68459930">linpos</a>++;
<a name="l02528"></a>02528       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l02529"></a>02529 
<a name="l02530"></a>02530       (*busies)++;
<a name="l02531"></a>02531       <span class="keywordflow">return</span> 0;
<a name="l02532"></a>02532    }
<a name="l02533"></a>02533    
<a name="l02534"></a>02534    <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a9edbd6d881ea6dd2b0b4d78c11723517">cancel_answered_elsewhere</a>) {
<a name="l02535"></a>02535       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ac2c6da6c29fad431dfb87caf552315d7">AST_FLAG_ANSWERED_ELSEWHERE</a>);
<a name="l02536"></a>02536    }
<a name="l02537"></a>02537    tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a> = <span class="stringliteral">&quot;AppQueue&quot;</span>;
<a name="l02538"></a>02538    tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a> = <span class="stringliteral">&quot;(Outgoing Line)&quot;</span>;
<a name="l02539"></a>02539    memset(&amp;tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a645928dea02ce2132b83e7e61ef5b80a">whentohangup</a>, 0, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a645928dea02ce2132b83e7e61ef5b80a">whentohangup</a>));
<a name="l02540"></a>02540    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)
<a name="l02541"></a>02541       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>);
<a name="l02542"></a>02542    tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>);
<a name="l02543"></a>02543    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>)
<a name="l02544"></a>02544       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>);
<a name="l02545"></a>02545    tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>);
<a name="l02546"></a>02546    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a>)
<a name="l02547"></a>02547       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a>);
<a name="l02548"></a>02548    tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a>);
<a name="l02549"></a>02549 
<a name="l02550"></a>02550    <span class="comment">/* Inherit specially named variables from parent channel */</span>
<a name="l02551"></a>02551    <a class="code" href="channel_8h.html#a892b6550a4f90b70ad92198c9d05cedc" title="Inherits channel variable from parent to child channel.">ast_channel_inherit_variables</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l02552"></a>02552    <a class="code" href="channel_8h.html#a6ce892974f59537bda03a71319b452e2" title="Inherit datastores from a parent to a child.">ast_channel_datastore_inherit</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l02553"></a>02553 
<a name="l02554"></a>02554    <span class="comment">/* Presense of ADSI CPE on outgoing channel follows ours */</span>
<a name="l02555"></a>02555    tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> = qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a>;
<a name="l02556"></a>02556 
<a name="l02557"></a>02557    <span class="comment">/* Inherit context and extension */</span>
<a name="l02558"></a>02558    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l02559"></a>02559    macrocontext = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;MACRO_CONTEXT&quot;</span>);
<a name="l02560"></a>02560    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="app__voicemail_8c.html#a695d5aca89839d016497739454f9779a">dialcontext</a>, <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(macrocontext) ? qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a> : macrocontext);
<a name="l02561"></a>02561    macroexten = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;MACRO_EXTEN&quot;</span>);
<a name="l02562"></a>02562    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(macroexten))
<a name="l02563"></a>02563       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, macroexten, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l02564"></a>02564    <span class="keywordflow">else</span>
<a name="l02565"></a>02565       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l02566"></a>02566    <span class="keywordflow">if</span> (<a class="code" href="cdr_8h.html#a3230b9156b0d5fd8b1bd5b91e8ead303">ast_cdr_isset_unanswered</a>()) {
<a name="l02567"></a>02567       <span class="comment">/* they want to see the unanswered dial attempts! */</span>
<a name="l02568"></a>02568       <span class="comment">/* set up the CDR fields on all the CDRs to give sensical information */</span>
<a name="l02569"></a>02569       <a class="code" href="cdr_8h.html#aa7ed883d22142f873c13cf5364b95e1e" title="Set the destination channel, if there was one.">ast_cdr_setdestchan</a>(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l02570"></a>02570       strcpy(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#ab7fd8bddf0ce6987ae5e58fb64cfc9e2">clid</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#ab7fd8bddf0ce6987ae5e58fb64cfc9e2">clid</a>);
<a name="l02571"></a>02571       strcpy(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a6396dbd53fd6fedc1fc3ba2743f00eca">channel</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a6396dbd53fd6fedc1fc3ba2743f00eca">channel</a>);
<a name="l02572"></a>02572       strcpy(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#aa8e4f370559b3fe698f36b3132467f94">src</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#aa8e4f370559b3fe698f36b3132467f94">src</a>);
<a name="l02573"></a>02573       strcpy(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#ab30db746a1bf5c869a5dc9dbfaa864d4">dst</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>);
<a name="l02574"></a>02574       strcpy(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#af27d556683a4a28e6564618bcf00bec1">dcontext</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l02575"></a>02575       strcpy(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#ae7697234189954ec7c6a81b4ab691b85">lastapp</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#ae7697234189954ec7c6a81b4ab691b85">lastapp</a>);
<a name="l02576"></a>02576       strcpy(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a2176704f41b4368f2dfa94b64bfcfb6a">lastdata</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a2176704f41b4368f2dfa94b64bfcfb6a">lastdata</a>);
<a name="l02577"></a>02577       tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#aa2112d5526f7d98a80d5da0abea1cc7d">amaflags</a> = qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#aa2112d5526f7d98a80d5da0abea1cc7d">amaflags</a>;
<a name="l02578"></a>02578       strcpy(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#adfee50d07a98645d4d20b896ce03785a">accountcode</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#adfee50d07a98645d4d20b896ce03785a">accountcode</a>);
<a name="l02579"></a>02579       strcpy(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a2d480b13820a3a97582a1a138036aa25">userfield</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a2d480b13820a3a97582a1a138036aa25">userfield</a>);
<a name="l02580"></a>02580    }
<a name="l02581"></a>02581    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l02582"></a>02582 
<a name="l02583"></a>02583    <span class="comment">/* Place the call, but don&apos;t wait on the answer */</span>
<a name="l02584"></a>02584    <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8h.html#ae212e5f3ae50a869bbf859fe9db7dee0" title="Make a call.">ast_call</a>(tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, location, 0))) {
<a name="l02585"></a>02585       <span class="comment">/* Again, keep going even if there&apos;s an error */</span>
<a name="l02586"></a>02586       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;ast call on peer returned %d\n&quot;</span>, res);
<a name="l02587"></a>02587       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Couldn&apos;t call %s\n&quot;</span>, tmp-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>);
<a name="l02588"></a>02588       <a class="code" href="app__queue_8c.html#a37f1ce6ab6c24242c99997e17ec4fc33" title="common hangup actions">do_hang</a>(tmp);
<a name="l02589"></a>02589       (*busies)++;
<a name="l02590"></a>02590       <a class="code" href="app__queue_8c.html#a7e0cf32398ece87e80e92dffce3cda2c" title="set a member&amp;#39;s status based on device state of that member&amp;#39;s state_interface...">update_status</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, tmp-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>, <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a>(tmp-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>));
<a name="l02591"></a>02591       <span class="keywordflow">return</span> 0;
<a name="l02592"></a>02592    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a>) {
<a name="l02593"></a>02593       <span class="keywordtype">char</span> vars[2048];
<a name="l02594"></a>02594 
<a name="l02595"></a>02595       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;AgentCalled&quot;</span>,
<a name="l02596"></a>02596                <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l02597"></a>02597                <span class="stringliteral">&quot;AgentCalled: %s\r\n&quot;</span>
<a name="l02598"></a>02598                <span class="stringliteral">&quot;AgentName: %s\r\n&quot;</span>
<a name="l02599"></a>02599                <span class="stringliteral">&quot;ChannelCalling: %s\r\n&quot;</span>
<a name="l02600"></a>02600                <span class="stringliteral">&quot;DestinationChannel: %s\r\n&quot;</span>
<a name="l02601"></a>02601                <span class="stringliteral">&quot;CallerIDNum: %s\r\n&quot;</span>
<a name="l02602"></a>02602                <span class="stringliteral">&quot;CallerIDName: %s\r\n&quot;</span>
<a name="l02603"></a>02603                <span class="stringliteral">&quot;Context: %s\r\n&quot;</span>
<a name="l02604"></a>02604                <span class="stringliteral">&quot;Extension: %s\r\n&quot;</span>
<a name="l02605"></a>02605                <span class="stringliteral">&quot;Priority: %d\r\n&quot;</span>
<a name="l02606"></a>02606                <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l02607"></a>02607                <span class="stringliteral">&quot;%s&quot;</span>,
<a name="l02608"></a>02608                qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name, tmp-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>, tmp-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name,
<a name="l02609"></a>02609                tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a> ? tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a> : <span class="stringliteral">&quot;unknown&quot;</span>,
<a name="l02610"></a>02610                tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a> ? tmp-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a> : <span class="stringliteral">&quot;unknown&quot;</span>,
<a name="l02611"></a>02611                qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid,
<a name="l02612"></a>02612                qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a> == <a class="code" href="app__queue_8c.html#a533ee4344c442cf6da3e610598ecca75">QUEUE_EVENT_VARIABLES</a> ? <a class="code" href="app__queue_8c.html#a5f13e8661f3dfcdb919d8140a997cf7a" title="convert &amp;quot;\n&amp;quot; to &amp;quot;\nVariable: &amp;quot; ready for manager to use">vars2manager</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, vars, <span class="keyword">sizeof</span>(vars)) : <span class="stringliteral">&quot;&quot;</span>);
<a name="l02613"></a>02613       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Called %s\n&quot;</span>, tmp-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>);
<a name="l02614"></a>02614    }
<a name="l02615"></a>02615 
<a name="l02616"></a>02616    <a class="code" href="app__queue_8c.html#a7e0cf32398ece87e80e92dffce3cda2c" title="set a member&amp;#39;s status based on device state of that member&amp;#39;s state_interface...">update_status</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, tmp-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>, <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a>(tmp-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>));
<a name="l02617"></a>02617    <span class="keywordflow">return</span> 1;
<a name="l02618"></a>02618 }
<a name="l02619"></a>02619 <span class="comment"></span>
<a name="l02620"></a>02620 <span class="comment">/*! \brief find the entry with the best metric, or NULL */</span>
<a name="l02621"></a><a class="code" href="app__queue_8c.html#ab389b8ba466d7d05808b044592b05710">02621</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *<a class="code" href="app__queue_8c.html#ab389b8ba466d7d05808b044592b05710" title="find the entry with the best metric, or NULL">find_best</a>(<span class="keyword">struct</span> <a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *<a class="code" href="structoutgoing.html">outgoing</a>)
<a name="l02622"></a>02622 {
<a name="l02623"></a>02623    <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *best = NULL, *cur;
<a name="l02624"></a>02624 
<a name="l02625"></a>02625    <span class="keywordflow">for</span> (cur = outgoing; cur; cur = cur-&gt;<a class="code" href="structcallattempt.html#a9e0459b954643e4b37535fdcb0140326">q_next</a>) {
<a name="l02626"></a>02626       <span class="keywordflow">if</span> (cur-&gt;stillgoing &amp;&amp;              <span class="comment">/* Not already done */</span>
<a name="l02627"></a>02627          !cur-&gt;chan &amp;&amp;              <span class="comment">/* Isn&apos;t already going */</span>
<a name="l02628"></a>02628          (!best || cur-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> &lt; best-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a>)) {     <span class="comment">/* We haven&apos;t found one yet, or it&apos;s better */</span>
<a name="l02629"></a>02629          best = cur;
<a name="l02630"></a>02630       }
<a name="l02631"></a>02631    }
<a name="l02632"></a>02632 
<a name="l02633"></a>02633    <span class="keywordflow">return</span> best;
<a name="l02634"></a>02634 }
<a name="l02635"></a>02635 <span class="comment"></span>
<a name="l02636"></a>02636 <span class="comment">/*! </span>
<a name="l02637"></a>02637 <span class="comment"> * \brief Place a call to a queue member.</span>
<a name="l02638"></a>02638 <span class="comment"> *</span>
<a name="l02639"></a>02639 <span class="comment"> * Once metrics have been calculated for each member, this function is used</span>
<a name="l02640"></a>02640 <span class="comment"> * to place a call to the appropriate member (or members). The low-level</span>
<a name="l02641"></a>02641 <span class="comment"> * channel-handling and error detection is handled in ring_entry</span>
<a name="l02642"></a>02642 <span class="comment"> *</span>
<a name="l02643"></a>02643 <span class="comment"> * \retval 1 if a member was called successfully</span>
<a name="l02644"></a>02644 <span class="comment"> * \retval 0 otherwise</span>
<a name="l02645"></a>02645 <span class="comment"> */</span>
<a name="l02646"></a><a class="code" href="app__queue_8c.html#af0efe7e816fe1c82ebac5d82a3218b31">02646</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#af0efe7e816fe1c82ebac5d82a3218b31" title="Place a call to a queue member.">ring_one</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keyword">struct</span> <a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *<a class="code" href="structoutgoing.html">outgoing</a>, <span class="keywordtype">int</span> *busies)
<a name="l02647"></a>02647 {
<a name="l02648"></a>02648    <span class="keywordtype">int</span> ret = 0;
<a name="l02649"></a>02649 
<a name="l02650"></a>02650    <span class="keywordflow">while</span> (ret == 0) {
<a name="l02651"></a>02651       <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *best = <a class="code" href="app__queue_8c.html#ab389b8ba466d7d05808b044592b05710" title="find the entry with the best metric, or NULL">find_best</a>(outgoing);
<a name="l02652"></a>02652       <span class="keywordflow">if</span> (!best) {
<a name="l02653"></a>02653          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Nobody left to try ringing in queue\n&quot;</span>);
<a name="l02654"></a>02654          <span class="keywordflow">break</span>;
<a name="l02655"></a>02655       }
<a name="l02656"></a>02656       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> == <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>) {
<a name="l02657"></a>02657          <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *cur;
<a name="l02658"></a>02658          <span class="comment">/* Ring everyone who shares this best metric (for ringall) */</span>
<a name="l02659"></a>02659          <span class="keywordflow">for</span> (cur = outgoing; cur; cur = cur-&gt;<a class="code" href="structcallattempt.html#a9e0459b954643e4b37535fdcb0140326">q_next</a>) {
<a name="l02660"></a>02660             <span class="keywordflow">if</span> (cur-&gt;<a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a> &amp;&amp; !cur-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp; cur-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> &lt;= best-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a>) {
<a name="l02661"></a>02661                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;(Parallel) Trying &apos;%s&apos; with metric %d\n&quot;</span>, cur-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>, cur-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a>);
<a name="l02662"></a>02662                ret |= <a class="code" href="app__queue_8c.html#ac53cea8ee06b85c53f586133109f6ad7" title="Part 2 of ring_one.">ring_entry</a>(qe, cur, busies);
<a name="l02663"></a>02663             }
<a name="l02664"></a>02664          }
<a name="l02665"></a>02665       } <span class="keywordflow">else</span> {
<a name="l02666"></a>02666          <span class="comment">/* Ring just the best channel */</span>
<a name="l02667"></a>02667          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Trying &apos;%s&apos; with metric %d\n&quot;</span>, best-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>, best-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a>);
<a name="l02668"></a>02668          ret = <a class="code" href="app__queue_8c.html#ac53cea8ee06b85c53f586133109f6ad7" title="Part 2 of ring_one.">ring_entry</a>(qe, best, busies);
<a name="l02669"></a>02669       }
<a name="l02670"></a>02670       
<a name="l02671"></a>02671       <span class="comment">/* If we have timed out, break out */</span>
<a name="l02672"></a>02672       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> &amp;&amp; (time(NULL) &gt;= qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a>)) {
<a name="l02673"></a>02673          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Queue timed out while ringing members.\n&quot;</span>);
<a name="l02674"></a>02674          ret = 0;
<a name="l02675"></a>02675          <span class="keywordflow">break</span>;
<a name="l02676"></a>02676       }
<a name="l02677"></a>02677    }
<a name="l02678"></a>02678 
<a name="l02679"></a>02679    <span class="keywordflow">return</span> ret;
<a name="l02680"></a>02680 }
<a name="l02681"></a>02681 <span class="comment"></span>
<a name="l02682"></a>02682 <span class="comment">/*! \brief Search for best metric and add to Round Robbin queue */</span>
<a name="l02683"></a><a class="code" href="app__queue_8c.html#abdcc4a1bb61f226f36c2026ec3d65a35">02683</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#abdcc4a1bb61f226f36c2026ec3d65a35" title="Search for best metric and add to Round Robbin queue.">store_next_rr</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keyword">struct</span> <a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *<a class="code" href="structoutgoing.html">outgoing</a>)
<a name="l02684"></a>02684 {
<a name="l02685"></a>02685    <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *best = <a class="code" href="app__queue_8c.html#ab389b8ba466d7d05808b044592b05710" title="find the entry with the best metric, or NULL">find_best</a>(outgoing);
<a name="l02686"></a>02686 
<a name="l02687"></a>02687    <span class="keywordflow">if</span> (best) {
<a name="l02688"></a>02688       <span class="comment">/* Ring just the best channel */</span>
<a name="l02689"></a>02689       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Next is &apos;%s&apos; with metric %d\n&quot;</span>, best-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>, best-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a>);
<a name="l02690"></a>02690       qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a0a7a994a2db49ad4569bfd6db242247b">rrpos</a> = best-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> % 1000;
<a name="l02691"></a>02691    } <span class="keywordflow">else</span> {
<a name="l02692"></a>02692       <span class="comment">/* Just increment rrpos */</span>
<a name="l02693"></a>02693       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#ac3419e9b31cb1aebe3666439449bcecc">wrapped</a>) {
<a name="l02694"></a>02694          <span class="comment">/* No more channels, start over */</span>
<a name="l02695"></a>02695          qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a0a7a994a2db49ad4569bfd6db242247b">rrpos</a> = 0;
<a name="l02696"></a>02696       } <span class="keywordflow">else</span> {
<a name="l02697"></a>02697          <span class="comment">/* Prioritize next entry */</span>
<a name="l02698"></a>02698          qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a0a7a994a2db49ad4569bfd6db242247b">rrpos</a>++;
<a name="l02699"></a>02699       }
<a name="l02700"></a>02700    }
<a name="l02701"></a>02701    qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#ac3419e9b31cb1aebe3666439449bcecc">wrapped</a> = 0;
<a name="l02702"></a>02702 
<a name="l02703"></a>02703    <span class="keywordflow">return</span> 0;
<a name="l02704"></a>02704 }
<a name="l02705"></a>02705 <span class="comment"></span>
<a name="l02706"></a>02706 <span class="comment">/*! \brief Search for best metric and add to Linear queue */</span>
<a name="l02707"></a><a class="code" href="app__queue_8c.html#a8a12ebde49cdd091865dc355f41a3cb9">02707</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a8a12ebde49cdd091865dc355f41a3cb9" title="Search for best metric and add to Linear queue.">store_next_lin</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keyword">struct</span> <a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *<a class="code" href="structoutgoing.html">outgoing</a>)
<a name="l02708"></a>02708 {
<a name="l02709"></a>02709    <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *best = <a class="code" href="app__queue_8c.html#ab389b8ba466d7d05808b044592b05710" title="find the entry with the best metric, or NULL">find_best</a>(outgoing);
<a name="l02710"></a>02710 
<a name="l02711"></a>02711    <span class="keywordflow">if</span> (best) {
<a name="l02712"></a>02712       <span class="comment">/* Ring just the best channel */</span>
<a name="l02713"></a>02713       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Next is &apos;%s&apos; with metric %d\n&quot;</span>, best-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>, best-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a>);
<a name="l02714"></a>02714       qe-&gt;<a class="code" href="structqueue__ent.html#a51db7b9d0e86f2188b541b3d68459930">linpos</a> = best-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> % 1000;
<a name="l02715"></a>02715    } <span class="keywordflow">else</span> {
<a name="l02716"></a>02716       <span class="comment">/* Just increment rrpos */</span>
<a name="l02717"></a>02717       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ab552667d2252975f206fb8a8af49888a">linwrapped</a>) {
<a name="l02718"></a>02718          <span class="comment">/* No more channels, start over */</span>
<a name="l02719"></a>02719          qe-&gt;<a class="code" href="structqueue__ent.html#a51db7b9d0e86f2188b541b3d68459930">linpos</a> = 0;
<a name="l02720"></a>02720       } <span class="keywordflow">else</span> {
<a name="l02721"></a>02721          <span class="comment">/* Prioritize next entry */</span>
<a name="l02722"></a>02722          qe-&gt;<a class="code" href="structqueue__ent.html#a51db7b9d0e86f2188b541b3d68459930">linpos</a>++;
<a name="l02723"></a>02723       }
<a name="l02724"></a>02724    }
<a name="l02725"></a>02725    qe-&gt;<a class="code" href="structqueue__ent.html#ab552667d2252975f206fb8a8af49888a">linwrapped</a> = 0;
<a name="l02726"></a>02726 
<a name="l02727"></a>02727    <span class="keywordflow">return</span> 0;
<a name="l02728"></a>02728 }
<a name="l02729"></a>02729 <span class="comment"></span>
<a name="l02730"></a>02730 <span class="comment">/*! \brief Playback announcement to queued members if peroid has elapsed */</span>
<a name="l02731"></a><a class="code" href="app__queue_8c.html#a3d3fbc78100b994e44f9f270af21c451">02731</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a3d3fbc78100b994e44f9f270af21c451" title="Playback announcement to queued members if peroid has elapsed.">say_periodic_announcement</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keywordtype">int</span> ringing)
<a name="l02732"></a>02732 {
<a name="l02733"></a>02733    <span class="keywordtype">int</span> res = 0;
<a name="l02734"></a>02734    time_t now;
<a name="l02735"></a>02735 
<a name="l02736"></a>02736    <span class="comment">/* Get the current time */</span>
<a name="l02737"></a>02737    time(&amp;now);
<a name="l02738"></a>02738 
<a name="l02739"></a>02739    <span class="comment">/* Check to see if it is time to announce */</span>
<a name="l02740"></a>02740    <span class="keywordflow">if</span> ((now - qe-&gt;<a class="code" href="structqueue__ent.html#a26f62e545090b51f4c7e8efbf2db8d6b">last_periodic_announce_time</a>) &lt; qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a2a43a68cf8add918260068d677434132">periodicannouncefrequency</a>)
<a name="l02741"></a>02741       <span class="keywordflow">return</span> 0;
<a name="l02742"></a>02742 
<a name="l02743"></a>02743    <span class="comment">/* Stop the music on hold so we can play our own file */</span>
<a name="l02744"></a>02744    <span class="keywordflow">if</span> (ringing)
<a name="l02745"></a>02745       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>,-1);
<a name="l02746"></a>02746    <span class="keywordflow">else</span>
<a name="l02747"></a>02747       <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l02748"></a>02748 
<a name="l02749"></a>02749    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Playing periodic announcement\n&quot;</span>);
<a name="l02750"></a>02750    
<a name="l02751"></a>02751    <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a3991228a9e7540246c6cc4cf42c0794d">randomperiodicannounce</a> &amp;&amp; qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a8e2c16675bb0afd19ebeabbcd4329681">numperiodicannounce</a>) {
<a name="l02752"></a>02752       qe-&gt;<a class="code" href="structqueue__ent.html#ac49f311625f4ec75469d1af3e7505a4b">last_periodic_announce_sound</a> = ((<span class="keywordtype">unsigned</span> long) <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>()) % qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a8e2c16675bb0afd19ebeabbcd4329681">numperiodicannounce</a>;
<a name="l02753"></a>02753    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ac49f311625f4ec75469d1af3e7505a4b">last_periodic_announce_sound</a> &gt;= qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a8e2c16675bb0afd19ebeabbcd4329681">numperiodicannounce</a> || 
<a name="l02754"></a>02754       <a class="code" href="strings_8h.html#a99409c17a1d20e1c3dc00039b7925a2d" title="Returns the current length of the string stored within buf.">ast_str_strlen</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">sound_periodicannounce</a>[qe-&gt;<a class="code" href="structqueue__ent.html#ac49f311625f4ec75469d1af3e7505a4b">last_periodic_announce_sound</a>]) == 0) {
<a name="l02755"></a>02755       qe-&gt;<a class="code" href="structqueue__ent.html#ac49f311625f4ec75469d1af3e7505a4b">last_periodic_announce_sound</a> = 0;
<a name="l02756"></a>02756    }
<a name="l02757"></a>02757    
<a name="l02758"></a>02758    <span class="comment">/* play the announcement */</span>
<a name="l02759"></a>02759    res = <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a105b54b12ae3aab330cdcce0b6d71953">sound_periodicannounce</a>[qe-&gt;<a class="code" href="structqueue__ent.html#ac49f311625f4ec75469d1af3e7505a4b">last_periodic_announce_sound</a>]));
<a name="l02760"></a>02760 
<a name="l02761"></a>02761    <span class="keywordflow">if</span> (res &gt; 0 &amp;&amp; !<a class="code" href="app__queue_8c.html#a4df5a56907979a04a511007899753456" title="Check for valid exit from queue via goto.">valid_exit</a>(qe, res))
<a name="l02762"></a>02762       res = 0;
<a name="l02763"></a>02763 
<a name="l02764"></a>02764    <span class="comment">/* Resume Music on Hold if the caller is going to stay in the queue */</span>
<a name="l02765"></a>02765    <span class="keywordflow">if</span> (!res) {
<a name="l02766"></a>02766       <span class="keywordflow">if</span> (ringing)
<a name="l02767"></a>02767          <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>);
<a name="l02768"></a>02768       <span class="keywordflow">else</span>
<a name="l02769"></a>02769          <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>, NULL);
<a name="l02770"></a>02770    }
<a name="l02771"></a>02771 
<a name="l02772"></a>02772    <span class="comment">/* update last_periodic_announce_time */</span>
<a name="l02773"></a>02773    qe-&gt;<a class="code" href="structqueue__ent.html#a26f62e545090b51f4c7e8efbf2db8d6b">last_periodic_announce_time</a> = now;
<a name="l02774"></a>02774 
<a name="l02775"></a>02775    <span class="comment">/* Update the current periodic announcement to the next announcement */</span>
<a name="l02776"></a>02776    <span class="keywordflow">if</span> (!qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a3991228a9e7540246c6cc4cf42c0794d">randomperiodicannounce</a>) {
<a name="l02777"></a>02777       qe-&gt;<a class="code" href="structqueue__ent.html#ac49f311625f4ec75469d1af3e7505a4b">last_periodic_announce_sound</a>++;
<a name="l02778"></a>02778    }
<a name="l02779"></a>02779    
<a name="l02780"></a>02780    <span class="keywordflow">return</span> res;
<a name="l02781"></a>02781 }
<a name="l02782"></a>02782 <span class="comment"></span>
<a name="l02783"></a>02783 <span class="comment">/*! \brief Record that a caller gave up on waiting in queue */</span>
<a name="l02784"></a><a class="code" href="app__queue_8c.html#a0b2ffd959c3ce34b11292c6ecfc8f2d8">02784</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a0b2ffd959c3ce34b11292c6ecfc8f2d8" title="Record that a caller gave up on waiting in queue.">record_abandoned</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe)
<a name="l02785"></a>02785 {
<a name="l02786"></a>02786    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l02787"></a>02787    <a class="code" href="app__queue_8c.html#a1248fe33745c5cb9c87db6be0a25d138" title="Set variables of queue.">set_queue_variables</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l02788"></a>02788    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;QueueCallerAbandon&quot;</span>,
<a name="l02789"></a>02789       <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l02790"></a>02790       <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l02791"></a>02791       <span class="stringliteral">&quot;Position: %d\r\n&quot;</span>
<a name="l02792"></a>02792       <span class="stringliteral">&quot;OriginalPosition: %d\r\n&quot;</span>
<a name="l02793"></a>02793       <span class="stringliteral">&quot;HoldTime: %d\r\n&quot;</span>,
<a name="l02794"></a>02794       qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>, (<span class="keywordtype">int</span>)(time(NULL) - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>));
<a name="l02795"></a>02795 
<a name="l02796"></a>02796    qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a8c3a63527e11cef32f7e5aae9f3f270f">callsabandoned</a>++;
<a name="l02797"></a>02797    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l02798"></a>02798 }
<a name="l02799"></a>02799 <span class="comment"></span>
<a name="l02800"></a>02800 <span class="comment">/*! \brief RNA == Ring No Answer. Common code that is executed when we try a queue member and they don&apos;t answer. */</span>
<a name="l02801"></a><a class="code" href="app__queue_8c.html#a4494107e6b89facddac0e0eb432c3ff4">02801</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a4494107e6b89facddac0e0eb432c3ff4" title="RNA == Ring No Answer. Common code that is executed when we try a queue member and...">rna</a>(<span class="keywordtype">int</span> rnatime, <span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keywordtype">char</span> *<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>, <span class="keywordtype">char</span> *membername, <span class="keywordtype">int</span> pause)
<a name="l02802"></a>02802 {
<a name="l02803"></a>02803    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Nobody picked up in %d ms\n&quot;</span>, rnatime);
<a name="l02804"></a>02804    <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a>) {
<a name="l02805"></a>02805       <span class="keywordtype">char</span> vars[2048];
<a name="l02806"></a>02806 
<a name="l02807"></a>02807       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;AgentRingNoAnswer&quot;</span>,
<a name="l02808"></a>02808                   <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l02809"></a>02809                   <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l02810"></a>02810                   <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l02811"></a>02811                   <span class="stringliteral">&quot;Member: %s\r\n&quot;</span>
<a name="l02812"></a>02812                   <span class="stringliteral">&quot;MemberName: %s\r\n&quot;</span>
<a name="l02813"></a>02813                   <span class="stringliteral">&quot;Ringtime: %d\r\n&quot;</span>
<a name="l02814"></a>02814                   <span class="stringliteral">&quot;%s&quot;</span>,
<a name="l02815"></a>02815                   qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name,
<a name="l02816"></a>02816                   qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid,
<a name="l02817"></a>02817                   qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name,
<a name="l02818"></a>02818                   interface,
<a name="l02819"></a>02819                   membername,
<a name="l02820"></a>02820                   rnatime,
<a name="l02821"></a>02821                   qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a> == <a class="code" href="app__queue_8c.html#a533ee4344c442cf6da3e610598ecca75">QUEUE_EVENT_VARIABLES</a> ? <a class="code" href="app__queue_8c.html#a5f13e8661f3dfcdb919d8140a997cf7a" title="convert &amp;quot;\n&amp;quot; to &amp;quot;\nVariable: &amp;quot; ready for manager to use">vars2manager</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, vars, <span class="keyword">sizeof</span>(vars)) : <span class="stringliteral">&quot;&quot;</span>);
<a name="l02822"></a>02822    }
<a name="l02823"></a>02823    <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, membername, <span class="stringliteral">&quot;RINGNOANSWER&quot;</span>, <span class="stringliteral">&quot;%d&quot;</span>, rnatime);
<a name="l02824"></a>02824    <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a4092d0238a0a8aa7aeaf503a7f0e6380">autopause</a> &amp;&amp; pause) {
<a name="l02825"></a>02825       <span class="keywordflow">if</span> (!<a class="code" href="app__queue_8c.html#a5d60239f838c9f941528fb426bcd2290">set_member_paused</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name, interface, <span class="stringliteral">&quot;Auto-Pause&quot;</span>, 1)) {
<a name="l02826"></a>02826          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Auto-Pausing Queue Member %s in queue %s since they failed to answer.\n&quot;</span>, interface, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name);
<a name="l02827"></a>02827       } <span class="keywordflow">else</span> {
<a name="l02828"></a>02828          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Failed to pause Queue Member %s in queue %s!\n&quot;</span>, interface, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name);
<a name="l02829"></a>02829       }
<a name="l02830"></a>02830    }
<a name="l02831"></a>02831    <span class="keywordflow">return</span>;
<a name="l02832"></a>02832 }
<a name="l02833"></a>02833 
<a name="l02834"></a><a class="code" href="app__queue_8c.html#a618d839aac1e2aa80050a5d54598a33d">02834</a> <span class="preprocessor">#define AST_MAX_WATCHERS 256</span>
<a name="l02835"></a>02835 <span class="preprocessor"></span><span class="comment">/*! \brief Wait for a member to answer the call</span>
<a name="l02836"></a>02836 <span class="comment"> *</span>
<a name="l02837"></a>02837 <span class="comment"> * \param[in] qe the queue_ent corresponding to the caller in the queue</span>
<a name="l02838"></a>02838 <span class="comment"> * \param[in] outgoing the list of callattempts. Relevant ones will have their chan and stillgoing parameters non-zero</span>
<a name="l02839"></a>02839 <span class="comment"> * \param[in] to the amount of time (in milliseconds) to wait for a response</span>
<a name="l02840"></a>02840 <span class="comment"> * \param[out] digit if a user presses a digit to exit the queue, this is the digit the caller pressed</span>
<a name="l02841"></a>02841 <span class="comment"> * \param[in] prebusies number of busy members calculated prior to calling wait_for_answer</span>
<a name="l02842"></a>02842 <span class="comment"> * \param[in] caller_disconnect if the &apos;H&apos; option is used when calling Queue(), this is used to detect if the caller pressed * to disconnect the call</span>
<a name="l02843"></a>02843 <span class="comment"> * \param[in] forwardsallowed used to detect if we should allow call forwarding, based on the &apos;i&apos; option to Queue()</span>
<a name="l02844"></a>02844 <span class="comment"> */</span>
<a name="l02845"></a><a class="code" href="app__queue_8c.html#a0034e8c905ec7f5d1222f3ac4947efa8">02845</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *<a class="code" href="app__queue_8c.html#a0034e8c905ec7f5d1222f3ac4947efa8" title="Wait for a member to answer the call.">wait_for_answer</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keyword">struct</span> <a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *<a class="code" href="structoutgoing.html">outgoing</a>, <span class="keywordtype">int</span> *to, <span class="keywordtype">char</span> *digit, <span class="keywordtype">int</span> prebusies, <span class="keywordtype">int</span> caller_disconnect, <span class="keywordtype">int</span> forwardsallowed)
<a name="l02846"></a>02846 {
<a name="l02847"></a>02847    <span class="keyword">const</span> <span class="keywordtype">char</span> *queue = qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name;
<a name="l02848"></a>02848    <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *o, *<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a> = NULL, *prev = NULL;
<a name="l02849"></a>02849    <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>;
<a name="l02850"></a>02850    <span class="keywordtype">int</span> numbusies = prebusies;
<a name="l02851"></a>02851    <span class="keywordtype">int</span> numnochan = 0;
<a name="l02852"></a>02852    <span class="keywordtype">int</span> <a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a> = 0;
<a name="l02853"></a>02853    <span class="keywordtype">int</span> orig = *to;
<a name="l02854"></a>02854    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l02855"></a>02855    <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *peer = NULL;
<a name="l02856"></a>02856    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *winner;
<a name="l02857"></a>02857    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *in = qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l02858"></a>02858    <span class="keywordtype">char</span> on[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02859"></a>02859    <span class="keywordtype">char</span> membername[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02860"></a>02860    <span class="keywordtype">long</span> <a class="code" href="app__rpt_8c.html#a2a6c54dcdbeb16bb2e1676a4abf4a4d8">starttime</a> = 0;
<a name="l02861"></a>02861    <span class="keywordtype">long</span> endtime = 0;
<a name="l02862"></a>02862 <span class="preprocessor">#ifdef HAVE_EPOLL</span>
<a name="l02863"></a>02863 <span class="preprocessor"></span>   <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *epollo;
<a name="l02864"></a>02864 <span class="preprocessor">#endif</span>
<a name="l02865"></a>02865 <span class="preprocessor"></span>
<a name="l02866"></a>02866    starttime = (long) time(NULL);
<a name="l02867"></a>02867 <span class="preprocessor">#ifdef HAVE_EPOLL</span>
<a name="l02868"></a>02868 <span class="preprocessor"></span>   <span class="keywordflow">for</span> (epollo = outgoing; epollo; epollo = epollo-&gt;<a class="code" href="structcallattempt.html#a9e0459b954643e4b37535fdcb0140326">q_next</a>) {
<a name="l02869"></a>02869       <span class="keywordflow">if</span> (epollo-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l02870"></a>02870          <a class="code" href="channel_8h.html#a1b3f92e2239cd9e9bc20c783e1dedc80">ast_poll_channel_add</a>(in, epollo-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l02871"></a>02871    }
<a name="l02872"></a>02872 <span class="preprocessor">#endif</span>
<a name="l02873"></a>02873 <span class="preprocessor"></span>   
<a name="l02874"></a>02874    <span class="keywordflow">while</span> (*to &amp;&amp; !peer) {
<a name="l02875"></a>02875       <span class="keywordtype">int</span> numlines, retry, <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a> = 1;
<a name="l02876"></a>02876       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *watchers[<a class="code" href="app__dial_8c.html#a618d839aac1e2aa80050a5d54598a33d">AST_MAX_WATCHERS</a>];
<a name="l02877"></a>02877       watchers[0] = in;
<a name="l02878"></a>02878       start = NULL;
<a name="l02879"></a>02879 
<a name="l02880"></a>02880       <span class="keywordflow">for</span> (retry = 0; retry &lt; 2; retry++) {
<a name="l02881"></a>02881          numlines = 0;
<a name="l02882"></a>02882          <span class="keywordflow">for</span> (o = outgoing; o; o = o-&gt;<a class="code" href="structcallattempt.html#a9e0459b954643e4b37535fdcb0140326">q_next</a>) { <span class="comment">/* Keep track of important channels */</span>
<a name="l02883"></a>02883             <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a>) { <span class="comment">/* Keep track of important channels */</span>
<a name="l02884"></a>02884                stillgoing = 1;
<a name="l02885"></a>02885                <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l02886"></a>02886                   watchers[pos++] = o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l02887"></a>02887                   <span class="keywordflow">if</span> (!start)
<a name="l02888"></a>02888                      start = o;
<a name="l02889"></a>02889                   <span class="keywordflow">else</span>
<a name="l02890"></a>02890                      prev-&gt;<a class="code" href="structcallattempt.html#a6babf4f66dfb83d62d08d3401f6e452b">call_next</a> = o;
<a name="l02891"></a>02891                   prev = o;
<a name="l02892"></a>02892                }
<a name="l02893"></a>02893             }
<a name="l02894"></a>02894             numlines++;
<a name="l02895"></a>02895          }
<a name="l02896"></a>02896          <span class="keywordflow">if</span> (pos &gt; 1 <span class="comment">/* found */</span> || !stillgoing <span class="comment">/* nobody listening */</span> ||
<a name="l02897"></a>02897             (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> != <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>) <span class="comment">/* ring would not be delivered */</span>)
<a name="l02898"></a>02898             <span class="keywordflow">break</span>;
<a name="l02899"></a>02899          <span class="comment">/* On &quot;ringall&quot; strategy we only move to the next penalty level</span>
<a name="l02900"></a>02900 <span class="comment">            when *all* ringing phones are done in the current penalty level */</span>
<a name="l02901"></a>02901          <a class="code" href="app__queue_8c.html#af0efe7e816fe1c82ebac5d82a3218b31" title="Place a call to a queue member.">ring_one</a>(qe, outgoing, &amp;numbusies);
<a name="l02902"></a>02902          <span class="comment">/* and retry... */</span>
<a name="l02903"></a>02903       }
<a name="l02904"></a>02904       <span class="keywordflow">if</span> (pos == 1 <span class="comment">/* not found */</span>) {
<a name="l02905"></a>02905          <span class="keywordflow">if</span> (numlines == (numbusies + numnochan)) {
<a name="l02906"></a>02906             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Everyone is busy at this time\n&quot;</span>);
<a name="l02907"></a>02907          } <span class="keywordflow">else</span> {
<a name="l02908"></a>02908             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;No one is answering queue &apos;%s&apos; (%d numlines / %d busies / %d failed channels)\n&quot;</span>, queue, numlines, numbusies, numnochan);
<a name="l02909"></a>02909          }
<a name="l02910"></a>02910          *to = 0;
<a name="l02911"></a>02911          <span class="keywordflow">return</span> NULL;
<a name="l02912"></a>02912       }
<a name="l02913"></a>02913 
<a name="l02914"></a>02914       <span class="comment">/* Poll for events from both the incoming channel as well as any outgoing channels */</span>
<a name="l02915"></a>02915       winner = <a class="code" href="channel_8h.html#aec8ce59b78afbd3651f3de011f13290a" title="Waits for input on a group of channels Wait for input on an array of channels for...">ast_waitfor_n</a>(watchers, pos, to);
<a name="l02916"></a>02916 
<a name="l02917"></a>02917       <span class="comment">/* Service all of the outgoing channels */</span>
<a name="l02918"></a>02918       <span class="keywordflow">for</span> (o = start; o; o = o-&gt;<a class="code" href="structcallattempt.html#a6babf4f66dfb83d62d08d3401f6e452b">call_next</a>) {
<a name="l02919"></a>02919          <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a> &amp;&amp; (o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) &amp;&amp;  (o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)) {
<a name="l02920"></a>02920             <span class="keywordflow">if</span> (!peer) {
<a name="l02921"></a>02921                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;%s answered %s\n&quot;</span>, o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, in-&gt;name);
<a name="l02922"></a>02922                peer = o;
<a name="l02923"></a>02923             }
<a name="l02924"></a>02924          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp; (o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> == winner)) {
<a name="l02925"></a>02925 
<a name="l02926"></a>02926             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(on, o-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, <span class="keyword">sizeof</span>(on));
<a name="l02927"></a>02927             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(membername, o-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, <span class="keyword">sizeof</span>(membername));
<a name="l02928"></a>02928 
<a name="l02929"></a>02929             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;call_forward) &amp;&amp; !forwardsallowed) {
<a name="l02930"></a>02930                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Forwarding %s to &apos;%s&apos; prevented.\n&quot;</span>, in-&gt;name, o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;call_forward);
<a name="l02931"></a>02931                numnochan++;
<a name="l02932"></a>02932                <a class="code" href="app__queue_8c.html#a37f1ce6ab6c24242c99997e17ec4fc33" title="common hangup actions">do_hang</a>(o);
<a name="l02933"></a>02933                winner = NULL;
<a name="l02934"></a>02934                <span class="keywordflow">continue</span>;
<a name="l02935"></a>02935             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;call_forward)) {
<a name="l02936"></a>02936                <span class="keywordtype">char</span> tmpchan[256];
<a name="l02937"></a>02937                <span class="keywordtype">char</span> *stuff;
<a name="l02938"></a>02938                <span class="keywordtype">char</span> *<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>;
<a name="l02939"></a>02939 
<a name="l02940"></a>02940                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmpchan, o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;call_forward, <span class="keyword">sizeof</span>(tmpchan));
<a name="l02941"></a>02941                <span class="keywordflow">if</span> ((stuff = strchr(tmpchan, <span class="charliteral">&apos;/&apos;</span>))) {
<a name="l02942"></a>02942                   *stuff++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02943"></a>02943                   tech = tmpchan;
<a name="l02944"></a>02944                } <span class="keywordflow">else</span> {
<a name="l02945"></a>02945                   snprintf(tmpchan, <span class="keyword">sizeof</span>(tmpchan), <span class="stringliteral">&quot;%s@%s&quot;</span>, o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;call_forward, o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l02946"></a>02946                   stuff = tmpchan;
<a name="l02947"></a>02947                   tech = <span class="stringliteral">&quot;Local&quot;</span>;
<a name="l02948"></a>02948                }
<a name="l02949"></a>02949                <span class="comment">/* Before processing channel, go ahead and check for forwarding */</span>
<a name="l02950"></a>02950                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Now forwarding %s to &apos;%s/%s&apos; (thanks to %s)\n&quot;</span>, in-&gt;name, tech, stuff, o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l02951"></a>02951                <span class="comment">/* Setup parameters */</span>
<a name="l02952"></a>02952                o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = <a class="code" href="channel_8h.html#a922b0c040026477b8e2020211abf604a" title="Requests a channel.">ast_request</a>(tech, in-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>, stuff, &amp;status);
<a name="l02953"></a>02953                <span class="keywordflow">if</span> (!o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l02954"></a>02954                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to create local channel for call forward to &apos;%s/%s&apos;\n&quot;</span>, tech, stuff);
<a name="l02955"></a>02955                   o-&gt;<a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a> = 0;
<a name="l02956"></a>02956                   numnochan++;
<a name="l02957"></a>02957                } <span class="keywordflow">else</span> {
<a name="l02958"></a>02958                   <a class="code" href="channel_8h.html#a892b6550a4f90b70ad92198c9d05cedc" title="Inherits channel variable from parent to child channel.">ast_channel_inherit_variables</a>(in, o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l02959"></a>02959                   <a class="code" href="channel_8h.html#a6ce892974f59537bda03a71319b452e2" title="Inherit datastores from a parent to a child.">ast_channel_datastore_inherit</a>(in, o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l02960"></a>02960                   <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)
<a name="l02961"></a>02961                      <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>);
<a name="l02962"></a>02962                   o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(in-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>);
<a name="l02963"></a>02963 
<a name="l02964"></a>02964                   <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>)
<a name="l02965"></a>02965                      <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>);
<a name="l02966"></a>02966                   o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(in-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>);
<a name="l02967"></a>02967 
<a name="l02968"></a>02968                   <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="chan__iax2_8c.html#adfee50d07a98645d4d20b896ce03785a">accountcode</a>, in-&gt;accountcode);
<a name="l02969"></a>02969                   o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a45c4bec79a4bc84fdd2d2c67f6605a6c">cdrflags</a> = in-&gt;<a class="code" href="structast__channel.html#a45c4bec79a4bc84fdd2d2c67f6605a6c">cdrflags</a>;
<a name="l02970"></a>02970 
<a name="l02971"></a>02971                   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a>) {
<a name="l02972"></a>02972                      <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a>)
<a name="l02973"></a>02973                         <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a>);
<a name="l02974"></a>02974                      o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(in-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a>);
<a name="l02975"></a>02975                   }
<a name="l02976"></a>02976                   <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a4791c5f3aedc8782678867a1741f4131">cid_rdnis</a>)
<a name="l02977"></a>02977                      <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a4791c5f3aedc8782678867a1741f4131">cid_rdnis</a>);
<a name="l02978"></a>02978                   o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a4791c5f3aedc8782678867a1741f4131">cid_rdnis</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(in-&gt;<a class="code" href="structast__channel.html#a582cff3075953f73ba96888167acf009">macroexten</a>, in-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l02979"></a>02979                   <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#ae212e5f3ae50a869bbf859fe9db7dee0" title="Make a call.">ast_call</a>(o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, tmpchan, 0)) {
<a name="l02980"></a>02980                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Failed to dial on local channel for call forward to &apos;%s&apos;\n&quot;</span>, tmpchan);
<a name="l02981"></a>02981                      <a class="code" href="app__queue_8c.html#a37f1ce6ab6c24242c99997e17ec4fc33" title="common hangup actions">do_hang</a>(o);
<a name="l02982"></a>02982                      numnochan++;
<a name="l02983"></a>02983                   }
<a name="l02984"></a>02984                }
<a name="l02985"></a>02985                <span class="comment">/* Hangup the original channel now, in case we needed it */</span>
<a name="l02986"></a>02986                <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(winner);
<a name="l02987"></a>02987                <span class="keywordflow">continue</span>;
<a name="l02988"></a>02988             }
<a name="l02989"></a>02989             f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(winner);
<a name="l02990"></a>02990             <span class="keywordflow">if</span> (f) {
<a name="l02991"></a>02991                <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>) {
<a name="l02992"></a>02992                   <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) {
<a name="l02993"></a>02993                   <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a9e3135920bd5bdbfd8c57fdaaa6b1dbe">AST_CONTROL_ANSWER</a>:
<a name="l02994"></a>02994                      <span class="comment">/* This is our guy if someone answered. */</span>
<a name="l02995"></a>02995                      <span class="keywordflow">if</span> (!peer) {
<a name="l02996"></a>02996                         <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;%s answered %s\n&quot;</span>, o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, in-&gt;name);
<a name="l02997"></a>02997                         peer = o;
<a name="l02998"></a>02998                      }
<a name="l02999"></a>02999                      <span class="keywordflow">break</span>;
<a name="l03000"></a>03000                   <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a387635982df3d2edb669a1eece92c875">AST_CONTROL_BUSY</a>:
<a name="l03001"></a>03001                      <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;%s is busy\n&quot;</span>, o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l03002"></a>03002                      <span class="keywordflow">if</span> (in-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l03003"></a>03003                         <a class="code" href="cdr_8h.html#a4df18ef44f74b2dce240ca02a9c22ddf" title="Busy a call.">ast_cdr_busy</a>(in-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l03004"></a>03004                      <a class="code" href="app__queue_8c.html#a37f1ce6ab6c24242c99997e17ec4fc33" title="common hangup actions">do_hang</a>(o);
<a name="l03005"></a>03005                      endtime = (long) time(NULL);
<a name="l03006"></a>03006                      endtime -= starttime;
<a name="l03007"></a>03007                      <a class="code" href="app__queue_8c.html#a4494107e6b89facddac0e0eb432c3ff4" title="RNA == Ring No Answer. Common code that is executed when we try a queue member and...">rna</a>(endtime * 1000, qe, on, membername, 0);
<a name="l03008"></a>03008                      <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> != <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>) {
<a name="l03009"></a>03009                         <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a24cf7a74d65e1d4f4b9bfd16455187fb">timeoutrestart</a>)
<a name="l03010"></a>03010                            *to = orig;
<a name="l03011"></a>03011                         <span class="comment">/* Have enough time for a queue member to answer? */</span>
<a name="l03012"></a>03012                         <span class="keywordflow">if</span> (*to &gt; 500) {
<a name="l03013"></a>03013                            <a class="code" href="app__queue_8c.html#af0efe7e816fe1c82ebac5d82a3218b31" title="Place a call to a queue member.">ring_one</a>(qe, outgoing, &amp;numbusies);
<a name="l03014"></a>03014                            starttime = (long) time(NULL);
<a name="l03015"></a>03015                         }
<a name="l03016"></a>03016                      }
<a name="l03017"></a>03017                      numbusies++;
<a name="l03018"></a>03018                      <span class="keywordflow">break</span>;
<a name="l03019"></a>03019                   <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a850bb06a1702741c93a3fd67cc9637ab">AST_CONTROL_CONGESTION</a>:
<a name="l03020"></a>03020                      <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;%s is circuit-busy\n&quot;</span>, o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l03021"></a>03021                      <span class="keywordflow">if</span> (in-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l03022"></a>03022                         <a class="code" href="cdr_8h.html#a4df18ef44f74b2dce240ca02a9c22ddf" title="Busy a call.">ast_cdr_busy</a>(in-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l03023"></a>03023                      endtime = (long) time(NULL);
<a name="l03024"></a>03024                      endtime -= starttime;
<a name="l03025"></a>03025                      <a class="code" href="app__queue_8c.html#a4494107e6b89facddac0e0eb432c3ff4" title="RNA == Ring No Answer. Common code that is executed when we try a queue member and...">rna</a>(endtime * 1000, qe, on, membername, 0);
<a name="l03026"></a>03026                      <a class="code" href="app__queue_8c.html#a37f1ce6ab6c24242c99997e17ec4fc33" title="common hangup actions">do_hang</a>(o);
<a name="l03027"></a>03027                      <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> != <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>) {
<a name="l03028"></a>03028                         <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a24cf7a74d65e1d4f4b9bfd16455187fb">timeoutrestart</a>)
<a name="l03029"></a>03029                            *to = orig;
<a name="l03030"></a>03030                         <span class="keywordflow">if</span> (*to &gt; 500) {
<a name="l03031"></a>03031                            <a class="code" href="app__queue_8c.html#af0efe7e816fe1c82ebac5d82a3218b31" title="Place a call to a queue member.">ring_one</a>(qe, outgoing, &amp;numbusies);
<a name="l03032"></a>03032                            starttime = (long) time(NULL);
<a name="l03033"></a>03033                         }
<a name="l03034"></a>03034                      }
<a name="l03035"></a>03035                      numbusies++;
<a name="l03036"></a>03036                      <span class="keywordflow">break</span>;
<a name="l03037"></a>03037                   <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>:
<a name="l03038"></a>03038                      <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;%s is ringing\n&quot;</span>, o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l03039"></a>03039                      <span class="keywordflow">break</span>;
<a name="l03040"></a>03040                   <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a28cd8e9f9005e25624f993d6edd46755">AST_CONTROL_OFFHOOK</a>:
<a name="l03041"></a>03041                      <span class="comment">/* Ignore going off hook */</span>
<a name="l03042"></a>03042                      <span class="keywordflow">break</span>;
<a name="l03043"></a>03043                   <span class="keywordflow">default</span>:
<a name="l03044"></a>03044                      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Dunno what to do with control type %d\n&quot;</span>, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l03045"></a>03045                   }
<a name="l03046"></a>03046                }
<a name="l03047"></a>03047                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l03048"></a>03048             } <span class="keywordflow">else</span> { <span class="comment">/* ast_read() returned NULL */</span>
<a name="l03049"></a>03049                endtime = (long) time(NULL) - starttime;
<a name="l03050"></a>03050                <a class="code" href="app__queue_8c.html#a4494107e6b89facddac0e0eb432c3ff4" title="RNA == Ring No Answer. Common code that is executed when we try a queue member and...">rna</a>(endtime * 1000, qe, on, membername, 1);
<a name="l03051"></a>03051                <a class="code" href="app__queue_8c.html#a37f1ce6ab6c24242c99997e17ec4fc33" title="common hangup actions">do_hang</a>(o);
<a name="l03052"></a>03052                <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> != <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>) {
<a name="l03053"></a>03053                   <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a24cf7a74d65e1d4f4b9bfd16455187fb">timeoutrestart</a>)
<a name="l03054"></a>03054                      *to = orig;
<a name="l03055"></a>03055                   <span class="keywordflow">if</span> (*to &gt; 500) {
<a name="l03056"></a>03056                      <a class="code" href="app__queue_8c.html#af0efe7e816fe1c82ebac5d82a3218b31" title="Place a call to a queue member.">ring_one</a>(qe, outgoing, &amp;numbusies);
<a name="l03057"></a>03057                      starttime = (long) time(NULL);
<a name="l03058"></a>03058                   }
<a name="l03059"></a>03059                }
<a name="l03060"></a>03060             }
<a name="l03061"></a>03061          }
<a name="l03062"></a>03062       }
<a name="l03063"></a>03063 
<a name="l03064"></a>03064       <span class="comment">/* If we received an event from the caller, deal with it. */</span>
<a name="l03065"></a>03065       <span class="keywordflow">if</span> (winner == in) {
<a name="l03066"></a>03066          f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(in);
<a name="l03067"></a>03067          <span class="keywordflow">if</span> (!f || ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>) &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa7dac1c1896ab418c2ff351aae707fba">AST_CONTROL_HANGUP</a>))) {
<a name="l03068"></a>03068             <span class="comment">/* Got hung up */</span>
<a name="l03069"></a>03069             *to = -1;
<a name="l03070"></a>03070             <span class="keywordflow">if</span> (f) {
<a name="l03071"></a>03071                <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#a5ad776be1fb768f3399aafcd1b58b3a2">uint32</a>) {
<a name="l03072"></a>03072                   in-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a> = f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#a5ad776be1fb768f3399aafcd1b58b3a2">uint32</a>;
<a name="l03073"></a>03073                }
<a name="l03074"></a>03074                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l03075"></a>03075             }
<a name="l03076"></a>03076             <span class="keywordflow">return</span> NULL;
<a name="l03077"></a>03077          }
<a name="l03078"></a>03078          <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) &amp;&amp; caller_disconnect &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <span class="charliteral">&apos;*&apos;</span>)) {
<a name="l03079"></a>03079             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User hit %c to disconnect call.\n&quot;</span>, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l03080"></a>03080             *to = 0;
<a name="l03081"></a>03081             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l03082"></a>03082             <span class="keywordflow">return</span> NULL;
<a name="l03083"></a>03083          }
<a name="l03084"></a>03084          <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) &amp;&amp; <a class="code" href="app__queue_8c.html#a4df5a56907979a04a511007899753456" title="Check for valid exit from queue via goto.">valid_exit</a>(qe, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>)) {
<a name="l03085"></a>03085             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User pressed digit: %c\n&quot;</span>, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l03086"></a>03086             *to = 0;
<a name="l03087"></a>03087             *digit = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l03088"></a>03088             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l03089"></a>03089             <span class="keywordflow">return</span> NULL;
<a name="l03090"></a>03090          }
<a name="l03091"></a>03091          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l03092"></a>03092       }
<a name="l03093"></a>03093       <span class="keywordflow">if</span> (!*to) {
<a name="l03094"></a>03094          <span class="keywordflow">for</span> (o = start; o; o = o-&gt;<a class="code" href="structcallattempt.html#a6babf4f66dfb83d62d08d3401f6e452b">call_next</a>)
<a name="l03095"></a>03095             <a class="code" href="app__queue_8c.html#a4494107e6b89facddac0e0eb432c3ff4" title="RNA == Ring No Answer. Common code that is executed when we try a queue member and...">rna</a>(orig, qe, o-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>, o-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, 1);
<a name="l03096"></a>03096       }
<a name="l03097"></a>03097    }
<a name="l03098"></a>03098 
<a name="l03099"></a>03099 <span class="preprocessor">#ifdef HAVE_EPOLL</span>
<a name="l03100"></a>03100 <span class="preprocessor"></span>   <span class="keywordflow">for</span> (epollo = outgoing; epollo; epollo = epollo-&gt;<a class="code" href="structcallattempt.html#a9e0459b954643e4b37535fdcb0140326">q_next</a>) {
<a name="l03101"></a>03101       <span class="keywordflow">if</span> (epollo-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l03102"></a>03102          <a class="code" href="channel_8h.html#a6b2da1bbe090143571ba1db7f94055a0">ast_poll_channel_del</a>(in, epollo-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03103"></a>03103    }
<a name="l03104"></a>03104 <span class="preprocessor">#endif</span>
<a name="l03105"></a>03105 <span class="preprocessor"></span>
<a name="l03106"></a>03106    <span class="keywordflow">return</span> peer;
<a name="l03107"></a>03107 }
<a name="l03108"></a>03108 <span class="comment"></span>
<a name="l03109"></a>03109 <span class="comment">/*! </span>
<a name="l03110"></a>03110 <span class="comment"> * \brief Check if we should start attempting to call queue members.</span>
<a name="l03111"></a>03111 <span class="comment"> *</span>
<a name="l03112"></a>03112 <span class="comment"> * A simple process, really. Count the number of members who are available</span>
<a name="l03113"></a>03113 <span class="comment"> * to take our call and then see if we are in a position in the queue at</span>
<a name="l03114"></a>03114 <span class="comment"> * which a member could accept our call.</span>
<a name="l03115"></a>03115 <span class="comment"> *</span>
<a name="l03116"></a>03116 <span class="comment"> * \param[in] qe The caller who wants to know if it is his turn</span>
<a name="l03117"></a>03117 <span class="comment"> * \retval 0 It is not our turn</span>
<a name="l03118"></a>03118 <span class="comment"> * \retval 1 It is our turn</span>
<a name="l03119"></a>03119 <span class="comment"> */</span>
<a name="l03120"></a><a class="code" href="app__queue_8c.html#a09df986cff00524f91c16051486231ec">03120</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a09df986cff00524f91c16051486231ec" title="Check if we should start attempting to call queue members.">is_our_turn</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe)
<a name="l03121"></a>03121 {
<a name="l03122"></a>03122    <span class="keyword">struct </span><a class="code" href="structqueue__ent.html">queue_ent</a> *ch;
<a name="l03123"></a>03123    <span class="keywordtype">int</span> res;
<a name="l03124"></a>03124    <span class="keywordtype">int</span> avl;
<a name="l03125"></a>03125    <span class="keywordtype">int</span> idx = 0;
<a name="l03126"></a>03126    <span class="comment">/* This needs a lock. How many members are available to be served? */</span>
<a name="l03127"></a>03127    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03128"></a>03128 
<a name="l03129"></a>03129    avl = <a class="code" href="app__queue_8c.html#ab9873b95b03723c7f06d85b044b9e96c" title="Get the number of members available to accept a call.">num_available_members</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03130"></a>03130 
<a name="l03131"></a>03131    ch = qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a4cee904f94736300a8eba28cc5763bed">head</a>;
<a name="l03132"></a>03132 
<a name="l03133"></a>03133    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;There %s %d available %s.\n&quot;</span>, avl != 1 ? <span class="stringliteral">&quot;are&quot;</span> : <span class="stringliteral">&quot;is&quot;</span>, avl, avl != 1 ? <span class="stringliteral">&quot;members&quot;</span> : <span class="stringliteral">&quot;member&quot;</span>);
<a name="l03134"></a>03134 
<a name="l03135"></a>03135    <span class="keywordflow">while</span> ((idx &lt; avl) &amp;&amp; (ch) &amp;&amp; (ch != qe)) {
<a name="l03136"></a>03136       <span class="keywordflow">if</span> (!ch-&gt;<a class="code" href="structqueue__ent.html#a79ec26d453dcd29aec17f5536233e849">pending</a>)
<a name="l03137"></a>03137          idx++;
<a name="l03138"></a>03138       ch = ch-&gt;next;       
<a name="l03139"></a>03139    }
<a name="l03140"></a>03140 
<a name="l03141"></a>03141    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03142"></a>03142    <span class="comment">/* If the queue entry is within avl [the number of available members] calls from the top ... </span>
<a name="l03143"></a>03143 <span class="comment">    * Autofill and position check added to support autofill=no (as only calls</span>
<a name="l03144"></a>03144 <span class="comment">    * from the front of the queue are valid when autofill is disabled)</span>
<a name="l03145"></a>03145 <span class="comment">    */</span>
<a name="l03146"></a>03146    <span class="keywordflow">if</span> (ch &amp;&amp; idx &lt; avl &amp;&amp; (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a76e20f3c9df399ad87bb4e45c7419e99">autofill</a> || qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 1)) {
<a name="l03147"></a>03147       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;It&apos;s our turn (%s).\n&quot;</span>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l03148"></a>03148       res = 1;
<a name="l03149"></a>03149    } <span class="keywordflow">else</span> {
<a name="l03150"></a>03150       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;It&apos;s not our turn (%s).\n&quot;</span>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l03151"></a>03151       res = 0;
<a name="l03152"></a>03152    }
<a name="l03153"></a>03153 
<a name="l03154"></a>03154    <span class="keywordflow">return</span> res;
<a name="l03155"></a>03155 }
<a name="l03156"></a>03156 <span class="comment"></span>
<a name="l03157"></a>03157 <span class="comment">/*!</span>
<a name="l03158"></a>03158 <span class="comment"> * \brief update rules for queues</span>
<a name="l03159"></a>03159 <span class="comment"> *</span>
<a name="l03160"></a>03160 <span class="comment"> * Calculate min/max penalties making sure if relative they stay within bounds.</span>
<a name="l03161"></a>03161 <span class="comment"> * Update queues penalty and set dialplan vars, goto next list entry.</span>
<a name="l03162"></a>03162 <span class="comment">*/</span>
<a name="l03163"></a><a class="code" href="app__queue_8c.html#aa1efb798e09a88e68559b08c90c573ee">03163</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#aa1efb798e09a88e68559b08c90c573ee" title="update rules for queues">update_qe_rule</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe)
<a name="l03164"></a>03164 {
<a name="l03165"></a>03165    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a> = qe-&gt;pr-&gt;max_relative ? qe-&gt;<a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a> + qe-&gt;pr-&gt;max_value : qe-&gt;pr-&gt;max_value;
<a name="l03166"></a>03166    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a> = qe-&gt;pr-&gt;min_relative ? qe-&gt;<a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a> + qe-&gt;pr-&gt;min_value : qe-&gt;pr-&gt;min_value;
<a name="l03167"></a>03167    <span class="keywordtype">char</span> max_penalty_str[20], min_penalty_str[20]; 
<a name="l03168"></a>03168    <span class="comment">/* a relative change to the penalty could put it below 0 */</span>
<a name="l03169"></a>03169    <span class="keywordflow">if</span> (max_penalty &lt; 0)
<a name="l03170"></a>03170       max_penalty = 0;
<a name="l03171"></a>03171    <span class="keywordflow">if</span> (min_penalty &lt; 0)
<a name="l03172"></a>03172       min_penalty = 0;
<a name="l03173"></a>03173    <span class="keywordflow">if</span> (min_penalty &gt; max_penalty)
<a name="l03174"></a>03174       min_penalty = max_penalty;
<a name="l03175"></a>03175    snprintf(max_penalty_str, <span class="keyword">sizeof</span>(max_penalty_str), <span class="stringliteral">&quot;%d&quot;</span>, max_penalty);
<a name="l03176"></a>03176    snprintf(min_penalty_str, <span class="keyword">sizeof</span>(min_penalty_str), <span class="stringliteral">&quot;%d&quot;</span>, min_penalty);
<a name="l03177"></a>03177    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;QUEUE_MAX_PENALTY&quot;</span>, max_penalty_str);
<a name="l03178"></a>03178    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;QUEUE_MIN_PENALTY&quot;</span>, min_penalty_str);
<a name="l03179"></a>03179    qe-&gt;<a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a> = max_penalty;
<a name="l03180"></a>03180    qe-&gt;<a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a> = min_penalty;
<a name="l03181"></a>03181    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Setting max penalty to %d and min penalty to %d for caller %s since %d seconds have elapsed\n&quot;</span>, qe-&gt;<a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, qe-&gt;pr-&gt;time);
<a name="l03182"></a>03182    qe-&gt;pr = <a class="code" href="linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6" title="Returns the next entry in the list after the given entry.">AST_LIST_NEXT</a>(qe-&gt;pr, list);
<a name="l03183"></a>03183 }
<a name="l03184"></a>03184 <span class="comment"></span>
<a name="l03185"></a>03185 <span class="comment">/*! \brief The waiting areas for callers who are not actively calling members</span>
<a name="l03186"></a>03186 <span class="comment"> *</span>
<a name="l03187"></a>03187 <span class="comment"> * This function is one large loop. This function will return if a caller</span>
<a name="l03188"></a>03188 <span class="comment"> * either exits the queue or it becomes that caller&apos;s turn to attempt calling</span>
<a name="l03189"></a>03189 <span class="comment"> * queue members. Inside the loop, we service the caller with periodic announcements,</span>
<a name="l03190"></a>03190 <span class="comment"> * holdtime announcements, etc. as configured in queues.conf</span>
<a name="l03191"></a>03191 <span class="comment"> *</span>
<a name="l03192"></a>03192 <span class="comment"> * \retval  0 if the caller&apos;s turn has arrived</span>
<a name="l03193"></a>03193 <span class="comment"> * \retval -1 if the caller should exit the queue.</span>
<a name="l03194"></a>03194 <span class="comment"> */</span>
<a name="l03195"></a><a class="code" href="app__queue_8c.html#a54d8f5c6ba5bd46020c7c319fa5a89c2">03195</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a54d8f5c6ba5bd46020c7c319fa5a89c2" title="The waiting areas for callers who are not actively calling members.">wait_our_turn</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keywordtype">int</span> ringing, <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2">queue_result</a> *reason)
<a name="l03196"></a>03196 {
<a name="l03197"></a>03197    <span class="keywordtype">int</span> res = 0;
<a name="l03198"></a>03198 
<a name="l03199"></a>03199    <span class="comment">/* This is the holding pen for callers 2 through maxlen */</span>
<a name="l03200"></a>03200    <span class="keywordflow">for</span> (;;) {
<a name="l03201"></a>03201 
<a name="l03202"></a>03202       <span class="keywordflow">if</span> (<a class="code" href="app__queue_8c.html#a09df986cff00524f91c16051486231ec" title="Check if we should start attempting to call queue members.">is_our_turn</a>(qe))
<a name="l03203"></a>03203          <span class="keywordflow">break</span>;
<a name="l03204"></a>03204 
<a name="l03205"></a>03205       <span class="comment">/* If we have timed out, break out */</span>
<a name="l03206"></a>03206       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> &amp;&amp; (time(NULL) &gt;= qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a>)) {
<a name="l03207"></a>03207          *reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2af24af6741501e58c5a32990e70a35a5d">QUEUE_TIMEOUT</a>;
<a name="l03208"></a>03208          <span class="keywordflow">break</span>;
<a name="l03209"></a>03209       }
<a name="l03210"></a>03210 
<a name="l03211"></a>03211       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a77bab4023f1969460cc9c64baa39e016">leavewhenempty</a>) {
<a name="l03212"></a>03212          <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 0;
<a name="l03213"></a>03213 
<a name="l03214"></a>03214          <span class="keywordflow">if</span> ((status = <a class="code" href="app__queue_8c.html#ac038b08379d8bdb21a862f1bafe729d4" title="Check if members are available.">get_member_status</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a77bab4023f1969460cc9c64baa39e016">leavewhenempty</a>))) {
<a name="l03215"></a>03215             *reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a96a1965ee856fa58fbd96bc5b0ffc101">QUEUE_LEAVEEMPTY</a>;
<a name="l03216"></a>03216             <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, <span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;EXITEMPTY&quot;</span>, <span class="stringliteral">&quot;%d|%d|%ld&quot;</span>, qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>, (<span class="keywordtype">long</span>) time(NULL) - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>);
<a name="l03217"></a>03217             <a class="code" href="app__queue_8c.html#a3135d5c6b468bef49c1e3fc5d7394f30" title="Caller leaving queue.">leave_queue</a>(qe);
<a name="l03218"></a>03218             <span class="keywordflow">break</span>;
<a name="l03219"></a>03219          }
<a name="l03220"></a>03220       }
<a name="l03221"></a>03221 
<a name="l03222"></a>03222       <span class="comment">/* Make a position announcement, if enabled */</span>
<a name="l03223"></a>03223       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a158e72e504d11a5f6cdfa8d25343adbb">announcefrequency</a> &amp;&amp;
<a name="l03224"></a>03224          (res = <a class="code" href="app__queue_8c.html#ad395c86c08af4a1c22518966e9ead32f">say_position</a>(qe,ringing)))
<a name="l03225"></a>03225          <span class="keywordflow">break</span>;
<a name="l03226"></a>03226 
<a name="l03227"></a>03227       <span class="comment">/* If we have timed out, break out */</span>
<a name="l03228"></a>03228       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> &amp;&amp; (time(NULL) &gt;= qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a>)) {
<a name="l03229"></a>03229          *reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2af24af6741501e58c5a32990e70a35a5d">QUEUE_TIMEOUT</a>;
<a name="l03230"></a>03230          <span class="keywordflow">break</span>;
<a name="l03231"></a>03231       }
<a name="l03232"></a>03232 
<a name="l03233"></a>03233       <span class="comment">/* Make a periodic announcement, if enabled */</span>
<a name="l03234"></a>03234       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a2a43a68cf8add918260068d677434132">periodicannouncefrequency</a> &amp;&amp;
<a name="l03235"></a>03235          (res = <a class="code" href="app__queue_8c.html#a3d3fbc78100b994e44f9f270af21c451" title="Playback announcement to queued members if peroid has elapsed.">say_periodic_announcement</a>(qe,ringing)))
<a name="l03236"></a>03236          <span class="keywordflow">break</span>;
<a name="l03237"></a>03237       
<a name="l03238"></a>03238       <span class="comment">/* see if we need to move to the next penalty level for this queue */</span>
<a name="l03239"></a>03239       <span class="keywordflow">while</span> (qe-&gt;pr &amp;&amp; ((time(NULL) - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>) &gt;= qe-&gt;pr-&gt;time)) {
<a name="l03240"></a>03240          <a class="code" href="app__queue_8c.html#aa1efb798e09a88e68559b08c90c573ee" title="update rules for queues">update_qe_rule</a>(qe);
<a name="l03241"></a>03241       }
<a name="l03242"></a>03242 
<a name="l03243"></a>03243       <span class="comment">/* If we have timed out, break out */</span>
<a name="l03244"></a>03244       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> &amp;&amp; (time(NULL) &gt;= qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a>)) {
<a name="l03245"></a>03245          *reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2af24af6741501e58c5a32990e70a35a5d">QUEUE_TIMEOUT</a>;
<a name="l03246"></a>03246          <span class="keywordflow">break</span>;
<a name="l03247"></a>03247       }
<a name="l03248"></a>03248       
<a name="l03249"></a>03249       <span class="comment">/* Wait a second before checking again */</span>
<a name="l03250"></a>03250       <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="app__queue_8c.html#ac483b545204943907eab26ae059e65dd">RECHECK</a> * 1000))) {
<a name="l03251"></a>03251          <span class="keywordflow">if</span> (res &gt; 0 &amp;&amp; !<a class="code" href="app__queue_8c.html#a4df5a56907979a04a511007899753456" title="Check for valid exit from queue via goto.">valid_exit</a>(qe, res))
<a name="l03252"></a>03252             res = 0;
<a name="l03253"></a>03253          <span class="keywordflow">else</span>
<a name="l03254"></a>03254             <span class="keywordflow">break</span>;
<a name="l03255"></a>03255       }
<a name="l03256"></a>03256       
<a name="l03257"></a>03257       <span class="comment">/* If we have timed out, break out */</span>
<a name="l03258"></a>03258       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> &amp;&amp; (time(NULL) &gt;= qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a>)) {
<a name="l03259"></a>03259          *reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2af24af6741501e58c5a32990e70a35a5d">QUEUE_TIMEOUT</a>;
<a name="l03260"></a>03260          <span class="keywordflow">break</span>;
<a name="l03261"></a>03261       }
<a name="l03262"></a>03262    }
<a name="l03263"></a>03263 
<a name="l03264"></a>03264    <span class="keywordflow">return</span> res;
<a name="l03265"></a>03265 }
<a name="l03266"></a>03266 <span class="comment"></span>
<a name="l03267"></a>03267 <span class="comment">/*!</span>
<a name="l03268"></a>03268 <span class="comment"> * \brief update the queue status</span>
<a name="l03269"></a>03269 <span class="comment"> * \retval Always 0</span>
<a name="l03270"></a>03270 <span class="comment">*/</span>
<a name="l03271"></a><a class="code" href="app__queue_8c.html#a62226f8ba56b53bd8b3f9ee8d8a4877d">03271</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a62226f8ba56b53bd8b3f9ee8d8a4877d" title="update the queue status">update_queue</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q, <span class="keyword">struct</span> <a class="code" href="structmember.html">member</a> *<a class="code" href="structmember.html">member</a>, <span class="keywordtype">int</span> callcompletedinsl, <span class="keywordtype">int</span> newtalktime)
<a name="l03272"></a>03272 {
<a name="l03273"></a>03273    <span class="keywordtype">int</span> oldtalktime;
<a name="l03274"></a>03274 
<a name="l03275"></a>03275    <span class="keyword">struct </span>member *mem;
<a name="l03276"></a>03276    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *qtmp;
<a name="l03277"></a>03277    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> queue_iter;  
<a name="l03278"></a>03278    
<a name="l03279"></a>03279    <span class="keywordflow">if</span> (shared_lastcall) {
<a name="l03280"></a>03280       queue_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, 0);
<a name="l03281"></a>03281       <span class="keywordflow">while</span> ((qtmp = <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;queue_iter, <span class="stringliteral">&quot;Iterate through queues&quot;</span>))) {
<a name="l03282"></a>03282          <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(qtmp);
<a name="l03283"></a>03283          <span class="keywordflow">if</span> ((mem = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(qtmp-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, member, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>))) {
<a name="l03284"></a>03284             time(&amp;mem-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>);
<a name="l03285"></a>03285             mem-&gt;<a class="code" href="structmember.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a>++;
<a name="l03286"></a>03286             mem-&gt;<a class="code" href="structmember.html#ad666640d5cfd34a434cfa5347f50def4">lastqueue</a> = q;
<a name="l03287"></a>03287             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l03288"></a>03288          }
<a name="l03289"></a>03289          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(qtmp);
<a name="l03290"></a>03290          <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(qtmp, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l03291"></a>03291       }
<a name="l03292"></a>03292       <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;queue_iter);
<a name="l03293"></a>03293    } <span class="keywordflow">else</span> {
<a name="l03294"></a>03294       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l03295"></a>03295       time(&amp;member-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>);
<a name="l03296"></a>03296       member-&gt;<a class="code" href="structmember.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a>++;
<a name="l03297"></a>03297       member-&gt;<a class="code" href="structmember.html#ad666640d5cfd34a434cfa5347f50def4">lastqueue</a> = q;
<a name="l03298"></a>03298       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l03299"></a>03299    }  
<a name="l03300"></a>03300    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l03301"></a>03301    q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a>++;
<a name="l03302"></a>03302    <span class="keywordflow">if</span> (callcompletedinsl)
<a name="l03303"></a>03303       q-&gt;<a class="code" href="structcall__queue.html#ad22c84b7016cae07c521dda4a74544f8">callscompletedinsl</a>++;
<a name="l03304"></a>03304    <span class="comment">/* Calculate talktime using the same exponential average as holdtime code*/</span>
<a name="l03305"></a>03305    oldtalktime = q-&gt;<a class="code" href="structcall__queue.html#a080da53416fe93b51940797285eeee5c">talktime</a>;
<a name="l03306"></a>03306    q-&gt;<a class="code" href="structcall__queue.html#a080da53416fe93b51940797285eeee5c">talktime</a> = (((oldtalktime &lt;&lt; 2) - oldtalktime) + newtalktime) &gt;&gt; 2;
<a name="l03307"></a>03307    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l03308"></a>03308    <span class="keywordflow">return</span> 0;
<a name="l03309"></a>03309 }
<a name="l03310"></a>03310 <span class="comment"></span>
<a name="l03311"></a>03311 <span class="comment">/*! \brief Calculate the metric of each member in the outgoing callattempts</span>
<a name="l03312"></a>03312 <span class="comment"> *</span>
<a name="l03313"></a>03313 <span class="comment"> * A numeric metric is given to each member depending on the ring strategy used</span>
<a name="l03314"></a>03314 <span class="comment"> * by the queue. Members with lower metrics will be called before members with</span>
<a name="l03315"></a>03315 <span class="comment"> * higher metrics</span>
<a name="l03316"></a>03316 <span class="comment"> * \retval -1 if penalties are exceeded</span>
<a name="l03317"></a>03317 <span class="comment"> * \retval 0 otherwise</span>
<a name="l03318"></a>03318 <span class="comment"> */</span>
<a name="l03319"></a><a class="code" href="app__queue_8c.html#a76af963fe9291f7d528d6db711144a6d">03319</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a76af963fe9291f7d528d6db711144a6d" title="Calculate the metric of each member in the outgoing callattempts.">calc_metric</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q, <span class="keyword">struct</span> <a class="code" href="structmember.html">member</a> *mem, <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, <span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keyword">struct</span> <a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *tmp)
<a name="l03320"></a>03320 {
<a name="l03321"></a>03321    <span class="keywordflow">if</span> ((qe-&gt;<a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a> &amp;&amp; (mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> &gt; qe-&gt;<a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a>)) || (qe-&gt;<a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a> &amp;&amp; (mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> &lt; qe-&gt;<a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a>)))
<a name="l03322"></a>03322       <span class="keywordflow">return</span> -1;
<a name="l03323"></a>03323 
<a name="l03324"></a>03324    <span class="keywordflow">switch</span> (q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a>) {
<a name="l03325"></a>03325    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>:
<a name="l03326"></a>03326       <span class="comment">/* Everyone equal, except for penalty */</span>
<a name="l03327"></a>03327       tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> = mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> * 1000000;
<a name="l03328"></a>03328       <span class="keywordflow">break</span>;
<a name="l03329"></a>03329    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba49bae9dfad805972b20763389a090d09">QUEUE_STRATEGY_LINEAR</a>:
<a name="l03330"></a>03330       <span class="keywordflow">if</span> (pos &lt; qe-&gt;<a class="code" href="structqueue__ent.html#a51db7b9d0e86f2188b541b3d68459930">linpos</a>) {
<a name="l03331"></a>03331          tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> = 1000 + pos;
<a name="l03332"></a>03332       } <span class="keywordflow">else</span> {
<a name="l03333"></a>03333          <span class="keywordflow">if</span> (pos &gt; qe-&gt;<a class="code" href="structqueue__ent.html#a51db7b9d0e86f2188b541b3d68459930">linpos</a>)
<a name="l03334"></a>03334             <span class="comment">/* Indicate there is another priority */</span>
<a name="l03335"></a>03335             qe-&gt;<a class="code" href="structqueue__ent.html#ab552667d2252975f206fb8a8af49888a">linwrapped</a> = 1;
<a name="l03336"></a>03336          tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> = pos;
<a name="l03337"></a>03337       }
<a name="l03338"></a>03338       tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> += mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> * 1000000;
<a name="l03339"></a>03339       <span class="keywordflow">break</span>;
<a name="l03340"></a>03340    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba272ff295ebf6d216c1320a296908753a">QUEUE_STRATEGY_RRMEMORY</a>:
<a name="l03341"></a>03341       <span class="keywordflow">if</span> (pos &lt; q-&gt;rrpos) {
<a name="l03342"></a>03342          tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> = 1000 + pos;
<a name="l03343"></a>03343       } <span class="keywordflow">else</span> {
<a name="l03344"></a>03344          <span class="keywordflow">if</span> (pos &gt; q-&gt;<a class="code" href="structcall__queue.html#a0a7a994a2db49ad4569bfd6db242247b">rrpos</a>)
<a name="l03345"></a>03345             <span class="comment">/* Indicate there is another priority */</span>
<a name="l03346"></a>03346             q-&gt;<a class="code" href="structcall__queue.html#ac3419e9b31cb1aebe3666439449bcecc">wrapped</a> = 1;
<a name="l03347"></a>03347          tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> = pos;
<a name="l03348"></a>03348       }
<a name="l03349"></a>03349       tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> += mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> * 1000000;
<a name="l03350"></a>03350       <span class="keywordflow">break</span>;
<a name="l03351"></a>03351    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba89db95f6e97c58cd5915abddc140df70">QUEUE_STRATEGY_RANDOM</a>:
<a name="l03352"></a>03352       tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() % 1000;
<a name="l03353"></a>03353       tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> += mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> * 1000000;
<a name="l03354"></a>03354       <span class="keywordflow">break</span>;
<a name="l03355"></a>03355    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebbaee8588c59bd53b91d0cebce5faca7a06">QUEUE_STRATEGY_WRANDOM</a>:
<a name="l03356"></a>03356       tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() % ((1 + mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>) * 1000);
<a name="l03357"></a>03357       <span class="keywordflow">break</span>;
<a name="l03358"></a>03358    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba9b9caf74d13b75b846264a89d5aea9a4">QUEUE_STRATEGY_FEWESTCALLS</a>:
<a name="l03359"></a>03359       tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> = mem-&gt;<a class="code" href="structmember.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a>;
<a name="l03360"></a>03360       tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> += mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> * 1000000;
<a name="l03361"></a>03361       <span class="keywordflow">break</span>;
<a name="l03362"></a>03362    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba5ecd46d3615498a0c1f620952b919855">QUEUE_STRATEGY_LEASTRECENT</a>:
<a name="l03363"></a>03363       <span class="keywordflow">if</span> (!mem-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>)
<a name="l03364"></a>03364          tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> = 0;
<a name="l03365"></a>03365       <span class="keywordflow">else</span>
<a name="l03366"></a>03366          tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> = 1000000 - (time(NULL) - mem-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>);
<a name="l03367"></a>03367       tmp-&gt;<a class="code" href="structcallattempt.html#ab7103c08fa28b20499d3a68a29c7e0a8">metric</a> += mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> * 1000000;
<a name="l03368"></a>03368       <span class="keywordflow">break</span>;
<a name="l03369"></a>03369    <span class="keywordflow">default</span>:
<a name="l03370"></a>03370       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t calculate metric for unknown strategy %d\n&quot;</span>, q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a>);
<a name="l03371"></a>03371       <span class="keywordflow">break</span>;
<a name="l03372"></a>03372    }
<a name="l03373"></a>03373    <span class="keywordflow">return</span> 0;
<a name="l03374"></a>03374 }
<a name="l03375"></a>03375 
<a name="l03376"></a><a class="code" href="app__queue_8c.html#af59feeff9c61049bf1d1a7839164564d">03376</a> <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#af59feeff9c61049bf1d1a7839164564d">agent_complete_reason</a> {
<a name="l03377"></a><a class="code" href="app__queue_8c.html#af59feeff9c61049bf1d1a7839164564da705a981107e0ea89ff36ae0707a97889">03377</a>    <a class="code" href="app__queue_8c.html#af59feeff9c61049bf1d1a7839164564da705a981107e0ea89ff36ae0707a97889">CALLER</a>,
<a name="l03378"></a><a class="code" href="app__queue_8c.html#af59feeff9c61049bf1d1a7839164564da40e60d510aa885cf9334b0c0175cd2b2">03378</a>    <a class="code" href="app__queue_8c.html#af59feeff9c61049bf1d1a7839164564da40e60d510aa885cf9334b0c0175cd2b2">AGENT</a>,
<a name="l03379"></a><a class="code" href="app__queue_8c.html#af59feeff9c61049bf1d1a7839164564dac1bee29cc4915cda4b613b8b95330663">03379</a>    <a class="code" href="chan__dahdi_8c.html#a3811374ead4311c8b04a85ae6dd7196b">TRANSFER</a>
<a name="l03380"></a>03380 };
<a name="l03381"></a>03381 <span class="comment"></span>
<a name="l03382"></a>03382 <span class="comment">/*! \brief Send out AMI message with member call completion status information */</span>
<a name="l03383"></a><a class="code" href="app__queue_8c.html#ad7d17f55f6b97ebc0d32e202aacfa8b7">03383</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#ad7d17f55f6b97ebc0d32e202aacfa8b7" title="Send out AMI message with member call completion status information.">send_agent_complete</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keyword">const</span> <span class="keywordtype">char</span> *queuename,
<a name="l03384"></a>03384    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *peer, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmember.html">member</a> *<a class="code" href="structmember.html">member</a>, time_t callstart,
<a name="l03385"></a>03385    <span class="keywordtype">char</span> *vars, <span class="keywordtype">size_t</span> vars_len, <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#af59feeff9c61049bf1d1a7839164564d">agent_complete_reason</a> rsn)
<a name="l03386"></a>03386 {
<a name="l03387"></a>03387    <span class="keyword">const</span> <span class="keywordtype">char</span> *reason = NULL; <span class="comment">/* silence dumb compilers */</span>
<a name="l03388"></a>03388 
<a name="l03389"></a>03389    <span class="keywordflow">if</span> (!qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a>)
<a name="l03390"></a>03390       <span class="keywordflow">return</span>;
<a name="l03391"></a>03391 
<a name="l03392"></a>03392    <span class="keywordflow">switch</span> (rsn) {
<a name="l03393"></a>03393    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#af59feeff9c61049bf1d1a7839164564da705a981107e0ea89ff36ae0707a97889">CALLER</a>:
<a name="l03394"></a>03394       reason = <span class="stringliteral">&quot;caller&quot;</span>;
<a name="l03395"></a>03395       <span class="keywordflow">break</span>;
<a name="l03396"></a>03396    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#af59feeff9c61049bf1d1a7839164564da40e60d510aa885cf9334b0c0175cd2b2">AGENT</a>:
<a name="l03397"></a>03397       reason = <span class="stringliteral">&quot;agent&quot;</span>;
<a name="l03398"></a>03398       <span class="keywordflow">break</span>;
<a name="l03399"></a>03399    <span class="keywordflow">case</span> <a class="code" href="chan__dahdi_8c.html#a3811374ead4311c8b04a85ae6dd7196b">TRANSFER</a>:
<a name="l03400"></a>03400       reason = <span class="stringliteral">&quot;transfer&quot;</span>;
<a name="l03401"></a>03401       <span class="keywordflow">break</span>;
<a name="l03402"></a>03402    }
<a name="l03403"></a>03403 
<a name="l03404"></a>03404    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;AgentComplete&quot;</span>,
<a name="l03405"></a>03405       <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l03406"></a>03406       <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l03407"></a>03407       <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l03408"></a>03408       <span class="stringliteral">&quot;Member: %s\r\n&quot;</span>
<a name="l03409"></a>03409       <span class="stringliteral">&quot;MemberName: %s\r\n&quot;</span>
<a name="l03410"></a>03410       <span class="stringliteral">&quot;HoldTime: %ld\r\n&quot;</span>
<a name="l03411"></a>03411       <span class="stringliteral">&quot;TalkTime: %ld\r\n&quot;</span>
<a name="l03412"></a>03412       <span class="stringliteral">&quot;Reason: %s\r\n&quot;</span>
<a name="l03413"></a>03413       <span class="stringliteral">&quot;%s&quot;</span>,
<a name="l03414"></a>03414       queuename, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, peer-&gt;name, member-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>,
<a name="l03415"></a>03415       (<span class="keywordtype">long</span>)(callstart - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>), (<span class="keywordtype">long</span>)(time(NULL) - callstart), reason,
<a name="l03416"></a>03416       qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a> == <a class="code" href="app__queue_8c.html#a533ee4344c442cf6da3e610598ecca75">QUEUE_EVENT_VARIABLES</a> ? <a class="code" href="app__queue_8c.html#a5f13e8661f3dfcdb919d8140a997cf7a" title="convert &amp;quot;\n&amp;quot; to &amp;quot;\nVariable: &amp;quot; ready for manager to use">vars2manager</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, vars, vars_len) : <span class="stringliteral">&quot;&quot;</span>);
<a name="l03417"></a>03417 }
<a name="l03418"></a>03418 
<a name="l03419"></a><a class="code" href="structqueue__transfer__ds.html">03419</a> <span class="keyword">struct </span><a class="code" href="structqueue__transfer__ds.html">queue_transfer_ds</a> {
<a name="l03420"></a><a class="code" href="structqueue__transfer__ds.html#ac3bc7886a367e234fb7e5effdd231891">03420</a>    <span class="keyword">struct </span><a class="code" href="structqueue__ent.html">queue_ent</a> *qe;
<a name="l03421"></a><a class="code" href="structqueue__transfer__ds.html#adf5e7e1635f0aef4ff3c2119a46dbca4">03421</a>    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *<a class="code" href="structmember.html">member</a>;
<a name="l03422"></a><a class="code" href="structqueue__transfer__ds.html#a2a6c54dcdbeb16bb2e1676a4abf4a4d8">03422</a>    time_t <a class="code" href="app__rpt_8c.html#a2a6c54dcdbeb16bb2e1676a4abf4a4d8">starttime</a>;
<a name="l03423"></a><a class="code" href="structqueue__transfer__ds.html#a9a2af6e4da551e6d05da960a6f2432ab">03423</a>    <span class="keywordtype">int</span> callcompletedinsl;
<a name="l03424"></a>03424 };
<a name="l03425"></a>03425 
<a name="l03426"></a><a class="code" href="app__queue_8c.html#a80745b43882c328837d452d9fd6b69b2">03426</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a80745b43882c328837d452d9fd6b69b2">queue_transfer_destroy</a>(<span class="keywordtype">void</span> *data)
<a name="l03427"></a>03427 {
<a name="l03428"></a>03428    <span class="keyword">struct </span><a class="code" href="structqueue__transfer__ds.html">queue_transfer_ds</a> *qtds = data;
<a name="l03429"></a>03429    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(qtds);
<a name="l03430"></a>03430 }
<a name="l03431"></a>03431 <span class="comment"></span>
<a name="l03432"></a>03432 <span class="comment">/*! \brief a datastore used to help correctly log attended transfers of queue callers</span>
<a name="l03433"></a>03433 <span class="comment"> */</span>
<a name="l03434"></a><a class="code" href="app__queue_8c.html#ad61e79a226bf0ecbf6862dc2b5c01eaf">03434</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__datastore__info.html" title="Structure for a data store type.">ast_datastore_info</a> <a class="code" href="app__queue_8c.html#ad61e79a226bf0ecbf6862dc2b5c01eaf" title="a datastore used to help correctly log attended transfers of queue callers">queue_transfer_info</a> = {
<a name="l03435"></a>03435    .<a class="code" href="structast__datastore__info.html#a763fd8db6bba8fbbbc113ca0d61c47c2">type</a> = <span class="stringliteral">&quot;queue_transfer&quot;</span>,
<a name="l03436"></a>03436    .chan_fixup = <a class="code" href="app__queue_8c.html#a480e30e7b4e274a8165f678902b96b3a" title="Log an attended transfer when a queue caller channel is masqueraded.">queue_transfer_fixup</a>,
<a name="l03437"></a>03437    .destroy = <a class="code" href="app__queue_8c.html#a80745b43882c328837d452d9fd6b69b2">queue_transfer_destroy</a>,
<a name="l03438"></a>03438 };
<a name="l03439"></a>03439 <span class="comment"></span>
<a name="l03440"></a>03440 <span class="comment">/*! \brief Log an attended transfer when a queue caller channel is masqueraded</span>
<a name="l03441"></a>03441 <span class="comment"> *</span>
<a name="l03442"></a>03442 <span class="comment"> * When a caller is masqueraded, we want to log a transfer. Fixup time is the closest we can come to when</span>
<a name="l03443"></a>03443 <span class="comment"> * the actual transfer occurs. This happens during the masquerade after datastores are moved from old_chan</span>
<a name="l03444"></a>03444 <span class="comment"> * to new_chan. This is why new_chan is referenced for exten, context, and datastore information.</span>
<a name="l03445"></a>03445 <span class="comment"> *</span>
<a name="l03446"></a>03446 <span class="comment"> * At the end of this, we want to remove the datastore so that this fixup function is not called on any</span>
<a name="l03447"></a>03447 <span class="comment"> * future masquerades of the caller during the current call.</span>
<a name="l03448"></a>03448 <span class="comment"> */</span>
<a name="l03449"></a><a class="code" href="app__queue_8c.html#a480e30e7b4e274a8165f678902b96b3a">03449</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a480e30e7b4e274a8165f678902b96b3a" title="Log an attended transfer when a queue caller channel is masqueraded.">queue_transfer_fixup</a>(<span class="keywordtype">void</span> *data, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *old_chan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *new_chan)
<a name="l03450"></a>03450 {
<a name="l03451"></a>03451    <span class="keyword">struct </span><a class="code" href="structqueue__transfer__ds.html">queue_transfer_ds</a> *qtds = data;
<a name="l03452"></a>03452    <span class="keyword">struct </span><a class="code" href="structqueue__ent.html">queue_ent</a> *qe = qtds-&gt;<a class="code" href="structqueue__transfer__ds.html#ac3bc7886a367e234fb7e5effdd231891">qe</a>;
<a name="l03453"></a>03453    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *<a class="code" href="structmember.html">member</a> = qtds-&gt;<a class="code" href="structqueue__transfer__ds.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>;
<a name="l03454"></a>03454    time_t callstart = qtds-&gt;<a class="code" href="structqueue__transfer__ds.html#a2a6c54dcdbeb16bb2e1676a4abf4a4d8">starttime</a>;
<a name="l03455"></a>03455    <span class="keywordtype">int</span> callcompletedinsl = qtds-&gt;<a class="code" href="structqueue__transfer__ds.html#a9a2af6e4da551e6d05da960a6f2432ab">callcompletedinsl</a>;
<a name="l03456"></a>03456    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *datastore;
<a name="l03457"></a>03457 
<a name="l03458"></a>03458    <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, <span class="stringliteral">&quot;TRANSFER&quot;</span>, <span class="stringliteral">&quot;%s|%s|%ld|%ld|%d&quot;</span>,
<a name="l03459"></a>03459             new_chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, new_chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, (<span class="keywordtype">long</span>) (callstart - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>),
<a name="l03460"></a>03460             (<span class="keywordtype">long</span>) (time(NULL) - callstart), qe-&gt;<a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>);
<a name="l03461"></a>03461 
<a name="l03462"></a>03462    <a class="code" href="app__queue_8c.html#a62226f8ba56b53bd8b3f9ee8d8a4877d" title="update the queue status">update_queue</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, member, callcompletedinsl, (time(NULL) - callstart));
<a name="l03463"></a>03463    
<a name="l03464"></a>03464    <span class="comment">/* No need to lock the channels because they are already locked in ast_do_masquerade */</span>
<a name="l03465"></a>03465    <span class="keywordflow">if</span> ((datastore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(old_chan, &amp;queue_transfer_info, NULL))) {
<a name="l03466"></a>03466       <a class="code" href="channel_8h.html#a1ff1c62b6d50823da93a920575c9c0c9" title="Remove a datastore from a channel.">ast_channel_datastore_remove</a>(old_chan, datastore);
<a name="l03467"></a>03467    } <span class="keywordflow">else</span> {
<a name="l03468"></a>03468       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t find the queue_transfer datastore.\n&quot;</span>);
<a name="l03469"></a>03469    }
<a name="l03470"></a>03470 }
<a name="l03471"></a>03471 <span class="comment"></span>
<a name="l03472"></a>03472 <span class="comment">/*! \brief mechanism to tell if a queue caller was atxferred by a queue member.</span>
<a name="l03473"></a>03473 <span class="comment"> *</span>
<a name="l03474"></a>03474 <span class="comment"> * When a caller is atxferred, then the queue_transfer_info datastore</span>
<a name="l03475"></a>03475 <span class="comment"> * is removed from the channel. If it&apos;s still there after the bridge is</span>
<a name="l03476"></a>03476 <span class="comment"> * broken, then the caller was not atxferred.</span>
<a name="l03477"></a>03477 <span class="comment"> *</span>
<a name="l03478"></a>03478 <span class="comment"> * \note Only call this with chan locked</span>
<a name="l03479"></a>03479 <span class="comment"> */</span>
<a name="l03480"></a><a class="code" href="app__queue_8c.html#a1309ff218d974fd7aa8701b062971e44">03480</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a1309ff218d974fd7aa8701b062971e44" title="mechanism to tell if a queue caller was atxferred by a queue member.">attended_transfer_occurred</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l03481"></a>03481 {
<a name="l03482"></a>03482    <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;queue_transfer_info, NULL) ? 0 : 1;
<a name="l03483"></a>03483 }
<a name="l03484"></a>03484 <span class="comment"></span>
<a name="l03485"></a>03485 <span class="comment">/*! \brief create a datastore for storing relevant info to log attended transfers in the queue_log</span>
<a name="l03486"></a>03486 <span class="comment"> */</span>
<a name="l03487"></a><a class="code" href="app__queue_8c.html#aa429d08abcb33bf94372e629c7501986">03487</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *<a class="code" href="app__queue_8c.html#aa429d08abcb33bf94372e629c7501986" title="create a datastore for storing relevant info to log attended transfers in the queue_log...">setup_transfer_datastore</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keyword">struct</span> <a class="code" href="structmember.html">member</a> *<a class="code" href="structmember.html">member</a>, time_t <a class="code" href="app__rpt_8c.html#a2a6c54dcdbeb16bb2e1676a4abf4a4d8">starttime</a>, <span class="keywordtype">int</span> callcompletedinsl)
<a name="l03488"></a>03488 {
<a name="l03489"></a>03489    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *ds;
<a name="l03490"></a>03490    <span class="keyword">struct </span><a class="code" href="structqueue__transfer__ds.html">queue_transfer_ds</a> *qtds = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*qtds));
<a name="l03491"></a>03491 
<a name="l03492"></a>03492    <span class="keywordflow">if</span> (!qtds) {
<a name="l03493"></a>03493       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Memory allocation error!\n&quot;</span>);
<a name="l03494"></a>03494       <span class="keywordflow">return</span> NULL;
<a name="l03495"></a>03495    }
<a name="l03496"></a>03496 
<a name="l03497"></a>03497    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03498"></a>03498    <span class="keywordflow">if</span> (!(ds = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;queue_transfer_info, NULL))) {
<a name="l03499"></a>03499       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03500"></a>03500       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create transfer datastore. queue_log will not show attended transfer\n&quot;</span>);
<a name="l03501"></a>03501       <span class="keywordflow">return</span> NULL;
<a name="l03502"></a>03502    }
<a name="l03503"></a>03503 
<a name="l03504"></a>03504    qtds-&gt;<a class="code" href="structqueue__transfer__ds.html#ac3bc7886a367e234fb7e5effdd231891">qe</a> = qe;
<a name="l03505"></a>03505    <span class="comment">/* This member is refcounted in try_calling, so no need to add it here, too */</span>
<a name="l03506"></a>03506    qtds-&gt;<a class="code" href="structqueue__transfer__ds.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a> = member;
<a name="l03507"></a>03507    qtds-&gt;<a class="code" href="structqueue__transfer__ds.html#a2a6c54dcdbeb16bb2e1676a4abf4a4d8">starttime</a> = starttime;
<a name="l03508"></a>03508    qtds-&gt;<a class="code" href="structqueue__transfer__ds.html#a9a2af6e4da551e6d05da960a6f2432ab">callcompletedinsl</a> = callcompletedinsl;
<a name="l03509"></a>03509    ds-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = qtds;
<a name="l03510"></a>03510    <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, ds);
<a name="l03511"></a>03511    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03512"></a>03512    <span class="keywordflow">return</span> ds;
<a name="l03513"></a>03513 }
<a name="l03514"></a>03514 
<a name="l03515"></a><a class="code" href="structqueue__end__bridge.html">03515</a> <span class="keyword">struct </span><a class="code" href="structqueue__end__bridge.html">queue_end_bridge</a> {
<a name="l03516"></a><a class="code" href="structqueue__end__bridge.html#a6d8b242e106dd6592a625bdc396bbe55">03516</a>    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l03517"></a><a class="code" href="structqueue__end__bridge.html#a84d1435c5b8d387806714ea7079304b7">03517</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l03518"></a>03518 };
<a name="l03519"></a>03519 
<a name="l03520"></a><a class="code" href="app__queue_8c.html#adc150dec1056eca590d0f1555ff5188b">03520</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#adc150dec1056eca590d0f1555ff5188b">end_bridge_callback_data_fixup</a>(<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html" title="bridge configuration">ast_bridge_config</a> *bconfig, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *originator, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *terminator)
<a name="l03521"></a>03521 {
<a name="l03522"></a>03522    <span class="keyword">struct </span><a class="code" href="structqueue__end__bridge.html">queue_end_bridge</a> *qeb = bconfig-&gt;<a class="code" href="structast__bridge__config.html#a30cb875f49910a9515ee92d8dfdf8b83">end_bridge_callback_data</a>;
<a name="l03523"></a>03523    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(qeb, +1);
<a name="l03524"></a>03524    qeb-&gt;<a class="code" href="structqueue__end__bridge.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = originator;
<a name="l03525"></a>03525 }
<a name="l03526"></a>03526 
<a name="l03527"></a><a class="code" href="app__queue_8c.html#acb5e3261ae018d7bbe4cbdcc9cace101">03527</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#acb5e3261ae018d7bbe4cbdcc9cace101">end_bridge_callback</a>(<span class="keywordtype">void</span> *data)
<a name="l03528"></a>03528 {
<a name="l03529"></a>03529    <span class="keyword">struct </span><a class="code" href="structqueue__end__bridge.html">queue_end_bridge</a> *qeb = data;
<a name="l03530"></a>03530    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q = qeb-&gt;<a class="code" href="structqueue__end__bridge.html#a6d8b242e106dd6592a625bdc396bbe55">q</a>;
<a name="l03531"></a>03531    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = qeb-&gt;<a class="code" href="structqueue__end__bridge.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l03532"></a>03532 
<a name="l03533"></a>03533    <span class="keywordflow">if</span> (<a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(qeb, -1) == 1) {
<a name="l03534"></a>03534       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l03535"></a>03535       <a class="code" href="app__queue_8c.html#a1248fe33745c5cb9c87db6be0a25d138" title="Set variables of queue.">set_queue_variables</a>(q, chan);
<a name="l03536"></a>03536       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l03537"></a>03537       <span class="comment">/* This unrefs the reference we made in try_calling when we allocated qeb */</span>
<a name="l03538"></a>03538       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Expire bridge_config reference&quot;</span>);
<a name="l03539"></a>03539    }
<a name="l03540"></a>03540 }
<a name="l03541"></a>03541 <span class="comment"></span>
<a name="l03542"></a>03542 <span class="comment">/*! \brief A large function which calls members, updates statistics, and bridges the caller and a member</span>
<a name="l03543"></a>03543 <span class="comment"> * </span>
<a name="l03544"></a>03544 <span class="comment"> * Here is the process of this function</span>
<a name="l03545"></a>03545 <span class="comment"> * 1. Process any options passed to the Queue() application. Options here mean the third argument to Queue()</span>
<a name="l03546"></a>03546 <span class="comment"> * 2. Iterate trough the members of the queue, creating a callattempt corresponding to each member. During this</span>
<a name="l03547"></a>03547 <span class="comment"> *    iteration, we also check the dialed_interfaces datastore to see if we have already attempted calling this</span>
<a name="l03548"></a>03548 <span class="comment"> *    member. If we have, we do not create a callattempt. This is in place to prevent call forwarding loops. Also</span>
<a name="l03549"></a>03549 <span class="comment"> *    during each iteration, we call calc_metric to determine which members should be rung when.</span>
<a name="l03550"></a>03550 <span class="comment"> * 3. Call ring_one to place a call to the appropriate member(s)</span>
<a name="l03551"></a>03551 <span class="comment"> * 4. Call wait_for_answer to wait for an answer. If no one answers, return.</span>
<a name="l03552"></a>03552 <span class="comment"> * 5. Take care of any holdtime announcements, member delays, or other options which occur after a call has been answered.</span>
<a name="l03553"></a>03553 <span class="comment"> * 6. Start the monitor or mixmonitor if the option is set</span>
<a name="l03554"></a>03554 <span class="comment"> * 7. Remove the caller from the queue to allow other callers to advance</span>
<a name="l03555"></a>03555 <span class="comment"> * 8. Bridge the call.</span>
<a name="l03556"></a>03556 <span class="comment"> * 9. Do any post processing after the call has disconnected.</span>
<a name="l03557"></a>03557 <span class="comment"> *</span>
<a name="l03558"></a>03558 <span class="comment"> * \param[in] qe the queue_ent structure which corresponds to the caller attempting to reach members</span>
<a name="l03559"></a>03559 <span class="comment"> * \param[in] options the options passed as the third parameter to the Queue() application</span>
<a name="l03560"></a>03560 <span class="comment"> * \param[in] announceoverride filename to play to user when waiting </span>
<a name="l03561"></a>03561 <span class="comment"> * \param[in] url the url passed as the fourth parameter to the Queue() application</span>
<a name="l03562"></a>03562 <span class="comment"> * \param[in,out] tries the number of times we have tried calling queue members</span>
<a name="l03563"></a>03563 <span class="comment"> * \param[out] noption set if the call to Queue() has the &apos;n&apos; option set.</span>
<a name="l03564"></a>03564 <span class="comment"> * \param[in] agi the agi passed as the fifth parameter to the Queue() application</span>
<a name="l03565"></a>03565 <span class="comment"> * \param[in] macro the macro passed as the sixth parameter to the Queue() application</span>
<a name="l03566"></a>03566 <span class="comment"> * \param[in] gosub the gosub passed as the seventh parameter to the Queue() application</span>
<a name="l03567"></a>03567 <span class="comment"> * \param[in] ringing 1 if the &apos;r&apos; option is set, otherwise 0</span>
<a name="l03568"></a>03568 <span class="comment"> */</span>
<a name="l03569"></a><a class="code" href="app__queue_8c.html#a9a05da352a5c433d2b614c972203a7d2">03569</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a9a05da352a5c433d2b614c972203a7d2" title="A large function which calls members, updates statistics, and bridges the caller...">try_calling</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keyword">const</span> <span class="keywordtype">char</span> *options, <span class="keywordtype">char</span> *announceoverride, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>, <span class="keywordtype">int</span> *tries, <span class="keywordtype">int</span> *noption, <span class="keyword">const</span> <span class="keywordtype">char</span> *agi, <span class="keyword">const</span> <span class="keywordtype">char</span> *macro, <span class="keyword">const</span> <span class="keywordtype">char</span> *gosub, <span class="keywordtype">int</span> ringing)
<a name="l03570"></a>03570 {
<a name="l03571"></a>03571    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *cur;
<a name="l03572"></a>03572    <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *<a class="code" href="structoutgoing.html">outgoing</a> = NULL; <span class="comment">/* the list of calls we are building */</span>
<a name="l03573"></a>03573    <span class="keywordtype">int</span> to, orig;
<a name="l03574"></a>03574    <span class="keywordtype">char</span> oldexten[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l03575"></a>03575    <span class="keywordtype">char</span> oldcontext[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l03576"></a>03576    <span class="keywordtype">char</span> queuename[256]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l03577"></a>03577    <span class="keywordtype">char</span> interfacevar[256]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l03578"></a>03578    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *peer;
<a name="l03579"></a>03579    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *which;
<a name="l03580"></a>03580    <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *lpeer;
<a name="l03581"></a>03581    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *<a class="code" href="structmember.html">member</a>;
<a name="l03582"></a>03582    <span class="keyword">struct </span><a class="code" href="structast__app.html" title="ast_app: A registered application">ast_app</a> *application;
<a name="l03583"></a>03583    <span class="keywordtype">int</span> res = 0, bridge = 0;
<a name="l03584"></a>03584    <span class="keywordtype">int</span> numbusies = 0;
<a name="l03585"></a>03585    <span class="keywordtype">int</span> x=0;
<a name="l03586"></a>03586    <span class="keywordtype">char</span> *<a class="code" href="structqueue__ent.html#a6b2f794058fc666c44aa8ea1c055c34a">announce</a> = NULL;
<a name="l03587"></a>03587    <span class="keywordtype">char</span> digit = 0;
<a name="l03588"></a>03588    time_t callstart;
<a name="l03589"></a>03589    time_t now = time(NULL);
<a name="l03590"></a>03590    <span class="keyword">struct </span><a class="code" href="structast__bridge__config.html" title="bridge configuration">ast_bridge_config</a> bridge_config;
<a name="l03591"></a>03591    <span class="keywordtype">char</span> nondataquality = 1;
<a name="l03592"></a>03592    <span class="keywordtype">char</span> *agiexec = NULL;
<a name="l03593"></a>03593    <span class="keywordtype">char</span> *macroexec = NULL;
<a name="l03594"></a>03594    <span class="keywordtype">char</span> *gosubexec = NULL;
<a name="l03595"></a>03595    <span class="keywordtype">int</span> ret = 0;
<a name="l03596"></a>03596    <span class="keyword">const</span> <span class="keywordtype">char</span> *monitorfilename;
<a name="l03597"></a>03597    <span class="keyword">const</span> <span class="keywordtype">char</span> *monitor_exec;
<a name="l03598"></a>03598    <span class="keyword">const</span> <span class="keywordtype">char</span> *monitor_options;
<a name="l03599"></a>03599    <span class="keywordtype">char</span> tmpid[256], tmpid2[256];
<a name="l03600"></a>03600    <span class="keywordtype">char</span> meid[1024], meid2[1024];
<a name="l03601"></a>03601    <span class="keywordtype">char</span> mixmonargs[1512];
<a name="l03602"></a>03602    <span class="keyword">struct </span><a class="code" href="structast__app.html" title="ast_app: A registered application">ast_app</a> *mixmonapp = NULL;
<a name="l03603"></a>03603    <span class="keywordtype">char</span> *p;
<a name="l03604"></a>03604    <span class="keywordtype">char</span> vars[2048];
<a name="l03605"></a>03605    <span class="keywordtype">int</span> forwardsallowed = 1;
<a name="l03606"></a>03606    <span class="keywordtype">int</span> callcompletedinsl;
<a name="l03607"></a>03607    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> memi;
<a name="l03608"></a>03608    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *datastore, *transfer_ds;
<a name="l03609"></a>03609    <span class="keyword">struct </span><a class="code" href="structqueue__end__bridge.html">queue_end_bridge</a> *<a class="code" href="structqueue__end__bridge.html">queue_end_bridge</a> = NULL;
<a name="l03610"></a>03610    <span class="keyword">const</span> <span class="keywordtype">int</span> need_weight = use_weight;
<a name="l03611"></a>03611 
<a name="l03612"></a>03612    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03613"></a>03613    datastore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, &amp;<a class="code" href="global__datastores_8h.html#a3697a5dbd006917fee0367c497a5cc38">dialed_interface_info</a>, NULL);
<a name="l03614"></a>03614    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03615"></a>03615 
<a name="l03616"></a>03616    memset(&amp;bridge_config, 0, <span class="keyword">sizeof</span>(bridge_config));
<a name="l03617"></a>03617    tmpid[0] = 0;
<a name="l03618"></a>03618    meid[0] = 0;
<a name="l03619"></a>03619    time(&amp;now);
<a name="l03620"></a>03620 
<a name="l03621"></a>03621    <span class="comment">/* If we&apos;ve already exceeded our timeout, then just stop</span>
<a name="l03622"></a>03622 <span class="comment">    * This should be extremely rare. queue_exec will take care</span>
<a name="l03623"></a>03623 <span class="comment">    * of removing the caller and reporting the timeout as the reason.</span>
<a name="l03624"></a>03624 <span class="comment">    */</span>
<a name="l03625"></a>03625    <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> &amp;&amp; now &gt;= qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a>) {
<a name="l03626"></a>03626       res = 0;
<a name="l03627"></a>03627       <span class="keywordflow">goto</span> out;
<a name="l03628"></a>03628    }
<a name="l03629"></a>03629       
<a name="l03630"></a>03630    <span class="keywordflow">for</span> (; options &amp;&amp; *options; options++)
<a name="l03631"></a>03631       <span class="keywordflow">switch</span> (*options) {
<a name="l03632"></a>03632       <span class="keywordflow">case</span> <span class="charliteral">&apos;t&apos;</span>:
<a name="l03633"></a>03633          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bridge_config.<a class="code" href="structast__bridge__config.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93a33e339fbf78c26377f6c7057dda06ccc">AST_FEATURE_REDIRECT</a>);
<a name="l03634"></a>03634          <span class="keywordflow">break</span>;
<a name="l03635"></a>03635       <span class="keywordflow">case</span> <span class="charliteral">&apos;T&apos;</span>:
<a name="l03636"></a>03636          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bridge_config.<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93a33e339fbf78c26377f6c7057dda06ccc">AST_FEATURE_REDIRECT</a>);
<a name="l03637"></a>03637          <span class="keywordflow">break</span>;
<a name="l03638"></a>03638       <span class="keywordflow">case</span> <span class="charliteral">&apos;w&apos;</span>:
<a name="l03639"></a>03639          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bridge_config.<a class="code" href="structast__bridge__config.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae16218a9dfb2123d391f959e3d078362">AST_FEATURE_AUTOMON</a>);
<a name="l03640"></a>03640          <span class="keywordflow">break</span>;
<a name="l03641"></a>03641       <span class="keywordflow">case</span> <span class="charliteral">&apos;W&apos;</span>:
<a name="l03642"></a>03642          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bridge_config.<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae16218a9dfb2123d391f959e3d078362">AST_FEATURE_AUTOMON</a>);
<a name="l03643"></a>03643          <span class="keywordflow">break</span>;
<a name="l03644"></a>03644       <span class="keywordflow">case</span> <span class="charliteral">&apos;c&apos;</span>:
<a name="l03645"></a>03645          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bridge_config.<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93a84500213ed3a17d1959c36062a7ba474">AST_FEATURE_NO_H_EXTEN</a>);
<a name="l03646"></a>03646          <span class="keywordflow">break</span>;
<a name="l03647"></a>03647       <span class="keywordflow">case</span> <span class="charliteral">&apos;d&apos;</span>:
<a name="l03648"></a>03648          nondataquality = 0;
<a name="l03649"></a>03649          <span class="keywordflow">break</span>;
<a name="l03650"></a>03650       <span class="keywordflow">case</span> <span class="charliteral">&apos;h&apos;</span>:
<a name="l03651"></a>03651          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bridge_config.<a class="code" href="structast__bridge__config.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae4ef6bff70f5837c4ccfcef8d789a9cc">AST_FEATURE_DISCONNECT</a>);
<a name="l03652"></a>03652          <span class="keywordflow">break</span>;
<a name="l03653"></a>03653       <span class="keywordflow">case</span> <span class="charliteral">&apos;H&apos;</span>:
<a name="l03654"></a>03654          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bridge_config.<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae4ef6bff70f5837c4ccfcef8d789a9cc">AST_FEATURE_DISCONNECT</a>);
<a name="l03655"></a>03655          <span class="keywordflow">break</span>;
<a name="l03656"></a>03656       <span class="keywordflow">case</span> <span class="charliteral">&apos;k&apos;</span>:
<a name="l03657"></a>03657          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bridge_config.<a class="code" href="structast__bridge__config.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ace68898ce2f86298d8e39e0473a55e28">AST_FEATURE_PARKCALL</a>);
<a name="l03658"></a>03658          <span class="keywordflow">break</span>;
<a name="l03659"></a>03659       <span class="keywordflow">case</span> <span class="charliteral">&apos;K&apos;</span>:
<a name="l03660"></a>03660          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bridge_config.<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ace68898ce2f86298d8e39e0473a55e28">AST_FEATURE_PARKCALL</a>);
<a name="l03661"></a>03661          <span class="keywordflow">break</span>;
<a name="l03662"></a>03662       <span class="keywordflow">case</span> <span class="charliteral">&apos;n&apos;</span>:
<a name="l03663"></a>03663          <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> == <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba272ff295ebf6d216c1320a296908753a">QUEUE_STRATEGY_RRMEMORY</a> || qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> == <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba49bae9dfad805972b20763389a090d09">QUEUE_STRATEGY_LINEAR</a>)
<a name="l03664"></a>03664             (*tries)++;
<a name="l03665"></a>03665          <span class="keywordflow">else</span>
<a name="l03666"></a>03666             *tries = qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>;
<a name="l03667"></a>03667          *noption = 1;
<a name="l03668"></a>03668          <span class="keywordflow">break</span>;
<a name="l03669"></a>03669       <span class="keywordflow">case</span> <span class="charliteral">&apos;i&apos;</span>:
<a name="l03670"></a>03670          forwardsallowed = 0;
<a name="l03671"></a>03671          <span class="keywordflow">break</span>;
<a name="l03672"></a>03672       <span class="keywordflow">case</span> <span class="charliteral">&apos;x&apos;</span>:
<a name="l03673"></a>03673          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bridge_config.<a class="code" href="structast__bridge__config.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93a0a015b303a0970eda3ea8328714cbbae">AST_FEATURE_AUTOMIXMON</a>);
<a name="l03674"></a>03674          <span class="keywordflow">break</span>;
<a name="l03675"></a>03675       <span class="keywordflow">case</span> <span class="charliteral">&apos;X&apos;</span>:
<a name="l03676"></a>03676          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bridge_config.<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93a0a015b303a0970eda3ea8328714cbbae">AST_FEATURE_AUTOMIXMON</a>);
<a name="l03677"></a>03677          <span class="keywordflow">break</span>;
<a name="l03678"></a>03678       <span class="keywordflow">case</span> <span class="charliteral">&apos;C&apos;</span>:
<a name="l03679"></a>03679          qe-&gt;<a class="code" href="structqueue__ent.html#a9edbd6d881ea6dd2b0b4d78c11723517">cancel_answered_elsewhere</a> = 1;
<a name="l03680"></a>03680          <span class="keywordflow">break</span>;
<a name="l03681"></a>03681 
<a name="l03682"></a>03682       }
<a name="l03683"></a>03683 
<a name="l03684"></a>03684    <span class="comment">/* if the calling channel has the ANSWERED_ELSEWHERE flag set, make sure this is inherited. </span>
<a name="l03685"></a>03685 <span class="comment">      (this is mainly to support chan_local)</span>
<a name="l03686"></a>03686 <span class="comment">   */</span>
<a name="l03687"></a>03687    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ac2c6da6c29fad431dfb87caf552315d7">AST_FLAG_ANSWERED_ELSEWHERE</a>)) {
<a name="l03688"></a>03688       qe-&gt;<a class="code" href="structqueue__ent.html#a9edbd6d881ea6dd2b0b4d78c11723517">cancel_answered_elsewhere</a> = 1;
<a name="l03689"></a>03689    }
<a name="l03690"></a>03690 
<a name="l03691"></a>03691    <span class="comment">/* Hold the lock while we setup the outgoing calls */</span>
<a name="l03692"></a>03692    <span class="keywordflow">if</span> (need_weight)
<a name="l03693"></a>03693       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l03694"></a>03694    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03695"></a>03695    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s is trying to call a queue member.\n&quot;</span>,
<a name="l03696"></a>03696                      qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l03697"></a>03697    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(queuename, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name, <span class="keyword">sizeof</span>(queuename));
<a name="l03698"></a>03698    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a6b2f794058fc666c44aa8ea1c055c34a">announce</a>))
<a name="l03699"></a>03699       announce = qe-&gt;<a class="code" href="structqueue__ent.html#a6b2f794058fc666c44aa8ea1c055c34a">announce</a>;
<a name="l03700"></a>03700    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(announceoverride))
<a name="l03701"></a>03701       announce = announceoverride;
<a name="l03702"></a>03702 
<a name="l03703"></a>03703    memi = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l03704"></a>03704    <span class="keywordflow">while</span> ((cur = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;memi))) {
<a name="l03705"></a>03705       <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *tmp = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tmp));
<a name="l03706"></a>03706       <span class="keyword">struct </span><a class="code" href="structast__dialed__interface.html">ast_dialed_interface</a> *<a class="code" href="tdd_8c.html#ab96661d6a02f08ff657b76e81815d14e">di</a>;
<a name="l03707"></a>03707       <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structast__dialed__interface.html">ast_dialed_interface</a>) *dialed_interfaces;
<a name="l03708"></a>03708       <span class="keywordflow">if</span> (!tmp) {
<a name="l03709"></a>03709          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(cur, -1);
<a name="l03710"></a>03710          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03711"></a>03711          <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;memi);
<a name="l03712"></a>03712          <span class="keywordflow">if</span> (need_weight)
<a name="l03713"></a>03713             <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l03714"></a>03714          <span class="keywordflow">goto</span> out;
<a name="l03715"></a>03715       }
<a name="l03716"></a>03716       <span class="keywordflow">if</span> (!datastore) {
<a name="l03717"></a>03717          <span class="keywordflow">if</span> (!(datastore = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="global__datastores_8h.html#a3697a5dbd006917fee0367c497a5cc38">dialed_interface_info</a>, NULL))) {
<a name="l03718"></a>03718             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(cur, -1);
<a name="l03719"></a>03719             <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03720"></a>03720             <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;memi);
<a name="l03721"></a>03721             <span class="keywordflow">if</span> (need_weight)
<a name="l03722"></a>03722                <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l03723"></a>03723             <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(tmp);
<a name="l03724"></a>03724             <span class="keywordflow">goto</span> out;
<a name="l03725"></a>03725          }
<a name="l03726"></a>03726          datastore-&gt;<a class="code" href="structast__datastore.html#a79d869daa2e63a92b3e5f542446031bb">inheritance</a> = <a class="code" href="channel_8h.html#a3a32e3014998d0066281c4dd8e278ae9">DATASTORE_INHERIT_FOREVER</a>;
<a name="l03727"></a>03727          <span class="keywordflow">if</span> (!(dialed_interfaces = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*dialed_interfaces)))) {
<a name="l03728"></a>03728             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(cur, -1);
<a name="l03729"></a>03729             <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(&amp;qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03730"></a>03730             <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;memi);
<a name="l03731"></a>03731             <span class="keywordflow">if</span> (need_weight)
<a name="l03732"></a>03732                <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l03733"></a>03733             <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(tmp);
<a name="l03734"></a>03734             <span class="keywordflow">goto</span> out;
<a name="l03735"></a>03735          }
<a name="l03736"></a>03736          datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = dialed_interfaces;
<a name="l03737"></a>03737          <a class="code" href="linkedlists_8h.html#a6f42d3bf45cc9af6f794d9d1cf8c45ca" title="Initializes a list head structure.">AST_LIST_HEAD_INIT</a>(dialed_interfaces);
<a name="l03738"></a>03738 
<a name="l03739"></a>03739          <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03740"></a>03740          <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, datastore);
<a name="l03741"></a>03741          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03742"></a>03742       } <span class="keywordflow">else</span>
<a name="l03743"></a>03743          dialed_interfaces = datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l03744"></a>03744 
<a name="l03745"></a>03745       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(dialed_interfaces);
<a name="l03746"></a>03746       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(dialed_interfaces, di, list) {
<a name="l03747"></a>03747          <span class="keywordflow">if</span> (!strcasecmp(cur-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, di-&gt;<a class="code" href="structast__dialed__interface.html#a454febcff2099e3e7165d243f65705cd">interface</a>)) {
<a name="l03748"></a>03748             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Skipping dialing interface &apos;%s&apos; since it has already been dialed\n&quot;</span>, 
<a name="l03749"></a>03749                di-&gt;<a class="code" href="structast__dialed__interface.html#a454febcff2099e3e7165d243f65705cd">interface</a>);
<a name="l03750"></a>03750             <span class="keywordflow">break</span>;
<a name="l03751"></a>03751          }
<a name="l03752"></a>03752       }
<a name="l03753"></a>03753       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(dialed_interfaces);
<a name="l03754"></a>03754       
<a name="l03755"></a>03755       <span class="keywordflow">if</span> (di) {
<a name="l03756"></a>03756          <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(tmp);
<a name="l03757"></a>03757          <span class="keywordflow">continue</span>;
<a name="l03758"></a>03758       }
<a name="l03759"></a>03759 
<a name="l03760"></a>03760       <span class="comment">/* It is always ok to dial a Local interface.  We only keep track of</span>
<a name="l03761"></a>03761 <span class="comment">       * which &quot;real&quot; interfaces have been dialed.  The Local channel will</span>
<a name="l03762"></a>03762 <span class="comment">       * inherit this list so that if it ends up dialing a real interface,</span>
<a name="l03763"></a>03763 <span class="comment">       * it won&apos;t call one that has already been called. */</span>
<a name="l03764"></a>03764       <span class="keywordflow">if</span> (strncasecmp(cur-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, <span class="stringliteral">&quot;Local/&quot;</span>, 6)) {
<a name="l03765"></a>03765          <span class="keywordflow">if</span> (!(di = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*di) + strlen(cur-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>)))) {
<a name="l03766"></a>03766             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(cur, -1);
<a name="l03767"></a>03767             <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03768"></a>03768             <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;memi);
<a name="l03769"></a>03769             <span class="keywordflow">if</span> (need_weight)
<a name="l03770"></a>03770                <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l03771"></a>03771             <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(tmp);
<a name="l03772"></a>03772             <span class="keywordflow">goto</span> out;
<a name="l03773"></a>03773          }
<a name="l03774"></a>03774          strcpy(di-&gt;<a class="code" href="structast__dialed__interface.html#a454febcff2099e3e7165d243f65705cd">interface</a>, cur-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>);
<a name="l03775"></a>03775 
<a name="l03776"></a>03776          <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(dialed_interfaces);
<a name="l03777"></a>03777          <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(dialed_interfaces, di, list);
<a name="l03778"></a>03778          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(dialed_interfaces);
<a name="l03779"></a>03779       }
<a name="l03780"></a>03780 
<a name="l03781"></a>03781       tmp-&gt;<a class="code" href="structcallattempt.html#a90acd3aa857bb6520a0266aef650fee9">stillgoing</a> = -1;
<a name="l03782"></a>03782       tmp-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a> = cur;
<a name="l03783"></a>03783       tmp-&gt;<a class="code" href="structcallattempt.html#a0a56811891e1336d4eec52d3281854a9">oldstatus</a> = cur-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a>;
<a name="l03784"></a>03784       tmp-&gt;<a class="code" href="structcallattempt.html#a33479a2976f279910df62bda3a3df62d">lastcall</a> = cur-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>;
<a name="l03785"></a>03785       tmp-&gt;<a class="code" href="structcallattempt.html#ad666640d5cfd34a434cfa5347f50def4">lastqueue</a> = cur-&gt;<a class="code" href="structmember.html#ad666640d5cfd34a434cfa5347f50def4">lastqueue</a>;
<a name="l03786"></a>03786       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>, cur-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structcallattempt.html#a5b9365892c1d516cba42c3c6df59ff69">interface</a>));
<a name="l03787"></a>03787       <span class="comment">/* Special case: If we ring everyone, go ahead and ring them, otherwise</span>
<a name="l03788"></a>03788 <span class="comment">         just calculate their metric for the appropriate strategy */</span>
<a name="l03789"></a>03789       <span class="keywordflow">if</span> (!<a class="code" href="app__queue_8c.html#a76af963fe9291f7d528d6db711144a6d" title="Calculate the metric of each member in the outgoing callattempts.">calc_metric</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, cur, x++, qe, tmp)) {
<a name="l03790"></a>03790          <span class="comment">/* Put them in the list of outgoing thingies...  We&apos;re ready now.</span>
<a name="l03791"></a>03791 <span class="comment">            XXX If we&apos;re forcibly removed, these outgoing calls won&apos;t get</span>
<a name="l03792"></a>03792 <span class="comment">            hung up XXX */</span>
<a name="l03793"></a>03793          tmp-&gt;<a class="code" href="structcallattempt.html#a9e0459b954643e4b37535fdcb0140326">q_next</a> = outgoing;
<a name="l03794"></a>03794          outgoing = tmp;      
<a name="l03795"></a>03795          <span class="comment">/* If this line is up, don&apos;t try anybody else */</span>
<a name="l03796"></a>03796          <span class="keywordflow">if</span> (outgoing-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp; (outgoing-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>))
<a name="l03797"></a>03797             <span class="keywordflow">break</span>;
<a name="l03798"></a>03798       } <span class="keywordflow">else</span> {
<a name="l03799"></a>03799          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(cur, -1);
<a name="l03800"></a>03800          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l03801"></a>03801       }
<a name="l03802"></a>03802    }
<a name="l03803"></a>03803    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;memi);
<a name="l03804"></a>03804 
<a name="l03805"></a>03805    <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#af983858a2192f96c9a30e44467b87f61">timeoutpriority</a> == <a class="code" href="app__queue_8c.html#a452e8221d8fbd54db8c589265a09e844aabaf51de14755cf9b47a42c3cc460a87">TIMEOUT_PRIORITY_APP</a>) {
<a name="l03806"></a>03806       <span class="comment">/* Application arguments have higher timeout priority (behaviour for &lt;=1.6) */</span>
<a name="l03807"></a>03807       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> &amp;&amp; (!qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> || (qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> - now) &lt;= qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>))
<a name="l03808"></a>03808          to = (qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> - now) * 1000;
<a name="l03809"></a>03809       <span class="keywordflow">else</span>
<a name="l03810"></a>03810          to = (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>) ? qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> * 1000 : -1;
<a name="l03811"></a>03811    } <span class="keywordflow">else</span> {
<a name="l03812"></a>03812       <span class="comment">/* Config timeout is higher priority thatn application timeout */</span>
<a name="l03813"></a>03813       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> &amp;&amp; qe-&gt;<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a>&lt;=now) {
<a name="l03814"></a>03814          to = 0;
<a name="l03815"></a>03815       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>) {
<a name="l03816"></a>03816          to = qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> * 1000;
<a name="l03817"></a>03817       } <span class="keywordflow">else</span> {
<a name="l03818"></a>03818          to = -1;
<a name="l03819"></a>03819       }
<a name="l03820"></a>03820    }
<a name="l03821"></a>03821    orig = to;
<a name="l03822"></a>03822    ++qe-&gt;<a class="code" href="structqueue__ent.html#a79ec26d453dcd29aec17f5536233e849">pending</a>;
<a name="l03823"></a>03823    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03824"></a>03824    <a class="code" href="app__queue_8c.html#af0efe7e816fe1c82ebac5d82a3218b31" title="Place a call to a queue member.">ring_one</a>(qe, outgoing, &amp;numbusies);
<a name="l03825"></a>03825    <span class="keywordflow">if</span> (need_weight)
<a name="l03826"></a>03826       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l03827"></a>03827    lpeer = <a class="code" href="app__queue_8c.html#a0034e8c905ec7f5d1222f3ac4947efa8" title="Wait for a member to answer the call.">wait_for_answer</a>(qe, outgoing, &amp;to, &amp;digit, numbusies, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;(bridge_config.<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae4ef6bff70f5837c4ccfcef8d789a9cc">AST_FEATURE_DISCONNECT</a>), forwardsallowed);
<a name="l03828"></a>03828    <span class="comment">/* The ast_channel_datastore_remove() function could fail here if the</span>
<a name="l03829"></a>03829 <span class="comment">    * datastore was moved to another channel during a masquerade. If this is</span>
<a name="l03830"></a>03830 <span class="comment">    * the case, don&apos;t free the datastore here because later, when the channel</span>
<a name="l03831"></a>03831 <span class="comment">    * to which the datastore was moved hangs up, it will attempt to free this</span>
<a name="l03832"></a>03832 <span class="comment">    * datastore again, causing a crash</span>
<a name="l03833"></a>03833 <span class="comment">    */</span>
<a name="l03834"></a>03834    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03835"></a>03835    <span class="keywordflow">if</span> (datastore &amp;&amp; !<a class="code" href="channel_8h.html#a1ff1c62b6d50823da93a920575c9c0c9" title="Remove a datastore from a channel.">ast_channel_datastore_remove</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, datastore)) {
<a name="l03836"></a>03836       <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(datastore);
<a name="l03837"></a>03837    }
<a name="l03838"></a>03838    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03839"></a>03839    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03840"></a>03840    <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> == <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba272ff295ebf6d216c1320a296908753a">QUEUE_STRATEGY_RRMEMORY</a>) {
<a name="l03841"></a>03841       <a class="code" href="app__queue_8c.html#abdcc4a1bb61f226f36c2026ec3d65a35" title="Search for best metric and add to Round Robbin queue.">store_next_rr</a>(qe, outgoing);
<a name="l03842"></a>03842    }
<a name="l03843"></a>03843    <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> == <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba49bae9dfad805972b20763389a090d09">QUEUE_STRATEGY_LINEAR</a>) {
<a name="l03844"></a>03844       <a class="code" href="app__queue_8c.html#a8a12ebde49cdd091865dc355f41a3cb9" title="Search for best metric and add to Linear queue.">store_next_lin</a>(qe, outgoing);
<a name="l03845"></a>03845    }
<a name="l03846"></a>03846    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03847"></a>03847    peer = lpeer ? lpeer-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> : NULL;
<a name="l03848"></a>03848    <span class="keywordflow">if</span> (!peer) {
<a name="l03849"></a>03849       qe-&gt;<a class="code" href="structqueue__ent.html#a79ec26d453dcd29aec17f5536233e849">pending</a> = 0;
<a name="l03850"></a>03850       <span class="keywordflow">if</span> (to) {
<a name="l03851"></a>03851          <span class="comment">/* Must gotten hung up */</span>
<a name="l03852"></a>03852          res = -1;
<a name="l03853"></a>03853       } <span class="keywordflow">else</span> {
<a name="l03854"></a>03854          <span class="comment">/* User exited by pressing a digit */</span>
<a name="l03855"></a>03855          res = digit;
<a name="l03856"></a>03856       }
<a name="l03857"></a>03857       <span class="keywordflow">if</span> (res == -1)
<a name="l03858"></a>03858          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s: Nobody answered.\n&quot;</span>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l03859"></a>03859       <span class="keywordflow">if</span> (<a class="code" href="cdr_8h.html#a3230b9156b0d5fd8b1bd5b91e8ead303">ast_cdr_isset_unanswered</a>()) {
<a name="l03860"></a>03860          <span class="comment">/* channel contains the name of one of the outgoing channels</span>
<a name="l03861"></a>03861 <span class="comment">            in its CDR; zero out this CDR to avoid a dual-posting */</span>
<a name="l03862"></a>03862          <span class="keyword">struct </span><a class="code" href="structcallattempt.html" title="We define a custom &amp;quot;local user&amp;quot; structure because we use it not only for...">callattempt</a> *o;
<a name="l03863"></a>03863          <span class="keywordflow">for</span> (o = outgoing; o; o = o-&gt;<a class="code" href="structcallattempt.html#a9e0459b954643e4b37535fdcb0140326">q_next</a>) {
<a name="l03864"></a>03864             <span class="keywordflow">if</span> (!o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l03865"></a>03865                <span class="keywordflow">continue</span>;
<a name="l03866"></a>03866             }
<a name="l03867"></a>03867             <span class="keywordflow">if</span> (strcmp(o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a0d43f7cac6179c7c4f9521f3138195b4">dstchannel</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a0d43f7cac6179c7c4f9521f3138195b4">dstchannel</a>) == 0) {
<a name="l03868"></a>03868                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(o-&gt;<a class="code" href="structcallattempt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, <a class="code" href="cdr_8h.html#ad1c97f787a4ae3481dd9b48fef118572">AST_CDR_FLAG_POST_DISABLED</a>);
<a name="l03869"></a>03869                <span class="keywordflow">break</span>;
<a name="l03870"></a>03870             }
<a name="l03871"></a>03871          }
<a name="l03872"></a>03872       }
<a name="l03873"></a>03873    } <span class="keywordflow">else</span> { <span class="comment">/* peer is valid */</span>
<a name="l03874"></a>03874       <span class="comment">/* Ah ha!  Someone answered within the desired timeframe.  Of course after this</span>
<a name="l03875"></a>03875 <span class="comment">         we will always return with -1 so that it is hung up properly after the</span>
<a name="l03876"></a>03876 <span class="comment">         conversation.  */</span>
<a name="l03877"></a>03877       <span class="keywordflow">if</span> (!strcmp(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a>, <span class="stringliteral">&quot;DAHDI&quot;</span>))
<a name="l03878"></a>03878          <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="frame_8h.html#a31312f6b6c2296e3495ad1d9e198cbf4">AST_OPTION_TONE_VERIFY</a>, &amp;nondataquality, <span class="keyword">sizeof</span>(nondataquality), 0);
<a name="l03879"></a>03879       <span class="keywordflow">if</span> (!strcmp(peer-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a>, <span class="stringliteral">&quot;DAHDI&quot;</span>))
<a name="l03880"></a>03880          <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(peer, <a class="code" href="frame_8h.html#a31312f6b6c2296e3495ad1d9e198cbf4">AST_OPTION_TONE_VERIFY</a>, &amp;nondataquality, <span class="keyword">sizeof</span>(nondataquality), 0);
<a name="l03881"></a>03881       <span class="comment">/* Update parameters for the queue */</span>
<a name="l03882"></a>03882       time(&amp;now);
<a name="l03883"></a>03883       <a class="code" href="app__queue_8c.html#a43d6ec3224724bd43cc280902fe22991">recalc_holdtime</a>(qe, (now - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>));
<a name="l03884"></a>03884       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03885"></a>03885       callcompletedinsl = ((now - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>) &lt;= qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a6293d1622ff45ccac3a1679171376856">servicelevel</a>);
<a name="l03886"></a>03886       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03887"></a>03887       member = lpeer-&gt;<a class="code" href="structcallattempt.html#adf5e7e1635f0aef4ff3c2119a46dbca4">member</a>;
<a name="l03888"></a>03888       <span class="comment">/* Increment the refcount for this member, since we&apos;re going to be using it for awhile in here. */</span>
<a name="l03889"></a>03889       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(member, 1);
<a name="l03890"></a>03890       <a class="code" href="app__queue_8c.html#a5c48dc0a23bd6fb868ee9b1508d47d4e" title="Hang up a list of outgoing calls.">hangupcalls</a>(outgoing, peer, qe-&gt;<a class="code" href="structqueue__ent.html#a9edbd6d881ea6dd2b0b4d78c11723517">cancel_answered_elsewhere</a>);
<a name="l03891"></a>03891       outgoing = NULL;
<a name="l03892"></a>03892       <span class="keywordflow">if</span> (announce || qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a20ba21c586c791a31ef97102b4811a8f">reportholdtime</a> || qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#adc032ac2dcea31bd708fc762f42c385e">memberdelay</a>) {
<a name="l03893"></a>03893          <span class="keywordtype">int</span> res2;
<a name="l03894"></a>03894 
<a name="l03895"></a>03895          res2 = <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03896"></a>03896          <span class="keywordflow">if</span> (!res2) {
<a name="l03897"></a>03897             <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#adc032ac2dcea31bd708fc762f42c385e">memberdelay</a>) {
<a name="l03898"></a>03898                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Delaying member connect for %d seconds\n&quot;</span>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#adc032ac2dcea31bd708fc762f42c385e">memberdelay</a>);
<a name="l03899"></a>03899                res2 |= <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(peer, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#adc032ac2dcea31bd708fc762f42c385e">memberdelay</a> * 1000);
<a name="l03900"></a>03900             }
<a name="l03901"></a>03901             <span class="keywordflow">if</span> (!res2 &amp;&amp; announce) {
<a name="l03902"></a>03902                <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(peer, announce);
<a name="l03903"></a>03903             }
<a name="l03904"></a>03904             <span class="keywordflow">if</span> (!res2 &amp;&amp; qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a20ba21c586c791a31ef97102b4811a8f">reportholdtime</a>) {
<a name="l03905"></a>03905                <span class="keywordflow">if</span> (!<a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(peer, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_reporthold)) {
<a name="l03906"></a>03906                   <span class="keywordtype">int</span> holdtime, holdtimesecs;
<a name="l03907"></a>03907 
<a name="l03908"></a>03908                   time(&amp;now);
<a name="l03909"></a>03909                   holdtime = abs((now - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>) / 60);
<a name="l03910"></a>03910                   holdtimesecs = abs((now - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>) % 60);
<a name="l03911"></a>03911                   <span class="keywordflow">if</span> (holdtime &gt; 0) {
<a name="l03912"></a>03912                      <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(peer, holdtime, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, peer-&gt;language, NULL);
<a name="l03913"></a>03913                      <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(peer, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_minutes);
<a name="l03914"></a>03914                   }
<a name="l03915"></a>03915                   <span class="keywordflow">if</span> (holdtimesecs &gt; 1) {
<a name="l03916"></a>03916                      <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(peer, holdtimesecs, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, peer-&gt;language, NULL);
<a name="l03917"></a>03917                      <a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(peer, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_seconds);
<a name="l03918"></a>03918                   }
<a name="l03919"></a>03919                }
<a name="l03920"></a>03920             }
<a name="l03921"></a>03921          }
<a name="l03922"></a>03922          res2 |= <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03923"></a>03923          <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(peer)) {
<a name="l03924"></a>03924             <span class="comment">/* Agent must have hung up */</span>
<a name="l03925"></a>03925             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Agent on %s hungup on the customer.\n&quot;</span>, peer-&gt;name);
<a name="l03926"></a>03926             <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(queuename, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, <span class="stringliteral">&quot;AGENTDUMP&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03927"></a>03927             <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a>)
<a name="l03928"></a>03928                <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;AgentDump&quot;</span>,
<a name="l03929"></a>03929                      <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l03930"></a>03930                      <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l03931"></a>03931                      <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l03932"></a>03932                      <span class="stringliteral">&quot;Member: %s\r\n&quot;</span>
<a name="l03933"></a>03933                      <span class="stringliteral">&quot;MemberName: %s\r\n&quot;</span>
<a name="l03934"></a>03934                      <span class="stringliteral">&quot;%s&quot;</span>,
<a name="l03935"></a>03935                      queuename, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, peer-&gt;name, member-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>,
<a name="l03936"></a>03936                      qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a> == <a class="code" href="app__queue_8c.html#a533ee4344c442cf6da3e610598ecca75">QUEUE_EVENT_VARIABLES</a> ? <a class="code" href="app__queue_8c.html#a5f13e8661f3dfcdb919d8140a997cf7a" title="convert &amp;quot;\n&amp;quot; to &amp;quot;\nVariable: &amp;quot; ready for manager to use">vars2manager</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, vars, <span class="keyword">sizeof</span>(vars)) : <span class="stringliteral">&quot;&quot;</span>);
<a name="l03937"></a>03937             <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(peer);
<a name="l03938"></a>03938             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(member, -1);
<a name="l03939"></a>03939             <span class="keywordflow">goto</span> out;
<a name="l03940"></a>03940          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res2) {
<a name="l03941"></a>03941             <span class="comment">/* Caller must have hung up just before being connected*/</span>
<a name="l03942"></a>03942             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Caller was about to talk to agent on %s but the caller hungup.\n&quot;</span>, peer-&gt;name);
<a name="l03943"></a>03943             <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(queuename, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, <span class="stringliteral">&quot;ABANDON&quot;</span>, <span class="stringliteral">&quot;%d|%d|%ld&quot;</span>, qe-&gt;<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>, (<span class="keywordtype">long</span>) time(NULL) - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>);
<a name="l03944"></a>03944             <a class="code" href="app__queue_8c.html#a0b2ffd959c3ce34b11292c6ecfc8f2d8" title="Record that a caller gave up on waiting in queue.">record_abandoned</a>(qe);
<a name="l03945"></a>03945             <a class="code" href="cdr_8h.html#a46d2f4a55a1be9b94fef1a87ac3f7fbb" title="A call wasn&amp;#39;t answered.">ast_cdr_noanswer</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l03946"></a>03946             <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(peer);
<a name="l03947"></a>03947             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(member, -1);
<a name="l03948"></a>03948             <span class="keywordflow">return</span> -1;
<a name="l03949"></a>03949          }
<a name="l03950"></a>03950       }
<a name="l03951"></a>03951       <span class="comment">/* Stop music on hold */</span>
<a name="l03952"></a>03952       <span class="keywordflow">if</span> (ringing)
<a name="l03953"></a>03953          <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>,-1);
<a name="l03954"></a>03954       <span class="keywordflow">else</span>
<a name="l03955"></a>03955          <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03956"></a>03956       <span class="comment">/* If appropriate, log that we have a destination channel */</span>
<a name="l03957"></a>03957       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l03958"></a>03958          <a class="code" href="cdr_8h.html#aa7ed883d22142f873c13cf5364b95e1e" title="Set the destination channel, if there was one.">ast_cdr_setdestchan</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, peer-&gt;name);
<a name="l03959"></a>03959       <span class="comment">/* Make sure channels are compatible */</span>
<a name="l03960"></a>03960       res = <a class="code" href="channel_8h.html#a57646ce13ff95b5fc66dea2e741b21ff" title="Makes two channel formats compatible.">ast_channel_make_compatible</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, peer);
<a name="l03961"></a>03961       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l03962"></a>03962          <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(queuename, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, <span class="stringliteral">&quot;SYSCOMPAT&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03963"></a>03963          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Had to drop call because I couldn&apos;t make %s compatible with %s\n&quot;</span>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, peer-&gt;name);
<a name="l03964"></a>03964          <a class="code" href="app__queue_8c.html#a0b2ffd959c3ce34b11292c6ecfc8f2d8" title="Record that a caller gave up on waiting in queue.">record_abandoned</a>(qe);
<a name="l03965"></a>03965          <a class="code" href="cdr_8h.html#acdce2d9d0af5180090b70149ce18e554" title="Fail a call.">ast_cdr_failed</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l03966"></a>03966          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(peer);
<a name="l03967"></a>03967          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(member, -1);
<a name="l03968"></a>03968          <span class="keywordflow">return</span> -1;
<a name="l03969"></a>03969       }
<a name="l03970"></a>03970 
<a name="l03971"></a>03971       <span class="comment">/* Play announcement to the caller telling it&apos;s his turn if defined */</span>
<a name="l03972"></a>03972       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_callerannounce)) {
<a name="l03973"></a>03973          <span class="keywordflow">if</span> (<a class="code" href="app__queue_8c.html#a244b9e8ffcadf8040db882c82f5b120b">play_file</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_callerannounce))
<a name="l03974"></a>03974             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Announcement file &apos;%s&apos; is unavailable, continuing anyway...\n&quot;</span>, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;sound_callerannounce);
<a name="l03975"></a>03975       }
<a name="l03976"></a>03976 
<a name="l03977"></a>03977       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l03978"></a>03978       <span class="comment">/* if setinterfacevar is defined, make member variables available to the channel */</span>
<a name="l03979"></a>03979       <span class="comment">/* use  pbx_builtin_setvar to set a load of variables with one call */</span>
<a name="l03980"></a>03980       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a0c5bcd98bca1c3085183ba1fc80195ed">setinterfacevar</a>) {
<a name="l03981"></a>03981          snprintf(interfacevar, <span class="keyword">sizeof</span>(interfacevar), <span class="stringliteral">&quot;MEMBERINTERFACE=%s,MEMBERNAME=%s,MEMBERCALLS=%d,MEMBERLASTCALL=%ld,MEMBERPENALTY=%d,MEMBERDYNAMIC=%d,MEMBERREALTIME=%d&quot;</span>,
<a name="l03982"></a>03982             member-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, member-&gt;<a class="code" href="structmember.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a>, (<span class="keywordtype">long</span>)member-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>, member-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>, member-&gt;<a class="code" href="structmember.html#a44690a0a629211d7620ce0d55c412e9d">dynamic</a>, member-&gt;<a class="code" href="structmember.html#aac1ae37fa4007496a50df75cf1f698c1">realtime</a>);
<a name="l03983"></a>03983          <a class="code" href="pbx_8h.html#a990bfc8582dc017423d8518bcc110a2c" title="Parse and set multiple channel variables, where the pairs are separated by the &amp;#39;...">pbx_builtin_setvar_multiple</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, interfacevar);
<a name="l03984"></a>03984          <a class="code" href="pbx_8h.html#a990bfc8582dc017423d8518bcc110a2c" title="Parse and set multiple channel variables, where the pairs are separated by the &amp;#39;...">pbx_builtin_setvar_multiple</a>(peer, interfacevar);
<a name="l03985"></a>03985       }
<a name="l03986"></a>03986       
<a name="l03987"></a>03987       <span class="comment">/* if setqueueentryvar is defined, make queue entry (i.e. the caller) variables available to the channel */</span>
<a name="l03988"></a>03988       <span class="comment">/* use  pbx_builtin_setvar to set a load of variables with one call */</span>
<a name="l03989"></a>03989       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a23486e86a21295aa734885d335ae9c2f">setqueueentryvar</a>) {
<a name="l03990"></a>03990          snprintf(interfacevar, <span class="keyword">sizeof</span>(interfacevar), <span class="stringliteral">&quot;QEHOLDTIME=%ld,QEORIGINALPOS=%d&quot;</span>,
<a name="l03991"></a>03991             (<span class="keywordtype">long</span>) time(NULL) - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>);
<a name="l03992"></a>03992          <a class="code" href="pbx_8h.html#a990bfc8582dc017423d8518bcc110a2c" title="Parse and set multiple channel variables, where the pairs are separated by the &amp;#39;...">pbx_builtin_setvar_multiple</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, interfacevar);
<a name="l03993"></a>03993          <a class="code" href="pbx_8h.html#a990bfc8582dc017423d8518bcc110a2c" title="Parse and set multiple channel variables, where the pairs are separated by the &amp;#39;...">pbx_builtin_setvar_multiple</a>(peer, interfacevar);
<a name="l03994"></a>03994       }
<a name="l03995"></a>03995    
<a name="l03996"></a>03996       <span class="comment">/* try to set queue variables if configured to do so*/</span>
<a name="l03997"></a>03997       <a class="code" href="app__queue_8c.html#a1248fe33745c5cb9c87db6be0a25d138" title="Set variables of queue.">set_queue_variables</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l03998"></a>03998       <a class="code" href="app__queue_8c.html#a1248fe33745c5cb9c87db6be0a25d138" title="Set variables of queue.">set_queue_variables</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, peer);
<a name="l03999"></a>03999       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l04000"></a>04000       
<a name="l04001"></a>04001       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l04002"></a>04002       <span class="keywordflow">if</span> ((monitorfilename = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;MONITOR_FILENAME&quot;</span>))) {
<a name="l04003"></a>04003             monitorfilename = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(monitorfilename);
<a name="l04004"></a>04004       }
<a name="l04005"></a>04005       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l04006"></a>04006       <span class="comment">/* Begin Monitoring */</span>
<a name="l04007"></a>04007       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#ab76c064ab44a836302512ee2adbb297e">monfmt</a> &amp;&amp; *qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#ab76c064ab44a836302512ee2adbb297e">monfmt</a>) {
<a name="l04008"></a>04008          <span class="keywordflow">if</span> (!qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a7ccaa047c703f95f5eaf0dd0a10670b5">montype</a>) {
<a name="l04009"></a>04009             <span class="keyword">const</span> <span class="keywordtype">char</span> *monexec, *monargs;
<a name="l04010"></a>04010             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Starting Monitor as requested.\n&quot;</span>);
<a name="l04011"></a>04011             <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l04012"></a>04012             <span class="keywordflow">if</span> ((monexec = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;MONITOR_EXEC&quot;</span>)) || (monargs = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;MONITOR_EXEC_ARGS&quot;</span>))) {
<a name="l04013"></a>04013                which = qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l04014"></a>04014                monexec = monexec ? <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(monexec) : NULL;
<a name="l04015"></a>04015             }
<a name="l04016"></a>04016             <span class="keywordflow">else</span>
<a name="l04017"></a>04017                which = peer;
<a name="l04018"></a>04018             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l04019"></a>04019             <span class="keywordflow">if</span> (<a class="code" href="monitor_8h.html#a5c2b029a972b1819e2baaa63906d5bc6" title="Start monitoring a channel.">ast_monitor_start</a>) {
<a name="l04020"></a>04020                <span class="keywordflow">if</span> (monitorfilename) {
<a name="l04021"></a>04021                   <a class="code" href="monitor_8h.html#a5c2b029a972b1819e2baaa63906d5bc6" title="Start monitoring a channel.">ast_monitor_start</a>(which, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#ab76c064ab44a836302512ee2adbb297e">monfmt</a>, monitorfilename, 1, <a class="code" href="monitor_8h.html#a95b90f61870300ea984afae5123dd44f">X_REC_IN</a> | <a class="code" href="monitor_8h.html#ac03869f26afacb6d45355d401ced19d8">X_REC_OUT</a>);
<a name="l04022"></a>04022                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> &amp;&amp; <a class="code" href="monitor_8h.html#a5c2b029a972b1819e2baaa63906d5bc6" title="Start monitoring a channel.">ast_monitor_start</a>) {
<a name="l04023"></a>04023                   <a class="code" href="monitor_8h.html#a5c2b029a972b1819e2baaa63906d5bc6" title="Start monitoring a channel.">ast_monitor_start</a>(which, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#ab76c064ab44a836302512ee2adbb297e">monfmt</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#aa7a934e4f070b98b9113d24737a40ec5">uniqueid</a>, 1, <a class="code" href="monitor_8h.html#a95b90f61870300ea984afae5123dd44f">X_REC_IN</a> | <a class="code" href="monitor_8h.html#ac03869f26afacb6d45355d401ced19d8">X_REC_OUT</a>);
<a name="l04024"></a>04024                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="monitor_8h.html#a5c2b029a972b1819e2baaa63906d5bc6" title="Start monitoring a channel.">ast_monitor_start</a>) {
<a name="l04025"></a>04025                   <span class="comment">/* Last ditch effort -- no CDR, make up something */</span>
<a name="l04026"></a>04026                   snprintf(tmpid, <span class="keyword">sizeof</span>(tmpid), <span class="stringliteral">&quot;chan-%lx&quot;</span>, <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l04027"></a>04027                   <a class="code" href="monitor_8h.html#a5c2b029a972b1819e2baaa63906d5bc6" title="Start monitoring a channel.">ast_monitor_start</a>(which, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#ab76c064ab44a836302512ee2adbb297e">monfmt</a>, tmpid, 1, <a class="code" href="monitor_8h.html#a95b90f61870300ea984afae5123dd44f">X_REC_IN</a> | <a class="code" href="monitor_8h.html#ac03869f26afacb6d45355d401ced19d8">X_REC_OUT</a>);
<a name="l04028"></a>04028                }
<a name="l04029"></a>04029             }
<a name="l04030"></a>04030             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(monexec) &amp;&amp; <a class="code" href="monitor_8h.html#a170e08ebc79dab55c1ff3a5fd4d9214e">ast_monitor_setjoinfiles</a>) {
<a name="l04031"></a>04031                <a class="code" href="monitor_8h.html#a170e08ebc79dab55c1ff3a5fd4d9214e">ast_monitor_setjoinfiles</a>(which, 1);
<a name="l04032"></a>04032             }
<a name="l04033"></a>04033          } <span class="keywordflow">else</span> {
<a name="l04034"></a>04034             mixmonapp = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(<span class="stringliteral">&quot;MixMonitor&quot;</span>);
<a name="l04035"></a>04035             
<a name="l04036"></a>04036             <span class="keywordflow">if</span> (mixmonapp) {
<a name="l04037"></a>04037                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Starting MixMonitor as requested.\n&quot;</span>);
<a name="l04038"></a>04038                <span class="keywordflow">if</span> (!monitorfilename) {
<a name="l04039"></a>04039                   <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l04040"></a>04040                      <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmpid, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#aa7a934e4f070b98b9113d24737a40ec5">uniqueid</a>, <span class="keyword">sizeof</span>(tmpid));
<a name="l04041"></a>04041                   <span class="keywordflow">else</span>
<a name="l04042"></a>04042                      snprintf(tmpid, <span class="keyword">sizeof</span>(tmpid), <span class="stringliteral">&quot;chan-%lx&quot;</span>, <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l04043"></a>04043                } <span class="keywordflow">else</span> {
<a name="l04044"></a>04044                   <span class="keyword">const</span> <span class="keywordtype">char</span> *m = monitorfilename;
<a name="l04045"></a>04045                   <span class="keywordflow">for</span> (p = tmpid2; p &lt; tmpid2 + <span class="keyword">sizeof</span>(tmpid2) - 1; p++, m++) {
<a name="l04046"></a>04046                      <span class="keywordflow">switch</span> (*m) {
<a name="l04047"></a>04047                      <span class="keywordflow">case</span> <span class="charliteral">&apos;^&apos;</span>:
<a name="l04048"></a>04048                         <span class="keywordflow">if</span> (*(m + 1) == <span class="charliteral">&apos;{&apos;</span>)
<a name="l04049"></a>04049                            *p = <span class="charliteral">&apos;$&apos;</span>;
<a name="l04050"></a>04050                         <span class="keywordflow">break</span>;
<a name="l04051"></a>04051                      <span class="keywordflow">case</span> <span class="charliteral">&apos;,&apos;</span>:
<a name="l04052"></a>04052                         *p++ = <span class="charliteral">&apos;\\&apos;</span>;
<a name="l04053"></a>04053                         <span class="comment">/* Fall through */</span>
<a name="l04054"></a>04054                      <span class="keywordflow">default</span>:
<a name="l04055"></a>04055                         *p = *m;
<a name="l04056"></a>04056                      }
<a name="l04057"></a>04057                      <span class="keywordflow">if</span> (*m == <span class="charliteral">&apos;\0&apos;</span>)
<a name="l04058"></a>04058                         <span class="keywordflow">break</span>;
<a name="l04059"></a>04059                   }
<a name="l04060"></a>04060                   <span class="keywordflow">if</span> (p == tmpid2 + <span class="keyword">sizeof</span>(tmpid2))
<a name="l04061"></a>04061                      tmpid2[<span class="keyword">sizeof</span>(tmpid2) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04062"></a>04062 
<a name="l04063"></a>04063                   <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, tmpid2, tmpid, <span class="keyword">sizeof</span>(tmpid) - 1);
<a name="l04064"></a>04064                }
<a name="l04065"></a>04065 
<a name="l04066"></a>04066                <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l04067"></a>04067                <span class="keywordflow">if</span> ((monitor_exec = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;MONITOR_EXEC&quot;</span>))) {
<a name="l04068"></a>04068                      monitor_exec = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(monitor_exec);
<a name="l04069"></a>04069                }
<a name="l04070"></a>04070                <span class="keywordflow">if</span> ((monitor_options = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;MONITOR_OPTIONS&quot;</span>))) {
<a name="l04071"></a>04071                      monitor_options = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(monitor_options);
<a name="l04072"></a>04072                } <span class="keywordflow">else</span> {
<a name="l04073"></a>04073                   monitor_options = <span class="stringliteral">&quot;&quot;</span>;
<a name="l04074"></a>04074                }
<a name="l04075"></a>04075                <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l04076"></a>04076 
<a name="l04077"></a>04077                <span class="keywordflow">if</span> (monitor_exec) {
<a name="l04078"></a>04078                   <span class="keyword">const</span> <span class="keywordtype">char</span> *m = monitor_exec;
<a name="l04079"></a>04079                   <span class="keywordflow">for</span> (p = meid2; p &lt; meid2 + <span class="keyword">sizeof</span>(meid2) - 1; p++, m++) {
<a name="l04080"></a>04080                      <span class="keywordflow">switch</span> (*m) {
<a name="l04081"></a>04081                      <span class="keywordflow">case</span> <span class="charliteral">&apos;^&apos;</span>:
<a name="l04082"></a>04082                         <span class="keywordflow">if</span> (*(m + 1) == <span class="charliteral">&apos;{&apos;</span>)
<a name="l04083"></a>04083                            *p = <span class="charliteral">&apos;$&apos;</span>;
<a name="l04084"></a>04084                         <span class="keywordflow">break</span>;
<a name="l04085"></a>04085                      <span class="keywordflow">case</span> <span class="charliteral">&apos;,&apos;</span>:
<a name="l04086"></a>04086                         *p++ = <span class="charliteral">&apos;\\&apos;</span>;
<a name="l04087"></a>04087                         <span class="comment">/* Fall through */</span>
<a name="l04088"></a>04088                      <span class="keywordflow">default</span>:
<a name="l04089"></a>04089                         *p = *m;
<a name="l04090"></a>04090                      }
<a name="l04091"></a>04091                      <span class="keywordflow">if</span> (*m == <span class="charliteral">&apos;\0&apos;</span>)
<a name="l04092"></a>04092                         <span class="keywordflow">break</span>;
<a name="l04093"></a>04093                   }
<a name="l04094"></a>04094                   <span class="keywordflow">if</span> (p == meid2 + <span class="keyword">sizeof</span>(meid2))
<a name="l04095"></a>04095                      meid2[<span class="keyword">sizeof</span>(meid2) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04096"></a>04096 
<a name="l04097"></a>04097                   <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, meid2, meid, <span class="keyword">sizeof</span>(meid) - 1);
<a name="l04098"></a>04098                }
<a name="l04099"></a>04099    
<a name="l04100"></a>04100                snprintf(tmpid2, <span class="keyword">sizeof</span>(tmpid2), <span class="stringliteral">&quot;%s.%s&quot;</span>, tmpid, qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#ab76c064ab44a836302512ee2adbb297e">monfmt</a>);
<a name="l04101"></a>04101 
<a name="l04102"></a>04102                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(monitor_exec))
<a name="l04103"></a>04103                   snprintf(mixmonargs, <span class="keyword">sizeof</span>(mixmonargs), <span class="stringliteral">&quot;%s,b%s,%s&quot;</span>, tmpid2, monitor_options, monitor_exec);
<a name="l04104"></a>04104                <span class="keywordflow">else</span>
<a name="l04105"></a>04105                   snprintf(mixmonargs, <span class="keyword">sizeof</span>(mixmonargs), <span class="stringliteral">&quot;%s,b%s&quot;</span>, tmpid2, monitor_options);
<a name="l04106"></a>04106                
<a name="l04107"></a>04107                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Arguments being passed to MixMonitor: %s\n&quot;</span>, mixmonargs);
<a name="l04108"></a>04108                <span class="comment">/* We purposely lock the CDR so that pbx_exec does not update the application data */</span>
<a name="l04109"></a>04109                <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l04110"></a>04110                   <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, <a class="code" href="cdr_8h.html#ad19495bac7dec6a99190f93e21965da6">AST_CDR_FLAG_LOCKED</a>);
<a name="l04111"></a>04111                ret = <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, mixmonapp, mixmonargs);
<a name="l04112"></a>04112                <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l04113"></a>04113                   <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, <a class="code" href="cdr_8h.html#ad19495bac7dec6a99190f93e21965da6">AST_CDR_FLAG_LOCKED</a>);
<a name="l04114"></a>04114 
<a name="l04115"></a>04115             } <span class="keywordflow">else</span> {
<a name="l04116"></a>04116                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Asked to run MixMonitor on this call, but cannot find the MixMonitor app!\n&quot;</span>);
<a name="l04117"></a>04117             }
<a name="l04118"></a>04118          }
<a name="l04119"></a>04119       }
<a name="l04120"></a>04120       <span class="comment">/* Drop out of the queue at this point, to prepare for next caller */</span>
<a name="l04121"></a>04121       <a class="code" href="app__queue_8c.html#a3135d5c6b468bef49c1e3fc5d7394f30" title="Caller leaving queue.">leave_queue</a>(qe);        
<a name="l04122"></a>04122       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(url) &amp;&amp; <a class="code" href="channel_8h.html#a981a7bfac667e10cb62582b465e48d98">ast_channel_supports_html</a>(peer)) {
<a name="l04123"></a>04123          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;app_queue: sendurl=%s.\n&quot;</span>, url);
<a name="l04124"></a>04124          <a class="code" href="channel_8h.html#ac1509976728f0058b229802a66a485ee">ast_channel_sendurl</a>(peer, url);
<a name="l04125"></a>04125       }
<a name="l04126"></a>04126       
<a name="l04127"></a>04127       <span class="comment">/* run a macro for this connection if defined. The macro simply returns, no action is taken on the result */</span>
<a name="l04128"></a>04128       <span class="comment">/* use macro from dialplan if passed as a option, otherwise use the default queue macro */</span>
<a name="l04129"></a>04129       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(macro)) {
<a name="l04130"></a>04130             macroexec = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(macro);
<a name="l04131"></a>04131       } <span class="keywordflow">else</span> {
<a name="l04132"></a>04132          <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;membermacro)
<a name="l04133"></a>04133             macroexec = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;membermacro);
<a name="l04134"></a>04134       }
<a name="l04135"></a>04135 
<a name="l04136"></a>04136       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(macroexec)) {
<a name="l04137"></a>04137          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;app_queue: macro=%s.\n&quot;</span>, macroexec);
<a name="l04138"></a>04138          
<a name="l04139"></a>04139          res = <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l04140"></a>04140          <span class="keywordflow">if</span> (res) {
<a name="l04141"></a>04141             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to start autoservice on calling channel\n&quot;</span>);
<a name="l04142"></a>04142             res = -1;
<a name="l04143"></a>04143          }
<a name="l04144"></a>04144          
<a name="l04145"></a>04145          application = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(<span class="stringliteral">&quot;Macro&quot;</span>);
<a name="l04146"></a>04146 
<a name="l04147"></a>04147          <span class="keywordflow">if</span> (application) {
<a name="l04148"></a>04148             res = <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(peer, application, macroexec);
<a name="l04149"></a>04149             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Macro exited with status %d\n&quot;</span>, res);
<a name="l04150"></a>04150             res = 0;
<a name="l04151"></a>04151          } <span class="keywordflow">else</span> {
<a name="l04152"></a>04152             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not find application Macro\n&quot;</span>);
<a name="l04153"></a>04153             res = -1;
<a name="l04154"></a>04154          }
<a name="l04155"></a>04155 
<a name="l04156"></a>04156          <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) &lt; 0) {
<a name="l04157"></a>04157             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not stop autoservice on calling channel\n&quot;</span>);
<a name="l04158"></a>04158             res = -1;
<a name="l04159"></a>04159          }
<a name="l04160"></a>04160       }
<a name="l04161"></a>04161 
<a name="l04162"></a>04162       <span class="comment">/* run a gosub for this connection if defined. The gosub simply returns, no action is taken on the result */</span>
<a name="l04163"></a>04163       <span class="comment">/* use gosub from dialplan if passed as a option, otherwise use the default queue gosub */</span>
<a name="l04164"></a>04164       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(gosub)) {
<a name="l04165"></a>04165             gosubexec = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(gosub);
<a name="l04166"></a>04166       } <span class="keywordflow">else</span> {
<a name="l04167"></a>04167          <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;membergosub)
<a name="l04168"></a>04168             gosubexec = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;membergosub);
<a name="l04169"></a>04169       }
<a name="l04170"></a>04170 
<a name="l04171"></a>04171       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(gosubexec)) {
<a name="l04172"></a>04172          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;app_queue: gosub=%s.\n&quot;</span>, gosubexec);
<a name="l04173"></a>04173          
<a name="l04174"></a>04174          res = <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l04175"></a>04175          <span class="keywordflow">if</span> (res) {
<a name="l04176"></a>04176             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to start autoservice on calling channel\n&quot;</span>);
<a name="l04177"></a>04177             res = -1;
<a name="l04178"></a>04178          }
<a name="l04179"></a>04179          
<a name="l04180"></a>04180          application = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(<span class="stringliteral">&quot;Gosub&quot;</span>);
<a name="l04181"></a>04181          
<a name="l04182"></a>04182          <span class="keywordflow">if</span> (application) {
<a name="l04183"></a>04183             <span class="keywordtype">char</span> *gosub_args, *gosub_argstart;
<a name="l04184"></a>04184 
<a name="l04185"></a>04185             <span class="comment">/* Set where we came from */</span>
<a name="l04186"></a>04186             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(peer-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;app_queue_gosub_virtual_context&quot;</span>, <span class="keyword">sizeof</span>(peer-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l04187"></a>04187             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(peer-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="stringliteral">&quot;s&quot;</span>, <span class="keyword">sizeof</span>(peer-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l04188"></a>04188             peer-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 0;
<a name="l04189"></a>04189 
<a name="l04190"></a>04190             gosub_argstart = strchr(gosubexec, <span class="charliteral">&apos;,&apos;</span>);
<a name="l04191"></a>04191             <span class="keywordflow">if</span> (gosub_argstart) {
<a name="l04192"></a>04192                *gosub_argstart = 0;
<a name="l04193"></a>04193                <span class="keywordflow">if</span> (<a class="code" href="astmm_8h.html#a5d1f84199c77c83b8b51928dd359e228">asprintf</a>(&amp;gosub_args, <span class="stringliteral">&quot;%s,s,1(%s)&quot;</span>, gosubexec, gosub_argstart + 1) &lt; 0) {
<a name="l04194"></a>04194                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;asprintf() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l04195"></a>04195                   gosub_args = NULL;
<a name="l04196"></a>04196                }
<a name="l04197"></a>04197                *gosub_argstart = <span class="charliteral">&apos;,&apos;</span>;
<a name="l04198"></a>04198             } <span class="keywordflow">else</span> {
<a name="l04199"></a>04199                <span class="keywordflow">if</span> (<a class="code" href="astmm_8h.html#a5d1f84199c77c83b8b51928dd359e228">asprintf</a>(&amp;gosub_args, <span class="stringliteral">&quot;%s,s,1&quot;</span>, gosubexec) &lt; 0) {
<a name="l04200"></a>04200                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;asprintf() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l04201"></a>04201                   gosub_args = NULL;
<a name="l04202"></a>04202                }
<a name="l04203"></a>04203             }
<a name="l04204"></a>04204             <span class="keywordflow">if</span> (gosub_args) {
<a name="l04205"></a>04205                res = <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(peer, application, gosub_args);
<a name="l04206"></a>04206                <span class="keywordflow">if</span> (!res) {
<a name="l04207"></a>04207                   <span class="keyword">struct </span><a class="code" href="structast__pbx__args.html" title="Options for ast_pbx_run().">ast_pbx_args</a> args;
<a name="l04208"></a>04208                   memset(&amp;args, 0, <span class="keyword">sizeof</span>(args));
<a name="l04209"></a>04209                   args.<a class="code" href="structast__pbx__args.html#a0449b0be05342e431e60937c47fc52f7">no_hangup_chan</a> = 1;
<a name="l04210"></a>04210                   <a class="code" href="pbx_8h.html#a2c502c100b8b4791d9efe395e08d620b" title="Execute the PBX in the current thread.">ast_pbx_run_args</a>(peer, &amp;args);
<a name="l04211"></a>04211                }
<a name="l04212"></a>04212                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(gosub_args);
<a name="l04213"></a>04213                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Gosub exited with status %d\n&quot;</span>, res);
<a name="l04214"></a>04214             } <span class="keywordflow">else</span> {
<a name="l04215"></a>04215                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not Allocate string for Gosub arguments -- Gosub Call Aborted!\n&quot;</span>);
<a name="l04216"></a>04216             }
<a name="l04217"></a>04217          } <span class="keywordflow">else</span> {
<a name="l04218"></a>04218             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not find application Gosub\n&quot;</span>);
<a name="l04219"></a>04219             res = -1;
<a name="l04220"></a>04220          }
<a name="l04221"></a>04221       
<a name="l04222"></a>04222          <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) &lt; 0) {
<a name="l04223"></a>04223             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not stop autoservice on calling channel\n&quot;</span>);
<a name="l04224"></a>04224             res = -1;
<a name="l04225"></a>04225          }
<a name="l04226"></a>04226       }
<a name="l04227"></a>04227 
<a name="l04228"></a>04228       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(agi)) {
<a name="l04229"></a>04229          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;app_queue: agi=%s.\n&quot;</span>, agi);
<a name="l04230"></a>04230          application = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(<span class="stringliteral">&quot;agi&quot;</span>);
<a name="l04231"></a>04231          <span class="keywordflow">if</span> (application) {
<a name="l04232"></a>04232             agiexec = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(agi);
<a name="l04233"></a>04233             ret = <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, application, agiexec);
<a name="l04234"></a>04234          } <span class="keywordflow">else</span>
<a name="l04235"></a>04235             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Asked to execute an AGI on this channel, but could not find application (agi)!\n&quot;</span>);
<a name="l04236"></a>04236       }
<a name="l04237"></a>04237       qe-&gt;<a class="code" href="structqueue__ent.html#ab234be20f2e48f4f08d2d2c071b8ff55">handled</a>++;
<a name="l04238"></a>04238       <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(queuename, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, <span class="stringliteral">&quot;CONNECT&quot;</span>, <span class="stringliteral">&quot;%ld|%s|%ld&quot;</span>, (<span class="keywordtype">long</span>) time(NULL) - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>, peer-&gt;uniqueid,
<a name="l04239"></a>04239                                        (<span class="keywordtype">long</span>)(orig - to &gt; 0 ? (orig - to) / 1000 : 0));
<a name="l04240"></a>04240       <span class="keywordflow">if</span> (update_cdr &amp;&amp; qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>) 
<a name="l04241"></a>04241          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a0d43f7cac6179c7c4f9521f3138195b4">dstchannel</a>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, <span class="keyword">sizeof</span>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a0d43f7cac6179c7c4f9521f3138195b4">dstchannel</a>));
<a name="l04242"></a>04242       <span class="keywordflow">if</span> (qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a>)
<a name="l04243"></a>04243          <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;AgentConnect&quot;</span>,
<a name="l04244"></a>04244                <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l04245"></a>04245                <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l04246"></a>04246                <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l04247"></a>04247                <span class="stringliteral">&quot;Member: %s\r\n&quot;</span>
<a name="l04248"></a>04248                <span class="stringliteral">&quot;MemberName: %s\r\n&quot;</span>
<a name="l04249"></a>04249                <span class="stringliteral">&quot;Holdtime: %ld\r\n&quot;</span>
<a name="l04250"></a>04250                <span class="stringliteral">&quot;BridgedChannel: %s\r\n&quot;</span>
<a name="l04251"></a>04251                <span class="stringliteral">&quot;Ringtime: %ld\r\n&quot;</span>
<a name="l04252"></a>04252                <span class="stringliteral">&quot;%s&quot;</span>,
<a name="l04253"></a>04253                queuename, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, peer-&gt;name, member-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>,
<a name="l04254"></a>04254                (<span class="keywordtype">long</span>) time(NULL) - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>, peer-&gt;uniqueid, (<span class="keywordtype">long</span>)(orig - to &gt; 0 ? (orig - to) / 1000 : 0),
<a name="l04255"></a>04255                qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#af06d6103246856160c7ea9917c4ea1ec">eventwhencalled</a> == <a class="code" href="app__queue_8c.html#a533ee4344c442cf6da3e610598ecca75">QUEUE_EVENT_VARIABLES</a> ? <a class="code" href="app__queue_8c.html#a5f13e8661f3dfcdb919d8140a997cf7a" title="convert &amp;quot;\n&amp;quot; to &amp;quot;\nVariable: &amp;quot; ready for manager to use">vars2manager</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, vars, <span class="keyword">sizeof</span>(vars)) : <span class="stringliteral">&quot;&quot;</span>);
<a name="l04256"></a>04256       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(oldcontext, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(oldcontext));
<a name="l04257"></a>04257       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(oldexten, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(oldexten));
<a name="l04258"></a>04258    
<a name="l04259"></a>04259       <span class="keywordflow">if</span> ((queue_end_bridge = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*queue_end_bridge), NULL))) {
<a name="l04260"></a>04260          queue_end_bridge-&gt;<a class="code" href="structqueue__end__bridge.html#a6d8b242e106dd6592a625bdc396bbe55">q</a> = qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>;
<a name="l04261"></a>04261          queue_end_bridge-&gt;<a class="code" href="structqueue__end__bridge.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l04262"></a>04262          bridge_config.<a class="code" href="structast__bridge__config.html#a03acb9e092c45d88e1fb9e146e5e554e">end_bridge_callback</a> = <a class="code" href="app__queue_8c.html#acb5e3261ae018d7bbe4cbdcc9cace101">end_bridge_callback</a>;
<a name="l04263"></a>04263          bridge_config.<a class="code" href="structast__bridge__config.html#a30cb875f49910a9515ee92d8dfdf8b83">end_bridge_callback_data</a> = queue_end_bridge;
<a name="l04264"></a>04264          bridge_config.<a class="code" href="structast__bridge__config.html#acf41a4cfd7f144294e2d14ab8738704a">end_bridge_callback_data_fixup</a> = <a class="code" href="app__queue_8c.html#adc150dec1056eca590d0f1555ff5188b">end_bridge_callback_data_fixup</a>;
<a name="l04265"></a>04265          <span class="comment">/* Since queue_end_bridge can survive beyond the life of this call to Queue, we need</span>
<a name="l04266"></a>04266 <span class="comment">          * to make sure to increase the refcount of this queue so it cannot be freed until we</span>
<a name="l04267"></a>04267 <span class="comment">          * are done with it. We remove this reference in end_bridge_callback.</span>
<a name="l04268"></a>04268 <span class="comment">          */</span>
<a name="l04269"></a>04269          <a class="code" href="app__queue_8c.html#a975930eef9239c04b8bb2453bafe0798">queue_t_ref</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, <span class="stringliteral">&quot;For bridge_config reference&quot;</span>);
<a name="l04270"></a>04270       }
<a name="l04271"></a>04271 
<a name="l04272"></a>04272       time(&amp;callstart);
<a name="l04273"></a>04273       transfer_ds = <a class="code" href="app__queue_8c.html#aa429d08abcb33bf94372e629c7501986" title="create a datastore for storing relevant info to log attended transfers in the queue_log...">setup_transfer_datastore</a>(qe, member, callstart, callcompletedinsl);
<a name="l04274"></a>04274       bridge = <a class="code" href="features_8h.html#a3fe7c7e43b8f3140716d836816bf827f" title="Bridge a call, optionally allowing redirection.">ast_bridge_call</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>,peer, &amp;bridge_config);
<a name="l04275"></a>04275 
<a name="l04276"></a>04276       <span class="comment">/* If the queue member did an attended transfer, then the TRANSFER already was logged in the queue_log</span>
<a name="l04277"></a>04277 <span class="comment">       * when the masquerade occurred. These other &quot;ending&quot; queue_log messages are unnecessary</span>
<a name="l04278"></a>04278 <span class="comment">       */</span>
<a name="l04279"></a>04279       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l04280"></a>04280       <span class="keywordflow">if</span> (!<a class="code" href="app__queue_8c.html#a1309ff218d974fd7aa8701b062971e44" title="mechanism to tell if a queue caller was atxferred by a queue member.">attended_transfer_occurred</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)) {
<a name="l04281"></a>04281          <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *tds;
<a name="l04282"></a>04282 
<a name="l04283"></a>04283          <span class="comment">/* detect a blind transfer */</span>
<a name="l04284"></a>04284          <span class="keywordflow">if</span> (!(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> | peer-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a>) &amp;&amp; (strcasecmp(oldcontext, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>) || strcasecmp(oldexten, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>))) {
<a name="l04285"></a>04285             <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(queuename, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, <span class="stringliteral">&quot;TRANSFER&quot;</span>, <span class="stringliteral">&quot;%s|%s|%ld|%ld|%d&quot;</span>,
<a name="l04286"></a>04286                qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, (<span class="keywordtype">long</span>) (callstart - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>),
<a name="l04287"></a>04287                (<span class="keywordtype">long</span>) (time(NULL) - callstart), qe-&gt;<a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>);
<a name="l04288"></a>04288             <a class="code" href="app__queue_8c.html#ad7d17f55f6b97ebc0d32e202aacfa8b7" title="Send out AMI message with member call completion status information.">send_agent_complete</a>(qe, queuename, peer, member, callstart, vars, <span class="keyword">sizeof</span>(vars), <a class="code" href="chan__dahdi_8c.html#a3811374ead4311c8b04a85ae6dd7196b">TRANSFER</a>);
<a name="l04289"></a>04289          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)) {
<a name="l04290"></a>04290             <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(queuename, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, <span class="stringliteral">&quot;COMPLETECALLER&quot;</span>, <span class="stringliteral">&quot;%ld|%ld|%d&quot;</span>,
<a name="l04291"></a>04291                (<span class="keywordtype">long</span>) (callstart - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>), (<span class="keywordtype">long</span>) (time(NULL) - callstart), qe-&gt;<a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>);
<a name="l04292"></a>04292             <a class="code" href="app__queue_8c.html#ad7d17f55f6b97ebc0d32e202aacfa8b7" title="Send out AMI message with member call completion status information.">send_agent_complete</a>(qe, queuename, peer, member, callstart, vars, <span class="keyword">sizeof</span>(vars), <a class="code" href="app__queue_8c.html#af59feeff9c61049bf1d1a7839164564da705a981107e0ea89ff36ae0707a97889">CALLER</a>);
<a name="l04293"></a>04293          } <span class="keywordflow">else</span> {
<a name="l04294"></a>04294             <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(queuename, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid, member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, <span class="stringliteral">&quot;COMPLETEAGENT&quot;</span>, <span class="stringliteral">&quot;%ld|%ld|%d&quot;</span>,
<a name="l04295"></a>04295                (<span class="keywordtype">long</span>) (callstart - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>), (<span class="keywordtype">long</span>) (time(NULL) - callstart), qe-&gt;<a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>);
<a name="l04296"></a>04296             <a class="code" href="app__queue_8c.html#ad7d17f55f6b97ebc0d32e202aacfa8b7" title="Send out AMI message with member call completion status information.">send_agent_complete</a>(qe, queuename, peer, member, callstart, vars, <span class="keyword">sizeof</span>(vars), <a class="code" href="app__queue_8c.html#af59feeff9c61049bf1d1a7839164564da40e60d510aa885cf9334b0c0175cd2b2">AGENT</a>);
<a name="l04297"></a>04297          }
<a name="l04298"></a>04298          <span class="keywordflow">if</span> ((tds = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, &amp;queue_transfer_info, NULL))) {  
<a name="l04299"></a>04299             <a class="code" href="channel_8h.html#a1ff1c62b6d50823da93a920575c9c0c9" title="Remove a datastore from a channel.">ast_channel_datastore_remove</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, tds);
<a name="l04300"></a>04300          }
<a name="l04301"></a>04301          <a class="code" href="app__queue_8c.html#a62226f8ba56b53bd8b3f9ee8d8a4877d" title="update the queue status">update_queue</a>(qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, member, callcompletedinsl, (time(NULL) - callstart));
<a name="l04302"></a>04302       }
<a name="l04303"></a>04303 
<a name="l04304"></a>04304       <span class="keywordflow">if</span> (transfer_ds) {
<a name="l04305"></a>04305          <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(transfer_ds);
<a name="l04306"></a>04306       }
<a name="l04307"></a>04307       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l04308"></a>04308       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(peer);
<a name="l04309"></a>04309       res = bridge ? bridge : 1;
<a name="l04310"></a>04310       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(member, -1);
<a name="l04311"></a>04311    }
<a name="l04312"></a>04312 out:
<a name="l04313"></a>04313    <a class="code" href="app__queue_8c.html#a5c48dc0a23bd6fb868ee9b1508d47d4e" title="Hang up a list of outgoing calls.">hangupcalls</a>(outgoing, NULL, qe-&gt;<a class="code" href="structqueue__ent.html#a9edbd6d881ea6dd2b0b4d78c11723517">cancel_answered_elsewhere</a>);
<a name="l04314"></a>04314 
<a name="l04315"></a>04315    <span class="keywordflow">return</span> res;
<a name="l04316"></a>04316 }
<a name="l04317"></a>04317 
<a name="l04318"></a><a class="code" href="app__queue_8c.html#ae2c06dcaa81d44b2782bb33be68c4858">04318</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ae2c06dcaa81d44b2782bb33be68c4858">wait_a_bit</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe)
<a name="l04319"></a>04319 {
<a name="l04320"></a>04320    <span class="comment">/* Don&apos;t need to hold the lock while we setup the outgoing calls */</span>
<a name="l04321"></a>04321    <span class="keywordtype">int</span> retrywait = qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#addf2eb79daee1e400c823a699b0f856b">retry</a> * 1000;
<a name="l04322"></a>04322 
<a name="l04323"></a>04323    <span class="keywordtype">int</span> res = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, retrywait);
<a name="l04324"></a>04324    <span class="keywordflow">if</span> (res &gt; 0 &amp;&amp; !<a class="code" href="app__queue_8c.html#a4df5a56907979a04a511007899753456" title="Check for valid exit from queue via goto.">valid_exit</a>(qe, res))
<a name="l04325"></a>04325       res = 0;
<a name="l04326"></a>04326 
<a name="l04327"></a>04327    <span class="keywordflow">return</span> res;
<a name="l04328"></a>04328 }
<a name="l04329"></a>04329 
<a name="l04330"></a><a class="code" href="app__queue_8c.html#acf92d1c768150a8310825cb0af6fc29f">04330</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *<a class="code" href="app__queue_8c.html#acf92d1c768150a8310825cb0af6fc29f">interface_exists</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>)
<a name="l04331"></a>04331 {
<a name="l04332"></a>04332    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *mem;
<a name="l04333"></a>04333    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l04334"></a>04334 
<a name="l04335"></a>04335    <span class="keywordflow">if</span> (!q)
<a name="l04336"></a>04336       <span class="keywordflow">return</span> NULL;
<a name="l04337"></a>04337 
<a name="l04338"></a>04338    mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l04339"></a>04339    <span class="keywordflow">while</span> ((mem = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l04340"></a>04340       <span class="keywordflow">if</span> (!strcasecmp(interface, mem-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>)) {
<a name="l04341"></a>04341          <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l04342"></a>04342          <span class="keywordflow">return</span> mem;
<a name="l04343"></a>04343       }
<a name="l04344"></a>04344       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l04345"></a>04345    }
<a name="l04346"></a>04346    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l04347"></a>04347 
<a name="l04348"></a>04348    <span class="keywordflow">return</span> NULL;
<a name="l04349"></a>04349 }
<a name="l04350"></a>04350 
<a name="l04351"></a>04351 <span class="comment"></span>
<a name="l04352"></a>04352 <span class="comment">/*! \brief Dump all members in a specific queue to the database</span>
<a name="l04353"></a>04353 <span class="comment"> *</span>
<a name="l04354"></a>04354 <span class="comment"> * &lt;pm_family&gt;/&lt;queuename&gt; = &lt;interface&gt;;&lt;penalty&gt;;&lt;paused&gt;;&lt;state_interface&gt;[|...]</span>
<a name="l04355"></a>04355 <span class="comment"> */</span>
<a name="l04356"></a><a class="code" href="app__queue_8c.html#a2268442ff742f200d845e5223a722594">04356</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a2268442ff742f200d845e5223a722594" title="Dump all members in a specific queue to the database.">dump_queue_members</a>(<span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *pm_queue)
<a name="l04357"></a>04357 {
<a name="l04358"></a>04358    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *cur_member;
<a name="l04359"></a>04359    <span class="keywordtype">char</span> value[<a class="code" href="app__queue_8c.html#a84ed86bae7c71bb0b3a5d6db08b7aade">PM_MAX_LEN</a>];
<a name="l04360"></a>04360    <span class="keywordtype">int</span> value_len = 0;
<a name="l04361"></a>04361    <span class="keywordtype">int</span> res;
<a name="l04362"></a>04362    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l04363"></a>04363 
<a name="l04364"></a>04364    memset(value, 0, <span class="keyword">sizeof</span>(value));
<a name="l04365"></a>04365 
<a name="l04366"></a>04366    <span class="keywordflow">if</span> (!pm_queue)
<a name="l04367"></a>04367       <span class="keywordflow">return</span>;
<a name="l04368"></a>04368 
<a name="l04369"></a>04369    mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(pm_queue-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l04370"></a>04370    <span class="keywordflow">while</span> ((cur_member = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l04371"></a>04371       <span class="keywordflow">if</span> (!cur_member-&gt;<a class="code" href="structmember.html#a44690a0a629211d7620ce0d55c412e9d">dynamic</a>) {
<a name="l04372"></a>04372          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(cur_member, -1);
<a name="l04373"></a>04373          <span class="keywordflow">continue</span>;
<a name="l04374"></a>04374       }
<a name="l04375"></a>04375 
<a name="l04376"></a>04376       res = snprintf(value + value_len, <span class="keyword">sizeof</span>(value) - value_len, <span class="stringliteral">&quot;%s%s;%d;%d;%s;%s&quot;</span>,
<a name="l04377"></a>04377          value_len ? <span class="stringliteral">&quot;|&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, cur_member-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, cur_member-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>, cur_member-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a>, cur_member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, cur_member-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>);
<a name="l04378"></a>04378 
<a name="l04379"></a>04379       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(cur_member, -1);
<a name="l04380"></a>04380 
<a name="l04381"></a>04381       <span class="keywordflow">if</span> (res != strlen(value + value_len)) {
<a name="l04382"></a>04382          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not create persistent member string, out of space\n&quot;</span>);
<a name="l04383"></a>04383          <span class="keywordflow">break</span>;
<a name="l04384"></a>04384       }
<a name="l04385"></a>04385       value_len += res;
<a name="l04386"></a>04386    }
<a name="l04387"></a>04387    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l04388"></a>04388    
<a name="l04389"></a>04389    <span class="keywordflow">if</span> (value_len &amp;&amp; !cur_member) {
<a name="l04390"></a>04390       <span class="keywordflow">if</span> (<a class="code" href="astdb_8h.html#a0f14f6bff4f412c88b50aba34d3a5e35" title="Store value addressed by family/key.">ast_db_put</a>(pm_family, pm_queue-&gt;name, value))
<a name="l04391"></a>04391          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;failed to create persistent dynamic entry!\n&quot;</span>);
<a name="l04392"></a>04392    } <span class="keywordflow">else</span>
<a name="l04393"></a>04393       <span class="comment">/* Delete the entry if the queue is empty or there is an error */</span>
<a name="l04394"></a>04394       <a class="code" href="astdb_8h.html#a71e8d5ab1757b184683a99125d1c8160" title="Delete entry in astdb.">ast_db_del</a>(pm_family, pm_queue-&gt;name);
<a name="l04395"></a>04395 }
<a name="l04396"></a>04396 <span class="comment"></span>
<a name="l04397"></a>04397 <span class="comment">/*! \brief Remove member from queue </span>
<a name="l04398"></a>04398 <span class="comment"> * \retval RES_NOT_DYNAMIC when they aren&apos;t a RT member</span>
<a name="l04399"></a>04399 <span class="comment"> * \retval RES_NOSUCHQUEUE queue does not exist</span>
<a name="l04400"></a>04400 <span class="comment"> * \retval RES_OKAY removed member from queue</span>
<a name="l04401"></a>04401 <span class="comment"> * \retval RES_EXISTS queue exists but no members</span>
<a name="l04402"></a>04402 <span class="comment">*/</span>
<a name="l04403"></a><a class="code" href="app__queue_8c.html#a2d8545a6eecf92b885f8880aaaf662d2">04403</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a2d8545a6eecf92b885f8880aaaf662d2" title="Remove member from queue.">remove_from_queue</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *queuename, <span class="keyword">const</span> <span class="keywordtype">char</span> *interface)
<a name="l04404"></a>04404 {
<a name="l04405"></a>04405    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q, tmpq = {
<a name="l04406"></a>04406       .name = queuename,   
<a name="l04407"></a>04407    };
<a name="l04408"></a>04408    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *mem, tmpmem;
<a name="l04409"></a>04409    <span class="keywordtype">int</span> res = <a class="code" href="app__queue_8c.html#a88215ab017dd4ed8343d17918eacee81">RES_NOSUCHQUEUE</a>;
<a name="l04410"></a>04410 
<a name="l04411"></a>04411    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmpmem.<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, interface, <span class="keyword">sizeof</span>(tmpmem.<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>));
<a name="l04412"></a>04412    <span class="keywordflow">if</span> ((q = <a class="code" href="astobj2_8h.html#a804bb959fec31c062b3848316b8e80b1">ao2_t_find</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, &amp;tmpq, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>, <span class="stringliteral">&quot;Temporary reference for interface removal&quot;</span>))) {
<a name="l04413"></a>04413       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l04414"></a>04414       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l04415"></a>04415       <span class="keywordflow">if</span> ((mem = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, &amp;tmpmem, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>))) {
<a name="l04416"></a>04416          <span class="comment">/* XXX future changes should beware of this assumption!! */</span>
<a name="l04417"></a>04417          <span class="keywordflow">if</span> (!mem-&gt;<a class="code" href="structmember.html#a44690a0a629211d7620ce0d55c412e9d">dynamic</a>) {
<a name="l04418"></a>04418             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l04419"></a>04419             <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l04420"></a>04420             <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Interface wasn&apos;t dynamic, expiring temporary reference&quot;</span>);
<a name="l04421"></a>04421             <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l04422"></a>04422             <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#a447a632daaf1a56114da95816c12b8a5">RES_NOT_DYNAMIC</a>;
<a name="l04423"></a>04423          }
<a name="l04424"></a>04424          q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>--;
<a name="l04425"></a>04425          <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;QueueMemberRemoved&quot;</span>,
<a name="l04426"></a>04426             <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l04427"></a>04427             <span class="stringliteral">&quot;Location: %s\r\n&quot;</span>
<a name="l04428"></a>04428             <span class="stringliteral">&quot;MemberName: %s\r\n&quot;</span>,
<a name="l04429"></a>04429             q-&gt;name, mem-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, mem-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>);
<a name="l04430"></a>04430          <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, mem);
<a name="l04431"></a>04431          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l04432"></a>04432 
<a name="l04433"></a>04433          <span class="keywordflow">if</span> (queue_persistent_members)
<a name="l04434"></a>04434             <a class="code" href="app__queue_8c.html#a2268442ff742f200d845e5223a722594" title="Dump all members in a specific queue to the database.">dump_queue_members</a>(q);
<a name="l04435"></a>04435          
<a name="l04436"></a>04436          res = <a class="code" href="app__queue_8c.html#aaa42581c853cb64af155ddd19937d80e">RES_OKAY</a>;
<a name="l04437"></a>04437       } <span class="keywordflow">else</span> {
<a name="l04438"></a>04438          res = <a class="code" href="app__queue_8c.html#ae72ca8d43e1d9acf1dbfcbc18c98a3ae">RES_EXISTS</a>;
<a name="l04439"></a>04439       }
<a name="l04440"></a>04440       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l04441"></a>04441       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l04442"></a>04442       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Expiring temporary reference&quot;</span>);
<a name="l04443"></a>04443    }
<a name="l04444"></a>04444 
<a name="l04445"></a>04445    <span class="keywordflow">return</span> res;
<a name="l04446"></a>04446 }
<a name="l04447"></a>04447 <span class="comment"></span>
<a name="l04448"></a>04448 <span class="comment">/*! \brief Add member to queue </span>
<a name="l04449"></a>04449 <span class="comment"> * \retval RES_NOT_DYNAMIC when they aren&apos;t a RT member</span>
<a name="l04450"></a>04450 <span class="comment"> * \retval RES_NOSUCHQUEUE queue does not exist</span>
<a name="l04451"></a>04451 <span class="comment"> * \retval RES_OKAY added member from queue</span>
<a name="l04452"></a>04452 <span class="comment"> * \retval RES_EXISTS queue exists but no members</span>
<a name="l04453"></a>04453 <span class="comment"> * \retval RES_OUT_OF_MEMORY queue exists but not enough memory to create member</span>
<a name="l04454"></a>04454 <span class="comment">*/</span>
<a name="l04455"></a><a class="code" href="app__queue_8c.html#abe87549704e5140ad7f8798fa60b8642">04455</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#abe87549704e5140ad7f8798fa60b8642" title="Add member to queue.">add_to_queue</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *queuename, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, <span class="keywordtype">int</span> <a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>, <span class="keywordtype">int</span> <a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a>, <span class="keywordtype">int</span> dump, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>)
<a name="l04456"></a>04456 {
<a name="l04457"></a>04457    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l04458"></a>04458    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *new_member, *old_member;
<a name="l04459"></a>04459    <span class="keywordtype">int</span> res = <a class="code" href="app__queue_8c.html#a88215ab017dd4ed8343d17918eacee81">RES_NOSUCHQUEUE</a>;
<a name="l04460"></a>04460 <span class="comment"></span>
<a name="l04461"></a>04461 <span class="comment">   /*! \note Ensure the appropriate realtime queue is loaded.  Note that this</span>
<a name="l04462"></a>04462 <span class="comment">    * short-circuits if the queue is already in memory. */</span>
<a name="l04463"></a>04463    <span class="keywordflow">if</span> (!(q = <a class="code" href="app__queue_8c.html#a9944f03f3b77344b38927628150d3ab7">load_realtime_queue</a>(queuename)))
<a name="l04464"></a>04464       <span class="keywordflow">return</span> res;
<a name="l04465"></a>04465 
<a name="l04466"></a>04466    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l04467"></a>04467 
<a name="l04468"></a>04468    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l04469"></a>04469    <span class="keywordflow">if</span> ((old_member = <a class="code" href="app__queue_8c.html#acf92d1c768150a8310825cb0af6fc29f">interface_exists</a>(q, interface)) == NULL) {
<a name="l04470"></a>04470       <span class="keywordflow">if</span> ((new_member = <a class="code" href="app__queue_8c.html#a8cfa1185143485f4531932cf8970555e" title="allocate space for new queue member and set fields based on parameters passed">create_queue_member</a>(interface, membername, penalty, paused, state_interface))) {
<a name="l04471"></a>04471          new_member-&gt;<a class="code" href="structmember.html#a44690a0a629211d7620ce0d55c412e9d">dynamic</a> = 1;
<a name="l04472"></a>04472          <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, new_member);
<a name="l04473"></a>04473          q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>++;
<a name="l04474"></a>04474          <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;QueueMemberAdded&quot;</span>,
<a name="l04475"></a>04475             <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l04476"></a>04476             <span class="stringliteral">&quot;Location: %s\r\n&quot;</span>
<a name="l04477"></a>04477             <span class="stringliteral">&quot;MemberName: %s\r\n&quot;</span>
<a name="l04478"></a>04478             <span class="stringliteral">&quot;Membership: %s\r\n&quot;</span>
<a name="l04479"></a>04479             <span class="stringliteral">&quot;Penalty: %d\r\n&quot;</span>
<a name="l04480"></a>04480             <span class="stringliteral">&quot;CallsTaken: %d\r\n&quot;</span>
<a name="l04481"></a>04481             <span class="stringliteral">&quot;LastCall: %d\r\n&quot;</span>
<a name="l04482"></a>04482             <span class="stringliteral">&quot;Status: %d\r\n&quot;</span>
<a name="l04483"></a>04483             <span class="stringliteral">&quot;Paused: %d\r\n&quot;</span>,
<a name="l04484"></a>04484             q-&gt;name, new_member-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, new_member-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>,
<a name="l04485"></a>04485             <span class="stringliteral">&quot;dynamic&quot;</span>,
<a name="l04486"></a>04486             new_member-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>, new_member-&gt;<a class="code" href="structmember.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a>, (<span class="keywordtype">int</span>) new_member-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>,
<a name="l04487"></a>04487             new_member-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a>, new_member-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a>);
<a name="l04488"></a>04488          
<a name="l04489"></a>04489          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(new_member, -1);
<a name="l04490"></a>04490          new_member = NULL;
<a name="l04491"></a>04491 
<a name="l04492"></a>04492          <span class="keywordflow">if</span> (dump)
<a name="l04493"></a>04493             <a class="code" href="app__queue_8c.html#a2268442ff742f200d845e5223a722594" title="Dump all members in a specific queue to the database.">dump_queue_members</a>(q);
<a name="l04494"></a>04494          
<a name="l04495"></a>04495          res = <a class="code" href="app__queue_8c.html#aaa42581c853cb64af155ddd19937d80e">RES_OKAY</a>;
<a name="l04496"></a>04496       } <span class="keywordflow">else</span> {
<a name="l04497"></a>04497          res = <a class="code" href="app__queue_8c.html#a662a43c452569dfc9f20d49a73498c64">RES_OUTOFMEMORY</a>;
<a name="l04498"></a>04498       }
<a name="l04499"></a>04499    } <span class="keywordflow">else</span> {
<a name="l04500"></a>04500       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(old_member, -1);
<a name="l04501"></a>04501       res = <a class="code" href="app__queue_8c.html#ae72ca8d43e1d9acf1dbfcbc18c98a3ae">RES_EXISTS</a>;
<a name="l04502"></a>04502    }
<a name="l04503"></a>04503    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l04504"></a>04504    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l04505"></a>04505 
<a name="l04506"></a>04506    <span class="keywordflow">return</span> res;
<a name="l04507"></a>04507 }
<a name="l04508"></a>04508 
<a name="l04509"></a><a class="code" href="app__queue_8c.html#a5d60239f838c9f941528fb426bcd2290">04509</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a5d60239f838c9f941528fb426bcd2290">set_member_paused</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *queuename, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *reason, <span class="keywordtype">int</span> <a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a>)
<a name="l04510"></a>04510 {
<a name="l04511"></a>04511    <span class="keywordtype">int</span> found = 0;
<a name="l04512"></a>04512    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l04513"></a>04513    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *mem;
<a name="l04514"></a>04514    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> queue_iter;
<a name="l04515"></a>04515    <span class="keywordtype">int</span> failed;
<a name="l04516"></a>04516 
<a name="l04517"></a>04517    <span class="comment">/* Special event for when all queues are paused - individual events still generated */</span>
<a name="l04518"></a>04518    <span class="comment">/* XXX In all other cases, we use the membername, but since this affects all queues, we cannot */</span>
<a name="l04519"></a>04519    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename))
<a name="l04520"></a>04520       <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(<span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;NONE&quot;</span>, interface, (paused ? <span class="stringliteral">&quot;PAUSEALL&quot;</span> : <span class="stringliteral">&quot;UNPAUSEALL&quot;</span>), <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l04521"></a>04521 
<a name="l04522"></a>04522    queue_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, 0);
<a name="l04523"></a>04523    <span class="keywordflow">while</span> ((q = <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;queue_iter, <span class="stringliteral">&quot;Iterate over queues&quot;</span>))) {
<a name="l04524"></a>04524       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l04525"></a>04525       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename) || !strcasecmp(q-&gt;name, queuename)) {
<a name="l04526"></a>04526          <span class="keywordflow">if</span> ((mem = <a class="code" href="app__queue_8c.html#acf92d1c768150a8310825cb0af6fc29f">interface_exists</a>(q, interface))) {
<a name="l04527"></a>04527             <span class="keywordflow">if</span> (mem-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a> == paused) {
<a name="l04528"></a>04528                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%spausing already-%spaused queue member %s:%s\n&quot;</span>, (paused ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;un&quot;</span>), (paused ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;un&quot;</span>), q-&gt;name, interface);
<a name="l04529"></a>04529             }
<a name="l04530"></a>04530 
<a name="l04531"></a>04531             failed = 0;
<a name="l04532"></a>04532             <span class="keywordflow">if</span> (mem-&gt;<a class="code" href="structmember.html#aac1ae37fa4007496a50df75cf1f698c1">realtime</a>) {
<a name="l04533"></a>04533                failed = <a class="code" href="app__queue_8c.html#abc63b07b1a30653be5a5f722ce7ee39c">update_realtime_member_field</a>(mem, q-&gt;name, <span class="stringliteral">&quot;paused&quot;</span>, paused ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;0&quot;</span>);
<a name="l04534"></a>04534             }
<a name="l04535"></a>04535          
<a name="l04536"></a>04536             <span class="keywordflow">if</span> (failed) {
<a name="l04537"></a>04537                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed %spausing realtime queue member %s:%s\n&quot;</span>, (paused ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;un&quot;</span>), q-&gt;name, interface);
<a name="l04538"></a>04538                <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l04539"></a>04539                <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l04540"></a>04540                <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l04541"></a>04541                <span class="keywordflow">continue</span>;
<a name="l04542"></a>04542             }  
<a name="l04543"></a>04543             found++;
<a name="l04544"></a>04544             mem-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a> = paused;
<a name="l04545"></a>04545 
<a name="l04546"></a>04546             <span class="keywordflow">if</span> (queue_persistent_members)
<a name="l04547"></a>04547                <a class="code" href="app__queue_8c.html#a2268442ff742f200d845e5223a722594" title="Dump all members in a specific queue to the database.">dump_queue_members</a>(q);
<a name="l04548"></a>04548 
<a name="l04549"></a>04549             <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(q-&gt;name, <span class="stringliteral">&quot;NONE&quot;</span>, mem-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, (paused ? <span class="stringliteral">&quot;PAUSE&quot;</span> : <span class="stringliteral">&quot;UNPAUSE&quot;</span>), <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(reason, <span class="stringliteral">&quot;&quot;</span>));
<a name="l04550"></a>04550             
<a name="l04551"></a>04551             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(reason)) {
<a name="l04552"></a>04552                <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;QueueMemberPaused&quot;</span>,
<a name="l04553"></a>04553                   <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l04554"></a>04554                   <span class="stringliteral">&quot;Location: %s\r\n&quot;</span>
<a name="l04555"></a>04555                   <span class="stringliteral">&quot;MemberName: %s\r\n&quot;</span>
<a name="l04556"></a>04556                   <span class="stringliteral">&quot;Paused: %d\r\n&quot;</span>
<a name="l04557"></a>04557                   <span class="stringliteral">&quot;Reason: %s\r\n&quot;</span>,
<a name="l04558"></a>04558                      q-&gt;name, mem-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, mem-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, paused, reason);
<a name="l04559"></a>04559             } <span class="keywordflow">else</span> {
<a name="l04560"></a>04560                <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;QueueMemberPaused&quot;</span>,
<a name="l04561"></a>04561                   <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l04562"></a>04562                   <span class="stringliteral">&quot;Location: %s\r\n&quot;</span>
<a name="l04563"></a>04563                   <span class="stringliteral">&quot;MemberName: %s\r\n&quot;</span>
<a name="l04564"></a>04564                   <span class="stringliteral">&quot;Paused: %d\r\n&quot;</span>,
<a name="l04565"></a>04565                      q-&gt;name, mem-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, mem-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, paused);
<a name="l04566"></a>04566             }
<a name="l04567"></a>04567             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l04568"></a>04568          }
<a name="l04569"></a>04569       }
<a name="l04570"></a>04570       
<a name="l04571"></a>04571       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename) &amp;&amp; !strcasecmp(queuename, q-&gt;name)) {
<a name="l04572"></a>04572          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l04573"></a>04573          <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l04574"></a>04574          <span class="keywordflow">break</span>;
<a name="l04575"></a>04575       }
<a name="l04576"></a>04576       
<a name="l04577"></a>04577       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l04578"></a>04578       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l04579"></a>04579    }
<a name="l04580"></a>04580    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;queue_iter);
<a name="l04581"></a>04581 
<a name="l04582"></a>04582    <span class="keywordflow">return</span> found ? <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l04583"></a>04583 }
<a name="l04584"></a>04584 
<a name="l04585"></a>04585 <span class="comment">/* \brief Sets members penalty, if queuename=NULL we set member penalty in all the queues. */</span>
<a name="l04586"></a><a class="code" href="app__queue_8c.html#a214853f4f35145fe0c543edae51469b0">04586</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a214853f4f35145fe0c543edae51469b0">set_member_penalty</a>(<span class="keywordtype">char</span> *queuename, <span class="keywordtype">char</span> *interface, <span class="keywordtype">int</span> penalty)
<a name="l04587"></a>04587 {
<a name="l04588"></a>04588    <span class="keywordtype">int</span> foundinterface = 0, foundqueue = 0;
<a name="l04589"></a>04589    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l04590"></a>04590    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *mem;
<a name="l04591"></a>04591    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> queue_iter;
<a name="l04592"></a>04592 
<a name="l04593"></a>04593    <span class="keywordflow">if</span> (penalty &lt; 0) {
<a name="l04594"></a>04594       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid penalty (%d)\n&quot;</span>, penalty);
<a name="l04595"></a>04595       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l04596"></a>04596    }
<a name="l04597"></a>04597 
<a name="l04598"></a>04598    queue_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, 0);
<a name="l04599"></a>04599    <span class="keywordflow">while</span> ((q = <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;queue_iter, <span class="stringliteral">&quot;Iterate through queues&quot;</span>))) {
<a name="l04600"></a>04600       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l04601"></a>04601       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename) || !strcasecmp(q-&gt;name, queuename)) {
<a name="l04602"></a>04602          foundqueue++;
<a name="l04603"></a>04603          <span class="keywordflow">if</span> ((mem = <a class="code" href="app__queue_8c.html#acf92d1c768150a8310825cb0af6fc29f">interface_exists</a>(q, interface))) {
<a name="l04604"></a>04604             foundinterface++;
<a name="l04605"></a>04605             mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> = penalty;
<a name="l04606"></a>04606             
<a name="l04607"></a>04607             <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(q-&gt;name, <span class="stringliteral">&quot;NONE&quot;</span>, interface, <span class="stringliteral">&quot;PENALTY&quot;</span>, <span class="stringliteral">&quot;%d&quot;</span>, penalty);
<a name="l04608"></a>04608             <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;QueueMemberPenalty&quot;</span>,
<a name="l04609"></a>04609                <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l04610"></a>04610                <span class="stringliteral">&quot;Location: %s\r\n&quot;</span>
<a name="l04611"></a>04611                <span class="stringliteral">&quot;Penalty: %d\r\n&quot;</span>,
<a name="l04612"></a>04612                q-&gt;name, mem-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, penalty);
<a name="l04613"></a>04613             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l04614"></a>04614          }
<a name="l04615"></a>04615       }
<a name="l04616"></a>04616       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l04617"></a>04617       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l04618"></a>04618    }
<a name="l04619"></a>04619    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;queue_iter);
<a name="l04620"></a>04620 
<a name="l04621"></a>04621    <span class="keywordflow">if</span> (foundinterface) {
<a name="l04622"></a>04622       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l04623"></a>04623    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!foundqueue) {
<a name="l04624"></a>04624       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid queuename\n&quot;</span>); 
<a name="l04625"></a>04625    } <span class="keywordflow">else</span> {
<a name="l04626"></a>04626       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid interface\n&quot;</span>);
<a name="l04627"></a>04627    }  
<a name="l04628"></a>04628 
<a name="l04629"></a>04629    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l04630"></a>04630 }
<a name="l04631"></a>04631 
<a name="l04632"></a>04632 <span class="comment">/* \brief Gets members penalty. </span>
<a name="l04633"></a>04633 <span class="comment"> * \return Return the members penalty or RESULT_FAILURE on error. </span>
<a name="l04634"></a>04634 <span class="comment">*/</span>
<a name="l04635"></a><a class="code" href="app__queue_8c.html#a6fdd4581a4a8945d35a54bb170b21ac6">04635</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a6fdd4581a4a8945d35a54bb170b21ac6">get_member_penalty</a>(<span class="keywordtype">char</span> *queuename, <span class="keywordtype">char</span> *interface)
<a name="l04636"></a>04636 {
<a name="l04637"></a>04637    <span class="keywordtype">int</span> foundqueue = 0, penalty;
<a name="l04638"></a>04638    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q, tmpq = {
<a name="l04639"></a>04639       .name = queuename,   
<a name="l04640"></a>04640    };
<a name="l04641"></a>04641    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *mem;
<a name="l04642"></a>04642    
<a name="l04643"></a>04643    <span class="keywordflow">if</span> ((q = <a class="code" href="astobj2_8h.html#a804bb959fec31c062b3848316b8e80b1">ao2_t_find</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, &amp;tmpq, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>, <span class="stringliteral">&quot;Search for queue&quot;</span>))) {
<a name="l04644"></a>04644       foundqueue = 1;
<a name="l04645"></a>04645       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l04646"></a>04646       <span class="keywordflow">if</span> ((mem = <a class="code" href="app__queue_8c.html#acf92d1c768150a8310825cb0af6fc29f">interface_exists</a>(q, interface))) {
<a name="l04647"></a>04647          <a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> = mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>;
<a name="l04648"></a>04648          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l04649"></a>04649          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l04650"></a>04650          <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Search complete&quot;</span>);
<a name="l04651"></a>04651          <span class="keywordflow">return</span> <a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>;
<a name="l04652"></a>04652       }
<a name="l04653"></a>04653       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l04654"></a>04654       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Search complete&quot;</span>);
<a name="l04655"></a>04655    }
<a name="l04656"></a>04656 
<a name="l04657"></a>04657    <span class="comment">/* some useful debuging */</span>
<a name="l04658"></a>04658    <span class="keywordflow">if</span> (foundqueue) 
<a name="l04659"></a>04659       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid queuename\n&quot;</span>);
<a name="l04660"></a>04660    <span class="keywordflow">else</span> 
<a name="l04661"></a>04661       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid interface\n&quot;</span>);
<a name="l04662"></a>04662 
<a name="l04663"></a>04663    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l04664"></a>04664 }
<a name="l04665"></a>04665 <span class="comment"></span>
<a name="l04666"></a>04666 <span class="comment">/*! \brief Reload dynamic queue members persisted into the astdb */</span>
<a name="l04667"></a><a class="code" href="app__queue_8c.html#a4a18e85dad5b206bccd39112cf9d0002">04667</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a4a18e85dad5b206bccd39112cf9d0002" title="Reload dynamic queue members persisted into the astdb.">reload_queue_members</a>(<span class="keywordtype">void</span>)
<a name="l04668"></a>04668 {
<a name="l04669"></a>04669    <span class="keywordtype">char</span> *cur_ptr;
<a name="l04670"></a>04670    <span class="keyword">const</span> <span class="keywordtype">char</span> *queue_name;
<a name="l04671"></a>04671    <span class="keywordtype">char</span> *<a class="code" href="structmember.html">member</a>;
<a name="l04672"></a>04672    <span class="keywordtype">char</span> *<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>;
<a name="l04673"></a>04673    <span class="keywordtype">char</span> *<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a> = NULL;
<a name="l04674"></a>04674    <span class="keywordtype">char</span> *<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>;
<a name="l04675"></a>04675    <span class="keywordtype">char</span> *penalty_tok;
<a name="l04676"></a>04676    <span class="keywordtype">int</span> <a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a> = 0;
<a name="l04677"></a>04677    <span class="keywordtype">char</span> *paused_tok;
<a name="l04678"></a>04678    <span class="keywordtype">int</span> <a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a> = 0;
<a name="l04679"></a>04679    <span class="keyword">struct </span><a class="code" href="structast__db__entry.html">ast_db_entry</a> *db_tree;
<a name="l04680"></a>04680    <span class="keyword">struct </span><a class="code" href="structast__db__entry.html">ast_db_entry</a> *entry;
<a name="l04681"></a>04681    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *cur_queue;
<a name="l04682"></a>04682    <span class="keywordtype">char</span> queue_data[<a class="code" href="app__queue_8c.html#a84ed86bae7c71bb0b3a5d6db08b7aade">PM_MAX_LEN</a>];
<a name="l04683"></a>04683 
<a name="l04684"></a>04684    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l04685"></a>04685 
<a name="l04686"></a>04686    <span class="comment">/* Each key in &apos;pm_family&apos; is the name of a queue */</span>
<a name="l04687"></a>04687    db_tree = <a class="code" href="astdb_8h.html#afeb9839f89da4fc24838de74739d181e" title="Get a whole family.">ast_db_gettree</a>(pm_family, NULL);
<a name="l04688"></a>04688    <span class="keywordflow">for</span> (entry = db_tree; entry; entry = entry-&gt;<a class="code" href="structast__db__entry.html#a3fee4a0a4bff112e0262fb8d49f41b5e">next</a>) {
<a name="l04689"></a>04689 
<a name="l04690"></a>04690       queue_name = entry-&gt;<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a> + strlen(pm_family) + 2;
<a name="l04691"></a>04691 
<a name="l04692"></a>04692       {
<a name="l04693"></a>04693          <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> tmpq = {
<a name="l04694"></a>04694             .name = queue_name,
<a name="l04695"></a>04695          };
<a name="l04696"></a>04696          cur_queue = <a class="code" href="astobj2_8h.html#a804bb959fec31c062b3848316b8e80b1">ao2_t_find</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, &amp;tmpq, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>, <span class="stringliteral">&quot;Reload queue members&quot;</span>);
<a name="l04697"></a>04697       }  
<a name="l04698"></a>04698 
<a name="l04699"></a>04699       <span class="keywordflow">if</span> (!cur_queue)
<a name="l04700"></a>04700          cur_queue = <a class="code" href="app__queue_8c.html#a9944f03f3b77344b38927628150d3ab7">load_realtime_queue</a>(queue_name);
<a name="l04701"></a>04701 
<a name="l04702"></a>04702       <span class="keywordflow">if</span> (!cur_queue) {
<a name="l04703"></a>04703          <span class="comment">/* If the queue no longer exists, remove it from the</span>
<a name="l04704"></a>04704 <span class="comment">          * database */</span>
<a name="l04705"></a>04705          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error loading persistent queue: &apos;%s&apos;: it does not exist\n&quot;</span>, queue_name);
<a name="l04706"></a>04706          <a class="code" href="astdb_8h.html#a71e8d5ab1757b184683a99125d1c8160" title="Delete entry in astdb.">ast_db_del</a>(pm_family, queue_name);
<a name="l04707"></a>04707          <span class="keywordflow">continue</span>;
<a name="l04708"></a>04708       } 
<a name="l04709"></a>04709 
<a name="l04710"></a>04710       <span class="keywordflow">if</span> (<a class="code" href="astdb_8h.html#a48033762bf6ab77f15dd72277a1fe7fa" title="Get key value specified by family/key.">ast_db_get</a>(pm_family, queue_name, queue_data, <a class="code" href="app__queue_8c.html#a84ed86bae7c71bb0b3a5d6db08b7aade">PM_MAX_LEN</a>)) {
<a name="l04711"></a>04711          <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(cur_queue, <span class="stringliteral">&quot;Expire reload reference&quot;</span>);
<a name="l04712"></a>04712          <span class="keywordflow">continue</span>;
<a name="l04713"></a>04713       }
<a name="l04714"></a>04714 
<a name="l04715"></a>04715       cur_ptr = queue_data;
<a name="l04716"></a>04716       <span class="keywordflow">while</span> ((member = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;cur_ptr, <span class="stringliteral">&quot;,|&quot;</span>))) {
<a name="l04717"></a>04717          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(member))
<a name="l04718"></a>04718             <span class="keywordflow">continue</span>;
<a name="l04719"></a>04719 
<a name="l04720"></a>04720          interface = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;member, <span class="stringliteral">&quot;;&quot;</span>);
<a name="l04721"></a>04721          penalty_tok = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;member, <span class="stringliteral">&quot;;&quot;</span>);
<a name="l04722"></a>04722          paused_tok = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;member, <span class="stringliteral">&quot;;&quot;</span>);
<a name="l04723"></a>04723          membername = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;member, <span class="stringliteral">&quot;;&quot;</span>);
<a name="l04724"></a>04724          state_interface = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;member, <span class="stringliteral">&quot;;&quot;</span>);
<a name="l04725"></a>04725 
<a name="l04726"></a>04726          <span class="keywordflow">if</span> (!penalty_tok) {
<a name="l04727"></a>04727             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error parsing persistent member string for &apos;%s&apos; (penalty)\n&quot;</span>, queue_name);
<a name="l04728"></a>04728             <span class="keywordflow">break</span>;
<a name="l04729"></a>04729          }
<a name="l04730"></a>04730          penalty = strtol(penalty_tok, NULL, 10);
<a name="l04731"></a>04731          <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == <a class="code" href="utils_8c.html#aa1591a4f3a86360108de5b9ba34980ca">ERANGE</a>) {
<a name="l04732"></a>04732             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error converting penalty: %s: Out of range.\n&quot;</span>, penalty_tok);
<a name="l04733"></a>04733             <span class="keywordflow">break</span>;
<a name="l04734"></a>04734          }
<a name="l04735"></a>04735          
<a name="l04736"></a>04736          <span class="keywordflow">if</span> (!paused_tok) {
<a name="l04737"></a>04737             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error parsing persistent member string for &apos;%s&apos; (paused)\n&quot;</span>, queue_name);
<a name="l04738"></a>04738             <span class="keywordflow">break</span>;
<a name="l04739"></a>04739          }
<a name="l04740"></a>04740          paused = strtol(paused_tok, NULL, 10);
<a name="l04741"></a>04741          <span class="keywordflow">if</span> ((<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == <a class="code" href="utils_8c.html#aa1591a4f3a86360108de5b9ba34980ca">ERANGE</a>) || paused &lt; 0 || paused &gt; 1) {
<a name="l04742"></a>04742             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error converting paused: %s: Expected 0 or 1.\n&quot;</span>, paused_tok);
<a name="l04743"></a>04743             <span class="keywordflow">break</span>;
<a name="l04744"></a>04744          }
<a name="l04745"></a>04745 
<a name="l04746"></a>04746          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Reload Members: Queue: %s  Member: %s  Name: %s  Penalty: %d  Paused: %d\n&quot;</span>, queue_name, interface, membername, penalty, paused);
<a name="l04747"></a>04747          
<a name="l04748"></a>04748          <span class="keywordflow">if</span> (<a class="code" href="app__queue_8c.html#abe87549704e5140ad7f8798fa60b8642" title="Add member to queue.">add_to_queue</a>(queue_name, interface, membername, penalty, paused, 0, state_interface) == <a class="code" href="app__queue_8c.html#a662a43c452569dfc9f20d49a73498c64">RES_OUTOFMEMORY</a>) {
<a name="l04749"></a>04749             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of Memory when reloading persistent queue member\n&quot;</span>);
<a name="l04750"></a>04750             <span class="keywordflow">break</span>;
<a name="l04751"></a>04751          }
<a name="l04752"></a>04752       }
<a name="l04753"></a>04753       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(cur_queue, <span class="stringliteral">&quot;Expire reload reference&quot;</span>);
<a name="l04754"></a>04754    }
<a name="l04755"></a>04755 
<a name="l04756"></a>04756    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l04757"></a>04757    <span class="keywordflow">if</span> (db_tree) {
<a name="l04758"></a>04758       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Queue members successfully reloaded from database.\n&quot;</span>);
<a name="l04759"></a>04759       <a class="code" href="astdb_8h.html#af9ab454a70a91551b2bf6c55199fc514" title="Free in-memory data.">ast_db_freetree</a>(db_tree);
<a name="l04760"></a>04760    }
<a name="l04761"></a>04761 }
<a name="l04762"></a>04762 <span class="comment"></span>
<a name="l04763"></a>04763 <span class="comment">/*! \brief PauseQueueMember application */</span>
<a name="l04764"></a><a class="code" href="app__queue_8c.html#a243fe57cf3a80bfb2d69d1ef7fdfc45f">04764</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a243fe57cf3a80bfb2d69d1ef7fdfc45f" title="PauseQueueMember application.">pqm_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l04765"></a>04765 {
<a name="l04766"></a>04766    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l04767"></a>04767    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l04768"></a>04768       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(queuename);
<a name="l04769"></a>04769       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(interface);
<a name="l04770"></a>04770       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l04771"></a>04771       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(reason);
<a name="l04772"></a>04772    );
<a name="l04773"></a>04773 
<a name="l04774"></a>04774    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l04775"></a>04775       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;PauseQueueMember requires an argument ([queuename],interface[,options][,reason])\n&quot;</span>);
<a name="l04776"></a>04776       <span class="keywordflow">return</span> -1;
<a name="l04777"></a>04777    }
<a name="l04778"></a>04778 
<a name="l04779"></a>04779    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l04780"></a>04780 
<a name="l04781"></a>04781    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l04782"></a>04782 
<a name="l04783"></a>04783    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.interface)) {
<a name="l04784"></a>04784       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Missing interface argument to PauseQueueMember ([queuename],interface[,options[,reason]])\n&quot;</span>);
<a name="l04785"></a>04785       <span class="keywordflow">return</span> -1;
<a name="l04786"></a>04786    }
<a name="l04787"></a>04787 
<a name="l04788"></a>04788    <span class="keywordflow">if</span> (<a class="code" href="app__queue_8c.html#a5d60239f838c9f941528fb426bcd2290">set_member_paused</a>(args.queuename, args.interface, args.reason, 1)) {
<a name="l04789"></a>04789       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Attempt to pause interface %s, not found\n&quot;</span>, args.interface);
<a name="l04790"></a>04790       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;PQMSTATUS&quot;</span>, <span class="stringliteral">&quot;NOTFOUND&quot;</span>);
<a name="l04791"></a>04791       <span class="keywordflow">return</span> 0;
<a name="l04792"></a>04792    }
<a name="l04793"></a>04793 
<a name="l04794"></a>04794    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;PQMSTATUS&quot;</span>, <span class="stringliteral">&quot;PAUSED&quot;</span>);
<a name="l04795"></a>04795 
<a name="l04796"></a>04796    <span class="keywordflow">return</span> 0;
<a name="l04797"></a>04797 }
<a name="l04798"></a>04798 <span class="comment"></span>
<a name="l04799"></a>04799 <span class="comment">/*! \brief UnPauseQueueMember application */</span>
<a name="l04800"></a><a class="code" href="app__queue_8c.html#a54a8fd8bb1ccb4f91240e07b4ec6980c">04800</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a54a8fd8bb1ccb4f91240e07b4ec6980c" title="UnPauseQueueMember application.">upqm_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l04801"></a>04801 {
<a name="l04802"></a>04802    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l04803"></a>04803    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l04804"></a>04804       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(queuename);
<a name="l04805"></a>04805       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(interface);
<a name="l04806"></a>04806       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l04807"></a>04807       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(reason);
<a name="l04808"></a>04808    );
<a name="l04809"></a>04809 
<a name="l04810"></a>04810    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l04811"></a>04811       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;UnpauseQueueMember requires an argument ([queuename],interface[,options[,reason]])\n&quot;</span>);
<a name="l04812"></a>04812       <span class="keywordflow">return</span> -1;
<a name="l04813"></a>04813    }
<a name="l04814"></a>04814 
<a name="l04815"></a>04815    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l04816"></a>04816 
<a name="l04817"></a>04817    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l04818"></a>04818 
<a name="l04819"></a>04819    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.interface)) {
<a name="l04820"></a>04820       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Missing interface argument to PauseQueueMember ([queuename],interface[,options[,reason]])\n&quot;</span>);
<a name="l04821"></a>04821       <span class="keywordflow">return</span> -1;
<a name="l04822"></a>04822    }
<a name="l04823"></a>04823 
<a name="l04824"></a>04824    <span class="keywordflow">if</span> (<a class="code" href="app__queue_8c.html#a5d60239f838c9f941528fb426bcd2290">set_member_paused</a>(args.queuename, args.interface, args.reason, 0)) {
<a name="l04825"></a>04825       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Attempt to unpause interface %s, not found\n&quot;</span>, args.interface);
<a name="l04826"></a>04826       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;UPQMSTATUS&quot;</span>, <span class="stringliteral">&quot;NOTFOUND&quot;</span>);
<a name="l04827"></a>04827       <span class="keywordflow">return</span> 0;
<a name="l04828"></a>04828    }
<a name="l04829"></a>04829 
<a name="l04830"></a>04830    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;UPQMSTATUS&quot;</span>, <span class="stringliteral">&quot;UNPAUSED&quot;</span>);
<a name="l04831"></a>04831 
<a name="l04832"></a>04832    <span class="keywordflow">return</span> 0;
<a name="l04833"></a>04833 }
<a name="l04834"></a>04834 <span class="comment"></span>
<a name="l04835"></a>04835 <span class="comment">/*! \brief RemoveQueueMember application */</span>
<a name="l04836"></a><a class="code" href="app__queue_8c.html#afa57dc74f655759ac27df0cf69dbe9dc">04836</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#afa57dc74f655759ac27df0cf69dbe9dc" title="RemoveQueueMember application.">rqm_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l04837"></a>04837 {
<a name="l04838"></a>04838    <span class="keywordtype">int</span> res=-1;
<a name="l04839"></a>04839    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>, *temppos = NULL;
<a name="l04840"></a>04840    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l04841"></a>04841       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(queuename);
<a name="l04842"></a>04842       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(interface);
<a name="l04843"></a>04843       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l04844"></a>04844    );
<a name="l04845"></a>04845 
<a name="l04846"></a>04846 
<a name="l04847"></a>04847    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l04848"></a>04848       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;RemoveQueueMember requires an argument (queuename[,interface[,options]])\n&quot;</span>);
<a name="l04849"></a>04849       <span class="keywordflow">return</span> -1;
<a name="l04850"></a>04850    }
<a name="l04851"></a>04851 
<a name="l04852"></a>04852    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l04853"></a>04853 
<a name="l04854"></a>04854    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l04855"></a>04855 
<a name="l04856"></a>04856    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.interface)) {
<a name="l04857"></a>04857       args.interface = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(chan-&gt;name);
<a name="l04858"></a>04858       temppos = strrchr(args.interface, <span class="charliteral">&apos;-&apos;</span>);
<a name="l04859"></a>04859       <span class="keywordflow">if</span> (temppos)
<a name="l04860"></a>04860          *temppos = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04861"></a>04861    }
<a name="l04862"></a>04862 
<a name="l04863"></a>04863    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;queue: %s, member: %s\n&quot;</span>, args.queuename, args.interface);
<a name="l04864"></a>04864 
<a name="l04865"></a>04865    <span class="keywordflow">switch</span> (<a class="code" href="app__queue_8c.html#a2d8545a6eecf92b885f8880aaaf662d2" title="Remove member from queue.">remove_from_queue</a>(args.queuename, args.interface)) {
<a name="l04866"></a>04866    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#aaa42581c853cb64af155ddd19937d80e">RES_OKAY</a>:
<a name="l04867"></a>04867       <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(args.queuename, chan-&gt;uniqueid, args.interface, <span class="stringliteral">&quot;REMOVEMEMBER&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l04868"></a>04868       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Removed interface &apos;%s&apos; from queue &apos;%s&apos;\n&quot;</span>, args.interface, args.queuename);
<a name="l04869"></a>04869       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;RQMSTATUS&quot;</span>, <span class="stringliteral">&quot;REMOVED&quot;</span>);
<a name="l04870"></a>04870       res = 0;
<a name="l04871"></a>04871       <span class="keywordflow">break</span>;
<a name="l04872"></a>04872    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#ae72ca8d43e1d9acf1dbfcbc18c98a3ae">RES_EXISTS</a>:
<a name="l04873"></a>04873       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Unable to remove interface &apos;%s&apos; from queue &apos;%s&apos;: Not there\n&quot;</span>, args.interface, args.queuename);
<a name="l04874"></a>04874       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;RQMSTATUS&quot;</span>, <span class="stringliteral">&quot;NOTINQUEUE&quot;</span>);
<a name="l04875"></a>04875       res = 0;
<a name="l04876"></a>04876       <span class="keywordflow">break</span>;
<a name="l04877"></a>04877    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a88215ab017dd4ed8343d17918eacee81">RES_NOSUCHQUEUE</a>:
<a name="l04878"></a>04878       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to remove interface from queue &apos;%s&apos;: No such queue\n&quot;</span>, args.queuename);
<a name="l04879"></a>04879       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;RQMSTATUS&quot;</span>, <span class="stringliteral">&quot;NOSUCHQUEUE&quot;</span>);
<a name="l04880"></a>04880       res = 0;
<a name="l04881"></a>04881       <span class="keywordflow">break</span>;
<a name="l04882"></a>04882    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a447a632daaf1a56114da95816c12b8a5">RES_NOT_DYNAMIC</a>:
<a name="l04883"></a>04883       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to remove interface from queue &apos;%s&apos;: &apos;%s&apos; is not a dynamic member\n&quot;</span>, args.queuename, args.interface);
<a name="l04884"></a>04884       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;RQMSTATUS&quot;</span>, <span class="stringliteral">&quot;NOTDYNAMIC&quot;</span>);
<a name="l04885"></a>04885       res = 0;
<a name="l04886"></a>04886       <span class="keywordflow">break</span>;
<a name="l04887"></a>04887    }
<a name="l04888"></a>04888 
<a name="l04889"></a>04889    <span class="keywordflow">return</span> res;
<a name="l04890"></a>04890 }
<a name="l04891"></a>04891 <span class="comment"></span>
<a name="l04892"></a>04892 <span class="comment">/*! \brief AddQueueMember application */</span>
<a name="l04893"></a><a class="code" href="app__queue_8c.html#af19ce2770909b12f1a9c5beb90d7fba2">04893</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#af19ce2770909b12f1a9c5beb90d7fba2" title="AddQueueMember application.">aqm_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l04894"></a>04894 {
<a name="l04895"></a>04895    <span class="keywordtype">int</span> res=-1;
<a name="l04896"></a>04896    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>, *temppos = NULL;
<a name="l04897"></a>04897    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l04898"></a>04898       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(queuename);
<a name="l04899"></a>04899       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(interface);
<a name="l04900"></a>04900       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(penalty);
<a name="l04901"></a>04901       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l04902"></a>04902       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(membername);
<a name="l04903"></a>04903       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(state_interface);
<a name="l04904"></a>04904    );
<a name="l04905"></a>04905    <span class="keywordtype">int</span> penalty = 0;
<a name="l04906"></a>04906 
<a name="l04907"></a>04907    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l04908"></a>04908       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;AddQueueMember requires an argument (queuename[,interface[,penalty[,options[,membername[,stateinterface]]]]])\n&quot;</span>);
<a name="l04909"></a>04909       <span class="keywordflow">return</span> -1;
<a name="l04910"></a>04910    }
<a name="l04911"></a>04911 
<a name="l04912"></a>04912    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l04913"></a>04913 
<a name="l04914"></a>04914    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l04915"></a>04915 
<a name="l04916"></a>04916    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.interface)) {
<a name="l04917"></a>04917       args.interface = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(chan-&gt;name);
<a name="l04918"></a>04918       temppos = strrchr(args.interface, <span class="charliteral">&apos;-&apos;</span>);
<a name="l04919"></a>04919       <span class="keywordflow">if</span> (temppos)
<a name="l04920"></a>04920          *temppos = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04921"></a>04921    }
<a name="l04922"></a>04922 
<a name="l04923"></a>04923    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.penalty)) {
<a name="l04924"></a>04924       <span class="keywordflow">if</span> ((sscanf(args.penalty, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;penalty) != 1) || penalty &lt; 0) {
<a name="l04925"></a>04925          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Penalty &apos;%s&apos; is invalid, must be an integer &gt;= 0\n&quot;</span>, args.penalty);
<a name="l04926"></a>04926          penalty = 0;
<a name="l04927"></a>04927       }
<a name="l04928"></a>04928    }
<a name="l04929"></a>04929 
<a name="l04930"></a>04930    <span class="keywordflow">switch</span> (<a class="code" href="app__queue_8c.html#abe87549704e5140ad7f8798fa60b8642" title="Add member to queue.">add_to_queue</a>(args.queuename, args.interface, args.membername, penalty, 0, queue_persistent_members, args.state_interface)) {
<a name="l04931"></a>04931    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#aaa42581c853cb64af155ddd19937d80e">RES_OKAY</a>:
<a name="l04932"></a>04932       <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(args.queuename, chan-&gt;uniqueid, args.interface, <span class="stringliteral">&quot;ADDMEMBER&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l04933"></a>04933       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Added interface &apos;%s&apos; to queue &apos;%s&apos;\n&quot;</span>, args.interface, args.queuename);
<a name="l04934"></a>04934       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;AQMSTATUS&quot;</span>, <span class="stringliteral">&quot;ADDED&quot;</span>);
<a name="l04935"></a>04935       res = 0;
<a name="l04936"></a>04936       <span class="keywordflow">break</span>;
<a name="l04937"></a>04937    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#ae72ca8d43e1d9acf1dbfcbc18c98a3ae">RES_EXISTS</a>:
<a name="l04938"></a>04938       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to add interface &apos;%s&apos; to queue &apos;%s&apos;: Already there\n&quot;</span>, args.interface, args.queuename);
<a name="l04939"></a>04939       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;AQMSTATUS&quot;</span>, <span class="stringliteral">&quot;MEMBERALREADY&quot;</span>);
<a name="l04940"></a>04940       res = 0;
<a name="l04941"></a>04941       <span class="keywordflow">break</span>;
<a name="l04942"></a>04942    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a88215ab017dd4ed8343d17918eacee81">RES_NOSUCHQUEUE</a>:
<a name="l04943"></a>04943       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to add interface to queue &apos;%s&apos;: No such queue\n&quot;</span>, args.queuename);
<a name="l04944"></a>04944       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;AQMSTATUS&quot;</span>, <span class="stringliteral">&quot;NOSUCHQUEUE&quot;</span>);
<a name="l04945"></a>04945       res = 0;
<a name="l04946"></a>04946       <span class="keywordflow">break</span>;
<a name="l04947"></a>04947    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a662a43c452569dfc9f20d49a73498c64">RES_OUTOFMEMORY</a>:
<a name="l04948"></a>04948       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory adding member %s to queue %s\n&quot;</span>, args.interface, args.queuename);
<a name="l04949"></a>04949       <span class="keywordflow">break</span>;
<a name="l04950"></a>04950    }
<a name="l04951"></a>04951 
<a name="l04952"></a>04952    <span class="keywordflow">return</span> res;
<a name="l04953"></a>04953 }
<a name="l04954"></a>04954 <span class="comment"></span>
<a name="l04955"></a>04955 <span class="comment">/*! \brief QueueLog application */</span>
<a name="l04956"></a><a class="code" href="app__queue_8c.html#aaa24653e1b1376076e5f4cf9fe617f33">04956</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#aaa24653e1b1376076e5f4cf9fe617f33" title="QueueLog application.">ql_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l04957"></a>04957 {
<a name="l04958"></a>04958    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l04959"></a>04959 
<a name="l04960"></a>04960    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l04961"></a>04961       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(queuename);
<a name="l04962"></a>04962       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(uniqueid);
<a name="l04963"></a>04963       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(membername);
<a name="l04964"></a>04964       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(event);
<a name="l04965"></a>04965       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(params);
<a name="l04966"></a>04966    );
<a name="l04967"></a>04967 
<a name="l04968"></a>04968    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l04969"></a>04969       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;QueueLog requires arguments (queuename,uniqueid,membername,event[,additionalinfo]\n&quot;</span>);
<a name="l04970"></a>04970       <span class="keywordflow">return</span> -1;
<a name="l04971"></a>04971    }
<a name="l04972"></a>04972 
<a name="l04973"></a>04973    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l04974"></a>04974 
<a name="l04975"></a>04975    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l04976"></a>04976 
<a name="l04977"></a>04977    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.queuename) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.uniqueid)
<a name="l04978"></a>04978        || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.membername) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.event)) {
<a name="l04979"></a>04979       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;QueueLog requires arguments (queuename,uniqueid,membername,event[,additionalinfo])\n&quot;</span>);
<a name="l04980"></a>04980       <span class="keywordflow">return</span> -1;
<a name="l04981"></a>04981    }
<a name="l04982"></a>04982 
<a name="l04983"></a>04983    <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(args.queuename, args.uniqueid, args.membername, args.event, 
<a name="l04984"></a>04984       <span class="stringliteral">&quot;%s&quot;</span>, args.params ? args.params : <span class="stringliteral">&quot;&quot;</span>);
<a name="l04985"></a>04985 
<a name="l04986"></a>04986    <span class="keywordflow">return</span> 0;
<a name="l04987"></a>04987 }
<a name="l04988"></a>04988 <span class="comment"></span>
<a name="l04989"></a>04989 <span class="comment">/*! \brief Copy rule from global list into specified queue */</span>
<a name="l04990"></a><a class="code" href="app__queue_8c.html#a5a980ba36a8d002f369930cbf8a9b595">04990</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a5a980ba36a8d002f369930cbf8a9b595" title="Copy rule from global list into specified queue.">copy_rules</a>(<span class="keyword">struct</span> <a class="code" href="structqueue__ent.html">queue_ent</a> *qe, <span class="keyword">const</span> <span class="keywordtype">char</span> *rulename)
<a name="l04991"></a>04991 {
<a name="l04992"></a>04992    <span class="keyword">struct </span><a class="code" href="structpenalty__rule.html">penalty_rule</a> *pr_iter;
<a name="l04993"></a>04993    <span class="keyword">struct </span>rule_list *rl_iter;
<a name="l04994"></a>04994    <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp = <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(rulename) ? qe-&gt;<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;defaultrule : rulename;
<a name="l04995"></a>04995    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;rule_lists);
<a name="l04996"></a>04996    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;rule_lists, rl_iter, list) {
<a name="l04997"></a>04997       <span class="keywordflow">if</span> (!strcasecmp(rl_iter-&gt;<a class="code" href="structrule__list.html#a3777dbae63a15da001b2baa317a25149">name</a>, tmp))
<a name="l04998"></a>04998          <span class="keywordflow">break</span>;
<a name="l04999"></a>04999    }
<a name="l05000"></a>05000    <span class="keywordflow">if</span> (rl_iter) {
<a name="l05001"></a>05001       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;rl_iter-&gt;rules, pr_iter, list) {
<a name="l05002"></a>05002          <span class="keyword">struct </span><a class="code" href="structpenalty__rule.html">penalty_rule</a> *new_pr = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*new_pr));
<a name="l05003"></a>05003          <span class="keywordflow">if</span> (!new_pr) {
<a name="l05004"></a>05004             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error when copying penalty rules! Aborting!\n&quot;</span>);
<a name="l05005"></a>05005             <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;rule_lists);
<a name="l05006"></a>05006             <span class="keywordflow">break</span>;
<a name="l05007"></a>05007          }
<a name="l05008"></a>05008          new_pr-&gt;<a class="code" href="structpenalty__rule.html#a42715f65f02da52edc5b22021d8ae670">time</a> = pr_iter-&gt;<a class="code" href="structpenalty__rule.html#a42715f65f02da52edc5b22021d8ae670">time</a>;
<a name="l05009"></a>05009          new_pr-&gt;<a class="code" href="structpenalty__rule.html#aff3c96df7d67617d6ee82fa1f257ff84">max_value</a> = pr_iter-&gt;<a class="code" href="structpenalty__rule.html#aff3c96df7d67617d6ee82fa1f257ff84">max_value</a>;
<a name="l05010"></a>05010          new_pr-&gt;<a class="code" href="structpenalty__rule.html#a2b15eec5f0109b01f534046bb5c04666">min_value</a> = pr_iter-&gt;<a class="code" href="structpenalty__rule.html#a2b15eec5f0109b01f534046bb5c04666">min_value</a>;
<a name="l05011"></a>05011          new_pr-&gt;<a class="code" href="structpenalty__rule.html#ae0778c688a39dcc28198f568176370eb">max_relative</a> = pr_iter-&gt;<a class="code" href="structpenalty__rule.html#ae0778c688a39dcc28198f568176370eb">max_relative</a>;
<a name="l05012"></a>05012          new_pr-&gt;<a class="code" href="structpenalty__rule.html#a790961d8e38a4dbcdd59e8c2b0a292b4">min_relative</a> = pr_iter-&gt;<a class="code" href="structpenalty__rule.html#a790961d8e38a4dbcdd59e8c2b0a292b4">min_relative</a>;
<a name="l05013"></a>05013          <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;qe-&gt;qe_rules, new_pr, list);
<a name="l05014"></a>05014       }
<a name="l05015"></a>05015    }
<a name="l05016"></a>05016    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;rule_lists);
<a name="l05017"></a>05017 }
<a name="l05018"></a>05018 <span class="comment"></span>
<a name="l05019"></a>05019 <span class="comment">/*!\brief The starting point for all queue calls</span>
<a name="l05020"></a>05020 <span class="comment"> *</span>
<a name="l05021"></a>05021 <span class="comment"> * The process involved here is to </span>
<a name="l05022"></a>05022 <span class="comment"> * 1. Parse the options specified in the call to Queue()</span>
<a name="l05023"></a>05023 <span class="comment"> * 2. Join the queue</span>
<a name="l05024"></a>05024 <span class="comment"> * 3. Wait in a loop until it is our turn to try calling a queue member</span>
<a name="l05025"></a>05025 <span class="comment"> * 4. Attempt to call a queue member</span>
<a name="l05026"></a>05026 <span class="comment"> * 5. If 4. did not result in a bridged call, then check for between</span>
<a name="l05027"></a>05027 <span class="comment"> *    call options such as periodic announcements etc.</span>
<a name="l05028"></a>05028 <span class="comment"> * 6. Try 4 again unless some condition (such as an expiration time) causes us to </span>
<a name="l05029"></a>05029 <span class="comment"> *    exit the queue.</span>
<a name="l05030"></a>05030 <span class="comment"> */</span>
<a name="l05031"></a><a class="code" href="app__queue_8c.html#a3afbdcfe9fe1e41cd693648e29b4fa78">05031</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a3afbdcfe9fe1e41cd693648e29b4fa78" title="The starting point for all queue calls.">queue_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l05032"></a>05032 {
<a name="l05033"></a>05033    <span class="keywordtype">int</span> res=-1;
<a name="l05034"></a>05034    <span class="keywordtype">int</span> ringing=0;
<a name="l05035"></a>05035    <span class="keyword">const</span> <span class="keywordtype">char</span> *user_priority;
<a name="l05036"></a>05036    <span class="keyword">const</span> <span class="keywordtype">char</span> *max_penalty_str;
<a name="l05037"></a>05037    <span class="keyword">const</span> <span class="keywordtype">char</span> *min_penalty_str;
<a name="l05038"></a>05038    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a6f8e491cf1d80eb127fe0c10ebbfc659">prio</a>;
<a name="l05039"></a>05039    <span class="keywordtype">int</span> qcontinue = 0;
<a name="l05040"></a>05040    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a>, <a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a>;
<a name="l05041"></a>05041    <span class="keyword">enum</span> <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2">queue_result</a> reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a49a10204f0f100fb6ae669936e01a90c">QUEUE_UNKNOWN</a>;
<a name="l05042"></a>05042    <span class="comment">/* whether to exit Queue application after the timeout hits */</span>
<a name="l05043"></a>05043    <span class="keywordtype">int</span> tries = 0;
<a name="l05044"></a>05044    <span class="keywordtype">int</span> noption = 0;
<a name="l05045"></a>05045    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l05046"></a>05046    <span class="keywordtype">int</span> makeannouncement = 0;
<a name="l05047"></a>05047    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l05048"></a>05048       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(queuename);
<a name="l05049"></a>05049       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l05050"></a>05050       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>);
<a name="l05051"></a>05051       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(announceoverride);
<a name="l05052"></a>05052       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(queuetimeoutstr);
<a name="l05053"></a>05053       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(agi);
<a name="l05054"></a>05054       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(macro);
<a name="l05055"></a>05055       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(gosub);
<a name="l05056"></a>05056       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structrule.html">rule</a>);
<a name="l05057"></a>05057    );
<a name="l05058"></a>05058    <span class="comment">/* Our queue entry */</span>
<a name="l05059"></a>05059    <span class="keyword">struct </span><a class="code" href="structqueue__ent.html">queue_ent</a> qe = { 0 };
<a name="l05060"></a>05060    
<a name="l05061"></a>05061    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l05062"></a>05062       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Queue requires an argument: queuename[,options[,URL[,announceoverride[,timeout[,agi[,macro[,gosub[,rule]]]]]]]]\n&quot;</span>);
<a name="l05063"></a>05063       <span class="keywordflow">return</span> -1;
<a name="l05064"></a>05064    }
<a name="l05065"></a>05065    
<a name="l05066"></a>05066    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l05067"></a>05067    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l05068"></a>05068 
<a name="l05069"></a>05069    <span class="comment">/* Setup our queue entry */</span>
<a name="l05070"></a>05070    qe.<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a> = time(NULL);
<a name="l05071"></a>05071 
<a name="l05072"></a>05072    <span class="comment">/* set the expire time based on the supplied timeout; */</span>
<a name="l05073"></a>05073    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.queuetimeoutstr))
<a name="l05074"></a>05074       qe.<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> = qe.<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a> + atoi(args.queuetimeoutstr);
<a name="l05075"></a>05075    <span class="keywordflow">else</span>
<a name="l05076"></a>05076       qe.<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> = 0;
<a name="l05077"></a>05077 
<a name="l05078"></a>05078    <span class="comment">/* Get the priority from the variable ${QUEUE_PRIO} */</span>
<a name="l05079"></a>05079    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l05080"></a>05080    user_priority = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;QUEUE_PRIO&quot;</span>);
<a name="l05081"></a>05081    <span class="keywordflow">if</span> (user_priority) {
<a name="l05082"></a>05082       <span class="keywordflow">if</span> (sscanf(user_priority, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;prio) == 1) {
<a name="l05083"></a>05083          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s: Got priority %d from ${QUEUE_PRIO}.\n&quot;</span>, chan-&gt;name, prio);
<a name="l05084"></a>05084       } <span class="keywordflow">else</span> {
<a name="l05085"></a>05085          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;${QUEUE_PRIO}: Invalid value (%s), channel %s.\n&quot;</span>,
<a name="l05086"></a>05086             user_priority, chan-&gt;name);
<a name="l05087"></a>05087          prio = 0;
<a name="l05088"></a>05088       }
<a name="l05089"></a>05089    } <span class="keywordflow">else</span> {
<a name="l05090"></a>05090       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;NO QUEUE_PRIO variable found. Using default.\n&quot;</span>);
<a name="l05091"></a>05091       prio = 0;
<a name="l05092"></a>05092    }
<a name="l05093"></a>05093 
<a name="l05094"></a>05094    <span class="comment">/* Get the maximum penalty from the variable ${QUEUE_MAX_PENALTY} */</span>
<a name="l05095"></a>05095 
<a name="l05096"></a>05096    <span class="keywordflow">if</span> ((max_penalty_str = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;QUEUE_MAX_PENALTY&quot;</span>))) {
<a name="l05097"></a>05097       <span class="keywordflow">if</span> (sscanf(max_penalty_str, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;max_penalty) == 1) {
<a name="l05098"></a>05098          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s: Got max penalty %d from ${QUEUE_MAX_PENALTY}.\n&quot;</span>, chan-&gt;name, max_penalty);
<a name="l05099"></a>05099       } <span class="keywordflow">else</span> {
<a name="l05100"></a>05100          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;${QUEUE_MAX_PENALTY}: Invalid value (%s), channel %s.\n&quot;</span>,
<a name="l05101"></a>05101             max_penalty_str, chan-&gt;name);
<a name="l05102"></a>05102          max_penalty = 0;
<a name="l05103"></a>05103       }
<a name="l05104"></a>05104    } <span class="keywordflow">else</span> {
<a name="l05105"></a>05105       max_penalty = 0;
<a name="l05106"></a>05106    }
<a name="l05107"></a>05107 
<a name="l05108"></a>05108    <span class="keywordflow">if</span> ((min_penalty_str = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;QUEUE_MIN_PENALTY&quot;</span>))) {
<a name="l05109"></a>05109       <span class="keywordflow">if</span> (sscanf(min_penalty_str, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;min_penalty) == 1) {
<a name="l05110"></a>05110          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s: Got min penalty %d from ${QUEUE_MIN_PENALTY}.\n&quot;</span>, chan-&gt;name, min_penalty);
<a name="l05111"></a>05111       } <span class="keywordflow">else</span> {
<a name="l05112"></a>05112          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;${QUEUE_MIN_PENALTY}: Invalid value (%s), channel %s.\n&quot;</span>,
<a name="l05113"></a>05113             min_penalty_str, chan-&gt;name);
<a name="l05114"></a>05114          min_penalty = 0;
<a name="l05115"></a>05115       }
<a name="l05116"></a>05116    } <span class="keywordflow">else</span> {
<a name="l05117"></a>05117       min_penalty = 0;
<a name="l05118"></a>05118    }
<a name="l05119"></a>05119    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l05120"></a>05120 
<a name="l05121"></a>05121    <span class="keywordflow">if</span> (args.options &amp;&amp; (strchr(args.options, <span class="charliteral">&apos;r&apos;</span>)))
<a name="l05122"></a>05122       ringing = 1;
<a name="l05123"></a>05123 
<a name="l05124"></a>05124    <span class="keywordflow">if</span> (args.options &amp;&amp; (strchr(args.options, <span class="charliteral">&apos;c&apos;</span>)))
<a name="l05125"></a>05125       qcontinue = 1;
<a name="l05126"></a>05126 
<a name="l05127"></a>05127    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;queue: %s, options: %s, url: %s, announce: %s, expires: %ld, priority: %d\n&quot;</span>,
<a name="l05128"></a>05128       args.queuename, args.options, args.url, args.announceoverride, (<span class="keywordtype">long</span>)qe.<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a>, prio);
<a name="l05129"></a>05129 
<a name="l05130"></a>05130    qe.<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = chan;
<a name="l05131"></a>05131    qe.<a class="code" href="structqueue__ent.html#a6f8e491cf1d80eb127fe0c10ebbfc659">prio</a> = prio;
<a name="l05132"></a>05132    qe.<a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a> = max_penalty;
<a name="l05133"></a>05133    qe.<a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a> = min_penalty;
<a name="l05134"></a>05134    qe.<a class="code" href="structqueue__ent.html#ac019537a959f6147cecffb126bb04381">last_pos_said</a> = 0;
<a name="l05135"></a>05135    qe.<a class="code" href="structqueue__ent.html#a1f8971bc7f04d9152056ed8aa4f36ef6">last_pos</a> = 0;
<a name="l05136"></a>05136    qe.<a class="code" href="structqueue__ent.html#a26f62e545090b51f4c7e8efbf2db8d6b">last_periodic_announce_time</a> = time(NULL);
<a name="l05137"></a>05137    qe.<a class="code" href="structqueue__ent.html#ac49f311625f4ec75469d1af3e7505a4b">last_periodic_announce_sound</a> = 0;
<a name="l05138"></a>05138    qe.<a class="code" href="structqueue__ent.html#a12851de4518c71edbf5c5adb40976629">valid_digits</a> = 0;
<a name="l05139"></a>05139    <span class="keywordflow">if</span> (<a class="code" href="app__queue_8c.html#aaf5770fac8f13bed203f66971d2cdc23">join_queue</a>(args.queuename, &amp;qe, &amp;reason)) {
<a name="l05140"></a>05140       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to join queue &apos;%s&apos;\n&quot;</span>, args.queuename);
<a name="l05141"></a>05141       <a class="code" href="app__queue_8c.html#a30fd2efd3517fe2537656bdd18a09c6f" title="sets the QUEUESTATUS channel variable">set_queue_result</a>(chan, reason);
<a name="l05142"></a>05142       <span class="keywordflow">return</span> 0;
<a name="l05143"></a>05143    }
<a name="l05144"></a>05144    <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(args.queuename, chan-&gt;uniqueid, <span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;ENTERQUEUE&quot;</span>, <span class="stringliteral">&quot;%s|%s&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(args.url, <span class="stringliteral">&quot;&quot;</span>),
<a name="l05145"></a>05145       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;&quot;</span>));
<a name="l05146"></a>05146    <a class="code" href="app__queue_8c.html#a5a980ba36a8d002f369930cbf8a9b595" title="Copy rule from global list into specified queue.">copy_rules</a>(&amp;qe, args.rule);
<a name="l05147"></a>05147    qe.pr = <a class="code" href="linkedlists_8h.html#adf1959c5c03a3a706da97ad2f49617e5" title="Returns the first entry contained in a list.">AST_LIST_FIRST</a>(&amp;qe.qe_rules);
<a name="l05148"></a>05148 check_turns:
<a name="l05149"></a>05149    <span class="keywordflow">if</span> (ringing) {
<a name="l05150"></a>05150       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>);
<a name="l05151"></a>05151    } <span class="keywordflow">else</span> {
<a name="l05152"></a>05152       <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(chan, qe.<a class="code" href="structqueue__ent.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>, NULL);
<a name="l05153"></a>05153    }
<a name="l05154"></a>05154 
<a name="l05155"></a>05155    <span class="comment">/* This is the wait loop for callers 2 through maxlen */</span>
<a name="l05156"></a>05156    res = <a class="code" href="app__queue_8c.html#a54d8f5c6ba5bd46020c7c319fa5a89c2" title="The waiting areas for callers who are not actively calling members.">wait_our_turn</a>(&amp;qe, ringing, &amp;reason);
<a name="l05157"></a>05157    <span class="keywordflow">if</span> (res) {
<a name="l05158"></a>05158       <span class="keywordflow">goto</span> <a class="code" href="res__ais_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a>;
<a name="l05159"></a>05159    }
<a name="l05160"></a>05160 
<a name="l05161"></a>05161    makeannouncement = 0;
<a name="l05162"></a>05162 
<a name="l05163"></a>05163    <span class="keywordflow">for</span> (;;) {
<a name="l05164"></a>05164       <span class="comment">/* This is the wait loop for the head caller*/</span>
<a name="l05165"></a>05165       <span class="comment">/* To exit, they may get their call answered; */</span>
<a name="l05166"></a>05166       <span class="comment">/* they may dial a digit from the queue context; */</span>
<a name="l05167"></a>05167       <span class="comment">/* or, they may timeout. */</span>
<a name="l05168"></a>05168 
<a name="l05169"></a>05169       <span class="comment">/* Leave if we have exceeded our queuetimeout */</span>
<a name="l05170"></a>05170       <span class="keywordflow">if</span> (qe.<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> &amp;&amp; (time(NULL) &gt;= qe.<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a>)) {
<a name="l05171"></a>05171          <a class="code" href="app__queue_8c.html#a0b2ffd959c3ce34b11292c6ecfc8f2d8" title="Record that a caller gave up on waiting in queue.">record_abandoned</a>(&amp;qe);
<a name="l05172"></a>05172          <a class="code" href="cdr_8h.html#a46d2f4a55a1be9b94fef1a87ac3f7fbb" title="A call wasn&amp;#39;t answered.">ast_cdr_noanswer</a>(qe.<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l05173"></a>05173          reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2af24af6741501e58c5a32990e70a35a5d">QUEUE_TIMEOUT</a>;
<a name="l05174"></a>05174          res = 0;
<a name="l05175"></a>05175          <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(args.queuename, chan-&gt;uniqueid,<span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;EXITWITHTIMEOUT&quot;</span>, <span class="stringliteral">&quot;%d|%d|%ld&quot;</span>, 
<a name="l05176"></a>05176             qe.<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, qe.<a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>, (<span class="keywordtype">long</span>) time(NULL) - qe.<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>);
<a name="l05177"></a>05177          <span class="keywordflow">break</span>;
<a name="l05178"></a>05178       }
<a name="l05179"></a>05179 
<a name="l05180"></a>05180       <span class="keywordflow">if</span> (makeannouncement) {
<a name="l05181"></a>05181          <span class="comment">/* Make a position announcement, if enabled */</span>
<a name="l05182"></a>05182          <span class="keywordflow">if</span> (qe.<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a158e72e504d11a5f6cdfa8d25343adbb">announcefrequency</a>)
<a name="l05183"></a>05183             <span class="keywordflow">if</span> ((res = <a class="code" href="app__queue_8c.html#ad395c86c08af4a1c22518966e9ead32f">say_position</a>(&amp;qe,ringing)))
<a name="l05184"></a>05184                <span class="keywordflow">goto</span> <a class="code" href="res__ais_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a>;
<a name="l05185"></a>05185       }
<a name="l05186"></a>05186       makeannouncement = 1;
<a name="l05187"></a>05187 
<a name="l05188"></a>05188       <span class="comment">/* Make a periodic announcement, if enabled */</span>
<a name="l05189"></a>05189       <span class="keywordflow">if</span> (qe.<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a2a43a68cf8add918260068d677434132">periodicannouncefrequency</a>)
<a name="l05190"></a>05190          <span class="keywordflow">if</span> ((res = <a class="code" href="app__queue_8c.html#a3d3fbc78100b994e44f9f270af21c451" title="Playback announcement to queued members if peroid has elapsed.">say_periodic_announcement</a>(&amp;qe,ringing)))
<a name="l05191"></a>05191             <span class="keywordflow">goto</span> <a class="code" href="res__ais_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a>;
<a name="l05192"></a>05192    
<a name="l05193"></a>05193       <span class="comment">/* Leave if we have exceeded our queuetimeout */</span>
<a name="l05194"></a>05194       <span class="keywordflow">if</span> (qe.<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> &amp;&amp; (time(NULL) &gt;= qe.<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a>)) {
<a name="l05195"></a>05195          <a class="code" href="app__queue_8c.html#a0b2ffd959c3ce34b11292c6ecfc8f2d8" title="Record that a caller gave up on waiting in queue.">record_abandoned</a>(&amp;qe);
<a name="l05196"></a>05196          <a class="code" href="cdr_8h.html#a46d2f4a55a1be9b94fef1a87ac3f7fbb" title="A call wasn&amp;#39;t answered.">ast_cdr_noanswer</a>(qe.<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l05197"></a>05197          reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2af24af6741501e58c5a32990e70a35a5d">QUEUE_TIMEOUT</a>;
<a name="l05198"></a>05198          res = 0;
<a name="l05199"></a>05199          <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(args.queuename, chan-&gt;uniqueid, <span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;EXITWITHTIMEOUT&quot;</span>, <span class="stringliteral">&quot;%d&quot;</span>, qe.<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>);
<a name="l05200"></a>05200          <span class="keywordflow">break</span>;
<a name="l05201"></a>05201       }
<a name="l05202"></a>05202 
<a name="l05203"></a>05203       <span class="comment">/* see if we need to move to the next penalty level for this queue */</span>
<a name="l05204"></a>05204       <span class="keywordflow">while</span> (qe.pr &amp;&amp; ((time(NULL) - qe.<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>) &gt; qe.pr-&gt;time)) {
<a name="l05205"></a>05205          <a class="code" href="app__queue_8c.html#aa1efb798e09a88e68559b08c90c573ee" title="update rules for queues">update_qe_rule</a>(&amp;qe);
<a name="l05206"></a>05206       }
<a name="l05207"></a>05207 
<a name="l05208"></a>05208       <span class="comment">/* Try calling all queue members for &apos;timeout&apos; seconds */</span>
<a name="l05209"></a>05209       res = <a class="code" href="app__queue_8c.html#a9a05da352a5c433d2b614c972203a7d2" title="A large function which calls members, updates statistics, and bridges the caller...">try_calling</a>(&amp;qe, args.options, args.announceoverride, args.url, &amp;tries, &amp;noption, args.agi, args.macro, args.gosub, ringing);
<a name="l05210"></a>05210       <span class="keywordflow">if</span> (res) {
<a name="l05211"></a>05211          <span class="keywordflow">goto</span> <a class="code" href="res__ais_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a>;
<a name="l05212"></a>05212       }
<a name="l05213"></a>05213 
<a name="l05214"></a>05214       <span class="keywordflow">if</span> (qe.<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a77bab4023f1969460cc9c64baa39e016">leavewhenempty</a>) {
<a name="l05215"></a>05215          <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 0;
<a name="l05216"></a>05216          <span class="keywordflow">if</span> ((status = <a class="code" href="app__queue_8c.html#ac038b08379d8bdb21a862f1bafe729d4" title="Check if members are available.">get_member_status</a>(qe.<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, qe.<a class="code" href="structqueue__ent.html#a6953d3232b673de8d1b0112a0bae49cc">max_penalty</a>, qe.<a class="code" href="structqueue__ent.html#a9038df9f3d3bbd51a7bb8d04cf2e4125">min_penalty</a>, qe.<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a77bab4023f1969460cc9c64baa39e016">leavewhenempty</a>))) {
<a name="l05217"></a>05217             <a class="code" href="app__queue_8c.html#a0b2ffd959c3ce34b11292c6ecfc8f2d8" title="Record that a caller gave up on waiting in queue.">record_abandoned</a>(&amp;qe);
<a name="l05218"></a>05218             <a class="code" href="cdr_8h.html#a46d2f4a55a1be9b94fef1a87ac3f7fbb" title="A call wasn&amp;#39;t answered.">ast_cdr_noanswer</a>(qe.<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l05219"></a>05219             reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a96a1965ee856fa58fbd96bc5b0ffc101">QUEUE_LEAVEEMPTY</a>;
<a name="l05220"></a>05220             <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(args.queuename, chan-&gt;uniqueid, <span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;EXITEMPTY&quot;</span>, <span class="stringliteral">&quot;%d|%d|%ld&quot;</span>, qe.<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, qe.<a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>, (<span class="keywordtype">long</span>)(time(NULL) - qe.<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>));
<a name="l05221"></a>05221             res = 0;
<a name="l05222"></a>05222             <span class="keywordflow">break</span>;
<a name="l05223"></a>05223          }
<a name="l05224"></a>05224       }
<a name="l05225"></a>05225 
<a name="l05226"></a>05226       <span class="comment">/* exit after &apos;timeout&apos; cycle if &apos;n&apos; option enabled */</span>
<a name="l05227"></a>05227       <span class="keywordflow">if</span> (noption &amp;&amp; tries &gt;= qe.<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>) {
<a name="l05228"></a>05228          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Exiting on time-out cycle\n&quot;</span>);
<a name="l05229"></a>05229          <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(args.queuename, chan-&gt;uniqueid, <span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;EXITWITHTIMEOUT&quot;</span>, <span class="stringliteral">&quot;%d&quot;</span>, qe.<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>);
<a name="l05230"></a>05230          <a class="code" href="app__queue_8c.html#a0b2ffd959c3ce34b11292c6ecfc8f2d8" title="Record that a caller gave up on waiting in queue.">record_abandoned</a>(&amp;qe);
<a name="l05231"></a>05231          <a class="code" href="cdr_8h.html#a46d2f4a55a1be9b94fef1a87ac3f7fbb" title="A call wasn&amp;#39;t answered.">ast_cdr_noanswer</a>(qe.<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l05232"></a>05232          reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2af24af6741501e58c5a32990e70a35a5d">QUEUE_TIMEOUT</a>;
<a name="l05233"></a>05233          res = 0;
<a name="l05234"></a>05234          <span class="keywordflow">break</span>;
<a name="l05235"></a>05235       }
<a name="l05236"></a>05236 
<a name="l05237"></a>05237       
<a name="l05238"></a>05238       <span class="comment">/* Leave if we have exceeded our queuetimeout */</span>
<a name="l05239"></a>05239       <span class="keywordflow">if</span> (qe.<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a> &amp;&amp; (time(NULL) &gt;= qe.<a class="code" href="structqueue__ent.html#a30cde435136d2c66ba5c601bf6e52d1e">expire</a>)) {
<a name="l05240"></a>05240          <a class="code" href="app__queue_8c.html#a0b2ffd959c3ce34b11292c6ecfc8f2d8" title="Record that a caller gave up on waiting in queue.">record_abandoned</a>(&amp;qe);
<a name="l05241"></a>05241          <a class="code" href="cdr_8h.html#a46d2f4a55a1be9b94fef1a87ac3f7fbb" title="A call wasn&amp;#39;t answered.">ast_cdr_noanswer</a>(qe.<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l05242"></a>05242          reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2af24af6741501e58c5a32990e70a35a5d">QUEUE_TIMEOUT</a>;
<a name="l05243"></a>05243          res = 0;
<a name="l05244"></a>05244          <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(qe.<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>-&gt;name, qe.<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid,<span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;EXITWITHTIMEOUT&quot;</span>, <span class="stringliteral">&quot;%d|%d|%ld&quot;</span>, qe.<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, qe.<a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>, (<span class="keywordtype">long</span>) time(NULL) - qe.<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>);
<a name="l05245"></a>05245          <span class="keywordflow">break</span>;
<a name="l05246"></a>05246       }
<a name="l05247"></a>05247 
<a name="l05248"></a>05248       <span class="comment">/* If using dynamic realtime members, we should regenerate the member list for this queue */</span>
<a name="l05249"></a>05249       <a class="code" href="app__queue_8c.html#ad4d94a7a9e04ddf7984d69a8737221f9">update_realtime_members</a>(qe.<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l05250"></a>05250       <span class="comment">/* OK, we didn&apos;t get anybody; wait for &apos;retry&apos; seconds; may get a digit to exit with */</span>
<a name="l05251"></a>05251       res = <a class="code" href="app__queue_8c.html#ae2c06dcaa81d44b2782bb33be68c4858">wait_a_bit</a>(&amp;qe);
<a name="l05252"></a>05252       <span class="keywordflow">if</span> (res)
<a name="l05253"></a>05253          <span class="keywordflow">goto</span> <a class="code" href="res__ais_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a>;
<a name="l05254"></a>05254 
<a name="l05255"></a>05255       <span class="comment">/* Since this is a priority queue and</span>
<a name="l05256"></a>05256 <span class="comment">       * it is not sure that we are still at the head</span>
<a name="l05257"></a>05257 <span class="comment">       * of the queue, go and check for our turn again.</span>
<a name="l05258"></a>05258 <span class="comment">       */</span>
<a name="l05259"></a>05259       <span class="keywordflow">if</span> (!<a class="code" href="app__queue_8c.html#a09df986cff00524f91c16051486231ec" title="Check if we should start attempting to call queue members.">is_our_turn</a>(&amp;qe)) {
<a name="l05260"></a>05260          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Darn priorities, going back in queue (%s)!\n&quot;</span>, qe.<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l05261"></a>05261          <span class="keywordflow">goto</span> check_turns;
<a name="l05262"></a>05262       }
<a name="l05263"></a>05263    }
<a name="l05264"></a>05264 
<a name="l05265"></a>05265 <a class="code" href="res__ais_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a>:
<a name="l05266"></a>05266    <span class="keywordflow">if</span> (res) {
<a name="l05267"></a>05267       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l05268"></a>05268          <span class="keywordflow">if</span> (!qe.<a class="code" href="structqueue__ent.html#ab234be20f2e48f4f08d2d2c071b8ff55">handled</a>) {
<a name="l05269"></a>05269             <a class="code" href="app__queue_8c.html#a0b2ffd959c3ce34b11292c6ecfc8f2d8" title="Record that a caller gave up on waiting in queue.">record_abandoned</a>(&amp;qe);
<a name="l05270"></a>05270             <a class="code" href="cdr_8h.html#a46d2f4a55a1be9b94fef1a87ac3f7fbb" title="A call wasn&amp;#39;t answered.">ast_cdr_noanswer</a>(qe.<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l05271"></a>05271             <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(args.queuename, chan-&gt;uniqueid, <span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;ABANDON&quot;</span>,
<a name="l05272"></a>05272                <span class="stringliteral">&quot;%d|%d|%ld&quot;</span>, qe.<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, qe.<a class="code" href="structqueue__ent.html#a86191f9cf0936c2201653d521b369c6c">opos</a>,
<a name="l05273"></a>05273                (<span class="keywordtype">long</span>) time(NULL) - qe.<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>);
<a name="l05274"></a>05274             res = -1;
<a name="l05275"></a>05275          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (qcontinue) {
<a name="l05276"></a>05276             reason = <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a7d363853794316b276622be186ead6f0">QUEUE_CONTINUE</a>;
<a name="l05277"></a>05277             res = 0;
<a name="l05278"></a>05278          }
<a name="l05279"></a>05279       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (qe.<a class="code" href="structqueue__ent.html#a12851de4518c71edbf5c5adb40976629">valid_digits</a>) {
<a name="l05280"></a>05280          <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(args.queuename, chan-&gt;uniqueid, <span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;EXITWITHKEY&quot;</span>,
<a name="l05281"></a>05281             <span class="stringliteral">&quot;%s|%d&quot;</span>, qe.<a class="code" href="structqueue__ent.html#a03f45477f89c1c873bd0ce9b508901ca">digits</a>, qe.<a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>);
<a name="l05282"></a>05282       }
<a name="l05283"></a>05283    }
<a name="l05284"></a>05284 
<a name="l05285"></a>05285    <span class="comment">/* Don&apos;t allow return code &gt; 0 */</span>
<a name="l05286"></a>05286    <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l05287"></a>05287       res = 0; 
<a name="l05288"></a>05288       <span class="keywordflow">if</span> (ringing) {
<a name="l05289"></a>05289          <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, -1);
<a name="l05290"></a>05290       } <span class="keywordflow">else</span> {
<a name="l05291"></a>05291          <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l05292"></a>05292       }        
<a name="l05293"></a>05293       <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l05294"></a>05294    }
<a name="l05295"></a>05295 
<a name="l05296"></a>05296    <a class="code" href="app__queue_8c.html#a1248fe33745c5cb9c87db6be0a25d138" title="Set variables of queue.">set_queue_variables</a>(qe.<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>, qe.<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l05297"></a>05297 
<a name="l05298"></a>05298    <a class="code" href="app__queue_8c.html#a3135d5c6b468bef49c1e3fc5d7394f30" title="Caller leaving queue.">leave_queue</a>(&amp;qe);
<a name="l05299"></a>05299    <span class="keywordflow">if</span> (reason != <a class="code" href="app__queue_8c.html#a9be528c0673709889b09c11f2c0f77d2a49a10204f0f100fb6ae669936e01a90c">QUEUE_UNKNOWN</a>)
<a name="l05300"></a>05300       <a class="code" href="app__queue_8c.html#a30fd2efd3517fe2537656bdd18a09c6f" title="sets the QUEUESTATUS channel variable">set_queue_result</a>(chan, reason);
<a name="l05301"></a>05301 
<a name="l05302"></a>05302    <span class="keywordflow">if</span> (qe.<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>) {
<a name="l05303"></a>05303       <span class="comment">/* every queue_ent is given a reference to it&apos;s parent call_queue when it joins the queue.</span>
<a name="l05304"></a>05304 <span class="comment">       * This ref must be taken away right before the queue_ent is destroyed.  In this case</span>
<a name="l05305"></a>05305 <span class="comment">       * the queue_ent is about to be returned on the stack */</span>
<a name="l05306"></a>05306       qe.<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a> = <a class="code" href="app__queue_8c.html#aa4c67d0629622e3bb3d1a8e7104da47e">queue_unref</a>(qe.<a class="code" href="structqueue__ent.html#ae696e1fe3492379e4f8a1df0c72f63ab">parent</a>);
<a name="l05307"></a>05307    }
<a name="l05308"></a>05308 
<a name="l05309"></a>05309    <span class="keywordflow">return</span> res;
<a name="l05310"></a>05310 }
<a name="l05311"></a>05311 <span class="comment"></span>
<a name="l05312"></a>05312 <span class="comment">/*!</span>
<a name="l05313"></a>05313 <span class="comment"> * \brief create interface var with all queue details.</span>
<a name="l05314"></a>05314 <span class="comment"> * \retval 0 on success</span>
<a name="l05315"></a>05315 <span class="comment"> * \retval -1 on error</span>
<a name="l05316"></a>05316 <span class="comment">*/</span>
<a name="l05317"></a><a class="code" href="app__queue_8c.html#a7b254b14693f1f30d4ddd615d7f777b9">05317</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a7b254b14693f1f30d4ddd615d7f777b9" title="create interface var with all queue details.">queue_function_var</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l05318"></a>05318 {
<a name="l05319"></a>05319    <span class="keywordtype">int</span> res = -1;
<a name="l05320"></a>05320    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q, tmpq = {
<a name="l05321"></a>05321       .name = data,  
<a name="l05322"></a>05322    };
<a name="l05323"></a>05323 
<a name="l05324"></a>05324    <span class="keywordtype">char</span> interfacevar[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l05325"></a>05325    <span class="keywordtype">float</span> sl = 0;
<a name="l05326"></a>05326 
<a name="l05327"></a>05327    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l05328"></a>05328       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;%s requires an argument: queuename\n&quot;</span>, cmd);
<a name="l05329"></a>05329       <span class="keywordflow">return</span> -1;
<a name="l05330"></a>05330    }
<a name="l05331"></a>05331 
<a name="l05332"></a>05332    <span class="keywordflow">if</span> ((q = <a class="code" href="astobj2_8h.html#a804bb959fec31c062b3848316b8e80b1">ao2_t_find</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, &amp;tmpq, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>, <span class="stringliteral">&quot;Find for QUEUE() function&quot;</span>))) {
<a name="l05333"></a>05333       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l05334"></a>05334       <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a32794c302b9a60821d519f6d4d1e7885">setqueuevar</a>) {
<a name="l05335"></a>05335          sl = 0;
<a name="l05336"></a>05336          res = 0;
<a name="l05337"></a>05337 
<a name="l05338"></a>05338          <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a> &gt; 0) {
<a name="l05339"></a>05339             sl = 100 * ((float) q-&gt;<a class="code" href="structcall__queue.html#ad22c84b7016cae07c521dda4a74544f8">callscompletedinsl</a> / (<span class="keywordtype">float</span>) q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a>);
<a name="l05340"></a>05340          }
<a name="l05341"></a>05341 
<a name="l05342"></a>05342          snprintf(interfacevar, <span class="keyword">sizeof</span>(interfacevar),
<a name="l05343"></a>05343             <span class="stringliteral">&quot;QUEUEMAX=%d,QUEUESTRATEGY=%s,QUEUECALLS=%d,QUEUEHOLDTIME=%d,QUEUETALKTIME=%d,QUEUECOMPLETED=%d,QUEUEABANDONED=%d,QUEUESRVLEVEL=%d,QUEUESRVLEVELPERF=%2.1f&quot;</span>,
<a name="l05344"></a>05344             q-&gt;<a class="code" href="structcall__queue.html#a245b5bee0d02a20222d815dbeaaac0fb">maxlen</a>, <a class="code" href="app__queue_8c.html#a792b5d8a5231db2f05b08bd73d318ea5">int2strat</a>(q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a>), q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>, q-&gt;<a class="code" href="structcall__queue.html#aebac91dc9bbd110e44f8ffa9f2e697d1">holdtime</a>, q-&gt;<a class="code" href="structcall__queue.html#a080da53416fe93b51940797285eeee5c">talktime</a>, q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a>, q-&gt;<a class="code" href="structcall__queue.html#a8c3a63527e11cef32f7e5aae9f3f270f">callsabandoned</a>,  q-&gt;<a class="code" href="structcall__queue.html#a6293d1622ff45ccac3a1679171376856">servicelevel</a>, sl);
<a name="l05345"></a>05345 
<a name="l05346"></a>05346          <a class="code" href="pbx_8h.html#a990bfc8582dc017423d8518bcc110a2c" title="Parse and set multiple channel variables, where the pairs are separated by the &amp;#39;...">pbx_builtin_setvar_multiple</a>(chan, interfacevar);
<a name="l05347"></a>05347       }
<a name="l05348"></a>05348 
<a name="l05349"></a>05349       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l05350"></a>05350       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with QUEUE() function&quot;</span>);
<a name="l05351"></a>05351    } <span class="keywordflow">else</span> {
<a name="l05352"></a>05352       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;queue %s was not found\n&quot;</span>, data);
<a name="l05353"></a>05353    }
<a name="l05354"></a>05354 
<a name="l05355"></a>05355    snprintf(buf, len, <span class="stringliteral">&quot;%d&quot;</span>, res);
<a name="l05356"></a>05356 
<a name="l05357"></a>05357    <span class="keywordflow">return</span> 0;
<a name="l05358"></a>05358 }
<a name="l05359"></a>05359 <span class="comment"></span>
<a name="l05360"></a>05360 <span class="comment">/*! </span>
<a name="l05361"></a>05361 <span class="comment"> * \brief Get number either busy / free or total members of a specific queue</span>
<a name="l05362"></a>05362 <span class="comment"> * \retval number of members (busy / free / total)</span>
<a name="l05363"></a>05363 <span class="comment"> * \retval -1 on error</span>
<a name="l05364"></a>05364 <span class="comment">*/</span>
<a name="l05365"></a><a class="code" href="app__queue_8c.html#a0d500489ea7e1bccec9bf39d9d2978da">05365</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a0d500489ea7e1bccec9bf39d9d2978da" title="Get number either busy / free or total members of a specific queue.">queue_function_qac</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l05366"></a>05366 {
<a name="l05367"></a>05367    <span class="keywordtype">int</span> <a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> = 0;
<a name="l05368"></a>05368    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *m;
<a name="l05369"></a>05369    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l05370"></a>05370    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l05371"></a>05371    <span class="keywordtype">char</span> *option;
<a name="l05372"></a>05372 
<a name="l05373"></a>05373    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l05374"></a>05374       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;%s requires an argument: queuename\n&quot;</span>, cmd);
<a name="l05375"></a>05375       <span class="keywordflow">return</span> -1;
<a name="l05376"></a>05376    }
<a name="l05377"></a>05377 
<a name="l05378"></a>05378    <span class="keywordflow">if</span> ((option = strchr(data, <span class="charliteral">&apos;,&apos;</span>)))
<a name="l05379"></a>05379       *option++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05380"></a>05380    <span class="keywordflow">else</span>
<a name="l05381"></a>05381       option = <span class="stringliteral">&quot;logged&quot;</span>;
<a name="l05382"></a>05382    <span class="keywordflow">if</span> ((q = <a class="code" href="app__queue_8c.html#a9944f03f3b77344b38927628150d3ab7">load_realtime_queue</a>(data))) {
<a name="l05383"></a>05383       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l05384"></a>05384       <span class="keywordflow">if</span> (!strcasecmp(option, <span class="stringliteral">&quot;logged&quot;</span>)) {
<a name="l05385"></a>05385          mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l05386"></a>05386          <span class="keywordflow">while</span> ((m = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l05387"></a>05387             <span class="comment">/* Count the agents who are logged in and presently answering calls */</span>
<a name="l05388"></a>05388             <span class="keywordflow">if</span> ((m-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> != <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>) &amp;&amp; (m-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> != <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>)) {
<a name="l05389"></a>05389                count++;
<a name="l05390"></a>05390             }
<a name="l05391"></a>05391             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l05392"></a>05392          }
<a name="l05393"></a>05393          <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l05394"></a>05394       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(option, <span class="stringliteral">&quot;free&quot;</span>)) {
<a name="l05395"></a>05395          mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l05396"></a>05396          <span class="keywordflow">while</span> ((m = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l05397"></a>05397             <span class="comment">/* Count the agents who are logged in and presently answering calls */</span>
<a name="l05398"></a>05398             <span class="keywordflow">if</span> ((m-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> == <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>) &amp;&amp; (!m-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a>)) {
<a name="l05399"></a>05399                count++;
<a name="l05400"></a>05400             }
<a name="l05401"></a>05401             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l05402"></a>05402          }
<a name="l05403"></a>05403          <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l05404"></a>05404       } <span class="keywordflow">else</span> <span class="comment">/* must be &quot;count&quot; */</span>
<a name="l05405"></a>05405          count = q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>;
<a name="l05406"></a>05406       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l05407"></a>05407       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with temporary reference in QUEUE_MEMBER()&quot;</span>);
<a name="l05408"></a>05408    } <span class="keywordflow">else</span>
<a name="l05409"></a>05409       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;queue %s was not found\n&quot;</span>, data);
<a name="l05410"></a>05410 
<a name="l05411"></a>05411    snprintf(buf, len, <span class="stringliteral">&quot;%d&quot;</span>, count);
<a name="l05412"></a>05412 
<a name="l05413"></a>05413    <span class="keywordflow">return</span> 0;
<a name="l05414"></a>05414 }
<a name="l05415"></a>05415 <span class="comment"></span>
<a name="l05416"></a>05416 <span class="comment">/*! </span>
<a name="l05417"></a>05417 <span class="comment"> * \brief Get the total number of members in a specific queue (Deprecated)</span>
<a name="l05418"></a>05418 <span class="comment"> * \retval number of members </span>
<a name="l05419"></a>05419 <span class="comment"> * \retval -1 on error </span>
<a name="l05420"></a>05420 <span class="comment">*/</span>
<a name="l05421"></a><a class="code" href="app__queue_8c.html#aa08d109f431a880fd7c401d6f2e58d25">05421</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#aa08d109f431a880fd7c401d6f2e58d25" title="Get the total number of members in a specific queue (Deprecated).">queue_function_qac_dep</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l05422"></a>05422 {
<a name="l05423"></a>05423    <span class="keywordtype">int</span> <a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> = 0;
<a name="l05424"></a>05424    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *m;
<a name="l05425"></a>05425    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l05426"></a>05426    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l05427"></a>05427    <span class="keyword">static</span> <span class="keywordtype">int</span> depflag = 1;
<a name="l05428"></a>05428 
<a name="l05429"></a>05429    <span class="keywordflow">if</span> (depflag) {
<a name="l05430"></a>05430       depflag = 0;
<a name="l05431"></a>05431       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;The function QUEUE_MEMBER_COUNT has been deprecated in favor of the QUEUE_MEMBER function and will not be in further releases.\n&quot;</span>);
<a name="l05432"></a>05432    }
<a name="l05433"></a>05433 
<a name="l05434"></a>05434    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l05435"></a>05435       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;%s requires an argument: queuename\n&quot;</span>, cmd);
<a name="l05436"></a>05436       <span class="keywordflow">return</span> -1;
<a name="l05437"></a>05437    }
<a name="l05438"></a>05438    
<a name="l05439"></a>05439    <span class="keywordflow">if</span> ((q = <a class="code" href="app__queue_8c.html#a9944f03f3b77344b38927628150d3ab7">load_realtime_queue</a>(data))) {
<a name="l05440"></a>05440       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l05441"></a>05441       mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l05442"></a>05442       <span class="keywordflow">while</span> ((m = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l05443"></a>05443          <span class="comment">/* Count the agents who are logged in and presently answering calls */</span>
<a name="l05444"></a>05444          <span class="keywordflow">if</span> ((m-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> != <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>) &amp;&amp; (m-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> != <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>)) {
<a name="l05445"></a>05445             count++;
<a name="l05446"></a>05446          }
<a name="l05447"></a>05447          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l05448"></a>05448       }
<a name="l05449"></a>05449       <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l05450"></a>05450       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l05451"></a>05451       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with temporary reference in QUEUE_MEMBER_COUNT&quot;</span>);
<a name="l05452"></a>05452    } <span class="keywordflow">else</span>
<a name="l05453"></a>05453       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;queue %s was not found\n&quot;</span>, data);
<a name="l05454"></a>05454 
<a name="l05455"></a>05455    snprintf(buf, len, <span class="stringliteral">&quot;%d&quot;</span>, count);
<a name="l05456"></a>05456 
<a name="l05457"></a>05457    <span class="keywordflow">return</span> 0;
<a name="l05458"></a>05458 }
<a name="l05459"></a>05459 <span class="comment"></span>
<a name="l05460"></a>05460 <span class="comment">/*! \brief Dialplan function QUEUE_WAITING_COUNT() Get number callers waiting in a specific queue */</span>
<a name="l05461"></a><a class="code" href="app__queue_8c.html#ab058e7cb09a0800bc35a1db2053de820">05461</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ab058e7cb09a0800bc35a1db2053de820" title="Dialplan function QUEUE_WAITING_COUNT() Get number callers waiting in a specific...">queue_function_queuewaitingcount</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l05462"></a>05462 {
<a name="l05463"></a>05463    <span class="keywordtype">int</span> count = 0;
<a name="l05464"></a>05464    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q, tmpq = {
<a name="l05465"></a>05465       .name = data,  
<a name="l05466"></a>05466    };
<a name="l05467"></a>05467    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a> = NULL;
<a name="l05468"></a>05468 
<a name="l05469"></a>05469    buf[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05470"></a>05470    
<a name="l05471"></a>05471    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l05472"></a>05472       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;QUEUE_WAITING_COUNT requires an argument: queuename\n&quot;</span>);
<a name="l05473"></a>05473       <span class="keywordflow">return</span> -1;
<a name="l05474"></a>05474    }
<a name="l05475"></a>05475 
<a name="l05476"></a>05476    <span class="keywordflow">if</span> ((q = <a class="code" href="astobj2_8h.html#a804bb959fec31c062b3848316b8e80b1">ao2_t_find</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, &amp;tmpq, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>, <span class="stringliteral">&quot;Find for QUEUE_WAITING_COUNT()&quot;</span>))) {
<a name="l05477"></a>05477       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l05478"></a>05478       count = q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>;
<a name="l05479"></a>05479       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l05480"></a>05480       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with reference in QUEUE_WAITING_COUNT()&quot;</span>);
<a name="l05481"></a>05481    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;queues&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, data, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>))) {
<a name="l05482"></a>05482       <span class="comment">/* if the queue is realtime but was not found in memory, this</span>
<a name="l05483"></a>05483 <span class="comment">       * means that the queue had been deleted from memory since it was </span>
<a name="l05484"></a>05484 <span class="comment">       * &quot;dead.&quot; This means it has a 0 waiting count</span>
<a name="l05485"></a>05485 <span class="comment">       */</span>
<a name="l05486"></a>05486       count = 0;
<a name="l05487"></a>05487       <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l05488"></a>05488    } <span class="keywordflow">else</span>
<a name="l05489"></a>05489       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;queue %s was not found\n&quot;</span>, data);
<a name="l05490"></a>05490 
<a name="l05491"></a>05491    snprintf(buf, len, <span class="stringliteral">&quot;%d&quot;</span>, count);
<a name="l05492"></a>05492 
<a name="l05493"></a>05493    <span class="keywordflow">return</span> 0;
<a name="l05494"></a>05494 }
<a name="l05495"></a>05495 <span class="comment"></span>
<a name="l05496"></a>05496 <span class="comment">/*! \brief Dialplan function QUEUE_MEMBER_LIST() Get list of members in a specific queue */</span>
<a name="l05497"></a><a class="code" href="app__queue_8c.html#a47a9a7eb9151809e5e86948c146bee2e">05497</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a47a9a7eb9151809e5e86948c146bee2e" title="Dialplan function QUEUE_MEMBER_LIST() Get list of members in a specific queue.">queue_function_queuememberlist</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l05498"></a>05498 {
<a name="l05499"></a>05499    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q, tmpq = {
<a name="l05500"></a>05500       .name = data,  
<a name="l05501"></a>05501    };
<a name="l05502"></a>05502    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *m;
<a name="l05503"></a>05503 
<a name="l05504"></a>05504    <span class="comment">/* Ensure an otherwise empty list doesn&apos;t return garbage */</span>
<a name="l05505"></a>05505    buf[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05506"></a>05506 
<a name="l05507"></a>05507    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l05508"></a>05508       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;QUEUE_MEMBER_LIST requires an argument: queuename\n&quot;</span>);
<a name="l05509"></a>05509       <span class="keywordflow">return</span> -1;
<a name="l05510"></a>05510    }
<a name="l05511"></a>05511 
<a name="l05512"></a>05512    <span class="keywordflow">if</span> ((q = <a class="code" href="astobj2_8h.html#a804bb959fec31c062b3848316b8e80b1">ao2_t_find</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, &amp;tmpq, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>, <span class="stringliteral">&quot;Find for QUEUE_MEMBER_LIST()&quot;</span>))) {
<a name="l05513"></a>05513       <span class="keywordtype">int</span> buflen = 0, count = 0;
<a name="l05514"></a>05514       <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l05515"></a>05515 
<a name="l05516"></a>05516       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l05517"></a>05517       <span class="keywordflow">while</span> ((m = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l05518"></a>05518          <span class="comment">/* strcat() is always faster than printf() */</span>
<a name="l05519"></a>05519          <span class="keywordflow">if</span> (count++) {
<a name="l05520"></a>05520             strncat(buf + buflen, <span class="stringliteral">&quot;,&quot;</span>, len - buflen - 1);
<a name="l05521"></a>05521             buflen++;
<a name="l05522"></a>05522          }
<a name="l05523"></a>05523          strncat(buf + buflen, m-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, len - buflen - 1);
<a name="l05524"></a>05524          buflen += strlen(m-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>);
<a name="l05525"></a>05525          <span class="comment">/* Safeguard against overflow (negative length) */</span>
<a name="l05526"></a>05526          <span class="keywordflow">if</span> (buflen &gt;= len - 2) {
<a name="l05527"></a>05527             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l05528"></a>05528             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Truncating list\n&quot;</span>);
<a name="l05529"></a>05529             <span class="keywordflow">break</span>;
<a name="l05530"></a>05530          }
<a name="l05531"></a>05531          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l05532"></a>05532       }
<a name="l05533"></a>05533       <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l05534"></a>05534       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l05535"></a>05535       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with QUEUE_MEMBER_LIST()&quot;</span>);
<a name="l05536"></a>05536    } <span class="keywordflow">else</span>
<a name="l05537"></a>05537       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;queue %s was not found\n&quot;</span>, data);
<a name="l05538"></a>05538 
<a name="l05539"></a>05539    <span class="comment">/* We should already be terminated, but let&apos;s make sure. */</span>
<a name="l05540"></a>05540    buf[len - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05541"></a>05541 
<a name="l05542"></a>05542    <span class="keywordflow">return</span> 0;
<a name="l05543"></a>05543 }
<a name="l05544"></a>05544 <span class="comment"></span>
<a name="l05545"></a>05545 <span class="comment">/*! \brief Dialplan function QUEUE_MEMBER_PENALTY() Gets the members penalty. */</span>
<a name="l05546"></a><a class="code" href="app__queue_8c.html#a332b673addb088061273b81df018d7ac">05546</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a332b673addb088061273b81df018d7ac" title="Dialplan function QUEUE_MEMBER_PENALTY() Gets the members penalty.">queue_function_memberpenalty_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l05547"></a>05547 {
<a name="l05548"></a>05548    <span class="keywordtype">int</span> penalty;
<a name="l05549"></a>05549    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l05550"></a>05550       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(queuename);
<a name="l05551"></a>05551       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(interface);
<a name="l05552"></a>05552    );
<a name="l05553"></a>05553    <span class="comment">/* Make sure the returned value on error is NULL. */</span>
<a name="l05554"></a>05554    buf[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05555"></a>05555 
<a name="l05556"></a>05556    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l05557"></a>05557       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Missing argument. QUEUE_MEMBER_PENALTY(&lt;queuename&gt;,&lt;interface&gt;)\n&quot;</span>);
<a name="l05558"></a>05558       <span class="keywordflow">return</span> -1;
<a name="l05559"></a>05559    }
<a name="l05560"></a>05560 
<a name="l05561"></a>05561    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, data);
<a name="l05562"></a>05562 
<a name="l05563"></a>05563    <span class="keywordflow">if</span> (args.argc &lt; 2) {
<a name="l05564"></a>05564       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Missing argument. QUEUE_MEMBER_PENALTY(&lt;queuename&gt;,&lt;interface&gt;)\n&quot;</span>);
<a name="l05565"></a>05565       <span class="keywordflow">return</span> -1;
<a name="l05566"></a>05566    }
<a name="l05567"></a>05567 
<a name="l05568"></a>05568    penalty = <a class="code" href="app__queue_8c.html#a6fdd4581a4a8945d35a54bb170b21ac6">get_member_penalty</a> (args.queuename, args.interface);
<a name="l05569"></a>05569    
<a name="l05570"></a>05570    <span class="keywordflow">if</span> (penalty &gt;= 0) <span class="comment">/* remember that buf is already &apos;\0&apos; */</span>
<a name="l05571"></a>05571       snprintf (buf, len, <span class="stringliteral">&quot;%d&quot;</span>, penalty);
<a name="l05572"></a>05572 
<a name="l05573"></a>05573    <span class="keywordflow">return</span> 0;
<a name="l05574"></a>05574 }
<a name="l05575"></a>05575 <span class="comment"></span>
<a name="l05576"></a>05576 <span class="comment">/*! \brief Dialplan function QUEUE_MEMBER_PENALTY() Sets the members penalty. */</span>
<a name="l05577"></a><a class="code" href="app__queue_8c.html#ad4e6d4309c0c90061cdc3d10adb669a0">05577</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ad4e6d4309c0c90061cdc3d10adb669a0" title="Dialplan function QUEUE_MEMBER_PENALTY() Sets the members penalty.">queue_function_memberpenalty_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *data, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l05578"></a>05578 {
<a name="l05579"></a>05579    <span class="keywordtype">int</span> penalty;
<a name="l05580"></a>05580    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l05581"></a>05581       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(queuename);
<a name="l05582"></a>05582       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(interface);
<a name="l05583"></a>05583    );
<a name="l05584"></a>05584 
<a name="l05585"></a>05585    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l05586"></a>05586       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Missing argument. QUEUE_MEMBER_PENALTY(&lt;queuename&gt;,&lt;interface&gt;)\n&quot;</span>);
<a name="l05587"></a>05587       <span class="keywordflow">return</span> -1;
<a name="l05588"></a>05588    }
<a name="l05589"></a>05589 
<a name="l05590"></a>05590    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, data);
<a name="l05591"></a>05591 
<a name="l05592"></a>05592    <span class="keywordflow">if</span> (args.argc &lt; 2) {
<a name="l05593"></a>05593       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Missing argument. QUEUE_MEMBER_PENALTY(&lt;queuename&gt;,&lt;interface&gt;)\n&quot;</span>);
<a name="l05594"></a>05594       <span class="keywordflow">return</span> -1;
<a name="l05595"></a>05595    }
<a name="l05596"></a>05596 
<a name="l05597"></a>05597    penalty = atoi(value);
<a name="l05598"></a>05598 
<a name="l05599"></a>05599    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.interface)) {
<a name="l05600"></a>05600       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;&lt;interface&gt; parameter can&apos;t be null\n&quot;</span>);
<a name="l05601"></a>05601       <span class="keywordflow">return</span> -1;
<a name="l05602"></a>05602    }
<a name="l05603"></a>05603 
<a name="l05604"></a>05604    <span class="comment">/* if queuename = NULL then penalty will be set for interface in all the queues. */</span>
<a name="l05605"></a>05605    <span class="keywordflow">if</span> (<a class="code" href="app__queue_8c.html#a214853f4f35145fe0c543edae51469b0">set_member_penalty</a>(args.queuename, args.interface, penalty)) {
<a name="l05606"></a>05606       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid interface, queue or penalty\n&quot;</span>);
<a name="l05607"></a>05607       <span class="keywordflow">return</span> -1;
<a name="l05608"></a>05608    }
<a name="l05609"></a>05609 
<a name="l05610"></a>05610    <span class="keywordflow">return</span> 0;
<a name="l05611"></a>05611 }
<a name="l05612"></a>05612 
<a name="l05613"></a><a class="code" href="app__queue_8c.html#a030c82755a6b35bb25eb912920d997ba">05613</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="app__queue_8c.html#a030c82755a6b35bb25eb912920d997ba">queuevar_function</a> = {
<a name="l05614"></a>05614    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;QUEUE_VARIABLES&quot;</span>,
<a name="l05615"></a>05615    .read = <a class="code" href="app__queue_8c.html#a7b254b14693f1f30d4ddd615d7f777b9" title="create interface var with all queue details.">queue_function_var</a>,
<a name="l05616"></a>05616 };
<a name="l05617"></a>05617 
<a name="l05618"></a><a class="code" href="app__queue_8c.html#a23c0aa9ae2331c5f79a8e7a998a20ea0">05618</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="app__queue_8c.html#a23c0aa9ae2331c5f79a8e7a998a20ea0">queuemembercount_function</a> = {
<a name="l05619"></a>05619    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;QUEUE_MEMBER&quot;</span>,
<a name="l05620"></a>05620    .read = <a class="code" href="app__queue_8c.html#a0d500489ea7e1bccec9bf39d9d2978da" title="Get number either busy / free or total members of a specific queue.">queue_function_qac</a>,
<a name="l05621"></a>05621 };
<a name="l05622"></a>05622 
<a name="l05623"></a><a class="code" href="app__queue_8c.html#ad6116b09b58e795dd72862b6c5a6d140">05623</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="app__queue_8c.html#ad6116b09b58e795dd72862b6c5a6d140">queuemembercount_dep</a> = {
<a name="l05624"></a>05624    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;QUEUE_MEMBER_COUNT&quot;</span>,
<a name="l05625"></a>05625    .read = <a class="code" href="app__queue_8c.html#aa08d109f431a880fd7c401d6f2e58d25" title="Get the total number of members in a specific queue (Deprecated).">queue_function_qac_dep</a>,
<a name="l05626"></a>05626 };
<a name="l05627"></a>05627 
<a name="l05628"></a><a class="code" href="app__queue_8c.html#a244749c3d8b00d8ad1c335cf2cd2e54c">05628</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="app__queue_8c.html#a244749c3d8b00d8ad1c335cf2cd2e54c">queuewaitingcount_function</a> = {
<a name="l05629"></a>05629    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;QUEUE_WAITING_COUNT&quot;</span>,
<a name="l05630"></a>05630    .read = <a class="code" href="app__queue_8c.html#ab058e7cb09a0800bc35a1db2053de820" title="Dialplan function QUEUE_WAITING_COUNT() Get number callers waiting in a specific...">queue_function_queuewaitingcount</a>,
<a name="l05631"></a>05631 };
<a name="l05632"></a>05632 
<a name="l05633"></a><a class="code" href="app__queue_8c.html#a2ae3e4026ef50c6dbe7de7bae5023d15">05633</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="app__queue_8c.html#a2ae3e4026ef50c6dbe7de7bae5023d15">queuememberlist_function</a> = {
<a name="l05634"></a>05634    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;QUEUE_MEMBER_LIST&quot;</span>,
<a name="l05635"></a>05635    .read = <a class="code" href="app__queue_8c.html#a47a9a7eb9151809e5e86948c146bee2e" title="Dialplan function QUEUE_MEMBER_LIST() Get list of members in a specific queue.">queue_function_queuememberlist</a>,
<a name="l05636"></a>05636 };
<a name="l05637"></a>05637 
<a name="l05638"></a><a class="code" href="app__queue_8c.html#a9827f040c8a8bbf13b82b6098c0e7d25">05638</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="app__queue_8c.html#a9827f040c8a8bbf13b82b6098c0e7d25">queuememberpenalty_function</a> = {
<a name="l05639"></a>05639    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;QUEUE_MEMBER_PENALTY&quot;</span>,
<a name="l05640"></a>05640    .read = <a class="code" href="app__queue_8c.html#a332b673addb088061273b81df018d7ac" title="Dialplan function QUEUE_MEMBER_PENALTY() Gets the members penalty.">queue_function_memberpenalty_read</a>,
<a name="l05641"></a>05641    .write = <a class="code" href="app__queue_8c.html#ad4e6d4309c0c90061cdc3d10adb669a0" title="Dialplan function QUEUE_MEMBER_PENALTY() Sets the members penalty.">queue_function_memberpenalty_write</a>,
<a name="l05642"></a>05642 };
<a name="l05643"></a>05643 <span class="comment"></span>
<a name="l05644"></a>05644 <span class="comment">/*! \brief Reload the rules defined in queuerules.conf</span>
<a name="l05645"></a>05645 <span class="comment"> *</span>
<a name="l05646"></a>05646 <span class="comment"> * \param reload If 1, then only process queuerules.conf if the file</span>
<a name="l05647"></a>05647 <span class="comment"> * has changed since the last time we inspected it.</span>
<a name="l05648"></a>05648 <span class="comment"> * \return Always returns AST_MODULE_LOAD_SUCCESS</span>
<a name="l05649"></a>05649 <span class="comment"> */</span>
<a name="l05650"></a><a class="code" href="app__queue_8c.html#a7c735420578948b9097fbf5dc71a094c">05650</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a7c735420578948b9097fbf5dc71a094c" title="Reload the rules defined in queuerules.conf.">reload_queue_rules</a>(<span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l05651"></a>05651 {
<a name="l05652"></a>05652    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l05653"></a>05653    <span class="keyword">struct </span>rule_list *rl_iter, *new_rl;
<a name="l05654"></a>05654    <span class="keyword">struct </span><a class="code" href="structpenalty__rule.html">penalty_rule</a> *pr_iter;
<a name="l05655"></a>05655    <span class="keywordtype">char</span> *rulecat = NULL;
<a name="l05656"></a>05656    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *rulevar = NULL;
<a name="l05657"></a>05657    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { reload ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l05658"></a>05658    
<a name="l05659"></a>05659    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;queuerules.conf&quot;</span>, config_flags))) {
<a name="l05660"></a>05660       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No queuerules.conf file found, queues will not follow penalty rules\n&quot;</span>);
<a name="l05661"></a>05661       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l05662"></a>05662    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {
<a name="l05663"></a>05663       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;queuerules.conf has not changed since it was last loaded. Not taking any action.\n&quot;</span>);
<a name="l05664"></a>05664       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l05665"></a>05665    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l05666"></a>05666       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file queuerules.conf is in an invalid format.  Aborting.\n&quot;</span>);
<a name="l05667"></a>05667       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l05668"></a>05668    }
<a name="l05669"></a>05669 
<a name="l05670"></a>05670    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;rule_lists);
<a name="l05671"></a>05671    <span class="keywordflow">while</span> ((rl_iter = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;rule_lists, list))) {
<a name="l05672"></a>05672       <span class="keywordflow">while</span> ((pr_iter = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;rl_iter-&gt;rules, list)))
<a name="l05673"></a>05673          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(pr_iter);
<a name="l05674"></a>05674       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(rl_iter);
<a name="l05675"></a>05675    }
<a name="l05676"></a>05676    <span class="keywordflow">while</span> ((rulecat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, rulecat))) {
<a name="l05677"></a>05677       <span class="keywordflow">if</span> (!(new_rl = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*new_rl)))) {
<a name="l05678"></a>05678          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;rule_lists);
<a name="l05679"></a>05679          <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l05680"></a>05680       } <span class="keywordflow">else</span> {
<a name="l05681"></a>05681          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(new_rl-&gt;<a class="code" href="structrule__list.html#a3777dbae63a15da001b2baa317a25149">name</a>, rulecat, <span class="keyword">sizeof</span>(new_rl-&gt;<a class="code" href="structrule__list.html#a3777dbae63a15da001b2baa317a25149">name</a>));
<a name="l05682"></a>05682          <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;rule_lists, new_rl, list);
<a name="l05683"></a>05683          <span class="keywordflow">for</span> (rulevar = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, rulecat); rulevar; rulevar = rulevar-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>)
<a name="l05684"></a>05684             <span class="keywordflow">if</span>(!strcasecmp(rulevar-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;penaltychange&quot;</span>))
<a name="l05685"></a>05685                <a class="code" href="app__queue_8c.html#ab7086bc4304099aec95794ea6ed63260" title="Change queue penalty by adding rule.">insert_penaltychange</a>(new_rl-&gt;<a class="code" href="structrule__list.html#a3777dbae63a15da001b2baa317a25149">name</a>, rulevar-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, rulevar-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l05686"></a>05686             <span class="keywordflow">else</span>
<a name="l05687"></a>05687                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Don&apos;t know how to handle rule type &apos;%s&apos; on line %d\n&quot;</span>, rulevar-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, rulevar-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l05688"></a>05688       }
<a name="l05689"></a>05689    }
<a name="l05690"></a>05690    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;rule_lists);
<a name="l05691"></a>05691 
<a name="l05692"></a>05692    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l05693"></a>05693 
<a name="l05694"></a>05694    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l05695"></a>05695 }
<a name="l05696"></a>05696 <span class="comment"></span>
<a name="l05697"></a>05697 <span class="comment">/*! Set the global queue parameters as defined in the &quot;general&quot; section of queues.conf */</span>
<a name="l05698"></a><a class="code" href="app__queue_8c.html#a49cb6663a6fd8f3f40808206df196722">05698</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a49cb6663a6fd8f3f40808206df196722">queue_set_global_params</a>(<span class="keyword">struct</span> <a class="code" href="structast__config.html">ast_config</a> *cfg)
<a name="l05699"></a>05699 {
<a name="l05700"></a>05700    <span class="keyword">const</span> <span class="keywordtype">char</span> *general_val = NULL;
<a name="l05701"></a>05701    queue_persistent_members = 0;
<a name="l05702"></a>05702    <span class="keywordflow">if</span> ((general_val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;persistentmembers&quot;</span>)))
<a name="l05703"></a>05703       queue_persistent_members = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(general_val);
<a name="l05704"></a>05704    autofill_default = 0;
<a name="l05705"></a>05705    <span class="keywordflow">if</span> ((general_val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;autofill&quot;</span>)))
<a name="l05706"></a>05706       autofill_default = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(general_val);
<a name="l05707"></a>05707    montype_default = 0;
<a name="l05708"></a>05708    <span class="keywordflow">if</span> ((general_val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;monitor-type&quot;</span>))) {
<a name="l05709"></a>05709       <span class="keywordflow">if</span> (!strcasecmp(general_val, <span class="stringliteral">&quot;mixmonitor&quot;</span>))
<a name="l05710"></a>05710          montype_default = 1;
<a name="l05711"></a>05711    }
<a name="l05712"></a>05712    update_cdr = 0;
<a name="l05713"></a>05713    <span class="keywordflow">if</span> ((general_val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;updatecdr&quot;</span>)))
<a name="l05714"></a>05714       update_cdr = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(general_val);
<a name="l05715"></a>05715    shared_lastcall = 0;
<a name="l05716"></a>05716    <span class="keywordflow">if</span> ((general_val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;shared_lastcall&quot;</span>)))
<a name="l05717"></a>05717       shared_lastcall = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(general_val);
<a name="l05718"></a>05718 }
<a name="l05719"></a>05719 <span class="comment"></span>
<a name="l05720"></a>05720 <span class="comment">/*! \brief reload information pertaining to a single member</span>
<a name="l05721"></a>05721 <span class="comment"> *</span>
<a name="l05722"></a>05722 <span class="comment"> * This function is called when a member = line is encountered in</span>
<a name="l05723"></a>05723 <span class="comment"> * queues.conf.</span>
<a name="l05724"></a>05724 <span class="comment"> *</span>
<a name="l05725"></a>05725 <span class="comment"> * \param memberdata The part after member = in the config file</span>
<a name="l05726"></a>05726 <span class="comment"> * \param q The queue to which this member belongs</span>
<a name="l05727"></a>05727 <span class="comment"> */</span>
<a name="l05728"></a><a class="code" href="app__queue_8c.html#a39bf3539cac69a629428927d5228ec1d">05728</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a39bf3539cac69a629428927d5228ec1d" title="reload information pertaining to a single member">reload_single_member</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *memberdata, <span class="keyword">struct</span> <a class="code" href="structcall__queue.html">call_queue</a> *q)
<a name="l05729"></a>05729 {
<a name="l05730"></a>05730    <span class="keywordtype">char</span> *membername, *interface, *state_interface, *tmp;
<a name="l05731"></a>05731    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l05732"></a>05732    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *cur, *newm;
<a name="l05733"></a>05733    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> tmpmem;
<a name="l05734"></a>05734    <span class="keywordtype">int</span> <a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>;
<a name="l05735"></a>05735    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l05736"></a>05736       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(interface);
<a name="l05737"></a>05737       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(penalty);
<a name="l05738"></a>05738       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(membername);
<a name="l05739"></a>05739       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(state_interface);
<a name="l05740"></a>05740    );
<a name="l05741"></a>05741 
<a name="l05742"></a>05742    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(memberdata)) {
<a name="l05743"></a>05743       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Empty queue member definition. Moving on!\n&quot;</span>);
<a name="l05744"></a>05744       <span class="keywordflow">return</span>;
<a name="l05745"></a>05745    }
<a name="l05746"></a>05746 
<a name="l05747"></a>05747    <span class="comment">/* Add a new member */</span>
<a name="l05748"></a>05748    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(memberdata);
<a name="l05749"></a>05749             
<a name="l05750"></a>05750    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l05751"></a>05751 
<a name="l05752"></a>05752    interface = args.interface;
<a name="l05753"></a>05753    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.penalty)) {
<a name="l05754"></a>05754       tmp = args.penalty;
<a name="l05755"></a>05755       <a class="code" href="strings_8h.html#aeb1c54e6e100c63176d8e22b0d5ca865" title="Strip leading/trailing whitespace from a string.">ast_strip</a>(tmp);
<a name="l05756"></a>05756       penalty = atoi(tmp);
<a name="l05757"></a>05757       <span class="keywordflow">if</span> (penalty &lt; 0) {
<a name="l05758"></a>05758          penalty = 0;
<a name="l05759"></a>05759       }
<a name="l05760"></a>05760    } <span class="keywordflow">else</span> {
<a name="l05761"></a>05761       penalty = 0;
<a name="l05762"></a>05762    }
<a name="l05763"></a>05763 
<a name="l05764"></a>05764    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.membername)) {
<a name="l05765"></a>05765       membername = args.membername;
<a name="l05766"></a>05766       <a class="code" href="strings_8h.html#aeb1c54e6e100c63176d8e22b0d5ca865" title="Strip leading/trailing whitespace from a string.">ast_strip</a>(membername);
<a name="l05767"></a>05767    } <span class="keywordflow">else</span> {
<a name="l05768"></a>05768       membername = interface;
<a name="l05769"></a>05769    }
<a name="l05770"></a>05770 
<a name="l05771"></a>05771    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.state_interface)) {
<a name="l05772"></a>05772       state_interface = args.state_interface;
<a name="l05773"></a>05773       <a class="code" href="strings_8h.html#aeb1c54e6e100c63176d8e22b0d5ca865" title="Strip leading/trailing whitespace from a string.">ast_strip</a>(state_interface);
<a name="l05774"></a>05774    } <span class="keywordflow">else</span> {
<a name="l05775"></a>05775       state_interface = interface;
<a name="l05776"></a>05776    }
<a name="l05777"></a>05777 
<a name="l05778"></a>05778    <span class="comment">/* Find the old position in the list */</span>
<a name="l05779"></a>05779    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmpmem.<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, interface, <span class="keyword">sizeof</span>(tmpmem.<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>));
<a name="l05780"></a>05780    cur = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, &amp;tmpmem, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca71f42ec6460e60eb6e10956c53329e45">OBJ_UNLINK</a>);
<a name="l05781"></a>05781    <span class="keywordflow">if</span> ((newm = <a class="code" href="app__queue_8c.html#a8cfa1185143485f4531932cf8970555e" title="allocate space for new queue member and set fields based on parameters passed">create_queue_member</a>(interface, membername, penalty, cur ? cur-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a> : 0, state_interface))) {
<a name="l05782"></a>05782       <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, newm);
<a name="l05783"></a>05783       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(newm, -1);
<a name="l05784"></a>05784    }
<a name="l05785"></a>05785    newm = NULL;
<a name="l05786"></a>05786 
<a name="l05787"></a>05787    <span class="keywordflow">if</span> (cur) {
<a name="l05788"></a>05788       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(cur, -1);
<a name="l05789"></a>05789    } <span class="keywordflow">else</span> {
<a name="l05790"></a>05790       q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>++;
<a name="l05791"></a>05791    }
<a name="l05792"></a>05792 }
<a name="l05793"></a>05793 
<a name="l05794"></a><a class="code" href="app__queue_8c.html#a2807f5312b497d9ccbb4c43f226d5c19">05794</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a2807f5312b497d9ccbb4c43f226d5c19">mark_member_dead</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l05795"></a>05795 {
<a name="l05796"></a>05796    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *<a class="code" href="structmember.html">member</a> = obj;
<a name="l05797"></a>05797    <span class="keywordflow">if</span> (!member-&gt;<a class="code" href="structmember.html#a44690a0a629211d7620ce0d55c412e9d">dynamic</a>) {
<a name="l05798"></a>05798       member-&gt;<a class="code" href="structmember.html#a22ed1f20028b26f7ece35aeec695293f">delme</a> = 1;
<a name="l05799"></a>05799    }
<a name="l05800"></a>05800    <span class="keywordflow">return</span> 0;
<a name="l05801"></a>05801 }
<a name="l05802"></a>05802 
<a name="l05803"></a><a class="code" href="app__queue_8c.html#aac7dfe864fa6fde0b2069f9aca32d9bf">05803</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#aac7dfe864fa6fde0b2069f9aca32d9bf">kill_dead_members</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l05804"></a>05804 {
<a name="l05805"></a>05805    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *<a class="code" href="structmember.html">member</a> = obj;
<a name="l05806"></a>05806    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q = arg;
<a name="l05807"></a>05807 
<a name="l05808"></a>05808    <span class="keywordflow">if</span> (!member-&gt;<a class="code" href="structmember.html#a22ed1f20028b26f7ece35aeec695293f">delme</a>) {
<a name="l05809"></a>05809       <span class="keywordflow">if</span> (member-&gt;<a class="code" href="structmember.html#a44690a0a629211d7620ce0d55c412e9d">dynamic</a>) {
<a name="l05810"></a>05810          <span class="comment">/* dynamic members were not counted toward the member count</span>
<a name="l05811"></a>05811 <span class="comment">          * when reloading members from queues.conf, so we do that here</span>
<a name="l05812"></a>05812 <span class="comment">          */</span>
<a name="l05813"></a>05813          q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>++;
<a name="l05814"></a>05814       }
<a name="l05815"></a>05815       member-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a>(member-&gt;<a class="code" href="structmember.html#affeb97abd64fdf01c6aa648c00513e52">state_interface</a>);
<a name="l05816"></a>05816       <span class="keywordflow">return</span> 0;
<a name="l05817"></a>05817    } <span class="keywordflow">else</span> {
<a name="l05818"></a>05818       q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a>--;
<a name="l05819"></a>05819       <span class="keywordflow">return</span> <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a>;
<a name="l05820"></a>05820    }
<a name="l05821"></a>05821 }
<a name="l05822"></a>05822 <span class="comment"></span>
<a name="l05823"></a>05823 <span class="comment">/*! \brief Reload information pertaining to a particular queue</span>
<a name="l05824"></a>05824 <span class="comment"> *</span>
<a name="l05825"></a>05825 <span class="comment"> * Once we have isolated a queue within reload_queues, we call this. This will either</span>
<a name="l05826"></a>05826 <span class="comment"> * reload information for the queue or if we&apos;re just reloading member information, we&apos;ll just</span>
<a name="l05827"></a>05827 <span class="comment"> * reload that without touching other settings within the queue </span>
<a name="l05828"></a>05828 <span class="comment"> *</span>
<a name="l05829"></a>05829 <span class="comment"> * \param cfg The configuration which we are reading</span>
<a name="l05830"></a>05830 <span class="comment"> * \param mask Tells us what information we need to reload</span>
<a name="l05831"></a>05831 <span class="comment"> * \param queuename The name of the queue we are reloading information from</span>
<a name="l05832"></a>05832 <span class="comment"> * \retval void</span>
<a name="l05833"></a>05833 <span class="comment"> */</span>
<a name="l05834"></a><a class="code" href="app__queue_8c.html#a3dcb3584df9f70680b14a8fb4d152e10">05834</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#a3dcb3584df9f70680b14a8fb4d152e10" title="Reload information pertaining to a particular queue.">reload_single_queue</a>(<span class="keyword">struct</span> <a class="code" href="structast__config.html">ast_config</a> *cfg, <span class="keyword">struct</span> <a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> *mask, <span class="keyword">const</span> <span class="keywordtype">char</span> *queuename)
<a name="l05835"></a>05835 {
<a name="l05836"></a>05836    <span class="keywordtype">int</span> <span class="keyword">new</span>;
<a name="l05837"></a>05837    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q = NULL;
<a name="l05838"></a>05838    <span class="comment">/*We&apos;re defining a queue*/</span>
<a name="l05839"></a>05839    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> tmpq = {
<a name="l05840"></a>05840       .name = queuename,
<a name="l05841"></a>05841    };
<a name="l05842"></a>05842    <span class="keyword">const</span> <span class="keywordtype">char</span> *tmpvar;
<a name="l05843"></a>05843    <span class="keyword">const</span> <span class="keywordtype">int</span> queue_reload = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(mask, <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398ab18e9313e34662b745beabef3ed7ca44">QUEUE_RELOAD_PARAMETERS</a>);
<a name="l05844"></a>05844    <span class="keyword">const</span> <span class="keywordtype">int</span> member_reload = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(mask, <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a4fc330b82c294649884cd4d189da8d5f">QUEUE_RELOAD_MEMBER</a>);
<a name="l05845"></a>05845    <span class="keywordtype">int</span> prev_weight = 0;
<a name="l05846"></a>05846    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l05847"></a>05847    <span class="keywordflow">if</span> (!(q = <a class="code" href="astobj2_8h.html#a804bb959fec31c062b3848316b8e80b1">ao2_t_find</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, &amp;tmpq, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>, <span class="stringliteral">&quot;Find queue for reload&quot;</span>))) {
<a name="l05848"></a>05848       <span class="keywordflow">if</span> (queue_reload) {
<a name="l05849"></a>05849          <span class="comment">/* Make one then */</span>
<a name="l05850"></a>05850          <span class="keywordflow">if</span> (!(q = <a class="code" href="app__queue_8c.html#a73f936847e6ad20cb842d03593dc47c4">alloc_queue</a>(queuename))) {
<a name="l05851"></a>05851             <span class="keywordflow">return</span>;
<a name="l05852"></a>05852          }
<a name="l05853"></a>05853       } <span class="keywordflow">else</span> {
<a name="l05854"></a>05854          <span class="comment">/* Since we&apos;re not reloading queues, this means that we found a queue</span>
<a name="l05855"></a>05855 <span class="comment">          * in the configuration file which we don&apos;t know about yet. Just return.</span>
<a name="l05856"></a>05856 <span class="comment">          */</span>
<a name="l05857"></a>05857          <span class="keywordflow">return</span>;
<a name="l05858"></a>05858       }
<a name="l05859"></a>05859       <span class="keyword">new</span> = 1;
<a name="l05860"></a>05860    } <span class="keywordflow">else</span> {
<a name="l05861"></a>05861       <span class="keyword">new</span> = 0;
<a name="l05862"></a>05862    }
<a name="l05863"></a>05863    
<a name="l05864"></a>05864    <span class="keywordflow">if</span> (!<span class="keyword">new</span>) {
<a name="l05865"></a>05865       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l05866"></a>05866       prev_weight = q-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a> ? 1 : 0;
<a name="l05867"></a>05867    }
<a name="l05868"></a>05868    <span class="comment">/* Check if we already found a queue with this name in the config file */</span>
<a name="l05869"></a>05869    <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a7dbc8370e15350314b041aad17f96706">found</a>) {
<a name="l05870"></a>05870       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Queue &apos;%s&apos; already defined! Skipping!\n&quot;</span>, queuename);
<a name="l05871"></a>05871       <span class="keywordflow">if</span> (!<span class="keyword">new</span>) {
<a name="l05872"></a>05872          <span class="comment">/* It should be impossible to *not* hit this case*/</span>
<a name="l05873"></a>05873          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l05874"></a>05874       }
<a name="l05875"></a>05875       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;We exist! Expiring temporary pointer&quot;</span>);
<a name="l05876"></a>05876       <span class="keywordflow">return</span>;
<a name="l05877"></a>05877    }
<a name="l05878"></a>05878    <span class="comment">/* Due to the fact that the &quot;linear&quot; strategy will have a different allocation</span>
<a name="l05879"></a>05879 <span class="comment">    * scheme for queue members, we must devise the queue&apos;s strategy before other initializations.</span>
<a name="l05880"></a>05880 <span class="comment">    * To be specific, the linear strategy needs to function like a linked list, meaning the ao2</span>
<a name="l05881"></a>05881 <span class="comment">    * container used will have only a single bucket instead of the typical number.</span>
<a name="l05882"></a>05882 <span class="comment">    */</span>
<a name="l05883"></a>05883    <span class="keywordflow">if</span> (queue_reload) {
<a name="l05884"></a>05884       <span class="keywordflow">if</span> ((tmpvar = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, queuename, <span class="stringliteral">&quot;strategy&quot;</span>))) {
<a name="l05885"></a>05885          q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> = <a class="code" href="app__queue_8c.html#aeee3b4385050286dedc0e20f247d428c">strat2int</a>(tmpvar);
<a name="l05886"></a>05886          <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> &lt; 0) {
<a name="l05887"></a>05887             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;&apos;%s&apos; isn&apos;t a valid strategy for queue &apos;%s&apos;, using ringall instead\n&quot;</span>,
<a name="l05888"></a>05888             tmpvar, q-&gt;name);
<a name="l05889"></a>05889             q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> = <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>;
<a name="l05890"></a>05890          }
<a name="l05891"></a>05891       } <span class="keywordflow">else</span> {
<a name="l05892"></a>05892          q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a> = <a class="code" href="app__queue_8c.html#a0ed680fdb405e7195d9f14032851eebba1af23b1ad5497875f46898f87c3da396">QUEUE_STRATEGY_RINGALL</a>;
<a name="l05893"></a>05893       }
<a name="l05894"></a>05894       <a class="code" href="app__queue_8c.html#aa76378a6ff09ce40268e214fdae6a61d" title="Initialize Queue default values.">init_queue</a>(q);
<a name="l05895"></a>05895    }
<a name="l05896"></a>05896    <span class="keywordflow">if</span> (member_reload) {
<a name="l05897"></a>05897       q-&gt;<a class="code" href="structcall__queue.html#a348ea754febc54ffc807a01e034a8e7f" title="Number of members _logged in_.">membercount</a> = 0;
<a name="l05898"></a>05898       <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a>, <a class="code" href="app__queue_8c.html#a2807f5312b497d9ccbb4c43f226d5c19">mark_member_dead</a>, NULL);
<a name="l05899"></a>05899    }
<a name="l05900"></a>05900    <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, queuename); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l05901"></a>05901       <span class="keywordflow">if</span> (member_reload &amp;&amp; !strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;member&quot;</span>)) {
<a name="l05902"></a>05902          <a class="code" href="app__queue_8c.html#a39bf3539cac69a629428927d5228ec1d" title="reload information pertaining to a single member">reload_single_member</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, q);
<a name="l05903"></a>05903       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (queue_reload) {
<a name="l05904"></a>05904          <a class="code" href="app__queue_8c.html#a94baaee180e6f6ae082418dc78e7c7cf" title="Configure a queue parameter.">queue_set_param</a>(q, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, var-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>, 1);
<a name="l05905"></a>05905       }
<a name="l05906"></a>05906    }
<a name="l05907"></a>05907    <span class="comment">/* At this point, we&apos;ve determined if the queue has a weight, so update use_weight</span>
<a name="l05908"></a>05908 <span class="comment">    * as appropriate</span>
<a name="l05909"></a>05909 <span class="comment">    */</span>
<a name="l05910"></a>05910    <span class="keywordflow">if</span> (!q-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a> &amp;&amp; prev_weight) {
<a name="l05911"></a>05911       <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;use_weight, -1);
<a name="l05912"></a>05912    }
<a name="l05913"></a>05913    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a> &amp;&amp; !prev_weight) {
<a name="l05914"></a>05914       <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;use_weight, +1);
<a name="l05915"></a>05915    }
<a name="l05916"></a>05916 
<a name="l05917"></a>05917    <span class="comment">/* Free remaining members marked as delme */</span>
<a name="l05918"></a>05918    <span class="keywordflow">if</span> (member_reload) {
<a name="l05919"></a>05919       <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca614744a4d36b3189d4ab5b02c8645d47">OBJ_MULTIPLE</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca71f42ec6460e60eb6e10956c53329e45">OBJ_UNLINK</a>, <a class="code" href="app__queue_8c.html#aac7dfe864fa6fde0b2069f9aca32d9bf">kill_dead_members</a>, q);
<a name="l05920"></a>05920    }
<a name="l05921"></a>05921 
<a name="l05922"></a>05922    <span class="keywordflow">if</span> (<span class="keyword">new</span>) {
<a name="l05923"></a>05923       <a class="code" href="app__queue_8c.html#a6d56dcc1f330ae7fe1b5a1ee832077c1">queues_t_link</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, q, <span class="stringliteral">&quot;Add queue to container&quot;</span>);
<a name="l05924"></a>05924    } <span class="keywordflow">else</span> {
<a name="l05925"></a>05925       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l05926"></a>05926    }
<a name="l05927"></a>05927    <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Expiring creation reference&quot;</span>);
<a name="l05928"></a>05928 }
<a name="l05929"></a>05929 
<a name="l05930"></a><a class="code" href="app__queue_8c.html#adf3d85aeb676b87a626939fc670677eb">05930</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#adf3d85aeb676b87a626939fc670677eb">mark_dead_and_unfound</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l05931"></a>05931 {
<a name="l05932"></a>05932    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q = obj;
<a name="l05933"></a>05933    <span class="keywordtype">char</span> *queuename = arg;
<a name="l05934"></a>05934    <span class="keywordflow">if</span> (!q-&gt;<a class="code" href="structcall__queue.html#a53e750a536c8270e37bbdd35a9def3d4">realtime</a> &amp;&amp; (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename) || !strcasecmp(queuename, q-&gt;name))) {
<a name="l05935"></a>05935       q-&gt;<a class="code" href="structcall__queue.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a> = 1;
<a name="l05936"></a>05936       q-&gt;<a class="code" href="structcall__queue.html#a7dbc8370e15350314b041aad17f96706">found</a> = 0;
<a name="l05937"></a>05937    }
<a name="l05938"></a>05938    <span class="keywordflow">return</span> 0;
<a name="l05939"></a>05939 }
<a name="l05940"></a>05940 
<a name="l05941"></a><a class="code" href="app__queue_8c.html#afee5aedcd47019bce3b7cca1f311056e">05941</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#afee5aedcd47019bce3b7cca1f311056e">kill_dead_queues</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l05942"></a>05942 {
<a name="l05943"></a>05943    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q = obj;
<a name="l05944"></a>05944    <span class="keywordtype">char</span> *queuename = arg;
<a name="l05945"></a>05945    <span class="keywordflow">if</span> ((<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename) || !strcasecmp(queuename, q-&gt;name)) &amp;&amp; q-&gt;<a class="code" href="structcall__queue.html#a1d67f434933f43ad9deb32da61dda2b6">dead</a>) {
<a name="l05946"></a>05946       <span class="keywordflow">return</span> <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a>;
<a name="l05947"></a>05947    } <span class="keywordflow">else</span> {
<a name="l05948"></a>05948       <span class="keywordflow">return</span> 0;
<a name="l05949"></a>05949    }
<a name="l05950"></a>05950 }
<a name="l05951"></a>05951 <span class="comment"></span>
<a name="l05952"></a>05952 <span class="comment">/*! \brief reload the queues.conf file</span>
<a name="l05953"></a>05953 <span class="comment"> *</span>
<a name="l05954"></a>05954 <span class="comment"> * This function reloads the information in the general section of the queues.conf</span>
<a name="l05955"></a>05955 <span class="comment"> * file and potentially more, depending on the value of mask.</span>
<a name="l05956"></a>05956 <span class="comment"> *</span>
<a name="l05957"></a>05957 <span class="comment"> * \param reload 0 if we are calling this the first time, 1 every other time</span>
<a name="l05958"></a>05958 <span class="comment"> * \param mask Gives flags telling us what information to actually reload</span>
<a name="l05959"></a>05959 <span class="comment"> * \param queuename If set to a non-zero string, then only reload information from</span>
<a name="l05960"></a>05960 <span class="comment"> * that particular queue. Otherwise inspect all queues</span>
<a name="l05961"></a>05961 <span class="comment"> * \retval -1 Failure occurred </span>
<a name="l05962"></a>05962 <span class="comment"> * \retval 0 All clear!</span>
<a name="l05963"></a>05963 <span class="comment"> */</span>
<a name="l05964"></a><a class="code" href="app__queue_8c.html#a3d172953bea29dc16fe1596eca35b186">05964</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a3d172953bea29dc16fe1596eca35b186" title="reload the queues.conf file">reload_queues</a>(<span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>, <span class="keyword">struct</span> <a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> *mask, <span class="keyword">const</span> <span class="keywordtype">char</span> *queuename)
<a name="l05965"></a>05965 {
<a name="l05966"></a>05966    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l05967"></a>05967    <span class="keywordtype">char</span> *cat;
<a name="l05968"></a>05968    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { reload ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l05969"></a>05969    <span class="keyword">const</span> <span class="keywordtype">int</span> queue_reload = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(mask, <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398ab18e9313e34662b745beabef3ed7ca44">QUEUE_RELOAD_PARAMETERS</a>);
<a name="l05970"></a>05970 
<a name="l05971"></a>05971    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;queues.conf&quot;</span>, config_flags))) {
<a name="l05972"></a>05972       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No call queueing config file (queues.conf), so no call queues\n&quot;</span>);
<a name="l05973"></a>05973       <span class="keywordflow">return</span> -1;
<a name="l05974"></a>05974    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {
<a name="l05975"></a>05975       <span class="keywordflow">return</span> 0;
<a name="l05976"></a>05976    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l05977"></a>05977       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file queues.conf is in an invalid format.  Aborting.\n&quot;</span>);
<a name="l05978"></a>05978       <span class="keywordflow">return</span> -1;
<a name="l05979"></a>05979    }
<a name="l05980"></a>05980 
<a name="l05981"></a>05981    <span class="comment">/* We&apos;ve made it here, so it looks like we&apos;re doing operations on all queues. */</span>
<a name="l05982"></a>05982    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l05983"></a>05983    
<a name="l05984"></a>05984    <span class="comment">/* Mark all queues as dead for the moment if we&apos;re reloading queues.</span>
<a name="l05985"></a>05985 <span class="comment">    * For clarity, we could just be reloading members, in which case we don&apos;t want to mess</span>
<a name="l05986"></a>05986 <span class="comment">    * with the other queue parameters at all*/</span>
<a name="l05987"></a>05987    <span class="keywordflow">if</span> (queue_reload) {
<a name="l05988"></a>05988       <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a>, <a class="code" href="app__queue_8c.html#adf3d85aeb676b87a626939fc670677eb">mark_dead_and_unfound</a>, (<span class="keywordtype">char</span> *) queuename);
<a name="l05989"></a>05989    }
<a name="l05990"></a>05990 
<a name="l05991"></a>05991    <span class="comment">/* Chug through config file */</span>
<a name="l05992"></a>05992    cat = NULL;
<a name="l05993"></a>05993    <span class="keywordflow">while</span> ((cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, cat)) ) {
<a name="l05994"></a>05994       <span class="keywordflow">if</span> (!strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>) &amp;&amp; queue_reload) {
<a name="l05995"></a>05995          <a class="code" href="app__queue_8c.html#a49cb6663a6fd8f3f40808206df196722">queue_set_global_params</a>(cfg);
<a name="l05996"></a>05996          <span class="keywordflow">continue</span>;
<a name="l05997"></a>05997       }
<a name="l05998"></a>05998       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename) || !strcasecmp(cat, queuename))
<a name="l05999"></a>05999          <a class="code" href="app__queue_8c.html#a3dcb3584df9f70680b14a8fb4d152e10" title="Reload information pertaining to a particular queue.">reload_single_queue</a>(cfg, mask, cat);
<a name="l06000"></a>06000    }
<a name="l06001"></a>06001 
<a name="l06002"></a>06002    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l06003"></a>06003    <span class="comment">/* Unref all the dead queues if we were reloading queues */</span>
<a name="l06004"></a>06004    <span class="keywordflow">if</span> (queue_reload) {
<a name="l06005"></a>06005       <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca614744a4d36b3189d4ab5b02c8645d47">OBJ_MULTIPLE</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca71f42ec6460e60eb6e10956c53329e45">OBJ_UNLINK</a>, <a class="code" href="app__queue_8c.html#afee5aedcd47019bce3b7cca1f311056e">kill_dead_queues</a>, (<span class="keywordtype">char</span> *) queuename);
<a name="l06006"></a>06006    }
<a name="l06007"></a>06007    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l06008"></a>06008    <span class="keywordflow">return</span> 0;
<a name="l06009"></a>06009 }
<a name="l06010"></a>06010   <span class="comment"></span>
<a name="l06011"></a>06011 <span class="comment">/*! \brief Facilitates resetting statistics for a queue</span>
<a name="l06012"></a>06012 <span class="comment"> *</span>
<a name="l06013"></a>06013 <span class="comment"> * This function actually does not reset any statistics, but</span>
<a name="l06014"></a>06014 <span class="comment"> * rather finds a call_queue struct which corresponds to the</span>
<a name="l06015"></a>06015 <span class="comment"> * passed-in queue name and passes that structure to the </span>
<a name="l06016"></a>06016 <span class="comment"> * clear_queue function. If no queuename is passed in, then</span>
<a name="l06017"></a>06017 <span class="comment"> * all queues will have their statistics reset.</span>
<a name="l06018"></a>06018 <span class="comment"> *</span>
<a name="l06019"></a>06019 <span class="comment"> * \param queuename The name of the queue to reset the statistics</span>
<a name="l06020"></a>06020 <span class="comment"> * for. If this is NULL or zero-length, then this means to reset</span>
<a name="l06021"></a>06021 <span class="comment"> * the statistics for all queues</span>
<a name="l06022"></a>06022 <span class="comment"> * \retval void</span>
<a name="l06023"></a>06023 <span class="comment"> */</span>
<a name="l06024"></a><a class="code" href="app__queue_8c.html#a97708d329e8643860a9f82eafcd5a4ff">06024</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a97708d329e8643860a9f82eafcd5a4ff" title="Facilitates resetting statistics for a queue.">clear_stats</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *queuename)
<a name="l06025"></a>06025 {
<a name="l06026"></a>06026    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l06027"></a>06027    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> queue_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, 0);
<a name="l06028"></a>06028    <span class="keywordflow">while</span> ((q = <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;queue_iter, <span class="stringliteral">&quot;Iterate through queues&quot;</span>))) {
<a name="l06029"></a>06029       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l06030"></a>06030       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename) || !strcasecmp(q-&gt;name, queuename))
<a name="l06031"></a>06031          <a class="code" href="app__queue_8c.html#a3f75910c35a627fb9d15d0024fe0c36b">clear_queue</a>(q);
<a name="l06032"></a>06032       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l06033"></a>06033       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l06034"></a>06034    }
<a name="l06035"></a>06035    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;queue_iter);
<a name="l06036"></a>06036    <span class="keywordflow">return</span> 0;
<a name="l06037"></a>06037 }
<a name="l06038"></a>06038 <span class="comment"></span>
<a name="l06039"></a>06039 <span class="comment">/*! \brief The command center for all reload operations</span>
<a name="l06040"></a>06040 <span class="comment"> *</span>
<a name="l06041"></a>06041 <span class="comment"> * Whenever any piece of queue information is to be reloaded, this function</span>
<a name="l06042"></a>06042 <span class="comment"> * is called. It interprets the flags set in the mask parameter and acts</span>
<a name="l06043"></a>06043 <span class="comment"> * based on how they are set.</span>
<a name="l06044"></a>06044 <span class="comment"> *</span>
<a name="l06045"></a>06045 <span class="comment"> * \param reload True if we are reloading information, false if we are loading</span>
<a name="l06046"></a>06046 <span class="comment"> * information for the first time.</span>
<a name="l06047"></a>06047 <span class="comment"> * \param mask A bitmask which tells the handler what actions to take</span>
<a name="l06048"></a>06048 <span class="comment"> * \param queuename The name of the queue on which we wish to take action</span>
<a name="l06049"></a>06049 <span class="comment"> * \retval 0 All reloads were successful</span>
<a name="l06050"></a>06050 <span class="comment"> * \retval non-zero There was a failure</span>
<a name="l06051"></a>06051 <span class="comment"> */</span>
<a name="l06052"></a><a class="code" href="app__queue_8c.html#a321f7a8a2dcb3064e3f719a0fd98c6b5">06052</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a321f7a8a2dcb3064e3f719a0fd98c6b5" title="The command center for all reload operations.">reload_handler</a>(<span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>, <span class="keyword">struct</span> <a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> *mask, <span class="keyword">const</span> <span class="keywordtype">char</span> *queuename)
<a name="l06053"></a>06053 {
<a name="l06054"></a>06054    <span class="keywordtype">int</span> res = 0;
<a name="l06055"></a>06055 
<a name="l06056"></a>06056    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(mask, <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a04da28a6a506fbc6dfce3f3da3569acc">QUEUE_RELOAD_RULES</a>)) {
<a name="l06057"></a>06057       res |= <a class="code" href="app__queue_8c.html#a7c735420578948b9097fbf5dc71a094c" title="Reload the rules defined in queuerules.conf.">reload_queue_rules</a>(reload);
<a name="l06058"></a>06058    }
<a name="l06059"></a>06059    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(mask, <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a845535b8e69c40b11c12b08740d1357c">QUEUE_RESET_STATS</a>)) {
<a name="l06060"></a>06060       res |= <a class="code" href="app__queue_8c.html#a97708d329e8643860a9f82eafcd5a4ff" title="Facilitates resetting statistics for a queue.">clear_stats</a>(queuename);
<a name="l06061"></a>06061    }
<a name="l06062"></a>06062    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(mask, (<a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398ab18e9313e34662b745beabef3ed7ca44">QUEUE_RELOAD_PARAMETERS</a> | <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a4fc330b82c294649884cd4d189da8d5f">QUEUE_RELOAD_MEMBER</a>))) {
<a name="l06063"></a>06063       res |= <a class="code" href="app__queue_8c.html#a3d172953bea29dc16fe1596eca35b186" title="reload the queues.conf file">reload_queues</a>(reload, mask, queuename);
<a name="l06064"></a>06064    }
<a name="l06065"></a>06065    <span class="keywordflow">return</span> res;
<a name="l06066"></a>06066 }
<a name="l06067"></a>06067 <span class="comment"></span>
<a name="l06068"></a>06068 <span class="comment">/*! \brief direct ouput to manager or cli with proper terminator */</span>
<a name="l06069"></a><a class="code" href="app__queue_8c.html#ae42d359bffaf530be173cc3239f64c48">06069</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__queue_8c.html#ae42d359bffaf530be173cc3239f64c48" title="direct ouput to manager or cli with proper terminator">do_print</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>)
<a name="l06070"></a>06070 {
<a name="l06071"></a>06071    <span class="keywordflow">if</span> (s)
<a name="l06072"></a>06072       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;%s\r\n&quot;</span>, str);
<a name="l06073"></a>06073    <span class="keywordflow">else</span>
<a name="l06074"></a>06074       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s\n&quot;</span>, str);
<a name="l06075"></a>06075 }
<a name="l06076"></a>06076 <span class="comment"></span>
<a name="l06077"></a>06077 <span class="comment">/*! </span>
<a name="l06078"></a>06078 <span class="comment"> * \brief Show queue(s) status and statistics </span>
<a name="l06079"></a>06079 <span class="comment"> * </span>
<a name="l06080"></a>06080 <span class="comment"> * List the queues strategy, calls processed, members logged in,</span>
<a name="l06081"></a>06081 <span class="comment"> * other queue statistics such as avg hold time.</span>
<a name="l06082"></a>06082 <span class="comment">*/</span>
<a name="l06083"></a><a class="code" href="app__queue_8c.html#afc46ef4fee34af240445267034cf7126">06083</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#afc46ef4fee34af240445267034cf7126" title="Show queue(s) status and statistics.">__queues_show</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l06084"></a>06084 {
<a name="l06085"></a>06085    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l06086"></a>06086    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *out = <a class="code" href="strings_8h.html#a7fc844c12b769ccded05e7514036e241">ast_str_alloca</a>(240);
<a name="l06087"></a>06087    <span class="keywordtype">int</span> found = 0;
<a name="l06088"></a>06088    time_t now = time(NULL);
<a name="l06089"></a>06089    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> queue_iter;
<a name="l06090"></a>06090    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l06091"></a>06091 
<a name="l06092"></a>06092    <span class="keywordflow">if</span> (argc != 2 &amp;&amp; argc != 3)
<a name="l06093"></a>06093       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06094"></a>06094 
<a name="l06095"></a>06095    <span class="keywordflow">if</span> (argc == 3) { <span class="comment">/* specific queue */</span>
<a name="l06096"></a>06096       <span class="keywordflow">if</span> ((q = <a class="code" href="app__queue_8c.html#a9944f03f3b77344b38927628150d3ab7">load_realtime_queue</a>(argv[2]))) {
<a name="l06097"></a>06097          <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with temporary pointer&quot;</span>);
<a name="l06098"></a>06098       }
<a name="l06099"></a>06099    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;queues&quot;</span>)) {
<a name="l06100"></a>06100       <span class="comment">/* This block is to find any queues which are defined in realtime but</span>
<a name="l06101"></a>06101 <span class="comment">       * which have not yet been added to the in-core container</span>
<a name="l06102"></a>06102 <span class="comment">       */</span>
<a name="l06103"></a>06103       <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg = <a class="code" href="config_8h.html#a29ff8cd717c0c0bac60abbd827fec409" title="Retrieve realtime configuration.">ast_load_realtime_multientry</a>(<span class="stringliteral">&quot;queues&quot;</span>, <span class="stringliteral">&quot;name LIKE&quot;</span>, <span class="stringliteral">&quot;%&quot;</span>, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l06104"></a>06104       <span class="keywordtype">char</span> *queuename;
<a name="l06105"></a>06105       <span class="keywordflow">if</span> (cfg) {
<a name="l06106"></a>06106          <span class="keywordflow">for</span> (queuename = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, NULL); !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename); queuename = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, queuename)) {
<a name="l06107"></a>06107             <span class="keywordflow">if</span> ((q = <a class="code" href="app__queue_8c.html#a9944f03f3b77344b38927628150d3ab7">load_realtime_queue</a>(queuename))) {
<a name="l06108"></a>06108                <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with temporary pointer&quot;</span>);
<a name="l06109"></a>06109             }
<a name="l06110"></a>06110          }
<a name="l06111"></a>06111          <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l06112"></a>06112       }
<a name="l06113"></a>06113    }
<a name="l06114"></a>06114 
<a name="l06115"></a>06115    queue_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, <a class="code" href="astobj2_8h.html#a7b5de2aa80f528d3dc554caadb8dc6aba42e2c6aadc44e4259a058a6675b7e7e4">AO2_ITERATOR_DONTLOCK</a>);
<a name="l06116"></a>06116    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l06117"></a>06117    <span class="keywordflow">while</span> ((q = <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;queue_iter, <span class="stringliteral">&quot;Iterate through queues&quot;</span>))) {
<a name="l06118"></a>06118       <span class="keywordtype">float</span> sl;
<a name="l06119"></a>06119       <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *realtime_queue = NULL;
<a name="l06120"></a>06120 
<a name="l06121"></a>06121       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l06122"></a>06122       <span class="comment">/* This check is to make sure we don&apos;t print information for realtime</span>
<a name="l06123"></a>06123 <span class="comment">       * queues which have been deleted from realtime but which have not yet</span>
<a name="l06124"></a>06124 <span class="comment">       * been deleted from the in-core container</span>
<a name="l06125"></a>06125 <span class="comment">       */</span>
<a name="l06126"></a>06126       <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a53e750a536c8270e37bbdd35a9def3d4">realtime</a> &amp;&amp; !(realtime_queue = <a class="code" href="app__queue_8c.html#a9944f03f3b77344b38927628150d3ab7">load_realtime_queue</a>(q-&gt;name))) {
<a name="l06127"></a>06127          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l06128"></a>06128          <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l06129"></a>06129          <span class="keywordflow">continue</span>;
<a name="l06130"></a>06130       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a53e750a536c8270e37bbdd35a9def3d4">realtime</a>) {
<a name="l06131"></a>06131          <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(realtime_queue, <span class="stringliteral">&quot;Queue is already in memory&quot;</span>);
<a name="l06132"></a>06132       }
<a name="l06133"></a>06133       <span class="keywordflow">if</span> (argc == 3 &amp;&amp; strcasecmp(q-&gt;name, argv[2])) {
<a name="l06134"></a>06134          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l06135"></a>06135          <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l06136"></a>06136          <span class="keywordflow">continue</span>;
<a name="l06137"></a>06137       }
<a name="l06138"></a>06138       found = 1;
<a name="l06139"></a>06139 
<a name="l06140"></a>06140       <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;out, 0, <span class="stringliteral">&quot;%s has %d calls (max &quot;</span>, q-&gt;name, q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>);
<a name="l06141"></a>06141       <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a245b5bee0d02a20222d815dbeaaac0fb">maxlen</a>)
<a name="l06142"></a>06142          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;%d&quot;</span>, q-&gt;<a class="code" href="structcall__queue.html#a245b5bee0d02a20222d815dbeaaac0fb">maxlen</a>);
<a name="l06143"></a>06143       <span class="keywordflow">else</span>
<a name="l06144"></a>06144          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;unlimited&quot;</span>);
<a name="l06145"></a>06145       sl = 0;
<a name="l06146"></a>06146       <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a> &gt; 0)
<a name="l06147"></a>06147          sl = 100 * ((float) q-&gt;<a class="code" href="structcall__queue.html#ad22c84b7016cae07c521dda4a74544f8">callscompletedinsl</a> / (<span class="keywordtype">float</span>) q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a>);
<a name="l06148"></a>06148       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;) in &apos;%s&apos; strategy (%ds holdtime, %ds talktime), W:%d, C:%d, A:%d, SL:%2.1f%% within %ds&quot;</span>,
<a name="l06149"></a>06149          <a class="code" href="app__queue_8c.html#a792b5d8a5231db2f05b08bd73d318ea5">int2strat</a>(q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a>), q-&gt;<a class="code" href="structcall__queue.html#aebac91dc9bbd110e44f8ffa9f2e697d1">holdtime</a>, q-&gt;<a class="code" href="structcall__queue.html#a080da53416fe93b51940797285eeee5c">talktime</a>, q-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a>,
<a name="l06150"></a>06150          q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a>, q-&gt;<a class="code" href="structcall__queue.html#a8c3a63527e11cef32f7e5aae9f3f270f">callsabandoned</a>,sl,q-&gt;<a class="code" href="structcall__queue.html#a6293d1622ff45ccac3a1679171376856">servicelevel</a>);
<a name="l06151"></a>06151       <a class="code" href="app__queue_8c.html#ae42d359bffaf530be173cc3239f64c48" title="direct ouput to manager or cli with proper terminator">do_print</a>(s, fd, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out));
<a name="l06152"></a>06152       <span class="keywordflow">if</span> (!<a class="code" href="astobj2_8h.html#a512cc40ce96c63b3d5c78040baa4c9cd" title="Returns the number of elements in a container.">ao2_container_count</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>))
<a name="l06153"></a>06153          <a class="code" href="app__queue_8c.html#ae42d359bffaf530be173cc3239f64c48" title="direct ouput to manager or cli with proper terminator">do_print</a>(s, fd, <span class="stringliteral">&quot;   No Members&quot;</span>);
<a name="l06154"></a>06154       <span class="keywordflow">else</span> {
<a name="l06155"></a>06155          <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *mem;
<a name="l06156"></a>06156 
<a name="l06157"></a>06157          <a class="code" href="app__queue_8c.html#ae42d359bffaf530be173cc3239f64c48" title="direct ouput to manager or cli with proper terminator">do_print</a>(s, fd, <span class="stringliteral">&quot;   Members: &quot;</span>);
<a name="l06158"></a>06158          mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l06159"></a>06159          <span class="keywordflow">while</span> ((mem = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l06160"></a>06160             <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;out, 0, <span class="stringliteral">&quot;      %s&quot;</span>, mem-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>);
<a name="l06161"></a>06161             <span class="keywordflow">if</span> (strcasecmp(mem-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, mem-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>)) {
<a name="l06162"></a>06162                <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot; (%s)&quot;</span>, mem-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>);
<a name="l06163"></a>06163             }
<a name="l06164"></a>06164             <span class="keywordflow">if</span> (mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>)
<a name="l06165"></a>06165                <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot; with penalty %d&quot;</span>, mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>);
<a name="l06166"></a>06166             <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;%s%s%s (%s)&quot;</span>,
<a name="l06167"></a>06167                mem-&gt;<a class="code" href="structmember.html#a44690a0a629211d7620ce0d55c412e9d">dynamic</a> ? <span class="stringliteral">&quot; (dynamic)&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l06168"></a>06168                mem-&gt;<a class="code" href="structmember.html#aac1ae37fa4007496a50df75cf1f698c1">realtime</a> ? <span class="stringliteral">&quot; (realtime)&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l06169"></a>06169                mem-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a> ? <span class="stringliteral">&quot; (paused)&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l06170"></a>06170                <a class="code" href="devicestate_8h.html#ac3a57910a6eb04d12d793fe3df796b8e" title="Find devicestate as text message for output.">ast_devstate2str</a>(mem-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a>));
<a name="l06171"></a>06171             <span class="keywordflow">if</span> (mem-&gt;<a class="code" href="structmember.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a>)
<a name="l06172"></a>06172                <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot; has taken %d calls (last was %ld secs ago)&quot;</span>,
<a name="l06173"></a>06173                   mem-&gt;<a class="code" href="structmember.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a>, (<span class="keywordtype">long</span>) (time(NULL) - mem-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>));
<a name="l06174"></a>06174             <span class="keywordflow">else</span>
<a name="l06175"></a>06175                <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot; has taken no calls yet&quot;</span>);
<a name="l06176"></a>06176             <a class="code" href="app__queue_8c.html#ae42d359bffaf530be173cc3239f64c48" title="direct ouput to manager or cli with proper terminator">do_print</a>(s, fd, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out));
<a name="l06177"></a>06177             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l06178"></a>06178          }
<a name="l06179"></a>06179          <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l06180"></a>06180       }
<a name="l06181"></a>06181       <span class="keywordflow">if</span> (!q-&gt;<a class="code" href="structcall__queue.html#a4cee904f94736300a8eba28cc5763bed">head</a>)
<a name="l06182"></a>06182          <a class="code" href="app__queue_8c.html#ae42d359bffaf530be173cc3239f64c48" title="direct ouput to manager or cli with proper terminator">do_print</a>(s, fd, <span class="stringliteral">&quot;   No Callers&quot;</span>);
<a name="l06183"></a>06183       <span class="keywordflow">else</span> {
<a name="l06184"></a>06184          <span class="keyword">struct </span><a class="code" href="structqueue__ent.html">queue_ent</a> *qe;
<a name="l06185"></a>06185          <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a> = 1;
<a name="l06186"></a>06186 
<a name="l06187"></a>06187          <a class="code" href="app__queue_8c.html#ae42d359bffaf530be173cc3239f64c48" title="direct ouput to manager or cli with proper terminator">do_print</a>(s, fd, <span class="stringliteral">&quot;   Callers: &quot;</span>);
<a name="l06188"></a>06188          <span class="keywordflow">for</span> (qe = q-&gt;<a class="code" href="structcall__queue.html#a4cee904f94736300a8eba28cc5763bed">head</a>; qe; qe = qe-&gt;next) {
<a name="l06189"></a>06189             <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;out, 0, <span class="stringliteral">&quot;      %d. %s (wait: %ld:%2.2ld, prio: %d)&quot;</span>,
<a name="l06190"></a>06190                pos++, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, (<span class="keywordtype">long</span>) (now - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>) / 60,
<a name="l06191"></a>06191                (<span class="keywordtype">long</span>) (now - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>) % 60, qe-&gt;<a class="code" href="structqueue__ent.html#a6f8e491cf1d80eb127fe0c10ebbfc659">prio</a>);
<a name="l06192"></a>06192             <a class="code" href="app__queue_8c.html#ae42d359bffaf530be173cc3239f64c48" title="direct ouput to manager or cli with proper terminator">do_print</a>(s, fd, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out));
<a name="l06193"></a>06193          }
<a name="l06194"></a>06194       }
<a name="l06195"></a>06195       <a class="code" href="app__queue_8c.html#ae42d359bffaf530be173cc3239f64c48" title="direct ouput to manager or cli with proper terminator">do_print</a>(s, fd, <span class="stringliteral">&quot;&quot;</span>); <span class="comment">/* blank line between entries */</span>
<a name="l06196"></a>06196       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l06197"></a>06197       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>); <span class="comment">/* Unref the iterator&apos;s reference */</span>
<a name="l06198"></a>06198    }
<a name="l06199"></a>06199    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;queue_iter);
<a name="l06200"></a>06200    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>);
<a name="l06201"></a>06201    <span class="keywordflow">if</span> (!found) {
<a name="l06202"></a>06202       <span class="keywordflow">if</span> (argc == 3)
<a name="l06203"></a>06203          <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;out, 0, <span class="stringliteral">&quot;No such queue: %s.&quot;</span>, argv[2]);
<a name="l06204"></a>06204       <span class="keywordflow">else</span>
<a name="l06205"></a>06205          <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;out, 0, <span class="stringliteral">&quot;No queues.&quot;</span>);
<a name="l06206"></a>06206       <a class="code" href="app__queue_8c.html#ae42d359bffaf530be173cc3239f64c48" title="direct ouput to manager or cli with proper terminator">do_print</a>(s, fd, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out));
<a name="l06207"></a>06207    }
<a name="l06208"></a>06208    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06209"></a>06209 }
<a name="l06210"></a>06210 
<a name="l06211"></a><a class="code" href="app__queue_8c.html#af171b6fd3865cf9618ec718d42cfdee9">06211</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#af171b6fd3865cf9618ec718d42cfdee9">complete_queue</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l06212"></a>06212 {
<a name="l06213"></a>06213    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l06214"></a>06214    <span class="keywordtype">char</span> *ret = NULL;
<a name="l06215"></a>06215    <span class="keywordtype">int</span> which = 0;
<a name="l06216"></a>06216    <span class="keywordtype">int</span> wordlen = strlen(word);
<a name="l06217"></a>06217    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> queue_iter;
<a name="l06218"></a>06218 
<a name="l06219"></a>06219    queue_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, 0);
<a name="l06220"></a>06220    <span class="keywordflow">while</span> ((q = <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;queue_iter, <span class="stringliteral">&quot;Iterate through queues&quot;</span>))) {
<a name="l06221"></a>06221       <span class="keywordflow">if</span> (!strncasecmp(word, q-&gt;name, wordlen) &amp;&amp; ++which &gt; state) {
<a name="l06222"></a>06222          ret = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(q-&gt;name);
<a name="l06223"></a>06223          <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l06224"></a>06224          <span class="keywordflow">break</span>;
<a name="l06225"></a>06225       }
<a name="l06226"></a>06226       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l06227"></a>06227    }
<a name="l06228"></a>06228    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;queue_iter);
<a name="l06229"></a>06229 
<a name="l06230"></a>06230    <span class="keywordflow">return</span> ret;
<a name="l06231"></a>06231 }
<a name="l06232"></a>06232 
<a name="l06233"></a><a class="code" href="app__queue_8c.html#a5b08d861378519df1563080cc0e22fd4">06233</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5b08d861378519df1563080cc0e22fd4">complete_queue_show</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l06234"></a>06234 {
<a name="l06235"></a>06235    <span class="keywordflow">if</span> (pos == 2)
<a name="l06236"></a>06236       <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#af171b6fd3865cf9618ec718d42cfdee9">complete_queue</a>(line, word, pos, state);
<a name="l06237"></a>06237    <span class="keywordflow">return</span> NULL;
<a name="l06238"></a>06238 }
<a name="l06239"></a>06239 
<a name="l06240"></a><a class="code" href="app__queue_8c.html#a8f11ecb2ece22635477ca2ee913b39e3">06240</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a8f11ecb2ece22635477ca2ee913b39e3">queue_show</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06241"></a>06241 {
<a name="l06242"></a>06242    <span class="keywordflow">switch</span> ( cmd ) {
<a name="l06243"></a>06243    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06244"></a>06244       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;queue show&quot;</span>;
<a name="l06245"></a>06245       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06246"></a>06246          <span class="stringliteral">&quot;Usage: queue show\n&quot;</span>
<a name="l06247"></a>06247          <span class="stringliteral">&quot;       Provides summary information on a specified queue.\n&quot;</span>;
<a name="l06248"></a>06248       <span class="keywordflow">return</span> NULL;
<a name="l06249"></a>06249    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06250"></a>06250       <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#a5b08d861378519df1563080cc0e22fd4">complete_queue_show</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>); 
<a name="l06251"></a>06251    }
<a name="l06252"></a>06252 
<a name="l06253"></a>06253    <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#afc46ef4fee34af240445267034cf7126" title="Show queue(s) status and statistics.">__queues_show</a>(NULL, a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>);
<a name="l06254"></a>06254 }
<a name="l06255"></a>06255 <span class="comment"></span>
<a name="l06256"></a>06256 <span class="comment">/*!\brief callback to display queues status in manager</span>
<a name="l06257"></a>06257 <span class="comment">   \addtogroup Group_AMI</span>
<a name="l06258"></a>06258 <span class="comment"> */</span>
<a name="l06259"></a><a class="code" href="app__queue_8c.html#ae5d140c0198c679d756844e8858ad4bf">06259</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ae5d140c0198c679d756844e8858ad4bf">manager_queues_show</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06260"></a>06260 {
<a name="l06261"></a>06261    <span class="keywordtype">char</span> *a[] = { <span class="stringliteral">&quot;queue&quot;</span>, <span class="stringliteral">&quot;show&quot;</span> };
<a name="l06262"></a>06262 
<a name="l06263"></a>06263    <a class="code" href="app__queue_8c.html#afc46ef4fee34af240445267034cf7126" title="Show queue(s) status and statistics.">__queues_show</a>(s, -1, 2, a);
<a name="l06264"></a>06264    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;\r\n\r\n&quot;</span>); <span class="comment">/* Properly terminate Manager output */</span>
<a name="l06265"></a>06265 
<a name="l06266"></a>06266    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l06267"></a>06267 }
<a name="l06268"></a>06268 
<a name="l06269"></a><a class="code" href="app__queue_8c.html#a5b0161cb9388c7e8886b1b35a9b54fdc">06269</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a5b0161cb9388c7e8886b1b35a9b54fdc">manager_queue_rule_show</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06270"></a>06270 {
<a name="l06271"></a>06271    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structrule.html">rule</a> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Rule&quot;</span>);
<a name="l06272"></a>06272    <span class="keyword">struct </span>rule_list *rl_iter;
<a name="l06273"></a>06273    <span class="keyword">struct </span><a class="code" href="structpenalty__rule.html">penalty_rule</a> *pr_iter;
<a name="l06274"></a>06274 
<a name="l06275"></a>06275    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;rule_lists);
<a name="l06276"></a>06276    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;rule_lists, rl_iter, list) {
<a name="l06277"></a>06277       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(rule) || !strcasecmp(rule, rl_iter-&gt;<a class="code" href="structrule__list.html#a3777dbae63a15da001b2baa317a25149">name</a>)) {
<a name="l06278"></a>06278          <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;RuleList: %s\r\n&quot;</span>, rl_iter-&gt;<a class="code" href="structrule__list.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l06279"></a>06279          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;rl_iter-&gt;rules, pr_iter, list) {
<a name="l06280"></a>06280             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Rule: %d,%s%d,%s%d\r\n&quot;</span>, pr_iter-&gt;<a class="code" href="structpenalty__rule.html#a42715f65f02da52edc5b22021d8ae670">time</a>, pr_iter-&gt;<a class="code" href="structpenalty__rule.html#ae0778c688a39dcc28198f568176370eb">max_relative</a> &amp;&amp; pr_iter-&gt;<a class="code" href="structpenalty__rule.html#aff3c96df7d67617d6ee82fa1f257ff84">max_value</a> &gt;= 0 ? <span class="stringliteral">&quot;+&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, pr_iter-&gt;<a class="code" href="structpenalty__rule.html#aff3c96df7d67617d6ee82fa1f257ff84">max_value</a>, pr_iter-&gt;<a class="code" href="structpenalty__rule.html#a790961d8e38a4dbcdd59e8c2b0a292b4">min_relative</a> &amp;&amp; pr_iter-&gt;<a class="code" href="structpenalty__rule.html#a2b15eec5f0109b01f534046bb5c04666">min_value</a> &gt;= 0 ? <span class="stringliteral">&quot;+&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, pr_iter-&gt;<a class="code" href="structpenalty__rule.html#a2b15eec5f0109b01f534046bb5c04666">min_value</a> );
<a name="l06281"></a>06281          }
<a name="l06282"></a>06282          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(rule))
<a name="l06283"></a>06283             <span class="keywordflow">break</span>;
<a name="l06284"></a>06284       }
<a name="l06285"></a>06285    }
<a name="l06286"></a>06286    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;rule_lists);
<a name="l06287"></a>06287 
<a name="l06288"></a>06288    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;\r\n\r\n&quot;</span>);
<a name="l06289"></a>06289 
<a name="l06290"></a>06290    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l06291"></a>06291 }
<a name="l06292"></a>06292 <span class="comment"></span>
<a name="l06293"></a>06293 <span class="comment">/*! \brief Summary of queue info via the AMI */</span>
<a name="l06294"></a><a class="code" href="app__queue_8c.html#ace5e218ac5b4850ddcf7cb1a9866da6b">06294</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ace5e218ac5b4850ddcf7cb1a9866da6b" title="Summary of queue info via the AMI.">manager_queues_summary</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06295"></a>06295 {
<a name="l06296"></a>06296    time_t now;
<a name="l06297"></a>06297    <span class="keywordtype">int</span> qmemcount = 0;
<a name="l06298"></a>06298    <span class="keywordtype">int</span> qmemavail = 0;
<a name="l06299"></a>06299    <span class="keywordtype">int</span> qchancount = 0;
<a name="l06300"></a>06300    <span class="keywordtype">int</span> qlongestholdtime = 0;
<a name="l06301"></a>06301    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l06302"></a>06302    <span class="keyword">const</span> <span class="keywordtype">char</span> *queuefilter = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Queue&quot;</span>);
<a name="l06303"></a>06303    <span class="keywordtype">char</span> idText[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06304"></a>06304    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l06305"></a>06305    <span class="keyword">struct </span><a class="code" href="structqueue__ent.html">queue_ent</a> *qe;
<a name="l06306"></a>06306    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *mem;
<a name="l06307"></a>06307    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> queue_iter;
<a name="l06308"></a>06308    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l06309"></a>06309 
<a name="l06310"></a>06310    <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Queue summary will follow&quot;</span>);
<a name="l06311"></a>06311    time(&amp;now);
<a name="l06312"></a>06312    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l06313"></a>06313       snprintf(idText, 256, <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, <span class="keywordtype">id</span>);
<a name="l06314"></a>06314    queue_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, 0);
<a name="l06315"></a>06315    <span class="keywordflow">while</span> ((q = <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;queue_iter, <span class="stringliteral">&quot;Iterate through queues&quot;</span>))) {
<a name="l06316"></a>06316       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l06317"></a>06317 
<a name="l06318"></a>06318       <span class="comment">/* List queue properties */</span>
<a name="l06319"></a>06319       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuefilter) || !strcmp(q-&gt;name, queuefilter)) {
<a name="l06320"></a>06320          <span class="comment">/* Reset the necessary local variables if no queuefilter is set*/</span>
<a name="l06321"></a>06321          qmemcount = 0;
<a name="l06322"></a>06322          qmemavail = 0;
<a name="l06323"></a>06323          qchancount = 0;
<a name="l06324"></a>06324          qlongestholdtime = 0;
<a name="l06325"></a>06325 
<a name="l06326"></a>06326          <span class="comment">/* List Queue Members */</span>
<a name="l06327"></a>06327          mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l06328"></a>06328          <span class="keywordflow">while</span> ((mem = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l06329"></a>06329             <span class="keywordflow">if</span> ((mem-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> != <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>) &amp;&amp; (mem-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> != <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>)) {
<a name="l06330"></a>06330                ++qmemcount;
<a name="l06331"></a>06331                <span class="keywordflow">if</span> (((mem-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> == <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>) || (mem-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a> == <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>)) &amp;&amp; !(mem-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a>)) {
<a name="l06332"></a>06332                   ++qmemavail;
<a name="l06333"></a>06333                }
<a name="l06334"></a>06334             }
<a name="l06335"></a>06335             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l06336"></a>06336          }
<a name="l06337"></a>06337          <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l06338"></a>06338          <span class="keywordflow">for</span> (qe = q-&gt;<a class="code" href="structcall__queue.html#a4cee904f94736300a8eba28cc5763bed">head</a>; qe; qe = qe-&gt;next) {
<a name="l06339"></a>06339             <span class="keywordflow">if</span> ((now - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>) &gt; qlongestholdtime) {
<a name="l06340"></a>06340                qlongestholdtime = now - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;
<a name="l06341"></a>06341             }
<a name="l06342"></a>06342             ++qchancount;
<a name="l06343"></a>06343          }
<a name="l06344"></a>06344          <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: QueueSummary\r\n&quot;</span>
<a name="l06345"></a>06345             <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l06346"></a>06346             <span class="stringliteral">&quot;LoggedIn: %d\r\n&quot;</span>
<a name="l06347"></a>06347             <span class="stringliteral">&quot;Available: %d\r\n&quot;</span>
<a name="l06348"></a>06348             <span class="stringliteral">&quot;Callers: %d\r\n&quot;</span> 
<a name="l06349"></a>06349             <span class="stringliteral">&quot;HoldTime: %d\r\n&quot;</span>
<a name="l06350"></a>06350             <span class="stringliteral">&quot;TalkTime: %d\r\n&quot;</span>
<a name="l06351"></a>06351             <span class="stringliteral">&quot;LongestHoldTime: %d\r\n&quot;</span>
<a name="l06352"></a>06352             <span class="stringliteral">&quot;%s&quot;</span>
<a name="l06353"></a>06353             <span class="stringliteral">&quot;\r\n&quot;</span>,
<a name="l06354"></a>06354             q-&gt;name, qmemcount, qmemavail, qchancount, q-&gt;<a class="code" href="structcall__queue.html#aebac91dc9bbd110e44f8ffa9f2e697d1">holdtime</a>, q-&gt;<a class="code" href="structcall__queue.html#a080da53416fe93b51940797285eeee5c">talktime</a>, qlongestholdtime, idText);
<a name="l06355"></a>06355       }
<a name="l06356"></a>06356       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l06357"></a>06357       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l06358"></a>06358    }
<a name="l06359"></a>06359    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;queue_iter);
<a name="l06360"></a>06360    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s,
<a name="l06361"></a>06361       <span class="stringliteral">&quot;Event: QueueSummaryComplete\r\n&quot;</span>
<a name="l06362"></a>06362       <span class="stringliteral">&quot;%s&quot;</span>
<a name="l06363"></a>06363       <span class="stringliteral">&quot;\r\n&quot;</span>, idText);
<a name="l06364"></a>06364 
<a name="l06365"></a>06365    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l06366"></a>06366 }
<a name="l06367"></a>06367 <span class="comment"></span>
<a name="l06368"></a>06368 <span class="comment">/*! \brief Queue status info via AMI */</span>
<a name="l06369"></a><a class="code" href="app__queue_8c.html#ad2bd8d5629fdba7d86c59b7d72c892a7">06369</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ad2bd8d5629fdba7d86c59b7d72c892a7" title="Queue status info via AMI.">manager_queues_status</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06370"></a>06370 {
<a name="l06371"></a>06371    time_t now;
<a name="l06372"></a>06372    <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>;
<a name="l06373"></a>06373    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l06374"></a>06374    <span class="keyword">const</span> <span class="keywordtype">char</span> *queuefilter = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;Queue&quot;</span>);
<a name="l06375"></a>06375    <span class="keyword">const</span> <span class="keywordtype">char</span> *memberfilter = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;Member&quot;</span>);
<a name="l06376"></a>06376    <span class="keywordtype">char</span> idText[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06377"></a>06377    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l06378"></a>06378    <span class="keyword">struct </span><a class="code" href="structqueue__ent.html">queue_ent</a> *qe;
<a name="l06379"></a>06379    <span class="keywordtype">float</span> sl = 0;
<a name="l06380"></a>06380    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *mem;
<a name="l06381"></a>06381    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> queue_iter;
<a name="l06382"></a>06382    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l06383"></a>06383 
<a name="l06384"></a>06384    <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Queue status will follow&quot;</span>);
<a name="l06385"></a>06385    time(&amp;now);
<a name="l06386"></a>06386    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l06387"></a>06387       snprintf(idText, <span class="keyword">sizeof</span>(idText), <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, <span class="keywordtype">id</span>);
<a name="l06388"></a>06388 
<a name="l06389"></a>06389    queue_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, 0);
<a name="l06390"></a>06390    <span class="keywordflow">while</span> ((q = <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;queue_iter, <span class="stringliteral">&quot;Iterate through queues&quot;</span>))) {
<a name="l06391"></a>06391       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l06392"></a>06392 
<a name="l06393"></a>06393       <span class="comment">/* List queue properties */</span>
<a name="l06394"></a>06394       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuefilter) || !strcmp(q-&gt;name, queuefilter)) {
<a name="l06395"></a>06395          sl = ((q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a> &gt; 0) ? 100 * ((<span class="keywordtype">float</span>)q-&gt;<a class="code" href="structcall__queue.html#ad22c84b7016cae07c521dda4a74544f8">callscompletedinsl</a> / (float)q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a>) : 0);
<a name="l06396"></a>06396          <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: QueueParams\r\n&quot;</span>
<a name="l06397"></a>06397             <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l06398"></a>06398             <span class="stringliteral">&quot;Max: %d\r\n&quot;</span>
<a name="l06399"></a>06399             <span class="stringliteral">&quot;Strategy: %s\r\n&quot;</span>
<a name="l06400"></a>06400             <span class="stringliteral">&quot;Calls: %d\r\n&quot;</span>
<a name="l06401"></a>06401             <span class="stringliteral">&quot;Holdtime: %d\r\n&quot;</span>
<a name="l06402"></a>06402             <span class="stringliteral">&quot;TalkTime: %d\r\n&quot;</span>
<a name="l06403"></a>06403             <span class="stringliteral">&quot;Completed: %d\r\n&quot;</span>
<a name="l06404"></a>06404             <span class="stringliteral">&quot;Abandoned: %d\r\n&quot;</span>
<a name="l06405"></a>06405             <span class="stringliteral">&quot;ServiceLevel: %d\r\n&quot;</span>
<a name="l06406"></a>06406             <span class="stringliteral">&quot;ServicelevelPerf: %2.1f\r\n&quot;</span>
<a name="l06407"></a>06407             <span class="stringliteral">&quot;Weight: %d\r\n&quot;</span>
<a name="l06408"></a>06408             <span class="stringliteral">&quot;%s&quot;</span>
<a name="l06409"></a>06409             <span class="stringliteral">&quot;\r\n&quot;</span>,
<a name="l06410"></a>06410             q-&gt;name, q-&gt;<a class="code" href="structcall__queue.html#a245b5bee0d02a20222d815dbeaaac0fb">maxlen</a>, <a class="code" href="app__queue_8c.html#a792b5d8a5231db2f05b08bd73d318ea5">int2strat</a>(q-&gt;<a class="code" href="structcall__queue.html#acc89aafdc65ecd15f010b7c6fc295522">strategy</a>), q-&gt;<a class="code" href="structcall__queue.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>, q-&gt;<a class="code" href="structcall__queue.html#aebac91dc9bbd110e44f8ffa9f2e697d1">holdtime</a>, q-&gt;<a class="code" href="structcall__queue.html#a080da53416fe93b51940797285eeee5c">talktime</a>, q-&gt;<a class="code" href="structcall__queue.html#a98ff2e1b2bd8da1b71bb907198595e53">callscompleted</a>,
<a name="l06411"></a>06411             q-&gt;<a class="code" href="structcall__queue.html#a8c3a63527e11cef32f7e5aae9f3f270f">callsabandoned</a>, q-&gt;<a class="code" href="structcall__queue.html#a6293d1622ff45ccac3a1679171376856">servicelevel</a>, sl, q-&gt;<a class="code" href="structcall__queue.html#aa01147b1f07072d246c76dc85d69df7c">weight</a>, idText);
<a name="l06412"></a>06412          <span class="comment">/* List Queue Members */</span>
<a name="l06413"></a>06413          mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l06414"></a>06414          <span class="keywordflow">while</span> ((mem = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l06415"></a>06415             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(memberfilter) || !strcmp(mem-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, memberfilter) || !strcmp(mem-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, memberfilter)) {
<a name="l06416"></a>06416                <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: QueueMember\r\n&quot;</span>
<a name="l06417"></a>06417                   <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l06418"></a>06418                   <span class="stringliteral">&quot;Name: %s\r\n&quot;</span>
<a name="l06419"></a>06419                   <span class="stringliteral">&quot;Location: %s\r\n&quot;</span>
<a name="l06420"></a>06420                   <span class="stringliteral">&quot;Membership: %s\r\n&quot;</span>
<a name="l06421"></a>06421                   <span class="stringliteral">&quot;Penalty: %d\r\n&quot;</span>
<a name="l06422"></a>06422                   <span class="stringliteral">&quot;CallsTaken: %d\r\n&quot;</span>
<a name="l06423"></a>06423                   <span class="stringliteral">&quot;LastCall: %d\r\n&quot;</span>
<a name="l06424"></a>06424                   <span class="stringliteral">&quot;Status: %d\r\n&quot;</span>
<a name="l06425"></a>06425                   <span class="stringliteral">&quot;Paused: %d\r\n&quot;</span>
<a name="l06426"></a>06426                   <span class="stringliteral">&quot;%s&quot;</span>
<a name="l06427"></a>06427                   <span class="stringliteral">&quot;\r\n&quot;</span>,
<a name="l06428"></a>06428                   q-&gt;name, mem-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, mem-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>, mem-&gt;<a class="code" href="structmember.html#a44690a0a629211d7620ce0d55c412e9d">dynamic</a> ? <span class="stringliteral">&quot;dynamic&quot;</span> : <span class="stringliteral">&quot;static&quot;</span>,
<a name="l06429"></a>06429                   mem-&gt;<a class="code" href="structmember.html#a70500289fa53bc6e8b1c2d7b82a11640">penalty</a>, mem-&gt;<a class="code" href="structmember.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a>, (<span class="keywordtype">int</span>)mem-&gt;<a class="code" href="structmember.html#a33479a2976f279910df62bda3a3df62d">lastcall</a>, mem-&gt;<a class="code" href="structmember.html#a6e27f49150e9a14580fb313cc2777e00">status</a>, mem-&gt;<a class="code" href="structmember.html#a868659a2f991de87c2b0dcbe6cea6175">paused</a>, idText);
<a name="l06430"></a>06430             }
<a name="l06431"></a>06431             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mem, -1);
<a name="l06432"></a>06432          }
<a name="l06433"></a>06433          <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l06434"></a>06434          <span class="comment">/* List Queue Entries */</span>
<a name="l06435"></a>06435          pos = 1;
<a name="l06436"></a>06436          <span class="keywordflow">for</span> (qe = q-&gt;<a class="code" href="structcall__queue.html#a4cee904f94736300a8eba28cc5763bed">head</a>; qe; qe = qe-&gt;next) {
<a name="l06437"></a>06437             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: QueueEntry\r\n&quot;</span>
<a name="l06438"></a>06438                <span class="stringliteral">&quot;Queue: %s\r\n&quot;</span>
<a name="l06439"></a>06439                <span class="stringliteral">&quot;Position: %d\r\n&quot;</span>
<a name="l06440"></a>06440                <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l06441"></a>06441                <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l06442"></a>06442                <span class="stringliteral">&quot;CallerIDNum: %s\r\n&quot;</span>
<a name="l06443"></a>06443                <span class="stringliteral">&quot;CallerIDName: %s\r\n&quot;</span>
<a name="l06444"></a>06444                <span class="stringliteral">&quot;Wait: %ld\r\n&quot;</span>
<a name="l06445"></a>06445                <span class="stringliteral">&quot;%s&quot;</span>
<a name="l06446"></a>06446                <span class="stringliteral">&quot;\r\n&quot;</span>,
<a name="l06447"></a>06447                q-&gt;name, pos++, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid,
<a name="l06448"></a>06448                <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;unknown&quot;</span>),
<a name="l06449"></a>06449                <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(qe-&gt;<a class="code" href="structqueue__ent.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;unknown&quot;</span>),
<a name="l06450"></a>06450                (<span class="keywordtype">long</span>) (now - qe-&gt;<a class="code" href="structqueue__ent.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>), idText);
<a name="l06451"></a>06451          }
<a name="l06452"></a>06452       }
<a name="l06453"></a>06453       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l06454"></a>06454       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l06455"></a>06455    }
<a name="l06456"></a>06456    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;queue_iter);
<a name="l06457"></a>06457 
<a name="l06458"></a>06458    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s,
<a name="l06459"></a>06459       <span class="stringliteral">&quot;Event: QueueStatusComplete\r\n&quot;</span>
<a name="l06460"></a>06460       <span class="stringliteral">&quot;%s&quot;</span>
<a name="l06461"></a>06461       <span class="stringliteral">&quot;\r\n&quot;</span>,idText);
<a name="l06462"></a>06462 
<a name="l06463"></a>06463    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l06464"></a>06464 }
<a name="l06465"></a>06465 
<a name="l06466"></a><a class="code" href="app__queue_8c.html#a2ec48379febcdee77d6c659269714dd6">06466</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a2ec48379febcdee77d6c659269714dd6">manager_add_queue_member</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06467"></a>06467 {
<a name="l06468"></a>06468    <span class="keyword">const</span> <span class="keywordtype">char</span> *queuename, *interface, *penalty_s, *paused_s, *membername, *state_interface;
<a name="l06469"></a>06469    <span class="keywordtype">int</span> paused, penalty = 0;
<a name="l06470"></a>06470 
<a name="l06471"></a>06471    queuename = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Queue&quot;</span>);
<a name="l06472"></a>06472    interface = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Interface&quot;</span>);
<a name="l06473"></a>06473    penalty_s = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Penalty&quot;</span>);
<a name="l06474"></a>06474    paused_s = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Paused&quot;</span>);
<a name="l06475"></a>06475    membername = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;MemberName&quot;</span>);
<a name="l06476"></a>06476    state_interface = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;StateInterface&quot;</span>);
<a name="l06477"></a>06477 
<a name="l06478"></a>06478    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename)) {
<a name="l06479"></a>06479       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;&apos;Queue&apos; not specified.&quot;</span>);
<a name="l06480"></a>06480       <span class="keywordflow">return</span> 0;
<a name="l06481"></a>06481    }
<a name="l06482"></a>06482 
<a name="l06483"></a>06483    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(interface)) {
<a name="l06484"></a>06484       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;&apos;Interface&apos; not specified.&quot;</span>);
<a name="l06485"></a>06485       <span class="keywordflow">return</span> 0;
<a name="l06486"></a>06486    }
<a name="l06487"></a>06487 
<a name="l06488"></a>06488    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(penalty_s))
<a name="l06489"></a>06489       penalty = 0;
<a name="l06490"></a>06490    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(penalty_s, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;penalty) != 1 || penalty &lt; 0)
<a name="l06491"></a>06491       penalty = 0;
<a name="l06492"></a>06492 
<a name="l06493"></a>06493    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(paused_s))
<a name="l06494"></a>06494       paused = 0;
<a name="l06495"></a>06495    <span class="keywordflow">else</span>
<a name="l06496"></a>06496       paused = abs(<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(paused_s));
<a name="l06497"></a>06497 
<a name="l06498"></a>06498    <span class="keywordflow">switch</span> (<a class="code" href="app__queue_8c.html#abe87549704e5140ad7f8798fa60b8642" title="Add member to queue.">add_to_queue</a>(queuename, interface, membername, penalty, paused, queue_persistent_members, state_interface)) {
<a name="l06499"></a>06499    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#aaa42581c853cb64af155ddd19937d80e">RES_OKAY</a>:
<a name="l06500"></a>06500       <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(queuename, <span class="stringliteral">&quot;MANAGER&quot;</span>, interface, <span class="stringliteral">&quot;ADDMEMBER&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06501"></a>06501       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Added interface to queue&quot;</span>);
<a name="l06502"></a>06502       <span class="keywordflow">break</span>;
<a name="l06503"></a>06503    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#ae72ca8d43e1d9acf1dbfcbc18c98a3ae">RES_EXISTS</a>:
<a name="l06504"></a>06504       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Unable to add interface: Already there&quot;</span>);
<a name="l06505"></a>06505       <span class="keywordflow">break</span>;
<a name="l06506"></a>06506    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a88215ab017dd4ed8343d17918eacee81">RES_NOSUCHQUEUE</a>:
<a name="l06507"></a>06507       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Unable to add interface to queue: No such queue&quot;</span>);
<a name="l06508"></a>06508       <span class="keywordflow">break</span>;
<a name="l06509"></a>06509    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a662a43c452569dfc9f20d49a73498c64">RES_OUTOFMEMORY</a>:
<a name="l06510"></a>06510       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Out of memory&quot;</span>);
<a name="l06511"></a>06511       <span class="keywordflow">break</span>;
<a name="l06512"></a>06512    }
<a name="l06513"></a>06513 
<a name="l06514"></a>06514    <span class="keywordflow">return</span> 0;
<a name="l06515"></a>06515 }
<a name="l06516"></a>06516 
<a name="l06517"></a><a class="code" href="app__queue_8c.html#abbeea50ec5fd219991763c7a848464ea">06517</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#abbeea50ec5fd219991763c7a848464ea">manager_remove_queue_member</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06518"></a>06518 {
<a name="l06519"></a>06519    <span class="keyword">const</span> <span class="keywordtype">char</span> *queuename, *interface;
<a name="l06520"></a>06520 
<a name="l06521"></a>06521    queuename = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Queue&quot;</span>);
<a name="l06522"></a>06522    interface = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Interface&quot;</span>);
<a name="l06523"></a>06523 
<a name="l06524"></a>06524    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(interface)) {
<a name="l06525"></a>06525       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Need &apos;Queue&apos; and &apos;Interface&apos; parameters.&quot;</span>);
<a name="l06526"></a>06526       <span class="keywordflow">return</span> 0;
<a name="l06527"></a>06527    }
<a name="l06528"></a>06528 
<a name="l06529"></a>06529    <span class="keywordflow">switch</span> (<a class="code" href="app__queue_8c.html#a2d8545a6eecf92b885f8880aaaf662d2" title="Remove member from queue.">remove_from_queue</a>(queuename, interface)) {
<a name="l06530"></a>06530    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#aaa42581c853cb64af155ddd19937d80e">RES_OKAY</a>:
<a name="l06531"></a>06531       <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(queuename, <span class="stringliteral">&quot;MANAGER&quot;</span>, interface, <span class="stringliteral">&quot;REMOVEMEMBER&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06532"></a>06532       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Removed interface from queue&quot;</span>);
<a name="l06533"></a>06533       <span class="keywordflow">break</span>;
<a name="l06534"></a>06534    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#ae72ca8d43e1d9acf1dbfcbc18c98a3ae">RES_EXISTS</a>:
<a name="l06535"></a>06535       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Unable to remove interface: Not there&quot;</span>);
<a name="l06536"></a>06536       <span class="keywordflow">break</span>;
<a name="l06537"></a>06537    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a88215ab017dd4ed8343d17918eacee81">RES_NOSUCHQUEUE</a>:
<a name="l06538"></a>06538       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Unable to remove interface from queue: No such queue&quot;</span>);
<a name="l06539"></a>06539       <span class="keywordflow">break</span>;
<a name="l06540"></a>06540    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a662a43c452569dfc9f20d49a73498c64">RES_OUTOFMEMORY</a>:
<a name="l06541"></a>06541       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Out of memory&quot;</span>);
<a name="l06542"></a>06542       <span class="keywordflow">break</span>;
<a name="l06543"></a>06543    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a447a632daaf1a56114da95816c12b8a5">RES_NOT_DYNAMIC</a>:
<a name="l06544"></a>06544       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Member not dynamic&quot;</span>);
<a name="l06545"></a>06545       <span class="keywordflow">break</span>;
<a name="l06546"></a>06546    }
<a name="l06547"></a>06547 
<a name="l06548"></a>06548    <span class="keywordflow">return</span> 0;
<a name="l06549"></a>06549 }
<a name="l06550"></a>06550 
<a name="l06551"></a><a class="code" href="app__queue_8c.html#ab294d279fc57c00a43df3d8783e10dcf">06551</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ab294d279fc57c00a43df3d8783e10dcf">manager_pause_queue_member</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06552"></a>06552 {
<a name="l06553"></a>06553    <span class="keyword">const</span> <span class="keywordtype">char</span> *queuename, *interface, *paused_s, *reason;
<a name="l06554"></a>06554    <span class="keywordtype">int</span> paused;
<a name="l06555"></a>06555 
<a name="l06556"></a>06556    interface = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Interface&quot;</span>);
<a name="l06557"></a>06557    paused_s = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Paused&quot;</span>);
<a name="l06558"></a>06558    queuename = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Queue&quot;</span>);      <span class="comment">/* Optional - if not supplied, pause the given Interface in all queues */</span>
<a name="l06559"></a>06559    reason = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Reason&quot;</span>);        <span class="comment">/* Optional - Only used for logging purposes */</span>
<a name="l06560"></a>06560 
<a name="l06561"></a>06561    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(interface) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(paused_s)) {
<a name="l06562"></a>06562       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Need &apos;Interface&apos; and &apos;Paused&apos; parameters.&quot;</span>);
<a name="l06563"></a>06563       <span class="keywordflow">return</span> 0;
<a name="l06564"></a>06564    }
<a name="l06565"></a>06565 
<a name="l06566"></a>06566    paused = abs(<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(paused_s));
<a name="l06567"></a>06567 
<a name="l06568"></a>06568    <span class="keywordflow">if</span> (<a class="code" href="app__queue_8c.html#a5d60239f838c9f941528fb426bcd2290">set_member_paused</a>(queuename, interface, reason, paused))
<a name="l06569"></a>06569       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Interface not found&quot;</span>);
<a name="l06570"></a>06570    <span class="keywordflow">else</span>
<a name="l06571"></a>06571       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, paused ? <span class="stringliteral">&quot;Interface paused successfully&quot;</span> : <span class="stringliteral">&quot;Interface unpaused successfully&quot;</span>);
<a name="l06572"></a>06572    <span class="keywordflow">return</span> 0;
<a name="l06573"></a>06573 }
<a name="l06574"></a>06574 
<a name="l06575"></a><a class="code" href="app__queue_8c.html#afc981f304f48009b383c870db6aac776">06575</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#afc981f304f48009b383c870db6aac776">manager_queue_log_custom</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06576"></a>06576 {
<a name="l06577"></a>06577    <span class="keyword">const</span> <span class="keywordtype">char</span> *queuename, *event, *<a class="code" href="structmessage.html">message</a>, *interface, *uniqueid;
<a name="l06578"></a>06578 
<a name="l06579"></a>06579    queuename = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Queue&quot;</span>);
<a name="l06580"></a>06580    uniqueid = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;UniqueId&quot;</span>);
<a name="l06581"></a>06581    interface = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Interface&quot;</span>);
<a name="l06582"></a>06582    <span class="keyword">event</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Event&quot;</span>);
<a name="l06583"></a>06583    message = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Message&quot;</span>);
<a name="l06584"></a>06584 
<a name="l06585"></a>06585    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(event)) {
<a name="l06586"></a>06586       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Need &apos;Queue&apos; and &apos;Event&apos; parameters.&quot;</span>);
<a name="l06587"></a>06587       <span class="keywordflow">return</span> 0;
<a name="l06588"></a>06588    }
<a name="l06589"></a>06589 
<a name="l06590"></a>06590    <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(queuename, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(uniqueid, <span class="stringliteral">&quot;NONE&quot;</span>), interface, event, <span class="stringliteral">&quot;%s&quot;</span>, message);
<a name="l06591"></a>06591    <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Event added successfully&quot;</span>);
<a name="l06592"></a>06592 
<a name="l06593"></a>06593    <span class="keywordflow">return</span> 0;
<a name="l06594"></a>06594 }
<a name="l06595"></a>06595 
<a name="l06596"></a><a class="code" href="app__queue_8c.html#a6eb92f6a70762912ce80b53e9282204a">06596</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a6eb92f6a70762912ce80b53e9282204a">manager_queue_reload</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06597"></a>06597 {
<a name="l06598"></a>06598    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> mask = {0,};
<a name="l06599"></a>06599    <span class="keyword">const</span> <span class="keywordtype">char</span> *queuename = NULL;
<a name="l06600"></a>06600    <span class="keywordtype">int</span> header_found = 0;
<a name="l06601"></a>06601 
<a name="l06602"></a>06602    queuename = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Queue&quot;</span>);
<a name="l06603"></a>06603    <span class="keywordflow">if</span> (!strcasecmp(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Members&quot;</span>), <span class="stringliteral">&quot;&quot;</span>), <span class="stringliteral">&quot;yes&quot;</span>)) {
<a name="l06604"></a>06604       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;mask, <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a4fc330b82c294649884cd4d189da8d5f">QUEUE_RELOAD_MEMBER</a>);
<a name="l06605"></a>06605       header_found = 1;
<a name="l06606"></a>06606    }
<a name="l06607"></a>06607    <span class="keywordflow">if</span> (!strcasecmp(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Rules&quot;</span>), <span class="stringliteral">&quot;&quot;</span>), <span class="stringliteral">&quot;yes&quot;</span>)) {
<a name="l06608"></a>06608       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;mask, <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a04da28a6a506fbc6dfce3f3da3569acc">QUEUE_RELOAD_RULES</a>);
<a name="l06609"></a>06609       header_found = 1;
<a name="l06610"></a>06610    }
<a name="l06611"></a>06611    <span class="keywordflow">if</span> (!strcasecmp(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Parameters&quot;</span>), <span class="stringliteral">&quot;&quot;</span>), <span class="stringliteral">&quot;yes&quot;</span>)) {
<a name="l06612"></a>06612       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;mask, <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398ab18e9313e34662b745beabef3ed7ca44">QUEUE_RELOAD_PARAMETERS</a>);
<a name="l06613"></a>06613       header_found = 1;
<a name="l06614"></a>06614    }
<a name="l06615"></a>06615 
<a name="l06616"></a>06616    <span class="keywordflow">if</span> (!header_found) {
<a name="l06617"></a>06617       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;mask, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l06618"></a>06618    }
<a name="l06619"></a>06619 
<a name="l06620"></a>06620    <span class="keywordflow">if</span> (!<a class="code" href="app__queue_8c.html#a321f7a8a2dcb3064e3f719a0fd98c6b5" title="The command center for all reload operations.">reload_handler</a>(1, &amp;mask, queuename)) {
<a name="l06621"></a>06621       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Queue reloaded successfully&quot;</span>);
<a name="l06622"></a>06622    } <span class="keywordflow">else</span> {
<a name="l06623"></a>06623       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Error encountered while reloading queue&quot;</span>);
<a name="l06624"></a>06624    }
<a name="l06625"></a>06625    <span class="keywordflow">return</span> 0;
<a name="l06626"></a>06626 }
<a name="l06627"></a>06627 
<a name="l06628"></a><a class="code" href="app__queue_8c.html#a14d56b1e279722b17bc293e06c099b6b">06628</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a14d56b1e279722b17bc293e06c099b6b">manager_queue_reset</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06629"></a>06629 {
<a name="l06630"></a>06630    <span class="keyword">const</span> <span class="keywordtype">char</span> *queuename = NULL;
<a name="l06631"></a>06631    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> mask = {<a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a845535b8e69c40b11c12b08740d1357c">QUEUE_RESET_STATS</a>,};
<a name="l06632"></a>06632    
<a name="l06633"></a>06633    queuename = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Queue&quot;</span>);
<a name="l06634"></a>06634 
<a name="l06635"></a>06635    <span class="keywordflow">if</span> (!<a class="code" href="app__queue_8c.html#a321f7a8a2dcb3064e3f719a0fd98c6b5" title="The command center for all reload operations.">reload_handler</a>(1, &amp;mask, queuename)) {
<a name="l06636"></a>06636       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Queue stats reset successfully&quot;</span>);
<a name="l06637"></a>06637    } <span class="keywordflow">else</span> {
<a name="l06638"></a>06638       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Error encountered while resetting queue stats&quot;</span>);
<a name="l06639"></a>06639    }
<a name="l06640"></a>06640    <span class="keywordflow">return</span> 0;
<a name="l06641"></a>06641 }
<a name="l06642"></a>06642 
<a name="l06643"></a><a class="code" href="app__queue_8c.html#ab5a25afd13aa42a238c165bd5a8fecf2">06643</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#ab5a25afd13aa42a238c165bd5a8fecf2">complete_queue_add_member</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l06644"></a>06644 {
<a name="l06645"></a>06645    <span class="comment">/* 0 - queue; 1 - add; 2 - member; 3 - &lt;interface&gt;; 4 - to; 5 - &lt;queue&gt;; 6 - penalty; 7 - &lt;penalty&gt;; 8 - as; 9 - &lt;membername&gt; */</span>
<a name="l06646"></a>06646    <span class="keywordflow">switch</span> (pos) {
<a name="l06647"></a>06647    <span class="keywordflow">case</span> 3: <span class="comment">/* Don&apos;t attempt to complete name of interface (infinite possibilities) */</span>
<a name="l06648"></a>06648       <span class="keywordflow">return</span> NULL;
<a name="l06649"></a>06649    <span class="keywordflow">case</span> 4: <span class="comment">/* only one possible match, &quot;to&quot; */</span>
<a name="l06650"></a>06650       <span class="keywordflow">return</span> state == 0 ? <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;to&quot;</span>) : NULL;
<a name="l06651"></a>06651    <span class="keywordflow">case</span> 5: <span class="comment">/* &lt;queue&gt; */</span>
<a name="l06652"></a>06652       <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#af171b6fd3865cf9618ec718d42cfdee9">complete_queue</a>(line, word, pos, state);
<a name="l06653"></a>06653    <span class="keywordflow">case</span> 6: <span class="comment">/* only one possible match, &quot;penalty&quot; */</span>
<a name="l06654"></a>06654       <span class="keywordflow">return</span> state == 0 ? <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;penalty&quot;</span>) : NULL;
<a name="l06655"></a>06655    <span class="keywordflow">case</span> 7:
<a name="l06656"></a>06656       <span class="keywordflow">if</span> (state &lt; 100) {      <span class="comment">/* 0-99 */</span>
<a name="l06657"></a>06657          <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>;
<a name="l06658"></a>06658          <span class="keywordflow">if</span> ((num = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(3))) {
<a name="l06659"></a>06659             sprintf(num, <span class="stringliteral">&quot;%d&quot;</span>, state);
<a name="l06660"></a>06660          }
<a name="l06661"></a>06661          <span class="keywordflow">return</span> num;
<a name="l06662"></a>06662       } <span class="keywordflow">else</span> {
<a name="l06663"></a>06663          <span class="keywordflow">return</span> NULL;
<a name="l06664"></a>06664       }
<a name="l06665"></a>06665    <span class="keywordflow">case</span> 8: <span class="comment">/* only one possible match, &quot;as&quot; */</span>
<a name="l06666"></a>06666       <span class="keywordflow">return</span> state == 0 ? <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;as&quot;</span>) : NULL;
<a name="l06667"></a>06667    <span class="keywordflow">case</span> 9: <span class="comment">/* Don&apos;t attempt to complete name of member (infinite possibilities) */</span>
<a name="l06668"></a>06668       <span class="keywordflow">return</span> NULL;
<a name="l06669"></a>06669    <span class="keywordflow">default</span>:
<a name="l06670"></a>06670       <span class="keywordflow">return</span> NULL;
<a name="l06671"></a>06671    }
<a name="l06672"></a>06672 }
<a name="l06673"></a>06673 
<a name="l06674"></a><a class="code" href="app__queue_8c.html#a90a66cbfb007419fb44ca4426265a03d">06674</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#a90a66cbfb007419fb44ca4426265a03d">manager_queue_member_penalty</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06675"></a>06675 {
<a name="l06676"></a>06676    <span class="keyword">const</span> <span class="keywordtype">char</span> *queuename, *interface, *penalty_s;
<a name="l06677"></a>06677    <span class="keywordtype">int</span> penalty;
<a name="l06678"></a>06678 
<a name="l06679"></a>06679    interface = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Interface&quot;</span>);
<a name="l06680"></a>06680    penalty_s = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Penalty&quot;</span>);
<a name="l06681"></a>06681    <span class="comment">/* Optional - if not supplied, set the penalty value for the given Interface in all queues */</span>
<a name="l06682"></a>06682    queuename = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Queue&quot;</span>);
<a name="l06683"></a>06683 
<a name="l06684"></a>06684    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(interface) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(penalty_s)) {
<a name="l06685"></a>06685       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Need &apos;Interface&apos; and &apos;Penalty&apos; parameters.&quot;</span>);
<a name="l06686"></a>06686       <span class="keywordflow">return</span> 0;
<a name="l06687"></a>06687    }
<a name="l06688"></a>06688  
<a name="l06689"></a>06689    penalty = atoi(penalty_s);
<a name="l06690"></a>06690 
<a name="l06691"></a>06691    <span class="keywordflow">if</span> (<a class="code" href="app__queue_8c.html#a214853f4f35145fe0c543edae51469b0">set_member_penalty</a>((<span class="keywordtype">char</span> *)queuename, (<span class="keywordtype">char</span> *)interface, penalty))
<a name="l06692"></a>06692       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Invalid interface, queuename or penalty&quot;</span>);
<a name="l06693"></a>06693    <span class="keywordflow">else</span>
<a name="l06694"></a>06694       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Interface penalty set successfully&quot;</span>);
<a name="l06695"></a>06695 
<a name="l06696"></a>06696    <span class="keywordflow">return</span> 0;
<a name="l06697"></a>06697 }
<a name="l06698"></a>06698 
<a name="l06699"></a><a class="code" href="app__queue_8c.html#a809b8e2a1be84c1a33a191a1c8ed549f">06699</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a809b8e2a1be84c1a33a191a1c8ed549f">handle_queue_add_member</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06700"></a>06700 {
<a name="l06701"></a>06701    <span class="keywordtype">char</span> *queuename, *interface, *membername = NULL, *state_interface = NULL;
<a name="l06702"></a>06702    <span class="keywordtype">int</span> penalty;
<a name="l06703"></a>06703 
<a name="l06704"></a>06704    <span class="keywordflow">switch</span> ( cmd ) {
<a name="l06705"></a>06705    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06706"></a>06706       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;queue add member&quot;</span>;
<a name="l06707"></a>06707       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06708"></a>06708          <span class="stringliteral">&quot;Usage: queue add member &lt;channel&gt; to &lt;queue&gt; [[[penalty &lt;penalty&gt;] as &lt;membername&gt;] state_interface &lt;interface&gt;]\n&quot;</span>
<a name="l06709"></a>06709          <span class="stringliteral">&quot;       Add a channel to a queue with optionally:  a penalty, membername and a state_interface\n&quot;</span>;
<a name="l06710"></a>06710       <span class="keywordflow">return</span> NULL;
<a name="l06711"></a>06711    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06712"></a>06712       <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#ab5a25afd13aa42a238c165bd5a8fecf2">complete_queue_add_member</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l06713"></a>06713    }
<a name="l06714"></a>06714 
<a name="l06715"></a>06715    <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 6) &amp;&amp; (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 8) &amp;&amp; (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 10) &amp;&amp; (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 12)) {
<a name="l06716"></a>06716       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06717"></a>06717    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;to&quot;</span>)) {
<a name="l06718"></a>06718       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06719"></a>06719    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt;= 8) &amp;&amp; strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[6], <span class="stringliteral">&quot;penalty&quot;</span>)) {
<a name="l06720"></a>06720       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06721"></a>06721    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt;= 10) &amp;&amp; strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[8], <span class="stringliteral">&quot;as&quot;</span>)) {
<a name="l06722"></a>06722       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06723"></a>06723    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 12) &amp;&amp; strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[10], <span class="stringliteral">&quot;state_interface&quot;</span>)) {
<a name="l06724"></a>06724       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06725"></a>06725    }
<a name="l06726"></a>06726 
<a name="l06727"></a>06727    queuename = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5];
<a name="l06728"></a>06728    interface = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3];
<a name="l06729"></a>06729    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt;= 8) {
<a name="l06730"></a>06730       <span class="keywordflow">if</span> (sscanf(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[7], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;penalty) == 1) {
<a name="l06731"></a>06731          <span class="keywordflow">if</span> (penalty &lt; 0) {
<a name="l06732"></a>06732             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Penalty must be &gt;= 0\n&quot;</span>);
<a name="l06733"></a>06733             penalty = 0;
<a name="l06734"></a>06734          }
<a name="l06735"></a>06735       } <span class="keywordflow">else</span> {
<a name="l06736"></a>06736          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Penalty must be an integer &gt;= 0\n&quot;</span>);
<a name="l06737"></a>06737          penalty = 0;
<a name="l06738"></a>06738       }
<a name="l06739"></a>06739    } <span class="keywordflow">else</span> {
<a name="l06740"></a>06740       penalty = 0;
<a name="l06741"></a>06741    }
<a name="l06742"></a>06742 
<a name="l06743"></a>06743    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt;= 10) {
<a name="l06744"></a>06744       membername = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[9];
<a name="l06745"></a>06745    }
<a name="l06746"></a>06746 
<a name="l06747"></a>06747    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt;= 12) {
<a name="l06748"></a>06748       state_interface = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[11];
<a name="l06749"></a>06749    }
<a name="l06750"></a>06750 
<a name="l06751"></a>06751    <span class="keywordflow">switch</span> (<a class="code" href="app__queue_8c.html#abe87549704e5140ad7f8798fa60b8642" title="Add member to queue.">add_to_queue</a>(queuename, interface, membername, penalty, 0, queue_persistent_members, state_interface)) {
<a name="l06752"></a>06752    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#aaa42581c853cb64af155ddd19937d80e">RES_OKAY</a>:
<a name="l06753"></a>06753       <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(queuename, <span class="stringliteral">&quot;CLI&quot;</span>, interface, <span class="stringliteral">&quot;ADDMEMBER&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06754"></a>06754       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Added interface &apos;%s&apos; to queue &apos;%s&apos;\n&quot;</span>, interface, queuename);
<a name="l06755"></a>06755       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06756"></a>06756    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#ae72ca8d43e1d9acf1dbfcbc18c98a3ae">RES_EXISTS</a>:
<a name="l06757"></a>06757       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unable to add interface &apos;%s&apos; to queue &apos;%s&apos;: Already there\n&quot;</span>, interface, queuename);
<a name="l06758"></a>06758       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06759"></a>06759    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a88215ab017dd4ed8343d17918eacee81">RES_NOSUCHQUEUE</a>:
<a name="l06760"></a>06760       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unable to add interface to queue &apos;%s&apos;: No such queue\n&quot;</span>, queuename);
<a name="l06761"></a>06761       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06762"></a>06762    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a662a43c452569dfc9f20d49a73498c64">RES_OUTOFMEMORY</a>:
<a name="l06763"></a>06763       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Out of memory\n&quot;</span>);
<a name="l06764"></a>06764       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06765"></a>06765    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a447a632daaf1a56114da95816c12b8a5">RES_NOT_DYNAMIC</a>:
<a name="l06766"></a>06766       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Member not dynamic\n&quot;</span>);
<a name="l06767"></a>06767       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06768"></a>06768    <span class="keywordflow">default</span>:
<a name="l06769"></a>06769       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06770"></a>06770    }
<a name="l06771"></a>06771 }
<a name="l06772"></a>06772 
<a name="l06773"></a><a class="code" href="app__queue_8c.html#a2555f8439a688d7ac9f3aa9d368d197b">06773</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a2555f8439a688d7ac9f3aa9d368d197b">complete_queue_remove_member</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l06774"></a>06774 {
<a name="l06775"></a>06775    <span class="keywordtype">int</span> which = 0;
<a name="l06776"></a>06776    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q;
<a name="l06777"></a>06777    <span class="keyword">struct </span><a class="code" href="structmember.html">member</a> *m;
<a name="l06778"></a>06778    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> queue_iter;
<a name="l06779"></a>06779    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> mem_iter;
<a name="l06780"></a>06780    <span class="keywordtype">int</span> wordlen = strlen(word);
<a name="l06781"></a>06781 
<a name="l06782"></a>06782    <span class="comment">/* 0 - queue; 1 - remove; 2 - member; 3 - &lt;member&gt;; 4 - from; 5 - &lt;queue&gt; */</span>
<a name="l06783"></a>06783    <span class="keywordflow">if</span> (pos &gt; 5 || pos &lt; 3)
<a name="l06784"></a>06784       <span class="keywordflow">return</span> NULL;
<a name="l06785"></a>06785    <span class="keywordflow">if</span> (pos == 4)   <span class="comment">/* only one possible match, &apos;from&apos; */</span>
<a name="l06786"></a>06786       <span class="keywordflow">return</span> (state == 0 ? <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;from&quot;</span>) : NULL);
<a name="l06787"></a>06787 
<a name="l06788"></a>06788    <span class="keywordflow">if</span> (pos == 5)   <span class="comment">/* No need to duplicate code */</span>
<a name="l06789"></a>06789       <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#af171b6fd3865cf9618ec718d42cfdee9">complete_queue</a>(line, word, pos, state);
<a name="l06790"></a>06790 
<a name="l06791"></a>06791    <span class="comment">/* here is the case for 3, &lt;member&gt; */</span>
<a name="l06792"></a>06792    queue_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, 0);
<a name="l06793"></a>06793    <span class="keywordflow">while</span> ((q = <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;queue_iter, <span class="stringliteral">&quot;Iterate through queues&quot;</span>))) {
<a name="l06794"></a>06794       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(q);
<a name="l06795"></a>06795       mem_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(q-&gt;<a class="code" href="structcall__queue.html#a27056a1575e82ba16b1d2cf11ca3eb16">members</a>, 0);
<a name="l06796"></a>06796       <span class="keywordflow">while</span> ((m = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;mem_iter))) {
<a name="l06797"></a>06797          <span class="keywordflow">if</span> (!strncasecmp(word, m-&gt;<a class="code" href="structmember.html#a56c9306da4383826a84cd7602384db15">membername</a>, wordlen) &amp;&amp; ++which &gt; state) {
<a name="l06798"></a>06798             <span class="keywordtype">char</span> *tmp;
<a name="l06799"></a>06799             <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l06800"></a>06800             tmp = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(m-&gt;<a class="code" href="structmember.html#a972adbc68bf3a9a6d2e31093081d3eeb">interface</a>);
<a name="l06801"></a>06801             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l06802"></a>06802             <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator, returning interface name&quot;</span>);
<a name="l06803"></a>06803             <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l06804"></a>06804             <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;queue_iter);
<a name="l06805"></a>06805             <span class="keywordflow">return</span> tmp;
<a name="l06806"></a>06806          }
<a name="l06807"></a>06807          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(m, -1);
<a name="l06808"></a>06808       }
<a name="l06809"></a>06809       <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;mem_iter);
<a name="l06810"></a>06810       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(q);
<a name="l06811"></a>06811       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l06812"></a>06812    }
<a name="l06813"></a>06813    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;queue_iter);
<a name="l06814"></a>06814 
<a name="l06815"></a>06815    <span class="keywordflow">return</span> NULL;
<a name="l06816"></a>06816 }
<a name="l06817"></a>06817 
<a name="l06818"></a><a class="code" href="app__queue_8c.html#a9b97d0ffb7e1a6127de3acc037ea464b">06818</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a9b97d0ffb7e1a6127de3acc037ea464b">handle_queue_remove_member</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06819"></a>06819 {
<a name="l06820"></a>06820    <span class="keywordtype">char</span> *queuename, *interface;
<a name="l06821"></a>06821 
<a name="l06822"></a>06822    <span class="keywordflow">switch</span> (cmd) {
<a name="l06823"></a>06823    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06824"></a>06824       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;queue remove member&quot;</span>;
<a name="l06825"></a>06825       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l06826"></a>06826          <span class="stringliteral">&quot;Usage: queue remove member &lt;channel&gt; from &lt;queue&gt;\n&quot;</span>
<a name="l06827"></a>06827          <span class="stringliteral">&quot;       Remove a specific channel from a queue.\n&quot;</span>;
<a name="l06828"></a>06828       <span class="keywordflow">return</span> NULL;
<a name="l06829"></a>06829    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06830"></a>06830       <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#a2555f8439a688d7ac9f3aa9d368d197b">complete_queue_remove_member</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l06831"></a>06831    }
<a name="l06832"></a>06832 
<a name="l06833"></a>06833    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 6) {
<a name="l06834"></a>06834       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06835"></a>06835    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;from&quot;</span>)) {
<a name="l06836"></a>06836       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06837"></a>06837    }
<a name="l06838"></a>06838 
<a name="l06839"></a>06839    queuename = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5];
<a name="l06840"></a>06840    interface = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3];
<a name="l06841"></a>06841 
<a name="l06842"></a>06842    <span class="keywordflow">switch</span> (<a class="code" href="app__queue_8c.html#a2d8545a6eecf92b885f8880aaaf662d2" title="Remove member from queue.">remove_from_queue</a>(queuename, interface)) {
<a name="l06843"></a>06843    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#aaa42581c853cb64af155ddd19937d80e">RES_OKAY</a>:
<a name="l06844"></a>06844       <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(queuename, <span class="stringliteral">&quot;CLI&quot;</span>, interface, <span class="stringliteral">&quot;REMOVEMEMBER&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06845"></a>06845       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Removed interface &apos;%s&apos; from queue &apos;%s&apos;\n&quot;</span>, interface, queuename);
<a name="l06846"></a>06846       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06847"></a>06847    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#ae72ca8d43e1d9acf1dbfcbc18c98a3ae">RES_EXISTS</a>:
<a name="l06848"></a>06848       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unable to remove interface &apos;%s&apos; from queue &apos;%s&apos;: Not there\n&quot;</span>, interface, queuename);
<a name="l06849"></a>06849       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06850"></a>06850    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a88215ab017dd4ed8343d17918eacee81">RES_NOSUCHQUEUE</a>:
<a name="l06851"></a>06851       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unable to remove interface from queue &apos;%s&apos;: No such queue\n&quot;</span>, queuename);
<a name="l06852"></a>06852       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06853"></a>06853    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a662a43c452569dfc9f20d49a73498c64">RES_OUTOFMEMORY</a>:
<a name="l06854"></a>06854       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Out of memory\n&quot;</span>);
<a name="l06855"></a>06855       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06856"></a>06856    <span class="keywordflow">case</span> <a class="code" href="app__queue_8c.html#a447a632daaf1a56114da95816c12b8a5">RES_NOT_DYNAMIC</a>:
<a name="l06857"></a>06857       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unable to remove interface &apos;%s&apos; from queue &apos;%s&apos;: Member is not dynamic\n&quot;</span>, interface, queuename);
<a name="l06858"></a>06858       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06859"></a>06859    <span class="keywordflow">default</span>:
<a name="l06860"></a>06860       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06861"></a>06861    }
<a name="l06862"></a>06862 }
<a name="l06863"></a>06863 
<a name="l06864"></a><a class="code" href="app__queue_8c.html#a4c7d813324c2a5aec46aa9206cbaa912">06864</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a4c7d813324c2a5aec46aa9206cbaa912">complete_queue_pause_member</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l06865"></a>06865 {
<a name="l06866"></a>06866    <span class="comment">/* 0 - queue; 1 - pause; 2 - member; 3 - &lt;interface&gt;; 4 - queue; 5 - &lt;queue&gt;; 6 - reason; 7 - &lt;reason&gt; */</span>
<a name="l06867"></a>06867    <span class="keywordflow">switch</span> (pos) {
<a name="l06868"></a>06868    <span class="keywordflow">case</span> 3:  <span class="comment">/* Don&apos;t attempt to complete name of interface (infinite possibilities) */</span>
<a name="l06869"></a>06869       <span class="keywordflow">return</span> NULL;
<a name="l06870"></a>06870    <span class="keywordflow">case</span> 4:  <span class="comment">/* only one possible match, &quot;queue&quot; */</span>
<a name="l06871"></a>06871       <span class="keywordflow">return</span> state == 0 ? <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;queue&quot;</span>) : NULL;
<a name="l06872"></a>06872    <span class="keywordflow">case</span> 5:  <span class="comment">/* &lt;queue&gt; */</span>
<a name="l06873"></a>06873       <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#af171b6fd3865cf9618ec718d42cfdee9">complete_queue</a>(line, word, pos, state);
<a name="l06874"></a>06874    <span class="keywordflow">case</span> 6: <span class="comment">/* &quot;reason&quot; */</span>
<a name="l06875"></a>06875       <span class="keywordflow">return</span> state == 0 ? <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;reason&quot;</span>) : NULL;
<a name="l06876"></a>06876    <span class="keywordflow">case</span> 7: <span class="comment">/* Can&apos;t autocomplete a reason, since it&apos;s 100% customizeable */</span>
<a name="l06877"></a>06877       <span class="keywordflow">return</span> NULL;
<a name="l06878"></a>06878    <span class="keywordflow">default</span>:
<a name="l06879"></a>06879       <span class="keywordflow">return</span> NULL;
<a name="l06880"></a>06880    }
<a name="l06881"></a>06881 }
<a name="l06882"></a>06882 
<a name="l06883"></a><a class="code" href="app__queue_8c.html#a8cd08f19554c293e7455c33b6b225d0a">06883</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a8cd08f19554c293e7455c33b6b225d0a">handle_queue_pause_member</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06884"></a>06884 {
<a name="l06885"></a>06885    <span class="keywordtype">char</span> *queuename, *interface, *reason;
<a name="l06886"></a>06886    <span class="keywordtype">int</span> paused;
<a name="l06887"></a>06887 
<a name="l06888"></a>06888    <span class="keywordflow">switch</span> (cmd) {
<a name="l06889"></a>06889    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06890"></a>06890       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;queue {pause|unpause} member&quot;</span>;
<a name="l06891"></a>06891       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l06892"></a>06892          <span class="stringliteral">&quot;Usage: queue {pause|unpause} member &lt;member&gt; [queue &lt;queue&gt; [reason &lt;reason&gt;]]\n&quot;</span>
<a name="l06893"></a>06893          <span class="stringliteral">&quot;  Pause or unpause a queue member. Not specifying a particular queue\n&quot;</span>
<a name="l06894"></a>06894          <span class="stringliteral">&quot;  will pause or unpause a member across all queues to which the member\n&quot;</span>
<a name="l06895"></a>06895          <span class="stringliteral">&quot;  belongs.\n&quot;</span>;
<a name="l06896"></a>06896       <span class="keywordflow">return</span> NULL;
<a name="l06897"></a>06897    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06898"></a>06898       <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#a4c7d813324c2a5aec46aa9206cbaa912">complete_queue_pause_member</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt; <a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l06899"></a>06899    }
<a name="l06900"></a>06900 
<a name="l06901"></a>06901    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 4 || a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 5 || a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 7 || a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 8) {
<a name="l06902"></a>06902       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06903"></a>06903    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt;= 5 &amp;&amp; strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;queue&quot;</span>)) {
<a name="l06904"></a>06904       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06905"></a>06905    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 8 &amp;&amp; strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[6], <span class="stringliteral">&quot;reason&quot;</span>)) {
<a name="l06906"></a>06906       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06907"></a>06907    }
<a name="l06908"></a>06908 
<a name="l06909"></a>06909 
<a name="l06910"></a>06910    interface = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3];
<a name="l06911"></a>06911    queuename = a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt;= 6 ? a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5] : NULL;
<a name="l06912"></a>06912    reason = a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 8 ? a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[7] : NULL;
<a name="l06913"></a>06913    paused = !strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[1], <span class="stringliteral">&quot;pause&quot;</span>);
<a name="l06914"></a>06914 
<a name="l06915"></a>06915    <span class="keywordflow">if</span> (<a class="code" href="app__queue_8c.html#a5d60239f838c9f941528fb426bcd2290">set_member_paused</a>(queuename, interface, reason, paused) == <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>) {
<a name="l06916"></a>06916       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%spaused interface &apos;%s&apos;&quot;</span>, paused ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;un&quot;</span>, interface);
<a name="l06917"></a>06917       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename))
<a name="l06918"></a>06918          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot; in queue &apos;%s&apos;&quot;</span>, queuename);
<a name="l06919"></a>06919       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(reason))
<a name="l06920"></a>06920          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot; for reason &apos;%s&apos;&quot;</span>, reason);
<a name="l06921"></a>06921       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l06922"></a>06922       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06923"></a>06923    } <span class="keywordflow">else</span> {
<a name="l06924"></a>06924       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unable to %spause interface &apos;%s&apos;&quot;</span>, paused ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;un&quot;</span>, interface);
<a name="l06925"></a>06925       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(queuename))
<a name="l06926"></a>06926          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot; in queue &apos;%s&apos;&quot;</span>, queuename);
<a name="l06927"></a>06927       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(reason))
<a name="l06928"></a>06928          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot; for reason &apos;%s&apos;&quot;</span>, reason);
<a name="l06929"></a>06929       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l06930"></a>06930       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06931"></a>06931    }
<a name="l06932"></a>06932 }
<a name="l06933"></a>06933 
<a name="l06934"></a><a class="code" href="app__queue_8c.html#a9455d30a9242cbfbf390f574f398adf9">06934</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a9455d30a9242cbfbf390f574f398adf9">complete_queue_set_member_penalty</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l06935"></a>06935 {
<a name="l06936"></a>06936    <span class="comment">/* 0 - queue; 1 - set; 2 - penalty; 3 - &lt;penalty&gt;; 4 - on; 5 - &lt;member&gt;; 6 - in; 7 - &lt;queue&gt;;*/</span>
<a name="l06937"></a>06937    <span class="keywordflow">switch</span> (pos) {
<a name="l06938"></a>06938    <span class="keywordflow">case</span> 4:
<a name="l06939"></a>06939       <span class="keywordflow">if</span> (state == 0) {
<a name="l06940"></a>06940          <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;on&quot;</span>);
<a name="l06941"></a>06941       } <span class="keywordflow">else</span> {
<a name="l06942"></a>06942          <span class="keywordflow">return</span> NULL;
<a name="l06943"></a>06943       }
<a name="l06944"></a>06944    <span class="keywordflow">case</span> 6:
<a name="l06945"></a>06945       <span class="keywordflow">if</span> (state == 0) {
<a name="l06946"></a>06946          <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;in&quot;</span>);
<a name="l06947"></a>06947       } <span class="keywordflow">else</span> {
<a name="l06948"></a>06948          <span class="keywordflow">return</span> NULL;
<a name="l06949"></a>06949       }
<a name="l06950"></a>06950    <span class="keywordflow">case</span> 7:
<a name="l06951"></a>06951       <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#af171b6fd3865cf9618ec718d42cfdee9">complete_queue</a>(line, word, pos, state);
<a name="l06952"></a>06952    <span class="keywordflow">default</span>:
<a name="l06953"></a>06953       <span class="keywordflow">return</span> NULL;
<a name="l06954"></a>06954    }
<a name="l06955"></a>06955 }
<a name="l06956"></a>06956  
<a name="l06957"></a><a class="code" href="app__queue_8c.html#ab8cbb9ecaec149b8f265951980818cfc">06957</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#ab8cbb9ecaec149b8f265951980818cfc">handle_queue_set_member_penalty</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06958"></a>06958 {
<a name="l06959"></a>06959    <span class="keywordtype">char</span> *queuename = NULL, *interface;
<a name="l06960"></a>06960    <span class="keywordtype">int</span> penalty = 0;
<a name="l06961"></a>06961 
<a name="l06962"></a>06962    <span class="keywordflow">switch</span> (cmd) {
<a name="l06963"></a>06963    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06964"></a>06964       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;queue set penalty&quot;</span>;
<a name="l06965"></a>06965       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l06966"></a>06966       <span class="stringliteral">&quot;Usage: queue set penalty &lt;penalty&gt; on &lt;interface&gt; [in &lt;queue&gt;]\n&quot;</span>
<a name="l06967"></a>06967       <span class="stringliteral">&quot;  Set a member&apos;s penalty in the queue specified. If no queue is specified\n&quot;</span>
<a name="l06968"></a>06968       <span class="stringliteral">&quot;  then that interface&apos;s penalty is set in all queues to which that interface is a member\n&quot;</span>;
<a name="l06969"></a>06969       <span class="keywordflow">return</span> NULL;
<a name="l06970"></a>06970    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06971"></a>06971       <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#a9455d30a9242cbfbf390f574f398adf9">complete_queue_set_member_penalty</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l06972"></a>06972    }
<a name="l06973"></a>06973 
<a name="l06974"></a>06974    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 6 &amp;&amp; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 8) {
<a name="l06975"></a>06975       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06976"></a>06976    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;on&quot;</span>) || (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 6 &amp;&amp; strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[6], <span class="stringliteral">&quot;in&quot;</span>))) {
<a name="l06977"></a>06977       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06978"></a>06978    }
<a name="l06979"></a>06979 
<a name="l06980"></a>06980    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 8)
<a name="l06981"></a>06981       queuename = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[7];
<a name="l06982"></a>06982    interface = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5];
<a name="l06983"></a>06983    penalty = atoi(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l06984"></a>06984 
<a name="l06985"></a>06985    <span class="keywordflow">switch</span> (<a class="code" href="app__queue_8c.html#a214853f4f35145fe0c543edae51469b0">set_member_penalty</a>(queuename, interface, penalty)) {
<a name="l06986"></a>06986    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>:
<a name="l06987"></a>06987       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Set penalty on interface &apos;%s&apos; from queue &apos;%s&apos;\n&quot;</span>, interface, queuename);
<a name="l06988"></a>06988       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06989"></a>06989    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>:
<a name="l06990"></a>06990       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to set penalty on interface &apos;%s&apos; from queue &apos;%s&apos;\n&quot;</span>, interface, queuename);
<a name="l06991"></a>06991       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06992"></a>06992    <span class="keywordflow">default</span>:
<a name="l06993"></a>06993       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06994"></a>06994    }
<a name="l06995"></a>06995 }
<a name="l06996"></a>06996 
<a name="l06997"></a><a class="code" href="app__queue_8c.html#a19ddc6dbd24b622cdf07e0e0e3e4ce01">06997</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a19ddc6dbd24b622cdf07e0e0e3e4ce01">complete_queue_rule_show</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> <a class="code" href="structqueue__ent.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>) 
<a name="l06998"></a>06998 {
<a name="l06999"></a>06999    <span class="keywordtype">int</span> which = 0;
<a name="l07000"></a>07000    <span class="keyword">struct </span>rule_list *rl_iter;
<a name="l07001"></a>07001    <span class="keywordtype">int</span> wordlen = strlen(word);
<a name="l07002"></a>07002    <span class="keywordtype">char</span> *ret = NULL;
<a name="l07003"></a>07003    <span class="keywordflow">if</span> (pos != 3) <span class="comment">/* Wha? */</span> {
<a name="l07004"></a>07004       <span class="keywordflow">return</span> NULL;
<a name="l07005"></a>07005    }
<a name="l07006"></a>07006 
<a name="l07007"></a>07007    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;rule_lists);
<a name="l07008"></a>07008    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;rule_lists, rl_iter, list) {
<a name="l07009"></a>07009       <span class="keywordflow">if</span> (!strncasecmp(word, rl_iter-&gt;<a class="code" href="structrule__list.html#a3777dbae63a15da001b2baa317a25149">name</a>, wordlen) &amp;&amp; ++which &gt; state) {
<a name="l07010"></a>07010          ret = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(rl_iter-&gt;<a class="code" href="structrule__list.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l07011"></a>07011          <span class="keywordflow">break</span>;
<a name="l07012"></a>07012       }
<a name="l07013"></a>07013    }
<a name="l07014"></a>07014    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;rule_lists);
<a name="l07015"></a>07015 
<a name="l07016"></a>07016    <span class="keywordflow">return</span> ret;
<a name="l07017"></a>07017 }
<a name="l07018"></a>07018 
<a name="l07019"></a><a class="code" href="app__queue_8c.html#aa69c5e8b97eda56a099f72a195f28bea">07019</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#aa69c5e8b97eda56a099f72a195f28bea">handle_queue_rule_show</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l07020"></a>07020 {
<a name="l07021"></a>07021    <span class="keywordtype">char</span> *<a class="code" href="structrule.html">rule</a>;
<a name="l07022"></a>07022    <span class="keyword">struct </span>rule_list *rl_iter;
<a name="l07023"></a>07023    <span class="keyword">struct </span><a class="code" href="structpenalty__rule.html">penalty_rule</a> *pr_iter;
<a name="l07024"></a>07024    <span class="keywordflow">switch</span> (cmd) {
<a name="l07025"></a>07025    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l07026"></a>07026       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;queue show rules&quot;</span>;
<a name="l07027"></a>07027       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l07028"></a>07028       <span class="stringliteral">&quot;Usage: queue show rules [rulename]\n&quot;</span>
<a name="l07029"></a>07029       <span class="stringliteral">&quot;  Show the list of rules associated with rulename. If no\n&quot;</span>
<a name="l07030"></a>07030       <span class="stringliteral">&quot;  rulename is specified, list all rules defined in queuerules.conf\n&quot;</span>;
<a name="l07031"></a>07031       <span class="keywordflow">return</span> NULL;
<a name="l07032"></a>07032    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l07033"></a>07033       <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#a19ddc6dbd24b622cdf07e0e0e3e4ce01">complete_queue_rule_show</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l07034"></a>07034    }
<a name="l07035"></a>07035 
<a name="l07036"></a>07036    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3 &amp;&amp; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l07037"></a>07037       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l07038"></a>07038 
<a name="l07039"></a>07039    rule = a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 4 ? a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3] : <span class="stringliteral">&quot;&quot;</span>;
<a name="l07040"></a>07040    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;rule_lists);
<a name="l07041"></a>07041    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;rule_lists, rl_iter, list) {
<a name="l07042"></a>07042       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(rule) || !strcasecmp(rl_iter-&gt;<a class="code" href="structrule__list.html#a3777dbae63a15da001b2baa317a25149">name</a>, rule)) {
<a name="l07043"></a>07043          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Rule: %s\n&quot;</span>, rl_iter-&gt;<a class="code" href="structrule__list.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l07044"></a>07044          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;rl_iter-&gt;rules, pr_iter, list) {
<a name="l07045"></a>07045             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\tAfter %d seconds, adjust QUEUE_MAX_PENALTY %s %d and adjust QUEUE_MIN_PENALTY %s %d\n&quot;</span>, pr_iter-&gt;<a class="code" href="structpenalty__rule.html#a42715f65f02da52edc5b22021d8ae670">time</a>, pr_iter-&gt;<a class="code" href="structpenalty__rule.html#ae0778c688a39dcc28198f568176370eb">max_relative</a> ? <span class="stringliteral">&quot;by&quot;</span> : <span class="stringliteral">&quot;to&quot;</span>, pr_iter-&gt;<a class="code" href="structpenalty__rule.html#aff3c96df7d67617d6ee82fa1f257ff84">max_value</a>, pr_iter-&gt;<a class="code" href="structpenalty__rule.html#a790961d8e38a4dbcdd59e8c2b0a292b4">min_relative</a> ? <span class="stringliteral">&quot;by&quot;</span> : <span class="stringliteral">&quot;to&quot;</span>, pr_iter-&gt;<a class="code" href="structpenalty__rule.html#a2b15eec5f0109b01f534046bb5c04666">min_value</a>);
<a name="l07046"></a>07046          }
<a name="l07047"></a>07047       }
<a name="l07048"></a>07048    }
<a name="l07049"></a>07049    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;rule_lists);
<a name="l07050"></a>07050    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>; 
<a name="l07051"></a>07051 }
<a name="l07052"></a>07052 
<a name="l07053"></a><a class="code" href="app__queue_8c.html#aab6f3afb06683e692b69f0e886c0bedb">07053</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#aab6f3afb06683e692b69f0e886c0bedb">handle_queue_reset</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l07054"></a>07054 {
<a name="l07055"></a>07055    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> mask = {<a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a845535b8e69c40b11c12b08740d1357c">QUEUE_RESET_STATS</a>,};
<a name="l07056"></a>07056    <span class="keywordtype">int</span> i;
<a name="l07057"></a>07057 
<a name="l07058"></a>07058    <span class="keywordflow">switch</span> (cmd) {
<a name="l07059"></a>07059       <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l07060"></a>07060          e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;queue reset stats&quot;</span>;
<a name="l07061"></a>07061          e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l07062"></a>07062             <span class="stringliteral">&quot;Usage: queue reset stats [&lt;queuenames&gt;]\n&quot;</span>
<a name="l07063"></a>07063             <span class="stringliteral">&quot;\n&quot;</span>
<a name="l07064"></a>07064             <span class="stringliteral">&quot;Issuing this command will reset statistics for\n&quot;</span>
<a name="l07065"></a>07065             <span class="stringliteral">&quot;&lt;queuenames&gt;, or for all queues if no queue is\n&quot;</span>
<a name="l07066"></a>07066             <span class="stringliteral">&quot;specified.\n&quot;</span>;
<a name="l07067"></a>07067          <span class="keywordflow">return</span> NULL;
<a name="l07068"></a>07068       <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l07069"></a>07069          <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> &gt;= 3) {
<a name="l07070"></a>07070             <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#af171b6fd3865cf9618ec718d42cfdee9">complete_queue</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l07071"></a>07071          } <span class="keywordflow">else</span> {
<a name="l07072"></a>07072             <span class="keywordflow">return</span> NULL;
<a name="l07073"></a>07073          }
<a name="l07074"></a>07074    }
<a name="l07075"></a>07075 
<a name="l07076"></a>07076    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 3) {
<a name="l07077"></a>07077       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l07078"></a>07078    }
<a name="l07079"></a>07079 
<a name="l07080"></a>07080    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3) {
<a name="l07081"></a>07081       <a class="code" href="app__queue_8c.html#a321f7a8a2dcb3064e3f719a0fd98c6b5" title="The command center for all reload operations.">reload_handler</a>(1, &amp;mask, NULL);
<a name="l07082"></a>07082       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l07083"></a>07083    }
<a name="l07084"></a>07084 
<a name="l07085"></a>07085    <span class="keywordflow">for</span> (i = 3; i &lt; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>; ++i) {
<a name="l07086"></a>07086       <a class="code" href="app__queue_8c.html#a321f7a8a2dcb3064e3f719a0fd98c6b5" title="The command center for all reload operations.">reload_handler</a>(1, &amp;mask, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[i]);
<a name="l07087"></a>07087    }
<a name="l07088"></a>07088 
<a name="l07089"></a>07089    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l07090"></a>07090 }
<a name="l07091"></a>07091 
<a name="l07092"></a><a class="code" href="app__queue_8c.html#a22f7d751732c215b14ab3e80aec3f541">07092</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a22f7d751732c215b14ab3e80aec3f541">handle_queue_reload</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l07093"></a>07093 {
<a name="l07094"></a>07094    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> mask = {0,};
<a name="l07095"></a>07095    <span class="keywordtype">int</span> i;
<a name="l07096"></a>07096 
<a name="l07097"></a>07097    <span class="keywordflow">switch</span> (cmd) {
<a name="l07098"></a>07098       <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l07099"></a>07099          e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;queue reload {parameters|members|rules|all}&quot;</span>;
<a name="l07100"></a>07100          e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l07101"></a>07101             <span class="stringliteral">&quot;Usage: queue reload {parameters|members|rules|all} [&lt;queuenames&gt;]\n&quot;</span>
<a name="l07102"></a>07102             <span class="stringliteral">&quot;Reload queues. If &lt;queuenames&gt; are specified, only reload information pertaining\n&quot;</span>
<a name="l07103"></a>07103             <span class="stringliteral">&quot;to &lt;queuenames&gt;. One of &apos;parameters,&apos; &apos;members,&apos; &apos;rules,&apos; or &apos;all&apos; must be\n&quot;</span>
<a name="l07104"></a>07104             <span class="stringliteral">&quot;specified in order to know what information to reload. Below is an explanation\n&quot;</span>
<a name="l07105"></a>07105             <span class="stringliteral">&quot;of each of these qualifiers.\n&quot;</span>
<a name="l07106"></a>07106             <span class="stringliteral">&quot;\n&quot;</span>
<a name="l07107"></a>07107             <span class="stringliteral">&quot;\t&apos;members&apos; - reload queue members from queues.conf\n&quot;</span>
<a name="l07108"></a>07108             <span class="stringliteral">&quot;\t&apos;parameters&apos; - reload all queue options except for queue members\n&quot;</span>
<a name="l07109"></a>07109             <span class="stringliteral">&quot;\t&apos;rules&apos; - reload the queuerules.conf file\n&quot;</span>
<a name="l07110"></a>07110             <span class="stringliteral">&quot;\t&apos;all&apos; - reload queue rules, parameters, and members\n&quot;</span>
<a name="l07111"></a>07111             <span class="stringliteral">&quot;\n&quot;</span>
<a name="l07112"></a>07112             <span class="stringliteral">&quot;Note: the &apos;rules&apos; qualifier here cannot actually be applied to a specific queue.\n&quot;</span>
<a name="l07113"></a>07113             <span class="stringliteral">&quot;Use of the &apos;rules&apos; qualifier causes queuerules.conf to be reloaded. Even if only\n&quot;</span>
<a name="l07114"></a>07114             <span class="stringliteral">&quot;one queue is specified when using this command, reloading queue rules may cause\n&quot;</span>
<a name="l07115"></a>07115             <span class="stringliteral">&quot;other queues to be affected\n&quot;</span>;
<a name="l07116"></a>07116          <span class="keywordflow">return</span> NULL;
<a name="l07117"></a>07117       <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l07118"></a>07118          <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> &gt;= 3) {
<a name="l07119"></a>07119             <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#af171b6fd3865cf9618ec718d42cfdee9">complete_queue</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l07120"></a>07120          } <span class="keywordflow">else</span> {
<a name="l07121"></a>07121             <span class="keywordflow">return</span> NULL;
<a name="l07122"></a>07122          }
<a name="l07123"></a>07123    }
<a name="l07124"></a>07124 
<a name="l07125"></a>07125    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 3)
<a name="l07126"></a>07126       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l07127"></a>07127 
<a name="l07128"></a>07128    <span class="keywordflow">if</span> (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], <span class="stringliteral">&quot;rules&quot;</span>)) {
<a name="l07129"></a>07129       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;mask, <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a04da28a6a506fbc6dfce3f3da3569acc">QUEUE_RELOAD_RULES</a>);
<a name="l07130"></a>07130    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], <span class="stringliteral">&quot;members&quot;</span>)) {
<a name="l07131"></a>07131       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;mask, <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398a4fc330b82c294649884cd4d189da8d5f">QUEUE_RELOAD_MEMBER</a>);
<a name="l07132"></a>07132    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], <span class="stringliteral">&quot;parameters&quot;</span>)) {
<a name="l07133"></a>07133       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;mask, <a class="code" href="app__queue_8c.html#abfd16358cfabbb3ad0c435c17883e398ab18e9313e34662b745beabef3ed7ca44">QUEUE_RELOAD_PARAMETERS</a>);
<a name="l07134"></a>07134    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], <span class="stringliteral">&quot;all&quot;</span>)) {
<a name="l07135"></a>07135       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;mask, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l07136"></a>07136    }
<a name="l07137"></a>07137 
<a name="l07138"></a>07138    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3) {
<a name="l07139"></a>07139       <a class="code" href="app__queue_8c.html#a321f7a8a2dcb3064e3f719a0fd98c6b5" title="The command center for all reload operations.">reload_handler</a>(1, &amp;mask, NULL);
<a name="l07140"></a>07140       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l07141"></a>07141    }
<a name="l07142"></a>07142 
<a name="l07143"></a>07143    <span class="keywordflow">for</span> (i = 3; i &lt; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>; ++i) {
<a name="l07144"></a>07144       <a class="code" href="app__queue_8c.html#a321f7a8a2dcb3064e3f719a0fd98c6b5" title="The command center for all reload operations.">reload_handler</a>(1, &amp;mask, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[i]);
<a name="l07145"></a>07145    }
<a name="l07146"></a>07146 
<a name="l07147"></a>07147    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l07148"></a>07148 }
<a name="l07149"></a>07149 
<a name="l07150"></a><a class="code" href="app__queue_8c.html#af46513a5ccf5ec50b65dcf92932c8a96">07150</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="app__queue_8c.html#af46513a5ccf5ec50b65dcf92932c8a96">qpm_cmd_usage</a>[] = 
<a name="l07151"></a>07151 <span class="stringliteral">&quot;Usage: queue pause member &lt;channel&gt; in &lt;queue&gt; reason &lt;reason&gt;\n&quot;</span>;
<a name="l07152"></a>07152 
<a name="l07153"></a><a class="code" href="app__queue_8c.html#aff747212051113c7f19a0d7418f33dcd">07153</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="app__queue_8c.html#aff747212051113c7f19a0d7418f33dcd">qum_cmd_usage</a>[] =
<a name="l07154"></a>07154 <span class="stringliteral">&quot;Usage: queue unpause member &lt;channel&gt; in &lt;queue&gt; reason &lt;reason&gt;\n&quot;</span>;
<a name="l07155"></a>07155 
<a name="l07156"></a><a class="code" href="app__queue_8c.html#ae67130ab63b5d2584242132c412b8d92">07156</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="app__queue_8c.html#ae67130ab63b5d2584242132c412b8d92">qsmp_cmd_usage</a>[] =
<a name="l07157"></a>07157 <span class="stringliteral">&quot;Usage: queue set member penalty &lt;channel&gt; from &lt;queue&gt; &lt;penalty&gt;\n&quot;</span>;
<a name="l07158"></a>07158 
<a name="l07159"></a><a class="code" href="app__queue_8c.html#ae88eeca2bab42ff051da9157696726d4">07159</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="app__queue_8c.html#ae88eeca2bab42ff051da9157696726d4">cli_queue</a>[] = {
<a name="l07160"></a>07160    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__queue_8c.html#a8f11ecb2ece22635477ca2ee913b39e3">queue_show</a>, <span class="stringliteral">&quot;Show status of a specified queue&quot;</span>),
<a name="l07161"></a>07161    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__queue_8c.html#a809b8e2a1be84c1a33a191a1c8ed549f">handle_queue_add_member</a>, <span class="stringliteral">&quot;Add a channel to a specified queue&quot;</span>),
<a name="l07162"></a>07162    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__queue_8c.html#a9b97d0ffb7e1a6127de3acc037ea464b">handle_queue_remove_member</a>, <span class="stringliteral">&quot;Removes a channel from a specified queue&quot;</span>),
<a name="l07163"></a>07163    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__queue_8c.html#a8cd08f19554c293e7455c33b6b225d0a">handle_queue_pause_member</a>, <span class="stringliteral">&quot;Pause or unpause a queue member&quot;</span>),
<a name="l07164"></a>07164    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__queue_8c.html#ab8cbb9ecaec149b8f265951980818cfc">handle_queue_set_member_penalty</a>, <span class="stringliteral">&quot;Set penalty for a channel of a specified queue&quot;</span>),
<a name="l07165"></a>07165    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__queue_8c.html#aa69c5e8b97eda56a099f72a195f28bea">handle_queue_rule_show</a>, <span class="stringliteral">&quot;Show the rules defined in queuerules.conf&quot;</span>),
<a name="l07166"></a>07166    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__queue_8c.html#a22f7d751732c215b14ab3e80aec3f541">handle_queue_reload</a>, <span class="stringliteral">&quot;Reload queues, members, queue rules, or parameters&quot;</span>),
<a name="l07167"></a>07167    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__queue_8c.html#aab6f3afb06683e692b69f0e886c0bedb">handle_queue_reset</a>, <span class="stringliteral">&quot;Reset statistics for a queue&quot;</span>),
<a name="l07168"></a>07168 };
<a name="l07169"></a>07169 
<a name="l07170"></a><a class="code" href="app__queue_8c.html#ad09fa931f468002152a3cc2d5ce25eae">07170</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l07171"></a>07171 {
<a name="l07172"></a>07172    <span class="keywordtype">int</span> res;
<a name="l07173"></a>07173    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con;
<a name="l07174"></a>07174    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> q_iter;
<a name="l07175"></a>07175    <span class="keyword">struct </span><a class="code" href="structcall__queue.html">call_queue</a> *q = NULL;
<a name="l07176"></a>07176 
<a name="l07177"></a>07177    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(cli_queue, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_queue));
<a name="l07178"></a>07178    res = <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;QueueStatus&quot;</span>);
<a name="l07179"></a>07179    res |= <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;Queues&quot;</span>);
<a name="l07180"></a>07180    res |= <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;QueueRule&quot;</span>);
<a name="l07181"></a>07181    res |= <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;QueueSummary&quot;</span>);
<a name="l07182"></a>07182    res |= <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;QueueAdd&quot;</span>);
<a name="l07183"></a>07183    res |= <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;QueueRemove&quot;</span>);
<a name="l07184"></a>07184    res |= <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;QueuePause&quot;</span>);
<a name="l07185"></a>07185    res |= <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;QueueLog&quot;</span>);
<a name="l07186"></a>07186    res |= <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;QueuePenalty&quot;</span>);
<a name="l07187"></a>07187    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app_aqm);
<a name="l07188"></a>07188    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app_rqm);
<a name="l07189"></a>07189    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app_pqm);
<a name="l07190"></a>07190    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app_upqm);
<a name="l07191"></a>07191    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app_ql);
<a name="l07192"></a>07192    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app);
<a name="l07193"></a>07193    res |= <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;queuevar_function);
<a name="l07194"></a>07194    res |= <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;queuemembercount_function);
<a name="l07195"></a>07195    res |= <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;queuemembercount_dep);
<a name="l07196"></a>07196    res |= <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;queuememberlist_function);
<a name="l07197"></a>07197    res |= <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;queuewaitingcount_function);
<a name="l07198"></a>07198    res |= <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;queuememberpenalty_function);
<a name="l07199"></a>07199 
<a name="l07200"></a>07200    <span class="keywordflow">if</span> (device_state_sub)
<a name="l07201"></a>07201       <a class="code" href="event_8h.html#a71eb177cf8553883be773f1534e8a09a" title="Un-subscribe from events.">ast_event_unsubscribe</a>(device_state_sub);
<a name="l07202"></a>07202 
<a name="l07203"></a>07203    <span class="keywordflow">if</span> ((con = <a class="code" href="pbx_8h.html#a2af2d2771e5347b18454a05dbc98e35f" title="Find a context.">ast_context_find</a>(<span class="stringliteral">&quot;app_queue_gosub_virtual_context&quot;</span>))) {
<a name="l07204"></a>07204       <a class="code" href="pbx_8h.html#a25dad382feec89a9bbc6c5284bb30e25" title="This functionc locks given context, search for the right extension and fires out...">ast_context_remove_extension2</a>(con, <span class="stringliteral">&quot;s&quot;</span>, 1, NULL, 0);
<a name="l07205"></a>07205       <a class="code" href="pbx_8h.html#a9546b830c22c693a2baed08e48569401" title="Destroy a context (matches the specified context (or ANY context if NULL).">ast_context_destroy</a>(con, <span class="stringliteral">&quot;app_queue&quot;</span>); <span class="comment">/* leave no trace */</span>
<a name="l07206"></a>07206    }
<a name="l07207"></a>07207 
<a name="l07208"></a>07208    q_iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, 0);
<a name="l07209"></a>07209    <span class="keywordflow">while</span> ((q = <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;q_iter, <span class="stringliteral">&quot;Iterate through queues&quot;</span>))) {
<a name="l07210"></a>07210       <a class="code" href="app__queue_8c.html#a677f1c4c1a61e9e02d180803d8b8a008">queues_t_unlink</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, q, <span class="stringliteral">&quot;Remove queue from container due to unload&quot;</span>);
<a name="l07211"></a>07211       <a class="code" href="app__queue_8c.html#a0194465b67041e02505e5e890e84b9e4">queue_t_unref</a>(q, <span class="stringliteral">&quot;Done with iterator&quot;</span>);
<a name="l07212"></a>07212    }
<a name="l07213"></a>07213    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;q_iter);
<a name="l07214"></a>07214    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(<a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a>, -1);
<a name="l07215"></a>07215    devicestate_tps = <a class="code" href="taskprocessor_8h.html#a32492eb2480cb8c46ad669622cff8556" title="Unreference the specified taskprocessor and its reference count will decrement.">ast_taskprocessor_unreference</a>(devicestate_tps);
<a name="l07216"></a>07216    <a class="code" href="config_8h.html#a66b6af9ceef39cb23b48501efe87219f" title="Release any resources cached for a realtime family.">ast_unload_realtime</a>(<span class="stringliteral">&quot;queue_members&quot;</span>);
<a name="l07217"></a>07217    <span class="keywordflow">return</span> res;
<a name="l07218"></a>07218 }
<a name="l07219"></a>07219 
<a name="l07220"></a><a class="code" href="app__queue_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">07220</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l07221"></a>07221 {
<a name="l07222"></a>07222    <span class="keywordtype">int</span> res;
<a name="l07223"></a>07223    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con;
<a name="l07224"></a>07224    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> mask = {<a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>, };
<a name="l07225"></a>07225 
<a name="l07226"></a>07226    <a class="code" href="app__queue_8c.html#a60c18ff0a82f2460a253a69179aa9534">queues</a> = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(<a class="code" href="app__queue_8c.html#a318c21ecadbe981df2771149df1ed361">MAX_QUEUE_BUCKETS</a>, <a class="code" href="app__queue_8c.html#a9f81db529b7d97134601164c43a945f2">queue_hash_cb</a>, <a class="code" href="app__queue_8c.html#a9a488aa902d38d97f26bbfbb59a22e2b">queue_cmp_cb</a>);
<a name="l07227"></a>07227 
<a name="l07228"></a>07228    use_weight = 0;
<a name="l07229"></a>07229 
<a name="l07230"></a>07230    <span class="keywordflow">if</span> (<a class="code" href="app__queue_8c.html#a321f7a8a2dcb3064e3f719a0fd98c6b5" title="The command center for all reload operations.">reload_handler</a>(0, &amp;mask, NULL))
<a name="l07231"></a>07231       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l07232"></a>07232 
<a name="l07233"></a>07233    con = <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(NULL, NULL, <span class="stringliteral">&quot;app_queue_gosub_virtual_context&quot;</span>, <span class="stringliteral">&quot;app_queue&quot;</span>);
<a name="l07234"></a>07234    <span class="keywordflow">if</span> (!con)
<a name="l07235"></a>07235       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Queue virtual context &apos;app_queue_gosub_virtual_context&apos; does not exist and unable to create\n&quot;</span>);
<a name="l07236"></a>07236    <span class="keywordflow">else</span>
<a name="l07237"></a>07237       <a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(con, 1, <span class="stringliteral">&quot;s&quot;</span>, 1, NULL, NULL, <span class="stringliteral">&quot;NoOp&quot;</span>, <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;&quot;</span>), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, <span class="stringliteral">&quot;app_queue&quot;</span>);
<a name="l07238"></a>07238 
<a name="l07239"></a>07239    <span class="keywordflow">if</span> (queue_persistent_members)
<a name="l07240"></a>07240       <a class="code" href="app__queue_8c.html#a4a18e85dad5b206bccd39112cf9d0002" title="Reload dynamic queue members persisted into the astdb.">reload_queue_members</a>();
<a name="l07241"></a>07241 
<a name="l07242"></a>07242    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(cli_queue, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_queue));
<a name="l07243"></a>07243    res = <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app, <a class="code" href="app__queue_8c.html#a3afbdcfe9fe1e41cd693648e29b4fa78" title="The starting point for all queue calls.">queue_exec</a>);
<a name="l07244"></a>07244    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app_aqm, <a class="code" href="app__queue_8c.html#af19ce2770909b12f1a9c5beb90d7fba2" title="AddQueueMember application.">aqm_exec</a>);
<a name="l07245"></a>07245    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app_rqm, <a class="code" href="app__queue_8c.html#afa57dc74f655759ac27df0cf69dbe9dc" title="RemoveQueueMember application.">rqm_exec</a>);
<a name="l07246"></a>07246    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app_pqm, <a class="code" href="app__queue_8c.html#a243fe57cf3a80bfb2d69d1ef7fdfc45f" title="PauseQueueMember application.">pqm_exec</a>);
<a name="l07247"></a>07247    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app_upqm, <a class="code" href="app__queue_8c.html#a54a8fd8bb1ccb4f91240e07b4ec6980c" title="UnPauseQueueMember application.">upqm_exec</a>);
<a name="l07248"></a>07248    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app_ql, <a class="code" href="app__queue_8c.html#aaa24653e1b1376076e5f4cf9fe617f33" title="QueueLog application.">ql_exec</a>);
<a name="l07249"></a>07249    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;Queues&quot;</span>, 0, <a class="code" href="app__queue_8c.html#ae5d140c0198c679d756844e8858ad4bf">manager_queues_show</a>, <span class="stringliteral">&quot;Queues&quot;</span>);
<a name="l07250"></a>07250    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;QueueStatus&quot;</span>, 0, <a class="code" href="app__queue_8c.html#ad2bd8d5629fdba7d86c59b7d72c892a7" title="Queue status info via AMI.">manager_queues_status</a>, <span class="stringliteral">&quot;Queue Status&quot;</span>);
<a name="l07251"></a>07251    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;QueueSummary&quot;</span>, 0, <a class="code" href="app__queue_8c.html#ace5e218ac5b4850ddcf7cb1a9866da6b" title="Summary of queue info via the AMI.">manager_queues_summary</a>, <span class="stringliteral">&quot;Queue Summary&quot;</span>);
<a name="l07252"></a>07252    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;QueueAdd&quot;</span>, <a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <a class="code" href="app__queue_8c.html#a2ec48379febcdee77d6c659269714dd6">manager_add_queue_member</a>, <span class="stringliteral">&quot;Add interface to queue.&quot;</span>);
<a name="l07253"></a>07253    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;QueueRemove&quot;</span>, <a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <a class="code" href="app__queue_8c.html#abbeea50ec5fd219991763c7a848464ea">manager_remove_queue_member</a>, <span class="stringliteral">&quot;Remove interface from queue.&quot;</span>);
<a name="l07254"></a>07254    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;QueuePause&quot;</span>, <a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <a class="code" href="app__queue_8c.html#ab294d279fc57c00a43df3d8783e10dcf">manager_pause_queue_member</a>, <span class="stringliteral">&quot;Makes a queue member temporarily unavailable&quot;</span>);
<a name="l07255"></a>07255    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;QueueLog&quot;</span>, <a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <a class="code" href="app__queue_8c.html#afc981f304f48009b383c870db6aac776">manager_queue_log_custom</a>, <span class="stringliteral">&quot;Adds custom entry in queue_log&quot;</span>);
<a name="l07256"></a>07256    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;QueuePenalty&quot;</span>, <a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <a class="code" href="app__queue_8c.html#a90a66cbfb007419fb44ca4426265a03d">manager_queue_member_penalty</a>, <span class="stringliteral">&quot;Set the penalty for a queue member&quot;</span>); 
<a name="l07257"></a>07257    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;QueueRule&quot;</span>, 0, <a class="code" href="app__queue_8c.html#a5b0161cb9388c7e8886b1b35a9b54fdc">manager_queue_rule_show</a>, <span class="stringliteral">&quot;Queue Rules&quot;</span>);
<a name="l07258"></a>07258    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;QueueReload&quot;</span>, 0, <a class="code" href="app__queue_8c.html#a6eb92f6a70762912ce80b53e9282204a">manager_queue_reload</a>, <span class="stringliteral">&quot;Reload a queue, queues, or any sub-section of a queue or queues&quot;</span>);
<a name="l07259"></a>07259    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;QueueReset&quot;</span>, 0, <a class="code" href="app__queue_8c.html#a14d56b1e279722b17bc293e06c099b6b">manager_queue_reset</a>, <span class="stringliteral">&quot;Reset queue statistics&quot;</span>);
<a name="l07260"></a>07260    res |= <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;queuevar_function);
<a name="l07261"></a>07261    res |= <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;queuemembercount_function);
<a name="l07262"></a>07262    res |= <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;queuemembercount_dep);
<a name="l07263"></a>07263    res |= <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;queuememberlist_function);
<a name="l07264"></a>07264    res |= <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;queuewaitingcount_function);
<a name="l07265"></a>07265    res |= <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;queuememberpenalty_function);
<a name="l07266"></a>07266 
<a name="l07267"></a>07267    <span class="keywordflow">if</span> (!(devicestate_tps = <a class="code" href="taskprocessor_8h.html#a3d670ce6d9ed07b5db0dae8d2c11d275" title="Get a reference to a taskprocessor with the specified name and create the taskprocessor...">ast_taskprocessor_get</a>(<span class="stringliteral">&quot;app_queue&quot;</span>, 0))) {
<a name="l07268"></a>07268       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;devicestate taskprocessor reference failed - devicestate notifications will not occur\n&quot;</span>);
<a name="l07269"></a>07269    }
<a name="l07270"></a>07270 
<a name="l07271"></a>07271    <span class="keywordflow">if</span> (!(device_state_sub = <a class="code" href="event_8h.html#a517ac17630e7658463b66b309a6ce78f" title="Subscribe to events.">ast_event_subscribe</a>(<a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa8900374a138e7dbbc9da893f27923846">AST_EVENT_DEVICE_STATE</a>, <a class="code" href="app__queue_8c.html#a6fb2c0a540b83365dcdc10b470116e82">device_state_cb</a>, NULL, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a04c78c1362e97d548344c354001c151f">AST_EVENT_IE_END</a>))) {
<a name="l07272"></a>07272       res = -1;
<a name="l07273"></a>07273    }
<a name="l07274"></a>07274 
<a name="l07275"></a>07275    <a class="code" href="config_8h.html#a403ec8b49645ea204e82cb72bb8cf9f4" title="Inform realtime what fields that may be stored.">ast_realtime_require_field</a>(<span class="stringliteral">&quot;queue_members&quot;</span>, <span class="stringliteral">&quot;paused&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a7b4a9e81298a296d3e066ed369727cc4">RQ_INTEGER1</a>, 1, <span class="stringliteral">&quot;uniqueid&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1ab15af464bf1838c9ca91d32ca7a2a1">RQ_UINTEGER2</a>, 5, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l07276"></a>07276 
<a name="l07277"></a>07277    <span class="keywordflow">return</span> res ? <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a> : 0;
<a name="l07278"></a>07278 }
<a name="l07279"></a>07279 
<a name="l07280"></a><a class="code" href="app__queue_8c.html#ad1982509765f4870f1f63412a53ea668">07280</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>)
<a name="l07281"></a>07281 {
<a name="l07282"></a>07282    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> mask = {<a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>,};
<a name="l07283"></a>07283    <a class="code" href="config_8h.html#a66b6af9ceef39cb23b48501efe87219f" title="Release any resources cached for a realtime family.">ast_unload_realtime</a>(<span class="stringliteral">&quot;queue_members&quot;</span>);
<a name="l07284"></a>07284    <a class="code" href="app__queue_8c.html#a321f7a8a2dcb3064e3f719a0fd98c6b5" title="The command center for all reload operations.">reload_handler</a>(1, &amp;mask, NULL);
<a name="l07285"></a>07285    <span class="keywordflow">return</span> 0;
<a name="l07286"></a>07286 }
<a name="l07287"></a>07287 
<a name="l07288"></a>07288 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <span class="stringliteral">&quot;True Call Queueing&quot;</span>,
<a name="l07289"></a>07289       .load = <a class="code" href="app__queue_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>,
<a name="l07290"></a>07290       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l07291"></a>07291       .<a class="code" href="app__queue_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> = <a class="code" href="app__queue_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>,
<a name="l07292"></a>07292           );
<a name="l07293"></a>07293 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:26 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
