<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:42 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>logger.c</h1><a href="logger_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Asterisk Logger</span>
<a name="l00022"></a>00022 <span class="comment"> * </span>
<a name="l00023"></a>00023 <span class="comment"> * Logging routines</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">/*</span>
<a name="l00029"></a>00029 <span class="comment"> * define _ASTERISK_LOGGER_H to prevent the inclusion of logger.h;</span>
<a name="l00030"></a>00030 <span class="comment"> * it redefines LOG_* which we need to define syslog_level_map.</span>
<a name="l00031"></a>00031 <span class="comment"> * later, we force the inclusion of logger.h again.</span>
<a name="l00032"></a>00032 <span class="comment"> */</span>
<a name="l00033"></a><a class="code" href="logger_8c.html#af0f602bd60175108826d865d8c8070aa">00033</a> <span class="preprocessor">#define _ASTERISK_LOGGER_H</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 248643 $&quot;</span>)
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">/*</span>
<a name="l00039"></a>00039 <span class="comment"> * WARNING: additional #include directives should NOT be placed here, they </span>
<a name="l00040"></a>00040 <span class="comment"> * should be placed AFTER &apos;#undef _ASTERISK_LOGGER_H&apos; below</span>
<a name="l00041"></a>00041 <span class="comment"> */</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;asterisk/_private.h&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="paths_8h.html" title="Asterisk file paths, configured in asterisk.conf.">asterisk/paths.h</a>&quot;</span>   <span class="comment">/* use ast_config_AST_LOG_DIR */</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="time_8h.html" title="Time-related functions and macros.">time.h</a>&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#ifdef HAVE_BKTR</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#include &lt;execinfo.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#define MAX_BACKTRACE_FRAMES 20</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a><a class="code" href="logger_8c.html#ac8660f6e6aafab0d2bb2bba1462675ea">00053</a> <span class="preprocessor">#define SYSLOG_NAMES </span><span class="comment">/* so we can map syslog facilities names to their numeric values,</span>
<a name="l00054"></a>00054 <span class="comment">              from &lt;syslog.h&gt; which is included by logger.h */</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;syslog.h&gt;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a><a class="code" href="logger_8c.html#a9abf2993fd03cd30b5fae8dc716b513b">00057</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="logger_8c.html#a9abf2993fd03cd30b5fae8dc716b513b">syslog_level_map</a>[] = {
<a name="l00058"></a>00058    <a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>,
<a name="l00059"></a>00059    LOG_INFO,    <span class="comment">/* arbitrary equivalent of LOG_EVENT */</span>
<a name="l00060"></a>00060    <a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,
<a name="l00061"></a>00061    <a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00062"></a>00062    LOG_ERR,
<a name="l00063"></a>00063    <a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>,
<a name="l00064"></a>00064    LOG_DEBUG
<a name="l00065"></a>00065 };
<a name="l00066"></a>00066 
<a name="l00067"></a><a class="code" href="logger_8c.html#a822273d71a9d7777077c9fc62c4992ab">00067</a> <span class="preprocessor">#define SYSLOG_NLEVELS sizeof(syslog_level_map) / sizeof(int)</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span>
<a name="l00069"></a>00069 <span class="preprocessor">#undef _ASTERISK_LOGGER_H  </span><span class="comment">/* now include logger.h */</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="logger_8h.html" title="Support for logging to various files, console and syslog Configuration in file logger...">asterisk/logger.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="term_8h.html" title="Handy terminal functions for vt* terms.">asterisk/term.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="threadstorage_8h.html" title="Definitions to aid in the use of thread local storage.">asterisk/threadstorage.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="strings_8h.html" title="String manipulation functions.">asterisk/strings.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="preprocessor">#if defined(__linux__) &amp;&amp; !defined(__NR_gettid)</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span><span class="preprocessor">#include &lt;asm/unistd.h&gt;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#endif</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>
<a name="l00087"></a>00087 <span class="preprocessor">#if defined(__linux__) &amp;&amp; defined(__NR_gettid)</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span><span class="preprocessor">#define GETTID() syscall(__NR_gettid)</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00090"></a><a class="code" href="logger_8c.html#a0f11b3d4d80f9720a4a9d94c6441d73b">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define GETTID() getpid()</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>
<a name="l00093"></a><a class="code" href="logger_8c.html#a2057dec53731af6bb6881015b58936ba">00093</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="logger_8c.html#a2057dec53731af6bb6881015b58936ba">dateformat</a>[256] = <span class="stringliteral">&quot;%b %e %T&quot;</span>;    <span class="comment">/* Original Asterisk Format */</span>
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="logger_8c.html#a818fb8d162c63f2848d8bb57bffebd3e">00095</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="logger_8c.html#a818fb8d162c63f2848d8bb57bffebd3e">queue_log_name</a>[256] = <a class="code" href="logger_8h.html#a862a4fc7926f6d3294362303efe690fe">QUEUELOG</a>;
<a name="l00096"></a><a class="code" href="logger_8c.html#a63c5086d15ebc49d28387fcbfa176bf5">00096</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="logger_8c.html#a63c5086d15ebc49d28387fcbfa176bf5">exec_after_rotate</a>[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="logger_8c.html#a2b97f7299bdadbda12e69a1a31c9d28c">00098</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="logger_8c.html#a2b97f7299bdadbda12e69a1a31c9d28c">filesize_reload_needed</a>;
<a name="l00099"></a><a class="code" href="logger_8c.html#af0c601c87c9a26500fb6ab20d5acc2ef">00099</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="logger_8c.html#af0c601c87c9a26500fb6ab20d5acc2ef">global_logmask</a> = -1;
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392">00101</a> <span class="keyword">enum</span> <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392">rotatestrategy</a> {
<a name="l00102"></a><a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a6b834d43476553e583e0fde6578c82f0">00102</a>    <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a6b834d43476553e583e0fde6578c82f0">SEQUENTIAL</a> = 1 &lt;&lt; 0,     <span class="comment">/* Original method - create a new file, in order */</span>
<a name="l00103"></a><a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a3dcfe0046eb5876e287dbf0914819b16">00103</a>    <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a3dcfe0046eb5876e287dbf0914819b16">ROTATE</a> = 1 &lt;&lt; 1,         <span class="comment">/* Rotate all files, such that the oldest file has the highest suffix */</span>
<a name="l00104"></a><a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a3f2dbbd8fe9ad35caa594416336ceeda">00104</a>    <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a3f2dbbd8fe9ad35caa594416336ceeda">TIMESTAMP</a> = 1 &lt;&lt; 2,      <span class="comment">/* Append the epoch timestamp onto the end of the archived file */</span>
<a name="l00105"></a>00105 } <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392">rotatestrategy</a> = <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a6b834d43476553e583e0fde6578c82f0">SEQUENTIAL</a>;
<a name="l00106"></a>00106 
<a name="l00107"></a>00107 <span class="keyword">static</span> <span class="keyword">struct </span>{
<a name="l00108"></a><a class="code" href="logger_8c.html#a9d989b14b09eb7e10daf08b74a8aea30">00108</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="logger_8c.html#a9d989b14b09eb7e10daf08b74a8aea30">queue_log</a>:1;
<a name="l00109"></a><a class="code" href="logger_8c.html#a8e0afc1076b5f0163d20f6105becc4e7">00109</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="logger_8c.html#a8e0afc1076b5f0163d20f6105becc4e7">event_log</a>:1;
<a name="l00110"></a>00110 } <a class="code" href="logger_8c.html#a2a3c47f5d59c8a5754b5d4fea971c819">logfiles</a> = { 1, 1 };
<a name="l00111"></a>00111 
<a name="l00112"></a><a class="code" href="logger_8c.html#af31254e3111773fe1dc68e8dc13df2fe">00112</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="logger_8c.html#af31254e3111773fe1dc68e8dc13df2fe">hostname</a>[<a class="code" href="network_8h.html#afd80ecbe3170ca4fc85b65cda8659f82">MAXHOSTNAMELEN</a>];
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4">00114</a> <span class="keyword">enum</span> <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4">logtypes</a> {
<a name="l00115"></a><a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4affe678f5d32a5ad00d20d138627aa22f">00115</a>    <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4affe678f5d32a5ad00d20d138627aa22f">LOGTYPE_SYSLOG</a>,
<a name="l00116"></a><a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4a82620c2d182f4b50f3801669f747f3aa">00116</a>    <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4a82620c2d182f4b50f3801669f747f3aa">LOGTYPE_FILE</a>,
<a name="l00117"></a><a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4a439c8fd120012113aa39dfece22ed55f">00117</a>    <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4a439c8fd120012113aa39dfece22ed55f">LOGTYPE_CONSOLE</a>,
<a name="l00118"></a>00118 };
<a name="l00119"></a>00119 
<a name="l00120"></a><a class="code" href="structlogchannel.html">00120</a> <span class="keyword">struct </span><a class="code" href="structlogchannel.html">logchannel</a> {
<a name="l00121"></a><a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">00121</a>    <span class="keywordtype">int</span> <a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a>;         <span class="comment">/* What to log to this channel */</span>
<a name="l00122"></a><a class="code" href="structlogchannel.html#af255398e3e9383752e6234829e3f6037">00122</a>    <span class="keywordtype">int</span> <a class="code" href="structlogchannel.html#af255398e3e9383752e6234829e3f6037">disabled</a>;        <span class="comment">/* If this channel is disabled or not */</span>
<a name="l00123"></a><a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">00123</a>    <span class="keywordtype">int</span> <a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a>;        <span class="comment">/* syslog facility */</span>
<a name="l00124"></a><a class="code" href="structlogchannel.html#a6d3cd9e6800461f549a4fcabae1712c1">00124</a>    <span class="keyword">enum</span> <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4">logtypes</a> <a class="code" href="structlogchannel.html#a6d3cd9e6800461f549a4fcabae1712c1">type</a>;     <span class="comment">/* Type of log channel */</span>
<a name="l00125"></a><a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">00125</a>    FILE *<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a>;       <span class="comment">/* logfile logging file pointer */</span>
<a name="l00126"></a><a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">00126</a>    <span class="keywordtype">char</span> <a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>[256];     <span class="comment">/* Filename */</span>
<a name="l00127"></a><a class="code" href="structlogchannel.html#a24aaefbc5516dca5dbe245b41e34acf5">00127</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structlogchannel.html">logchannel</a>) <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>;
<a name="l00128"></a>00128 };
<a name="l00129"></a>00129 
<a name="l00130"></a><a class="code" href="structlogchannels.html#ace4e0066a5b24f84b90536e9906619f6">00130</a> static <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structlogchannels.html">logchannels</a>, <a class="code" href="structlogchannel.html">logchannel</a>);
<a name="l00131"></a>00131 
<a name="l00132"></a><a class="code" href="logger_8c.html#a29df94a387c835e6296b05418885993e">00132</a> enum <a class="code" href="logger_8c.html#a29df94a387c835e6296b05418885993e">logmsgtypes</a> {
<a name="l00133"></a><a class="code" href="logger_8c.html#a29df94a387c835e6296b05418885993ea4ff7bef379df472011e5516f51160e2c">00133</a>    <a class="code" href="logger_8c.html#a29df94a387c835e6296b05418885993ea4ff7bef379df472011e5516f51160e2c">LOGMSG_NORMAL</a> = 0,
<a name="l00134"></a><a class="code" href="logger_8c.html#a29df94a387c835e6296b05418885993eae66ea31ebaa61ba9cac6412f3f9f21c7">00134</a>    <a class="code" href="logger_8c.html#a29df94a387c835e6296b05418885993eae66ea31ebaa61ba9cac6412f3f9f21c7">LOGMSG_VERBOSE</a>,
<a name="l00135"></a>00135 };
<a name="l00136"></a>00136 
<a name="l00137"></a><a class="code" href="structlogmsg.html">00137</a> <span class="keyword">struct </span><a class="code" href="structlogmsg.html">logmsg</a> {
<a name="l00138"></a><a class="code" href="structlogmsg.html#ac85f938a8e2e1945cc672e4886cfb9e8">00138</a>    <span class="keyword">enum</span> <a class="code" href="logger_8c.html#a29df94a387c835e6296b05418885993e">logmsgtypes</a> <a class="code" href="structlogchannel.html#a6d3cd9e6800461f549a4fcabae1712c1">type</a>;
<a name="l00139"></a><a class="code" href="structlogmsg.html#a4e839704872ed7546e92d346f353dbb6">00139</a>    <span class="keywordtype">char</span> date[256];
<a name="l00140"></a><a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">00140</a>    <span class="keywordtype">int</span> level;
<a name="l00141"></a><a class="code" href="structlogmsg.html#ae97b19517c9f0cdda8fe4b87949e51e6">00141</a>    <span class="keywordtype">char</span> file[80];
<a name="l00142"></a><a class="code" href="structlogmsg.html#a41ebd28ef1d7c6ade45642cb6acc1039">00142</a>    <span class="keywordtype">int</span> line;
<a name="l00143"></a><a class="code" href="structlogmsg.html#abe54135be1a457ab08fe76825a6f2691">00143</a>    <span class="keywordtype">char</span> function[80];
<a name="l00144"></a><a class="code" href="structlogmsg.html#a3d369159085eab613678b5bc87d8d948">00144</a>    <span class="keywordtype">long</span> process_id;
<a name="l00145"></a><a class="code" href="structlogmsg.html#a6e3efb045d98a2c5c40e43d2980b2e55">00145</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structlogmsg.html">logmsg</a>) <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>;
<a name="l00146"></a><a class="code" href="structlogmsg.html#a21c9b0fee88b9f35e718afe5d065d676">00146</a>    <span class="keywordtype">char</span> <a class="code" href="app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>[0];
<a name="l00147"></a>00147 };
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="structlogmsgs.html#adf04f66344e3fb0a6f6a69bf39d19902">00149</a> static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(<a class="code" href="structlogmsgs.html">logmsgs</a>, <a class="code" href="structlogmsg.html">logmsg</a>);
<a name="l00150"></a><a class="code" href="logger_8c.html#a6685bab4f7be49a081c4d2efe4b77a23">00150</a> static pthread_t <a class="code" href="logger_8c.html#a6685bab4f7be49a081c4d2efe4b77a23">logthread</a> = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l00151"></a><a class="code" href="logger_8c.html#abb118951a9d7c498a6e28454e7eb0bd5">00151</a> static <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> <a class="code" href="logger_8c.html#abb118951a9d7c498a6e28454e7eb0bd5">logcond</a>;
<a name="l00152"></a><a class="code" href="logger_8c.html#a38ac6d8ec7483171f8a13fed360b6ced">00152</a> static <span class="keywordtype">int</span> <a class="code" href="logger_8c.html#a38ac6d8ec7483171f8a13fed360b6ced">close_logger_thread</a> = 0;
<a name="l00153"></a>00153 
<a name="l00154"></a><a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">00154</a> static FILE *<a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a>;
<a name="l00155"></a><a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">00155</a> static FILE *<a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a>;
<a name="l00156"></a>00156 <span class="comment"></span>
<a name="l00157"></a>00157 <span class="comment">/*! \brief Logging channels used in the Asterisk logging system */</span>
<a name="l00158"></a><a class="code" href="logger_8c.html#a004b893a4391189108c29182f992a68a">00158</a> static <span class="keywordtype">char</span> *<a class="code" href="logger_8c.html#a004b893a4391189108c29182f992a68a" title="Logging channels used in the Asterisk logging system.">levels</a>[] = {
<a name="l00159"></a>00159    <span class="stringliteral">&quot;DEBUG&quot;</span>,
<a name="l00160"></a>00160    <span class="stringliteral">&quot;EVENT&quot;</span>,
<a name="l00161"></a>00161    <span class="stringliteral">&quot;NOTICE&quot;</span>,
<a name="l00162"></a>00162    <span class="stringliteral">&quot;WARNING&quot;</span>,
<a name="l00163"></a>00163    <span class="stringliteral">&quot;ERROR&quot;</span>,
<a name="l00164"></a>00164    <span class="stringliteral">&quot;VERBOSE&quot;</span>,
<a name="l00165"></a>00165    <span class="stringliteral">&quot;DTMF&quot;</span>
<a name="l00166"></a>00166 };
<a name="l00167"></a>00167 <span class="comment"></span>
<a name="l00168"></a>00168 <span class="comment">/*! \brief Colors used in the console for logging */</span>
<a name="l00169"></a><a class="code" href="logger_8c.html#ae8cf707953b0478b5a77d65a7704015b">00169</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="logger_8c.html#ae8cf707953b0478b5a77d65a7704015b" title="Colors used in the console for logging.">colors</a>[] = {
<a name="l00170"></a>00170    <a class="code" href="term_8h.html#a0149574f00c0892ce71ca7964e69672b">COLOR_BRGREEN</a>,
<a name="l00171"></a>00171    <a class="code" href="term_8h.html#afdd2f35b8aaec284ad2ec54ef2d3831c">COLOR_BRBLUE</a>,
<a name="l00172"></a>00172    <a class="code" href="term_8h.html#a4534b577b74a58b0f4b7be027af664e0">COLOR_YELLOW</a>,
<a name="l00173"></a>00173    <a class="code" href="term_8h.html#a1851f8a3f25e5caf6183dc44af070d0d">COLOR_BRRED</a>,
<a name="l00174"></a>00174    <a class="code" href="term_8h.html#ad86358bf19927183dd7b4ae215a29731">COLOR_RED</a>,
<a name="l00175"></a>00175    <a class="code" href="term_8h.html#afc9149f5de51bd9ac4f5ebbfa153f018">COLOR_GREEN</a>,
<a name="l00176"></a>00176    <a class="code" href="term_8h.html#a0149574f00c0892ce71ca7964e69672b">COLOR_BRGREEN</a>
<a name="l00177"></a>00177 };
<a name="l00178"></a>00178 
<a name="l00179"></a><a class="code" href="logger_8c.html#a5a468f362fab520a3eb3bf152d84884a">00179</a> <a class="code" href="threadstorage_8h.html#ac268c0a8272ec11e73269392507fb1a6" title="Define a thread storage variable.">AST_THREADSTORAGE</a>(<a class="code" href="logger_8c.html#a5a468f362fab520a3eb3bf152d84884a">verbose_buf</a>);
<a name="l00180"></a><a class="code" href="logger_8c.html#abb718d66b0fc16699d625172b7117f94">00180</a> <span class="preprocessor">#define VERBOSE_BUF_INIT_SIZE   256</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span>
<a name="l00182"></a><a class="code" href="logger_8c.html#ad073beb53a8f82626a23cd86f79e587e">00182</a> <a class="code" href="threadstorage_8h.html#ac268c0a8272ec11e73269392507fb1a6" title="Define a thread storage variable.">AST_THREADSTORAGE</a>(<a class="code" href="logger_8c.html#ad073beb53a8f82626a23cd86f79e587e">log_buf</a>);
<a name="l00183"></a><a class="code" href="logger_8c.html#a823b00a2a06078bfb2e4aeb974ae9536">00183</a> <span class="preprocessor">#define LOG_BUF_INIT_SIZE       256</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span>
<a name="l00185"></a><a class="code" href="logger_8c.html#aa72654e2dd70fa46a9e543a7ad98f453">00185</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="logger_8c.html#aa72654e2dd70fa46a9e543a7ad98f453">make_components</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> lineno)
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187    <span class="keywordtype">char</span> *w;
<a name="l00188"></a>00188    <span class="keywordtype">int</span> res = 0;
<a name="l00189"></a>00189    <span class="keywordtype">char</span> *stringp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(s);
<a name="l00190"></a>00190 
<a name="l00191"></a>00191    <span class="keywordflow">while</span> ((w = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>))) {
<a name="l00192"></a>00192       w = <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(w);
<a name="l00193"></a>00193       <span class="keywordflow">if</span> (!strcasecmp(w, <span class="stringliteral">&quot;error&quot;</span>)) 
<a name="l00194"></a>00194          res |= (1 &lt;&lt; <a class="code" href="logger_8h.html#a0fcdc410e3e9fbb251fd0c4f8581d96c">__LOG_ERROR</a>);
<a name="l00195"></a>00195       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(w, <span class="stringliteral">&quot;warning&quot;</span>))
<a name="l00196"></a>00196          res |= (1 &lt;&lt; <a class="code" href="logger_8h.html#abdaf681117cfed901932cc0d38f1447a">__LOG_WARNING</a>);
<a name="l00197"></a>00197       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(w, <span class="stringliteral">&quot;notice&quot;</span>))
<a name="l00198"></a>00198          res |= (1 &lt;&lt; <a class="code" href="logger_8h.html#aa2665cd768af07cf474d06204e408e2c">__LOG_NOTICE</a>);
<a name="l00199"></a>00199       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(w, <span class="stringliteral">&quot;event&quot;</span>))
<a name="l00200"></a>00200          res |= (1 &lt;&lt; <a class="code" href="logger_8h.html#aecd368d88763d02ce570d9f1d6734c9c">__LOG_EVENT</a>);
<a name="l00201"></a>00201       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(w, <span class="stringliteral">&quot;debug&quot;</span>))
<a name="l00202"></a>00202          res |= (1 &lt;&lt; <a class="code" href="logger_8h.html#aaecc0363c3e5c2798fb8ed372c9a3d56">__LOG_DEBUG</a>);
<a name="l00203"></a>00203       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(w, <span class="stringliteral">&quot;verbose&quot;</span>))
<a name="l00204"></a>00204          res |= (1 &lt;&lt; <a class="code" href="logger_8h.html#aa11fae1314f286da3d57ae8c07ec4bca">__LOG_VERBOSE</a>);
<a name="l00205"></a>00205       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(w, <span class="stringliteral">&quot;dtmf&quot;</span>))
<a name="l00206"></a>00206          res |= (1 &lt;&lt; <a class="code" href="logger_8h.html#a71e644784b527384f60776ab18ac8bce">__LOG_DTMF</a>);
<a name="l00207"></a>00207       <span class="keywordflow">else</span> {
<a name="l00208"></a>00208          fprintf(stderr, <span class="stringliteral">&quot;Logfile Warning: Unknown keyword &apos;%s&apos; at line %d of logger.conf\n&quot;</span>, w, lineno);
<a name="l00209"></a>00209       }
<a name="l00210"></a>00210    }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212    <span class="keywordflow">return</span> res;
<a name="l00213"></a>00213 }
<a name="l00214"></a>00214 
<a name="l00215"></a><a class="code" href="logger_8c.html#a7f7e66bac39478c958363401f9d5d9b9">00215</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structlogchannel.html">logchannel</a> *<a class="code" href="logger_8c.html#a7f7e66bac39478c958363401f9d5d9b9">make_logchannel</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *channel, <span class="keyword">const</span> <span class="keywordtype">char</span> *components, <span class="keywordtype">int</span> lineno)
<a name="l00216"></a>00216 {
<a name="l00217"></a>00217    <span class="keyword">struct </span><a class="code" href="structlogchannel.html">logchannel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00218"></a>00218    <span class="keywordtype">char</span> *<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a>;
<a name="l00219"></a>00219 <span class="preprocessor">#ifndef SOLARIS</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span>   CODE *cptr;
<a name="l00221"></a>00221 <span class="preprocessor">#endif</span>
<a name="l00222"></a>00222 <span class="preprocessor"></span>
<a name="l00223"></a>00223    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(channel) || !(chan = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*chan))))
<a name="l00224"></a>00224       <span class="keywordflow">return</span> NULL;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226    <span class="keywordflow">if</span> (!strcasecmp(channel, <span class="stringliteral">&quot;console&quot;</span>)) {
<a name="l00227"></a>00227       chan-&gt;<a class="code" href="structlogchannel.html#a6d3cd9e6800461f549a4fcabae1712c1">type</a> = <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4a439c8fd120012113aa39dfece22ed55f">LOGTYPE_CONSOLE</a>;
<a name="l00228"></a>00228    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(channel, <span class="stringliteral">&quot;syslog&quot;</span>, 6)) {
<a name="l00229"></a>00229       <span class="comment">/*</span>
<a name="l00230"></a>00230 <span class="comment">      * syntax is:</span>
<a name="l00231"></a>00231 <span class="comment">      *  syslog.facility =&gt; level,level,level</span>
<a name="l00232"></a>00232 <span class="comment">      */</span>
<a name="l00233"></a>00233       facility = strchr(channel, <span class="charliteral">&apos;.&apos;</span>);
<a name="l00234"></a>00234       <span class="keywordflow">if</span> (!facility++ || !facility) {
<a name="l00235"></a>00235          facility = <span class="stringliteral">&quot;local0&quot;</span>;
<a name="l00236"></a>00236       }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238 <span class="preprocessor">#ifndef SOLARIS</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span>      <span class="comment">/*</span>
<a name="l00240"></a>00240 <span class="comment">      * Walk through the list of facilitynames (defined in sys/syslog.h)</span>
<a name="l00241"></a>00241 <span class="comment">      * to see if we can find the one we have been given</span>
<a name="l00242"></a>00242 <span class="comment">      */</span>
<a name="l00243"></a>00243       chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = -1;
<a name="l00244"></a>00244       cptr = facilitynames;
<a name="l00245"></a>00245       <span class="keywordflow">while</span> (cptr-&gt;c_name) {
<a name="l00246"></a>00246          <span class="keywordflow">if</span> (!strcasecmp(facility, cptr-&gt;c_name)) {
<a name="l00247"></a>00247             chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = cptr-&gt;c_val;
<a name="l00248"></a>00248             <span class="keywordflow">break</span>;
<a name="l00249"></a>00249          }
<a name="l00250"></a>00250          cptr++;
<a name="l00251"></a>00251       }
<a name="l00252"></a>00252 <span class="preprocessor">#else</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span>      chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = -1;
<a name="l00254"></a>00254       <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;kern&quot;</span>)) 
<a name="l00255"></a>00255          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_KERN;
<a name="l00256"></a>00256       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;USER&quot;</span>)) 
<a name="l00257"></a>00257          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_USER;
<a name="l00258"></a>00258       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;MAIL&quot;</span>)) 
<a name="l00259"></a>00259          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_MAIL;
<a name="l00260"></a>00260       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;DAEMON&quot;</span>)) 
<a name="l00261"></a>00261          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_DAEMON;
<a name="l00262"></a>00262       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;AUTH&quot;</span>)) 
<a name="l00263"></a>00263          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_AUTH;
<a name="l00264"></a>00264       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;SYSLOG&quot;</span>)) 
<a name="l00265"></a>00265          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_SYSLOG;
<a name="l00266"></a>00266       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;LPR&quot;</span>)) 
<a name="l00267"></a>00267          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_LPR;
<a name="l00268"></a>00268       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;NEWS&quot;</span>)) 
<a name="l00269"></a>00269          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_NEWS;
<a name="l00270"></a>00270       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;UUCP&quot;</span>)) 
<a name="l00271"></a>00271          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_UUCP;
<a name="l00272"></a>00272       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;CRON&quot;</span>)) 
<a name="l00273"></a>00273          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_CRON;
<a name="l00274"></a>00274       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;LOCAL0&quot;</span>)) 
<a name="l00275"></a>00275          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_LOCAL0;
<a name="l00276"></a>00276       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;LOCAL1&quot;</span>)) 
<a name="l00277"></a>00277          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_LOCAL1;
<a name="l00278"></a>00278       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;LOCAL2&quot;</span>)) 
<a name="l00279"></a>00279          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_LOCAL2;
<a name="l00280"></a>00280       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;LOCAL3&quot;</span>)) 
<a name="l00281"></a>00281          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_LOCAL3;
<a name="l00282"></a>00282       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;LOCAL4&quot;</span>)) 
<a name="l00283"></a>00283          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_LOCAL4;
<a name="l00284"></a>00284       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;LOCAL5&quot;</span>)) 
<a name="l00285"></a>00285          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_LOCAL5;
<a name="l00286"></a>00286       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;LOCAL6&quot;</span>)) 
<a name="l00287"></a>00287          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_LOCAL6;
<a name="l00288"></a>00288       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(facility, <span class="stringliteral">&quot;LOCAL7&quot;</span>)) 
<a name="l00289"></a>00289          chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a> = LOG_LOCAL7;
<a name="l00290"></a>00290 <span class="preprocessor">#endif </span><span class="comment">/* Solaris */</span>
<a name="l00291"></a>00291 
<a name="l00292"></a>00292       <span class="keywordflow">if</span> (0 &gt; chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a>) {
<a name="l00293"></a>00293          fprintf(stderr, <span class="stringliteral">&quot;Logger Warning: bad syslog facility in logger.conf\n&quot;</span>);
<a name="l00294"></a>00294          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(chan);
<a name="l00295"></a>00295          <span class="keywordflow">return</span> NULL;
<a name="l00296"></a>00296       }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298       chan-&gt;<a class="code" href="structlogchannel.html#a6d3cd9e6800461f549a4fcabae1712c1">type</a> = <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4affe678f5d32a5ad00d20d138627aa22f">LOGTYPE_SYSLOG</a>;
<a name="l00299"></a>00299       snprintf(chan-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>), <span class="stringliteral">&quot;%s&quot;</span>, channel);
<a name="l00300"></a>00300       openlog(<span class="stringliteral">&quot;asterisk&quot;</span>, LOG_PID, chan-&gt;<a class="code" href="structlogchannel.html#a213afa2e73e0c2102f43d4067e41b90f">facility</a>);
<a name="l00301"></a>00301    } <span class="keywordflow">else</span> {
<a name="l00302"></a>00302       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(hostname)) {
<a name="l00303"></a>00303          snprintf(chan-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>), <span class="stringliteral">&quot;%s/%s.%s&quot;</span>,
<a name="l00304"></a>00304              channel[0] != <span class="charliteral">&apos;/&apos;</span> ? <a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a> : <span class="stringliteral">&quot;&quot;</span>, channel, hostname);
<a name="l00305"></a>00305       } <span class="keywordflow">else</span> {
<a name="l00306"></a>00306          snprintf(chan-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>), <span class="stringliteral">&quot;%s/%s&quot;</span>,
<a name="l00307"></a>00307              channel[0] != <span class="charliteral">&apos;/&apos;</span> ? <a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a> : <span class="stringliteral">&quot;&quot;</span>, channel);
<a name="l00308"></a>00308       }
<a name="l00309"></a>00309       chan-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a> = fopen(chan-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>, <span class="stringliteral">&quot;a&quot;</span>);
<a name="l00310"></a>00310       <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a>) {
<a name="l00311"></a>00311          <span class="comment">/* Can&apos;t log here, since we&apos;re called with a lock */</span>
<a name="l00312"></a>00312          fprintf(stderr, <span class="stringliteral">&quot;Logger Warning: Unable to open log file &apos;%s&apos;: %s\n&quot;</span>, chan-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00313"></a>00313       } 
<a name="l00314"></a>00314       chan-&gt;<a class="code" href="structlogchannel.html#a6d3cd9e6800461f549a4fcabae1712c1">type</a> = <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4a82620c2d182f4b50f3801669f747f3aa">LOGTYPE_FILE</a>;
<a name="l00315"></a>00315    }
<a name="l00316"></a>00316    chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a> = <a class="code" href="logger_8c.html#aa72654e2dd70fa46a9e543a7ad98f453">make_components</a>(components, lineno);
<a name="l00317"></a>00317    <span class="keywordflow">return</span> chan;
<a name="l00318"></a>00318 }
<a name="l00319"></a>00319 
<a name="l00320"></a><a class="code" href="logger_8c.html#aaafd457f419506fd0aad9fcf2f8704e0">00320</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="logger_8c.html#aaafd457f419506fd0aad9fcf2f8704e0">init_logger_chain</a>(<span class="keywordtype">int</span> locked)
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322    <span class="keyword">struct </span><a class="code" href="structlogchannel.html">logchannel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00323"></a>00323    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l00324"></a>00324    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l00325"></a>00325    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00326"></a>00326    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { 0 };
<a name="l00327"></a>00327 
<a name="l00328"></a>00328    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8h.html#aab3eac8fa82a86a93c074deb7b77dbc9" title="Load a config file.">ast_config_load2</a>(<span class="stringliteral">&quot;logger.conf&quot;</span>, <span class="stringliteral">&quot;logger&quot;</span>, config_flags)) || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>)
<a name="l00329"></a>00329       <span class="keywordflow">return</span>;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331    <span class="comment">/* delete our list of log channels */</span>
<a name="l00332"></a>00332    <span class="keywordflow">if</span> (!locked)
<a name="l00333"></a>00333       <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00334"></a>00334    <span class="keywordflow">while</span> ((chan = <a class="code" href="linkedlists_8h.html#a3d3aa4fb3b4ba38ad8d6d255d97e037c">AST_RWLIST_REMOVE_HEAD</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>)))
<a name="l00335"></a>00335       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(chan);
<a name="l00336"></a>00336    <span class="keywordflow">if</span> (!locked)
<a name="l00337"></a>00337       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00338"></a>00338    
<a name="l00339"></a>00339    global_logmask = 0;
<a name="l00340"></a>00340    <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l00341"></a>00341    <span class="comment">/* close syslog */</span>
<a name="l00342"></a>00342    closelog();
<a name="l00343"></a>00343    
<a name="l00344"></a>00344    <span class="comment">/* If no config file, we&apos;re fine, set default options. */</span>
<a name="l00345"></a>00345    <span class="keywordflow">if</span> (!cfg) {
<a name="l00346"></a>00346       <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>)
<a name="l00347"></a>00347          fprintf(stderr, <span class="stringliteral">&quot;Unable to open logger.conf: %s; default settings will be used.\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00348"></a>00348       <span class="keywordflow">else</span>
<a name="l00349"></a>00349          fprintf(stderr, <span class="stringliteral">&quot;Errors detected in logger.conf: see above; default settings will be used.\n&quot;</span>);
<a name="l00350"></a>00350       <span class="keywordflow">if</span> (!(chan = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*chan))))
<a name="l00351"></a>00351          <span class="keywordflow">return</span>;
<a name="l00352"></a>00352       chan-&gt;<a class="code" href="structlogchannel.html#a6d3cd9e6800461f549a4fcabae1712c1">type</a> = <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4a439c8fd120012113aa39dfece22ed55f">LOGTYPE_CONSOLE</a>;
<a name="l00353"></a>00353       chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a> = 28; <span class="comment">/*warning,notice,error */</span>
<a name="l00354"></a>00354       <span class="keywordflow">if</span> (!locked)
<a name="l00355"></a>00355          <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00356"></a>00356       <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>, chan, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>);
<a name="l00357"></a>00357       <span class="keywordflow">if</span> (!locked)
<a name="l00358"></a>00358          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00359"></a>00359       global_logmask |= chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a>;
<a name="l00360"></a>00360       <span class="keywordflow">return</span>;
<a name="l00361"></a>00361    }
<a name="l00362"></a>00362    
<a name="l00363"></a>00363    <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;appendhostname&quot;</span>))) {
<a name="l00364"></a>00364       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(s)) {
<a name="l00365"></a>00365          <span class="keywordflow">if</span> (gethostname(hostname, <span class="keyword">sizeof</span>(hostname) - 1)) {
<a name="l00366"></a>00366             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(hostname, <span class="stringliteral">&quot;unknown&quot;</span>, <span class="keyword">sizeof</span>(hostname));
<a name="l00367"></a>00367             fprintf(stderr, <span class="stringliteral">&quot;What box has no hostname???\n&quot;</span>);
<a name="l00368"></a>00368          }
<a name="l00369"></a>00369       } <span class="keywordflow">else</span>
<a name="l00370"></a>00370          hostname[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00371"></a>00371    } <span class="keywordflow">else</span>
<a name="l00372"></a>00372       hostname[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00373"></a>00373    <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;dateformat&quot;</span>)))
<a name="l00374"></a>00374       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dateformat, s, <span class="keyword">sizeof</span>(dateformat));
<a name="l00375"></a>00375    <span class="keywordflow">else</span>
<a name="l00376"></a>00376       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dateformat, <span class="stringliteral">&quot;%b %e %T&quot;</span>, <span class="keyword">sizeof</span>(dateformat));
<a name="l00377"></a>00377    <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;queue_log&quot;</span>)))
<a name="l00378"></a>00378       <a class="code" href="logger_8c.html#a2a3c47f5d59c8a5754b5d4fea971c819">logfiles</a>.queue_log = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(s);
<a name="l00379"></a>00379    <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;event_log&quot;</span>)))
<a name="l00380"></a>00380       <a class="code" href="logger_8c.html#a2a3c47f5d59c8a5754b5d4fea971c819">logfiles</a>.event_log = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(s);
<a name="l00381"></a>00381    <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;queue_log_name&quot;</span>)))
<a name="l00382"></a>00382       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(queue_log_name, s, <span class="keyword">sizeof</span>(queue_log_name));
<a name="l00383"></a>00383    <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;exec_after_rotate&quot;</span>)))
<a name="l00384"></a>00384       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(exec_after_rotate, s, <span class="keyword">sizeof</span>(exec_after_rotate));
<a name="l00385"></a>00385    <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;rotatestrategy&quot;</span>))) {
<a name="l00386"></a>00386       <span class="keywordflow">if</span> (strcasecmp(s, <span class="stringliteral">&quot;timestamp&quot;</span>) == 0)
<a name="l00387"></a>00387          <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392">rotatestrategy</a> = <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a3f2dbbd8fe9ad35caa594416336ceeda">TIMESTAMP</a>;
<a name="l00388"></a>00388       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcasecmp(s, <span class="stringliteral">&quot;rotate&quot;</span>) == 0)
<a name="l00389"></a>00389          <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392">rotatestrategy</a> = <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a3dcfe0046eb5876e287dbf0914819b16">ROTATE</a>;
<a name="l00390"></a>00390       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcasecmp(s, <span class="stringliteral">&quot;sequential&quot;</span>) == 0)
<a name="l00391"></a>00391          <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392">rotatestrategy</a> = <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a6b834d43476553e583e0fde6578c82f0">SEQUENTIAL</a>;
<a name="l00392"></a>00392       <span class="keywordflow">else</span>
<a name="l00393"></a>00393          fprintf(stderr, <span class="stringliteral">&quot;Unknown rotatestrategy: %s\n&quot;</span>, s);
<a name="l00394"></a>00394    } <span class="keywordflow">else</span> {
<a name="l00395"></a>00395       <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;rotatetimestamp&quot;</span>))) {
<a name="l00396"></a>00396          <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392">rotatestrategy</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(s) ? <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a3f2dbbd8fe9ad35caa594416336ceeda">TIMESTAMP</a> : <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a6b834d43476553e583e0fde6578c82f0">SEQUENTIAL</a>;
<a name="l00397"></a>00397          fprintf(stderr, <span class="stringliteral">&quot;rotatetimestamp option has been deprecated.  Please use rotatestrategy instead.\n&quot;</span>);
<a name="l00398"></a>00398       }
<a name="l00399"></a>00399    }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401    <span class="keywordflow">if</span> (!locked)
<a name="l00402"></a>00402       <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00403"></a>00403    var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;logfiles&quot;</span>);
<a name="l00404"></a>00404    <span class="keywordflow">for</span> (; var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00405"></a>00405       <span class="keywordflow">if</span> (!(chan = <a class="code" href="logger_8c.html#a7f7e66bac39478c958363401f9d5d9b9">make_logchannel</a>(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, var-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>)))
<a name="l00406"></a>00406          <span class="keywordflow">continue</span>;
<a name="l00407"></a>00407       <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>, chan, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>);
<a name="l00408"></a>00408       global_logmask |= chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a>;
<a name="l00409"></a>00409    }
<a name="l00410"></a>00410    <span class="keywordflow">if</span> (!locked)
<a name="l00411"></a>00411       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l00414"></a>00414 }
<a name="l00415"></a>00415 
<a name="l00416"></a><a class="code" href="logger_8c.html#abe937354501761e17f2d2163d1f8ac87">00416</a> <span class="keywordtype">void</span> <a class="code" href="logger_8h.html#abe937354501761e17f2d2163d1f8ac87">ast_child_verbose</a>(<span class="keywordtype">int</span> level, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...)
<a name="l00417"></a>00417 {
<a name="l00418"></a>00418    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a> = NULL, *emsg = NULL, *sptr, *eptr;
<a name="l00419"></a>00419    va_list ap, aq;
<a name="l00420"></a>00420    <span class="keywordtype">int</span> size;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422    <span class="comment">/* Don&apos;t bother, if the level isn&apos;t that high */</span>
<a name="l00423"></a>00423    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">option_verbose</a> &lt; level) {
<a name="l00424"></a>00424       <span class="keywordflow">return</span>;
<a name="l00425"></a>00425    }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427    va_start(ap, fmt);
<a name="l00428"></a>00428    va_copy(aq, ap);
<a name="l00429"></a>00429    <span class="keywordflow">if</span> ((size = vsnprintf(msg, 0, fmt, ap)) &lt; 0) {
<a name="l00430"></a>00430       va_end(ap);
<a name="l00431"></a>00431       va_end(aq);
<a name="l00432"></a>00432       <span class="keywordflow">return</span>;
<a name="l00433"></a>00433    }
<a name="l00434"></a>00434    va_end(ap);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436    <span class="keywordflow">if</span> (!(msg = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(size + 1))) {
<a name="l00437"></a>00437       va_end(aq);
<a name="l00438"></a>00438       <span class="keywordflow">return</span>;
<a name="l00439"></a>00439    }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441    vsnprintf(msg, size + 1, fmt, aq);
<a name="l00442"></a>00442    va_end(aq);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444    <span class="keywordflow">if</span> (!(emsg = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(size * 2 + 1))) {
<a name="l00445"></a>00445       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(msg);
<a name="l00446"></a>00446       <span class="keywordflow">return</span>;
<a name="l00447"></a>00447    }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449    <span class="keywordflow">for</span> (sptr = msg, eptr = emsg; ; sptr++) {
<a name="l00450"></a>00450       <span class="keywordflow">if</span> (*sptr == <span class="charliteral">&apos;&quot;&apos;</span>) {
<a name="l00451"></a>00451          *eptr++ = <span class="charliteral">&apos;\\&apos;</span>;
<a name="l00452"></a>00452       }
<a name="l00453"></a>00453       *eptr++ = *sptr;
<a name="l00454"></a>00454       <span class="keywordflow">if</span> (*sptr == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l00455"></a>00455          <span class="keywordflow">break</span>;
<a name="l00456"></a>00456       }
<a name="l00457"></a>00457    }
<a name="l00458"></a>00458    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(msg);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460    fprintf(stdout, <span class="stringliteral">&quot;verbose \&quot;%s\&quot; %d\n&quot;</span>, emsg, level);
<a name="l00461"></a>00461    fflush(stdout);
<a name="l00462"></a>00462    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(emsg);
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00465"></a><a class="code" href="logger_8c.html#a9f7a6acbec3680a06af27ae561772915">00465</a> <span class="keywordtype">void</span> <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *queuename, <span class="keyword">const</span> <span class="keywordtype">char</span> *callid, <span class="keyword">const</span> <span class="keywordtype">char</span> *agent, <span class="keyword">const</span> <span class="keywordtype">char</span> *event, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...)
<a name="l00466"></a>00466 {
<a name="l00467"></a>00467    va_list ap;
<a name="l00468"></a>00468    <span class="keywordtype">char</span> qlog_msg[8192];
<a name="l00469"></a>00469    <span class="keywordtype">int</span> qlog_len;
<a name="l00470"></a>00470    <span class="keywordtype">char</span> time_str[16];
<a name="l00471"></a>00471 
<a name="l00472"></a>00472    <span class="keywordflow">if</span> (<a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;queue_log&quot;</span>)) {
<a name="l00473"></a>00473       va_start(ap, fmt);
<a name="l00474"></a>00474       vsnprintf(qlog_msg, <span class="keyword">sizeof</span>(qlog_msg), fmt, ap);
<a name="l00475"></a>00475       va_end(ap);
<a name="l00476"></a>00476       snprintf(time_str, <span class="keyword">sizeof</span>(time_str), <span class="stringliteral">&quot;%ld&quot;</span>, (<span class="keywordtype">long</span>)time(NULL));
<a name="l00477"></a>00477       <a class="code" href="config_8h.html#abbd9786e26d09dce06c32a53fd3c0cc2" title="Create realtime configuration.">ast_store_realtime</a>(<span class="stringliteral">&quot;queue_log&quot;</span>, <span class="stringliteral">&quot;time&quot;</span>, time_str, 
<a name="l00478"></a>00478                   <span class="stringliteral">&quot;callid&quot;</span>, callid, 
<a name="l00479"></a>00479                   <span class="stringliteral">&quot;queuename&quot;</span>, queuename, 
<a name="l00480"></a>00480                   <span class="stringliteral">&quot;agent&quot;</span>, agent, 
<a name="l00481"></a>00481                   <span class="stringliteral">&quot;event&quot;</span>, event,
<a name="l00482"></a>00482                   <span class="stringliteral">&quot;data&quot;</span>, qlog_msg,
<a name="l00483"></a>00483                   <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l00484"></a>00484    } <span class="keywordflow">else</span> {
<a name="l00485"></a>00485       <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a>) {
<a name="l00486"></a>00486          va_start(ap, fmt);
<a name="l00487"></a>00487          qlog_len = snprintf(qlog_msg, <span class="keyword">sizeof</span>(qlog_msg), <span class="stringliteral">&quot;%ld|%s|%s|%s|%s|&quot;</span>, (<span class="keywordtype">long</span>)time(NULL), callid, queuename, agent, event);
<a name="l00488"></a>00488          vsnprintf(qlog_msg + qlog_len, <span class="keyword">sizeof</span>(qlog_msg) - qlog_len, fmt, ap);
<a name="l00489"></a>00489          va_end(ap);
<a name="l00490"></a>00490       }
<a name="l00491"></a>00491       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00492"></a>00492       <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a>) {
<a name="l00493"></a>00493          fprintf(<a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, qlog_msg);
<a name="l00494"></a>00494          fflush(<a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a>);
<a name="l00495"></a>00495       }
<a name="l00496"></a>00496       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00497"></a>00497    }
<a name="l00498"></a>00498 }
<a name="l00499"></a>00499 
<a name="l00500"></a><a class="code" href="logger_8c.html#aeeca350be69b461abe789c969ed420ab">00500</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="logger_8c.html#aeeca350be69b461abe789c969ed420ab">rotate_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>)
<a name="l00501"></a>00501 {
<a name="l00502"></a>00502    <span class="keywordtype">char</span> old[PATH_MAX];
<a name="l00503"></a>00503    <span class="keywordtype">char</span> <span class="keyword">new</span>[PATH_MAX];
<a name="l00504"></a>00504    <span class="keywordtype">int</span> x, y, which, found, res = 0, fd;
<a name="l00505"></a>00505    <span class="keywordtype">char</span> *suffixes[4] = { <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;.gz&quot;</span>, <span class="stringliteral">&quot;.bz2&quot;</span>, <span class="stringliteral">&quot;.Z&quot;</span> };
<a name="l00506"></a>00506 
<a name="l00507"></a>00507    <span class="keywordflow">switch</span> (<a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392">rotatestrategy</a>) {
<a name="l00508"></a>00508    <span class="keywordflow">case</span> <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a6b834d43476553e583e0fde6578c82f0">SEQUENTIAL</a>:
<a name="l00509"></a>00509       <span class="keywordflow">for</span> (x = 0; ; x++) {
<a name="l00510"></a>00510          snprintf(<span class="keyword">new</span>, <span class="keyword">sizeof</span>(<span class="keyword">new</span>), <span class="stringliteral">&quot;%s.%d&quot;</span>, filename, x);
<a name="l00511"></a>00511          fd = open(<span class="keyword">new</span>, O_RDONLY);
<a name="l00512"></a>00512          <span class="keywordflow">if</span> (fd &gt; -1)
<a name="l00513"></a>00513             close(fd);
<a name="l00514"></a>00514          <span class="keywordflow">else</span>
<a name="l00515"></a>00515             <span class="keywordflow">break</span>;
<a name="l00516"></a>00516       }
<a name="l00517"></a>00517       <span class="keywordflow">if</span> (rename(filename, <span class="keyword">new</span>)) {
<a name="l00518"></a>00518          fprintf(stderr, <span class="stringliteral">&quot;Unable to rename file &apos;%s&apos; to &apos;%s&apos;\n&quot;</span>, filename, <span class="keyword">new</span>);
<a name="l00519"></a>00519          res = -1;
<a name="l00520"></a>00520       }
<a name="l00521"></a>00521       <span class="keywordflow">break</span>;
<a name="l00522"></a>00522    <span class="keywordflow">case</span> <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a3f2dbbd8fe9ad35caa594416336ceeda">TIMESTAMP</a>:
<a name="l00523"></a>00523       snprintf(<span class="keyword">new</span>, <span class="keyword">sizeof</span>(<span class="keyword">new</span>), <span class="stringliteral">&quot;%s.%ld&quot;</span>, filename, (<span class="keywordtype">long</span>)time(NULL));
<a name="l00524"></a>00524       <span class="keywordflow">if</span> (rename(filename, <span class="keyword">new</span>)) {
<a name="l00525"></a>00525          fprintf(stderr, <span class="stringliteral">&quot;Unable to rename file &apos;%s&apos; to &apos;%s&apos;\n&quot;</span>, filename, <span class="keyword">new</span>);
<a name="l00526"></a>00526          res = -1;
<a name="l00527"></a>00527       }
<a name="l00528"></a>00528       <span class="keywordflow">break</span>;
<a name="l00529"></a>00529    <span class="keywordflow">case</span> <a class="code" href="logger_8c.html#a390505c32550f77c3e013a8030fac392a3dcfe0046eb5876e287dbf0914819b16">ROTATE</a>:
<a name="l00530"></a>00530       <span class="comment">/* Find the next empty slot, including a possible suffix */</span>
<a name="l00531"></a>00531       <span class="keywordflow">for</span> (x = 0; ; x++) {
<a name="l00532"></a>00532          found = 0;
<a name="l00533"></a>00533          <span class="keywordflow">for</span> (which = 0; which &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(suffixes); which++) {
<a name="l00534"></a>00534             snprintf(<span class="keyword">new</span>, <span class="keyword">sizeof</span>(<span class="keyword">new</span>), <span class="stringliteral">&quot;%s.%d%s&quot;</span>, filename, x, suffixes[which]);
<a name="l00535"></a>00535             fd = open(<span class="keyword">new</span>, O_RDONLY);
<a name="l00536"></a>00536             <span class="keywordflow">if</span> (fd &gt; -1) {
<a name="l00537"></a>00537                close(fd);
<a name="l00538"></a>00538                found = 1;
<a name="l00539"></a>00539                <span class="keywordflow">break</span>;
<a name="l00540"></a>00540             }
<a name="l00541"></a>00541          }
<a name="l00542"></a>00542          <span class="keywordflow">if</span> (!found) {
<a name="l00543"></a>00543             <span class="keywordflow">break</span>;
<a name="l00544"></a>00544          }
<a name="l00545"></a>00545       }
<a name="l00546"></a>00546 
<a name="l00547"></a>00547       <span class="comment">/* Found an empty slot */</span>
<a name="l00548"></a>00548       <span class="keywordflow">for</span> (y = x; y &gt; 0; y--) {
<a name="l00549"></a>00549          <span class="keywordflow">for</span> (which = 0; which &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(suffixes); which++) {
<a name="l00550"></a>00550             snprintf(old, <span class="keyword">sizeof</span>(old), <span class="stringliteral">&quot;%s.%d%s&quot;</span>, filename, y - 1, suffixes[which]);
<a name="l00551"></a>00551             fd = open(old, O_RDONLY);
<a name="l00552"></a>00552             <span class="keywordflow">if</span> (fd &gt; -1) {
<a name="l00553"></a>00553                <span class="comment">/* Found the right suffix */</span>
<a name="l00554"></a>00554                close(fd);
<a name="l00555"></a>00555                snprintf(<span class="keyword">new</span>, <span class="keyword">sizeof</span>(<span class="keyword">new</span>), <span class="stringliteral">&quot;%s.%d%s&quot;</span>, filename, y, suffixes[which]);
<a name="l00556"></a>00556                <span class="keywordflow">if</span> (rename(old, <span class="keyword">new</span>)) {
<a name="l00557"></a>00557                   fprintf(stderr, <span class="stringliteral">&quot;Unable to rename file &apos;%s&apos; to &apos;%s&apos;\n&quot;</span>, old, <span class="keyword">new</span>);
<a name="l00558"></a>00558                   res = -1;
<a name="l00559"></a>00559                }
<a name="l00560"></a>00560                <span class="keywordflow">break</span>;
<a name="l00561"></a>00561             }
<a name="l00562"></a>00562          }
<a name="l00563"></a>00563       }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565       <span class="comment">/* Finally, rename the current file */</span>
<a name="l00566"></a>00566       snprintf(<span class="keyword">new</span>, <span class="keyword">sizeof</span>(<span class="keyword">new</span>), <span class="stringliteral">&quot;%s.0&quot;</span>, filename);
<a name="l00567"></a>00567       <span class="keywordflow">if</span> (rename(filename, <span class="keyword">new</span>)) {
<a name="l00568"></a>00568          fprintf(stderr, <span class="stringliteral">&quot;Unable to rename file &apos;%s&apos; to &apos;%s&apos;\n&quot;</span>, filename, <span class="keyword">new</span>);
<a name="l00569"></a>00569          res = -1;
<a name="l00570"></a>00570       }
<a name="l00571"></a>00571    }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(exec_after_rotate)) {
<a name="l00574"></a>00574       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Logger/rotate&quot;</span>);
<a name="l00575"></a>00575       <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[512];
<a name="l00576"></a>00576       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(c, <span class="stringliteral">&quot;filename&quot;</span>, filename);
<a name="l00577"></a>00577       <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(c, exec_after_rotate, buf, <span class="keyword">sizeof</span>(buf));
<a name="l00578"></a>00578       <span class="keywordflow">if</span> (<a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(buf) == -1) {
<a name="l00579"></a>00579          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;error executing &apos;%s&apos;\n&quot;</span>, buf);
<a name="l00580"></a>00580       }
<a name="l00581"></a>00581       <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>(c);
<a name="l00582"></a>00582    }
<a name="l00583"></a>00583    <span class="keywordflow">return</span> res;
<a name="l00584"></a>00584 }
<a name="l00585"></a>00585 
<a name="l00586"></a><a class="code" href="logger_8c.html#a3036f1057f021e2eecd38c1d0d060f8c">00586</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="logger_8c.html#a3036f1057f021e2eecd38c1d0d060f8c">reload_logger</a>(<span class="keywordtype">int</span> rotate)
<a name="l00587"></a>00587 {
<a name="l00588"></a>00588    <span class="keywordtype">char</span> old[PATH_MAX] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00589"></a>00589    <span class="keywordtype">int</span> event_rotate = rotate, queue_rotate = rotate;
<a name="l00590"></a>00590    <span class="keyword">struct </span><a class="code" href="structlogchannel.html">logchannel</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00591"></a>00591    <span class="keywordtype">int</span> res = 0;
<a name="l00592"></a>00592    <span class="keyword">struct </span>stat st;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00595"></a>00595 
<a name="l00596"></a>00596    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a>) {
<a name="l00597"></a>00597       <span class="keywordflow">if</span> (rotate &lt; 0) {
<a name="l00598"></a>00598          <span class="comment">/* Check filesize - this one typically doesn&apos;t need an auto-rotate */</span>
<a name="l00599"></a>00599          snprintf(old, <span class="keyword">sizeof</span>(old), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a>, <a class="code" href="logger_8h.html#ace977ddb6fd1b76f78736d010bf8601d">EVENTLOG</a>);
<a name="l00600"></a>00600          <span class="keywordflow">if</span> (stat(old, &amp;st) != 0 || st.st_size &gt; 0x40000000) { <span class="comment">/* Arbitrarily, 1 GB */</span>
<a name="l00601"></a>00601             fclose(<a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a>);
<a name="l00602"></a>00602             <a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a> = NULL;
<a name="l00603"></a>00603          } <span class="keywordflow">else</span>
<a name="l00604"></a>00604             event_rotate = 0;
<a name="l00605"></a>00605       } <span class="keywordflow">else</span> {
<a name="l00606"></a>00606          fclose(<a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a>);
<a name="l00607"></a>00607          <a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a> = NULL;
<a name="l00608"></a>00608       }
<a name="l00609"></a>00609    } <span class="keywordflow">else</span>
<a name="l00610"></a>00610       event_rotate = 0;
<a name="l00611"></a>00611 
<a name="l00612"></a>00612    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a>) {
<a name="l00613"></a>00613       <span class="keywordflow">if</span> (rotate &lt; 0) {
<a name="l00614"></a>00614          <span class="comment">/* Check filesize - this one typically doesn&apos;t need an auto-rotate */</span>
<a name="l00615"></a>00615          snprintf(old, <span class="keyword">sizeof</span>(old), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a>, queue_log_name);
<a name="l00616"></a>00616          <span class="keywordflow">if</span> (stat(old, &amp;st) != 0 || st.st_size &gt; 0x40000000) { <span class="comment">/* Arbitrarily, 1 GB */</span>
<a name="l00617"></a>00617             fclose(<a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a>);
<a name="l00618"></a>00618             <a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a> = NULL;
<a name="l00619"></a>00619          } <span class="keywordflow">else</span>
<a name="l00620"></a>00620             queue_rotate = 0;
<a name="l00621"></a>00621       } <span class="keywordflow">else</span> {
<a name="l00622"></a>00622          fclose(<a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a>);
<a name="l00623"></a>00623          <a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a> = NULL;
<a name="l00624"></a>00624       }
<a name="l00625"></a>00625    } <span class="keywordflow">else</span> 
<a name="l00626"></a>00626       queue_rotate = 0;
<a name="l00627"></a>00627 
<a name="l00628"></a>00628    <a class="code" href="utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0" title="Recursively create directory path.">ast_mkdir</a>(<a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a>, 0777);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>, f, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>) {
<a name="l00631"></a>00631       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structlogchannel.html#af255398e3e9383752e6234829e3f6037">disabled</a>) {
<a name="l00632"></a>00632          f-&gt;<a class="code" href="structlogchannel.html#af255398e3e9383752e6234829e3f6037">disabled</a> = 0;  <span class="comment">/* Re-enable logging at reload */</span>
<a name="l00633"></a>00633          <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;LogChannel&quot;</span>, <span class="stringliteral">&quot;Channel: %s\r\nEnabled: Yes\r\n&quot;</span>, f-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>);
<a name="l00634"></a>00634       }
<a name="l00635"></a>00635       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a> &amp;&amp; (f-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a> != stdout) &amp;&amp; (f-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a> != stderr)) {
<a name="l00636"></a>00636          fclose(f-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a>);  <span class="comment">/* Close file */</span>
<a name="l00637"></a>00637          f-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a> = NULL;
<a name="l00638"></a>00638          <span class="keywordflow">if</span> (rotate)
<a name="l00639"></a>00639             <a class="code" href="logger_8c.html#aeeca350be69b461abe789c969ed420ab">rotate_file</a>(f-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>);
<a name="l00640"></a>00640       }
<a name="l00641"></a>00641    }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643    filesize_reload_needed = 0;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645    <a class="code" href="logger_8c.html#aaafd457f419506fd0aad9fcf2f8704e0">init_logger_chain</a>(1 <span class="comment">/* locked */</span>);
<a name="l00646"></a>00646 
<a name="l00647"></a>00647    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a2a3c47f5d59c8a5754b5d4fea971c819">logfiles</a>.event_log) {
<a name="l00648"></a>00648       snprintf(old, <span class="keyword">sizeof</span>(old), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a>, <a class="code" href="logger_8h.html#ace977ddb6fd1b76f78736d010bf8601d">EVENTLOG</a>);
<a name="l00649"></a>00649       <span class="keywordflow">if</span> (event_rotate)
<a name="l00650"></a>00650          <a class="code" href="logger_8c.html#aeeca350be69b461abe789c969ed420ab">rotate_file</a>(old);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652       <a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a> = fopen(old, <span class="stringliteral">&quot;a&quot;</span>);
<a name="l00653"></a>00653       <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a>) {
<a name="l00654"></a>00654          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#af7c8529df13c84f0c9d1122f36a94a41">LOG_EVENT</a>, <span class="stringliteral">&quot;Restarted Asterisk Event Logger\n&quot;</span>);
<a name="l00655"></a>00655          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;Asterisk Event Logger restarted\n&quot;</span>);
<a name="l00656"></a>00656       } <span class="keywordflow">else</span> {
<a name="l00657"></a>00657          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create event log: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00658"></a>00658          res = -1;
<a name="l00659"></a>00659       }
<a name="l00660"></a>00660    }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a2a3c47f5d59c8a5754b5d4fea971c819">logfiles</a>.queue_log) {
<a name="l00663"></a>00663       snprintf(old, <span class="keyword">sizeof</span>(old), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a>, queue_log_name);
<a name="l00664"></a>00664       <span class="keywordflow">if</span> (queue_rotate)
<a name="l00665"></a>00665          <a class="code" href="logger_8c.html#aeeca350be69b461abe789c969ed420ab">rotate_file</a>(old);
<a name="l00666"></a>00666 
<a name="l00667"></a>00667       <a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a> = fopen(old, <span class="stringliteral">&quot;a&quot;</span>);
<a name="l00668"></a>00668       <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a>) {
<a name="l00669"></a>00669          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00670"></a>00670          <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(<span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;CONFIGRELOAD&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00671"></a>00671          <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00672"></a>00672          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#af7c8529df13c84f0c9d1122f36a94a41">LOG_EVENT</a>, <span class="stringliteral">&quot;Restarted Asterisk Queue Logger\n&quot;</span>);
<a name="l00673"></a>00673          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;Asterisk Queue Logger restarted\n&quot;</span>);
<a name="l00674"></a>00674       } <span class="keywordflow">else</span> {
<a name="l00675"></a>00675          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create queue log: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00676"></a>00676          res = -1;
<a name="l00677"></a>00677       }
<a name="l00678"></a>00678    }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00681"></a>00681 
<a name="l00682"></a>00682    <span class="keywordflow">return</span> res;
<a name="l00683"></a>00683 }
<a name="l00684"></a>00684 <span class="comment"></span>
<a name="l00685"></a>00685 <span class="comment">/*! \brief Reload the logger module without rotating log files (also used from loader.c during</span>
<a name="l00686"></a>00686 <span class="comment">   a full Asterisk reload) */</span>
<a name="l00687"></a><a class="code" href="logger_8c.html#aff824284e4a5a007c3a87bed5e61af66">00687</a> <span class="keywordtype">int</span> <a class="code" href="logger_8h.html#aff824284e4a5a007c3a87bed5e61af66" title="Reload logger without rotating log files.">logger_reload</a>(<span class="keywordtype">void</span>)
<a name="l00688"></a>00688 {
<a name="l00689"></a>00689    <span class="keywordflow">if</span>(<a class="code" href="logger_8c.html#a3036f1057f021e2eecd38c1d0d060f8c">reload_logger</a>(0))
<a name="l00690"></a>00690       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>;
<a name="l00691"></a>00691    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a><a class="code" href="logger_8c.html#a60ed0cfcb00fccff5f115bca239a3737">00694</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="logger_8c.html#a60ed0cfcb00fccff5f115bca239a3737">handle_logger_reload</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00695"></a>00695 {
<a name="l00696"></a>00696    <span class="keywordflow">switch</span> (cmd) {
<a name="l00697"></a>00697    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00698"></a>00698       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;logger reload&quot;</span>;
<a name="l00699"></a>00699       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l00700"></a>00700          <span class="stringliteral">&quot;Usage: logger reload\n&quot;</span>
<a name="l00701"></a>00701          <span class="stringliteral">&quot;       Reloads the logger subsystem state.  Use after restarting syslogd(8) if you are using syslog logging.\n&quot;</span>;
<a name="l00702"></a>00702       <span class="keywordflow">return</span> NULL;
<a name="l00703"></a>00703    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00704"></a>00704       <span class="keywordflow">return</span> NULL;
<a name="l00705"></a>00705    }
<a name="l00706"></a>00706    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a3036f1057f021e2eecd38c1d0d060f8c">reload_logger</a>(0)) {
<a name="l00707"></a>00707       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to reload the logger\n&quot;</span>);
<a name="l00708"></a>00708       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00709"></a>00709    }
<a name="l00710"></a>00710    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00711"></a>00711 }
<a name="l00712"></a>00712 
<a name="l00713"></a><a class="code" href="logger_8c.html#a529d7be34c865a9be09c3348f6beeefd">00713</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="logger_8c.html#a529d7be34c865a9be09c3348f6beeefd">handle_logger_rotate</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00714"></a>00714 {
<a name="l00715"></a>00715    <span class="keywordflow">switch</span> (cmd) {
<a name="l00716"></a>00716    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00717"></a>00717       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;logger rotate&quot;</span>;
<a name="l00718"></a>00718       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l00719"></a>00719          <span class="stringliteral">&quot;Usage: logger rotate\n&quot;</span>
<a name="l00720"></a>00720          <span class="stringliteral">&quot;       Rotates and Reopens the log files.\n&quot;</span>;
<a name="l00721"></a>00721       <span class="keywordflow">return</span> NULL;
<a name="l00722"></a>00722    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00723"></a>00723       <span class="keywordflow">return</span> NULL;   
<a name="l00724"></a>00724    }
<a name="l00725"></a>00725    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a3036f1057f021e2eecd38c1d0d060f8c">reload_logger</a>(1)) {
<a name="l00726"></a>00726       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to reload the logger and rotate log files\n&quot;</span>);
<a name="l00727"></a>00727       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00728"></a>00728    } 
<a name="l00729"></a>00729    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00730"></a>00730 }
<a name="l00731"></a>00731 
<a name="l00732"></a><a class="code" href="logger_8c.html#a8da7a09e6808d7e4b3654f4fea8dfbfd">00732</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="logger_8c.html#a8da7a09e6808d7e4b3654f4fea8dfbfd">handle_logger_set_level</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00733"></a>00733 {
<a name="l00734"></a>00734    <span class="keywordtype">int</span> x;
<a name="l00735"></a>00735    <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>;
<a name="l00736"></a>00736    <span class="keywordtype">int</span> level = -1;
<a name="l00737"></a>00737 
<a name="l00738"></a>00738    <span class="keywordflow">switch</span> (cmd) {
<a name="l00739"></a>00739    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00740"></a>00740       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;logger set level&quot;</span>;
<a name="l00741"></a>00741       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l00742"></a>00742          <span class="stringliteral">&quot;Usage: logger set level\n&quot;</span>
<a name="l00743"></a>00743          <span class="stringliteral">&quot;       Set a specific log level to enabled/disabled for this console.\n&quot;</span>;
<a name="l00744"></a>00744       <span class="keywordflow">return</span> NULL;
<a name="l00745"></a>00745    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00746"></a>00746       <span class="keywordflow">return</span> NULL;
<a name="l00747"></a>00747    }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 5)
<a name="l00750"></a>00750       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00751"></a>00751 
<a name="l00752"></a>00752    <span class="keywordflow">for</span> (x = 0; x &lt;= <a class="code" href="logger_8h.html#a3d02ffd5809bdb049c815df859bbfcf4">NUMLOGLEVELS</a>; x++) {
<a name="l00753"></a>00753       <span class="keywordflow">if</span> (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <a class="code" href="logger_8c.html#a004b893a4391189108c29182f992a68a" title="Logging channels used in the Asterisk logging system.">levels</a>[x])) {
<a name="l00754"></a>00754          level = x;
<a name="l00755"></a>00755          <span class="keywordflow">break</span>;
<a name="l00756"></a>00756       }
<a name="l00757"></a>00757    }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759    state = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4]) ? 1 : 0;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761    <span class="keywordflow">if</span> (level != -1) {
<a name="l00762"></a>00762       <a class="code" href="logger_8h.html#a4f8c3e6c4cf3b41470b9df95f046a48d">ast_console_toggle_loglevel</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, level, state);
<a name="l00763"></a>00763       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Logger status for &apos;%s&apos; has been set to &apos;%s&apos;.\n&quot;</span>, <a class="code" href="logger_8c.html#a004b893a4391189108c29182f992a68a" title="Logging channels used in the Asterisk logging system.">levels</a>[level], state ? <span class="stringliteral">&quot;on&quot;</span> : <span class="stringliteral">&quot;off&quot;</span>);
<a name="l00764"></a>00764    } <span class="keywordflow">else</span>
<a name="l00765"></a>00765       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00766"></a>00766 
<a name="l00767"></a>00767    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00768"></a>00768 }
<a name="l00769"></a>00769 <span class="comment"></span>
<a name="l00770"></a>00770 <span class="comment">/*! \brief CLI command to show logging system configuration */</span>
<a name="l00771"></a><a class="code" href="logger_8c.html#aa66664a8448c2dbfdae4cd6ebfa8b402">00771</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="logger_8c.html#aa66664a8448c2dbfdae4cd6ebfa8b402" title="CLI command to show logging system configuration.">handle_logger_show_channels</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00772"></a>00772 {
<a name="l00773"></a>00773 <span class="preprocessor">#define FORMATL   &quot;%-35.35s %-8.8s %-9.9s &quot;</span>
<a name="l00774"></a>00774 <span class="preprocessor"></span>   <span class="keyword">struct </span><a class="code" href="structlogchannel.html">logchannel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00775"></a>00775    <span class="keywordflow">switch</span> (cmd) {
<a name="l00776"></a>00776    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00777"></a>00777       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;logger show channels&quot;</span>;
<a name="l00778"></a>00778       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l00779"></a>00779          <span class="stringliteral">&quot;Usage: logger show channels\n&quot;</span>
<a name="l00780"></a>00780          <span class="stringliteral">&quot;       List configured logger channels.\n&quot;</span>;
<a name="l00781"></a>00781       <span class="keywordflow">return</span> NULL;
<a name="l00782"></a>00782    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00783"></a>00783       <span class="keywordflow">return</span> NULL;   
<a name="l00784"></a>00784    }
<a name="l00785"></a>00785    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="logger_8c.html#a363296aa77a2d22cbdc759d82dbe883f">FORMATL</a>, <span class="stringliteral">&quot;Channel&quot;</span>, <span class="stringliteral">&quot;Type&quot;</span>, <span class="stringliteral">&quot;Status&quot;</span>);
<a name="l00786"></a>00786    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Configuration\n&quot;</span>);
<a name="l00787"></a>00787    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="logger_8c.html#a363296aa77a2d22cbdc759d82dbe883f">FORMATL</a>, <span class="stringliteral">&quot;-------&quot;</span>, <span class="stringliteral">&quot;----&quot;</span>, <span class="stringliteral">&quot;------&quot;</span>);
<a name="l00788"></a>00788    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;-------------\n&quot;</span>);
<a name="l00789"></a>00789    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00790"></a>00790    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>, chan, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>) {
<a name="l00791"></a>00791       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="logger_8c.html#a363296aa77a2d22cbdc759d82dbe883f">FORMATL</a>, chan-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>, chan-&gt;<a class="code" href="structlogchannel.html#a6d3cd9e6800461f549a4fcabae1712c1">type</a> == <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4a439c8fd120012113aa39dfece22ed55f">LOGTYPE_CONSOLE</a> ? <span class="stringliteral">&quot;Console&quot;</span> : (chan-&gt;<a class="code" href="structlogchannel.html#a6d3cd9e6800461f549a4fcabae1712c1">type</a> == <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4affe678f5d32a5ad00d20d138627aa22f">LOGTYPE_SYSLOG</a> ? <span class="stringliteral">&quot;Syslog&quot;</span> : <span class="stringliteral">&quot;File&quot;</span>),
<a name="l00792"></a>00792          chan-&gt;<a class="code" href="structlogchannel.html#af255398e3e9383752e6234829e3f6037">disabled</a> ? <span class="stringliteral">&quot;Disabled&quot;</span> : <span class="stringliteral">&quot;Enabled&quot;</span>);
<a name="l00793"></a>00793       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot; - &quot;</span>);
<a name="l00794"></a>00794       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a> &amp; (1 &lt;&lt; <a class="code" href="logger_8h.html#aaecc0363c3e5c2798fb8ed372c9a3d56">__LOG_DEBUG</a>)) 
<a name="l00795"></a>00795          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Debug &quot;</span>);
<a name="l00796"></a>00796       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a> &amp; (1 &lt;&lt; <a class="code" href="logger_8h.html#a71e644784b527384f60776ab18ac8bce">__LOG_DTMF</a>)) 
<a name="l00797"></a>00797          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;DTMF &quot;</span>);
<a name="l00798"></a>00798       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a> &amp; (1 &lt;&lt; <a class="code" href="logger_8h.html#aa11fae1314f286da3d57ae8c07ec4bca">__LOG_VERBOSE</a>)) 
<a name="l00799"></a>00799          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Verbose &quot;</span>);
<a name="l00800"></a>00800       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a> &amp; (1 &lt;&lt; <a class="code" href="logger_8h.html#abdaf681117cfed901932cc0d38f1447a">__LOG_WARNING</a>)) 
<a name="l00801"></a>00801          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Warning &quot;</span>);
<a name="l00802"></a>00802       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a> &amp; (1 &lt;&lt; <a class="code" href="logger_8h.html#aa2665cd768af07cf474d06204e408e2c">__LOG_NOTICE</a>)) 
<a name="l00803"></a>00803          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Notice &quot;</span>);
<a name="l00804"></a>00804       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a> &amp; (1 &lt;&lt; <a class="code" href="logger_8h.html#a0fcdc410e3e9fbb251fd0c4f8581d96c">__LOG_ERROR</a>)) 
<a name="l00805"></a>00805          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Error &quot;</span>);
<a name="l00806"></a>00806       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a> &amp; (1 &lt;&lt; <a class="code" href="logger_8h.html#aecd368d88763d02ce570d9f1d6734c9c">__LOG_EVENT</a>)) 
<a name="l00807"></a>00807          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Event &quot;</span>);
<a name="l00808"></a>00808       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00809"></a>00809    }
<a name="l00810"></a>00810    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00811"></a>00811    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00812"></a>00812       
<a name="l00813"></a>00813    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00814"></a>00814 }
<a name="l00815"></a>00815 
<a name="l00816"></a><a class="code" href="structverb.html">00816</a> <span class="keyword">struct </span><a class="code" href="structverb.html">verb</a> {
<a name="l00817"></a>00817    void (*<a class="code" href="pbx__gtkconsole_8c.html#a0c0c99ba0add51bd09ff543f9e245d12">verboser</a>)(<span class="keyword">const</span> <span class="keywordtype">char</span> *string);
<a name="l00818"></a><a class="code" href="structverb.html#ace744970e6f41d55a8e807eb9f8e8b69">00818</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structverb.html">verb</a>) <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>;
<a name="l00819"></a>00819 };
<a name="l00820"></a>00820 
<a name="l00821"></a><a class="code" href="structverbosers.html#ace4e0066a5b24f84b90536e9906619f6">00821</a> static <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structverbosers.html">verbosers</a>, <a class="code" href="structverb.html">verb</a>);
<a name="l00822"></a>00822 
<a name="l00823"></a><a class="code" href="logger_8c.html#ad833b610a71e242ad11a7f3fb5e79b90">00823</a> static struct <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="logger_8c.html#ad833b610a71e242ad11a7f3fb5e79b90">cli_logger</a>[] = {
<a name="l00824"></a>00824    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="logger_8c.html#aa66664a8448c2dbfdae4cd6ebfa8b402" title="CLI command to show logging system configuration.">handle_logger_show_channels</a>, <span class="stringliteral">&quot;List configured log channels&quot;</span>),
<a name="l00825"></a>00825    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="logger_8c.html#a60ed0cfcb00fccff5f115bca239a3737">handle_logger_reload</a>, <span class="stringliteral">&quot;Reopens the log files&quot;</span>),
<a name="l00826"></a>00826    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="logger_8c.html#a529d7be34c865a9be09c3348f6beeefd">handle_logger_rotate</a>, <span class="stringliteral">&quot;Rotates and reopens the log files&quot;</span>),
<a name="l00827"></a>00827    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="logger_8c.html#a8da7a09e6808d7e4b3654f4fea8dfbfd">handle_logger_set_level</a>, <span class="stringliteral">&quot;Enables/Disables a specific logging level for this console&quot;</span>)
<a name="l00828"></a>00828 };
<a name="l00829"></a>00829 
<a name="l00830"></a><a class="code" href="logger_8c.html#a1406ca59219e1599fa22449317b13a37">00830</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="logger_8c.html#a1406ca59219e1599fa22449317b13a37">handle_SIGXFSZ</a>(<span class="keywordtype">int</span> sig) 
<a name="l00831"></a>00831 {
<a name="l00832"></a>00832    <span class="comment">/* Indicate need to reload */</span>
<a name="l00833"></a>00833    filesize_reload_needed = 1;
<a name="l00834"></a>00834    <span class="keywordflow">return</span> 0;
<a name="l00835"></a>00835 }
<a name="l00836"></a>00836 
<a name="l00837"></a><a class="code" href="logger_8c.html#aa90a4fb4bf2c5ce2d07bfb8703cdc730">00837</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="logger_8c.html#aa90a4fb4bf2c5ce2d07bfb8703cdc730">ast_log_vsyslog</a>(<span class="keywordtype">int</span> level, <span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> line, <span class="keyword">const</span> <span class="keywordtype">char</span> *function, <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>, <span class="keywordtype">long</span> pid)
<a name="l00838"></a>00838 {
<a name="l00839"></a>00839    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[BUFSIZ];
<a name="l00840"></a>00840 
<a name="l00841"></a>00841    <span class="keywordflow">if</span> (level &gt;= <a class="code" href="logger_8c.html#a822273d71a9d7777077c9fc62c4992ab">SYSLOG_NLEVELS</a>) {
<a name="l00842"></a>00842       <span class="comment">/* we are locked here, so cannot ast_log() */</span>
<a name="l00843"></a>00843       fprintf(stderr, <span class="stringliteral">&quot;ast_log_vsyslog called with bogus level: %d\n&quot;</span>, level);
<a name="l00844"></a>00844       <span class="keywordflow">return</span>;
<a name="l00845"></a>00845    }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847    <span class="keywordflow">if</span> (level == <a class="code" href="logger_8h.html#aa11fae1314f286da3d57ae8c07ec4bca">__LOG_VERBOSE</a>) {
<a name="l00848"></a>00848       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;VERBOSE[%ld]: %s&quot;</span>, pid, str);
<a name="l00849"></a>00849       level = <a class="code" href="logger_8h.html#aaecc0363c3e5c2798fb8ed372c9a3d56">__LOG_DEBUG</a>;
<a name="l00850"></a>00850    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (level == <a class="code" href="logger_8h.html#a71e644784b527384f60776ab18ac8bce">__LOG_DTMF</a>) {
<a name="l00851"></a>00851       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;DTMF[%ld]: %s&quot;</span>, pid, str);
<a name="l00852"></a>00852       level = <a class="code" href="logger_8h.html#aaecc0363c3e5c2798fb8ed372c9a3d56">__LOG_DEBUG</a>;
<a name="l00853"></a>00853    } <span class="keywordflow">else</span> {
<a name="l00854"></a>00854       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;%s[%ld]: %s:%d in %s: %s&quot;</span>,
<a name="l00855"></a>00855           <a class="code" href="logger_8c.html#a004b893a4391189108c29182f992a68a" title="Logging channels used in the Asterisk logging system.">levels</a>[level], pid, file, line, function, str);
<a name="l00856"></a>00856    }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858    <a class="code" href="term_8h.html#ab0924db6a78be6daa36e939ad5c983de">term_strip</a>(buf, buf, strlen(buf) + 1);
<a name="l00859"></a>00859    syslog(syslog_level_map[level], <span class="stringliteral">&quot;%s&quot;</span>, buf);
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 <span class="comment"></span>
<a name="l00862"></a>00862 <span class="comment">/*! \brief Print a normal log message to the channels */</span>
<a name="l00863"></a><a class="code" href="logger_8c.html#ac2c5290c43f91e7f6bdac350c32d29ae">00863</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="logger_8c.html#ac2c5290c43f91e7f6bdac350c32d29ae" title="Print a normal log message to the channels.">logger_print_normal</a>(<span class="keyword">struct</span> <a class="code" href="structlogmsg.html">logmsg</a> *<a class="code" href="structlogmsg.html">logmsg</a>)
<a name="l00864"></a>00864 {
<a name="l00865"></a>00865    <span class="keyword">struct </span><a class="code" href="structlogchannel.html">logchannel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a> = NULL;
<a name="l00866"></a>00866    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[BUFSIZ];
<a name="l00867"></a>00867 
<a name="l00868"></a>00868    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00869"></a>00869 
<a name="l00870"></a>00870    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a2a3c47f5d59c8a5754b5d4fea971c819">logfiles</a>.event_log &amp;&amp; logmsg-&gt;<a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">level</a> == <a class="code" href="logger_8h.html#aecd368d88763d02ce570d9f1d6734c9c">__LOG_EVENT</a>) {
<a name="l00871"></a>00871       fprintf(<a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a>, <span class="stringliteral">&quot;%s asterisk[%ld]: %s&quot;</span>, logmsg-&gt;<a class="code" href="structlogmsg.html#a4e839704872ed7546e92d346f353dbb6">date</a>, (<span class="keywordtype">long</span>)getpid(), logmsg-&gt;<a class="code" href="structlogmsg.html#a21c9b0fee88b9f35e718afe5d065d676">str</a>);
<a name="l00872"></a>00872       fflush(<a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a>);
<a name="l00873"></a>00873       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00874"></a>00874       <span class="keywordflow">return</span>;
<a name="l00875"></a>00875    }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#a0044f6572f50a89049b3b5272e51b0e7">AST_RWLIST_EMPTY</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>)) {
<a name="l00878"></a>00878       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>, chan, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>) {
<a name="l00879"></a>00879          <span class="comment">/* If the channel is disabled, then move on to the next one */</span>
<a name="l00880"></a>00880          <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structlogchannel.html#af255398e3e9383752e6234829e3f6037">disabled</a>)
<a name="l00881"></a>00881             <span class="keywordflow">continue</span>;
<a name="l00882"></a>00882          <span class="comment">/* Check syslog channels */</span>
<a name="l00883"></a>00883          <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structlogchannel.html#a6d3cd9e6800461f549a4fcabae1712c1">type</a> == <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4affe678f5d32a5ad00d20d138627aa22f">LOGTYPE_SYSLOG</a> &amp;&amp; (chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a> &amp; (1 &lt;&lt; logmsg-&gt;<a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">level</a>))) {
<a name="l00884"></a>00884             <a class="code" href="logger_8c.html#aa90a4fb4bf2c5ce2d07bfb8703cdc730">ast_log_vsyslog</a>(logmsg-&gt;<a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">level</a>, logmsg-&gt;<a class="code" href="structlogmsg.html#ae97b19517c9f0cdda8fe4b87949e51e6">file</a>, logmsg-&gt;<a class="code" href="structlogmsg.html#a41ebd28ef1d7c6ade45642cb6acc1039">line</a>, logmsg-&gt;<a class="code" href="structlogmsg.html#abe54135be1a457ab08fe76825a6f2691">function</a>, logmsg-&gt;<a class="code" href="structlogmsg.html#a21c9b0fee88b9f35e718afe5d065d676">str</a>, logmsg-&gt;<a class="code" href="structlogmsg.html#a3d369159085eab613678b5bc87d8d948">process_id</a>);
<a name="l00885"></a>00885          <span class="comment">/* Console channels */</span>
<a name="l00886"></a>00886          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structlogchannel.html#a6d3cd9e6800461f549a4fcabae1712c1">type</a> == <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4a439c8fd120012113aa39dfece22ed55f">LOGTYPE_CONSOLE</a> &amp;&amp; (chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a> &amp; (1 &lt;&lt; logmsg-&gt;<a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">level</a>))) {
<a name="l00887"></a>00887             <span class="keywordtype">char</span> linestr[128];
<a name="l00888"></a>00888             <span class="keywordtype">char</span> tmp1[80], tmp2[80], tmp3[80], tmp4[80];
<a name="l00889"></a>00889 
<a name="l00890"></a>00890             <span class="comment">/* If the level is verbose, then skip it */</span>
<a name="l00891"></a>00891             <span class="keywordflow">if</span> (logmsg-&gt;<a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">level</a> == <a class="code" href="logger_8h.html#aa11fae1314f286da3d57ae8c07ec4bca">__LOG_VERBOSE</a>)
<a name="l00892"></a>00892                <span class="keywordflow">continue</span>;
<a name="l00893"></a>00893 
<a name="l00894"></a>00894             <span class="comment">/* Turn the numerical line number into a string */</span>
<a name="l00895"></a>00895             snprintf(linestr, <span class="keyword">sizeof</span>(linestr), <span class="stringliteral">&quot;%d&quot;</span>, logmsg-&gt;<a class="code" href="structlogmsg.html#a41ebd28ef1d7c6ade45642cb6acc1039">line</a>);
<a name="l00896"></a>00896             <span class="comment">/* Build string to print out */</span>
<a name="l00897"></a>00897             snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;[%s] %s[%ld]: %s:%s %s: %s&quot;</span>,
<a name="l00898"></a>00898                 logmsg-&gt;<a class="code" href="structlogmsg.html#a4e839704872ed7546e92d346f353dbb6">date</a>,
<a name="l00899"></a>00899                 <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmp1, <a class="code" href="logger_8c.html#a004b893a4391189108c29182f992a68a" title="Logging channels used in the Asterisk logging system.">levels</a>[logmsg-&gt;<a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">level</a>], <a class="code" href="logger_8c.html#ae8cf707953b0478b5a77d65a7704015b" title="Colors used in the console for logging.">colors</a>[logmsg-&gt;<a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">level</a>], 0, <span class="keyword">sizeof</span>(tmp1)),
<a name="l00900"></a>00900                 logmsg-&gt;<a class="code" href="structlogmsg.html#a3d369159085eab613678b5bc87d8d948">process_id</a>,
<a name="l00901"></a>00901                 <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmp2, logmsg-&gt;<a class="code" href="structlogmsg.html#ae97b19517c9f0cdda8fe4b87949e51e6">file</a>, <a class="code" href="term_8h.html#aa25d3faed7c00a4612beb33f7306d251">COLOR_BRWHITE</a>, 0, <span class="keyword">sizeof</span>(tmp2)),
<a name="l00902"></a>00902                 <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmp3, linestr, <a class="code" href="term_8h.html#aa25d3faed7c00a4612beb33f7306d251">COLOR_BRWHITE</a>, 0, <span class="keyword">sizeof</span>(tmp3)),
<a name="l00903"></a>00903                 <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmp4, logmsg-&gt;<a class="code" href="structlogmsg.html#abe54135be1a457ab08fe76825a6f2691">function</a>, <a class="code" href="term_8h.html#aa25d3faed7c00a4612beb33f7306d251">COLOR_BRWHITE</a>, 0, <span class="keyword">sizeof</span>(tmp4)),
<a name="l00904"></a>00904                 logmsg-&gt;<a class="code" href="structlogmsg.html#a21c9b0fee88b9f35e718afe5d065d676">str</a>);
<a name="l00905"></a>00905             <span class="comment">/* Print out */</span>
<a name="l00906"></a>00906             <a class="code" href="logger_8h.html#a6b74ef8709c2a8f00f06c0933ca993a1" title="log the string to the console, and all attached console clients">ast_console_puts_mutable</a>(buf, logmsg-&gt;<a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">level</a>);
<a name="l00907"></a>00907          <span class="comment">/* File channels */</span>
<a name="l00908"></a>00908          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structlogchannel.html#a6d3cd9e6800461f549a4fcabae1712c1">type</a> == <a class="code" href="logger_8c.html#a7e2550c12ff27e5cd303101e86cf8eb4a82620c2d182f4b50f3801669f747f3aa">LOGTYPE_FILE</a> &amp;&amp; (chan-&gt;<a class="code" href="structlogchannel.html#aae55c0421192369c58f45e8c8dd143f3">logmask</a> &amp; (1 &lt;&lt; logmsg-&gt;<a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">level</a>))) {
<a name="l00909"></a>00909             <span class="keywordtype">int</span> res = 0;
<a name="l00910"></a>00910 
<a name="l00911"></a>00911             <span class="comment">/* If no file pointer exists, skip it */</span>
<a name="l00912"></a>00912             <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a>) {
<a name="l00913"></a>00913                <span class="keywordflow">continue</span>;
<a name="l00914"></a>00914             }
<a name="l00915"></a>00915 
<a name="l00916"></a>00916             <span class="comment">/* Print out to the file */</span>
<a name="l00917"></a>00917             res = fprintf(chan-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a>, <span class="stringliteral">&quot;[%s] %s[%ld] %s: %s&quot;</span>,
<a name="l00918"></a>00918                      logmsg-&gt;<a class="code" href="structlogmsg.html#a4e839704872ed7546e92d346f353dbb6">date</a>, <a class="code" href="logger_8c.html#a004b893a4391189108c29182f992a68a" title="Logging channels used in the Asterisk logging system.">levels</a>[logmsg-&gt;<a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">level</a>], logmsg-&gt;<a class="code" href="structlogmsg.html#a3d369159085eab613678b5bc87d8d948">process_id</a>, logmsg-&gt;<a class="code" href="structlogmsg.html#ae97b19517c9f0cdda8fe4b87949e51e6">file</a>, <a class="code" href="term_8h.html#ab0924db6a78be6daa36e939ad5c983de">term_strip</a>(buf, logmsg-&gt;<a class="code" href="structlogmsg.html#a21c9b0fee88b9f35e718afe5d065d676">str</a>, BUFSIZ));
<a name="l00919"></a>00919             <span class="keywordflow">if</span> (res &lt;= 0 &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(logmsg-&gt;<a class="code" href="structlogmsg.html#a21c9b0fee88b9f35e718afe5d065d676">str</a>)) {
<a name="l00920"></a>00920                fprintf(stderr, <span class="stringliteral">&quot;**** Asterisk Logging Error: ***********\n&quot;</span>);
<a name="l00921"></a>00921                <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENOMEM || <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENOSPC)
<a name="l00922"></a>00922                   fprintf(stderr, <span class="stringliteral">&quot;Asterisk logging error: Out of disk space, can&apos;t log to log file %s\n&quot;</span>, chan-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>);
<a name="l00923"></a>00923                <span class="keywordflow">else</span>
<a name="l00924"></a>00924                   fprintf(stderr, <span class="stringliteral">&quot;Logger Warning: Unable to write to log file &apos;%s&apos;: %s (disabled)\n&quot;</span>, chan-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00925"></a>00925                <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;LogChannel&quot;</span>, <span class="stringliteral">&quot;Channel: %s\r\nEnabled: No\r\nReason: %d - %s\r\n&quot;</span>, chan-&gt;<a class="code" href="structlogchannel.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>, <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00926"></a>00926                chan-&gt;<a class="code" href="structlogchannel.html#af255398e3e9383752e6234829e3f6037">disabled</a> = 1;
<a name="l00927"></a>00927             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l00928"></a>00928                fflush(chan-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a>);
<a name="l00929"></a>00929             }
<a name="l00930"></a>00930          }
<a name="l00931"></a>00931       }
<a name="l00932"></a>00932    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (logmsg-&gt;<a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">level</a> != <a class="code" href="logger_8h.html#aa11fae1314f286da3d57ae8c07ec4bca">__LOG_VERBOSE</a>) {
<a name="l00933"></a>00933       fputs(logmsg-&gt;<a class="code" href="structlogmsg.html#a21c9b0fee88b9f35e718afe5d065d676">str</a>, stdout);
<a name="l00934"></a>00934    }
<a name="l00935"></a>00935 
<a name="l00936"></a>00936    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l00937"></a>00937 
<a name="l00938"></a>00938    <span class="comment">/* If we need to reload because of the file size, then do so */</span>
<a name="l00939"></a>00939    <span class="keywordflow">if</span> (filesize_reload_needed) {
<a name="l00940"></a>00940       <a class="code" href="logger_8c.html#a3036f1057f021e2eecd38c1d0d060f8c">reload_logger</a>(-1);
<a name="l00941"></a>00941       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#af7c8529df13c84f0c9d1122f36a94a41">LOG_EVENT</a>, <span class="stringliteral">&quot;Rotated Logs Per SIGXFSZ (Exceeded file size limit)\n&quot;</span>);
<a name="l00942"></a>00942       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;Rotated Logs Per SIGXFSZ (Exceeded file size limit)\n&quot;</span>);
<a name="l00943"></a>00943    }
<a name="l00944"></a>00944 
<a name="l00945"></a>00945    <span class="keywordflow">return</span>;
<a name="l00946"></a>00946 }
<a name="l00947"></a>00947 <span class="comment"></span>
<a name="l00948"></a>00948 <span class="comment">/*! \brief Print a verbose message to the verbosers */</span>
<a name="l00949"></a><a class="code" href="logger_8c.html#ac439f2504126267a7a8049976ac80050">00949</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="logger_8c.html#ac439f2504126267a7a8049976ac80050" title="Print a verbose message to the verbosers.">logger_print_verbose</a>(<span class="keyword">struct</span> <a class="code" href="structlogmsg.html">logmsg</a> *<a class="code" href="structlogmsg.html">logmsg</a>)
<a name="l00950"></a>00950 {
<a name="l00951"></a>00951    <span class="keyword">struct </span><a class="code" href="structverb.html">verb</a> *v = NULL;
<a name="l00952"></a>00952 
<a name="l00953"></a>00953    <span class="comment">/* Iterate through the list of verbosers and pass them the log message string */</span>
<a name="l00954"></a>00954    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structverbosers.html">verbosers</a>);
<a name="l00955"></a>00955    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structverbosers.html">verbosers</a>, v, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>)
<a name="l00956"></a>00956       v-&gt;<a class="code" href="structverb.html#a8c66d6f0eeba787154fd66c2a538f12c">verboser</a>(logmsg-&gt;<a class="code" href="structlogmsg.html#a21c9b0fee88b9f35e718afe5d065d676">str</a>);
<a name="l00957"></a>00957    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structverbosers.html">verbosers</a>);
<a name="l00958"></a>00958 
<a name="l00959"></a>00959    <span class="keywordflow">return</span>;
<a name="l00960"></a>00960 }
<a name="l00961"></a>00961 <span class="comment"></span>
<a name="l00962"></a>00962 <span class="comment">/*! \brief Actual logging thread */</span>
<a name="l00963"></a><a class="code" href="logger_8c.html#ac4f7d8da66207fdb53d5f5ecb171032e">00963</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="logger_8c.html#ac4f7d8da66207fdb53d5f5ecb171032e" title="Actual logging thread.">logger_thread</a>(<span class="keywordtype">void</span> *data)
<a name="l00964"></a>00964 {
<a name="l00965"></a>00965    <span class="keyword">struct </span><a class="code" href="structlogmsg.html">logmsg</a> *<a class="code" href="structlogchannel.html#a24aaefbc5516dca5dbe245b41e34acf5">next</a> = NULL, *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a> = NULL;
<a name="l00966"></a>00966 
<a name="l00967"></a>00967    <span class="keywordflow">for</span> (;;) {
<a name="l00968"></a>00968       <span class="comment">/* We lock the message list, and see if any message exists... if not we wait on the condition to be signalled */</span>
<a name="l00969"></a>00969       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>);
<a name="l00970"></a>00970       <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>)) {
<a name="l00971"></a>00971          <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a38ac6d8ec7483171f8a13fed360b6ced">close_logger_thread</a>) {
<a name="l00972"></a>00972             <span class="keywordflow">break</span>;
<a name="l00973"></a>00973          } <span class="keywordflow">else</span> {
<a name="l00974"></a>00974             <a class="code" href="lock_8h.html#ae454b1ebfb5f5e9948876d470865d9dc">ast_cond_wait</a>(&amp;<a class="code" href="logger_8c.html#abb118951a9d7c498a6e28454e7eb0bd5">logcond</a>, &amp;<a class="code" href="structlogmsgs.html">logmsgs</a>.lock);
<a name="l00975"></a>00975          }
<a name="l00976"></a>00976       }
<a name="l00977"></a>00977       next = <a class="code" href="linkedlists_8h.html#adf1959c5c03a3a706da97ad2f49617e5" title="Returns the first entry contained in a list.">AST_LIST_FIRST</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>);
<a name="l00978"></a>00978       <a class="code" href="linkedlists_8h.html#a0d1f922e093ac18824a7863fe3f5fa27" title="Initializes a list head structure.">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>);
<a name="l00979"></a>00979       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>);
<a name="l00980"></a>00980 
<a name="l00981"></a>00981       <span class="comment">/* Otherwise go through and process each message in the order added */</span>
<a name="l00982"></a>00982       <span class="keywordflow">while</span> ((msg = next)) {
<a name="l00983"></a>00983          <span class="comment">/* Get the next entry now so that we can free our current structure later */</span>
<a name="l00984"></a>00984          next = <a class="code" href="linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6" title="Returns the next entry in the list after the given entry.">AST_LIST_NEXT</a>(msg, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>);
<a name="l00985"></a>00985 
<a name="l00986"></a>00986          <span class="comment">/* Depending on the type, send it to the proper function */</span>
<a name="l00987"></a>00987          <span class="keywordflow">if</span> (msg-&gt;type == <a class="code" href="logger_8c.html#a29df94a387c835e6296b05418885993ea4ff7bef379df472011e5516f51160e2c">LOGMSG_NORMAL</a>)
<a name="l00988"></a>00988             <a class="code" href="logger_8c.html#ac2c5290c43f91e7f6bdac350c32d29ae" title="Print a normal log message to the channels.">logger_print_normal</a>(msg);
<a name="l00989"></a>00989          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg-&gt;type == <a class="code" href="logger_8c.html#a29df94a387c835e6296b05418885993eae66ea31ebaa61ba9cac6412f3f9f21c7">LOGMSG_VERBOSE</a>)
<a name="l00990"></a>00990             <a class="code" href="logger_8c.html#ac439f2504126267a7a8049976ac80050" title="Print a verbose message to the verbosers.">logger_print_verbose</a>(msg);
<a name="l00991"></a>00991 
<a name="l00992"></a>00992          <span class="comment">/* Free the data since we are done */</span>
<a name="l00993"></a>00993          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(msg);
<a name="l00994"></a>00994       }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996       <span class="comment">/* If we should stop, then stop */</span>
<a name="l00997"></a>00997       <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a38ac6d8ec7483171f8a13fed360b6ced">close_logger_thread</a>)
<a name="l00998"></a>00998          <span class="keywordflow">break</span>;
<a name="l00999"></a>00999    }
<a name="l01000"></a>01000 
<a name="l01001"></a>01001    <span class="keywordflow">return</span> NULL;
<a name="l01002"></a>01002 }
<a name="l01003"></a>01003 
<a name="l01004"></a><a class="code" href="logger_8c.html#aaa750bd60d48780b89622bb62520dff0">01004</a> <span class="keywordtype">int</span> <a class="code" href="__private_8h.html#aaa750bd60d48780b89622bb62520dff0">init_logger</a>(<span class="keywordtype">void</span>)
<a name="l01005"></a>01005 {
<a name="l01006"></a>01006    <span class="keywordtype">char</span> tmp[256];
<a name="l01007"></a>01007    <span class="keywordtype">int</span> res = 0;
<a name="l01008"></a>01008 
<a name="l01009"></a>01009    <span class="comment">/* auto rotate if sig SIGXFSZ comes a-knockin */</span>
<a name="l01010"></a>01010    (void) signal(SIGXFSZ, (<span class="keywordtype">void</span> *) <a class="code" href="logger_8c.html#a1406ca59219e1599fa22449317b13a37">handle_SIGXFSZ</a>);
<a name="l01011"></a>01011 
<a name="l01012"></a>01012    <span class="comment">/* start logger thread */</span>
<a name="l01013"></a>01013    <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;<a class="code" href="logger_8c.html#abb118951a9d7c498a6e28454e7eb0bd5">logcond</a>, NULL);
<a name="l01014"></a>01014    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a4781fd54a4ca8c7f0f8a32a6cce503c0">ast_pthread_create</a>(&amp;<a class="code" href="logger_8c.html#a6685bab4f7be49a081c4d2efe4b77a23">logthread</a>, NULL, <a class="code" href="logger_8c.html#ac4f7d8da66207fdb53d5f5ecb171032e" title="Actual logging thread.">logger_thread</a>, NULL) &lt; 0) {
<a name="l01015"></a>01015       <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;<a class="code" href="logger_8c.html#abb118951a9d7c498a6e28454e7eb0bd5">logcond</a>);
<a name="l01016"></a>01016       <span class="keywordflow">return</span> -1;
<a name="l01017"></a>01017    }
<a name="l01018"></a>01018 
<a name="l01019"></a>01019    <span class="comment">/* register the logger cli commands */</span>
<a name="l01020"></a>01020    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="logger_8c.html#ad833b610a71e242ad11a7f3fb5e79b90">cli_logger</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="logger_8c.html#ad833b610a71e242ad11a7f3fb5e79b90">cli_logger</a>));
<a name="l01021"></a>01021 
<a name="l01022"></a>01022    <a class="code" href="utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0" title="Recursively create directory path.">ast_mkdir</a>(<a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a>, 0777);
<a name="l01023"></a>01023   
<a name="l01024"></a>01024    <span class="comment">/* create log channels */</span>
<a name="l01025"></a>01025    <a class="code" href="logger_8c.html#aaafd457f419506fd0aad9fcf2f8704e0">init_logger_chain</a>(0 <span class="comment">/* locked */</span>);
<a name="l01026"></a>01026 
<a name="l01027"></a>01027    <span class="comment">/* create the eventlog */</span>
<a name="l01028"></a>01028    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a2a3c47f5d59c8a5754b5d4fea971c819">logfiles</a>.event_log) {
<a name="l01029"></a>01029       snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a>, <a class="code" href="logger_8h.html#ace977ddb6fd1b76f78736d010bf8601d">EVENTLOG</a>);
<a name="l01030"></a>01030       <a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a> = fopen(tmp, <span class="stringliteral">&quot;a&quot;</span>);
<a name="l01031"></a>01031       <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a>) {
<a name="l01032"></a>01032          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#af7c8529df13c84f0c9d1122f36a94a41">LOG_EVENT</a>, <span class="stringliteral">&quot;Started Asterisk Event Logger\n&quot;</span>);
<a name="l01033"></a>01033          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;Asterisk Event Logger Started %s\n&quot;</span>, tmp);
<a name="l01034"></a>01034       } <span class="keywordflow">else</span> {
<a name="l01035"></a>01035          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create event log: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01036"></a>01036          res = -1;
<a name="l01037"></a>01037       }
<a name="l01038"></a>01038    }
<a name="l01039"></a>01039 
<a name="l01040"></a>01040    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a2a3c47f5d59c8a5754b5d4fea971c819">logfiles</a>.queue_log) {
<a name="l01041"></a>01041       snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a>, queue_log_name);
<a name="l01042"></a>01042       <a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a> = fopen(tmp, <span class="stringliteral">&quot;a&quot;</span>);
<a name="l01043"></a>01043       <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(<span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;NONE&quot;</span>, <span class="stringliteral">&quot;QUEUESTART&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01044"></a>01044    }
<a name="l01045"></a>01045    <span class="keywordflow">return</span> res;
<a name="l01046"></a>01046 }
<a name="l01047"></a>01047 
<a name="l01048"></a><a class="code" href="logger_8c.html#a472851d5655c8a9b9492c40e5ff32d2d">01048</a> <span class="keywordtype">void</span> <a class="code" href="__private_8h.html#a472851d5655c8a9b9492c40e5ff32d2d">close_logger</a>(<span class="keywordtype">void</span>)
<a name="l01049"></a>01049 {
<a name="l01050"></a>01050    <span class="keyword">struct </span><a class="code" href="structlogchannel.html">logchannel</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l01051"></a>01051 
<a name="l01052"></a>01052    <span class="comment">/* Stop logger thread */</span>
<a name="l01053"></a>01053    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>);
<a name="l01054"></a>01054    <a class="code" href="logger_8c.html#a38ac6d8ec7483171f8a13fed360b6ced">close_logger_thread</a> = 1;
<a name="l01055"></a>01055    <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;<a class="code" href="logger_8c.html#abb118951a9d7c498a6e28454e7eb0bd5">logcond</a>);
<a name="l01056"></a>01056    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>);
<a name="l01057"></a>01057 
<a name="l01058"></a>01058    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a6685bab4f7be49a081c4d2efe4b77a23">logthread</a> != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>)
<a name="l01059"></a>01059       pthread_join(<a class="code" href="logger_8c.html#a6685bab4f7be49a081c4d2efe4b77a23">logthread</a>, NULL);
<a name="l01060"></a>01060 
<a name="l01061"></a>01061    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l01062"></a>01062 
<a name="l01063"></a>01063    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a>) {
<a name="l01064"></a>01064       fclose(<a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a>);
<a name="l01065"></a>01065       <a class="code" href="logger_8c.html#ae4fc4e52cb8f2c8872019c2117d32a7d">eventlog</a> = NULL;
<a name="l01066"></a>01066    }
<a name="l01067"></a>01067 
<a name="l01068"></a>01068    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a>) {
<a name="l01069"></a>01069       fclose(<a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a>);
<a name="l01070"></a>01070       <a class="code" href="logger_8c.html#a59cef8b13e5fcb3e2ea61f66ea4bf0e5">qlog</a> = NULL;
<a name="l01071"></a>01071    }
<a name="l01072"></a>01072 
<a name="l01073"></a>01073    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>, f, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>) {
<a name="l01074"></a>01074       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a> &amp;&amp; (f-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a> != stdout) &amp;&amp; (f-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a> != stderr)) {
<a name="l01075"></a>01075          fclose(f-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a>);
<a name="l01076"></a>01076          f-&gt;<a class="code" href="structlogchannel.html#acc2a21b64b19aeee05b382056974c1e9">fileptr</a> = NULL;
<a name="l01077"></a>01077       }
<a name="l01078"></a>01078    }
<a name="l01079"></a>01079 
<a name="l01080"></a>01080    closelog(); <span class="comment">/* syslog */</span>
<a name="l01081"></a>01081 
<a name="l01082"></a>01082    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>);
<a name="l01083"></a>01083 
<a name="l01084"></a>01084    <span class="keywordflow">return</span>;
<a name="l01085"></a>01085 }
<a name="l01086"></a>01086 <span class="comment"></span>
<a name="l01087"></a>01087 <span class="comment">/*!</span>
<a name="l01088"></a>01088 <span class="comment"> * \brief send log messages to syslog and/or the console</span>
<a name="l01089"></a>01089 <span class="comment"> */</span>
<a name="l01090"></a><a class="code" href="logger_8c.html#a93dd824dff97fe84941d6d71b7a3710e">01090</a> <span class="keywordtype">void</span> <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<span class="keywordtype">int</span> level, <span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> line, <span class="keyword">const</span> <span class="keywordtype">char</span> *function, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...)
<a name="l01091"></a>01091 {
<a name="l01092"></a>01092    <span class="keyword">struct </span><a class="code" href="structlogmsg.html">logmsg</a> *<a class="code" href="structlogmsg.html">logmsg</a> = NULL;
<a name="l01093"></a>01093    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a> = NULL;
<a name="l01094"></a>01094    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l01095"></a>01095    <span class="keyword">struct </span>timeval now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l01096"></a>01096    <span class="keywordtype">int</span> res = 0;
<a name="l01097"></a>01097    va_list ap;
<a name="l01098"></a>01098 
<a name="l01099"></a>01099    <span class="keywordflow">if</span> (!(buf = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="logger_8c.html#ad073beb53a8f82626a23cd86f79e587e">log_buf</a>, <a class="code" href="logger_8c.html#a823b00a2a06078bfb2e4aeb974ae9536">LOG_BUF_INIT_SIZE</a>)))
<a name="l01100"></a>01100       <span class="keywordflow">return</span>;
<a name="l01101"></a>01101 
<a name="l01102"></a>01102    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a0044f6572f50a89049b3b5272e51b0e7">AST_RWLIST_EMPTY</a>(&amp;<a class="code" href="structlogchannels.html">logchannels</a>)) {
<a name="l01103"></a>01103       <span class="comment">/*</span>
<a name="l01104"></a>01104 <span class="comment">       * we don&apos;t have the logger chain configured yet,</span>
<a name="l01105"></a>01105 <span class="comment">       * so just log to stdout</span>
<a name="l01106"></a>01106 <span class="comment">       */</span>
<a name="l01107"></a>01107       <span class="keywordflow">if</span> (level != <a class="code" href="logger_8h.html#aa11fae1314f286da3d57ae8c07ec4bca">__LOG_VERBOSE</a>) {
<a name="l01108"></a>01108          <span class="keywordtype">int</span> result;
<a name="l01109"></a>01109          va_start(ap, fmt);
<a name="l01110"></a>01110          result = <a class="code" href="strings_8h.html#a7ce3f97dd6d3f76f92304c1f5066c77b" title="Set a dynamic string from a va_list.">ast_str_set_va</a>(&amp;buf, BUFSIZ, fmt, ap); <span class="comment">/* XXX BUFSIZ ? */</span>
<a name="l01111"></a>01111          va_end(ap);
<a name="l01112"></a>01112          <span class="keywordflow">if</span> (result != <a class="code" href="strings_8h.html#a1e06e534e565b0e44afdf96c77951725a46fbdfa757aef01471bab9679ce4281f">AST_DYNSTR_BUILD_FAILED</a>) {
<a name="l01113"></a>01113             <a class="code" href="term_8h.html#acef95dbcdd79b1e2e0fb980d57524882">term_filter_escapes</a>(<a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l01114"></a>01114             fputs(<a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf), stdout);
<a name="l01115"></a>01115          }
<a name="l01116"></a>01116       }
<a name="l01117"></a>01117       <span class="keywordflow">return</span>;
<a name="l01118"></a>01118    }
<a name="l01119"></a>01119    
<a name="l01120"></a>01120    <span class="comment">/* don&apos;t display LOG_DEBUG messages unless option_verbose _or_ option_debug</span>
<a name="l01121"></a>01121 <span class="comment">      are non-zero; LOG_DEBUG messages can still be displayed if option_debug</span>
<a name="l01122"></a>01122 <span class="comment">      is zero, if option_verbose is non-zero (this allows for &apos;level zero&apos;</span>
<a name="l01123"></a>01123 <span class="comment">      LOG_DEBUG messages to be displayed, if the logmask on any channel</span>
<a name="l01124"></a>01124 <span class="comment">      allows it)</span>
<a name="l01125"></a>01125 <span class="comment">   */</span>
<a name="l01126"></a>01126    <span class="keywordflow">if</span> (!<a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">option_verbose</a> &amp;&amp; !<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &amp;&amp; (level == <a class="code" href="logger_8h.html#aaecc0363c3e5c2798fb8ed372c9a3d56">__LOG_DEBUG</a>))
<a name="l01127"></a>01127       <span class="keywordflow">return</span>;
<a name="l01128"></a>01128 
<a name="l01129"></a>01129    <span class="comment">/* Ignore anything that never gets logged anywhere */</span>
<a name="l01130"></a>01130    <span class="keywordflow">if</span> (!(global_logmask &amp; (1 &lt;&lt; level)))
<a name="l01131"></a>01131       <span class="keywordflow">return</span>;
<a name="l01132"></a>01132    
<a name="l01133"></a>01133    <span class="comment">/* Build string */</span>
<a name="l01134"></a>01134    va_start(ap, fmt);
<a name="l01135"></a>01135    res = <a class="code" href="strings_8h.html#a7ce3f97dd6d3f76f92304c1f5066c77b" title="Set a dynamic string from a va_list.">ast_str_set_va</a>(&amp;buf, BUFSIZ, fmt, ap);
<a name="l01136"></a>01136    va_end(ap);
<a name="l01137"></a>01137 
<a name="l01138"></a>01138    <span class="comment">/* If the build failed, then abort and free this structure */</span>
<a name="l01139"></a>01139    <span class="keywordflow">if</span> (res == <a class="code" href="strings_8h.html#a1e06e534e565b0e44afdf96c77951725a46fbdfa757aef01471bab9679ce4281f">AST_DYNSTR_BUILD_FAILED</a>)
<a name="l01140"></a>01140       <span class="keywordflow">return</span>;
<a name="l01141"></a>01141 
<a name="l01142"></a>01142    <span class="comment">/* Create a new logging message */</span>
<a name="l01143"></a>01143    <span class="keywordflow">if</span> (!(logmsg = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*logmsg) + res + 1)))
<a name="l01144"></a>01144       <span class="keywordflow">return</span>;
<a name="l01145"></a>01145 
<a name="l01146"></a>01146    <span class="comment">/* Copy string over */</span>
<a name="l01147"></a>01147    strcpy(logmsg-&gt;<a class="code" href="structlogmsg.html#a21c9b0fee88b9f35e718afe5d065d676">str</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l01148"></a>01148 
<a name="l01149"></a>01149    <span class="comment">/* Set type to be normal */</span>
<a name="l01150"></a>01150    logmsg-&gt;<a class="code" href="structlogmsg.html#ac85f938a8e2e1945cc672e4886cfb9e8">type</a> = <a class="code" href="logger_8c.html#a29df94a387c835e6296b05418885993ea4ff7bef379df472011e5516f51160e2c">LOGMSG_NORMAL</a>;
<a name="l01151"></a>01151 
<a name="l01152"></a>01152    <span class="comment">/* Create our date/time */</span>
<a name="l01153"></a>01153    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;tm, NULL);
<a name="l01154"></a>01154    <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(logmsg-&gt;<a class="code" href="structlogmsg.html#a4e839704872ed7546e92d346f353dbb6">date</a>, <span class="keyword">sizeof</span>(logmsg-&gt;<a class="code" href="structlogmsg.html#a4e839704872ed7546e92d346f353dbb6">date</a>), dateformat, &amp;tm);
<a name="l01155"></a>01155 
<a name="l01156"></a>01156    <span class="comment">/* Copy over data */</span>
<a name="l01157"></a>01157    logmsg-&gt;<a class="code" href="structlogmsg.html#acf4d33ee4cff36f69b924471174dcb11">level</a> = level;
<a name="l01158"></a>01158    logmsg-&gt;<a class="code" href="structlogmsg.html#a41ebd28ef1d7c6ade45642cb6acc1039">line</a> = line;
<a name="l01159"></a>01159    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(logmsg-&gt;<a class="code" href="structlogmsg.html#ae97b19517c9f0cdda8fe4b87949e51e6">file</a>, file, <span class="keyword">sizeof</span>(logmsg-&gt;<a class="code" href="structlogmsg.html#ae97b19517c9f0cdda8fe4b87949e51e6">file</a>));
<a name="l01160"></a>01160    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(logmsg-&gt;<a class="code" href="structlogmsg.html#abe54135be1a457ab08fe76825a6f2691">function</a>, function, <span class="keyword">sizeof</span>(logmsg-&gt;<a class="code" href="structlogmsg.html#abe54135be1a457ab08fe76825a6f2691">function</a>));
<a name="l01161"></a>01161    logmsg-&gt;<a class="code" href="structlogmsg.html#a3d369159085eab613678b5bc87d8d948">process_id</a> = (long) <a class="code" href="logger_8c.html#a0f11b3d4d80f9720a4a9d94c6441d73b">GETTID</a>();
<a name="l01162"></a>01162 
<a name="l01163"></a>01163    <span class="comment">/* If the logger thread is active, append it to the tail end of the list - otherwise skip that step */</span>
<a name="l01164"></a>01164    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a6685bab4f7be49a081c4d2efe4b77a23">logthread</a> != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) {
<a name="l01165"></a>01165       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>);
<a name="l01166"></a>01166       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>, logmsg, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>);
<a name="l01167"></a>01167       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;<a class="code" href="logger_8c.html#abb118951a9d7c498a6e28454e7eb0bd5">logcond</a>);
<a name="l01168"></a>01168       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>);
<a name="l01169"></a>01169    } <span class="keywordflow">else</span> {
<a name="l01170"></a>01170       <a class="code" href="logger_8c.html#ac2c5290c43f91e7f6bdac350c32d29ae" title="Print a normal log message to the channels.">logger_print_normal</a>(logmsg);
<a name="l01171"></a>01171       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(logmsg);
<a name="l01172"></a>01172    }
<a name="l01173"></a>01173 
<a name="l01174"></a>01174    <span class="keywordflow">return</span>;
<a name="l01175"></a>01175 }
<a name="l01176"></a>01176 
<a name="l01177"></a>01177 <span class="preprocessor">#ifdef HAVE_BKTR</span>
<a name="l01178"></a>01178 <span class="preprocessor"></span>
<a name="l01179"></a>01179 <span class="keyword">struct </span>ast_bt *ast_bt_create(<span class="keywordtype">void</span>) 
<a name="l01180"></a>01180 {
<a name="l01181"></a>01181    <span class="keyword">struct </span>ast_bt *bt = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*bt));
<a name="l01182"></a>01182    <span class="keywordflow">if</span> (!bt) {
<a name="l01183"></a>01183       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to allocate memory for backtrace structure!\n&quot;</span>);
<a name="l01184"></a>01184       <span class="keywordflow">return</span> NULL;
<a name="l01185"></a>01185    }
<a name="l01186"></a>01186 
<a name="l01187"></a>01187    bt-&gt;alloced = 1;
<a name="l01188"></a>01188 
<a name="l01189"></a>01189    ast_bt_get_addresses(bt);
<a name="l01190"></a>01190 
<a name="l01191"></a>01191    <span class="keywordflow">return</span> bt;
<a name="l01192"></a>01192 }
<a name="l01193"></a>01193 
<a name="l01194"></a>01194 <span class="keywordtype">int</span> ast_bt_get_addresses(<span class="keyword">struct</span> ast_bt *bt)
<a name="l01195"></a>01195 {
<a name="l01196"></a>01196    bt-&gt;num_frames = backtrace(bt-&gt;addresses, AST_MAX_BT_FRAMES);
<a name="l01197"></a>01197 
<a name="l01198"></a>01198    <span class="keywordflow">return</span> 0;
<a name="l01199"></a>01199 }
<a name="l01200"></a>01200 
<a name="l01201"></a>01201 <span class="keywordtype">void</span> *ast_bt_destroy(<span class="keyword">struct</span> ast_bt *bt)
<a name="l01202"></a>01202 {
<a name="l01203"></a>01203    <span class="keywordflow">if</span> (bt-&gt;alloced) {
<a name="l01204"></a>01204       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(bt);
<a name="l01205"></a>01205    }
<a name="l01206"></a>01206 
<a name="l01207"></a>01207    <span class="keywordflow">return</span> NULL;
<a name="l01208"></a>01208 }
<a name="l01209"></a>01209 
<a name="l01210"></a>01210 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_BKTR */</span>
<a name="l01211"></a>01211 
<a name="l01212"></a><a class="code" href="logger_8c.html#a63eb8f0823e4b154bea34fa09ad1c948">01212</a> <span class="keywordtype">void</span> <a class="code" href="logger_8h.html#a63eb8f0823e4b154bea34fa09ad1c948">ast_backtrace</a>(<span class="keywordtype">void</span>)
<a name="l01213"></a>01213 {
<a name="l01214"></a>01214 <span class="preprocessor">#ifdef HAVE_BKTR</span>
<a name="l01215"></a>01215 <span class="preprocessor"></span>   <span class="keyword">struct </span>ast_bt *bt;
<a name="l01216"></a>01216    <span class="keywordtype">int</span> i = 0;
<a name="l01217"></a>01217    <span class="keywordtype">char</span> **strings;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219    <span class="keywordflow">if</span> (!(bt = ast_bt_create())) {
<a name="l01220"></a>01220       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate space for backtrace structure\n&quot;</span>);
<a name="l01221"></a>01221       <span class="keywordflow">return</span>;
<a name="l01222"></a>01222    }
<a name="l01223"></a>01223 
<a name="l01224"></a>01224    <span class="keywordflow">if</span> ((strings = backtrace_symbols(bt-&gt;addresses, bt-&gt;num_frames))) {
<a name="l01225"></a>01225       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Got %d backtrace record%c\n&quot;</span>, bt-&gt;num_frames, bt-&gt;num_frames != 1 ? <span class="charliteral">&apos;s&apos;</span> : <span class="charliteral">&apos; &apos;</span>);
<a name="l01226"></a>01226       <span class="keywordflow">for</span> (i = 0; i &lt; bt-&gt;num_frames; i++) {
<a name="l01227"></a>01227          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;#%d: [%p] %s\n&quot;</span>, i, bt-&gt;addresses[i], strings[i]);
<a name="l01228"></a>01228       }
<a name="l01229"></a>01229       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(strings);
<a name="l01230"></a>01230    } <span class="keywordflow">else</span> {
<a name="l01231"></a>01231       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Could not allocate memory for backtrace\n&quot;</span>);
<a name="l01232"></a>01232    }
<a name="l01233"></a>01233    ast_bt_destroy(bt);
<a name="l01234"></a>01234 <span class="preprocessor">#else</span>
<a name="l01235"></a>01235 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Must run configure with &apos;--with-execinfo&apos; for stack backtraces.\n&quot;</span>);
<a name="l01236"></a>01236 <span class="preprocessor">#endif</span>
<a name="l01237"></a>01237 <span class="preprocessor"></span>}
<a name="l01238"></a>01238 
<a name="l01239"></a><a class="code" href="logger_8c.html#a7ac32ac2e490e2d6c2f5b52c423744f6">01239</a> <span class="keywordtype">void</span> <a class="code" href="logger_8h.html#a7ac32ac2e490e2d6c2f5b52c423744f6">__ast_verbose_ap</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> line, <span class="keyword">const</span> <span class="keywordtype">char</span> *func, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, va_list ap)
<a name="l01240"></a>01240 {
<a name="l01241"></a>01241    <span class="keyword">struct </span><a class="code" href="structlogmsg.html">logmsg</a> *<a class="code" href="structlogmsg.html">logmsg</a> = NULL;
<a name="l01242"></a>01242    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a> = NULL;
<a name="l01243"></a>01243    <span class="keywordtype">int</span> res = 0;
<a name="l01244"></a>01244 
<a name="l01245"></a>01245    <span class="keywordflow">if</span> (!(buf = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="logger_8c.html#a5a468f362fab520a3eb3bf152d84884a">verbose_buf</a>, <a class="code" href="logger_8c.html#abb718d66b0fc16699d625172b7117f94">VERBOSE_BUF_INIT_SIZE</a>)))
<a name="l01246"></a>01246       <span class="keywordflow">return</span>;
<a name="l01247"></a>01247 
<a name="l01248"></a>01248    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a8b68b62e712208bdd68cc743b937fcc3">ast_opt_timestamp</a>) {
<a name="l01249"></a>01249       <span class="keyword">struct </span>timeval now;
<a name="l01250"></a>01250       <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l01251"></a>01251       <span class="keywordtype">char</span> date[40];
<a name="l01252"></a>01252       <span class="keywordtype">char</span> *datefmt;
<a name="l01253"></a>01253 
<a name="l01254"></a>01254       now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l01255"></a>01255       <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;tm, NULL);
<a name="l01256"></a>01256       <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(date, <span class="keyword">sizeof</span>(date), dateformat, &amp;tm);
<a name="l01257"></a>01257       datefmt = alloca(strlen(date) + 3 + strlen(fmt) + 1);
<a name="l01258"></a>01258       sprintf(datefmt, <span class="stringliteral">&quot;%c[%s] %s&quot;</span>, 127, date, fmt);
<a name="l01259"></a>01259       fmt = datefmt;
<a name="l01260"></a>01260    } <span class="keywordflow">else</span> {
<a name="l01261"></a>01261       <span class="keywordtype">char</span> *tmp = alloca(strlen(fmt) + 2);
<a name="l01262"></a>01262       sprintf(tmp, <span class="stringliteral">&quot;%c%s&quot;</span>, 127, fmt);
<a name="l01263"></a>01263       fmt = tmp;
<a name="l01264"></a>01264    }
<a name="l01265"></a>01265 
<a name="l01266"></a>01266    <span class="comment">/* Build string */</span>
<a name="l01267"></a>01267    res = <a class="code" href="strings_8h.html#a7ce3f97dd6d3f76f92304c1f5066c77b" title="Set a dynamic string from a va_list.">ast_str_set_va</a>(&amp;buf, 0, fmt, ap);
<a name="l01268"></a>01268 
<a name="l01269"></a>01269    <span class="comment">/* If the build failed then we can drop this allocated message */</span>
<a name="l01270"></a>01270    <span class="keywordflow">if</span> (res == <a class="code" href="strings_8h.html#a1e06e534e565b0e44afdf96c77951725a46fbdfa757aef01471bab9679ce4281f">AST_DYNSTR_BUILD_FAILED</a>)
<a name="l01271"></a>01271       <span class="keywordflow">return</span>;
<a name="l01272"></a>01272 
<a name="l01273"></a>01273    <span class="keywordflow">if</span> (!(logmsg = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*logmsg) + res + 1)))
<a name="l01274"></a>01274       <span class="keywordflow">return</span>;
<a name="l01275"></a>01275 
<a name="l01276"></a>01276    strcpy(logmsg-&gt;<a class="code" href="structlogmsg.html#a21c9b0fee88b9f35e718afe5d065d676">str</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l01277"></a>01277 
<a name="l01278"></a>01278    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aa11fae1314f286da3d57ae8c07ec4bca">__LOG_VERBOSE</a>, file, line, func, <span class="stringliteral">&quot;%s&quot;</span>, logmsg-&gt;<a class="code" href="structlogmsg.html#a21c9b0fee88b9f35e718afe5d065d676">str</a> + 1);
<a name="l01279"></a>01279 
<a name="l01280"></a>01280    <span class="comment">/* Set type */</span>
<a name="l01281"></a>01281    logmsg-&gt;<a class="code" href="structlogmsg.html#ac85f938a8e2e1945cc672e4886cfb9e8">type</a> = <a class="code" href="logger_8c.html#a29df94a387c835e6296b05418885993eae66ea31ebaa61ba9cac6412f3f9f21c7">LOGMSG_VERBOSE</a>;
<a name="l01282"></a>01282    
<a name="l01283"></a>01283    <span class="comment">/* Add to the list and poke the thread if possible */</span>
<a name="l01284"></a>01284    <span class="keywordflow">if</span> (<a class="code" href="logger_8c.html#a6685bab4f7be49a081c4d2efe4b77a23">logthread</a> != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) {
<a name="l01285"></a>01285       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>);
<a name="l01286"></a>01286       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>, logmsg, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>);
<a name="l01287"></a>01287       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;<a class="code" href="logger_8c.html#abb118951a9d7c498a6e28454e7eb0bd5">logcond</a>);
<a name="l01288"></a>01288       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structlogmsgs.html">logmsgs</a>);
<a name="l01289"></a>01289    } <span class="keywordflow">else</span> {
<a name="l01290"></a>01290       <a class="code" href="logger_8c.html#ac439f2504126267a7a8049976ac80050" title="Print a verbose message to the verbosers.">logger_print_verbose</a>(logmsg);
<a name="l01291"></a>01291       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(logmsg);
<a name="l01292"></a>01292    }
<a name="l01293"></a>01293 }
<a name="l01294"></a>01294 
<a name="l01295"></a><a class="code" href="logger_8c.html#a5317b9fdc0e0a24515ae9db5905bee9a">01295</a> <span class="keywordtype">void</span> <a class="code" href="logger_8h.html#a5317b9fdc0e0a24515ae9db5905bee9a" title="This works like ast_log, but prints verbose messages to the console depending on...">__ast_verbose</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> line, <span class="keyword">const</span> <span class="keywordtype">char</span> *func, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...)
<a name="l01296"></a>01296 {
<a name="l01297"></a>01297    va_list ap;
<a name="l01298"></a>01298    va_start(ap, fmt);
<a name="l01299"></a>01299    <a class="code" href="logger_8h.html#a7ac32ac2e490e2d6c2f5b52c423744f6">__ast_verbose_ap</a>(file, line, func, fmt, ap);
<a name="l01300"></a>01300    va_end(ap);
<a name="l01301"></a>01301 }
<a name="l01302"></a>01302 
<a name="l01303"></a>01303 <span class="comment">/* No new code should use this directly, but we have the ABI for backwards compat */</span>
<a name="l01304"></a>01304 <span class="preprocessor">#undef ast_verbose</span>
<a name="l01305"></a>01305 <span class="preprocessor"></span><span class="keywordtype">void</span> __attribute__((<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>(printf, 1,2))) <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(const <span class="keywordtype">char</span> *fmt, ...);
<a name="l01306"></a><a class="code" href="logger_8c.html#a81d26348827b996085d4cb6be3e2c348">01306</a> <span class="keywordtype">void</span> <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(const <span class="keywordtype">char</span> *fmt, ...)
<a name="l01307"></a>01307 {
<a name="l01308"></a>01308    va_list ap;
<a name="l01309"></a>01309    va_start(ap, fmt);
<a name="l01310"></a>01310    <a class="code" href="logger_8h.html#a7ac32ac2e490e2d6c2f5b52c423744f6">__ast_verbose_ap</a>(<span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;&quot;</span>, fmt, ap);
<a name="l01311"></a>01311    va_end(ap);
<a name="l01312"></a>01312 }
<a name="l01313"></a>01313 
<a name="l01314"></a><a class="code" href="logger_8c.html#aff15272ce475ec507043da5c33adff70">01314</a> <span class="keywordtype">int</span> <a class="code" href="logger_8h.html#a88db6a9fa710d601734eb260ad30348f">ast_register_verbose</a>(<span class="keywordtype">void</span> (*v)(<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">string</span>)) 
<a name="l01315"></a>01315 {
<a name="l01316"></a>01316    <span class="keyword">struct </span><a class="code" href="structverb.html">verb</a> *<a class="code" href="structverb.html">verb</a>;
<a name="l01317"></a>01317 
<a name="l01318"></a>01318    <span class="keywordflow">if</span> (!(verb = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(<span class="keyword">sizeof</span>(*verb))))
<a name="l01319"></a>01319       <span class="keywordflow">return</span> -1;
<a name="l01320"></a>01320 
<a name="l01321"></a>01321    verb-&gt;<a class="code" href="structverb.html#a8c66d6f0eeba787154fd66c2a538f12c">verboser</a> = v;
<a name="l01322"></a>01322 
<a name="l01323"></a>01323    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structverbosers.html">verbosers</a>);
<a name="l01324"></a>01324    <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;<a class="code" href="structverbosers.html">verbosers</a>, verb, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>);
<a name="l01325"></a>01325    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structverbosers.html">verbosers</a>);
<a name="l01326"></a>01326    
<a name="l01327"></a>01327    <span class="keywordflow">return</span> 0;
<a name="l01328"></a>01328 }
<a name="l01329"></a>01329 
<a name="l01330"></a><a class="code" href="logger_8c.html#a1ad3ca2629dc46b664144c7cfca98e12">01330</a> <span class="keywordtype">int</span> <a class="code" href="logger_8h.html#ac9d5f6e4de00a7d86e9c6e1cdef13409">ast_unregister_verbose</a>(<span class="keywordtype">void</span> (*v)(<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">string</span>))
<a name="l01331"></a>01331 {
<a name="l01332"></a>01332    <span class="keyword">struct </span><a class="code" href="structverb.html">verb</a> *cur;
<a name="l01333"></a>01333 
<a name="l01334"></a>01334    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structverbosers.html">verbosers</a>);
<a name="l01335"></a>01335    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structverbosers.html">verbosers</a>, cur, <a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>) {
<a name="l01336"></a>01336       <span class="keywordflow">if</span> (cur-&gt;<a class="code" href="structverb.html#a8c66d6f0eeba787154fd66c2a538f12c">verboser</a> == v) {
<a name="l01337"></a>01337          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(<a class="code" href="structlogchannel.html#a54e8df86539f38f79b480a8c8d95e37a">list</a>);
<a name="l01338"></a>01338          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cur);
<a name="l01339"></a>01339          <span class="keywordflow">break</span>;
<a name="l01340"></a>01340       }
<a name="l01341"></a>01341    }
<a name="l01342"></a>01342    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l01343"></a>01343    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structverbosers.html">verbosers</a>);
<a name="l01344"></a>01344    
<a name="l01345"></a>01345    <span class="keywordflow">return</span> cur ? 0 : -1;
<a name="l01346"></a>01346 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:42 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
