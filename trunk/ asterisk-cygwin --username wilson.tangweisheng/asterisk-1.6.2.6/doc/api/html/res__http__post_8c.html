<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:23:13 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_318a70d4e812a718d9ecaeea98fff199.html">res</a>
  </div>
</div>
<div class="contents">
<h1>res_http_post.c File Reference</h1>
<p>HTTP POST upload support for Asterisk HTTP server.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &lt;sys/stat.h&gt;</code><br/>
<code>#include &lt;fcntl.h&gt;</code><br/>
<code>#include &lt;gmime/gmime.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="linkedlists_8h_source.html">asterisk/linkedlists.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="http_8h_source.html">asterisk/http.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="paths_8h_source.html">asterisk/paths.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="tcptls_8h_source.html">asterisk/tcptls.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="manager_8h_source.html">asterisk/manager.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cli_8h_source.html">asterisk/cli.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="module_8h_source.html">asterisk/module.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="ast__version_8h_source.html">asterisk/ast_version.h</a>&quot;</code><br/>

<p><a href="res__http__post_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmime__cbinfo.html">mime_cbinfo</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#aecb32037d29b6d4c9d903ba03b56f065">MAX_PREFIX</a>&nbsp;&nbsp;&nbsp;80</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#a92a4c9d95875dd9d4c17ab41118e429f">__ast_http_post_load</a> (int reload)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#a88b7c88fed6b80fd18f34f97757dfc04">__reg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#afeab1257bd17282b95875499393a147a">__unreg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#a792062a4f32107db7d58fb15073bdf43">find_sequence</a> (char *inbuf, int inlen, char *matchbuf, int matchlen)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__str.html">ast_str</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#adcfdd5789117c0462153ae8068546b18">http_post_callback</a> (struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *ser, const struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *urih, const char *uri, enum <a class="el" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80ef">ast_http_method</a> method, struct <a class="el" href="structast__variable.html">ast_variable</a> *vars, struct <a class="el" href="structast__variable.html">ast_variable</a> *headers, int *<a class="el" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>, char **title, int *contentlength)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static GMimeMessage *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#aba03bdc5d993dc34ed6706868a09583d">parse_message</a> (FILE *<a class="el" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#a54c1f76477b3633ae76edabc4fcf0d8a">post_raw</a> (GMimePart *part, const char *post_dir, const char *fn)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#ae67447f5256d0cbed3dfb4e8f22db543">process_message</a> (GMimeMessage *<a class="el" href="structmessage.html">message</a>, const char *post_dir)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#a450d43bbbe2bcc3ebc2517dde188f3cc">process_message_callback</a> (GMimeObject *part, gpointer user_data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#a119f2f1e46f078a62c4c0848d0fba2f1">readmimefile</a> (FILE *fin, FILE *fout, char *boundary, int contentlen)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a> (void)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_DEFAULT , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;HTTP POST support&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, .reload = reload, }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#ae25b9f3970870610911f8850897e8ead">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__http__post_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a> [MAX_PREFIX]</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>HTTP POST upload support for Asterisk HTTP server. </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Terry Wilson &lt;<a href="mailto:twilson@digium.com">twilson@digium.com</a></dd></dl>
<p><a class="el" href="AstHTTP.html">AMI over HTTP support</a> - AMI over the http protocol </p>

<p>Definition in file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="aecb32037d29b6d4c9d903ba03b56f065"></a><!-- doxytag: member="res_http_post.c::MAX_PREFIX" ref="aecb32037d29b6d4c9d903ba03b56f065" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_PREFIX&nbsp;&nbsp;&nbsp;80</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00053">53</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a92a4c9d95875dd9d4c17ab41118e429f"></a><!-- doxytag: member="res_http_post.c::__ast_http_post_load" ref="a92a4c9d95875dd9d4c17ab41118e429f" args="(int reload)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int __ast_http_post_load </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>reload</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00408">408</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="config_8c_source.html#l00827">ast_config_destroy()</a>, <a class="el" href="config_8c_source.html#l02071">ast_config_load2()</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="http_8c_source.html#l00344">ast_http_uri_link()</a>, <a class="el" href="http_8c_source.html#l00387">ast_http_uri_unlink_all_with_key()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="astmm_8h_source.html#l00099">ast_strdup</a>, <a class="el" href="config_8c_source.html#l00411">ast_variable_browse()</a>, <a class="el" href="http_8h_source.html#l00082">ast_http_uri::callback</a>, <a class="el" href="config_8h_source.html#l00043">CONFIG_FLAG_FILEUNCHANGED</a>, <a class="el" href="config_8h_source.html#l00050">CONFIG_STATUS_FILEINVALID</a>, <a class="el" href="config_8h_source.html#l00048">CONFIG_STATUS_FILEMISSING</a>, <a class="el" href="config_8h_source.html#l00049">CONFIG_STATUS_FILEUNCHANGED</a>, <a class="el" href="http_8h_source.html#l00095">ast_http_uri::data</a>, <a class="el" href="http_8h_source.html#l00080">ast_http_uri::description</a>, <a class="el" href="http_8h_source.html#l00093">ast_http_uri::dmallocd</a>, <a class="el" href="http_8h_source.html#l00083">ast_http_uri::has_subtree</a>, <a class="el" href="res__http__post_8c_source.html#l00296">http_post_callback()</a>, <a class="el" href="http_8h_source.html#l00097">ast_http_uri::key</a>, <a class="el" href="http_8h_source.html#l00091">ast_http_uri::mallocd</a>, <a class="el" href="config_8h_source.html#l00075">ast_variable::name</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, <a class="el" href="http_8h_source.html#l00087">ast_http_uri::supports_get</a>, <a class="el" href="http_8h_source.html#l00089">ast_http_uri::supports_post</a>, <a class="el" href="http_8h_source.html#l00081">ast_http_uri::uri</a>, and <a class="el" href="config_8h_source.html#l00076">ast_variable::value</a>.</p>

<p>Referenced by <a class="el" href="res__http__post_8c_source.html#l00481">load_module()</a>, and <a class="el" href="res__http__post_8c_source.html#l00474">reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00409"></a>00409 {
<a name="l00410"></a>00410    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l00411"></a>00411    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l00412"></a>00412    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="app__rpt_8c.html#a1f57f20c1f46890828791a4827fe8752">config_flags</a> = { <a class="code" href="res__http__post_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l00413"></a>00413 
<a name="l00414"></a>00414    cfg = <a class="code" href="config_8h.html#aab3eac8fa82a86a93c074deb7b77dbc9" title="Load a config file.">ast_config_load2</a>(<span class="stringliteral">&quot;http.conf&quot;</span>, <span class="stringliteral">&quot;http&quot;</span>, config_flags);
<a name="l00415"></a>00415    <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a> || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l00416"></a>00416       <span class="keywordflow">return</span> 0;
<a name="l00417"></a>00417    }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419    <span class="keywordflow">if</span> (<a class="code" href="res__http__post_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>) {
<a name="l00420"></a>00420       <a class="code" href="http_8h.html#ae05bfd31702ddfd156bd1312ccbf2441" title="Unregister all handlers with matching key.">ast_http_uri_unlink_all_with_key</a>(__FILE__);
<a name="l00421"></a>00421    }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423    <span class="keywordflow">if</span> (cfg) {
<a name="l00424"></a>00424       <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00425"></a>00425          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;prefix&quot;</span>)) {
<a name="l00426"></a>00426             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="res__http__post_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="res__http__post_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>));
<a name="l00427"></a>00427             <span class="keywordflow">if</span> (<a class="code" href="res__http__post_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>[strlen(<a class="code" href="res__http__post_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>)] == <span class="charliteral">&apos;/&apos;</span>) {
<a name="l00428"></a>00428                <a class="code" href="res__http__post_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>[strlen(<a class="code" href="res__http__post_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>)] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00429"></a>00429             }
<a name="l00430"></a>00430          }
<a name="l00431"></a>00431       }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433       <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;post_mappings&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00434"></a>00434          <span class="keyword">struct </span><a class="code" href="structast__http__uri.html" title="Definition of a URI handler.">ast_http_uri</a> *urih;
<a name="l00435"></a>00435          <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *ds;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437          <span class="keywordflow">if</span> (!(urih = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(<span class="keyword">sizeof</span>(*urih), 1))) {
<a name="l00438"></a>00438             <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l00439"></a>00439             <span class="keywordflow">return</span> -1;
<a name="l00440"></a>00440          }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442          <span class="keywordflow">if</span> (!(ds = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(32))) {
<a name="l00443"></a>00443             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(urih);
<a name="l00444"></a>00444             <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l00445"></a>00445             <span class="keywordflow">return</span> -1;
<a name="l00446"></a>00446          }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448          urih-&gt;<a class="code" href="structast__http__uri.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;HTTP POST mapping&quot;</span>);
<a name="l00449"></a>00449          urih-&gt;<a class="code" href="structast__http__uri.html#a69ec24fb2d0a5f5e532deb9adaab81d6">uri</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00450"></a>00450          <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;ds, 0, <span class="stringliteral">&quot;%s&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00451"></a>00451          urih-&gt;<a class="code" href="structast__http__uri.html#a735984d41155bc1032e09bece8f8d66d">data</a> = ds;
<a name="l00452"></a>00452          urih-&gt;<a class="code" href="structast__http__uri.html#a208647b07f25afba1725ed60eefb98ac">has_subtree</a> = 0;
<a name="l00453"></a>00453          urih-&gt;<a class="code" href="structast__http__uri.html#aefc8e8b7c3d28c7cf42196597cb4c281">supports_get</a> = 0;
<a name="l00454"></a>00454          urih-&gt;<a class="code" href="structast__http__uri.html#a79428a579d69a59c104cf74df85577dd">supports_post</a> = 1;
<a name="l00455"></a>00455          urih-&gt;<a class="code" href="structast__http__uri.html#a4ef4b8290b170231e27114a0a02f1c51">callback</a> = <a class="code" href="res__http__post_8c.html#adcfdd5789117c0462153ae8068546b18">http_post_callback</a>;
<a name="l00456"></a>00456          urih-&gt;<a class="code" href="structast__http__uri.html#acd3d88da3c0e0313c3645ff34f62f542">key</a> = __FILE__;
<a name="l00457"></a>00457          urih-&gt;<a class="code" href="structast__http__uri.html#ae6cd4621862105820006f1c6ba56e427">mallocd</a> = urih-&gt;<a class="code" href="structast__http__uri.html#a55ab2ed9aeff792462e0efe00685b7d6">dmallocd</a> = 1;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459          <a class="code" href="http_8h.html#ac99d56925cf94f8cf3ed0acac52e2d75" title="Register a URI handler.">ast_http_uri_link</a>(urih);
<a name="l00460"></a>00460       }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l00463"></a>00463    }
<a name="l00464"></a>00464    <span class="keywordflow">return</span> 0;
<a name="l00465"></a>00465 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a88b7c88fed6b80fd18f34f97757dfc04"></a><!-- doxytag: member="res_http_post.c::__reg_module" ref="a88b7c88fed6b80fd18f34f97757dfc04" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __reg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00494">494</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

</div>
</div>
<a class="anchor" id="afeab1257bd17282b95875499393a147a"></a><!-- doxytag: member="res_http_post.c::__unreg_module" ref="afeab1257bd17282b95875499393a147a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __unreg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00494">494</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

</div>
</div>
<a class="anchor" id="a792062a4f32107db7d58fb15073bdf43"></a><!-- doxytag: member="res_http_post.c::find_sequence" ref="a792062a4f32107db7d58fb15073bdf43" args="(char *inbuf, int inlen, char *matchbuf, int matchlen)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int find_sequence </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>inbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>inlen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>matchbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>matchlen</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00161">161</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

<p>Referenced by <a class="el" href="res__http__post_8c_source.html#l00197">readmimefile()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00162"></a>00162 {
<a name="l00163"></a>00163    <span class="keywordtype">int</span> current;
<a name="l00164"></a>00164    <span class="keywordtype">int</span> comp;
<a name="l00165"></a>00165    <span class="keywordtype">int</span> found = 0;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167    <span class="keywordflow">for</span> (current = 0; current &lt; inlen-matchlen; current++, <a class="code" href="app__voicemail_8c.html#ac70fbae4ed48b5b48ff4b49f01e29f86" title="utility used by inchar(), for base_encode()">inbuf</a>++) {
<a name="l00168"></a>00168       <span class="keywordflow">if</span> (*<a class="code" href="app__voicemail_8c.html#ac70fbae4ed48b5b48ff4b49f01e29f86" title="utility used by inchar(), for base_encode()">inbuf</a> == *matchbuf) {
<a name="l00169"></a>00169          found=1;
<a name="l00170"></a>00170          <span class="keywordflow">for</span> (comp = 1; comp &lt; matchlen; comp++) {
<a name="l00171"></a>00171             <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ac70fbae4ed48b5b48ff4b49f01e29f86" title="utility used by inchar(), for base_encode()">inbuf</a>[comp] != matchbuf[comp]) {
<a name="l00172"></a>00172                found = 0;
<a name="l00173"></a>00173                <span class="keywordflow">break</span>;
<a name="l00174"></a>00174             }
<a name="l00175"></a>00175          }
<a name="l00176"></a>00176          <span class="keywordflow">if</span> (found) {
<a name="l00177"></a>00177             <span class="keywordflow">break</span>;
<a name="l00178"></a>00178          }
<a name="l00179"></a>00179       }
<a name="l00180"></a>00180    }
<a name="l00181"></a>00181    <span class="keywordflow">if</span> (found) {
<a name="l00182"></a>00182       <span class="keywordflow">return</span> current;
<a name="l00183"></a>00183    } <span class="keywordflow">else</span> {
<a name="l00184"></a>00184       <span class="keywordflow">return</span> -1;
<a name="l00185"></a>00185    }
<a name="l00186"></a>00186 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="adcfdd5789117c0462153ae8068546b18"></a><!-- doxytag: member="res_http_post.c::http_post_callback" ref="adcfdd5789117c0462153ae8068546b18" args="(struct ast_tcptls_session_instance *ser, const struct ast_http_uri *urih, const char *uri, enum ast_http_method method, struct ast_variable *vars, struct ast_variable *headers, int *status, char **title, int *contentlength)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__str.html">ast_str</a>* http_post_callback </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *&nbsp;</td>
          <td class="paramname"> <em>ser</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *&nbsp;</td>
          <td class="paramname"> <em>urih</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>uri</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="http_8h.html#a16fb43ed7e6093a9dc96477ba37b80ef">ast_http_method</a>&nbsp;</td>
          <td class="paramname"> <em>method</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td>
          <td class="paramname"> <em>vars</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td>
          <td class="paramname"> <em>headers</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>status</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&nbsp;</td>
          <td class="paramname"> <em>title</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>contentlength</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00296">296</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="http_8c_source.html#l00309">ast_http_error()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="astmm_8h_source.html#l00099">ast_strdup</a>, <a class="el" href="manager_8c_source.html#l03555">astman_verify_session_writepermissions()</a>, <a class="el" href="http_8h_source.html#l00095">ast_http_uri::data</a>, <a class="el" href="manager_8h_source.html#l00068">EVENT_FLAG_CONFIG</a>, <a class="el" href="tcptls_8h_source.html#l00134">ast_tcptls_session_instance::f</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="logger_8h_source.html#l00119">LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="config_8h_source.html#l00075">ast_variable::name</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>, <a class="el" href="res__http__post_8c_source.html#l00091">parse_message()</a>, <a class="el" href="res__http__post_8c_source.html#l00147">process_message()</a>, <a class="el" href="res__http__post_8c_source.html#l00197">readmimefile()</a>, <a class="el" href="config_8h_source.html#l00076">ast_variable::value</a>, and <a class="el" href="ast__expr2f_8c_source.html#l00613">var</a>.</p>

<p>Referenced by <a class="el" href="res__http__post_8c_source.html#l00408">__ast_http_post_load()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00297"></a>00297 {
<a name="l00298"></a>00298    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l00299"></a>00299    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ident = 0;
<a name="l00300"></a>00300    FILE *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00301"></a>00301    <span class="keywordtype">int</span> content_len = 0;
<a name="l00302"></a>00302    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *post_dir;
<a name="l00303"></a>00303    GMimeMessage *<a class="code" href="structmessage.html">message</a>;
<a name="l00304"></a>00304    <span class="keywordtype">int</span> message_count = 0;
<a name="l00305"></a>00305    <span class="keywordtype">char</span> * boundary_marker = NULL;
<a name="l00306"></a>00306 
<a name="l00307"></a>00307    <span class="keywordflow">if</span> (!urih) {
<a name="l00308"></a>00308       <span class="keywordflow">return</span> <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 400),
<a name="l00309"></a>00309             (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;Missing URI handle&quot;</span>)),
<a name="l00310"></a>00310             NULL, <span class="stringliteral">&quot;There was an error parsing the request&quot;</span>);
<a name="l00311"></a>00311    }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313    <span class="keywordflow">for</span> (var = vars; var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00314"></a>00314       <span class="keywordflow">if</span> (strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mansession_id&quot;</span>)) {
<a name="l00315"></a>00315          <span class="keywordflow">continue</span>;
<a name="l00316"></a>00316       }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318       <span class="keywordflow">if</span> (sscanf(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30lx&quot;</span>, &amp;ident) != 1) {
<a name="l00319"></a>00319          <span class="keywordflow">return</span> <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 400),
<a name="l00320"></a>00320                      (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;Bad Request&quot;</span>)),
<a name="l00321"></a>00321                      NULL, <span class="stringliteral">&quot;The was an error parsing the request.&quot;</span>);
<a name="l00322"></a>00322       }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324       <span class="keywordflow">if</span> (!<a class="code" href="manager_8h.html#a38eb222ca678604d4f203c9e9d5295ab" title="Verify a session&amp;#39;s write permissions against a permission mask.">astman_verify_session_writepermissions</a>(ident, <a class="code" href="manager_8h.html#a36fb89c2a73755209133b6c73fe92e54">EVENT_FLAG_CONFIG</a>)) {
<a name="l00325"></a>00325          <span class="keywordflow">return</span> <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 401),
<a name="l00326"></a>00326                      (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;Unauthorized&quot;</span>)),
<a name="l00327"></a>00327                      NULL, <span class="stringliteral">&quot;You are not authorized to make this request.&quot;</span>);
<a name="l00328"></a>00328       }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330       <span class="keywordflow">break</span>;
<a name="l00331"></a>00331    }
<a name="l00332"></a>00332 
<a name="l00333"></a>00333    <span class="keywordflow">if</span> (!var) {
<a name="l00334"></a>00334       <span class="keywordflow">return</span> <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 401),
<a name="l00335"></a>00335                   (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;Unauthorized&quot;</span>)),
<a name="l00336"></a>00336                   NULL, <span class="stringliteral">&quot;You are not authorized to make this request.&quot;</span>);
<a name="l00337"></a>00337    }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339    <span class="keywordflow">if</span> (!(f = tmpfile())) {
<a name="l00340"></a>00340       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not create temp file.\n&quot;</span>);
<a name="l00341"></a>00341       <span class="keywordflow">return</span> NULL;
<a name="l00342"></a>00342    }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344    <span class="keywordflow">for</span> (var = headers; var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00345"></a>00345       fprintf(f, <span class="stringliteral">&quot;%s: %s\r\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00346"></a>00346 
<a name="l00347"></a>00347       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;Content-Length&quot;</span>)) {
<a name="l00348"></a>00348          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30u&quot;</span>, &amp;content_len)) != 1) {
<a name="l00349"></a>00349             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid Content-Length in POST request!\n&quot;</span>);
<a name="l00350"></a>00350             fclose(f);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352             <span class="keywordflow">return</span> NULL;
<a name="l00353"></a>00353          }
<a name="l00354"></a>00354          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Got a Content-Length of %d\n&quot;</span>, content_len);
<a name="l00355"></a>00355       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;Content-Type&quot;</span>)) {
<a name="l00356"></a>00356          boundary_marker = strstr(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;boundary=&quot;</span>);
<a name="l00357"></a>00357          <span class="keywordflow">if</span> (boundary_marker) {
<a name="l00358"></a>00358             boundary_marker += strlen(<span class="stringliteral">&quot;boundary=&quot;</span>);
<a name="l00359"></a>00359          }
<a name="l00360"></a>00360       }
<a name="l00361"></a>00361    }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363    fprintf(f, <span class="stringliteral">&quot;\r\n&quot;</span>);
<a name="l00364"></a>00364 
<a name="l00365"></a>00365    <span class="keywordflow">if</span> (0 &gt; <a class="code" href="res__http__post_8c.html#a119f2f1e46f078a62c4c0848d0fba2f1">readmimefile</a>(ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>, f, boundary_marker, content_len)) {
<a name="l00366"></a>00366       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>) {
<a name="l00367"></a>00367          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Cannot find boundary marker in POST request.\n&quot;</span>);
<a name="l00368"></a>00368       }
<a name="l00369"></a>00369       fclose(f);
<a name="l00370"></a>00370       
<a name="l00371"></a>00371       <span class="keywordflow">return</span> NULL;
<a name="l00372"></a>00372    }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374    <span class="keywordflow">if</span> (fseek(f, SEEK_SET, 0)) {
<a name="l00375"></a>00375       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to seek temp file back to beginning.\n&quot;</span>);
<a name="l00376"></a>00376       fclose(f);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378       <span class="keywordflow">return</span> NULL;
<a name="l00379"></a>00379    }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381    post_dir = urih-&gt;<a class="code" href="structast__http__uri.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383    message = <a class="code" href="res__http__post_8c.html#aba03bdc5d993dc34ed6706868a09583d">parse_message</a>(f); <span class="comment">/* Takes ownership and will close f */</span>
<a name="l00384"></a>00384 
<a name="l00385"></a>00385    <span class="keywordflow">if</span> (!message) {
<a name="l00386"></a>00386       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error parsing MIME data\n&quot;</span>);
<a name="l00387"></a>00387 
<a name="l00388"></a>00388       <span class="keywordflow">return</span> <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 400),
<a name="l00389"></a>00389                   (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;Bad Request&quot;</span>)),
<a name="l00390"></a>00390                   NULL, <span class="stringliteral">&quot;The was an error parsing the request.&quot;</span>);
<a name="l00391"></a>00391    }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393    <span class="keywordflow">if</span> (!(message_count = <a class="code" href="res__http__post_8c.html#ae67447f5256d0cbed3dfb4e8f22db543">process_message</a>(message, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(post_dir)))) {
<a name="l00394"></a>00394       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid MIME data, found no parts!\n&quot;</span>);
<a name="l00395"></a>00395       g_object_unref(message);
<a name="l00396"></a>00396       <span class="keywordflow">return</span> <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 400),
<a name="l00397"></a>00397                   (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;Bad Request&quot;</span>)),
<a name="l00398"></a>00398                   NULL, <span class="stringliteral">&quot;The was an error parsing the request.&quot;</span>);
<a name="l00399"></a>00399    }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401    g_object_unref(message);
<a name="l00402"></a>00402 
<a name="l00403"></a>00403    <span class="keywordflow">return</span> <a class="code" href="http_8h.html#a934683361438de9f78b6c88a6a106b46" title="Return an ast_str malloc()&amp;#39;d string containing an HTTP error message.">ast_http_error</a>((*<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = 200),
<a name="l00404"></a>00404                (*title = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;OK&quot;</span>)),
<a name="l00405"></a>00405                NULL, <span class="stringliteral">&quot;File successfully uploaded.&quot;</span>);
<a name="l00406"></a>00406 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac3382bf6da54c56b37069bd76bbdf4f9"></a><!-- doxytag: member="res_http_post.c::load_module" ref="ac3382bf6da54c56b37069bd76bbdf4f9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00481">481</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

<p>References <a class="el" href="res__http__post_8c_source.html#l00408">__ast_http_post_load()</a>, and <a class="el" href="module_8h_source.html#l00061">AST_MODULE_LOAD_SUCCESS</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00482"></a>00482 {
<a name="l00483"></a>00483    g_mime_init(0);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485    <a class="code" href="res__http__post_8c.html#a92a4c9d95875dd9d4c17ab41118e429f">__ast_http_post_load</a>(0);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l00488"></a>00488 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aba03bdc5d993dc34ed6706868a09583d"></a><!-- doxytag: member="res_http_post.c::parse_message" ref="aba03bdc5d993dc34ed6706868a09583d" args="(FILE *f)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static GMimeMessage* parse_message </td>
          <td>(</td>
          <td class="paramtype">FILE *&nbsp;</td>
          <td class="paramname"> <em>f</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00091">91</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

<p>Referenced by <a class="el" href="res__http__post_8c_source.html#l00296">http_post_callback()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00092"></a>00092 {
<a name="l00093"></a>00093    GMimeMessage *<a class="code" href="structmessage.html">message</a>;
<a name="l00094"></a>00094    GMimeParser *parser;
<a name="l00095"></a>00095    GMimeStream *stream;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097    stream = g_mime_stream_file_new(<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>);
<a name="l00098"></a>00098 
<a name="l00099"></a>00099    parser = g_mime_parser_new_with_stream(stream);
<a name="l00100"></a>00100    g_mime_parser_set_respect_content_length(parser, 1);
<a name="l00101"></a>00101    
<a name="l00102"></a>00102    g_object_unref(stream);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104    message = g_mime_parser_construct_message(parser);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106    g_object_unref(parser);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108    <span class="keywordflow">return</span> message;
<a name="l00109"></a>00109 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a54c1f76477b3633ae76edabc4fcf0d8a"></a><!-- doxytag: member="res_http_post.c::post_raw" ref="a54c1f76477b3633ae76edabc4fcf0d8a" args="(GMimePart *part, const char *post_dir, const char *fn)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void post_raw </td>
          <td>(</td>
          <td class="paramtype">GMimePart *&nbsp;</td>
          <td class="paramname"> <em>part</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>post_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>fn</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00064">64</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, and <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>.</p>

<p>Referenced by <a class="el" href="res__http__post_8c_source.html#l00111">process_message_callback()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00065"></a>00065 {
<a name="l00066"></a>00066    <span class="keywordtype">char</span> filename[PATH_MAX];
<a name="l00067"></a>00067    GMimeDataWrapper *content;
<a name="l00068"></a>00068    GMimeStream *stream;
<a name="l00069"></a>00069    <span class="keywordtype">int</span> fd;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071    snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s/%s&quot;</span>, post_dir, fn);
<a name="l00072"></a>00072 
<a name="l00073"></a>00073    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Posting raw data to %s\n&quot;</span>, filename);
<a name="l00074"></a>00074 
<a name="l00075"></a>00075    <span class="keywordflow">if</span> ((fd = open(filename, O_CREAT | O_WRONLY | O_TRUNC, 0666)) == -1) {
<a name="l00076"></a>00076       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open %s for writing file from a POST!\n&quot;</span>, filename);
<a name="l00077"></a>00077 
<a name="l00078"></a>00078       <span class="keywordflow">return</span>;
<a name="l00079"></a>00079    }
<a name="l00080"></a>00080 
<a name="l00081"></a>00081    stream = g_mime_stream_fs_new(fd);
<a name="l00082"></a>00082 
<a name="l00083"></a>00083    content = g_mime_part_get_content_object(part);
<a name="l00084"></a>00084    g_mime_data_wrapper_write_to_stream(content, stream);
<a name="l00085"></a>00085    g_mime_stream_flush(stream);
<a name="l00086"></a>00086 
<a name="l00087"></a>00087    g_object_unref(content);
<a name="l00088"></a>00088    g_object_unref(stream);
<a name="l00089"></a>00089 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae67447f5256d0cbed3dfb4e8f22db543"></a><!-- doxytag: member="res_http_post.c::process_message" ref="ae67447f5256d0cbed3dfb4e8f22db543" args="(GMimeMessage *message, const char *post_dir)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int process_message </td>
          <td>(</td>
          <td class="paramtype">GMimeMessage *&nbsp;</td>
          <td class="paramname"> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>post_dir</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00147">147</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

<p>References <a class="el" href="res__http__post_8c_source.html#l00057">mime_cbinfo::count</a>, and <a class="el" href="res__http__post_8c_source.html#l00111">process_message_callback()</a>.</p>

<p>Referenced by <a class="el" href="res__http__post_8c_source.html#l00296">http_post_callback()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00148"></a>00148 {
<a name="l00149"></a>00149    <span class="keyword">struct </span><a class="code" href="structmime__cbinfo.html">mime_cbinfo</a> cbinfo = {
<a name="l00150"></a>00150       .count = 0,
<a name="l00151"></a>00151       .post_dir = <a class="code" href="structmime__cbinfo.html#a9a7b789e775871d6ef5e642736940c1d">post_dir</a>,
<a name="l00152"></a>00152    };
<a name="l00153"></a>00153 
<a name="l00154"></a>00154    g_mime_message_foreach_part(<a class="code" href="structmessage.html">message</a>, <a class="code" href="res__http__post_8c.html#a450d43bbbe2bcc3ebc2517dde188f3cc">process_message_callback</a>, &amp;cbinfo);
<a name="l00155"></a>00155 
<a name="l00156"></a>00156    <span class="keywordflow">return</span> cbinfo.<a class="code" href="structmime__cbinfo.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>;
<a name="l00157"></a>00157 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a450d43bbbe2bcc3ebc2517dde188f3cc"></a><!-- doxytag: member="res_http_post.c::process_message_callback" ref="a450d43bbbe2bcc3ebc2517dde188f3cc" args="(GMimeObject *part, gpointer user_data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void process_message_callback </td>
          <td>(</td>
          <td class="paramtype">GMimeObject *&nbsp;</td>
          <td class="paramname"> <em>part</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gpointer&nbsp;</td>
          <td class="paramname"> <em>user_data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00111">111</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="res__http__post_8c_source.html#l00057">mime_cbinfo::count</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__http__post_8c_source.html#l00058">mime_cbinfo::post_dir</a>, and <a class="el" href="res__http__post_8c_source.html#l00064">post_raw()</a>.</p>

<p>Referenced by <a class="el" href="res__http__post_8c_source.html#l00147">process_message()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00112"></a>00112 {
<a name="l00113"></a>00113    <span class="keyword">struct </span><a class="code" href="structmime__cbinfo.html">mime_cbinfo</a> *cbinfo = user_data;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115    cbinfo-&gt;<a class="code" href="structmime__cbinfo.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>++;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117    <span class="comment">/* We strip off the headers before we get here, so should only see GMIME_IS_PART */</span>
<a name="l00118"></a>00118    <span class="keywordflow">if</span> (GMIME_IS_MESSAGE_PART(part)) {
<a name="l00119"></a>00119       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Got unexpected GMIME_IS_MESSAGE_PART\n&quot;</span>);
<a name="l00120"></a>00120       <span class="keywordflow">return</span>;
<a name="l00121"></a>00121    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GMIME_IS_MESSAGE_PARTIAL(part)) {
<a name="l00122"></a>00122       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Got unexpected GMIME_IS_MESSAGE_PARTIAL\n&quot;</span>);
<a name="l00123"></a>00123       <span class="keywordflow">return</span>;
<a name="l00124"></a>00124    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GMIME_IS_MULTIPART(part)) {
<a name="l00125"></a>00125       GList *l;
<a name="l00126"></a>00126       
<a name="l00127"></a>00127       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Got unexpected GMIME_IS_MULTIPART, trying to process subparts\n&quot;</span>);
<a name="l00128"></a>00128       l = GMIME_MULTIPART(part)-&gt;subparts;
<a name="l00129"></a>00129       <span class="keywordflow">while</span> (l) {
<a name="l00130"></a>00130          <a class="code" href="res__http__post_8c.html#a450d43bbbe2bcc3ebc2517dde188f3cc">process_message_callback</a>(l-&gt;data, cbinfo);
<a name="l00131"></a>00131          l = l-&gt;next;
<a name="l00132"></a>00132       }
<a name="l00133"></a>00133    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GMIME_IS_PART(part)) {
<a name="l00134"></a>00134       <span class="keyword">const</span> <span class="keywordtype">char</span> *filename;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(filename = g_mime_part_get_filename(GMIME_PART(part)))) {
<a name="l00137"></a>00137          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Skipping part with no filename\n&quot;</span>);
<a name="l00138"></a>00138          <span class="keywordflow">return</span>;
<a name="l00139"></a>00139       }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141       <a class="code" href="res__http__post_8c.html#a54c1f76477b3633ae76edabc4fcf0d8a">post_raw</a>(GMIME_PART(part), cbinfo-&gt;<a class="code" href="structmime__cbinfo.html#a9a7b789e775871d6ef5e642736940c1d">post_dir</a>, filename);
<a name="l00142"></a>00142    } <span class="keywordflow">else</span> {
<a name="l00143"></a>00143       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Encountered unknown MIME part. This should never happen!\n&quot;</span>);
<a name="l00144"></a>00144    }
<a name="l00145"></a>00145 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a119f2f1e46f078a62c4c0848d0fba2f1"></a><!-- doxytag: member="res_http_post.c::readmimefile" ref="a119f2f1e46f078a62c4c0848d0fba2f1" args="(FILE *fin, FILE *fout, char *boundary, int contentlen)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int readmimefile </td>
          <td>(</td>
          <td class="paramtype">FILE *&nbsp;</td>
          <td class="paramname"> <em>fin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">FILE *&nbsp;</td>
          <td class="paramname"> <em>fout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>boundary</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>contentlen</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00197">197</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="res__http__post_8c_source.html#l00161">find_sequence()</a>, <a class="el" href="ast__expr2f_8c_source.html#l00563">fwrite</a>, and <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>.</p>

<p>Referenced by <a class="el" href="res__http__post_8c_source.html#l00296">http_post_callback()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00198"></a>00198 {
<a name="l00199"></a>00199    <span class="keywordtype">int</span> find_filename = 0;
<a name="l00200"></a>00200    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[4096];
<a name="l00201"></a>00201    <span class="keywordtype">int</span> marker;
<a name="l00202"></a>00202    <span class="keywordtype">int</span> x;
<a name="l00203"></a>00203    <span class="keywordtype">int</span> char_in_buf = 0;
<a name="l00204"></a>00204    <span class="keywordtype">int</span> num_to_read;
<a name="l00205"></a>00205    <span class="keywordtype">int</span> boundary_len;
<a name="l00206"></a>00206    <span class="keywordtype">char</span> * path_end, * path_start, * filespec;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208    <span class="keywordflow">if</span> (NULL == fin || NULL == fout || NULL == boundary || 0 &gt;= contentlen) {
<a name="l00209"></a>00209       <span class="keywordflow">return</span> -1;
<a name="l00210"></a>00210    }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212    boundary_len = strlen(boundary);
<a name="l00213"></a>00213    <span class="keywordflow">while</span> (0 &lt; contentlen || 0 &lt; char_in_buf) {
<a name="l00214"></a>00214       <span class="comment">/* determine how much I will read into the buffer */</span>
<a name="l00215"></a>00215       <span class="keywordflow">if</span> (contentlen &gt; <span class="keyword">sizeof</span>(buf) - char_in_buf) {
<a name="l00216"></a>00216          num_to_read = <span class="keyword">sizeof</span>(buf)- char_in_buf;
<a name="l00217"></a>00217       } <span class="keywordflow">else</span> {
<a name="l00218"></a>00218          num_to_read = contentlen;
<a name="l00219"></a>00219       }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221       <span class="keywordflow">if</span> (0 &lt; num_to_read) {
<a name="l00222"></a>00222          <span class="keywordflow">if</span> (fread(&amp;(buf[char_in_buf]), 1, num_to_read, fin) &lt; num_to_read) {
<a name="l00223"></a>00223             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;fread() failed: %s\n&quot;</span>, strerror(errno));
<a name="l00224"></a>00224             num_to_read = 0;
<a name="l00225"></a>00225          }
<a name="l00226"></a>00226          contentlen -= num_to_read;
<a name="l00227"></a>00227          char_in_buf += num_to_read;
<a name="l00228"></a>00228       }
<a name="l00229"></a>00229       <span class="comment">/* If I am looking for the filename spec */</span>
<a name="l00230"></a>00230       <span class="keywordflow">if</span> (find_filename) {
<a name="l00231"></a>00231          path_end = filespec = NULL;
<a name="l00232"></a>00232          x = strlen(<span class="stringliteral">&quot;filename=\&quot;&quot;</span>);
<a name="l00233"></a>00233          marker = <a class="code" href="res__http__post_8c.html#a792062a4f32107db7d58fb15073bdf43">find_sequence</a>(buf, char_in_buf, <span class="stringliteral">&quot;filename=\&quot;&quot;</span>, x );
<a name="l00234"></a>00234          <span class="keywordflow">if</span> (0 &lt;= marker) {
<a name="l00235"></a>00235             marker += x;  <span class="comment">/* Index beyond the filename marker */</span>
<a name="l00236"></a>00236             path_start = &amp;buf[marker];
<a name="l00237"></a>00237             <span class="keywordflow">for</span> (path_end = path_start, x = 0; x &lt; char_in_buf-marker; x++, path_end++) {
<a name="l00238"></a>00238                <span class="keywordflow">if</span> (<span class="charliteral">&apos;\\&apos;</span> == *path_end) {   <span class="comment">/* convert backslashses to forward slashes */</span>
<a name="l00239"></a>00239                   *path_end = <span class="charliteral">&apos;/&apos;</span>;
<a name="l00240"></a>00240                }
<a name="l00241"></a>00241                <span class="keywordflow">if</span> (<span class="charliteral">&apos;\&quot;&apos;</span> == *path_end) {   <span class="comment">/* If at the end of the file name spec */</span>
<a name="l00242"></a>00242                   *path_end = <span class="charliteral">&apos;\0&apos;</span>;    <span class="comment">/* temporarily null terminate the file spec for basename */</span>
<a name="l00243"></a>00243                   filespec = basename(path_start);
<a name="l00244"></a>00244                   *path_end = <span class="charliteral">&apos;\&quot;&apos;</span>;
<a name="l00245"></a>00245                   <span class="keywordflow">break</span>;
<a name="l00246"></a>00246                }
<a name="l00247"></a>00247             }
<a name="l00248"></a>00248          }
<a name="l00249"></a>00249          <span class="keywordflow">if</span> (filespec) {   <span class="comment">/* If the file name path was found in the header */</span>
<a name="l00250"></a>00250             <span class="keywordflow">if</span> (<a class="code" href="ast__expr2f_8c.html#a8541b986268a39ba1b07d9e912d31732">fwrite</a>(buf, 1, marker, fout) != marker) {
<a name="l00251"></a>00251                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;fwrite() failed: %s\n&quot;</span>, strerror(errno));
<a name="l00252"></a>00252             }
<a name="l00253"></a>00253             x = (int)(path_end+1 - filespec);
<a name="l00254"></a>00254             <span class="keywordflow">if</span> (<a class="code" href="ast__expr2f_8c.html#a8541b986268a39ba1b07d9e912d31732">fwrite</a>(filespec, 1, x, fout) != x) {
<a name="l00255"></a>00255                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;fwrite() failed: %s\n&quot;</span>, strerror(errno));
<a name="l00256"></a>00256             }
<a name="l00257"></a>00257             x = (int)(path_end+1 - buf);
<a name="l00258"></a>00258             memmove(buf, &amp;(buf[x]), char_in_buf-x);
<a name="l00259"></a>00259             char_in_buf -= x;
<a name="l00260"></a>00260          }
<a name="l00261"></a>00261          find_filename = 0;
<a name="l00262"></a>00262       } <span class="keywordflow">else</span> { <span class="comment">/* I am looking for the boundary marker */</span>
<a name="l00263"></a>00263          marker = <a class="code" href="res__http__post_8c.html#a792062a4f32107db7d58fb15073bdf43">find_sequence</a>(buf, char_in_buf, boundary, boundary_len);
<a name="l00264"></a>00264          <span class="keywordflow">if</span> (0 &gt; marker) {
<a name="l00265"></a>00265             <span class="keywordflow">if</span> (char_in_buf &lt; (boundary_len)) {
<a name="l00266"></a>00266                <span class="comment">/*no possibility to find the boundary, write all you have */</span>
<a name="l00267"></a>00267                <span class="keywordflow">if</span> (<a class="code" href="ast__expr2f_8c.html#a8541b986268a39ba1b07d9e912d31732">fwrite</a>(buf, 1, char_in_buf, fout) != char_in_buf) {
<a name="l00268"></a>00268                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;fwrite() failed: %s\n&quot;</span>, strerror(errno));
<a name="l00269"></a>00269                }
<a name="l00270"></a>00270                char_in_buf = 0;
<a name="l00271"></a>00271             } <span class="keywordflow">else</span> {
<a name="l00272"></a>00272                <span class="comment">/* write all except for area where the boundary marker could be */</span>
<a name="l00273"></a>00273                <span class="keywordflow">if</span> (<a class="code" href="ast__expr2f_8c.html#a8541b986268a39ba1b07d9e912d31732">fwrite</a>(buf, 1, char_in_buf -(boundary_len -1), fout) != char_in_buf - (boundary_len - 1)) {
<a name="l00274"></a>00274                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;fwrite() failed: %s\n&quot;</span>, strerror(errno));
<a name="l00275"></a>00275                }
<a name="l00276"></a>00276                x = char_in_buf -(boundary_len -1);
<a name="l00277"></a>00277                memmove(buf, &amp;(buf[x]), char_in_buf-x);
<a name="l00278"></a>00278                char_in_buf = (boundary_len -1);
<a name="l00279"></a>00279             }
<a name="l00280"></a>00280          } <span class="keywordflow">else</span> {
<a name="l00281"></a>00281             <span class="comment">/* write up through the boundary, then look for filename in the rest */</span>
<a name="l00282"></a>00282             <span class="keywordflow">if</span> (<a class="code" href="ast__expr2f_8c.html#a8541b986268a39ba1b07d9e912d31732">fwrite</a>(buf, 1, marker + boundary_len, fout) != marker + boundary_len) {
<a name="l00283"></a>00283                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;fwrite() failed: %s\n&quot;</span>, strerror(errno));
<a name="l00284"></a>00284             }
<a name="l00285"></a>00285             x = marker + boundary_len;
<a name="l00286"></a>00286             memmove(buf, &amp;(buf[x]), char_in_buf-x);
<a name="l00287"></a>00287             char_in_buf -= marker + boundary_len;
<a name="l00288"></a>00288             find_filename =1;
<a name="l00289"></a>00289          }
<a name="l00290"></a>00290       }
<a name="l00291"></a>00291    }
<a name="l00292"></a>00292    <span class="keywordflow">return</span> 0;
<a name="l00293"></a>00293 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad1982509765f4870f1f63412a53ea668"></a><!-- doxytag: member="res_http_post.c::reload" ref="ad1982509765f4870f1f63412a53ea668" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int reload </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00474">474</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

<p>References <a class="el" href="res__http__post_8c_source.html#l00408">__ast_http_post_load()</a>, and <a class="el" href="module_8h_source.html#l00061">AST_MODULE_LOAD_SUCCESS</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00475"></a>00475 {
<a name="l00476"></a>00476    <a class="code" href="res__http__post_8c.html#a92a4c9d95875dd9d4c17ab41118e429f">__ast_http_post_load</a>(1);
<a name="l00477"></a>00477 
<a name="l00478"></a>00478    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l00479"></a>00479 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad09fa931f468002152a3cc2d5ce25eae"></a><!-- doxytag: member="res_http_post.c::unload_module" ref="ad09fa931f468002152a3cc2d5ce25eae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unload_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00467">467</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

<p>References <a class="el" href="http_8c_source.html#l00387">ast_http_uri_unlink_all_with_key()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00468"></a>00468 {
<a name="l00469"></a>00469    <a class="code" href="http_8h.html#ae05bfd31702ddfd156bd1312ccbf2441" title="Unregister all handlers with matching key.">ast_http_uri_unlink_all_with_key</a>(__FILE__);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471    <span class="keywordflow">return</span> 0;
<a name="l00472"></a>00472 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="ab22f32016155f7f403e7178767163d7d"></a><!-- doxytag: member="res_http_post.c::__mod_info" ref="ab22f32016155f7f403e7178767163d7d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a> <a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_DEFAULT , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;HTTP POST support&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, .reload = reload, }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00494">494</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

</div>
</div>
<a class="anchor" id="ae25b9f3970870610911f8850897e8ead"></a><!-- doxytag: member="res_http_post.c::ast_module_info" ref="ae25b9f3970870610911f8850897e8ead" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a>* <a class="el" href="structast__module__info.html">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00494">494</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

</div>
</div>
<a class="anchor" id="a6f25bc812d09fedb86bf394c01061c56"></a><!-- doxytag: member="res_http_post.c::prefix" ref="a6f25bc812d09fedb86bf394c01061c56" args="[MAX_PREFIX]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__http__post_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>[MAX_PREFIX]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__http__post_8c_source.html#l00062">62</a> of file <a class="el" href="res__http__post_8c_source.html">res_http_post.c</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:23:13 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
