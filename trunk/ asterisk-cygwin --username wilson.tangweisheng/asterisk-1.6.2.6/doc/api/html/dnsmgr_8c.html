<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:21:59 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>dnsmgr.c File Reference</h1>
<p>Background DNS update manager.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="__private_8h_source.html">asterisk/_private.h</a>&quot;</code><br/>
<code>#include &lt;regex.h&gt;</code><br/>
<code>#include &lt;signal.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="dnsmgr_8h_source.html">asterisk/dnsmgr.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="linkedlists_8h_source.html">asterisk/linkedlists.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="config_8h_source.html">asterisk/config.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="sched_8h_source.html">asterisk/sched.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cli_8h_source.html">asterisk/cli.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="manager_8h_source.html">asterisk/manager.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="acl_8h_source.html">asterisk/acl.h</a>&quot;</code><br/>

<p><a href="dnsmgr_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structentry__list.html">entry_list</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structrefresh__info.html">refresh_info</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a4eac7b6f80c0e093ae0517ecc49ae7ef">REFRESH_DEFAULT</a>&nbsp;&nbsp;&nbsp;300</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#ad43ae5f58db3498b5b1830bd98677117">ast_dnsmgr_changed</a> (struct <a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *entry)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check is see if a dnsmgr entry has changed.  <a href="#ad43ae5f58db3498b5b1830bd98677117"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a984d70d01632590958b00f14e33962bb">ast_dnsmgr_get</a> (const char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, struct sockaddr_in *result, const char *<a class="el" href="adsistub_8c.html#ad61354ac038c6aaed26fded971a8843b">service</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Allocate a new DNS manager entry.  <a href="#a984d70d01632590958b00f14e33962bb"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a281a512e7dbfb3ca5875c1a4d08ac0d6">ast_dnsmgr_lookup</a> (const char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, struct sockaddr_in *result, struct <a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> **dnsmgr, const char *<a class="el" href="adsistub_8c.html#ad61354ac038c6aaed26fded971a8843b">service</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Allocate and initialize a DNS manager entry.  <a href="#a281a512e7dbfb3ca5875c1a4d08ac0d6"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#add74c87320b8447b69e776931520e994">ast_dnsmgr_refresh</a> (struct <a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *entry)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Force a refresh of a dnsmgr entry.  <a href="#add74c87320b8447b69e776931520e994"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a0255399a507b71ae563fc2caf94d749c">ast_dnsmgr_release</a> (struct <a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *entry)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Free a DNS manager entry.  <a href="#a0255399a507b71ae563fc2caf94d749c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#abc95730f7f0f9420f52e56e525056e6c">dnsmgr_init</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#afd4006993b0aac1410d7255730bc3a7c">dnsmgr_refresh</a> (struct <a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *entry, int verbose)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a0eae193f3c757d3cd34ed238b8860ebf">dnsmgr_reload</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a0ede7ff922fb2764dfd455e49dc59bc8">dnsmgr_start_refresh</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#acea7f3ec33ca5aef5c8e8c532b313976">do_refresh</a> (void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#adeaf0f7f80508d4b4bfd37c5cda21b97">do_reload</a> (int loading)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#af4a10fc6c4154180877b09818f5f9b76">handle_cli_refresh</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#abed484dae5cb5531660b1f571985cb6a">handle_cli_reload</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a42f51bfd026479da84c974d890c5c673">handle_cli_status</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a7f623757756f349de3f28480aeb8b7a6">refresh_list</a> (const void *data)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#aa331d52ef44f75eebbe4068a001099ba">cli_refresh</a> = AST_CLI_DEFINE(handle_cli_refresh, &quot;Performs an <a class="el" href="chan__mgcp_8c.html#ad380fd38219b013f5a77dfd26147ddfa">immediate</a> refresh&quot;)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#ab5b66ed9cfa2ea543e90ed13a4320817">cli_reload</a> = AST_CLI_DEFINE(handle_cli_reload, &quot;Reloads the DNS manager configuration&quot;)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a2bfbc88e2118d426be7b9ed59d6cf14f">cli_status</a> = AST_CLI_DEFINE(handle_cli_status, &quot;Display the DNS manager <a class="el" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>&quot;)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structrefresh__info.html">refresh_info</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a809d1040a29742820a4989d585349d5b">master_refresh_info</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a09442e9709a069712484f11df9470c53">refresh_interval</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static <a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a46c89517bfb41f8528974cfb7e18fa22">refresh_lock</a> = ((<a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>) PTHREAD_MUTEX_INITIALIZER )</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a9896125bdd6cb3d2605cbb261b4228ea">refresh_sched</a> = -1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static pthread_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#a8c64083a818c7f079198f34c0ef05aef">refresh_thread</a> = AST_PTHREADT_NULL</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dnsmgr_8c.html#aea6233539fc73fc5303bf7525ec27e73">sched</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Background DNS update manager. </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Kevin P. Fleming &lt;<a href="mailto:kpfleming@digium.com">kpfleming@digium.com</a>&gt;</dd></dl>
<dl class="bug"><dt><b><a class="el" href="bug.html#_bug000003">Bug:</a></b></dt><dd>There is a minor race condition. In the event that an IP address of a dnsmgr managed host changes, there is the potential for the consumer of that address to access the in_addr data at the same time that the dnsmgr thread is in the middle of updating it to the new address. </dd></dl>

<p>Definition in file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a4eac7b6f80c0e093ae0517ecc49ae7ef"></a><!-- doxytag: member="dnsmgr.c::REFRESH_DEFAULT" ref="a4eac7b6f80c0e093ae0517ecc49ae7ef" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define REFRESH_DEFAULT&nbsp;&nbsp;&nbsp;300</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00071">71</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>Referenced by <a class="el" href="dnsmgr_8c_source.html#l00367">do_reload()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ad43ae5f58db3498b5b1830bd98677117"></a><!-- doxytag: member="dnsmgr.c::ast_dnsmgr_changed" ref="ad43ae5f58db3498b5b1830bd98677117" args="(struct ast_dnsmgr_entry *entry)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_dnsmgr_changed </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>entry</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check is see if a dnsmgr entry has changed. </p>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>non-zero</em>&nbsp;</td><td>if the dnsmgr entry has changed since the last call to this function </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>if the dnsmgr entry has not changed since the last call to this function </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00191">191</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="dnsmgr_8c_source.html#l00060">ast_dnsmgr_entry::changed</a>, and <a class="el" href="dnsmgr_8c_source.html#l00061">ast_dnsmgr_entry::lock</a>.</p>

<p>Referenced by <a class="el" href="chan__iax2_8c_source.html#l11265">iax2_do_register()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00192"></a>00192 {
<a name="l00193"></a>00193    <span class="keywordtype">int</span> changed;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197    changed = entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#af28d4213d4bda49ab19d2451ec6da277">changed</a>;
<a name="l00198"></a>00198    entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#af28d4213d4bda49ab19d2451ec6da277">changed</a> = 0;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00201"></a>00201    
<a name="l00202"></a>00202    <span class="keywordflow">return</span> changed;
<a name="l00203"></a>00203 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a984d70d01632590958b00f14e33962bb"></a><!-- doxytag: member="dnsmgr.c::ast_dnsmgr_get" ref="a984d70d01632590958b00f14e33962bb" args="(const char *name, struct sockaddr_in *result, const char *service)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a>* ast_dnsmgr_get </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct sockaddr_in *&nbsp;</td>
          <td class="paramname"> <em>result</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>service</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Allocate a new DNS manager entry. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>name</em>&nbsp;</td><td>the hostname </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>result</em>&nbsp;</td><td>where the DNS manager should store the IP address as it refreshes it. it.</td></tr>
  </table>
  </dd>
</dl>
<p>This function allocates a new DNS manager entry object, and fills it with the provided hostname and IP address. This function does not force an initial lookup of the IP address. So, generally, this should be used when the initial address is already known.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>a DNS manager entry </dd></dl>
<dl class="version"><dt><b>Version:</b></dt><dd>1.6.1 result changed from struct in_addr to struct sockaddr_in to store port <a class="el" href="structnumber.html" title="Number structure.">number</a> </dd></dl>

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00088">88</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="lock_8h_source.html#l01692">ast_mutex_init()</a>, <a class="el" href="linkedlists_8h_source.html#l00702">AST_RWLIST_INSERT_HEAD</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="dnsmgr_8c_source.html#l00056">ast_dnsmgr_entry::last</a>, <a class="el" href="dnsmgr_8c_source.html#l00061">ast_dnsmgr_entry::lock</a>, <a class="el" href="dnsmgr_8c_source.html#l00064">ast_dnsmgr_entry::name</a>, <a class="el" href="dnsmgr_8c_source.html#l00054">ast_dnsmgr_entry::result</a>, and <a class="el" href="dnsmgr_8c_source.html#l00058">ast_dnsmgr_entry::service</a>.</p>

<p>Referenced by <a class="el" href="dnsmgr_8c_source.html#l00126">ast_dnsmgr_lookup()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00089"></a>00089 {
<a name="l00090"></a>00090    <span class="keyword">struct </span><a class="code" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *entry;
<a name="l00091"></a>00091    <span class="keywordtype">int</span> total_size = <span class="keyword">sizeof</span>(*entry) + strlen(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>) + (<a class="code" href="adsistub_8c.html#ad61354ac038c6aaed26fded971a8843b">service</a> ? strlen(<a class="code" href="adsistub_8c.html#ad61354ac038c6aaed26fded971a8843b">service</a>) + 1 : 0);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093    <span class="keywordflow">if</span> (!<a class="code" href="structast__dnsmgr__entry.html#a7eeb286de7c2b82381f8d0ffbc910d64">result</a> || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>) || !(entry = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, total_size)))
<a name="l00094"></a>00094       <span class="keywordflow">return</span> NULL;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096    entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#a7eeb286de7c2b82381f8d0ffbc910d64">result</a> = <a class="code" href="structast__dnsmgr__entry.html#a7eeb286de7c2b82381f8d0ffbc910d64">result</a>;
<a name="l00097"></a>00097    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00098"></a>00098    strcpy(entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#ac8b44a387cf3da062c4a32316b43962c">name</a>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00099"></a>00099    memcpy(&amp;entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#a8f560e4877f6a2c9fb75a68df1b0c2e6">last</a>, <a class="code" href="structast__dnsmgr__entry.html#a7eeb286de7c2b82381f8d0ffbc910d64">result</a>, <span class="keyword">sizeof</span>(entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#a8f560e4877f6a2c9fb75a68df1b0c2e6">last</a>));
<a name="l00100"></a>00100    <span class="keywordflow">if</span> (<a class="code" href="adsistub_8c.html#ad61354ac038c6aaed26fded971a8843b">service</a>) {
<a name="l00101"></a>00101       entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#a95c05b2a02d1d31907fde00f0051aed2">service</a> = ((<span class="keywordtype">char</span> *) entry) + <span class="keyword">sizeof</span>(*entry) + strlen(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00102"></a>00102       strcpy(entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#a95c05b2a02d1d31907fde00f0051aed2">service</a>, <a class="code" href="adsistub_8c.html#ad61354ac038c6aaed26fded971a8843b">service</a>);
<a name="l00103"></a>00103    }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structentry__list.html">entry_list</a>);
<a name="l00106"></a>00106    <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;<a class="code" href="structentry__list.html">entry_list</a>, entry, <a class="code" href="structast__dnsmgr__entry.html#aae38607f9c0c85769368645b604157a0">list</a>);
<a name="l00107"></a>00107    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structentry__list.html">entry_list</a>);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109    <span class="keywordflow">return</span> entry;
<a name="l00110"></a>00110 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a281a512e7dbfb3ca5875c1a4d08ac0d6"></a><!-- doxytag: member="dnsmgr.c::ast_dnsmgr_lookup" ref="a281a512e7dbfb3ca5875c1a4d08ac0d6" args="(const char *name, struct sockaddr_in *result, struct ast_dnsmgr_entry **dnsmgr, const char *service)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_dnsmgr_lookup </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct sockaddr_in *&nbsp;</td>
          <td class="paramname"> <em>result</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> **&nbsp;</td>
          <td class="paramname"> <em>dnsmgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>service</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Allocate and initialize a DNS manager entry. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>name</em>&nbsp;</td><td>the hostname </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>result</em>&nbsp;</td><td>where to store the IP address as the DNS manager refreshes it </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dnsmgr</em>&nbsp;</td><td>Where to store the allocate DNS manager entry</td></tr>
  </table>
  </dd>
</dl>
<p>This function allocates a new DNS manager entry object, and fills it with the provided hostname and IP address. This function _does_ force an initial lookup, so it may block for some period of time.</p>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>non-zero</em>&nbsp;</td><td>failure </td></tr>
  </table>
  </dd>
</dl>
<dl class="version"><dt><b>Version:</b></dt><dd>1.6.1 result changed from struct in_addr to struct aockaddr_in to store port <a class="el" href="structnumber.html" title="Number structure.">number</a> </dd></dl>

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00126">126</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="dnsmgr_8c_source.html#l00088">ast_dnsmgr_get()</a>, <a class="el" href="acl_8c_source.html#l00375">ast_get_ip_or_srv()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, and <a class="el" href="cdr_8c_source.html#l00086">enabled</a>.</p>

<p>Referenced by <a class="el" href="chan__sip_8c_source.html#l10966">__sip_subscribe_mwi_do()</a>, <a class="el" href="chan__iax2_8c_source.html#l11880">build_peer()</a>, <a class="el" href="chan__iax2_8c_source.html#l08150">iax2_append_register()</a>, and <a class="el" href="chan__sip_8c_source.html#l11545">transmit_register()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00127"></a>00127 {
<a name="l00128"></a>00128    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>) || !<a class="code" href="structast__dnsmgr__entry.html#a7eeb286de7c2b82381f8d0ffbc910d64">result</a> || !dnsmgr)
<a name="l00129"></a>00129       <span class="keywordflow">return</span> -1;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131    <span class="keywordflow">if</span> (*dnsmgr &amp;&amp; !strcasecmp((*dnsmgr)-&gt;name, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>))
<a name="l00132"></a>00132       <span class="keywordflow">return</span> 0;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134    <span class="comment">/* if it&apos;s actually an IP address and not a name,</span>
<a name="l00135"></a>00135 <span class="comment">      there&apos;s no need for a managed lookup */</span>
<a name="l00136"></a>00136    <span class="keywordflow">if</span> (inet_aton(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, &amp;<a class="code" href="structast__dnsmgr__entry.html#a7eeb286de7c2b82381f8d0ffbc910d64">result</a>-&gt;sin_addr))
<a name="l00137"></a>00137       <span class="keywordflow">return</span> 0;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;doing dnsmgr_lookup for &apos;%s&apos;\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141    <span class="comment">/* do a lookup now but add a manager so it will automagically get updated in the background */</span>
<a name="l00142"></a>00142    <a class="code" href="acl_8h.html#afab7a25fb37c7e1a0dedef9c286a44a1">ast_get_ip_or_srv</a>(<a class="code" href="structast__dnsmgr__entry.html#a7eeb286de7c2b82381f8d0ffbc910d64">result</a>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <a class="code" href="adsistub_8c.html#ad61354ac038c6aaed26fded971a8843b">service</a>);
<a name="l00143"></a>00143    
<a name="l00144"></a>00144    <span class="comment">/* if dnsmgr is not enable don&apos;t bother adding an entry */</span>
<a name="l00145"></a>00145    <span class="keywordflow">if</span> (!<a class="code" href="cdr_8c.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a>)
<a name="l00146"></a>00146       <span class="keywordflow">return</span> 0;
<a name="l00147"></a>00147    
<a name="l00148"></a>00148    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;adding dns manager for &apos;%s&apos;\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00149"></a>00149    *dnsmgr = <a class="code" href="dnsmgr_8h.html#a984d70d01632590958b00f14e33962bb" title="Allocate a new DNS manager entry.">ast_dnsmgr_get</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <a class="code" href="structast__dnsmgr__entry.html#a7eeb286de7c2b82381f8d0ffbc910d64">result</a>, <a class="code" href="adsistub_8c.html#ad61354ac038c6aaed26fded971a8843b">service</a>);
<a name="l00150"></a>00150    <span class="keywordflow">return</span> !*dnsmgr;
<a name="l00151"></a>00151 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="add74c87320b8447b69e776931520e994"></a><!-- doxytag: member="dnsmgr.c::ast_dnsmgr_refresh" ref="add74c87320b8447b69e776931520e994" args="(struct ast_dnsmgr_entry *entry)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_dnsmgr_refresh </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>entry</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Force a refresh of a dnsmgr entry. </p>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>non-zero</em>&nbsp;</td><td>if the result is different than the previous result </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>if the result is the same as the previous result </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00183">183</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="dnsmgr_8c_source.html#l00156">dnsmgr_refresh()</a>.</p>

<p>Referenced by <a class="el" href="chan__iax2_8c_source.html#l11265">iax2_do_register()</a>, and <a class="el" href="chan__sip_8c_source.html#l11487">sip_reg_timeout()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00184"></a>00184 {
<a name="l00185"></a>00185    <span class="keywordflow">return</span> <a class="code" href="dnsmgr_8c.html#afd4006993b0aac1410d7255730bc3a7c">dnsmgr_refresh</a>(entry, 0);
<a name="l00186"></a>00186 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0255399a507b71ae563fc2caf94d749c"></a><!-- doxytag: member="dnsmgr.c::ast_dnsmgr_release" ref="a0255399a507b71ae563fc2caf94d749c" args="(struct ast_dnsmgr_entry *entry)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_dnsmgr_release </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>entry</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Free a DNS manager entry. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>entry</em>&nbsp;</td><td>the DNS manager entry to free</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>nothing </dd></dl>

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00112">112</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="lock_8h_source.html#l01712">ast_mutex_destroy()</a>, <a class="el" href="linkedlists_8h_source.html#l00860">AST_RWLIST_REMOVE</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="dnsmgr_8c_source.html#l00061">ast_dnsmgr_entry::lock</a>, and <a class="el" href="dnsmgr_8c_source.html#l00064">ast_dnsmgr_entry::name</a>.</p>

<p>Referenced by <a class="el" href="chan__iax2_8c_source.html#l12414">delete_users()</a>, <a class="el" href="chan__iax2_8c_source.html#l11855">peer_destructor()</a>, <a class="el" href="chan__sip_8c_source.html#l04649">sip_destroy_peer()</a>, <a class="el" href="chan__sip_8c_source.html#l05460">sip_registry_destroy()</a>, and <a class="el" href="chan__sip_8c_source.html#l05484">sip_subscribe_mwi_destroy()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00113"></a>00113 {
<a name="l00114"></a>00114    <span class="keywordflow">if</span> (!entry)
<a name="l00115"></a>00115       <span class="keywordflow">return</span>;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structentry__list.html">entry_list</a>);
<a name="l00118"></a>00118    <a class="code" href="linkedlists_8h.html#a6091f0518f8b6f443fd9f5150f3ac407">AST_RWLIST_REMOVE</a>(&amp;<a class="code" href="structentry__list.html">entry_list</a>, entry, <a class="code" href="structast__dnsmgr__entry.html#aae38607f9c0c85769368645b604157a0">list</a>);
<a name="l00119"></a>00119    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structentry__list.html">entry_list</a>);
<a name="l00120"></a>00120    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;removing dns manager for &apos;%s&apos;\n&quot;</span>, entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#ac8b44a387cf3da062c4a32316b43962c">name</a>);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00123"></a>00123    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(entry);
<a name="l00124"></a>00124 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="abc95730f7f0f9420f52e56e525056e6c"></a><!-- doxytag: member="dnsmgr.c::dnsmgr_init" ref="abc95730f7f0f9420f52e56e525056e6c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int dnsmgr_init </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Provided by <a class="el" href="dnsmgr_8c.html" title="Background DNS update manager.">dnsmgr.c</a> </p>

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00350">350</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="cli_8c_source.html#l01919">ast_cli_register()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="dnsmgr_8c_source.html#l00347">cli_refresh</a>, <a class="el" href="dnsmgr_8c_source.html#l00346">cli_reload</a>, <a class="el" href="dnsmgr_8c_source.html#l00348">cli_status</a>, <a class="el" href="dnsmgr_8c_source.html#l00367">do_reload()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="sched_8c_source.html#l00239">sched_context_create()</a>.</p>

<p>Referenced by <a class="el" href="asterisk_8c_source.html#l03095">main()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00351"></a>00351 {
<a name="l00352"></a>00352    <span class="keywordflow">if</span> (!(<a class="code" href="structsched.html">sched</a> = <a class="code" href="sched_8h.html#ad4fd5c63d5d3dcc8e11bec644c601017" title="New schedule context.">sched_context_create</a>())) {
<a name="l00353"></a>00353       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create schedule context.\n&quot;</span>);
<a name="l00354"></a>00354       <span class="keywordflow">return</span> -1;
<a name="l00355"></a>00355    }
<a name="l00356"></a>00356    <a class="code" href="cli_8h.html#a0ca7e108aceb1cd488bb9e3ee26e4ebc" title="Registers a command or an array of commands.">ast_cli_register</a>(&amp;<a class="code" href="dnsmgr_8c.html#ab5b66ed9cfa2ea543e90ed13a4320817">cli_reload</a>);
<a name="l00357"></a>00357    <a class="code" href="cli_8h.html#a0ca7e108aceb1cd488bb9e3ee26e4ebc" title="Registers a command or an array of commands.">ast_cli_register</a>(&amp;<a class="code" href="dnsmgr_8c.html#a2bfbc88e2118d426be7b9ed59d6cf14f">cli_status</a>);
<a name="l00358"></a>00358    <a class="code" href="cli_8h.html#a0ca7e108aceb1cd488bb9e3ee26e4ebc" title="Registers a command or an array of commands.">ast_cli_register</a>(&amp;<a class="code" href="dnsmgr_8c.html#aa331d52ef44f75eebbe4068a001099ba">cli_refresh</a>);
<a name="l00359"></a>00359    <span class="keywordflow">return</span> <a class="code" href="dnsmgr_8c.html#adeaf0f7f80508d4b4bfd37c5cda21b97">do_reload</a>(1);
<a name="l00360"></a>00360 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="afd4006993b0aac1410d7255730bc3a7c"></a><!-- doxytag: member="dnsmgr.c::dnsmgr_refresh" ref="afd4006993b0aac1410d7255730bc3a7c" args="(struct ast_dnsmgr_entry *entry, int verbose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int dnsmgr_refresh </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>entry</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>verbose</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00156">156</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="acl_8c_source.html#l00375">ast_get_ip_or_srv()</a>, <a class="el" href="utils_8c_source.html#l00431">ast_inet_ntoa()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="dnsmgr_8c_source.html#l00060">ast_dnsmgr_entry::changed</a>, <a class="el" href="network_8h_source.html#l00090">inaddrcmp()</a>, <a class="el" href="dnsmgr_8c_source.html#l00056">ast_dnsmgr_entry::last</a>, <a class="el" href="dnsmgr_8c_source.html#l00061">ast_dnsmgr_entry::lock</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="dnsmgr_8c_source.html#l00064">ast_dnsmgr_entry::name</a>, <a class="el" href="dnsmgr_8c_source.html#l00054">ast_dnsmgr_entry::result</a>, and <a class="el" href="dnsmgr_8c_source.html#l00058">ast_dnsmgr_entry::service</a>.</p>

<p>Referenced by <a class="el" href="dnsmgr_8c_source.html#l00183">ast_dnsmgr_refresh()</a>, and <a class="el" href="dnsmgr_8c_source.html#l00216">refresh_list()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00157"></a>00157 {
<a name="l00158"></a>00158    <span class="keywordtype">char</span> iabuf[INET_ADDRSTRLEN];
<a name="l00159"></a>00159    <span class="keywordtype">char</span> iabuf2[INET_ADDRSTRLEN];
<a name="l00160"></a>00160    <span class="keyword">struct </span>sockaddr_in tmp;
<a name="l00161"></a>00161    <span class="keywordtype">int</span> changed = 0;
<a name="l00162"></a>00162         
<a name="l00163"></a>00163    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00164"></a>00164    <span class="keywordflow">if</span> (verbose)
<a name="l00165"></a>00165       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;refreshing &apos;%s&apos;\n&quot;</span>, entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#ac8b44a387cf3da062c4a32316b43962c">name</a>);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167    tmp.sin_port = entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#a8f560e4877f6a2c9fb75a68df1b0c2e6">last</a>.sin_port;
<a name="l00168"></a>00168    
<a name="l00169"></a>00169    <span class="keywordflow">if</span> (!<a class="code" href="acl_8h.html#afab7a25fb37c7e1a0dedef9c286a44a1">ast_get_ip_or_srv</a>(&amp;tmp, entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#ac8b44a387cf3da062c4a32316b43962c">name</a>, entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#a95c05b2a02d1d31907fde00f0051aed2">service</a>) &amp;&amp; <a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;tmp, &amp;entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#a8f560e4877f6a2c9fb75a68df1b0c2e6">last</a>)) {
<a name="l00170"></a>00170       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(iabuf, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#a8f560e4877f6a2c9fb75a68df1b0c2e6">last</a>.sin_addr), <span class="keyword">sizeof</span>(iabuf));
<a name="l00171"></a>00171       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(iabuf2, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(tmp.sin_addr), <span class="keyword">sizeof</span>(iabuf2));
<a name="l00172"></a>00172       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;dnssrv: host &apos;%s&apos; changed from %s:%d to %s:%d\n&quot;</span>, 
<a name="l00173"></a>00173          entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#ac8b44a387cf3da062c4a32316b43962c">name</a>, iabuf, ntohs(entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#a8f560e4877f6a2c9fb75a68df1b0c2e6">last</a>.sin_port), iabuf2, ntohs(tmp.sin_port));
<a name="l00174"></a>00174       *entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#a7eeb286de7c2b82381f8d0ffbc910d64">result</a> = tmp;
<a name="l00175"></a>00175       entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#a8f560e4877f6a2c9fb75a68df1b0c2e6">last</a> = tmp;
<a name="l00176"></a>00176       changed = entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#af28d4213d4bda49ab19d2451ec6da277">changed</a> = 1;
<a name="l00177"></a>00177    }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00180"></a>00180    <span class="keywordflow">return</span> changed;
<a name="l00181"></a>00181 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0eae193f3c757d3cd34ed238b8860ebf"></a><!-- doxytag: member="dnsmgr.c::dnsmgr_reload" ref="a0eae193f3c757d3cd34ed238b8860ebf" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int dnsmgr_reload </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Provided by <a class="el" href="dnsmgr_8c.html" title="Background DNS update manager.">dnsmgr.c</a> </p>

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00362">362</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="dnsmgr_8c_source.html#l00367">do_reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00363"></a>00363 {
<a name="l00364"></a>00364    <span class="keywordflow">return</span> <a class="code" href="dnsmgr_8c.html#adeaf0f7f80508d4b4bfd37c5cda21b97">do_reload</a>(0);
<a name="l00365"></a>00365 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0ede7ff922fb2764dfd455e49dc59bc8"></a><!-- doxytag: member="dnsmgr.c::dnsmgr_start_refresh" ref="a0ede7ff922fb2764dfd455e49dc59bc8" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void dnsmgr_start_refresh </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Provided by <a class="el" href="dnsmgr_8c.html" title="Background DNS update manager.">dnsmgr.c</a> </p>

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00244">244</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="sched_8c_source.html#l00399">ast_sched_add_variable()</a>, <a class="el" href="sched_8h_source.html#l00051">AST_SCHED_DEL</a>, <a class="el" href="dnsmgr_8c_source.html#l00083">master_refresh_info</a>, and <a class="el" href="dnsmgr_8c_source.html#l00216">refresh_list()</a>.</p>

<p>Referenced by <a class="el" href="asterisk_8c_source.html#l03095">main()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00245"></a>00245 {
<a name="l00246"></a>00246    <span class="keywordflow">if</span> (<a class="code" href="dnsmgr_8c.html#a9896125bdd6cb3d2605cbb261b4228ea">refresh_sched</a> &gt; -1) {
<a name="l00247"></a>00247       <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(<a class="code" href="structsched.html">sched</a>, <a class="code" href="dnsmgr_8c.html#a9896125bdd6cb3d2605cbb261b4228ea">refresh_sched</a>);
<a name="l00248"></a>00248       <a class="code" href="dnsmgr_8c.html#a9896125bdd6cb3d2605cbb261b4228ea">refresh_sched</a> = <a class="code" href="sched_8h.html#a5d738bcc3c3d38165a59a17a35f6ca2c" title="Schedule callback(data) to happen when ms into the future.">ast_sched_add_variable</a>(<a class="code" href="structsched.html">sched</a>, 100, <a class="code" href="dnsmgr_8c.html#a7f623757756f349de3f28480aeb8b7a6">refresh_list</a>, &amp;<a class="code" href="dnsmgr_8c.html#a809d1040a29742820a4989d585349d5b">master_refresh_info</a>, 1);
<a name="l00249"></a>00249    }
<a name="l00250"></a>00250 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="acea7f3ec33ca5aef5c8e8c532b313976"></a><!-- doxytag: member="dnsmgr.c::do_refresh" ref="acea7f3ec33ca5aef5c8e8c532b313976" args="(void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* do_refresh </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00205">205</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="sched_8c_source.html#l00581">ast_sched_runq()</a>, and <a class="el" href="sched_8c_source.html#l00327">ast_sched_wait()</a>.</p>

<p>Referenced by <a class="el" href="dnsmgr_8c_source.html#l00367">do_reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00206"></a>00206 {
<a name="l00207"></a>00207    <span class="keywordflow">for</span> (;;) {
<a name="l00208"></a>00208       pthread_testcancel();
<a name="l00209"></a>00209       usleep((<a class="code" href="sched_8h.html#a64797d66b6051095debfcdb7f790e605" title="Determines number of seconds until the next outstanding event to take place Determine...">ast_sched_wait</a>(<a class="code" href="structsched.html">sched</a>)*1000));
<a name="l00210"></a>00210       pthread_testcancel();
<a name="l00211"></a>00211       <a class="code" href="sched_8h.html#a2867b39106061847a8508bf49e38f420" title="Runs the queue.">ast_sched_runq</a>(<a class="code" href="structsched.html">sched</a>);
<a name="l00212"></a>00212    }
<a name="l00213"></a>00213    <span class="keywordflow">return</span> NULL;
<a name="l00214"></a>00214 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="adeaf0f7f80508d4b4bfd37c5cda21b97"></a><!-- doxytag: member="dnsmgr.c::do_reload" ref="adeaf0f7f80508d4b4bfd37c5cda21b97" args="(int loading)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int do_reload </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>loading</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00367">367</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="config_8c_source.html#l00827">ast_config_destroy()</a>, <a class="el" href="config_8c_source.html#l02071">ast_config_load2()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="utils_8h_source.html#l00384">ast_pthread_create_background</a>, <a class="el" href="lock_8h_source.html#l00082">AST_PTHREADT_NULL</a>, <a class="el" href="sched_8c_source.html#l00399">ast_sched_add_variable()</a>, <a class="el" href="sched_8h_source.html#l00051">AST_SCHED_DEL</a>, <a class="el" href="utils_8c_source.html#l01311">ast_true()</a>, <a class="el" href="config_8c_source.html#l00435">ast_variable_retrieve()</a>, <a class="el" href="cdr__csv_8c_source.html#l00054">config</a>, <a class="el" href="config_8h_source.html#l00043">CONFIG_FLAG_FILEUNCHANGED</a>, <a class="el" href="config_8h_source.html#l00050">CONFIG_STATUS_FILEINVALID</a>, <a class="el" href="config_8h_source.html#l00048">CONFIG_STATUS_FILEMISSING</a>, <a class="el" href="config_8h_source.html#l00049">CONFIG_STATUS_FILEUNCHANGED</a>, <a class="el" href="dnsmgr_8c_source.html#l00205">do_refresh()</a>, <a class="el" href="cdr_8c_source.html#l00086">enabled</a>, <a class="el" href="manager_8h_source.html#l00061">EVENT_FLAG_SYSTEM</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="manager_8h_source.html#l00181">manager_event</a>, <a class="el" href="dnsmgr_8c_source.html#l00083">master_refresh_info</a>, <a class="el" href="dnsmgr_8c_source.html#l00071">REFRESH_DEFAULT</a>, <a class="el" href="dnsmgr_8c_source.html#l00074">refresh_interval</a>, and <a class="el" href="dnsmgr_8c_source.html#l00216">refresh_list()</a>.</p>

<p>Referenced by <a class="el" href="dnsmgr_8c_source.html#l00350">dnsmgr_init()</a>, <a class="el" href="dnsmgr_8c_source.html#l00362">dnsmgr_reload()</a>, and <a class="el" href="dnsmgr_8c_source.html#l00254">handle_cli_reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00368"></a>00368 {
<a name="l00369"></a>00369    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>;
<a name="l00370"></a>00370    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="app__rpt_8c.html#a1f57f20c1f46890828791a4827fe8752">config_flags</a> = { loading ? 0 : <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> };
<a name="l00371"></a>00371    <span class="keyword">const</span> <span class="keywordtype">char</span> *interval_value;
<a name="l00372"></a>00372    <span class="keyword">const</span> <span class="keywordtype">char</span> *enabled_value;
<a name="l00373"></a>00373    <span class="keywordtype">int</span> interval;
<a name="l00374"></a>00374    <span class="keywordtype">int</span> was_enabled;
<a name="l00375"></a>00375    <span class="keywordtype">int</span> res = -1;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377    config = <a class="code" href="config_8h.html#aab3eac8fa82a86a93c074deb7b77dbc9" title="Load a config file.">ast_config_load2</a>(<span class="stringliteral">&quot;dnsmgr.conf&quot;</span>, <span class="stringliteral">&quot;dnsmgr&quot;</span>, config_flags);
<a name="l00378"></a>00378    <span class="keywordflow">if</span> (config == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || config == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a> || config == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l00379"></a>00379       <span class="keywordflow">return</span> 0;
<a name="l00380"></a>00380    }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382    <span class="comment">/* ensure that no refresh cycles run while the reload is in progress */</span>
<a name="l00383"></a>00383    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="dnsmgr_8c.html#a46c89517bfb41f8528974cfb7e18fa22">refresh_lock</a>);
<a name="l00384"></a>00384 
<a name="l00385"></a>00385    <span class="comment">/* reset defaults in preparation for reading config file */</span>
<a name="l00386"></a>00386    <a class="code" href="dnsmgr_8c.html#a09442e9709a069712484f11df9470c53">refresh_interval</a> = <a class="code" href="dnsmgr_8c.html#a4eac7b6f80c0e093ae0517ecc49ae7ef">REFRESH_DEFAULT</a>;
<a name="l00387"></a>00387    was_enabled = <a class="code" href="cdr_8c.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a>;
<a name="l00388"></a>00388    <a class="code" href="cdr_8c.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a> = 0;
<a name="l00389"></a>00389 
<a name="l00390"></a>00390    <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(<a class="code" href="structsched.html">sched</a>, <a class="code" href="dnsmgr_8c.html#a9896125bdd6cb3d2605cbb261b4228ea">refresh_sched</a>);
<a name="l00391"></a>00391 
<a name="l00392"></a>00392    <span class="keywordflow">if</span> (config) {
<a name="l00393"></a>00393       <span class="keywordflow">if</span> ((enabled_value = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(config, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;enable&quot;</span>))) {
<a name="l00394"></a>00394          <a class="code" href="cdr_8c.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(enabled_value);
<a name="l00395"></a>00395       }
<a name="l00396"></a>00396       <span class="keywordflow">if</span> ((interval_value = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(config, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;refreshinterval&quot;</span>))) {
<a name="l00397"></a>00397          <span class="keywordflow">if</span> (sscanf(interval_value, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;interval) &lt; 1)
<a name="l00398"></a>00398             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to convert &apos;%s&apos; to a numeric value.\n&quot;</span>, interval_value);
<a name="l00399"></a>00399          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (interval &lt; 0)
<a name="l00400"></a>00400             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid refresh interval &apos;%d&apos; specified, using default\n&quot;</span>, interval);
<a name="l00401"></a>00401          <span class="keywordflow">else</span>
<a name="l00402"></a>00402             <a class="code" href="dnsmgr_8c.html#a09442e9709a069712484f11df9470c53">refresh_interval</a> = interval;
<a name="l00403"></a>00403       }
<a name="l00404"></a>00404       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(config);
<a name="l00405"></a>00405    }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407    <span class="keywordflow">if</span> (<a class="code" href="cdr_8c.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a> &amp;&amp; <a class="code" href="dnsmgr_8c.html#a09442e9709a069712484f11df9470c53">refresh_interval</a>)
<a name="l00408"></a>00408       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Managed DNS entries will be refreshed every %d seconds.\n&quot;</span>, <a class="code" href="dnsmgr_8c.html#a09442e9709a069712484f11df9470c53">refresh_interval</a>);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410    <span class="comment">/* if this reload enabled the manager, create the background thread</span>
<a name="l00411"></a>00411 <span class="comment">      if it does not exist */</span>
<a name="l00412"></a>00412    <span class="keywordflow">if</span> (<a class="code" href="cdr_8c.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a>) {
<a name="l00413"></a>00413       <span class="keywordflow">if</span> (!was_enabled &amp;&amp; (<a class="code" href="dnsmgr_8c.html#a8c64083a818c7f079198f34c0ef05aef">refresh_thread</a> == <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>)) {
<a name="l00414"></a>00414          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;<a class="code" href="dnsmgr_8c.html#a8c64083a818c7f079198f34c0ef05aef">refresh_thread</a>, NULL, <a class="code" href="dnsmgr_8c.html#acea7f3ec33ca5aef5c8e8c532b313976">do_refresh</a>, NULL) &lt; 0) {
<a name="l00415"></a>00415             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to start refresh thread.\n&quot;</span>);
<a name="l00416"></a>00416          }
<a name="l00417"></a>00417       }
<a name="l00418"></a>00418       <span class="comment">/* make a background refresh happen right away */</span>
<a name="l00419"></a>00419       <a class="code" href="dnsmgr_8c.html#a9896125bdd6cb3d2605cbb261b4228ea">refresh_sched</a> = <a class="code" href="sched_8h.html#a5d738bcc3c3d38165a59a17a35f6ca2c" title="Schedule callback(data) to happen when ms into the future.">ast_sched_add_variable</a>(<a class="code" href="structsched.html">sched</a>, 100, <a class="code" href="dnsmgr_8c.html#a7f623757756f349de3f28480aeb8b7a6">refresh_list</a>, &amp;<a class="code" href="dnsmgr_8c.html#a809d1040a29742820a4989d585349d5b">master_refresh_info</a>, 1);
<a name="l00420"></a>00420       res = 0;
<a name="l00421"></a>00421    }
<a name="l00422"></a>00422    <span class="comment">/* if this reload disabled the manager and there is a background thread,</span>
<a name="l00423"></a>00423 <span class="comment">      kill it */</span>
<a name="l00424"></a>00424    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="cdr_8c.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a> &amp;&amp; was_enabled &amp;&amp; (<a class="code" href="dnsmgr_8c.html#a8c64083a818c7f079198f34c0ef05aef">refresh_thread</a> != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>)) {
<a name="l00425"></a>00425       <span class="comment">/* wake up the thread so it will exit */</span>
<a name="l00426"></a>00426       pthread_cancel(<a class="code" href="dnsmgr_8c.html#a8c64083a818c7f079198f34c0ef05aef">refresh_thread</a>);
<a name="l00427"></a>00427       pthread_kill(<a class="code" href="dnsmgr_8c.html#a8c64083a818c7f079198f34c0ef05aef">refresh_thread</a>, SIGURG);
<a name="l00428"></a>00428       pthread_join(<a class="code" href="dnsmgr_8c.html#a8c64083a818c7f079198f34c0ef05aef">refresh_thread</a>, NULL);
<a name="l00429"></a>00429       <a class="code" href="dnsmgr_8c.html#a8c64083a818c7f079198f34c0ef05aef">refresh_thread</a> = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l00430"></a>00430       res = 0;
<a name="l00431"></a>00431    }
<a name="l00432"></a>00432    <span class="keywordflow">else</span>
<a name="l00433"></a>00433       res = 0;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="dnsmgr_8c.html#a46c89517bfb41f8528974cfb7e18fa22">refresh_lock</a>);
<a name="l00436"></a>00436    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;Reload&quot;</span>, <span class="stringliteral">&quot;Module: DNSmgr\r\nStatus: %s\r/nMessage: DNSmgr reload Requested\r\n&quot;</span>, <a class="code" href="cdr_8c.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a> ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438    <span class="keywordflow">return</span> res;
<a name="l00439"></a>00439 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af4a10fc6c4154180877b09818f5f9b76"></a><!-- doxytag: member="dnsmgr.c::handle_cli_refresh" ref="af4a10fc6c4154180877b09818f5f9b76" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_cli_refresh </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00273">273</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8h_source.html#l00141">ast_cli_args::argv</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="cdr_8c_source.html#l00086">enabled</a>, <a class="el" href="dnsmgr_8c_source.html#l00077">refresh_info::entries</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="dnsmgr_8c_source.html#l00080">refresh_info::filter</a>, <a class="el" href="dnsmgr_8c_source.html#l00216">refresh_list()</a>, <a class="el" href="dnsmgr_8c_source.html#l00079">refresh_info::regex_present</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00274"></a>00274 {
<a name="l00275"></a>00275    <span class="keyword">struct </span><a class="code" href="structrefresh__info.html">refresh_info</a> info = {
<a name="l00276"></a>00276       .entries = &amp;<a class="code" href="structentry__list.html">entry_list</a>,
<a name="l00277"></a>00277       .verbose = 1,
<a name="l00278"></a>00278    };
<a name="l00279"></a>00279    <span class="keywordflow">switch</span> (cmd) {
<a name="l00280"></a>00280    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00281"></a>00281       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dnsmgr refresh&quot;</span>;
<a name="l00282"></a>00282       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l00283"></a>00283          <span class="stringliteral">&quot;Usage: dnsmgr refresh [pattern]\n&quot;</span>
<a name="l00284"></a>00284          <span class="stringliteral">&quot;       Peforms an immediate refresh of the managed DNS entries.\n&quot;</span>
<a name="l00285"></a>00285          <span class="stringliteral">&quot;       Optional regular expression pattern is used to filter the entries to refresh.\n&quot;</span>;
<a name="l00286"></a>00286       <span class="keywordflow">return</span> NULL;
<a name="l00287"></a>00287    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00288"></a>00288       <span class="keywordflow">return</span> NULL;   
<a name="l00289"></a>00289    }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291    <span class="keywordflow">if</span> (!<a class="code" href="cdr_8c.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a>) {
<a name="l00292"></a>00292       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;DNS Manager is disabled.\n&quot;</span>);
<a name="l00293"></a>00293       <span class="keywordflow">return</span> 0;
<a name="l00294"></a>00294    }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 3) {
<a name="l00297"></a>00297       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00298"></a>00298    }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3) {
<a name="l00301"></a>00301       <span class="keywordflow">if</span> (regcomp(&amp;info.<a class="code" href="structrefresh__info.html#a1ef66e7ee3c98b5d3c96c566c17f6d22">filter</a>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], REG_EXTENDED | REG_NOSUB)) {
<a name="l00302"></a>00302          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00303"></a>00303       } <span class="keywordflow">else</span> {
<a name="l00304"></a>00304          info.<a class="code" href="structrefresh__info.html#ad3eff95758537fb81e9e8b874b249516">regex_present</a> = 1;
<a name="l00305"></a>00305       }
<a name="l00306"></a>00306    }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308    <a class="code" href="dnsmgr_8c.html#a7f623757756f349de3f28480aeb8b7a6">refresh_list</a>(&amp;info);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310    <span class="keywordflow">if</span> (info.<a class="code" href="structrefresh__info.html#ad3eff95758537fb81e9e8b874b249516">regex_present</a>) {
<a name="l00311"></a>00311       regfree(&amp;info.<a class="code" href="structrefresh__info.html#a1ef66e7ee3c98b5d3c96c566c17f6d22">filter</a>);
<a name="l00312"></a>00312    }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00315"></a>00315 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="abed484dae5cb5531660b1f571985cb6a"></a><!-- doxytag: member="dnsmgr.c::handle_cli_reload" ref="abed484dae5cb5531660b1f571985cb6a" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_cli_reload </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00254">254</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="dnsmgr_8c_source.html#l00367">do_reload()</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00255"></a>00255 {
<a name="l00256"></a>00256    <span class="keywordflow">switch</span> (cmd) {
<a name="l00257"></a>00257    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00258"></a>00258       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dnsmgr reload&quot;</span>;
<a name="l00259"></a>00259       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l00260"></a>00260          <span class="stringliteral">&quot;Usage: dnsmgr reload\n&quot;</span>
<a name="l00261"></a>00261          <span class="stringliteral">&quot;       Reloads the DNS manager configuration.\n&quot;</span>;
<a name="l00262"></a>00262       <span class="keywordflow">return</span> NULL;
<a name="l00263"></a>00263    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00264"></a>00264       <span class="keywordflow">return</span> NULL;   
<a name="l00265"></a>00265    }
<a name="l00266"></a>00266    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 2)
<a name="l00267"></a>00267       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269    <a class="code" href="dnsmgr_8c.html#adeaf0f7f80508d4b4bfd37c5cda21b97">do_reload</a>(0);
<a name="l00270"></a>00270    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00271"></a>00271 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a42f51bfd026479da84c974d890c5c673"></a><!-- doxytag: member="dnsmgr.c::handle_cli_status" ref="a42f51bfd026479da84c974d890c5c673" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_cli_status </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00317">317</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="linkedlists_8h_source.html#l00077">AST_RWLIST_RDLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00493">AST_RWLIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="cdr_8c_source.html#l00086">enabled</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="dnsmgr_8c_source.html#l00074">refresh_interval</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00318"></a>00318 {
<a name="l00319"></a>00319    <span class="keywordtype">int</span> count = 0;
<a name="l00320"></a>00320    <span class="keyword">struct </span><a class="code" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *entry;
<a name="l00321"></a>00321    <span class="keywordflow">switch</span> (cmd) {
<a name="l00322"></a>00322    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00323"></a>00323       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dnsmgr status&quot;</span>;
<a name="l00324"></a>00324       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l00325"></a>00325          <span class="stringliteral">&quot;Usage: dnsmgr status\n&quot;</span>
<a name="l00326"></a>00326          <span class="stringliteral">&quot;       Displays the DNS manager status.\n&quot;</span>;
<a name="l00327"></a>00327       <span class="keywordflow">return</span> NULL;
<a name="l00328"></a>00328    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00329"></a>00329       <span class="keywordflow">return</span> NULL;   
<a name="l00330"></a>00330    }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 2)
<a name="l00333"></a>00333       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;DNS Manager: %s\n&quot;</span>, <a class="code" href="cdr_8c.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a> ? <span class="stringliteral">&quot;enabled&quot;</span> : <span class="stringliteral">&quot;disabled&quot;</span>);
<a name="l00336"></a>00336    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Refresh Interval: %d seconds\n&quot;</span>, <a class="code" href="dnsmgr_8c.html#a09442e9709a069712484f11df9470c53">refresh_interval</a>);
<a name="l00337"></a>00337    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structentry__list.html">entry_list</a>);
<a name="l00338"></a>00338    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structentry__list.html">entry_list</a>, entry, <a class="code" href="structast__dnsmgr__entry.html#aae38607f9c0c85769368645b604157a0">list</a>)
<a name="l00339"></a>00339       count++;
<a name="l00340"></a>00340    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structentry__list.html">entry_list</a>);
<a name="l00341"></a>00341    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;fd, &quot;Number of entries: %d\n&quot;, count);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343    return <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00344"></a>00344 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7f623757756f349de3f28480aeb8b7a6"></a><!-- doxytag: member="dnsmgr.c::refresh_list" ref="a7f623757756f349de3f28480aeb8b7a6" args="(const void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int refresh_list </td>
          <td>(</td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00216">216</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01722">ast_mutex_trylock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="linkedlists_8h_source.html#l00077">AST_RWLIST_RDLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00493">AST_RWLIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="dnsmgr_8c_source.html#l00156">dnsmgr_refresh()</a>, <a class="el" href="dnsmgr_8c_source.html#l00077">refresh_info::entries</a>, <a class="el" href="dnsmgr_8c_source.html#l00080">refresh_info::filter</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="dnsmgr_8c_source.html#l00064">ast_dnsmgr_entry::name</a>, <a class="el" href="dnsmgr_8c_source.html#l00074">refresh_interval</a>, <a class="el" href="dnsmgr_8c_source.html#l00079">refresh_info::regex_present</a>, and <a class="el" href="dnsmgr_8c_source.html#l00078">refresh_info::verbose</a>.</p>

<p>Referenced by <a class="el" href="dnsmgr_8c_source.html#l00244">dnsmgr_start_refresh()</a>, <a class="el" href="dnsmgr_8c_source.html#l00367">do_reload()</a>, and <a class="el" href="dnsmgr_8c_source.html#l00273">handle_cli_refresh()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00217"></a>00217 {
<a name="l00218"></a>00218    <span class="keyword">struct </span><a class="code" href="structrefresh__info.html">refresh_info</a> *info = (<span class="keyword">struct </span><a class="code" href="structrefresh__info.html">refresh_info</a> *)data;
<a name="l00219"></a>00219    <span class="keyword">struct </span><a class="code" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *entry;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221    <span class="comment">/* if a refresh or reload is already in progress, exit now */</span>
<a name="l00222"></a>00222    <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#a036ccafa2339f674a46bc269bbd48c5f">ast_mutex_trylock</a>(&amp;<a class="code" href="dnsmgr_8c.html#a46c89517bfb41f8528974cfb7e18fa22">refresh_lock</a>)) {
<a name="l00223"></a>00223       <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structrefresh__info.html#a0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>)
<a name="l00224"></a>00224          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;DNS Manager refresh already in progress.\n&quot;</span>);
<a name="l00225"></a>00225       <span class="keywordflow">return</span> -1;
<a name="l00226"></a>00226    }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Refreshing DNS lookups.\n&quot;</span>);
<a name="l00229"></a>00229    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(info-&gt;<a class="code" href="structrefresh__info.html#aa809bd76ac6f10f49321dd9600723b53">entries</a>);
<a name="l00230"></a>00230    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(info-&gt;<a class="code" href="structrefresh__info.html#aa809bd76ac6f10f49321dd9600723b53">entries</a>, entry, <a class="code" href="structast__dnsmgr__entry.html#aae38607f9c0c85769368645b604157a0">list</a>) {
<a name="l00231"></a>00231       <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structrefresh__info.html#ad3eff95758537fb81e9e8b874b249516">regex_present</a> &amp;&amp; regexec(&amp;info-&gt;<a class="code" href="structrefresh__info.html#a1ef66e7ee3c98b5d3c96c566c17f6d22">filter</a>, entry-&gt;<a class="code" href="structast__dnsmgr__entry.html#ac8b44a387cf3da062c4a32316b43962c">name</a>, 0, NULL, 0))
<a name="l00232"></a>00232           <span class="keywordflow">continue</span>;
<a name="l00233"></a>00233 
<a name="l00234"></a>00234       <a class="code" href="dnsmgr_8c.html#afd4006993b0aac1410d7255730bc3a7c">dnsmgr_refresh</a>(entry, info-&gt;<a class="code" href="structrefresh__info.html#a0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>);
<a name="l00235"></a>00235    }
<a name="l00236"></a>00236    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(info-&gt;<a class="code" href="structrefresh__info.html#aa809bd76ac6f10f49321dd9600723b53">entries</a>);
<a name="l00237"></a>00237 
<a name="l00238"></a>00238    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="dnsmgr_8c.html#a46c89517bfb41f8528974cfb7e18fa22">refresh_lock</a>);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240    <span class="comment">/* automatically reschedule based on the interval */</span>
<a name="l00241"></a>00241    <span class="keywordflow">return</span> <a class="code" href="dnsmgr_8c.html#a09442e9709a069712484f11df9470c53">refresh_interval</a> * 1000;
<a name="l00242"></a>00242 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="aa331d52ef44f75eebbe4068a001099ba"></a><!-- doxytag: member="dnsmgr.c::cli_refresh" ref="aa331d52ef44f75eebbe4068a001099ba" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> <a class="el" href="dnsmgr_8c.html#aa331d52ef44f75eebbe4068a001099ba">cli_refresh</a> = AST_CLI_DEFINE(handle_cli_refresh, &quot;Performs an <a class="el" href="chan__mgcp_8c.html#ad380fd38219b013f5a77dfd26147ddfa">immediate</a> refresh&quot;)<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00347">347</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>Referenced by <a class="el" href="dnsmgr_8c_source.html#l00350">dnsmgr_init()</a>.</p>

</div>
</div>
<a class="anchor" id="ab5b66ed9cfa2ea543e90ed13a4320817"></a><!-- doxytag: member="dnsmgr.c::cli_reload" ref="ab5b66ed9cfa2ea543e90ed13a4320817" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> <a class="el" href="dnsmgr_8c.html#ab5b66ed9cfa2ea543e90ed13a4320817">cli_reload</a> = AST_CLI_DEFINE(handle_cli_reload, &quot;Reloads the DNS manager configuration&quot;)<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00346">346</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>Referenced by <a class="el" href="dnsmgr_8c_source.html#l00350">dnsmgr_init()</a>.</p>

</div>
</div>
<a class="anchor" id="a2bfbc88e2118d426be7b9ed59d6cf14f"></a><!-- doxytag: member="dnsmgr.c::cli_status" ref="a2bfbc88e2118d426be7b9ed59d6cf14f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> <a class="el" href="res__config__sqlite_8c.html#a47b6b9c6ba9ec579e0cc93d497500db8">cli_status</a> = AST_CLI_DEFINE(handle_cli_status, &quot;Display the DNS manager <a class="el" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>&quot;)<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00348">348</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>Referenced by <a class="el" href="dnsmgr_8c_source.html#l00350">dnsmgr_init()</a>.</p>

</div>
</div>
<a class="anchor" id="a03e6cca0c879c0443efb431c30c14f76"></a><!-- doxytag: member="dnsmgr.c::enabled" ref="a03e6cca0c879c0443efb431c30c14f76" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="dnsmgr_8c.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00073">73</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

</div>
</div>
<a class="anchor" id="a809d1040a29742820a4989d585349d5b"></a><!-- doxytag: member="dnsmgr.c::master_refresh_info" ref="a809d1040a29742820a4989d585349d5b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structrefresh__info.html">refresh_info</a> <a class="el" href="dnsmgr_8c.html#a809d1040a29742820a4989d585349d5b">master_refresh_info</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
   .entries = &amp;<a class="code" href="structentry__list.html">entry_list</a>,
   .verbose = 0,
}
</pre></div>
<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00083">83</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>Referenced by <a class="el" href="dnsmgr_8c_source.html#l00244">dnsmgr_start_refresh()</a>, and <a class="el" href="dnsmgr_8c_source.html#l00367">do_reload()</a>.</p>

</div>
</div>
<a class="anchor" id="a09442e9709a069712484f11df9470c53"></a><!-- doxytag: member="dnsmgr.c::refresh_interval" ref="a09442e9709a069712484f11df9470c53" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="dnsmgr_8c.html#a09442e9709a069712484f11df9470c53">refresh_interval</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00074">74</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

<p>Referenced by <a class="el" href="dnsmgr_8c_source.html#l00367">do_reload()</a>, <a class="el" href="dnsmgr_8c_source.html#l00317">handle_cli_status()</a>, and <a class="el" href="dnsmgr_8c_source.html#l00216">refresh_list()</a>.</p>

</div>
</div>
<a class="anchor" id="a46c89517bfb41f8528974cfb7e18fa22"></a><!-- doxytag: member="dnsmgr.c::refresh_lock" ref="a46c89517bfb41f8528974cfb7e18fa22" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="el" href="dnsmgr_8c.html#a46c89517bfb41f8528974cfb7e18fa22">refresh_lock</a> = ((<a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>) PTHREAD_MUTEX_INITIALIZER )<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00069">69</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

</div>
</div>
<a class="anchor" id="a9896125bdd6cb3d2605cbb261b4228ea"></a><!-- doxytag: member="dnsmgr.c::refresh_sched" ref="a9896125bdd6cb3d2605cbb261b4228ea" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="dnsmgr_8c.html#a9896125bdd6cb3d2605cbb261b4228ea">refresh_sched</a> = -1<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00049">49</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

</div>
</div>
<a class="anchor" id="a8c64083a818c7f079198f34c0ef05aef"></a><!-- doxytag: member="dnsmgr.c::refresh_thread" ref="a8c64083a818c7f079198f34c0ef05aef" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">pthread_t <a class="el" href="dnsmgr_8c.html#a8c64083a818c7f079198f34c0ef05aef">refresh_thread</a> = AST_PTHREADT_NULL<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00050">50</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

</div>
</div>
<a class="anchor" id="aea6233539fc73fc5303bf7525ec27e73"></a><!-- doxytag: member="dnsmgr.c::sched" ref="aea6233539fc73fc5303bf7525ec27e73" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structsched__context.html">sched_context</a>* <a class="el" href="structsched.html">sched</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="dnsmgr_8c_source.html#l00048">48</a> of file <a class="el" href="dnsmgr_8c_source.html">dnsmgr.c</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:21:59 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
