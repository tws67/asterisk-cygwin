<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:46 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_318a70d4e812a718d9ecaeea98fff199.html">res</a>
  </div>
</div>
<div class="contents">
<h1>res_musiconhold.c</h1><a href="res__musiconhold_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Routines implementing music on hold</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \arg See also \ref Config_moh</span>
<a name="l00024"></a>00024 <span class="comment"> * </span>
<a name="l00025"></a>00025 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">/*** MODULEINFO</span>
<a name="l00029"></a>00029 <span class="comment">   &lt;conflict&gt;win32&lt;/conflict&gt;</span>
<a name="l00030"></a>00030 <span class="comment">   &lt;use&gt;dahdi&lt;/use&gt;</span>
<a name="l00031"></a>00031 <span class="comment"> ***/</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 240670 $&quot;</span>)
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;sys/signal.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#ifdef SOLARIS</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">#include &lt;thread.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#endif</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span>
<a name="l00049"></a>00049 <span class="preprocessor">#ifdef SOLARIS</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">#include &lt;thread.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#endif</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a>00053 <span class="preprocessor">#ifdef HAVE_DAHDI</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">#include &lt;dahdi/user.h&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#endif</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="translate_8h.html" title="Support for translation of data formats. translate.c.">asterisk/translate.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="say_8h.html" title="Say numbers and dates (maybe words one day too).">asterisk/say.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="musiconhold_8h.html" title="Music on hold handling.">asterisk/musiconhold.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="stringfields_8h.html" title="String fields in structures.">asterisk/stringfields.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="linkedlists_8h.html" title="A set of macros to manage forward-linked lists.">asterisk/linkedlists.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="paths_8h.html" title="Asterisk file paths, configured in asterisk.conf.">asterisk/paths.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="astobj2_8h.html">asterisk/astobj2.h</a>&quot;</span>
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="res__musiconhold_8c.html#a8677bd3f55d6db9157da91f3f556beeb">00075</a> <span class="preprocessor">#define INITIAL_NUM_FILES   8</span>
<a name="l00076"></a><a class="code" href="res__musiconhold_8c.html#a376adfa47c759987671a2909dbcacafd">00076</a> <span class="preprocessor"></span><span class="preprocessor">#define HANDLE_REF   1</span>
<a name="l00077"></a><a class="code" href="res__musiconhold_8c.html#af282bb73fa767a734878f6389f08cc2b">00077</a> <span class="preprocessor"></span><span class="preprocessor">#define DONT_UNREF   0</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>
<a name="l00079"></a><a class="code" href="res__musiconhold_8c.html#a04592ea728cb79d64ac23da8b0b08971">00079</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a04592ea728cb79d64ac23da8b0b08971">play_moh</a> = <span class="stringliteral">&quot;MusicOnHold&quot;</span>;
<a name="l00080"></a><a class="code" href="res__musiconhold_8c.html#a3c24fa4d5d94ec63de5757cdc9e97484">00080</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a3c24fa4d5d94ec63de5757cdc9e97484">wait_moh</a> = <span class="stringliteral">&quot;WaitMusicOnHold&quot;</span>;
<a name="l00081"></a><a class="code" href="res__musiconhold_8c.html#a0c41c089093dbdc7129b7ddcc19336bb">00081</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a0c41c089093dbdc7129b7ddcc19336bb">set_moh</a> = <span class="stringliteral">&quot;SetMusicOnHold&quot;</span>;
<a name="l00082"></a><a class="code" href="res__musiconhold_8c.html#ab347896d3066c085263098d7fc1e9a69">00082</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#ab347896d3066c085263098d7fc1e9a69">start_moh</a> = <span class="stringliteral">&quot;StartMusicOnHold&quot;</span>;
<a name="l00083"></a><a class="code" href="res__musiconhold_8c.html#a3461bee75891ea066a679539130eadfc">00083</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a3461bee75891ea066a679539130eadfc">stop_moh</a> = <span class="stringliteral">&quot;StopMusicOnHold&quot;</span>;
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="res__musiconhold_8c.html#a759939a445cf51a178d0ea84dcd01c8b">00085</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a759939a445cf51a178d0ea84dcd01c8b">play_moh_syn</a> = <span class="stringliteral">&quot;Play Music On Hold indefinitely&quot;</span>;
<a name="l00086"></a><a class="code" href="res__musiconhold_8c.html#a0efd256d6055d727976c6f6e2cf60165">00086</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a0efd256d6055d727976c6f6e2cf60165">wait_moh_syn</a> = <span class="stringliteral">&quot;Wait, playing Music On Hold&quot;</span>;
<a name="l00087"></a><a class="code" href="res__musiconhold_8c.html#a584b226dadeae071b66157141be90aef">00087</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a584b226dadeae071b66157141be90aef">set_moh_syn</a> = <span class="stringliteral">&quot;Set default Music On Hold class&quot;</span>;
<a name="l00088"></a><a class="code" href="res__musiconhold_8c.html#a860caad2c54dab0ce77de51c53e3f828">00088</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a860caad2c54dab0ce77de51c53e3f828">start_moh_syn</a> = <span class="stringliteral">&quot;Play Music On Hold&quot;</span>;
<a name="l00089"></a><a class="code" href="res__musiconhold_8c.html#a06465db5890277cea6ec8fd473ecabfd">00089</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a06465db5890277cea6ec8fd473ecabfd">stop_moh_syn</a> = <span class="stringliteral">&quot;Stop Playing Music On Hold&quot;</span>;
<a name="l00090"></a>00090 
<a name="l00091"></a><a class="code" href="res__musiconhold_8c.html#a4b067897b06a272b4c3998eee36effc6">00091</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a4b067897b06a272b4c3998eee36effc6">play_moh_desc</a> = <span class="stringliteral">&quot;  MusicOnHold(class[,duration]):\n&quot;</span>
<a name="l00092"></a>00092 <span class="stringliteral">&quot;Plays hold music specified by class.  If omitted, the default\n&quot;</span>
<a name="l00093"></a>00093 <span class="stringliteral">&quot;music source for the channel will be used. Change the default \n&quot;</span>
<a name="l00094"></a>00094 <span class="stringliteral">&quot;class with Set(CHANNEL(musicclass)=...).\n&quot;</span>
<a name="l00095"></a>00095 <span class="stringliteral">&quot;If duration is given, hold music will be played specified number\n&quot;</span>
<a name="l00096"></a>00096 <span class="stringliteral">&quot;of seconds. If duration is ommited, music plays indefinitely.\n&quot;</span>
<a name="l00097"></a>00097 <span class="stringliteral">&quot;Returns 0 when done, -1 on hangup.\n&quot;</span>;
<a name="l00098"></a>00098 
<a name="l00099"></a><a class="code" href="res__musiconhold_8c.html#a04bb25de1a18f3617d63056abe30ce2a">00099</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a04bb25de1a18f3617d63056abe30ce2a">wait_moh_desc</a> = <span class="stringliteral">&quot;  WaitMusicOnHold(delay):\n&quot;</span>
<a name="l00100"></a>00100 <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00101"></a>00101 <span class="stringliteral">&quot;  !!! DEPRECATED. Use MusicOnHold instead !!!\n&quot;</span>
<a name="l00102"></a>00102 <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00103"></a>00103 <span class="stringliteral">&quot;Plays hold music specified number of seconds.  Returns 0 when\n&quot;</span>
<a name="l00104"></a>00104 <span class="stringliteral">&quot;done, or -1 on hangup.  If no hold music is available, the delay will\n&quot;</span>
<a name="l00105"></a>00105 <span class="stringliteral">&quot;still occur with no sound.\n&quot;</span>
<a name="l00106"></a>00106 <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00107"></a>00107 <span class="stringliteral">&quot;  !!! DEPRECATED. Use MusicOnHold instead !!!\n&quot;</span>;
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="res__musiconhold_8c.html#a2213835328cf9da01bf7f43e3611e0de">00109</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a2213835328cf9da01bf7f43e3611e0de">set_moh_desc</a> = <span class="stringliteral">&quot;  SetMusicOnHold(class):\n&quot;</span>
<a name="l00110"></a>00110 <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00111"></a>00111 <span class="stringliteral">&quot;  !!! DEPRECATED. USe Set(CHANNEL(musicclass)=...) instead !!!\n&quot;</span>
<a name="l00112"></a>00112 <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00113"></a>00113 <span class="stringliteral">&quot;Sets the default class for music on hold for a given channel.  When\n&quot;</span>
<a name="l00114"></a>00114 <span class="stringliteral">&quot;music on hold is activated, this class will be used to select which\n&quot;</span>
<a name="l00115"></a>00115 <span class="stringliteral">&quot;music is played.\n&quot;</span>
<a name="l00116"></a>00116 <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00117"></a>00117 <span class="stringliteral">&quot;  !!! DEPRECATED. USe Set(CHANNEL(musicclass)=...) instead !!!\n&quot;</span>;
<a name="l00118"></a>00118 
<a name="l00119"></a><a class="code" href="res__musiconhold_8c.html#a3b67bab10152c5e9d6f0d1c44d8f5644">00119</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a3b67bab10152c5e9d6f0d1c44d8f5644">start_moh_desc</a> = <span class="stringliteral">&quot;  StartMusicOnHold(class):\n&quot;</span>
<a name="l00120"></a>00120 <span class="stringliteral">&quot;Starts playing music on hold, uses default music class for channel.\n&quot;</span>
<a name="l00121"></a>00121 <span class="stringliteral">&quot;Starts playing music specified by class.  If omitted, the default\n&quot;</span>
<a name="l00122"></a>00122 <span class="stringliteral">&quot;music source for the channel will be used.  Always returns 0.\n&quot;</span>;
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="res__musiconhold_8c.html#acaa24598ed52746a2319c7e32123d9e1">00124</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#acaa24598ed52746a2319c7e32123d9e1">stop_moh_desc</a> = <span class="stringliteral">&quot;  StopMusicOnHold(): &quot;</span>
<a name="l00125"></a>00125 <span class="stringliteral">&quot;Stops playing music on hold.\n&quot;</span>;
<a name="l00126"></a>00126 
<a name="l00127"></a><a class="code" href="res__musiconhold_8c.html#ae5eaf0102cfcdb1e7019b67812e9d729">00127</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#ae5eaf0102cfcdb1e7019b67812e9d729">respawn_time</a> = 20;
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="structmoh__files__state.html">00129</a> <span class="keyword">struct </span><a class="code" href="structmoh__files__state.html">moh_files_state</a> {
<a name="l00130"></a><a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">00130</a>    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class</span>;
<a name="l00131"></a><a class="code" href="structmoh__files__state.html#a1544f236ea071cf9a855b49a332f5c13">00131</a>    <span class="keywordtype">char</span> <a class="code" href="structmoh__files__state.html#a1544f236ea071cf9a855b49a332f5c13">name</a>[<a class="code" href="channel_8h.html#afb2ae2e53d6676f3ca44a98aa3f92a2c">MAX_MUSICCLASS</a>];
<a name="l00132"></a><a class="code" href="structmoh__files__state.html#a5ef8e42d1eab1890f7eeb29e4af357eb">00132</a>    <span class="keywordtype">int</span> <a class="code" href="structmoh__files__state.html#a5ef8e42d1eab1890f7eeb29e4af357eb">origwfmt</a>;
<a name="l00133"></a><a class="code" href="structmoh__files__state.html#a37672e6b906143604cefd3e959777b31">00133</a>    <span class="keywordtype">int</span> <a class="code" href="structmoh__files__state.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l00134"></a><a class="code" href="structmoh__files__state.html#ab45f20669bce21a6e7a16eff0fba0792">00134</a>    <span class="keywordtype">int</span> <a class="code" href="structmoh__files__state.html#ab45f20669bce21a6e7a16eff0fba0792">sample_queue</a>;
<a name="l00135"></a><a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">00135</a>    <span class="keywordtype">int</span> <a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a>;
<a name="l00136"></a><a class="code" href="structmoh__files__state.html#a6e3ea5b9afde5625ce286122ab8c3af4">00136</a>    <span class="keywordtype">int</span> <a class="code" href="structmoh__files__state.html#a6e3ea5b9afde5625ce286122ab8c3af4">save_pos</a>;
<a name="l00137"></a><a class="code" href="structmoh__files__state.html#ac89cb4e1a202cc332301c76d6c3eefb1">00137</a>    <span class="keywordtype">int</span> <a class="code" href="structmoh__files__state.html#ac89cb4e1a202cc332301c76d6c3eefb1">save_total</a>;
<a name="l00138"></a><a class="code" href="structmoh__files__state.html#a325fdaa3c6f64c09d0257b3b6ee5aec4">00138</a>    <span class="keywordtype">char</span> *<a class="code" href="structmoh__files__state.html#a325fdaa3c6f64c09d0257b3b6ee5aec4">save_pos_filename</a>;
<a name="l00139"></a>00139 };
<a name="l00140"></a>00140 
<a name="l00141"></a><a class="code" href="res__musiconhold_8c.html#a35d37162b1781f830c686da44c0c9a9d">00141</a> <span class="preprocessor">#define MOH_QUIET    (1 &lt;&lt; 0)</span>
<a name="l00142"></a><a class="code" href="res__musiconhold_8c.html#acb4a79e9b83147f8ab6a7ada46071740">00142</a> <span class="preprocessor"></span><span class="preprocessor">#define MOH_SINGLE      (1 &lt;&lt; 1)</span>
<a name="l00143"></a><a class="code" href="res__musiconhold_8c.html#a2eff543e703f0fb49f655f760312e291">00143</a> <span class="preprocessor"></span><span class="preprocessor">#define MOH_CUSTOM      (1 &lt;&lt; 2)</span>
<a name="l00144"></a><a class="code" href="res__musiconhold_8c.html#a47622ed8ba1100fc57a944cef6a485eb">00144</a> <span class="preprocessor"></span><span class="preprocessor">#define MOH_RANDOMIZE      (1 &lt;&lt; 3)</span>
<a name="l00145"></a><a class="code" href="res__musiconhold_8c.html#a81ae754573bd2c0d252b398313601fcf">00145</a> <span class="preprocessor"></span><span class="preprocessor">#define MOH_SORTALPHA      (1 &lt;&lt; 4)</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>
<a name="l00147"></a><a class="code" href="res__musiconhold_8c.html#a90367ee5bb64c9b16ce7e44731ec5f90">00147</a> <span class="preprocessor">#define MOH_CACHERTCLASSES      (1 &lt;&lt; 5)        </span><span class="comment">/*!&lt; Should we use a separate instance of MOH for each user or not */</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="comment">/* Custom astobj2 flag */</span>
<a name="l00150"></a><a class="code" href="res__musiconhold_8c.html#ad5d15309259ebc26964f94f4cbf11dae">00150</a> <span class="preprocessor">#define MOH_NOTDELETED          (1 &lt;&lt; 30)       </span><span class="comment">/*!&lt; Find only records that aren&apos;t deleted? */</span>
<a name="l00151"></a>00151 
<a name="l00152"></a><a class="code" href="res__musiconhold_8c.html#af222d606c20cb9edacaf2e4fae1b9150">00152</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="res__musiconhold_8c.html#af222d606c20cb9edacaf2e4fae1b9150">global_flags</a>[1] = {{0}};        <span class="comment">/*!&lt; global MOH_ flags */</span>
<a name="l00153"></a>00153 
<a name="l00154"></a><a class="code" href="structmohclass.html">00154</a> <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> {
<a name="l00155"></a><a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">00155</a>    <span class="keywordtype">char</span> <a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>[<a class="code" href="channel_8h.html#afb2ae2e53d6676f3ca44a98aa3f92a2c">MAX_MUSICCLASS</a>];
<a name="l00156"></a><a class="code" href="structmohclass.html#a4a55f3eac855c94cd30d3f16c3f83fb7">00156</a>    <span class="keywordtype">char</span> <a class="code" href="structmohclass.html#a4a55f3eac855c94cd30d3f16c3f83fb7">dir</a>[256];
<a name="l00157"></a><a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">00157</a>    <span class="keywordtype">char</span> <a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>[256];
<a name="l00158"></a><a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">00158</a>    <span class="keywordtype">char</span> <a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>[80];
<a name="l00159"></a><a class="code" href="structmohclass.html#ac2c887b7f7b359bfdda8a128980f5081">00159</a>    <span class="keywordtype">char</span> <a class="code" href="structmohclass.html#ac2c887b7f7b359bfdda8a128980f5081">digit</a>;<span class="comment"></span>
<a name="l00160"></a>00160 <span class="comment">   /*! A dynamically sized array to hold the list of filenames in &quot;files&quot; mode */</span>
<a name="l00161"></a><a class="code" href="structmohclass.html#a04b870a2b3aee9d3060c499d69630652">00161</a>    <span class="keywordtype">char</span> **<a class="code" href="structmohclass.html#a04b870a2b3aee9d3060c499d69630652">filearray</a>;<span class="comment"></span>
<a name="l00162"></a>00162 <span class="comment">   /*! The current size of the filearray */</span>
<a name="l00163"></a><a class="code" href="structmohclass.html#a635ce4dfc5bb8d5a73b5d610698c14a4">00163</a>    <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#a635ce4dfc5bb8d5a73b5d610698c14a4">allowed_files</a>;<span class="comment"></span>
<a name="l00164"></a>00164 <span class="comment">   /*! The current number of files loaded into the filearray */</span>
<a name="l00165"></a><a class="code" href="structmohclass.html#ac4bef3984b07b68ad586b3109e528f47">00165</a>    <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#ac4bef3984b07b68ad586b3109e528f47">total_files</a>;
<a name="l00166"></a><a class="code" href="structmohclass.html#ac92588540e8c1d014a08cd8a45462b19">00166</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>;<span class="comment"></span>
<a name="l00167"></a>00167 <span class="comment">   /*! The format from the MOH source, not applicable to &quot;files&quot; mode */</span>
<a name="l00168"></a><a class="code" href="structmohclass.html#a317afff57d87a89158c2b038d37b2b08">00168</a>    <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#a317afff57d87a89158c2b038d37b2b08">format</a>;<span class="comment"></span>
<a name="l00169"></a>00169 <span class="comment">   /*! The pid of the external application delivering MOH */</span>
<a name="l00170"></a><a class="code" href="structmohclass.html#af500917c052066b40cf47f96b43c607b">00170</a>    <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#af500917c052066b40cf47f96b43c607b">pid</a>;
<a name="l00171"></a><a class="code" href="structmohclass.html#ada310e7f72b38fadd4b24d80ed3438ee">00171</a>    time_t <a class="code" href="structmohclass.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;
<a name="l00172"></a><a class="code" href="structmohclass.html#a01f75a9ad916f63a94e06a27635ba278">00172</a>    pthread_t <a class="code" href="structmohclass.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>;<span class="comment"></span>
<a name="l00173"></a>00173 <span class="comment">   /*! Source of audio */</span>
<a name="l00174"></a><a class="code" href="structmohclass.html#af08b24ab237f0647a06f2f9dcdb36e82">00174</a>    <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#af08b24ab237f0647a06f2f9dcdb36e82">srcfd</a>;<span class="comment"></span>
<a name="l00175"></a>00175 <span class="comment">   /*! FD for timing source */</span>
<a name="l00176"></a><a class="code" href="structmohclass.html#aa6e23be0b421a7756d686b9ad6ef698a">00176</a>    <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#aa6e23be0b421a7756d686b9ad6ef698a">pseudofd</a>;<span class="comment"></span>
<a name="l00177"></a>00177 <span class="comment">   /*! Created on the fly, from RT engine */</span>
<a name="l00178"></a><a class="code" href="structmohclass.html#aac1ae37fa4007496a50df75cf1f698c1">00178</a>    <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#aac1ae37fa4007496a50df75cf1f698c1">realtime</a>;
<a name="l00179"></a><a class="code" href="structmohclass.html#a7ade7227ba7e8a7a6bd06f1d11bd9266">00179</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="keyword">delete</span>:1;
<a name="l00180"></a><a class="code" href="structmohclass.html#a758d951cc38f248a121c1d5a0e3dfdc9">00180</a>    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structmohdata.html">mohdata</a>) <a class="code" href="structmohclass.html#aff118ddddb0ad12a54ec5595f4662d09">members</a>;
<a name="l00181"></a><a class="code" href="structmohclass.html#ad60897f2b00a7fc93dd6ba3f7274131f">00181</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structmohclass.html">mohclass</a>) <a class="code" href="structmohclass.html#a18944752b68d592280e4c301185011fc">list</a>;
<a name="l00182"></a>00182 };
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="structmohdata.html">00184</a> struct <a class="code" href="structmohdata.html">mohdata</a> {
<a name="l00185"></a><a class="code" href="structmohdata.html#a67646b28a1d0efc1226de7291833b5ec">00185</a>    <span class="keywordtype">int</span> pipe[2];
<a name="l00186"></a><a class="code" href="structmohdata.html#a5ef8e42d1eab1890f7eeb29e4af357eb">00186</a>    <span class="keywordtype">int</span> origwfmt;
<a name="l00187"></a><a class="code" href="structmohdata.html#a1bd837db6069403d50229efd1848e2a3">00187</a>    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *parent;
<a name="l00188"></a><a class="code" href="structmohdata.html#a735f764b1095611ace084e7c6c06857d">00188</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> <a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00189"></a><a class="code" href="structmohdata.html#a39d98e5e4a1acb9c657b0b0993ace585">00189</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(mohdata) list;
<a name="l00190"></a>00190 };
<a name="l00191"></a>00191 
<a name="l00192"></a><a class="code" href="res__musiconhold_8c.html#a4785a3659ef2f92593e3fd270cf936e4">00192</a> static struct <a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="res__musiconhold_8c.html#a4785a3659ef2f92593e3fd270cf936e4">mohclasses</a>;
<a name="l00193"></a>00193 
<a name="l00194"></a><a class="code" href="res__musiconhold_8c.html#a81f956d8547e816f632929caf937662e">00194</a> <span class="preprocessor">#define LOCAL_MPG_123 &quot;/usr/local/bin/mpg123&quot;</span>
<a name="l00195"></a><a class="code" href="res__musiconhold_8c.html#a07f0c52e86a747f8e6ebff81bc88a527">00195</a> <span class="preprocessor"></span><span class="preprocessor">#define MPG_123 &quot;/usr/bin/mpg123&quot;</span>
<a name="l00196"></a><a class="code" href="res__musiconhold_8c.html#aa7f60ce1373c47d96ece41e57364bd35">00196</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_MP3S 256</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span>
<a name="l00198"></a>00198 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>);
<a name="l00199"></a>00199 
<a name="l00200"></a><a class="code" href="res__musiconhold_8c.html#a837adf51399825c74e2d96602756d68c">00200</a> <span class="preprocessor">#define mohclass_ref(class,string)   (ao2_t_ref((class), +1, (string)), class)</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span>
<a name="l00202"></a>00202 <span class="preprocessor">#ifndef REF_DEBUG</span>
<a name="l00203"></a><a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">00203</a> <span class="preprocessor"></span><span class="preprocessor">#define mohclass_unref(class,string) (ao2_t_ref((class), -1, (string)), (struct mohclass *) NULL)</span>
<a name="l00204"></a>00204 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span><span class="preprocessor">#define mohclass_unref(class,string) _mohclass_unref(class, string, __FILE__,__LINE__,__PRETTY_FUNCTION__)</span>
<a name="l00206"></a>00206 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *_mohclass_unref(<span class="keyword">struct</span> <a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *tag, <span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> line, <span class="keyword">const</span> <span class="keywordtype">char</span> *funcname)
<a name="l00207"></a>00207 {
<a name="l00208"></a>00208    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *dup;
<a name="l00209"></a>00209    <span class="keywordflow">if</span> ((dup = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(mohclasses, <span class="keyword">class</span>, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>))) {
<a name="l00210"></a>00210       <span class="keywordflow">if</span> (<a class="code" href="astobj2_8h.html#a8edbc54a8389a1d173305dd79af77873">_ao2_ref_debug</a>(dup, -1, (<span class="keywordtype">char</span> *) tag, (<span class="keywordtype">char</span> *) file, line, funcname) == 2) {
<a name="l00211"></a>00211          FILE *ref = fopen(<span class="stringliteral">&quot;/tmp/refs&quot;</span>, <span class="stringliteral">&quot;a&quot;</span>);
<a name="l00212"></a>00212          <span class="keywordflow">if</span> (ref) {
<a name="l00213"></a>00213             fprintf(ref, <span class="stringliteral">&quot;%p =1   %s:%d:%s (%s) BAD ATTEMPT!\n&quot;</span>, <span class="keyword">class</span>, file, line, funcname, tag);
<a name="l00214"></a>00214             fclose(ref);
<a name="l00215"></a>00215          }
<a name="l00216"></a>00216          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Attempt to unref mohclass %p (%s) when only 1 ref remained, and class is still in a container! (at %s:%d (%s))\n&quot;</span>,
<a name="l00217"></a>00217             <span class="keyword">class</span>, class-&gt;name, file, line, funcname);
<a name="l00218"></a>00218       } <span class="keywordflow">else</span> {
<a name="l00219"></a>00219          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(<span class="keyword">class</span>, -1);
<a name="l00220"></a>00220       }
<a name="l00221"></a>00221    } <span class="keywordflow">else</span> {
<a name="l00222"></a>00222       <a class="code" href="astobj2_8h.html#a14c61bcab109a520a96d30c56ba5fcde" title="Reference/unreference an object and return the old refcount.">ao2_t_ref</a>(<span class="keyword">class</span>, -1, (<span class="keywordtype">char</span> *) tag);
<a name="l00223"></a>00223    }
<a name="l00224"></a>00224    <span class="keywordflow">return</span> NULL;
<a name="l00225"></a>00225 }
<a name="l00226"></a>00226 <span class="preprocessor">#endif</span>
<a name="l00227"></a>00227 <span class="preprocessor"></span>
<a name="l00228"></a><a class="code" href="res__musiconhold_8c.html#a94a2a280b4beeffa8e35576bd3a46d09">00228</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__musiconhold_8c.html#a94a2a280b4beeffa8e35576bd3a46d09">moh_files_release</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00229"></a>00229 {
<a name="l00230"></a>00230    <span class="keyword">struct </span><a class="code" href="structmoh__files__state.html">moh_files_state</a> *<a class="code" href="structstate.html">state</a>;
<a name="l00231"></a>00231 
<a name="l00232"></a>00232    <span class="keywordflow">if</span> (!chan || !chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a>) {
<a name="l00233"></a>00233       <span class="keywordflow">return</span>;
<a name="l00234"></a>00234    }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236    state = chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a>;
<a name="l00237"></a>00237 
<a name="l00238"></a>00238    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>) {
<a name="l00239"></a>00239       <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>);
<a name="l00240"></a>00240       chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> = NULL;
<a name="l00241"></a>00241    }
<a name="l00242"></a>00242    
<a name="l00243"></a>00243    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">option_verbose</a> &gt; 2) {
<a name="l00244"></a>00244       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<a class="code" href="logger_8h.html#a24b0f46e22f4ea3226fa082e955dd4ef">VERBOSE_PREFIX_3</a> <span class="stringliteral">&quot;Stopped music on hold on %s\n&quot;</span>, chan-&gt;name);
<a name="l00245"></a>00245    }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247    <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structmoh__files__state.html#a5ef8e42d1eab1890f7eeb29e4af357eb">origwfmt</a> &amp;&amp; <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, state-&gt;<a class="code" href="structmoh__files__state.html#a5ef8e42d1eab1890f7eeb29e4af357eb">origwfmt</a>)) {
<a name="l00248"></a>00248       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to restore channel &apos;%s&apos; to format &apos;%d&apos;\n&quot;</span>, chan-&gt;name, state-&gt;<a class="code" href="structmoh__files__state.html#a5ef8e42d1eab1890f7eeb29e4af357eb">origwfmt</a>);
<a name="l00249"></a>00249    }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251    state-&gt;<a class="code" href="structmoh__files__state.html#a6e3ea5b9afde5625ce286122ab8c3af4">save_pos</a> = state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a>;
<a name="l00252"></a>00252 
<a name="l00253"></a>00253    state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a> = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>, <span class="stringliteral">&quot;Unreffing channel&apos;s music class upon deactivation of generator&quot;</span>);
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a><a class="code" href="res__musiconhold_8c.html#adcad3bce0f18dc8ef562c36db9fe370f">00256</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#adcad3bce0f18dc8ef562c36db9fe370f">ast_moh_files_next</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>) 
<a name="l00257"></a>00257 {
<a name="l00258"></a>00258    <span class="keyword">struct </span><a class="code" href="structmoh__files__state.html">moh_files_state</a> *<a class="code" href="structstate.html">state</a> = chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a>;
<a name="l00259"></a>00259    <span class="keywordtype">int</span> tries;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261    <span class="comment">/* Discontinue a stream if it is running already */</span>
<a name="l00262"></a>00262    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>) {
<a name="l00263"></a>00263       <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>);
<a name="l00264"></a>00264       chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> = NULL;
<a name="l00265"></a>00265    }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267    <span class="keywordflow">if</span> (!state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#ac4bef3984b07b68ad586b3109e528f47">total_files</a>) {
<a name="l00268"></a>00268       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No files available for class &apos;%s&apos;\n&quot;</span>, state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>);
<a name="l00269"></a>00269       <span class="keywordflow">return</span> -1;
<a name="l00270"></a>00270    }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272    <span class="comment">/* If a specific file has been saved confirm it still exists and that it is still valid */</span>
<a name="l00273"></a>00273    <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structmoh__files__state.html#a6e3ea5b9afde5625ce286122ab8c3af4">save_pos</a> &gt;= 0 &amp;&amp; state-&gt;<a class="code" href="structmoh__files__state.html#a6e3ea5b9afde5625ce286122ab8c3af4">save_pos</a> &lt; state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#ac4bef3984b07b68ad586b3109e528f47">total_files</a> &amp;&amp; state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a04b870a2b3aee9d3060c499d69630652">filearray</a>[state-&gt;<a class="code" href="structmoh__files__state.html#a6e3ea5b9afde5625ce286122ab8c3af4">save_pos</a>] == state-&gt;<a class="code" href="structmoh__files__state.html#a325fdaa3c6f64c09d0257b3b6ee5aec4">save_pos_filename</a>) {
<a name="l00274"></a>00274       state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a> = state-&gt;<a class="code" href="structmoh__files__state.html#a6e3ea5b9afde5625ce286122ab8c3af4">save_pos</a>;
<a name="l00275"></a>00275       state-&gt;<a class="code" href="structmoh__files__state.html#a6e3ea5b9afde5625ce286122ab8c3af4">save_pos</a> = -1;
<a name="l00276"></a>00276    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>, <a class="code" href="res__musiconhold_8c.html#a47622ed8ba1100fc57a944cef6a485eb">MOH_RANDOMIZE</a>)) {
<a name="l00277"></a>00277       <span class="comment">/* Get a random file and ensure we can open it */</span>
<a name="l00278"></a>00278       <span class="keywordflow">for</span> (tries = 0; tries &lt; 20; tries++) {
<a name="l00279"></a>00279          state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a> = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() % state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#ac4bef3984b07b68ad586b3109e528f47">total_files</a>;
<a name="l00280"></a>00280          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a04b870a2b3aee9d3060c499d69630652">filearray</a>[state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a>], NULL, NULL) &gt; 0)
<a name="l00281"></a>00281             <span class="keywordflow">break</span>;
<a name="l00282"></a>00282       }
<a name="l00283"></a>00283       state-&gt;<a class="code" href="structmoh__files__state.html#a6e3ea5b9afde5625ce286122ab8c3af4">save_pos</a> = -1;
<a name="l00284"></a>00284       state-&gt;<a class="code" href="structmoh__files__state.html#a37672e6b906143604cefd3e959777b31">samples</a> = 0;
<a name="l00285"></a>00285    } <span class="keywordflow">else</span> {
<a name="l00286"></a>00286       <span class="comment">/* This is easy, just increment our position and make sure we don&apos;t exceed the total file count */</span>
<a name="l00287"></a>00287       state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a>++;
<a name="l00288"></a>00288       state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a> %= state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#ac4bef3984b07b68ad586b3109e528f47">total_files</a>;
<a name="l00289"></a>00289       state-&gt;<a class="code" href="structmoh__files__state.html#a6e3ea5b9afde5625ce286122ab8c3af4">save_pos</a> = -1;
<a name="l00290"></a>00290       state-&gt;<a class="code" href="structmoh__files__state.html#a37672e6b906143604cefd3e959777b31">samples</a> = 0;
<a name="l00291"></a>00291    }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293    <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#ae2d6dfeafd18a99d47195178cd752a3d" title="Opens stream for use in seeking, playing.">ast_openstream_full</a>(chan, state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a04b870a2b3aee9d3060c499d69630652">filearray</a>[state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a>], chan-&gt;language, 1)) {
<a name="l00294"></a>00294       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open file &apos;%s&apos;: %s\n&quot;</span>, state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a04b870a2b3aee9d3060c499d69630652">filearray</a>[state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a>], strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00295"></a>00295       state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a>++;
<a name="l00296"></a>00296       state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a> %= state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#ac4bef3984b07b68ad586b3109e528f47">total_files</a>;
<a name="l00297"></a>00297       <span class="keywordflow">return</span> -1;
<a name="l00298"></a>00298    }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300    <span class="comment">/* Record the pointer to the filename for position resuming later */</span>
<a name="l00301"></a>00301    state-&gt;<a class="code" href="structmoh__files__state.html#a325fdaa3c6f64c09d0257b3b6ee5aec4">save_pos_filename</a> = state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a04b870a2b3aee9d3060c499d69630652">filearray</a>[state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a>];
<a name="l00302"></a>00302 
<a name="l00303"></a>00303    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s Opened file %d &apos;%s&apos;\n&quot;</span>, chan-&gt;name, state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a04b870a2b3aee9d3060c499d69630652">filearray</a>[state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a>]);
<a name="l00304"></a>00304 
<a name="l00305"></a>00305    <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structmoh__files__state.html#a37672e6b906143604cefd3e959777b31">samples</a>)
<a name="l00306"></a>00306       <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>, state-&gt;<a class="code" href="structmoh__files__state.html#a37672e6b906143604cefd3e959777b31">samples</a>, SEEK_SET);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308    <span class="keywordflow">return</span> 0;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a><a class="code" href="res__musiconhold_8c.html#abe4dc09c9760e2a65b0c66c971b4bde2">00311</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="res__musiconhold_8c.html#abe4dc09c9760e2a65b0c66c971b4bde2">moh_files_readframe</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>) 
<a name="l00312"></a>00312 {
<a name="l00313"></a>00313    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l00314"></a>00314    
<a name="l00315"></a>00315    <span class="keywordflow">if</span> (!(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> &amp;&amp; (f = <a class="code" href="file_8h.html#a962bc31d7a953b0a0290c72b168d41a7" title="Read a frame from a filestream.">ast_readframe</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>)))) {
<a name="l00316"></a>00316       <span class="keywordflow">if</span> (!<a class="code" href="res__musiconhold_8c.html#adcad3bce0f18dc8ef562c36db9fe370f">ast_moh_files_next</a>(chan))
<a name="l00317"></a>00317          f = <a class="code" href="file_8h.html#a962bc31d7a953b0a0290c72b168d41a7" title="Read a frame from a filestream.">ast_readframe</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>);
<a name="l00318"></a>00318    }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320    <span class="keywordflow">return</span> f;
<a name="l00321"></a>00321 }
<a name="l00322"></a>00322 
<a name="l00323"></a><a class="code" href="res__musiconhold_8c.html#a15a0fb01a254a8e80d724e1b151567e9">00323</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a15a0fb01a254a8e80d724e1b151567e9">moh_files_generator</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>)
<a name="l00324"></a>00324 {
<a name="l00325"></a>00325    <span class="keyword">struct </span><a class="code" href="structmoh__files__state.html">moh_files_state</a> *<a class="code" href="structstate.html">state</a> = chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a>;
<a name="l00326"></a>00326    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l00327"></a>00327    <span class="keywordtype">int</span> res = 0;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329    state-&gt;<a class="code" href="structmoh__files__state.html#ab45f20669bce21a6e7a16eff0fba0792">sample_queue</a> += samples;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331    <span class="keywordflow">while</span> (state-&gt;<a class="code" href="structmoh__files__state.html#ab45f20669bce21a6e7a16eff0fba0792">sample_queue</a> &gt; 0) {
<a name="l00332"></a>00332       <span class="keywordflow">if</span> ((f = <a class="code" href="res__musiconhold_8c.html#abe4dc09c9760e2a65b0c66c971b4bde2">moh_files_readframe</a>(chan))) {
<a name="l00333"></a>00333          state-&gt;<a class="code" href="structmoh__files__state.html#a37672e6b906143604cefd3e959777b31">samples</a> += f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l00334"></a>00334          state-&gt;<a class="code" href="structmoh__files__state.html#ab45f20669bce21a6e7a16eff0fba0792">sample_queue</a> -= f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l00335"></a>00335          res = <a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(chan, f);
<a name="l00336"></a>00336          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00337"></a>00337          <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00338"></a>00338             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to write frame to &apos;%s&apos;: %s\n&quot;</span>, chan-&gt;name, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00339"></a>00339             <span class="keywordflow">return</span> -1;
<a name="l00340"></a>00340          }
<a name="l00341"></a>00341       } <span class="keywordflow">else</span>
<a name="l00342"></a>00342          <span class="keywordflow">return</span> -1;  
<a name="l00343"></a>00343    }
<a name="l00344"></a>00344    <span class="keywordflow">return</span> res;
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00347"></a><a class="code" href="res__musiconhold_8c.html#ab4d3a28045c026a65173ddc0af47a79b">00347</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="res__musiconhold_8c.html#ab4d3a28045c026a65173ddc0af47a79b">moh_files_alloc</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *params)
<a name="l00348"></a>00348 {
<a name="l00349"></a>00349    <span class="keyword">struct </span><a class="code" href="structmoh__files__state.html">moh_files_state</a> *<a class="code" href="structstate.html">state</a>;
<a name="l00350"></a>00350    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class </span>= params;
<a name="l00351"></a>00351 
<a name="l00352"></a>00352    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a> &amp;&amp; (state = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*state)))) {
<a name="l00353"></a>00353       chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a> = state;
<a name="l00354"></a>00354       <a class="code" href="module_8h.html#aa08fcee0b390e15532dd03803c8728c4">ast_module_ref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l00355"></a>00355    } <span class="keywordflow">else</span> {
<a name="l00356"></a>00356       state = chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a>;
<a name="l00357"></a>00357    }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359    <span class="keywordflow">if</span> (!state) {
<a name="l00360"></a>00360       <span class="keywordflow">return</span> NULL;
<a name="l00361"></a>00361    }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363    <span class="comment">/* LOGIC: Comparing an unrefcounted pointer is a really bad idea, because</span>
<a name="l00364"></a>00364 <span class="comment">    * malloc may allocate a different class to the same memory block.  This</span>
<a name="l00365"></a>00365 <span class="comment">    * might only happen when two reloads are generated in a short period of</span>
<a name="l00366"></a>00366 <span class="comment">    * time, but it&apos;s still important to protect against.</span>
<a name="l00367"></a>00367 <span class="comment">    * PROG: Compare the quick operation first, to save CPU. */</span>
<a name="l00368"></a>00368    <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structmoh__files__state.html#ac89cb4e1a202cc332301c76d6c3eefb1">save_total</a> != class-&gt;total_files || strcmp(state-&gt;<a class="code" href="structmoh__files__state.html#a1544f236ea071cf9a855b49a332f5c13">name</a>, class-&gt;name) != 0) {
<a name="l00369"></a>00369       memset(state, 0, <span class="keyword">sizeof</span>(*state));
<a name="l00370"></a>00370       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#a47622ed8ba1100fc57a944cef6a485eb">MOH_RANDOMIZE</a>) &amp;&amp; class-&gt;total_files) {
<a name="l00371"></a>00371          state-&gt;<a class="code" href="structmoh__files__state.html#a1910d262855b71da353ed0d07a6c7823">pos</a> = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() % <span class="keyword">class</span>-&gt;total_files;
<a name="l00372"></a>00372       }
<a name="l00373"></a>00373    }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375    state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a> = <a class="code" href="res__musiconhold_8c.html#a837adf51399825c74e2d96602756d68c">mohclass_ref</a>(<span class="keyword">class</span>, <span class="stringliteral">&quot;Reffing music class for channel&quot;</span>);
<a name="l00376"></a>00376    state-&gt;<a class="code" href="structmoh__files__state.html#a5ef8e42d1eab1890f7eeb29e4af357eb">origwfmt</a> = chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l00377"></a>00377    <span class="comment">/* For comparison on restart of MOH (see above) */</span>
<a name="l00378"></a>00378    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(state-&gt;<a class="code" href="structmoh__files__state.html#a1544f236ea071cf9a855b49a332f5c13">name</a>, class-&gt;name, <span class="keyword">sizeof</span>(state-&gt;<a class="code" href="structmoh__files__state.html#a1544f236ea071cf9a855b49a332f5c13">name</a>));
<a name="l00379"></a>00379    state-&gt;<a class="code" href="structmoh__files__state.html#ac89cb4e1a202cc332301c76d6c3eefb1">save_total</a> = <span class="keyword">class</span>-&gt;total_files;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Started music on hold, class &apos;%s&apos;, on %s\n&quot;</span>, class-&gt;name, chan-&gt;name);
<a name="l00382"></a>00382    
<a name="l00383"></a>00383    <span class="keywordflow">return</span> chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a>;
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a><a class="code" href="res__musiconhold_8c.html#aa1418453804cd37367f225e729d7386f">00386</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#aa1418453804cd37367f225e729d7386f">moh_digit_match</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l00387"></a>00387 {
<a name="l00388"></a>00388    <span class="keywordtype">char</span> *<a class="code" href="structmohclass.html#ac2c887b7f7b359bfdda8a128980f5081">digit</a> = arg;
<a name="l00389"></a>00389    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class </span>= obj;
<a name="l00390"></a>00390 
<a name="l00391"></a>00391    <span class="keywordflow">return</span> (*digit == class-&gt;digit) ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a> : 0;
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 <span class="comment"></span>
<a name="l00394"></a>00394 <span class="comment">/*! \note This function should be called with the mohclasses list locked */</span>
<a name="l00395"></a><a class="code" href="res__musiconhold_8c.html#a5c938679a3baa8aee78f35ad4acd003e">00395</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<a class="code" href="res__musiconhold_8c.html#a5c938679a3baa8aee78f35ad4acd003e">get_mohbydigit</a>(<span class="keywordtype">char</span> <a class="code" href="structmohclass.html#ac2c887b7f7b359bfdda8a128980f5081">digit</a>)
<a name="l00396"></a>00396 {
<a name="l00397"></a>00397    <span class="keywordflow">return</span> <a class="code" href="astobj2_8h.html#aeca960ec22a1d0384f6e285b25df8501" title="ao2_callback() is a generic function that applies cb_fn() to all objects in a container...">ao2_t_callback</a>(mohclasses, 0, <a class="code" href="res__musiconhold_8c.html#aa1418453804cd37367f225e729d7386f">moh_digit_match</a>, &amp;digit, <span class="stringliteral">&quot;digit callback&quot;</span>);
<a name="l00398"></a>00398 }
<a name="l00399"></a>00399 
<a name="l00400"></a><a class="code" href="res__musiconhold_8c.html#a1dd51b9e4184fc66f8f823a2bd6c4bf9">00400</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__musiconhold_8c.html#a1dd51b9e4184fc66f8f823a2bd6c4bf9">moh_handle_digit</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> <a class="code" href="structmohclass.html#ac2c887b7f7b359bfdda8a128980f5081">digit</a>)
<a name="l00401"></a>00401 {
<a name="l00402"></a>00402    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class</span>;
<a name="l00403"></a>00403    <span class="keyword">const</span> <span class="keywordtype">char</span> *classname = NULL;
<a name="l00404"></a>00404 
<a name="l00405"></a>00405    <span class="keywordflow">if</span> ((<span class="keyword">class</span> = <a class="code" href="res__musiconhold_8c.html#a5c938679a3baa8aee78f35ad4acd003e">get_mohbydigit</a>(digit))) {
<a name="l00406"></a>00406       classname = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(class-&gt;name);
<a name="l00407"></a>00407       <span class="keyword">class </span>= <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(class, &quot;Unreffing ao2_find from finding by digit&quot;);
<a name="l00408"></a>00408       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(chan,<a class="code" href="chan__mgcp_8c.html#abc34958c9b03014779727e5ca61b93e5">musicclass</a>,classname);
<a name="l00409"></a>00409       <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l00410"></a>00410       <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(chan, classname, NULL);
<a name="l00411"></a>00411    }
<a name="l00412"></a>00412 }
<a name="l00413"></a>00413 
<a name="l00414"></a><a class="code" href="res__musiconhold_8c.html#a85c1df65873a5502a7f355548d4c953c">00414</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__generator.html">ast_generator</a> <a class="code" href="res__musiconhold_8c.html#a85c1df65873a5502a7f355548d4c953c">moh_file_stream</a> = 
<a name="l00415"></a>00415 {
<a name="l00416"></a>00416    .<a class="code" href="structast__generator.html#a4cdb1ccb0ee9d0a97af1862c625e6bc8">alloc</a>    = <a class="code" href="res__musiconhold_8c.html#ab4d3a28045c026a65173ddc0af47a79b">moh_files_alloc</a>,
<a name="l00417"></a>00417    .release  = <a class="code" href="res__musiconhold_8c.html#a94a2a280b4beeffa8e35576bd3a46d09">moh_files_release</a>,
<a name="l00418"></a>00418    .generate = <a class="code" href="res__musiconhold_8c.html#a15a0fb01a254a8e80d724e1b151567e9">moh_files_generator</a>,
<a name="l00419"></a>00419    .digit    = <a class="code" href="res__musiconhold_8c.html#a1dd51b9e4184fc66f8f823a2bd6c4bf9">moh_handle_digit</a>,
<a name="l00420"></a>00420 };
<a name="l00421"></a>00421 
<a name="l00422"></a><a class="code" href="res__musiconhold_8c.html#aafda9fa43e4259cef9e4880390f96734">00422</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#aafda9fa43e4259cef9e4880390f96734">spawn_mp3</a>(<span class="keyword">struct</span> <a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class</span>)
<a name="l00423"></a>00423 {
<a name="l00424"></a>00424    <span class="keywordtype">int</span> fds[2];
<a name="l00425"></a>00425    <span class="keywordtype">int</span> files = 0;
<a name="l00426"></a>00426    <span class="keywordtype">char</span> fns[<a class="code" href="res__musiconhold_8c.html#aa7f60ce1373c47d96ece41e57364bd35">MAX_MP3S</a>][80];
<a name="l00427"></a>00427    <span class="keywordtype">char</span> *argv[<a class="code" href="res__musiconhold_8c.html#aa7f60ce1373c47d96ece41e57364bd35">MAX_MP3S</a> + 50];
<a name="l00428"></a>00428    <span class="keywordtype">char</span> xargs[256];
<a name="l00429"></a>00429    <span class="keywordtype">char</span> *argptr;
<a name="l00430"></a>00430    <span class="keywordtype">int</span> argc = 0;
<a name="l00431"></a>00431    DIR *<a class="code" href="structmohclass.html#a4a55f3eac855c94cd30d3f16c3f83fb7">dir</a> = NULL;
<a name="l00432"></a>00432    <span class="keyword">struct </span>dirent *de;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434    
<a name="l00435"></a>00435    <span class="keywordflow">if</span> (!strcasecmp(class-&gt;dir, <span class="stringliteral">&quot;nodir&quot;</span>)) {
<a name="l00436"></a>00436       files = 1;
<a name="l00437"></a>00437    } <span class="keywordflow">else</span> {
<a name="l00438"></a>00438       dir = opendir(class-&gt;dir);
<a name="l00439"></a>00439       <span class="keywordflow">if</span> (!dir &amp;&amp; strncasecmp(class-&gt;dir, <span class="stringliteral">&quot;http://&quot;</span>, 7)) {
<a name="l00440"></a>00440          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s is not a valid directory\n&quot;</span>, class-&gt;dir);
<a name="l00441"></a>00441          <span class="keywordflow">return</span> -1;
<a name="l00442"></a>00442       }
<a name="l00443"></a>00443    }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#a2eff543e703f0fb49f655f760312e291">MOH_CUSTOM</a>)) {
<a name="l00446"></a>00446       argv[argc++] = <span class="stringliteral">&quot;mpg123&quot;</span>;
<a name="l00447"></a>00447       argv[argc++] = <span class="stringliteral">&quot;-q&quot;</span>;
<a name="l00448"></a>00448       argv[argc++] = <span class="stringliteral">&quot;-s&quot;</span>;
<a name="l00449"></a>00449       argv[argc++] = <span class="stringliteral">&quot;--mono&quot;</span>;
<a name="l00450"></a>00450       argv[argc++] = <span class="stringliteral">&quot;-r&quot;</span>;
<a name="l00451"></a>00451       argv[argc++] = <span class="stringliteral">&quot;8000&quot;</span>;
<a name="l00452"></a>00452       
<a name="l00453"></a>00453       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#acb4a79e9b83147f8ab6a7ada46071740">MOH_SINGLE</a>)) {
<a name="l00454"></a>00454          argv[argc++] = <span class="stringliteral">&quot;-b&quot;</span>;
<a name="l00455"></a>00455          argv[argc++] = <span class="stringliteral">&quot;2048&quot;</span>;
<a name="l00456"></a>00456       }
<a name="l00457"></a>00457       
<a name="l00458"></a>00458       argv[argc++] = <span class="stringliteral">&quot;-f&quot;</span>;
<a name="l00459"></a>00459       
<a name="l00460"></a>00460       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#a35d37162b1781f830c686da44c0c9a9d">MOH_QUIET</a>))
<a name="l00461"></a>00461          argv[argc++] = <span class="stringliteral">&quot;4096&quot;</span>;
<a name="l00462"></a>00462       <span class="keywordflow">else</span>
<a name="l00463"></a>00463          argv[argc++] = <span class="stringliteral">&quot;8192&quot;</span>;
<a name="l00464"></a>00464       
<a name="l00465"></a>00465       <span class="comment">/* Look for extra arguments and add them to the list */</span>
<a name="l00466"></a>00466       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(xargs, class-&gt;args, <span class="keyword">sizeof</span>(xargs));
<a name="l00467"></a>00467       argptr = xargs;
<a name="l00468"></a>00468       <span class="keywordflow">while</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(argptr)) {
<a name="l00469"></a>00469          argv[argc++] = argptr;
<a name="l00470"></a>00470          <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;argptr, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l00471"></a>00471       }
<a name="l00472"></a>00472    } <span class="keywordflow">else</span>  {
<a name="l00473"></a>00473       <span class="comment">/* Format arguments for argv vector */</span>
<a name="l00474"></a>00474       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(xargs, class-&gt;args, <span class="keyword">sizeof</span>(xargs));
<a name="l00475"></a>00475       argptr = xargs;
<a name="l00476"></a>00476       <span class="keywordflow">while</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(argptr)) {
<a name="l00477"></a>00477          argv[argc++] = argptr;
<a name="l00478"></a>00478          <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;argptr, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00479"></a>00479       }
<a name="l00480"></a>00480    }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482    <span class="keywordflow">if</span> (!strncasecmp(class-&gt;dir, <span class="stringliteral">&quot;http://&quot;</span>, 7)) {
<a name="l00483"></a>00483       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fns[files], class-&gt;dir, <span class="keyword">sizeof</span>(fns[files]));
<a name="l00484"></a>00484       argv[argc++] = fns[files];
<a name="l00485"></a>00485       files++;
<a name="l00486"></a>00486    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dir) {
<a name="l00487"></a>00487       <span class="keywordflow">while</span> ((de = readdir(dir)) &amp;&amp; (files &lt; <a class="code" href="res__musiconhold_8c.html#aa7f60ce1373c47d96ece41e57364bd35">MAX_MP3S</a>)) {
<a name="l00488"></a>00488          <span class="keywordflow">if</span> ((strlen(de-&gt;d_name) &gt; 3) &amp;&amp; 
<a name="l00489"></a>00489              ((<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#a2eff543e703f0fb49f655f760312e291">MOH_CUSTOM</a>) &amp;&amp; 
<a name="l00490"></a>00490                (!strcasecmp(de-&gt;d_name + strlen(de-&gt;d_name) - 4, <span class="stringliteral">&quot;.raw&quot;</span>) || 
<a name="l00491"></a>00491                 !strcasecmp(de-&gt;d_name + strlen(de-&gt;d_name) - 4, <span class="stringliteral">&quot;.sln&quot;</span>))) ||
<a name="l00492"></a>00492               !strcasecmp(de-&gt;d_name + strlen(de-&gt;d_name) - 4, <span class="stringliteral">&quot;.mp3&quot;</span>))) {
<a name="l00493"></a>00493             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fns[files], de-&gt;d_name, <span class="keyword">sizeof</span>(fns[files]));
<a name="l00494"></a>00494             argv[argc++] = fns[files];
<a name="l00495"></a>00495             files++;
<a name="l00496"></a>00496          }
<a name="l00497"></a>00497       }
<a name="l00498"></a>00498    }
<a name="l00499"></a>00499    argv[argc] = NULL;
<a name="l00500"></a>00500    <span class="keywordflow">if</span> (dir) {
<a name="l00501"></a>00501       closedir(dir);
<a name="l00502"></a>00502    }
<a name="l00503"></a>00503    <span class="keywordflow">if</span> (pipe(fds)) {  
<a name="l00504"></a>00504       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Pipe failed\n&quot;</span>);
<a name="l00505"></a>00505       <span class="keywordflow">return</span> -1;
<a name="l00506"></a>00506    }
<a name="l00507"></a>00507    <span class="keywordflow">if</span> (!files) {
<a name="l00508"></a>00508       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Found no files in &apos;%s&apos;\n&quot;</span>, class-&gt;dir);
<a name="l00509"></a>00509       close(fds[0]);
<a name="l00510"></a>00510       close(fds[1]);
<a name="l00511"></a>00511       <span class="keywordflow">return</span> -1;
<a name="l00512"></a>00512    }
<a name="l00513"></a>00513    <span class="keywordflow">if</span> (!strncasecmp(class-&gt;dir, <span class="stringliteral">&quot;http://&quot;</span>, 7) &amp;&amp; time(NULL) - class-&gt;start &lt; respawn_time) {
<a name="l00514"></a>00514       sleep(respawn_time - (time(NULL) - class-&gt;start));
<a name="l00515"></a>00515    }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517    time(&amp;class-&gt;start);
<a name="l00518"></a>00518    <span class="keyword">class</span>-&gt;pid = <a class="code" href="app_8h.html#a7a4c7e208ffc4d11a1918beb0e920ec0" title="Common routine to safely fork without a chance of a signal handler firing badly in...">ast_safe_fork</a>(0);
<a name="l00519"></a>00519    <span class="keywordflow">if</span> (class-&gt;pid &lt; 0) {
<a name="l00520"></a>00520       close(fds[0]);
<a name="l00521"></a>00521       close(fds[1]);
<a name="l00522"></a>00522       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Fork failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00523"></a>00523       <span class="keywordflow">return</span> -1;
<a name="l00524"></a>00524    }
<a name="l00525"></a>00525    <span class="keywordflow">if</span> (!class-&gt;pid) {
<a name="l00526"></a>00526       <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a8445b47cb18dde73b1b233358a25ed68">ast_opt_high_priority</a>)
<a name="l00527"></a>00527          <a class="code" href="asterisk_8h.html#ad649acedd512a45c748a440e78a281c9" title="We set ourselves to a high priority, that we might pre-empt everything else. If your...">ast_set_priority</a>(0);
<a name="l00528"></a>00528 
<a name="l00529"></a>00529       close(fds[0]);
<a name="l00530"></a>00530       <span class="comment">/* Stdout goes to pipe */</span>
<a name="l00531"></a>00531       dup2(fds[1], STDOUT_FILENO);
<a name="l00532"></a>00532 
<a name="l00533"></a>00533       <span class="comment">/* Close everything else */</span>
<a name="l00534"></a>00534       <a class="code" href="app_8h.html#afcbfdd6dfc8c5f0f549b0a5d7e263e97" title="Common routine for child processes, to close all fds prior to exec(2).">ast_close_fds_above_n</a>(STDERR_FILENO);
<a name="l00535"></a>00535 
<a name="l00536"></a>00536       <span class="comment">/* Child */</span>
<a name="l00537"></a>00537       <span class="keywordflow">if</span> (strcasecmp(class-&gt;dir, <span class="stringliteral">&quot;nodir&quot;</span>) &amp;&amp; chdir(class-&gt;dir) &lt; 0) {
<a name="l00538"></a>00538          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;chdir() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00539"></a>00539          _exit(1);
<a name="l00540"></a>00540       }
<a name="l00541"></a>00541       setpgid(0, getpid());
<a name="l00542"></a>00542       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#a2eff543e703f0fb49f655f760312e291">MOH_CUSTOM</a>)) {
<a name="l00543"></a>00543          execv(argv[0], argv);
<a name="l00544"></a>00544       } <span class="keywordflow">else</span> {
<a name="l00545"></a>00545          <span class="comment">/* Default install is /usr/local/bin */</span>
<a name="l00546"></a>00546          execv(<a class="code" href="app__mp3_8c.html#a81f956d8547e816f632929caf937662e">LOCAL_MPG_123</a>, argv);
<a name="l00547"></a>00547          <span class="comment">/* Many places have it in /usr/bin */</span>
<a name="l00548"></a>00548          execv(<a class="code" href="app__mp3_8c.html#a07f0c52e86a747f8e6ebff81bc88a527">MPG_123</a>, argv);
<a name="l00549"></a>00549          <span class="comment">/* Check PATH as a last-ditch effort */</span>
<a name="l00550"></a>00550          execvp(<span class="stringliteral">&quot;mpg123&quot;</span>, argv);
<a name="l00551"></a>00551       }
<a name="l00552"></a>00552       <span class="comment">/* Can&apos;t use logger, since log FDs are closed */</span>
<a name="l00553"></a>00553       fprintf(stderr, <span class="stringliteral">&quot;MOH: exec failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00554"></a>00554       close(fds[1]);
<a name="l00555"></a>00555       _exit(1);
<a name="l00556"></a>00556    } <span class="keywordflow">else</span> {
<a name="l00557"></a>00557       <span class="comment">/* Parent */</span>
<a name="l00558"></a>00558       close(fds[1]);
<a name="l00559"></a>00559    }
<a name="l00560"></a>00560    <span class="keywordflow">return</span> fds[0];
<a name="l00561"></a>00561 }
<a name="l00562"></a>00562 
<a name="l00563"></a><a class="code" href="res__musiconhold_8c.html#af7c7c2858fee7838706a4cd3163f2ad1">00563</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="res__musiconhold_8c.html#af7c7c2858fee7838706a4cd3163f2ad1">monmp3thread</a>(<span class="keywordtype">void</span> *data)
<a name="l00564"></a>00564 {
<a name="l00565"></a>00565 <span class="preprocessor">#define  MOH_MS_INTERVAL      100</span>
<a name="l00566"></a>00566 <span class="preprocessor"></span>
<a name="l00567"></a>00567    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class </span>= data;
<a name="l00568"></a>00568    <span class="keyword">struct </span>mohdata *<a class="code" href="chan__agent_8c.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>;
<a name="l00569"></a>00569    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[8192];
<a name="l00570"></a>00570    <span class="keywordtype">short</span> sbuf[8192];
<a name="l00571"></a>00571    <span class="keywordtype">int</span> res, res2;
<a name="l00572"></a>00572    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l00573"></a>00573    <span class="keyword">struct </span>timeval deadline, tv_tmp;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575    deadline.tv_sec = 0;
<a name="l00576"></a>00576    deadline.tv_usec = 0;
<a name="l00577"></a>00577    <span class="keywordflow">for</span>(;<span class="comment">/* ever */</span>;) {
<a name="l00578"></a>00578       pthread_testcancel();
<a name="l00579"></a>00579       <span class="comment">/* Spawn mp3 player if it&apos;s not there */</span>
<a name="l00580"></a>00580       <span class="keywordflow">if</span> (class-&gt;srcfd &lt; 0) {
<a name="l00581"></a>00581          <span class="keywordflow">if</span> ((class-&gt;srcfd = <a class="code" href="res__musiconhold_8c.html#aafda9fa43e4259cef9e4880390f96734">spawn_mp3</a>(<span class="keyword">class</span>)) &lt; 0) {
<a name="l00582"></a>00582             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to spawn mp3player\n&quot;</span>);
<a name="l00583"></a>00583             <span class="comment">/* Try again later */</span>
<a name="l00584"></a>00584             sleep(500);
<a name="l00585"></a>00585             pthread_testcancel();
<a name="l00586"></a>00586          }
<a name="l00587"></a>00587       }
<a name="l00588"></a>00588       <span class="keywordflow">if</span> (class-&gt;pseudofd &gt; -1) {
<a name="l00589"></a>00589 <span class="preprocessor">#ifdef SOLARIS</span>
<a name="l00590"></a>00590 <span class="preprocessor"></span>         thr_yield();
<a name="l00591"></a>00591 <span class="preprocessor">#endif</span>
<a name="l00592"></a>00592 <span class="preprocessor"></span>         <span class="comment">/* Pause some amount of time */</span>
<a name="l00593"></a>00593          res = read(class-&gt;pseudofd, buf, <span class="keyword">sizeof</span>(buf));
<a name="l00594"></a>00594          pthread_testcancel();
<a name="l00595"></a>00595       } <span class="keywordflow">else</span> {
<a name="l00596"></a>00596          <span class="keywordtype">long</span> delta;
<a name="l00597"></a>00597          <span class="comment">/* Reliable sleep */</span>
<a name="l00598"></a>00598          tv_tmp = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00599"></a>00599          <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(deadline))
<a name="l00600"></a>00600             deadline = tv_tmp;
<a name="l00601"></a>00601          delta = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(tv_tmp, deadline);
<a name="l00602"></a>00602          <span class="keywordflow">if</span> (delta &lt; <a class="code" href="res__musiconhold_8c.html#a4ff559a740a305b67163843b2f1fcf02">MOH_MS_INTERVAL</a>) {   <span class="comment">/* too early */</span>
<a name="l00603"></a>00603             deadline = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(deadline, <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(<a class="code" href="res__musiconhold_8c.html#a4ff559a740a305b67163843b2f1fcf02">MOH_MS_INTERVAL</a>, 1000));  <span class="comment">/* next deadline */</span>
<a name="l00604"></a>00604             usleep(1000 * (<a class="code" href="res__musiconhold_8c.html#a4ff559a740a305b67163843b2f1fcf02">MOH_MS_INTERVAL</a> - delta));
<a name="l00605"></a>00605             pthread_testcancel();
<a name="l00606"></a>00606          } <span class="keywordflow">else</span> {
<a name="l00607"></a>00607             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Request to schedule in the past?!?!\n&quot;</span>);
<a name="l00608"></a>00608             deadline = tv_tmp;
<a name="l00609"></a>00609          }
<a name="l00610"></a>00610          res = 8 * <a class="code" href="res__musiconhold_8c.html#a4ff559a740a305b67163843b2f1fcf02">MOH_MS_INTERVAL</a>; <span class="comment">/* 8 samples per millisecond */</span>
<a name="l00611"></a>00611       }
<a name="l00612"></a>00612       <span class="keywordflow">if</span> ((strncasecmp(class-&gt;dir, <span class="stringliteral">&quot;http://&quot;</span>, 7) &amp;&amp; strcasecmp(class-&gt;dir, <span class="stringliteral">&quot;nodir&quot;</span>)) &amp;&amp; <a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;class-&gt;members))
<a name="l00613"></a>00613          <span class="keywordflow">continue</span>;
<a name="l00614"></a>00614       <span class="comment">/* Read mp3 audio */</span>
<a name="l00615"></a>00615       len = <a class="code" href="frame_8h.html#ae147ae1521acd6b95bba6956078b2f34" title="Returns the number of bytes for the number of samples of the given format.">ast_codec_get_len</a>(class-&gt;format, res);
<a name="l00616"></a>00616 
<a name="l00617"></a>00617       <span class="keywordflow">if</span> ((res2 = read(class-&gt;srcfd, sbuf, len)) != len) {
<a name="l00618"></a>00618          <span class="keywordflow">if</span> (!res2) {
<a name="l00619"></a>00619             close(class-&gt;srcfd);
<a name="l00620"></a>00620             <span class="keyword">class</span>-&gt;srcfd = -1;
<a name="l00621"></a>00621             pthread_testcancel();
<a name="l00622"></a>00622             <span class="keywordflow">if</span> (class-&gt;pid &gt; 1) {
<a name="l00623"></a>00623                <span class="keywordflow">do</span> {
<a name="l00624"></a>00624                   <span class="keywordflow">if</span> (killpg(class-&gt;pid, SIGHUP) &lt; 0) {
<a name="l00625"></a>00625                      <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ESRCH) {
<a name="l00626"></a>00626                         <span class="keywordflow">break</span>;
<a name="l00627"></a>00627                      }
<a name="l00628"></a>00628                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to send a SIGHUP to MOH process?!!: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00629"></a>00629                   }
<a name="l00630"></a>00630                   usleep(100000);
<a name="l00631"></a>00631                   <span class="keywordflow">if</span> (killpg(class-&gt;pid, SIGTERM) &lt; 0) {
<a name="l00632"></a>00632                      <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ESRCH) {
<a name="l00633"></a>00633                         <span class="keywordflow">break</span>;
<a name="l00634"></a>00634                      }
<a name="l00635"></a>00635                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to terminate MOH process?!!: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00636"></a>00636                   }
<a name="l00637"></a>00637                   usleep(100000);
<a name="l00638"></a>00638                   <span class="keywordflow">if</span> (killpg(class-&gt;pid, SIGKILL) &lt; 0) {
<a name="l00639"></a>00639                      <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ESRCH) {
<a name="l00640"></a>00640                         <span class="keywordflow">break</span>;
<a name="l00641"></a>00641                      }
<a name="l00642"></a>00642                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to kill MOH process?!!: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00643"></a>00643                   }
<a name="l00644"></a>00644                } <span class="keywordflow">while</span> (0);
<a name="l00645"></a>00645                <span class="keyword">class</span>-&gt;pid = 0;
<a name="l00646"></a>00646             }
<a name="l00647"></a>00647          } <span class="keywordflow">else</span> {
<a name="l00648"></a>00648             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Read %d bytes of audio while expecting %d\n&quot;</span>, res2, len);
<a name="l00649"></a>00649          }
<a name="l00650"></a>00650          <span class="keywordflow">continue</span>;
<a name="l00651"></a>00651       }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653       pthread_testcancel();
<a name="l00654"></a>00654 
<a name="l00655"></a>00655       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<span class="keyword">class</span>);
<a name="l00656"></a>00656       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;class-&gt;members, moh, list) {
<a name="l00657"></a>00657          <span class="comment">/* Write data */</span>
<a name="l00658"></a>00658          <span class="keywordflow">if</span> ((res = write(moh-&gt;<a class="code" href="structmohdata.html#a67646b28a1d0efc1226de7291833b5ec">pipe</a>[1], sbuf, res2)) != res2) {
<a name="l00659"></a>00659             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Only wrote %d of %d bytes to pipe\n&quot;</span>, res, res2);
<a name="l00660"></a>00660          }
<a name="l00661"></a>00661       }
<a name="l00662"></a>00662       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<span class="keyword">class</span>);
<a name="l00663"></a>00663    }
<a name="l00664"></a>00664    <span class="keywordflow">return</span> NULL;
<a name="l00665"></a>00665 }
<a name="l00666"></a>00666 
<a name="l00667"></a><a class="code" href="res__musiconhold_8c.html#a02c661b74ad220761f58dd18af45a367">00667</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a02c661b74ad220761f58dd18af45a367">play_moh_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00668"></a>00668 {
<a name="l00669"></a>00669    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l00670"></a>00670    <span class="keywordtype">char</span> *<span class="keyword">class</span>;
<a name="l00671"></a>00671    <span class="keywordtype">int</span> timeout = -1;
<a name="l00672"></a>00672    <span class="keywordtype">int</span> res;
<a name="l00673"></a>00673    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(<a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>,
<a name="l00674"></a>00674       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<span class="keyword">class</span>);
<a name="l00675"></a>00675       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(duration);
<a name="l00676"></a>00676    );
<a name="l00677"></a>00677 
<a name="l00678"></a>00678    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l00679"></a>00679 
<a name="l00680"></a>00680    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(<a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>, parse);
<a name="l00681"></a>00681 
<a name="l00682"></a>00682    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>.duration)) {
<a name="l00683"></a>00683       <span class="keywordflow">if</span> (sscanf(<a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>.duration, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;timeout) == 1) {
<a name="l00684"></a>00684          timeout *= 1000;
<a name="l00685"></a>00685       } <span class="keywordflow">else</span> {
<a name="l00686"></a>00686          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid MusicOnHold duration &apos;%s&apos;. Will wait indefinitely.\n&quot;</span>, <a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>.duration);
<a name="l00687"></a>00687       }
<a name="l00688"></a>00688    }
<a name="l00689"></a>00689 
<a name="l00690"></a>00690    <span class="keyword">class </span>= <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(args.class, NULL);
<a name="l00691"></a>00691    <span class="keywordflow">if</span> (<a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(chan, <span class="keyword">class</span>, NULL)) {
<a name="l00692"></a>00692       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to start music on hold class &apos;%s&apos; on channel %s\n&quot;</span>, <span class="keyword">class</span>, chan-&gt;name);
<a name="l00693"></a>00693       <span class="keywordflow">return</span> 0;
<a name="l00694"></a>00694    }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696    <span class="keywordflow">if</span> (timeout &gt; 0)
<a name="l00697"></a>00697       res = <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(chan, timeout);
<a name="l00698"></a>00698    <span class="keywordflow">else</span> {
<a name="l00699"></a>00699       <span class="keywordflow">while</span> (!(res = <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(chan, 10000)));
<a name="l00700"></a>00700    }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702    <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l00703"></a>00703 
<a name="l00704"></a>00704    <span class="keywordflow">return</span> res;
<a name="l00705"></a>00705 }
<a name="l00706"></a>00706 
<a name="l00707"></a><a class="code" href="res__musiconhold_8c.html#aff91d8cab0d5d1f02de2039346b512c1">00707</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#aff91d8cab0d5d1f02de2039346b512c1">wait_moh_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00708"></a>00708 {
<a name="l00709"></a>00709    <span class="keyword">static</span> <span class="keywordtype">int</span> deprecation_warning = 0;
<a name="l00710"></a>00710    <span class="keywordtype">int</span> res;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712    <span class="keywordflow">if</span> (!deprecation_warning) {
<a name="l00713"></a>00713       deprecation_warning = 1;
<a name="l00714"></a>00714       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;WaitMusicOnHold application is deprecated and will be removed. Use MusicOnHold with duration parameter instead\n&quot;</span>);
<a name="l00715"></a>00715    }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717    <span class="keywordflow">if</span> (!data || !atoi(data)) {
<a name="l00718"></a>00718       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;WaitMusicOnHold requires an argument (number of seconds to wait)\n&quot;</span>);
<a name="l00719"></a>00719       <span class="keywordflow">return</span> -1;
<a name="l00720"></a>00720    }
<a name="l00721"></a>00721    <span class="keywordflow">if</span> (<a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(chan, NULL, NULL)) {
<a name="l00722"></a>00722       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to start music on hold for %d seconds on channel %s\n&quot;</span>, atoi(data), chan-&gt;name);
<a name="l00723"></a>00723       <span class="keywordflow">return</span> 0;
<a name="l00724"></a>00724    }
<a name="l00725"></a>00725    res = <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(chan, atoi(data) * 1000);
<a name="l00726"></a>00726    <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l00727"></a>00727    <span class="keywordflow">return</span> res;
<a name="l00728"></a>00728 }
<a name="l00729"></a>00729 
<a name="l00730"></a><a class="code" href="res__musiconhold_8c.html#ad74d0b042ef5e41a7ac11d21a9b4b05c">00730</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#ad74d0b042ef5e41a7ac11d21a9b4b05c">set_moh_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00731"></a>00731 {
<a name="l00732"></a>00732    <span class="keyword">static</span> <span class="keywordtype">int</span> deprecation_warning = 0;
<a name="l00733"></a>00733 
<a name="l00734"></a>00734    <span class="keywordflow">if</span> (!deprecation_warning) {
<a name="l00735"></a>00735       deprecation_warning = 1;
<a name="l00736"></a>00736       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SetMusicOnHold application is deprecated and will be removed. Use Set(CHANNEL(musicclass)=...) instead\n&quot;</span>);
<a name="l00737"></a>00737    }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l00740"></a>00740       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SetMusicOnHold requires an argument (class)\n&quot;</span>);
<a name="l00741"></a>00741       <span class="keywordflow">return</span> -1;
<a name="l00742"></a>00742    }
<a name="l00743"></a>00743    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(chan, <a class="code" href="chan__mgcp_8c.html#abc34958c9b03014779727e5ca61b93e5">musicclass</a>, data);
<a name="l00744"></a>00744    <span class="keywordflow">return</span> 0;
<a name="l00745"></a>00745 }
<a name="l00746"></a>00746 
<a name="l00747"></a><a class="code" href="res__musiconhold_8c.html#ab3b9f86e48edb2853a7f6ee7bd17ecf1">00747</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#ab3b9f86e48edb2853a7f6ee7bd17ecf1">start_moh_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00748"></a>00748 {
<a name="l00749"></a>00749    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l00750"></a>00750    <span class="keywordtype">char</span> *<span class="keyword">class</span>;
<a name="l00751"></a>00751    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(<a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>,
<a name="l00752"></a>00752       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<span class="keyword">class</span>);
<a name="l00753"></a>00753    );
<a name="l00754"></a>00754 
<a name="l00755"></a>00755    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l00756"></a>00756 
<a name="l00757"></a>00757    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(<a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>, parse);
<a name="l00758"></a>00758 
<a name="l00759"></a>00759    <span class="keyword">class </span>= <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(args.class, NULL);
<a name="l00760"></a>00760    <span class="keywordflow">if</span> (<a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(chan, <span class="keyword">class</span>, NULL)) 
<a name="l00761"></a>00761       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to start music on hold class &apos;%s&apos; on channel %s\n&quot;</span>, <span class="keyword">class</span>, chan-&gt;name);
<a name="l00762"></a>00762 
<a name="l00763"></a>00763    <span class="keywordflow">return</span> 0;
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a><a class="code" href="res__musiconhold_8c.html#a903d206ef650f4216b41018d0baf83d0">00766</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a903d206ef650f4216b41018d0baf83d0">stop_moh_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00767"></a>00767 {
<a name="l00768"></a>00768    <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l00769"></a>00769 
<a name="l00770"></a>00770    <span class="keywordflow">return</span> 0;
<a name="l00771"></a>00771 }
<a name="l00772"></a>00772 
<a name="l00773"></a><a class="code" href="res__musiconhold_8c.html#a3d6bd423c91a036598151be18001cf73">00773</a> <span class="preprocessor">#define get_mohbyname(a,b,c)  _get_mohbyname(a,b,c,__FILE__,__LINE__,__PRETTY_FUNCTION__)</span>
<a name="l00774"></a>00774 <span class="preprocessor"></span>
<a name="l00775"></a><a class="code" href="res__musiconhold_8c.html#a8828a2f647293fd1b6b317dddcb0c487">00775</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<a class="code" href="res__musiconhold_8c.html#a8828a2f647293fd1b6b317dddcb0c487">_get_mohbyname</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>, <span class="keywordtype">int</span> warn, <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> lineno, <span class="keyword">const</span> <span class="keywordtype">char</span> *funcname)
<a name="l00776"></a>00776 {
<a name="l00777"></a>00777    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<a class="code" href="chan__agent_8c.html#a0f66f061490edf209d9ff6e2f18be109">moh</a> = NULL;
<a name="l00778"></a>00778    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> tmp_class = {
<a name="l00779"></a>00779       .<a class="code" href="structmohclass.html#ac92588540e8c1d014a08cd8a45462b19">flags</a> = 0,
<a name="l00780"></a>00780    };
<a name="l00781"></a>00781 
<a name="l00782"></a>00782    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp_class.<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>, name, <span class="keyword">sizeof</span>(tmp_class.<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>));
<a name="l00783"></a>00783 
<a name="l00784"></a>00784 <span class="preprocessor">#ifdef REF_DEBUG</span>
<a name="l00785"></a>00785 <span class="preprocessor"></span>   moh = <a class="code" href="astobj2_8h.html#a5dbd3b81ca89a8474950a7e44ad8adc5">_ao2_find_debug</a>(mohclasses, &amp;tmp_class, flags, <span class="stringliteral">&quot;get_mohbyname&quot;</span>, (<span class="keywordtype">char</span> *) file, lineno, funcname);
<a name="l00786"></a>00786 <span class="preprocessor">#else</span>
<a name="l00787"></a>00787 <span class="preprocessor"></span>   moh = <a class="code" href="astobj2_8h.html#a1fbe06cf1b054fe94d7ff6b06343e7d0">_ao2_find</a>(mohclasses, &amp;tmp_class, flags);
<a name="l00788"></a>00788 <span class="preprocessor">#endif</span>
<a name="l00789"></a>00789 <span class="preprocessor"></span>
<a name="l00790"></a>00790    <span class="keywordflow">if</span> (!moh &amp;&amp; warn) {
<a name="l00791"></a>00791       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Music on Hold class &apos;%s&apos; not found in memory\n&quot;</span>, name);
<a name="l00792"></a>00792    }
<a name="l00793"></a>00793 
<a name="l00794"></a>00794    <span class="keywordflow">return</span> moh;
<a name="l00795"></a>00795 }
<a name="l00796"></a>00796 
<a name="l00797"></a><a class="code" href="res__musiconhold_8c.html#a62bb3c5f4e818b298c9a66a512822d75">00797</a> <span class="keyword">static</span> <span class="keyword">struct </span>mohdata *<a class="code" href="res__musiconhold_8c.html#a62bb3c5f4e818b298c9a66a512822d75">mohalloc</a>(<span class="keyword">struct</span> <a class="code" href="structmohclass.html">mohclass</a> *cl)
<a name="l00798"></a>00798 {
<a name="l00799"></a>00799    <span class="keyword">struct </span>mohdata *<a class="code" href="chan__agent_8c.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>;
<a name="l00800"></a>00800    <span class="keywordtype">long</span> <a class="code" href="structmohclass.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>; 
<a name="l00801"></a>00801    
<a name="l00802"></a>00802    <span class="keywordflow">if</span> (!(moh = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*moh))))
<a name="l00803"></a>00803       <span class="keywordflow">return</span> NULL;
<a name="l00804"></a>00804    
<a name="l00805"></a>00805    <span class="keywordflow">if</span> (<a class="code" href="structmohdata.html#a67646b28a1d0efc1226de7291833b5ec">pipe</a>(moh-&gt;<a class="code" href="structmohdata.html#a67646b28a1d0efc1226de7291833b5ec">pipe</a>)) {
<a name="l00806"></a>00806       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to create pipe: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00807"></a>00807       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(moh);
<a name="l00808"></a>00808       <span class="keywordflow">return</span> NULL;
<a name="l00809"></a>00809    }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811    <span class="comment">/* Make entirely non-blocking */</span>
<a name="l00812"></a>00812    flags = fcntl(moh-&gt;<a class="code" href="structmohdata.html#a67646b28a1d0efc1226de7291833b5ec">pipe</a>[0], F_GETFL);
<a name="l00813"></a>00813    fcntl(moh-&gt;<a class="code" href="structmohdata.html#a67646b28a1d0efc1226de7291833b5ec">pipe</a>[0], F_SETFL, flags | O_NONBLOCK);
<a name="l00814"></a>00814    flags = fcntl(moh-&gt;<a class="code" href="structmohdata.html#a67646b28a1d0efc1226de7291833b5ec">pipe</a>[1], F_GETFL);
<a name="l00815"></a>00815    fcntl(moh-&gt;<a class="code" href="structmohdata.html#a67646b28a1d0efc1226de7291833b5ec">pipe</a>[1], F_SETFL, flags | O_NONBLOCK);
<a name="l00816"></a>00816 
<a name="l00817"></a>00817    moh-&gt;<a class="code" href="structmohdata.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>;
<a name="l00818"></a>00818    moh-&gt;<a class="code" href="structmohdata.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = cl-&gt;<a class="code" href="structmohclass.html#a317afff57d87a89158c2b038d37b2b08">format</a>;
<a name="l00819"></a>00819    moh-&gt;<a class="code" href="structmohdata.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821    moh-&gt;<a class="code" href="structmohdata.html#a1bd837db6069403d50229efd1848e2a3">parent</a> = <a class="code" href="res__musiconhold_8c.html#a837adf51399825c74e2d96602756d68c">mohclass_ref</a>(cl, <span class="stringliteral">&quot;Reffing music class for mohdata parent&quot;</span>);
<a name="l00822"></a>00822 
<a name="l00823"></a>00823    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(cl);
<a name="l00824"></a>00824    <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;cl-&gt;<a class="code" href="structmohclass.html#aff118ddddb0ad12a54ec5595f4662d09">members</a>, moh, list);
<a name="l00825"></a>00825    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(cl);
<a name="l00826"></a>00826    
<a name="l00827"></a>00827    <span class="keywordflow">return</span> moh;
<a name="l00828"></a>00828 }
<a name="l00829"></a>00829 
<a name="l00830"></a><a class="code" href="res__musiconhold_8c.html#a15a2f8f52bb02094278b3ed53916d0bf">00830</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__musiconhold_8c.html#a15a2f8f52bb02094278b3ed53916d0bf">moh_release</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00831"></a>00831 {
<a name="l00832"></a>00832    <span class="keyword">struct </span>mohdata *<a class="code" href="chan__agent_8c.html#a0f66f061490edf209d9ff6e2f18be109">moh</a> = data;
<a name="l00833"></a>00833    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class </span>= moh-&gt;parent;
<a name="l00834"></a>00834    <span class="keywordtype">int</span> oldwfmt;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<span class="keyword">class</span>);
<a name="l00837"></a>00837    <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;moh-&gt;<a class="code" href="structmohdata.html#a1bd837db6069403d50229efd1848e2a3">parent</a>-&gt;<a class="code" href="structmohclass.html#aff118ddddb0ad12a54ec5595f4662d09">members</a>, moh, list); 
<a name="l00838"></a>00838    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<span class="keyword">class</span>);
<a name="l00839"></a>00839    
<a name="l00840"></a>00840    close(moh-&gt;<a class="code" href="structmohdata.html#a67646b28a1d0efc1226de7291833b5ec">pipe</a>[0]);
<a name="l00841"></a>00841    close(moh-&gt;<a class="code" href="structmohdata.html#a67646b28a1d0efc1226de7291833b5ec">pipe</a>[1]);
<a name="l00842"></a>00842 
<a name="l00843"></a>00843    oldwfmt = moh-&gt;<a class="code" href="structmohdata.html#a5ef8e42d1eab1890f7eeb29e4af357eb">origwfmt</a>;
<a name="l00844"></a>00844 
<a name="l00845"></a>00845    moh-&gt;<a class="code" href="structmohdata.html#a1bd837db6069403d50229efd1848e2a3">parent</a> = <span class="keyword">class </span>= <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(class, &quot;unreffing moh-&gt;parent upon deactivation of generator&quot;);
<a name="l00846"></a>00846 
<a name="l00847"></a>00847    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(moh);
<a name="l00848"></a>00848 
<a name="l00849"></a>00849    <span class="keywordflow">if</span> (chan) {
<a name="l00850"></a>00850       <span class="keywordflow">if</span> (oldwfmt &amp;&amp; <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, oldwfmt)) {
<a name="l00851"></a>00851          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to restore channel &apos;%s&apos; to format %s\n&quot;</span>,
<a name="l00852"></a>00852                chan-&gt;name, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(oldwfmt));
<a name="l00853"></a>00853       }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Stopped music on hold on %s\n&quot;</span>, chan-&gt;name);
<a name="l00856"></a>00856    }
<a name="l00857"></a>00857 }
<a name="l00858"></a>00858 
<a name="l00859"></a><a class="code" href="res__musiconhold_8c.html#a44aac99ade1ef7d5bb30ac6203c88f24">00859</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="res__musiconhold_8c.html#a44aac99ade1ef7d5bb30ac6203c88f24">moh_alloc</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *params)
<a name="l00860"></a>00860 {
<a name="l00861"></a>00861    <span class="keyword">struct </span>mohdata *res;
<a name="l00862"></a>00862    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class </span>= params;
<a name="l00863"></a>00863    <span class="keyword">struct </span><a class="code" href="structmoh__files__state.html">moh_files_state</a> *<a class="code" href="structstate.html">state</a>;
<a name="l00864"></a>00864 
<a name="l00865"></a>00865    <span class="comment">/* Initiating music_state for current channel. Channel should know name of moh class */</span>
<a name="l00866"></a>00866    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a> &amp;&amp; (state = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*state)))) {
<a name="l00867"></a>00867       chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a> = state;
<a name="l00868"></a>00868       state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a> = <a class="code" href="res__musiconhold_8c.html#a837adf51399825c74e2d96602756d68c">mohclass_ref</a>(<span class="keyword">class</span>, <span class="stringliteral">&quot;Copying reference into state container&quot;</span>);
<a name="l00869"></a>00869       <a class="code" href="module_8h.html#aa08fcee0b390e15532dd03803c8728c4">ast_module_ref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l00870"></a>00870    } <span class="keywordflow">else</span>
<a name="l00871"></a>00871       state = chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a>;
<a name="l00872"></a>00872    <span class="keywordflow">if</span> (state &amp;&amp; state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a> != <span class="keyword">class</span>) {
<a name="l00873"></a>00873       memset(state, 0, <span class="keyword">sizeof</span>(*state));
<a name="l00874"></a>00874       state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a> = <span class="keyword">class</span>;
<a name="l00875"></a>00875    }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877    <span class="keywordflow">if</span> ((res = <a class="code" href="res__musiconhold_8c.html#a62bb3c5f4e818b298c9a66a512822d75">mohalloc</a>(<span class="keyword">class</span>))) {
<a name="l00878"></a>00878       res-&gt;<a class="code" href="structmohdata.html#a5ef8e42d1eab1890f7eeb29e4af357eb">origwfmt</a> = chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l00879"></a>00879       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, <a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a317afff57d87a89158c2b038d37b2b08">format</a>)) {
<a name="l00880"></a>00880          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set channel &apos;%s&apos; to format &apos;%s&apos;\n&quot;</span>, chan-&gt;name, <a class="code" href="frame_8h.html#ab492fdbd06591d26ff743d440cc0594f" title="Get a name from a format Gets a name from a format.">ast_codec2str</a>(<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a317afff57d87a89158c2b038d37b2b08">format</a>));
<a name="l00881"></a>00881          <a class="code" href="res__musiconhold_8c.html#a15a2f8f52bb02094278b3ed53916d0bf">moh_release</a>(NULL, res);
<a name="l00882"></a>00882          res = NULL;
<a name="l00883"></a>00883       }
<a name="l00884"></a>00884       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Started music on hold, class &apos;%s&apos;, on channel &apos;%s&apos;\n&quot;</span>, <a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>, chan-&gt;name);
<a name="l00885"></a>00885    }
<a name="l00886"></a>00886    <span class="keywordflow">return</span> res;
<a name="l00887"></a>00887 }
<a name="l00888"></a>00888 
<a name="l00889"></a><a class="code" href="res__musiconhold_8c.html#a79dd0a1d5ff281b87d63ccb3cf0cfc08">00889</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a79dd0a1d5ff281b87d63ccb3cf0cfc08">moh_generate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keywordtype">int</span> <a class="code" href="structmoh__files__state.html#a37672e6b906143604cefd3e959777b31">samples</a>)
<a name="l00890"></a>00890 {
<a name="l00891"></a>00891    <span class="keyword">struct </span>mohdata *<a class="code" href="chan__agent_8c.html#a0f66f061490edf209d9ff6e2f18be109">moh</a> = data;
<a name="l00892"></a>00892    <span class="keywordtype">short</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[1280 + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a> / 2];
<a name="l00893"></a>00893    <span class="keywordtype">int</span> res;
<a name="l00894"></a>00894 
<a name="l00895"></a>00895    len = <a class="code" href="frame_8h.html#ae147ae1521acd6b95bba6956078b2f34" title="Returns the number of bytes for the number of samples of the given format.">ast_codec_get_len</a>(moh-&gt;<a class="code" href="structmohdata.html#a1bd837db6069403d50229efd1848e2a3">parent</a>-&gt;<a class="code" href="structmohclass.html#a317afff57d87a89158c2b038d37b2b08">format</a>, samples);
<a name="l00896"></a>00896 
<a name="l00897"></a>00897    <span class="keywordflow">if</span> (len &gt; <span class="keyword">sizeof</span>(buf) - <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>) {
<a name="l00898"></a>00898       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Only doing %d of %d requested bytes on %s\n&quot;</span>, (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(buf), len, chan-&gt;name);
<a name="l00899"></a>00899       len = <span class="keyword">sizeof</span>(buf) - <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>;
<a name="l00900"></a>00900    }
<a name="l00901"></a>00901    res = read(moh-&gt;<a class="code" href="structmohdata.html#a67646b28a1d0efc1226de7291833b5ec">pipe</a>[0], buf + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>/2, len);
<a name="l00902"></a>00902    <span class="keywordflow">if</span> (res &lt;= 0)
<a name="l00903"></a>00903       <span class="keywordflow">return</span> 0;
<a name="l00904"></a>00904 
<a name="l00905"></a>00905    moh-&gt;<a class="code" href="structmohdata.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = res;
<a name="l00906"></a>00906    moh-&gt;<a class="code" href="structmohdata.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = buf + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a> / 2;
<a name="l00907"></a>00907    moh-&gt;<a class="code" href="structmohdata.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = <a class="code" href="frame_8h.html#aedec72ae8357bb6c334111f93d283713" title="Returns the number of samples contained in the frame.">ast_codec_get_samples</a>(&amp;moh-&gt;<a class="code" href="structmohdata.html#a735f764b1095611ace084e7c6c06857d">f</a>);
<a name="l00908"></a>00908 
<a name="l00909"></a>00909    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(chan, &amp;moh-&gt;<a class="code" href="structmohdata.html#a735f764b1095611ace084e7c6c06857d">f</a>) &lt; 0) {
<a name="l00910"></a>00910       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to write frame to &apos;%s&apos;: %s\n&quot;</span>, chan-&gt;name, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00911"></a>00911       <span class="keywordflow">return</span> -1;
<a name="l00912"></a>00912    }
<a name="l00913"></a>00913 
<a name="l00914"></a>00914    <span class="keywordflow">return</span> 0;
<a name="l00915"></a>00915 }
<a name="l00916"></a>00916 
<a name="l00917"></a><a class="code" href="res__musiconhold_8c.html#a2428c6c3324c4f30dbf2f8933135d959">00917</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__generator.html">ast_generator</a> <a class="code" href="res__musiconhold_8c.html#a2428c6c3324c4f30dbf2f8933135d959">mohgen</a> = {
<a name="l00918"></a>00918    .<a class="code" href="structast__generator.html#a4cdb1ccb0ee9d0a97af1862c625e6bc8">alloc</a>    = <a class="code" href="res__musiconhold_8c.html#a44aac99ade1ef7d5bb30ac6203c88f24">moh_alloc</a>,
<a name="l00919"></a>00919    .release  = <a class="code" href="res__musiconhold_8c.html#a15a2f8f52bb02094278b3ed53916d0bf">moh_release</a>,
<a name="l00920"></a>00920    .generate = <a class="code" href="res__musiconhold_8c.html#a79dd0a1d5ff281b87d63ccb3cf0cfc08">moh_generate</a>,
<a name="l00921"></a>00921    .digit    = <a class="code" href="res__musiconhold_8c.html#a1dd51b9e4184fc66f8f823a2bd6c4bf9">moh_handle_digit</a>,
<a name="l00922"></a>00922 };
<a name="l00923"></a>00923 
<a name="l00924"></a><a class="code" href="res__musiconhold_8c.html#a1788f2ea3f56bb97d5c46d22839b20c2">00924</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a1788f2ea3f56bb97d5c46d22839b20c2">moh_add_file</a>(<span class="keyword">struct</span> <a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *filepath)
<a name="l00925"></a>00925 {
<a name="l00926"></a>00926    <span class="keywordflow">if</span> (!class-&gt;allowed_files) {
<a name="l00927"></a>00927       <span class="keywordflow">if</span> (!(class-&gt;filearray = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <a class="code" href="res__musiconhold_8c.html#a8677bd3f55d6db9157da91f3f556beeb">INITIAL_NUM_FILES</a> * <span class="keyword">sizeof</span>(*class-&gt;filearray))))
<a name="l00928"></a>00928          <span class="keywordflow">return</span> -1;
<a name="l00929"></a>00929       <span class="keyword">class</span>-&gt;allowed_files = <a class="code" href="res__musiconhold_8c.html#a8677bd3f55d6db9157da91f3f556beeb">INITIAL_NUM_FILES</a>;
<a name="l00930"></a>00930    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (class-&gt;total_files == class-&gt;allowed_files) {
<a name="l00931"></a>00931       <span class="keywordflow">if</span> (!(class-&gt;filearray = <a class="code" href="astmm_8h.html#aa852314efa0cfeecee97ffc51b649734">ast_realloc</a>(class-&gt;filearray, class-&gt;allowed_files * <span class="keyword">sizeof</span>(*class-&gt;filearray) * 2))) {
<a name="l00932"></a>00932          <span class="keyword">class</span>-&gt;allowed_files = 0;
<a name="l00933"></a>00933          <span class="keyword">class</span>-&gt;total_files = 0;
<a name="l00934"></a>00934          <span class="keywordflow">return</span> -1;
<a name="l00935"></a>00935       }
<a name="l00936"></a>00936       <span class="keyword">class</span>-&gt;allowed_files *= 2;
<a name="l00937"></a>00937    }
<a name="l00938"></a>00938 
<a name="l00939"></a>00939    <span class="keywordflow">if</span> (!(class-&gt;filearray[class-&gt;total_files] = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(filepath)))
<a name="l00940"></a>00940       <span class="keywordflow">return</span> -1;
<a name="l00941"></a>00941 
<a name="l00942"></a>00942    <span class="keyword">class</span>-&gt;total_files++;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944    <span class="keywordflow">return</span> 0;
<a name="l00945"></a>00945 }
<a name="l00946"></a>00946 
<a name="l00947"></a><a class="code" href="res__musiconhold_8c.html#a328127b26ed523d252a63a758412f387">00947</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a328127b26ed523d252a63a758412f387">moh_sort_compare</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *i1, <span class="keyword">const</span> <span class="keywordtype">void</span> *i2)
<a name="l00948"></a>00948 {
<a name="l00949"></a>00949    <span class="keywordtype">char</span> *s1, *s2;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951    s1 = ((<span class="keywordtype">char</span> **)i1)[0];
<a name="l00952"></a>00952    s2 = ((<span class="keywordtype">char</span> **)i2)[0];
<a name="l00953"></a>00953 
<a name="l00954"></a>00954    <span class="keywordflow">return</span> strcasecmp(s1, s2);
<a name="l00955"></a>00955 }
<a name="l00956"></a>00956 
<a name="l00957"></a><a class="code" href="res__musiconhold_8c.html#a587e0538fac924934573a153ad7a6f7e">00957</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a587e0538fac924934573a153ad7a6f7e">moh_scan_files</a>(<span class="keyword">struct</span> <a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class</span>) {
<a name="l00958"></a>00958 
<a name="l00959"></a>00959    DIR *files_DIR;
<a name="l00960"></a>00960    <span class="keyword">struct </span>dirent *files_dirent;
<a name="l00961"></a>00961    <span class="keywordtype">char</span> dir_path[PATH_MAX];
<a name="l00962"></a>00962    <span class="keywordtype">char</span> path[PATH_MAX];
<a name="l00963"></a>00963    <span class="keywordtype">char</span> filepath[PATH_MAX];
<a name="l00964"></a>00964    <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>;
<a name="l00965"></a>00965    <span class="keyword">struct </span>stat statbuf;
<a name="l00966"></a>00966    <span class="keywordtype">int</span> dirnamelen;
<a name="l00967"></a>00967    <span class="keywordtype">int</span> i;
<a name="l00968"></a>00968 
<a name="l00969"></a>00969    <span class="keywordflow">if</span> (class-&gt;dir[0] != <span class="charliteral">&apos;/&apos;</span>) {
<a name="l00970"></a>00970       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dir_path, <a class="code" href="paths_8h.html#ab6e1cd3d774ab1b31836a8777d3a812d">ast_config_AST_VAR_DIR</a>, <span class="keyword">sizeof</span>(dir_path));
<a name="l00971"></a>00971       strncat(dir_path, <span class="stringliteral">&quot;/&quot;</span>, <span class="keyword">sizeof</span>(dir_path) - 1);
<a name="l00972"></a>00972       strncat(dir_path, class-&gt;dir, <span class="keyword">sizeof</span>(dir_path) - 1);
<a name="l00973"></a>00973    } <span class="keywordflow">else</span> {
<a name="l00974"></a>00974       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dir_path, class-&gt;dir, <span class="keyword">sizeof</span>(dir_path));
<a name="l00975"></a>00975    }
<a name="l00976"></a>00976    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;Scanning &apos;%s&apos; for files for class &apos;%s&apos;\n&quot;</span>, dir_path, class-&gt;name);
<a name="l00977"></a>00977    files_DIR = opendir(dir_path);
<a name="l00978"></a>00978    <span class="keywordflow">if</span> (!files_DIR) {
<a name="l00979"></a>00979       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot open dir %s or dir does not exist\n&quot;</span>, dir_path);
<a name="l00980"></a>00980       <span class="keywordflow">return</span> -1;
<a name="l00981"></a>00981    }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983    <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">class</span>-&gt;total_files; i++)
<a name="l00984"></a>00984       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(class-&gt;filearray[i]);
<a name="l00985"></a>00985 
<a name="l00986"></a>00986    <span class="keyword">class</span>-&gt;total_files = 0;
<a name="l00987"></a>00987    dirnamelen = strlen(dir_path) + 2;
<a name="l00988"></a>00988    <span class="keywordflow">if</span> (!getcwd(path, <span class="keyword">sizeof</span>(path))) {
<a name="l00989"></a>00989       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;getcwd() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00990"></a>00990       <span class="keywordflow">return</span> -1;
<a name="l00991"></a>00991    }
<a name="l00992"></a>00992    <span class="keywordflow">if</span> (chdir(dir_path) &lt; 0) {
<a name="l00993"></a>00993       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;chdir() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00994"></a>00994       <span class="keywordflow">return</span> -1;
<a name="l00995"></a>00995    }
<a name="l00996"></a>00996    <span class="keywordflow">while</span> ((files_dirent = readdir(files_DIR))) {
<a name="l00997"></a>00997       <span class="comment">/* The file name must be at least long enough to have the file type extension */</span>
<a name="l00998"></a>00998       <span class="keywordflow">if</span> ((strlen(files_dirent-&gt;d_name) &lt; 4))
<a name="l00999"></a>00999          <span class="keywordflow">continue</span>;
<a name="l01000"></a>01000 
<a name="l01001"></a>01001       <span class="comment">/* Skip files that starts with a dot */</span>
<a name="l01002"></a>01002       <span class="keywordflow">if</span> (files_dirent-&gt;d_name[0] == <span class="charliteral">&apos;.&apos;</span>)
<a name="l01003"></a>01003          <span class="keywordflow">continue</span>;
<a name="l01004"></a>01004 
<a name="l01005"></a>01005       <span class="comment">/* Skip files without extensions... they are not audio */</span>
<a name="l01006"></a>01006       <span class="keywordflow">if</span> (!strchr(files_dirent-&gt;d_name, <span class="charliteral">&apos;.&apos;</span>))
<a name="l01007"></a>01007          <span class="keywordflow">continue</span>;
<a name="l01008"></a>01008 
<a name="l01009"></a>01009       snprintf(filepath, <span class="keyword">sizeof</span>(filepath), <span class="stringliteral">&quot;%s/%s&quot;</span>, dir_path, files_dirent-&gt;d_name);
<a name="l01010"></a>01010 
<a name="l01011"></a>01011       <span class="keywordflow">if</span> (stat(filepath, &amp;statbuf))
<a name="l01012"></a>01012          <span class="keywordflow">continue</span>;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014       <span class="keywordflow">if</span> (!S_ISREG(statbuf.st_mode))
<a name="l01015"></a>01015          <span class="keywordflow">continue</span>;
<a name="l01016"></a>01016 
<a name="l01017"></a>01017       <span class="keywordflow">if</span> ((ext = strrchr(filepath, <span class="charliteral">&apos;.&apos;</span>)))
<a name="l01018"></a>01018          *ext = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01019"></a>01019 
<a name="l01020"></a>01020       <span class="comment">/* if the file is present in multiple formats, ensure we only put it into the list once */</span>
<a name="l01021"></a>01021       <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">class</span>-&gt;total_files; i++)
<a name="l01022"></a>01022          <span class="keywordflow">if</span> (!strcmp(filepath, class-&gt;filearray[i]))
<a name="l01023"></a>01023             <span class="keywordflow">break</span>;
<a name="l01024"></a>01024 
<a name="l01025"></a>01025       <span class="keywordflow">if</span> (i == class-&gt;total_files) {
<a name="l01026"></a>01026          <span class="keywordflow">if</span> (<a class="code" href="res__musiconhold_8c.html#a1788f2ea3f56bb97d5c46d22839b20c2">moh_add_file</a>(<span class="keyword">class</span>, filepath))
<a name="l01027"></a>01027             <span class="keywordflow">break</span>;
<a name="l01028"></a>01028       }
<a name="l01029"></a>01029    }
<a name="l01030"></a>01030 
<a name="l01031"></a>01031    closedir(files_DIR);
<a name="l01032"></a>01032    <span class="keywordflow">if</span> (chdir(path) &lt; 0) {
<a name="l01033"></a>01033       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;chdir() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01034"></a>01034       <span class="keywordflow">return</span> -1;
<a name="l01035"></a>01035    }
<a name="l01036"></a>01036    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#a81ae754573bd2c0d252b398313601fcf">MOH_SORTALPHA</a>))
<a name="l01037"></a>01037       qsort(&amp;class-&gt;filearray[0], class-&gt;total_files, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *), <a class="code" href="res__musiconhold_8c.html#a328127b26ed523d252a63a758412f387">moh_sort_compare</a>);
<a name="l01038"></a>01038    <span class="keywordflow">return</span> <span class="keyword">class</span>-&gt;total_files;
<a name="l01039"></a>01039 }
<a name="l01040"></a>01040 
<a name="l01041"></a><a class="code" href="res__musiconhold_8c.html#a60b3b2e888cfc21530ab9aaca95abd6f">01041</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a60b3b2e888cfc21530ab9aaca95abd6f">init_files_class</a>(<span class="keyword">struct</span> <a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class</span>)
<a name="l01042"></a>01042 {
<a name="l01043"></a>01043    <span class="keywordtype">int</span> res;
<a name="l01044"></a>01044 
<a name="l01045"></a>01045    res = <a class="code" href="res__musiconhold_8c.html#a587e0538fac924934573a153ad7a6f7e">moh_scan_files</a>(<span class="keyword">class</span>);
<a name="l01046"></a>01046 
<a name="l01047"></a>01047    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01048"></a>01048       <span class="keywordflow">return</span> -1;
<a name="l01049"></a>01049    }
<a name="l01050"></a>01050 
<a name="l01051"></a>01051    <span class="keywordflow">if</span> (!res) {
<a name="l01052"></a>01052       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">option_verbose</a> &gt; 2) {
<a name="l01053"></a>01053          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<a class="code" href="logger_8h.html#a24b0f46e22f4ea3226fa082e955dd4ef">VERBOSE_PREFIX_3</a> <span class="stringliteral">&quot;Files not found in %s for moh class:%s\n&quot;</span>,
<a name="l01054"></a>01054                class-&gt;dir, class-&gt;name);
<a name="l01055"></a>01055       }
<a name="l01056"></a>01056       <span class="keywordflow">return</span> -1;
<a name="l01057"></a>01057    }
<a name="l01058"></a>01058 
<a name="l01059"></a>01059    <span class="keywordflow">if</span> (strchr(class-&gt;args, <span class="charliteral">&apos;r&apos;</span>)) {
<a name="l01060"></a>01060       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#a47622ed8ba1100fc57a944cef6a485eb">MOH_RANDOMIZE</a>);
<a name="l01061"></a>01061    }
<a name="l01062"></a>01062 
<a name="l01063"></a>01063    <span class="keywordflow">return</span> 0;
<a name="l01064"></a>01064 }
<a name="l01065"></a>01065 
<a name="l01066"></a>01066 
<a name="l01067"></a><a class="code" href="res__musiconhold_8c.html#a6d8518cbb26dbbbcda8dd824c990f02c">01067</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a6d8518cbb26dbbbcda8dd824c990f02c">moh_diff</a>(<span class="keyword">struct</span> <a class="code" href="structmohclass.html">mohclass</a> *old, <span class="keyword">struct</span> <a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">new</span>)
<a name="l01068"></a>01068 {
<a name="l01069"></a>01069    <span class="keywordflow">if</span> (!old || !<span class="keyword">new</span>) {
<a name="l01070"></a>01070       <span class="keywordflow">return</span> -1;
<a name="l01071"></a>01071    }
<a name="l01072"></a>01072 
<a name="l01073"></a>01073    <span class="keywordflow">if</span> (strcmp(old-&gt;<a class="code" href="structmohclass.html#a4a55f3eac855c94cd30d3f16c3f83fb7">dir</a>, new-&gt;dir)) {
<a name="l01074"></a>01074       <span class="keywordflow">return</span> -1;
<a name="l01075"></a>01075    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(old-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, new-&gt;mode)) {
<a name="l01076"></a>01076       <span class="keywordflow">return</span> -1;
<a name="l01077"></a>01077    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(old-&gt;<a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>, new-&gt;args)) {
<a name="l01078"></a>01078       <span class="keywordflow">return</span> -1;
<a name="l01079"></a>01079    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (old-&gt;<a class="code" href="structmohclass.html#ac92588540e8c1d014a08cd8a45462b19">flags</a> != new-&gt;flags) {
<a name="l01080"></a>01080       <span class="keywordflow">return</span> -1;
<a name="l01081"></a>01081    }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083    <span class="keywordflow">return</span> 0;
<a name="l01084"></a>01084 }
<a name="l01085"></a>01085 
<a name="l01086"></a><a class="code" href="res__musiconhold_8c.html#a5ed78875899347da1a29ce18606bb12b">01086</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a5ed78875899347da1a29ce18606bb12b">init_app_class</a>(<span class="keyword">struct</span> <a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class</span>)
<a name="l01087"></a>01087 {
<a name="l01088"></a>01088 <span class="preprocessor">#ifdef HAVE_DAHDI</span>
<a name="l01089"></a>01089 <span class="preprocessor"></span>   <span class="keywordtype">int</span> x;
<a name="l01090"></a>01090 <span class="preprocessor">#endif</span>
<a name="l01091"></a>01091 <span class="preprocessor"></span>
<a name="l01092"></a>01092    <span class="keywordflow">if</span> (!strcasecmp(class-&gt;mode, <span class="stringliteral">&quot;custom&quot;</span>)) {
<a name="l01093"></a>01093       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#a2eff543e703f0fb49f655f760312e291">MOH_CUSTOM</a>);
<a name="l01094"></a>01094    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(class-&gt;mode, <span class="stringliteral">&quot;mp3nb&quot;</span>)) {
<a name="l01095"></a>01095       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#acb4a79e9b83147f8ab6a7ada46071740">MOH_SINGLE</a>);
<a name="l01096"></a>01096    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(class-&gt;mode, <span class="stringliteral">&quot;quietmp3nb&quot;</span>)) {
<a name="l01097"></a>01097       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#acb4a79e9b83147f8ab6a7ada46071740">MOH_SINGLE</a> | <a class="code" href="res__musiconhold_8c.html#a35d37162b1781f830c686da44c0c9a9d">MOH_QUIET</a>);
<a name="l01098"></a>01098    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(class-&gt;mode, <span class="stringliteral">&quot;quietmp3&quot;</span>)) {
<a name="l01099"></a>01099       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#a35d37162b1781f830c686da44c0c9a9d">MOH_QUIET</a>);
<a name="l01100"></a>01100    }
<a name="l01101"></a>01101       
<a name="l01102"></a>01102    <span class="keyword">class</span>-&gt;srcfd = -1;
<a name="l01103"></a>01103    <span class="keyword">class</span>-&gt;pseudofd = -1;
<a name="l01104"></a>01104 
<a name="l01105"></a>01105 <span class="preprocessor">#ifdef HAVE_DAHDI</span>
<a name="l01106"></a>01106 <span class="preprocessor"></span>   <span class="comment">/* Open /dev/zap/pseudo for timing...  Is</span>
<a name="l01107"></a>01107 <span class="comment">      there a better, yet reliable way to do this? */</span>
<a name="l01108"></a>01108    <span class="keyword">class</span>-&gt;pseudofd = open(<span class="stringliteral">&quot;/dev/dahdi/pseudo&quot;</span>, O_RDONLY);
<a name="l01109"></a>01109    <span class="keywordflow">if</span> (class-&gt;pseudofd &lt; 0) {
<a name="l01110"></a>01110       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open pseudo channel for timing...  Sound may be choppy.\n&quot;</span>);
<a name="l01111"></a>01111    } <span class="keywordflow">else</span> {
<a name="l01112"></a>01112       x = 320;
<a name="l01113"></a>01113       ioctl(class-&gt;pseudofd, DAHDI_SET_BLOCKSIZE, &amp;x);
<a name="l01114"></a>01114    }
<a name="l01115"></a>01115 <span class="preprocessor">#endif</span>
<a name="l01116"></a>01116 <span class="preprocessor"></span>
<a name="l01117"></a>01117    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;class-&gt;thread, NULL, <a class="code" href="res__musiconhold_8c.html#af7c7c2858fee7838706a4cd3163f2ad1">monmp3thread</a>, <span class="keyword">class</span>)) {
<a name="l01118"></a>01118       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create moh thread...\n&quot;</span>);
<a name="l01119"></a>01119       <span class="keywordflow">if</span> (class-&gt;pseudofd &gt; -1) {
<a name="l01120"></a>01120          close(class-&gt;pseudofd);
<a name="l01121"></a>01121          <span class="keyword">class</span>-&gt;pseudofd = -1;
<a name="l01122"></a>01122       }
<a name="l01123"></a>01123       <span class="keywordflow">return</span> -1;
<a name="l01124"></a>01124    }
<a name="l01125"></a>01125 
<a name="l01126"></a>01126    <span class="keywordflow">return</span> 0;
<a name="l01127"></a>01127 }
<a name="l01128"></a>01128 <span class="comment"></span>
<a name="l01129"></a>01129 <span class="comment">/*!</span>
<a name="l01130"></a>01130 <span class="comment"> * \note This function owns the reference it gets to moh if unref is true</span>
<a name="l01131"></a>01131 <span class="comment"> */</span>
<a name="l01132"></a><a class="code" href="res__musiconhold_8c.html#abee0f1450f8e48a15361f2f651907156">01132</a> <span class="preprocessor">#define moh_register(a,b,c)   _moh_register(a,b,c,__FILE__,__LINE__,__PRETTY_FUNCTION__)</span>
<a name="l01133"></a><a class="code" href="res__musiconhold_8c.html#a4d522036769978e755ef029333db5711">01133</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a4d522036769978e755ef029333db5711">_moh_register</a>(<span class="keyword">struct</span> <a class="code" href="structmohclass.html">mohclass</a> *<a class="code" href="chan__agent_8c.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>, <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>, <span class="keywordtype">int</span> unref, <span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> line, <span class="keyword">const</span> <span class="keywordtype">char</span> *funcname)
<a name="l01134"></a>01134 {
<a name="l01135"></a>01135    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<a class="code" href="structmohclass.html">mohclass</a> = NULL;
<a name="l01136"></a>01136 
<a name="l01137"></a>01137    <span class="keywordflow">if</span> ((mohclass = <a class="code" href="res__musiconhold_8c.html#a8828a2f647293fd1b6b317dddcb0c487">_get_mohbyname</a>(moh-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>, 0, <a class="code" href="res__musiconhold_8c.html#ad5d15309259ebc26964f94f4cbf11dae">MOH_NOTDELETED</a>, file, line, funcname)) &amp;&amp; !<a class="code" href="res__musiconhold_8c.html#a6d8518cbb26dbbbcda8dd824c990f02c">moh_diff</a>(mohclass, moh)) {
<a name="l01138"></a>01138       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Music on Hold class &apos;%s&apos; already exists\n&quot;</span>, moh-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>);
<a name="l01139"></a>01139       mohclass = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(mohclass, <span class="stringliteral">&quot;unreffing mohclass we just found by name&quot;</span>);
<a name="l01140"></a>01140       <span class="keywordflow">if</span> (unref) {
<a name="l01141"></a>01141          moh = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(moh, <span class="stringliteral">&quot;unreffing potential new moh class (it is a duplicate)&quot;</span>);
<a name="l01142"></a>01142       }
<a name="l01143"></a>01143       <span class="keywordflow">return</span> -1;
<a name="l01144"></a>01144    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mohclass) {
<a name="l01145"></a>01145       <span class="comment">/* Found a class, but it&apos;s different from the one being registered */</span>
<a name="l01146"></a>01146       mohclass = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(mohclass, <span class="stringliteral">&quot;unreffing mohclass we just found by name&quot;</span>);
<a name="l01147"></a>01147    }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149    time(&amp;moh-&gt;<a class="code" href="structmohclass.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>);
<a name="l01150"></a>01150    moh-&gt;<a class="code" href="structmohclass.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a> -= respawn_time;
<a name="l01151"></a>01151    
<a name="l01152"></a>01152    <span class="keywordflow">if</span> (!strcasecmp(moh-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;files&quot;</span>)) {
<a name="l01153"></a>01153       <span class="keywordflow">if</span> (<a class="code" href="res__musiconhold_8c.html#a60b3b2e888cfc21530ab9aaca95abd6f">init_files_class</a>(moh)) {
<a name="l01154"></a>01154          <span class="keywordflow">if</span> (unref) {
<a name="l01155"></a>01155             moh = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(moh, <span class="stringliteral">&quot;unreffing potential new moh class (init_files_class failed)&quot;</span>);
<a name="l01156"></a>01156          }
<a name="l01157"></a>01157          <span class="keywordflow">return</span> -1;
<a name="l01158"></a>01158       }
<a name="l01159"></a>01159    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(moh-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;mp3&quot;</span>) || !strcasecmp(moh-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;mp3nb&quot;</span>) || 
<a name="l01160"></a>01160          !strcasecmp(moh-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;quietmp3&quot;</span>) || !strcasecmp(moh-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;quietmp3nb&quot;</span>) || 
<a name="l01161"></a>01161          !strcasecmp(moh-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;httpmp3&quot;</span>) || !strcasecmp(moh-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;custom&quot;</span>)) {
<a name="l01162"></a>01162       <span class="keywordflow">if</span> (<a class="code" href="res__musiconhold_8c.html#a5ed78875899347da1a29ce18606bb12b">init_app_class</a>(moh)) {
<a name="l01163"></a>01163          <span class="keywordflow">if</span> (unref) {
<a name="l01164"></a>01164             moh = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(moh, <span class="stringliteral">&quot;unreffing potential new moh class (init_app_class_failed)&quot;</span>);
<a name="l01165"></a>01165          }
<a name="l01166"></a>01166          <span class="keywordflow">return</span> -1;
<a name="l01167"></a>01167       }
<a name="l01168"></a>01168    } <span class="keywordflow">else</span> {
<a name="l01169"></a>01169       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Don&apos;t know how to do a mode &apos;%s&apos; music on hold\n&quot;</span>, moh-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>);
<a name="l01170"></a>01170       <span class="keywordflow">if</span> (unref) {
<a name="l01171"></a>01171          moh = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(moh, <span class="stringliteral">&quot;unreffing potential new moh class (unknown mode)&quot;</span>);
<a name="l01172"></a>01172       }
<a name="l01173"></a>01173       <span class="keywordflow">return</span> -1;
<a name="l01174"></a>01174    }
<a name="l01175"></a>01175 
<a name="l01176"></a>01176    <a class="code" href="astobj2_8h.html#adc3c0db3563654f7f71244961a4479dd" title="Add an object to a container.">ao2_t_link</a>(mohclasses, moh, <span class="stringliteral">&quot;Adding class to container&quot;</span>);
<a name="l01177"></a>01177 
<a name="l01178"></a>01178    <span class="keywordflow">if</span> (unref) {
<a name="l01179"></a>01179       moh = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(moh, <span class="stringliteral">&quot;Unreffing new moh class because we just added it to the container&quot;</span>);
<a name="l01180"></a>01180    }
<a name="l01181"></a>01181    
<a name="l01182"></a>01182    <span class="keywordflow">return</span> 0;
<a name="l01183"></a>01183 }
<a name="l01184"></a>01184 
<a name="l01185"></a><a class="code" href="res__musiconhold_8c.html#ae3373fcd30d3294aac1893975eef851b">01185</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__musiconhold_8c.html#ae3373fcd30d3294aac1893975eef851b">local_ast_moh_cleanup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)
<a name="l01186"></a>01186 {
<a name="l01187"></a>01187    <span class="keyword">struct </span><a class="code" href="structmoh__files__state.html">moh_files_state</a> *<a class="code" href="structstate.html">state</a> = chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a>;
<a name="l01188"></a>01188 
<a name="l01189"></a>01189    <span class="keywordflow">if</span> (state) {
<a name="l01190"></a>01190       <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>) {
<a name="l01191"></a>01191          state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a> = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>, <span class="stringliteral">&quot;Channel MOH state destruction&quot;</span>);
<a name="l01192"></a>01192       }
<a name="l01193"></a>01193       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a>);
<a name="l01194"></a>01194       chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a> = NULL;
<a name="l01195"></a>01195       <span class="comment">/* Only held a module reference if we had a music state */</span>
<a name="l01196"></a>01196       <a class="code" href="module_8h.html#ac65fa15b16dbc563a2424af744ab003d">ast_module_unref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l01197"></a>01197    }
<a name="l01198"></a>01198 }
<a name="l01199"></a>01199 
<a name="l01200"></a>01200 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__musiconhold_8c.html#aba4e08833be2bc1bd7e5b98e345bc6ce">moh_class_destructor</a>(<span class="keywordtype">void</span> *obj);
<a name="l01201"></a>01201 
<a name="l01202"></a><a class="code" href="res__musiconhold_8c.html#a6775781a88ec94d713fe92bc7f8ef3dd">01202</a> <span class="preprocessor">#define moh_class_malloc() _moh_class_malloc(__FILE__,__LINE__,__PRETTY_FUNCTION__)</span>
<a name="l01203"></a>01203 <span class="preprocessor"></span>
<a name="l01204"></a><a class="code" href="res__musiconhold_8c.html#aedc98dd3ab3bdda3e859898f836e2aa1">01204</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<a class="code" href="res__musiconhold_8c.html#aedc98dd3ab3bdda3e859898f836e2aa1">_moh_class_malloc</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> line, <span class="keyword">const</span> <span class="keywordtype">char</span> *funcname)
<a name="l01205"></a>01205 {
<a name="l01206"></a>01206    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class</span>;
<a name="l01207"></a>01207 
<a name="l01208"></a>01208    <span class="keywordflow">if</span> ((<span class="keyword">class</span> =
<a name="l01209"></a>01209 #ifdef REF_DEBUG
<a name="l01210"></a>01210          <a class="code" href="astobj2_8h.html#acaa3595d4023693e24ae4b5bb5fe1372">_ao2_alloc_debug</a>(<span class="keyword">sizeof</span>(*<span class="keyword">class</span>), <a class="code" href="res__musiconhold_8c.html#aba4e08833be2bc1bd7e5b98e345bc6ce">moh_class_destructor</a>, <span class="stringliteral">&quot;Allocating new moh class&quot;</span>, file, line, funcname, 1)
<a name="l01211"></a>01211 #elif defined(<a class="code" href="astmm_8h.html#a0b9e80daa0c5b56b735a14d697ebf6c5">__AST_DEBUG_MALLOC</a>)
<a name="l01212"></a>01212          <a class="code" href="astobj2_8h.html#acaa3595d4023693e24ae4b5bb5fe1372">_ao2_alloc_debug</a>(<span class="keyword">sizeof</span>(*<span class="keyword">class</span>), <a class="code" href="res__musiconhold_8c.html#aba4e08833be2bc1bd7e5b98e345bc6ce">moh_class_destructor</a>, <span class="stringliteral">&quot;Allocating new moh class&quot;</span>, file, line, funcname, 0)
<a name="l01213"></a>01213 #<span class="keywordflow">else</span>
<a name="l01214"></a>01214          <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*<span class="keyword">class</span>), <a class="code" href="res__musiconhold_8c.html#aba4e08833be2bc1bd7e5b98e345bc6ce">moh_class_destructor</a>)
<a name="l01215"></a>01215 #endif
<a name="l01216"></a>01216       )) {
<a name="l01217"></a>01217       <span class="keyword">class</span>-&gt;<a class="code" href="structmohclass.html#a317afff57d87a89158c2b038d37b2b08">format</a> = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l01218"></a>01218    }
<a name="l01219"></a>01219 
<a name="l01220"></a>01220    <span class="keywordflow">return</span> <span class="keyword">class</span>;
<a name="l01221"></a>01221 }
<a name="l01222"></a>01222 
<a name="l01223"></a><a class="code" href="res__musiconhold_8c.html#af0b92f70cc027687abfc34228a488c8f">01223</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#af0b92f70cc027687abfc34228a488c8f">local_ast_moh_start</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *mclass, <span class="keyword">const</span> <span class="keywordtype">char</span> *interpclass)
<a name="l01224"></a>01224 {
<a name="l01225"></a>01225    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<a class="code" href="structmohclass.html">mohclass</a> = NULL;
<a name="l01226"></a>01226    <span class="keyword">struct </span><a class="code" href="structmoh__files__state.html">moh_files_state</a> *<a class="code" href="structstate.html">state</a> = chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a>;
<a name="l01227"></a>01227    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a> = NULL;
<a name="l01228"></a>01228    <span class="keywordtype">int</span> res;
<a name="l01229"></a>01229    <span class="keywordtype">int</span> realtime_possible = <a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;musiconhold&quot;</span>);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231    <span class="comment">/* The following is the order of preference for which class to use:</span>
<a name="l01232"></a>01232 <span class="comment">    * 1) The channels explicitly set musicclass, which should *only* be</span>
<a name="l01233"></a>01233 <span class="comment">    *    set by a call to Set(CHANNEL(musicclass)=whatever) in the dialplan.</span>
<a name="l01234"></a>01234 <span class="comment">    * 2) The mclass argument. If a channel is calling ast_moh_start() as the</span>
<a name="l01235"></a>01235 <span class="comment">    *    result of receiving a HOLD control frame, this should be the</span>
<a name="l01236"></a>01236 <span class="comment">    *    payload that came with the frame.</span>
<a name="l01237"></a>01237 <span class="comment">    * 3) The interpclass argument. This would be from the mohinterpret</span>
<a name="l01238"></a>01238 <span class="comment">    *    option from channel drivers. This is the same as the old musicclass</span>
<a name="l01239"></a>01239 <span class="comment">    *    option.</span>
<a name="l01240"></a>01240 <span class="comment">    * 4) The default class.</span>
<a name="l01241"></a>01241 <span class="comment">    */</span>
<a name="l01242"></a>01242    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan-&gt;musicclass)) {
<a name="l01243"></a>01243       mohclass = <a class="code" href="res__musiconhold_8c.html#a3d6bd423c91a036598151be18001cf73">get_mohbyname</a>(chan-&gt;musicclass, 1, 0);
<a name="l01244"></a>01244       <span class="keywordflow">if</span> (!mohclass &amp;&amp; realtime_possible) {
<a name="l01245"></a>01245          var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;musiconhold&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, chan-&gt;musicclass, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l01246"></a>01246       }
<a name="l01247"></a>01247    }
<a name="l01248"></a>01248    <span class="keywordflow">if</span> (!mohclass &amp;&amp; !var &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mclass)) {
<a name="l01249"></a>01249       mohclass = <a class="code" href="res__musiconhold_8c.html#a3d6bd423c91a036598151be18001cf73">get_mohbyname</a>(mclass, 1, 0);
<a name="l01250"></a>01250       <span class="keywordflow">if</span> (!mohclass &amp;&amp; realtime_possible) {
<a name="l01251"></a>01251          var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;musiconhold&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, mclass, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l01252"></a>01252       }
<a name="l01253"></a>01253    }
<a name="l01254"></a>01254    <span class="keywordflow">if</span> (!mohclass &amp;&amp; !var &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(interpclass)) {
<a name="l01255"></a>01255       mohclass = <a class="code" href="res__musiconhold_8c.html#a3d6bd423c91a036598151be18001cf73">get_mohbyname</a>(interpclass, 1, 0);
<a name="l01256"></a>01256       <span class="keywordflow">if</span> (!mohclass &amp;&amp; realtime_possible) {
<a name="l01257"></a>01257          var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;musiconhold&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, interpclass, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l01258"></a>01258       }
<a name="l01259"></a>01259    }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261    <span class="keywordflow">if</span> (!mohclass &amp;&amp; !var) {
<a name="l01262"></a>01262       mohclass = <a class="code" href="res__musiconhold_8c.html#a3d6bd423c91a036598151be18001cf73">get_mohbyname</a>(<span class="stringliteral">&quot;default&quot;</span>, 1, 0);
<a name="l01263"></a>01263       <span class="keywordflow">if</span> (!mohclass &amp;&amp; realtime_possible) {
<a name="l01264"></a>01264          var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;musiconhold&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;default&quot;</span>, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l01265"></a>01265       }
<a name="l01266"></a>01266    }
<a name="l01267"></a>01267 
<a name="l01268"></a>01268    <span class="comment">/* If no moh class found in memory, then check RT. Note that the logic used</span>
<a name="l01269"></a>01269 <span class="comment">    * above guarantees that if var is non-NULL, then mohclass must be NULL.</span>
<a name="l01270"></a>01270 <span class="comment">    */</span>
<a name="l01271"></a>01271    <span class="keywordflow">if</span> (var) {
<a name="l01272"></a>01272       <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *tmp = NULL;
<a name="l01273"></a>01273 
<a name="l01274"></a>01274       <span class="keywordflow">if</span> ((mohclass = <a class="code" href="res__musiconhold_8c.html#a6775781a88ec94d713fe92bc7f8ef3dd">moh_class_malloc</a>())) {
<a name="l01275"></a>01275          mohclass-&gt;<a class="code" href="structmohclass.html#aac1ae37fa4007496a50df75cf1f698c1">realtime</a> = 1;
<a name="l01276"></a>01276          <span class="keywordflow">for</span> (tmp = var; tmp; tmp = tmp-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01277"></a>01277             <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;name&quot;</span>))
<a name="l01278"></a>01278                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(mohclass-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>, tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(mohclass-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>));
<a name="l01279"></a>01279             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mode&quot;</span>))
<a name="l01280"></a>01280                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>)); 
<a name="l01281"></a>01281             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;directory&quot;</span>))
<a name="l01282"></a>01282                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(mohclass-&gt;<a class="code" href="structmohclass.html#a4a55f3eac855c94cd30d3f16c3f83fb7">dir</a>, tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(mohclass-&gt;<a class="code" href="structmohclass.html#a4a55f3eac855c94cd30d3f16c3f83fb7">dir</a>));
<a name="l01283"></a>01283             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;application&quot;</span>))
<a name="l01284"></a>01284                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(mohclass-&gt;<a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>, tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(mohclass-&gt;<a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>));
<a name="l01285"></a>01285             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;digit&quot;</span>) &amp;&amp; (isdigit(*tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>) || strchr(<span class="stringliteral">&quot;*#&quot;</span>, *tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)))
<a name="l01286"></a>01286                mohclass-&gt;<a class="code" href="structmohclass.html#ac2c887b7f7b359bfdda8a128980f5081">digit</a> = *tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l01287"></a>01287             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;random&quot;</span>))
<a name="l01288"></a>01288                <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(mohclass, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="res__musiconhold_8c.html#a47622ed8ba1100fc57a944cef6a485eb">MOH_RANDOMIZE</a>);
<a name="l01289"></a>01289             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;sort&quot;</span>) &amp;&amp; !strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;random&quot;</span>))
<a name="l01290"></a>01290                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(mohclass, <a class="code" href="res__musiconhold_8c.html#a47622ed8ba1100fc57a944cef6a485eb">MOH_RANDOMIZE</a>);
<a name="l01291"></a>01291             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;sort&quot;</span>) &amp;&amp; !strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;alpha&quot;</span>)) 
<a name="l01292"></a>01292                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(mohclass, <a class="code" href="res__musiconhold_8c.html#a81ae754573bd2c0d252b398313601fcf">MOH_SORTALPHA</a>);
<a name="l01293"></a>01293             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;format&quot;</span>)) {
<a name="l01294"></a>01294                mohclass-&gt;<a class="code" href="structmohclass.html#a317afff57d87a89158c2b038d37b2b08">format</a> = <a class="code" href="frame_8h.html#a2cf30450cd1821bfbc77d2d9e3605363" title="Gets a format from a name.">ast_getformatbyname</a>(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01295"></a>01295                <span class="keywordflow">if</span> (!mohclass-&gt;<a class="code" href="structmohclass.html#a317afff57d87a89158c2b038d37b2b08">format</a>) {
<a name="l01296"></a>01296                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown format &apos;%s&apos; -- defaulting to SLIN\n&quot;</span>, tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01297"></a>01297                   mohclass-&gt;<a class="code" href="structmohclass.html#a317afff57d87a89158c2b038d37b2b08">format</a> = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l01298"></a>01298                }
<a name="l01299"></a>01299             }
<a name="l01300"></a>01300          }
<a name="l01301"></a>01301          <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l01302"></a>01302          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mohclass-&gt;<a class="code" href="structmohclass.html#a4a55f3eac855c94cd30d3f16c3f83fb7">dir</a>)) {
<a name="l01303"></a>01303             <span class="keywordflow">if</span> (!strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;custom&quot;</span>)) {
<a name="l01304"></a>01304                strcpy(mohclass-&gt;<a class="code" href="structmohclass.html#a4a55f3eac855c94cd30d3f16c3f83fb7">dir</a>, <span class="stringliteral">&quot;nodir&quot;</span>);
<a name="l01305"></a>01305             } <span class="keywordflow">else</span> {
<a name="l01306"></a>01306                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;A directory must be specified for class &apos;%s&apos;!\n&quot;</span>, mohclass-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>);
<a name="l01307"></a>01307                mohclass = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(mohclass, <span class="stringliteral">&quot;unreffing potential mohclass (no directory specified)&quot;</span>);
<a name="l01308"></a>01308                <span class="keywordflow">return</span> -1;
<a name="l01309"></a>01309             }
<a name="l01310"></a>01310          }
<a name="l01311"></a>01311          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>)) {
<a name="l01312"></a>01312             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;A mode must be specified for class &apos;%s&apos;!\n&quot;</span>, mohclass-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>);
<a name="l01313"></a>01313             mohclass = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(mohclass, <span class="stringliteral">&quot;unreffing potential mohclass (no mode specified)&quot;</span>);
<a name="l01314"></a>01314             <span class="keywordflow">return</span> -1;
<a name="l01315"></a>01315          }
<a name="l01316"></a>01316          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mohclass-&gt;<a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>) &amp;&amp; !strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;custom&quot;</span>)) {
<a name="l01317"></a>01317             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;An application must be specified for class &apos;%s&apos;!\n&quot;</span>, mohclass-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>);
<a name="l01318"></a>01318             mohclass = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(mohclass, <span class="stringliteral">&quot;unreffing potential mohclass (no app specified for custom mode&quot;</span>);
<a name="l01319"></a>01319             <span class="keywordflow">return</span> -1;
<a name="l01320"></a>01320          }
<a name="l01321"></a>01321 
<a name="l01322"></a>01322          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(global_flags, <a class="code" href="res__musiconhold_8c.html#a90367ee5bb64c9b16ce7e44731ec5f90">MOH_CACHERTCLASSES</a>)) {
<a name="l01323"></a>01323             <span class="comment">/* CACHERTCLASSES enabled, let&apos;s add this class to default tree */</span>
<a name="l01324"></a>01324             <span class="keywordflow">if</span> (state &amp;&amp; state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>) {
<a name="l01325"></a>01325                <span class="comment">/* Class already exist for this channel */</span>
<a name="l01326"></a>01326                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;This channel already has a MOH class attached (%s)!\n&quot;</span>, state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>);
<a name="l01327"></a>01327                <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#aac1ae37fa4007496a50df75cf1f698c1">realtime</a> &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(global_flags, <a class="code" href="res__musiconhold_8c.html#a90367ee5bb64c9b16ce7e44731ec5f90">MOH_CACHERTCLASSES</a>) &amp;&amp; !strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>, state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>)) {
<a name="l01328"></a>01328                   <span class="comment">/* we found RT class with the same name, seems like we should continue playing existing one */</span>
<a name="l01329"></a>01329                   <span class="comment">/* XXX This code is impossible to reach */</span>
<a name="l01330"></a>01330                   mohclass = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(mohclass, <span class="stringliteral">&quot;unreffing potential mohclass (channel already has a class)&quot;</span>);
<a name="l01331"></a>01331                   mohclass = state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>;
<a name="l01332"></a>01332                }
<a name="l01333"></a>01333             }
<a name="l01334"></a>01334             <span class="comment">/* We don&apos;t want moh_register to unref the mohclass because we do it at the end of this function as well.</span>
<a name="l01335"></a>01335 <span class="comment">             * If we allowed moh_register to unref the mohclass,too, then the count would be off by one. The result would</span>
<a name="l01336"></a>01336 <span class="comment">             * be that the destructor would be called when the generator on the channel is deactivated. The container then</span>
<a name="l01337"></a>01337 <span class="comment">             * has a pointer to a freed mohclass, so any operations involving the mohclass container would result in reading</span>
<a name="l01338"></a>01338 <span class="comment">             * invalid memory.</span>
<a name="l01339"></a>01339 <span class="comment">             */</span>
<a name="l01340"></a>01340             <a class="code" href="res__musiconhold_8c.html#abee0f1450f8e48a15361f2f651907156">moh_register</a>(mohclass, 0, <a class="code" href="res__musiconhold_8c.html#af282bb73fa767a734878f6389f08cc2b">DONT_UNREF</a>);
<a name="l01341"></a>01341          } <span class="keywordflow">else</span> {
<a name="l01342"></a>01342             <span class="comment">/* We don&apos;t register RT moh class, so let&apos;s init it manualy */</span>
<a name="l01343"></a>01343 
<a name="l01344"></a>01344             time(&amp;mohclass-&gt;<a class="code" href="structmohclass.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>);
<a name="l01345"></a>01345             mohclass-&gt;<a class="code" href="structmohclass.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a> -= respawn_time;
<a name="l01346"></a>01346    
<a name="l01347"></a>01347             <span class="keywordflow">if</span> (!strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;files&quot;</span>)) {
<a name="l01348"></a>01348                <span class="keywordflow">if</span> (!<a class="code" href="res__musiconhold_8c.html#a587e0538fac924934573a153ad7a6f7e">moh_scan_files</a>(mohclass)) {
<a name="l01349"></a>01349                   mohclass = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(mohclass, <span class="stringliteral">&quot;unreffing potential mohclass (moh_scan_files failed)&quot;</span>);
<a name="l01350"></a>01350                   <span class="keywordflow">return</span> -1;
<a name="l01351"></a>01351                }
<a name="l01352"></a>01352                <span class="keywordflow">if</span> (strchr(mohclass-&gt;<a class="code" href="structmohclass.html#a2539ece5bb753f415746fd252a117f19">args</a>, <span class="charliteral">&apos;r&apos;</span>))
<a name="l01353"></a>01353                   <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(mohclass, <a class="code" href="res__musiconhold_8c.html#a47622ed8ba1100fc57a944cef6a485eb">MOH_RANDOMIZE</a>);
<a name="l01354"></a>01354             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;mp3&quot;</span>) || !strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;mp3nb&quot;</span>) || !strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;quietmp3&quot;</span>) || !strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;quietmp3nb&quot;</span>) || !strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;httpmp3&quot;</span>) || !strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;custom&quot;</span>)) {
<a name="l01355"></a>01355 
<a name="l01356"></a>01356                <span class="keywordflow">if</span> (!strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;custom&quot;</span>))
<a name="l01357"></a>01357                   <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(mohclass, <a class="code" href="res__musiconhold_8c.html#a2eff543e703f0fb49f655f760312e291">MOH_CUSTOM</a>);
<a name="l01358"></a>01358                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;mp3nb&quot;</span>))
<a name="l01359"></a>01359                   <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(mohclass, <a class="code" href="res__musiconhold_8c.html#acb4a79e9b83147f8ab6a7ada46071740">MOH_SINGLE</a>);
<a name="l01360"></a>01360                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;quietmp3nb&quot;</span>))
<a name="l01361"></a>01361                   <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(mohclass, <a class="code" href="res__musiconhold_8c.html#acb4a79e9b83147f8ab6a7ada46071740">MOH_SINGLE</a> | <a class="code" href="res__musiconhold_8c.html#a35d37162b1781f830c686da44c0c9a9d">MOH_QUIET</a>);
<a name="l01362"></a>01362                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>, <span class="stringliteral">&quot;quietmp3&quot;</span>))
<a name="l01363"></a>01363                   <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(mohclass, <a class="code" href="res__musiconhold_8c.html#a35d37162b1781f830c686da44c0c9a9d">MOH_QUIET</a>);
<a name="l01364"></a>01364          
<a name="l01365"></a>01365                mohclass-&gt;<a class="code" href="structmohclass.html#af08b24ab237f0647a06f2f9dcdb36e82">srcfd</a> = -1;
<a name="l01366"></a>01366 <span class="preprocessor">#ifdef HAVE_DAHDI</span>
<a name="l01367"></a>01367 <span class="preprocessor"></span>               <span class="comment">/* Open /dev/dahdi/pseudo for timing...  Is</span>
<a name="l01368"></a>01368 <span class="comment">                  there a better, yet reliable way to do this? */</span>
<a name="l01369"></a>01369                mohclass-&gt;<a class="code" href="structmohclass.html#aa6e23be0b421a7756d686b9ad6ef698a">pseudofd</a> = open(<span class="stringliteral">&quot;/dev/dahdi/pseudo&quot;</span>, O_RDONLY);
<a name="l01370"></a>01370                <span class="keywordflow">if</span> (mohclass-&gt;<a class="code" href="structmohclass.html#aa6e23be0b421a7756d686b9ad6ef698a">pseudofd</a> &lt; 0) {
<a name="l01371"></a>01371                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open pseudo channel for timing...  Sound may be choppy.\n&quot;</span>);
<a name="l01372"></a>01372                } <span class="keywordflow">else</span> {
<a name="l01373"></a>01373                   <span class="keywordtype">int</span> x = 320;
<a name="l01374"></a>01374                   ioctl(mohclass-&gt;<a class="code" href="structmohclass.html#aa6e23be0b421a7756d686b9ad6ef698a">pseudofd</a>, DAHDI_SET_BLOCKSIZE, &amp;x);
<a name="l01375"></a>01375                }
<a name="l01376"></a>01376 <span class="preprocessor">#else</span>
<a name="l01377"></a>01377 <span class="preprocessor"></span>               mohclass-&gt;<a class="code" href="structmohclass.html#aa6e23be0b421a7756d686b9ad6ef698a">pseudofd</a> = -1;
<a name="l01378"></a>01378 <span class="preprocessor">#endif</span>
<a name="l01379"></a>01379 <span class="preprocessor"></span>               <span class="comment">/* Let&apos;s check if this channel already had a moh class before */</span>
<a name="l01380"></a>01380                <span class="keywordflow">if</span> (state &amp;&amp; state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>) {
<a name="l01381"></a>01381                   <span class="comment">/* Class already exist for this channel */</span>
<a name="l01382"></a>01382                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;This channel already has a MOH class attached (%s)!\n&quot;</span>, state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>);
<a name="l01383"></a>01383                   <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#aac1ae37fa4007496a50df75cf1f698c1">realtime</a> &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(global_flags, <a class="code" href="res__musiconhold_8c.html#a90367ee5bb64c9b16ce7e44731ec5f90">MOH_CACHERTCLASSES</a>) &amp;&amp; !strcasecmp(mohclass-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>, state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>-&gt;<a class="code" href="structmohclass.html#a1544f236ea071cf9a855b49a332f5c13">name</a>)) {
<a name="l01384"></a>01384                      <span class="comment">/* we found RT class with the same name, seems like we should continue playing existing one */</span>
<a name="l01385"></a>01385                      mohclass = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(mohclass, <span class="stringliteral">&quot;unreffing potential mohclass (channel already has one)&quot;</span>);
<a name="l01386"></a>01386                      mohclass = state-&gt;<a class="code" href="structmoh__files__state.html#a4c5923d033de3a078431f25f27f9c410">class</a>;
<a name="l01387"></a>01387                   }
<a name="l01388"></a>01388                } <span class="keywordflow">else</span> {
<a name="l01389"></a>01389                   <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;mohclass-&gt;<a class="code" href="structmohclass.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>, NULL, <a class="code" href="res__musiconhold_8c.html#af7c7c2858fee7838706a4cd3163f2ad1">monmp3thread</a>, mohclass)) {
<a name="l01390"></a>01390                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create moh...\n&quot;</span>);
<a name="l01391"></a>01391                      <span class="keywordflow">if</span> (mohclass-&gt;<a class="code" href="structmohclass.html#aa6e23be0b421a7756d686b9ad6ef698a">pseudofd</a> &gt; -1) {
<a name="l01392"></a>01392                         close(mohclass-&gt;<a class="code" href="structmohclass.html#aa6e23be0b421a7756d686b9ad6ef698a">pseudofd</a>);
<a name="l01393"></a>01393                         mohclass-&gt;<a class="code" href="structmohclass.html#aa6e23be0b421a7756d686b9ad6ef698a">pseudofd</a> = -1;
<a name="l01394"></a>01394                      }
<a name="l01395"></a>01395                      mohclass = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(mohclass, <span class="stringliteral">&quot;Unreffing potential mohclass (failed to create background thread)&quot;</span>);
<a name="l01396"></a>01396                      <span class="keywordflow">return</span> -1;
<a name="l01397"></a>01397                   }
<a name="l01398"></a>01398                }
<a name="l01399"></a>01399             } <span class="keywordflow">else</span> {
<a name="l01400"></a>01400                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Don&apos;t know how to do a mode &apos;%s&apos; music on hold\n&quot;</span>, mohclass-&gt;<a class="code" href="structmohclass.html#ac950c6bd268f3f45a5b0cf39e5d12817">mode</a>);
<a name="l01401"></a>01401                mohclass = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(mohclass, <span class="stringliteral">&quot;unreffing potential mohclass (unknown mode)&quot;</span>);
<a name="l01402"></a>01402                <span class="keywordflow">return</span> -1;
<a name="l01403"></a>01403             }
<a name="l01404"></a>01404          }
<a name="l01405"></a>01405       } <span class="keywordflow">else</span> {
<a name="l01406"></a>01406          <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l01407"></a>01407       }
<a name="l01408"></a>01408    }
<a name="l01409"></a>01409 
<a name="l01410"></a>01410    <span class="keywordflow">if</span> (!mohclass) {
<a name="l01411"></a>01411       <span class="keywordflow">return</span> -1;
<a name="l01412"></a>01412    }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MusicOnHold&quot;</span>,
<a name="l01415"></a>01415       <span class="stringliteral">&quot;State: Start\r\n&quot;</span>
<a name="l01416"></a>01416       <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l01417"></a>01417       <span class="stringliteral">&quot;UniqueID: %s\r\n&quot;</span>,
<a name="l01418"></a>01418       chan-&gt;name, chan-&gt;uniqueid);
<a name="l01419"></a>01419 
<a name="l01420"></a>01420    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329af342fb5a757280799be80248e898d14a">AST_FLAG_MOH</a>);
<a name="l01421"></a>01421 
<a name="l01422"></a>01422    <span class="keywordflow">if</span> (mohclass-&gt;<a class="code" href="structmohclass.html#ac4bef3984b07b68ad586b3109e528f47">total_files</a>) {
<a name="l01423"></a>01423       res = <a class="code" href="channel_8h.html#a12a58dda74a19f383f6b77cf7fa88b54">ast_activate_generator</a>(chan, &amp;moh_file_stream, mohclass);
<a name="l01424"></a>01424    } <span class="keywordflow">else</span> {
<a name="l01425"></a>01425       res = <a class="code" href="channel_8h.html#a12a58dda74a19f383f6b77cf7fa88b54">ast_activate_generator</a>(chan, &amp;mohgen, mohclass);
<a name="l01426"></a>01426    }
<a name="l01427"></a>01427 
<a name="l01428"></a>01428    mohclass = <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(mohclass, <span class="stringliteral">&quot;unreffing local reference to mohclass in local_ast_moh_start&quot;</span>);
<a name="l01429"></a>01429 
<a name="l01430"></a>01430    <span class="keywordflow">return</span> res;
<a name="l01431"></a>01431 }
<a name="l01432"></a>01432 
<a name="l01433"></a><a class="code" href="res__musiconhold_8c.html#a3ea9c183ecd11d0c0ec1a95500821b5f">01433</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__musiconhold_8c.html#a3ea9c183ecd11d0c0ec1a95500821b5f">local_ast_moh_stop</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)
<a name="l01434"></a>01434 {
<a name="l01435"></a>01435    <span class="keyword">struct </span><a class="code" href="structmoh__files__state.html">moh_files_state</a> *<a class="code" href="structstate.html">state</a> = chan-&gt;<a class="code" href="structast__channel.html#a80a9a0d24139c1d84463de5e88248491">music_state</a>;
<a name="l01436"></a>01436    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329af342fb5a757280799be80248e898d14a">AST_FLAG_MOH</a>);
<a name="l01437"></a>01437    <a class="code" href="channel_8h.html#a7160355005776732fba88cc020f4a45b">ast_deactivate_generator</a>(chan);
<a name="l01438"></a>01438 
<a name="l01439"></a>01439    <span class="keywordflow">if</span> (state) {
<a name="l01440"></a>01440       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>) {
<a name="l01441"></a>01441          <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>);
<a name="l01442"></a>01442          chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> = NULL;
<a name="l01443"></a>01443       }
<a name="l01444"></a>01444    }
<a name="l01445"></a>01445 
<a name="l01446"></a>01446    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MusicOnHold&quot;</span>,
<a name="l01447"></a>01447       <span class="stringliteral">&quot;State: Stop\r\n&quot;</span>
<a name="l01448"></a>01448       <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l01449"></a>01449       <span class="stringliteral">&quot;UniqueID: %s\r\n&quot;</span>,
<a name="l01450"></a>01450       chan-&gt;name, chan-&gt;uniqueid);
<a name="l01451"></a>01451 }
<a name="l01452"></a>01452 
<a name="l01453"></a><a class="code" href="res__musiconhold_8c.html#aba4e08833be2bc1bd7e5b98e345bc6ce">01453</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__musiconhold_8c.html#aba4e08833be2bc1bd7e5b98e345bc6ce">moh_class_destructor</a>(<span class="keywordtype">void</span> *obj)
<a name="l01454"></a>01454 {
<a name="l01455"></a>01455    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class </span>= obj;
<a name="l01456"></a>01456    <span class="keyword">struct </span>mohdata *<a class="code" href="structmember.html">member</a>;
<a name="l01457"></a>01457    pthread_t tid = 0;
<a name="l01458"></a>01458 
<a name="l01459"></a>01459    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Destroying MOH class &apos;%s&apos;\n&quot;</span>, class-&gt;name);
<a name="l01460"></a>01460 
<a name="l01461"></a>01461    <span class="comment">/* Kill the thread first, so it cannot restart the child process while the</span>
<a name="l01462"></a>01462 <span class="comment">    * class is being destroyed */</span>
<a name="l01463"></a>01463    <span class="keywordflow">if</span> (class-&gt;thread != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a> &amp;&amp; class-&gt;thread != 0) {
<a name="l01464"></a>01464       tid = <span class="keyword">class</span>-&gt;thread;
<a name="l01465"></a>01465       <span class="keyword">class</span>-&gt;thread = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l01466"></a>01466       pthread_cancel(tid);
<a name="l01467"></a>01467       <span class="comment">/* We&apos;ll collect the exit status later, after we ensure all the readers</span>
<a name="l01468"></a>01468 <span class="comment">       * are dead. */</span>
<a name="l01469"></a>01469    }
<a name="l01470"></a>01470 
<a name="l01471"></a>01471    <span class="keywordflow">if</span> (class-&gt;pid &gt; 1) {
<a name="l01472"></a>01472       <span class="keywordtype">char</span> <a class="code" href="chan__unistim_8c.html#af30c10a8c6ed3d4649cfdc61e2029dc3">buff</a>[8192];
<a name="l01473"></a>01473       <span class="keywordtype">int</span> bytes, tbytes = 0, stime = 0, <a class="code" href="structmohclass.html#af500917c052066b40cf47f96b43c607b">pid</a> = 0;
<a name="l01474"></a>01474 
<a name="l01475"></a>01475       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;killing %d!\n&quot;</span>, class-&gt;pid);
<a name="l01476"></a>01476 
<a name="l01477"></a>01477       stime = time(NULL) + 2;
<a name="l01478"></a>01478       <a class="code" href="structmohclass.html#af500917c052066b40cf47f96b43c607b">pid</a> = <span class="keyword">class</span>-&gt;pid;
<a name="l01479"></a>01479       <span class="keyword">class</span>-&gt;pid = 0;
<a name="l01480"></a>01480 
<a name="l01481"></a>01481       <span class="comment">/* Back when this was just mpg123, SIGKILL was fine.  Now we need</span>
<a name="l01482"></a>01482 <span class="comment">       * to give the process a reason and time enough to kill off its</span>
<a name="l01483"></a>01483 <span class="comment">       * children. */</span>
<a name="l01484"></a>01484       <span class="keywordflow">do</span> {
<a name="l01485"></a>01485          <span class="keywordflow">if</span> (killpg(<a class="code" href="structmohclass.html#af500917c052066b40cf47f96b43c607b">pid</a>, SIGHUP) &lt; 0) {
<a name="l01486"></a>01486             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to send a SIGHUP to MOH process?!!: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01487"></a>01487          }
<a name="l01488"></a>01488          usleep(100000);
<a name="l01489"></a>01489          <span class="keywordflow">if</span> (killpg(<a class="code" href="structmohclass.html#af500917c052066b40cf47f96b43c607b">pid</a>, SIGTERM) &lt; 0) {
<a name="l01490"></a>01490             <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ESRCH) {
<a name="l01491"></a>01491                <span class="keywordflow">break</span>;
<a name="l01492"></a>01492             }
<a name="l01493"></a>01493             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to terminate MOH process?!!: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01494"></a>01494          }
<a name="l01495"></a>01495          usleep(100000);
<a name="l01496"></a>01496          <span class="keywordflow">if</span> (killpg(<a class="code" href="structmohclass.html#af500917c052066b40cf47f96b43c607b">pid</a>, SIGKILL) &lt; 0) {
<a name="l01497"></a>01497             <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ESRCH) {
<a name="l01498"></a>01498                <span class="keywordflow">break</span>;
<a name="l01499"></a>01499             }
<a name="l01500"></a>01500             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to kill MOH process?!!: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01501"></a>01501          }
<a name="l01502"></a>01502       } <span class="keywordflow">while</span> (0);
<a name="l01503"></a>01503 
<a name="l01504"></a>01504       <span class="keywordflow">while</span> ((<a class="code" href="utils_8h.html#a60404ef44696316455e79c3a002cc71e">ast_wait_for_input</a>(class-&gt;srcfd, 100) &gt; 0) &amp;&amp; 
<a name="l01505"></a>01505             (bytes = read(class-&gt;srcfd, buff, 8192)) &amp;&amp; time(NULL) &lt; stime) {
<a name="l01506"></a>01506          tbytes = tbytes + bytes;
<a name="l01507"></a>01507       }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;mpg123 pid %d and child died after %d bytes read\n&quot;</span>, <a class="code" href="structmohclass.html#af500917c052066b40cf47f96b43c607b">pid</a>, tbytes);
<a name="l01510"></a>01510 
<a name="l01511"></a>01511       close(class-&gt;srcfd);
<a name="l01512"></a>01512    }
<a name="l01513"></a>01513 
<a name="l01514"></a>01514    <span class="keywordflow">while</span> ((member = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;class-&gt;members, list))) {
<a name="l01515"></a>01515       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(member);
<a name="l01516"></a>01516    }
<a name="l01517"></a>01517 
<a name="l01518"></a>01518    <span class="keywordflow">if</span> (class-&gt;filearray) {
<a name="l01519"></a>01519       <span class="keywordtype">int</span> i;
<a name="l01520"></a>01520       <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">class</span>-&gt;total_files; i++) {
<a name="l01521"></a>01521          <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(class-&gt;filearray[i]);
<a name="l01522"></a>01522       }
<a name="l01523"></a>01523       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(class-&gt;filearray);
<a name="l01524"></a>01524       <span class="keyword">class</span>-&gt;filearray = NULL;
<a name="l01525"></a>01525    }
<a name="l01526"></a>01526 
<a name="l01527"></a>01527    <span class="comment">/* Finally, collect the exit status of the monitor thread */</span>
<a name="l01528"></a>01528    <span class="keywordflow">if</span> (tid &gt; 0) {
<a name="l01529"></a>01529       pthread_join(tid, NULL);
<a name="l01530"></a>01530    }
<a name="l01531"></a>01531 }
<a name="l01532"></a>01532 
<a name="l01533"></a><a class="code" href="res__musiconhold_8c.html#a43d33b3a3495c6ab85e029bd48182698">01533</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a43d33b3a3495c6ab85e029bd48182698">moh_class_mark</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l01534"></a>01534 {
<a name="l01535"></a>01535    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class </span>= obj;
<a name="l01536"></a>01536 
<a name="l01537"></a>01537    <span class="keyword">class</span>-&gt;delete = 1;
<a name="l01538"></a>01538 
<a name="l01539"></a>01539    <span class="keywordflow">return</span> 0;
<a name="l01540"></a>01540 }
<a name="l01541"></a>01541 
<a name="l01542"></a><a class="code" href="res__musiconhold_8c.html#af6ef0d39674dc83bdb095cc1e19162c5">01542</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#af6ef0d39674dc83bdb095cc1e19162c5">moh_classes_delete_marked</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l01543"></a>01543 {
<a name="l01544"></a>01544    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class </span>= obj;
<a name="l01545"></a>01545 
<a name="l01546"></a>01546    <span class="keywordflow">return</span> <span class="keyword">class</span>-&gt;delete ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> : 0;
<a name="l01547"></a>01547 }
<a name="l01548"></a>01548 
<a name="l01549"></a><a class="code" href="res__musiconhold_8c.html#a5aed3b10670d29e3b0c58f185ff64ec2">01549</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#a5aed3b10670d29e3b0c58f185ff64ec2">load_moh_classes</a>(<span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l01550"></a>01550 {
<a name="l01551"></a>01551    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l01552"></a>01552    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l01553"></a>01553    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class</span>; 
<a name="l01554"></a>01554    <span class="keywordtype">char</span> *cat;
<a name="l01555"></a>01555    <span class="keywordtype">int</span> numclasses = 0;
<a name="l01556"></a>01556    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { reload ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l01557"></a>01557 
<a name="l01558"></a>01558    cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;musiconhold.conf&quot;</span>, config_flags);
<a name="l01559"></a>01559 
<a name="l01560"></a>01560    <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a> || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l01561"></a>01561       <span class="keywordflow">return</span> 0;
<a name="l01562"></a>01562    }
<a name="l01563"></a>01563 
<a name="l01564"></a>01564    <span class="keywordflow">if</span> (reload) {
<a name="l01565"></a>01565       <a class="code" href="astobj2_8h.html#aeca960ec22a1d0384f6e285b25df8501" title="ao2_callback() is a generic function that applies cb_fn() to all objects in a container...">ao2_t_callback</a>(mohclasses, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a>, <a class="code" href="res__musiconhold_8c.html#a43d33b3a3495c6ab85e029bd48182698">moh_class_mark</a>, NULL, <span class="stringliteral">&quot;Mark deleted classes&quot;</span>);
<a name="l01566"></a>01566    }
<a name="l01567"></a>01567    
<a name="l01568"></a>01568    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(global_flags, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l01569"></a>01569 
<a name="l01570"></a>01570    cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, NULL);
<a name="l01571"></a>01571    <span class="keywordflow">for</span> (; cat; cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, cat)) {
<a name="l01572"></a>01572       <span class="comment">/* Setup common options from [general] section */</span>
<a name="l01573"></a>01573       <span class="keywordflow">if</span> (!strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>)) {
<a name="l01574"></a>01574          <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01575"></a>01575             <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;cachertclasses&quot;</span>)) {
<a name="l01576"></a>01576                <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(global_flags, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="res__musiconhold_8c.html#a90367ee5bb64c9b16ce7e44731ec5f90">MOH_CACHERTCLASSES</a>);
<a name="l01577"></a>01577             } <span class="keywordflow">else</span> {
<a name="l01578"></a>01578                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown option &apos;%s&apos; in [general] section of musiconhold.conf\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l01579"></a>01579             }
<a name="l01580"></a>01580          }
<a name="l01581"></a>01581       }
<a name="l01582"></a>01582       <span class="comment">/* These names were deprecated in 1.4 and should not be used until after the next major release. */</span>
<a name="l01583"></a>01583       <span class="keywordflow">if</span> (!strcasecmp(cat, <span class="stringliteral">&quot;classes&quot;</span>) || !strcasecmp(cat, <span class="stringliteral">&quot;moh_files&quot;</span>) || 
<a name="l01584"></a>01584             !strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>)) {
<a name="l01585"></a>01585          <span class="keywordflow">continue</span>;
<a name="l01586"></a>01586       }
<a name="l01587"></a>01587 
<a name="l01588"></a>01588       <span class="keywordflow">if</span> (!(<span class="keyword">class</span> = <a class="code" href="res__musiconhold_8c.html#a6775781a88ec94d713fe92bc7f8ef3dd">moh_class_malloc</a>())) {
<a name="l01589"></a>01589          <span class="keywordflow">break</span>;
<a name="l01590"></a>01590       }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(class-&gt;name, cat, <span class="keyword">sizeof</span>(class-&gt;name));  
<a name="l01593"></a>01593       <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01594"></a>01594          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mode&quot;</span>))
<a name="l01595"></a>01595             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(class-&gt;mode, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(class-&gt;mode)); 
<a name="l01596"></a>01596          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;directory&quot;</span>))
<a name="l01597"></a>01597             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(class-&gt;dir, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(class-&gt;dir));
<a name="l01598"></a>01598          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;application&quot;</span>))
<a name="l01599"></a>01599             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(class-&gt;args, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(class-&gt;args));
<a name="l01600"></a>01600          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;digit&quot;</span>) &amp;&amp; (isdigit(*var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>) || strchr(<span class="stringliteral">&quot;*#&quot;</span>, *var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)))
<a name="l01601"></a>01601             <span class="keyword">class</span>-&gt;digit = *var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l01602"></a>01602          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;random&quot;</span>))
<a name="l01603"></a>01603             <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(<span class="keyword">class</span>, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="res__musiconhold_8c.html#a47622ed8ba1100fc57a944cef6a485eb">MOH_RANDOMIZE</a>);
<a name="l01604"></a>01604          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;sort&quot;</span>) &amp;&amp; !strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;random&quot;</span>))
<a name="l01605"></a>01605             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#a47622ed8ba1100fc57a944cef6a485eb">MOH_RANDOMIZE</a>);
<a name="l01606"></a>01606          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;sort&quot;</span>) &amp;&amp; !strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;alpha&quot;</span>)) 
<a name="l01607"></a>01607             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#a81ae754573bd2c0d252b398313601fcf">MOH_SORTALPHA</a>);
<a name="l01608"></a>01608          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;format&quot;</span>)) {
<a name="l01609"></a>01609             <span class="keyword">class</span>-&gt;format = <a class="code" href="frame_8h.html#a2cf30450cd1821bfbc77d2d9e3605363" title="Gets a format from a name.">ast_getformatbyname</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01610"></a>01610             <span class="keywordflow">if</span> (!class-&gt;format) {
<a name="l01611"></a>01611                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown format &apos;%s&apos; -- defaulting to SLIN\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01612"></a>01612                <span class="keyword">class</span>-&gt;format = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l01613"></a>01613             }
<a name="l01614"></a>01614          }
<a name="l01615"></a>01615       }
<a name="l01616"></a>01616 
<a name="l01617"></a>01617       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(class-&gt;dir)) {
<a name="l01618"></a>01618          <span class="keywordflow">if</span> (!strcasecmp(class-&gt;mode, <span class="stringliteral">&quot;custom&quot;</span>)) {
<a name="l01619"></a>01619             strcpy(class-&gt;dir, <span class="stringliteral">&quot;nodir&quot;</span>);
<a name="l01620"></a>01620          } <span class="keywordflow">else</span> {
<a name="l01621"></a>01621             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;A directory must be specified for class &apos;%s&apos;!\n&quot;</span>, class-&gt;name);
<a name="l01622"></a>01622             <span class="keyword">class </span>= <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(class, &quot;unreffing potential mohclass (no directory)&quot;);
<a name="l01623"></a>01623             <span class="keywordflow">continue</span>;
<a name="l01624"></a>01624          }
<a name="l01625"></a>01625       }
<a name="l01626"></a>01626       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(class-&gt;mode)) {
<a name="l01627"></a>01627          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;A mode must be specified for class &apos;%s&apos;!\n&quot;</span>, class-&gt;name);
<a name="l01628"></a>01628          <span class="keyword">class </span>= <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(class, &quot;unreffing potential mohclass (no mode)&quot;);
<a name="l01629"></a>01629          <span class="keywordflow">continue</span>;
<a name="l01630"></a>01630       }
<a name="l01631"></a>01631       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(class-&gt;args) &amp;&amp; !strcasecmp(class-&gt;mode, <span class="stringliteral">&quot;custom&quot;</span>)) {
<a name="l01632"></a>01632          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;An application must be specified for class &apos;%s&apos;!\n&quot;</span>, class-&gt;name);
<a name="l01633"></a>01633          <span class="keyword">class </span>= <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(class, &quot;unreffing potential mohclass (no app for custom mode)&quot;);
<a name="l01634"></a>01634          <span class="keywordflow">continue</span>;
<a name="l01635"></a>01635       }
<a name="l01636"></a>01636 
<a name="l01637"></a>01637       <span class="comment">/* Don&apos;t leak a class when it&apos;s already registered */</span>
<a name="l01638"></a>01638       <span class="keywordflow">if</span> (!<a class="code" href="res__musiconhold_8c.html#abee0f1450f8e48a15361f2f651907156">moh_register</a>(<span class="keyword">class</span>, reload, <a class="code" href="res__musiconhold_8c.html#a376adfa47c759987671a2909dbcacafd">HANDLE_REF</a>)) {
<a name="l01639"></a>01639          numclasses++;
<a name="l01640"></a>01640       }
<a name="l01641"></a>01641    }
<a name="l01642"></a>01642 
<a name="l01643"></a>01643    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01644"></a>01644 
<a name="l01645"></a>01645    <a class="code" href="astobj2_8h.html#aeca960ec22a1d0384f6e285b25df8501" title="ao2_callback() is a generic function that applies cb_fn() to all objects in a container...">ao2_t_callback</a>(mohclasses, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca71f42ec6460e60eb6e10956c53329e45">OBJ_UNLINK</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca614744a4d36b3189d4ab5b02c8645d47">OBJ_MULTIPLE</a>, 
<a name="l01646"></a>01646          <a class="code" href="res__musiconhold_8c.html#af6ef0d39674dc83bdb095cc1e19162c5">moh_classes_delete_marked</a>, NULL, <span class="stringliteral">&quot;Purge marked classes&quot;</span>);
<a name="l01647"></a>01647 
<a name="l01648"></a>01648    <span class="keywordflow">return</span> numclasses;
<a name="l01649"></a>01649 }
<a name="l01650"></a>01650 
<a name="l01651"></a><a class="code" href="res__musiconhold_8c.html#a30b16736de801e460a4a70b436afd0bf">01651</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__musiconhold_8c.html#a30b16736de801e460a4a70b436afd0bf">ast_moh_destroy</a>(<span class="keywordtype">void</span>)
<a name="l01652"></a>01652 {
<a name="l01653"></a>01653    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Destroying musiconhold processes\n&quot;</span>);
<a name="l01654"></a>01654    <a class="code" href="astobj2_8h.html#aeca960ec22a1d0384f6e285b25df8501" title="ao2_callback() is a generic function that applies cb_fn() to all objects in a container...">ao2_t_callback</a>(mohclasses, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca71f42ec6460e60eb6e10956c53329e45">OBJ_UNLINK</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca614744a4d36b3189d4ab5b02c8645d47">OBJ_MULTIPLE</a>, NULL, NULL, <span class="stringliteral">&quot;Destroy callback&quot;</span>);
<a name="l01655"></a>01655 }
<a name="l01656"></a>01656 
<a name="l01657"></a><a class="code" href="res__musiconhold_8c.html#a92aebb46726ee16a3ec938ffd6bf0ad2">01657</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#a92aebb46726ee16a3ec938ffd6bf0ad2">handle_cli_moh_reload</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01658"></a>01658 {
<a name="l01659"></a>01659    <span class="keywordflow">switch</span> (cmd) {
<a name="l01660"></a>01660    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01661"></a>01661       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;moh reload&quot;</span>;
<a name="l01662"></a>01662       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01663"></a>01663          <span class="stringliteral">&quot;Usage: moh reload\n&quot;</span>
<a name="l01664"></a>01664          <span class="stringliteral">&quot;       Reloads the MusicOnHold module.\n&quot;</span>
<a name="l01665"></a>01665          <span class="stringliteral">&quot;       Alias for &apos;module reload res_musiconhold.so&apos;\n&quot;</span>;
<a name="l01666"></a>01666       <span class="keywordflow">return</span> NULL;
<a name="l01667"></a>01667    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01668"></a>01668       <span class="keywordflow">return</span> NULL;
<a name="l01669"></a>01669    }
<a name="l01670"></a>01670 
<a name="l01671"></a>01671    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01672"></a>01672       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01673"></a>01673 
<a name="l01674"></a>01674    <a class="code" href="res__musiconhold_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>();
<a name="l01675"></a>01675 
<a name="l01676"></a>01676    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01677"></a>01677 }
<a name="l01678"></a>01678 
<a name="l01679"></a><a class="code" href="res__musiconhold_8c.html#ad203910383071d5b827155f5ca48567b">01679</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#ad203910383071d5b827155f5ca48567b">handle_cli_moh_show_files</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01680"></a>01680 {
<a name="l01681"></a>01681    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class</span>;
<a name="l01682"></a>01682    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l01683"></a>01683 
<a name="l01684"></a>01684    <span class="keywordflow">switch</span> (cmd) {
<a name="l01685"></a>01685    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01686"></a>01686       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;moh show files&quot;</span>;
<a name="l01687"></a>01687       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01688"></a>01688          <span class="stringliteral">&quot;Usage: moh show files\n&quot;</span>
<a name="l01689"></a>01689          <span class="stringliteral">&quot;       Lists all loaded file-based MusicOnHold classes and their\n&quot;</span>
<a name="l01690"></a>01690          <span class="stringliteral">&quot;       files.\n&quot;</span>;
<a name="l01691"></a>01691       <span class="keywordflow">return</span> NULL;
<a name="l01692"></a>01692    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01693"></a>01693       <span class="keywordflow">return</span> NULL;
<a name="l01694"></a>01694    }
<a name="l01695"></a>01695 
<a name="l01696"></a>01696    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01697"></a>01697       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01698"></a>01698 
<a name="l01699"></a>01699    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(mohclasses, 0);
<a name="l01700"></a>01700    <span class="keywordflow">for</span> (; (<span class="keyword">class </span>= <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;i, <span class="stringliteral">&quot;Show files iterator&quot;</span>)); <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(<span class="keyword">class</span>, <span class="stringliteral">&quot;Unref iterator in moh show files&quot;</span>)) {
<a name="l01701"></a>01701       <span class="keywordtype">int</span> x;
<a name="l01702"></a>01702 
<a name="l01703"></a>01703       <span class="keywordflow">if</span> (!class-&gt;total_files) {
<a name="l01704"></a>01704          <span class="keywordflow">continue</span>;
<a name="l01705"></a>01705       }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Class: %s\n&quot;</span>, class-&gt;name);
<a name="l01708"></a>01708       <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">class</span>-&gt;total_files; x++) {
<a name="l01709"></a>01709          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\tFile: %s\n&quot;</span>, class-&gt;filearray[x]);
<a name="l01710"></a>01710       }
<a name="l01711"></a>01711    }
<a name="l01712"></a>01712    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l01713"></a>01713 
<a name="l01714"></a>01714    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01715"></a>01715 }
<a name="l01716"></a>01716 
<a name="l01717"></a><a class="code" href="res__musiconhold_8c.html#af66d488f3fe5cbab8a9e399f6bb9b24b">01717</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__musiconhold_8c.html#af66d488f3fe5cbab8a9e399f6bb9b24b">handle_cli_moh_show_classes</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01718"></a>01718 {
<a name="l01719"></a>01719    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class</span>;
<a name="l01720"></a>01720    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l01721"></a>01721 
<a name="l01722"></a>01722    <span class="keywordflow">switch</span> (cmd) {
<a name="l01723"></a>01723    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01724"></a>01724       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;moh show classes&quot;</span>;
<a name="l01725"></a>01725       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01726"></a>01726          <span class="stringliteral">&quot;Usage: moh show classes\n&quot;</span>
<a name="l01727"></a>01727          <span class="stringliteral">&quot;       Lists all MusicOnHold classes.\n&quot;</span>;
<a name="l01728"></a>01728       <span class="keywordflow">return</span> NULL;
<a name="l01729"></a>01729    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01730"></a>01730       <span class="keywordflow">return</span> NULL;
<a name="l01731"></a>01731    }
<a name="l01732"></a>01732 
<a name="l01733"></a>01733    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01734"></a>01734       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01735"></a>01735 
<a name="l01736"></a>01736    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(mohclasses, 0);
<a name="l01737"></a>01737    <span class="keywordflow">for</span> (; (<span class="keyword">class </span>= <a class="code" href="astobj2_8h.html#aace7c75c12ac954ed78d72eb84ea0477">ao2_t_iterator_next</a>(&amp;i, <span class="stringliteral">&quot;Show classes iterator&quot;</span>)); <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(<span class="keyword">class</span>, <span class="stringliteral">&quot;Unref iterator in moh show classes&quot;</span>)) {
<a name="l01738"></a>01738       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Class: %s\n&quot;</span>, class-&gt;name);
<a name="l01739"></a>01739       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\tMode: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(class-&gt;mode, <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>));
<a name="l01740"></a>01740       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\tDirectory: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(class-&gt;dir, <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>));
<a name="l01741"></a>01741       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<span class="keyword">class</span>, <a class="code" href="res__musiconhold_8c.html#a2eff543e703f0fb49f655f760312e291">MOH_CUSTOM</a>)) {
<a name="l01742"></a>01742          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\tApplication: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(class-&gt;args, <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>));
<a name="l01743"></a>01743       }
<a name="l01744"></a>01744       <span class="keywordflow">if</span> (strcasecmp(class-&gt;mode, <span class="stringliteral">&quot;files&quot;</span>)) {
<a name="l01745"></a>01745          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\tFormat: %s\n&quot;</span>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(class-&gt;format));
<a name="l01746"></a>01746       }
<a name="l01747"></a>01747    }
<a name="l01748"></a>01748    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l01749"></a>01749 
<a name="l01750"></a>01750    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01751"></a>01751 }
<a name="l01752"></a>01752 
<a name="l01753"></a><a class="code" href="res__musiconhold_8c.html#a264050bac9251c25a734fc5fc7ee3a19">01753</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="res__musiconhold_8c.html#a264050bac9251c25a734fc5fc7ee3a19">cli_moh</a>[] = {
<a name="l01754"></a>01754    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__musiconhold_8c.html#a92aebb46726ee16a3ec938ffd6bf0ad2">handle_cli_moh_reload</a>,       <span class="stringliteral">&quot;Reload MusicOnHold&quot;</span>),
<a name="l01755"></a>01755    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__musiconhold_8c.html#af66d488f3fe5cbab8a9e399f6bb9b24b">handle_cli_moh_show_classes</a>, <span class="stringliteral">&quot;List MusicOnHold classes&quot;</span>),
<a name="l01756"></a>01756    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__musiconhold_8c.html#ad203910383071d5b827155f5ca48567b">handle_cli_moh_show_files</a>,   <span class="stringliteral">&quot;List MusicOnHold file-based classes&quot;</span>)
<a name="l01757"></a>01757 };
<a name="l01758"></a>01758 
<a name="l01759"></a><a class="code" href="res__musiconhold_8c.html#ad1d97ef76be9d79aef93987c8f6c8eb0">01759</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#ad1d97ef76be9d79aef93987c8f6c8eb0">moh_class_hash</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l01760"></a>01760 {
<a name="l01761"></a>01761    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class </span>= obj;
<a name="l01762"></a>01762 
<a name="l01763"></a>01763    <span class="keywordflow">return</span> <a class="code" href="strings_8h.html#ab08f8db2a7258e538a0da7417f58db58" title="Compute a hash value on a case-insensitive string.">ast_str_case_hash</a>(class-&gt;name);
<a name="l01764"></a>01764 }
<a name="l01765"></a>01765 
<a name="l01766"></a><a class="code" href="res__musiconhold_8c.html#aa512ff84e2e4d42881c982936649f9e8">01766</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#aa512ff84e2e4d42881c982936649f9e8">moh_class_cmp</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l01767"></a>01767 {
<a name="l01768"></a>01768    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class </span>= obj, *class2 = arg;
<a name="l01769"></a>01769 
<a name="l01770"></a>01770    <span class="keywordflow">return</span> strcasecmp(class-&gt;name, class2-&gt;name) ? 0 :
<a name="l01771"></a>01771       (flags &amp; <a class="code" href="res__musiconhold_8c.html#ad5d15309259ebc26964f94f4cbf11dae">MOH_NOTDELETED</a>) &amp;&amp; (class-&gt;delete || class2-&gt;delete) ? 0 :
<a name="l01772"></a>01772       <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a>;
<a name="l01773"></a>01773 }
<a name="l01774"></a>01774 
<a name="l01775"></a><a class="code" href="res__musiconhold_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">01775</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l01776"></a>01776 {
<a name="l01777"></a>01777    <span class="keywordtype">int</span> res;
<a name="l01778"></a>01778 
<a name="l01779"></a>01779    <span class="keywordflow">if</span> (!(mohclasses = <a class="code" href="astobj2_8h.html#a0963146a7af29455f2540e5654daa5f7" title="Allocate and initialize a container with the desired number of buckets.">ao2_t_container_alloc</a>(53, <a class="code" href="res__musiconhold_8c.html#ad1d97ef76be9d79aef93987c8f6c8eb0">moh_class_hash</a>, <a class="code" href="res__musiconhold_8c.html#aa512ff84e2e4d42881c982936649f9e8">moh_class_cmp</a>, <span class="stringliteral">&quot;Moh class container&quot;</span>))) {
<a name="l01780"></a>01780       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01781"></a>01781    }
<a name="l01782"></a>01782 
<a name="l01783"></a>01783    <span class="keywordflow">if</span> (!<a class="code" href="res__musiconhold_8c.html#a5aed3b10670d29e3b0c58f185ff64ec2">load_moh_classes</a>(0)) {   <span class="comment">/* No music classes configured, so skip it */</span>
<a name="l01784"></a>01784       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No music on hold classes configured, &quot;</span>
<a name="l01785"></a>01785             <span class="stringliteral">&quot;disabling music on hold.\n&quot;</span>);
<a name="l01786"></a>01786    } <span class="keywordflow">else</span> {
<a name="l01787"></a>01787       <a class="code" href="musiconhold_8h.html#a76c8f293c2dacf853b96314157f3421b">ast_install_music_functions</a>(<a class="code" href="res__musiconhold_8c.html#af0b92f70cc027687abfc34228a488c8f">local_ast_moh_start</a>, <a class="code" href="res__musiconhold_8c.html#a3ea9c183ecd11d0c0ec1a95500821b5f">local_ast_moh_stop</a>,
<a name="l01788"></a>01788             <a class="code" href="res__musiconhold_8c.html#ae3373fcd30d3294aac1893975eef851b">local_ast_moh_cleanup</a>);
<a name="l01789"></a>01789    }
<a name="l01790"></a>01790 
<a name="l01791"></a>01791    res = <a class="code" href="module_8h.html#aa47a7223480d23a864cf83fef0f8585e" title="Register an application.">ast_register_application</a>(play_moh, <a class="code" href="res__musiconhold_8c.html#a02c661b74ad220761f58dd18af45a367">play_moh_exec</a>, play_moh_syn, play_moh_desc);
<a name="l01792"></a>01792    <a class="code" href="asterisk_8h.html#a9b09e95876dfecb9a8573819da0b255e" title="Register a function to be executed before Asterisk exits.">ast_register_atexit</a>(<a class="code" href="res__musiconhold_8c.html#a30b16736de801e460a4a70b436afd0bf">ast_moh_destroy</a>);
<a name="l01793"></a>01793    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(cli_moh, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_moh));
<a name="l01794"></a>01794    <span class="keywordflow">if</span> (!res)
<a name="l01795"></a>01795       res = <a class="code" href="module_8h.html#aa47a7223480d23a864cf83fef0f8585e" title="Register an application.">ast_register_application</a>(wait_moh, <a class="code" href="res__musiconhold_8c.html#aff91d8cab0d5d1f02de2039346b512c1">wait_moh_exec</a>, wait_moh_syn, wait_moh_desc);
<a name="l01796"></a>01796    <span class="keywordflow">if</span> (!res)
<a name="l01797"></a>01797       res = <a class="code" href="module_8h.html#aa47a7223480d23a864cf83fef0f8585e" title="Register an application.">ast_register_application</a>(set_moh, <a class="code" href="res__musiconhold_8c.html#ad74d0b042ef5e41a7ac11d21a9b4b05c">set_moh_exec</a>, set_moh_syn, set_moh_desc);
<a name="l01798"></a>01798    <span class="keywordflow">if</span> (!res)
<a name="l01799"></a>01799       res = <a class="code" href="module_8h.html#aa47a7223480d23a864cf83fef0f8585e" title="Register an application.">ast_register_application</a>(start_moh, <a class="code" href="res__musiconhold_8c.html#ab3b9f86e48edb2853a7f6ee7bd17ecf1">start_moh_exec</a>, start_moh_syn, start_moh_desc);
<a name="l01800"></a>01800    <span class="keywordflow">if</span> (!res)
<a name="l01801"></a>01801       res = <a class="code" href="module_8h.html#aa47a7223480d23a864cf83fef0f8585e" title="Register an application.">ast_register_application</a>(stop_moh, <a class="code" href="res__musiconhold_8c.html#a903d206ef650f4216b41018d0baf83d0">stop_moh_exec</a>, stop_moh_syn, stop_moh_desc);
<a name="l01802"></a>01802 
<a name="l01803"></a>01803    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l01804"></a>01804 }
<a name="l01805"></a>01805 
<a name="l01806"></a><a class="code" href="res__musiconhold_8c.html#ad1982509765f4870f1f63412a53ea668">01806</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>)
<a name="l01807"></a>01807 {
<a name="l01808"></a>01808    <span class="keywordflow">if</span> (<a class="code" href="res__musiconhold_8c.html#a5aed3b10670d29e3b0c58f185ff64ec2">load_moh_classes</a>(1)) {
<a name="l01809"></a>01809       <a class="code" href="musiconhold_8h.html#a76c8f293c2dacf853b96314157f3421b">ast_install_music_functions</a>(<a class="code" href="res__musiconhold_8c.html#af0b92f70cc027687abfc34228a488c8f">local_ast_moh_start</a>, <a class="code" href="res__musiconhold_8c.html#a3ea9c183ecd11d0c0ec1a95500821b5f">local_ast_moh_stop</a>,
<a name="l01810"></a>01810             <a class="code" href="res__musiconhold_8c.html#ae3373fcd30d3294aac1893975eef851b">local_ast_moh_cleanup</a>);
<a name="l01811"></a>01811    }
<a name="l01812"></a>01812 
<a name="l01813"></a>01813    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l01814"></a>01814 }
<a name="l01815"></a>01815 
<a name="l01816"></a><a class="code" href="res__musiconhold_8c.html#aa0b77a5d3e427c9dbd64808906f7d806">01816</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__musiconhold_8c.html#aa0b77a5d3e427c9dbd64808906f7d806">moh_class_inuse</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> <a class="code" href="structmohclass.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l01817"></a>01817 {
<a name="l01818"></a>01818    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class </span>= obj;
<a name="l01819"></a>01819 
<a name="l01820"></a>01820    <span class="keywordflow">return</span> <a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;class-&gt;members) ? 0 : <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a>;
<a name="l01821"></a>01821 }
<a name="l01822"></a>01822 
<a name="l01823"></a><a class="code" href="res__musiconhold_8c.html#ad09fa931f468002152a3cc2d5ce25eae">01823</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l01824"></a>01824 {
<a name="l01825"></a>01825    <span class="keywordtype">int</span> res = 0;
<a name="l01826"></a>01826    <span class="keyword">struct </span><a class="code" href="structmohclass.html">mohclass</a> *<span class="keyword">class </span>= NULL;
<a name="l01827"></a>01827 
<a name="l01828"></a>01828    <span class="comment">/* XXX This check shouldn&apos;t be required if module ref counting was being used</span>
<a name="l01829"></a>01829 <span class="comment">    * properly ... */</span>
<a name="l01830"></a>01830    <span class="keywordflow">if</span> ((<span class="keyword">class</span> = <a class="code" href="astobj2_8h.html#aeca960ec22a1d0384f6e285b25df8501" title="ao2_callback() is a generic function that applies cb_fn() to all objects in a container...">ao2_t_callback</a>(mohclasses, 0, <a class="code" href="res__musiconhold_8c.html#aa0b77a5d3e427c9dbd64808906f7d806">moh_class_inuse</a>, NULL, <span class="stringliteral">&quot;Module unload callback&quot;</span>))) {
<a name="l01831"></a>01831       <span class="keyword">class </span>= <a class="code" href="res__musiconhold_8c.html#aea42799a2487b1483e78ca76907cf5eb">mohclass_unref</a>(class, &quot;unref of class from module unload callback&quot;);
<a name="l01832"></a>01832       res = -1;
<a name="l01833"></a>01833    }
<a name="l01834"></a>01834 
<a name="l01835"></a>01835    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01836"></a>01836       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to unload res_musiconhold due to active MOH channels\n&quot;</span>);
<a name="l01837"></a>01837       <span class="keywordflow">return</span> res;
<a name="l01838"></a>01838    }
<a name="l01839"></a>01839 
<a name="l01840"></a>01840    <a class="code" href="musiconhold_8h.html#a9a1bf5906ede80cab6b57627fea47272">ast_uninstall_music_functions</a>();
<a name="l01841"></a>01841 
<a name="l01842"></a>01842    <a class="code" href="res__musiconhold_8c.html#a30b16736de801e460a4a70b436afd0bf">ast_moh_destroy</a>();
<a name="l01843"></a>01843    res = <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(play_moh);
<a name="l01844"></a>01844    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(wait_moh);
<a name="l01845"></a>01845    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(set_moh);
<a name="l01846"></a>01846    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(start_moh);
<a name="l01847"></a>01847    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(stop_moh);
<a name="l01848"></a>01848    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(cli_moh, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_moh));
<a name="l01849"></a>01849    <a class="code" href="asterisk_8h.html#a7f60f486e8e4a322ae5132d791a94bcc" title="Unregister a function registered with ast_register_atexit().">ast_unregister_atexit</a>(<a class="code" href="res__musiconhold_8c.html#a30b16736de801e460a4a70b436afd0bf">ast_moh_destroy</a>);
<a name="l01850"></a>01850 
<a name="l01851"></a>01851    <span class="keywordflow">return</span> res;
<a name="l01852"></a>01852 }
<a name="l01853"></a>01853 
<a name="l01854"></a>01854 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <span class="stringliteral">&quot;Music On Hold Resource&quot;</span>,
<a name="l01855"></a>01855    .load = <a class="code" href="res__musiconhold_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>,
<a name="l01856"></a>01856    .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l01857"></a>01857    .<a class="code" href="res__musiconhold_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> = <a class="code" href="res__musiconhold_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>,
<a name="l01858"></a><a class="code" href="res__musiconhold_8c.html#ae25b9f3970870610911f8850897e8ead">01858</a> );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:47 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
