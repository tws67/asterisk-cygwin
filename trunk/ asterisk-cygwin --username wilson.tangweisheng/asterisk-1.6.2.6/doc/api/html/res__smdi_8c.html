<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:23:17 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_318a70d4e812a718d9ecaeea98fff199.html">res</a>
  </div>
</div>
<div class="contents">
<h1>res_smdi.c File Reference</h1>
<p>SMDI support for Asterisk.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &lt;termios.h&gt;</code><br/>
<code>#include &lt;sys/time.h&gt;</code><br/>
<code>#include &lt;<a class="el" href="time_8h_source.html">time.h</a>&gt;</code><br/>
<code>#include &lt;ctype.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="module_8h_source.html">asterisk/module.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="lock_8h_source.html">asterisk/lock.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="smdi_8h_source.html">asterisk/smdi.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="config_8h_source.html">asterisk/config.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="astobj_8h_source.html">asterisk/astobj.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="io_8h_source.html">asterisk/io.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="stringfields_8h_source.html">asterisk/stringfields.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="linkedlists_8h_source.html">asterisk/linkedlists.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="app_8h_source.html">asterisk/app.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pbx_8h_source.html">asterisk/pbx.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="channel_8h_source.html">asterisk/channel.h</a>&quot;</code><br/>

<p><a href="res__smdi_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__smdi__interface__container.html">ast_smdi_interface_container</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">SMDI interface container.  <a href="structast__smdi__interface__container.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__smdi__md__queue.html">ast_smdi_md_queue</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">SMDI <a class="el" href="structmessage.html">message</a> desk <a class="el" href="structmessage.html">message</a> queue.  <a href="structast__smdi__md__queue.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__smdi__mwi__queue.html">ast_smdi_mwi_queue</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">SMDI <a class="el" href="structmessage.html">message</a> waiting indicator <a class="el" href="structmessage.html">message</a> queue.  <a href="structast__smdi__mwi__queue.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmailbox__mapping.html">mailbox_mapping</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">A mapping between an SMDI mailbox ID and an Asterisk mailbox.  <a href="structmailbox__mapping.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structsmdi__msg__datastore.html">smdi_msg_datastore</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a805616595a796949ade4a78edc628f99">AST_API_MODULE</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a3180eebdd34e39357d1fc13e34fa0298">DEFAULT_POLLING_INTERVAL</a>&nbsp;&nbsp;&nbsp;10</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a0628a499b942c4fe8d3db18d4806af1e">SMDI_MSG_EXPIRY_TIME</a>&nbsp;&nbsp;&nbsp;30000</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a3ce34b39eb6105c25220f8a98edb4cea">SMDI_RETRIEVE_TIMEOUT_DEFAULT</a>&nbsp;&nbsp;&nbsp;3000</td></tr>
<tr><td colspan="2"><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom">{ <a class="el" href="res__smdi_8c.html#a775634eda7917b3f2142895169300799a3d54913f4c5755501ab529da993e3314">OPT_SEARCH_TERMINAL</a> =  (1 &lt;&lt; 0), 
<a class="el" href="res__smdi_8c.html#a775634eda7917b3f2142895169300799a07b7c8dedaab2e0ddec24d2d3e77c378">OPT_SEARCH_NUMBER</a> =  (1 &lt;&lt; 1)
 }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a> { <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>, 
<a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>
 }</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a88b7c88fed6b80fd18f34f97757dfc04">__reg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#afeab1257bd17282b95875499393a147a">__unreg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#ad3ea0faf0ae5bcebd30986b4f707daaa">alloc_smdi_interface</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#aedebd1c4c85c9db863bbe6de85832a26">append_mailbox_mapping</a> (struct <a class="el" href="structast__variable.html">ast_variable</a> *var, struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#ac5e5c2f622f22084f67a01e8f12eab8d">ast_smdi_interface_find</a> (const char *iface_name)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Find an SMDI interface with the specified name.  <a href="#ac5e5c2f622f22084f67a01e8f12eab8d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a9de8197068a3ea0bf4d808b8d8671b3e">ast_smdi_interface_unref</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a93d0f6a07f05b426c70b5e7b79c17966">ast_smdi_md_message_destroy</a> (struct <a class="el" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *<a class="el" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><a class="el" href="structast__smdi__md__message.html" title="An SMDI message desk message.">ast_smdi_md_message</a> destructor.  <a href="#a93d0f6a07f05b426c70b5e7b79c17966"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a94dd57643d9e22a7328e4a5779249aaf">ast_smdi_md_message_pop</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get the next SMDI <a class="el" href="structmessage.html">message</a> from the queue.  <a href="#a94dd57643d9e22a7328e4a5779249aaf"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a539e23e0762cb4032cd69b241b650f3c">ast_smdi_md_message_push</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, struct <a class="el" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *md_msg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#ac10ace25064086876ed8348052cf73ba">ast_smdi_md_message_putback</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, struct <a class="el" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *md_msg)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Put an SMDI <a class="el" href="structmessage.html">message</a> back in the front of the queue.  <a href="#ac10ace25064086876ed8348052cf73ba"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a74b97e1c1bcaa07659fdf57107e0a69e">ast_smdi_md_message_wait</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, int timeout)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get the next SMDI <a class="el" href="structmessage.html">message</a> from the queue.  <a href="#a74b97e1c1bcaa07659fdf57107e0a69e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a22233cce8c423cccc2ff7537b5c6c6f8">ast_smdi_mwi_message_destroy</a> (struct <a class="el" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *<a class="el" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><a class="el" href="structast__smdi__mwi__message.html" title="An SMDI message waiting indicator message.">ast_smdi_mwi_message</a> destructor.  <a href="#a22233cce8c423cccc2ff7537b5c6c6f8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a3ec7db2b5c86856bc1cfbbbc186edf0e">ast_smdi_mwi_message_pop</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get the next SMDI <a class="el" href="structmessage.html">message</a> from the queue.  <a href="#a3ec7db2b5c86856bc1cfbbbc186edf0e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a912ab4e78c7db772efa012cf8bfba4ed">ast_smdi_mwi_message_push</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, struct <a class="el" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *mwi_msg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#ad56b18d4fd6a3b5335d7de6ca9eef8e8">ast_smdi_mwi_message_putback</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, struct <a class="el" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *mwi_msg)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Put an SMDI <a class="el" href="structmessage.html">message</a> back in the front of the queue.  <a href="#ad56b18d4fd6a3b5335d7de6ca9eef8e8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a4b4f48bf27efd32d7c276677e2d9221b">ast_smdi_mwi_message_wait</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, int timeout)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get the next SMDI <a class="el" href="structmessage.html">message</a> from the queue.  <a href="#a4b4f48bf27efd32d7c276677e2d9221b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a57edcf9aa93ccef269ad6ba1d2222609">ast_smdi_mwi_message_wait_station</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, int timeout, const char *station)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a6c1ad3c56eeed633ea2f8c9efabe66ba">ast_smdi_mwi_set</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, const char *<a class="el" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Set the MWI indicator for a mailbox.  <a href="#a6c1ad3c56eeed633ea2f8c9efabe66ba"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a9debceb53aa38da429365ca91e50cd35">ast_smdi_mwi_unset</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, const char *<a class="el" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Unset the MWI indicator for a mailbox.  <a href="#a9debceb53aa38da429365ca91e50cd35"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#aa8dcf5c17e8d6f96acfe863feb6efadc">destroy_all_mailbox_mappings</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a5f83379eaba5ad5f548bfd95560337b6">destroy_mailbox_mapping</a> (struct <a class="el" href="structmailbox__mapping.html">mailbox_mapping</a> *mm)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#aabeaf259ac09253ebae4b4ed0072e677">lock_msg_q</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a> <a class="el" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct timeval&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a2444f5f2c850374177edbc157a112c99">msg_timestamp</a> (void *<a class="el" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a> <a class="el" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a825180f65e43db5b6d50b43f3a64dfda">mwi_monitor_handler</a> (void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a6c34212eb77de40eba9366761c519425">poll_mailbox</a> (struct <a class="el" href="structmailbox__mapping.html">mailbox_mapping</a> *mm)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a902997b7f1d31f4b65899bf89aab3da2">purge_old_messages</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a> <a class="el" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#ae78e2818ae561f95b462d1b50eda7f7d">smdi_load</a> (int reload)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a50ede8e5a94567acefe2a29fbef4e4c0">smdi_message_wait</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, int timeout, enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a> <a class="el" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, const char *search_key, struct <a class="el" href="structast__flags.html">ast_flags</a> options)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a7a89715a33742e572af17f2ff5e91db4">smdi_msg_datastore_destroy</a> (void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a9c94fea9d1c3a7d2175c73d8e90997a9">smdi_msg_find</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a> <a class="el" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, const char *search_key, struct <a class="el" href="structast__flags.html">ast_flags</a> options)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a65b6dc916b3e2d052d6afc00d5f26cee">smdi_msg_pop</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a> <a class="el" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a7f7dca7279c64bdf5d70179f63744f9a">smdi_msg_read</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, const char *cmd, char *data, char *<a class="el" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, size_t len)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a6b024159cf6f1be4facd11cc97c90f88">smdi_msg_retrieve_read</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, const char *cmd, char *data, char *<a class="el" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, size_t len)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#acc85846aabcdbc6620973ad47cedca45">smdi_read</a> (void *iface_p)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a7e881b24835a2254e43d88f68d052e55">smdi_toggle_mwi</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, const char *<a class="el" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, int on)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a051d9e79bbd9448f61d8bfafb756355b">unlink_from_msg_q</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a> <a class="el" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#af6f2cbd59866ad8e9e7e92226c7e2526">unlock_msg_q</a> (struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a> <a class="el" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#aa128a8b37535b9c3c64c6f0564ef4a51">unref_msg</a> (void *<a class="el" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a> <a class="el" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_GLOBAL_SYMBOLS , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;Simplified Message Desk Interface (SMDI) Resource&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, .reload = reload, }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#ae25b9f3970870610911f8850897e8ead">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a> [] = &quot;smdi.conf&quot;</td></tr>
<tr><td class="memItemLeft" >struct {</td></tr>
<tr><td class="memItemLeft" >&nbsp;&nbsp;&nbsp;<a class="el" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a>&nbsp;&nbsp;&nbsp;<a class="el" href="res__smdi_8c.html#a1c7181c39f99ee801943a0d0aa9872b9">cond</a></td></tr>
<tr><td class="memItemLeft" >&nbsp;&nbsp;&nbsp;struct timeval&nbsp;&nbsp;&nbsp;<a class="el" href="res__smdi_8c.html#acfe0553b07ce04ccd0001791aa20ccd2">last_poll</a></td></tr>
<tr><td class="memItemLeft" >&nbsp;&nbsp;&nbsp;<a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>&nbsp;&nbsp;&nbsp;<a class="el" href="res__smdi_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a></td></tr>
<tr><td class="memItemLeft" >&nbsp;&nbsp;&nbsp;struct {</td></tr>
<tr><td class="memItemLeft" >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct <a class="el" href="structmailbox__mapping.html">mailbox_mapping</a> *&nbsp;&nbsp;&nbsp;<a class="el" href="res__smdi_8c.html#af1c80cf45d32519afc2e859f8e5819a1">first</a></td></tr>
<tr><td class="memItemLeft" >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct <a class="el" href="structmailbox__mapping.html">mailbox_mapping</a> *&nbsp;&nbsp;&nbsp;<a class="el" href="res__smdi_8c.html#a9584356f2e9a2d4e36cdadce9c5df4a7">last</a></td></tr>
<tr><td class="memItemLeft" valign="top">&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;<a class="el" href="res__smdi_8c.html#ab63d2897c74948a6792c4cbdbeae9f16">mailbox_mappings</a></td></tr>
<tr><td class="memItemLeft" >&nbsp;&nbsp;&nbsp;unsigned int&nbsp;&nbsp;&nbsp;<a class="el" href="res__smdi_8c.html#a392d1e08448d735437a3ee22460e1bc5">polling_interval</a></td></tr>
<tr><td class="memItemLeft" >&nbsp;&nbsp;&nbsp;unsigned int&nbsp;&nbsp;&nbsp;<a class="el" href="res__smdi_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a>:1</td></tr>
<tr><td class="memItemLeft" >&nbsp;&nbsp;&nbsp;pthread_t&nbsp;&nbsp;&nbsp;<a class="el" href="res__smdi_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a></td></tr>
<tr><td class="memItemLeft" valign="top">}&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72">mwi_monitor</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Data that gets used by the SMDI MWI monitoring thread.  <a href="#a85c9ccfa40ad2c8c4afbf2b10b32ac72"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__smdi__interface__container.html">ast_smdi_interface_container</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9">smdi_ifaces</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">SMDI interface container.  <a href="#a0ccb57302bb98603a039fe3989d5ecb9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__datastore__info.html">ast_datastore_info</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#aa3633a2b3d5aefdf40ed428c3d483527">smdi_msg_datastore_info</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__custom__function.html">ast_custom_function</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a128dbd1032b7d4c41879b13dbe5a8734">smdi_msg_function</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#af946306630fcc495fc32ab59aecf4fca">smdi_msg_id</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__app__option.html">ast_app_option</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#a78fd6e06a4ad1ece63365b1703c263c5">smdi_msg_ret_options</a> [128] = { [ 't' ] = { .flag = OPT_SEARCH_TERMINAL }, [ 'n' ] = { .flag = OPT_SEARCH_NUMBER }, }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__custom__function.html">ast_custom_function</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__smdi_8c.html#ae571eca2127e70a65dd831104c03dbe7">smdi_msg_retrieve_function</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>SMDI support for Asterisk. </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Matthew A. Nicholson &lt;<a href="mailto:mnicholson@digium.com">mnicholson@digium.com</a>&gt; </dd>
<dd>
Russell Bryant &lt;<a href="mailto:russell@digium.com">russell@digium.com</a>&gt;</dd></dl>
<p>Here is a useful mailing list post that describes SMDI protocol details: http://lists.digium.com/pipermail/asterisk-dev/2003-June/000884.html</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000093">Todo:</a></b></dt><dd>This module currently has its own mailbox monitoring thread. This should be converted to MWI subscriptions and just let the optional global voicemail polling thread handle it. </dd></dl>

<p>Definition in file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a805616595a796949ade4a78edc628f99"></a><!-- doxytag: member="res_smdi.c::AST_API_MODULE" ref="a805616595a796949ade4a78edc628f99" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define AST_API_MODULE</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00046">46</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="a3180eebdd34e39357d1fc13e34fa0298"></a><!-- doxytag: member="res_smdi.c::DEFAULT_POLLING_INTERVAL" ref="a3180eebdd34e39357d1fc13e34fa0298" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_POLLING_INTERVAL&nbsp;&nbsp;&nbsp;10</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>10 seconds </p>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00112">112</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00861">smdi_load()</a>.</p>

</div>
</div>
<a class="anchor" id="a0628a499b942c4fe8d3db18d4806af1e"></a><!-- doxytag: member="res_smdi.c::SMDI_MSG_EXPIRY_TIME" ref="a0628a499b942c4fe8d3db18d4806af1e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SMDI_MSG_EXPIRY_TIME&nbsp;&nbsp;&nbsp;30000</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00058">58</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00861">smdi_load()</a>.</p>

</div>
</div>
<a class="anchor" id="a3ce34b39eb6105c25220f8a98edb4cea"></a><!-- doxytag: member="res_smdi.c::SMDI_RETRIEVE_TIMEOUT_DEFAULT" ref="a3ce34b39eb6105c25220f8a98edb4cea" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SMDI_RETRIEVE_TIMEOUT_DEFAULT&nbsp;&nbsp;&nbsp;3000</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>In milliseconds </p>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01115">1115</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l01122">smdi_msg_retrieve_read()</a>.</p>

</div>
</div>
<hr/><h2>Enumeration Type Documentation</h2>
<a class="anchor" id="a775634eda7917b3f2142895169300799"></a><!-- doxytag: member="res_smdi.c::@263" ref="a775634eda7917b3f2142895169300799" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="a775634eda7917b3f2142895169300799a3d54913f4c5755501ab529da993e3314"></a><!-- doxytag: member="OPT_SEARCH_TERMINAL" ref="a775634eda7917b3f2142895169300799a3d54913f4c5755501ab529da993e3314" args="" -->OPT_SEARCH_TERMINAL</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="a775634eda7917b3f2142895169300799a07b7c8dedaab2e0ddec24d2d3e77c378"></a><!-- doxytag: member="OPT_SEARCH_NUMBER" ref="a775634eda7917b3f2142895169300799a07b7c8dedaab2e0ddec24d2d3e77c378" args="" -->OPT_SEARCH_NUMBER</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00370">370</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00370"></a>00370      {
<a name="l00371"></a>00371    <a class="code" href="res__smdi_8c.html#a775634eda7917b3f2142895169300799a3d54913f4c5755501ab529da993e3314">OPT_SEARCH_TERMINAL</a> = (1 &lt;&lt; 0),
<a name="l00372"></a>00372    <a class="code" href="res__smdi_8c.html#a775634eda7917b3f2142895169300799a07b7c8dedaab2e0ddec24d2d3e77c378">OPT_SEARCH_NUMBER</a>   = (1 &lt;&lt; 1),
<a name="l00373"></a>00373 };
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac26bfca8265a99875c72729bd604781e"></a><!-- doxytag: member="res_smdi.c::smdi_message_type" ref="ac26bfca8265a99875c72729bd604781e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4"></a><!-- doxytag: member="SMDI_MWI" ref="ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4" args="" -->SMDI_MWI</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84"></a><!-- doxytag: member="SMDI_MD" ref="ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84" args="" -->SMDI_MD</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00246">246</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00246"></a>00246                        {
<a name="l00247"></a>00247    <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>,
<a name="l00248"></a>00248    <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>,
<a name="l00249"></a>00249 };
</pre></div></p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a88b7c88fed6b80fd18f34f97757dfc04"></a><!-- doxytag: member="res_smdi.c::__reg_module" ref="a88b7c88fed6b80fd18f34f97757dfc04" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __reg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01410">1410</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="afeab1257bd17282b95875499393a147a"></a><!-- doxytag: member="res_smdi.c::__unreg_module" ref="afeab1257bd17282b95875499393a147a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __unreg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01410">1410</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="ad3ea0faf0ae5bcebd30986b4f707daaa"></a><!-- doxytag: member="res_smdi.c::alloc_smdi_interface" ref="ad3ea0faf0ae5bcebd30986b4f707daaa" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a>* alloc_smdi_interface </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00831">831</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="lock_8h_source.html#l01729">ast_cond_init()</a>, <a class="el" href="lock_8h_source.html#l01692">ast_mutex_init()</a>, <a class="el" href="astobj_8h_source.html#l00752">ASTOBJ_CONTAINER_INIT</a>, <a class="el" href="astobj_8h_source.html#l00264">ASTOBJ_INIT</a>, <a class="el" href="res__smdi_8c_source.html#l00074">ast_smdi_interface::md_q</a>, <a class="el" href="res__smdi_8c_source.html#l00076">ast_smdi_interface::md_q_cond</a>, <a class="el" href="res__smdi_8c_source.html#l00075">ast_smdi_interface::md_q_lock</a>, <a class="el" href="res__smdi_8c_source.html#l00077">ast_smdi_interface::mwi_q</a>, <a class="el" href="res__smdi_8c_source.html#l00079">ast_smdi_interface::mwi_q_cond</a>, and <a class="el" href="res__smdi_8c_source.html#l00078">ast_smdi_interface::mwi_q_lock</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00861">smdi_load()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00832"></a>00832 {
<a name="l00833"></a>00833    <span class="keyword">struct </span><a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface;
<a name="l00834"></a>00834 
<a name="l00835"></a>00835    <span class="keywordflow">if</span> (!(iface = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*iface))))
<a name="l00836"></a>00836       <span class="keywordflow">return</span> NULL;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838    <a class="code" href="astobj_8h.html#a996db3d193843755068f61f21e14c3dd" title="Initialize an object.">ASTOBJ_INIT</a>(iface);
<a name="l00839"></a>00839    <a class="code" href="astobj_8h.html#a8551f606c8aecc4797ef7728c7792827" title="Initialize a container.">ASTOBJ_CONTAINER_INIT</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a71b0ca7192d996168361d98dfc7b43a3">md_q</a>);
<a name="l00840"></a>00840    <a class="code" href="astobj_8h.html#a8551f606c8aecc4797ef7728c7792827" title="Initialize a container.">ASTOBJ_CONTAINER_INIT</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#ac0aedea441d08fd6fc7aea5ba5d22fbd">mwi_q</a>);
<a name="l00841"></a>00841 
<a name="l00842"></a>00842    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a1894293fb071c2d433189f286b67f553">md_q_lock</a>);
<a name="l00843"></a>00843    <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a4e3447ab3ab436d88d450c2e1f73df7e">md_q_cond</a>, NULL);
<a name="l00844"></a>00844 
<a name="l00845"></a>00845    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a25597a94a263390ea8f0141a01380cb6">mwi_q_lock</a>);
<a name="l00846"></a>00846    <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#aba3bce62d544689a2aeca93c36865a19">mwi_q_cond</a>, NULL);
<a name="l00847"></a>00847 
<a name="l00848"></a>00848    <span class="keywordflow">return</span> iface;
<a name="l00849"></a>00849 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aedebd1c4c85c9db863bbe6de85832a26"></a><!-- doxytag: member="res_smdi.c::append_mailbox_mapping" ref="aedebd1c4c85c9db863bbe6de85832a26" args="(struct ast_variable *var, struct ast_smdi_interface *iface)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void append_mailbox_mapping </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td>
          <td class="paramname"> <em>var</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00752">752</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="linkedlists_8h_source.html#l00715">AST_LIST_INSERT_TAIL</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="stringfields_8h_source.html#l00241">ast_string_field_init</a>, <a class="el" href="stringfields_8h_source.html#l00285">ast_string_field_set</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="chan__alsa_8c_source.html#l00105">context</a>, <a class="el" href="astmm_8h_source.html#l00084">free</a>, <a class="el" href="res__smdi_8c_source.html#l00099">mailbox_mapping::iface</a>, <a class="el" href="chan__mgcp_8c_source.html#l00185">mailbox</a>, <a class="el" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72">mwi_monitor</a>, <a class="el" href="config_8h_source.html#l00075">ast_variable::name</a>, <a class="el" href="res__smdi_8c_source.html#l00107">mailbox_mapping::smdi</a>, <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>, and <a class="el" href="config_8h_source.html#l00076">ast_variable::value</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00861">smdi_load()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00753"></a>00753 {
<a name="l00754"></a>00754    <span class="keyword">struct </span><a class="code" href="structmailbox__mapping.html" title="A mapping between an SMDI mailbox ID and an Asterisk mailbox.">mailbox_mapping</a> *mm;
<a name="l00755"></a>00755    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757    <span class="keywordflow">if</span> (!(mm = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*mm))))
<a name="l00758"></a>00758       <span class="keywordflow">return</span>;
<a name="l00759"></a>00759    
<a name="l00760"></a>00760    <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(mm, 32)) {
<a name="l00761"></a>00761       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(mm);
<a name="l00762"></a>00762       <span class="keywordflow">return</span>;
<a name="l00763"></a>00763    }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(mm, <a class="code" href="structmailbox__mapping.html#a34a6d0dbdac55fb87d709e5b3368076a">smdi</a>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00766"></a>00766 
<a name="l00767"></a>00767    context = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00768"></a>00768    mailbox = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;context, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l00769"></a>00769    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(context))
<a name="l00770"></a>00770       context = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(mm, mailbox, mailbox);
<a name="l00773"></a>00773    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(mm, context, context);
<a name="l00774"></a>00774 
<a name="l00775"></a>00775    mm-&gt;<a class="code" href="structmailbox__mapping.html#a0c21b945d5c5afe7e76693134f4c192c">iface</a> = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>(iface);
<a name="l00776"></a>00776 
<a name="l00777"></a>00777    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.lock);
<a name="l00778"></a>00778    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.mailbox_mappings, mm, <a class="code" href="structmailbox__mapping.html#a5336555b186de91c82d2beed65280843">entry</a>);
<a name="l00779"></a>00779    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.lock);
<a name="l00780"></a>00780 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a213aa83b70bccd8e7ea627308d0ba9ea"></a><!-- doxytag: member="res_smdi.c::ast_smdi_interface_destroy" ref="a213aa83b70bccd8e7ea627308d0ba9ea" args="(struct ast_smdi_interface *iface)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ast_smdi_interface_destroy </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00132">132</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01744">ast_cond_destroy()</a>, <a class="el" href="loader_8c_source.html#l01171">ast_module_unref()</a>, <a class="el" href="lock_8h_source.html#l01712">ast_mutex_destroy()</a>, <a class="el" href="lock_8h_source.html#l00082">AST_PTHREADT_NULL</a>, <a class="el" href="lock_8h_source.html#l00083">AST_PTHREADT_STOP</a>, <a class="el" href="res__smdi_8c_source.html#l00725">ast_smdi_md_message_destroy()</a>, <a class="el" href="res__smdi_8c_source.html#l00730">ast_smdi_mwi_message_destroy()</a>, <a class="el" href="astobj_8h_source.html#l00765">ASTOBJ_CONTAINER_DESTROY</a>, <a class="el" href="astobj_8h_source.html#l00453">ASTOBJ_CONTAINER_DESTROYALL</a>, <a class="el" href="res__smdi_8c_source.html#l00080">ast_smdi_interface::file</a>, <a class="el" href="astmm_8h_source.html#l00084">free</a>, <a class="el" href="res__smdi_8c_source.html#l00074">ast_smdi_interface::md_q</a>, <a class="el" href="res__smdi_8c_source.html#l00076">ast_smdi_interface::md_q_cond</a>, <a class="el" href="res__smdi_8c_source.html#l00075">ast_smdi_interface::md_q_lock</a>, <a class="el" href="res__smdi_8c_source.html#l00077">ast_smdi_interface::mwi_q</a>, <a class="el" href="res__smdi_8c_source.html#l00079">ast_smdi_interface::mwi_q_cond</a>, <a class="el" href="res__smdi_8c_source.html#l00078">ast_smdi_interface::mwi_q_lock</a>, and <a class="el" href="res__smdi_8c_source.html#l00082">ast_smdi_interface::thread</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00160">ast_smdi_interface_unref()</a>, <a class="el" href="res__smdi_8c_source.html#l00735">destroy_mailbox_mapping()</a>, <a class="el" href="res__smdi_8c_source.html#l00861">smdi_load()</a>, <a class="el" href="res__smdi_8c_source.html#l01094">smdi_msg_datastore_destroy()</a>, <a class="el" href="res__smdi_8c_source.html#l01122">smdi_msg_retrieve_read()</a>, <a class="el" href="res__smdi_8c_source.html#l00542">smdi_read()</a>, and <a class="el" href="res__smdi_8c_source.html#l01368">unload_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00133"></a>00133 {
<a name="l00134"></a>00134    <span class="keywordflow">if</span> (iface-&gt;<a class="code" href="structast__smdi__interface.html#a01f75a9ad916f63a94e06a27635ba278">thread</a> != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a> &amp;&amp; iface-&gt;<a class="code" href="structast__smdi__interface.html#a01f75a9ad916f63a94e06a27635ba278">thread</a> != <a class="code" href="lock_8h.html#a873a83eb8196323194aac2bea23d794e">AST_PTHREADT_STOP</a>) {
<a name="l00135"></a>00135       pthread_cancel(iface-&gt;<a class="code" href="structast__smdi__interface.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>);
<a name="l00136"></a>00136       pthread_join(iface-&gt;<a class="code" href="structast__smdi__interface.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>, NULL);
<a name="l00137"></a>00137    }
<a name="l00138"></a>00138    
<a name="l00139"></a>00139    iface-&gt;<a class="code" href="structast__smdi__interface.html#a01f75a9ad916f63a94e06a27635ba278">thread</a> = <a class="code" href="lock_8h.html#a873a83eb8196323194aac2bea23d794e">AST_PTHREADT_STOP</a>;
<a name="l00140"></a>00140    
<a name="l00141"></a>00141    <span class="keywordflow">if</span> (iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a>) 
<a name="l00142"></a>00142       fclose(iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a>);
<a name="l00143"></a>00143    
<a name="l00144"></a>00144    <a class="code" href="astobj_8h.html#a5b923418ce1d4908359bb3b27b211411" title="Empty a container.">ASTOBJ_CONTAINER_DESTROYALL</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a71b0ca7192d996168361d98dfc7b43a3">md_q</a>, <a class="code" href="smdi_8h.html#a408e56a27064d1537eb6e4accf73e6bf" title="ast_smdi_md_message destructor.">ast_smdi_md_message_destroy</a>);
<a name="l00145"></a>00145    <a class="code" href="astobj_8h.html#a5b923418ce1d4908359bb3b27b211411" title="Empty a container.">ASTOBJ_CONTAINER_DESTROYALL</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#ac0aedea441d08fd6fc7aea5ba5d22fbd">mwi_q</a>, <a class="code" href="smdi_8h.html#adbf3873da6231af24d5a38113d6a8def" title="ast_smdi_mwi_message destructor.">ast_smdi_mwi_message_destroy</a>);
<a name="l00146"></a>00146    <a class="code" href="astobj_8h.html#a49ab9467549d53be33f3f9f3ecae97f9" title="Destroy a container.">ASTOBJ_CONTAINER_DESTROY</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a71b0ca7192d996168361d98dfc7b43a3">md_q</a>);
<a name="l00147"></a>00147    <a class="code" href="astobj_8h.html#a49ab9467549d53be33f3f9f3ecae97f9" title="Destroy a container.">ASTOBJ_CONTAINER_DESTROY</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#ac0aedea441d08fd6fc7aea5ba5d22fbd">mwi_q</a>);
<a name="l00148"></a>00148 
<a name="l00149"></a>00149    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a1894293fb071c2d433189f286b67f553">md_q_lock</a>);
<a name="l00150"></a>00150    <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a4e3447ab3ab436d88d450c2e1f73df7e">md_q_cond</a>);
<a name="l00151"></a>00151 
<a name="l00152"></a>00152    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a25597a94a263390ea8f0141a01380cb6">mwi_q_lock</a>);
<a name="l00153"></a>00153    <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#aba3bce62d544689a2aeca93c36865a19">mwi_q_cond</a>);
<a name="l00154"></a>00154 
<a name="l00155"></a>00155    <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(iface);
<a name="l00156"></a>00156 
<a name="l00157"></a>00157    <a class="code" href="module_8h.html#ac65fa15b16dbc563a2424af744ab003d">ast_module_unref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l00158"></a>00158 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac5e5c2f622f22084f67a01e8f12eab8d"></a><!-- doxytag: member="res_smdi.c::ast_smdi_interface_find" ref="ac5e5c2f622f22084f67a01e8f12eab8d" args="(const char *iface_name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a>* ast_smdi_interface_find </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>iface_name</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Find an SMDI interface with the specified name. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>iface_name</em>&nbsp;</td><td>the name/port of the interface to search for.</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>a pointer to the interface located or NULL if none was found. This actually returns an ASTOBJ reference and should be released using <a class="el" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF(iface, ast_smdi_interface_destroy)</a>. </dd></dl>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00528">528</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, and <a class="el" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9">smdi_ifaces</a>.</p>

<p>Referenced by <a class="el" href="app__voicemail_8c_source.html#l10603">load_config()</a>, <a class="el" href="chan__dahdi_8c_source.html#l09990">mkintf()</a>, and <a class="el" href="res__smdi_8c_source.html#l01122">smdi_msg_retrieve_read()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00529"></a>00529 {
<a name="l00530"></a>00530    <span class="keywordflow">return</span> (<a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>, iface_name));
<a name="l00531"></a>00531 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9de8197068a3ea0bf4d808b8d8671b3e"></a><!-- doxytag: member="res_smdi.c::ast_smdi_interface_unref" ref="a9de8197068a3ea0bf4d808b8d8671b3e" args="(struct ast_smdi_interface *iface)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_smdi_interface_unref </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00160">160</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00132">ast_smdi_interface_destroy()</a>, and <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>.</p>

<p>Referenced by <a class="el" href="chan__dahdi_8c_source.html#l03856">destroy_dahdi_pvt()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00161"></a>00161 {
<a name="l00162"></a>00162    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l00163"></a>00163 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a93d0f6a07f05b426c70b5e7b79c17966"></a><!-- doxytag: member="res_smdi.c::ast_smdi_md_message_destroy" ref="a93d0f6a07f05b426c70b5e7b79c17966" args="(struct ast_smdi_md_message *msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_smdi_md_message_destroy </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *&nbsp;</td>
          <td class="paramname"> <em>msg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><a class="el" href="structast__smdi__md__message.html" title="An SMDI message desk message.">ast_smdi_md_message</a> destructor. </p>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00725">725</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00132">ast_smdi_interface_destroy()</a>, <a class="el" href="res__smdi_8c_source.html#l01094">smdi_msg_datastore_destroy()</a>, <a class="el" href="res__smdi_8c_source.html#l01122">smdi_msg_retrieve_read()</a>, <a class="el" href="res__smdi_8c_source.html#l00542">smdi_read()</a>, <a class="el" href="chan__dahdi_8c_source.html#l07675">ss_thread()</a>, and <a class="el" href="res__smdi_8c_source.html#l00301">unref_msg()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00726"></a>00726 {
<a name="l00727"></a>00727    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(msg);
<a name="l00728"></a>00728 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a94dd57643d9e22a7328e4a5779249aaf"></a><!-- doxytag: member="res_smdi.c::ast_smdi_md_message_pop" ref="a94dd57643d9e22a7328e4a5779249aaf" args="(struct ast_smdi_interface *iface)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__smdi__md__message.html">ast_smdi_md_message</a>* ast_smdi_md_message_pop </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get the next SMDI <a class="el" href="structmessage.html">message</a> from the queue. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>iface</em>&nbsp;</td><td>a pointer to the interface to use.</td></tr>
  </table>
  </dd>
</dl>
<p>This function pulls the first unexpired <a class="el" href="structmessage.html">message</a> from the SMDI <a class="el" href="structmessage.html">message</a> queue on the specified interface. It will purge all expired SMDI messages before returning.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>the next SMDI <a class="el" href="structmessage.html">message</a>, or NULL if there were no pending messages. </dd></dl>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00499">499</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00248">SMDI_MD</a>, and <a class="el" href="res__smdi_8c_source.html#l00357">smdi_msg_pop()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00500"></a>00500 {
<a name="l00501"></a>00501    <span class="keywordflow">return</span> <a class="code" href="res__smdi_8c.html#a65b6dc916b3e2d052d6afc00d5f26cee">smdi_msg_pop</a>(iface, <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>);
<a name="l00502"></a>00502 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a539e23e0762cb4032cd69b241b650f3c"></a><!-- doxytag: member="res_smdi.c::ast_smdi_md_message_push" ref="a539e23e0762cb4032cd69b241b650f3c" args="(struct ast_smdi_interface *iface, struct ast_smdi_md_message *md_msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ast_smdi_md_message_push </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *&nbsp;</td>
          <td class="paramname"> <em>md_msg</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00171">171</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01739">ast_cond_broadcast()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="astobj_8h_source.html#l00580">ASTOBJ_CONTAINER_LINK_END</a>, <a class="el" href="res__smdi_8c_source.html#l00074">ast_smdi_interface::md_q</a>, <a class="el" href="res__smdi_8c_source.html#l00076">ast_smdi_interface::md_q_cond</a>, and <a class="el" href="res__smdi_8c_source.html#l00075">ast_smdi_interface::md_q_lock</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00316">purge_old_messages()</a>, and <a class="el" href="res__smdi_8c_source.html#l00542">smdi_read()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00172"></a>00172 {
<a name="l00173"></a>00173    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a1894293fb071c2d433189f286b67f553">md_q_lock</a>);
<a name="l00174"></a>00174    <a class="code" href="astobj_8h.html#a0133062dfa738a600b244275c03a15ac" title="Add an object to the end of a container.">ASTOBJ_CONTAINER_LINK_END</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a71b0ca7192d996168361d98dfc7b43a3">md_q</a>, md_msg);
<a name="l00175"></a>00175    <a class="code" href="lock_8h.html#a466651f89bf35b22f320a2fcf1f18113">ast_cond_broadcast</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a4e3447ab3ab436d88d450c2e1f73df7e">md_q_cond</a>);
<a name="l00176"></a>00176    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a1894293fb071c2d433189f286b67f553">md_q_lock</a>);
<a name="l00177"></a>00177 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac10ace25064086876ed8348052cf73ba"></a><!-- doxytag: member="res_smdi.c::ast_smdi_md_message_putback" ref="ac10ace25064086876ed8348052cf73ba" args="(struct ast_smdi_interface *iface, struct ast_smdi_md_message *md_msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_smdi_md_message_putback </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *&nbsp;</td>
          <td class="paramname"> <em>msg</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Put an SMDI <a class="el" href="structmessage.html">message</a> back in the front of the queue. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>iface</em>&nbsp;</td><td>a pointer to the interface to use. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>md_msg</em>&nbsp;</td><td>a pointer to the <a class="el" href="structmessage.html">message</a> to use.</td></tr>
  </table>
  </dd>
</dl>
<p>This function puts a <a class="el" href="structmessage.html">message</a> back in the front of the specified queue. It should be used if a <a class="el" href="structmessage.html">message</a> was popped but is not going to be processed for some reason, and the <a class="el" href="structmessage.html">message</a> needs to be returned to the queue. </p>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00230">230</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01739">ast_cond_broadcast()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="astobj_8h_source.html#l00610">ASTOBJ_CONTAINER_LINK_START</a>, <a class="el" href="res__smdi_8c_source.html#l00074">ast_smdi_interface::md_q</a>, <a class="el" href="res__smdi_8c_source.html#l00076">ast_smdi_interface::md_q_cond</a>, and <a class="el" href="res__smdi_8c_source.html#l00075">ast_smdi_interface::md_q_lock</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00231"></a>00231 {
<a name="l00232"></a>00232    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a1894293fb071c2d433189f286b67f553">md_q_lock</a>);
<a name="l00233"></a>00233    <a class="code" href="astobj_8h.html#afcb742aeb1fcf29e0f2ae75b6f9e0bd2" title="Add an object to the front of a container.">ASTOBJ_CONTAINER_LINK_START</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a71b0ca7192d996168361d98dfc7b43a3">md_q</a>, md_msg);
<a name="l00234"></a>00234    <a class="code" href="lock_8h.html#a466651f89bf35b22f320a2fcf1f18113">ast_cond_broadcast</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a4e3447ab3ab436d88d450c2e1f73df7e">md_q_cond</a>);
<a name="l00235"></a>00235    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a1894293fb071c2d433189f286b67f553">md_q_lock</a>);
<a name="l00236"></a>00236 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a74b97e1c1bcaa07659fdf57107e0a69e"></a><!-- doxytag: member="res_smdi.c::ast_smdi_md_message_wait" ref="a74b97e1c1bcaa07659fdf57107e0a69e" args="(struct ast_smdi_interface *iface, int timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__smdi__md__message.html">ast_smdi_md_message</a>* ast_smdi_md_message_wait </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get the next SMDI <a class="el" href="structmessage.html">message</a> from the queue. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>iface</em>&nbsp;</td><td>a pointer to the interface to use. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>timeout</em>&nbsp;</td><td>the time to wait before returning in milliseconds.</td></tr>
  </table>
  </dd>
</dl>
<p>This function pulls a <a class="el" href="structmessage.html">message</a> from the SMDI <a class="el" href="structmessage.html">message</a> queue on the specified interface. If no <a class="el" href="structmessage.html">message</a> is available this function will wait the specified amount of time before returning.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>the next SMDI <a class="el" href="structmessage.html">message</a>, or NULL if there were no pending messages and the timeout has expired. </dd></dl>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00504">504</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00248">SMDI_MD</a>, and <a class="el" href="res__smdi_8c_source.html#l00443">smdi_message_wait()</a>.</p>

<p>Referenced by <a class="el" href="chan__dahdi_8c_source.html#l07675">ss_thread()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00505"></a>00505 {
<a name="l00506"></a>00506    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> options = { 0 };
<a name="l00507"></a>00507    <span class="keywordflow">return</span> <a class="code" href="res__smdi_8c.html#a50ede8e5a94567acefe2a29fbef4e4c0">smdi_message_wait</a>(iface, timeout, <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>, NULL, options);
<a name="l00508"></a>00508 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a22233cce8c423cccc2ff7537b5c6c6f8"></a><!-- doxytag: member="res_smdi.c::ast_smdi_mwi_message_destroy" ref="a22233cce8c423cccc2ff7537b5c6c6f8" args="(struct ast_smdi_mwi_message *msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_smdi_mwi_message_destroy </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *&nbsp;</td>
          <td class="paramname"> <em>msg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><a class="el" href="structast__smdi__mwi__message.html" title="An SMDI message waiting indicator message.">ast_smdi_mwi_message</a> destructor. </p>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00730">730</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00132">ast_smdi_interface_destroy()</a>, <a class="el" href="app__voicemail_8c_source.html#l05078">run_externnotify()</a>, <a class="el" href="res__smdi_8c_source.html#l00542">smdi_read()</a>, and <a class="el" href="res__smdi_8c_source.html#l00301">unref_msg()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00731"></a>00731 {
<a name="l00732"></a>00732    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(msg);
<a name="l00733"></a>00733 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3ec7db2b5c86856bc1cfbbbc186edf0e"></a><!-- doxytag: member="res_smdi.c::ast_smdi_mwi_message_pop" ref="a3ec7db2b5c86856bc1cfbbbc186edf0e" args="(struct ast_smdi_interface *iface)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a>* ast_smdi_mwi_message_pop </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get the next SMDI <a class="el" href="structmessage.html">message</a> from the queue. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>iface</em>&nbsp;</td><td>a pointer to the interface to use.</td></tr>
  </table>
  </dd>
</dl>
<p>This function pulls the first unexpired <a class="el" href="structmessage.html">message</a> from the SMDI <a class="el" href="structmessage.html">message</a> queue on the specified interface. It will purge all expired SMDI messages before returning.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>the next SMDI <a class="el" href="structmessage.html">message</a>, or NULL if there were no pending messages. </dd></dl>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00510">510</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00357">smdi_msg_pop()</a>, and <a class="el" href="res__smdi_8c_source.html#l00247">SMDI_MWI</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00511"></a>00511 {
<a name="l00512"></a>00512    <span class="keywordflow">return</span> <a class="code" href="res__smdi_8c.html#a65b6dc916b3e2d052d6afc00d5f26cee">smdi_msg_pop</a>(iface, <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>);
<a name="l00513"></a>00513 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a912ab4e78c7db772efa012cf8bfba4ed"></a><!-- doxytag: member="res_smdi.c::ast_smdi_mwi_message_push" ref="a912ab4e78c7db772efa012cf8bfba4ed" args="(struct ast_smdi_interface *iface, struct ast_smdi_mwi_message *mwi_msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ast_smdi_mwi_message_push </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *&nbsp;</td>
          <td class="paramname"> <em>mwi_msg</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00185">185</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01739">ast_cond_broadcast()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="astobj_8h_source.html#l00580">ASTOBJ_CONTAINER_LINK_END</a>, <a class="el" href="res__smdi_8c_source.html#l00077">ast_smdi_interface::mwi_q</a>, <a class="el" href="res__smdi_8c_source.html#l00079">ast_smdi_interface::mwi_q_cond</a>, and <a class="el" href="res__smdi_8c_source.html#l00078">ast_smdi_interface::mwi_q_lock</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00316">purge_old_messages()</a>, and <a class="el" href="res__smdi_8c_source.html#l00542">smdi_read()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00186"></a>00186 {
<a name="l00187"></a>00187    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a25597a94a263390ea8f0141a01380cb6">mwi_q_lock</a>);
<a name="l00188"></a>00188    <a class="code" href="astobj_8h.html#a0133062dfa738a600b244275c03a15ac" title="Add an object to the end of a container.">ASTOBJ_CONTAINER_LINK_END</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#ac0aedea441d08fd6fc7aea5ba5d22fbd">mwi_q</a>, mwi_msg);
<a name="l00189"></a>00189    <a class="code" href="lock_8h.html#a466651f89bf35b22f320a2fcf1f18113">ast_cond_broadcast</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#aba3bce62d544689a2aeca93c36865a19">mwi_q_cond</a>);
<a name="l00190"></a>00190    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a25597a94a263390ea8f0141a01380cb6">mwi_q_lock</a>);
<a name="l00191"></a>00191 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad56b18d4fd6a3b5335d7de6ca9eef8e8"></a><!-- doxytag: member="res_smdi.c::ast_smdi_mwi_message_putback" ref="ad56b18d4fd6a3b5335d7de6ca9eef8e8" args="(struct ast_smdi_interface *iface, struct ast_smdi_mwi_message *mwi_msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_smdi_mwi_message_putback </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *&nbsp;</td>
          <td class="paramname"> <em>msg</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Put an SMDI <a class="el" href="structmessage.html">message</a> back in the front of the queue. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>iface</em>&nbsp;</td><td>a pointer to the interface to use. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>mwi_msg</em>&nbsp;</td><td>a pointer to the <a class="el" href="structmessage.html">message</a> to use.</td></tr>
  </table>
  </dd>
</dl>
<p>This function puts a <a class="el" href="structmessage.html">message</a> back in the front of the specified queue. It should be used if a <a class="el" href="structmessage.html">message</a> was popped but is not going to be processed for some reason, and the <a class="el" href="structmessage.html">message</a> needs to be returned to the queue. </p>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00238">238</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01739">ast_cond_broadcast()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="astobj_8h_source.html#l00610">ASTOBJ_CONTAINER_LINK_START</a>, <a class="el" href="res__smdi_8c_source.html#l00077">ast_smdi_interface::mwi_q</a>, <a class="el" href="res__smdi_8c_source.html#l00079">ast_smdi_interface::mwi_q_cond</a>, and <a class="el" href="res__smdi_8c_source.html#l00078">ast_smdi_interface::mwi_q_lock</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00239"></a>00239 {
<a name="l00240"></a>00240    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a25597a94a263390ea8f0141a01380cb6">mwi_q_lock</a>);
<a name="l00241"></a>00241    <a class="code" href="astobj_8h.html#afcb742aeb1fcf29e0f2ae75b6f9e0bd2" title="Add an object to the front of a container.">ASTOBJ_CONTAINER_LINK_START</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#ac0aedea441d08fd6fc7aea5ba5d22fbd">mwi_q</a>, mwi_msg);
<a name="l00242"></a>00242    <a class="code" href="lock_8h.html#a466651f89bf35b22f320a2fcf1f18113">ast_cond_broadcast</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#aba3bce62d544689a2aeca93c36865a19">mwi_q_cond</a>);
<a name="l00243"></a>00243    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a25597a94a263390ea8f0141a01380cb6">mwi_q_lock</a>);
<a name="l00244"></a>00244 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a4b4f48bf27efd32d7c276677e2d9221b"></a><!-- doxytag: member="res_smdi.c::ast_smdi_mwi_message_wait" ref="a4b4f48bf27efd32d7c276677e2d9221b" args="(struct ast_smdi_interface *iface, int timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a>* ast_smdi_mwi_message_wait </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get the next SMDI <a class="el" href="structmessage.html">message</a> from the queue. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>iface</em>&nbsp;</td><td>a pointer to the interface to use. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>timeout</em>&nbsp;</td><td>the time to wait before returning in milliseconds.</td></tr>
  </table>
  </dd>
</dl>
<p>This function pulls a <a class="el" href="structmessage.html">message</a> from the SMDI <a class="el" href="structmessage.html">message</a> queue on the specified interface. If no <a class="el" href="structmessage.html">message</a> is available this function will wait the specified amount of time before returning.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>the next SMDI <a class="el" href="structmessage.html">message</a>, or NULL if there were no pending messages and the timeout has expired. </dd></dl>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00515">515</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00443">smdi_message_wait()</a>, and <a class="el" href="res__smdi_8c_source.html#l00247">SMDI_MWI</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00516"></a>00516 {
<a name="l00517"></a>00517    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> options = { 0 };
<a name="l00518"></a>00518    <span class="keywordflow">return</span> <a class="code" href="res__smdi_8c.html#a50ede8e5a94567acefe2a29fbef4e4c0">smdi_message_wait</a>(iface, timeout, <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>, NULL, options);
<a name="l00519"></a>00519 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a57edcf9aa93ccef269ad6ba1d2222609"></a><!-- doxytag: member="res_smdi.c::ast_smdi_mwi_message_wait_station" ref="a57edcf9aa93ccef269ad6ba1d2222609" args="(struct ast_smdi_interface *iface, int timeout, const char *station)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a>* ast_smdi_mwi_message_wait_station </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>station</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00521">521</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00443">smdi_message_wait()</a>, and <a class="el" href="res__smdi_8c_source.html#l00247">SMDI_MWI</a>.</p>

<p>Referenced by <a class="el" href="app__voicemail_8c_source.html#l05078">run_externnotify()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00523"></a>00523 {
<a name="l00524"></a>00524    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> options = { 0 };
<a name="l00525"></a>00525    <span class="keywordflow">return</span> <a class="code" href="res__smdi_8c.html#a50ede8e5a94567acefe2a29fbef4e4c0">smdi_message_wait</a>(iface, timeout, <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>, station, options);
<a name="l00526"></a>00526 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6c1ad3c56eeed633ea2f8c9efabe66ba"></a><!-- doxytag: member="res_smdi.c::ast_smdi_mwi_set" ref="a6c1ad3c56eeed633ea2f8c9efabe66ba" args="(struct ast_smdi_interface *iface, const char *mailbox)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_smdi_mwi_set </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>mailbox</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Set the MWI indicator for a mailbox. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>iface</em>&nbsp;</td><td>the interface to use. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>mailbox</em>&nbsp;</td><td>the mailbox to use. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00220">220</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00193">smdi_toggle_mwi()</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00785">poll_mailbox()</a>, and <a class="el" href="app__voicemail_8c_source.html#l05078">run_externnotify()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00221"></a>00221 {
<a name="l00222"></a>00222    <span class="keywordflow">return</span> <a class="code" href="res__smdi_8c.html#a7e881b24835a2254e43d88f68d052e55">smdi_toggle_mwi</a>(iface, <a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, 1);
<a name="l00223"></a>00223 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9debceb53aa38da429365ca91e50cd35"></a><!-- doxytag: member="res_smdi.c::ast_smdi_mwi_unset" ref="a9debceb53aa38da429365ca91e50cd35" args="(struct ast_smdi_interface *iface, const char *mailbox)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_smdi_mwi_unset </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>mailbox</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Unset the MWI indicator for a mailbox. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>iface</em>&nbsp;</td><td>the interface to use. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>mailbox</em>&nbsp;</td><td>the mailbox to use. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00225">225</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00193">smdi_toggle_mwi()</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00785">poll_mailbox()</a>, and <a class="el" href="app__voicemail_8c_source.html#l05078">run_externnotify()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00226"></a>00226 {
<a name="l00227"></a>00227    <span class="keywordflow">return</span> <a class="code" href="res__smdi_8c.html#a7e881b24835a2254e43d88f68d052e55">smdi_toggle_mwi</a>(iface, <a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, 0);
<a name="l00228"></a>00228 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa8dcf5c17e8d6f96acfe863feb6efadc"></a><!-- doxytag: member="res_smdi.c::destroy_all_mailbox_mappings" ref="aa8dcf5c17e8d6f96acfe863feb6efadc" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void destroy_all_mailbox_mappings </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00742">742</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="linkedlists_8h_source.html#l00817">AST_LIST_REMOVE_HEAD</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="res__smdi_8c_source.html#l00735">destroy_mailbox_mapping()</a>, and <a class="el" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72">mwi_monitor</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00861">smdi_load()</a>, and <a class="el" href="res__smdi_8c_source.html#l01368">unload_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00743"></a>00743 {
<a name="l00744"></a>00744    <span class="keyword">struct </span><a class="code" href="structmailbox__mapping.html" title="A mapping between an SMDI mailbox ID and an Asterisk mailbox.">mailbox_mapping</a> *mm;
<a name="l00745"></a>00745 
<a name="l00746"></a>00746    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.lock);
<a name="l00747"></a>00747    <span class="keywordflow">while</span> ((mm = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.mailbox_mappings, <a class="code" href="structmailbox__mapping.html#a5336555b186de91c82d2beed65280843">entry</a>)))
<a name="l00748"></a>00748       <a class="code" href="res__smdi_8c.html#a5f83379eaba5ad5f548bfd95560337b6">destroy_mailbox_mapping</a>(mm);
<a name="l00749"></a>00749    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.lock);
<a name="l00750"></a>00750 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5f83379eaba5ad5f548bfd95560337b6"></a><!-- doxytag: member="res_smdi.c::destroy_mailbox_mapping" ref="a5f83379eaba5ad5f548bfd95560337b6" args="(struct mailbox_mapping *mm)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void destroy_mailbox_mapping </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structmailbox__mapping.html">mailbox_mapping</a> *&nbsp;</td>
          <td class="paramname"> <em>mm</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00735">735</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00132">ast_smdi_interface_destroy()</a>, <a class="el" href="stringfields_8h_source.html#l00245">ast_string_field_free_memory</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="astmm_8h_source.html#l00084">free</a>, and <a class="el" href="res__smdi_8c_source.html#l00099">mailbox_mapping::iface</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00742">destroy_all_mailbox_mappings()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00736"></a>00736 {
<a name="l00737"></a>00737    <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(mm);
<a name="l00738"></a>00738    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(mm-&gt;<a class="code" href="structmailbox__mapping.html#a0c21b945d5c5afe7e76693134f4c192c">iface</a>, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l00739"></a>00739    <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(mm);
<a name="l00740"></a>00740 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac3382bf6da54c56b37069bd76bbdf4f9"></a><!-- doxytag: member="res_smdi.c::load_module" ref="ac3382bf6da54c56b37069bd76bbdf4f9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01340">1340</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01729">ast_cond_init()</a>, <a class="el" href="pbx_8h_source.html#l01028">ast_custom_function_register</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="module_8h_source.html#l00062">AST_MODULE_LOAD_DECLINE</a>, <a class="el" href="module_8h_source.html#l00061">AST_MODULE_LOAD_SUCCESS</a>, <a class="el" href="lock_8h_source.html#l01692">ast_mutex_init()</a>, <a class="el" href="astobj_8h_source.html#l00752">ASTOBJ_CONTAINER_INIT</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72">mwi_monitor</a>, <a class="el" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9">smdi_ifaces</a>, <a class="el" href="res__smdi_8c_source.html#l00861">smdi_load()</a>, and <a class="el" href="agent_8c_source.html#l00071">unload_module</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01341"></a>01341 {
<a name="l01342"></a>01342    <span class="keywordtype">int</span> res;
<a name="l01343"></a>01343    
<a name="l01344"></a>01344    <span class="comment">/* initialize our containers */</span>
<a name="l01345"></a>01345    memset(&amp;<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>));
<a name="l01346"></a>01346    <a class="code" href="astobj_8h.html#a8551f606c8aecc4797ef7728c7792827" title="Initialize a container.">ASTOBJ_CONTAINER_INIT</a>(&amp;<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>);
<a name="l01347"></a>01347    
<a name="l01348"></a>01348    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.lock);
<a name="l01349"></a>01349    <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.cond, NULL);
<a name="l01350"></a>01350 
<a name="l01351"></a>01351    <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;<a class="code" href="res__smdi_8c.html#ae571eca2127e70a65dd831104c03dbe7">smdi_msg_retrieve_function</a>);
<a name="l01352"></a>01352    <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;<a class="code" href="res__smdi_8c.html#a128dbd1032b7d4c41879b13dbe5a8734">smdi_msg_function</a>);
<a name="l01353"></a>01353 
<a name="l01354"></a>01354    <span class="comment">/* load the config and start the listener threads*/</span>
<a name="l01355"></a>01355    res = <a class="code" href="res__smdi_8c.html#ae78e2818ae561f95b462d1b50eda7f7d">smdi_load</a>(0);
<a name="l01356"></a>01356    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01357"></a>01357       <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>();
<a name="l01358"></a>01358       <span class="keywordflow">return</span> res;
<a name="l01359"></a>01359    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == 1) {
<a name="l01360"></a>01360       <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>();
<a name="l01361"></a>01361       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No SMDI interfaces are available to listen on, not starting SMDI listener.\n&quot;</span>);
<a name="l01362"></a>01362       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01363"></a>01363    }
<a name="l01364"></a>01364    
<a name="l01365"></a>01365    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l01366"></a>01366 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aabeaf259ac09253ebae4b4ed0072e677"></a><!-- doxytag: member="res_smdi.c::lock_msg_q" ref="aabeaf259ac09253ebae4b4ed0072e677" args="(struct ast_smdi_interface *iface, enum smdi_message_type type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lock_msg_q </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a>&nbsp;</td>
          <td class="paramname"> <em>type</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00251">251</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="res__smdi_8c_source.html#l00075">ast_smdi_interface::md_q_lock</a>, <a class="el" href="res__smdi_8c_source.html#l00078">ast_smdi_interface::mwi_q_lock</a>, <a class="el" href="res__smdi_8c_source.html#l00248">SMDI_MD</a>, and <a class="el" href="res__smdi_8c_source.html#l00247">SMDI_MWI</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00316">purge_old_messages()</a>, <a class="el" href="res__smdi_8c_source.html#l00443">smdi_message_wait()</a>, and <a class="el" href="res__smdi_8c_source.html#l00357">smdi_msg_pop()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00252"></a>00252 {
<a name="l00253"></a>00253    <span class="keywordflow">switch</span> (<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>) {
<a name="l00254"></a>00254    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>:
<a name="l00255"></a>00255       <span class="keywordflow">return</span> <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a25597a94a263390ea8f0141a01380cb6">mwi_q_lock</a>);
<a name="l00256"></a>00256    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>:  
<a name="l00257"></a>00257       <span class="keywordflow">return</span> <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a1894293fb071c2d433189f286b67f553">md_q_lock</a>);
<a name="l00258"></a>00258    }
<a name="l00259"></a>00259    
<a name="l00260"></a>00260    <span class="keywordflow">return</span> -1;
<a name="l00261"></a>00261 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2444f5f2c850374177edbc157a112c99"></a><!-- doxytag: member="res_smdi.c::msg_timestamp" ref="a2444f5f2c850374177edbc157a112c99" args="(void *msg, enum smdi_message_type type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct timeval msg_timestamp </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a>&nbsp;</td>
          <td class="paramname"> <em>type</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00286">286</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="time_8h_source.html#l00164">ast_tv()</a>, <a class="el" href="adsistub_8c_source.html#l00055">msg</a>, <a class="el" href="res__smdi_8c_source.html#l00248">SMDI_MD</a>, <a class="el" href="res__smdi_8c_source.html#l00247">SMDI_MWI</a>, <a class="el" href="smdi_8h_source.html#l00075">ast_smdi_md_message::timestamp</a>, <a class="el" href="smdi_8h_source.html#l00058">ast_smdi_mwi_message::timestamp</a>, and <a class="el" href="evt_8c_source.html#l00071">type</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00316">purge_old_messages()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00287"></a>00287 {
<a name="l00288"></a>00288    <span class="keyword">struct </span><a class="code" href="structast__smdi__md__message.html" title="An SMDI message desk message.">ast_smdi_md_message</a> *md_msg = <a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>;
<a name="l00289"></a>00289    <span class="keyword">struct </span><a class="code" href="structast__smdi__mwi__message.html" title="An SMDI message waiting indicator message.">ast_smdi_mwi_message</a> *mwi_msg = <a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291    <span class="keywordflow">switch</span> (<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>) {
<a name="l00292"></a>00292    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>:
<a name="l00293"></a>00293       <span class="keywordflow">return</span> mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#a175ebf16736553ad076aefe3f02d180c">timestamp</a>;
<a name="l00294"></a>00294    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>:
<a name="l00295"></a>00295       <span class="keywordflow">return</span> md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a175ebf16736553ad076aefe3f02d180c">timestamp</a>;
<a name="l00296"></a>00296    }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298    <span class="keywordflow">return</span> <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0, 0);
<a name="l00299"></a>00299 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a825180f65e43db5b6d50b43f3a64dfda"></a><!-- doxytag: member="res_smdi.c::mwi_monitor_handler" ref="a825180f65e43db5b6d50b43f3a64dfda" args="(void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* mwi_monitor_handler </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00804">804</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01754">ast_cond_timedwait()</a>, <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="time_8h_source.html#l00164">ast_tv()</a>, <a class="el" href="utils_8c_source.html#l01365">ast_tvadd()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72">mwi_monitor</a>, and <a class="el" href="res__smdi_8c_source.html#l00785">poll_mailbox()</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00861">smdi_load()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00805"></a>00805 {
<a name="l00806"></a>00806    <span class="keywordflow">while</span> (!<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.stop) {
<a name="l00807"></a>00807       <span class="keyword">struct </span>timespec ts = { 0, };
<a name="l00808"></a>00808       <span class="keyword">struct </span>timeval polltime;
<a name="l00809"></a>00809       <span class="keyword">struct </span><a class="code" href="structmailbox__mapping.html" title="A mapping between an SMDI mailbox ID and an Asterisk mailbox.">mailbox_mapping</a> *mm;
<a name="l00810"></a>00810 
<a name="l00811"></a>00811       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.lock);
<a name="l00812"></a>00812 
<a name="l00813"></a>00813       <a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.last_poll = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00814"></a>00814 
<a name="l00815"></a>00815       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.mailbox_mappings, mm, <a class="code" href="structmailbox__mapping.html#a5336555b186de91c82d2beed65280843">entry</a>)
<a name="l00816"></a>00816          <a class="code" href="res__smdi_8c.html#a6c34212eb77de40eba9366761c519425">poll_mailbox</a>(mm);
<a name="l00817"></a>00817 
<a name="l00818"></a>00818       <span class="comment">/* Sleep up to the configured polling interval.  Allow unload_module()</span>
<a name="l00819"></a>00819 <span class="comment">       * to signal us to wake up and exit. */</span>
<a name="l00820"></a>00820       polltime = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.<a class="code" href="res__smdi_8c.html#acfe0553b07ce04ccd0001791aa20ccd2">last_poll</a>, <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.<a class="code" href="res__smdi_8c.html#a392d1e08448d735437a3ee22460e1bc5">polling_interval</a>, 0));
<a name="l00821"></a>00821       ts.tv_sec = polltime.tv_sec;
<a name="l00822"></a>00822       ts.tv_nsec = polltime.tv_usec * 1000;
<a name="l00823"></a>00823       <a class="code" href="lock_8h.html#aa6fec4bba2b7190b94a1a4c7b6c541a4">ast_cond_timedwait</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.<a class="code" href="app__meetme_8c.html#a1c7181c39f99ee801943a0d0aa9872b9">cond</a>, &amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.<a class="code" href="app__meetme_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>, &amp;ts);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.lock);
<a name="l00826"></a>00826    }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828    return NULL;
<a name="l00829"></a>00829 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6c34212eb77de40eba9366761c519425"></a><!-- doxytag: member="res_smdi.c::poll_mailbox" ref="a6c34212eb77de40eba9366761c519425" args="(struct mailbox_mapping *mm)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void poll_mailbox </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structmailbox__mapping.html">mailbox_mapping</a> *&nbsp;</td>
          <td class="paramname"> <em>mm</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl class="note"><dt><b>Note:</b></dt><dd>Called with the <a class="el" href="res__timing__pthread_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">mwi_monitor.lock</a> locked </dd></dl>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00785">785</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="app_8c_source.html#l00234">ast_app_has_voicemail()</a>, <a class="el" href="res__smdi_8c_source.html#l00220">ast_smdi_mwi_set()</a>, <a class="el" href="res__smdi_8c_source.html#l00225">ast_smdi_mwi_unset()</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="res__smdi_8c_source.html#l00107">mailbox_mapping::context</a>, <a class="el" href="res__smdi_8c_source.html#l00097">mailbox_mapping::cur_state</a>, <a class="el" href="res__smdi_8c_source.html#l00099">mailbox_mapping::iface</a>, <a class="el" href="res__smdi_8c_source.html#l00107">mailbox_mapping::mailbox</a>, and <a class="el" href="res__smdi_8c_source.html#l00107">mailbox_mapping::smdi</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00804">mwi_monitor_handler()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00786"></a>00786 {
<a name="l00787"></a>00787    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[1024];
<a name="l00788"></a>00788    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>;
<a name="l00789"></a>00789 
<a name="l00790"></a>00790    snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;%s@%s&quot;</span>, mm-&gt;<a class="code" href="structmailbox__mapping.html#aea357396b4d70e149a76d9911689eb4b">mailbox</a>, mm-&gt;<a class="code" href="structmailbox__mapping.html#a7faec841658b88ad0cfbc684853acad3">context</a>);
<a name="l00791"></a>00791 
<a name="l00792"></a>00792    state = !!<a class="code" href="app_8h.html#ae5953304e56862ac7efc1fed0ac6732f" title="Determine if a given mailbox has any voicemail If folder is NULL, defaults to &amp;quot;INBOX&amp;quot;...">ast_app_has_voicemail</a>(mm-&gt;<a class="code" href="structmailbox__mapping.html#aea357396b4d70e149a76d9911689eb4b">mailbox</a>, NULL);
<a name="l00793"></a>00793 
<a name="l00794"></a>00794    <span class="keywordflow">if</span> (state != mm-&gt;<a class="code" href="structmailbox__mapping.html#a6c5899039878a4a6977779aaa8bbf285">cur_state</a>) {
<a name="l00795"></a>00795       <span class="keywordflow">if</span> (state)
<a name="l00796"></a>00796          <a class="code" href="smdi_8h.html#a4b03364640d2d27d752c09cbafc6c96e" title="Set the MWI indicator for a mailbox.">ast_smdi_mwi_set</a>(mm-&gt;<a class="code" href="structmailbox__mapping.html#a0c21b945d5c5afe7e76693134f4c192c">iface</a>, mm-&gt;<a class="code" href="structmailbox__mapping.html#a34a6d0dbdac55fb87d709e5b3368076a">smdi</a>);
<a name="l00797"></a>00797       <span class="keywordflow">else</span>
<a name="l00798"></a>00798          <a class="code" href="smdi_8h.html#afdb61f0da8c6f539f66c8a7871c7a2fa" title="Unset the MWI indicator for a mailbox.">ast_smdi_mwi_unset</a>(mm-&gt;<a class="code" href="structmailbox__mapping.html#a0c21b945d5c5afe7e76693134f4c192c">iface</a>, mm-&gt;<a class="code" href="structmailbox__mapping.html#a34a6d0dbdac55fb87d709e5b3368076a">smdi</a>);
<a name="l00799"></a>00799 
<a name="l00800"></a>00800       mm-&gt;<a class="code" href="structmailbox__mapping.html#a6c5899039878a4a6977779aaa8bbf285">cur_state</a> = state;
<a name="l00801"></a>00801    }
<a name="l00802"></a>00802 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a902997b7f1d31f4b65899bf89aab3da2"></a><!-- doxytag: member="res_smdi.c::purge_old_messages" ref="a902997b7f1d31f4b65899bf89aab3da2" args="(struct ast_smdi_interface *iface, enum smdi_message_type type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void purge_old_messages </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a>&nbsp;</td>
          <td class="paramname"> <em>type</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00316">316</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="res__smdi_8c_source.html#l00171">ast_smdi_md_message_push()</a>, <a class="el" href="res__smdi_8c_source.html#l00185">ast_smdi_mwi_message_push()</a>, <a class="el" href="time_8h_source.html#l00089">ast_tvdiff_ms()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="res__smdi_8c_source.html#l00251">lock_msg_q()</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="adsistub_8c_source.html#l00055">msg</a>, <a class="el" href="res__smdi_8c_source.html#l00085">ast_smdi_interface::msg_expiry</a>, <a class="el" href="res__smdi_8c_source.html#l00286">msg_timestamp()</a>, <a class="el" href="res__smdi_8c_source.html#l00073">ast_smdi_interface::name</a>, <a class="el" href="res__smdi_8c_source.html#l00248">SMDI_MD</a>, <a class="el" href="res__smdi_8c_source.html#l00247">SMDI_MWI</a>, <a class="el" href="res__smdi_8c_source.html#l00275">unlink_from_msg_q()</a>, <a class="el" href="res__smdi_8c_source.html#l00263">unlock_msg_q()</a>, and <a class="el" href="res__smdi_8c_source.html#l00301">unref_msg()</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00375">smdi_msg_find()</a>, and <a class="el" href="res__smdi_8c_source.html#l00357">smdi_msg_pop()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00317"></a>00317 {
<a name="l00318"></a>00318    <span class="keyword">struct </span>timeval now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00319"></a>00319    <span class="keywordtype">long</span> elapsed = 0;
<a name="l00320"></a>00320    <span class="keywordtype">void</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>;
<a name="l00321"></a>00321    
<a name="l00322"></a>00322    <a class="code" href="res__smdi_8c.html#aabeaf259ac09253ebae4b4ed0072e677">lock_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00323"></a>00323    msg = <a class="code" href="res__smdi_8c.html#a051d9e79bbd9448f61d8bfafb756355b">unlink_from_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00324"></a>00324    <a class="code" href="res__smdi_8c.html#af6f2cbd59866ad8e9e7e92226c7e2526">unlock_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00325"></a>00325 
<a name="l00326"></a>00326    <span class="comment">/* purge old messages */</span>
<a name="l00327"></a>00327    <span class="keywordflow">while</span> (msg) {
<a name="l00328"></a>00328       elapsed = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(now, <a class="code" href="res__smdi_8c.html#a2444f5f2c850374177edbc157a112c99">msg_timestamp</a>(msg, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>));
<a name="l00329"></a>00329 
<a name="l00330"></a>00330       <span class="keywordflow">if</span> (elapsed &gt; iface-&gt;<a class="code" href="structast__smdi__interface.html#a52cefa70b74095ada360b9b2e48a4899">msg_expiry</a>) {
<a name="l00331"></a>00331          <span class="comment">/* found an expired message */</span>
<a name="l00332"></a>00332          <a class="code" href="res__smdi_8c.html#aa128a8b37535b9c3c64c6f0564ef4a51">unref_msg</a>(msg, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00333"></a>00333          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Purged expired message from %s SMDI %s message queue.  &quot;</span>
<a name="l00334"></a>00334             <span class="stringliteral">&quot;Message was %ld milliseconds too old.\n&quot;</span>,
<a name="l00335"></a>00335             iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, (<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a> == <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>) ? <span class="stringliteral">&quot;MD&quot;</span> : <span class="stringliteral">&quot;MWI&quot;</span>, 
<a name="l00336"></a>00336             elapsed - iface-&gt;<a class="code" href="structast__smdi__interface.html#a52cefa70b74095ada360b9b2e48a4899">msg_expiry</a>);
<a name="l00337"></a>00337 
<a name="l00338"></a>00338          <a class="code" href="res__smdi_8c.html#aabeaf259ac09253ebae4b4ed0072e677">lock_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00339"></a>00339          msg = <a class="code" href="res__smdi_8c.html#a051d9e79bbd9448f61d8bfafb756355b">unlink_from_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00340"></a>00340          <a class="code" href="res__smdi_8c.html#af6f2cbd59866ad8e9e7e92226c7e2526">unlock_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00341"></a>00341       } <span class="keywordflow">else</span> {
<a name="l00342"></a>00342          <span class="comment">/* good message, put it back and return */</span>
<a name="l00343"></a>00343          <span class="keywordflow">switch</span> (<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>) {
<a name="l00344"></a>00344          <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>:
<a name="l00345"></a>00345             <a class="code" href="res__smdi_8c.html#a539e23e0762cb4032cd69b241b650f3c">ast_smdi_md_message_push</a>(iface, msg);
<a name="l00346"></a>00346             <span class="keywordflow">break</span>;
<a name="l00347"></a>00347          <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>:
<a name="l00348"></a>00348             <a class="code" href="res__smdi_8c.html#a912ab4e78c7db772efa012cf8bfba4ed">ast_smdi_mwi_message_push</a>(iface, msg);
<a name="l00349"></a>00349             <span class="keywordflow">break</span>;
<a name="l00350"></a>00350          }
<a name="l00351"></a>00351          <a class="code" href="res__smdi_8c.html#aa128a8b37535b9c3c64c6f0564ef4a51">unref_msg</a>(msg, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00352"></a>00352          <span class="keywordflow">break</span>;
<a name="l00353"></a>00353       }
<a name="l00354"></a>00354    }
<a name="l00355"></a>00355 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad1982509765f4870f1f63412a53ea668"></a><!-- doxytag: member="res_smdi.c::reload" ref="ad1982509765f4870f1f63412a53ea668" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int reload </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01391">1391</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, and <a class="el" href="res__smdi_8c_source.html#l00861">smdi_load()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01392"></a>01392 {
<a name="l01393"></a>01393    <span class="keywordtype">int</span> res;
<a name="l01394"></a>01394 
<a name="l01395"></a>01395    res = <a class="code" href="res__smdi_8c.html#ae78e2818ae561f95b462d1b50eda7f7d">smdi_load</a>(1);
<a name="l01396"></a>01396 
<a name="l01397"></a>01397    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01398"></a>01398       <span class="keywordflow">return</span> res;
<a name="l01399"></a>01399    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == 1) {
<a name="l01400"></a>01400       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No SMDI interfaces were specified to listen on, not starting SDMI listener.\n&quot;</span>);
<a name="l01401"></a>01401       <span class="keywordflow">return</span> 0;
<a name="l01402"></a>01402    } <span class="keywordflow">else</span>
<a name="l01403"></a>01403       <span class="keywordflow">return</span> 0;
<a name="l01404"></a>01404 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae78e2818ae561f95b462d1b50eda7f7d"></a><!-- doxytag: member="res_smdi.c::smdi_load" ref="ae78e2818ae561f95b462d1b50eda7f7d" args="(int reload)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int smdi_load </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>reload</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00861">861</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00831">alloc_smdi_interface()</a>, <a class="el" href="res__smdi_8c_source.html#l00752">append_mailbox_mapping()</a>, <a class="el" href="config_8c_source.html#l00827">ast_config_destroy()</a>, <a class="el" href="config_8h_source.html#l00139">ast_config_load</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="linkedlists_8h_source.html#l00449">AST_LIST_EMPTY</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="module_8h_source.html#l00065">AST_MODULE_LOAD_FAILURE</a>, <a class="el" href="loader_8c_source.html#l01163">ast_module_ref()</a>, <a class="el" href="utils_8h_source.html#l00384">ast_pthread_create_background</a>, <a class="el" href="lock_8h_source.html#l00082">AST_PTHREADT_NULL</a>, <a class="el" href="res__smdi_8c_source.html#l00132">ast_smdi_interface_destroy()</a>, <a class="el" href="utils_8c_source.html#l01311">ast_true()</a>, <a class="el" href="config_8c_source.html#l00411">ast_variable_browse()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, <a class="el" href="astobj_8h_source.html#l00776">ASTOBJ_CONTAINER_LINK</a>, <a class="el" href="astobj_8h_source.html#l00782">ASTOBJ_CONTAINER_MARKALL</a>, <a class="el" href="astobj_8h_source.html#l00651">ASTOBJ_CONTAINER_PRUNE_MARKED</a>, <a class="el" href="astobj_8h_source.html#l00276">ASTOBJ_CONTAINER_RDLOCK</a>, <a class="el" href="astobj_8h_source.html#l00283">ASTOBJ_CONTAINER_UNLOCK</a>, <a class="el" href="astobj_8h_source.html#l00251">ASTOBJ_UNMARK</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="config_8h_source.html#l00043">CONFIG_FLAG_FILEUNCHANGED</a>, <a class="el" href="config_8h_source.html#l00050">CONFIG_STATUS_FILEINVALID</a>, <a class="el" href="config_8h_source.html#l00049">CONFIG_STATUS_FILEUNCHANGED</a>, <a class="el" href="res__smdi_8c_source.html#l00112">DEFAULT_POLLING_INTERVAL</a>, <a class="el" href="res__smdi_8c_source.html#l00742">destroy_all_mailbox_mappings()</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="res__smdi_8c_source.html#l00081">ast_smdi_interface::fd</a>, <a class="el" href="res__smdi_8c_source.html#l00080">ast_smdi_interface::file</a>, <a class="el" href="config_8h_source.html#l00081">ast_variable::lineno</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="res__smdi_8c_source.html#l00083">ast_smdi_interface::mode</a>, <a class="el" href="res__smdi_8c_source.html#l00084">ast_smdi_interface::msdstrip</a>, <a class="el" href="res__smdi_8c_source.html#l00085">ast_smdi_interface::msg_expiry</a>, <a class="el" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72">mwi_monitor</a>, <a class="el" href="res__smdi_8c_source.html#l00804">mwi_monitor_handler()</a>, <a class="el" href="res__smdi_8c_source.html#l00073">ast_smdi_interface::name</a>, <a class="el" href="config_8h_source.html#l00075">ast_variable::name</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, <a class="el" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9">smdi_ifaces</a>, <a class="el" href="res__smdi_8c_source.html#l00058">SMDI_MSG_EXPIRY_TIME</a>, <a class="el" href="res__smdi_8c_source.html#l00542">smdi_read()</a>, <a class="el" href="res__smdi_8c_source.html#l00082">ast_smdi_interface::thread</a>, and <a class="el" href="config_8h_source.html#l00076">ast_variable::value</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l01340">load_module()</a>, and <a class="el" href="res__smdi_8c_source.html#l01391">reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00862"></a>00862 {
<a name="l00863"></a>00863    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *conf;
<a name="l00864"></a>00864    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l00865"></a>00865    <span class="keyword">struct </span><a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface = NULL;
<a name="l00866"></a>00866    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="app__rpt_8c.html#a1f57f20c1f46890828791a4827fe8752">config_flags</a> = { <a class="code" href="res__smdi_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l00867"></a>00867    <span class="keywordtype">int</span> res = 0;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869    <span class="comment">/* Config options */</span>
<a name="l00870"></a>00870    speed_t baud_rate = B9600;     <span class="comment">/* 9600 baud rate */</span>
<a name="l00871"></a>00871    tcflag_t paritybit = PARENB;   <span class="comment">/* even parity checking */</span>
<a name="l00872"></a>00872    tcflag_t charsize = CS7;       <span class="comment">/* seven bit characters */</span>
<a name="l00873"></a>00873    <span class="keywordtype">int</span> stopbits = 0;              <span class="comment">/* One stop bit */</span>
<a name="l00874"></a>00874    
<a name="l00875"></a>00875    <span class="keywordtype">int</span> msdstrip = 0;              <span class="comment">/* strip zero digits */</span>
<a name="l00876"></a>00876    <span class="keywordtype">long</span> msg_expiry = <a class="code" href="res__smdi_8c.html#a0628a499b942c4fe8d3db18d4806af1e">SMDI_MSG_EXPIRY_TIME</a>;
<a name="l00877"></a>00877 
<a name="l00878"></a>00878    <span class="keywordflow">if</span> (!(conf = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="res__smdi_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a>, config_flags)) || conf == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l00879"></a>00879       <span class="keywordflow">if</span> (<a class="code" href="res__smdi_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l00880"></a>00880          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to reload config %s: SMDI untouched\n&quot;</span>, <a class="code" href="res__smdi_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a>);
<a name="l00881"></a>00881       <span class="keywordflow">else</span>
<a name="l00882"></a>00882          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to load config %s: SMDI disabled\n&quot;</span>, <a class="code" href="res__smdi_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a>);
<a name="l00883"></a>00883       <span class="keywordflow">return</span> 1;
<a name="l00884"></a>00884    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (conf == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>)
<a name="l00885"></a>00885       <span class="keywordflow">return</span> 0;
<a name="l00886"></a>00886 
<a name="l00887"></a>00887    <span class="comment">/* Mark all interfaces that we are listening on.  We will unmark them</span>
<a name="l00888"></a>00888 <span class="comment">    * as we find them in the config file, this way we know any interfaces</span>
<a name="l00889"></a>00889 <span class="comment">    * still marked after we have finished parsing the config file should</span>
<a name="l00890"></a>00890 <span class="comment">    * be stopped.</span>
<a name="l00891"></a>00891 <span class="comment">    */</span>
<a name="l00892"></a>00892    <span class="keywordflow">if</span> (<a class="code" href="res__smdi_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l00893"></a>00893       <a class="code" href="astobj_8h.html#a5e865869ca1acadd652b42810fec2ec9" title="Mark all the objects in a container.">ASTOBJ_CONTAINER_MARKALL</a>(&amp;<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>);
<a name="l00894"></a>00894 
<a name="l00895"></a>00895    <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(conf, <span class="stringliteral">&quot;interfaces&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00896"></a>00896       <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;baudrate&quot;</span>)) {
<a name="l00897"></a>00897          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;9600&quot;</span>))
<a name="l00898"></a>00898             baud_rate = B9600;
<a name="l00899"></a>00899          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;4800&quot;</span>))
<a name="l00900"></a>00900             baud_rate = B4800;
<a name="l00901"></a>00901          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;2400&quot;</span>))
<a name="l00902"></a>00902             baud_rate = B2400;
<a name="l00903"></a>00903          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;1200&quot;</span>))
<a name="l00904"></a>00904             baud_rate = B1200;
<a name="l00905"></a>00905          <span class="keywordflow">else</span> {
<a name="l00906"></a>00906             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Invalid baud rate &apos;%s&apos; specified in %s (line %d), using default\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <a class="code" href="res__smdi_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l00907"></a>00907             baud_rate = B9600;
<a name="l00908"></a>00908          }
<a name="l00909"></a>00909       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;msdstrip&quot;</span>)) {
<a name="l00910"></a>00910          <span class="keywordflow">if</span> (!sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;msdstrip)) {
<a name="l00911"></a>00911             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Invalid msdstrip value in %s (line %d), using default\n&quot;</span>, <a class="code" href="res__smdi_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l00912"></a>00912             msdstrip = 0;
<a name="l00913"></a>00913          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 &gt; msdstrip || msdstrip &gt; 9) {
<a name="l00914"></a>00914             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Invalid msdstrip value in %s (line %d), using default\n&quot;</span>, <a class="code" href="res__smdi_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l00915"></a>00915             msdstrip = 0;
<a name="l00916"></a>00916          }
<a name="l00917"></a>00917       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;msgexpirytime&quot;</span>)) {
<a name="l00918"></a>00918          <span class="keywordflow">if</span> (!sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30ld&quot;</span>, &amp;msg_expiry)) {
<a name="l00919"></a>00919             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Invalid msgexpirytime value in %s (line %d), using default\n&quot;</span>, <a class="code" href="res__smdi_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l00920"></a>00920             msg_expiry = <a class="code" href="res__smdi_8c.html#a0628a499b942c4fe8d3db18d4806af1e">SMDI_MSG_EXPIRY_TIME</a>;
<a name="l00921"></a>00921          }
<a name="l00922"></a>00922       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;paritybit&quot;</span>)) {
<a name="l00923"></a>00923          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;even&quot;</span>))
<a name="l00924"></a>00924             paritybit = PARENB;
<a name="l00925"></a>00925          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;odd&quot;</span>))
<a name="l00926"></a>00926             paritybit = PARENB | PARODD;
<a name="l00927"></a>00927          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;none&quot;</span>))
<a name="l00928"></a>00928             paritybit = ~PARENB;
<a name="l00929"></a>00929          <span class="keywordflow">else</span> {
<a name="l00930"></a>00930             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Invalid parity bit setting in %s (line %d), using default\n&quot;</span>, <a class="code" href="res__smdi_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l00931"></a>00931             paritybit = PARENB;
<a name="l00932"></a>00932          }
<a name="l00933"></a>00933       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;charsize&quot;</span>)) {
<a name="l00934"></a>00934          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;7&quot;</span>))
<a name="l00935"></a>00935             charsize = CS7;
<a name="l00936"></a>00936          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;8&quot;</span>))
<a name="l00937"></a>00937             charsize = CS8;
<a name="l00938"></a>00938          <span class="keywordflow">else</span> {
<a name="l00939"></a>00939             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Invalid character size setting in %s (line %d), using default\n&quot;</span>, <a class="code" href="res__smdi_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l00940"></a>00940             charsize = CS7;
<a name="l00941"></a>00941          }
<a name="l00942"></a>00942       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;twostopbits&quot;</span>)) {
<a name="l00943"></a>00943          stopbits = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00944"></a>00944       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;smdiport&quot;</span>)) {
<a name="l00945"></a>00945          <span class="keywordflow">if</span> (<a class="code" href="res__smdi_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>) {
<a name="l00946"></a>00946             <span class="comment">/* we are reloading, check if we are already</span>
<a name="l00947"></a>00947 <span class="comment">             * monitoring this interface, if we are we do</span>
<a name="l00948"></a>00948 <span class="comment">             * not want to start it again.  This also has</span>
<a name="l00949"></a>00949 <span class="comment">             * the side effect of not updating different</span>
<a name="l00950"></a>00950 <span class="comment">             * setting for the serial port, but it should</span>
<a name="l00951"></a>00951 <span class="comment">             * be trivial to rewrite this section so that</span>
<a name="l00952"></a>00952 <span class="comment">             * options on the port are changed without</span>
<a name="l00953"></a>00953 <span class="comment">             * restarting the interface.  Or the interface</span>
<a name="l00954"></a>00954 <span class="comment">             * could be restarted with out emptying the</span>
<a name="l00955"></a>00955 <span class="comment">             * queue. */</span>
<a name="l00956"></a>00956             <span class="keywordflow">if</span> ((iface = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))) {
<a name="l00957"></a>00957                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;SMDI interface %s already running, not restarting\n&quot;</span>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>);
<a name="l00958"></a>00958                <a class="code" href="astobj_8h.html#a789fc1432f54cb615e839f0db9decad5" title="Unmark an ASTOBJ by subtracting the ASTOBJ_FLAG_MARKED flag from its objflags mask...">ASTOBJ_UNMARK</a>(iface);
<a name="l00959"></a>00959                <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l00960"></a>00960                <span class="keywordflow">continue</span>;
<a name="l00961"></a>00961             }
<a name="l00962"></a>00962          }
<a name="l00963"></a>00963          
<a name="l00964"></a>00964          <span class="keywordflow">if</span> (!(iface = <a class="code" href="res__smdi_8c.html#ad3ea0faf0ae5bcebd30986b4f707daaa">alloc_smdi_interface</a>()))
<a name="l00965"></a>00965             <span class="keywordflow">continue</span>;
<a name="l00966"></a>00966 
<a name="l00967"></a>00967          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>));
<a name="l00968"></a>00968 
<a name="l00969"></a>00969          iface-&gt;<a class="code" href="structast__smdi__interface.html#a01f75a9ad916f63a94e06a27635ba278">thread</a> = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l00970"></a>00970 
<a name="l00971"></a>00971          <span class="keywordflow">if</span> (!(iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a> = fopen(iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, <span class="stringliteral">&quot;r&quot;</span>))) {
<a name="l00972"></a>00972             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error opening SMDI interface %s (%s)\n&quot;</span>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, strerror(errno));
<a name="l00973"></a>00973             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l00974"></a>00974             <span class="keywordflow">continue</span>;
<a name="l00975"></a>00975          }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977          iface-&gt;<a class="code" href="structast__smdi__interface.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = fileno(iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a>);
<a name="l00978"></a>00978 
<a name="l00979"></a>00979          <span class="comment">/* Set the proper attributes for our serial port. */</span>
<a name="l00980"></a>00980 
<a name="l00981"></a>00981          <span class="comment">/* get the current attributes from the port */</span>
<a name="l00982"></a>00982          <span class="keywordflow">if</span> (tcgetattr(iface-&gt;<a class="code" href="structast__smdi__interface.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, &amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#ab16027e92cb6953c27d7d65c8d904bdd">mode</a>)) {
<a name="l00983"></a>00983             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error getting atributes of %s (%s)\n&quot;</span>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, strerror(errno));
<a name="l00984"></a>00984             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l00985"></a>00985             <span class="keywordflow">continue</span>;
<a name="l00986"></a>00986          }
<a name="l00987"></a>00987 
<a name="l00988"></a>00988          <span class="comment">/* set the desired speed */</span>
<a name="l00989"></a>00989          <span class="keywordflow">if</span> (cfsetispeed(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#ab16027e92cb6953c27d7d65c8d904bdd">mode</a>, baud_rate) || cfsetospeed(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#ab16027e92cb6953c27d7d65c8d904bdd">mode</a>, baud_rate)) {
<a name="l00990"></a>00990             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error setting baud rate on %s (%s)\n&quot;</span>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, strerror(errno));
<a name="l00991"></a>00991             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l00992"></a>00992             <span class="keywordflow">continue</span>;
<a name="l00993"></a>00993          }
<a name="l00994"></a>00994          
<a name="l00995"></a>00995          <span class="comment">/* set the stop bits */</span>
<a name="l00996"></a>00996          <span class="keywordflow">if</span> (stopbits)
<a name="l00997"></a>00997             iface-&gt;<a class="code" href="structast__smdi__interface.html#ab16027e92cb6953c27d7d65c8d904bdd">mode</a>.c_cflag = iface-&gt;<a class="code" href="structast__smdi__interface.html#ab16027e92cb6953c27d7d65c8d904bdd">mode</a>.c_cflag | CSTOPB;   <span class="comment">/* set two stop bits */</span>
<a name="l00998"></a>00998          <span class="keywordflow">else</span>
<a name="l00999"></a>00999             iface-&gt;<a class="code" href="structast__smdi__interface.html#ab16027e92cb6953c27d7d65c8d904bdd">mode</a>.c_cflag = iface-&gt;<a class="code" href="structast__smdi__interface.html#ab16027e92cb6953c27d7d65c8d904bdd">mode</a>.c_cflag &amp; ~CSTOPB;  <span class="comment">/* set one stop bit */</span>
<a name="l01000"></a>01000          
<a name="l01001"></a>01001          <span class="comment">/* set the parity */</span>
<a name="l01002"></a>01002          iface-&gt;<a class="code" href="structast__smdi__interface.html#ab16027e92cb6953c27d7d65c8d904bdd">mode</a>.c_cflag = (iface-&gt;<a class="code" href="structast__smdi__interface.html#ab16027e92cb6953c27d7d65c8d904bdd">mode</a>.c_cflag &amp; ~PARENB &amp; ~PARODD) | paritybit;
<a name="l01003"></a>01003          
<a name="l01004"></a>01004          <span class="comment">/* set the character size */</span>
<a name="l01005"></a>01005          iface-&gt;<a class="code" href="structast__smdi__interface.html#ab16027e92cb6953c27d7d65c8d904bdd">mode</a>.c_cflag = (iface-&gt;<a class="code" href="structast__smdi__interface.html#ab16027e92cb6953c27d7d65c8d904bdd">mode</a>.c_cflag &amp; ~CSIZE) | charsize;
<a name="l01006"></a>01006          
<a name="l01007"></a>01007          <span class="comment">/* commit the desired attributes */</span>
<a name="l01008"></a>01008          <span class="keywordflow">if</span> (tcsetattr(iface-&gt;<a class="code" href="structast__smdi__interface.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, TCSAFLUSH, &amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#ab16027e92cb6953c27d7d65c8d904bdd">mode</a>)) {
<a name="l01009"></a>01009             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error setting attributes on %s (%s)\n&quot;</span>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, strerror(errno));
<a name="l01010"></a>01010             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l01011"></a>01011             <span class="keywordflow">continue</span>;
<a name="l01012"></a>01012          }
<a name="l01013"></a>01013 
<a name="l01014"></a>01014          <span class="comment">/* set the msdstrip */</span>
<a name="l01015"></a>01015          iface-&gt;<a class="code" href="structast__smdi__interface.html#a4c06c7e1993e25ece171922094497fff">msdstrip</a> = msdstrip;
<a name="l01016"></a>01016 
<a name="l01017"></a>01017          <span class="comment">/* set the message expiry time */</span>
<a name="l01018"></a>01018          iface-&gt;<a class="code" href="structast__smdi__interface.html#a52cefa70b74095ada360b9b2e48a4899">msg_expiry</a> = msg_expiry;
<a name="l01019"></a>01019 
<a name="l01020"></a>01020          <span class="comment">/* start the listener thread */</span>
<a name="l01021"></a>01021          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Starting SMDI monitor thread for %s\n&quot;</span>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>);
<a name="l01022"></a>01022          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>, NULL, <a class="code" href="res__smdi_8c.html#acc85846aabcdbc6620973ad47cedca45">smdi_read</a>, iface)) {
<a name="l01023"></a>01023             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error starting SMDI monitor thread for %s\n&quot;</span>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>);
<a name="l01024"></a>01024             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l01025"></a>01025             <span class="keywordflow">continue</span>;
<a name="l01026"></a>01026          }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028          <a class="code" href="astobj_8h.html#a73bb2d9f59430fd47007a3c6ea651de6" title="Add an object to a container.">ASTOBJ_CONTAINER_LINK</a>(&amp;<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>, iface);
<a name="l01029"></a>01029          <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l01030"></a>01030          <a class="code" href="module_8h.html#aa08fcee0b390e15532dd03803c8728c4">ast_module_ref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l01031"></a>01031       } <span class="keywordflow">else</span> {
<a name="l01032"></a>01032          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Ignoring unknown option %s in %s\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <a class="code" href="res__smdi_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a>);
<a name="l01033"></a>01033       }
<a name="l01034"></a>01034    }
<a name="l01035"></a>01035 
<a name="l01036"></a>01036    <a class="code" href="res__smdi_8c.html#aa8dcf5c17e8d6f96acfe863feb6efadc">destroy_all_mailbox_mappings</a>();
<a name="l01037"></a>01037    <a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.polling_interval = <a class="code" href="res__smdi_8c.html#a3180eebdd34e39357d1fc13e34fa0298">DEFAULT_POLLING_INTERVAL</a>;
<a name="l01038"></a>01038    
<a name="l01039"></a>01039    iface = NULL;
<a name="l01040"></a>01040 
<a name="l01041"></a>01041    <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(conf, <span class="stringliteral">&quot;mailboxes&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01042"></a>01042       <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;smdiport&quot;</span>)) {
<a name="l01043"></a>01043          <span class="keywordflow">if</span> (iface)
<a name="l01044"></a>01044             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l01045"></a>01045 
<a name="l01046"></a>01046          <span class="keywordflow">if</span> (!(iface = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))) {
<a name="l01047"></a>01047             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;SMDI interface %s not found\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01048"></a>01048             <span class="keywordflow">continue</span>;
<a name="l01049"></a>01049          }
<a name="l01050"></a>01050       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;pollinginterval&quot;</span>)) {
<a name="l01051"></a>01051          <span class="keywordflow">if</span> (sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30u&quot;</span>, &amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.polling_interval) != 1) {
<a name="l01052"></a>01052             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid value for pollinginterval: %s\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01053"></a>01053             <a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.polling_interval = <a class="code" href="res__smdi_8c.html#a3180eebdd34e39357d1fc13e34fa0298">DEFAULT_POLLING_INTERVAL</a>;
<a name="l01054"></a>01054          }
<a name="l01055"></a>01055       } <span class="keywordflow">else</span> {
<a name="l01056"></a>01056          <span class="keywordflow">if</span> (!iface) {
<a name="l01057"></a>01057             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Mailbox mapping ignored, no valid SMDI interface specified in mailboxes section\n&quot;</span>);
<a name="l01058"></a>01058             <span class="keywordflow">continue</span>;
<a name="l01059"></a>01059          }
<a name="l01060"></a>01060          <a class="code" href="res__smdi_8c.html#aedebd1c4c85c9db863bbe6de85832a26">append_mailbox_mapping</a>(v, iface);
<a name="l01061"></a>01061       }
<a name="l01062"></a>01062    }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064    <span class="keywordflow">if</span> (iface)
<a name="l01065"></a>01065       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l01066"></a>01066 
<a name="l01067"></a>01067    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(conf);
<a name="l01068"></a>01068    
<a name="l01069"></a>01069    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.mailbox_mappings) &amp;&amp; <a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.thread == <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>
<a name="l01070"></a>01070       &amp;&amp; <a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.thread, NULL, <a class="code" href="res__smdi_8c.html#a825180f65e43db5b6d50b43f3a64dfda">mwi_monitor_handler</a>, NULL)) {
<a name="l01071"></a>01071       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to start MWI monitoring thread.  This module will not operate.\n&quot;</span>);
<a name="l01072"></a>01072       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l01073"></a>01073    }
<a name="l01074"></a>01074 
<a name="l01075"></a>01075    <span class="comment">/* Prune any interfaces we should no longer monitor. */</span>
<a name="l01076"></a>01076    <span class="keywordflow">if</span> (<a class="code" href="res__smdi_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l01077"></a>01077       <a class="code" href="astobj_8h.html#a794727ca4ef71982250ff9f36a9668d7" title="Prune marked objects from a container.">ASTOBJ_CONTAINER_PRUNE_MARKED</a>(&amp;<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l01078"></a>01078    
<a name="l01079"></a>01079    <a class="code" href="astobj_8h.html#ae08cb94fa026f1534c5fafd0e95a788d" title="Lock an ASTOBJ_CONTAINER for reading.">ASTOBJ_CONTAINER_RDLOCK</a>(&amp;<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>);
<a name="l01080"></a>01080    <span class="comment">/* TODO: this is bad, we need an ASTOBJ method for this! */</span>
<a name="l01081"></a>01081    <span class="keywordflow">if</span> (!<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>.head)
<a name="l01082"></a>01082       res = 1;
<a name="l01083"></a>01083    <a class="code" href="astobj_8h.html#aa427859308cff6f8153760f7f67e5e30" title="Unlock an ASTOBJ_CONTAINER.">ASTOBJ_CONTAINER_UNLOCK</a>(&amp;<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>);
<a name="l01084"></a>01084    
<a name="l01085"></a>01085    <span class="keywordflow">return</span> res;
<a name="l01086"></a>01086 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a50ede8e5a94567acefe2a29fbef4e4c0"></a><!-- doxytag: member="res_smdi.c::smdi_message_wait" ref="a50ede8e5a94567acefe2a29fbef4e4c0" args="(struct ast_smdi_interface *iface, int timeout, enum smdi_message_type type, const char *search_key, struct ast_flags options)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* smdi_message_wait </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a>&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>search_key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__flags.html">ast_flags</a>&nbsp;</td>
          <td class="paramname"> <em>options</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00443">443</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01754">ast_cond_timedwait()</a>, <a class="el" href="time_8h_source.html#l00164">ast_tv()</a>, <a class="el" href="utils_8c_source.html#l01365">ast_tvadd()</a>, <a class="el" href="time_8h_source.html#l00089">ast_tvdiff_ms()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="app__meetme_8c_source.html#l00841">cond</a>, <a class="el" href="app__meetme_8c_source.html#l00842">lock</a>, <a class="el" href="res__smdi_8c_source.html#l00251">lock_msg_q()</a>, <a class="el" href="res__smdi_8c_source.html#l00076">ast_smdi_interface::md_q_cond</a>, <a class="el" href="res__smdi_8c_source.html#l00075">ast_smdi_interface::md_q_lock</a>, <a class="el" href="adsistub_8c_source.html#l00055">msg</a>, <a class="el" href="res__smdi_8c_source.html#l00079">ast_smdi_interface::mwi_q_cond</a>, <a class="el" href="res__smdi_8c_source.html#l00078">ast_smdi_interface::mwi_q_lock</a>, <a class="el" href="res__smdi_8c_source.html#l00248">SMDI_MD</a>, <a class="el" href="res__smdi_8c_source.html#l00375">smdi_msg_find()</a>, <a class="el" href="res__smdi_8c_source.html#l00247">SMDI_MWI</a>, and <a class="el" href="res__smdi_8c_source.html#l00263">unlock_msg_q()</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00504">ast_smdi_md_message_wait()</a>, <a class="el" href="res__smdi_8c_source.html#l00515">ast_smdi_mwi_message_wait()</a>, <a class="el" href="res__smdi_8c_source.html#l00521">ast_smdi_mwi_message_wait_station()</a>, and <a class="el" href="res__smdi_8c_source.html#l01122">smdi_msg_retrieve_read()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00445"></a>00445 {
<a name="l00446"></a>00446    <span class="keyword">struct </span>timeval start;
<a name="l00447"></a>00447    <span class="keywordtype">long</span> diff = 0;
<a name="l00448"></a>00448    <span class="keywordtype">void</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>;
<a name="l00449"></a>00449    <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> *<a class="code" href="app__meetme_8c.html#a1c7181c39f99ee801943a0d0aa9872b9">cond</a> = NULL;
<a name="l00450"></a>00450    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> *<a class="code" href="app__meetme_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a> = NULL;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452    <span class="keywordflow">switch</span> (<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>) {
<a name="l00453"></a>00453    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>:
<a name="l00454"></a>00454       cond = &amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#aba3bce62d544689a2aeca93c36865a19">mwi_q_cond</a>;
<a name="l00455"></a>00455       lock = &amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a25597a94a263390ea8f0141a01380cb6">mwi_q_lock</a>;
<a name="l00456"></a>00456       <span class="keywordflow">break</span>;
<a name="l00457"></a>00457    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>:
<a name="l00458"></a>00458       cond = &amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a4e3447ab3ab436d88d450c2e1f73df7e">md_q_cond</a>;
<a name="l00459"></a>00459       lock = &amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a1894293fb071c2d433189f286b67f553">md_q_lock</a>;
<a name="l00460"></a>00460       <span class="keywordflow">break</span>;
<a name="l00461"></a>00461    }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463    start = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00464"></a>00464 
<a name="l00465"></a>00465    <span class="keywordflow">while</span> (diff &lt; timeout) {
<a name="l00466"></a>00466       <span class="keyword">struct </span>timespec ts = { 0, };
<a name="l00467"></a>00467       <span class="keyword">struct </span>timeval wait;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469       <a class="code" href="res__smdi_8c.html#aabeaf259ac09253ebae4b4ed0072e677">lock_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471       <span class="keywordflow">if</span> ((msg = <a class="code" href="res__smdi_8c.html#a9c94fea9d1c3a7d2175c73d8e90997a9">smdi_msg_find</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, search_key, options))) {
<a name="l00472"></a>00472          <a class="code" href="res__smdi_8c.html#af6f2cbd59866ad8e9e7e92226c7e2526">unlock_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00473"></a>00473          <span class="keywordflow">return</span> msg;
<a name="l00474"></a>00474       }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476       wait = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(start, <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0, timeout));
<a name="l00477"></a>00477       ts.tv_sec = wait.tv_sec;
<a name="l00478"></a>00478       ts.tv_nsec = wait.tv_usec * 1000;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480       <span class="comment">/* If there were no messages in the queue, then go to sleep until one</span>
<a name="l00481"></a>00481 <span class="comment">       * arrives. */</span>
<a name="l00482"></a>00482 
<a name="l00483"></a>00483       <a class="code" href="lock_8h.html#aa6fec4bba2b7190b94a1a4c7b6c541a4">ast_cond_timedwait</a>(cond, lock, &amp;ts);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485       <span class="keywordflow">if</span> ((msg = <a class="code" href="res__smdi_8c.html#a9c94fea9d1c3a7d2175c73d8e90997a9">smdi_msg_find</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, search_key, options))) {
<a name="l00486"></a>00486          <a class="code" href="res__smdi_8c.html#af6f2cbd59866ad8e9e7e92226c7e2526">unlock_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00487"></a>00487          <span class="keywordflow">return</span> msg;
<a name="l00488"></a>00488       }
<a name="l00489"></a>00489 
<a name="l00490"></a>00490       <a class="code" href="res__smdi_8c.html#af6f2cbd59866ad8e9e7e92226c7e2526">unlock_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492       <span class="comment">/* check timeout */</span>
<a name="l00493"></a>00493       diff = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), start);
<a name="l00494"></a>00494    }
<a name="l00495"></a>00495 
<a name="l00496"></a>00496    <span class="keywordflow">return</span> NULL;
<a name="l00497"></a>00497 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7a89715a33742e572af17f2ff5e91db4"></a><!-- doxytag: member="res_smdi.c::smdi_msg_datastore_destroy" ref="a7a89715a33742e572af17f2ff5e91db4" args="(void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void smdi_msg_datastore_destroy </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01094">1094</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00132">ast_smdi_interface_destroy()</a>, <a class="el" href="res__smdi_8c_source.html#l00725">ast_smdi_md_message_destroy()</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="astmm_8h_source.html#l00084">free</a>, <a class="el" href="res__smdi_8c_source.html#l01090">smdi_msg_datastore::iface</a>, and <a class="el" href="res__smdi_8c_source.html#l01091">smdi_msg_datastore::md_msg</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l01122">smdi_msg_retrieve_read()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01095"></a>01095 {
<a name="l01096"></a>01096    <span class="keyword">struct </span><a class="code" href="structsmdi__msg__datastore.html">smdi_msg_datastore</a> *smd = data;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098    <span class="keywordflow">if</span> (smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#a0c21b945d5c5afe7e76693134f4c192c">iface</a>)
<a name="l01099"></a>01099       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#a0c21b945d5c5afe7e76693134f4c192c">iface</a>, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l01100"></a>01100 
<a name="l01101"></a>01101    <span class="keywordflow">if</span> (smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#a680853992aca5507ae09e30cc2243d34">md_msg</a>)
<a name="l01102"></a>01102       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#a680853992aca5507ae09e30cc2243d34">md_msg</a>, <a class="code" href="smdi_8h.html#a408e56a27064d1537eb6e4accf73e6bf" title="ast_smdi_md_message destructor.">ast_smdi_md_message_destroy</a>);
<a name="l01103"></a>01103 
<a name="l01104"></a>01104    <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(smd);
<a name="l01105"></a>01105 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9c94fea9d1c3a7d2175c73d8e90997a9"></a><!-- doxytag: member="res_smdi.c::smdi_msg_find" ref="a9c94fea9d1c3a7d2175c73d8e90997a9" args="(struct ast_smdi_interface *iface, enum smdi_message_type type, const char *search_key, struct ast_flags options)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* smdi_msg_find </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a>&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>search_key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__flags.html">ast_flags</a>&nbsp;</td>
          <td class="paramname"> <em>options</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00375">375</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="astobj_8h_source.html#l00376">ASTOBJ_CONTAINER_TRAVERSE</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="res__smdi_8c_source.html#l00074">ast_smdi_interface::md_q</a>, <a class="el" href="adsistub_8c_source.html#l00055">msg</a>, <a class="el" href="res__smdi_8c_source.html#l00371">OPT_SEARCH_TERMINAL</a>, <a class="el" href="res__smdi_8c_source.html#l00316">purge_old_messages()</a>, and <a class="el" href="res__smdi_8c_source.html#l00248">SMDI_MD</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00443">smdi_message_wait()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00377"></a>00377 {
<a name="l00378"></a>00378    <span class="keywordtype">void</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a> = NULL;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380    <a class="code" href="res__smdi_8c.html#a902997b7f1d31f4b65899bf89aab3da2">purge_old_messages</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00381"></a>00381 
<a name="l00382"></a>00382    <span class="keywordflow">switch</span> (<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>) {
<a name="l00383"></a>00383    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>:
<a name="l00384"></a>00384       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(search_key)) {
<a name="l00385"></a>00385          <span class="keyword">struct </span><a class="code" href="structast__smdi__md__message.html" title="An SMDI message desk message.">ast_smdi_md_message</a> *md_msg = NULL;
<a name="l00386"></a>00386 
<a name="l00387"></a>00387          <span class="comment">/* No search key provided (the code from chan_dahdi does this).</span>
<a name="l00388"></a>00388 <span class="comment">          * Just pop the top message off of the queue. */</span>
<a name="l00389"></a>00389 
<a name="l00390"></a>00390          <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a71b0ca7192d996168361d98dfc7b43a3">md_q</a>, !md_msg, <span class="keywordflow">do</span> {
<a name="l00391"></a>00391             md_msg = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>(iterator);
<a name="l00392"></a>00392          } <span class="keywordflow">while</span> (0); );
<a name="l00393"></a>00393 
<a name="l00394"></a>00394          msg = md_msg;
<a name="l00395"></a>00395       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;options, <a class="code" href="res__smdi_8c.html#a775634eda7917b3f2142895169300799a3d54913f4c5755501ab529da993e3314">OPT_SEARCH_TERMINAL</a>)) {
<a name="l00396"></a>00396          <span class="keyword">struct </span><a class="code" href="structast__smdi__md__message.html" title="An SMDI message desk message.">ast_smdi_md_message</a> *md_msg = NULL;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398          <span class="comment">/* Searching by the message desk terminal */</span>
<a name="l00399"></a>00399 
<a name="l00400"></a>00400          <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a71b0ca7192d996168361d98dfc7b43a3">md_q</a>, !md_msg, <span class="keywordflow">do</span> {
<a name="l00401"></a>00401             if (!strcasecmp(iterator-&gt;mesg_desk_term, search_key))
<a name="l00402"></a>00402                md_msg = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>(iterator);
<a name="l00403"></a>00403          } <span class="keywordflow">while</span> (0); );
<a name="l00404"></a>00404 
<a name="l00405"></a>00405          msg = md_msg;
<a name="l00406"></a>00406       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;options, <a class="code" href="res__smdi_8c.html#a775634eda7917b3f2142895169300799a07b7c8dedaab2e0ddec24d2d3e77c378">OPT_SEARCH_NUMBER</a>)) {
<a name="l00407"></a>00407          <span class="keyword">struct </span><a class="code" href="structast__smdi__md__message.html" title="An SMDI message desk message.">ast_smdi_md_message</a> *md_msg = NULL;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409          <span class="comment">/* Searching by the message desk number */</span>
<a name="l00410"></a>00410 
<a name="l00411"></a>00411          <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a71b0ca7192d996168361d98dfc7b43a3">md_q</a>, !md_msg, <span class="keywordflow">do</span> {
<a name="l00412"></a>00412             if (!strcasecmp(iterator-&gt;mesg_desk_num, search_key))
<a name="l00413"></a>00413                md_msg = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>(iterator);
<a name="l00414"></a>00414          } <span class="keywordflow">while</span> (0); );
<a name="l00415"></a>00415 
<a name="l00416"></a>00416          msg = md_msg;
<a name="l00417"></a>00417       } <span class="keywordflow">else</span> {
<a name="l00418"></a>00418          <span class="comment">/* Searching by the forwarding station */</span>
<a name="l00419"></a>00419          msg = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a71b0ca7192d996168361d98dfc7b43a3">md_q</a>, search_key);
<a name="l00420"></a>00420       }
<a name="l00421"></a>00421       <span class="keywordflow">break</span>;
<a name="l00422"></a>00422    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>:
<a name="l00423"></a>00423       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(search_key)) {
<a name="l00424"></a>00424          <span class="keyword">struct </span><a class="code" href="structast__smdi__mwi__message.html" title="An SMDI message waiting indicator message.">ast_smdi_mwi_message</a> *mwi_msg = NULL;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426          <span class="comment">/* No search key provided (the code from chan_dahdi does this).</span>
<a name="l00427"></a>00427 <span class="comment">          * Just pop the top message off of the queue. */</span>
<a name="l00428"></a>00428 
<a name="l00429"></a>00429          <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#ac0aedea441d08fd6fc7aea5ba5d22fbd">mwi_q</a>, !mwi_msg, <span class="keywordflow">do</span> {
<a name="l00430"></a>00430             mwi_msg = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>(iterator);
<a name="l00431"></a>00431          } <span class="keywordflow">while</span> (0); );
<a name="l00432"></a>00432 
<a name="l00433"></a>00433          msg = mwi_msg;
<a name="l00434"></a>00434       } <span class="keywordflow">else</span> {
<a name="l00435"></a>00435          msg = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#ac0aedea441d08fd6fc7aea5ba5d22fbd">mwi_q</a>, search_key);
<a name="l00436"></a>00436       }
<a name="l00437"></a>00437       <span class="keywordflow">break</span>;
<a name="l00438"></a>00438    }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440    <span class="keywordflow">return</span> msg;
<a name="l00441"></a>00441 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a65b6dc916b3e2d052d6afc00d5f26cee"></a><!-- doxytag: member="res_smdi.c::smdi_msg_pop" ref="a65b6dc916b3e2d052d6afc00d5f26cee" args="(struct ast_smdi_interface *iface, enum smdi_message_type type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* smdi_msg_pop </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a>&nbsp;</td>
          <td class="paramname"> <em>type</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00357">357</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00251">lock_msg_q()</a>, <a class="el" href="adsistub_8c_source.html#l00055">msg</a>, <a class="el" href="res__smdi_8c_source.html#l00316">purge_old_messages()</a>, <a class="el" href="res__smdi_8c_source.html#l00275">unlink_from_msg_q()</a>, and <a class="el" href="res__smdi_8c_source.html#l00263">unlock_msg_q()</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00499">ast_smdi_md_message_pop()</a>, and <a class="el" href="res__smdi_8c_source.html#l00510">ast_smdi_mwi_message_pop()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00358"></a>00358 {
<a name="l00359"></a>00359    <span class="keywordtype">void</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>;
<a name="l00360"></a>00360 
<a name="l00361"></a>00361    <a class="code" href="res__smdi_8c.html#a902997b7f1d31f4b65899bf89aab3da2">purge_old_messages</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00362"></a>00362 
<a name="l00363"></a>00363    <a class="code" href="res__smdi_8c.html#aabeaf259ac09253ebae4b4ed0072e677">lock_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00364"></a>00364    msg = <a class="code" href="res__smdi_8c.html#a051d9e79bbd9448f61d8bfafb756355b">unlink_from_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00365"></a>00365    <a class="code" href="res__smdi_8c.html#af6f2cbd59866ad8e9e7e92226c7e2526">unlock_msg_q</a>(iface, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>);
<a name="l00366"></a>00366 
<a name="l00367"></a>00367    <span class="keywordflow">return</span> msg;
<a name="l00368"></a>00368 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7f7dca7279c64bdf5d70179f63744f9a"></a><!-- doxytag: member="res_smdi.c::smdi_msg_read" ref="a7f7dca7279c64bdf5d70179f63744f9a" args="(struct ast_channel *chan, const char *cmd, char *data, char *buf, size_t len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int smdi_msg_read </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&nbsp;</td>
          <td class="paramname"> <em>len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01221">1221</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="app_8h_source.html#l00338">AST_APP_ARG</a>, <a class="el" href="channel_8c_source.html#l01548">ast_channel_datastore_find()</a>, <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="app_8h_source.html#l00355">AST_DECLARE_APP_ARGS</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="module_8h_source.html#l00240">ast_module_user_add</a>, <a class="el" href="module_8h_source.html#l00241">ast_module_user_remove</a>, <a class="el" href="app_8h_source.html#l00387">AST_STANDARD_APP_ARGS</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="smdi_8h_source.html#l00073">ast_smdi_md_message::calling_st</a>, <a class="el" href="datastore_8h_source.html#l00056">ast_datastore::data</a>, <a class="el" href="smdi_8h_source.html#l00072">ast_smdi_md_message::fwd_st</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__smdi_8c_source.html#l01091">smdi_msg_datastore::md_msg</a>, <a class="el" href="smdi_8h_source.html#l00069">ast_smdi_md_message::mesg_desk_num</a>, <a class="el" href="smdi_8h_source.html#l00071">ast_smdi_md_message::mesg_desk_term</a>, <a class="el" href="chan__mgcp_8c_source.html#l01737">parse()</a>, and <a class="el" href="smdi_8h_source.html#l00074">ast_smdi_md_message::type</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01222"></a>01222 {
<a name="l01223"></a>01223    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u;
<a name="l01224"></a>01224    <span class="keywordtype">int</span> res = -1;
<a name="l01225"></a>01225    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l01226"></a>01226       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<span class="keywordtype">id</span>);
<a name="l01227"></a>01227       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(component);
<a name="l01228"></a>01228    );
<a name="l01229"></a>01229    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l01230"></a>01230    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *datastore = NULL;
<a name="l01231"></a>01231    <span class="keyword">struct </span><a class="code" href="structsmdi__msg__datastore.html">smdi_msg_datastore</a> *smd = NULL;
<a name="l01232"></a>01232 
<a name="l01233"></a>01233    u = <a class="code" href="module_8h.html#ab941a600dc47b469ab225f140bc0973f">ast_module_user_add</a>(chan);
<a name="l01234"></a>01234 
<a name="l01235"></a>01235    <span class="keywordflow">if</span> (!chan) {
<a name="l01236"></a>01236       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;SMDI_MSG can not be called without a channel\n&quot;</span>);
<a name="l01237"></a>01237       <span class="keywordflow">goto</span> return_error;
<a name="l01238"></a>01238    }
<a name="l01239"></a>01239 
<a name="l01240"></a>01240    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l01241"></a>01241       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SMDI_MSG requires an argument\n&quot;</span>);
<a name="l01242"></a>01242       <span class="keywordflow">goto</span> return_error;
<a name="l01243"></a>01243    }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l01246"></a>01246    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l01247"></a>01247 
<a name="l01248"></a>01248    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.id)) {
<a name="l01249"></a>01249       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;ID must be supplied to SMDI_MSG\n&quot;</span>);
<a name="l01250"></a>01250       <span class="keywordflow">goto</span> return_error;
<a name="l01251"></a>01251    }
<a name="l01252"></a>01252 
<a name="l01253"></a>01253    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.component)) {
<a name="l01254"></a>01254       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;ID must be supplied to SMDI_MSG\n&quot;</span>);
<a name="l01255"></a>01255       <span class="keywordflow">goto</span> return_error;
<a name="l01256"></a>01256    }
<a name="l01257"></a>01257 
<a name="l01258"></a>01258    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l01259"></a>01259    datastore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;<a class="code" href="res__smdi_8c.html#aa3633a2b3d5aefdf40ed428c3d483527">smdi_msg_datastore_info</a>, args.id);
<a name="l01260"></a>01260    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l01261"></a>01261    
<a name="l01262"></a>01262    <span class="keywordflow">if</span> (!datastore) {
<a name="l01263"></a>01263       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No SMDI message found for message ID &apos;%s&apos;\n&quot;</span>, args.id);
<a name="l01264"></a>01264       <span class="keywordflow">goto</span> return_error;
<a name="l01265"></a>01265    }
<a name="l01266"></a>01266 
<a name="l01267"></a>01267    smd = datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l01268"></a>01268 
<a name="l01269"></a>01269    <span class="keywordflow">if</span> (!strcasecmp(args.component, <span class="stringliteral">&quot;number&quot;</span>)) {
<a name="l01270"></a>01270       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#a680853992aca5507ae09e30cc2243d34">md_msg</a>-&gt;<a class="code" href="structast__smdi__md__message.html#a45ad4fcc948460a8f37cc736d4d1ebca">mesg_desk_num</a>, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l01271"></a>01271    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(args.component, <span class="stringliteral">&quot;terminal&quot;</span>)) {
<a name="l01272"></a>01272       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#a680853992aca5507ae09e30cc2243d34">md_msg</a>-&gt;<a class="code" href="structast__smdi__md__message.html#a1ecc00a9b445a72596499679ed6c5672">mesg_desk_term</a>, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l01273"></a>01273    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(args.component, <span class="stringliteral">&quot;station&quot;</span>)) {
<a name="l01274"></a>01274       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#a680853992aca5507ae09e30cc2243d34">md_msg</a>-&gt;<a class="code" href="structast__smdi__md__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l01275"></a>01275    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(args.component, <span class="stringliteral">&quot;callerid&quot;</span>)) {
<a name="l01276"></a>01276       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#a680853992aca5507ae09e30cc2243d34">md_msg</a>-&gt;<a class="code" href="structast__smdi__md__message.html#a35dcfe0bcfb5c95e42fd180e23d89990">calling_st</a>, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l01277"></a>01277    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(args.component, <span class="stringliteral">&quot;type&quot;</span>)) {
<a name="l01278"></a>01278       snprintf(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="stringliteral">&quot;%c&quot;</span>, smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#a680853992aca5507ae09e30cc2243d34">md_msg</a>-&gt;<a class="code" href="structast__smdi__md__message.html#aff17911edc8208aa8ddb1c7c52c78389">type</a>);
<a name="l01279"></a>01279    } <span class="keywordflow">else</span> {
<a name="l01280"></a>01280       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;&apos;%s&apos; is not a valid message component for SMDI_MSG\n&quot;</span>,
<a name="l01281"></a>01281          args.component);
<a name="l01282"></a>01282       <span class="keywordflow">goto</span> return_error;
<a name="l01283"></a>01283    }
<a name="l01284"></a>01284 
<a name="l01285"></a>01285    res = 0;
<a name="l01286"></a>01286 
<a name="l01287"></a>01287 return_error:
<a name="l01288"></a>01288    <a class="code" href="module_8h.html#aac87725d61b6daf4ce7d7b505f1b68c9">ast_module_user_remove</a>(u);
<a name="l01289"></a>01289 
<a name="l01290"></a>01290    <span class="keywordflow">return</span> res;
<a name="l01291"></a>01291 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6b024159cf6f1be4facd11cc97c90f88"></a><!-- doxytag: member="res_smdi.c::smdi_msg_retrieve_read" ref="a6b024159cf6f1be4facd11cc97c90f88" args="(struct ast_channel *chan, const char *cmd, char *data, char *buf, size_t len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int smdi_msg_retrieve_read </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&nbsp;</td>
          <td class="paramname"> <em>len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01122">1122</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="app_8h_source.html#l00338">AST_APP_ARG</a>, <a class="el" href="app_8c_source.html#l01776">ast_app_parse_options()</a>, <a class="el" href="lock_8h_source.html#l01964">ast_atomic_fetchadd_int()</a>, <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="channel_8c_source.html#l01534">ast_channel_datastore_add()</a>, <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="datastore_8h_source.html#l00071">ast_datastore_alloc</a>, <a class="el" href="app_8h_source.html#l00355">AST_DECLARE_APP_ARGS</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="module_8h_source.html#l00240">ast_module_user_add</a>, <a class="el" href="module_8h_source.html#l00241">ast_module_user_remove</a>, <a class="el" href="res__smdi_8c_source.html#l00132">ast_smdi_interface_destroy()</a>, <a class="el" href="res__smdi_8c_source.html#l00528">ast_smdi_interface_find()</a>, <a class="el" href="res__smdi_8c_source.html#l00725">ast_smdi_md_message_destroy()</a>, <a class="el" href="app_8h_source.html#l00387">AST_STANDARD_APP_ARGS</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="datastore_8h_source.html#l00056">ast_datastore::data</a>, <a class="el" href="res__smdi_8c_source.html#l01089">smdi_msg_datastore::id</a>, <a class="el" href="res__smdi_8c_source.html#l01090">smdi_msg_datastore::iface</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__smdi_8c_source.html#l01091">smdi_msg_datastore::md_msg</a>, <a class="el" href="chan__mgcp_8c_source.html#l01737">parse()</a>, <a class="el" href="res__smdi_8c_source.html#l00248">SMDI_MD</a>, <a class="el" href="res__smdi_8c_source.html#l00443">smdi_message_wait()</a>, <a class="el" href="res__smdi_8c_source.html#l01094">smdi_msg_datastore_destroy()</a>, <a class="el" href="res__smdi_8c_source.html#l01120">smdi_msg_ret_options</a>, and <a class="el" href="res__smdi_8c_source.html#l01115">SMDI_RETRIEVE_TIMEOUT_DEFAULT</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01123"></a>01123 {
<a name="l01124"></a>01124    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u;
<a name="l01125"></a>01125    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l01126"></a>01126       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(port);
<a name="l01127"></a>01127       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(search_key);
<a name="l01128"></a>01128       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(timeout);
<a name="l01129"></a>01129       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l01130"></a>01130    );
<a name="l01131"></a>01131    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> options = { 0 };
<a name="l01132"></a>01132    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timeout = <a class="code" href="res__smdi_8c.html#a3ce34b39eb6105c25220f8a98edb4cea">SMDI_RETRIEVE_TIMEOUT_DEFAULT</a>;
<a name="l01133"></a>01133    <span class="keywordtype">int</span> res = -1;
<a name="l01134"></a>01134    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a> = NULL;
<a name="l01135"></a>01135    <span class="keyword">struct </span><a class="code" href="structsmdi__msg__datastore.html">smdi_msg_datastore</a> *smd = NULL;
<a name="l01136"></a>01136    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *datastore = NULL;
<a name="l01137"></a>01137    <span class="keyword">struct </span><a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface = NULL;
<a name="l01138"></a>01138    <span class="keyword">struct </span><a class="code" href="structast__smdi__md__message.html" title="An SMDI message desk message.">ast_smdi_md_message</a> *md_msg = NULL;
<a name="l01139"></a>01139 
<a name="l01140"></a>01140    u = <a class="code" href="module_8h.html#ab941a600dc47b469ab225f140bc0973f">ast_module_user_add</a>(chan);
<a name="l01141"></a>01141 
<a name="l01142"></a>01142    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l01143"></a>01143       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;SMDI_MSG_RETRIEVE requires an argument\n&quot;</span>);
<a name="l01144"></a>01144       <span class="keywordflow">goto</span> return_error;
<a name="l01145"></a>01145    }
<a name="l01146"></a>01146 
<a name="l01147"></a>01147    <span class="keywordflow">if</span> (!chan) {
<a name="l01148"></a>01148       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;SMDI_MSG_RETRIEVE must be used with a channel\n&quot;</span>);
<a name="l01149"></a>01149       <span class="keywordflow">goto</span> return_error;
<a name="l01150"></a>01150    }
<a name="l01151"></a>01151 
<a name="l01152"></a>01152    <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(chan);
<a name="l01153"></a>01153 
<a name="l01154"></a>01154    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l01155"></a>01155    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l01156"></a>01156 
<a name="l01157"></a>01157    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.port) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.search_key)) {
<a name="l01158"></a>01158       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid arguments provided to SMDI_MSG_RETRIEVE\n&quot;</span>);
<a name="l01159"></a>01159       <span class="keywordflow">goto</span> return_error;
<a name="l01160"></a>01160    }
<a name="l01161"></a>01161 
<a name="l01162"></a>01162    <span class="keywordflow">if</span> (!(iface = <a class="code" href="smdi_8h.html#aa5a1e111a1c9346decb38270aeb28c29" title="Find an SMDI interface with the specified name.">ast_smdi_interface_find</a>(args.port))) {
<a name="l01163"></a>01163       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;SMDI port &apos;%s&apos; not found\n&quot;</span>, args.port);
<a name="l01164"></a>01164       <span class="keywordflow">goto</span> return_error;
<a name="l01165"></a>01165    }
<a name="l01166"></a>01166 
<a name="l01167"></a>01167    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.options)) {
<a name="l01168"></a>01168       <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(<a class="code" href="res__smdi_8c.html#a78fd6e06a4ad1ece63365b1703c263c5">smdi_msg_ret_options</a>, &amp;options, NULL, args.options);
<a name="l01169"></a>01169    }
<a name="l01170"></a>01170 
<a name="l01171"></a>01171    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.timeout)) {
<a name="l01172"></a>01172       <span class="keywordflow">if</span> (sscanf(args.timeout, <span class="stringliteral">&quot;%30u&quot;</span>, &amp;timeout) != 1) {
<a name="l01173"></a>01173          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;&apos;%s&apos; is not a valid timeout\n&quot;</span>, args.timeout);
<a name="l01174"></a>01174          timeout = <a class="code" href="res__smdi_8c.html#a3ce34b39eb6105c25220f8a98edb4cea">SMDI_RETRIEVE_TIMEOUT_DEFAULT</a>;
<a name="l01175"></a>01175       }
<a name="l01176"></a>01176    }
<a name="l01177"></a>01177 
<a name="l01178"></a>01178    <span class="keywordflow">if</span> (!(md_msg = <a class="code" href="res__smdi_8c.html#a50ede8e5a94567acefe2a29fbef4e4c0">smdi_message_wait</a>(iface, timeout, <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>, args.search_key, options))) {
<a name="l01179"></a>01179       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No SMDI message retrieved for search key &apos;%s&apos; after &quot;</span>
<a name="l01180"></a>01180          <span class="stringliteral">&quot;waiting %u ms.\n&quot;</span>, args.search_key, timeout);
<a name="l01181"></a>01181       <span class="keywordflow">goto</span> return_error;
<a name="l01182"></a>01182    }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184    <span class="keywordflow">if</span> (!(smd = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*smd))))
<a name="l01185"></a>01185       <span class="keywordflow">goto</span> return_error;
<a name="l01186"></a>01186 
<a name="l01187"></a>01187    smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#a0c21b945d5c5afe7e76693134f4c192c">iface</a> = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>(iface);
<a name="l01188"></a>01188    smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#a680853992aca5507ae09e30cc2243d34">md_msg</a> = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>(md_msg);
<a name="l01189"></a>01189    smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#ab7ce6f462afaf105224b0ca772a33c43">id</a> = <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;<a class="code" href="res__smdi_8c.html#af946306630fcc495fc32ab59aecf4fca">smdi_msg_id</a>, 1);
<a name="l01190"></a>01190    snprintf(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="stringliteral">&quot;%u&quot;</span>, smd-&gt;<a class="code" href="structsmdi__msg__datastore.html#ab7ce6f462afaf105224b0ca772a33c43">id</a>);
<a name="l01191"></a>01191 
<a name="l01192"></a>01192    <span class="keywordflow">if</span> (!(datastore = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="res__smdi_8c.html#aa3633a2b3d5aefdf40ed428c3d483527">smdi_msg_datastore_info</a>, <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)))
<a name="l01193"></a>01193       <span class="keywordflow">goto</span> return_error;
<a name="l01194"></a>01194 
<a name="l01195"></a>01195    datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = smd;
<a name="l01196"></a>01196 
<a name="l01197"></a>01197    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l01198"></a>01198    <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(chan, datastore);
<a name="l01199"></a>01199    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l01200"></a>01200 
<a name="l01201"></a>01201    res = 0;
<a name="l01202"></a>01202 
<a name="l01203"></a>01203 return_error:
<a name="l01204"></a>01204    <span class="keywordflow">if</span> (iface)
<a name="l01205"></a>01205       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l01206"></a>01206 
<a name="l01207"></a>01207    <span class="keywordflow">if</span> (md_msg)
<a name="l01208"></a>01208       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(md_msg, <a class="code" href="smdi_8h.html#a408e56a27064d1537eb6e4accf73e6bf" title="ast_smdi_md_message destructor.">ast_smdi_md_message_destroy</a>);
<a name="l01209"></a>01209 
<a name="l01210"></a>01210    <span class="keywordflow">if</span> (smd &amp;&amp; !datastore)
<a name="l01211"></a>01211       <a class="code" href="res__smdi_8c.html#a7a89715a33742e572af17f2ff5e91db4">smdi_msg_datastore_destroy</a>(smd);
<a name="l01212"></a>01212 
<a name="l01213"></a>01213    <span class="keywordflow">if</span> (parse)
<a name="l01214"></a>01214       <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l01215"></a>01215 
<a name="l01216"></a>01216    <a class="code" href="module_8h.html#aac87725d61b6daf4ce7d7b505f1b68c9">ast_module_user_remove</a>(u);
<a name="l01217"></a>01217 
<a name="l01218"></a>01218    <span class="keywordflow">return</span> res;
<a name="l01219"></a>01219 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="acc85846aabcdbc6620973ad47cedca45"></a><!-- doxytag: member="res_smdi.c::smdi_read" ref="acc85846aabcdbc6620973ad47cedca45" args="(void *iface_p)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* smdi_read </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>iface_p</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00542">542</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="res__smdi_8c_source.html#l00132">ast_smdi_interface_destroy()</a>, <a class="el" href="res__smdi_8c_source.html#l00725">ast_smdi_md_message_destroy()</a>, <a class="el" href="res__smdi_8c_source.html#l00171">ast_smdi_md_message_push()</a>, <a class="el" href="res__smdi_8c_source.html#l00730">ast_smdi_mwi_message_destroy()</a>, <a class="el" href="res__smdi_8c_source.html#l00185">ast_smdi_mwi_message_push()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="astobj_8h_source.html#l00264">ASTOBJ_INIT</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="smdi_8h_source.html#l00073">ast_smdi_md_message::calling_st</a>, <a class="el" href="smdi_8h_source.html#l00057">ast_smdi_mwi_message::cause</a>, <a class="el" href="res__smdi_8c_source.html#l00080">ast_smdi_interface::file</a>, <a class="el" href="smdi_8h_source.html#l00055">ast_smdi_mwi_message::fwd_st</a>, <a class="el" href="smdi_8h_source.html#l00072">ast_smdi_md_message::fwd_st</a>, <a class="el" href="logger_8h_source.html#l00119">LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="smdi_8h_source.html#l00069">ast_smdi_md_message::mesg_desk_num</a>, <a class="el" href="smdi_8h_source.html#l00071">ast_smdi_md_message::mesg_desk_term</a>, <a class="el" href="res__smdi_8c_source.html#l00084">ast_smdi_interface::msdstrip</a>, <a class="el" href="smdi_8h_source.html#l00055">ast_smdi_mwi_message::name</a>, <a class="el" href="res__smdi_8c_source.html#l00073">ast_smdi_interface::name</a>, <a class="el" href="smdi_8h_source.html#l00069">ast_smdi_md_message::name</a>, <a class="el" href="smdi_8h_source.html#l00058">ast_smdi_mwi_message::timestamp</a>, <a class="el" href="smdi_8h_source.html#l00075">ast_smdi_md_message::timestamp</a>, and <a class="el" href="smdi_8h_source.html#l00074">ast_smdi_md_message::type</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00861">smdi_load()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00543"></a>00543 {
<a name="l00544"></a>00544    <span class="keyword">struct </span><a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface = iface_p;
<a name="l00545"></a>00545    <span class="keyword">struct </span><a class="code" href="structast__smdi__md__message.html" title="An SMDI message desk message.">ast_smdi_md_message</a> *md_msg;
<a name="l00546"></a>00546    <span class="keyword">struct </span><a class="code" href="structast__smdi__mwi__message.html" title="An SMDI message waiting indicator message.">ast_smdi_mwi_message</a> *mwi_msg;
<a name="l00547"></a>00547    <span class="keywordtype">char</span> c = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00548"></a>00548    <span class="keywordtype">char</span> *cp = NULL;
<a name="l00549"></a>00549    <span class="keywordtype">int</span> i;
<a name="l00550"></a>00550    <span class="keywordtype">int</span> start = 0;
<a name="l00551"></a>00551       
<a name="l00552"></a>00552    <span class="comment">/* read an smdi message */</span>
<a name="l00553"></a>00553    <span class="keywordflow">while</span> ((c = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a>))) {
<a name="l00554"></a>00554 
<a name="l00555"></a>00555       <span class="comment">/* check if this is the start of a message */</span>
<a name="l00556"></a>00556       <span class="keywordflow">if</span> (!start) {
<a name="l00557"></a>00557          <span class="keywordflow">if</span> (c == <span class="charliteral">&apos;M&apos;</span>) {
<a name="l00558"></a>00558             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Read an &apos;M&apos; to start an SMDI message\n&quot;</span>);
<a name="l00559"></a>00559             start = 1;
<a name="l00560"></a>00560          }
<a name="l00561"></a>00561          <span class="keywordflow">continue</span>;
<a name="l00562"></a>00562       }
<a name="l00563"></a>00563       
<a name="l00564"></a>00564       <span class="keywordflow">if</span> (c == <span class="charliteral">&apos;D&apos;</span>) { <span class="comment">/* MD message */</span>
<a name="l00565"></a>00565          start = 0;
<a name="l00566"></a>00566 
<a name="l00567"></a>00567          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Read a &apos;D&apos; ... it&apos;s an MD message.\n&quot;</span>);
<a name="l00568"></a>00568 
<a name="l00569"></a>00569          <span class="keywordflow">if</span> (!(md_msg = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*md_msg)))) {
<a name="l00570"></a>00570             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l00571"></a>00571             <span class="keywordflow">return</span> NULL;
<a name="l00572"></a>00572          }
<a name="l00573"></a>00573          
<a name="l00574"></a>00574          <a class="code" href="astobj_8h.html#a996db3d193843755068f61f21e14c3dd" title="Initialize an object.">ASTOBJ_INIT</a>(md_msg);
<a name="l00575"></a>00575 
<a name="l00576"></a>00576          <span class="comment">/* read the message desk number */</span>
<a name="l00577"></a>00577          <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a45ad4fcc948460a8f37cc736d4d1ebca">mesg_desk_num</a>) - 1; i++) {
<a name="l00578"></a>00578             md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a45ad4fcc948460a8f37cc736d4d1ebca">mesg_desk_num</a>[i] = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a>);
<a name="l00579"></a>00579             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Read a &apos;%c&apos;\n&quot;</span>, md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a45ad4fcc948460a8f37cc736d4d1ebca">mesg_desk_num</a>[i]);
<a name="l00580"></a>00580          }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582          md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a45ad4fcc948460a8f37cc736d4d1ebca">mesg_desk_num</a>[<span class="keyword">sizeof</span>(md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a45ad4fcc948460a8f37cc736d4d1ebca">mesg_desk_num</a>) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00583"></a>00583          
<a name="l00584"></a>00584          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;The message desk number is &apos;%s&apos;\n&quot;</span>, md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a45ad4fcc948460a8f37cc736d4d1ebca">mesg_desk_num</a>);
<a name="l00585"></a>00585 
<a name="l00586"></a>00586          <span class="comment">/* read the message desk terminal number */</span>
<a name="l00587"></a>00587          <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a1ecc00a9b445a72596499679ed6c5672">mesg_desk_term</a>) - 1; i++) {
<a name="l00588"></a>00588             md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a1ecc00a9b445a72596499679ed6c5672">mesg_desk_term</a>[i] = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a>);
<a name="l00589"></a>00589             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Read a &apos;%c&apos;\n&quot;</span>, md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a1ecc00a9b445a72596499679ed6c5672">mesg_desk_term</a>[i]);
<a name="l00590"></a>00590          }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592          md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a1ecc00a9b445a72596499679ed6c5672">mesg_desk_term</a>[<span class="keyword">sizeof</span>(md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a1ecc00a9b445a72596499679ed6c5672">mesg_desk_term</a>) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;The message desk terminal is &apos;%s&apos;\n&quot;</span>, md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a1ecc00a9b445a72596499679ed6c5672">mesg_desk_term</a>);
<a name="l00595"></a>00595 
<a name="l00596"></a>00596          <span class="comment">/* read the message type */</span>
<a name="l00597"></a>00597          md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#aff17911edc8208aa8ddb1c7c52c78389">type</a> = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a>);
<a name="l00598"></a>00598        
<a name="l00599"></a>00599          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Message type is &apos;%c&apos;\n&quot;</span>, md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#aff17911edc8208aa8ddb1c7c52c78389">type</a>);
<a name="l00600"></a>00600 
<a name="l00601"></a>00601          <span class="comment">/* read the forwarding station number (may be blank) */</span>
<a name="l00602"></a>00602          cp = &amp;md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>[0];
<a name="l00603"></a>00603          <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>) - 1; i++) {
<a name="l00604"></a>00604             <span class="keywordflow">if</span> ((c = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a>)) == <span class="charliteral">&apos; &apos;</span>) {
<a name="l00605"></a>00605                *cp = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00606"></a>00606                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Read a space, done looking for the forwarding station\n&quot;</span>);
<a name="l00607"></a>00607                <span class="keywordflow">break</span>;
<a name="l00608"></a>00608             }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610             <span class="comment">/* store c in md_msg-&gt;fwd_st */</span>
<a name="l00611"></a>00611             <span class="keywordflow">if</span> (i &gt;= iface-&gt;<a class="code" href="structast__smdi__interface.html#a4c06c7e1993e25ece171922094497fff">msdstrip</a>) {
<a name="l00612"></a>00612                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Read a &apos;%c&apos; and stored it in the forwarding station buffer\n&quot;</span>, c);
<a name="l00613"></a>00613                *cp++ = c;
<a name="l00614"></a>00614             } <span class="keywordflow">else</span> {
<a name="l00615"></a>00615                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Read a &apos;%c&apos;, but didn&apos;t store it in the fwd station buffer, because of the msdstrip setting (%d &lt; %d)\n&quot;</span>, c, i, iface-&gt;<a class="code" href="structast__smdi__interface.html#a4c06c7e1993e25ece171922094497fff">msdstrip</a>);
<a name="l00616"></a>00616             }
<a name="l00617"></a>00617          }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619          <span class="comment">/* make sure the value is null terminated, even if this truncates it */</span>
<a name="l00620"></a>00620          md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>[<span class="keyword">sizeof</span>(md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00621"></a>00621          cp = NULL;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;The forwarding station is &apos;%s&apos;\n&quot;</span>, md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>);
<a name="l00624"></a>00624 
<a name="l00625"></a>00625          <span class="comment">/* Put the fwd_st in the name field so that we can use ASTOBJ_FIND to look</span>
<a name="l00626"></a>00626 <span class="comment">          * up a message on this field */</span>
<a name="l00627"></a>00627          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a3777dbae63a15da001b2baa317a25149">name</a>, md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>, <span class="keyword">sizeof</span>(md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a3777dbae63a15da001b2baa317a25149">name</a>));
<a name="l00628"></a>00628 
<a name="l00629"></a>00629          <span class="comment">/* read the calling station number (may be blank) */</span>
<a name="l00630"></a>00630          cp = &amp;md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a35dcfe0bcfb5c95e42fd180e23d89990">calling_st</a>[0];
<a name="l00631"></a>00631          <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a35dcfe0bcfb5c95e42fd180e23d89990">calling_st</a>) - 1; i++) {
<a name="l00632"></a>00632             <span class="keywordflow">if</span> (!isdigit((c = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a>)))) {
<a name="l00633"></a>00633                *cp = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00634"></a>00634                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Read a &apos;%c&apos;, but didn&apos;t store it in the calling station buffer because it&apos;s not a digit\n&quot;</span>, c);
<a name="l00635"></a>00635                <span class="keywordflow">if</span> (c == <span class="charliteral">&apos; &apos;</span>) {
<a name="l00636"></a>00636                   <span class="comment">/* Don&apos;t break on a space.  We may read the space before the calling station</span>
<a name="l00637"></a>00637 <span class="comment">                   * here if the forwarding station buffer filled up. */</span>
<a name="l00638"></a>00638                   i--; <span class="comment">/* We&apos;re still on the same character */</span>
<a name="l00639"></a>00639                   <span class="keywordflow">continue</span>;
<a name="l00640"></a>00640                }
<a name="l00641"></a>00641                <span class="keywordflow">break</span>;
<a name="l00642"></a>00642             }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644             <span class="comment">/* store c in md_msg-&gt;calling_st */</span>
<a name="l00645"></a>00645             <span class="keywordflow">if</span> (i &gt;= iface-&gt;<a class="code" href="structast__smdi__interface.html#a4c06c7e1993e25ece171922094497fff">msdstrip</a>) {
<a name="l00646"></a>00646                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Read a &apos;%c&apos; and stored it in the calling station buffer\n&quot;</span>, c);
<a name="l00647"></a>00647                *cp++ = c;
<a name="l00648"></a>00648             } <span class="keywordflow">else</span> {
<a name="l00649"></a>00649                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Read a &apos;%c&apos;, but didn&apos;t store it in the calling station buffer, because of the msdstrip setting (%d &lt; %d)\n&quot;</span>, c, i, iface-&gt;<a class="code" href="structast__smdi__interface.html#a4c06c7e1993e25ece171922094497fff">msdstrip</a>);
<a name="l00650"></a>00650             }
<a name="l00651"></a>00651          }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653          <span class="comment">/* make sure the value is null terminated, even if this truncates it */</span>
<a name="l00654"></a>00654          md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a35dcfe0bcfb5c95e42fd180e23d89990">calling_st</a>[<span class="keyword">sizeof</span>(md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a35dcfe0bcfb5c95e42fd180e23d89990">calling_st</a>) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00655"></a>00655          cp = NULL;
<a name="l00656"></a>00656 
<a name="l00657"></a>00657          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;The calling station is &apos;%s&apos;\n&quot;</span>, md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a35dcfe0bcfb5c95e42fd180e23d89990">calling_st</a>);
<a name="l00658"></a>00658 
<a name="l00659"></a>00659          <span class="comment">/* add the message to the message queue */</span>
<a name="l00660"></a>00660          md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#a175ebf16736553ad076aefe3f02d180c">timestamp</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00661"></a>00661          <a class="code" href="res__smdi_8c.html#a539e23e0762cb4032cd69b241b650f3c">ast_smdi_md_message_push</a>(iface, md_msg);
<a name="l00662"></a>00662          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Received SMDI MD message on %s\n&quot;</span>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>);
<a name="l00663"></a>00663          
<a name="l00664"></a>00664          <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(md_msg, <a class="code" href="smdi_8h.html#a408e56a27064d1537eb6e4accf73e6bf" title="ast_smdi_md_message destructor.">ast_smdi_md_message_destroy</a>);
<a name="l00665"></a>00665 
<a name="l00666"></a>00666       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == <span class="charliteral">&apos;W&apos;</span>) { <span class="comment">/* MWI message */</span>
<a name="l00667"></a>00667          start = 0;
<a name="l00668"></a>00668 
<a name="l00669"></a>00669          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Read a &apos;W&apos;, it&apos;s an MWI message. (No more debug coming for MWI messages)\n&quot;</span>);
<a name="l00670"></a>00670 
<a name="l00671"></a>00671          <span class="keywordflow">if</span> (!(mwi_msg = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*mwi_msg)))) {
<a name="l00672"></a>00672             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface,<a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l00673"></a>00673             <span class="keywordflow">return</span> NULL;
<a name="l00674"></a>00674          }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676          <a class="code" href="astobj_8h.html#a996db3d193843755068f61f21e14c3dd" title="Initialize an object.">ASTOBJ_INIT</a>(mwi_msg);
<a name="l00677"></a>00677 
<a name="l00678"></a>00678          <span class="comment">/* discard the &apos;I&apos; (from &apos;MWI&apos;) */</span>
<a name="l00679"></a>00679          fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a>);
<a name="l00680"></a>00680          
<a name="l00681"></a>00681          <span class="comment">/* read the forwarding station number (may be blank) */</span>
<a name="l00682"></a>00682          cp = &amp;mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>[0];
<a name="l00683"></a>00683          <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>) - 1; i++) {
<a name="l00684"></a>00684             <span class="keywordflow">if</span> ((c = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a>)) == <span class="charliteral">&apos; &apos;</span>) {
<a name="l00685"></a>00685                *cp = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00686"></a>00686                <span class="keywordflow">break</span>;
<a name="l00687"></a>00687             }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689             <span class="comment">/* store c in md_msg-&gt;fwd_st */</span>
<a name="l00690"></a>00690             <span class="keywordflow">if</span> (i &gt;= iface-&gt;<a class="code" href="structast__smdi__interface.html#a4c06c7e1993e25ece171922094497fff">msdstrip</a>)
<a name="l00691"></a>00691                *cp++ = c;
<a name="l00692"></a>00692          }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694          <span class="comment">/* make sure the station number is null terminated, even if this will truncate it */</span>
<a name="l00695"></a>00695          mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>[<span class="keyword">sizeof</span>(mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00696"></a>00696          cp = NULL;
<a name="l00697"></a>00697          
<a name="l00698"></a>00698          <span class="comment">/* Put the fwd_st in the name field so that we can use ASTOBJ_FIND to look</span>
<a name="l00699"></a>00699 <span class="comment">          * up a message on this field */</span>
<a name="l00700"></a>00700          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#a3777dbae63a15da001b2baa317a25149">name</a>, mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>, <span class="keyword">sizeof</span>(mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#a3777dbae63a15da001b2baa317a25149">name</a>));
<a name="l00701"></a>00701 
<a name="l00702"></a>00702          <span class="comment">/* read the mwi failure cause */</span>
<a name="l00703"></a>00703          <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#a3b3500852ae2642c562389b5a8ce9654">cause</a>) - 1; i++)
<a name="l00704"></a>00704             mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#a3b3500852ae2642c562389b5a8ce9654">cause</a>[i] = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#a702945180aa732857b380a007a7e2a21">file</a>);
<a name="l00705"></a>00705 
<a name="l00706"></a>00706          mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#a3b3500852ae2642c562389b5a8ce9654">cause</a>[<span class="keyword">sizeof</span>(mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#a3b3500852ae2642c562389b5a8ce9654">cause</a>) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00707"></a>00707 
<a name="l00708"></a>00708          <span class="comment">/* add the message to the message queue */</span>
<a name="l00709"></a>00709          mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#a175ebf16736553ad076aefe3f02d180c">timestamp</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00710"></a>00710          <a class="code" href="res__smdi_8c.html#a912ab4e78c7db772efa012cf8bfba4ed">ast_smdi_mwi_message_push</a>(iface, mwi_msg);
<a name="l00711"></a>00711          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Received SMDI MWI message on %s\n&quot;</span>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>);
<a name="l00712"></a>00712          
<a name="l00713"></a>00713          <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(mwi_msg, <a class="code" href="smdi_8h.html#adbf3873da6231af24d5a38113d6a8def" title="ast_smdi_mwi_message destructor.">ast_smdi_mwi_message_destroy</a>);
<a name="l00714"></a>00714       } <span class="keywordflow">else</span> {
<a name="l00715"></a>00715          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unknown SMDI message type received on %s (M%c).\n&quot;</span>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, c);
<a name="l00716"></a>00716          start = 0;
<a name="l00717"></a>00717       }
<a name="l00718"></a>00718    }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error reading from SMDI interface %s, stopping listener thread\n&quot;</span>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>);
<a name="l00721"></a>00721    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(iface,<a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l00722"></a>00722    <span class="keywordflow">return</span> NULL;
<a name="l00723"></a>00723 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7e881b24835a2254e43d88f68d052e55"></a><!-- doxytag: member="res_smdi.c::smdi_toggle_mwi" ref="a7e881b24835a2254e43d88f68d052e55" args="(struct ast_smdi_interface *iface, const char *mailbox, int on)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int smdi_toggle_mwi </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>mailbox</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>on</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00193">193</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astobj_8h_source.html#l00109">ASTOBJ_UNLOCK</a>, <a class="el" href="astobj_8h_source.html#l00104">ASTOBJ_WRLOCK</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="res__smdi_8c_source.html#l00084">ast_smdi_interface::msdstrip</a>, and <a class="el" href="res__smdi_8c_source.html#l00073">ast_smdi_interface::name</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00220">ast_smdi_mwi_set()</a>, and <a class="el" href="res__smdi_8c_source.html#l00225">ast_smdi_mwi_unset()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00194"></a>00194 {
<a name="l00195"></a>00195    FILE *file;
<a name="l00196"></a>00196    <span class="keywordtype">int</span> i;
<a name="l00197"></a>00197    
<a name="l00198"></a>00198    <span class="keywordflow">if</span> (!(file = fopen(iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, <span class="stringliteral">&quot;w&quot;</span>))) {
<a name="l00199"></a>00199       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error opening SMDI interface %s (%s) for writing\n&quot;</span>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>, strerror(errno));
<a name="l00200"></a>00200       <span class="keywordflow">return</span> 1;
<a name="l00201"></a>00201    }  
<a name="l00202"></a>00202    
<a name="l00203"></a>00203    <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(iface);
<a name="l00204"></a>00204    
<a name="l00205"></a>00205    fprintf(file, <span class="stringliteral">&quot;%s:MWI &quot;</span>, on ? <span class="stringliteral">&quot;OP&quot;</span> : <span class="stringliteral">&quot;RMV&quot;</span>);
<a name="l00206"></a>00206    
<a name="l00207"></a>00207    <span class="keywordflow">for</span> (i = 0; i &lt; iface-&gt;<a class="code" href="structast__smdi__interface.html#a4c06c7e1993e25ece171922094497fff">msdstrip</a>; i++)
<a name="l00208"></a>00208       fprintf(file, <span class="stringliteral">&quot;0&quot;</span>);
<a name="l00209"></a>00209 
<a name="l00210"></a>00210    fprintf(file, <span class="stringliteral">&quot;%s!\x04&quot;</span>, <a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>);
<a name="l00211"></a>00211 
<a name="l00212"></a>00212    fclose(file);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214    <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iface);
<a name="l00215"></a>00215    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Sent MWI set message for %s on %s\n&quot;</span>, <a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, iface-&gt;<a class="code" href="structast__smdi__interface.html#a8e03167ce04350be901b028cc4cf1ce1">name</a>);
<a name="l00216"></a>00216 
<a name="l00217"></a>00217    <span class="keywordflow">return</span> 0;
<a name="l00218"></a>00218 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a051d9e79bbd9448f61d8bfafb756355b"></a><!-- doxytag: member="res_smdi.c::unlink_from_msg_q" ref="a051d9e79bbd9448f61d8bfafb756355b" args="(struct ast_smdi_interface *iface, enum smdi_message_type type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* unlink_from_msg_q </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a>&nbsp;</td>
          <td class="paramname"> <em>type</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00275">275</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="astobj_8h_source.html#l00630">ASTOBJ_CONTAINER_UNLINK_START</a>, <a class="el" href="res__smdi_8c_source.html#l00074">ast_smdi_interface::md_q</a>, <a class="el" href="res__smdi_8c_source.html#l00077">ast_smdi_interface::mwi_q</a>, <a class="el" href="res__smdi_8c_source.html#l00248">SMDI_MD</a>, and <a class="el" href="res__smdi_8c_source.html#l00247">SMDI_MWI</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00316">purge_old_messages()</a>, and <a class="el" href="res__smdi_8c_source.html#l00357">smdi_msg_pop()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00276"></a>00276 {
<a name="l00277"></a>00277    <span class="keywordflow">switch</span> (<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>) {
<a name="l00278"></a>00278    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>:
<a name="l00279"></a>00279       <span class="keywordflow">return</span> <a class="code" href="astobj_8h.html#a524bda8342b3198a0c1fc9a23f6fb095" title="Remove an object from the front of a container.">ASTOBJ_CONTAINER_UNLINK_START</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#ac0aedea441d08fd6fc7aea5ba5d22fbd">mwi_q</a>);
<a name="l00280"></a>00280    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>:
<a name="l00281"></a>00281       <span class="keywordflow">return</span> <a class="code" href="astobj_8h.html#a524bda8342b3198a0c1fc9a23f6fb095" title="Remove an object from the front of a container.">ASTOBJ_CONTAINER_UNLINK_START</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a71b0ca7192d996168361d98dfc7b43a3">md_q</a>);
<a name="l00282"></a>00282    }
<a name="l00283"></a>00283    <span class="keywordflow">return</span> NULL;
<a name="l00284"></a>00284 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad09fa931f468002152a3cc2d5ce25eae"></a><!-- doxytag: member="res_smdi.c::unload_module" ref="ad09fa931f468002152a3cc2d5ce25eae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unload_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01368">1368</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01734">ast_cond_signal()</a>, <a class="el" href="pbx_8c_source.html#l03216">ast_custom_function_unregister()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="lock_8h_source.html#l00082">AST_PTHREADT_NULL</a>, <a class="el" href="res__smdi_8c_source.html#l00132">ast_smdi_interface_destroy()</a>, <a class="el" href="astobj_8h_source.html#l00765">ASTOBJ_CONTAINER_DESTROY</a>, <a class="el" href="astobj_8h_source.html#l00453">ASTOBJ_CONTAINER_DESTROYALL</a>, <a class="el" href="res__smdi_8c_source.html#l00742">destroy_all_mailbox_mappings()</a>, <a class="el" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72">mwi_monitor</a>, and <a class="el" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9">smdi_ifaces</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01369"></a>01369 {
<a name="l01370"></a>01370    <span class="comment">/* this destructor stops any running smdi_read threads */</span>
<a name="l01371"></a>01371    <a class="code" href="astobj_8h.html#a5b923418ce1d4908359bb3b27b211411" title="Empty a container.">ASTOBJ_CONTAINER_DESTROYALL</a>(&amp;<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>, <a class="code" href="res__smdi_8c.html#a213aa83b70bccd8e7ea627308d0ba9ea">ast_smdi_interface_destroy</a>);
<a name="l01372"></a>01372    <a class="code" href="astobj_8h.html#a49ab9467549d53be33f3f9f3ecae97f9" title="Destroy a container.">ASTOBJ_CONTAINER_DESTROY</a>(&amp;<a class="code" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9" title="SMDI interface container.">smdi_ifaces</a>);
<a name="l01373"></a>01373 
<a name="l01374"></a>01374    <a class="code" href="res__smdi_8c.html#aa8dcf5c17e8d6f96acfe863feb6efadc">destroy_all_mailbox_mappings</a>();
<a name="l01375"></a>01375 
<a name="l01376"></a>01376    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.lock);
<a name="l01377"></a>01377    <a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.stop = 1;
<a name="l01378"></a>01378    <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.cond);
<a name="l01379"></a>01379    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.lock);
<a name="l01380"></a>01380 
<a name="l01381"></a>01381    <span class="keywordflow">if</span> (<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.thread != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) {
<a name="l01382"></a>01382       pthread_join(<a class="code" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72" title="Data that gets used by the SMDI MWI monitoring thread.">mwi_monitor</a>.thread, NULL);
<a name="l01383"></a>01383    }
<a name="l01384"></a>01384 
<a name="l01385"></a>01385    <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;<a class="code" href="res__smdi_8c.html#ae571eca2127e70a65dd831104c03dbe7">smdi_msg_retrieve_function</a>);
<a name="l01386"></a>01386    <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;<a class="code" href="res__smdi_8c.html#a128dbd1032b7d4c41879b13dbe5a8734">smdi_msg_function</a>);
<a name="l01387"></a>01387 
<a name="l01388"></a>01388    <span class="keywordflow">return</span> 0;
<a name="l01389"></a>01389 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af6f2cbd59866ad8e9e7e92226c7e2526"></a><!-- doxytag: member="res_smdi.c::unlock_msg_q" ref="af6f2cbd59866ad8e9e7e92226c7e2526" args="(struct ast_smdi_interface *iface, enum smdi_message_type type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unlock_msg_q </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__smdi__interface.html">ast_smdi_interface</a> *&nbsp;</td>
          <td class="paramname"> <em>iface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a>&nbsp;</td>
          <td class="paramname"> <em>type</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00263">263</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="res__smdi_8c_source.html#l00075">ast_smdi_interface::md_q_lock</a>, <a class="el" href="res__smdi_8c_source.html#l00078">ast_smdi_interface::mwi_q_lock</a>, <a class="el" href="res__smdi_8c_source.html#l00248">SMDI_MD</a>, and <a class="el" href="res__smdi_8c_source.html#l00247">SMDI_MWI</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00316">purge_old_messages()</a>, <a class="el" href="res__smdi_8c_source.html#l00443">smdi_message_wait()</a>, and <a class="el" href="res__smdi_8c_source.html#l00357">smdi_msg_pop()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00264"></a>00264 {
<a name="l00265"></a>00265    <span class="keywordflow">switch</span> (<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>) {
<a name="l00266"></a>00266    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>:
<a name="l00267"></a>00267       <span class="keywordflow">return</span> <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a25597a94a263390ea8f0141a01380cb6">mwi_q_lock</a>);
<a name="l00268"></a>00268    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>:
<a name="l00269"></a>00269       <span class="keywordflow">return</span> <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#a1894293fb071c2d433189f286b67f553">md_q_lock</a>);
<a name="l00270"></a>00270    }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272    <span class="keywordflow">return</span> -1;
<a name="l00273"></a>00273 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa128a8b37535b9c3c64c6f0564ef4a51"></a><!-- doxytag: member="res_smdi.c::unref_msg" ref="aa128a8b37535b9c3c64c6f0564ef4a51" args="(void *msg, enum smdi_message_type type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void unref_msg </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781e">smdi_message_type</a>&nbsp;</td>
          <td class="paramname"> <em>type</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00301">301</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>References <a class="el" href="res__smdi_8c_source.html#l00725">ast_smdi_md_message_destroy()</a>, <a class="el" href="res__smdi_8c_source.html#l00730">ast_smdi_mwi_message_destroy()</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="res__smdi_8c_source.html#l00248">SMDI_MD</a>, and <a class="el" href="res__smdi_8c_source.html#l00247">SMDI_MWI</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00316">purge_old_messages()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00302"></a>00302 {
<a name="l00303"></a>00303    <span class="keyword">struct </span><a class="code" href="structast__smdi__md__message.html" title="An SMDI message desk message.">ast_smdi_md_message</a> *md_msg = <a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>;
<a name="l00304"></a>00304    <span class="keyword">struct </span><a class="code" href="structast__smdi__mwi__message.html" title="An SMDI message waiting indicator message.">ast_smdi_mwi_message</a> *mwi_msg = <a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306    <span class="keywordflow">switch</span> (<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>) {
<a name="l00307"></a>00307    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781ea21b9c68da53a6750ed7d332883f35ec4">SMDI_MWI</a>:
<a name="l00308"></a>00308       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(mwi_msg, <a class="code" href="smdi_8h.html#adbf3873da6231af24d5a38113d6a8def" title="ast_smdi_mwi_message destructor.">ast_smdi_mwi_message_destroy</a>);
<a name="l00309"></a>00309       <span class="keywordflow">break</span>;
<a name="l00310"></a>00310    <span class="keywordflow">case</span> <a class="code" href="res__smdi_8c.html#ac26bfca8265a99875c72729bd604781eaaa91d9fd87da4e5013fef78503d41b84">SMDI_MD</a>:
<a name="l00311"></a>00311       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(md_msg, <a class="code" href="smdi_8h.html#a408e56a27064d1537eb6e4accf73e6bf" title="ast_smdi_md_message destructor.">ast_smdi_md_message_destroy</a>);
<a name="l00312"></a>00312       <span class="keywordflow">break</span>;
<a name="l00313"></a>00313    }
<a name="l00314"></a>00314 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="ab22f32016155f7f403e7178767163d7d"></a><!-- doxytag: member="res_smdi.c::__mod_info" ref="ab22f32016155f7f403e7178767163d7d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a> <a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_GLOBAL_SYMBOLS , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;Simplified Message Desk Interface (SMDI) Resource&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, .reload = reload, }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01410">1410</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="ae25b9f3970870610911f8850897e8ead"></a><!-- doxytag: member="res_smdi.c::ast_module_info" ref="ae25b9f3970870610911f8850897e8ead" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a>* <a class="el" href="structast__module__info.html">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01410">1410</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="a1c7181c39f99ee801943a0d0aa9872b9"></a><!-- doxytag: member="res_smdi.c::cond" ref="a1c7181c39f99ee801943a0d0aa9872b9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> <a class="el" href="res__timing__pthread_8c.html#a1c7181c39f99ee801943a0d0aa9872b9">cond</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00119">119</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="abb961ff543844412d044d48e6163b3a8"></a><!-- doxytag: member="res_smdi.c::config_file" ref="abb961ff543844412d044d48e6163b3a8" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char <a class="el" href="res__smdi_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a>[] = &quot;smdi.conf&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00060">60</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="af1c80cf45d32519afc2e859f8e5819a1"></a><!-- doxytag: member="res_smdi.c::first" ref="af1c80cf45d32519afc2e859f8e5819a1" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structmailbox__mapping.html">mailbox_mapping</a>* <a class="el" href="res__smdi_8c.html#af1c80cf45d32519afc2e859f8e5819a1">first</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00121">121</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="a9584356f2e9a2d4e36cdadce9c5df4a7"></a><!-- doxytag: member="res_smdi.c::last" ref="a9584356f2e9a2d4e36cdadce9c5df4a7" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structmailbox__mapping.html">mailbox_mapping</a>* <a class="el" href="res__smdi_8c.html#a9584356f2e9a2d4e36cdadce9c5df4a7">last</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00121">121</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="acfe0553b07ce04ccd0001791aa20ccd2"></a><!-- doxytag: member="res_smdi.c::last_poll" ref="acfe0553b07ce04ccd0001791aa20ccd2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct timeval <a class="el" href="res__smdi_8c.html#acfe0553b07ce04ccd0001791aa20ccd2">last_poll</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>The time that the last poll began </p>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00127">127</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="adf04f66344e3fb0a6f6a69bf39d19902"></a><!-- doxytag: member="res_smdi.c::lock" ref="adf04f66344e3fb0a6f6a69bf39d19902" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="el" href="res__timing__pthread_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00118">118</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab63d2897c74948a6792c4cbdbeae9f16"></a><!-- doxytag: member="res_smdi.c::mailbox_mappings" ref="ab63d2897c74948a6792c4cbdbeae9f16" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct { ... }   <a class="el" href="res__smdi_8c.html#ab63d2897c74948a6792c4cbdbeae9f16">mailbox_mappings</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>A list of mailboxes that need to be monitored </p>

</div>
</div>
<a class="anchor" id="a85c9ccfa40ad2c8c4afbf2b10b32ac72"></a><!-- doxytag: member="res_smdi.c::mwi_monitor" ref="a85c9ccfa40ad2c8c4afbf2b10b32ac72" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct { ... }   <a class="el" href="res__smdi_8c.html#a85c9ccfa40ad2c8c4afbf2b10b32ac72">mwi_monitor</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Data that gets used by the SMDI MWI monitoring thread. </p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00752">append_mailbox_mapping()</a>, <a class="el" href="res__smdi_8c_source.html#l00742">destroy_all_mailbox_mappings()</a>, <a class="el" href="res__smdi_8c_source.html#l01340">load_module()</a>, <a class="el" href="res__smdi_8c_source.html#l00804">mwi_monitor_handler()</a>, <a class="el" href="res__smdi_8c_source.html#l00861">smdi_load()</a>, and <a class="el" href="res__smdi_8c_source.html#l01368">unload_module()</a>.</p>

</div>
</div>
<a class="anchor" id="a392d1e08448d735437a3ee22460e1bc5"></a><!-- doxytag: member="res_smdi.c::polling_interval" ref="a392d1e08448d735437a3ee22460e1bc5" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned int <a class="el" href="res__smdi_8c.html#a392d1e08448d735437a3ee22460e1bc5">polling_interval</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Polling Interval for checking mailbox status </p>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00123">123</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="a0ccb57302bb98603a039fe3989d5ecb9"></a><!-- doxytag: member="res_smdi.c::smdi_ifaces" ref="a0ccb57302bb98603a039fe3989d5ecb9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__smdi__interface__container.html">ast_smdi_interface_container</a>  <a class="el" href="res__smdi_8c.html#a0ccb57302bb98603a039fe3989d5ecb9">smdi_ifaces</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>SMDI interface container. </p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l00528">ast_smdi_interface_find()</a>, <a class="el" href="res__smdi_8c_source.html#l01340">load_module()</a>, <a class="el" href="res__smdi_8c_source.html#l00861">smdi_load()</a>, and <a class="el" href="res__smdi_8c_source.html#l01368">unload_module()</a>.</p>

</div>
</div>
<a class="anchor" id="aa3633a2b3d5aefdf40ed428c3d483527"></a><!-- doxytag: member="res_smdi.c::smdi_msg_datastore_info" ref="aa3633a2b3d5aefdf40ed428c3d483527" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__datastore__info.html">ast_datastore_info</a> <a class="el" href="res__smdi_8c.html#aa3633a2b3d5aefdf40ed428c3d483527">smdi_msg_datastore_info</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
   .type = <span class="stringliteral">&quot;SMDIMSG&quot;</span>,
   .destroy = <a class="code" href="res__smdi_8c.html#a7a89715a33742e572af17f2ff5e91db4">smdi_msg_datastore_destroy</a>,
}
</pre></div>
<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01107">1107</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="a128dbd1032b7d4c41879b13dbe5a8734"></a><!-- doxytag: member="res_smdi.c::smdi_msg_function" ref="a128dbd1032b7d4c41879b13dbe5a8734" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__custom__function.html">ast_custom_function</a> <a class="el" href="res__smdi_8c.html#a128dbd1032b7d4c41879b13dbe5a8734">smdi_msg_function</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01317">1317</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="af946306630fcc495fc32ab59aecf4fca"></a><!-- doxytag: member="res_smdi.c::smdi_msg_id" ref="af946306630fcc495fc32ab59aecf4fca" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="res__smdi_8c.html#af946306630fcc495fc32ab59aecf4fca">smdi_msg_id</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01112">1112</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="a78fd6e06a4ad1ece63365b1703c263c5"></a><!-- doxytag: member="res_smdi.c::smdi_msg_ret_options" ref="a78fd6e06a4ad1ece63365b1703c263c5" args="[128]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__app__option.html">ast_app_option</a> <a class="el" href="res__smdi_8c.html#a78fd6e06a4ad1ece63365b1703c263c5">smdi_msg_ret_options</a>[128] = { [ 't' ] = { .flag = OPT_SEARCH_TERMINAL }, [ 'n' ] = { .flag = OPT_SEARCH_NUMBER }, }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01120">1120</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

<p>Referenced by <a class="el" href="res__smdi_8c_source.html#l01122">smdi_msg_retrieve_read()</a>.</p>

</div>
</div>
<a class="anchor" id="ae571eca2127e70a65dd831104c03dbe7"></a><!-- doxytag: member="res_smdi.c::smdi_msg_retrieve_function" ref="ae571eca2127e70a65dd831104c03dbe7" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__custom__function.html">ast_custom_function</a> <a class="el" href="res__smdi_8c.html#ae571eca2127e70a65dd831104c03dbe7">smdi_msg_retrieve_function</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l01293">1293</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="a111277a0849f92b793ed6aa1efe54462"></a><!-- doxytag: member="res_smdi.c::stop" ref="a111277a0849f92b793ed6aa1efe54462" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned int <a class="el" href="res__timing__pthread_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Set to 1 to tell the polling thread to stop </p>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00125">125</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
<a class="anchor" id="a01f75a9ad916f63a94e06a27635ba278"></a><!-- doxytag: member="res_smdi.c::thread" ref="a01f75a9ad916f63a94e06a27635ba278" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">pthread_t <a class="el" href="res__timing__pthread_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>The thread ID </p>

<p>Definition at line <a class="el" href="res__smdi_8c_source.html#l00117">117</a> of file <a class="el" href="res__smdi_8c_source.html">res_smdi.c</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:23:17 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
