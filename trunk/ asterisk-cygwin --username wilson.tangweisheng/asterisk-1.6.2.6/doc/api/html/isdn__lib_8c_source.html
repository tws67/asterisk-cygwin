<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:42 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_0ca6ff3bf6b340411b2c6edd15b1a34d.html">channels</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_ff311a8f439b457db2e83f52de102b35.html">misdn</a>
  </div>
</div>
<div class="contents">
<h1>isdn_lib.c</h1><a href="isdn__lib_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Chan_Misdn -- Channel Driver for Asterisk</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Interface to mISDN</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Copyright (C) 2004, Christian Richter</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * Christian Richter &lt;crich@beronet.com&gt;</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00011"></a>00011 <span class="comment"> * the GNU General Public License</span>
<a name="l00012"></a>00012 <span class="comment"> */</span>
<a name="l00013"></a>00013 <span class="comment"></span>
<a name="l00014"></a>00014 <span class="comment">/*! \file </span>
<a name="l00015"></a>00015 <span class="comment"> * \brief Interface to mISDN</span>
<a name="l00016"></a>00016 <span class="comment"> * \author Christian Richter &lt;crich@beronet.com&gt;</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;syslog.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;mISDNuser/isdn_debug.h&gt;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="isdn__lib__intern_8h.html">isdn_lib_intern.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="isdn__lib_8h.html" title="Interface to mISDN.">isdn_lib.h</a>&quot;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#aa6143baad2c3764c9d130d676850196b">event_response_e</a> (*<a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>) (<span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0">event_e</a> event, <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">void</span> *user_data);
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 void (*<a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>) (<span class="keywordtype">int</span> level, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="keywordtype">char</span> *tmpl, ...)
<a name="l00031"></a>00031    __attribute__ ((<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a> (printf, 3, 4)));
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 int (*<a class="code" href="isdn__lib_8c.html#a72481e6f9189b5aa9d4b4ab441118e76">cb_jb_empty</a>)(<span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="comment">/* </span>
<a name="l00037"></a>00037 <span class="comment"> * Define ARRAY_LEN() because I cannot</span>
<a name="l00038"></a>00038 <span class="comment"> * #include &quot;asterisk/utils.h&quot;</span>
<a name="l00039"></a>00039 <span class="comment"> */</span>
<a name="l00040"></a><a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">00040</a> <span class="preprocessor">#define ARRAY_LEN(a) (sizeof(a) / sizeof(a[0]))</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="causes_8h.html" title="Internal Asterisk hangup causes.">asterisk/causes.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#abab4f8b1249e8086247badba522584c7">misdn_join_conf</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#aab0f7344f706b822f3aeab3e328793d0" title="Bridging conference ID.">conf_id</a>);
<a name="l00045"></a>00045 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a4f8e334830dd8d96704965b9ef8de451">misdn_split_conf</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#aab0f7344f706b822f3aeab3e328793d0" title="Bridging conference ID.">conf_id</a>);
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a3e98bad8b07fc948392093f449341f4c">queue_cleanup_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc) ;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#af03ad57836b38845f685368e60625707">misdn_lib_get_l2_up</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack);
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a>* <a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>( <span class="keywordtype">void</span> );
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a5ed5ed7382be41aad46e670f55825fcd">release_cr</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, mISDNuser_head_t *hh);
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="isdn__lib_8h.html#a0397696531bb8058c4f712aa8428d492">00055</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a0397696531bb8058c4f712aa8428d492">misdn_lib_port_is_pri</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>)
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>();
<a name="l00058"></a>00058    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l00059"></a>00059       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) {
<a name="l00060"></a>00060          <span class="keywordflow">return</span> stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a>;
<a name="l00061"></a>00061       }
<a name="l00062"></a>00062    }
<a name="l00063"></a>00063    
<a name="l00064"></a>00064    <span class="keywordflow">return</span> -1;
<a name="l00065"></a>00065 }
<a name="l00066"></a>00066 
<a name="l00067"></a><a class="code" href="isdn__lib_8h.html#af7c94af767216508e15fd4f55131abc1">00067</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#af7c94af767216508e15fd4f55131abc1">misdn_lib_port_is_nt</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>)
<a name="l00068"></a>00068 {
<a name="l00069"></a>00069    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>();
<a name="l00070"></a>00070    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l00071"></a>00071       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) {
<a name="l00072"></a>00072          <span class="keywordflow">return</span> stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>;
<a name="l00073"></a>00073       }
<a name="l00074"></a>00074    }
<a name="l00075"></a>00075    
<a name="l00076"></a>00076    <span class="keywordflow">return</span> -1;
<a name="l00077"></a>00077 }
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="isdn__lib_8h.html#aeb7cfd0342e0a820eb3d7302401c9c74">00079</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#aeb7cfd0342e0a820eb3d7302401c9c74">misdn_make_dummy</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *dummybc, <span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="keywordtype">int</span> l3id, <span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>, <span class="keywordtype">int</span> channel) 
<a name="l00080"></a>00080 {
<a name="l00081"></a>00081    memset (dummybc,0,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>));
<a name="l00082"></a>00082    dummybc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>=port;
<a name="l00083"></a>00083    <span class="keywordflow">if</span> (l3id==0) 
<a name="l00084"></a>00084       dummybc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a> = MISDN_ID_DUMMY;
<a name="l00085"></a>00085    <span class="keywordflow">else</span>
<a name="l00086"></a>00086       dummybc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>=l3id;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088    dummybc-&gt;<a class="code" href="structmisdn__bchannel.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>=nt;
<a name="l00089"></a>00089    dummybc-&gt;<a class="code" href="structmisdn__bchannel.html#a7c1d654b7b6114d7a0abc8d351dd1bcd" title="TRUE if this is a dummy BC record.">dummy</a>=1;
<a name="l00090"></a>00090    dummybc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>=channel;
<a name="l00091"></a>00091 }
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="isdn__lib_8h.html#a4cadcadbe3825e4fe2a476a4b93a529a">00093</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a4cadcadbe3825e4fe2a476a4b93a529a">misdn_lib_port_block</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>)
<a name="l00094"></a>00094 {
<a name="l00095"></a>00095    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>();
<a name="l00096"></a>00096    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l00097"></a>00097       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) {
<a name="l00098"></a>00098          stack-&gt;<a class="code" href="structmisdn__stack.html#ac74e3d5a1b1eeb5c8e32867ad62823f0" title="TRUE if port is blocked.">blocked</a>=1;
<a name="l00099"></a>00099          <span class="keywordflow">return</span> 0;
<a name="l00100"></a>00100       }
<a name="l00101"></a>00101    }
<a name="l00102"></a>00102    <span class="keywordflow">return</span> -1;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="isdn__lib_8h.html#a2ed2741b4a2412a38f62d57d5439f9b8">00106</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a2ed2741b4a2412a38f62d57d5439f9b8">misdn_lib_port_unblock</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>)
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>();
<a name="l00109"></a>00109    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l00110"></a>00110       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) {
<a name="l00111"></a>00111          stack-&gt;<a class="code" href="structmisdn__stack.html#ac74e3d5a1b1eeb5c8e32867ad62823f0" title="TRUE if port is blocked.">blocked</a>=0;
<a name="l00112"></a>00112          <span class="keywordflow">return</span> 0;
<a name="l00113"></a>00113       }
<a name="l00114"></a>00114    }
<a name="l00115"></a>00115    <span class="keywordflow">return</span> -1;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 
<a name="l00119"></a><a class="code" href="isdn__lib_8h.html#aecc0ab9ac09a182f65a2042357240088">00119</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#aecc0ab9ac09a182f65a2042357240088">misdn_lib_is_port_blocked</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>)
<a name="l00120"></a>00120 {  
<a name="l00121"></a>00121    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>();
<a name="l00122"></a>00122    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l00123"></a>00123       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) {
<a name="l00124"></a>00124          <span class="keywordflow">return</span> stack-&gt;<a class="code" href="structmisdn__stack.html#ac74e3d5a1b1eeb5c8e32867ad62823f0" title="TRUE if port is blocked.">blocked</a>;
<a name="l00125"></a>00125       }
<a name="l00126"></a>00126    }
<a name="l00127"></a>00127    <span class="keywordflow">return</span> -1;
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a><a class="code" href="isdn__lib_8h.html#abb98bbaed704a93d67663012188d4f46">00130</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#abb98bbaed704a93d67663012188d4f46">misdn_lib_is_ptp</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>();
<a name="l00133"></a>00133    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l00134"></a>00134       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) <span class="keywordflow">return</span> stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a>;
<a name="l00135"></a>00135    }
<a name="l00136"></a>00136    <span class="keywordflow">return</span> -1;
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="isdn__lib_8h.html#a0ea1ee03bd6a45acb752b8046ed1fd30">00139</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a0ea1ee03bd6a45acb752b8046ed1fd30">misdn_lib_get_maxchans</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>) 
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>();
<a name="l00142"></a>00142    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l00143"></a>00143       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) {
<a name="l00144"></a>00144          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a>) 
<a name="l00145"></a>00145             <span class="keywordflow">return</span> 30;
<a name="l00146"></a>00146          <span class="keywordflow">else</span>
<a name="l00147"></a>00147             <span class="keywordflow">return</span> 2;
<a name="l00148"></a>00148       }
<a name="l00149"></a>00149    }
<a name="l00150"></a>00150    <span class="keywordflow">return</span> -1;
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 
<a name="l00154"></a><a class="code" href="isdn__lib__intern_8h.html#a741c68a6879aa333e2fdf1e552e1a5fd">00154</a> <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *<a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack = <a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>();
<a name="l00157"></a>00157 
<a name="l00158"></a>00158    <span class="keywordflow">if</span> (!bc)
<a name="l00159"></a>00159       <span class="keywordflow">return</span> NULL;
<a name="l00160"></a>00160    
<a name="l00161"></a>00161    <span class="keywordflow">for</span> ( ; stack; stack = stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l00162"></a>00162       <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a> == stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>)
<a name="l00163"></a>00163          <span class="keywordflow">return</span> stack;
<a name="l00164"></a>00164    }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166    <span class="keywordflow">return</span> NULL;
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="isdn__lib_8h.html#a43a4d64b314f634eabc3589c0d5fa0b9">00170</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a43a4d64b314f634eabc3589c0d5fa0b9">get_show_stack_details</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>();
<a name="l00173"></a>00173    
<a name="l00174"></a>00174    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l00175"></a>00175       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) <span class="keywordflow">break</span>;
<a name="l00176"></a>00176    }
<a name="l00177"></a>00177    
<a name="l00178"></a>00178    <span class="keywordflow">if</span> (stack) {
<a name="l00179"></a>00179       sprintf(buf, <span class="stringliteral">&quot;* Port %d Type %s Prot. %s L2Link %s L1Link:%s Blocked:%d&quot;</span>,
<a name="l00180"></a>00180          stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a> ? <span class="stringliteral">&quot;NT&quot;</span> : <span class="stringliteral">&quot;TE&quot;</span>, stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a> ? <span class="stringliteral">&quot;PTP&quot;</span> : <span class="stringliteral">&quot;PMP&quot;</span>,
<a name="l00181"></a>00181          stack-&gt;<a class="code" href="structmisdn__stack.html#a2f51cb4d0630a299b4e436c7471eea21" title="TRUE if Layer 2 is UP.">l2link</a> ? <span class="stringliteral">&quot;UP&quot;</span> : <span class="stringliteral">&quot;DOWN&quot;</span>, stack-&gt;<a class="code" href="structmisdn__stack.html#a579e76479941e4610b630ada968ae5e2" title="TRUE if Layer 1 is UP.">l1link</a> ? <span class="stringliteral">&quot;UP&quot;</span> : <span class="stringliteral">&quot;DOWN&quot;</span>,
<a name="l00182"></a>00182          stack-&gt;<a class="code" href="structmisdn__stack.html#ac74e3d5a1b1eeb5c8e32867ad62823f0" title="TRUE if port is blocked.">blocked</a>);
<a name="l00183"></a>00183    } <span class="keywordflow">else</span> {
<a name="l00184"></a>00184       buf[0]=0;
<a name="l00185"></a>00185    }
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="isdn__lib_8c.html#aba8cad333ff912c21e19c9e68ef14559">00189</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#aba8cad333ff912c21e19c9e68ef14559">nt_err_cnt</a> =0 ;
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="isdn__lib_8c.html#af1db0e676da5eccb2fa1d40ae01412a8">00191</a> <span class="keyword">enum</span> <a class="code" href="isdn__lib_8c.html#af1db0e676da5eccb2fa1d40ae01412a8">global_states</a> {
<a name="l00192"></a><a class="code" href="isdn__lib_8c.html#af1db0e676da5eccb2fa1d40ae01412a8a493e1a716bb1491a16cc538cab8cf544">00192</a>    <a class="code" href="isdn__lib_8c.html#af1db0e676da5eccb2fa1d40ae01412a8a493e1a716bb1491a16cc538cab8cf544">MISDN_INITIALIZING</a>,
<a name="l00193"></a><a class="code" href="isdn__lib_8c.html#af1db0e676da5eccb2fa1d40ae01412a8a2e1eacba6b620d51dce53d3bd8cffd4e">00193</a>    <a class="code" href="isdn__lib_8c.html#af1db0e676da5eccb2fa1d40ae01412a8a2e1eacba6b620d51dce53d3bd8cffd4e">MISDN_INITIALIZED</a>
<a name="l00194"></a>00194 } ;
<a name="l00195"></a>00195 
<a name="l00196"></a><a class="code" href="isdn__lib_8c.html#a6ec20a28d970e044419c8b3cf34e469e">00196</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="isdn__lib_8c.html#af1db0e676da5eccb2fa1d40ae01412a8">global_states</a>  <a class="code" href="isdn__lib_8c.html#a6ec20a28d970e044419c8b3cf34e469e">global_state</a>=<a class="code" href="isdn__lib_8c.html#af1db0e676da5eccb2fa1d40ae01412a8a493e1a716bb1491a16cc538cab8cf544">MISDN_INITIALIZING</a>;
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 <span class="preprocessor">#include &lt;mISDNuser/net_l2.h&gt;</span>
<a name="l00200"></a>00200 <span class="preprocessor">#include &lt;mISDNuser/tone.h&gt;</span>
<a name="l00201"></a>00201 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00202"></a>00202 <span class="preprocessor">#include &lt;semaphore.h&gt;</span>
<a name="l00203"></a>00203 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00204"></a>00204 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 <span class="preprocessor">#include &quot;<a class="code" href="isdn__lib_8h.html" title="Interface to mISDN.">isdn_lib.h</a>&quot;</span>
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 
<a name="l00209"></a><a class="code" href="structmisdn__lib.html">00209</a> <span class="keyword">struct </span><a class="code" href="structmisdn__lib.html">misdn_lib</a> {<span class="comment"></span>
<a name="l00210"></a>00210 <span class="comment">   /*! \brief mISDN device handle returned by mISDN_open() */</span>
<a name="l00211"></a><a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a">00211</a>    <span class="keywordtype">int</span> <a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>;
<a name="l00212"></a><a class="code" href="structmisdn__lib.html#a6cbea5a0a6b351559ff12a36bd62dba3">00212</a>    <span class="keywordtype">int</span> <a class="code" href="structmisdn__lib.html#a6cbea5a0a6b351559ff12a36bd62dba3">midev_nt</a>;  <span class="comment">/* Not used */</span>
<a name="l00213"></a>00213 
<a name="l00214"></a><a class="code" href="structmisdn__lib.html#a2094d25b23478520356dca649a8403e6">00214</a>    pthread_t <a class="code" href="structmisdn__lib.html#a2094d25b23478520356dca649a8403e6">event_thread</a>;
<a name="l00215"></a><a class="code" href="structmisdn__lib.html#a040ae357d3e92605bf26146fc6db0df7">00215</a>    pthread_t <a class="code" href="structmisdn__lib.html#a040ae357d3e92605bf26146fc6db0df7">event_handler_thread</a>;
<a name="l00216"></a>00216 
<a name="l00217"></a><a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">00217</a>    <span class="keywordtype">void</span> *<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>;
<a name="l00218"></a>00218 
<a name="l00219"></a><a class="code" href="structmisdn__lib.html#a8c19dab645a65e0caf1924c1bcce7f1d">00219</a>    msg_queue_t <a class="code" href="structmisdn__lib.html#a8c19dab645a65e0caf1924c1bcce7f1d">upqueue</a>;
<a name="l00220"></a><a class="code" href="structmisdn__lib.html#ad99ef86d7f5f4f6e4b4785fda4e1abcb">00220</a>    msg_queue_t <a class="code" href="structmisdn__lib.html#ad99ef86d7f5f4f6e4b4785fda4e1abcb">activatequeue</a>; 
<a name="l00221"></a>00221   
<a name="l00222"></a><a class="code" href="structmisdn__lib.html#a3faba04201c788a3b42b3af24b83f61f">00222</a>    sem_t <a class="code" href="structmisdn__lib.html#a3faba04201c788a3b42b3af24b83f61f">new_msg</a>;
<a name="l00223"></a>00223   
<a name="l00224"></a><a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">00224</a>    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>;
<a name="l00225"></a>00225 } ;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227 <span class="preprocessor">#ifndef ECHOCAN_ON</span>
<a name="l00228"></a><a class="code" href="isdn__lib_8c.html#a1d04e4c505f3b5098045983971c84bf3">00228</a> <span class="preprocessor"></span><span class="preprocessor">#define ECHOCAN_ON 123</span>
<a name="l00229"></a><a class="code" href="isdn__lib_8c.html#ae22add021206651a21a9a3f3cb631616">00229</a> <span class="preprocessor"></span><span class="preprocessor">#define ECHOCAN_OFF 124</span>
<a name="l00230"></a>00230 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span>
<a name="l00232"></a><a class="code" href="isdn__lib_8c.html#a442515fae9997fa2ba0256b9b72096e1">00232</a> <span class="preprocessor">#define MISDN_DEBUG 0</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span>
<a name="l00234"></a>00234 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a4b517b8a0f6a3571dba3ec48eed7ff0d">misdn_tx_jitter</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l3id);
<a name="l00237"></a>00237 
<a name="l00238"></a>00238 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a58b3989f0b5555f87f5c55fdefa8c6fb">setup_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a9b68a92e4295d00f7450b5300b63eef0">manager_isdn_handler</a>(iframe_t *frm ,msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a8cf964fe703a6f4f84f2011cd191a0df">misdn_lib_port_restart</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>);
<a name="l00243"></a>00243 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a111cdb350e166d2945f9fd13baa2ebc0">misdn_lib_pid_restart</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structisdn__msg.html">isdn_msg</a> <a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a>[]; 
<a name="l00246"></a>00246 
<a name="l00247"></a><a class="code" href="isdn__lib_8c.html#a085934559aa50e6c69555da1451d35f4">00247</a> <span class="preprocessor">#define ISDN_PID_L3_B_USER 0x430000ff</span>
<a name="l00248"></a><a class="code" href="isdn__lib_8c.html#a3537a99d1cf6027496cfdea16a4f5f2c">00248</a> <span class="preprocessor"></span><span class="preprocessor">#define ISDN_PID_L4_B_USER 0x440000ff</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span>
<a name="l00250"></a>00250 <span class="comment">/* #define MISDN_IBUF_SIZE 1024 */</span>
<a name="l00251"></a><a class="code" href="isdn__lib_8c.html#a2e0a45e18950314bd8306b3b0b6afc11">00251</a> <span class="preprocessor">#define MISDN_IBUF_SIZE 512</span>
<a name="l00252"></a>00252 <span class="preprocessor"></span>
<a name="l00253"></a>00253 <span class="comment">/*  Fine Tuning of Inband  Signalling time */</span>
<a name="l00254"></a><a class="code" href="isdn__lib_8c.html#a2e36d48e58b17ca1cc6d05a3d3981850">00254</a> <span class="preprocessor">#define TONE_ALERT_CNT 41 </span><span class="comment">/*  1 Sec  */</span>
<a name="l00255"></a><a class="code" href="isdn__lib_8c.html#aad821887afa7c59ad196f0381bc164dd">00255</a> <span class="preprocessor">#define TONE_ALERT_SILENCE_CNT 200 </span><span class="comment">/*  4 Sec */</span>
<a name="l00256"></a>00256 
<a name="l00257"></a><a class="code" href="isdn__lib_8c.html#a63f6ed94c5820114f18aee4b435b4fd9">00257</a> <span class="preprocessor">#define TONE_BUSY_CNT 20 </span><span class="comment">/*  ? */</span>
<a name="l00258"></a><a class="code" href="isdn__lib_8c.html#a4597208fba4d7fd32ac29dd8a29a53c6">00258</a> <span class="preprocessor">#define TONE_BUSY_SILENCE_CNT 48 </span><span class="comment">/*  ? */</span>
<a name="l00259"></a>00259 
<a name="l00260"></a><a class="code" href="isdn__lib_8c.html#ad4e4601988acb4a95ecd1ec380359ae5">00260</a> <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="isdn__lib_8c.html#ad4e4601988acb4a95ecd1ec380359ae5">entity</a>;
<a name="l00261"></a>00261 
<a name="l00262"></a><a class="code" href="isdn__lib_8c.html#a94a231558bbf2b31274b9848c262ec1e">00262</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__lib.html">misdn_lib</a> *<a class="code" href="isdn__lib_8c.html#a94a231558bbf2b31274b9848c262ec1e">glob_mgr</a>;
<a name="l00263"></a>00263 
<a name="l00264"></a><a class="code" href="isdn__lib_8c.html#aab80108963454954223661b8e7efd46f">00264</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="isdn__lib_8c.html#aab80108963454954223661b8e7efd46f">tone_425_flip</a>[TONE_425_SIZE];
<a name="l00265"></a><a class="code" href="isdn__lib_8c.html#abe32bf44a6e3dc9e463cecdd806091aa">00265</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="isdn__lib_8c.html#abe32bf44a6e3dc9e463cecdd806091aa">tone_silence_flip</a>[TONE_SILENCE_SIZE];
<a name="l00266"></a>00266 
<a name="l00267"></a>00267 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#aafca72f03d258872c306e1fb5d10b5bd">misdn_lib_isdn_event_catcher</a>(<span class="keywordtype">void</span> *arg);
<a name="l00268"></a>00268 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a337b0dfa9c48d2177f26a30278742186">handle_event_nt</a>(<span class="keywordtype">void</span> *dat, <span class="keywordtype">void</span> *arg);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#aed5d2f567f0cd604dcb408ac5be5f983">stack_holder_add</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *holder);
<a name="l00272"></a>00272 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a658efc12f0e9b235f2266fff4743dfab">stack_holder_remove</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *holder);
<a name="l00273"></a>00273 <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#a6ae22b9108f567d7bae369dc17c65062">stack_holder_find</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l3id);
<a name="l00274"></a>00274 
<a name="l00275"></a>00275 <span class="comment">/* from isdn_lib.h */</span>
<a name="l00276"></a>00276    <span class="comment">/* user iface */</span>
<a name="l00277"></a>00277 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a5350c9c1249234db77f41814cad90b6e">te_lib_init</a>( <span class="keywordtype">void</span> ) ; <span class="comment">/* returns midev */</span>
<a name="l00278"></a>00278 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#ad8cee834c1e43d68d987135d3456e091">te_lib_destroy</a>(<span class="keywordtype">int</span> midev) ;
<a name="l00279"></a>00279 <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#abf9dc535c1858428371b26baf226db3d">manager_find_bc_by_pid</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l00280"></a>00280 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a68056961358d38e2cef26ccf6c136a99">manager_ph_control_block</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> c1, <span class="keywordtype">void</span> *c2, <span class="keywordtype">int</span> c2_len);
<a name="l00281"></a>00281 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#ad4a199ce1a64870d8f5ca24d048ada66">manager_clean_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc );
<a name="l00282"></a>00282 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a498b221512049d20d2e3af173a7d9ed8">manager_bchannel_setup</a> (<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc);
<a name="l00283"></a>00283 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#aff2418a7c453ad93c5f9df8819136ba2">manager_bchannel_cleanup</a> (<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#aad3856e404061cdcc5b2b9ca7cc086b4">ec_chunk</a>( <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *rxchunk, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *txchunk, <span class="keywordtype">int</span> chunk_size);
<a name="l00286"></a>00286    <span class="comment">/* end */</span>
<a name="l00287"></a>00287 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a7b5721b41adc3b503285a8cead387c7e">bchdev_echocancel_activate</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>* dev);
<a name="l00288"></a>00288 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#ade62c48c829eea3194b7f48d2de136ef">bchdev_echocancel_deactivate</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>* dev);
<a name="l00289"></a>00289 <span class="comment">/* end */</span>
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 
<a name="l00292"></a><a class="code" href="isdn__lib_8c.html#aaffa6d9528e0309ddb72535d3ae40ca5">00292</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="isdn__lib_8c.html#aaffa6d9528e0309ddb72535d3ae40ca5">bearer2str</a>(<span class="keywordtype">int</span> cap) {
<a name="l00293"></a>00293    <span class="keyword">static</span> <span class="keywordtype">char</span> *bearers[]={
<a name="l00294"></a>00294       <span class="stringliteral">&quot;Speech&quot;</span>,
<a name="l00295"></a>00295       <span class="stringliteral">&quot;Audio 3.1k&quot;</span>,
<a name="l00296"></a>00296       <span class="stringliteral">&quot;Unres Digital&quot;</span>,
<a name="l00297"></a>00297       <span class="stringliteral">&quot;Res Digital&quot;</span>,
<a name="l00298"></a>00298       <span class="stringliteral">&quot;Unknown Bearer&quot;</span>
<a name="l00299"></a>00299    };
<a name="l00300"></a>00300    
<a name="l00301"></a>00301    <span class="keywordflow">switch</span> (cap) {
<a name="l00302"></a>00302    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#aa491173a6b1628f4ff82067b2e1ceaa9a5db215d31892d1f69b859bc07a416e07">INFO_CAPABILITY_SPEECH</a>:
<a name="l00303"></a>00303       <span class="keywordflow">return</span> bearers[0];
<a name="l00304"></a>00304       <span class="keywordflow">break</span>;
<a name="l00305"></a>00305    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#aa491173a6b1628f4ff82067b2e1ceaa9a29476f176950b8a11fc2d77b04a7d193">INFO_CAPABILITY_AUDIO_3_1K</a>:
<a name="l00306"></a>00306       <span class="keywordflow">return</span> bearers[1];
<a name="l00307"></a>00307       <span class="keywordflow">break</span>;
<a name="l00308"></a>00308    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#aa491173a6b1628f4ff82067b2e1ceaa9a69c4df8f03698f862e10246e1e86880e">INFO_CAPABILITY_DIGITAL_UNRESTRICTED</a>:
<a name="l00309"></a>00309       <span class="keywordflow">return</span> bearers[2];
<a name="l00310"></a>00310       <span class="keywordflow">break</span>;
<a name="l00311"></a>00311    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#aa491173a6b1628f4ff82067b2e1ceaa9adf7a0689e8e3c9cd2d7e6458f555c60c">INFO_CAPABILITY_DIGITAL_RESTRICTED</a>:
<a name="l00312"></a>00312       <span class="keywordflow">return</span> bearers[3];
<a name="l00313"></a>00313       <span class="keywordflow">break</span>;
<a name="l00314"></a>00314    <span class="keywordflow">default</span>:
<a name="l00315"></a>00315       <span class="keywordflow">return</span> bearers[4];
<a name="l00316"></a>00316       <span class="keywordflow">break</span>;
<a name="l00317"></a>00317    }
<a name="l00318"></a>00318 }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320 
<a name="l00321"></a><a class="code" href="isdn__lib_8c.html#adcf8e6abb16ce96527ab64e1c7e2e61f">00321</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="isdn__lib_8c.html#adcf8e6abb16ce96527ab64e1c7e2e61f">flip_table</a>[256];
<a name="l00322"></a>00322 
<a name="l00323"></a><a class="code" href="isdn__lib_8c.html#a2ebb37e9bbb05f618c25d794480d7e8d">00323</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a2ebb37e9bbb05f618c25d794480d7e8d">init_flip_bits</a>(<span class="keywordtype">void</span>)
<a name="l00324"></a>00324 {
<a name="l00325"></a>00325    <span class="keywordtype">int</span> i,k;
<a name="l00326"></a>00326    
<a name="l00327"></a>00327    <span class="keywordflow">for</span> (i = 0 ; i &lt; 256 ; i++) {
<a name="l00328"></a>00328       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> sample = 0 ;
<a name="l00329"></a>00329       <span class="keywordflow">for</span> (k = 0; k&lt;8; k++) {
<a name="l00330"></a>00330          <span class="keywordflow">if</span> ( i &amp; 1 &lt;&lt; k ) sample |= 0x80 &gt;&gt;  k;
<a name="l00331"></a>00331       }
<a name="l00332"></a>00332       flip_table[i] = sample;
<a name="l00333"></a>00333    }
<a name="l00334"></a>00334 }
<a name="l00335"></a>00335 
<a name="l00336"></a><a class="code" href="isdn__lib_8c.html#aec5e8bc764f0ae521c2e841d8609545d">00336</a> <span class="keyword">static</span> <span class="keywordtype">char</span> * <a class="code" href="isdn__lib_8c.html#aec5e8bc764f0ae521c2e841d8609545d">flip_buf_bits</a> ( <span class="keywordtype">char</span> * <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a> , <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l00337"></a>00337 {
<a name="l00338"></a>00338    <span class="keywordtype">int</span> i;
<a name="l00339"></a>00339    <span class="keywordtype">char</span> * start = buf;
<a name="l00340"></a>00340    
<a name="l00341"></a>00341    <span class="keywordflow">for</span> (i = 0 ; i &lt; len; i++) {
<a name="l00342"></a>00342       buf[i] = flip_table[(<span class="keywordtype">unsigned</span> char)buf[i]];
<a name="l00343"></a>00343    }
<a name="l00344"></a>00344    
<a name="l00345"></a>00345    <span class="keywordflow">return</span> start;
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 
<a name="l00350"></a>00350 
<a name="l00351"></a><a class="code" href="isdn__lib_8c.html#ad3ca3d5daee2e83b14b9dc7c5d24e302">00351</a> <span class="keyword">static</span> msg_t *<a class="code" href="isdn__lib_8c.html#ad3ca3d5daee2e83b14b9dc7c5d24e302">create_l2msg</a>(<span class="keywordtype">int</span> prim, <span class="keywordtype">int</span> dinfo, <span class="keywordtype">int</span> size) <span class="comment">/* NT only */</span>
<a name="l00352"></a>00352 {
<a name="l00353"></a>00353    <span class="keywordtype">int</span> i = 0;
<a name="l00354"></a>00354    msg_t *dmsg;
<a name="l00355"></a>00355   
<a name="l00356"></a>00356    <span class="keywordflow">while</span>(i &lt; 10)
<a name="l00357"></a>00357    {
<a name="l00358"></a>00358       dmsg = prep_l3data_msg(prim, dinfo, size, 256, NULL);
<a name="l00359"></a>00359       <span class="keywordflow">if</span> (dmsg)
<a name="l00360"></a>00360          <span class="keywordflow">return</span>(dmsg);
<a name="l00361"></a>00361       
<a name="l00362"></a>00362       <span class="keywordflow">if</span> (!i)
<a name="l00363"></a>00363          printf(<span class="stringliteral">&quot;cannot allocate memory, trying again...\n&quot;</span>);
<a name="l00364"></a>00364       i++;
<a name="l00365"></a>00365       usleep(300000);
<a name="l00366"></a>00366    }
<a name="l00367"></a>00367    printf(<span class="stringliteral">&quot;cannot allocate memory, system overloaded.\n&quot;</span>);
<a name="l00368"></a>00368    exit(-1);
<a name="l00369"></a>00369 }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371 
<a name="l00372"></a>00372 
<a name="l00373"></a><a class="code" href="isdn__lib__intern_8h.html#ade13137a3e8880c4bec999e6f5a65b9b">00373</a> msg_t *<a class="code" href="isdn__lib_8c.html#aee9bd3e9fc9e445d2aafcdecf91af352">create_l3msg</a>(<span class="keywordtype">int</span> prim, <span class="keywordtype">int</span> mt, <span class="keywordtype">int</span> dinfo, <span class="keywordtype">int</span> size, <span class="keywordtype">int</span> ntmode)
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375    <span class="keywordtype">int</span> i = 0;
<a name="l00376"></a>00376    msg_t *dmsg;
<a name="l00377"></a>00377    Q931_info_t *qi;
<a name="l00378"></a>00378    iframe_t *frm;
<a name="l00379"></a>00379   
<a name="l00380"></a>00380    <span class="keywordflow">if</span> (!ntmode)
<a name="l00381"></a>00381       size = <span class="keyword">sizeof</span>(Q931_info_t)+2;
<a name="l00382"></a>00382   
<a name="l00383"></a>00383    <span class="keywordflow">while</span>(i &lt; 10) {
<a name="l00384"></a>00384       <span class="keywordflow">if</span> (ntmode) {
<a name="l00385"></a>00385          dmsg = prep_l3data_msg(prim, dinfo, size, 256, NULL);
<a name="l00386"></a>00386          <span class="keywordflow">if</span> (dmsg) {
<a name="l00387"></a>00387             <span class="keywordflow">return</span>(dmsg);
<a name="l00388"></a>00388          }
<a name="l00389"></a>00389       } <span class="keywordflow">else</span> {
<a name="l00390"></a>00390          dmsg = alloc_msg(size+256+mISDN_HEADER_LEN+DEFAULT_HEADROOM);
<a name="l00391"></a>00391          <span class="keywordflow">if</span> (dmsg)
<a name="l00392"></a>00392          {
<a name="l00393"></a>00393             memset(msg_put(dmsg,size+mISDN_HEADER_LEN), 0, size+mISDN_HEADER_LEN);
<a name="l00394"></a>00394             frm = (iframe_t *)dmsg-&gt;data;
<a name="l00395"></a>00395             frm-&gt;prim = prim;
<a name="l00396"></a>00396             frm-&gt;dinfo = dinfo;
<a name="l00397"></a>00397             qi = (Q931_info_t *)(dmsg-&gt;data + mISDN_HEADER_LEN);
<a name="l00398"></a>00398             qi-&gt;type = mt;
<a name="l00399"></a>00399             <span class="keywordflow">return</span>(dmsg);
<a name="l00400"></a>00400          }
<a name="l00401"></a>00401       }
<a name="l00402"></a>00402     
<a name="l00403"></a>00403       <span class="keywordflow">if</span> (!i) printf(<span class="stringliteral">&quot;cannot allocate memory, trying again...\n&quot;</span>);
<a name="l00404"></a>00404       i++;
<a name="l00405"></a>00405       usleep(300000);
<a name="l00406"></a>00406    }
<a name="l00407"></a>00407    printf(<span class="stringliteral">&quot;cannot allocate memory, system overloaded.\n&quot;</span>);
<a name="l00408"></a>00408    exit(-1);
<a name="l00409"></a>00409 }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411 
<a name="l00412"></a><a class="code" href="isdn__lib_8c.html#a0e54055dbbf30b5553d4b3e71acb4162">00412</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a0e54055dbbf30b5553d4b3e71acb4162">send_msg</a> (<span class="keywordtype">int</span> midev, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, msg_t *dmsg)
<a name="l00413"></a>00413 {
<a name="l00414"></a>00414    iframe_t *frm = (iframe_t *)dmsg-&gt;data;
<a name="l00415"></a>00415    <span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417    <span class="keywordflow">if</span> (!stack) {
<a name="l00418"></a>00418       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;send_msg: IEK!! no stack\n &quot;</span>);
<a name="l00419"></a>00419       <span class="keywordflow">return</span> -1;
<a name="l00420"></a>00420    }
<a name="l00421"></a>00421    
<a name="l00422"></a>00422    frm-&gt;addr = (stack-&gt;upper_id | FLG_MSG_DOWN);
<a name="l00423"></a>00423    frm-&gt;dinfo = bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>;
<a name="l00424"></a>00424    frm-&gt;len = (dmsg-&gt;len) - mISDN_HEADER_LEN;
<a name="l00425"></a>00425             
<a name="l00426"></a>00426    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,stack-&gt;port,<span class="stringliteral">&quot;Sending msg, prim:%x addr:%x dinfo:%x\n&quot;</span>,frm-&gt;prim,frm-&gt;addr,frm-&gt;dinfo);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428    mISDN_write(midev, dmsg-&gt;data, dmsg-&gt;len, TIMEOUT_1SEC);
<a name="l00429"></a>00429    free_msg(dmsg);
<a name="l00430"></a>00430 
<a name="l00431"></a>00431    <span class="keywordflow">return</span> 0;
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 
<a name="l00435"></a><a class="code" href="isdn__lib_8c.html#a5ec9634520c3df4561d5e9a5dfbdf20a">00435</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a5ec9634520c3df4561d5e9a5dfbdf20a">mypid</a>=1;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437 
<a name="l00438"></a><a class="code" href="isdn__lib_8h.html#acaefa07620d12d0dc4f979c9e3c3f73e">00438</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#acaefa07620d12d0dc4f979c9e3c3f73e">misdn_cap_is_speech</a>(<span class="keywordtype">int</span> cap)<span class="comment"></span>
<a name="l00439"></a>00439 <span class="comment">/** Poor mans version **/</span>
<a name="l00440"></a>00440 {
<a name="l00441"></a>00441    <span class="keywordflow">if</span> ( (cap != <a class="code" href="isdn__lib_8h.html#aa491173a6b1628f4ff82067b2e1ceaa9a69c4df8f03698f862e10246e1e86880e">INFO_CAPABILITY_DIGITAL_UNRESTRICTED</a>) &amp;&amp;
<a name="l00442"></a>00442         (cap != <a class="code" href="isdn__lib_8h.html#aa491173a6b1628f4ff82067b2e1ceaa9adf7a0689e8e3c9cd2d7e6458f555c60c">INFO_CAPABILITY_DIGITAL_RESTRICTED</a>) ) <span class="keywordflow">return</span> 1;
<a name="l00443"></a>00443    <span class="keywordflow">return</span> 0;
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 
<a name="l00446"></a><a class="code" href="isdn__lib_8h.html#ad8554f641ff86b533f70526f80810de9">00446</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#ad8554f641ff86b533f70526f80810de9">misdn_inband_avail</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l00447"></a>00447 {
<a name="l00448"></a>00448 
<a name="l00449"></a>00449    <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#a0069ce490efd72751c789525317e2cf4" title="TRUE if the call progress indicators can indicate an inband audio message for the...">early_bconnect</a>) {
<a name="l00450"></a>00450       <span class="comment">/* We have opted to never receive any available inband recorded messages */</span>
<a name="l00451"></a>00451       <span class="keywordflow">return</span> 0;
<a name="l00452"></a>00452    }
<a name="l00453"></a>00453    
<a name="l00454"></a>00454    <span class="keywordflow">switch</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#a7f77bca4fa18c428d39f939be30e7112" title="Progress Indicator IE progress description field. Used to determine if there is an...">progress_indicator</a>) {
<a name="l00455"></a>00455    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a3babbf89cae9b856a12864a41506efbda17162f66340f9291db0c9506c49f8c16">INFO_PI_INBAND_AVAILABLE</a>:
<a name="l00456"></a>00456    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a3babbf89cae9b856a12864a41506efbda28e0d2e1b9ac25ef73073b62bdb6c25a">INFO_PI_CALL_NOT_E2E_ISDN</a>:
<a name="l00457"></a>00457    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a3babbf89cae9b856a12864a41506efbda827d73f1329aa94c28cfe5683921ead5">INFO_PI_CALLED_NOT_ISDN</a>:
<a name="l00458"></a>00458       <span class="keywordflow">return</span> 1;
<a name="l00459"></a>00459    <span class="keywordflow">default</span>:
<a name="l00460"></a>00460       <span class="keywordflow">return</span> 0;
<a name="l00461"></a>00461    }
<a name="l00462"></a>00462    <span class="keywordflow">return</span> 0;
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465 
<a name="l00466"></a><a class="code" href="isdn__lib_8c.html#a82ebf7eee4e824dd341a39135a9dbf0b">00466</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a82ebf7eee4e824dd341a39135a9dbf0b">dump_chan_list</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00467"></a>00467 {
<a name="l00468"></a>00468    <span class="keywordtype">int</span> i;
<a name="l00469"></a>00469 
<a name="l00470"></a>00470    <span class="keywordflow">for</span> (i=0; i &lt;= stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; i++) {
<a name="l00471"></a>00471       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(6, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Idx:%d stack-&gt;cchan:%d in_use:%d Chan:%d\n&quot;</span>,i,stack-&gt;<a class="code" href="structmisdn__stack.html#a0ccea073ca7f2de1fc50d383ef5dd967" title="Array of B channels in use (a[0] = B1). TRUE if B channel in use.">channels</a>[i], stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a>, i+1);
<a name="l00472"></a>00472    }
<a name="l00473"></a>00473 }
<a name="l00474"></a>00474 
<a name="l00475"></a>00475 
<a name="l00476"></a><a class="code" href="isdn__lib_8h.html#a31360d1850c8039cf700033c1c44edba">00476</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a31360d1850c8039cf700033c1c44edba">misdn_dump_chanlist</a>(<span class="keywordtype">void</span>)
<a name="l00477"></a>00477 {
<a name="l00478"></a>00478    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>();
<a name="l00479"></a>00479    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l00480"></a>00480       <a class="code" href="isdn__lib_8c.html#a82ebf7eee4e824dd341a39135a9dbf0b">dump_chan_list</a>(stack);
<a name="l00481"></a>00481    }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00485"></a><a class="code" href="isdn__lib_8c.html#a886ede1c40e3c08db8e89bf175477d9c">00485</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a886ede1c40e3c08db8e89bf175477d9c">set_chan_in_stack</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">int</span> channel)
<a name="l00486"></a>00486 {
<a name="l00487"></a>00487 
<a name="l00488"></a>00488    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;set_chan_in_stack: %d\n&quot;</span>,channel);
<a name="l00489"></a>00489    <a class="code" href="isdn__lib_8c.html#a82ebf7eee4e824dd341a39135a9dbf0b">dump_chan_list</a>(stack);
<a name="l00490"></a>00490    <span class="keywordflow">if</span> (channel &gt;=1 &amp;&amp; channel &lt;= <a class="code" href="isdn__lib_8h.html#a90726efd784d5cc679ad2e1160b5dc2f">MAX_BCHANS</a>) {
<a name="l00491"></a>00491       <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#a0ccea073ca7f2de1fc50d383ef5dd967" title="Array of B channels in use (a[0] = B1). TRUE if B channel in use.">channels</a>[channel-1])
<a name="l00492"></a>00492          stack-&gt;<a class="code" href="structmisdn__stack.html#a0ccea073ca7f2de1fc50d383ef5dd967" title="Array of B channels in use (a[0] = B1). TRUE if B channel in use.">channels</a>[channel-1] = 1;
<a name="l00493"></a>00493       <span class="keywordflow">else</span> {
<a name="l00494"></a>00494          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;channel already in use:%d\n&quot;</span>, channel );
<a name="l00495"></a>00495          <span class="keywordflow">return</span> -1;
<a name="l00496"></a>00496       }
<a name="l00497"></a>00497    } <span class="keywordflow">else</span> {
<a name="l00498"></a>00498       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;couldn&apos;t set channel %d in\n&quot;</span>, channel );
<a name="l00499"></a>00499       <span class="keywordflow">return</span> -1;
<a name="l00500"></a>00500    }
<a name="l00501"></a>00501   
<a name="l00502"></a>00502    <span class="keywordflow">return</span> 0;
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 
<a name="l00506"></a>00506 
<a name="l00507"></a><a class="code" href="isdn__lib_8c.html#a67727c8665c79737a5e7ffd7a524934a">00507</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a67727c8665c79737a5e7ffd7a524934a">find_free_chan_in_stack</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> channel, <span class="keywordtype">int</span> dec)
<a name="l00508"></a>00508 {
<a name="l00509"></a>00509    <span class="keywordtype">int</span> i;
<a name="l00510"></a>00510    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>=0;
<a name="l00511"></a>00511    <span class="keywordtype">int</span> bnums = stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a> ? stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a> : stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a> - 1;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513    <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#a53653df89bd2c5e3e88716779e899aa9" title="TRUE if the channel was allocated from the available B channels.">channel_found</a>)  
<a name="l00514"></a>00514       <span class="keywordflow">return</span> 0;
<a name="l00515"></a>00515    
<a name="l00516"></a>00516    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a53653df89bd2c5e3e88716779e899aa9" title="TRUE if the channel was allocated from the available B channels.">channel_found</a>=1;
<a name="l00517"></a>00517 
<a name="l00518"></a>00518    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;find_free_chan: req_chan:%d\n&quot;</span>,channel);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520    <span class="keywordflow">if</span> (channel &lt; 0 || channel &gt; <a class="code" href="isdn__lib_8h.html#a90726efd784d5cc679ad2e1160b5dc2f">MAX_BCHANS</a>) {
<a name="l00521"></a>00521       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; !! out of bound call to find_free_chan_in_stack! (ch:%d)\n&quot;</span>, channel);
<a name="l00522"></a>00522       <span class="keywordflow">return</span> 0;
<a name="l00523"></a>00523    }
<a name="l00524"></a>00524    
<a name="l00525"></a>00525    channel--;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527    <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>);
<a name="l00528"></a>00528    <span class="keywordflow">if</span> (dec) {
<a name="l00529"></a>00529       <span class="keywordflow">for</span> (i = bnums; i &gt;=0; i--) {
<a name="l00530"></a>00530          <span class="keywordflow">if</span> (i != 15 &amp;&amp; (channel &lt; 0 || i == channel)) { <span class="comment">/* skip E1 D channel ;) and work with chan preselection */</span>
<a name="l00531"></a>00531             <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#a0ccea073ca7f2de1fc50d383ef5dd967" title="Array of B channels in use (a[0] = B1). TRUE if B channel in use.">channels</a>[i]) {
<a name="l00532"></a>00532                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; found chan%s: %d\n&quot;</span>, channel&gt;=0?<span class="stringliteral">&quot; (preselected)&quot;</span>:<span class="stringliteral">&quot;&quot;</span>, i+1);
<a name="l00533"></a>00533                chan=i+1;
<a name="l00534"></a>00534                <span class="keywordflow">break</span>;
<a name="l00535"></a>00535             }
<a name="l00536"></a>00536          }
<a name="l00537"></a>00537       }
<a name="l00538"></a>00538    } <span class="keywordflow">else</span> {
<a name="l00539"></a>00539       <span class="keywordflow">for</span> (i = 0; i &lt;= bnums; i++) {
<a name="l00540"></a>00540          <span class="keywordflow">if</span> (i != 15 &amp;&amp; (channel &lt; 0 || i == channel)) { <span class="comment">/* skip E1 D channel ;) and work with chan preselection */</span>
<a name="l00541"></a>00541             <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#a0ccea073ca7f2de1fc50d383ef5dd967" title="Array of B channels in use (a[0] = B1). TRUE if B channel in use.">channels</a>[i]) {
<a name="l00542"></a>00542                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; found chan%s: %d\n&quot;</span>, channel&gt;=0?<span class="stringliteral">&quot; (preselected)&quot;</span>:<span class="stringliteral">&quot;&quot;</span>, i+1);
<a name="l00543"></a>00543                chan=i+1;
<a name="l00544"></a>00544                <span class="keywordflow">break</span>;
<a name="l00545"></a>00545             }
<a name="l00546"></a>00546          }
<a name="l00547"></a>00547       }
<a name="l00548"></a>00548    }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550    <span class="keywordflow">if</span> (!chan) {
<a name="l00551"></a>00551       <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>);
<a name="l00552"></a>00552       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (1, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; !! NO FREE CHAN IN STACK\n&quot;</span>);
<a name="l00553"></a>00553       <a class="code" href="isdn__lib_8c.html#a82ebf7eee4e824dd341a39135a9dbf0b">dump_chan_list</a>(stack);
<a name="l00554"></a>00554       bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1b724daeb32d8d023765605586269a02" title="Q.931 Cause for disconnection code (sent).">out_cause</a> = <a class="code" href="causes_8h.html#a84f3380611feeec35bb25319b26f92fd">AST_CAUSE_NORMAL_CIRCUIT_CONGESTION</a>;
<a name="l00555"></a>00555       <span class="keywordflow">return</span> -1;
<a name="l00556"></a>00556    }  
<a name="l00557"></a>00557 
<a name="l00558"></a>00558    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a886ede1c40e3c08db8e89bf175477d9c">set_chan_in_stack</a>(stack, chan)&lt;0) {
<a name="l00559"></a>00559       <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>);
<a name="l00560"></a>00560       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Channel Already in use:%d\n&quot;</span>, chan);
<a name="l00561"></a>00561       bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1b724daeb32d8d023765605586269a02" title="Q.931 Cause for disconnection code (sent).">out_cause</a> = <a class="code" href="causes_8h.html#a7f49d27e9e3876fb4ccf1d139d31db73">AST_CAUSE_REQUESTED_CHAN_UNAVAIL</a>;
<a name="l00562"></a>00562       <span class="keywordflow">return</span> -1;
<a name="l00563"></a>00563    }
<a name="l00564"></a>00564    <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566    bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>=chan;
<a name="l00567"></a>00567    <span class="keywordflow">return</span> 0;
<a name="l00568"></a>00568 }
<a name="l00569"></a>00569 <span class="comment"></span>
<a name="l00570"></a>00570 <span class="comment">/*!</span>
<a name="l00571"></a>00571 <span class="comment"> * \internal</span>
<a name="l00572"></a>00572 <span class="comment"> * \brief Release a B channel to the allocation pool.</span>
<a name="l00573"></a>00573 <span class="comment"> *</span>
<a name="l00574"></a>00574 <span class="comment"> * \param stack Which port stack B channel belongs.</span>
<a name="l00575"></a>00575 <span class="comment"> * \param channel B channel to release. (Range 1-MAX_BCHANS representing B1-Bn)</span>
<a name="l00576"></a>00576 <span class="comment"> *</span>
<a name="l00577"></a>00577 <span class="comment"> * \retval 0 on success.</span>
<a name="l00578"></a>00578 <span class="comment"> * \retval -1 on error.  i.e., The channel is out of range.</span>
<a name="l00579"></a>00579 <span class="comment"> *</span>
<a name="l00580"></a>00580 <span class="comment"> * \note</span>
<a name="l00581"></a>00581 <span class="comment"> * Must be called after clean_up_bc() to make sure that the media stream is</span>
<a name="l00582"></a>00582 <span class="comment"> * no longer connected.</span>
<a name="l00583"></a>00583 <span class="comment"> */</span>
<a name="l00584"></a><a class="code" href="isdn__lib_8c.html#a9f849e8a799ef7d6a52f6a10ec4446e5">00584</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a9f849e8a799ef7d6a52f6a10ec4446e5">empty_chan_in_stack</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">int</span> channel)
<a name="l00585"></a>00585 {
<a name="l00586"></a>00586    <span class="keywordflow">if</span> (channel&lt;=0 || channel&gt;<a class="code" href="isdn__lib_8h.html#a90726efd784d5cc679ad2e1160b5dc2f">MAX_BCHANS</a>) {
<a name="l00587"></a>00587       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,stack?stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>:0, <span class="stringliteral">&quot;empty_chan_in_stack: cannot empty channel %d\n&quot;</span>,channel);
<a name="l00588"></a>00588       <span class="keywordflow">return</span> -1;
<a name="l00589"></a>00589    }
<a name="l00590"></a>00590    
<a name="l00591"></a>00591    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (4, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>:0, <span class="stringliteral">&quot;empty_chan_in_stack: %d\n&quot;</span>,channel); 
<a name="l00592"></a>00592    stack-&gt;<a class="code" href="structmisdn__stack.html#a0ccea073ca7f2de1fc50d383ef5dd967" title="Array of B channels in use (a[0] = B1). TRUE if B channel in use.">channels</a>[channel-1] = 0;
<a name="l00593"></a>00593    <a class="code" href="isdn__lib_8c.html#a82ebf7eee4e824dd341a39135a9dbf0b">dump_chan_list</a>(stack);
<a name="l00594"></a>00594    <span class="keywordflow">return</span> 0;
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00597"></a><a class="code" href="isdn__lib_8h.html#ae2f4cc55968e9014a4daa06d1be05bef">00597</a> <span class="keywordtype">char</span> *<a class="code" href="isdn__lib_8c.html#ae2f4cc55968e9014a4daa06d1be05bef">bc_state2str</a>(<span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4">bchannel_state</a> <a class="code" href="structstate.html">state</a>) {
<a name="l00598"></a>00598    <span class="keywordtype">int</span> i;
<a name="l00599"></a>00599    
<a name="l00600"></a>00600    <span class="keyword">struct </span>bchan_state_s {
<a name="l00601"></a>00601       <span class="keywordtype">char</span> *n;
<a name="l00602"></a>00602       <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4">bchannel_state</a> <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00603"></a>00603    } states[] = {
<a name="l00604"></a>00604       {<span class="stringliteral">&quot;BCHAN_CLEANED&quot;</span>, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4aeb34fa6afdc8da6670a1e3a14c85c6fa">BCHAN_CLEANED</a> },
<a name="l00605"></a>00605       {<span class="stringliteral">&quot;BCHAN_EMPTY&quot;</span>, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a3875f0013e74dd275279e7ed5cd9b32f">BCHAN_EMPTY</a>},
<a name="l00606"></a>00606       {<span class="stringliteral">&quot;BCHAN_SETUP&quot;</span>, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a99d4cd17c748c9e4eacb056d759d63c5">BCHAN_SETUP</a>},
<a name="l00607"></a>00607       {<span class="stringliteral">&quot;BCHAN_SETUPED&quot;</span>, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4aae16b0b226652124bc668657d98d52f7">BCHAN_SETUPED</a>},
<a name="l00608"></a>00608       {<span class="stringliteral">&quot;BCHAN_ACTIVE&quot;</span>, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4afda21957b1956bb84d0a06ddc809b3bf">BCHAN_ACTIVE</a>},
<a name="l00609"></a>00609       {<span class="stringliteral">&quot;BCHAN_ACTIVATED&quot;</span>, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a1b7d7fde2aa8ceca170c3d0f8283fbc0">BCHAN_ACTIVATED</a>},
<a name="l00610"></a>00610       {<span class="stringliteral">&quot;BCHAN_BRIDGE&quot;</span>,  <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a1eaecb9d8ce0856629a9304b49588563">BCHAN_BRIDGE</a>},
<a name="l00611"></a>00611       {<span class="stringliteral">&quot;BCHAN_BRIDGED&quot;</span>, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a660c00210e9cd580ec7f1b0250c3ce6e">BCHAN_BRIDGED</a>},
<a name="l00612"></a>00612       {<span class="stringliteral">&quot;BCHAN_RELEASE&quot;</span>, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a94339a5e4ef7f395f9780bebf5de2fe3">BCHAN_RELEASE</a>},
<a name="l00613"></a>00613       {<span class="stringliteral">&quot;BCHAN_RELEASED&quot;</span>, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a1d499634b54140a756654aaa0d935b61">BCHAN_RELEASED</a>},
<a name="l00614"></a>00614       {<span class="stringliteral">&quot;BCHAN_CLEAN&quot;</span>, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a14ba763213f9cb48851cd061dbdc3a05">BCHAN_CLEAN</a>},
<a name="l00615"></a>00615       {<span class="stringliteral">&quot;BCHAN_CLEAN_REQUEST&quot;</span>, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4acac347e3046a60763322bcb9f26f1d9c">BCHAN_CLEAN_REQUEST</a>},
<a name="l00616"></a>00616       {<span class="stringliteral">&quot;BCHAN_ERROR&quot;</span>, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4afcaed23d8920931db5c4890b5f3bfad8">BCHAN_ERROR</a>}
<a name="l00617"></a>00617    };
<a name="l00618"></a>00618    
<a name="l00619"></a>00619    <span class="keywordflow">for</span> (i=0; i&lt; <span class="keyword">sizeof</span>(states)/<span class="keyword">sizeof</span>(<span class="keyword">struct</span> bchan_state_s); i++)
<a name="l00620"></a>00620       <span class="keywordflow">if</span> ( states[i].<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> == state)
<a name="l00621"></a>00621          <span class="keywordflow">return</span> states[i].n;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623    <span class="keywordflow">return</span> <span class="stringliteral">&quot;UNKNOWN&quot;</span>;
<a name="l00624"></a>00624 }
<a name="l00625"></a>00625 
<a name="l00626"></a><a class="code" href="isdn__lib_8h.html#a621dffd1191d37e3aaa056e9be75a495">00626</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4">bchannel_state</a> <a class="code" href="structstate.html">state</a>)
<a name="l00627"></a>00627 {
<a name="l00628"></a>00628    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;BC_STATE_CHANGE: l3id:%x from:%s to:%s\n&quot;</span>,
<a name="l00629"></a>00629       bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>,
<a name="l00630"></a>00630           <a class="code" href="isdn__lib_8c.html#ae2f4cc55968e9014a4daa06d1be05bef">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a>),
<a name="l00631"></a>00631           <a class="code" href="isdn__lib_8c.html#ae2f4cc55968e9014a4daa06d1be05bef">bc_state2str</a>(state) );
<a name="l00632"></a>00632    
<a name="l00633"></a>00633    <span class="keywordflow">switch</span> (state) {
<a name="l00634"></a>00634       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a1b7d7fde2aa8ceca170c3d0f8283fbc0">BCHAN_ACTIVATED</a>:
<a name="l00635"></a>00635          <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#ab126d2aadb7d7562d2f225e61231d2d6" title="This is used as a pending bridge join request for when bc_state becomes BCHAN_ACTIVATED...">next_bc_state</a> ==  <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a660c00210e9cd580ec7f1b0250c3ce6e">BCHAN_BRIDGED</a>) {
<a name="l00636"></a>00636             <a class="code" href="isdn__lib_8c.html#abab4f8b1249e8086247badba522584c7">misdn_join_conf</a>(bc, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aab0f7344f706b822f3aeab3e328793d0" title="Bridging conference ID.">conf_id</a>);
<a name="l00637"></a>00637             bc-&gt;<a class="code" href="structmisdn__bchannel.html#ab126d2aadb7d7562d2f225e61231d2d6" title="This is used as a pending bridge join request for when bc_state becomes BCHAN_ACTIVATED...">next_bc_state</a> = <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a3875f0013e74dd275279e7ed5cd9b32f">BCHAN_EMPTY</a>;
<a name="l00638"></a>00638             <span class="keywordflow">return</span>;
<a name="l00639"></a>00639          }
<a name="l00640"></a>00640       <span class="keywordflow">default</span>:
<a name="l00641"></a>00641          bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a>=state;
<a name="l00642"></a>00642          <span class="keywordflow">break</span>;
<a name="l00643"></a>00643    }
<a name="l00644"></a>00644 }
<a name="l00645"></a>00645 
<a name="l00646"></a><a class="code" href="isdn__lib_8c.html#ad87e2fd48d69fe48859d33f22d6d57d4">00646</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#ad87e2fd48d69fe48859d33f22d6d57d4">bc_next_state_change</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4">bchannel_state</a> <a class="code" href="structstate.html">state</a>)
<a name="l00647"></a>00647 {
<a name="l00648"></a>00648    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;BC_NEXT_STATE_CHANGE: from:%s to:%s\n&quot;</span>,
<a name="l00649"></a>00649           <a class="code" href="isdn__lib_8c.html#ae2f4cc55968e9014a4daa06d1be05bef">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#ab126d2aadb7d7562d2f225e61231d2d6" title="This is used as a pending bridge join request for when bc_state becomes BCHAN_ACTIVATED...">next_bc_state</a>),
<a name="l00650"></a>00650           <a class="code" href="isdn__lib_8c.html#ae2f4cc55968e9014a4daa06d1be05bef">bc_state2str</a>(state) );
<a name="l00651"></a>00651 
<a name="l00652"></a>00652    bc-&gt;<a class="code" href="structmisdn__bchannel.html#ab126d2aadb7d7562d2f225e61231d2d6" title="This is used as a pending bridge join request for when bc_state becomes BCHAN_ACTIVATED...">next_bc_state</a>=state;
<a name="l00653"></a>00653 }
<a name="l00654"></a>00654 <span class="comment"></span>
<a name="l00655"></a>00655 <span class="comment">/*!</span>
<a name="l00656"></a>00656 <span class="comment"> * \internal</span>
<a name="l00657"></a>00657 <span class="comment"> * \brief Empty the B channel record of most call data.</span>
<a name="l00658"></a>00658 <span class="comment"> *</span>
<a name="l00659"></a>00659 <span class="comment"> * \param bc B channel record to empty of most call data.</span>
<a name="l00660"></a>00660 <span class="comment"> *</span>
<a name="l00661"></a>00661 <span class="comment"> * \return Nothing</span>
<a name="l00662"></a>00662 <span class="comment"> *</span>
<a name="l00663"></a>00663 <span class="comment"> * \note</span>
<a name="l00664"></a>00664 <span class="comment"> * Sets the last_used time and must be called before clearing bc-&gt;in_use.</span>
<a name="l00665"></a>00665 <span class="comment"> */</span>
<a name="l00666"></a><a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">00666</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">empty_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l00667"></a>00667 {
<a name="l00668"></a>00668    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a7c1d654b7b6114d7a0abc8d351dd1bcd" title="TRUE if this is a dummy BC record.">dummy</a>=0;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670    bc-&gt;<a class="code" href="structmisdn__bchannel.html#abd2b13dba522040010e392081c185e60" title="B channel speech sample data buffer size.">bframe_len</a>=0;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a0e234074dd9e6208d65dcd4230827898" title="TRUE if call waiting.">cw</a>= 0;
<a name="l00673"></a>00673 
<a name="l00674"></a>00674    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a04e41b69f1017a234f0cfe958c99be93" title="TRUE if allocate higher B channels first.">dec</a>=0;
<a name="l00675"></a>00675    bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> = 0;
<a name="l00676"></a>00676 
<a name="l00677"></a>00677    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63e06215600e01fdfb2234581d3457b5" title="TRUE if all digits necessary to complete the call are available. No more INFORMATION...">sending_complete</a> = 0;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679    bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa003639bc50e231ad599d9ce4a476cd7" title="B channel to restart if received a RESTART message.">restart_channel</a>=0;
<a name="l00680"></a>00680    
<a name="l00681"></a>00681    bc-&gt;<a class="code" href="structmisdn__bchannel.html#aab0f7344f706b822f3aeab3e328793d0" title="Bridging conference ID.">conf_id</a> = 0;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683    bc-&gt;<a class="code" href="structmisdn__bchannel.html#ab7ab21c4af667d26899c1f22a4e6e920" title="TRUE if we send SETUP_ACKNOWLEDGE on incoming calls anyway (instead of PROCEEDING)...">need_more_infos</a> = 0;
<a name="l00684"></a>00684    
<a name="l00685"></a>00685    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1f467e7dfa18d05d423b9daff1b4e94c" title="TRUE if we should produce DTMF tones ourselves.">send_dtmf</a>=0;
<a name="l00686"></a>00686    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a134855bcd1a1ba0d1733faa7a4e94389" title="TRUE if we will not use jollys dsp.">nodsp</a>=0;
<a name="l00687"></a>00687    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6bb23a220a9276463546e4b5faa28e36" title="TRUE if we will not use the jitter buffer system.">nojitter</a>=0;
<a name="l00688"></a>00688 
<a name="l00689"></a>00689    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2fe4abc4d482027f264234ebde8ebbb0">time_usec</a>=0;
<a name="l00690"></a>00690    
<a name="l00691"></a>00691    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a80d0395aae5582433d6b02af3f8c270a" title="Rx gain setting (range -8 to 8).">rxgain</a>=0;
<a name="l00692"></a>00692    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a709429a6031e18717677d5254d38586f" title="Tx gain setting (range -8 to 8).">txgain</a>=0;
<a name="l00693"></a>00693 
<a name="l00694"></a>00694    bc-&gt;<a class="code" href="structmisdn__bchannel.html#ad086e3885102d6f73b63d0498180a329">crypt</a>=0;
<a name="l00695"></a>00695    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1708b0e86419435cb6fcc6572cc351e4">curptx</a>=0; bc-&gt;<a class="code" href="structmisdn__bchannel.html#a86fea522277cf7973a29978716c58040">curprx</a>=0;
<a name="l00696"></a>00696    
<a name="l00697"></a>00697    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9aa37e2112fabf2ca6694c70d2f0ff24" title="Blowfish encryption key string (secret).">crypt_key</a>[0] = 0;
<a name="l00698"></a>00698    
<a name="l00699"></a>00699    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a18f91a48afb97a188ef92e61c593862e" title="TRUE if tone generator allowed to start.">generate_tone</a>=0;
<a name="l00700"></a>00700    bc-&gt;<a class="code" href="structmisdn__bchannel.html#af6c8edfad6751df061697799630c7f47" title="Number of tone samples to generate.">tone_cnt</a>=0;
<a name="l00701"></a>00701   
<a name="l00702"></a>00702    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a54e1096eacf895fbbee3b263b8a5af5a" title="Type-of-number in ISDN terms for the dialed/called number.">dnumplan</a>=<a class="code" href="isdn__lib_8h.html#aae0adf4b80e71ed76a2019d8c9fad567a8c4c5d8a169e3036d743d513b0811f4a">NUMPLAN_UNKNOWN</a>;
<a name="l00703"></a>00703    bc-&gt;<a class="code" href="structmisdn__bchannel.html#aeea5d3e5d16496a8b3e35bdcf9faf3f0" title="Type-of-number in ISDN terms for the originating/calling number (Caller-ID).">onumplan</a>=<a class="code" href="isdn__lib_8h.html#aae0adf4b80e71ed76a2019d8c9fad567a8c4c5d8a169e3036d743d513b0811f4a">NUMPLAN_UNKNOWN</a>;
<a name="l00704"></a>00704    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a8d01f0e3cd6bd8f9ebd453a52c3f67ac" title="Type-of-number in ISDN terms for the redirecting number which a call diversion or...">rnumplan</a>=<a class="code" href="isdn__lib_8h.html#aae0adf4b80e71ed76a2019d8c9fad567a8c4c5d8a169e3036d743d513b0811f4a">NUMPLAN_UNKNOWN</a>;
<a name="l00705"></a>00705    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9ee82271317597b727ab006698eb0455" title="Type-of-number in ISDN terms for the connected party number.">cpnnumplan</a>=<a class="code" href="isdn__lib_8h.html#aae0adf4b80e71ed76a2019d8c9fad567a8c4c5d8a169e3036d743d513b0811f4a">NUMPLAN_UNKNOWN</a>;
<a name="l00706"></a>00706    
<a name="l00707"></a>00707 
<a name="l00708"></a>00708    bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa5805c5e936174e5092bf7a5b78e7e64" title="Seems to have been intended for something to do with the jitter buffer.">active</a> = 0;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a0069ce490efd72751c789525317e2cf4" title="TRUE if the call progress indicators can indicate an inband audio message for the...">early_bconnect</a> = 1;
<a name="l00711"></a>00711    
<a name="l00712"></a>00712 <span class="preprocessor">#ifdef MISDN_1_2</span>
<a name="l00713"></a>00713 <span class="preprocessor"></span>   *bc-&gt;pipeline = 0;
<a name="l00714"></a>00714 <span class="preprocessor">#else</span>
<a name="l00715"></a>00715 <span class="preprocessor"></span>   bc-&gt;<a class="code" href="structmisdn__bchannel.html#aeafef525b8bac4713c119b593780ca69" title="TRUE if the echo cancellor is enabled.">ec_enable</a> = 0;
<a name="l00716"></a>00716    bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf0690a26c02528e63f3cb623d1bd4a7" title="Number of taps in the echo cancellor when enabled.">ec_deftaps</a> = 128;
<a name="l00717"></a>00717 <span class="preprocessor">#endif</span>
<a name="l00718"></a>00718 <span class="preprocessor"></span>
<a name="l00719"></a>00719    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a0eb39f0206f0029457671f9501ad192d" title="TRUE if AOCDtype and AOCD data are ready to export to Asterisk.">AOCD_need_export</a> = 0;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9e217f04c0fbbe53b5ad22ba4eb2af25" title="Who originated the call (ORG_AST, ORG_MISDN).">orig</a>=0;
<a name="l00722"></a>00722   
<a name="l00723"></a>00723    bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa4d0ccb9d0904892652f2f258c5ad225" title="Q.931 Cause for disconnection code (received).">cause</a> = <a class="code" href="causes_8h.html#af2235eb1c27925e4020ce286255d165f">AST_CAUSE_NORMAL_CLEARING</a>;
<a name="l00724"></a>00724    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1b724daeb32d8d023765605586269a02" title="Q.931 Cause for disconnection code (sent).">out_cause</a> = <a class="code" href="causes_8h.html#af2235eb1c27925e4020ce286255d165f">AST_CAUSE_NORMAL_CLEARING</a>;
<a name="l00725"></a>00725    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a98244c51d406d209643d55bd6a93535c" title="Caller ID presentation restriction code 0=Allowed, 1=Restricted, 2=Unavailable.">pres</a> = 0;  <span class="comment">/* allowed */</span>
<a name="l00726"></a>00726    
<a name="l00727"></a>00727    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a07ec0ba2af253e4f29ee846bb28348be" title="Event waiting for Layer 1 to come up.">evq</a>=<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a9615f92c3638ed613857ed48d0612a4c">EVENT_NOTHING</a>;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729    bc-&gt;<a class="code" href="structmisdn__bchannel.html#ae1e4adbccbeb6f4b6e0a6b0392bc60d2" title="Progress Indicator IE coding standard field.">progress_coding</a>=0;
<a name="l00730"></a>00730    bc-&gt;<a class="code" href="structmisdn__bchannel.html#acfe78bf7903d08b35e446ecfb0c58ae6" title="Progress Indicator IE location field.">progress_location</a>=0;
<a name="l00731"></a>00731    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a7f77bca4fa18c428d39f939be30e7112" title="Progress Indicator IE progress description field. Used to determine if there is an...">progress_indicator</a>=0;
<a name="l00732"></a>00732    <span class="comment"></span>
<a name="l00733"></a>00733 <span class="comment">/** Set Default Bearer Caps **/</span>
<a name="l00734"></a>00734    bc-&gt;<a class="code" href="structmisdn__bchannel.html#afa05b14ff7f76f303c784c00c4c63fa7" title="SETUP message bearer capability field code value.">capability</a>=<a class="code" href="isdn__lib_8h.html#aa491173a6b1628f4ff82067b2e1ceaa9a5db215d31892d1f69b859bc07a416e07">INFO_CAPABILITY_SPEECH</a>;
<a name="l00735"></a>00735    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a17dd7b17c0e736754e01e575ca8d8cb8" title="Companding ALaw/uLaw encoding (INFO_CODEC_ALAW / INFO_CODEC_ULAW).">law</a>=<a class="code" href="isdn__lib_8h.html#aa57e16cd48de3b9a989056ff8df26f84a25426c03ab5d4728a4e7110a02879ccc">INFO_CODEC_ALAW</a>;
<a name="l00736"></a>00736    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1ea5d0cb93f22f7d0fdf804bd68c3326" title="Q.931 Bearer Capability IE Transfer Mode field. Initialized to 0 (Circuit). Altered...">mode</a>=0;
<a name="l00737"></a>00737    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a7a829e6fd74e94e0edf10550470d844c" title="Q.931 Bearer Capability IE Information Transfer Rate field. Initialized to 0x10 (64kbit)...">rate</a>=0x10;
<a name="l00738"></a>00738    bc-&gt;<a class="code" href="structmisdn__bchannel.html#ad1194c824f21bca3c5a6d4d5ceffcaec" title="Q.931 Bearer Capability IE User Information Layer 1 Protocol field code.">user1</a>=0;
<a name="l00739"></a>00739    bc-&gt;<a class="code" href="structmisdn__bchannel.html#af6c0d819ed84001ebc48f28c7765211a" title="Q.931 Bearer Capability IE Layer 1 User Rate field.">urate</a>=0;
<a name="l00740"></a>00740    
<a name="l00741"></a>00741    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a23c37f6ee7f30735975cc3848117a830" title="TRUE if call made in digital HDLC mode.">hdlc</a>=0;
<a name="l00742"></a>00742    
<a name="l00743"></a>00743    
<a name="l00744"></a>00744    bc-&gt;<a class="code" href="structmisdn__bchannel.html#ab8c928e7140e6b59abbe7dddadffd5ea" title="Current overlap dialing digits to/from INFORMATION messages.">info_dad</a>[0] = 0;
<a name="l00745"></a>00745    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a89b6e11f1f5add3aec515c40e0cbc44c" title="Display message that can be displayed by the user phone.">display</a>[0] = 0;
<a name="l00746"></a>00746    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a66ff99f3da20b87f6098269504f4517d" title="Collected digits to go into info_dad[] while waiting for a SETUP_ACKNOWLEDGE to come...">infos_pending</a>[0] = 0;
<a name="l00747"></a>00747    bc-&gt;<a class="code" href="structmisdn__bchannel.html#aedb5fadfcd803b101921d8e0f76ac6c4" title="Connected Party/Line Phone Number (Address).">cad</a>[0] = 0;
<a name="l00748"></a>00748    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a8d2efe6f05b62dd9ce5153b822663083" title="Originating/Calling Phone Number (Address).">oad</a>[0] = 0;
<a name="l00749"></a>00749    bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa306ec0dd386e28152b3f39d2a389402" title="Dialed/Called Phone Number (Address).">dad</a>[0] = 0;
<a name="l00750"></a>00750    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9dbe27031e2baf74c93cc2b719a4d47f" title="Redirecting Phone Number (Address) where a call diversion or transfer was invoked...">rad</a>[0] = 0;
<a name="l00751"></a>00751    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a516b7fc6ac87470e0d9ac555519c90a2" title="Original Dialed/Called Phone Number (Address) before national/international dialing...">orig_dad</a>[0] = 0;
<a name="l00752"></a>00752    bc-&gt;<a class="code" href="structmisdn__bchannel.html#af85206f753950090e4d86a4fde26c5ed" title="User-User information string.">uu</a>[0]=0;
<a name="l00753"></a>00753    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9b9b9448e634b1536a6bb5bc04438fbf" title="User-User information string length in uu[].">uulen</a>=0;
<a name="l00754"></a>00754    
<a name="l00755"></a>00755    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a661fd03f59ca366c30cb5886636be8bd" title="Inbound FACILITY message function type and contents.">fac_in</a>.Function = Fac_None;
<a name="l00756"></a>00756    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a985f4b3f8cb9f5dcd667ba89431a3975" title="Outbound FACILITY message function type and contents.">fac_out</a>.Function = Fac_None;
<a name="l00757"></a>00757    
<a name="l00758"></a>00758    bc-&gt;<a class="code" href="structmisdn__bchannel.html#ae822c229e6877cf2310db8e68f733611" title="TRUE if the TE side should choose the B channel to use.">te_choose_channel</a> = 0;
<a name="l00759"></a>00759    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a53653df89bd2c5e3e88716779e899aa9" title="TRUE if the channel was allocated from the available B channels.">channel_found</a>= 0;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761    gettimeofday(&amp;bc-&gt;<a class="code" href="structmisdn__bchannel.html#a43b2c8a8bf77a2504897ff0da9b0aa90" title="Time when empty_bc() last called on this record.">last_used</a>, NULL);
<a name="l00762"></a>00762 }
<a name="l00763"></a>00763 
<a name="l00764"></a>00764 
<a name="l00765"></a><a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">00765</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">clean_up_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l00766"></a>00766 {
<a name="l00767"></a>00767    <span class="keywordtype">int</span> ret=0;
<a name="l00768"></a>00768    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="chan__unistim_8c.html#af30c10a8c6ed3d4649cfdc61e2029dc3">buff</a>[32];
<a name="l00769"></a>00769    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> * stack;
<a name="l00770"></a>00770 
<a name="l00771"></a>00771    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, bc?bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>:0, <span class="stringliteral">&quot;$$$ CLEANUP CALLED pid:%d\n&quot;</span>, bc?bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>:-1);
<a name="l00772"></a>00772    
<a name="l00773"></a>00773    <span class="keywordflow">if</span> (!bc  ) <span class="keywordflow">return</span> -1;
<a name="l00774"></a>00774    stack=<a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l00775"></a>00775    
<a name="l00776"></a>00776    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span> -1;
<a name="l00777"></a>00777    
<a name="l00778"></a>00778    <span class="keywordflow">switch</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a> ) {
<a name="l00779"></a>00779    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4aeb34fa6afdc8da6670a1e3a14c85c6fa">BCHAN_CLEANED</a>:
<a name="l00780"></a>00780       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;$$$ Already cleaned up bc with stid :%x\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a>);
<a name="l00781"></a>00781       <span class="keywordflow">return</span> -1;
<a name="l00782"></a>00782       
<a name="l00783"></a>00783    <span class="keywordflow">default</span>:
<a name="l00784"></a>00784       <span class="keywordflow">break</span>;
<a name="l00785"></a>00785    }
<a name="l00786"></a>00786    
<a name="l00787"></a>00787    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;$$$ Cleaning up bc with stid :%x pid:%d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l00788"></a>00788    
<a name="l00789"></a>00789    <a class="code" href="isdn__lib_8c.html#a1801c58b6e467b4ef0d75aff37aa77f2">manager_ec_disable</a>(bc);
<a name="l00790"></a>00790 
<a name="l00791"></a>00791    <a class="code" href="isdn__lib_8c.html#adc7ac4a2a52152266d36adff41f5a587">manager_bchannel_deactivate</a>(bc);
<a name="l00792"></a>00792 
<a name="l00793"></a>00793    mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, buff, bc-&gt;<a class="code" href="structmisdn__bchannel.html#ad3f99071e2a45a0a256d33c018950293" title="B Channel mISDN driver layer ID from mISDN_new_layer().">layer_id</a>|FLG_MSG_TARGET|FLG_MSG_DOWN, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l00794"></a>00794    
<a name="l00795"></a>00795    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a> = 0;
<a name="l00796"></a>00796    <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4aeb34fa6afdc8da6670a1e3a14c85c6fa">BCHAN_CLEANED</a>);
<a name="l00797"></a>00797    
<a name="l00798"></a>00798    <span class="keywordflow">return</span> ret;
<a name="l00799"></a>00799 }
<a name="l00800"></a>00800 
<a name="l00801"></a>00801 
<a name="l00802"></a>00802 
<a name="l00803"></a><a class="code" href="isdn__lib_8c.html#ad1f0e37879b7ff599b95f5e9df7ae482">00803</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#ad1f0e37879b7ff599b95f5e9df7ae482">clear_l3</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00804"></a>00804 {
<a name="l00805"></a>00805    <span class="keywordtype">int</span> i;
<a name="l00806"></a>00806 
<a name="l00807"></a>00807    <span class="keywordflow">for</span> (i=0; i&lt;=stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; i++) {
<a name="l00808"></a>00808       <span class="keywordflow">if</span> (global_state == <a class="code" href="isdn__lib_8c.html#af1db0e676da5eccb2fa1d40ae01412a8a2e1eacba6b620d51dce53d3bd8cffd4e">MISDN_INITIALIZED</a>)  {
<a name="l00809"></a>00809          <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0ac49b8317168e8506edc0de2450658541">EVENT_CLEANUP</a>, &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i], NULL); 
<a name="l00810"></a>00810          <a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">empty_bc</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i]);
<a name="l00811"></a>00811          <a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">clean_up_bc</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i]);
<a name="l00812"></a>00812          <a class="code" href="isdn__lib_8c.html#a9f849e8a799ef7d6a52f6a10ec4446e5">empty_chan_in_stack</a>(stack, i + 1);
<a name="l00813"></a>00813          stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a> = 0;
<a name="l00814"></a>00814       }
<a name="l00815"></a>00815       
<a name="l00816"></a>00816    } 
<a name="l00817"></a>00817 }
<a name="l00818"></a>00818 
<a name="l00819"></a><a class="code" href="isdn__lib_8c.html#abcd4f87d737bd03224f8fcb9a7958714">00819</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#abcd4f87d737bd03224f8fcb9a7958714">new_te_id</a> = 0;
<a name="l00820"></a>00820 
<a name="l00821"></a><a class="code" href="isdn__lib_8c.html#a497ddc07900b2532f29637852a8cdd7e">00821</a> <span class="preprocessor">#define MAXPROCS 0x100</span>
<a name="l00822"></a>00822 <span class="preprocessor"></span>
<a name="l00823"></a><a class="code" href="isdn__lib_8c.html#af5d84057ddf714f7329a057806fcd6f4">00823</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#af5d84057ddf714f7329a057806fcd6f4">misdn_lib_get_l1_down</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00824"></a>00824 {
<a name="l00825"></a>00825    <span class="comment">/* Pull Up L1 */</span> 
<a name="l00826"></a>00826    iframe_t act;
<a name="l00827"></a>00827    act.prim = PH_DEACTIVATE | REQUEST; 
<a name="l00828"></a>00828    act.addr = stack-&gt;<a class="code" href="structmisdn__stack.html#aa2ae4f87975bbc69517aa3bc328e91c0" title="Lower layer mISDN ID (addr) (Layer 1/3).">lower_id</a>|FLG_MSG_DOWN;
<a name="l00829"></a>00829    act.dinfo = 0;
<a name="l00830"></a>00830    act.len = 0;
<a name="l00831"></a>00831 
<a name="l00832"></a>00832    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;SENDING PH_DEACTIVATE | REQ\n&quot;</span>);
<a name="l00833"></a>00833    <span class="keywordflow">return</span> mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, &amp;act, mISDN_HEADER_LEN+act.len, TIMEOUT_1SEC);
<a name="l00834"></a>00834 }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836 
<a name="l00837"></a><a class="code" href="isdn__lib_8c.html#aca6da100bec9aa446c5ccf22e6d894c6">00837</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#aca6da100bec9aa446c5ccf22e6d894c6">misdn_lib_get_l2_down</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00838"></a>00838 {
<a name="l00839"></a>00839    
<a name="l00840"></a>00840    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a> &amp;&amp; (stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) ) {
<a name="l00841"></a>00841       msg_t *dmsg;
<a name="l00842"></a>00842       <span class="comment">/* L2 */</span>
<a name="l00843"></a>00843       dmsg = <a class="code" href="isdn__lib_8c.html#ad3ca3d5daee2e83b14b9dc7c5d24e302">create_l2msg</a>(DL_RELEASE| REQUEST, 0, 0);
<a name="l00844"></a>00844       
<a name="l00845"></a>00845       <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l00846"></a>00846       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>, dmsg))
<a name="l00847"></a>00847          free_msg(dmsg);
<a name="l00848"></a>00848       <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l00849"></a>00849    } <span class="keywordflow">else</span> {
<a name="l00850"></a>00850       iframe_t act;
<a name="l00851"></a>00851       
<a name="l00852"></a>00852       act.prim = DL_RELEASE| REQUEST;
<a name="l00853"></a>00853       act.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a> |FLG_MSG_DOWN)  ;
<a name="l00854"></a>00854       
<a name="l00855"></a>00855       act.dinfo = 0;
<a name="l00856"></a>00856       act.len = 0;
<a name="l00857"></a>00857       <span class="keywordflow">return</span> mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, &amp;act, mISDN_HEADER_LEN+act.len, TIMEOUT_1SEC);
<a name="l00858"></a>00858    }
<a name="l00859"></a>00859    
<a name="l00860"></a>00860    <span class="keywordflow">return</span> 0;
<a name="l00861"></a>00861 }
<a name="l00862"></a>00862 
<a name="l00863"></a>00863 
<a name="l00864"></a><a class="code" href="isdn__lib_8c.html#a4af2f7ae2eb8c3746985df5544d17203">00864</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a4af2f7ae2eb8c3746985df5544d17203">misdn_lib_get_l1_up</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00865"></a>00865 {
<a name="l00866"></a>00866    <span class="comment">/* Pull Up L1 */</span> 
<a name="l00867"></a>00867    iframe_t act;
<a name="l00868"></a>00868    act.prim = PH_ACTIVATE | REQUEST; 
<a name="l00869"></a>00869    act.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a> | FLG_MSG_DOWN)  ;
<a name="l00870"></a>00870 
<a name="l00871"></a>00871    
<a name="l00872"></a>00872    act.dinfo = 0;
<a name="l00873"></a>00873    act.len = 0;
<a name="l00874"></a>00874 
<a name="l00875"></a>00875    <span class="keywordflow">return</span> mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, &amp;act, mISDN_HEADER_LEN+act.len, TIMEOUT_1SEC);
<a name="l00876"></a>00876 
<a name="l00877"></a>00877 }
<a name="l00878"></a>00878 
<a name="l00879"></a><a class="code" href="isdn__lib_8c.html#af03ad57836b38845f685368e60625707">00879</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#af03ad57836b38845f685368e60625707">misdn_lib_get_l2_up</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00880"></a>00880 {
<a name="l00881"></a>00881    
<a name="l00882"></a>00882    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a> &amp;&amp; (stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) ) {
<a name="l00883"></a>00883       msg_t *dmsg;
<a name="l00884"></a>00884       <span class="comment">/* L2 */</span>
<a name="l00885"></a>00885       dmsg = <a class="code" href="isdn__lib_8c.html#ad3ca3d5daee2e83b14b9dc7c5d24e302">create_l2msg</a>(DL_ESTABLISH | REQUEST, 0, 0);
<a name="l00886"></a>00886       
<a name="l00887"></a>00887       <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l00888"></a>00888       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>, dmsg))
<a name="l00889"></a>00889          free_msg(dmsg);
<a name="l00890"></a>00890       <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l00891"></a>00891    } <span class="keywordflow">else</span> {
<a name="l00892"></a>00892       iframe_t act;
<a name="l00893"></a>00893       
<a name="l00894"></a>00894       act.prim = DL_ESTABLISH | REQUEST;
<a name="l00895"></a>00895       act.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a> |FLG_MSG_DOWN)  ;
<a name="l00896"></a>00896       
<a name="l00897"></a>00897       act.dinfo = 0;
<a name="l00898"></a>00898       act.len = 0;
<a name="l00899"></a>00899       <span class="keywordflow">return</span> mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, &amp;act, mISDN_HEADER_LEN+act.len, TIMEOUT_1SEC);
<a name="l00900"></a>00900    }
<a name="l00901"></a>00901    
<a name="l00902"></a>00902    <span class="keywordflow">return</span> 0;
<a name="l00903"></a>00903 }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905 <span class="preprocessor">#if 0</span>
<a name="l00906"></a>00906 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> misdn_lib_get_l2_te_ptp_up(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00907"></a>00907 {
<a name="l00908"></a>00908    iframe_t act;
<a name="l00909"></a>00909       
<a name="l00910"></a>00910    act.prim = DL_ESTABLISH | REQUEST;
<a name="l00911"></a>00911    act.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a>  &amp; ~LAYER_ID_MASK) | 3 | FLG_MSG_DOWN;
<a name="l00912"></a>00912       
<a name="l00913"></a>00913    act.dinfo = 0;
<a name="l00914"></a>00914    act.len = 0;
<a name="l00915"></a>00915    <span class="keywordflow">return</span> mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, &amp;act, mISDN_HEADER_LEN+act.len, TIMEOUT_1SEC);
<a name="l00916"></a>00916    <span class="keywordflow">return</span> 0;
<a name="l00917"></a>00917 }
<a name="l00918"></a>00918 <span class="preprocessor">#endif</span>
<a name="l00919"></a>00919 <span class="preprocessor"></span>
<a name="l00920"></a><a class="code" href="isdn__lib_8c.html#a7dcc4196f1ee5793afa5bf53dbcb11c1">00920</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a7dcc4196f1ee5793afa5bf53dbcb11c1">misdn_lib_get_short_status</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00921"></a>00921 {
<a name="l00922"></a>00922    iframe_t act;
<a name="l00923"></a>00923    
<a name="l00924"></a>00924    
<a name="l00925"></a>00925    act.prim = MGR_SHORTSTATUS | REQUEST; 
<a name="l00926"></a>00926    
<a name="l00927"></a>00927    act.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a> | MSG_BROADCAST)  ;
<a name="l00928"></a>00928 
<a name="l00929"></a>00929    act.dinfo = SSTATUS_BROADCAST_BIT | SSTATUS_ALL;
<a name="l00930"></a>00930    
<a name="l00931"></a>00931    act.len = 0;
<a name="l00932"></a>00932    <span class="keywordflow">return</span> mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, &amp;act, mISDN_HEADER_LEN+act.len, TIMEOUT_1SEC);
<a name="l00933"></a>00933 }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935 
<a name="l00936"></a>00936 
<a name="l00937"></a><a class="code" href="isdn__lib_8c.html#ae97c690e8c7a79191abfcde368be8922">00937</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#ae97c690e8c7a79191abfcde368be8922">create_process</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l00938"></a>00938 {
<a name="l00939"></a>00939    iframe_t ncr;
<a name="l00940"></a>00940    <span class="keywordtype">int</span> l3_id;
<a name="l00941"></a>00941    <span class="keywordtype">int</span> proc_id;
<a name="l00942"></a>00942    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944    stack = <a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l00945"></a>00945    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) {
<a name="l00946"></a>00946       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a67727c8665c79737a5e7ffd7a524934a">find_free_chan_in_stack</a>(stack, bc, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a443e308806d144a6782fd01d04577129" title="TRUE if the B channel number is preselected.">channel_preselected</a> ? bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> : 0, 0) &lt; 0) {
<a name="l00947"></a>00947          <span class="keywordflow">return</span> -1;
<a name="l00948"></a>00948       }
<a name="l00949"></a>00949       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt;  found channel: %d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>);
<a name="l00950"></a>00950 
<a name="l00951"></a>00951       <span class="keywordflow">for</span> (proc_id = 0; proc_id &lt; <a class="code" href="isdn__lib_8c.html#a497ddc07900b2532f29637852a8cdd7e">MAXPROCS</a>; ++proc_id) {
<a name="l00952"></a>00952          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#af09226a0718361435f6aca5c31167166" title="CR Process ID allocation table. TRUE if ID allocated.">procids</a>[proc_id] == 0) {
<a name="l00953"></a>00953             <span class="keywordflow">break</span>;
<a name="l00954"></a>00954          }
<a name="l00955"></a>00955       }  <span class="comment">/* end for */</span>
<a name="l00956"></a>00956       <span class="keywordflow">if</span> (proc_id == MAXPROCS) {
<a name="l00957"></a>00957          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Couldn&apos;t Create New ProcId.\n&quot;</span>);
<a name="l00958"></a>00958          <span class="keywordflow">return</span> -1;
<a name="l00959"></a>00959       }
<a name="l00960"></a>00960 
<a name="l00961"></a>00961       stack-&gt;<a class="code" href="structmisdn__stack.html#af09226a0718361435f6aca5c31167166" title="CR Process ID allocation table. TRUE if ID allocated.">procids</a>[proc_id] = 1;
<a name="l00962"></a>00962 
<a name="l00963"></a>00963       l3_id = 0xff00 | proc_id;
<a name="l00964"></a>00964       bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a> = l3_id;
<a name="l00965"></a>00965       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; new_l3id %x\n&quot;</span>, l3_id);
<a name="l00966"></a>00966    } <span class="keywordflow">else</span> {
<a name="l00967"></a>00967       <span class="keywordflow">if</span> ((stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a> &amp;&amp; stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a>) || bc-&gt;<a class="code" href="structmisdn__bchannel.html#ae822c229e6877cf2310db8e68f733611" title="TRUE if the TE side should choose the B channel to use.">te_choose_channel</a>) {
<a name="l00968"></a>00968          <span class="comment">/* we know exactly which channels are in use */</span>
<a name="l00969"></a>00969          <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a67727c8665c79737a5e7ffd7a524934a">find_free_chan_in_stack</a>(stack, bc, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a443e308806d144a6782fd01d04577129" title="TRUE if the B channel number is preselected.">channel_preselected</a> ? bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> : 0, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a04e41b69f1017a234f0cfe958c99be93" title="TRUE if allocate higher B channels first.">dec</a>) &lt; 0) {
<a name="l00970"></a>00970             <span class="keywordflow">return</span> -1;
<a name="l00971"></a>00971          }
<a name="l00972"></a>00972          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt;  found channel: %d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>);
<a name="l00973"></a>00973       } <span class="keywordflow">else</span> {
<a name="l00974"></a>00974          <span class="comment">/* other phones could have made a call also on this port (ptmp) */</span>
<a name="l00975"></a>00975          bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> = 0xff;
<a name="l00976"></a>00976       }
<a name="l00977"></a>00977 
<a name="l00978"></a>00978       <span class="comment">/* if we are in te-mode, we need to create a process first */</span>
<a name="l00979"></a>00979       <span class="keywordflow">if</span> (++new_te_id &gt; 0xffff) {
<a name="l00980"></a>00980          new_te_id = 0x0001;
<a name="l00981"></a>00981       }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983       l3_id = (entity &lt;&lt; 16) | new_te_id;
<a name="l00984"></a>00984       bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a> = l3_id;
<a name="l00985"></a>00985       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;--&gt; new_l3id %x\n&quot;</span>, l3_id);
<a name="l00986"></a>00986 
<a name="l00987"></a>00987       <span class="comment">/* send message */</span>
<a name="l00988"></a>00988       ncr.prim = CC_NEW_CR | REQUEST;
<a name="l00989"></a>00989       ncr.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a> | FLG_MSG_DOWN);
<a name="l00990"></a>00990       ncr.dinfo = l3_id;
<a name="l00991"></a>00991       ncr.len = 0;
<a name="l00992"></a>00992       mISDN_write(midev, &amp;ncr, mISDN_HEADER_LEN + ncr.len, TIMEOUT_1SEC);
<a name="l00993"></a>00993    }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995    <span class="keywordflow">return</span> l3_id;
<a name="l00996"></a>00996 }
<a name="l00997"></a>00997 
<a name="l00998"></a>00998 
<a name="l00999"></a><a class="code" href="isdn__lib_8h.html#ab91bddf6e047c791ce4af897f23504a8">00999</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#ab91bddf6e047c791ce4af897f23504a8">misdn_lib_setup_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l01000"></a>01000 {
<a name="l01001"></a>01001    <a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">clean_up_bc</a>(bc);
<a name="l01002"></a>01002    <a class="code" href="isdn__lib_8c.html#a58b3989f0b5555f87f5c55fdefa8c6fb">setup_bc</a>(bc);
<a name="l01003"></a>01003 }
<a name="l01004"></a>01004 
<a name="l01005"></a>01005 
<a name="l01006"></a><a class="code" href="isdn__lib_8c.html#a58b3989f0b5555f87f5c55fdefa8c6fb">01006</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a58b3989f0b5555f87f5c55fdefa8c6fb">setup_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l01007"></a>01007 {
<a name="l01008"></a>01008    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="chan__unistim_8c.html#af30c10a8c6ed3d4649cfdc61e2029dc3">buff</a>[1025];
<a name="l01009"></a>01009    <span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>;
<a name="l01010"></a>01010    <span class="keywordtype">int</span> channel;
<a name="l01011"></a>01011    <span class="keywordtype">int</span> b_stid;
<a name="l01012"></a>01012    <span class="keywordtype">int</span> i;
<a name="l01013"></a>01013    mISDN_pid_t pid;
<a name="l01014"></a>01014    <span class="keywordtype">int</span> ret;
<a name="l01015"></a>01015 
<a name="l01016"></a>01016    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l01017"></a>01017 
<a name="l01018"></a>01018    <span class="keywordflow">if</span> (!stack) {
<a name="l01019"></a>01019       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;setup_bc: NO STACK FOUND!!\n&quot;</span>);
<a name="l01020"></a>01020       <span class="keywordflow">return</span> -1;
<a name="l01021"></a>01021    }
<a name="l01022"></a>01022    
<a name="l01023"></a>01023    midev = stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>;
<a name="l01024"></a>01024    channel = bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> - 1 - (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> &gt; 16);
<a name="l01025"></a>01025    b_stid = stack-&gt;<a class="code" href="structmisdn__stack.html#a257ff184f091881cb6bfb73bc8a181d0" title="B Channel mISDN driver stack IDs (Child stack IDs).">b_stids</a>[channel &gt;= 0 ? channel : 0];
<a name="l01026"></a>01026 
<a name="l01027"></a>01027    <span class="keywordflow">switch</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a>) {
<a name="l01028"></a>01028       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4aeb34fa6afdc8da6670a1e3a14c85c6fa">BCHAN_CLEANED</a>:
<a name="l01029"></a>01029          <span class="keywordflow">break</span>;
<a name="l01030"></a>01030       <span class="keywordflow">default</span>:
<a name="l01031"></a>01031          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;$$$ bc already setup stid :%x (state:%s)\n&quot;</span>, b_stid, <a class="code" href="isdn__lib_8c.html#ae2f4cc55968e9014a4daa06d1be05bef">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a>) );
<a name="l01032"></a>01032          <span class="keywordflow">return</span> -1;
<a name="l01033"></a>01033    }
<a name="l01034"></a>01034    
<a name="l01035"></a>01035    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;$$$ Setting up bc with stid :%x\n&quot;</span>, b_stid);
<a name="l01036"></a>01036    
<a name="l01037"></a>01037    <span class="comment">/*check if the b_stid is already initialized*/</span>
<a name="l01038"></a>01038    <span class="keywordflow">for</span> (i=0; i &lt;= stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; i++) {
<a name="l01039"></a>01039       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a> == b_stid) {
<a name="l01040"></a>01040          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;setup_bc: b_stid:%x already in use !!!\n&quot;</span>, b_stid);
<a name="l01041"></a>01041          <span class="keywordflow">return</span> -1;
<a name="l01042"></a>01042       }
<a name="l01043"></a>01043    }
<a name="l01044"></a>01044    
<a name="l01045"></a>01045    <span class="keywordflow">if</span> (b_stid &lt;= 0) {
<a name="l01046"></a>01046       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot; -- Stid &lt;=0 at the moment in channel:%d\n&quot;</span>,channel);
<a name="l01047"></a>01047       
<a name="l01048"></a>01048       <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4afcaed23d8920931db5c4890b5f3bfad8">BCHAN_ERROR</a>);
<a name="l01049"></a>01049       <span class="keywordflow">return</span> 1;
<a name="l01050"></a>01050    }
<a name="l01051"></a>01051 
<a name="l01052"></a>01052    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a> = b_stid;
<a name="l01053"></a>01053 
<a name="l01054"></a>01054    {
<a name="l01055"></a>01055       layer_info_t li;
<a name="l01056"></a>01056       memset(&amp;li, 0, <span class="keyword">sizeof</span>(li));
<a name="l01057"></a>01057     
<a name="l01058"></a>01058       li.object_id = -1;
<a name="l01059"></a>01059       li.extentions = 0;
<a name="l01060"></a>01060       
<a name="l01061"></a>01061       li.st = bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a>; <span class="comment">/*  given idx */</span>
<a name="l01062"></a>01062 
<a name="l01063"></a>01063 
<a name="l01064"></a>01064 <span class="preprocessor">#define MISDN_DSP</span>
<a name="l01065"></a>01065 <span class="preprocessor"></span><span class="preprocessor">#ifndef MISDN_DSP</span>
<a name="l01066"></a>01066 <span class="preprocessor"></span>      bc-&gt;<a class="code" href="structmisdn__bchannel.html#a134855bcd1a1ba0d1733faa7a4e94389" title="TRUE if we will not use jollys dsp.">nodsp</a>=1;
<a name="l01067"></a>01067 <span class="preprocessor">#endif</span>
<a name="l01068"></a>01068 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#a23c37f6ee7f30735975cc3848117a830" title="TRUE if call made in digital HDLC mode.">hdlc</a> || bc-&gt;<a class="code" href="structmisdn__bchannel.html#a134855bcd1a1ba0d1733faa7a4e94389" title="TRUE if we will not use jollys dsp.">nodsp</a>) {
<a name="l01069"></a>01069          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;setup_bc: without dsp\n&quot;</span>);
<a name="l01070"></a>01070          { 
<a name="l01071"></a>01071             <span class="keywordtype">int</span> l = <span class="keyword">sizeof</span>(li.name);
<a name="l01072"></a>01072             strncpy(li.name, <span class="stringliteral">&quot;B L3&quot;</span>, l);
<a name="l01073"></a>01073             li.name[l-1] = 0;
<a name="l01074"></a>01074          }
<a name="l01075"></a>01075          li.pid.layermask = ISDN_LAYER((3));
<a name="l01076"></a>01076          li.pid.protocol[3] = <a class="code" href="isdn__lib_8c.html#a085934559aa50e6c69555da1451d35f4">ISDN_PID_L3_B_USER</a>;
<a name="l01077"></a>01077          
<a name="l01078"></a>01078          bc-&gt;<a class="code" href="structmisdn__bchannel.html#af5e6403cb6864751421a5e7249e4cc62" title="B channel layer; set to 3 or 4.">layer</a>=3;
<a name="l01079"></a>01079       } <span class="keywordflow">else</span> {
<a name="l01080"></a>01080          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;setup_bc: with dsp\n&quot;</span>);
<a name="l01081"></a>01081          { 
<a name="l01082"></a>01082             <span class="keywordtype">int</span> l = <span class="keyword">sizeof</span>(li.name);
<a name="l01083"></a>01083             strncpy(li.name, <span class="stringliteral">&quot;B L4&quot;</span>, l);
<a name="l01084"></a>01084             li.name[l-1] = 0;
<a name="l01085"></a>01085          }
<a name="l01086"></a>01086          li.pid.layermask = ISDN_LAYER((4));
<a name="l01087"></a>01087          li.pid.protocol[4] = <a class="code" href="isdn__lib_8c.html#a3537a99d1cf6027496cfdea16a4f5f2c">ISDN_PID_L4_B_USER</a>;
<a name="l01088"></a>01088 
<a name="l01089"></a>01089          bc-&gt;<a class="code" href="structmisdn__bchannel.html#af5e6403cb6864751421a5e7249e4cc62" title="B channel layer; set to 3 or 4.">layer</a>=4;
<a name="l01090"></a>01090       }  
<a name="l01091"></a>01091       
<a name="l01092"></a>01092       ret = mISDN_new_layer(midev, &amp;li);
<a name="l01093"></a>01093       <span class="keywordflow">if</span> (ret ) {
<a name="l01094"></a>01094          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;New Layer Err: %d %s\n&quot;</span>,ret,strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01095"></a>01095 
<a name="l01096"></a>01096          <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4afcaed23d8920931db5c4890b5f3bfad8">BCHAN_ERROR</a>);
<a name="l01097"></a>01097          <span class="keywordflow">return</span>(-EINVAL);
<a name="l01098"></a>01098       }
<a name="l01099"></a>01099       
<a name="l01100"></a>01100       bc-&gt;<a class="code" href="structmisdn__bchannel.html#ad3f99071e2a45a0a256d33c018950293" title="B Channel mISDN driver layer ID from mISDN_new_layer().">layer_id</a> = li.id;
<a name="l01101"></a>01101    }
<a name="l01102"></a>01102    
<a name="l01103"></a>01103    memset(&amp;pid, 0, <span class="keyword">sizeof</span>(pid));
<a name="l01104"></a>01104    
<a name="l01105"></a>01105    
<a name="l01106"></a>01106    
<a name="l01107"></a>01107    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot; --&gt; Channel is %d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>);
<a name="l01108"></a>01108    
<a name="l01109"></a>01109    <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#a134855bcd1a1ba0d1733faa7a4e94389" title="TRUE if we will not use jollys dsp.">nodsp</a>) {
<a name="l01110"></a>01110       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot; --&gt; TRANSPARENT Mode (no DSP, no HDLC)\n&quot;</span>);
<a name="l01111"></a>01111       pid.protocol[1] = ISDN_PID_L1_B_64TRANS;
<a name="l01112"></a>01112       pid.protocol[2] = ISDN_PID_L2_B_TRANS;
<a name="l01113"></a>01113       pid.protocol[3] = <a class="code" href="isdn__lib_8c.html#a085934559aa50e6c69555da1451d35f4">ISDN_PID_L3_B_USER</a>;
<a name="l01114"></a>01114       pid.layermask = ISDN_LAYER((1)) | ISDN_LAYER((2)) | ISDN_LAYER((3));
<a name="l01115"></a>01115       
<a name="l01116"></a>01116    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#a23c37f6ee7f30735975cc3848117a830" title="TRUE if call made in digital HDLC mode.">hdlc</a> ) {
<a name="l01117"></a>01117       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot; --&gt; HDLC Mode\n&quot;</span>);
<a name="l01118"></a>01118       pid.protocol[1] = ISDN_PID_L1_B_64HDLC ;
<a name="l01119"></a>01119       pid.protocol[2] = ISDN_PID_L2_B_TRANS  ;
<a name="l01120"></a>01120       pid.protocol[3] = <a class="code" href="isdn__lib_8c.html#a085934559aa50e6c69555da1451d35f4">ISDN_PID_L3_B_USER</a>;
<a name="l01121"></a>01121       pid.layermask = ISDN_LAYER((1)) | ISDN_LAYER((2)) | ISDN_LAYER((3)) ;
<a name="l01122"></a>01122    } <span class="keywordflow">else</span> {
<a name="l01123"></a>01123       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot; --&gt; TRANSPARENT Mode\n&quot;</span>);
<a name="l01124"></a>01124       pid.protocol[1] = ISDN_PID_L1_B_64TRANS;
<a name="l01125"></a>01125       pid.protocol[2] = ISDN_PID_L2_B_TRANS;
<a name="l01126"></a>01126       pid.protocol[3] = ISDN_PID_L3_B_DSP;
<a name="l01127"></a>01127       pid.protocol[4] = <a class="code" href="isdn__lib_8c.html#a3537a99d1cf6027496cfdea16a4f5f2c">ISDN_PID_L4_B_USER</a>;
<a name="l01128"></a>01128       pid.layermask = ISDN_LAYER((1)) | ISDN_LAYER((2)) | ISDN_LAYER((3)) | ISDN_LAYER((4));
<a name="l01129"></a>01129       
<a name="l01130"></a>01130    } 
<a name="l01131"></a>01131 
<a name="l01132"></a>01132    ret = mISDN_set_stack(midev, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a>, &amp;pid);
<a name="l01133"></a>01133 
<a name="l01134"></a>01134    <span class="keywordflow">if</span> (ret){
<a name="l01135"></a>01135       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;$$$ Set Stack Err: %d %s\n&quot;</span>,ret,strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01136"></a>01136       
<a name="l01137"></a>01137       mISDN_write_frame(midev, buff, bc-&gt;<a class="code" href="structmisdn__bchannel.html#ad3f99071e2a45a0a256d33c018950293" title="B Channel mISDN driver layer ID from mISDN_new_layer().">layer_id</a>, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l01138"></a>01138       
<a name="l01139"></a>01139       <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4afcaed23d8920931db5c4890b5f3bfad8">BCHAN_ERROR</a>);
<a name="l01140"></a>01140       <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a784d7a1053a1d9680c5be66e3c294843">EVENT_BCHAN_ERROR</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l01141"></a>01141       <span class="keywordflow">return</span>(-EINVAL);
<a name="l01142"></a>01142    }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144    ret = mISDN_get_setstack_ind(midev, bc-&gt;<a class="code" href="structmisdn__bchannel.html#ad3f99071e2a45a0a256d33c018950293" title="B Channel mISDN driver layer ID from mISDN_new_layer().">layer_id</a>);
<a name="l01145"></a>01145 
<a name="l01146"></a>01146    <span class="keywordflow">if</span> (ret) {
<a name="l01147"></a>01147       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;$$$ Set StackIND Err: %d %s\n&quot;</span>,ret,strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01148"></a>01148       mISDN_write_frame(midev, buff, bc-&gt;<a class="code" href="structmisdn__bchannel.html#ad3f99071e2a45a0a256d33c018950293" title="B Channel mISDN driver layer ID from mISDN_new_layer().">layer_id</a>, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l01149"></a>01149       
<a name="l01150"></a>01150       <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4afcaed23d8920931db5c4890b5f3bfad8">BCHAN_ERROR</a>);
<a name="l01151"></a>01151       <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a784d7a1053a1d9680c5be66e3c294843">EVENT_BCHAN_ERROR</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l01152"></a>01152       <span class="keywordflow">return</span>(-EINVAL);
<a name="l01153"></a>01153    }
<a name="l01154"></a>01154 
<a name="l01155"></a>01155    ret = mISDN_get_layerid(midev, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#af5e6403cb6864751421a5e7249e4cc62" title="B channel layer; set to 3 or 4.">layer</a>) ;
<a name="l01156"></a>01156 
<a name="l01157"></a>01157    bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> = ret&gt;0? ret : 0;
<a name="l01158"></a>01158 
<a name="l01159"></a>01159    <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>) {
<a name="l01160"></a>01160       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;$$$ Get Layerid Err: %d %s\n&quot;</span>,ret,strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01161"></a>01161       mISDN_write_frame(midev, buff, bc-&gt;<a class="code" href="structmisdn__bchannel.html#ad3f99071e2a45a0a256d33c018950293" title="B Channel mISDN driver layer ID from mISDN_new_layer().">layer_id</a>, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l01162"></a>01162       
<a name="l01163"></a>01163       <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4afcaed23d8920931db5c4890b5f3bfad8">BCHAN_ERROR</a>);
<a name="l01164"></a>01164       <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a784d7a1053a1d9680c5be66e3c294843">EVENT_BCHAN_ERROR</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l01165"></a>01165       <span class="keywordflow">return</span> (-EINVAL);
<a name="l01166"></a>01166    }
<a name="l01167"></a>01167 
<a name="l01168"></a>01168    <a class="code" href="isdn__lib_8c.html#a49017a4e2c6e4515c217c40bf822abb6">manager_bchannel_activate</a>(bc);
<a name="l01169"></a>01169    
<a name="l01170"></a>01170    <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a1b7d7fde2aa8ceca170c3d0f8283fbc0">BCHAN_ACTIVATED</a>);
<a name="l01171"></a>01171 
<a name="l01172"></a>01172    <span class="keywordflow">return</span> 0;
<a name="l01173"></a>01173 }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175 
<a name="l01176"></a>01176 <span class="comment"></span>
<a name="l01177"></a>01177 <span class="comment">/** IFACE **/</span>
<a name="l01178"></a><a class="code" href="isdn__lib_8c.html#a87f40cb8ee97ceb51e0e6143cc47ebd4">01178</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a87f40cb8ee97ceb51e0e6143cc47ebd4">init_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, <span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="keywordtype">int</span> bidx, <span class="keywordtype">char</span> *msn, <span class="keywordtype">int</span> firsttime)
<a name="l01179"></a>01179 {
<a name="l01180"></a>01180    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="chan__unistim_8c.html#af30c10a8c6ed3d4649cfdc61e2029dc3">buff</a>[1025] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01181"></a>01181    iframe_t *frm = (iframe_t *)buff;
<a name="l01182"></a>01182    <span class="keywordtype">int</span> ret;
<a name="l01183"></a>01183   
<a name="l01184"></a>01184    <span class="keywordflow">if</span> (!bc) <span class="keywordflow">return</span> -1;
<a name="l01185"></a>01185   
<a name="l01186"></a>01186    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(8, port, <span class="stringliteral">&quot;Init.BC %d.\n&quot;</span>,bidx);
<a name="l01187"></a>01187    
<a name="l01188"></a>01188    memset(bc, 0,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>));
<a name="l01189"></a>01189 
<a name="l01190"></a>01190    bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa344dc277658ddd12815b6ff5f561a3f" title="B channel send locking structure.">send_lock</a>=<a class="code" href="astmm_8h.html#ab8b25cd8f16d4a6552afe4e65c4f082d">malloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsend__lock.html">send_lock</a>));
<a name="l01191"></a>01191    <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa344dc277658ddd12815b6ff5f561a3f" title="B channel send locking structure.">send_lock</a>) {
<a name="l01192"></a>01192       <span class="keywordflow">return</span> -1;
<a name="l01193"></a>01193    }
<a name="l01194"></a>01194    <a class="code" href="lock_8h.html#ad7693eb0c23d9649f82992b785ddbe4e">pthread_mutex_init</a>(&amp;bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa344dc277658ddd12815b6ff5f561a3f" title="B channel send locking structure.">send_lock</a>-&gt;<a class="code" href="structsend__lock.html#a0abaf4b5d42c4e5d19190035fade3599">lock</a>, NULL);
<a name="l01195"></a>01195    
<a name="l01196"></a>01196    <span class="keywordflow">if</span> (msn) {
<a name="l01197"></a>01197       <span class="keywordtype">int</span> l = <span class="keyword">sizeof</span>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#ac5c729c7b0e983290217fb2bffcc6370" title="Not used. Contents are setup but not used.">msn</a>);
<a name="l01198"></a>01198       strncpy(bc-&gt;<a class="code" href="structmisdn__bchannel.html#ac5c729c7b0e983290217fb2bffcc6370" title="Not used. Contents are setup but not used.">msn</a>,msn, l);
<a name="l01199"></a>01199       bc-&gt;<a class="code" href="structmisdn__bchannel.html#ac5c729c7b0e983290217fb2bffcc6370" title="Not used. Contents are setup but not used.">msn</a>[l-1] = 0;
<a name="l01200"></a>01200    }
<a name="l01201"></a>01201    
<a name="l01202"></a>01202    
<a name="l01203"></a>01203    <a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">empty_bc</a>(bc);
<a name="l01204"></a>01204    <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4aeb34fa6afdc8da6670a1e3a14c85c6fa">BCHAN_CLEANED</a>);
<a name="l01205"></a>01205    
<a name="l01206"></a>01206    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>;
<a name="l01207"></a>01207    bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>?1:0;
<a name="l01208"></a>01208    bc-&gt;<a class="code" href="structmisdn__bchannel.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a>;
<a name="l01209"></a>01209    
<a name="l01210"></a>01210    {
<a name="l01211"></a>01211       ibuffer_t* ibuf= init_ibuffer(<a class="code" href="isdn__lib_8c.html#a2e0a45e18950314bd8306b3b0b6afc11">MISDN_IBUF_SIZE</a>);
<a name="l01212"></a>01212 
<a name="l01213"></a>01213       <span class="keywordflow">if</span> (!ibuf) <span class="keywordflow">return</span> -1;
<a name="l01214"></a>01214       
<a name="l01215"></a>01215       clear_ibuffer( ibuf);
<a name="l01216"></a>01216       
<a name="l01217"></a>01217       ibuf-&gt;rsem=<a class="code" href="astmm_8h.html#ab8b25cd8f16d4a6552afe4e65c4f082d">malloc</a>(<span class="keyword">sizeof</span>(sem_t));
<a name="l01218"></a>01218       <span class="keywordflow">if</span> (!ibuf-&gt;rsem) {
<a name="l01219"></a>01219          <span class="keywordflow">return</span> -1;
<a name="l01220"></a>01220       }
<a name="l01221"></a>01221       
<a name="l01222"></a>01222       bc-&gt;<a class="code" href="structmisdn__bchannel.html#a341f18ec4157d0b4b3b9cf2367122c88" title="Not used. Contents are setup but not used.">astbuf</a>=ibuf;
<a name="l01223"></a>01223 
<a name="l01224"></a>01224       <span class="keywordflow">if</span> (sem_init(ibuf-&gt;rsem,1,0)&lt;0)
<a name="l01225"></a>01225          sem_init(ibuf-&gt;rsem,0,0);
<a name="l01226"></a>01226       
<a name="l01227"></a>01227    }
<a name="l01228"></a>01228    
<a name="l01229"></a>01229    {
<a name="l01230"></a>01230       stack_info_t *stinf;
<a name="l01231"></a>01231       ret = mISDN_get_stack_info(midev, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, buff, <span class="keyword">sizeof</span>(buff));
<a name="l01232"></a>01232       <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l01233"></a>01233          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;%s: Cannot get stack info for this port. (ret=%d)\n&quot;</span>, __FUNCTION__, ret);
<a name="l01234"></a>01234          <span class="keywordflow">return</span> -1;
<a name="l01235"></a>01235       }
<a name="l01236"></a>01236     
<a name="l01237"></a>01237       stinf = (stack_info_t *)&amp;frm-&gt;data.p;
<a name="l01238"></a>01238     
<a name="l01239"></a>01239       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(8, port, <span class="stringliteral">&quot; --&gt; Child %x\n&quot;</span>,stinf-&gt;child[bidx]);
<a name="l01240"></a>01240    }
<a name="l01241"></a>01241   
<a name="l01242"></a>01242    <span class="keywordflow">return</span> 0;
<a name="l01243"></a>01243 }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245 
<a name="l01246"></a>01246 
<a name="l01247"></a><a class="code" href="isdn__lib_8c.html#a3f9047004fc7ad138acb1b4f43f64ac0">01247</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *<a class="code" href="isdn__lib_8c.html#a3f9047004fc7ad138acb1b4f43f64ac0">stack_init</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, <span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="keywordtype">int</span> <a class="code" href="misdn__config_8c.html#a8811c37f1bf155dadba8ae3dfb0fdfee">ptp</a>)
<a name="l01248"></a>01248 {
<a name="l01249"></a>01249    <span class="keywordtype">int</span> ret;
<a name="l01250"></a>01250    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="chan__unistim_8c.html#af30c10a8c6ed3d4649cfdc61e2029dc3">buff</a>[1025];
<a name="l01251"></a>01251    iframe_t *frm = (iframe_t *)buff;
<a name="l01252"></a>01252    stack_info_t *stinf;
<a name="l01253"></a>01253    <span class="keywordtype">int</span> i; 
<a name="l01254"></a>01254    layer_info_t li;
<a name="l01255"></a>01255 
<a name="l01256"></a>01256    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack = <a class="code" href="astmm_8h.html#ab8b25cd8f16d4a6552afe4e65c4f082d">malloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a>));
<a name="l01257"></a>01257    <span class="keywordflow">if</span> (!stack ) <span class="keywordflow">return</span> NULL;
<a name="l01258"></a>01258 
<a name="l01259"></a>01259 
<a name="l01260"></a>01260    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(8, port, <span class="stringliteral">&quot;Init. Stack.\n&quot;</span>);
<a name="l01261"></a>01261   
<a name="l01262"></a>01262    memset(stack,0,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a>));
<a name="l01263"></a>01263   
<a name="l01264"></a>01264    <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="isdn__lib_8h.html#a90726efd784d5cc679ad2e1160b5dc2f">MAX_BCHANS</a> + 1; i++ ) stack-&gt;<a class="code" href="structmisdn__stack.html#a0ccea073ca7f2de1fc50d383ef5dd967" title="Array of B channels in use (a[0] = B1). TRUE if B channel in use.">channels</a>[i]=0;
<a name="l01265"></a>01265    
<a name="l01266"></a>01266    stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>=port;
<a name="l01267"></a>01267    stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>=midev;
<a name="l01268"></a>01268    stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a>=ptp;
<a name="l01269"></a>01269   
<a name="l01270"></a>01270    stack-&gt;<a class="code" href="structmisdn__stack.html#a406ae8ad1276496c0fa46acf9814e366" title="List of held channels.">holding</a>=NULL;
<a name="l01271"></a>01271    stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a>=0;
<a name="l01272"></a>01272   
<a name="l01273"></a>01273    msg_queue_init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a22a2136dedb63955d062cead263b809f" title="Queue of Event messages to send to mISDN.">downqueue</a>);
<a name="l01274"></a>01274    msg_queue_init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a8c19dab645a65e0caf1924c1bcce7f1d">upqueue</a>);
<a name="l01275"></a>01275 
<a name="l01276"></a>01276    <a class="code" href="lock_8h.html#ad7693eb0c23d9649f82992b785ddbe4e">pthread_mutex_init</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>, NULL);
<a name="l01277"></a>01277   
<a name="l01278"></a>01278    <span class="comment">/* query port&apos;s requirements */</span>
<a name="l01279"></a>01279    ret = mISDN_get_stack_info(midev, port, buff, <span class="keyword">sizeof</span>(buff));
<a name="l01280"></a>01280    <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l01281"></a>01281       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;%s: Cannot get stack info for this port. (ret=%d)\n&quot;</span>, __FUNCTION__, ret);
<a name="l01282"></a>01282       <span class="keywordflow">return</span>(NULL);
<a name="l01283"></a>01283    }
<a name="l01284"></a>01284   
<a name="l01285"></a>01285    stinf = (stack_info_t *)&amp;frm-&gt;data.p;
<a name="l01286"></a>01286 
<a name="l01287"></a>01287    stack-&gt;<a class="code" href="structmisdn__stack.html#af820f8cddb26fe90f6da9cdef9c1cc94" title="D Channel mISDN driver stack ID (Parent stack ID).">d_stid</a> = stinf-&gt;id;
<a name="l01288"></a>01288    stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a> = stinf-&gt;childcnt;
<a name="l01289"></a>01289 
<a name="l01290"></a>01290    for (i=0; i&lt;=stinf-&gt;childcnt; i++)
<a name="l01291"></a>01291       stack-&gt;<a class="code" href="structmisdn__stack.html#a257ff184f091881cb6bfb73bc8a181d0" title="B Channel mISDN driver stack IDs (Child stack IDs).">b_stids</a>[i] = stinf-&gt;child[i];
<a name="l01292"></a>01292   
<a name="l01293"></a>01293    <span class="keywordflow">switch</span>(stinf-&gt;pid.protocol[0] &amp; ~ISDN_PID_FEATURE_MASK) {
<a name="l01294"></a>01294    <span class="keywordflow">case</span> ISDN_PID_L0_TE_S0:
<a name="l01295"></a>01295       stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>=0;
<a name="l01296"></a>01296       <span class="keywordflow">break</span>;
<a name="l01297"></a>01297    <span class="keywordflow">case</span> ISDN_PID_L0_NT_S0:
<a name="l01298"></a>01298       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(8, port, <span class="stringliteral">&quot;NT Stack\n&quot;</span>);
<a name="l01299"></a>01299 
<a name="l01300"></a>01300       stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>=1;
<a name="l01301"></a>01301       <span class="keywordflow">break</span>;
<a name="l01302"></a>01302    <span class="keywordflow">case</span> ISDN_PID_L0_TE_E1:
<a name="l01303"></a>01303       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(8, port, <span class="stringliteral">&quot;TE S2M Stack\n&quot;</span>);
<a name="l01304"></a>01304       stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>=0;
<a name="l01305"></a>01305       stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a>=1;
<a name="l01306"></a>01306       <span class="keywordflow">break</span>;
<a name="l01307"></a>01307    <span class="keywordflow">case</span> ISDN_PID_L0_NT_E1:
<a name="l01308"></a>01308       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(8, port, <span class="stringliteral">&quot;TE S2M Stack\n&quot;</span>);
<a name="l01309"></a>01309       stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>=1;
<a name="l01310"></a>01310       stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a>=1;
<a name="l01311"></a>01311       
<a name="l01312"></a>01312       <span class="keywordflow">break</span>;
<a name="l01313"></a>01313    <span class="keywordflow">default</span>:
<a name="l01314"></a>01314       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;this is a unknown port type 0x%08x\n&quot;</span>, stinf-&gt;pid.protocol[0]);
<a name="l01315"></a>01315 
<a name="l01316"></a>01316    }
<a name="l01317"></a>01317 
<a name="l01318"></a>01318    <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) {
<a name="l01319"></a>01319       <span class="keywordflow">if</span> (stinf-&gt;pid.protocol[2] &amp; ISDN_PID_L2_DF_PTP ) { 
<a name="l01320"></a>01320          stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a> = 1;
<a name="l01321"></a>01321       } <span class="keywordflow">else</span> {
<a name="l01322"></a>01322          stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a> = 0;
<a name="l01323"></a>01323       }
<a name="l01324"></a>01324    }
<a name="l01325"></a>01325    
<a name="l01326"></a>01326    {
<a name="l01327"></a>01327       <span class="keywordtype">int</span> ret;
<a name="l01328"></a>01328       <span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>;
<a name="l01329"></a>01329 
<a name="l01330"></a>01330       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(8, port, <span class="stringliteral">&quot;Init. Stack.\n&quot;</span>);
<a name="l01331"></a>01331       
<a name="l01332"></a>01332       memset(&amp;li, 0, <span class="keyword">sizeof</span>(li));
<a name="l01333"></a>01333       {
<a name="l01334"></a>01334          <span class="keywordtype">int</span> l = <span class="keyword">sizeof</span>(li.name);
<a name="l01335"></a>01335          strncpy(li.name,nt?<span class="stringliteral">&quot;net l2&quot;</span>:<span class="stringliteral">&quot;user l4&quot;</span>, l);
<a name="l01336"></a>01336          li.name[l-1] = 0;
<a name="l01337"></a>01337       }
<a name="l01338"></a>01338       li.object_id = -1;
<a name="l01339"></a>01339       li.extentions = 0;
<a name="l01340"></a>01340       li.pid.protocol[nt?2:4] = nt?ISDN_PID_L2_LAPD_NET:ISDN_PID_L4_CAPI20;
<a name="l01341"></a>01341       li.pid.layermask = ISDN_LAYER((nt?2:4));
<a name="l01342"></a>01342       li.st = stack-&gt;<a class="code" href="structmisdn__stack.html#af820f8cddb26fe90f6da9cdef9c1cc94" title="D Channel mISDN driver stack ID (Parent stack ID).">d_stid</a>;
<a name="l01343"></a>01343       
<a name="l01344"></a>01344       
<a name="l01345"></a>01345       ret = mISDN_new_layer(midev, &amp;li);
<a name="l01346"></a>01346       <span class="keywordflow">if</span> (ret) {
<a name="l01347"></a>01347          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;%s: Cannot add layer %d to this port.\n&quot;</span>, __FUNCTION__, nt?2:4);
<a name="l01348"></a>01348          <span class="keywordflow">return</span>(NULL);
<a name="l01349"></a>01349       }
<a name="l01350"></a>01350       
<a name="l01351"></a>01351       
<a name="l01352"></a>01352       stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a> = li.id;
<a name="l01353"></a>01353       ret = mISDN_register_layer(midev, stack-&gt;<a class="code" href="structmisdn__stack.html#af820f8cddb26fe90f6da9cdef9c1cc94" title="D Channel mISDN driver stack ID (Parent stack ID).">d_stid</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a>);
<a name="l01354"></a>01354       <span class="keywordflow">if</span> (ret)
<a name="l01355"></a>01355       {
<a name="l01356"></a>01356          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,port,<span class="stringliteral">&quot;Cannot register layer %d of this port.\n&quot;</span>, nt?2:4);
<a name="l01357"></a>01357          <span class="keywordflow">return</span>(NULL);
<a name="l01358"></a>01358       }
<a name="l01359"></a>01359       
<a name="l01360"></a>01360       stack-&gt;<a class="code" href="structmisdn__stack.html#aa2ae4f87975bbc69517aa3bc328e91c0" title="Lower layer mISDN ID (addr) (Layer 1/3).">lower_id</a> = mISDN_get_layerid(midev, stack-&gt;<a class="code" href="structmisdn__stack.html#af820f8cddb26fe90f6da9cdef9c1cc94" title="D Channel mISDN driver stack ID (Parent stack ID).">d_stid</a>, nt?1:3); 
<a name="l01361"></a>01361       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aa2ae4f87975bbc69517aa3bc328e91c0" title="Lower layer mISDN ID (addr) (Layer 1/3).">lower_id</a> &lt; 0) {
<a name="l01362"></a>01362          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;%s: Cannot get layer(%d) id of this port.\n&quot;</span>, __FUNCTION__, nt?1:3);
<a name="l01363"></a>01363          <span class="keywordflow">return</span>(NULL);
<a name="l01364"></a>01364       }
<a name="l01365"></a>01365       
<a name="l01366"></a>01366       stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a> = mISDN_get_layerid(midev, stack-&gt;<a class="code" href="structmisdn__stack.html#af820f8cddb26fe90f6da9cdef9c1cc94" title="D Channel mISDN driver stack ID (Parent stack ID).">d_stid</a>, nt?2:4);
<a name="l01367"></a>01367       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a> &lt; 0) {
<a name="l01368"></a>01368          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;%s: Cannot get layer(%d) id of this port.\n&quot;</span>, __FUNCTION__, 2);
<a name="l01369"></a>01369          <span class="keywordflow">return</span>(NULL);
<a name="l01370"></a>01370       }
<a name="l01371"></a>01371       
<a name="l01372"></a>01372       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(8, port, <span class="stringliteral">&quot;NT Stacks upper_id %x\n&quot;</span>,stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a>);
<a name="l01373"></a>01373       
<a name="l01374"></a>01374       
<a name="l01375"></a>01375       <span class="comment">/* create nst (nt-mode only) */</span>
<a name="l01376"></a>01376       <span class="keywordflow">if</span> (nt) {
<a name="l01377"></a>01377          
<a name="l01378"></a>01378          memset(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>, 0, <span class="keyword">sizeof</span>(net_stack_t));
<a name="l01379"></a>01379          memset(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a0bdc24d4d5181fb244f8c409805bb7d2">mgr</a>, 0, <span class="keyword">sizeof</span>(manager_t));
<a name="l01380"></a>01380     
<a name="l01381"></a>01381          stack-&gt;<a class="code" href="structmisdn__stack.html#a0bdc24d4d5181fb244f8c409805bb7d2">mgr</a>.nst = &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>;
<a name="l01382"></a>01382          stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.manager = &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a0bdc24d4d5181fb244f8c409805bb7d2">mgr</a>;
<a name="l01383"></a>01383     
<a name="l01384"></a>01384          stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.l3_manager = <a class="code" href="isdn__lib_8c.html#a337b0dfa9c48d2177f26a30278742186">handle_event_nt</a>;
<a name="l01385"></a>01385          stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.device = midev;
<a name="l01386"></a>01386          stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.cardnr = port;
<a name="l01387"></a>01387          stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.d_stid = stack-&gt;<a class="code" href="structmisdn__stack.html#af820f8cddb26fe90f6da9cdef9c1cc94" title="D Channel mISDN driver stack ID (Parent stack ID).">d_stid</a>;
<a name="l01388"></a>01388     
<a name="l01389"></a>01389          stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.feature = FEATURE_NET_HOLD;
<a name="l01390"></a>01390          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a>)
<a name="l01391"></a>01391             stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.feature |= FEATURE_NET_PTP;
<a name="l01392"></a>01392          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a>)
<a name="l01393"></a>01393             stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.feature |= FEATURE_NET_CRLEN2 | FEATURE_NET_EXTCID;
<a name="l01394"></a>01394          
<a name="l01395"></a>01395          stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.l1_id = stack-&gt;<a class="code" href="structmisdn__stack.html#aa2ae4f87975bbc69517aa3bc328e91c0" title="Lower layer mISDN ID (addr) (Layer 1/3).">lower_id</a>;
<a name="l01396"></a>01396          stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.l2_id = stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a>;
<a name="l01397"></a>01397          
<a name="l01398"></a>01398          msg_queue_init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.down_queue);
<a name="l01399"></a>01399          <a class="code" href="lock_8h.html#ad7693eb0c23d9649f82992b785ddbe4e">pthread_mutex_init</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>, NULL);
<a name="l01400"></a>01400          
<a name="l01401"></a>01401          Isdnl2Init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>);
<a name="l01402"></a>01402          Isdnl3Init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>);
<a name="l01403"></a>01403          
<a name="l01404"></a>01404       } 
<a name="l01405"></a>01405       
<a name="l01406"></a>01406       <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) {
<a name="l01407"></a>01407          <span class="comment">/*assume L1 is up, we&apos;ll get DEACTIVATES soon, for non</span>
<a name="l01408"></a>01408 <span class="comment">          * up L1s*/</span>
<a name="l01409"></a>01409          stack-&gt;<a class="code" href="structmisdn__stack.html#a579e76479941e4610b630ada968ae5e2" title="TRUE if Layer 1 is UP.">l1link</a>=0;
<a name="l01410"></a>01410       }
<a name="l01411"></a>01411       stack-&gt;<a class="code" href="structmisdn__stack.html#a579e76479941e4610b630ada968ae5e2" title="TRUE if Layer 1 is UP.">l1link</a>=0;
<a name="l01412"></a>01412       stack-&gt;<a class="code" href="structmisdn__stack.html#a2f51cb4d0630a299b4e436c7471eea21" title="TRUE if Layer 2 is UP.">l2link</a>=0;
<a name="l01413"></a>01413 <span class="preprocessor">#if 0 </span>
<a name="l01414"></a>01414 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) {
<a name="l01415"></a>01415          <a class="code" href="isdn__lib_8c.html#a7dcc4196f1ee5793afa5bf53dbcb11c1">misdn_lib_get_short_status</a>(stack);
<a name="l01416"></a>01416       } <span class="keywordflow">else</span> {
<a name="l01417"></a>01417          <a class="code" href="isdn__lib_8c.html#a4af2f7ae2eb8c3746985df5544d17203">misdn_lib_get_l1_up</a>(stack);
<a name="l01418"></a>01418          <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a>) <a class="code" href="isdn__lib_8c.html#a4af2f7ae2eb8c3746985df5544d17203">misdn_lib_get_l1_up</a>(stack);
<a name="l01419"></a>01419          <a class="code" href="isdn__lib_8c.html#af03ad57836b38845f685368e60625707">misdn_lib_get_l2_up</a>(stack);
<a name="l01420"></a>01420       }
<a name="l01421"></a>01421 <span class="preprocessor">#endif</span>
<a name="l01422"></a>01422 <span class="preprocessor"></span>
<a name="l01423"></a>01423       <a class="code" href="isdn__lib_8c.html#a7dcc4196f1ee5793afa5bf53dbcb11c1">misdn_lib_get_short_status</a>(stack);
<a name="l01424"></a>01424       <a class="code" href="isdn__lib_8c.html#a4af2f7ae2eb8c3746985df5544d17203">misdn_lib_get_l1_up</a>(stack);
<a name="l01425"></a>01425       <a class="code" href="isdn__lib_8c.html#af03ad57836b38845f685368e60625707">misdn_lib_get_l2_up</a>(stack); 
<a name="l01426"></a>01426       
<a name="l01427"></a>01427    }
<a name="l01428"></a>01428 
<a name="l01429"></a>01429    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(8,0,<span class="stringliteral">&quot;stack_init: port:%d lowerId:%x  upperId:%x\n&quot;</span>,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,stack-&gt;<a class="code" href="structmisdn__stack.html#aa2ae4f87975bbc69517aa3bc328e91c0" title="Lower layer mISDN ID (addr) (Layer 1/3).">lower_id</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a>);
<a name="l01430"></a>01430    
<a name="l01431"></a>01431    <span class="keywordflow">return</span> stack;
<a name="l01432"></a>01432 }
<a name="l01433"></a>01433 
<a name="l01434"></a>01434 
<a name="l01435"></a><a class="code" href="isdn__lib_8c.html#a87902d7e550c8bd1b03317345e44b9c5">01435</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a87902d7e550c8bd1b03317345e44b9c5">stack_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l01436"></a>01436 {
<a name="l01437"></a>01437    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[1024];
<a name="l01438"></a>01438    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span>;
<a name="l01439"></a>01439 
<a name="l01440"></a>01440    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) {
<a name="l01441"></a>01441       <a class="code" href="lock_8h.html#abda856b9d567d956a04e1dd3139acc40">pthread_mutex_destroy</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l01442"></a>01442       cleanup_Isdnl2(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>);
<a name="l01443"></a>01443       cleanup_Isdnl3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>);
<a name="l01444"></a>01444    }
<a name="l01445"></a>01445   
<a name="l01446"></a>01446    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aa2ae4f87975bbc69517aa3bc328e91c0" title="Lower layer mISDN ID (addr) (Layer 1/3).">lower_id</a>) 
<a name="l01447"></a>01447       mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, buf, stack-&gt;<a class="code" href="structmisdn__stack.html#aa2ae4f87975bbc69517aa3bc328e91c0" title="Lower layer mISDN ID (addr) (Layer 1/3).">lower_id</a>, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l01448"></a>01448 
<a name="l01449"></a>01449    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a>) 
<a name="l01450"></a>01450       mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, buf, stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a>, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l01451"></a>01451 
<a name="l01452"></a>01452    <a class="code" href="lock_8h.html#abda856b9d567d956a04e1dd3139acc40">pthread_mutex_destroy</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>);
<a name="l01453"></a>01453 }
<a name="l01454"></a>01454 
<a name="l01455"></a>01455 
<a name="l01456"></a><a class="code" href="isdn__lib_8c.html#a7db594d519df4dae7eb3dbd1b128d6f8">01456</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> * <a class="code" href="isdn__lib_8c.html#a7db594d519df4dae7eb3dbd1b128d6f8">find_stack_by_addr</a>(<span class="keywordtype">int</span>  addr)
<a name="l01457"></a>01457 {
<a name="l01458"></a>01458    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l01459"></a>01459    
<a name="l01460"></a>01460    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>;
<a name="l01461"></a>01461         stack;
<a name="l01462"></a>01462         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l01463"></a>01463       <span class="keywordflow">if</span> ( (stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a>&amp;STACK_ID_MASK) == (addr&amp;STACK_ID_MASK)) <span class="keywordflow">return</span> stack;
<a name="l01464"></a>01464 
<a name="l01465"></a>01465    }
<a name="l01466"></a>01466   
<a name="l01467"></a>01467    <span class="keywordflow">return</span> NULL;
<a name="l01468"></a>01468 }
<a name="l01469"></a>01469 
<a name="l01470"></a>01470 
<a name="l01471"></a><a class="code" href="isdn__lib_8c.html#a440118240f78921a8727b1587ce959b0">01471</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> * <a class="code" href="isdn__lib_8c.html#a440118240f78921a8727b1587ce959b0">find_stack_by_port</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>)
<a name="l01472"></a>01472 {
<a name="l01473"></a>01473    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l01474"></a>01474   
<a name="l01475"></a>01475    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>;
<a name="l01476"></a>01476         stack;
<a name="l01477"></a>01477         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) 
<a name="l01478"></a>01478       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) <span class="keywordflow">return</span> stack;
<a name="l01479"></a>01479   
<a name="l01480"></a>01480    <span class="keywordflow">return</span> NULL;
<a name="l01481"></a>01481 }
<a name="l01482"></a>01482 
<a name="l01483"></a><a class="code" href="isdn__lib_8c.html#a69a08642538651e801328b124e732651">01483</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> * <a class="code" href="isdn__lib_8c.html#a69a08642538651e801328b124e732651">find_stack_by_mgr</a>(manager_t* mgr_nt)
<a name="l01484"></a>01484 {
<a name="l01485"></a>01485    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l01486"></a>01486   
<a name="l01487"></a>01487    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>;
<a name="l01488"></a>01488         stack;
<a name="l01489"></a>01489         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) 
<a name="l01490"></a>01490       <span class="keywordflow">if</span> ( &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a0bdc24d4d5181fb244f8c409805bb7d2">mgr</a> == mgr_nt) <span class="keywordflow">return</span> stack;
<a name="l01491"></a>01491   
<a name="l01492"></a>01492    <span class="keywordflow">return</span> NULL;
<a name="l01493"></a>01493 }
<a name="l01494"></a>01494 
<a name="l01495"></a><a class="code" href="isdn__lib_8c.html#ac3392b1dd6f36d98faf116f8f5323d59">01495</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#ac3392b1dd6f36d98faf116f8f5323d59">find_bc_by_masked_l3id</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l3id, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> mask)
<a name="l01496"></a>01496 {
<a name="l01497"></a>01497    <span class="keywordtype">int</span> i;
<a name="l01498"></a>01498 
<a name="l01499"></a>01499    <span class="keywordflow">for</span> (i = 0; i &lt;= stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; i++) {
<a name="l01500"></a>01500       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a> &amp;&amp; (stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a> &amp; mask) == (l3id &amp; mask)) {
<a name="l01501"></a>01501          <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i];
<a name="l01502"></a>01502       }
<a name="l01503"></a>01503    }
<a name="l01504"></a>01504    <span class="keywordflow">return</span> <a class="code" href="isdn__lib_8c.html#a6ae22b9108f567d7bae369dc17c65062">stack_holder_find</a>(stack,l3id);
<a name="l01505"></a>01505 }
<a name="l01506"></a>01506 
<a name="l01507"></a>01507 
<a name="l01508"></a><a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">01508</a> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l3id)
<a name="l01509"></a>01509 {
<a name="l01510"></a>01510    <span class="keywordtype">int</span> i;
<a name="l01511"></a>01511 
<a name="l01512"></a>01512    <span class="keywordflow">for</span> (i = 0; i &lt;= stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; i++) {
<a name="l01513"></a>01513       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a> &amp;&amp; stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a> == l3id) {
<a name="l01514"></a>01514          <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i];
<a name="l01515"></a>01515       }
<a name="l01516"></a>01516    }
<a name="l01517"></a>01517    <span class="keywordflow">return</span> <a class="code" href="isdn__lib_8c.html#a6ae22b9108f567d7bae369dc17c65062">stack_holder_find</a>(stack,l3id);
<a name="l01518"></a>01518 }
<a name="l01519"></a>01519 
<a name="l01520"></a><a class="code" href="isdn__lib_8c.html#af2764eaebbffa1c0141a0abd2991fab3">01520</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#af2764eaebbffa1c0141a0abd2991fab3">find_bc_by_addr</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>)
<a name="l01521"></a>01521 {
<a name="l01522"></a>01522    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l01523"></a>01523    <span class="keywordtype">int</span> i;
<a name="l01524"></a>01524 
<a name="l01525"></a>01525    <span class="keywordflow">for</span> (stack = glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>; stack; stack = stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l01526"></a>01526       <span class="keywordflow">for</span> (i = 0; i &lt;= stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; i++) {
<a name="l01527"></a>01527          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a>
<a name="l01528"></a>01528             &amp;&amp; ((stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> &amp; STACK_ID_MASK) == (addr &amp; STACK_ID_MASK)
<a name="l01529"></a>01529                || stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#ad3f99071e2a45a0a256d33c018950293" title="B Channel mISDN driver layer ID from mISDN_new_layer().">layer_id</a> == addr)) {
<a name="l01530"></a>01530             <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i];
<a name="l01531"></a>01531          }
<a name="l01532"></a>01532       }
<a name="l01533"></a>01533    }
<a name="l01534"></a>01534    
<a name="l01535"></a>01535    <span class="keywordflow">return</span> NULL;
<a name="l01536"></a>01536 }
<a name="l01537"></a>01537 
<a name="l01538"></a><a class="code" href="isdn__lib_8c.html#ab6f6b56683e60c20c5adebda999718d4">01538</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#ab6f6b56683e60c20c5adebda999718d4">find_bc_by_confid</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> confid)
<a name="l01539"></a>01539 {
<a name="l01540"></a>01540    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l01541"></a>01541    <span class="keywordtype">int</span> i;
<a name="l01542"></a>01542    
<a name="l01543"></a>01543    <span class="keywordflow">for</span> (stack = glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>; stack; stack = stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l01544"></a>01544       <span class="keywordflow">for</span> (i = 0; i &lt;= stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; i++) {
<a name="l01545"></a>01545          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a> &amp;&amp; stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#aab0f7344f706b822f3aeab3e328793d0" title="Bridging conference ID.">conf_id</a> == confid) {
<a name="l01546"></a>01546             <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i];
<a name="l01547"></a>01547          }
<a name="l01548"></a>01548       }
<a name="l01549"></a>01549    }
<a name="l01550"></a>01550    <span class="keywordflow">return</span> NULL;
<a name="l01551"></a>01551 }
<a name="l01552"></a>01552 
<a name="l01553"></a>01553 
<a name="l01554"></a><a class="code" href="isdn__lib_8c.html#ac8166c295a460811db716afa8ff5d036">01554</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#ac8166c295a460811db716afa8ff5d036">find_bc_by_channel</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>)
<a name="l01555"></a>01555 {
<a name="l01556"></a>01556    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack = <a class="code" href="isdn__lib_8c.html#a440118240f78921a8727b1587ce959b0">find_stack_by_port</a>(port);
<a name="l01557"></a>01557    <span class="keywordtype">int</span> i;
<a name="l01558"></a>01558 
<a name="l01559"></a>01559    <span class="keywordflow">if</span> (!stack) {
<a name="l01560"></a>01560       <span class="keywordflow">return</span> NULL;
<a name="l01561"></a>01561    }
<a name="l01562"></a>01562    
<a name="l01563"></a>01563    <span class="keywordflow">for</span> (i = 0; i &lt;= stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; i++) {
<a name="l01564"></a>01564       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a> &amp;&amp; stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> == channel) {
<a name="l01565"></a>01565          <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i];
<a name="l01566"></a>01566       }
<a name="l01567"></a>01567    }
<a name="l01568"></a>01568       
<a name="l01569"></a>01569    <span class="keywordflow">return</span> NULL;
<a name="l01570"></a>01570 }
<a name="l01571"></a>01571 
<a name="l01572"></a>01572 
<a name="l01573"></a>01573 
<a name="l01574"></a>01574 
<a name="l01575"></a>01575 
<a name="l01576"></a><a class="code" href="isdn__lib_8c.html#aa14033d61f7f3192cbf76c6b1d76dd49">01576</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#aa14033d61f7f3192cbf76c6b1d76dd49">handle_event</a> ( <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0">event_e</a> event, iframe_t *frm)
<a name="l01577"></a>01577 {
<a name="l01578"></a>01578    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l01579"></a>01579    
<a name="l01580"></a>01580    <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) {
<a name="l01581"></a>01581       
<a name="l01582"></a>01582       <span class="keywordflow">switch</span> (event) {
<a name="l01583"></a>01583 
<a name="l01584"></a>01584       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0ad0435294fbb8a6afc9e2713035d044ea">EVENT_CONNECT_ACKNOWLEDGE</a>:
<a name="l01585"></a>01585          <a class="code" href="isdn__lib_8c.html#a58b3989f0b5555f87f5c55fdefa8c6fb">setup_bc</a>(bc);
<a name="l01586"></a>01586 
<a name="l01587"></a>01587          <span class="keywordflow">if</span> ( *bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9aa37e2112fabf2ca6694c70d2f0ff24" title="Blowfish encryption key string (secret).">crypt_key</a> ) {
<a name="l01588"></a>01588             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;ENABLING BLOWFISH channel:%d oad%d:%s dad%d:%s\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aeea5d3e5d16496a8b3e35bdcf9faf3f0" title="Type-of-number in ISDN terms for the originating/calling number (Caller-ID).">onumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a8d2efe6f05b62dd9ce5153b822663083" title="Originating/Calling Phone Number (Address).">oad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a54e1096eacf895fbbee3b263b8a5af5a" title="Type-of-number in ISDN terms for the dialed/called number.">dnumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa306ec0dd386e28152b3f39d2a389402" title="Dialed/Called Phone Number (Address).">dad</a>);
<a name="l01589"></a>01589             <a class="code" href="isdn__lib_8c.html#a68056961358d38e2cef26ccf6c136a99">manager_ph_control_block</a>(bc,  BF_ENABLE_KEY, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9aa37e2112fabf2ca6694c70d2f0ff24" title="Blowfish encryption key string (secret).">crypt_key</a>, strlen(bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9aa37e2112fabf2ca6694c70d2f0ff24" title="Blowfish encryption key string (secret).">crypt_key</a>) );
<a name="l01590"></a>01590          }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592          <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#acaefa07620d12d0dc4f979c9e3c3f73e">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#afa05b14ff7f76f303c784c00c4c63fa7" title="SETUP message bearer capability field code value.">capability</a>)) {
<a name="l01593"></a>01593             <span class="keywordflow">if</span> (  !bc-&gt;<a class="code" href="structmisdn__bchannel.html#a134855bcd1a1ba0d1733faa7a4e94389" title="TRUE if we will not use jollys dsp.">nodsp</a>) <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc,  DTMF_TONE_START, 0);
<a name="l01594"></a>01594             <a class="code" href="isdn__lib_8c.html#a7e7944bc36ef8fe8e943ac12c2fea749">manager_ec_enable</a>(bc);
<a name="l01595"></a>01595 
<a name="l01596"></a>01596             <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#a709429a6031e18717677d5254d38586f" title="Tx gain setting (range -8 to 8).">txgain</a> != 0 ) {
<a name="l01597"></a>01597                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;--&gt; Changing txgain to %d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a709429a6031e18717677d5254d38586f" title="Tx gain setting (range -8 to 8).">txgain</a>);
<a name="l01598"></a>01598                <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, VOL_CHANGE_TX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a709429a6031e18717677d5254d38586f" title="Tx gain setting (range -8 to 8).">txgain</a>);
<a name="l01599"></a>01599             }
<a name="l01600"></a>01600             <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#a80d0395aae5582433d6b02af3f8c270a" title="Rx gain setting (range -8 to 8).">rxgain</a> != 0 ) {
<a name="l01601"></a>01601                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;--&gt; Changing rxgain to %d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a80d0395aae5582433d6b02af3f8c270a" title="Rx gain setting (range -8 to 8).">rxgain</a>);
<a name="l01602"></a>01602                <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, VOL_CHANGE_RX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a80d0395aae5582433d6b02af3f8c270a" title="Rx gain setting (range -8 to 8).">rxgain</a>);
<a name="l01603"></a>01603             }
<a name="l01604"></a>01604          }
<a name="l01605"></a>01605 
<a name="l01606"></a>01606          <span class="keywordflow">break</span>;
<a name="l01607"></a>01607       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a9d1a3f3e4b462e571e5485570ee63adb">EVENT_CONNECT</a>:
<a name="l01608"></a>01608 
<a name="l01609"></a>01609          <span class="keywordflow">if</span> ( *bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9aa37e2112fabf2ca6694c70d2f0ff24" title="Blowfish encryption key string (secret).">crypt_key</a> ) {
<a name="l01610"></a>01610             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;ENABLING BLOWFISH channel:%d oad%d:%s dad%d:%s\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aeea5d3e5d16496a8b3e35bdcf9faf3f0" title="Type-of-number in ISDN terms for the originating/calling number (Caller-ID).">onumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a8d2efe6f05b62dd9ce5153b822663083" title="Originating/Calling Phone Number (Address).">oad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a54e1096eacf895fbbee3b263b8a5af5a" title="Type-of-number in ISDN terms for the dialed/called number.">dnumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa306ec0dd386e28152b3f39d2a389402" title="Dialed/Called Phone Number (Address).">dad</a>);
<a name="l01611"></a>01611             <a class="code" href="isdn__lib_8c.html#a68056961358d38e2cef26ccf6c136a99">manager_ph_control_block</a>(bc,  BF_ENABLE_KEY, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9aa37e2112fabf2ca6694c70d2f0ff24" title="Blowfish encryption key string (secret).">crypt_key</a>, strlen(bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9aa37e2112fabf2ca6694c70d2f0ff24" title="Blowfish encryption key string (secret).">crypt_key</a>) );
<a name="l01612"></a>01612          }
<a name="l01613"></a>01613       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a0de72a83490b9470ea743075273c82ed">EVENT_ALERTING</a>:
<a name="l01614"></a>01614       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a9edbfcbbe26666eab8693f9b070f1635">EVENT_PROGRESS</a>:
<a name="l01615"></a>01615       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0ae7a1bdce2a4a05df29bdd33b399592b9">EVENT_PROCEEDING</a>:
<a name="l01616"></a>01616       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a76e873730835e083066b5b1e48e7f97a">EVENT_SETUP_ACKNOWLEDGE</a>:
<a name="l01617"></a>01617       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a71b67c9dd659e015ff13d68c2d3ea2aa">EVENT_SETUP</a>:
<a name="l01618"></a>01618       {
<a name="l01619"></a>01619          <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> == 0xff || bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>&lt;=0)
<a name="l01620"></a>01620             bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>=0;
<a name="l01621"></a>01621 
<a name="l01622"></a>01622          <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a67727c8665c79737a5e7ffd7a524934a">find_free_chan_in_stack</a>(stack, bc, bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>, 0)&lt;0){
<a name="l01623"></a>01623             <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a> &amp;&amp; !stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a>)  {
<a name="l01624"></a>01624                bc-&gt;<a class="code" href="structmisdn__bchannel.html#a0e234074dd9e6208d65dcd4230827898" title="TRUE if call waiting.">cw</a>=1;
<a name="l01625"></a>01625                <span class="keywordflow">break</span>;
<a name="l01626"></a>01626             }
<a name="l01627"></a>01627 
<a name="l01628"></a>01628             <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>)
<a name="l01629"></a>01629                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Any Channel Requested, but we have no more!!\n&quot;</span>);
<a name="l01630"></a>01630             <span class="keywordflow">else</span> 
<a name="l01631"></a>01631                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,
<a name="l01632"></a>01632                   <span class="stringliteral">&quot;Requested Channel Already in Use releasing this call with cause %d!!!!\n&quot;</span>,
<a name="l01633"></a>01633                   bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1b724daeb32d8d023765605586269a02" title="Q.931 Cause for disconnection code (sent).">out_cause</a>);
<a name="l01634"></a>01634 
<a name="l01635"></a>01635             <span class="comment">/* when the channel is already in use, we can&apos;t</span>
<a name="l01636"></a>01636 <span class="comment">             * simply clear it, we need to make sure that </span>
<a name="l01637"></a>01637 <span class="comment">             * it will still be marked as in_use in the </span>
<a name="l01638"></a>01638 <span class="comment">             * available channels list.*/</span>
<a name="l01639"></a>01639             bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>=0;
<a name="l01640"></a>01640 
<a name="l01641"></a>01641             <a class="code" href="isdn__lib_8c.html#a9b9f5e8fc32b68c5d1a0c28d7ee40fb3">misdn_lib_send_event</a>(bc,<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a2473594848bb5e1cb2eafb862337f51a">EVENT_RELEASE_COMPLETE</a>);
<a name="l01642"></a>01642             <span class="keywordflow">return</span> -1;
<a name="l01643"></a>01643          }
<a name="l01644"></a>01644       }
<a name="l01645"></a>01645 
<a name="l01646"></a>01646       <a class="code" href="isdn__lib_8c.html#a58b3989f0b5555f87f5c55fdefa8c6fb">setup_bc</a>(bc);
<a name="l01647"></a>01647       <span class="keywordflow">break</span>;
<a name="l01648"></a>01648 
<a name="l01649"></a>01649       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a2473594848bb5e1cb2eafb862337f51a">EVENT_RELEASE_COMPLETE</a>:
<a name="l01650"></a>01650       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0abe8648d8a43122eac550c72a1babcb07">EVENT_RELEASE</a>:
<a name="l01651"></a>01651          <span class="keywordflow">break</span>;
<a name="l01652"></a>01652       <span class="keywordflow">default</span>:
<a name="l01653"></a>01653          <span class="keywordflow">break</span>;
<a name="l01654"></a>01654       }
<a name="l01655"></a>01655    } <span class="keywordflow">else</span> {    <span class="comment">/** NT MODE **/</span>
<a name="l01656"></a>01656       
<a name="l01657"></a>01657    }
<a name="l01658"></a>01658    <span class="keywordflow">return</span> 0;
<a name="l01659"></a>01659 }
<a name="l01660"></a>01660 
<a name="l01661"></a><a class="code" href="isdn__lib_8c.html#a787e765292d60ac1cc701eec9939a210">01661</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a787e765292d60ac1cc701eec9939a210">handle_cr</a> ( <span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, iframe_t *frm)
<a name="l01662"></a>01662 {
<a name="l01663"></a>01663    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc;
<a name="l01664"></a>01664 
<a name="l01665"></a>01665    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span> -1;
<a name="l01666"></a>01666   
<a name="l01667"></a>01667    <span class="keywordflow">switch</span> (frm-&gt;prim) {
<a name="l01668"></a>01668    <span class="keywordflow">case</span> CC_NEW_CR|INDICATION:
<a name="l01669"></a>01669       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(7, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; lib: NEW_CR Ind with l3id:%x on this port.\n&quot;</span>,frm-&gt;dinfo);
<a name="l01670"></a>01670 
<a name="l01671"></a>01671       bc = <a class="code" href="isdn__lib_8c.html#aa0fb761776d759bbd96a56bf38fe8c06">misdn_lib_get_free_bc</a>(stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, 0, 1, 0);
<a name="l01672"></a>01672       <span class="keywordflow">if</span> (!bc) {
<a name="l01673"></a>01673          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; !! lib: No free channel!\n&quot;</span>);
<a name="l01674"></a>01674          <span class="keywordflow">return</span> -1;
<a name="l01675"></a>01675       }
<a name="l01676"></a>01676   
<a name="l01677"></a>01677       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(7, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; new_process: New L3Id: %x\n&quot;</span>,frm-&gt;dinfo);
<a name="l01678"></a>01678       bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>=frm-&gt;dinfo;
<a name="l01679"></a>01679       <span class="keywordflow">return</span> 1;
<a name="l01680"></a>01680    <span class="keywordflow">case</span> CC_NEW_CR|CONFIRM:
<a name="l01681"></a>01681       <span class="keywordflow">return</span> 1;
<a name="l01682"></a>01682    <span class="keywordflow">case</span> CC_NEW_CR|REQUEST:
<a name="l01683"></a>01683       <span class="keywordflow">return</span> 1;
<a name="l01684"></a>01684    <span class="keywordflow">case</span> CC_RELEASE_CR|REQUEST:
<a name="l01685"></a>01685       <span class="keywordflow">return</span> 1;
<a name="l01686"></a>01686    <span class="keywordflow">case</span> CC_RELEASE_CR|CONFIRM:
<a name="l01687"></a>01687       <span class="keywordflow">break</span>;
<a name="l01688"></a>01688    <span class="keywordflow">case</span> CC_RELEASE_CR|INDICATION:
<a name="l01689"></a>01689       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; lib: RELEASE_CR Ind with l3id:%x\n&quot;</span>,frm-&gt;dinfo);
<a name="l01690"></a>01690       {
<a name="l01691"></a>01691          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(stack, frm-&gt;dinfo);
<a name="l01692"></a>01692          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> dummybc;
<a name="l01693"></a>01693       
<a name="l01694"></a>01694          <span class="keywordflow">if</span> (!bc) {
<a name="l01695"></a>01695             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; Didn&apos;t find BC so temporarily creating dummy BC (l3id:%x) on this port.\n&quot;</span>, frm-&gt;dinfo);
<a name="l01696"></a>01696             <a class="code" href="isdn__lib_8c.html#aeb7cfd0342e0a820eb3d7302401c9c74">misdn_make_dummy</a>(&amp;dummybc, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, frm-&gt;dinfo, stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>, 0);
<a name="l01697"></a>01697             
<a name="l01698"></a>01698             bc=&amp;dummybc; 
<a name="l01699"></a>01699          }
<a name="l01700"></a>01700       
<a name="l01701"></a>01701          <span class="keywordflow">if</span> (bc) {
<a name="l01702"></a>01702             <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> = bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>;
<a name="l01703"></a>01703             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; lib: CLEANING UP l3id: %x\n&quot;</span>,frm-&gt;dinfo);
<a name="l01704"></a>01704 
<a name="l01705"></a>01705             <span class="comment">/*bc-&gt;pid = 0;*/</span>
<a name="l01706"></a>01706             bc-&gt;<a class="code" href="structmisdn__bchannel.html#a96296ec1ed855ce59e12762be480825b" title="TRUE if DISCONNECT needs to be sent to clear a call.">need_disconnect</a>=0;
<a name="l01707"></a>01707             bc-&gt;<a class="code" href="structmisdn__bchannel.html#aca6b8a790005c71e029e73fd5362007b" title="TRUE if RELEASE needs to be sent to clear a call.">need_release</a>=0;
<a name="l01708"></a>01708             bc-&gt;<a class="code" href="structmisdn__bchannel.html#a81790e7ee2b93373b0e048d0ef4c53bd" title="TRUE if RELEASE_COMPLETE needs to be sent to clear a call.">need_release_complete</a>=0;
<a name="l01709"></a>01709 
<a name="l01710"></a>01710             <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0ac49b8317168e8506edc0de2450658541">EVENT_CLEANUP</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l01711"></a>01711 
<a name="l01712"></a>01712             <a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">empty_bc</a>(bc);
<a name="l01713"></a>01713             <a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">clean_up_bc</a>(bc);
<a name="l01714"></a>01714 
<a name="l01715"></a>01715             <span class="keywordflow">if</span> (channel&gt;0)
<a name="l01716"></a>01716                <a class="code" href="isdn__lib_8c.html#a9f849e8a799ef7d6a52f6a10ec4446e5">empty_chan_in_stack</a>(stack,channel);
<a name="l01717"></a>01717             bc-&gt;<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a>=0;
<a name="l01718"></a>01718 
<a name="l01719"></a>01719             <a class="code" href="isdn__lib_8c.html#a82ebf7eee4e824dd341a39135a9dbf0b">dump_chan_list</a>(stack);
<a name="l01720"></a>01720 
<a name="l01721"></a>01721             <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#a94bf2beb01269f6feb818b5c2231537c" title="TRUE if this channel is on the misdn_stack-&amp;gt;holding list.">stack_holder</a>) {
<a name="l01722"></a>01722                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;REMOVING Holder\n&quot;</span>);
<a name="l01723"></a>01723                <a class="code" href="isdn__lib_8c.html#a658efc12f0e9b235f2266fff4743dfab">stack_holder_remove</a>( stack, bc);
<a name="l01724"></a>01724                <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(bc);
<a name="l01725"></a>01725             }
<a name="l01726"></a>01726          }
<a name="l01727"></a>01727          <span class="keywordflow">else</span> {
<a name="l01728"></a>01728             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) 
<a name="l01729"></a>01729                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;BC with dinfo: %x  not found.. (prim was %x and addr %x)\n&quot;</span>,frm-&gt;dinfo, frm-&gt;prim, frm-&gt;addr);
<a name="l01730"></a>01730          }
<a name="l01731"></a>01731       
<a name="l01732"></a>01732          <span class="keywordflow">return</span> 1;
<a name="l01733"></a>01733       }
<a name="l01734"></a>01734       <span class="keywordflow">break</span>;
<a name="l01735"></a>01735    }
<a name="l01736"></a>01736   
<a name="l01737"></a>01737    <span class="keywordflow">return</span> 0;
<a name="l01738"></a>01738 }
<a name="l01739"></a>01739 
<a name="l01740"></a>01740 
<a name="l01741"></a>01741 <span class="comment">/* Empties bc if it&apos;s reserved (no SETUP out yet) */</span>
<a name="l01742"></a><a class="code" href="isdn__lib_8h.html#afc3a516ffc421e9ded54345e2ed59248">01742</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#afc3a516ffc421e9ded54345e2ed59248">misdn_lib_release</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l01743"></a>01743 {
<a name="l01744"></a>01744    <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>;
<a name="l01745"></a>01745    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l01746"></a>01746 
<a name="l01747"></a>01747    <span class="keywordflow">if</span> (!stack) {
<a name="l01748"></a>01748       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1,0,<span class="stringliteral">&quot;misdn_release: No Stack found\n&quot;</span>);
<a name="l01749"></a>01749       <span class="keywordflow">return</span>;
<a name="l01750"></a>01750    }
<a name="l01751"></a>01751    
<a name="l01752"></a>01752    channel = bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>;
<a name="l01753"></a>01753    <a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">empty_bc</a>(bc);
<a name="l01754"></a>01754    <a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">clean_up_bc</a>(bc);
<a name="l01755"></a>01755    <span class="keywordflow">if</span> (channel &gt; 0) {
<a name="l01756"></a>01756       <a class="code" href="isdn__lib_8c.html#a9f849e8a799ef7d6a52f6a10ec4446e5">empty_chan_in_stack</a>(stack, channel);
<a name="l01757"></a>01757    }
<a name="l01758"></a>01758    bc-&gt;<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a>=0;
<a name="l01759"></a>01759 }
<a name="l01760"></a>01760 
<a name="l01761"></a>01761 
<a name="l01762"></a>01762 
<a name="l01763"></a>01763 
<a name="l01764"></a><a class="code" href="isdn__lib_8h.html#a35c0c233baff2379c5ab795e32964316">01764</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a35c0c233baff2379c5ab795e32964316">misdn_lib_get_port_up</a> (<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>) 
<a name="l01765"></a>01765 { <span class="comment">/* Pull Up L1 */</span> 
<a name="l01766"></a>01766    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l01767"></a>01767    
<a name="l01768"></a>01768    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>;
<a name="l01769"></a>01769         stack;
<a name="l01770"></a>01770         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l01771"></a>01771       
<a name="l01772"></a>01772       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) {
<a name="l01773"></a>01773 
<a name="l01774"></a>01774          <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#a579e76479941e4610b630ada968ae5e2" title="TRUE if Layer 1 is UP.">l1link</a>)
<a name="l01775"></a>01775             <a class="code" href="isdn__lib_8c.html#a4af2f7ae2eb8c3746985df5544d17203">misdn_lib_get_l1_up</a>(stack);
<a name="l01776"></a>01776          <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#a2f51cb4d0630a299b4e436c7471eea21" title="TRUE if Layer 2 is UP.">l2link</a>)
<a name="l01777"></a>01777             <a class="code" href="isdn__lib_8c.html#af03ad57836b38845f685368e60625707">misdn_lib_get_l2_up</a>(stack);
<a name="l01778"></a>01778          
<a name="l01779"></a>01779          <span class="keywordflow">return</span> 0;
<a name="l01780"></a>01780       }
<a name="l01781"></a>01781    }
<a name="l01782"></a>01782    <span class="keywordflow">return</span> 0;
<a name="l01783"></a>01783 }
<a name="l01784"></a>01784 
<a name="l01785"></a>01785 
<a name="l01786"></a><a class="code" href="isdn__lib_8h.html#a2bd1958952ab44d23665ef7b560562ad">01786</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a2bd1958952ab44d23665ef7b560562ad">misdn_lib_get_port_down</a> (<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>) 
<a name="l01787"></a>01787 { <span class="comment">/* Pull Down L1 */</span> 
<a name="l01788"></a>01788    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l01789"></a>01789    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>;
<a name="l01790"></a>01790         stack;
<a name="l01791"></a>01791         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l01792"></a>01792       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) {
<a name="l01793"></a>01793             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a2f51cb4d0630a299b4e436c7471eea21" title="TRUE if Layer 2 is UP.">l2link</a>)
<a name="l01794"></a>01794                <a class="code" href="isdn__lib_8c.html#aca6da100bec9aa446c5ccf22e6d894c6">misdn_lib_get_l2_down</a>(stack);
<a name="l01795"></a>01795             <a class="code" href="isdn__lib_8c.html#af5d84057ddf714f7329a057806fcd6f4">misdn_lib_get_l1_down</a>(stack);
<a name="l01796"></a>01796          <span class="keywordflow">return</span> 0;
<a name="l01797"></a>01797       }
<a name="l01798"></a>01798    }
<a name="l01799"></a>01799    <span class="keywordflow">return</span> 0;
<a name="l01800"></a>01800 }
<a name="l01801"></a>01801 
<a name="l01802"></a><a class="code" href="isdn__lib_8h.html#ae099fc7fbd4a6db83e1c042bbe8d4fbf">01802</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a6f06df375dc3530408a6c2f8488b2440">misdn_lib_port_up</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="keywordtype">int</span> check)
<a name="l01803"></a>01803 {
<a name="l01804"></a>01804    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l01805"></a>01805 
<a name="l01806"></a>01806 
<a name="l01807"></a>01807    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>;
<a name="l01808"></a>01808         stack;
<a name="l01809"></a>01809         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l01810"></a>01810       
<a name="l01811"></a>01811       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) {
<a name="l01812"></a>01812 
<a name="l01813"></a>01813          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#ac74e3d5a1b1eeb5c8e32867ad62823f0" title="TRUE if port is blocked.">blocked</a>) {
<a name="l01814"></a>01814             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,port, <span class="stringliteral">&quot;Port Blocked:%d L2:%d L1:%d\n&quot;</span>, stack-&gt;<a class="code" href="structmisdn__stack.html#ac74e3d5a1b1eeb5c8e32867ad62823f0" title="TRUE if port is blocked.">blocked</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#a2f51cb4d0630a299b4e436c7471eea21" title="TRUE if Layer 2 is UP.">l2link</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#a579e76479941e4610b630ada968ae5e2" title="TRUE if Layer 1 is UP.">l1link</a>);
<a name="l01815"></a>01815             <span class="keywordflow">return</span> -1;
<a name="l01816"></a>01816          }
<a name="l01817"></a>01817 
<a name="l01818"></a>01818          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a> ) {
<a name="l01819"></a>01819 
<a name="l01820"></a>01820             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a579e76479941e4610b630ada968ae5e2" title="TRUE if Layer 1 is UP.">l1link</a> &amp;&amp; stack-&gt;<a class="code" href="structmisdn__stack.html#a2f51cb4d0630a299b4e436c7471eea21" title="TRUE if Layer 2 is UP.">l2link</a>) {
<a name="l01821"></a>01821                <span class="keywordflow">return</span> 1;
<a name="l01822"></a>01822             } <span class="keywordflow">else</span> {
<a name="l01823"></a>01823                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1,port, <span class="stringliteral">&quot;Port Down L2:%d L1:%d\n&quot;</span>,
<a name="l01824"></a>01824                   stack-&gt;<a class="code" href="structmisdn__stack.html#a2f51cb4d0630a299b4e436c7471eea21" title="TRUE if Layer 2 is UP.">l2link</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#a579e76479941e4610b630ada968ae5e2" title="TRUE if Layer 1 is UP.">l1link</a>);
<a name="l01825"></a>01825                <span class="keywordflow">return</span> 0;
<a name="l01826"></a>01826             }
<a name="l01827"></a>01827          } <span class="keywordflow">else</span> {
<a name="l01828"></a>01828             <span class="keywordflow">if</span> ( !check || stack-&gt;<a class="code" href="structmisdn__stack.html#a579e76479941e4610b630ada968ae5e2" title="TRUE if Layer 1 is UP.">l1link</a> )
<a name="l01829"></a>01829                <span class="keywordflow">return</span> 1;
<a name="l01830"></a>01830             <span class="keywordflow">else</span> {
<a name="l01831"></a>01831                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1,port, <span class="stringliteral">&quot;Port down PMP\n&quot;</span>);
<a name="l01832"></a>01832                <span class="keywordflow">return</span> 0;
<a name="l01833"></a>01833             }
<a name="l01834"></a>01834          }
<a name="l01835"></a>01835       }
<a name="l01836"></a>01836    }
<a name="l01837"></a>01837   
<a name="l01838"></a>01838    <span class="keywordflow">return</span> -1;
<a name="l01839"></a>01839 }
<a name="l01840"></a>01840 
<a name="l01841"></a>01841 
<a name="l01842"></a><a class="code" href="isdn__lib_8c.html#a5ed5ed7382be41aad46e670f55825fcd">01842</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a5ed5ed7382be41aad46e670f55825fcd">release_cr</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, mISDNuser_head_t *hh)
<a name="l01843"></a>01843 {
<a name="l01844"></a>01844    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l01845"></a>01845    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> dummybc;
<a name="l01846"></a>01846    iframe_t frm; <span class="comment">/* fake te frm to remove callref from global callreflist */</span>
<a name="l01847"></a>01847    frm.dinfo = hh-&gt;dinfo;
<a name="l01848"></a>01848 
<a name="l01849"></a>01849    frm.<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a> | FLG_MSG_DOWN;
<a name="l01850"></a>01850 
<a name="l01851"></a>01851    frm.prim = CC_RELEASE_CR|INDICATION;
<a name="l01852"></a>01852    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; CC_RELEASE_CR: Faking Release_cr for %x l3id:%x\n&quot;</span>,frm.addr, frm.dinfo);<span class="comment"></span>
<a name="l01853"></a>01853 <span class="comment">   /** removing procid **/</span>
<a name="l01854"></a>01854    <span class="keywordflow">if</span> (!bc) {
<a name="l01855"></a>01855       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; Didn&apos;t find BC so temporarily creating dummy BC (l3id:%x) on this port.\n&quot;</span>, hh-&gt;dinfo);
<a name="l01856"></a>01856       <a class="code" href="isdn__lib_8c.html#aeb7cfd0342e0a820eb3d7302401c9c74">misdn_make_dummy</a>(&amp;dummybc, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, hh-&gt;dinfo, stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>, 0);
<a name="l01857"></a>01857       bc=&amp;dummybc; 
<a name="l01858"></a>01858    }
<a name="l01859"></a>01859 
<a name="l01860"></a>01860    <span class="keywordflow">if</span> (bc) {
<a name="l01861"></a>01861       <span class="keywordflow">if</span> ( (bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a> &amp; 0xff00) == 0xff00) {
<a name="l01862"></a>01862          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; Removing Process Id:%x on this port.\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>&amp;0xff);
<a name="l01863"></a>01863          stack-&gt;<a class="code" href="structmisdn__stack.html#af09226a0718361435f6aca5c31167166" title="CR Process ID allocation table. TRUE if ID allocated.">procids</a>[bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>&amp;0xff] = 0 ;
<a name="l01864"></a>01864       }
<a name="l01865"></a>01865    }
<a name="l01866"></a>01866    <span class="keywordflow">else</span> <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Couldn&apos;t find BC so I couldn&apos;t remove the Process!!!! this is a bad port.\n&quot;</span>);
<a name="l01867"></a>01867 
<a name="l01868"></a>01868    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a787e765292d60ac1cc701eec9939a210">handle_cr</a>(stack, &amp;frm)&lt;0) {
<a name="l01869"></a>01869    }
<a name="l01870"></a>01870 
<a name="l01871"></a>01871    <span class="keywordflow">return</span> 0 ;
<a name="l01872"></a>01872 }
<a name="l01873"></a>01873 
<a name="l01874"></a>01874 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01875"></a><a class="code" href="isdn__lib_8c.html#a337b0dfa9c48d2177f26a30278742186">01875</a> <a class="code" href="isdn__lib_8c.html#a337b0dfa9c48d2177f26a30278742186">handle_event_nt</a>(<span class="keywordtype">void</span> *dat, <span class="keywordtype">void</span> *arg)
<a name="l01876"></a>01876 {
<a name="l01877"></a>01877    manager_t *mgr = (manager_t *)dat;
<a name="l01878"></a>01878    msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a> = (msg_t *)arg;
<a name="l01879"></a>01879    mISDNuser_head_t *hh;
<a name="l01880"></a>01880    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l01881"></a>01881    <span class="keywordtype">int</span> reject=0;
<a name="l01882"></a>01882 
<a name="l01883"></a>01883    <span class="keywordflow">if</span> (!msg || !mgr)
<a name="l01884"></a>01884       <span class="keywordflow">return</span>(-EINVAL);
<a name="l01885"></a>01885 
<a name="l01886"></a>01886    stack = <a class="code" href="isdn__lib_8c.html#a69a08642538651e801328b124e732651">find_stack_by_mgr</a>(mgr);
<a name="l01887"></a>01887    hh=(mISDNuser_head_t*)msg-&gt;data;
<a name="l01888"></a>01888 
<a name="l01889"></a>01889    <span class="comment">/*</span>
<a name="l01890"></a>01890 <span class="comment">    * When we are called from the mISDNuser lib, the nstlock is held and it</span>
<a name="l01891"></a>01891 <span class="comment">    * must be held when we return.  We unlock here because the lib may be</span>
<a name="l01892"></a>01892 <span class="comment">    * entered again recursively.</span>
<a name="l01893"></a>01893 <span class="comment">    */</span>
<a name="l01894"></a>01894    <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l01895"></a>01895 
<a name="l01896"></a>01896    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; lib: prim %x dinfo %x\n&quot;</span>,hh-&gt;prim, hh-&gt;dinfo);
<a name="l01897"></a>01897    {
<a name="l01898"></a>01898       <span class="keywordflow">switch</span>(hh-&gt;prim){
<a name="l01899"></a>01899       <span class="keywordflow">case</span> CC_RETRIEVE|INDICATION:
<a name="l01900"></a>01900       {
<a name="l01901"></a>01901          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc;
<a name="l01902"></a>01902          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *hold_bc;
<a name="l01903"></a>01903 
<a name="l01904"></a>01904          iframe_t frm; <span class="comment">/* fake te frm to add callref to global callreflist */</span>
<a name="l01905"></a>01905          frm.dinfo = hh-&gt;dinfo;
<a name="l01906"></a>01906 
<a name="l01907"></a>01907          frm.<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a> | FLG_MSG_DOWN;
<a name="l01908"></a>01908 
<a name="l01909"></a>01909          frm.prim = CC_NEW_CR|INDICATION;
<a name="l01910"></a>01910          
<a name="l01911"></a>01911          <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a787e765292d60ac1cc701eec9939a210">handle_cr</a>( stack, &amp;frm)&lt; 0) {
<a name="l01912"></a>01912             msg_t *dmsg;
<a name="l01913"></a>01913             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Patch from MEIDANIS:Sending RELEASE_COMPLETE %x (No free Chan for you..)\n&quot;</span>, hh-&gt;dinfo);
<a name="l01914"></a>01914             dmsg = <a class="code" href="isdn__lib_8c.html#aee9bd3e9fc9e445d2aafcdecf91af352">create_l3msg</a>(CC_RELEASE_COMPLETE | REQUEST,MT_RELEASE_COMPLETE, hh-&gt;dinfo,<span class="keyword">sizeof</span>(RELEASE_COMPLETE_t), 1);
<a name="l01915"></a>01915             <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l01916"></a>01916             stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>, dmsg);
<a name="l01917"></a>01917             free_msg(msg);
<a name="l01918"></a>01918             <span class="keywordflow">return</span> 0;
<a name="l01919"></a>01919          }
<a name="l01920"></a>01920          
<a name="l01921"></a>01921          bc = <a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l01922"></a>01922          hold_bc = <a class="code" href="isdn__lib_8c.html#a6ae22b9108f567d7bae369dc17c65062">stack_holder_find</a>(stack, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>);
<a name="l01923"></a>01923          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;bc_l3id:%x holded_bc_l3id:%x\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>, hold_bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>);
<a name="l01924"></a>01924 
<a name="l01925"></a>01925          <span class="keywordflow">if</span> (hold_bc) {
<a name="l01926"></a>01926             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;REMOVING Holder\n&quot;</span>);
<a name="l01927"></a>01927 
<a name="l01928"></a>01928             <span class="comment">/*swap the backup to our new channel back*/</span>
<a name="l01929"></a>01929             <a class="code" href="isdn__lib_8c.html#a658efc12f0e9b235f2266fff4743dfab">stack_holder_remove</a>(stack, hold_bc);
<a name="l01930"></a>01930             memcpy(bc, hold_bc, <span class="keyword">sizeof</span>(*bc));
<a name="l01931"></a>01931             <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(hold_bc);
<a name="l01932"></a>01932 
<a name="l01933"></a>01933             bc-&gt;<a class="code" href="structmisdn__bchannel.html#a17ef6ae19b9fca79e3e2f7ce9525f089" title="TRUE if this channel is on hold.">holded</a>=0;
<a name="l01934"></a>01934             bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a>=0;
<a name="l01935"></a>01935          }
<a name="l01936"></a>01936          
<a name="l01937"></a>01937       }
<a name="l01938"></a>01938          
<a name="l01939"></a>01939          <span class="keywordflow">break</span>;
<a name="l01940"></a>01940          
<a name="l01941"></a>01941       <span class="keywordflow">case</span> CC_SETUP|CONFIRM:
<a name="l01942"></a>01942       {
<a name="l01943"></a>01943          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l01944"></a>01944          <span class="keywordtype">int</span> l3id = *((<span class="keywordtype">int</span> *)(((u_char *)msg-&gt;data)+ <a class="code" href="isdn__lib__intern_8h.html#a88137f1d562eb491a6f952d43e7f0f22">mISDNUSER_HEAD_SIZE</a>));
<a name="l01945"></a>01945          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; lib: Event_ind:SETUP CONFIRM [NT] : new L3ID  is %x\n&quot;</span>,l3id );
<a name="l01946"></a>01946    
<a name="l01947"></a>01947          <span class="keywordflow">if</span> (bc) {
<a name="l01948"></a>01948             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (2, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;I IND :CC_SETUP|CONFIRM: old l3id:%x new l3id:%x\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>, l3id);
<a name="l01949"></a>01949             bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a> = l3id;
<a name="l01950"></a>01950             <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a00e5f3ee95cd2c61825dde95d4561ce3">EVENT_NEW_L3ID</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l01951"></a>01951          } <span class="keywordflow">else</span> {
<a name="l01952"></a>01952             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Bc Not found (after SETUP CONFIRM)\n&quot;</span>);
<a name="l01953"></a>01953          }
<a name="l01954"></a>01954       }
<a name="l01955"></a>01955       free_msg(msg);
<a name="l01956"></a>01956       <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l01957"></a>01957       <span class="keywordflow">return</span> 0;
<a name="l01958"></a>01958       
<a name="l01959"></a>01959       <span class="keywordflow">case</span> CC_SETUP|INDICATION:
<a name="l01960"></a>01960       {
<a name="l01961"></a>01961          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>* bc=<a class="code" href="isdn__lib_8c.html#aa0fb761776d759bbd96a56bf38fe8c06">misdn_lib_get_free_bc</a>(stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, 0, 1, 0);
<a name="l01962"></a>01962          <span class="keywordflow">if</span> (!bc) {
<a name="l01963"></a>01963             msg_t *dmsg;
<a name="l01964"></a>01964             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Patch from MEIDANIS:Sending RELEASE_COMPLETE %x (No free Chan for you..)\n&quot;</span>, hh-&gt;dinfo);
<a name="l01965"></a>01965             dmsg = <a class="code" href="isdn__lib_8c.html#aee9bd3e9fc9e445d2aafcdecf91af352">create_l3msg</a>(CC_RELEASE_COMPLETE | REQUEST,MT_RELEASE_COMPLETE, hh-&gt;dinfo,<span class="keyword">sizeof</span>(RELEASE_COMPLETE_t), 1);
<a name="l01966"></a>01966             <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l01967"></a>01967             stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>, dmsg);
<a name="l01968"></a>01968             free_msg(msg);
<a name="l01969"></a>01969             <span class="keywordflow">return</span> 0;
<a name="l01970"></a>01970          }
<a name="l01971"></a>01971   
<a name="l01972"></a>01972          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; new_process: New L3Id: %x\n&quot;</span>,hh-&gt;dinfo);
<a name="l01973"></a>01973          bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>=hh-&gt;dinfo;
<a name="l01974"></a>01974       }
<a name="l01975"></a>01975       <span class="keywordflow">break</span>;
<a name="l01976"></a>01976 
<a name="l01977"></a>01977       <span class="keywordflow">case</span> CC_CONNECT_ACKNOWLEDGE|INDICATION:
<a name="l01978"></a>01978       <span class="keywordflow">break</span>;
<a name="l01979"></a>01979       
<a name="l01980"></a>01980       <span class="keywordflow">case</span> CC_ALERTING|INDICATION:
<a name="l01981"></a>01981       <span class="keywordflow">case</span> CC_PROCEEDING|INDICATION:
<a name="l01982"></a>01982       <span class="keywordflow">case</span> CC_SETUP_ACKNOWLEDGE|INDICATION:
<a name="l01983"></a>01983          <span class="keywordflow">if</span>(!stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a>) <span class="keywordflow">break</span>;  
<a name="l01984"></a>01984       <span class="keywordflow">case</span> CC_CONNECT|INDICATION:
<a name="l01985"></a>01985       <span class="keywordflow">break</span>;
<a name="l01986"></a>01986       <span class="keywordflow">case</span> CC_DISCONNECT|INDICATION:
<a name="l01987"></a>01987       {
<a name="l01988"></a>01988          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l01989"></a>01989          <span class="keywordflow">if</span> (!bc) {
<a name="l01990"></a>01990             bc=<a class="code" href="isdn__lib_8c.html#ac3392b1dd6f36d98faf116f8f5323d59">find_bc_by_masked_l3id</a>(stack, hh-&gt;dinfo, 0xffff0000);
<a name="l01991"></a>01991             <span class="keywordflow">if</span> (bc) { 
<a name="l01992"></a>01992                <span class="keywordtype">int</span> myprocid=bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>&amp;0x0000ffff;
<a name="l01993"></a>01993                hh-&gt;dinfo=(hh-&gt;dinfo&amp;0xffff0000)|myprocid;
<a name="l01994"></a>01994                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;Reject dinfo: %x cause:%d\n&quot;</span>,hh-&gt;dinfo,bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa4d0ccb9d0904892652f2f258c5ad225" title="Q.931 Cause for disconnection code (received).">cause</a>);
<a name="l01995"></a>01995                reject=1;      
<a name="l01996"></a>01996             }
<a name="l01997"></a>01997          }
<a name="l01998"></a>01998       }
<a name="l01999"></a>01999       <span class="keywordflow">break</span>;
<a name="l02000"></a>02000       
<a name="l02001"></a>02001       <span class="keywordflow">case</span> CC_FACILITY|INDICATION:
<a name="l02002"></a>02002       {
<a name="l02003"></a>02003          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l02004"></a>02004          <span class="keywordflow">if</span> (!bc) {
<a name="l02005"></a>02005             bc=<a class="code" href="isdn__lib_8c.html#ac3392b1dd6f36d98faf116f8f5323d59">find_bc_by_masked_l3id</a>(stack, hh-&gt;dinfo, 0xffff0000);
<a name="l02006"></a>02006             <span class="keywordflow">if</span> (bc) { 
<a name="l02007"></a>02007                <span class="keywordtype">int</span> myprocid=bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>&amp;0x0000ffff;
<a name="l02008"></a>02008                hh-&gt;dinfo=(hh-&gt;dinfo&amp;0xffff0000)|myprocid;
<a name="l02009"></a>02009                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;Repaired reject Bug, new dinfo: %x\n&quot;</span>,hh-&gt;dinfo);
<a name="l02010"></a>02010             }
<a name="l02011"></a>02011          }
<a name="l02012"></a>02012       }
<a name="l02013"></a>02013       <span class="keywordflow">break</span>;
<a name="l02014"></a>02014       
<a name="l02015"></a>02015       <span class="keywordflow">case</span> CC_RELEASE_COMPLETE|INDICATION:
<a name="l02016"></a>02016          <span class="keywordflow">break</span>;
<a name="l02017"></a>02017 
<a name="l02018"></a>02018       <span class="keywordflow">case</span> CC_SUSPEND|INDICATION:
<a name="l02019"></a>02019       {
<a name="l02020"></a>02020          msg_t *dmsg;
<a name="l02021"></a>02021          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; Got Suspend, sending Reject for now\n&quot;</span>);
<a name="l02022"></a>02022          dmsg = <a class="code" href="isdn__lib_8c.html#aee9bd3e9fc9e445d2aafcdecf91af352">create_l3msg</a>(CC_SUSPEND_REJECT | REQUEST,MT_SUSPEND_REJECT, hh-&gt;dinfo,<span class="keyword">sizeof</span>(RELEASE_COMPLETE_t), 1);
<a name="l02023"></a>02023          <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l02024"></a>02024          stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>, dmsg);
<a name="l02025"></a>02025          free_msg(msg);
<a name="l02026"></a>02026          <span class="keywordflow">return</span> 0;
<a name="l02027"></a>02027       }
<a name="l02028"></a>02028       <span class="keywordflow">break</span>;
<a name="l02029"></a>02029       <span class="keywordflow">case</span> CC_RESUME|INDICATION:
<a name="l02030"></a>02030          <span class="keywordflow">break</span>;
<a name="l02031"></a>02031 
<a name="l02032"></a>02032       <span class="keywordflow">case</span> CC_RELEASE|CONFIRM:
<a name="l02033"></a>02033          {
<a name="l02034"></a>02034             <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l02035"></a>02035 
<a name="l02036"></a>02036             <span class="keywordflow">if</span> (bc) { 
<a name="l02037"></a>02037                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;CC_RELEASE|CONFIRM (l3id:%x), sending RELEASE_COMPLETE\n&quot;</span>, hh-&gt;dinfo);
<a name="l02038"></a>02038                <a class="code" href="isdn__lib_8c.html#a9b9f5e8fc32b68c5d1a0c28d7ee40fb3">misdn_lib_send_event</a>(bc, <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a2473594848bb5e1cb2eafb862337f51a">EVENT_RELEASE_COMPLETE</a>);
<a name="l02039"></a>02039             }
<a name="l02040"></a>02040          }
<a name="l02041"></a>02041          <span class="keywordflow">break</span>;
<a name="l02042"></a>02042          
<a name="l02043"></a>02043       <span class="keywordflow">case</span> CC_RELEASE|INDICATION:
<a name="l02044"></a>02044          <span class="keywordflow">break</span>;
<a name="l02045"></a>02045 
<a name="l02046"></a>02046       <span class="keywordflow">case</span> CC_RELEASE_CR|INDICATION:
<a name="l02047"></a>02047          <a class="code" href="isdn__lib_8c.html#a5ed5ed7382be41aad46e670f55825fcd">release_cr</a>(stack, hh);
<a name="l02048"></a>02048          free_msg(msg);
<a name="l02049"></a>02049          <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l02050"></a>02050          <span class="keywordflow">return</span> 0 ;
<a name="l02051"></a>02051       <span class="keywordflow">break</span>;
<a name="l02052"></a>02052       
<a name="l02053"></a>02053       <span class="keywordflow">case</span> CC_NEW_CR|INDICATION:
<a name="l02054"></a>02054          <span class="comment">/*  Got New CR for bchan, for now I handle this one in */</span>
<a name="l02055"></a>02055          <span class="comment">/*  connect_ack, Need to be changed */</span>
<a name="l02056"></a>02056       {
<a name="l02057"></a>02057          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l02058"></a>02058          <span class="keywordtype">int</span> l3id = *((<span class="keywordtype">int</span> *)(((u_char *)msg-&gt;data)+ <a class="code" href="isdn__lib__intern_8h.html#a88137f1d562eb491a6f952d43e7f0f22">mISDNUSER_HEAD_SIZE</a>));
<a name="l02059"></a>02059          <span class="keywordflow">if</span> (!bc) {
<a name="l02060"></a>02060             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; In NEW_CR: didn&apos;t found bc ??\n&quot;</span>);
<a name="l02061"></a>02061             <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l02062"></a>02062             <span class="keywordflow">return</span> -1;
<a name="l02063"></a>02063          }
<a name="l02064"></a>02064          <span class="keywordflow">if</span> (((l3id&amp;0xff00)!=0xff00) &amp;&amp; ((bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>&amp;0xff00)==0xff00)) {
<a name="l02065"></a>02065             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; Removing Process Id:%x on this port.\n&quot;</span>, 0xff&amp;bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>);
<a name="l02066"></a>02066             stack-&gt;<a class="code" href="structmisdn__stack.html#af09226a0718361435f6aca5c31167166" title="CR Process ID allocation table. TRUE if ID allocated.">procids</a>[bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>&amp;0xff] = 0 ;
<a name="l02067"></a>02067          }
<a name="l02068"></a>02068          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;lib: Event_ind:CC_NEW_CR : very new L3ID  is %x\n&quot;</span>,l3id );
<a name="l02069"></a>02069    
<a name="l02070"></a>02070          bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a> =l3id;
<a name="l02071"></a>02071          <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a00e5f3ee95cd2c61825dde95d4561ce3">EVENT_NEW_L3ID</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l02072"></a>02072    
<a name="l02073"></a>02073          free_msg(msg);
<a name="l02074"></a>02074          <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l02075"></a>02075          <span class="keywordflow">return</span> 0;
<a name="l02076"></a>02076       }
<a name="l02077"></a>02077       
<a name="l02078"></a>02078       <span class="keywordflow">case</span> DL_ESTABLISH | INDICATION:
<a name="l02079"></a>02079       <span class="keywordflow">case</span> DL_ESTABLISH | CONFIRM:
<a name="l02080"></a>02080       {
<a name="l02081"></a>02081          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;%% GOT L2 Activate Info.\n&quot;</span>);
<a name="l02082"></a>02082          
<a name="l02083"></a>02083          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a> &amp;&amp; stack-&gt;<a class="code" href="structmisdn__stack.html#a2f51cb4d0630a299b4e436c7471eea21" title="TRUE if Layer 2 is UP.">l2link</a>) {
<a name="l02084"></a>02084             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;%% GOT L2 Activate Info. but we&apos;re activated already.. this l2 is faulty, blocking port\n&quot;</span>);
<a name="l02085"></a>02085             <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a50ddddd2e7ed5ebc329cb84f494c59dd">EVENT_PORT_ALARM</a>, &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[0], glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l02086"></a>02086          }
<a name="l02087"></a>02087 
<a name="l02088"></a>02088          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a> &amp;&amp; !stack-&gt;<a class="code" href="structmisdn__stack.html#addc39c5f27e655c88d15915bab9df095" title="TRUE if restart has been sent to the other side after stack startup.">restart_sent</a>) {
<a name="l02089"></a>02089             <span class="comment">/* make sure we restart the interface of the </span>
<a name="l02090"></a>02090 <span class="comment">             * other side */</span>
<a name="l02091"></a>02091             stack-&gt;<a class="code" href="structmisdn__stack.html#addc39c5f27e655c88d15915bab9df095" title="TRUE if restart has been sent to the other side after stack startup.">restart_sent</a>=1;
<a name="l02092"></a>02092             <a class="code" href="isdn__lib_8c.html#a5eece989af344908ee385f23239508da">misdn_lib_send_restart</a>(stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, -1);
<a name="l02093"></a>02093 
<a name="l02094"></a>02094          }
<a name="l02095"></a>02095       
<a name="l02096"></a>02096          <span class="comment">/* when we get the L2 UP, the L1 is UP definitely too*/</span>
<a name="l02097"></a>02097          stack-&gt;<a class="code" href="structmisdn__stack.html#a2f51cb4d0630a299b4e436c7471eea21" title="TRUE if Layer 2 is UP.">l2link</a> = 1;
<a name="l02098"></a>02098          stack-&gt;<a class="code" href="structmisdn__stack.html#aa756ddc4588503eaace3e11fd6cf89c7" title="Number of consecutive times PTP Layer 2 declared down.">l2upcnt</a>=0;
<a name="l02099"></a>02099          
<a name="l02100"></a>02100          free_msg(msg);
<a name="l02101"></a>02101          <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l02102"></a>02102          <span class="keywordflow">return</span> 0;
<a name="l02103"></a>02103       }
<a name="l02104"></a>02104       <span class="keywordflow">break</span>;
<a name="l02105"></a>02105 
<a name="l02106"></a>02106 
<a name="l02107"></a>02107       <span class="keywordflow">case</span> DL_RELEASE | INDICATION:
<a name="l02108"></a>02108       <span class="keywordflow">case</span> DL_RELEASE | CONFIRM:
<a name="l02109"></a>02109       {
<a name="l02110"></a>02110          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a>) {
<a name="l02111"></a>02111             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3 , stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;%% GOT L2 DeActivate Info.\n&quot;</span>);
<a name="l02112"></a>02112 
<a name="l02113"></a>02113             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aa756ddc4588503eaace3e11fd6cf89c7" title="Number of consecutive times PTP Layer 2 declared down.">l2upcnt</a>&gt;3) {
<a name="l02114"></a>02114                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0 , stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;!!! Could not Get the L2 up after 3 Attempts!!!\n&quot;</span>);
<a name="l02115"></a>02115             }  <span class="keywordflow">else</span> {
<a name="l02116"></a>02116 <span class="preprocessor">#if 0</span>
<a name="l02117"></a>02117 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) <a class="code" href="isdn__lib_8c.html#adade044f8be231389ea854bc1e529c71">misdn_lib_reinit_nt_stack</a>(stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>);
<a name="l02118"></a>02118 <span class="preprocessor">#endif</span>
<a name="l02119"></a>02119 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a579e76479941e4610b630ada968ae5e2" title="TRUE if Layer 1 is UP.">l1link</a>) {
<a name="l02120"></a>02120                   <a class="code" href="isdn__lib_8c.html#af03ad57836b38845f685368e60625707">misdn_lib_get_l2_up</a>(stack);
<a name="l02121"></a>02121                   stack-&gt;<a class="code" href="structmisdn__stack.html#aa756ddc4588503eaace3e11fd6cf89c7" title="Number of consecutive times PTP Layer 2 declared down.">l2upcnt</a>++;
<a name="l02122"></a>02122                }
<a name="l02123"></a>02123             }
<a name="l02124"></a>02124             
<a name="l02125"></a>02125          } <span class="keywordflow">else</span> 
<a name="l02126"></a>02126             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;%% GOT L2 DeActivate Info.\n&quot;</span>);
<a name="l02127"></a>02127          
<a name="l02128"></a>02128          stack-&gt;<a class="code" href="structmisdn__stack.html#a2f51cb4d0630a299b4e436c7471eea21" title="TRUE if Layer 2 is UP.">l2link</a> = 0;
<a name="l02129"></a>02129          free_msg(msg);
<a name="l02130"></a>02130          <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l02131"></a>02131          <span class="keywordflow">return</span> 0;
<a name="l02132"></a>02132       }
<a name="l02133"></a>02133       <span class="keywordflow">break</span>;
<a name="l02134"></a>02134       }
<a name="l02135"></a>02135    }
<a name="l02136"></a>02136    
<a name="l02137"></a>02137    {
<a name="l02138"></a>02138       <span class="comment">/*  Parse Events and fire_up to App. */</span>
<a name="l02139"></a>02139       <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc;
<a name="l02140"></a>02140       <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> dummybc;
<a name="l02141"></a>02141       
<a name="l02142"></a>02142       <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0">event_e</a> <span class="keyword">event</span> = <a class="code" href="isdn__lib__intern_8h.html#a7a92a25c6c4083aee9277797c24977e9">isdn_msg_get_event</a>(<a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a>, msg, 1);
<a name="l02143"></a>02143     
<a name="l02144"></a>02144       bc=<a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l02145"></a>02145     
<a name="l02146"></a>02146       <span class="keywordflow">if</span> (!bc) {
<a name="l02147"></a>02147          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; Didn&apos;t find BC so temporarily creating dummy BC (l3id:%x).\n&quot;</span>, hh-&gt;dinfo);
<a name="l02148"></a>02148          <a class="code" href="isdn__lib_8c.html#aeb7cfd0342e0a820eb3d7302401c9c74">misdn_make_dummy</a>(&amp;dummybc, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,  hh-&gt;dinfo, stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>, 0);
<a name="l02149"></a>02149          bc=&amp;dummybc; 
<a name="l02150"></a>02150       }
<a name="l02151"></a>02151       <span class="keywordflow">if</span> (bc ) {
<a name="l02152"></a>02152          <a class="code" href="isdn__lib__intern_8h.html#a6fb028d4322a5a9d1a09ec780c73d05d">isdn_msg_parse_event</a>(<a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a>,msg,bc, 1);
<a name="l02153"></a>02153 
<a name="l02154"></a>02154          <span class="keywordflow">switch</span> (event) {
<a name="l02155"></a>02155             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a71b67c9dd659e015ff13d68c2d3ea2aa">EVENT_SETUP</a>:
<a name="l02156"></a>02156                <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>&lt;=0 || bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>==0xff) 
<a name="l02157"></a>02157                   bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>=0;
<a name="l02158"></a>02158             
<a name="l02159"></a>02159                <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a67727c8665c79737a5e7ffd7a524934a">find_free_chan_in_stack</a>(stack,bc, bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>,0)&lt;0) {
<a name="l02160"></a>02160                   msg_t *dmsg;
<a name="l02161"></a>02161                   <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Patch from MEIDANIS:Sending RELEASE_COMPLETE %x (No free Chan for you..)\n&quot;</span>, hh-&gt;dinfo);
<a name="l02162"></a>02162                   dmsg = <a class="code" href="isdn__lib_8c.html#aee9bd3e9fc9e445d2aafcdecf91af352">create_l3msg</a>(CC_RELEASE_COMPLETE | REQUEST,MT_RELEASE_COMPLETE, hh-&gt;dinfo,<span class="keyword">sizeof</span>(RELEASE_COMPLETE_t), 1);
<a name="l02163"></a>02163                   <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l02164"></a>02164                   stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>, dmsg);
<a name="l02165"></a>02165                   free_msg(msg);
<a name="l02166"></a>02166                   <span class="keywordflow">return</span> 0;
<a name="l02167"></a>02167                }
<a name="l02168"></a>02168                <span class="keywordflow">break</span>;
<a name="l02169"></a>02169             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0abe8648d8a43122eac550c72a1babcb07">EVENT_RELEASE</a>:
<a name="l02170"></a>02170             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a2473594848bb5e1cb2eafb862337f51a">EVENT_RELEASE_COMPLETE</a>:
<a name="l02171"></a>02171                {
<a name="l02172"></a>02172                <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>=bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>;
<a name="l02173"></a>02173                <span class="keywordtype">int</span> tmpcause=bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa4d0ccb9d0904892652f2f258c5ad225" title="Q.931 Cause for disconnection code (received).">cause</a>; 
<a name="l02174"></a>02174                          <a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">empty_bc</a>(bc);
<a name="l02175"></a>02175                bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa4d0ccb9d0904892652f2f258c5ad225" title="Q.931 Cause for disconnection code (received).">cause</a>=tmpcause;
<a name="l02176"></a>02176                <a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">clean_up_bc</a>(bc);
<a name="l02177"></a>02177 
<a name="l02178"></a>02178                <span class="keywordflow">if</span> (channel&gt;0)
<a name="l02179"></a>02179                                  <a class="code" href="isdn__lib_8c.html#a9f849e8a799ef7d6a52f6a10ec4446e5">empty_chan_in_stack</a>(stack,channel);
<a name="l02180"></a>02180                bc-&gt;<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a>=0;
<a name="l02181"></a>02181                }
<a name="l02182"></a>02182                <span class="keywordflow">break</span>;
<a name="l02183"></a>02183 
<a name="l02184"></a>02184             <span class="keywordflow">default</span>:
<a name="l02185"></a>02185             <span class="keywordflow">break</span>;
<a name="l02186"></a>02186          }
<a name="l02187"></a>02187          
<a name="l02188"></a>02188          <span class="keywordflow">if</span>(!<a class="code" href="isdn__lib__intern_8h.html#a622bd30db092a77314ee5e5581a80f75">isdn_get_info</a>(<a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a>,event,1)) {
<a name="l02189"></a>02189             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Unknown Event Ind: prim %x dinfo %x\n&quot;</span>,hh-&gt;prim, hh-&gt;dinfo);
<a name="l02190"></a>02190          } <span class="keywordflow">else</span> {
<a name="l02191"></a>02191             <span class="keywordflow">if</span> (reject) {
<a name="l02192"></a>02192                <span class="keywordflow">switch</span>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa4d0ccb9d0904892652f2f258c5ad225" title="Q.931 Cause for disconnection code (received).">cause</a>){
<a name="l02193"></a>02193                   <span class="keywordflow">case</span> <a class="code" href="causes_8h.html#aff0e956cb3ef657557fa468a17416c0b">AST_CAUSE_USER_BUSY</a>:
<a name="l02194"></a>02194                      <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Siemens Busy reject..\n&quot;</span>);
<a name="l02195"></a>02195 
<a name="l02196"></a>02196                      <span class="keywordflow">break</span>;
<a name="l02197"></a>02197                   <span class="keywordflow">default</span>:
<a name="l02198"></a>02198                      <span class="keywordflow">break</span>;
<a name="l02199"></a>02199                }
<a name="l02200"></a>02200             }
<a name="l02201"></a>02201             <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(event, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l02202"></a>02202          }
<a name="l02203"></a>02203       } <span class="keywordflow">else</span> {
<a name="l02204"></a>02204          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;No BC found with l3id: prim %x dinfo %x\n&quot;</span>,hh-&gt;prim, hh-&gt;dinfo);
<a name="l02205"></a>02205       }
<a name="l02206"></a>02206 
<a name="l02207"></a>02207       free_msg(msg);
<a name="l02208"></a>02208    }
<a name="l02209"></a>02209 
<a name="l02210"></a>02210 
<a name="l02211"></a>02211    <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l02212"></a>02212    <span class="keywordflow">return</span> 0;
<a name="l02213"></a>02213 }
<a name="l02214"></a>02214 
<a name="l02215"></a>02215 
<a name="l02216"></a><a class="code" href="isdn__lib_8c.html#adb7b67eb1f67f3b72857d674c6735114">02216</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#adb7b67eb1f67f3b72857d674c6735114">handle_timers</a>(msg_t* <a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)
<a name="l02217"></a>02217 {
<a name="l02218"></a>02218    iframe_t *frm= (iframe_t*)msg-&gt;data;
<a name="l02219"></a>02219    <span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack; 
<a name="l02220"></a>02220   
<a name="l02221"></a>02221    <span class="comment">/* Timer Stuff */</span>
<a name="l02222"></a>02222    switch (frm-&gt;prim) {
<a name="l02223"></a>02223    <span class="keywordflow">case</span> MGR_INITTIMER | CONFIRM:
<a name="l02224"></a>02224    <span class="keywordflow">case</span> MGR_ADDTIMER | CONFIRM:
<a name="l02225"></a>02225    <span class="keywordflow">case</span> MGR_DELTIMER | CONFIRM:
<a name="l02226"></a>02226    <span class="keywordflow">case</span> MGR_REMOVETIMER | CONFIRM:
<a name="l02227"></a>02227       free_msg(msg);
<a name="l02228"></a>02228       <span class="keywordflow">return</span>(1);
<a name="l02229"></a>02229    }
<a name="l02230"></a>02230   
<a name="l02231"></a>02231   
<a name="l02232"></a>02232   
<a name="l02233"></a>02233    <span class="keywordflow">if</span> (frm-&gt;prim==(MGR_TIMER | INDICATION) ) {
<a name="l02234"></a>02234       <span class="keywordflow">for</span> (stack = glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>;
<a name="l02235"></a>02235            stack;
<a name="l02236"></a>02236            stack = stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l02237"></a>02237          itimer_t *it;
<a name="l02238"></a>02238       
<a name="l02239"></a>02239          <span class="keywordflow">if</span> (!stack-&gt;nt) <span class="keywordflow">continue</span>;
<a name="l02240"></a>02240       
<a name="l02241"></a>02241          it = stack-&gt;nst.tlist;
<a name="l02242"></a>02242          <span class="comment">/* find timer */</span>
<a name="l02243"></a>02243          <span class="keywordflow">for</span>(it=stack-&gt;nst.tlist;
<a name="l02244"></a>02244              it;
<a name="l02245"></a>02245              it=it-&gt;next) {
<a name="l02246"></a>02246             <span class="keywordflow">if</span> (it-&gt;id == (<span class="keywordtype">int</span>)frm-&gt;addr)
<a name="l02247"></a>02247                <span class="keywordflow">break</span>;
<a name="l02248"></a>02248          }
<a name="l02249"></a>02249          <span class="keywordflow">if</span> (it) {
<a name="l02250"></a>02250             <span class="keywordtype">int</span> ret;
<a name="l02251"></a>02251             ret = mISDN_write_frame(stack-&gt;midev, msg-&gt;data, frm-&gt;addr,
<a name="l02252"></a>02252                      MGR_TIMER | RESPONSE, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l02253"></a>02253             test_and_clear_bit(FLG_TIMER_RUNING, (<span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)&amp;it-&gt;Flags);
<a name="l02254"></a>02254             <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;nstlock);
<a name="l02255"></a>02255             ret = it-&gt;function(it-&gt;data);
<a name="l02256"></a>02256             <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;nstlock);
<a name="l02257"></a>02257             free_msg(msg);
<a name="l02258"></a>02258             <span class="keywordflow">return</span> 1;
<a name="l02259"></a>02259          }
<a name="l02260"></a>02260       }
<a name="l02261"></a>02261     
<a name="l02262"></a>02262       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, 0, <span class="stringliteral">&quot;Timer Msg without Timer ??\n&quot;</span>);
<a name="l02263"></a>02263       free_msg(msg);
<a name="l02264"></a>02264       <span class="keywordflow">return</span> 1;
<a name="l02265"></a>02265    }
<a name="l02266"></a>02266   
<a name="l02267"></a>02267    <span class="keywordflow">return</span> 0;
<a name="l02268"></a>02268 }
<a name="l02269"></a>02269 
<a name="l02270"></a>02270 
<a name="l02271"></a>02271 
<a name="l02272"></a><a class="code" href="isdn__lib_8h.html#adf9d3ad762e15818c788ac1035f6cb06">02272</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#adf9d3ad762e15818c788ac1035f6cb06">misdn_lib_tone_generator_start</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l02273"></a>02273 {
<a name="l02274"></a>02274    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a18f91a48afb97a188ef92e61c593862e" title="TRUE if tone generator allowed to start.">generate_tone</a>=1;
<a name="l02275"></a>02275 }
<a name="l02276"></a>02276 
<a name="l02277"></a><a class="code" href="isdn__lib_8h.html#a25fc25d4f6566e90a0f8d992719c0e9e">02277</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a25fc25d4f6566e90a0f8d992719c0e9e">misdn_lib_tone_generator_stop</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l02278"></a>02278 {
<a name="l02279"></a>02279    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a18f91a48afb97a188ef92e61c593862e" title="TRUE if tone generator allowed to start.">generate_tone</a>=0;
<a name="l02280"></a>02280 }
<a name="l02281"></a>02281 
<a name="l02282"></a>02282 
<a name="l02283"></a><a class="code" href="isdn__lib_8c.html#ad8d568b6bb7ab30a7fd634e4f33a76f9">02283</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#ad8d568b6bb7ab30a7fd634e4f33a76f9">do_tone</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l02284"></a>02284 {
<a name="l02285"></a>02285    bc-&gt;<a class="code" href="structmisdn__bchannel.html#af6c8edfad6751df061697799630c7f47" title="Number of tone samples to generate.">tone_cnt</a>=len;
<a name="l02286"></a>02286    
<a name="l02287"></a>02287    <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#a18f91a48afb97a188ef92e61c593862e" title="TRUE if tone generator allowed to start.">generate_tone</a>) {
<a name="l02288"></a>02288       <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a346ec23214fa6f859c999294e84b65a2">EVENT_TONE_GENERATE</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l02289"></a>02289       
<a name="l02290"></a>02290       <span class="keywordflow">if</span> ( !bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6bb23a220a9276463546e4b5faa28e36" title="TRUE if we will not use the jitter buffer system.">nojitter</a> ) {
<a name="l02291"></a>02291          <a class="code" href="isdn__lib_8c.html#a4b517b8a0f6a3571dba3ec48eed7ff0d">misdn_tx_jitter</a>(bc,len);
<a name="l02292"></a>02292       }
<a name="l02293"></a>02293       
<a name="l02294"></a>02294       <span class="keywordflow">return</span> 1;
<a name="l02295"></a>02295    }
<a name="l02296"></a>02296    
<a name="l02297"></a>02297    <span class="keywordflow">return</span> 0;
<a name="l02298"></a>02298 }
<a name="l02299"></a>02299 
<a name="l02300"></a>02300 
<a name="l02301"></a>02301 <span class="preprocessor">#ifdef MISDN_SAVE_DATA</span>
<a name="l02302"></a>02302 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> misdn_save_data(<span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keywordtype">char</span> *p1, <span class="keywordtype">int</span> l1, <span class="keywordtype">char</span> *p2, <span class="keywordtype">int</span> l2) 
<a name="l02303"></a>02303 {
<a name="l02304"></a>02304    <span class="keywordtype">char</span> n1[32],n2[32];
<a name="l02305"></a>02305    FILE *rx, *tx;
<a name="l02306"></a>02306 
<a name="l02307"></a>02307    sprintf(n1,<span class="stringliteral">&quot;/tmp/misdn-rx-%d.raw&quot;</span>,<span class="keywordtype">id</span>);
<a name="l02308"></a>02308    sprintf(n2,<span class="stringliteral">&quot;/tmp/misdn-tx-%d.raw&quot;</span>,<span class="keywordtype">id</span>);
<a name="l02309"></a>02309 
<a name="l02310"></a>02310    rx = fopen(n1,<span class="stringliteral">&quot;a+&quot;</span>); 
<a name="l02311"></a>02311    tx = fopen(n2,<span class="stringliteral">&quot;a+&quot;</span>);
<a name="l02312"></a>02312 
<a name="l02313"></a>02313    <span class="keywordflow">if</span> (!rx || !tx) {
<a name="l02314"></a>02314       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,0,<span class="stringliteral">&quot;Couldn&apos;t open files: %s\n&quot;</span>,strerror(errno));
<a name="l02315"></a>02315       <span class="keywordflow">if</span> (rx)
<a name="l02316"></a>02316          fclose(rx);
<a name="l02317"></a>02317       <span class="keywordflow">if</span> (tx)
<a name="l02318"></a>02318          fclose(tx);
<a name="l02319"></a>02319       return ;
<a name="l02320"></a>02320    }
<a name="l02321"></a>02321    
<a name="l02322"></a>02322    <a class="code" href="ast__expr2f_8c.html#a8541b986268a39ba1b07d9e912d31732">fwrite</a>(p1,1,l1,rx);
<a name="l02323"></a>02323    <a class="code" href="ast__expr2f_8c.html#a8541b986268a39ba1b07d9e912d31732">fwrite</a>(p2,1,l2,tx);
<a name="l02324"></a>02324    
<a name="l02325"></a>02325    fclose(rx);
<a name="l02326"></a>02326    fclose(tx);
<a name="l02327"></a>02327 
<a name="l02328"></a>02328 }
<a name="l02329"></a>02329 <span class="preprocessor">#endif</span>
<a name="l02330"></a>02330 <span class="preprocessor"></span>
<a name="l02331"></a><a class="code" href="isdn__lib_8c.html#a4b517b8a0f6a3571dba3ec48eed7ff0d">02331</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a4b517b8a0f6a3571dba3ec48eed7ff0d">misdn_tx_jitter</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l02332"></a>02332 {
<a name="l02333"></a>02333    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[4096 + mISDN_HEADER_LEN];
<a name="l02334"></a>02334    <span class="keywordtype">char</span> *data=&amp;buf[mISDN_HEADER_LEN];
<a name="l02335"></a>02335    iframe_t *txfrm= (iframe_t*)buf;
<a name="l02336"></a>02336    <span class="keywordtype">int</span> jlen, r;
<a name="l02337"></a>02337    
<a name="l02338"></a>02338    jlen=<a class="code" href="isdn__lib_8c.html#a72481e6f9189b5aa9d4b4ab441118e76">cb_jb_empty</a>(bc,data,len);
<a name="l02339"></a>02339    
<a name="l02340"></a>02340    <span class="keywordflow">if</span> (jlen) {
<a name="l02341"></a>02341 <span class="preprocessor">#ifdef MISDN_SAVE_DATA</span>
<a name="l02342"></a>02342 <span class="preprocessor"></span>      misdn_save_data((bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>*100+bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>), data, jlen, bc-&gt;<a class="code" href="structmisdn__bchannel.html#ac5bda3fccb33a8bce547ec92e92f27e5" title="B channel speech sample data buffer.">bframe</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#abd2b13dba522040010e392081c185e60" title="B channel speech sample data buffer size.">bframe_len</a>);
<a name="l02343"></a>02343 <span class="preprocessor">#endif</span>
<a name="l02344"></a>02344 <span class="preprocessor"></span>      <a class="code" href="isdn__lib_8c.html#aec5e8bc764f0ae521c2e841d8609545d">flip_buf_bits</a>( data, jlen);
<a name="l02345"></a>02345       
<a name="l02346"></a>02346       <span class="keywordflow">if</span> (jlen &lt; len) {
<a name="l02347"></a>02347          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;Jitterbuffer Underrun. Got %d of expected %d\n&quot;</span>, jlen, len);
<a name="l02348"></a>02348       }
<a name="l02349"></a>02349       
<a name="l02350"></a>02350       txfrm-&gt;prim = DL_DATA|REQUEST;
<a name="l02351"></a>02351       
<a name="l02352"></a>02352       txfrm-&gt;dinfo = 0;
<a name="l02353"></a>02353       
<a name="l02354"></a>02354       txfrm-&gt;addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>|FLG_MSG_DOWN; <span class="comment">/*  | IF_DOWN; */</span>
<a name="l02355"></a>02355       
<a name="l02356"></a>02356       txfrm-&gt;len =jlen;
<a name="l02357"></a>02357       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(9, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;Transmitting %d samples 2 misdn\n&quot;</span>, txfrm-&gt;len);
<a name="l02358"></a>02358 
<a name="l02359"></a>02359       r=mISDN_write( glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, buf, txfrm-&gt;len + mISDN_HEADER_LEN, 8000 );
<a name="l02360"></a>02360    } <span class="keywordflow">else</span> {
<a name="l02361"></a>02361 <span class="preprocessor">#define MISDN_GEN_SILENCE</span>
<a name="l02362"></a>02362 <span class="preprocessor"></span><span class="preprocessor">#ifdef MISDN_GEN_SILENCE</span>
<a name="l02363"></a>02363 <span class="preprocessor"></span>      <span class="keywordtype">int</span> cnt=len/TONE_SILENCE_SIZE;
<a name="l02364"></a>02364       <span class="keywordtype">int</span> rest=len%TONE_SILENCE_SIZE;
<a name="l02365"></a>02365       <span class="keywordtype">int</span> i;
<a name="l02366"></a>02366 
<a name="l02367"></a>02367       <span class="keywordflow">for</span> (i=0; i&lt;cnt; i++) {
<a name="l02368"></a>02368          memcpy(data, tone_silence_flip, TONE_SILENCE_SIZE );
<a name="l02369"></a>02369          data +=TONE_SILENCE_SIZE;
<a name="l02370"></a>02370       }
<a name="l02371"></a>02371 
<a name="l02372"></a>02372       <span class="keywordflow">if</span> (rest) {
<a name="l02373"></a>02373          memcpy(data, tone_silence_flip, rest);
<a name="l02374"></a>02374       }
<a name="l02375"></a>02375 
<a name="l02376"></a>02376       txfrm-&gt;prim = DL_DATA|REQUEST;
<a name="l02377"></a>02377 
<a name="l02378"></a>02378       txfrm-&gt;dinfo = 0;
<a name="l02379"></a>02379 
<a name="l02380"></a>02380       txfrm-&gt;addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>|FLG_MSG_DOWN; <span class="comment">/*  | IF_DOWN; */</span>
<a name="l02381"></a>02381 
<a name="l02382"></a>02382       txfrm-&gt;len =len;
<a name="l02383"></a>02383       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;Transmitting %d samples of silence to misdn\n&quot;</span>, len);
<a name="l02384"></a>02384 
<a name="l02385"></a>02385       r=mISDN_write( glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, buf, txfrm-&gt;len + mISDN_HEADER_LEN, 8000 );
<a name="l02386"></a>02386 <span class="preprocessor">#else</span>
<a name="l02387"></a>02387 <span class="preprocessor"></span>      r = 0;
<a name="l02388"></a>02388 <span class="preprocessor">#endif</span>
<a name="l02389"></a>02389 <span class="preprocessor"></span>   }
<a name="l02390"></a>02390 
<a name="l02391"></a>02391    <span class="keywordflow">if</span> (r &lt; 0) {
<a name="l02392"></a>02392       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;Error in mISDN_write (%s)\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02393"></a>02393    }
<a name="l02394"></a>02394 }
<a name="l02395"></a>02395 
<a name="l02396"></a><a class="code" href="isdn__lib_8c.html#acb9ba231d9a9431439f251157ec6e1c0">02396</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#acb9ba231d9a9431439f251157ec6e1c0">handle_bchan</a>(msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)
<a name="l02397"></a>02397 {
<a name="l02398"></a>02398    iframe_t *frm= (iframe_t*)msg-&gt;data;
<a name="l02399"></a>02399    <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#af2764eaebbffa1c0141a0abd2991fab3">find_bc_by_addr</a>(frm-&gt;addr);
<a name="l02400"></a>02400    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l02401"></a>02401    
<a name="l02402"></a>02402    <span class="keywordflow">if</span> (!bc) {
<a name="l02403"></a>02403       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1,0,<span class="stringliteral">&quot;handle_bchan: BC not found for prim:%x with addr:%x dinfo:%x\n&quot;</span>, frm-&gt;prim, frm-&gt;addr, frm-&gt;dinfo);
<a name="l02404"></a>02404       <span class="keywordflow">return</span> 0 ;
<a name="l02405"></a>02405    }
<a name="l02406"></a>02406    
<a name="l02407"></a>02407    stack = <a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l02408"></a>02408    
<a name="l02409"></a>02409    <span class="keywordflow">if</span> (!stack) {
<a name="l02410"></a>02410       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;handle_bchan: STACK not found for prim:%x with addr:%x dinfo:%x\n&quot;</span>, frm-&gt;prim, frm-&gt;addr, frm-&gt;dinfo);
<a name="l02411"></a>02411       <span class="keywordflow">return</span> 0;
<a name="l02412"></a>02412    }
<a name="l02413"></a>02413    
<a name="l02414"></a>02414    <span class="keywordflow">switch</span> (frm-&gt;prim) {
<a name="l02415"></a>02415 
<a name="l02416"></a>02416    <span class="keywordflow">case</span> MGR_SETSTACK| CONFIRM:
<a name="l02417"></a>02417       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;BCHAN: MGR_SETSTACK|CONFIRM pid:%d\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l02418"></a>02418       <span class="keywordflow">break</span>;
<a name="l02419"></a>02419       
<a name="l02420"></a>02420    <span class="keywordflow">case</span> MGR_SETSTACK| INDICATION:
<a name="l02421"></a>02421       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;BCHAN: MGR_SETSTACK|IND pid:%d\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l02422"></a>02422    <span class="keywordflow">break</span>;
<a name="l02423"></a>02423 <span class="preprocessor">#if 0</span>
<a name="l02424"></a>02424 <span class="preprocessor"></span>   AGAIN:
<a name="l02425"></a>02425       bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> = mISDN_get_layerid(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#af5e6403cb6864751421a5e7249e4cc62" title="B channel layer; set to 3 or 4.">layer</a>);
<a name="l02426"></a>02426       <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>) {
<a name="l02427"></a>02427 
<a name="l02428"></a>02428          <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EAGAIN) {
<a name="l02429"></a>02429             usleep(1000);
<a name="l02430"></a>02430             <span class="keywordflow">goto</span> AGAIN;
<a name="l02431"></a>02431          }
<a name="l02432"></a>02432          
<a name="l02433"></a>02433          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;$$$ Get Layer (%d) Id Error: %s\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#af5e6403cb6864751421a5e7249e4cc62" title="B channel layer; set to 3 or 4.">layer</a>,strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02434"></a>02434          
<a name="l02435"></a>02435          <span class="comment">/* we kill the channel later, when we received some</span>
<a name="l02436"></a>02436 <span class="comment">            data. */</span>
<a name="l02437"></a>02437          bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>= frm-&gt;addr;
<a name="l02438"></a>02438       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> &lt; 0) {
<a name="l02439"></a>02439          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;$$$ bc-&gt;addr &lt;0 Error:%s\n&quot;</span>,strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02440"></a>02440          bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>=0;
<a name="l02441"></a>02441       }
<a name="l02442"></a>02442       
<a name="l02443"></a>02443       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot; --&gt; Got Adr %x\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>);
<a name="l02444"></a>02444 
<a name="l02445"></a>02445       free_msg(msg);
<a name="l02446"></a>02446    
<a name="l02447"></a>02447       
<a name="l02448"></a>02448       <span class="keywordflow">switch</span>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a>) {
<a name="l02449"></a>02449       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a99d4cd17c748c9e4eacb056d759d63c5">BCHAN_SETUP</a>:
<a name="l02450"></a>02450          <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4aae16b0b226652124bc668657d98d52f7">BCHAN_SETUPED</a>);
<a name="l02451"></a>02451       <span class="keywordflow">break</span>;
<a name="l02452"></a>02452 
<a name="l02453"></a>02453       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4acac347e3046a60763322bcb9f26f1d9c">BCHAN_CLEAN_REQUEST</a>:
<a name="l02454"></a>02454       <span class="keywordflow">default</span>:
<a name="l02455"></a>02455          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot; --&gt; STATE WASN&apos;T SETUP (but %s) in SETSTACK|IND pid:%d\n&quot;</span>,<a class="code" href="isdn__lib_8c.html#ae2f4cc55968e9014a4daa06d1be05bef">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a>), bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l02456"></a>02456          <a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">clean_up_bc</a>(bc);
<a name="l02457"></a>02457       }
<a name="l02458"></a>02458       <span class="keywordflow">return</span> 1;
<a name="l02459"></a>02459 <span class="preprocessor">#endif</span>
<a name="l02460"></a>02460 <span class="preprocessor"></span>
<a name="l02461"></a>02461    <span class="keywordflow">case</span> MGR_DELLAYER| INDICATION:
<a name="l02462"></a>02462       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;BCHAN: MGR_DELLAYER|IND pid:%d\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l02463"></a>02463       <span class="keywordflow">break</span>;
<a name="l02464"></a>02464       
<a name="l02465"></a>02465    <span class="keywordflow">case</span> MGR_DELLAYER| CONFIRM:
<a name="l02466"></a>02466       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;BCHAN: MGR_DELLAYER|CNF pid:%d\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l02467"></a>02467       
<a name="l02468"></a>02468       bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>=0;
<a name="l02469"></a>02469       bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>=0;
<a name="l02470"></a>02470       
<a name="l02471"></a>02471       free_msg(msg);
<a name="l02472"></a>02472       <span class="keywordflow">return</span> 1;
<a name="l02473"></a>02473       
<a name="l02474"></a>02474    <span class="keywordflow">case</span> PH_ACTIVATE | INDICATION:
<a name="l02475"></a>02475    <span class="keywordflow">case</span> DL_ESTABLISH | INDICATION:
<a name="l02476"></a>02476       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;BCHAN: ACT Ind pid:%d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l02477"></a>02477 
<a name="l02478"></a>02478       free_msg(msg);
<a name="l02479"></a>02479       <span class="keywordflow">return</span> 1;    
<a name="l02480"></a>02480 
<a name="l02481"></a>02481    <span class="keywordflow">case</span> PH_ACTIVATE | CONFIRM:
<a name="l02482"></a>02482    <span class="keywordflow">case</span> DL_ESTABLISH | CONFIRM:
<a name="l02483"></a>02483       
<a name="l02484"></a>02484       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;BCHAN: bchan ACT Confirm pid:%d\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l02485"></a>02485       free_msg(msg);
<a name="l02486"></a>02486       
<a name="l02487"></a>02487       <span class="keywordflow">return</span> 1;    
<a name="l02488"></a>02488 
<a name="l02489"></a>02489    <span class="keywordflow">case</span> DL_ESTABLISH | REQUEST:
<a name="l02490"></a>02490       {
<a name="l02491"></a>02491          <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[128];
<a name="l02492"></a>02492          mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, buf, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> | FLG_MSG_TARGET | FLG_MSG_DOWN,  DL_ESTABLISH | CONFIRM, 0,0, NULL, TIMEOUT_1SEC);
<a name="l02493"></a>02493       }
<a name="l02494"></a>02494       free_msg(msg);
<a name="l02495"></a>02495       <span class="keywordflow">return</span> 1;
<a name="l02496"></a>02496 
<a name="l02497"></a>02497    <span class="keywordflow">case</span> DL_RELEASE|REQUEST:
<a name="l02498"></a>02498       {
<a name="l02499"></a>02499          <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[128];
<a name="l02500"></a>02500          mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, buf, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> | FLG_MSG_TARGET | FLG_MSG_DOWN,  DL_RELEASE| CONFIRM, 0,0, NULL, TIMEOUT_1SEC);
<a name="l02501"></a>02501       }
<a name="l02502"></a>02502       free_msg(msg);
<a name="l02503"></a>02503       <span class="keywordflow">return</span> 1;
<a name="l02504"></a>02504       
<a name="l02505"></a>02505    <span class="keywordflow">case</span> PH_DEACTIVATE | INDICATION:
<a name="l02506"></a>02506    <span class="keywordflow">case</span> DL_RELEASE | INDICATION:
<a name="l02507"></a>02507       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;BCHAN: DeACT Ind pid:%d\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l02508"></a>02508       
<a name="l02509"></a>02509       free_msg(msg);
<a name="l02510"></a>02510       <span class="keywordflow">return</span> 1;
<a name="l02511"></a>02511     
<a name="l02512"></a>02512    <span class="keywordflow">case</span> PH_DEACTIVATE | CONFIRM:
<a name="l02513"></a>02513    <span class="keywordflow">case</span> DL_RELEASE | CONFIRM:
<a name="l02514"></a>02514       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;BCHAN: DeACT Conf pid:%d\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l02515"></a>02515       
<a name="l02516"></a>02516       free_msg(msg);
<a name="l02517"></a>02517       <span class="keywordflow">return</span> 1;
<a name="l02518"></a>02518     
<a name="l02519"></a>02519    <span class="keywordflow">case</span> PH_CONTROL|INDICATION:
<a name="l02520"></a>02520    {
<a name="l02521"></a>02521       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *cont = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) &amp;frm-&gt;data.p;
<a name="l02522"></a>02522       
<a name="l02523"></a>02523       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;PH_CONTROL: channel:%d oad%d:%s dad%d:%s \n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aeea5d3e5d16496a8b3e35bdcf9faf3f0" title="Type-of-number in ISDN terms for the originating/calling number (Caller-ID).">onumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a8d2efe6f05b62dd9ce5153b822663083" title="Originating/Calling Phone Number (Address).">oad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a54e1096eacf895fbbee3b263b8a5af5a" title="Type-of-number in ISDN terms for the dialed/called number.">dnumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa306ec0dd386e28152b3f39d2a389402" title="Dialed/Called Phone Number (Address).">dad</a>);
<a name="l02524"></a>02524 
<a name="l02525"></a>02525       <span class="keywordflow">if</span> ((*cont &amp; ~DTMF_TONE_MASK) == DTMF_TONE_VAL) {
<a name="l02526"></a>02526          <span class="keywordtype">int</span> dtmf = *cont &amp; DTMF_TONE_MASK;
<a name="l02527"></a>02527          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; DTMF TONE: %c\n&quot;</span>,dtmf);
<a name="l02528"></a>02528          bc-&gt;<a class="code" href="structmisdn__bchannel.html#a7712c89c275129d6c964a44eae526548" title="Last decoded DTMF digit from mISDN driver.">dtmf</a>=dtmf;
<a name="l02529"></a>02529          <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a5453b43c808f36b08d5145be1856ae77">EVENT_DTMF_TONE</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l02530"></a>02530    
<a name="l02531"></a>02531          free_msg(msg);
<a name="l02532"></a>02532          <span class="keywordflow">return</span> 1;
<a name="l02533"></a>02533       }
<a name="l02534"></a>02534       <span class="keywordflow">if</span> (*cont == BF_REJECT) {
<a name="l02535"></a>02535          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; BF REJECT\n&quot;</span>);
<a name="l02536"></a>02536          free_msg(msg);
<a name="l02537"></a>02537          <span class="keywordflow">return</span> 1;
<a name="l02538"></a>02538       }
<a name="l02539"></a>02539       <span class="keywordflow">if</span> (*cont == BF_ACCEPT) {
<a name="l02540"></a>02540          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; BF ACCEPT\n&quot;</span>);
<a name="l02541"></a>02541          free_msg(msg);
<a name="l02542"></a>02542          <span class="keywordflow">return</span> 1;
<a name="l02543"></a>02543       }
<a name="l02544"></a>02544    }
<a name="l02545"></a>02545    <span class="keywordflow">break</span>;
<a name="l02546"></a>02546 
<a name="l02547"></a>02547    <span class="keywordflow">case</span> PH_DATA|REQUEST:
<a name="l02548"></a>02548    <span class="keywordflow">case</span> DL_DATA|REQUEST:
<a name="l02549"></a>02549       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;DL_DATA REQUEST \n&quot;</span>);
<a name="l02550"></a>02550       <a class="code" href="isdn__lib_8c.html#ad8d568b6bb7ab30a7fd634e4f33a76f9">do_tone</a>(bc, 64);
<a name="l02551"></a>02551       
<a name="l02552"></a>02552       free_msg(msg);
<a name="l02553"></a>02553       <span class="keywordflow">return</span> 1;
<a name="l02554"></a>02554    
<a name="l02555"></a>02555    
<a name="l02556"></a>02556    <span class="keywordflow">case</span> PH_DATA|INDICATION:
<a name="l02557"></a>02557    <span class="keywordflow">case</span> DL_DATA|INDICATION:
<a name="l02558"></a>02558    {
<a name="l02559"></a>02559       bc-&gt;<a class="code" href="structmisdn__bchannel.html#ac5bda3fccb33a8bce547ec92e92f27e5" title="B channel speech sample data buffer.">bframe</a> = (<span class="keywordtype">void</span>*)&amp;frm-&gt;data.i;
<a name="l02560"></a>02560       bc-&gt;<a class="code" href="structmisdn__bchannel.html#abd2b13dba522040010e392081c185e60" title="B channel speech sample data buffer size.">bframe_len</a> = frm-&gt;len;
<a name="l02561"></a>02561 <span class="comment"></span>
<a name="l02562"></a>02562 <span class="comment">      /** Anyway flip the bufbits **/</span>
<a name="l02563"></a>02563       if ( <a class="code" href="isdn__lib_8c.html#acaefa07620d12d0dc4f979c9e3c3f73e">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#afa05b14ff7f76f303c784c00c4c63fa7" title="SETUP message bearer capability field code value.">capability</a>) ) 
<a name="l02564"></a>02564          <a class="code" href="isdn__lib_8c.html#aec5e8bc764f0ae521c2e841d8609545d">flip_buf_bits</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#ac5bda3fccb33a8bce547ec92e92f27e5" title="B channel speech sample data buffer.">bframe</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#abd2b13dba522040010e392081c185e60" title="B channel speech sample data buffer size.">bframe_len</a>);
<a name="l02565"></a>02565    
<a name="l02566"></a>02566 
<a name="l02567"></a>02567       <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#abd2b13dba522040010e392081c185e60" title="B channel speech sample data buffer size.">bframe_len</a>) {
<a name="l02568"></a>02568          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;DL_DATA INDICATION bc-&gt;addr:%x frm-&gt;addr:%x\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>, frm-&gt;addr);
<a name="l02569"></a>02569          free_msg(msg);
<a name="l02570"></a>02570          <span class="keywordflow">return</span> 1;
<a name="l02571"></a>02571       }
<a name="l02572"></a>02572 
<a name="l02573"></a>02573       <span class="keywordflow">if</span> ( (bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>&amp;STACK_ID_MASK) != (frm-&gt;addr&amp;STACK_ID_MASK) ) {
<a name="l02574"></a>02574          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;DL_DATA INDICATION bc-&gt;addr:%x frm-&gt;addr:%x\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>, frm-&gt;addr);
<a name="l02575"></a>02575          free_msg(msg);
<a name="l02576"></a>02576          <span class="keywordflow">return</span> 1;
<a name="l02577"></a>02577       }
<a name="l02578"></a>02578       
<a name="l02579"></a>02579 <span class="preprocessor">#if MISDN_DEBUG</span>
<a name="l02580"></a>02580 <span class="preprocessor"></span>      <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;DL_DATA INDICATION Len %d\n&quot;</span>, frm-&gt;len);
<a name="l02581"></a>02581 
<a name="l02582"></a>02582 <span class="preprocessor">#endif</span>
<a name="l02583"></a>02583 <span class="preprocessor"></span>      
<a name="l02584"></a>02584       <span class="keywordflow">if</span> ( (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a> == <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a1b7d7fde2aa8ceca170c3d0f8283fbc0">BCHAN_ACTIVATED</a>) &amp;&amp; frm-&gt;len &gt; 0) {
<a name="l02585"></a>02585          <span class="keywordtype">int</span> t;
<a name="l02586"></a>02586 
<a name="l02587"></a>02587 <span class="preprocessor">#ifdef MISDN_B_DEBUG</span>
<a name="l02588"></a>02588 <span class="preprocessor"></span>         <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;do_tone START\n&quot;</span>);
<a name="l02589"></a>02589 <span class="preprocessor">#endif</span>
<a name="l02590"></a>02590 <span class="preprocessor"></span>         t=<a class="code" href="isdn__lib_8c.html#ad8d568b6bb7ab30a7fd634e4f33a76f9">do_tone</a>(bc,frm-&gt;len);
<a name="l02591"></a>02591 
<a name="l02592"></a>02592 <span class="preprocessor">#ifdef MISDN_B_DEBUG</span>
<a name="l02593"></a>02593 <span class="preprocessor"></span>         <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;do_tone STOP (%d)\n&quot;</span>,t);
<a name="l02594"></a>02594 <span class="preprocessor">#endif</span>
<a name="l02595"></a>02595 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (  !t ) {
<a name="l02596"></a>02596             <span class="keywordtype">int</span> i;
<a name="l02597"></a>02597             
<a name="l02598"></a>02598             <span class="keywordflow">if</span> ( <a class="code" href="isdn__lib_8c.html#acaefa07620d12d0dc4f979c9e3c3f73e">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#afa05b14ff7f76f303c784c00c4c63fa7" title="SETUP message bearer capability field code value.">capability</a>)) {
<a name="l02599"></a>02599                <span class="keywordflow">if</span> ( !bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6bb23a220a9276463546e4b5faa28e36" title="TRUE if we will not use the jitter buffer system.">nojitter</a> ) {
<a name="l02600"></a>02600 <span class="preprocessor">#ifdef MISDN_B_DEBUG</span>
<a name="l02601"></a>02601 <span class="preprocessor"></span>                  <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;tx_jitter START\n&quot;</span>);
<a name="l02602"></a>02602 <span class="preprocessor">#endif</span>
<a name="l02603"></a>02603 <span class="preprocessor"></span>                  <a class="code" href="isdn__lib_8c.html#a4b517b8a0f6a3571dba3ec48eed7ff0d">misdn_tx_jitter</a>(bc,frm-&gt;len);
<a name="l02604"></a>02604 <span class="preprocessor">#ifdef MISDN_B_DEBUG</span>
<a name="l02605"></a>02605 <span class="preprocessor"></span>                  <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;tx_jitter STOP\n&quot;</span>);
<a name="l02606"></a>02606 <span class="preprocessor">#endif</span>
<a name="l02607"></a>02607 <span class="preprocessor"></span>               }
<a name="l02608"></a>02608             }
<a name="l02609"></a>02609 
<a name="l02610"></a>02610 <span class="preprocessor">#ifdef MISDN_B_DEBUG </span>
<a name="l02611"></a>02611 <span class="preprocessor"></span>            <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;EVENT_B_DATA START\n&quot;</span>);
<a name="l02612"></a>02612 <span class="preprocessor">#endif</span>
<a name="l02613"></a>02613 <span class="preprocessor"></span>            
<a name="l02614"></a>02614             i = <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a6b6590a1b67d07a9e1ab635a6cc1ebde">EVENT_BCHAN_DATA</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l02615"></a>02615 <span class="preprocessor">#ifdef MISDN_B_DEBUG </span>
<a name="l02616"></a>02616 <span class="preprocessor"></span>            <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;EVENT_B_DATA STOP\n&quot;</span>);
<a name="l02617"></a>02617 <span class="preprocessor">#endif</span>
<a name="l02618"></a>02618 <span class="preprocessor"></span>            
<a name="l02619"></a>02619             <span class="keywordflow">if</span> (i&lt;0) {
<a name="l02620"></a>02620                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(10,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;cb_event returned &lt;0\n&quot;</span>);
<a name="l02621"></a>02621                <span class="comment">/*clean_up_bc(bc);*/</span>
<a name="l02622"></a>02622             }
<a name="l02623"></a>02623          }
<a name="l02624"></a>02624       }
<a name="l02625"></a>02625       free_msg(msg);
<a name="l02626"></a>02626       <span class="keywordflow">return</span> 1;
<a name="l02627"></a>02627    }
<a name="l02628"></a>02628 
<a name="l02629"></a>02629 
<a name="l02630"></a>02630    <span class="keywordflow">case</span> PH_CONTROL | CONFIRM:
<a name="l02631"></a>02631       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;PH_CONTROL|CNF bc-&gt;addr:%x\n&quot;</span>, frm-&gt;addr);
<a name="l02632"></a>02632       free_msg(msg);
<a name="l02633"></a>02633       <span class="keywordflow">return</span> 1;
<a name="l02634"></a>02634 
<a name="l02635"></a>02635    <span class="keywordflow">case</span> PH_DATA | CONFIRM:
<a name="l02636"></a>02636    <span class="keywordflow">case</span> DL_DATA|CONFIRM:
<a name="l02637"></a>02637 <span class="preprocessor">#if MISDN_DEBUG</span>
<a name="l02638"></a>02638 <span class="preprocessor"></span>
<a name="l02639"></a>02639       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Data confirmed\n&quot;</span>);
<a name="l02640"></a>02640 
<a name="l02641"></a>02641 <span class="preprocessor">#endif</span>
<a name="l02642"></a>02642 <span class="preprocessor"></span>      free_msg(msg);
<a name="l02643"></a>02643       <span class="keywordflow">return</span> 1;
<a name="l02644"></a>02644    <span class="keywordflow">case</span> DL_DATA|RESPONSE:
<a name="l02645"></a>02645 <span class="preprocessor">#if MISDN_DEBUG</span>
<a name="l02646"></a>02646 <span class="preprocessor"></span>      <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Data response\n&quot;</span>);
<a name="l02647"></a>02647 
<a name="l02648"></a>02648 <span class="preprocessor">#endif</span>
<a name="l02649"></a>02649 <span class="preprocessor"></span>      <span class="keywordflow">break</span>;
<a name="l02650"></a>02650    }
<a name="l02651"></a>02651   
<a name="l02652"></a>02652    <span class="keywordflow">return</span> 0;
<a name="l02653"></a>02653 }
<a name="l02654"></a>02654 
<a name="l02655"></a>02655 
<a name="l02656"></a>02656 
<a name="l02657"></a><a class="code" href="isdn__lib_8c.html#aa98cf643b7264af96fa498d27e2d24bf">02657</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#aa98cf643b7264af96fa498d27e2d24bf">handle_frm_nt</a>(msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)
<a name="l02658"></a>02658 {
<a name="l02659"></a>02659    iframe_t *frm= (iframe_t*)msg-&gt;data;
<a name="l02660"></a>02660    <span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l02661"></a>02661    <span class="keywordtype">int</span> err=0;
<a name="l02662"></a>02662 
<a name="l02663"></a>02663    stack=<a class="code" href="isdn__lib_8c.html#a7db594d519df4dae7eb3dbd1b128d6f8">find_stack_by_addr</a>( frm-&gt;addr );
<a name="l02664"></a>02664 
<a name="l02665"></a>02665    
<a name="l02666"></a>02666   
<a name="l02667"></a>02667    <span class="keywordflow">if</span> (!stack || !stack-&gt;nt) {
<a name="l02668"></a>02668       <span class="keywordflow">return</span> 0;
<a name="l02669"></a>02669    }
<a name="l02670"></a>02670 
<a name="l02671"></a>02671    
<a name="l02672"></a>02672    <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;nstlock);
<a name="l02673"></a>02673    <span class="keywordflow">if</span> ((err=stack-&gt;nst.l1_l2(&amp;stack-&gt;nst,msg))) {
<a name="l02674"></a>02674       <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;nstlock);
<a name="l02675"></a>02675       <span class="keywordflow">if</span> (nt_err_cnt &gt; 0 ) {
<a name="l02676"></a>02676          <span class="keywordflow">if</span> (nt_err_cnt &lt; 100) {
<a name="l02677"></a>02677             nt_err_cnt++; 
<a name="l02678"></a>02678             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;port, <span class="stringliteral">&quot;NT Stack sends us error: %d \n&quot;</span>, err);
<a name="l02679"></a>02679          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nt_err_cnt &lt; 105){
<a name="l02680"></a>02680             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;port, <span class="stringliteral">&quot;NT Stack sends us error: %d over 100 times, so I&apos;ll stop this message\n&quot;</span>, err);
<a name="l02681"></a>02681             nt_err_cnt = - 1; 
<a name="l02682"></a>02682          }
<a name="l02683"></a>02683       }
<a name="l02684"></a>02684       free_msg(msg);
<a name="l02685"></a>02685       <span class="keywordflow">return</span> 1;
<a name="l02686"></a>02686    }
<a name="l02687"></a>02687    <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;nstlock);
<a name="l02688"></a>02688    <span class="keywordflow">return</span> 1;
<a name="l02689"></a>02689 }
<a name="l02690"></a>02690 
<a name="l02691"></a>02691 
<a name="l02692"></a><a class="code" href="isdn__lib_8c.html#adb9c8ee3cfac44315944b3991a141f13">02692</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#adb9c8ee3cfac44315944b3991a141f13">handle_frm</a>(msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)
<a name="l02693"></a>02693 {
<a name="l02694"></a>02694    iframe_t *frm = (iframe_t*) msg-&gt;data;
<a name="l02695"></a>02695    
<a name="l02696"></a>02696    <span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a7db594d519df4dae7eb3dbd1b128d6f8">find_stack_by_addr</a>(frm-&gt;addr);
<a name="l02697"></a>02697 
<a name="l02698"></a>02698    <span class="keywordflow">if</span> (!stack || stack-&gt;nt) {
<a name="l02699"></a>02699       <span class="keywordflow">return</span> 0;
<a name="l02700"></a>02700    }
<a name="l02701"></a>02701    
<a name="l02702"></a>02702    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,stack?stack-&gt;port:0,<span class="stringliteral">&quot;handle_frm: frm-&gt;addr:%x frm-&gt;prim:%x\n&quot;</span>,frm-&gt;addr,frm-&gt;prim);
<a name="l02703"></a>02703 
<a name="l02704"></a>02704    {
<a name="l02705"></a>02705       <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> dummybc;
<a name="l02706"></a>02706       <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc;
<a name="l02707"></a>02707       <span class="keywordtype">int</span> ret=<a class="code" href="isdn__lib_8c.html#a787e765292d60ac1cc701eec9939a210">handle_cr</a>(stack, frm);
<a name="l02708"></a>02708 
<a name="l02709"></a>02709       <span class="keywordflow">if</span> (ret&lt;0) {
<a name="l02710"></a>02710          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3,stack?stack-&gt;port:0,<span class="stringliteral">&quot;handle_frm: handle_cr &lt;0 prim:%x addr:%x\n&quot;</span>, frm-&gt;prim, frm-&gt;addr);
<a name="l02711"></a>02711 
<a name="l02712"></a>02712 
<a name="l02713"></a>02713       }
<a name="l02714"></a>02714 
<a name="l02715"></a>02715       <span class="keywordflow">if</span>(ret) {
<a name="l02716"></a>02716          free_msg(msg);
<a name="l02717"></a>02717          <span class="keywordflow">return</span> 1;
<a name="l02718"></a>02718       }
<a name="l02719"></a>02719     
<a name="l02720"></a>02720       bc=<a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(stack, frm-&gt;dinfo);
<a name="l02721"></a>02721 
<a name="l02722"></a>02722       <span class="keywordflow">if</span> (!bc &amp;&amp; (frm-&gt;prim==(CC_RESTART|CONFIRM)) ) {
<a name="l02723"></a>02723          <a class="code" href="isdn__lib_8c.html#aeb7cfd0342e0a820eb3d7302401c9c74">misdn_make_dummy</a>(&amp;dummybc, stack-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, MISDN_ID_GLOBAL, stack-&gt;nt, 0);
<a name="l02724"></a>02724          bc=&amp;dummybc;
<a name="l02725"></a>02725       }
<a name="l02726"></a>02726 
<a name="l02727"></a>02727       <span class="keywordflow">if</span> (!bc &amp;&amp; (frm-&gt;prim==(CC_SETUP|INDICATION)) ) {
<a name="l02728"></a>02728          <a class="code" href="isdn__lib_8c.html#aeb7cfd0342e0a820eb3d7302401c9c74">misdn_make_dummy</a>(&amp;dummybc, stack-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, MISDN_ID_GLOBAL, stack-&gt;nt, 0);
<a name="l02729"></a>02729          dummybc.<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>=stack-&gt;port;
<a name="l02730"></a>02730          dummybc.<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>=frm-&gt;dinfo;
<a name="l02731"></a>02731          bc=&amp;dummybc;
<a name="l02732"></a>02732 
<a name="l02733"></a>02733          <a class="code" href="isdn__lib_8c.html#a9b9f5e8fc32b68c5d1a0c28d7ee40fb3">misdn_lib_send_event</a>(bc,<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a2473594848bb5e1cb2eafb862337f51a">EVENT_RELEASE_COMPLETE</a>);
<a name="l02734"></a>02734 
<a name="l02735"></a>02735          free_msg(msg);
<a name="l02736"></a>02736          <span class="keywordflow">return</span> 1;
<a name="l02737"></a>02737       }
<a name="l02738"></a>02738 
<a name="l02739"></a>02739     
<a name="l02740"></a>02740 handle_frm_bc:
<a name="l02741"></a>02741       <span class="keywordflow">if</span> (bc ) {
<a name="l02742"></a>02742          <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0">event_e</a> <span class="keyword">event</span> = <a class="code" href="isdn__lib__intern_8h.html#a7a92a25c6c4083aee9277797c24977e9">isdn_msg_get_event</a>(<a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a>, msg, 0);
<a name="l02743"></a>02743          <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#aa6143baad2c3764c9d130d676850196b">event_response_e</a> response=<a class="code" href="isdn__lib_8h.html#aa6143baad2c3764c9d130d676850196bad9a009eaad7d808678adbea41b8b1faa">RESPONSE_OK</a>;
<a name="l02744"></a>02744          <span class="keywordtype">int</span> ret;
<a name="l02745"></a>02745       
<a name="l02746"></a>02746          <a class="code" href="isdn__lib__intern_8h.html#a6fb028d4322a5a9d1a09ec780c73d05d">isdn_msg_parse_event</a>(<a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a>,msg,bc, 0);
<a name="l02747"></a>02747          <span class="comment"></span>
<a name="l02748"></a>02748 <span class="comment">         /** Preprocess some Events **/</span>
<a name="l02749"></a>02749          ret = <a class="code" href="isdn__lib_8c.html#aa14033d61f7f3192cbf76c6b1d76dd49">handle_event</a>(bc, event, frm);
<a name="l02750"></a>02750          <span class="keywordflow">if</span> (ret&lt;0) {
<a name="l02751"></a>02751             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,stack-&gt;port,<span class="stringliteral">&quot;couldn&apos;t handle event\n&quot;</span>);
<a name="l02752"></a>02752             free_msg(msg);
<a name="l02753"></a>02753             <span class="keywordflow">return</span> 1;
<a name="l02754"></a>02754          }
<a name="l02755"></a>02755          <span class="comment">/*  shoot up event to App: */</span>
<a name="l02756"></a>02756          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5, stack-&gt;port, <span class="stringliteral">&quot;lib Got Prim: Addr %x prim %x dinfo %x\n&quot;</span>,frm-&gt;addr, frm-&gt;prim, frm-&gt;dinfo);
<a name="l02757"></a>02757       
<a name="l02758"></a>02758          <span class="keywordflow">if</span>(!<a class="code" href="isdn__lib__intern_8h.html#a622bd30db092a77314ee5e5581a80f75">isdn_get_info</a>(<a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a>,event,0)) 
<a name="l02759"></a>02759             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;port, <span class="stringliteral">&quot;Unknown Event Ind: Addr:%x prim %x dinfo %x\n&quot;</span>,frm-&gt;addr, frm-&gt;prim, frm-&gt;dinfo);
<a name="l02760"></a>02760          <span class="keywordflow">else</span>
<a name="l02761"></a>02761             response=<a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(event, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l02762"></a>02762 <span class="preprocessor">#if 1</span>
<a name="l02763"></a>02763 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (event == <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a71b67c9dd659e015ff13d68c2d3ea2aa">EVENT_SETUP</a>) {
<a name="l02764"></a>02764             <span class="keywordflow">switch</span> (response) {
<a name="l02765"></a>02765             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#aa6143baad2c3764c9d130d676850196ba762089f99cfe26124dfe5d7e8c11eb17">RESPONSE_IGNORE_SETUP_WITHOUT_CLOSE</a>:
<a name="l02766"></a>02766 
<a name="l02767"></a>02767                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;port, <span class="stringliteral">&quot;TOTALLY IGNORING SETUP\n&quot;</span>);               
<a name="l02768"></a>02768                
<a name="l02769"></a>02769                <span class="keywordflow">break</span>;
<a name="l02770"></a>02770             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#aa6143baad2c3764c9d130d676850196ba92645dbc0821c091a863bbbaf604a531">RESPONSE_IGNORE_SETUP</a>:
<a name="l02771"></a>02771                <span class="comment">/* I think we should send CC_RELEASE_CR, but am not sure*/</span>
<a name="l02772"></a>02772                bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1b724daeb32d8d023765605586269a02" title="Q.931 Cause for disconnection code (sent).">out_cause</a> = <a class="code" href="causes_8h.html#af2235eb1c27925e4020ce286255d165f">AST_CAUSE_NORMAL_CLEARING</a>;
<a name="l02773"></a>02773             
<a name="l02774"></a>02774             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#aa6143baad2c3764c9d130d676850196badeaf958617ddd900889fd5e0ea523cf9">RESPONSE_RELEASE_SETUP</a>:
<a name="l02775"></a>02775                <a class="code" href="isdn__lib_8c.html#a9b9f5e8fc32b68c5d1a0c28d7ee40fb3">misdn_lib_send_event</a>(bc,<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a2473594848bb5e1cb2eafb862337f51a">EVENT_RELEASE_COMPLETE</a>);
<a name="l02776"></a>02776                <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>&gt;0)
<a name="l02777"></a>02777                   <a class="code" href="isdn__lib_8c.html#a9f849e8a799ef7d6a52f6a10ec4446e5">empty_chan_in_stack</a>(stack, bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>);
<a name="l02778"></a>02778                <a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">empty_bc</a>(bc);
<a name="l02779"></a>02779                <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4aeb34fa6afdc8da6670a1e3a14c85c6fa">BCHAN_CLEANED</a>);
<a name="l02780"></a>02780                bc-&gt;<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a>=0;
<a name="l02781"></a>02781 
<a name="l02782"></a>02782                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;port, <span class="stringliteral">&quot;GOT IGNORE SETUP\n&quot;</span>);
<a name="l02783"></a>02783                <span class="keywordflow">break</span>;
<a name="l02784"></a>02784             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#aa6143baad2c3764c9d130d676850196bad9a009eaad7d808678adbea41b8b1faa">RESPONSE_OK</a>:
<a name="l02785"></a>02785                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;port, <span class="stringliteral">&quot;GOT SETUP OK\n&quot;</span>);
<a name="l02786"></a>02786 
<a name="l02787"></a>02787                
<a name="l02788"></a>02788                <span class="keywordflow">break</span>;
<a name="l02789"></a>02789             <span class="keywordflow">default</span>:
<a name="l02790"></a>02790                <span class="keywordflow">break</span>;
<a name="l02791"></a>02791             }
<a name="l02792"></a>02792          }
<a name="l02793"></a>02793 
<a name="l02794"></a>02794          <span class="keywordflow">if</span> (event == <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a2473594848bb5e1cb2eafb862337f51a">EVENT_RELEASE_COMPLETE</a>) {
<a name="l02795"></a>02795             <span class="comment">/* release bchannel only after we&apos;ve announced the RELEASE_COMPLETE */</span>
<a name="l02796"></a>02796             <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>=bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>;
<a name="l02797"></a>02797             <span class="keywordtype">int</span> tmpcause=bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa4d0ccb9d0904892652f2f258c5ad225" title="Q.931 Cause for disconnection code (received).">cause</a>; 
<a name="l02798"></a>02798             <span class="keywordtype">int</span> tmp_out_cause=bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1b724daeb32d8d023765605586269a02" title="Q.931 Cause for disconnection code (sent).">out_cause</a>; 
<a name="l02799"></a>02799             <a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">empty_bc</a>(bc);
<a name="l02800"></a>02800             bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa4d0ccb9d0904892652f2f258c5ad225" title="Q.931 Cause for disconnection code (received).">cause</a>=tmpcause;
<a name="l02801"></a>02801             bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1b724daeb32d8d023765605586269a02" title="Q.931 Cause for disconnection code (sent).">out_cause</a>=tmp_out_cause;
<a name="l02802"></a>02802             <a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">clean_up_bc</a>(bc);
<a name="l02803"></a>02803             bc-&gt;<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a> = 0;
<a name="l02804"></a>02804             
<a name="l02805"></a>02805             <span class="keywordflow">if</span> (tmpcause == <a class="code" href="causes_8h.html#a7f49d27e9e3876fb4ccf1d139d31db73">AST_CAUSE_REQUESTED_CHAN_UNAVAIL</a>) {
<a name="l02806"></a>02806                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;port, <span class="stringliteral">&quot;**** Received CAUSE:%d, restarting channel %d\n&quot;</span>, <a class="code" href="causes_8h.html#a7f49d27e9e3876fb4ccf1d139d31db73">AST_CAUSE_REQUESTED_CHAN_UNAVAIL</a>, channel);
<a name="l02807"></a>02807                <a class="code" href="isdn__lib_8c.html#a5eece989af344908ee385f23239508da">misdn_lib_send_restart</a>(stack-&gt;port, channel);
<a name="l02808"></a>02808             }
<a name="l02809"></a>02809             <span class="keywordflow">if</span> (channel &gt; 0) {
<a name="l02810"></a>02810                <a class="code" href="isdn__lib_8c.html#a9f849e8a799ef7d6a52f6a10ec4446e5">empty_chan_in_stack</a>(stack, channel);
<a name="l02811"></a>02811             }
<a name="l02812"></a>02812          }
<a name="l02813"></a>02813 
<a name="l02814"></a>02814          <span class="keywordflow">if</span> (event == <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a5932a8e4c466cdd288c5133486bf386c">EVENT_RESTART</a>) {
<a name="l02815"></a>02815             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;port, <span class="stringliteral">&quot;**** Received RESTART channel:%d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa003639bc50e231ad599d9ce4a476cd7" title="B channel to restart if received a RESTART message.">restart_channel</a>);
<a name="l02816"></a>02816             <a class="code" href="isdn__lib_8c.html#a9f849e8a799ef7d6a52f6a10ec4446e5">empty_chan_in_stack</a>(stack, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa003639bc50e231ad599d9ce4a476cd7" title="B channel to restart if received a RESTART message.">restart_channel</a>);
<a name="l02817"></a>02817          }
<a name="l02818"></a>02818 
<a name="l02819"></a>02819          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5, stack-&gt;port, <span class="stringliteral">&quot;Freeing Msg on prim:%x \n&quot;</span>,frm-&gt;prim);
<a name="l02820"></a>02820 
<a name="l02821"></a>02821          
<a name="l02822"></a>02822          free_msg(msg);
<a name="l02823"></a>02823          <span class="keywordflow">return</span> 1;
<a name="l02824"></a>02824 <span class="preprocessor">#endif</span>
<a name="l02825"></a>02825 <span class="preprocessor"></span>      
<a name="l02826"></a>02826       } <span class="keywordflow">else</span> {
<a name="l02827"></a>02827          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> dummybc;
<a name="l02828"></a>02828          <span class="keywordflow">if</span> (frm-&gt;prim!=(CC_FACILITY|INDICATION))
<a name="l02829"></a>02829             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;port, <span class="stringliteral">&quot; --&gt; Didn&apos;t find BC so temporarily creating dummy BC (l3id:%x) on this port.\n&quot;</span>, frm-&gt;dinfo);
<a name="l02830"></a>02830          <span class="keywordflow">else</span>
<a name="l02831"></a>02831             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5, stack-&gt;port, <span class="stringliteral">&quot; --&gt; Using Dummy BC for FACILITY\n&quot;</span>);
<a name="l02832"></a>02832 
<a name="l02833"></a>02833          memset (&amp;dummybc,0,<span class="keyword">sizeof</span>(dummybc));
<a name="l02834"></a>02834          dummybc.<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>=stack-&gt;port;
<a name="l02835"></a>02835          dummybc.<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>=frm-&gt;dinfo;
<a name="l02836"></a>02836          bc=&amp;dummybc; 
<a name="l02837"></a>02837          <span class="keywordflow">goto</span> handle_frm_bc;
<a name="l02838"></a>02838       }
<a name="l02839"></a>02839    }
<a name="l02840"></a>02840 
<a name="l02841"></a>02841    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;port, <span class="stringliteral">&quot;TE_FRM_HANDLER: Returning 0 on prim:%x \n&quot;</span>,frm-&gt;prim);
<a name="l02842"></a>02842    <span class="keywordflow">return</span> 0;
<a name="l02843"></a>02843 }
<a name="l02844"></a>02844 
<a name="l02845"></a>02845 
<a name="l02846"></a><a class="code" href="isdn__lib_8c.html#ac46cfb402396907e0f285b0e545afc01">02846</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#ac46cfb402396907e0f285b0e545afc01">handle_l1</a>(msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)
<a name="l02847"></a>02847 {
<a name="l02848"></a>02848    iframe_t *frm = (iframe_t*) msg-&gt;data;
<a name="l02849"></a>02849    <span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack = <a class="code" href="isdn__lib_8c.html#a7db594d519df4dae7eb3dbd1b128d6f8">find_stack_by_addr</a>(frm-&gt;addr);
<a name="l02850"></a>02850    <span class="keywordtype">int</span> i ;
<a name="l02851"></a>02851    
<a name="l02852"></a>02852    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span> 0 ;
<a name="l02853"></a>02853 
<a name="l02854"></a>02854    <span class="keywordflow">switch</span> (frm-&gt;prim) {
<a name="l02855"></a>02855    <span class="keywordflow">case</span> PH_ACTIVATE | CONFIRM:
<a name="l02856"></a>02856    <span class="keywordflow">case</span> PH_ACTIVATE | INDICATION:
<a name="l02857"></a>02857       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (3, stack-&gt;port, <span class="stringliteral">&quot;L1: PH L1Link Up!\n&quot;</span>);
<a name="l02858"></a>02858       stack-&gt;l1link=1;
<a name="l02859"></a>02859       
<a name="l02860"></a>02860       <span class="keywordflow">if</span> (stack-&gt;nt) {
<a name="l02861"></a>02861          
<a name="l02862"></a>02862          <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;nstlock);
<a name="l02863"></a>02863          <span class="keywordflow">if</span> (stack-&gt;nst.l1_l2(&amp;stack-&gt;nst, msg))
<a name="l02864"></a>02864             free_msg(msg);
<a name="l02865"></a>02865          <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;nstlock);
<a name="l02866"></a>02866 
<a name="l02867"></a>02867          <span class="keywordflow">if</span> (stack-&gt;ptp)
<a name="l02868"></a>02868             <a class="code" href="isdn__lib_8c.html#af03ad57836b38845f685368e60625707">misdn_lib_get_l2_up</a>(stack);
<a name="l02869"></a>02869       } <span class="keywordflow">else</span> {
<a name="l02870"></a>02870          free_msg(msg);
<a name="l02871"></a>02871       }
<a name="l02872"></a>02872       
<a name="l02873"></a>02873       <span class="keywordflow">for</span> (i=0;i&lt;=stack-&gt;b_num; i++) {
<a name="l02874"></a>02874          <span class="keywordflow">if</span> (stack-&gt;bc[i].evq != <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a9615f92c3638ed613857ed48d0612a4c">EVENT_NOTHING</a>) {
<a name="l02875"></a>02875             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;port, <span class="stringliteral">&quot;Firing Queued Event %s because L1 got up\n&quot;</span>, <a class="code" href="isdn__lib__intern_8h.html#a622bd30db092a77314ee5e5581a80f75">isdn_get_info</a>(<a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a>, stack-&gt;bc[i].evq, 0));
<a name="l02876"></a>02876             <a class="code" href="isdn__lib_8c.html#a9b9f5e8fc32b68c5d1a0c28d7ee40fb3">misdn_lib_send_event</a>(&amp;stack-&gt;bc[i],stack-&gt;bc[i].evq);
<a name="l02877"></a>02877             stack-&gt;bc[i].evq=<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a9615f92c3638ed613857ed48d0612a4c">EVENT_NOTHING</a>;
<a name="l02878"></a>02878          }
<a name="l02879"></a>02879          
<a name="l02880"></a>02880       }
<a name="l02881"></a>02881       <span class="keywordflow">return</span> 1;
<a name="l02882"></a>02882 
<a name="l02883"></a>02883    <span class="keywordflow">case</span> PH_ACTIVATE | REQUEST:
<a name="l02884"></a>02884       free_msg(msg);
<a name="l02885"></a>02885       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3,stack-&gt;port,<span class="stringliteral">&quot;L1: PH_ACTIVATE|REQUEST \n&quot;</span>);
<a name="l02886"></a>02886       <span class="keywordflow">return</span> 1;
<a name="l02887"></a>02887       
<a name="l02888"></a>02888    <span class="keywordflow">case</span> PH_DEACTIVATE | REQUEST:
<a name="l02889"></a>02889       free_msg(msg);
<a name="l02890"></a>02890       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3,stack-&gt;port,<span class="stringliteral">&quot;L1: PH_DEACTIVATE|REQUEST \n&quot;</span>);
<a name="l02891"></a>02891       <span class="keywordflow">return</span> 1;
<a name="l02892"></a>02892       
<a name="l02893"></a>02893    <span class="keywordflow">case</span> PH_DEACTIVATE | CONFIRM:
<a name="l02894"></a>02894    <span class="keywordflow">case</span> PH_DEACTIVATE | INDICATION:
<a name="l02895"></a>02895       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (3, stack-&gt;port, <span class="stringliteral">&quot;L1: PH L1Link Down! \n&quot;</span>);
<a name="l02896"></a>02896    
<a name="l02897"></a>02897 <span class="preprocessor">#if 0</span>
<a name="l02898"></a>02898 <span class="preprocessor"></span>      <span class="keywordflow">for</span> (i=0; i&lt;=stack-&gt;b_num; i++) {
<a name="l02899"></a>02899          <span class="keywordflow">if</span> (global_state == <a class="code" href="isdn__lib_8c.html#af1db0e676da5eccb2fa1d40ae01412a8a2e1eacba6b620d51dce53d3bd8cffd4e">MISDN_INITIALIZED</a>)  {
<a name="l02900"></a>02900             <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0ac49b8317168e8506edc0de2450658541">EVENT_CLEANUP</a>, &amp;stack-&gt;bc[i], glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l02901"></a>02901          }
<a name="l02902"></a>02902       }
<a name="l02903"></a>02903 <span class="preprocessor">#endif</span>
<a name="l02904"></a>02904 <span class="preprocessor"></span>      
<a name="l02905"></a>02905       <span class="keywordflow">if</span> (stack-&gt;nt) {
<a name="l02906"></a>02906          <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;nstlock);
<a name="l02907"></a>02907          <span class="keywordflow">if</span> (stack-&gt;nst.l1_l2(&amp;stack-&gt;nst, msg))
<a name="l02908"></a>02908             free_msg(msg);
<a name="l02909"></a>02909          <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;nstlock);
<a name="l02910"></a>02910       } <span class="keywordflow">else</span> {
<a name="l02911"></a>02911          free_msg(msg);
<a name="l02912"></a>02912       }
<a name="l02913"></a>02913       
<a name="l02914"></a>02914       stack-&gt;l1link=0;
<a name="l02915"></a>02915       stack-&gt;l2link=0;
<a name="l02916"></a>02916       <span class="keywordflow">return</span> 1;
<a name="l02917"></a>02917    }
<a name="l02918"></a>02918   
<a name="l02919"></a>02919    <span class="keywordflow">return</span> 0;
<a name="l02920"></a>02920 }
<a name="l02921"></a>02921 
<a name="l02922"></a><a class="code" href="isdn__lib_8c.html#a035253f6b68b342189bc33f12250cddf">02922</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a035253f6b68b342189bc33f12250cddf">handle_l2</a>(msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)
<a name="l02923"></a>02923 {
<a name="l02924"></a>02924    iframe_t *frm = (iframe_t*) msg-&gt;data;
<a name="l02925"></a>02925 
<a name="l02926"></a>02926    <span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack = <a class="code" href="isdn__lib_8c.html#a7db594d519df4dae7eb3dbd1b128d6f8">find_stack_by_addr</a>(frm-&gt;addr);
<a name="l02927"></a>02927    
<a name="l02928"></a>02928    <span class="keywordflow">if</span> (!stack) {
<a name="l02929"></a>02929       <span class="keywordflow">return</span> 0 ;
<a name="l02930"></a>02930    }
<a name="l02931"></a>02931    
<a name="l02932"></a>02932    <span class="keywordflow">switch</span>(frm-&gt;prim) {
<a name="l02933"></a>02933 
<a name="l02934"></a>02934    <span class="keywordflow">case</span> DL_ESTABLISH | REQUEST:
<a name="l02935"></a>02935       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1,stack-&gt;port,<span class="stringliteral">&quot;DL_ESTABLISH|REQUEST \n&quot;</span>);
<a name="l02936"></a>02936       free_msg(msg);
<a name="l02937"></a>02937       <span class="keywordflow">return</span> 1;
<a name="l02938"></a>02938    <span class="keywordflow">case</span> DL_RELEASE | REQUEST:
<a name="l02939"></a>02939       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1,stack-&gt;port,<span class="stringliteral">&quot;DL_RELEASE|REQUEST \n&quot;</span>);
<a name="l02940"></a>02940       free_msg(msg);
<a name="l02941"></a>02941       <span class="keywordflow">return</span> 1;
<a name="l02942"></a>02942       
<a name="l02943"></a>02943    <span class="keywordflow">case</span> DL_ESTABLISH | INDICATION:
<a name="l02944"></a>02944    <span class="keywordflow">case</span> DL_ESTABLISH | CONFIRM:
<a name="l02945"></a>02945    {
<a name="l02946"></a>02946       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (3, stack-&gt;port, <span class="stringliteral">&quot;L2: L2Link Up! \n&quot;</span>);
<a name="l02947"></a>02947       <span class="keywordflow">if</span> (stack-&gt;ptp &amp;&amp; stack-&gt;l2link) {
<a name="l02948"></a>02948          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (-1, stack-&gt;port, <span class="stringliteral">&quot;L2: L2Link Up! but it&apos;s already UP.. must be faulty, blocking port\n&quot;</span>); 
<a name="l02949"></a>02949          <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a50ddddd2e7ed5ebc329cb84f494c59dd">EVENT_PORT_ALARM</a>, &amp;stack-&gt;bc[0], glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a0f53d287ac7c064d1a49d4bd93ca1cb9">user_data</a>);
<a name="l02950"></a>02950       }
<a name="l02951"></a>02951       stack-&gt;l2link=1;
<a name="l02952"></a>02952       free_msg(msg);
<a name="l02953"></a>02953       <span class="keywordflow">return</span> 1;
<a name="l02954"></a>02954    }
<a name="l02955"></a>02955    <span class="keywordflow">break</span>;
<a name="l02956"></a>02956     
<a name="l02957"></a>02957    <span class="keywordflow">case</span> DL_RELEASE | INDICATION:
<a name="l02958"></a>02958    <span class="keywordflow">case</span> DL_RELEASE | CONFIRM:
<a name="l02959"></a>02959    {
<a name="l02960"></a>02960       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (3, stack-&gt;port, <span class="stringliteral">&quot;L2: L2Link Down! \n&quot;</span>);
<a name="l02961"></a>02961       stack-&gt;l2link=0;
<a name="l02962"></a>02962       
<a name="l02963"></a>02963       free_msg(msg);
<a name="l02964"></a>02964       <span class="keywordflow">return</span> 1;
<a name="l02965"></a>02965    }
<a name="l02966"></a>02966    <span class="keywordflow">break</span>;
<a name="l02967"></a>02967    }
<a name="l02968"></a>02968    <span class="keywordflow">return</span> 0;
<a name="l02969"></a>02969 }
<a name="l02970"></a>02970 
<a name="l02971"></a><a class="code" href="isdn__lib_8c.html#aa1f1bdac7d1036dd1d6cd3f7e10da56f">02971</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#aa1f1bdac7d1036dd1d6cd3f7e10da56f">handle_mgmt</a>(msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)
<a name="l02972"></a>02972 {
<a name="l02973"></a>02973    iframe_t *frm = (iframe_t*) msg-&gt;data;
<a name="l02974"></a>02974    <span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l02975"></a>02975 
<a name="l02976"></a>02976    if ( (frm-&gt;addr == 0) &amp;&amp; (frm-&gt;prim == (MGR_DELLAYER|CONFIRM)) ) {
<a name="l02977"></a>02977       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2, 0, <span class="stringliteral">&quot;MGMT: DELLAYER|CONFIRM Addr: 0 !\n&quot;</span>) ;
<a name="l02978"></a>02978       free_msg(msg);
<a name="l02979"></a>02979       <span class="keywordflow">return</span> 1;
<a name="l02980"></a>02980    }
<a name="l02981"></a>02981    
<a name="l02982"></a>02982    stack = <a class="code" href="isdn__lib_8c.html#a7db594d519df4dae7eb3dbd1b128d6f8">find_stack_by_addr</a>(frm-&gt;addr);
<a name="l02983"></a>02983    
<a name="l02984"></a>02984    <span class="keywordflow">if</span> (!stack) {
<a name="l02985"></a>02985       <span class="keywordflow">if</span> (frm-&gt;prim == (MGR_DELLAYER|CONFIRM)) {
<a name="l02986"></a>02986          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2, 0, <span class="stringliteral">&quot;MGMT: DELLAYER|CONFIRM Addr: %x !\n&quot;</span>,
<a name="l02987"></a>02987                frm-&gt;addr) ;
<a name="l02988"></a>02988          free_msg(msg);
<a name="l02989"></a>02989          <span class="keywordflow">return</span> 1;
<a name="l02990"></a>02990       }
<a name="l02991"></a>02991       
<a name="l02992"></a>02992       <span class="keywordflow">return</span> 0;
<a name="l02993"></a>02993    }
<a name="l02994"></a>02994    
<a name="l02995"></a>02995    <span class="keywordflow">switch</span>(frm-&gt;prim) {
<a name="l02996"></a>02996    <span class="keywordflow">case</span> MGR_SHORTSTATUS | INDICATION:
<a name="l02997"></a>02997    <span class="keywordflow">case</span> MGR_SHORTSTATUS | CONFIRM:
<a name="l02998"></a>02998       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5, stack-&gt;port, <span class="stringliteral">&quot;MGMT: Short status dinfo %x\n&quot;</span>,frm-&gt;dinfo);
<a name="l02999"></a>02999       
<a name="l03000"></a>03000       <span class="keywordflow">switch</span> (frm-&gt;dinfo) {
<a name="l03001"></a>03001       <span class="keywordflow">case</span> SSTATUS_L1_ACTIVATED:
<a name="l03002"></a>03002          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;port, <span class="stringliteral">&quot;MGMT: SSTATUS: L1_ACTIVATED \n&quot;</span>);
<a name="l03003"></a>03003          stack-&gt;l1link=1;
<a name="l03004"></a>03004       
<a name="l03005"></a>03005          <span class="keywordflow">break</span>;
<a name="l03006"></a>03006       <span class="keywordflow">case</span> SSTATUS_L1_DEACTIVATED:
<a name="l03007"></a>03007          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;port, <span class="stringliteral">&quot;MGMT: SSTATUS: L1_DEACTIVATED \n&quot;</span>);
<a name="l03008"></a>03008          stack-&gt;l1link=0;
<a name="l03009"></a>03009 <span class="preprocessor">#if 0</span>
<a name="l03010"></a>03010 <span class="preprocessor"></span>         <a class="code" href="isdn__lib_8c.html#ad1f0e37879b7ff599b95f5e9df7ae482">clear_l3</a>(stack);
<a name="l03011"></a>03011 <span class="preprocessor">#endif</span>
<a name="l03012"></a>03012 <span class="preprocessor"></span>         <span class="keywordflow">break</span>;
<a name="l03013"></a>03013 
<a name="l03014"></a>03014       <span class="keywordflow">case</span> SSTATUS_L2_ESTABLISHED:
<a name="l03015"></a>03015          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;port, <span class="stringliteral">&quot;MGMT: SSTATUS: L2_ESTABLISH \n&quot;</span>);
<a name="l03016"></a>03016          stack-&gt;l2link=1;
<a name="l03017"></a>03017          <span class="keywordflow">break</span>;
<a name="l03018"></a>03018          
<a name="l03019"></a>03019       <span class="keywordflow">case</span> SSTATUS_L2_RELEASED:
<a name="l03020"></a>03020          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;port, <span class="stringliteral">&quot;MGMT: SSTATUS: L2_RELEASED \n&quot;</span>);
<a name="l03021"></a>03021          stack-&gt;l2link=0;
<a name="l03022"></a>03022          <span class="keywordflow">break</span>;
<a name="l03023"></a>03023       }
<a name="l03024"></a>03024       
<a name="l03025"></a>03025       free_msg(msg);
<a name="l03026"></a>03026       <span class="keywordflow">return</span> 1;
<a name="l03027"></a>03027       
<a name="l03028"></a>03028    <span class="keywordflow">case</span> MGR_SETSTACK | INDICATION:
<a name="l03029"></a>03029       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;port, <span class="stringliteral">&quot;MGMT: SETSTACK|IND dinfo %x\n&quot;</span>,frm-&gt;dinfo);
<a name="l03030"></a>03030       free_msg(msg);
<a name="l03031"></a>03031       <span class="keywordflow">return</span> 1;
<a name="l03032"></a>03032    <span class="keywordflow">case</span> MGR_DELLAYER | CONFIRM:
<a name="l03033"></a>03033       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;port, <span class="stringliteral">&quot;MGMT: DELLAYER|CNF dinfo %x\n&quot;</span>,frm-&gt;dinfo) ;
<a name="l03034"></a>03034       free_msg(msg);
<a name="l03035"></a>03035       <span class="keywordflow">return</span> 1;
<a name="l03036"></a>03036       
<a name="l03037"></a>03037    }
<a name="l03038"></a>03038    
<a name="l03039"></a>03039    <span class="comment">/*</span>
<a name="l03040"></a>03040 <span class="comment">   if ( (frm-&gt;prim &amp; 0x0f0000) ==  0x0f0000) {</span>
<a name="l03041"></a>03041 <span class="comment">   cb_log(5, 0, &quot;$$$ MGMT FRAME: prim %x addr %x dinfo %x\n&quot;,frm-&gt;prim, frm-&gt;addr, frm-&gt;dinfo) ;</span>
<a name="l03042"></a>03042 <span class="comment">   free_msg(msg);</span>
<a name="l03043"></a>03043 <span class="comment">   return 1;</span>
<a name="l03044"></a>03044 <span class="comment">   } */</span>
<a name="l03045"></a>03045     
<a name="l03046"></a>03046    <span class="keywordflow">return</span> 0;
<a name="l03047"></a>03047 }
<a name="l03048"></a>03048 
<a name="l03049"></a>03049 
<a name="l03050"></a><a class="code" href="isdn__lib_8c.html#a1868fcba10e6780a36f1771b9c8b8bd2">03050</a> <span class="keyword">static</span> msg_t *<a class="code" href="isdn__lib_8c.html#a1868fcba10e6780a36f1771b9c8b8bd2">fetch_msg</a>(<span class="keywordtype">int</span> midev) 
<a name="l03051"></a>03051 {
<a name="l03052"></a>03052    msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>=alloc_msg(MAX_MSG_SIZE);
<a name="l03053"></a>03053    <span class="keywordtype">int</span> r;
<a name="l03054"></a>03054 
<a name="l03055"></a>03055    <span class="keywordflow">if</span> (!msg) {
<a name="l03056"></a>03056       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, 0, <span class="stringliteral">&quot;fetch_msg: alloc msg failed !!&quot;</span>);
<a name="l03057"></a>03057       <span class="keywordflow">return</span> NULL;
<a name="l03058"></a>03058    }
<a name="l03059"></a>03059 
<a name="l03060"></a>03060    AGAIN:
<a name="l03061"></a>03061       r=mISDN_read(midev,msg-&gt;data,MAX_MSG_SIZE, TIMEOUT_10SEC);
<a name="l03062"></a>03062       msg-&gt;len=r;
<a name="l03063"></a>03063     
<a name="l03064"></a>03064       <span class="keywordflow">if</span> (r==0) {
<a name="l03065"></a>03065          free_msg(msg); <span class="comment">/* danger, cause usually freeing in main_loop */</span>
<a name="l03066"></a>03066          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(6,0,<span class="stringliteral">&quot;Got empty Msg..\n&quot;</span>);
<a name="l03067"></a>03067          <span class="keywordflow">return</span> NULL;
<a name="l03068"></a>03068       }
<a name="l03069"></a>03069 
<a name="l03070"></a>03070       <span class="keywordflow">if</span> (r&lt;0) {
<a name="l03071"></a>03071          <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EAGAIN) {
<a name="l03072"></a>03072             <span class="comment">/*we wait for mISDN here*/</span>
<a name="l03073"></a>03073             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,0,<span class="stringliteral">&quot;mISDN_read wants us to wait\n&quot;</span>);
<a name="l03074"></a>03074             usleep(5000);
<a name="l03075"></a>03075             <span class="keywordflow">goto</span> AGAIN;
<a name="l03076"></a>03076          }
<a name="l03077"></a>03077          
<a name="l03078"></a>03078          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,0,<span class="stringliteral">&quot;mISDN_read returned :%d error:%s (%d)\n&quot;</span>,r,strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>),<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>); 
<a name="l03079"></a>03079       }
<a name="l03080"></a>03080 
<a name="l03081"></a>03081 <span class="preprocessor">#if 0</span>
<a name="l03082"></a>03082 <span class="preprocessor"></span>               <span class="keywordflow">if</span>  (!(frm-&gt;prim == (DL_DATA|INDICATION) )|| (frm-&gt;prim == (PH_DATA|INDICATION)))
<a name="l03083"></a>03083                        <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,0,<span class="stringliteral">&quot;prim: %x dinfo:%x addr:%x msglen:%d frm-&gt;len:%d\n&quot;</span>,frm-&gt;prim, frm-&gt;dinfo, frm-&gt;addr, msg-&gt;len,frm-&gt;len );
<a name="l03084"></a>03084 <span class="preprocessor">#endif</span>
<a name="l03085"></a>03085 <span class="preprocessor"></span>      <span class="keywordflow">return</span> msg;
<a name="l03086"></a>03086 }
<a name="l03087"></a>03087 
<a name="l03088"></a><a class="code" href="isdn__lib_8h.html#a69e6b059e10922db37fd2bd5d48c7c6f">03088</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a69e6b059e10922db37fd2bd5d48c7c6f">misdn_lib_isdn_l1watcher</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>)
<a name="l03089"></a>03089 {
<a name="l03090"></a>03090    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l03091"></a>03091 
<a name="l03092"></a>03092    <span class="keywordflow">for</span> (stack = glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>; stack &amp;&amp; (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> != port); stack = stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>)
<a name="l03093"></a>03093       ;
<a name="l03094"></a>03094 
<a name="l03095"></a>03095    <span class="keywordflow">if</span> (stack) {
<a name="l03096"></a>03096       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, port, <span class="stringliteral">&quot;Checking L1 State\n&quot;</span>);   
<a name="l03097"></a>03097       <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#a579e76479941e4610b630ada968ae5e2" title="TRUE if Layer 1 is UP.">l1link</a>) {
<a name="l03098"></a>03098          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, port, <span class="stringliteral">&quot;L1 State Down, trying to get it up again\n&quot;</span>); 
<a name="l03099"></a>03099          <a class="code" href="isdn__lib_8c.html#a7dcc4196f1ee5793afa5bf53dbcb11c1">misdn_lib_get_short_status</a>(stack);
<a name="l03100"></a>03100          <a class="code" href="isdn__lib_8c.html#a4af2f7ae2eb8c3746985df5544d17203">misdn_lib_get_l1_up</a>(stack); 
<a name="l03101"></a>03101          <a class="code" href="isdn__lib_8c.html#af03ad57836b38845f685368e60625707">misdn_lib_get_l2_up</a>(stack); 
<a name="l03102"></a>03102       }
<a name="l03103"></a>03103    }
<a name="l03104"></a>03104 }
<a name="l03105"></a>03105 
<a name="l03106"></a>03106 <span class="comment">/* This is a thread */</span>
<a name="l03107"></a><a class="code" href="isdn__lib_8c.html#aafca72f03d258872c306e1fb5d10b5bd">03107</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#aafca72f03d258872c306e1fb5d10b5bd">misdn_lib_isdn_event_catcher</a>(<span class="keywordtype">void</span> *arg)
<a name="l03108"></a>03108 {
<a name="l03109"></a>03109    <span class="keyword">struct </span><a class="code" href="structmisdn__lib.html">misdn_lib</a> *mgr = arg;
<a name="l03110"></a>03110    <span class="keywordtype">int</span> zero_frm=0 , fff_frm=0 ;
<a name="l03111"></a>03111    <span class="keywordtype">int</span> <a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>= mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>;
<a name="l03112"></a>03112    <span class="keywordtype">int</span> port=0;
<a name="l03113"></a>03113    
<a name="l03114"></a>03114    <span class="keywordflow">while</span> (1) {
<a name="l03115"></a>03115       msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a> = <a class="code" href="isdn__lib_8c.html#a1868fcba10e6780a36f1771b9c8b8bd2">fetch_msg</a>(midev); 
<a name="l03116"></a>03116       iframe_t *frm;
<a name="l03117"></a>03117       
<a name="l03118"></a>03118       
<a name="l03119"></a>03119       <span class="keywordflow">if</span> (!msg) <span class="keywordflow">continue</span>;
<a name="l03120"></a>03120       
<a name="l03121"></a>03121       frm = (iframe_t*) msg-&gt;data;
<a name="l03122"></a>03122       <span class="comment"></span>
<a name="l03123"></a>03123 <span class="comment">      /** When we make a call from NT2Ast we get these frames **/</span>
<a name="l03124"></a>03124       if (frm-&gt;len == 0 &amp;&amp; frm-&gt;addr == 0 &amp;&amp; frm-&gt;dinfo == 0 &amp;&amp; frm-&gt;prim == 0 ) {
<a name="l03125"></a>03125          zero_frm++; 
<a name="l03126"></a>03126          free_msg(msg);
<a name="l03127"></a>03127          <span class="keywordflow">continue</span>;
<a name="l03128"></a>03128       } <span class="keywordflow">else</span> {
<a name="l03129"></a>03129          <span class="keywordflow">if</span> (zero_frm) {
<a name="l03130"></a>03130             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;*** Alert: %d zero_frms caught\n&quot;</span>, zero_frm);
<a name="l03131"></a>03131             zero_frm = 0 ;
<a name="l03132"></a>03132          }
<a name="l03133"></a>03133       }
<a name="l03134"></a>03134       <span class="comment"></span>
<a name="l03135"></a>03135 <span class="comment">      /** I get this sometimes after setup_bc **/</span>
<a name="l03136"></a>03136       <span class="keywordflow">if</span> (frm-&gt;len == 0 &amp;&amp;  frm-&gt;dinfo == 0 &amp;&amp; frm-&gt;prim == 0xffffffff ) {
<a name="l03137"></a>03137          fff_frm++; 
<a name="l03138"></a>03138          free_msg(msg);
<a name="l03139"></a>03139          <span class="keywordflow">continue</span>;
<a name="l03140"></a>03140       } <span class="keywordflow">else</span> {
<a name="l03141"></a>03141          <span class="keywordflow">if</span> (fff_frm) {
<a name="l03142"></a>03142             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;*** Alert: %d fff_frms caught\n&quot;</span>, fff_frm);
<a name="l03143"></a>03143             fff_frm = 0 ;
<a name="l03144"></a>03144          }
<a name="l03145"></a>03145       }
<a name="l03146"></a>03146       
<a name="l03147"></a>03147       <a class="code" href="isdn__lib_8c.html#a9b68a92e4295d00f7450b5300b63eef0">manager_isdn_handler</a>(frm, msg);
<a name="l03148"></a>03148    }
<a name="l03149"></a>03149 
<a name="l03150"></a>03150 }
<a name="l03151"></a>03151 
<a name="l03152"></a>03152 <span class="comment"></span>
<a name="l03153"></a>03153 <span class="comment">/** App Interface **/</span>
<a name="l03154"></a>03154 
<a name="l03155"></a><a class="code" href="isdn__lib_8c.html#a5350c9c1249234db77f41814cad90b6e">03155</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a5350c9c1249234db77f41814cad90b6e">te_lib_init</a>(<span class="keywordtype">void</span>) {
<a name="l03156"></a>03156    <span class="keywordtype">char</span> <a class="code" href="chan__unistim_8c.html#af30c10a8c6ed3d4649cfdc61e2029dc3">buff</a>[1025] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03157"></a>03157    iframe_t *frm=(iframe_t*)buff;
<a name="l03158"></a>03158    <span class="keywordtype">int</span> <a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>=mISDN_open();
<a name="l03159"></a>03159    <span class="keywordtype">int</span> ret;
<a name="l03160"></a>03160 
<a name="l03161"></a>03161    <span class="keywordflow">if</span>  (midev&lt;=0) <span class="keywordflow">return</span> midev;
<a name="l03162"></a>03162   
<a name="l03163"></a>03163 <span class="comment">/* create entity for layer 3 TE-mode */</span>
<a name="l03164"></a>03164    mISDN_write_frame(midev, buff, 0, MGR_NEWENTITY | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l03165"></a>03165    ret = mISDN_read_frame(midev, frm, <span class="keyword">sizeof</span>(iframe_t), 0, MGR_NEWENTITY | CONFIRM, TIMEOUT_1SEC);
<a name="l03166"></a>03166   
<a name="l03167"></a>03167    <span class="keywordflow">if</span> (ret &lt; mISDN_HEADER_LEN) {
<a name="l03168"></a>03168    noentity:
<a name="l03169"></a>03169       fprintf(stderr, <span class="stringliteral">&quot;cannot request MGR_NEWENTITY from mISDN: %s\n&quot;</span>,strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03170"></a>03170       exit(-1);
<a name="l03171"></a>03171    }
<a name="l03172"></a>03172   
<a name="l03173"></a>03173    entity = frm-&gt;dinfo &amp; 0xffff ;
<a name="l03174"></a>03174   
<a name="l03175"></a>03175    <span class="keywordflow">if</span> (!entity)
<a name="l03176"></a>03176       <span class="keywordflow">goto</span> noentity;
<a name="l03177"></a>03177 
<a name="l03178"></a>03178    <span class="keywordflow">return</span> midev;
<a name="l03179"></a>03179   
<a name="l03180"></a>03180 }
<a name="l03181"></a>03181 
<a name="l03182"></a><a class="code" href="isdn__lib_8c.html#ad8cee834c1e43d68d987135d3456e091">03182</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#ad8cee834c1e43d68d987135d3456e091">te_lib_destroy</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>)
<a name="l03183"></a>03183 {
<a name="l03184"></a>03184    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[1024];
<a name="l03185"></a>03185    mISDN_write_frame(midev, buf, 0, MGR_DELENTITY | REQUEST, entity, 0, NULL, TIMEOUT_1SEC);
<a name="l03186"></a>03186 
<a name="l03187"></a>03187    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, 0, <span class="stringliteral">&quot;Entity deleted\n&quot;</span>);
<a name="l03188"></a>03188    mISDN_close(midev);
<a name="l03189"></a>03189    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, 0, <span class="stringliteral">&quot;midev closed\n&quot;</span>);
<a name="l03190"></a>03190 }
<a name="l03191"></a>03191 
<a name="l03192"></a><a class="code" href="isdn__lib_8c.html#abf9dc535c1858428371b26baf226db3d">03192</a> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#abf9dc535c1858428371b26baf226db3d">manager_find_bc_by_pid</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>)
<a name="l03193"></a>03193 {
<a name="l03194"></a>03194    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l03195"></a>03195    <span class="keywordtype">int</span> i;
<a name="l03196"></a>03196   
<a name="l03197"></a>03197    <span class="keywordflow">for</span> (stack = glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>; stack; stack = stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l03198"></a>03198       <span class="keywordflow">for</span> (i = 0; i &lt;= stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; i++) {
<a name="l03199"></a>03199          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a> &amp;&amp; stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a> == pid) {
<a name="l03200"></a>03200             <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i];
<a name="l03201"></a>03201          }
<a name="l03202"></a>03202       }
<a name="l03203"></a>03203    }
<a name="l03204"></a>03204   
<a name="l03205"></a>03205    <span class="keywordflow">return</span> NULL;
<a name="l03206"></a>03206 }
<a name="l03207"></a>03207 
<a name="l03208"></a><a class="code" href="isdn__lib_8c.html#a74c98fb7251dec891a2f26e41d66af3d">03208</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a74c98fb7251dec891a2f26e41d66af3d">test_inuse</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l03209"></a>03209 {
<a name="l03210"></a>03210    <span class="keyword">struct </span>timeval now;
<a name="l03211"></a>03211    gettimeofday(&amp;now, NULL);
<a name="l03212"></a>03212    <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a>) {
<a name="l03213"></a>03213       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a0397696531bb8058c4f712aa8428d492">misdn_lib_port_is_pri</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>) &amp;&amp; bc-&gt;<a class="code" href="structmisdn__bchannel.html#a43b2c8a8bf77a2504897ff0da9b0aa90" title="Time when empty_bc() last called on this record.">last_used</a>.tv_sec == now.tv_sec ) {
<a name="l03214"></a>03214          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;channel with stid:%x for one second still in use! (n:%d lu:%d)\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a>, (<span class="keywordtype">int</span>) now.tv_sec, (<span class="keywordtype">int</span>) bc-&gt;<a class="code" href="structmisdn__bchannel.html#a43b2c8a8bf77a2504897ff0da9b0aa90" title="Time when empty_bc() last called on this record.">last_used</a>.tv_sec);
<a name="l03215"></a>03215          <span class="keywordflow">return</span> 1;
<a name="l03216"></a>03216       }
<a name="l03217"></a>03217       
<a name="l03218"></a>03218 
<a name="l03219"></a>03219       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;channel with stid:%x not in use!\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a>);
<a name="l03220"></a>03220       <span class="keywordflow">return</span> 0;
<a name="l03221"></a>03221    }
<a name="l03222"></a>03222    
<a name="l03223"></a>03223    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;channel with stid:%x in use!\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a>);
<a name="l03224"></a>03224    <span class="keywordflow">return</span> 1;
<a name="l03225"></a>03225 }
<a name="l03226"></a>03226 
<a name="l03227"></a>03227 
<a name="l03228"></a><a class="code" href="isdn__lib_8c.html#aeb68367c5838b1da4afe9a3120923b26">03228</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#aeb68367c5838b1da4afe9a3120923b26">prepare_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>*bc, <span class="keywordtype">int</span> channel)
<a name="l03229"></a>03229 {
<a name="l03230"></a>03230    bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> = channel;
<a name="l03231"></a>03231    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a443e308806d144a6782fd01d04577129" title="TRUE if the B channel number is preselected.">channel_preselected</a> = channel?1:0;
<a name="l03232"></a>03232    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a96296ec1ed855ce59e12762be480825b" title="TRUE if DISCONNECT needs to be sent to clear a call.">need_disconnect</a>=1;
<a name="l03233"></a>03233    bc-&gt;<a class="code" href="structmisdn__bchannel.html#aca6b8a790005c71e029e73fd5362007b" title="TRUE if RELEASE needs to be sent to clear a call.">need_release</a>=1;
<a name="l03234"></a>03234    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a81790e7ee2b93373b0e048d0ef4c53bd" title="TRUE if RELEASE_COMPLETE needs to be sent to clear a call.">need_release_complete</a>=1;
<a name="l03235"></a>03235    bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa4d0ccb9d0904892652f2f258c5ad225" title="Q.931 Cause for disconnection code (received).">cause</a> = <a class="code" href="causes_8h.html#af2235eb1c27925e4020ce286255d165f">AST_CAUSE_NORMAL_CLEARING</a>;
<a name="l03236"></a>03236 
<a name="l03237"></a>03237    <span class="keywordflow">if</span> (++mypid&gt;5000) mypid=1;
<a name="l03238"></a>03238    bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>=mypid;
<a name="l03239"></a>03239 
<a name="l03240"></a>03240 <span class="preprocessor">#if 0</span>
<a name="l03241"></a>03241 <span class="preprocessor"></span>   bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>=0;
<a name="l03242"></a>03242    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a>=0;
<a name="l03243"></a>03243    bc-&gt;<a class="code" href="structmisdn__bchannel.html#ad3f99071e2a45a0a256d33c018950293" title="B Channel mISDN driver layer ID from mISDN_new_layer().">layer_id</a>=0;
<a name="l03244"></a>03244 <span class="preprocessor">#endif</span>
<a name="l03245"></a>03245 <span class="preprocessor"></span>
<a name="l03246"></a>03246    bc-&gt;<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a> = 1;
<a name="l03247"></a>03247 }
<a name="l03248"></a>03248 
<a name="l03249"></a><a class="code" href="isdn__lib_8h.html#aa0fb761776d759bbd96a56bf38fe8c06">03249</a> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>* <a class="code" href="isdn__lib_8c.html#aa0fb761776d759bbd96a56bf38fe8c06">misdn_lib_get_free_bc</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>, <span class="keywordtype">int</span> inout, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#a04e41b69f1017a234f0cfe958c99be93" title="TRUE if allocate higher B channels first.">dec</a>)
<a name="l03250"></a>03250 {
<a name="l03251"></a>03251    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l03252"></a>03252    <span class="keywordtype">int</span> i;
<a name="l03253"></a>03253    
<a name="l03254"></a>03254    <span class="keywordflow">if</span> (channel &lt; 0 || channel &gt; <a class="code" href="isdn__lib_8h.html#a90726efd784d5cc679ad2e1160b5dc2f">MAX_BCHANS</a>) {
<a name="l03255"></a>03255       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,port,<span class="stringliteral">&quot;Requested channel out of bounds (%d)\n&quot;</span>,channel);
<a name="l03256"></a>03256       <span class="keywordflow">return</span> NULL;
<a name="l03257"></a>03257    }
<a name="l03258"></a>03258 
<a name="l03259"></a>03259    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l03260"></a>03260     
<a name="l03261"></a>03261       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) {
<a name="l03262"></a>03262          <span class="keywordtype">int</span> maxnum;
<a name="l03263"></a>03263 
<a name="l03264"></a>03264          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#ac74e3d5a1b1eeb5c8e32867ad62823f0" title="TRUE if port is blocked.">blocked</a>) {
<a name="l03265"></a>03265             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,port,<span class="stringliteral">&quot;Port is blocked\n&quot;</span>);
<a name="l03266"></a>03266             <span class="keywordflow">return</span> NULL;
<a name="l03267"></a>03267          }
<a name="l03268"></a>03268       
<a name="l03269"></a>03269          <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>);
<a name="l03270"></a>03270          <span class="keywordflow">if</span> (channel &gt; 0) {
<a name="l03271"></a>03271             <span class="keywordflow">if</span> (channel &lt;= stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>) {
<a name="l03272"></a>03272                <span class="keywordflow">for</span> (i = 0; i &lt; stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; i++) {
<a name="l03273"></a>03273                   <span class="keywordflow">if</span> ( stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> == channel) {
<a name="l03274"></a>03274                      <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a74c98fb7251dec891a2f26e41d66af3d">test_inuse</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i])) { 
<a name="l03275"></a>03275                         <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>);
<a name="l03276"></a>03276                         <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,port,<span class="stringliteral">&quot;Requested channel:%d on port:%d is already in use\n&quot;</span>,channel, port);
<a name="l03277"></a>03277                         <span class="keywordflow">return</span> NULL;
<a name="l03278"></a>03278 
<a name="l03279"></a>03279                      } <span class="keywordflow">else</span> {
<a name="l03280"></a>03280                         <a class="code" href="isdn__lib_8c.html#aeb68367c5838b1da4afe9a3120923b26">prepare_bc</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i], channel);
<a name="l03281"></a>03281                         <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>);
<a name="l03282"></a>03282                         <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i];
<a name="l03283"></a>03283                      }
<a name="l03284"></a>03284                   }
<a name="l03285"></a>03285                }
<a name="l03286"></a>03286             } <span class="keywordflow">else</span> {
<a name="l03287"></a>03287                <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>);
<a name="l03288"></a>03288                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,port,<span class="stringliteral">&quot;Requested channel:%d is out of bounds on port:%d\n&quot;</span>,channel, port);
<a name="l03289"></a>03289                <span class="keywordflow">return</span> NULL;
<a name="l03290"></a>03290             }
<a name="l03291"></a>03291          }
<a name="l03292"></a>03292 
<a name="l03293"></a>03293          maxnum = inout &amp;&amp; !stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a> &amp;&amp; !stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a> ? stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a> + 1 : stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>;
<a name="l03294"></a>03294 
<a name="l03295"></a>03295          <span class="keywordflow">if</span> (dec) {
<a name="l03296"></a>03296             <span class="keywordflow">for</span> (i = maxnum-1; i&gt;=0; i--) {
<a name="l03297"></a>03297                <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#a74c98fb7251dec891a2f26e41d66af3d">test_inuse</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i])) {
<a name="l03298"></a>03298                   <span class="comment">/* 3. channel on bri means CW*/</span>
<a name="l03299"></a>03299                   <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a> &amp;&amp; i==stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>)
<a name="l03300"></a>03300                      stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#a0e234074dd9e6208d65dcd4230827898" title="TRUE if call waiting.">cw</a>=1;
<a name="l03301"></a>03301                      
<a name="l03302"></a>03302                   <a class="code" href="isdn__lib_8c.html#aeb68367c5838b1da4afe9a3120923b26">prepare_bc</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i], channel);
<a name="l03303"></a>03303                   stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#a04e41b69f1017a234f0cfe958c99be93" title="TRUE if allocate higher B channels first.">dec</a>=1;
<a name="l03304"></a>03304                   <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>);
<a name="l03305"></a>03305                   <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i];
<a name="l03306"></a>03306                }
<a name="l03307"></a>03307             }
<a name="l03308"></a>03308          } <span class="keywordflow">else</span> {
<a name="l03309"></a>03309             <span class="keywordflow">for</span> (i = 0; i &lt;maxnum; i++) {
<a name="l03310"></a>03310                <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#a74c98fb7251dec891a2f26e41d66af3d">test_inuse</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i])) {
<a name="l03311"></a>03311                   <span class="comment">/* 3. channel on bri means CW*/</span>
<a name="l03312"></a>03312                   <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a> &amp;&amp; i==stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>)
<a name="l03313"></a>03313                      stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#a0e234074dd9e6208d65dcd4230827898" title="TRUE if call waiting.">cw</a>=1;
<a name="l03314"></a>03314 
<a name="l03315"></a>03315                   <a class="code" href="isdn__lib_8c.html#aeb68367c5838b1da4afe9a3120923b26">prepare_bc</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i], channel);
<a name="l03316"></a>03316                   <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>);
<a name="l03317"></a>03317                   <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i];
<a name="l03318"></a>03318                }
<a name="l03319"></a>03319             }
<a name="l03320"></a>03320          }
<a name="l03321"></a>03321          <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#ac7ae4f003b2c87da8440a16e38183275" title="Stack struct critical section lock.">st_lock</a>);
<a name="l03322"></a>03322 
<a name="l03323"></a>03323          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1,port,<span class="stringliteral">&quot;There is no free channel on port (%d)\n&quot;</span>,port);
<a name="l03324"></a>03324          <span class="keywordflow">return</span> NULL;
<a name="l03325"></a>03325       }
<a name="l03326"></a>03326    }
<a name="l03327"></a>03327 
<a name="l03328"></a>03328    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,port,<span class="stringliteral">&quot;Port is not configured (%d)\n&quot;</span>,port);
<a name="l03329"></a>03329    <span class="keywordflow">return</span> NULL;
<a name="l03330"></a>03330 }
<a name="l03331"></a>03331 <span class="comment"></span>
<a name="l03332"></a>03332 <span class="comment">/*!</span>
<a name="l03333"></a>03333 <span class="comment"> * \internal</span>
<a name="l03334"></a>03334 <span class="comment"> * \brief Convert the facility function enum value into a string.</span>
<a name="l03335"></a>03335 <span class="comment"> *</span>
<a name="l03336"></a>03336 <span class="comment"> * \return String version of the enum value</span>
<a name="l03337"></a>03337 <span class="comment"> */</span>
<a name="l03338"></a><a class="code" href="isdn__lib_8c.html#af8bd422a82d35452a77fd62451698fad">03338</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="isdn__lib_8c.html#af8bd422a82d35452a77fd62451698fad">fac2str</a>(<span class="keyword">enum</span> FacFunction facility)
<a name="l03339"></a>03339 {
<a name="l03340"></a>03340    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>{ 
<a name="l03341"></a>03341       <span class="keyword">enum</span> FacFunction facility; 
<a name="l03342"></a>03342       <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>;
<a name="l03343"></a>03343    } arr[] = {
<a name="l03344"></a>03344 <span class="comment">/* *INDENT-OFF* */</span>
<a name="l03345"></a>03345       { Fac_None, <span class="stringliteral">&quot;Fac_None&quot;</span> },
<a name="l03346"></a>03346       { Fac_GetSupportedServices, <span class="stringliteral">&quot;Fac_GetSupportedServices&quot;</span> },
<a name="l03347"></a>03347       { Fac_Listen, <span class="stringliteral">&quot;Fac_Listen&quot;</span> },
<a name="l03348"></a>03348       { Fac_Suspend, <span class="stringliteral">&quot;Fac_Suspend&quot;</span> },
<a name="l03349"></a>03349       { Fac_Resume, <span class="stringliteral">&quot;Fac_Resume&quot;</span> },
<a name="l03350"></a>03350       { Fac_CFActivate, <span class="stringliteral">&quot;Fac_CFActivate&quot;</span> },
<a name="l03351"></a>03351       { Fac_CFDeactivate, <span class="stringliteral">&quot;Fac_CFDeactivate&quot;</span> },
<a name="l03352"></a>03352       { Fac_CFInterrogateParameters, <span class="stringliteral">&quot;Fac_CFInterrogateParameters&quot;</span> },
<a name="l03353"></a>03353       { Fac_CFInterrogateNumbers, <span class="stringliteral">&quot;Fac_CFInterrogateNumbers&quot;</span> },
<a name="l03354"></a>03354       { Fac_CD, <span class="stringliteral">&quot;Fac_CD&quot;</span> },
<a name="l03355"></a>03355       { Fac_AOCDCurrency, <span class="stringliteral">&quot;Fac_AOCDCurrency&quot;</span> },
<a name="l03356"></a>03356       { Fac_AOCDChargingUnit, <span class="stringliteral">&quot;Fac_AOCDChargingUnit&quot;</span> },
<a name="l03357"></a>03357 <span class="comment">/* *INDENT-ON* */</span>
<a name="l03358"></a>03358    };
<a name="l03359"></a>03359    
<a name="l03360"></a>03360    <span class="keywordtype">unsigned</span> index;
<a name="l03361"></a>03361    
<a name="l03362"></a>03362    <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(arr); ++index) {
<a name="l03363"></a>03363       <span class="keywordflow">if</span> (arr[index].facility == facility) {
<a name="l03364"></a>03364          <span class="keywordflow">return</span> arr[index].name;
<a name="l03365"></a>03365       }
<a name="l03366"></a>03366    }
<a name="l03367"></a>03367 
<a name="l03368"></a>03368    <span class="keywordflow">return</span> <span class="stringliteral">&quot;unknown&quot;</span>;
<a name="l03369"></a>03369 }
<a name="l03370"></a>03370 
<a name="l03371"></a><a class="code" href="isdn__lib_8h.html#a3c9c5a8101a5212ab83e7eecfee8ea33">03371</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a3c9c5a8101a5212ab83e7eecfee8ea33">misdn_lib_log_ies</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l03372"></a>03372 {
<a name="l03373"></a>03373    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l03374"></a>03374 
<a name="l03375"></a>03375    <span class="keywordflow">if</span> (!bc) <span class="keywordflow">return</span>;
<a name="l03376"></a>03376 
<a name="l03377"></a>03377    stack = <a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l03378"></a>03378 
<a name="l03379"></a>03379    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span>;
<a name="l03380"></a>03380 
<a name="l03381"></a>03381    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; channel:%d mode:%s cause:%d ocause:%d rad:%s cad:%s\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>?<span class="stringliteral">&quot;NT&quot;</span>:<span class="stringliteral">&quot;TE&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa4d0ccb9d0904892652f2f258c5ad225" title="Q.931 Cause for disconnection code (received).">cause</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1b724daeb32d8d023765605586269a02" title="Q.931 Cause for disconnection code (sent).">out_cause</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9dbe27031e2baf74c93cc2b719a4d47f" title="Redirecting Phone Number (Address) where a call diversion or transfer was invoked...">rad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aedb5fadfcd803b101921d8e0f76ac6c4" title="Connected Party/Line Phone Number (Address).">cad</a>);
<a name="l03382"></a>03382    
<a name="l03383"></a>03383    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,
<a name="l03384"></a>03384           <span class="stringliteral">&quot; --&gt; info_dad:%s onumplan:%c dnumplan:%c rnumplan:%c cpnnumplan:%c\n&quot;</span>,
<a name="l03385"></a>03385           bc-&gt;<a class="code" href="structmisdn__bchannel.html#ab8c928e7140e6b59abbe7dddadffd5ea" title="Current overlap dialing digits to/from INFORMATION messages.">info_dad</a>,
<a name="l03386"></a>03386           bc-&gt;<a class="code" href="structmisdn__bchannel.html#aeea5d3e5d16496a8b3e35bdcf9faf3f0" title="Type-of-number in ISDN terms for the originating/calling number (Caller-ID).">onumplan</a>&gt;=0?<span class="charliteral">&apos;0&apos;</span>+bc-&gt;<a class="code" href="structmisdn__bchannel.html#aeea5d3e5d16496a8b3e35bdcf9faf3f0" title="Type-of-number in ISDN terms for the originating/calling number (Caller-ID).">onumplan</a>:<span class="charliteral">&apos; &apos;</span>,
<a name="l03387"></a>03387           bc-&gt;<a class="code" href="structmisdn__bchannel.html#a54e1096eacf895fbbee3b263b8a5af5a" title="Type-of-number in ISDN terms for the dialed/called number.">dnumplan</a>&gt;=0?<span class="charliteral">&apos;0&apos;</span>+bc-&gt;<a class="code" href="structmisdn__bchannel.html#a54e1096eacf895fbbee3b263b8a5af5a" title="Type-of-number in ISDN terms for the dialed/called number.">dnumplan</a>:<span class="charliteral">&apos; &apos;</span>,
<a name="l03388"></a>03388           bc-&gt;<a class="code" href="structmisdn__bchannel.html#a8d01f0e3cd6bd8f9ebd453a52c3f67ac" title="Type-of-number in ISDN terms for the redirecting number which a call diversion or...">rnumplan</a>&gt;=0?<span class="charliteral">&apos;0&apos;</span>+bc-&gt;<a class="code" href="structmisdn__bchannel.html#a8d01f0e3cd6bd8f9ebd453a52c3f67ac" title="Type-of-number in ISDN terms for the redirecting number which a call diversion or...">rnumplan</a>:<span class="charliteral">&apos; &apos;</span>,
<a name="l03389"></a>03389           bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9ee82271317597b727ab006698eb0455" title="Type-of-number in ISDN terms for the connected party number.">cpnnumplan</a>&gt;=0?<span class="charliteral">&apos;0&apos;</span>+bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9ee82271317597b727ab006698eb0455" title="Type-of-number in ISDN terms for the connected party number.">cpnnumplan</a>:<span class="charliteral">&apos; &apos;</span>
<a name="l03390"></a>03390       );
<a name="l03391"></a>03391    
<a name="l03392"></a>03392    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; caps:%s pi:%x keypad:%s sending_complete:%d\n&quot;</span>, <a class="code" href="isdn__lib_8c.html#aaffa6d9528e0309ddb72535d3ae40ca5">bearer2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#afa05b14ff7f76f303c784c00c4c63fa7" title="SETUP message bearer capability field code value.">capability</a>),bc-&gt;<a class="code" href="structmisdn__bchannel.html#a7f77bca4fa18c428d39f939be30e7112" title="Progress Indicator IE progress description field. Used to determine if there is an...">progress_indicator</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63347cc881f9a2b8840368d1cfb86d15" title="Q.931 Keypad Facility IE contents.">keypad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63e06215600e01fdfb2234581d3457b5" title="TRUE if all digits necessary to complete the call are available. No more INFORMATION...">sending_complete</a>);
<a name="l03393"></a>03393    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; screen:%d --&gt; pres:%d\n&quot;</span>,
<a name="l03394"></a>03394          bc-&gt;<a class="code" href="structmisdn__bchannel.html#a3109b0889cec9f0de874a2bdc1f84372" title="Caller ID screening code 0=Unscreened, 1=Passed Screen, 2=Failed Screen, 3=Network...">screen</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a98244c51d406d209643d55bd6a93535c" title="Caller ID presentation restriction code 0=Allowed, 1=Restricted, 2=Unavailable.">pres</a>);
<a name="l03395"></a>03395    
<a name="l03396"></a>03396    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; addr:%x l3id:%x b_stid:%x layer_id:%x\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a6559a9ddea68bea15f40a65d1edbfd31" title="B Channel mISDN driver stack ID.">b_stid</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#ad3f99071e2a45a0a256d33c018950293" title="B Channel mISDN driver layer ID from mISDN_new_layer().">layer_id</a>);
<a name="l03397"></a>03397    
<a name="l03398"></a>03398    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; facility:%s out_facility:%s\n&quot;</span>,<a class="code" href="isdn__lib_8c.html#af8bd422a82d35452a77fd62451698fad">fac2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#a661fd03f59ca366c30cb5886636be8bd" title="Inbound FACILITY message function type and contents.">fac_in</a>.Function),<a class="code" href="isdn__lib_8c.html#af8bd422a82d35452a77fd62451698fad">fac2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#a985f4b3f8cb9f5dcd667ba89431a3975" title="Outbound FACILITY message function type and contents.">fac_out</a>.Function));
<a name="l03399"></a>03399 
<a name="l03400"></a>03400    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; urate:%d rate:%d mode:%d user1:%d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#af6c0d819ed84001ebc48f28c7765211a" title="Q.931 Bearer Capability IE Layer 1 User Rate field.">urate</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a7a829e6fd74e94e0edf10550470d844c" title="Q.931 Bearer Capability IE Information Transfer Rate field. Initialized to 0x10 (64kbit)...">rate</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1ea5d0cb93f22f7d0fdf804bd68c3326" title="Q.931 Bearer Capability IE Transfer Mode field. Initialized to 0 (Circuit). Altered...">mode</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#ad1194c824f21bca3c5a6d4d5ceffcaec" title="Q.931 Bearer Capability IE User Information Layer 1 Protocol field code.">user1</a>);
<a name="l03401"></a>03401    
<a name="l03402"></a>03402    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; bc:%p h:%d sh:%d\n&quot;</span>, bc, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a17ef6ae19b9fca79e3e2f7ce9525f089" title="TRUE if this channel is on hold.">holded</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a94bf2beb01269f6feb818b5c2231537c" title="TRUE if this channel is on the misdn_stack-&amp;gt;holding list.">stack_holder</a>);
<a name="l03403"></a>03403 }
<a name="l03404"></a>03404 
<a name="l03405"></a>03405 
<a name="l03406"></a><a class="code" href="isdn__lib_8c.html#ab174c05fc2551d7f453553831deb6989">03406</a> <span class="preprocessor">#define RETURN(a,b) {retval=a; goto b;}</span>
<a name="l03407"></a>03407 <span class="preprocessor"></span>
<a name="l03408"></a><a class="code" href="isdn__lib_8c.html#a2ff7845faff8dd0d8a27530b5cb53340">03408</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a2ff7845faff8dd0d8a27530b5cb53340">misdn_send_lock</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l03409"></a>03409 {
<a name="l03410"></a>03410    <span class="comment">//cb_log(0,bc-&gt;port,&quot;Locking bc-&gt;pid:%d\n&quot;, bc-&gt;pid);</span>
<a name="l03411"></a>03411    <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa344dc277658ddd12815b6ff5f561a3f" title="B channel send locking structure.">send_lock</a>)
<a name="l03412"></a>03412       <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa344dc277658ddd12815b6ff5f561a3f" title="B channel send locking structure.">send_lock</a>-&gt;<a class="code" href="structsend__lock.html#a0abaf4b5d42c4e5d19190035fade3599">lock</a>);
<a name="l03413"></a>03413 }
<a name="l03414"></a>03414 
<a name="l03415"></a><a class="code" href="isdn__lib_8c.html#ae7b6289e3ab5212df9ea53affa9d80ea">03415</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#ae7b6289e3ab5212df9ea53affa9d80ea">misdn_send_unlock</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l03416"></a>03416 {
<a name="l03417"></a>03417    <span class="comment">//cb_log(0,bc-&gt;port,&quot;UnLocking bc-&gt;pid:%d\n&quot;, bc-&gt;pid);</span>
<a name="l03418"></a>03418    <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa344dc277658ddd12815b6ff5f561a3f" title="B channel send locking structure.">send_lock</a>)
<a name="l03419"></a>03419       <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa344dc277658ddd12815b6ff5f561a3f" title="B channel send locking structure.">send_lock</a>-&gt;<a class="code" href="structsend__lock.html#a0abaf4b5d42c4e5d19190035fade3599">lock</a>);
<a name="l03420"></a>03420 }
<a name="l03421"></a>03421 
<a name="l03422"></a><a class="code" href="isdn__lib_8h.html#a9b9f5e8fc32b68c5d1a0c28d7ee40fb3">03422</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a9b9f5e8fc32b68c5d1a0c28d7ee40fb3">misdn_lib_send_event</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0">event_e</a> event )
<a name="l03423"></a>03423 {
<a name="l03424"></a>03424    msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>; 
<a name="l03425"></a>03425    <span class="keywordtype">int</span> retval=0;
<a name="l03426"></a>03426    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l03427"></a>03427    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *held_bc;
<a name="l03428"></a>03428   
<a name="l03429"></a>03429    <span class="keywordflow">if</span> (!bc) <a class="code" href="isdn__lib_8c.html#ab174c05fc2551d7f453553831deb6989">RETURN</a>(-1,OUT_POST_UNLOCK);
<a name="l03430"></a>03430    
<a name="l03431"></a>03431    stack = <a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l03432"></a>03432    
<a name="l03433"></a>03433    <span class="keywordflow">if</span> (!stack) {
<a name="l03434"></a>03434       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;SENDEVENT: no Stack for event:%s oad:%s dad:%s \n&quot;</span>, <a class="code" href="isdn__lib__intern_8h.html#a622bd30db092a77314ee5e5581a80f75">isdn_get_info</a>(<a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a>, event, 0), bc-&gt;<a class="code" href="structmisdn__bchannel.html#a8d2efe6f05b62dd9ce5153b822663083" title="Originating/Calling Phone Number (Address).">oad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa306ec0dd386e28152b3f39d2a389402" title="Dialed/Called Phone Number (Address).">dad</a>);
<a name="l03435"></a>03435       <a class="code" href="isdn__lib_8c.html#ab174c05fc2551d7f453553831deb6989">RETURN</a>(-1,OUT);
<a name="l03436"></a>03436    }
<a name="l03437"></a>03437    
<a name="l03438"></a>03438    <a class="code" href="isdn__lib_8c.html#a2ff7845faff8dd0d8a27530b5cb53340">misdn_send_lock</a>(bc);
<a name="l03439"></a>03439 
<a name="l03440"></a>03440 
<a name="l03441"></a>03441    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(6,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;SENDEVENT: stack-&gt;nt:%d stack-&gt;upperid:%x\n&quot;</span>,stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a>);
<a name="l03442"></a>03442 
<a name="l03443"></a>03443    <span class="keywordflow">if</span> ( stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a> &amp;&amp; !stack-&gt;<a class="code" href="structmisdn__stack.html#a579e76479941e4610b630ada968ae5e2" title="TRUE if Layer 1 is UP.">l1link</a>) {<span class="comment"></span>
<a name="l03444"></a>03444 <span class="comment">      /** Queue Event **/</span>
<a name="l03445"></a>03445       bc-&gt;<a class="code" href="structmisdn__bchannel.html#a07ec0ba2af253e4f29ee846bb28348be" title="Event waiting for Layer 1 to come up.">evq</a>=event;
<a name="l03446"></a>03446       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Queueing Event %s because L1 is down (btw. Activating L1)\n&quot;</span>, <a class="code" href="isdn__lib__intern_8h.html#a622bd30db092a77314ee5e5581a80f75">isdn_get_info</a>(<a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a>, event, 0));
<a name="l03447"></a>03447       <a class="code" href="isdn__lib_8c.html#a4af2f7ae2eb8c3746985df5544d17203">misdn_lib_get_l1_up</a>(stack);
<a name="l03448"></a>03448       <a class="code" href="isdn__lib_8c.html#ab174c05fc2551d7f453553831deb6989">RETURN</a>(0,OUT);
<a name="l03449"></a>03449    }
<a name="l03450"></a>03450    
<a name="l03451"></a>03451    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;I SEND:%s oad:%s dad:%s pid:%d\n&quot;</span>, <a class="code" href="isdn__lib__intern_8h.html#a622bd30db092a77314ee5e5581a80f75">isdn_get_info</a>(<a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a>, event, 0), bc-&gt;<a class="code" href="structmisdn__bchannel.html#a8d2efe6f05b62dd9ce5153b822663083" title="Originating/Calling Phone Number (Address).">oad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa306ec0dd386e28152b3f39d2a389402" title="Dialed/Called Phone Number (Address).">dad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a>);
<a name="l03452"></a>03452    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; --&gt; bc_state:%s\n&quot;</span>,<a class="code" href="isdn__lib_8c.html#ae2f4cc55968e9014a4daa06d1be05bef">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a>));
<a name="l03453"></a>03453    <a class="code" href="isdn__lib_8c.html#a3c9c5a8101a5212ab83e7eecfee8ea33">misdn_lib_log_ies</a>(bc);
<a name="l03454"></a>03454    
<a name="l03455"></a>03455    <span class="keywordflow">switch</span> (event) {
<a name="l03456"></a>03456    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a71b67c9dd659e015ff13d68c2d3ea2aa">EVENT_SETUP</a>:
<a name="l03457"></a>03457       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#ae97c690e8c7a79191abfcde368be8922">create_process</a>(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, bc)&lt;0) {
<a name="l03458"></a>03458          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,  stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; No free channel at the moment @ send_event\n&quot;</span>);
<a name="l03459"></a>03459 
<a name="l03460"></a>03460          <a class="code" href="isdn__lib_8c.html#ab174c05fc2551d7f453553831deb6989">RETURN</a>(-<a class="code" href="isdn__lib_8h.html#aefc450be0adfb41a7d1c57716c537648ad76b17371e2d0f0f02080a4c5058d160">ENOCHAN</a>,OUT);
<a name="l03461"></a>03461       }
<a name="l03462"></a>03462       <span class="keywordflow">break</span>;
<a name="l03463"></a>03463 
<a name="l03464"></a>03464    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a9edbfcbbe26666eab8693f9b070f1635">EVENT_PROGRESS</a>:
<a name="l03465"></a>03465    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a0de72a83490b9470ea743075273c82ed">EVENT_ALERTING</a>:
<a name="l03466"></a>03466    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0ae7a1bdce2a4a05df29bdd33b399592b9">EVENT_PROCEEDING</a>:
<a name="l03467"></a>03467    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a76e873730835e083066b5b1e48e7f97a">EVENT_SETUP_ACKNOWLEDGE</a>:
<a name="l03468"></a>03468    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a9d1a3f3e4b462e571e5485570ee63adb">EVENT_CONNECT</a>:
<a name="l03469"></a>03469       <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) <span class="keywordflow">break</span>;
<a name="l03470"></a>03470 
<a name="l03471"></a>03471    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a74f065bee005ec31713832d502578dfd">EVENT_RETRIEVE_ACKNOWLEDGE</a>:
<a name="l03472"></a>03472 
<a name="l03473"></a>03473       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) {
<a name="l03474"></a>03474          <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> &lt;=0 ) { <span class="comment">/*  else we have the channel already */</span>
<a name="l03475"></a>03475             <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a67727c8665c79737a5e7ffd7a524934a">find_free_chan_in_stack</a>(stack, bc, 0, 0)&lt;0) {
<a name="l03476"></a>03476                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot; No free channel at the moment\n&quot;</span>);
<a name="l03477"></a>03477                <span class="comment">/*FIXME: add disconnect*/</span>
<a name="l03478"></a>03478                <a class="code" href="isdn__lib_8c.html#ab174c05fc2551d7f453553831deb6989">RETURN</a>(-<a class="code" href="isdn__lib_8h.html#aefc450be0adfb41a7d1c57716c537648ad76b17371e2d0f0f02080a4c5058d160">ENOCHAN</a>,OUT);
<a name="l03479"></a>03479             }
<a name="l03480"></a>03480          }
<a name="l03481"></a>03481          <span class="comment">/* Its that i generate channels */</span>
<a name="l03482"></a>03482       }
<a name="l03483"></a>03483 
<a name="l03484"></a>03484       retval=<a class="code" href="isdn__lib_8c.html#a58b3989f0b5555f87f5c55fdefa8c6fb">setup_bc</a>(bc);
<a name="l03485"></a>03485       <span class="keywordflow">if</span> (retval == -EINVAL) {
<a name="l03486"></a>03486          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;send_event: setup_bc failed\n&quot;</span>);
<a name="l03487"></a>03487       }
<a name="l03488"></a>03488 
<a name="l03489"></a>03489       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#acaefa07620d12d0dc4f979c9e3c3f73e">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#afa05b14ff7f76f303c784c00c4c63fa7" title="SETUP message bearer capability field code value.">capability</a>)) {
<a name="l03490"></a>03490          <span class="keywordflow">if</span> ((event==<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a9d1a3f3e4b462e571e5485570ee63adb">EVENT_CONNECT</a>)||(event==<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a74f065bee005ec31713832d502578dfd">EVENT_RETRIEVE_ACKNOWLEDGE</a>)) {
<a name="l03491"></a>03491             <span class="keywordflow">if</span> ( *bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9aa37e2112fabf2ca6694c70d2f0ff24" title="Blowfish encryption key string (secret).">crypt_key</a> ) {
<a name="l03492"></a>03492                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,  <span class="stringliteral">&quot; --&gt; ENABLING BLOWFISH channel:%d oad%d:%s dad%d:%s \n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aeea5d3e5d16496a8b3e35bdcf9faf3f0" title="Type-of-number in ISDN terms for the originating/calling number (Caller-ID).">onumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a8d2efe6f05b62dd9ce5153b822663083" title="Originating/Calling Phone Number (Address).">oad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a54e1096eacf895fbbee3b263b8a5af5a" title="Type-of-number in ISDN terms for the dialed/called number.">dnumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa306ec0dd386e28152b3f39d2a389402" title="Dialed/Called Phone Number (Address).">dad</a>);
<a name="l03493"></a>03493                
<a name="l03494"></a>03494                <a class="code" href="isdn__lib_8c.html#a68056961358d38e2cef26ccf6c136a99">manager_ph_control_block</a>(bc,  BF_ENABLE_KEY, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9aa37e2112fabf2ca6694c70d2f0ff24" title="Blowfish encryption key string (secret).">crypt_key</a>, strlen(bc-&gt;<a class="code" href="structmisdn__bchannel.html#a9aa37e2112fabf2ca6694c70d2f0ff24" title="Blowfish encryption key string (secret).">crypt_key</a>) );
<a name="l03495"></a>03495             }
<a name="l03496"></a>03496             
<a name="l03497"></a>03497             <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#a134855bcd1a1ba0d1733faa7a4e94389" title="TRUE if we will not use jollys dsp.">nodsp</a>) <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc,  DTMF_TONE_START, 0);
<a name="l03498"></a>03498             <a class="code" href="isdn__lib_8c.html#a7e7944bc36ef8fe8e943ac12c2fea749">manager_ec_enable</a>(bc);
<a name="l03499"></a>03499             
<a name="l03500"></a>03500             <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#a709429a6031e18717677d5254d38586f" title="Tx gain setting (range -8 to 8).">txgain</a> != 0) {
<a name="l03501"></a>03501                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,  <span class="stringliteral">&quot;--&gt; Changing txgain to %d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a709429a6031e18717677d5254d38586f" title="Tx gain setting (range -8 to 8).">txgain</a>);
<a name="l03502"></a>03502                <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, VOL_CHANGE_TX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a709429a6031e18717677d5254d38586f" title="Tx gain setting (range -8 to 8).">txgain</a>);
<a name="l03503"></a>03503             }
<a name="l03504"></a>03504             
<a name="l03505"></a>03505             <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#a80d0395aae5582433d6b02af3f8c270a" title="Rx gain setting (range -8 to 8).">rxgain</a> != 0 ) {
<a name="l03506"></a>03506                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,  <span class="stringliteral">&quot;--&gt; Changing rxgain to %d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a80d0395aae5582433d6b02af3f8c270a" title="Rx gain setting (range -8 to 8).">rxgain</a>);
<a name="l03507"></a>03507                <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, VOL_CHANGE_RX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a80d0395aae5582433d6b02af3f8c270a" title="Rx gain setting (range -8 to 8).">rxgain</a>);
<a name="l03508"></a>03508             }
<a name="l03509"></a>03509          }
<a name="l03510"></a>03510       }
<a name="l03511"></a>03511       <span class="keywordflow">break</span>;
<a name="l03512"></a>03512 
<a name="l03513"></a>03513    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0ac490ba3a784107c476022618293c710d">EVENT_HOLD_ACKNOWLEDGE</a>:
<a name="l03514"></a>03514       held_bc = <a class="code" href="astmm_8h.html#ab8b25cd8f16d4a6552afe4e65c4f082d">malloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>));
<a name="l03515"></a>03515       <span class="keywordflow">if</span> (!held_bc) {
<a name="l03516"></a>03516          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;Could not allocate held_bc!!!\n&quot;</span>);
<a name="l03517"></a>03517          <a class="code" href="isdn__lib_8c.html#ab174c05fc2551d7f453553831deb6989">RETURN</a>(-1,OUT);
<a name="l03518"></a>03518       }
<a name="l03519"></a>03519 
<a name="l03520"></a>03520       <span class="comment">/* backup the bc and put it in storage */</span>
<a name="l03521"></a>03521       *held_bc = *bc;
<a name="l03522"></a>03522       held_bc-&gt;<a class="code" href="structmisdn__bchannel.html#a17ef6ae19b9fca79e3e2f7ce9525f089" title="TRUE if this channel is on hold.">holded</a> = 1;
<a name="l03523"></a>03523       held_bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> = 0;<span class="comment">/* A held call does not have a channel anymore. */</span>
<a name="l03524"></a>03524       held_bc-&gt;<a class="code" href="structmisdn__bchannel.html#a443e308806d144a6782fd01d04577129" title="TRUE if the B channel number is preselected.">channel_preselected</a> = 0;
<a name="l03525"></a>03525       held_bc-&gt;<a class="code" href="structmisdn__bchannel.html#a53653df89bd2c5e3e88716779e899aa9" title="TRUE if the channel was allocated from the available B channels.">channel_found</a> = 0;
<a name="l03526"></a>03526       <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(held_bc, <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4aeb34fa6afdc8da6670a1e3a14c85c6fa">BCHAN_CLEANED</a>);
<a name="l03527"></a>03527       <a class="code" href="isdn__lib_8c.html#aed5d2f567f0cd604dcb408ac5be5f983">stack_holder_add</a>(stack, held_bc);
<a name="l03528"></a>03528    
<a name="l03529"></a>03529       <span class="comment">/* kill the bridge and clean the real b-channel record */</span>
<a name="l03530"></a>03530       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) {
<a name="l03531"></a>03531          <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>;
<a name="l03532"></a>03532          <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a> == <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a660c00210e9cd580ec7f1b0250c3ce6e">BCHAN_BRIDGED</a>) {
<a name="l03533"></a>03533             <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc2;
<a name="l03534"></a>03534 
<a name="l03535"></a>03535             <a class="code" href="isdn__lib_8c.html#a4f8e334830dd8d96704965b9ef8de451">misdn_split_conf</a>(bc,bc-&gt;<a class="code" href="structmisdn__bchannel.html#aab0f7344f706b822f3aeab3e328793d0" title="Bridging conference ID.">conf_id</a>);
<a name="l03536"></a>03536             bc2 = <a class="code" href="isdn__lib_8c.html#ab6f6b56683e60c20c5adebda999718d4">find_bc_by_confid</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#aab0f7344f706b822f3aeab3e328793d0" title="Bridging conference ID.">conf_id</a>);
<a name="l03537"></a>03537             <span class="keywordflow">if</span> (!bc2) {
<a name="l03538"></a>03538                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;We have no second bc in bridge???\n&quot;</span>);
<a name="l03539"></a>03539             } <span class="keywordflow">else</span> {
<a name="l03540"></a>03540                <a class="code" href="isdn__lib_8c.html#a4f8e334830dd8d96704965b9ef8de451">misdn_split_conf</a>(bc2,bc-&gt;<a class="code" href="structmisdn__bchannel.html#aab0f7344f706b822f3aeab3e328793d0" title="Bridging conference ID.">conf_id</a>);
<a name="l03541"></a>03541             }
<a name="l03542"></a>03542          }
<a name="l03543"></a>03543          
<a name="l03544"></a>03544          channel = bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>;
<a name="l03545"></a>03545 
<a name="l03546"></a>03546          <a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">empty_bc</a>(bc);
<a name="l03547"></a>03547          <a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">clean_up_bc</a>(bc);
<a name="l03548"></a>03548 
<a name="l03549"></a>03549          <span class="keywordflow">if</span> (channel&gt;0)
<a name="l03550"></a>03550             <a class="code" href="isdn__lib_8c.html#a9f849e8a799ef7d6a52f6a10ec4446e5">empty_chan_in_stack</a>(stack,channel);
<a name="l03551"></a>03551 
<a name="l03552"></a>03552          bc-&gt;<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a>=0;  
<a name="l03553"></a>03553       }
<a name="l03554"></a>03554       <span class="keywordflow">break</span>;
<a name="l03555"></a>03555 
<a name="l03556"></a>03556    <span class="comment">/* finishing the channel eh ? */</span>
<a name="l03557"></a>03557    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0ac781d6bf6560fdb5855ef73245e8516c">EVENT_DISCONNECT</a>:
<a name="l03558"></a>03558       <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#a96296ec1ed855ce59e12762be480825b" title="TRUE if DISCONNECT needs to be sent to clear a call.">need_disconnect</a>) {
<a name="l03559"></a>03559          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot; --&gt; we have already send Disconnect\n&quot;</span>);
<a name="l03560"></a>03560          <a class="code" href="isdn__lib_8c.html#ab174c05fc2551d7f453553831deb6989">RETURN</a>(-1,OUT);
<a name="l03561"></a>03561       }
<a name="l03562"></a>03562       
<a name="l03563"></a>03563       bc-&gt;<a class="code" href="structmisdn__bchannel.html#a96296ec1ed855ce59e12762be480825b" title="TRUE if DISCONNECT needs to be sent to clear a call.">need_disconnect</a>=0;
<a name="l03564"></a>03564       <span class="keywordflow">break</span>;
<a name="l03565"></a>03565    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0abe8648d8a43122eac550c72a1babcb07">EVENT_RELEASE</a>:
<a name="l03566"></a>03566       <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#aca6b8a790005c71e029e73fd5362007b" title="TRUE if RELEASE needs to be sent to clear a call.">need_release</a>) {
<a name="l03567"></a>03567          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot; --&gt; we have already send Release\n&quot;</span>);
<a name="l03568"></a>03568          <a class="code" href="isdn__lib_8c.html#ab174c05fc2551d7f453553831deb6989">RETURN</a>(-1,OUT);
<a name="l03569"></a>03569       }
<a name="l03570"></a>03570       bc-&gt;<a class="code" href="structmisdn__bchannel.html#a96296ec1ed855ce59e12762be480825b" title="TRUE if DISCONNECT needs to be sent to clear a call.">need_disconnect</a>=0;
<a name="l03571"></a>03571       bc-&gt;<a class="code" href="structmisdn__bchannel.html#aca6b8a790005c71e029e73fd5362007b" title="TRUE if RELEASE needs to be sent to clear a call.">need_release</a>=0;
<a name="l03572"></a>03572       <span class="keywordflow">break</span>;
<a name="l03573"></a>03573    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a2473594848bb5e1cb2eafb862337f51a">EVENT_RELEASE_COMPLETE</a>:
<a name="l03574"></a>03574       <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#a81790e7ee2b93373b0e048d0ef4c53bd" title="TRUE if RELEASE_COMPLETE needs to be sent to clear a call.">need_release_complete</a>) {
<a name="l03575"></a>03575          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot; --&gt; we have already send Release_complete\n&quot;</span>);
<a name="l03576"></a>03576          <a class="code" href="isdn__lib_8c.html#ab174c05fc2551d7f453553831deb6989">RETURN</a>(-1,OUT);
<a name="l03577"></a>03577       }
<a name="l03578"></a>03578       bc-&gt;<a class="code" href="structmisdn__bchannel.html#a96296ec1ed855ce59e12762be480825b" title="TRUE if DISCONNECT needs to be sent to clear a call.">need_disconnect</a>=0;
<a name="l03579"></a>03579       bc-&gt;<a class="code" href="structmisdn__bchannel.html#aca6b8a790005c71e029e73fd5362007b" title="TRUE if RELEASE needs to be sent to clear a call.">need_release</a>=0;
<a name="l03580"></a>03580       bc-&gt;<a class="code" href="structmisdn__bchannel.html#a81790e7ee2b93373b0e048d0ef4c53bd" title="TRUE if RELEASE_COMPLETE needs to be sent to clear a call.">need_release_complete</a>=0;
<a name="l03581"></a>03581 
<a name="l03582"></a>03582       <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>) {
<a name="l03583"></a>03583          <span class="comment">/*create cleanup in TE*/</span>
<a name="l03584"></a>03584          <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>=bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>;
<a name="l03585"></a>03585 
<a name="l03586"></a>03586          <span class="keywordtype">int</span> tmpcause=bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa4d0ccb9d0904892652f2f258c5ad225" title="Q.931 Cause for disconnection code (received).">cause</a>; 
<a name="l03587"></a>03587          <span class="keywordtype">int</span> tmp_out_cause=bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1b724daeb32d8d023765605586269a02" title="Q.931 Cause for disconnection code (sent).">out_cause</a>; 
<a name="l03588"></a>03588          <a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">empty_bc</a>(bc);
<a name="l03589"></a>03589          bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa4d0ccb9d0904892652f2f258c5ad225" title="Q.931 Cause for disconnection code (received).">cause</a>=tmpcause;
<a name="l03590"></a>03590          bc-&gt;<a class="code" href="structmisdn__bchannel.html#a1b724daeb32d8d023765605586269a02" title="Q.931 Cause for disconnection code (sent).">out_cause</a>=tmp_out_cause;
<a name="l03591"></a>03591          <a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">clean_up_bc</a>(bc);
<a name="l03592"></a>03592          
<a name="l03593"></a>03593          <span class="keywordflow">if</span> (channel&gt;0)
<a name="l03594"></a>03594             <a class="code" href="isdn__lib_8c.html#a9f849e8a799ef7d6a52f6a10ec4446e5">empty_chan_in_stack</a>(stack,channel);
<a name="l03595"></a>03595          
<a name="l03596"></a>03596          bc-&gt;<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a>=0;
<a name="l03597"></a>03597       }
<a name="l03598"></a>03598       <span class="keywordflow">break</span>;
<a name="l03599"></a>03599     
<a name="l03600"></a>03600    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0ad0435294fbb8a6afc9e2713035d044ea">EVENT_CONNECT_ACKNOWLEDGE</a>:
<a name="l03601"></a>03601 
<a name="l03602"></a>03602       <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a> || <a class="code" href="isdn__lib_8c.html#acaefa07620d12d0dc4f979c9e3c3f73e">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#afa05b14ff7f76f303c784c00c4c63fa7" title="SETUP message bearer capability field code value.">capability</a>)) {
<a name="l03603"></a>03603          <span class="keywordtype">int</span> retval=<a class="code" href="isdn__lib_8c.html#a58b3989f0b5555f87f5c55fdefa8c6fb">setup_bc</a>(bc);
<a name="l03604"></a>03604          <span class="keywordflow">if</span> (retval == -EINVAL){
<a name="l03605"></a>03605             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;send_event: setup_bc failed\n&quot;</span>);
<a name="l03606"></a>03606             
<a name="l03607"></a>03607          }
<a name="l03608"></a>03608       }
<a name="l03609"></a>03609       
<a name="l03610"></a>03610       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#acaefa07620d12d0dc4f979c9e3c3f73e">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#afa05b14ff7f76f303c784c00c4c63fa7" title="SETUP message bearer capability field code value.">capability</a>)) {
<a name="l03611"></a>03611          <span class="keywordflow">if</span> (  !bc-&gt;<a class="code" href="structmisdn__bchannel.html#a134855bcd1a1ba0d1733faa7a4e94389" title="TRUE if we will not use jollys dsp.">nodsp</a>) <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc,  DTMF_TONE_START, 0);
<a name="l03612"></a>03612          <a class="code" href="isdn__lib_8c.html#a7e7944bc36ef8fe8e943ac12c2fea749">manager_ec_enable</a>(bc);
<a name="l03613"></a>03613 
<a name="l03614"></a>03614          <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#a709429a6031e18717677d5254d38586f" title="Tx gain setting (range -8 to 8).">txgain</a> != 0 ) {
<a name="l03615"></a>03615             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;--&gt; Changing txgain to %d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a709429a6031e18717677d5254d38586f" title="Tx gain setting (range -8 to 8).">txgain</a>);
<a name="l03616"></a>03616             <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, VOL_CHANGE_TX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a709429a6031e18717677d5254d38586f" title="Tx gain setting (range -8 to 8).">txgain</a>);
<a name="l03617"></a>03617          }
<a name="l03618"></a>03618          <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#a80d0395aae5582433d6b02af3f8c270a" title="Rx gain setting (range -8 to 8).">rxgain</a> != 0 ) {
<a name="l03619"></a>03619             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;--&gt; Changing rxgain to %d\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a80d0395aae5582433d6b02af3f8c270a" title="Rx gain setting (range -8 to 8).">rxgain</a>);
<a name="l03620"></a>03620             <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, VOL_CHANGE_RX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a80d0395aae5582433d6b02af3f8c270a" title="Rx gain setting (range -8 to 8).">rxgain</a>);
<a name="l03621"></a>03621          }
<a name="l03622"></a>03622       }
<a name="l03623"></a>03623       <span class="keywordflow">break</span>;
<a name="l03624"></a>03624     
<a name="l03625"></a>03625    <span class="keywordflow">default</span>:
<a name="l03626"></a>03626       <span class="keywordflow">break</span>;
<a name="l03627"></a>03627    }
<a name="l03628"></a>03628   
<a name="l03629"></a>03629    <span class="comment">/* Later we should think about sending bchannel data directly to misdn. */</span>
<a name="l03630"></a>03630    msg = <a class="code" href="isdn__lib__intern_8h.html#aa7c9e04ed1d840c5faccb31bee81e0cd">isdn_msg_build_event</a>(<a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a>, bc, event, stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>);
<a name="l03631"></a>03631    msg_queue_tail(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a22a2136dedb63955d062cead263b809f" title="Queue of Event messages to send to mISDN.">downqueue</a>, msg);
<a name="l03632"></a>03632    sem_post(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3faba04201c788a3b42b3af24b83f61f">new_msg</a>);
<a name="l03633"></a>03633   
<a name="l03634"></a>03634 OUT:
<a name="l03635"></a>03635    <a class="code" href="isdn__lib_8c.html#ae7b6289e3ab5212df9ea53affa9d80ea">misdn_send_unlock</a>(bc);
<a name="l03636"></a>03636 
<a name="l03637"></a>03637 OUT_POST_UNLOCK:
<a name="l03638"></a>03638    <span class="keywordflow">return</span> retval; 
<a name="l03639"></a>03639 }
<a name="l03640"></a>03640 
<a name="l03641"></a>03641 
<a name="l03642"></a><a class="code" href="isdn__lib_8c.html#ae0b36ec3b4c898343341c71ee0e02c68">03642</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#ae0b36ec3b4c898343341c71ee0e02c68">handle_err</a>(msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)
<a name="l03643"></a>03643 {
<a name="l03644"></a>03644    iframe_t *frm = (iframe_t*) msg-&gt;data;
<a name="l03645"></a>03645 
<a name="l03646"></a>03646 
<a name="l03647"></a>03647    if (!frm-&gt;addr) {
<a name="l03648"></a>03648       <span class="keyword">static</span> <span class="keywordtype">int</span> cnt=0;
<a name="l03649"></a>03649       <span class="keywordflow">if</span> (!cnt)
<a name="l03650"></a>03650          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,0,<span class="stringliteral">&quot;mISDN Msg without Address pr:%x dinfo:%x\n&quot;</span>,frm-&gt;prim,frm-&gt;dinfo);
<a name="l03651"></a>03651       cnt++;
<a name="l03652"></a>03652       <span class="keywordflow">if</span> (cnt&gt;100) {
<a name="l03653"></a>03653          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,0,<span class="stringliteral">&quot;mISDN Msg without Address pr:%x dinfo:%x (already more than 100 of them)\n&quot;</span>,frm-&gt;prim,frm-&gt;dinfo);
<a name="l03654"></a>03654          cnt=0;
<a name="l03655"></a>03655       }
<a name="l03656"></a>03656       
<a name="l03657"></a>03657       free_msg(msg);
<a name="l03658"></a>03658       <span class="keywordflow">return</span> 1;
<a name="l03659"></a>03659       
<a name="l03660"></a>03660    }
<a name="l03661"></a>03661    
<a name="l03662"></a>03662    <span class="keywordflow">switch</span> (frm-&gt;prim) {
<a name="l03663"></a>03663       <span class="keywordflow">case</span> MGR_SETSTACK|INDICATION:
<a name="l03664"></a>03664          <span class="keywordflow">return</span> <a class="code" href="isdn__lib_8c.html#acb9ba231d9a9431439f251157ec6e1c0">handle_bchan</a>(msg);
<a name="l03665"></a>03665       <span class="keywordflow">break</span>;
<a name="l03666"></a>03666 
<a name="l03667"></a>03667       <span class="keywordflow">case</span> MGR_SETSTACK|CONFIRM:
<a name="l03668"></a>03668       <span class="keywordflow">case</span> MGR_CLEARSTACK|CONFIRM:
<a name="l03669"></a>03669          free_msg(msg) ; 
<a name="l03670"></a>03670          <span class="keywordflow">return</span> 1;
<a name="l03671"></a>03671       <span class="keywordflow">break</span>;
<a name="l03672"></a>03672 
<a name="l03673"></a>03673       <span class="keywordflow">case</span> DL_DATA|CONFIRM:
<a name="l03674"></a>03674          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,0,<span class="stringliteral">&quot;DL_DATA|CONFIRM\n&quot;</span>);
<a name="l03675"></a>03675          free_msg(msg);
<a name="l03676"></a>03676          <span class="keywordflow">return</span> 1;
<a name="l03677"></a>03677 
<a name="l03678"></a>03678       <span class="keywordflow">case</span> PH_CONTROL|CONFIRM:
<a name="l03679"></a>03679          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,0,<span class="stringliteral">&quot;PH_CONTROL|CONFIRM\n&quot;</span>);
<a name="l03680"></a>03680          free_msg(msg);
<a name="l03681"></a>03681          <span class="keywordflow">return</span> 1;
<a name="l03682"></a>03682 
<a name="l03683"></a>03683       <span class="keywordflow">case</span> DL_DATA|INDICATION:
<a name="l03684"></a>03684       {
<a name="l03685"></a>03685          <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>=(frm-&gt;addr&amp;MASTER_ID_MASK) &gt;&gt; 8;
<a name="l03686"></a>03686          <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>=(frm-&gt;addr&amp;CHILD_ID_MASK) &gt;&gt; 16;
<a name="l03687"></a>03687          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc;
<a name="l03688"></a>03688 
<a name="l03689"></a>03689          <span class="comment">/*we flush the read buffer here*/</span>
<a name="l03690"></a>03690          
<a name="l03691"></a>03691          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(9,0,<span class="stringliteral">&quot;BCHAN DATA without BC: addr:%x port:%d channel:%d\n&quot;</span>,frm-&gt;addr, port,channel);
<a name="l03692"></a>03692          
<a name="l03693"></a>03693          free_msg(msg); 
<a name="l03694"></a>03694          <span class="keywordflow">return</span> 1;
<a name="l03695"></a>03695          
<a name="l03696"></a>03696          
<a name="l03697"></a>03697          bc = <a class="code" href="isdn__lib_8c.html#ac8166c295a460811db716afa8ff5d036">find_bc_by_channel</a>(port, channel);
<a name="l03698"></a>03698 
<a name="l03699"></a>03699          <span class="keywordflow">if</span> (!bc) {
<a name="l03700"></a>03700             <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack = <a class="code" href="isdn__lib_8c.html#a440118240f78921a8727b1587ce959b0">find_stack_by_port</a>(port);
<a name="l03701"></a>03701 
<a name="l03702"></a>03702             <span class="keywordflow">if</span> (!stack) {
<a name="l03703"></a>03703                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,0,<span class="stringliteral">&quot; --&gt; stack not found\n&quot;</span>);
<a name="l03704"></a>03704                free_msg(msg);
<a name="l03705"></a>03705                <span class="keywordflow">return</span> 1;
<a name="l03706"></a>03706             }
<a name="l03707"></a>03707             
<a name="l03708"></a>03708             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,0,<span class="stringliteral">&quot; --&gt; bc not found by channel\n&quot;</span>);
<a name="l03709"></a>03709             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a2f51cb4d0630a299b4e436c7471eea21" title="TRUE if Layer 2 is UP.">l2link</a>)
<a name="l03710"></a>03710                <a class="code" href="isdn__lib_8c.html#aca6da100bec9aa446c5ccf22e6d894c6">misdn_lib_get_l2_down</a>(stack);
<a name="l03711"></a>03711 
<a name="l03712"></a>03712             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a579e76479941e4610b630ada968ae5e2" title="TRUE if Layer 1 is UP.">l1link</a>)
<a name="l03713"></a>03713                <a class="code" href="isdn__lib_8c.html#af5d84057ddf714f7329a057806fcd6f4">misdn_lib_get_l1_down</a>(stack);
<a name="l03714"></a>03714 
<a name="l03715"></a>03715             free_msg(msg);
<a name="l03716"></a>03716             <span class="keywordflow">return</span> 1;
<a name="l03717"></a>03717          }
<a name="l03718"></a>03718          
<a name="l03719"></a>03719          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3,port,<span class="stringliteral">&quot; --&gt; BC in state:%s\n&quot;</span>, <a class="code" href="isdn__lib_8c.html#ae2f4cc55968e9014a4daa06d1be05bef">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a>));
<a name="l03720"></a>03720       }
<a name="l03721"></a>03721    }
<a name="l03722"></a>03722 
<a name="l03723"></a>03723    <span class="keywordflow">return</span> 0;
<a name="l03724"></a>03724 }
<a name="l03725"></a>03725 
<a name="l03726"></a>03726 <span class="preprocessor">#if 0</span>
<a name="l03727"></a>03727 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> queue_l2l3(msg_t *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)
<a name="l03728"></a>03728 {
<a name="l03729"></a>03729    iframe_t *frm= (iframe_t*)msg-&gt;data;
<a name="l03730"></a>03730    <span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l03731"></a>03731    stack=<a class="code" href="isdn__lib_8c.html#a7db594d519df4dae7eb3dbd1b128d6f8">find_stack_by_addr</a>( frm-&gt;addr );
<a name="l03732"></a>03732 
<a name="l03733"></a>03733    
<a name="l03734"></a>03734    <span class="keywordflow">if</span> (!stack) {
<a name="l03735"></a>03735       <span class="keywordflow">return</span> 0;
<a name="l03736"></a>03736    }
<a name="l03737"></a>03737 
<a name="l03738"></a>03738    msg_queue_tail(&amp;stack-&gt;upqueue, msg);
<a name="l03739"></a>03739    sem_post(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3faba04201c788a3b42b3af24b83f61f">new_msg</a>);
<a name="l03740"></a>03740    <span class="keywordflow">return</span> 1;
<a name="l03741"></a>03741 }
<a name="l03742"></a>03742 <span class="preprocessor">#endif</span>
<a name="l03743"></a>03743 <span class="preprocessor"></span>
<a name="l03744"></a><a class="code" href="isdn__lib_8c.html#a9b68a92e4295d00f7450b5300b63eef0">03744</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a9b68a92e4295d00f7450b5300b63eef0">manager_isdn_handler</a>(iframe_t *frm ,msg_t *msg)
<a name="l03745"></a>03745 {  
<a name="l03746"></a>03746 
<a name="l03747"></a>03747    <span class="keywordflow">if</span> (frm-&gt;dinfo==0xffffffff &amp;&amp; frm-&gt;prim==(PH_DATA|CONFIRM)) {
<a name="l03748"></a>03748       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,0,<span class="stringliteral">&quot;SERIOUS BUG, dinfo == 0xffffffff, prim == PH_DATA | CONFIRM !!!!\n&quot;</span>);
<a name="l03749"></a>03749    }
<a name="l03750"></a>03750 
<a name="l03751"></a>03751    <span class="keywordflow">if</span> ( ((frm-&gt;addr | ISDN_PID_BCHANNEL_BIT )&gt;&gt; 28 ) == 0x5) {
<a name="l03752"></a>03752       <span class="keyword">static</span> <span class="keywordtype">int</span> unhandled_bmsg_count=1000;
<a name="l03753"></a>03753       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#acb9ba231d9a9431439f251157ec6e1c0">handle_bchan</a>(msg)) {
<a name="l03754"></a>03754          <span class="keywordflow">return</span> 0 ;
<a name="l03755"></a>03755       }
<a name="l03756"></a>03756          
<a name="l03757"></a>03757       <span class="keywordflow">if</span> (unhandled_bmsg_count==1000) {
<a name="l03758"></a>03758          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, 0, <span class="stringliteral">&quot;received 1k Unhandled Bchannel Messages: prim %x len %d from addr %x, dinfo %x on this port.\n&quot;</span>,frm-&gt;prim, frm-&gt;len, frm-&gt;addr, frm-&gt;dinfo);     
<a name="l03759"></a>03759          unhandled_bmsg_count=0;
<a name="l03760"></a>03760       }
<a name="l03761"></a>03761 
<a name="l03762"></a>03762       unhandled_bmsg_count++;
<a name="l03763"></a>03763       free_msg(msg);
<a name="l03764"></a>03764       <span class="keywordflow">return</span> 0;
<a name="l03765"></a>03765    }  
<a name="l03766"></a>03766 
<a name="l03767"></a>03767 <span class="preprocessor">#ifdef RECV_FRM_SYSLOG_DEBUG</span>
<a name="l03768"></a>03768 <span class="preprocessor"></span>   syslog(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;mISDN recv: P(%02d): ADDR:%x PRIM:%x DINFO:%x\n&quot;</span>,stack-&gt;port, frm-&gt;addr, frm-&gt;prim, frm-&gt;dinfo);
<a name="l03769"></a>03769 <span class="preprocessor">#endif</span>
<a name="l03770"></a>03770 <span class="preprocessor"></span>
<a name="l03771"></a>03771    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#adb7b67eb1f67f3b72857d674c6735114">handle_timers</a>(msg)) 
<a name="l03772"></a>03772       <span class="keywordflow">return</span> 0 ;
<a name="l03773"></a>03773 
<a name="l03774"></a>03774    
<a name="l03775"></a>03775    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#aa1f1bdac7d1036dd1d6cd3f7e10da56f">handle_mgmt</a>(msg)) 
<a name="l03776"></a>03776       <span class="keywordflow">return</span> 0 ; 
<a name="l03777"></a>03777    
<a name="l03778"></a>03778    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a035253f6b68b342189bc33f12250cddf">handle_l2</a>(msg)) 
<a name="l03779"></a>03779       <span class="keywordflow">return</span> 0 ;
<a name="l03780"></a>03780 
<a name="l03781"></a>03781    <span class="comment">/* Its important to handle l1 AFTER l2  */</span>
<a name="l03782"></a>03782    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#ac46cfb402396907e0f285b0e545afc01">handle_l1</a>(msg)) 
<a name="l03783"></a>03783       <span class="keywordflow">return</span> 0 ;
<a name="l03784"></a>03784    
<a name="l03785"></a>03785    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#aa98cf643b7264af96fa498d27e2d24bf">handle_frm_nt</a>(msg)) {
<a name="l03786"></a>03786       <span class="keywordflow">return</span> 0;
<a name="l03787"></a>03787    }
<a name="l03788"></a>03788 
<a name="l03789"></a>03789    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#adb9c8ee3cfac44315944b3991a141f13">handle_frm</a>(msg)) {
<a name="l03790"></a>03790       <span class="keywordflow">return</span> 0;
<a name="l03791"></a>03791    }
<a name="l03792"></a>03792 
<a name="l03793"></a>03793    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#ae0b36ec3b4c898343341c71ee0e02c68">handle_err</a>(msg)) {
<a name="l03794"></a>03794       <span class="keywordflow">return</span> 0 ;
<a name="l03795"></a>03795    }
<a name="l03796"></a>03796 
<a name="l03797"></a>03797    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, 0, <span class="stringliteral">&quot;Unhandled Message: prim %x len %d from addr %x, dinfo %x on this port.\n&quot;</span>,frm-&gt;prim, frm-&gt;len, frm-&gt;addr, frm-&gt;dinfo);      
<a name="l03798"></a>03798    free_msg(msg);
<a name="l03799"></a>03799    
<a name="l03800"></a>03800 
<a name="l03801"></a>03801    <span class="keywordflow">return</span> 0;
<a name="l03802"></a>03802 }
<a name="l03803"></a>03803 
<a name="l03804"></a>03804 
<a name="l03805"></a>03805 
<a name="l03806"></a>03806 
<a name="l03807"></a><a class="code" href="isdn__lib_8h.html#a48c18cde42ddfa415e3258a361cde489">03807</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a48c18cde42ddfa415e3258a361cde489">misdn_lib_get_port_info</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>)
<a name="l03808"></a>03808 {
<a name="l03809"></a>03809    msg_t *msg=alloc_msg(MAX_MSG_SIZE);
<a name="l03810"></a>03810    iframe_t *frm;
<a name="l03811"></a>03811    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a440118240f78921a8727b1587ce959b0">find_stack_by_port</a>(port);
<a name="l03812"></a>03812    <span class="keywordflow">if</span> (!msg) {
<a name="l03813"></a>03813       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;misdn_lib_get_port_info: alloc_msg failed!\n&quot;</span>);
<a name="l03814"></a>03814       <span class="keywordflow">return</span> -1;
<a name="l03815"></a>03815    }
<a name="l03816"></a>03816    frm=(iframe_t*)msg-&gt;data;
<a name="l03817"></a>03817    if (!stack ) {
<a name="l03818"></a>03818       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;There is no Stack for this port.\n&quot;</span>);
<a name="l03819"></a>03819       <span class="keywordflow">return</span> -1;
<a name="l03820"></a>03820    }
<a name="l03821"></a>03821    <span class="comment">/* activate bchannel */</span>
<a name="l03822"></a>03822    frm-&gt;prim = CC_STATUS_ENQUIRY | REQUEST;
<a name="l03823"></a>03823 
<a name="l03824"></a>03824    frm-&gt;addr = stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a>| FLG_MSG_DOWN;
<a name="l03825"></a>03825 
<a name="l03826"></a>03826    frm-&gt;dinfo = 0;
<a name="l03827"></a>03827    frm-&gt;len = 0;
<a name="l03828"></a>03828   
<a name="l03829"></a>03829    msg_queue_tail(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ad99ef86d7f5f4f6e4b4785fda4e1abcb">activatequeue</a>, msg);
<a name="l03830"></a>03830    sem_post(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3faba04201c788a3b42b3af24b83f61f">new_msg</a>);
<a name="l03831"></a>03831 
<a name="l03832"></a>03832   
<a name="l03833"></a>03833    <span class="keywordflow">return</span> 0; 
<a name="l03834"></a>03834 }
<a name="l03835"></a>03835 
<a name="l03836"></a>03836 
<a name="l03837"></a><a class="code" href="isdn__lib_8c.html#a3e98bad8b07fc948392093f449341f4c">03837</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a3e98bad8b07fc948392093f449341f4c">queue_cleanup_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc) 
<a name="l03838"></a>03838 {
<a name="l03839"></a>03839    msg_t *msg=alloc_msg(MAX_MSG_SIZE);
<a name="l03840"></a>03840    iframe_t *frm;
<a name="l03841"></a>03841    <span class="keywordflow">if</span> (!msg) {
<a name="l03842"></a>03842       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;queue_cleanup_bc: alloc_msg failed!\n&quot;</span>);
<a name="l03843"></a>03843       <span class="keywordflow">return</span> -1;
<a name="l03844"></a>03844    }
<a name="l03845"></a>03845    frm=(iframe_t*)msg-&gt;data;
<a name="l03846"></a>03846 
<a name="l03847"></a>03847    <span class="comment">/* activate bchannel */</span>
<a name="l03848"></a>03848    frm-&gt;prim = MGR_CLEARSTACK| REQUEST;
<a name="l03849"></a>03849 
<a name="l03850"></a>03850    frm-&gt;addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>;
<a name="l03851"></a>03851 
<a name="l03852"></a>03852    frm-&gt;dinfo = bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>;
<a name="l03853"></a>03853    frm-&gt;len = 0;
<a name="l03854"></a>03854   
<a name="l03855"></a>03855    msg_queue_tail(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ad99ef86d7f5f4f6e4b4785fda4e1abcb">activatequeue</a>, msg);
<a name="l03856"></a>03856    sem_post(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3faba04201c788a3b42b3af24b83f61f">new_msg</a>);
<a name="l03857"></a>03857 
<a name="l03858"></a>03858    <span class="keywordflow">return</span> 0; 
<a name="l03859"></a>03859 
<a name="l03860"></a>03860 }
<a name="l03861"></a>03861 
<a name="l03862"></a><a class="code" href="isdn__lib_8h.html#a111cdb350e166d2945f9fd13baa2ebc0">03862</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a111cdb350e166d2945f9fd13baa2ebc0">misdn_lib_pid_restart</a>(<span class="keywordtype">int</span> pid) 
<a name="l03863"></a>03863 {
<a name="l03864"></a>03864    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#abf9dc535c1858428371b26baf226db3d">manager_find_bc_by_pid</a>(pid);
<a name="l03865"></a>03865 
<a name="l03866"></a>03866    <span class="keywordflow">if</span> (bc) {
<a name="l03867"></a>03867       <a class="code" href="isdn__lib_8c.html#ad4a199ce1a64870d8f5ca24d048ada66">manager_clean_bc</a>(bc);
<a name="l03868"></a>03868    }
<a name="l03869"></a>03869    <span class="keywordflow">return</span> 0;
<a name="l03870"></a>03870 }
<a name="l03871"></a>03871 
<a name="l03872"></a>03872 <span class="comment">/*Sends Restart message for every bchannel*/</span>
<a name="l03873"></a><a class="code" href="isdn__lib_8h.html#a5eece989af344908ee385f23239508da">03873</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a5eece989af344908ee385f23239508da">misdn_lib_send_restart</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>)
<a name="l03874"></a>03874 {
<a name="l03875"></a>03875    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a440118240f78921a8727b1587ce959b0">find_stack_by_port</a>(port);
<a name="l03876"></a>03876    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> dummybc;
<a name="l03877"></a>03877    <span class="comment">/*default is all channels*/</span>
<a name="l03878"></a>03878    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;Sending Restarts on this port.\n&quot;</span>);
<a name="l03879"></a>03879    
<a name="l03880"></a>03880    <a class="code" href="isdn__lib_8c.html#aeb7cfd0342e0a820eb3d7302401c9c74">misdn_make_dummy</a>(&amp;dummybc, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, MISDN_ID_GLOBAL, stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>, 0);
<a name="l03881"></a>03881 
<a name="l03882"></a>03882    <span class="comment">/*default is all channels*/</span>
<a name="l03883"></a>03883    <span class="keywordflow">if</span> (channel &lt;0) {
<a name="l03884"></a>03884       dummybc.<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>=-1;
<a name="l03885"></a>03885       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;Restarting and all Interfaces\n&quot;</span>);
<a name="l03886"></a>03886       <a class="code" href="isdn__lib_8c.html#a9b9f5e8fc32b68c5d1a0c28d7ee40fb3">misdn_lib_send_event</a>(&amp;dummybc, <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a5932a8e4c466cdd288c5133486bf386c">EVENT_RESTART</a>);
<a name="l03887"></a>03887 
<a name="l03888"></a>03888       <span class="keywordflow">return</span> 0;
<a name="l03889"></a>03889    }
<a name="l03890"></a>03890 
<a name="l03891"></a>03891    <span class="comment">/*if a channel is specified we restart only this one*/</span>
<a name="l03892"></a>03892    <span class="keywordflow">if</span> (channel &gt;0) {
<a name="l03893"></a>03893       <span class="keywordtype">int</span> cnt;
<a name="l03894"></a>03894       dummybc.<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>=channel;
<a name="l03895"></a>03895       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;Restarting and cleaning channel %d\n&quot;</span>,channel);
<a name="l03896"></a>03896       <a class="code" href="isdn__lib_8c.html#a9b9f5e8fc32b68c5d1a0c28d7ee40fb3">misdn_lib_send_event</a>(&amp;dummybc, <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0a5932a8e4c466cdd288c5133486bf386c">EVENT_RESTART</a>);
<a name="l03897"></a>03897       <span class="comment">/* clean up chan in stack, to be sure we don&apos;t think it&apos;s</span>
<a name="l03898"></a>03898 <span class="comment">       * in use anymore */</span>
<a name="l03899"></a>03899       <span class="keywordflow">for</span> (cnt=0; cnt&lt;=stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; cnt++) {
<a name="l03900"></a>03900          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[cnt].<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a> &amp;&amp; stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[cnt].<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a> == channel) {
<a name="l03901"></a>03901             <a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">empty_bc</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[cnt]);
<a name="l03902"></a>03902             <a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">clean_up_bc</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[cnt]);
<a name="l03903"></a>03903             stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[cnt].<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a>=0;
<a name="l03904"></a>03904          }
<a name="l03905"></a>03905       }
<a name="l03906"></a>03906    }
<a name="l03907"></a>03907 
<a name="l03908"></a>03908    <span class="keywordflow">return</span> 0;
<a name="l03909"></a>03909 }
<a name="l03910"></a>03910 
<a name="l03911"></a>03911 <span class="comment">/*reinitializes the L2/L3*/</span>
<a name="l03912"></a><a class="code" href="isdn__lib_8h.html#a8cf964fe703a6f4f84f2011cd191a0df">03912</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a8cf964fe703a6f4f84f2011cd191a0df">misdn_lib_port_restart</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>)
<a name="l03913"></a>03913 {
<a name="l03914"></a>03914    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a440118240f78921a8727b1587ce959b0">find_stack_by_port</a>(port);
<a name="l03915"></a>03915  
<a name="l03916"></a>03916    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;Restarting this port.\n&quot;</span>);
<a name="l03917"></a>03917    <span class="keywordflow">if</span> (stack) {
<a name="l03918"></a>03918       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;Stack:%p\n&quot;</span>,stack);
<a name="l03919"></a>03919          
<a name="l03920"></a>03920       <a class="code" href="isdn__lib_8c.html#ad1f0e37879b7ff599b95f5e9df7ae482">clear_l3</a>(stack);
<a name="l03921"></a>03921       {
<a name="l03922"></a>03922          msg_t *msg=alloc_msg(MAX_MSG_SIZE);
<a name="l03923"></a>03923          iframe_t *frm;
<a name="l03924"></a>03924 
<a name="l03925"></a>03925          <span class="keywordflow">if</span> (!msg) {
<a name="l03926"></a>03926             <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;port_restart: alloc_msg failed\n&quot;</span>);
<a name="l03927"></a>03927             <span class="keywordflow">return</span> -1;
<a name="l03928"></a>03928          }
<a name="l03929"></a>03929          
<a name="l03930"></a>03930          frm=(iframe_t*)msg-&gt;data;
<a name="l03931"></a>03931          <span class="comment">/* we must activate if we are deactivated */</span>
<a name="l03932"></a>03932          <span class="comment">/* activate bchannel */</span>
<a name="l03933"></a>03933          frm-&gt;prim = DL_RELEASE | REQUEST;
<a name="l03934"></a>03934          frm-&gt;addr = stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a> | FLG_MSG_DOWN;
<a name="l03935"></a>03935 
<a name="l03936"></a>03936          frm-&gt;dinfo = 0;
<a name="l03937"></a>03937          frm-&gt;len = 0;
<a name="l03938"></a>03938          msg_queue_tail(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ad99ef86d7f5f4f6e4b4785fda4e1abcb">activatequeue</a>, msg);
<a name="l03939"></a>03939          sem_post(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3faba04201c788a3b42b3af24b83f61f">new_msg</a>);
<a name="l03940"></a>03940       }
<a name="l03941"></a>03941 
<a name="l03942"></a>03942       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>)
<a name="l03943"></a>03943          <a class="code" href="isdn__lib_8c.html#adade044f8be231389ea854bc1e529c71">misdn_lib_reinit_nt_stack</a>(stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>);
<a name="l03944"></a>03944     
<a name="l03945"></a>03945    }
<a name="l03946"></a>03946 
<a name="l03947"></a>03947    <span class="keywordflow">return</span> 0;
<a name="l03948"></a>03948 }
<a name="l03949"></a>03949 
<a name="l03950"></a>03950 
<a name="l03951"></a>03951 
<a name="l03952"></a><a class="code" href="isdn__lib_8c.html#aca20d9a83fc1212461466b04ee04772c">03952</a> <span class="keyword">static</span> sem_t <a class="code" href="isdn__lib_8c.html#aca20d9a83fc1212461466b04ee04772c">handler_started</a>; 
<a name="l03953"></a>03953 
<a name="l03954"></a>03954 <span class="comment">/* This is a thread */</span>
<a name="l03955"></a><a class="code" href="isdn__lib_8c.html#a9281c6f937aa747ba7e72e38573c4d9d">03955</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a9281c6f937aa747ba7e72e38573c4d9d">manager_event_handler</a>(<span class="keywordtype">void</span> *arg)
<a name="l03956"></a>03956 {
<a name="l03957"></a>03957    sem_post(&amp;handler_started); 
<a name="l03958"></a>03958    <span class="keywordflow">while</span> (1) {
<a name="l03959"></a>03959       <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l03960"></a>03960       msg_t *msg;
<a name="l03961"></a>03961     <span class="comment"></span>
<a name="l03962"></a>03962 <span class="comment">      /** wait for events **/</span>
<a name="l03963"></a>03963       sem_wait(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3faba04201c788a3b42b3af24b83f61f">new_msg</a>);
<a name="l03964"></a>03964     
<a name="l03965"></a>03965       <span class="keywordflow">for</span> (msg=msg_dequeue(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ad99ef86d7f5f4f6e4b4785fda4e1abcb">activatequeue</a>);
<a name="l03966"></a>03966            msg;
<a name="l03967"></a>03967            msg=msg_dequeue(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ad99ef86d7f5f4f6e4b4785fda4e1abcb">activatequeue</a>)
<a name="l03968"></a>03968          )
<a name="l03969"></a>03969       {
<a name="l03970"></a>03970    
<a name="l03971"></a>03971          iframe_t *frm =  (iframe_t*) msg-&gt;data ;
<a name="l03972"></a>03972 
<a name="l03973"></a>03973          switch ( frm-&gt;prim) {
<a name="l03974"></a>03974 
<a name="l03975"></a>03975          <span class="keywordflow">case</span> MGR_CLEARSTACK | REQUEST:
<a name="l03976"></a>03976             <span class="comment">/*a queued bchannel cleanup*/</span>
<a name="l03977"></a>03977             {
<a name="l03978"></a>03978                <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a440118240f78921a8727b1587ce959b0">find_stack_by_port</a>(frm-&gt;dinfo);
<a name="l03979"></a>03979                <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc;
<a name="l03980"></a>03980                <span class="keywordflow">if</span> (!stack) {
<a name="l03981"></a>03981                   <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,0,<span class="stringliteral">&quot;no stack found with port [%d]!! so we cannot cleanup the bc\n&quot;</span>,frm-&gt;dinfo);
<a name="l03982"></a>03982                   free_msg(msg);
<a name="l03983"></a>03983                   <span class="keywordflow">break</span>;
<a name="l03984"></a>03984                }
<a name="l03985"></a>03985                
<a name="l03986"></a>03986                bc = <a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(stack, frm-&gt;addr);
<a name="l03987"></a>03987                <span class="keywordflow">if</span> (bc) {
<a name="l03988"></a>03988                   <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;CLEARSTACK queued, cleaning up\n&quot;</span>);
<a name="l03989"></a>03989                   <a class="code" href="isdn__lib_8c.html#ab5888a5c3a8816fa4a5332592faf534f">clean_up_bc</a>(bc);
<a name="l03990"></a>03990                } <span class="keywordflow">else</span> {
<a name="l03991"></a>03991                   <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;bc could not be cleaned correctly !! addr [%x]\n&quot;</span>,frm-&gt;addr);
<a name="l03992"></a>03992                }
<a name="l03993"></a>03993             }
<a name="l03994"></a>03994             free_msg(msg); 
<a name="l03995"></a>03995             <span class="keywordflow">break</span>;
<a name="l03996"></a>03996          <span class="keywordflow">case</span> MGR_SETSTACK | REQUEST :
<a name="l03997"></a>03997             free_msg(msg);
<a name="l03998"></a>03998             <span class="keywordflow">break</span>;
<a name="l03999"></a>03999          <span class="keywordflow">default</span>:
<a name="l04000"></a>04000             mISDN_write(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, frm, mISDN_HEADER_LEN+frm-&gt;len, TIMEOUT_1SEC);
<a name="l04001"></a>04001             free_msg(msg);
<a name="l04002"></a>04002          }
<a name="l04003"></a>04003       }
<a name="l04004"></a>04004 
<a name="l04005"></a>04005       <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>;
<a name="l04006"></a>04006            stack;
<a name="l04007"></a>04007            stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a> ) { 
<a name="l04008"></a>04008 
<a name="l04009"></a>04009          <span class="keywordflow">while</span> ( (msg=msg_dequeue(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a8c19dab645a65e0caf1924c1bcce7f1d">upqueue</a>)) ) {<span class="comment"></span>
<a name="l04010"></a>04010 <span class="comment">            /** Handle L2/3 Signalling after bchans **/</span> 
<a name="l04011"></a>04011             <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#aa98cf643b7264af96fa498d27e2d24bf">handle_frm_nt</a>(msg)) {
<a name="l04012"></a>04012                <span class="comment">/* Maybe it&apos;s TE */</span>
<a name="l04013"></a>04013                <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#adb9c8ee3cfac44315944b3991a141f13">handle_frm</a>(msg)) {
<a name="l04014"></a>04014                   <span class="comment">/* wow none! */</span>
<a name="l04015"></a>04015                   <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>,<span class="stringliteral">&quot;Wow we&apos;ve got a strange issue while dequeueing a Frame\n&quot;</span>);
<a name="l04016"></a>04016                }
<a name="l04017"></a>04017             }
<a name="l04018"></a>04018          }
<a name="l04019"></a>04019 
<a name="l04020"></a>04020          <span class="comment">/* Here we should check if we really want to </span>
<a name="l04021"></a>04021 <span class="comment">            send all the messages we&apos;ve queued, lets </span>
<a name="l04022"></a>04022 <span class="comment">            assume we&apos;ve queued a Disconnect, but </span>
<a name="l04023"></a>04023 <span class="comment">            received it already from the other side!*/</span>
<a name="l04024"></a>04024            
<a name="l04025"></a>04025          <span class="keywordflow">while</span> ( (msg=msg_dequeue(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a22a2136dedb63955d062cead263b809f" title="Queue of Event messages to send to mISDN.">downqueue</a>)) ) {
<a name="l04026"></a>04026             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a> ) {
<a name="l04027"></a>04027                <a class="code" href="lock_8h.html#a6ef26f63d38c1d8cdf05a15b6b368c24">pthread_mutex_lock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l04028"></a>04028                <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>, msg))
<a name="l04029"></a>04029                   <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Error@ Sending Message in NT-Stack.\n&quot;</span>);
<a name="l04030"></a>04030                <a class="code" href="lock_8h.html#ab417dd049910b852a43732c15e8dcaf2">pthread_mutex_unlock</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a6756735246feb4aedefb57bb261174de">nstlock</a>);
<a name="l04031"></a>04031             } <span class="keywordflow">else</span> {
<a name="l04032"></a>04032                iframe_t *frm = (iframe_t *)msg-&gt;data;
<a name="l04033"></a>04033                <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc = <a class="code" href="isdn__lib_8c.html#a30916b074b5a912d169137a8607acac7">find_bc_by_l3id</a>(stack, frm-&gt;dinfo);
<a name="l04034"></a>04034                <span class="keywordflow">if</span> (bc)
<a name="l04035"></a>04035                   <a class="code" href="isdn__lib_8c.html#a0e54055dbbf30b5553d4b3e71acb4162">send_msg</a>(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, bc, msg);
<a name="l04036"></a>04036                <span class="keywordflow">else</span>  {
<a name="l04037"></a>04037                   <span class="keywordflow">if</span> (frm-&gt;dinfo == MISDN_ID_GLOBAL || frm-&gt;dinfo == MISDN_ID_DUMMY ) {
<a name="l04038"></a>04038                      <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> dummybc;
<a name="l04039"></a>04039                      <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5,0,<span class="stringliteral">&quot; --&gt; GLOBAL/DUMMY\n&quot;</span>);
<a name="l04040"></a>04040                      <a class="code" href="isdn__lib_8c.html#aeb7cfd0342e0a820eb3d7302401c9c74">misdn_make_dummy</a>(&amp;dummybc, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, frm-&gt;dinfo, stack-&gt;<a class="code" href="structmisdn__stack.html#aa10df685d964a073b6109e024ca6e9ec" title="TRUE if NT side of protocol (TE otherwise).">nt</a>, 0);
<a name="l04041"></a>04041                      <a class="code" href="isdn__lib_8c.html#a0e54055dbbf30b5553d4b3e71acb4162">send_msg</a>(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, &amp;dummybc, msg);
<a name="l04042"></a>04042                   } <span class="keywordflow">else</span> {
<a name="l04043"></a>04043                      <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0,0,<span class="stringliteral">&quot;No bc for Message\n&quot;</span>);
<a name="l04044"></a>04044                   }
<a name="l04045"></a>04045                }
<a name="l04046"></a>04046             }
<a name="l04047"></a>04047          }
<a name="l04048"></a>04048       }
<a name="l04049"></a>04049    }
<a name="l04050"></a>04050 }
<a name="l04051"></a>04051 
<a name="l04052"></a>04052 
<a name="l04053"></a><a class="code" href="isdn__lib_8h.html#a09fa0c33c5c8fc7f1317234b3965d7ab">04053</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a09fa0c33c5c8fc7f1317234b3965d7ab">misdn_lib_maxports_get</a>(<span class="keywordtype">void</span>)
<a name="l04054"></a>04054 {
<a name="l04055"></a>04055    <span class="comment">/* BE AWARE WE HAVE NO cb_log() HERE! */</span>
<a name="l04056"></a>04056 
<a name="l04057"></a>04057    <span class="keywordtype">int</span> i = mISDN_open();
<a name="l04058"></a>04058    <span class="keywordtype">int</span> max=0;
<a name="l04059"></a>04059    
<a name="l04060"></a>04060    <span class="keywordflow">if</span> (i&lt;0)
<a name="l04061"></a>04061       <span class="keywordflow">return</span> -1;
<a name="l04062"></a>04062 
<a name="l04063"></a>04063    max = mISDN_get_stack_count(i);
<a name="l04064"></a>04064    
<a name="l04065"></a>04065    mISDN_close(i);
<a name="l04066"></a>04066    
<a name="l04067"></a>04067    <span class="keywordflow">return</span> max;
<a name="l04068"></a>04068 }
<a name="l04069"></a>04069 
<a name="l04070"></a>04070 
<a name="l04071"></a><a class="code" href="isdn__lib_8h.html#a0c45d15c14a1b1155e47f6625ffb8e80">04071</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a0c45d15c14a1b1155e47f6625ffb8e80">misdn_lib_nt_keepcalls</a>( <span class="keywordtype">int</span> kc)
<a name="l04072"></a>04072 {
<a name="l04073"></a>04073 <span class="preprocessor">#ifdef FEATURE_NET_KEEPCALLS</span>
<a name="l04074"></a>04074 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (kc) {
<a name="l04075"></a>04075       <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>();
<a name="l04076"></a>04076       <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l04077"></a>04077          stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.feature |= FEATURE_NET_KEEPCALLS;
<a name="l04078"></a>04078       }
<a name="l04079"></a>04079    }
<a name="l04080"></a>04080 <span class="preprocessor">#endif</span>
<a name="l04081"></a>04081 <span class="preprocessor"></span>}
<a name="l04082"></a>04082 
<a name="l04083"></a><a class="code" href="isdn__lib_8h.html#a1154a11f754192d2e62a4ed59f6ffa10">04083</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a1154a11f754192d2e62a4ed59f6ffa10">misdn_lib_nt_debug_init</a>( <span class="keywordtype">int</span> flags, <span class="keywordtype">char</span> *file ) 
<a name="l04084"></a>04084 {
<a name="l04085"></a>04085    <span class="keyword">static</span> <span class="keywordtype">int</span> init=0;
<a name="l04086"></a>04086    <span class="keywordtype">char</span> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l04087"></a>04087    
<a name="l04088"></a>04088    <span class="keywordflow">if</span> (!flags) 
<a name="l04089"></a>04089       f=NULL;
<a name="l04090"></a>04090    <span class="keywordflow">else</span>
<a name="l04091"></a>04091       f=file;
<a name="l04092"></a>04092 
<a name="l04093"></a>04093    <span class="keywordflow">if</span> (!init) {
<a name="l04094"></a>04094       debug_init( flags , f, f, f);
<a name="l04095"></a>04095       init=1;
<a name="l04096"></a>04096    } <span class="keywordflow">else</span> {
<a name="l04097"></a>04097       debug_close();
<a name="l04098"></a>04098       debug_init( flags , f, f, f);
<a name="l04099"></a>04099    }
<a name="l04100"></a>04100 }
<a name="l04101"></a>04101 
<a name="l04102"></a><a class="code" href="isdn__lib_8h.html#ae89d0b5cf902c0b4b8fb93a01f2f85d0">04102</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#ae89d0b5cf902c0b4b8fb93a01f2f85d0">misdn_lib_init</a>(<span class="keywordtype">char</span> *portlist, <span class="keyword">struct</span> <a class="code" href="structmisdn__lib__iface.html">misdn_lib_iface</a> *iface, <span class="keywordtype">void</span> *user_data)
<a name="l04103"></a>04103 {
<a name="l04104"></a>04104    <span class="keyword">struct </span><a class="code" href="structmisdn__lib.html">misdn_lib</a> *mgr=<a class="code" href="astmm_8h.html#a7cbb7b79af9d539af55b59dfc3598390">calloc</a>(1, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmisdn__lib.html">misdn_lib</a>));
<a name="l04105"></a>04105    <span class="keywordtype">char</span> *tok, *tokb;
<a name="l04106"></a>04106    <span class="keywordtype">char</span> plist[1024];
<a name="l04107"></a>04107    <span class="keywordtype">int</span> <a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>;
<a name="l04108"></a>04108    <span class="keywordtype">int</span> port_count=0;
<a name="l04109"></a>04109  
<a name="l04110"></a>04110    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> = iface-&gt;<a class="code" href="structmisdn__lib__iface.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>;
<a name="l04111"></a>04111    <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a> = iface-&gt;<a class="code" href="structmisdn__lib__iface.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>;
<a name="l04112"></a>04112    <a class="code" href="isdn__lib_8c.html#a72481e6f9189b5aa9d4b4ab441118e76">cb_jb_empty</a> = iface-&gt;<a class="code" href="structmisdn__lib__iface.html#a72481e6f9189b5aa9d4b4ab441118e76">cb_jb_empty</a>;
<a name="l04113"></a>04113    
<a name="l04114"></a>04114    glob_mgr = mgr;
<a name="l04115"></a>04115   
<a name="l04116"></a>04116    msg_init();
<a name="l04117"></a>04117 
<a name="l04118"></a>04118    <a class="code" href="isdn__lib_8c.html#a1154a11f754192d2e62a4ed59f6ffa10">misdn_lib_nt_debug_init</a>(0,NULL);
<a name="l04119"></a>04119    
<a name="l04120"></a>04120    <span class="keywordflow">if</span> (!portlist || (*portlist == 0) ) <span class="keywordflow">return</span> 1;
<a name="l04121"></a>04121    
<a name="l04122"></a>04122    <a class="code" href="isdn__lib_8c.html#a2ebb37e9bbb05f618c25d794480d7e8d">init_flip_bits</a>();
<a name="l04123"></a>04123    
<a name="l04124"></a>04124    {
<a name="l04125"></a>04125       strncpy(plist,portlist, 1024);
<a name="l04126"></a>04126       plist[1023] = 0;
<a name="l04127"></a>04127    }
<a name="l04128"></a>04128   
<a name="l04129"></a>04129    memcpy(tone_425_flip,tone_425,TONE_425_SIZE);
<a name="l04130"></a>04130    <a class="code" href="isdn__lib_8c.html#aec5e8bc764f0ae521c2e841d8609545d">flip_buf_bits</a>(tone_425_flip,TONE_425_SIZE);
<a name="l04131"></a>04131 
<a name="l04132"></a>04132    memcpy(tone_silence_flip,tone_SILENCE,TONE_SILENCE_SIZE);
<a name="l04133"></a>04133    <a class="code" href="isdn__lib_8c.html#aec5e8bc764f0ae521c2e841d8609545d">flip_buf_bits</a>(tone_silence_flip,TONE_SILENCE_SIZE);
<a name="l04134"></a>04134   
<a name="l04135"></a>04135    midev=<a class="code" href="isdn__lib_8c.html#a5350c9c1249234db77f41814cad90b6e">te_lib_init</a>();
<a name="l04136"></a>04136    mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>=midev;
<a name="l04137"></a>04137 
<a name="l04138"></a>04138    port_count=mISDN_get_stack_count(midev);
<a name="l04139"></a>04139   
<a name="l04140"></a>04140    msg_queue_init(&amp;mgr-&gt;<a class="code" href="structmisdn__lib.html#ad99ef86d7f5f4f6e4b4785fda4e1abcb">activatequeue</a>);
<a name="l04141"></a>04141   
<a name="l04142"></a>04142    <span class="keywordflow">if</span> (sem_init(&amp;mgr-&gt;<a class="code" href="structmisdn__lib.html#a3faba04201c788a3b42b3af24b83f61f">new_msg</a>, 1, 0)&lt;0)
<a name="l04143"></a>04143       sem_init(&amp;mgr-&gt;<a class="code" href="structmisdn__lib.html#a3faba04201c788a3b42b3af24b83f61f">new_msg</a>, 0, 0);
<a name="l04144"></a>04144  
<a name="l04145"></a>04145    <span class="keywordflow">for</span> (tok=strtok_r(plist,<span class="stringliteral">&quot; ,&quot;</span>,&amp;tokb );
<a name="l04146"></a>04146         tok; 
<a name="l04147"></a>04147         tok=strtok_r(NULL,<span class="stringliteral">&quot; ,&quot;</span>,&amp;tokb)) {
<a name="l04148"></a>04148       <span class="keywordtype">int</span> port = atoi(tok);
<a name="l04149"></a>04149       <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l04150"></a>04150       <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="devicestate_8c.html#abd2135e6f8a41bc900933b1985d97165">first</a>=1;
<a name="l04151"></a>04151       <span class="keywordtype">int</span> <a class="code" href="misdn__config_8c.html#a8811c37f1bf155dadba8ae3dfb0fdfee">ptp</a>=0;
<a name="l04152"></a>04152     
<a name="l04153"></a>04153       <span class="keywordflow">if</span> (strstr(tok, <span class="stringliteral">&quot;ptp&quot;</span>))
<a name="l04154"></a>04154          ptp=1;
<a name="l04155"></a>04155 
<a name="l04156"></a>04156       <span class="keywordflow">if</span> (port &gt; port_count) {
<a name="l04157"></a>04157          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;Couldn&apos;t Initialize this port since we have only %d ports\n&quot;</span>, port_count);
<a name="l04158"></a>04158          exit(1);
<a name="l04159"></a>04159       }
<a name="l04160"></a>04160       stack=<a class="code" href="isdn__lib_8c.html#a3f9047004fc7ad138acb1b4f43f64ac0">stack_init</a>(midev, port, ptp);
<a name="l04161"></a>04161     
<a name="l04162"></a>04162       <span class="keywordflow">if</span> (!stack) {
<a name="l04163"></a>04163          perror(<span class="stringliteral">&quot;stack_init&quot;</span>);
<a name="l04164"></a>04164          exit(1);
<a name="l04165"></a>04165       }
<a name="l04166"></a>04166     
<a name="l04167"></a>04167       {
<a name="l04168"></a>04168          <span class="keywordtype">int</span> i;
<a name="l04169"></a>04169          <span class="keywordflow">for</span>(i=0;i&lt;=stack-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; i++) {
<a name="l04170"></a>04170             <span class="keywordtype">int</span> r;
<a name="l04171"></a>04171             <span class="keywordflow">if</span> ((r=<a class="code" href="isdn__lib_8c.html#a87f40cb8ee97ceb51e0e6143cc47ebd4">init_bc</a>(stack, &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i], stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>,port,i, <span class="stringliteral">&quot;&quot;</span>, 1))&lt;0) {
<a name="l04172"></a>04172                <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, port, <span class="stringliteral">&quot;Got Err @ init_bc :%d\n&quot;</span>,r);
<a name="l04173"></a>04173                exit(1);
<a name="l04174"></a>04174             }
<a name="l04175"></a>04175          }
<a name="l04176"></a>04176       }
<a name="l04177"></a>04177 
<a name="l04178"></a>04178       <span class="keywordflow">if</span> (stack &amp;&amp; first) {
<a name="l04179"></a>04179          mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>=stack;
<a name="l04180"></a>04180          first=0;
<a name="l04181"></a>04181          <span class="keywordflow">continue</span>;
<a name="l04182"></a>04182       }
<a name="l04183"></a>04183     
<a name="l04184"></a>04184       <span class="keywordflow">if</span> (stack) {
<a name="l04185"></a>04185          <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> * help;
<a name="l04186"></a>04186          <span class="keywordflow">for</span> ( help=mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>; help; help=help-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a> ) 
<a name="l04187"></a>04187             <span class="keywordflow">if</span> (help-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a> == NULL) <span class="keywordflow">break</span>;
<a name="l04188"></a>04188          help-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>=stack;
<a name="l04189"></a>04189       }
<a name="l04190"></a>04190     
<a name="l04191"></a>04191    }
<a name="l04192"></a>04192   
<a name="l04193"></a>04193    <span class="keywordflow">if</span> (sem_init(&amp;handler_started, 1, 0)&lt;0)
<a name="l04194"></a>04194       sem_init(&amp;handler_started, 0, 0);
<a name="l04195"></a>04195   
<a name="l04196"></a>04196    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(8, 0, <span class="stringliteral">&quot;Starting Event Handler\n&quot;</span>);
<a name="l04197"></a>04197    <a class="code" href="lock_8h.html#a3c7d37cba2d420a45309a93b799d9db9">pthread_create</a>( &amp;mgr-&gt;<a class="code" href="structmisdn__lib.html#a040ae357d3e92605bf26146fc6db0df7">event_handler_thread</a>, NULL,(<span class="keywordtype">void</span>*)<a class="code" href="isdn__lib_8c.html#a9281c6f937aa747ba7e72e38573c4d9d">manager_event_handler</a>, mgr);
<a name="l04198"></a>04198   
<a name="l04199"></a>04199    sem_wait(&amp;handler_started) ;
<a name="l04200"></a>04200    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(8, 0, <span class="stringliteral">&quot;Starting Event Catcher\n&quot;</span>);
<a name="l04201"></a>04201    <a class="code" href="lock_8h.html#a3c7d37cba2d420a45309a93b799d9db9">pthread_create</a>( &amp;mgr-&gt;<a class="code" href="structmisdn__lib.html#a2094d25b23478520356dca649a8403e6">event_thread</a>, NULL, (<span class="keywordtype">void</span>*)<a class="code" href="isdn__lib_8c.html#aafca72f03d258872c306e1fb5d10b5bd">misdn_lib_isdn_event_catcher</a>, mgr);
<a name="l04202"></a>04202   
<a name="l04203"></a>04203    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(8, 0, <span class="stringliteral">&quot;Event Catcher started\n&quot;</span>);
<a name="l04204"></a>04204 
<a name="l04205"></a>04205    global_state= <a class="code" href="isdn__lib_8c.html#af1db0e676da5eccb2fa1d40ae01412a8a2e1eacba6b620d51dce53d3bd8cffd4e">MISDN_INITIALIZED</a>; 
<a name="l04206"></a>04206   
<a name="l04207"></a>04207    <span class="keywordflow">return</span> (mgr == NULL);
<a name="l04208"></a>04208 }
<a name="l04209"></a>04209 
<a name="l04210"></a><a class="code" href="isdn__lib_8h.html#a3806e75078a3cf3025dd5a9963bc99e1">04210</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a3806e75078a3cf3025dd5a9963bc99e1">misdn_lib_destroy</a>(<span class="keywordtype">void</span>)
<a name="l04211"></a>04211 {
<a name="l04212"></a>04212    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *help;
<a name="l04213"></a>04213    <span class="keywordtype">int</span> i;
<a name="l04214"></a>04214   
<a name="l04215"></a>04215    <span class="keywordflow">for</span> ( help=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>; help; help=help-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a> ) {
<a name="l04216"></a>04216       <span class="keywordflow">for</span>(i=0;i&lt;=help-&gt;<a class="code" href="structmisdn__stack.html#a5c1ef3ac6d3f68f8d6c29daf02f7777b">b_num</a>; i++) {
<a name="l04217"></a>04217          <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[1024];
<a name="l04218"></a>04218          mISDN_write_frame(help-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, buf, help-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l04219"></a>04219          help-&gt;<a class="code" href="structmisdn__stack.html#aba007739b9565d1ea988fdd5bf5efd80" title="B Channel record pool array.">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> = 0;
<a name="l04220"></a>04220       }
<a name="l04221"></a>04221       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a> (1, help-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Destroying this port.\n&quot;</span>);
<a name="l04222"></a>04222       <a class="code" href="isdn__lib_8c.html#a87902d7e550c8bd1b03317345e44b9c5">stack_destroy</a>(help);
<a name="l04223"></a>04223    }
<a name="l04224"></a>04224    
<a name="l04225"></a>04225    <span class="keywordflow">if</span> (global_state == <a class="code" href="isdn__lib_8c.html#af1db0e676da5eccb2fa1d40ae01412a8a2e1eacba6b620d51dce53d3bd8cffd4e">MISDN_INITIALIZED</a>) {
<a name="l04226"></a>04226       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, 0, <span class="stringliteral">&quot;Killing Handler Thread\n&quot;</span>);
<a name="l04227"></a>04227       <span class="keywordflow">if</span> ( pthread_cancel(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a040ae357d3e92605bf26146fc6db0df7">event_handler_thread</a>) == 0 ) {
<a name="l04228"></a>04228          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, 0, <span class="stringliteral">&quot;Joining Handler Thread\n&quot;</span>);
<a name="l04229"></a>04229          pthread_join(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a040ae357d3e92605bf26146fc6db0df7">event_handler_thread</a>, NULL);
<a name="l04230"></a>04230       }
<a name="l04231"></a>04231      
<a name="l04232"></a>04232       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, 0, <span class="stringliteral">&quot;Killing Main Thread\n&quot;</span>);
<a name="l04233"></a>04233       <span class="keywordflow">if</span> ( pthread_cancel(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a2094d25b23478520356dca649a8403e6">event_thread</a>) == 0 ) {
<a name="l04234"></a>04234          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, 0, <span class="stringliteral">&quot;Joining Main Thread\n&quot;</span>);
<a name="l04235"></a>04235          pthread_join(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a2094d25b23478520356dca649a8403e6">event_thread</a>, NULL);
<a name="l04236"></a>04236       }
<a name="l04237"></a>04237    }
<a name="l04238"></a>04238   
<a name="l04239"></a>04239    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1, 0, <span class="stringliteral">&quot;Closing mISDN device\n&quot;</span>);
<a name="l04240"></a>04240    <a class="code" href="isdn__lib_8c.html#ad8cee834c1e43d68d987135d3456e091">te_lib_destroy</a>(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>);
<a name="l04241"></a>04241 }
<a name="l04242"></a>04242 
<a name="l04243"></a><a class="code" href="isdn__lib_8h.html#a358cabb91a3da0abe7eac0910f916369">04243</a> <span class="keywordtype">char</span> *<a class="code" href="isdn__lib_8c.html#a358cabb91a3da0abe7eac0910f916369">manager_isdn_get_info</a>(<span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0">event_e</a> event)
<a name="l04244"></a>04244 {
<a name="l04245"></a>04245    <span class="keywordflow">return</span> <a class="code" href="isdn__lib__intern_8h.html#a622bd30db092a77314ee5e5581a80f75">isdn_get_info</a>(<a class="code" href="isdn__lib_8c.html#a26cba6350d4fa5c3ab48adead4168bd7">msgs_g</a> , event, 0);
<a name="l04246"></a>04246 }
<a name="l04247"></a>04247 
<a name="l04248"></a><a class="code" href="isdn__lib_8h.html#a49017a4e2c6e4515c217c40bf822abb6">04248</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a49017a4e2c6e4515c217c40bf822abb6">manager_bchannel_activate</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04249"></a>04249 {
<a name="l04250"></a>04250    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[128];
<a name="l04251"></a>04251 
<a name="l04252"></a>04252    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l04253"></a>04253 
<a name="l04254"></a>04254    <span class="keywordflow">if</span> (!stack) {
<a name="l04255"></a>04255       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;bchannel_activate: Stack not found !&quot;</span>);
<a name="l04256"></a>04256       return ;
<a name="l04257"></a>04257    }
<a name="l04258"></a>04258    
<a name="l04259"></a>04259    <span class="comment">/* we must activate if we are deactivated */</span>
<a name="l04260"></a>04260    clear_ibuffer(bc-&gt;<a class="code" href="structmisdn__bchannel.html#a341f18ec4157d0b4b3b9cf2367122c88" title="Not used. Contents are setup but not used.">astbuf</a>);
<a name="l04261"></a>04261    
<a name="l04262"></a>04262    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;$$$ Bchan Activated addr %x\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>);
<a name="l04263"></a>04263    
<a name="l04264"></a>04264    mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, buf, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> | FLG_MSG_DOWN,  DL_ESTABLISH | REQUEST, 0,0, NULL, TIMEOUT_1SEC);
<a name="l04265"></a>04265 
<a name="l04266"></a>04266    return ;
<a name="l04267"></a>04267 }
<a name="l04268"></a>04268 
<a name="l04269"></a>04269 
<a name="l04270"></a><a class="code" href="isdn__lib_8h.html#adc7ac4a2a52152266d36adff41f5a587">04270</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#adc7ac4a2a52152266d36adff41f5a587">manager_bchannel_deactivate</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> * bc)
<a name="l04271"></a>04271 {
<a name="l04272"></a>04272    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l04273"></a>04273    iframe_t dact;
<a name="l04274"></a>04274    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[128]; 
<a name="l04275"></a>04275 
<a name="l04276"></a>04276    <span class="keywordflow">switch</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a>) {
<a name="l04277"></a>04277       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a1b7d7fde2aa8ceca170c3d0f8283fbc0">BCHAN_ACTIVATED</a>:
<a name="l04278"></a>04278          <span class="keywordflow">break</span>;
<a name="l04279"></a>04279       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a660c00210e9cd580ec7f1b0250c3ce6e">BCHAN_BRIDGED</a>:
<a name="l04280"></a>04280          <a class="code" href="isdn__lib_8c.html#a4f8e334830dd8d96704965b9ef8de451">misdn_split_conf</a>(bc,bc-&gt;<a class="code" href="structmisdn__bchannel.html#aab0f7344f706b822f3aeab3e328793d0" title="Bridging conference ID.">conf_id</a>);
<a name="l04281"></a>04281          <span class="keywordflow">break</span>;
<a name="l04282"></a>04282       <span class="keywordflow">default</span>:
<a name="l04283"></a>04283          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>( 4, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;bchan_deactivate: called but not activated\n&quot;</span>);
<a name="l04284"></a>04284          return ;
<a name="l04285"></a>04285 
<a name="l04286"></a>04286    }
<a name="l04287"></a>04287    
<a name="l04288"></a>04288    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;$$$ Bchan deActivated addr %x\n&quot;</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>);
<a name="l04289"></a>04289    
<a name="l04290"></a>04290    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a18f91a48afb97a188ef92e61c593862e" title="TRUE if tone generator allowed to start.">generate_tone</a>=0;
<a name="l04291"></a>04291    
<a name="l04292"></a>04292    dact.prim = DL_RELEASE | REQUEST;
<a name="l04293"></a>04293    dact.addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> | FLG_MSG_DOWN;
<a name="l04294"></a>04294    dact.dinfo = 0;
<a name="l04295"></a>04295    dact.len = 0;
<a name="l04296"></a>04296    mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, buf, bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> | FLG_MSG_DOWN, DL_RELEASE|REQUEST,0,0,NULL, TIMEOUT_1SEC);
<a name="l04297"></a>04297 
<a name="l04298"></a>04298    clear_ibuffer(bc-&gt;<a class="code" href="structmisdn__bchannel.html#a341f18ec4157d0b4b3b9cf2367122c88" title="Not used. Contents are setup but not used.">astbuf</a>);
<a name="l04299"></a>04299    
<a name="l04300"></a>04300    <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a94339a5e4ef7f395f9780bebf5de2fe3">BCHAN_RELEASE</a>);
<a name="l04301"></a>04301   
<a name="l04302"></a>04302    <span class="keywordflow">return</span>;
<a name="l04303"></a>04303 }
<a name="l04304"></a>04304 
<a name="l04305"></a>04305 
<a name="l04306"></a><a class="code" href="isdn__lib_8h.html#a017d9391bbd17db8104fcb1c7761918a">04306</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a017d9391bbd17db8104fcb1c7761918a">misdn_lib_tx2misdn_frm</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l04307"></a>04307 {
<a name="l04308"></a>04308    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l04309"></a>04309    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[4096 + mISDN_HEADER_LEN];
<a name="l04310"></a>04310    iframe_t *frm = (iframe_t*)buf;
<a name="l04311"></a>04311    <span class="keywordtype">int</span> r;
<a name="l04312"></a>04312 
<a name="l04313"></a>04313    <span class="keywordflow">switch</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a>) {
<a name="l04314"></a>04314       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a1b7d7fde2aa8ceca170c3d0f8283fbc0">BCHAN_ACTIVATED</a>:
<a name="l04315"></a>04315       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a660c00210e9cd580ec7f1b0250c3ce6e">BCHAN_BRIDGED</a>:
<a name="l04316"></a>04316          <span class="keywordflow">break</span>;
<a name="l04317"></a>04317       <span class="keywordflow">default</span>:
<a name="l04318"></a>04318          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;BC not yet activated (state:%s)\n&quot;</span>,<a class="code" href="isdn__lib_8c.html#ae2f4cc55968e9014a4daa06d1be05bef">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf4c3863e7ccb99c1b55a3fc74ef8d3e" title="Current B Channel state.">bc_state</a>));
<a name="l04319"></a>04319          <span class="keywordflow">return</span> -1;
<a name="l04320"></a>04320    }
<a name="l04321"></a>04321    
<a name="l04322"></a>04322    frm-&gt;prim = DL_DATA|REQUEST;
<a name="l04323"></a>04323    frm-&gt;dinfo = 0;
<a name="l04324"></a>04324    frm-&gt;addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> | FLG_MSG_DOWN ;
<a name="l04325"></a>04325    
<a name="l04326"></a>04326    frm-&gt;len = len;
<a name="l04327"></a>04327    memcpy(&amp;buf[mISDN_HEADER_LEN], data,len);
<a name="l04328"></a>04328       
<a name="l04329"></a>04329    <span class="keywordflow">if</span> ( <a class="code" href="isdn__lib_8c.html#acaefa07620d12d0dc4f979c9e3c3f73e">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#afa05b14ff7f76f303c784c00c4c63fa7" title="SETUP message bearer capability field code value.">capability</a>) ) 
<a name="l04330"></a>04330       <a class="code" href="isdn__lib_8c.html#aec5e8bc764f0ae521c2e841d8609545d">flip_buf_bits</a>( &amp;buf[mISDN_HEADER_LEN], len);
<a name="l04331"></a>04331    <span class="keywordflow">else</span>
<a name="l04332"></a>04332       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(6, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Writing %d data bytes\n&quot;</span>,len);
<a name="l04333"></a>04333    
<a name="l04334"></a>04334    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(9, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Writing %d bytes 2 mISDN\n&quot;</span>,len);
<a name="l04335"></a>04335    r=mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, buf, frm-&gt;len + mISDN_HEADER_LEN, TIMEOUT_INFINIT);
<a name="l04336"></a>04336    <span class="keywordflow">return</span> 0;
<a name="l04337"></a>04337 }
<a name="l04338"></a>04338 
<a name="l04339"></a>04339 
<a name="l04340"></a>04340 
<a name="l04341"></a>04341 <span class="comment">/*</span>
<a name="l04342"></a>04342 <span class="comment"> * send control information to the channel (dsp-module)</span>
<a name="l04343"></a>04343 <span class="comment"> */</span>
<a name="l04344"></a><a class="code" href="isdn__lib_8h.html#a7505c098dd0c991d2f8b28ac8d2e714f">04344</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> c1, <span class="keywordtype">int</span> c2)
<a name="l04345"></a>04345 {
<a name="l04346"></a>04346    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buffer[mISDN_HEADER_LEN+2*<span class="keyword">sizeof</span>(int)];
<a name="l04347"></a>04347    iframe_t *ctrl = (iframe_t *)buffer; <span class="comment">/* preload data */</span>
<a name="l04348"></a>04348    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *d = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)&amp;ctrl-&gt;data.p;
<a name="l04349"></a>04349    <span class="comment">/*struct misdn_stack *stack=get_stack_by_bc(bc);*/</span>
<a name="l04350"></a>04350    
<a name="l04351"></a>04351    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,<span class="stringliteral">&quot;ph_control: c1:%x c2:%x\n&quot;</span>,c1,c2);
<a name="l04352"></a>04352    
<a name="l04353"></a>04353    ctrl-&gt;prim = PH_CONTROL | REQUEST;
<a name="l04354"></a>04354    ctrl-&gt;addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> | FLG_MSG_DOWN;
<a name="l04355"></a>04355    ctrl-&gt;dinfo = 0;
<a name="l04356"></a>04356    ctrl-&gt;len = <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int)*2;
<a name="l04357"></a>04357    *d++ = c1;
<a name="l04358"></a>04358    *d++ = c2;
<a name="l04359"></a>04359    mISDN_write(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, ctrl, mISDN_HEADER_LEN+ctrl-&gt;len, TIMEOUT_1SEC);
<a name="l04360"></a>04360 }
<a name="l04361"></a>04361 
<a name="l04362"></a>04362 <span class="comment">/*</span>
<a name="l04363"></a>04363 <span class="comment"> * allow live control of channel parameters</span>
<a name="l04364"></a>04364 <span class="comment"> */</span>
<a name="l04365"></a><a class="code" href="isdn__lib_8h.html#a24f360030ed342dce44792ae7541629b">04365</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a24f360030ed342dce44792ae7541629b">isdn_lib_update_rxgain</a> (<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04366"></a>04366 {
<a name="l04367"></a>04367    <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, VOL_CHANGE_RX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a80d0395aae5582433d6b02af3f8c270a" title="Rx gain setting (range -8 to 8).">rxgain</a>);
<a name="l04368"></a>04368 }
<a name="l04369"></a>04369 
<a name="l04370"></a><a class="code" href="isdn__lib_8h.html#a0e7e33031fca33e7d0bb916c424a8e12">04370</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a0e7e33031fca33e7d0bb916c424a8e12">isdn_lib_update_txgain</a> (<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04371"></a>04371 {
<a name="l04372"></a>04372    <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, VOL_CHANGE_TX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#a709429a6031e18717677d5254d38586f" title="Tx gain setting (range -8 to 8).">txgain</a>);
<a name="l04373"></a>04373 }
<a name="l04374"></a>04374 
<a name="l04375"></a><a class="code" href="isdn__lib_8h.html#a44f15a2eb1d3bf690ba43f330382db84">04375</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a44f15a2eb1d3bf690ba43f330382db84">isdn_lib_update_ec</a> (<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04376"></a>04376 {
<a name="l04377"></a>04377 <span class="preprocessor">#ifdef MISDN_1_2</span>
<a name="l04378"></a>04378 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (*bc-&gt;pipeline)
<a name="l04379"></a>04379 <span class="preprocessor">#else</span>
<a name="l04380"></a>04380 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#aeafef525b8bac4713c119b593780ca69" title="TRUE if the echo cancellor is enabled.">ec_enable</a>)
<a name="l04381"></a>04381 <span class="preprocessor">#endif</span>
<a name="l04382"></a>04382 <span class="preprocessor"></span>      <a class="code" href="isdn__lib_8c.html#a7e7944bc36ef8fe8e943ac12c2fea749">manager_ec_enable</a>(bc);
<a name="l04383"></a>04383    <span class="keywordflow">else</span>
<a name="l04384"></a>04384       <a class="code" href="isdn__lib_8c.html#a1801c58b6e467b4ef0d75aff37aa77f2">manager_ec_disable</a>(bc);
<a name="l04385"></a>04385 }
<a name="l04386"></a>04386 
<a name="l04387"></a><a class="code" href="isdn__lib_8h.html#add4f07db0191adc97a1a06cabd84a1b1">04387</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#add4f07db0191adc97a1a06cabd84a1b1">isdn_lib_stop_dtmf</a> (<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04388"></a>04388 {
<a name="l04389"></a>04389    <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, DTMF_TONE_STOP, 0);
<a name="l04390"></a>04390 }
<a name="l04391"></a>04391 
<a name="l04392"></a>04392 <span class="comment">/*</span>
<a name="l04393"></a>04393 <span class="comment"> * send control information to the channel (dsp-module)</span>
<a name="l04394"></a>04394 <span class="comment"> */</span>
<a name="l04395"></a><a class="code" href="isdn__lib_8c.html#a68056961358d38e2cef26ccf6c136a99">04395</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a68056961358d38e2cef26ccf6c136a99">manager_ph_control_block</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> c1, <span class="keywordtype">void</span> *c2, <span class="keywordtype">int</span> c2_len)
<a name="l04396"></a>04396 {
<a name="l04397"></a>04397    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buffer[mISDN_HEADER_LEN+<span class="keyword">sizeof</span>(int)+c2_len];
<a name="l04398"></a>04398    iframe_t *ctrl = (iframe_t *)buffer;
<a name="l04399"></a>04399    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *d = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)&amp;ctrl-&gt;data.p;
<a name="l04400"></a>04400    <span class="comment">/*struct misdn_stack *stack=get_stack_by_bc(bc);*/</span>
<a name="l04401"></a>04401    
<a name="l04402"></a>04402    ctrl-&gt;prim = PH_CONTROL | REQUEST;
<a name="l04403"></a>04403    ctrl-&gt;addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a> | FLG_MSG_DOWN;
<a name="l04404"></a>04404    ctrl-&gt;dinfo = 0;
<a name="l04405"></a>04405    ctrl-&gt;len = <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) + c2_len;
<a name="l04406"></a>04406    *d++ = c1;
<a name="l04407"></a>04407    memcpy(d, c2, c2_len);
<a name="l04408"></a>04408    mISDN_write(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, ctrl, mISDN_HEADER_LEN+ctrl-&gt;len, TIMEOUT_1SEC);
<a name="l04409"></a>04409 }
<a name="l04410"></a>04410 
<a name="l04411"></a>04411 
<a name="l04412"></a>04412 
<a name="l04413"></a>04413 
<a name="l04414"></a><a class="code" href="isdn__lib_8c.html#ad4a199ce1a64870d8f5ca24d048ada66">04414</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#ad4a199ce1a64870d8f5ca24d048ada66">manager_clean_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc )
<a name="l04415"></a>04415 {
<a name="l04416"></a>04416    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l04417"></a>04417    
<a name="l04418"></a>04418    <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>&gt;0)
<a name="l04419"></a>04419       <a class="code" href="isdn__lib_8c.html#a9f849e8a799ef7d6a52f6a10ec4446e5">empty_chan_in_stack</a>(stack, bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf7dff2c57c0da9a4a2b70e3e815be31" title="Assigned B channel number B1, B2... 0 if not assigned.">channel</a>);
<a name="l04420"></a>04420    <a class="code" href="isdn__lib_8c.html#aeaf5002243eeeea2bf2e562d2ba27e5c">empty_bc</a>(bc);
<a name="l04421"></a>04421    bc-&gt;<a class="code" href="structmisdn__bchannel.html#acd374dc544502235efa3c6533c75820f" title="TRUE if B channel record is in use.">in_use</a>=0;
<a name="l04422"></a>04422 
<a name="l04423"></a>04423    <a class="code" href="isdn__lib_8c.html#a1cda60ac3b071ee6309c8239c50fae5b">cb_event</a>(<a class="code" href="isdn__lib_8h.html#ab84d33304ff89cf68d47913663acbad0ac49b8317168e8506edc0de2450658541">EVENT_CLEANUP</a>, bc, NULL); 
<a name="l04424"></a>04424 }
<a name="l04425"></a>04425 
<a name="l04426"></a>04426 
<a name="l04427"></a><a class="code" href="isdn__lib_8c.html#aed5d2f567f0cd604dcb408ac5be5f983">04427</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#aed5d2f567f0cd604dcb408ac5be5f983">stack_holder_add</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *holder)
<a name="l04428"></a>04428 {
<a name="l04429"></a>04429    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *help;
<a name="l04430"></a>04430    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;*HOLDER: add %x\n&quot;</span>,holder-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>);
<a name="l04431"></a>04431    
<a name="l04432"></a>04432    holder-&gt;<a class="code" href="structmisdn__bchannel.html#a94bf2beb01269f6feb818b5c2231537c" title="TRUE if this channel is on the misdn_stack-&amp;gt;holding list.">stack_holder</a>=1;
<a name="l04433"></a>04433    holder-&gt;<a class="code" href="structmisdn__bchannel.html#a5ccd442713df94320740beb085068e7a" title="Next node in the misdn_stack.holding list.">next</a>=NULL;
<a name="l04434"></a>04434    
<a name="l04435"></a>04435    <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#a406ae8ad1276496c0fa46acf9814e366" title="List of held channels.">holding</a>) {
<a name="l04436"></a>04436       stack-&gt;<a class="code" href="structmisdn__stack.html#a406ae8ad1276496c0fa46acf9814e366" title="List of held channels.">holding</a> = holder;
<a name="l04437"></a>04437       <span class="keywordflow">return</span>;
<a name="l04438"></a>04438    }
<a name="l04439"></a>04439   
<a name="l04440"></a>04440    <span class="keywordflow">for</span> (help=stack-&gt;<a class="code" href="structmisdn__stack.html#a406ae8ad1276496c0fa46acf9814e366" title="List of held channels.">holding</a>;
<a name="l04441"></a>04441         help;
<a name="l04442"></a>04442         help=help-&gt;<a class="code" href="structmisdn__bchannel.html#a5ccd442713df94320740beb085068e7a" title="Next node in the misdn_stack.holding list.">next</a>) {
<a name="l04443"></a>04443       <span class="keywordflow">if</span> (!help-&gt;<a class="code" href="structmisdn__bchannel.html#a5ccd442713df94320740beb085068e7a" title="Next node in the misdn_stack.holding list.">next</a>) {
<a name="l04444"></a>04444          help-&gt;<a class="code" href="structmisdn__bchannel.html#a5ccd442713df94320740beb085068e7a" title="Next node in the misdn_stack.holding list.">next</a>=holder;
<a name="l04445"></a>04445          <span class="keywordflow">break</span>;
<a name="l04446"></a>04446       }
<a name="l04447"></a>04447    }
<a name="l04448"></a>04448   
<a name="l04449"></a>04449 }
<a name="l04450"></a>04450 
<a name="l04451"></a><a class="code" href="isdn__lib_8c.html#a658efc12f0e9b235f2266fff4743dfab">04451</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a658efc12f0e9b235f2266fff4743dfab">stack_holder_remove</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *holder)
<a name="l04452"></a>04452 {
<a name="l04453"></a>04453    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *h1;
<a name="l04454"></a>04454 
<a name="l04455"></a>04455    <span class="keywordflow">if</span> (!holder-&gt;<a class="code" href="structmisdn__bchannel.html#a94bf2beb01269f6feb818b5c2231537c" title="TRUE if this channel is on the misdn_stack-&amp;gt;holding list.">stack_holder</a>) <span class="keywordflow">return</span>;
<a name="l04456"></a>04456    
<a name="l04457"></a>04457    holder-&gt;<a class="code" href="structmisdn__bchannel.html#a94bf2beb01269f6feb818b5c2231537c" title="TRUE if this channel is on the misdn_stack-&amp;gt;holding list.">stack_holder</a>=0;
<a name="l04458"></a>04458    
<a name="l04459"></a>04459    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;*HOLDER: remove %x\n&quot;</span>,holder-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>);
<a name="l04460"></a>04460    <span class="keywordflow">if</span> (!stack || ! stack-&gt;<a class="code" href="structmisdn__stack.html#a406ae8ad1276496c0fa46acf9814e366" title="List of held channels.">holding</a>) <span class="keywordflow">return</span>;
<a name="l04461"></a>04461   
<a name="l04462"></a>04462    <span class="keywordflow">if</span> (holder == stack-&gt;<a class="code" href="structmisdn__stack.html#a406ae8ad1276496c0fa46acf9814e366" title="List of held channels.">holding</a>) {
<a name="l04463"></a>04463       stack-&gt;<a class="code" href="structmisdn__stack.html#a406ae8ad1276496c0fa46acf9814e366" title="List of held channels.">holding</a> = stack-&gt;<a class="code" href="structmisdn__stack.html#a406ae8ad1276496c0fa46acf9814e366" title="List of held channels.">holding</a>-&gt;<a class="code" href="structmisdn__bchannel.html#a5ccd442713df94320740beb085068e7a" title="Next node in the misdn_stack.holding list.">next</a>;
<a name="l04464"></a>04464       <span class="keywordflow">return</span>;
<a name="l04465"></a>04465    }
<a name="l04466"></a>04466    
<a name="l04467"></a>04467    <span class="keywordflow">for</span> (h1=stack-&gt;<a class="code" href="structmisdn__stack.html#a406ae8ad1276496c0fa46acf9814e366" title="List of held channels.">holding</a>;
<a name="l04468"></a>04468         h1;
<a name="l04469"></a>04469         h1=h1-&gt;<a class="code" href="structmisdn__bchannel.html#a5ccd442713df94320740beb085068e7a" title="Next node in the misdn_stack.holding list.">next</a>) {
<a name="l04470"></a>04470       <span class="keywordflow">if</span> (h1-&gt;<a class="code" href="structmisdn__bchannel.html#a5ccd442713df94320740beb085068e7a" title="Next node in the misdn_stack.holding list.">next</a> == holder) {
<a name="l04471"></a>04471          h1-&gt;<a class="code" href="structmisdn__bchannel.html#a5ccd442713df94320740beb085068e7a" title="Next node in the misdn_stack.holding list.">next</a>=h1-&gt;<a class="code" href="structmisdn__bchannel.html#a5ccd442713df94320740beb085068e7a" title="Next node in the misdn_stack.holding list.">next</a>-&gt;<a class="code" href="structmisdn__bchannel.html#a5ccd442713df94320740beb085068e7a" title="Next node in the misdn_stack.holding list.">next</a>;
<a name="l04472"></a>04472          return ;
<a name="l04473"></a>04473       }
<a name="l04474"></a>04474    }
<a name="l04475"></a>04475 }
<a name="l04476"></a>04476 
<a name="l04477"></a><a class="code" href="isdn__lib_8c.html#a6ae22b9108f567d7bae369dc17c65062">04477</a> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#a6ae22b9108f567d7bae369dc17c65062">stack_holder_find</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l3id)
<a name="l04478"></a>04478 {
<a name="l04479"></a>04479    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *help;
<a name="l04480"></a>04480 
<a name="l04481"></a>04481    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,stack?stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>:0, <span class="stringliteral">&quot;*HOLDER: find %lx\n&quot;</span>,l3id);
<a name="l04482"></a>04482    
<a name="l04483"></a>04483    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span> NULL;
<a name="l04484"></a>04484    
<a name="l04485"></a>04485    <span class="keywordflow">for</span> (help=stack-&gt;<a class="code" href="structmisdn__stack.html#a406ae8ad1276496c0fa46acf9814e366" title="List of held channels.">holding</a>;
<a name="l04486"></a>04486         help;
<a name="l04487"></a>04487         help=help-&gt;<a class="code" href="structmisdn__bchannel.html#a5ccd442713df94320740beb085068e7a" title="Next node in the misdn_stack.holding list.">next</a>) {
<a name="l04488"></a>04488       <span class="keywordflow">if</span> (help-&gt;<a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a> == l3id) {
<a name="l04489"></a>04489          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;*HOLDER: found bc\n&quot;</span>);
<a name="l04490"></a>04490          <span class="keywordflow">return</span> help;
<a name="l04491"></a>04491       }
<a name="l04492"></a>04492    }
<a name="l04493"></a>04493 
<a name="l04494"></a>04494    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;*HOLDER: find nothing\n&quot;</span>);
<a name="l04495"></a>04495    <span class="keywordflow">return</span> NULL;
<a name="l04496"></a>04496 }
<a name="l04497"></a>04497 <span class="comment"></span>
<a name="l04498"></a>04498 <span class="comment">/*!</span>
<a name="l04499"></a>04499 <span class="comment"> * \brief Find a held call&apos;s B channel record.</span>
<a name="l04500"></a>04500 <span class="comment"> *</span>
<a name="l04501"></a>04501 <span class="comment"> * \param port Port the call is on.</span>
<a name="l04502"></a>04502 <span class="comment"> * \param l3_id mISDN Layer 3 ID of held call.</span>
<a name="l04503"></a>04503 <span class="comment"> *</span>
<a name="l04504"></a>04504 <span class="comment"> * \return Found bc-record or NULL.</span>
<a name="l04505"></a>04505 <span class="comment"> */</span>
<a name="l04506"></a><a class="code" href="isdn__lib_8h.html#a1788dff1c632e46dd33697f6e3975e06">04506</a> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#a1788dff1c632e46dd33697f6e3975e06" title="Find a held call&amp;#39;s B channel record.">misdn_lib_find_held_bc</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#a2a616bc0b9f450c55ea28ea3a5c9e8e4" title="Layer 3 process ID.">l3_id</a>)
<a name="l04507"></a>04507 {
<a name="l04508"></a>04508    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc;
<a name="l04509"></a>04509    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack;
<a name="l04510"></a>04510 
<a name="l04511"></a>04511    bc = NULL;
<a name="l04512"></a>04512    <span class="keywordflow">for</span> (stack = <a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>(); stack; stack = stack-&gt;<a class="code" href="structmisdn__stack.html#a57eb386a189890dc2136b66b1d1fbdae" title="Next stack in the list of stacks.">next</a>) {
<a name="l04513"></a>04513       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a> == port) {
<a name="l04514"></a>04514          bc = <a class="code" href="isdn__lib_8c.html#a6ae22b9108f567d7bae369dc17c65062">stack_holder_find</a>(stack, l3_id);
<a name="l04515"></a>04515          <span class="keywordflow">break</span>;
<a name="l04516"></a>04516       }
<a name="l04517"></a>04517    }
<a name="l04518"></a>04518 
<a name="l04519"></a>04519    <span class="keywordflow">return</span> bc;
<a name="l04520"></a>04520 }
<a name="l04521"></a>04521 
<a name="l04522"></a><a class="code" href="isdn__lib_8h.html#a0ae7cb3ebbb16132ba484d6c4566d006">04522</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a0ae7cb3ebbb16132ba484d6c4566d006">misdn_lib_send_tone</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#a3252ee16ff4db6f40f149d91392d422a">tone_e</a> tone) 
<a name="l04523"></a>04523 {
<a name="l04524"></a>04524    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[mISDN_HEADER_LEN + 128] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l04525"></a>04525    iframe_t *frm = (iframe_t*)buf;
<a name="l04526"></a>04526 
<a name="l04527"></a>04527    <span class="keywordflow">switch</span>(tone) {
<a name="l04528"></a>04528    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a3252ee16ff4db6f40f149d91392d422aadd52466cad74a681d88a8426903d39e9">TONE_DIAL</a>:
<a name="l04529"></a>04529       <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, TONE_PATT_ON, TONE_GERMAN_DIALTONE); 
<a name="l04530"></a>04530    <span class="keywordflow">break</span>;
<a name="l04531"></a>04531    
<a name="l04532"></a>04532    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a3252ee16ff4db6f40f149d91392d422aa015bcb7b86b0a8063a048be4bf888350">TONE_ALERTING</a>:
<a name="l04533"></a>04533       <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, TONE_PATT_ON, TONE_GERMAN_RINGING);  
<a name="l04534"></a>04534    <span class="keywordflow">break</span>;
<a name="l04535"></a>04535    
<a name="l04536"></a>04536    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a3252ee16ff4db6f40f149d91392d422aaf83c9b163aec1068e1e500796951037c">TONE_HANGUP</a>:
<a name="l04537"></a>04537       <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, TONE_PATT_ON, TONE_GERMAN_HANGUP);   
<a name="l04538"></a>04538    <span class="keywordflow">break</span>;
<a name="l04539"></a>04539 
<a name="l04540"></a>04540    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a3252ee16ff4db6f40f149d91392d422aad40b60e844f3a712938f3c6408079753">TONE_NONE</a>:
<a name="l04541"></a>04541    <span class="keywordflow">default</span>:
<a name="l04542"></a>04542       <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, TONE_PATT_OFF, TONE_GERMAN_HANGUP);  
<a name="l04543"></a>04543    }
<a name="l04544"></a>04544 
<a name="l04545"></a>04545    frm-&gt;prim=DL_DATA|REQUEST;
<a name="l04546"></a>04546    frm-&gt;addr=bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>|FLG_MSG_DOWN;
<a name="l04547"></a>04547    frm-&gt;dinfo=0;
<a name="l04548"></a>04548    frm-&gt;len=128;
<a name="l04549"></a>04549    
<a name="l04550"></a>04550    mISDN_write(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>, frm, mISDN_HEADER_LEN+frm-&gt;len, TIMEOUT_1SEC);
<a name="l04551"></a>04551 }
<a name="l04552"></a>04552 
<a name="l04553"></a>04553 
<a name="l04554"></a><a class="code" href="isdn__lib_8h.html#a7e7944bc36ef8fe8e943ac12c2fea749">04554</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a7e7944bc36ef8fe8e943ac12c2fea749">manager_ec_enable</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04555"></a>04555 {
<a name="l04556"></a>04556    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l04557"></a>04557    
<a name="l04558"></a>04558    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>:0,<span class="stringliteral">&quot;ec_enable\n&quot;</span>);
<a name="l04559"></a>04559 
<a name="l04560"></a>04560    <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#acaefa07620d12d0dc4f979c9e3c3f73e">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#afa05b14ff7f76f303c784c00c4c63fa7" title="SETUP message bearer capability field code value.">capability</a>)) {
<a name="l04561"></a>04561       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>:0, <span class="stringliteral">&quot; --&gt; no speech? cannot enable EC\n&quot;</span>);
<a name="l04562"></a>04562    } <span class="keywordflow">else</span> {
<a name="l04563"></a>04563 
<a name="l04564"></a>04564 <span class="preprocessor">#ifdef MISDN_1_2</span>
<a name="l04565"></a>04565 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (*bc-&gt;pipeline) {
<a name="l04566"></a>04566       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>:0,<span class="stringliteral">&quot;Sending Control PIPELINE_CFG %s\n&quot;</span>,bc-&gt;pipeline);
<a name="l04567"></a>04567       <a class="code" href="isdn__lib_8c.html#a68056961358d38e2cef26ccf6c136a99">manager_ph_control_block</a>(bc, PIPELINE_CFG, bc-&gt;pipeline, strlen(bc-&gt;pipeline) + 1);
<a name="l04568"></a>04568    }
<a name="l04569"></a>04569 <span class="preprocessor">#else</span>
<a name="l04570"></a>04570 <span class="preprocessor"></span>   <span class="keywordtype">int</span> ec_arr[2];
<a name="l04571"></a>04571 
<a name="l04572"></a>04572    <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#aeafef525b8bac4713c119b593780ca69" title="TRUE if the echo cancellor is enabled.">ec_enable</a>) {
<a name="l04573"></a>04573       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>:0,<span class="stringliteral">&quot;Sending Control ECHOCAN_ON taps:%d\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf0690a26c02528e63f3cb623d1bd4a7" title="Number of taps in the echo cancellor when enabled.">ec_deftaps</a>);
<a name="l04574"></a>04574    
<a name="l04575"></a>04575       <span class="keywordflow">switch</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf0690a26c02528e63f3cb623d1bd4a7" title="Number of taps in the echo cancellor when enabled.">ec_deftaps</a>) {
<a name="l04576"></a>04576       <span class="keywordflow">case</span> 4:
<a name="l04577"></a>04577       <span class="keywordflow">case</span> 8:
<a name="l04578"></a>04578       <span class="keywordflow">case</span> 16:
<a name="l04579"></a>04579       <span class="keywordflow">case</span> 32:
<a name="l04580"></a>04580       <span class="keywordflow">case</span> 64:
<a name="l04581"></a>04581       <span class="keywordflow">case</span> 128:
<a name="l04582"></a>04582       <span class="keywordflow">case</span> 256:
<a name="l04583"></a>04583       <span class="keywordflow">case</span> 512:
<a name="l04584"></a>04584       <span class="keywordflow">case</span> 1024:
<a name="l04585"></a>04585          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Taps is %d\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf0690a26c02528e63f3cb623d1bd4a7" title="Number of taps in the echo cancellor when enabled.">ec_deftaps</a>);
<a name="l04586"></a>04586          <span class="keywordflow">break</span>;
<a name="l04587"></a>04587       <span class="keywordflow">default</span>:
<a name="l04588"></a>04588          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>, <span class="stringliteral">&quot;Taps should be power of 2\n&quot;</span>);
<a name="l04589"></a>04589          bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf0690a26c02528e63f3cb623d1bd4a7" title="Number of taps in the echo cancellor when enabled.">ec_deftaps</a>=128;
<a name="l04590"></a>04590       }
<a name="l04591"></a>04591    
<a name="l04592"></a>04592       ec_arr[0]=bc-&gt;<a class="code" href="structmisdn__bchannel.html#adf0690a26c02528e63f3cb623d1bd4a7" title="Number of taps in the echo cancellor when enabled.">ec_deftaps</a>;
<a name="l04593"></a>04593       ec_arr[1]=0;
<a name="l04594"></a>04594       
<a name="l04595"></a>04595       <a class="code" href="isdn__lib_8c.html#a68056961358d38e2cef26ccf6c136a99">manager_ph_control_block</a>(bc,  <a class="code" href="isdn__lib_8c.html#a1d04e4c505f3b5098045983971c84bf3">ECHOCAN_ON</a>,  ec_arr, <span class="keyword">sizeof</span>(ec_arr));
<a name="l04596"></a>04596    }
<a name="l04597"></a>04597 <span class="preprocessor">#endif</span>
<a name="l04598"></a>04598 <span class="preprocessor"></span>   }
<a name="l04599"></a>04599 }
<a name="l04600"></a>04600 
<a name="l04601"></a>04601 
<a name="l04602"></a>04602 
<a name="l04603"></a><a class="code" href="isdn__lib_8h.html#a1801c58b6e467b4ef0d75aff37aa77f2">04603</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a1801c58b6e467b4ef0d75aff37aa77f2">manager_ec_disable</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04604"></a>04604 {
<a name="l04605"></a>04605    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a741c68a6879aa333e2fdf1e552e1a5fd">get_stack_by_bc</a>(bc);
<a name="l04606"></a>04606    
<a name="l04607"></a>04607    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>:0,<span class="stringliteral">&quot; --&gt; ec_disable\n&quot;</span>);
<a name="l04608"></a>04608 
<a name="l04609"></a>04609    <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#acaefa07620d12d0dc4f979c9e3c3f73e">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#afa05b14ff7f76f303c784c00c4c63fa7" title="SETUP message bearer capability field code value.">capability</a>)) {
<a name="l04610"></a>04610       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(1, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>:0, <span class="stringliteral">&quot; --&gt; no speech? cannot disable EC\n&quot;</span>);
<a name="l04611"></a>04611       <span class="keywordflow">return</span>;
<a name="l04612"></a>04612    }
<a name="l04613"></a>04613 
<a name="l04614"></a>04614 <span class="preprocessor">#ifdef MISDN_1_2</span>
<a name="l04615"></a>04615 <span class="preprocessor"></span>   <a class="code" href="isdn__lib_8c.html#a68056961358d38e2cef26ccf6c136a99">manager_ph_control_block</a>(bc, PIPELINE_CFG, <span class="stringliteral">&quot;&quot;</span>, 0);
<a name="l04616"></a>04616 <span class="preprocessor">#else</span>
<a name="l04617"></a>04617 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ( ! bc-&gt;<a class="code" href="structmisdn__bchannel.html#aeafef525b8bac4713c119b593780ca69" title="TRUE if the echo cancellor is enabled.">ec_enable</a>) {
<a name="l04618"></a>04618       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this stack.">port</a>:0, <span class="stringliteral">&quot;Sending Control ECHOCAN_OFF\n&quot;</span>);
<a name="l04619"></a>04619       <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc,  <a class="code" href="isdn__lib_8c.html#ae22add021206651a21a9a3f3cb631616">ECHOCAN_OFF</a>, 0);
<a name="l04620"></a>04620    }
<a name="l04621"></a>04621 <span class="preprocessor">#endif</span>
<a name="l04622"></a>04622 <span class="preprocessor"></span>}
<a name="l04623"></a>04623 
<a name="l04624"></a><a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">04624</a> <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a>* <a class="code" href="isdn__lib_8c.html#afc530f1c2814dd0007e8ccd6aaf1fb06">get_misdn_stack</a>(<span class="keywordtype">void</span>) {
<a name="l04625"></a>04625    <span class="keywordflow">return</span> glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#ae868b2194d1d5198490293ca9a2b29ab">stack_list</a>;
<a name="l04626"></a>04626 }
<a name="l04627"></a>04627 
<a name="l04628"></a>04628 
<a name="l04629"></a>04629 
<a name="l04630"></a><a class="code" href="isdn__lib_8c.html#abab4f8b1249e8086247badba522584c7">04630</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#abab4f8b1249e8086247badba522584c7">misdn_join_conf</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> conf_id)
<a name="l04631"></a>04631 {
<a name="l04632"></a>04632    <span class="keywordtype">char</span> data[16] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l04633"></a>04633 
<a name="l04634"></a>04634    <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a660c00210e9cd580ec7f1b0250c3ce6e">BCHAN_BRIDGED</a>);
<a name="l04635"></a>04635    <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, CMX_RECEIVE_OFF, 0);
<a name="l04636"></a>04636    <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, CMX_CONF_JOIN, conf_id);
<a name="l04637"></a>04637 
<a name="l04638"></a>04638    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;Joining bc:%x in conf:%d\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>,conf_id);
<a name="l04639"></a>04639 
<a name="l04640"></a>04640    <a class="code" href="isdn__lib_8c.html#a017d9391bbd17db8104fcb1c7761918a">misdn_lib_tx2misdn_frm</a>(bc, data, <span class="keyword">sizeof</span>(data) - 1);
<a name="l04641"></a>04641 }
<a name="l04642"></a>04642 
<a name="l04643"></a>04643 
<a name="l04644"></a><a class="code" href="isdn__lib_8c.html#a4f8e334830dd8d96704965b9ef8de451">04644</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a4f8e334830dd8d96704965b9ef8de451">misdn_split_conf</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> conf_id)
<a name="l04645"></a>04645 {
<a name="l04646"></a>04646    <a class="code" href="isdn__lib_8c.html#a621dffd1191d37e3aaa056e9be75a495">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a1b7d7fde2aa8ceca170c3d0f8283fbc0">BCHAN_ACTIVATED</a>);
<a name="l04647"></a>04647    <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, CMX_RECEIVE_ON, 0);
<a name="l04648"></a>04648    <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, CMX_CONF_SPLIT, conf_id);
<a name="l04649"></a>04649 
<a name="l04650"></a>04650    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;Splitting bc:%x in conf:%d\n&quot;</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#aafb8164f20f79a2dd0290502a25367d1" title="B Channel mISDN driver layer ID from mISDN_get_layerid().">addr</a>,conf_id);
<a name="l04651"></a>04651 }
<a name="l04652"></a>04652 
<a name="l04653"></a><a class="code" href="isdn__lib_8h.html#a34620179f9915e64c16a7cc639bf38d2">04653</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a34620179f9915e64c16a7cc639bf38d2">misdn_lib_bridge</a>( <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> * bc1, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc2)
<a name="l04654"></a>04654 {
<a name="l04655"></a>04655    <span class="keywordtype">int</span> conf_id = bc1-&gt;<a class="code" href="structmisdn__bchannel.html#af500917c052066b40cf47f96b43c607b" title="B channel process ID (1-5000).">pid</a> + 1;
<a name="l04656"></a>04656    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc_list[] = { bc1, bc2, NULL };
<a name="l04657"></a>04657    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> **bc;
<a name="l04658"></a>04658 
<a name="l04659"></a>04659    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, bc1-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot;I Send: BRIDGE from:%d to:%d\n&quot;</span>,bc1-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>,bc2-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>);
<a name="l04660"></a>04660 
<a name="l04661"></a>04661    <span class="keywordflow">for</span> (bc=bc_list; *bc;  bc++) { 
<a name="l04662"></a>04662       (*bc)-&gt;conf_id=conf_id;
<a name="l04663"></a>04663       <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(4, (*bc)-&gt;port, <span class="stringliteral">&quot; --&gt; bc_addr:%x\n&quot;</span>,(*bc)-&gt;addr);
<a name="l04664"></a>04664    
<a name="l04665"></a>04665       <span class="keywordflow">switch</span>((*bc)-&gt;bc_state) {
<a name="l04666"></a>04666          <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a1b7d7fde2aa8ceca170c3d0f8283fbc0">BCHAN_ACTIVATED</a>:
<a name="l04667"></a>04667             <a class="code" href="isdn__lib_8c.html#abab4f8b1249e8086247badba522584c7">misdn_join_conf</a>(*bc,conf_id);
<a name="l04668"></a>04668             <span class="keywordflow">break</span>;
<a name="l04669"></a>04669          <span class="keywordflow">default</span>:
<a name="l04670"></a>04670             <a class="code" href="isdn__lib_8c.html#ad87e2fd48d69fe48859d33f22d6d57d4">bc_next_state_change</a>(*bc,<a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a660c00210e9cd580ec7f1b0250c3ce6e">BCHAN_BRIDGED</a>);
<a name="l04671"></a>04671             <span class="keywordflow">break</span>;
<a name="l04672"></a>04672       }
<a name="l04673"></a>04673    }
<a name="l04674"></a>04674 }
<a name="l04675"></a>04675 
<a name="l04676"></a><a class="code" href="isdn__lib_8h.html#a60d6c2795bd96c345a970a8dc23962d9">04676</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a60d6c2795bd96c345a970a8dc23962d9">misdn_lib_split_bridge</a>( <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> * bc1, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc2)
<a name="l04677"></a>04677 {
<a name="l04678"></a>04678 
<a name="l04679"></a>04679    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc_list[]={
<a name="l04680"></a>04680       bc1,bc2,NULL
<a name="l04681"></a>04681    };
<a name="l04682"></a>04682    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> **bc;
<a name="l04683"></a>04683       
<a name="l04684"></a>04684    <span class="keywordflow">for</span> (bc=bc_list; *bc;  bc++) { 
<a name="l04685"></a>04685       <span class="keywordflow">if</span> ( (*bc)-&gt;bc_state == <a class="code" href="isdn__lib_8h.html#a8ac183371c27715fa370f6c9aeb3e4c4a660c00210e9cd580ec7f1b0250c3ce6e">BCHAN_BRIDGED</a>){
<a name="l04686"></a>04686          <a class="code" href="isdn__lib_8c.html#a4f8e334830dd8d96704965b9ef8de451">misdn_split_conf</a>( *bc, (*bc)-&gt;<a class="code" href="structmisdn__bchannel.html#aab0f7344f706b822f3aeab3e328793d0" title="Bridging conference ID.">conf_id</a>);
<a name="l04687"></a>04687       } <span class="keywordflow">else</span> {
<a name="l04688"></a>04688          <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>( 2, (*bc)-&gt;port, <span class="stringliteral">&quot;BC not bridged (state:%s) so not splitting it\n&quot;</span>,<a class="code" href="isdn__lib_8c.html#ae2f4cc55968e9014a4daa06d1be05bef">bc_state2str</a>((*bc)-&gt;bc_state));
<a name="l04689"></a>04689       }
<a name="l04690"></a>04690    }
<a name="l04691"></a>04691    
<a name="l04692"></a>04692 }
<a name="l04693"></a>04693 
<a name="l04694"></a>04694 
<a name="l04695"></a>04695 
<a name="l04696"></a><a class="code" href="isdn__lib_8h.html#a4ac6ff440f5d1d763faea61535de934a">04696</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a4ac6ff440f5d1d763faea61535de934a">misdn_lib_echo</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> onoff)
<a name="l04697"></a>04697 {
<a name="l04698"></a>04698    <a class="code" href="isdn__lib_8c.html#ad1a7ed589e7bc8ca220a5dd792f474b7">cb_log</a>(3,bc-&gt;<a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>, <span class="stringliteral">&quot; --&gt; ECHO %s\n&quot;</span>, onoff?<span class="stringliteral">&quot;ON&quot;</span>:<span class="stringliteral">&quot;OFF&quot;</span>);
<a name="l04699"></a>04699    <a class="code" href="isdn__lib_8c.html#a7505c098dd0c991d2f8b28ac8d2e714f">manager_ph_control</a>(bc, onoff?CMX_ECHO_ON:CMX_ECHO_OFF, 0);
<a name="l04700"></a>04700 }
<a name="l04701"></a>04701 
<a name="l04702"></a>04702 
<a name="l04703"></a>04703 
<a name="l04704"></a><a class="code" href="isdn__lib_8h.html#adade044f8be231389ea854bc1e529c71">04704</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#adade044f8be231389ea854bc1e529c71">misdn_lib_reinit_nt_stack</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#a63c89c04d1feae07ca35558055155ffb" title="Logical Layer 1 port associated with this B channel.">port</a>)
<a name="l04705"></a>04705 {
<a name="l04706"></a>04706    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#a440118240f78921a8727b1587ce959b0">find_stack_by_port</a>(port);
<a name="l04707"></a>04707    
<a name="l04708"></a>04708    <span class="keywordflow">if</span> (stack) {
<a name="l04709"></a>04709       stack-&gt;<a class="code" href="structmisdn__stack.html#a2f51cb4d0630a299b4e436c7471eea21" title="TRUE if Layer 2 is UP.">l2link</a>=0;
<a name="l04710"></a>04710       stack-&gt;<a class="code" href="structmisdn__stack.html#ac74e3d5a1b1eeb5c8e32867ad62823f0" title="TRUE if port is blocked.">blocked</a>=0;
<a name="l04711"></a>04711    
<a name="l04712"></a>04712       cleanup_Isdnl3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>);
<a name="l04713"></a>04713       cleanup_Isdnl2(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>);
<a name="l04714"></a>04714 
<a name="l04715"></a>04715 
<a name="l04716"></a>04716       memset(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>, 0, <span class="keyword">sizeof</span>(net_stack_t));
<a name="l04717"></a>04717       memset(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a0bdc24d4d5181fb244f8c409805bb7d2">mgr</a>, 0, <span class="keyword">sizeof</span>(manager_t));
<a name="l04718"></a>04718    
<a name="l04719"></a>04719       stack-&gt;<a class="code" href="structmisdn__stack.html#a0bdc24d4d5181fb244f8c409805bb7d2">mgr</a>.nst = &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>;
<a name="l04720"></a>04720       stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.manager = &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a0bdc24d4d5181fb244f8c409805bb7d2">mgr</a>;
<a name="l04721"></a>04721     
<a name="l04722"></a>04722       stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.l3_manager = <a class="code" href="isdn__lib_8c.html#a337b0dfa9c48d2177f26a30278742186">handle_event_nt</a>;
<a name="l04723"></a>04723       stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.device = glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a3e10279a840024fc343894dfa724540a" title="mISDN device handle returned by mISDN_open()">midev</a>;
<a name="l04724"></a>04724       stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.cardnr = port;
<a name="l04725"></a>04725       stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.d_stid = stack-&gt;<a class="code" href="structmisdn__stack.html#af820f8cddb26fe90f6da9cdef9c1cc94" title="D Channel mISDN driver stack ID (Parent stack ID).">d_stid</a>;
<a name="l04726"></a>04726    
<a name="l04727"></a>04727       stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.feature = FEATURE_NET_HOLD;
<a name="l04728"></a>04728       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a>)
<a name="l04729"></a>04729          stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.feature |= FEATURE_NET_PTP;
<a name="l04730"></a>04730       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#af4b6f45a73da60a2b05d11e6f5bb0f23" title="TRUE if ISDN-PRI (ISDN-BRI otherwise).">pri</a>)
<a name="l04731"></a>04731          stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.feature |= FEATURE_NET_CRLEN2 | FEATURE_NET_EXTCID;
<a name="l04732"></a>04732       
<a name="l04733"></a>04733       stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.l1_id = stack-&gt;<a class="code" href="structmisdn__stack.html#aa2ae4f87975bbc69517aa3bc328e91c0" title="Lower layer mISDN ID (addr) (Layer 1/3).">lower_id</a>;
<a name="l04734"></a>04734       stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.l2_id = stack-&gt;<a class="code" href="structmisdn__stack.html#a9cc825eb785f594cc8676c3b5df1ce22" title="Upper layer mISDN ID (addr) (Layer 2/4).">upper_id</a>;
<a name="l04735"></a>04735       
<a name="l04736"></a>04736       msg_queue_init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>.down_queue);
<a name="l04737"></a>04737    
<a name="l04738"></a>04738       Isdnl2Init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>);
<a name="l04739"></a>04739       Isdnl3Init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#a95b0e52b68d1ca7fdeb61c7909dc5c4b">nst</a>);
<a name="l04740"></a>04740 
<a name="l04741"></a>04741       <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#afd87010c68e02b9327cf530850f3deb0" title="TRUE if Point-To-Point(PTP) (Point-To-Multipoint(PTMP) otherwise).">ptp</a>)
<a name="l04742"></a>04742          <a class="code" href="isdn__lib_8c.html#a4af2f7ae2eb8c3746985df5544d17203">misdn_lib_get_l1_up</a>(stack);
<a name="l04743"></a>04743       <a class="code" href="isdn__lib_8c.html#af03ad57836b38845f685368e60625707">misdn_lib_get_l2_up</a>(stack);
<a name="l04744"></a>04744    }
<a name="l04745"></a>04745 }
<a name="l04746"></a>04746 
<a name="l04747"></a>04747 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:42 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
