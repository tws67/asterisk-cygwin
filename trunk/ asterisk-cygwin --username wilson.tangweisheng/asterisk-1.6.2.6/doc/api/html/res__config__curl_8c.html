<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:23:09 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_318a70d4e812a718d9ecaeea98fff199.html">res</a>
  </div>
</div>
<div class="contents">
<h1>res_config_curl.c File Reference</h1>
<p>curl plugin for portable configuration engine  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &lt;curl/curl.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="file_8h_source.html">asterisk/file.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="channel_8h_source.html">asterisk/channel.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pbx_8h_source.html">asterisk/pbx.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="config_8h_source.html">asterisk/config.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="module_8h_source.html">asterisk/module.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="lock_8h_source.html">asterisk/lock.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>

<p><a href="res__config__curl_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#a88b7c88fed6b80fd18f34f97757dfc04">__reg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#afeab1257bd17282b95875499393a147a">__unreg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__config.html">ast_config</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#a3726af88bb9d84219f373338a7c01399">config_curl</a> (const char *<a class="el" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>, const char *unused, const char *file, struct <a class="el" href="structast__config.html">ast_config</a> *cfg, struct <a class="el" href="structast__flags.html">ast_flags</a> flags, const char *sugg_incl, const char *who_asked)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#af74fc43e299b0a29397c9cabc0dc5440">destroy_curl</a> (const char *<a class="el" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>, const char *unused, const char *keyfield, const char *lookup, va_list ap)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Execute an DELETE query.  <a href="#af74fc43e299b0a29397c9cabc0dc5440"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#a5a1dffdce95e120c5f404c8f3b384bb2">realtime_curl</a> (const char *<a class="el" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>, const char *unused, va_list ap)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Execute a curl query and return <a class="el" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> list.  <a href="#a5a1dffdce95e120c5f404c8f3b384bb2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__config.html">ast_config</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#acaded522fd492b3c3edd7478ae1f8ce9">realtime_multi_curl</a> (const char *<a class="el" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>, const char *unused, va_list ap)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Excute an Select query and return <a class="el" href="structast__config.html">ast_config</a> list.  <a href="#acaded522fd492b3c3edd7478ae1f8ce9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#a1fb05f8c2064f3ca872685ffd3f19f81">require_curl</a> (const char *<a class="el" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>, const char *unused, va_list ap)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#afadcecbaf4ea7e2252c80f55b839fc27">store_curl</a> (const char *<a class="el" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>, const char *unused, va_list ap)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Execute an INSERT query.  <a href="#afadcecbaf4ea7e2252c80f55b839fc27"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#a50bc909e09b1f0203d7806bf5bfe9bf3">update2_curl</a> (const char *<a class="el" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>, const char *unused, va_list ap)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#a68a5c3694627aedd19a614da83306af7">update_curl</a> (const char *<a class="el" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>, const char *unused, const char *keyfield, const char *lookup, va_list ap)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Execute an UPDATE query.  <a href="#a68a5c3694627aedd19a614da83306af7"></a><br/></td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_DEFAULT , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;Realtime Curl configuration&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#ae25b9f3970870610911f8850897e8ead">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__config__engine.html">ast_config_engine</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__curl_8c.html#a1b46c7d9dcc38d53fe2510276bd6db83">curl_engine</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>curl plugin for portable configuration engine </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Tilghman Lesher &lt;<a href="mailto:res_config_curl_v1@the-tilghman.com">res_config_curl_v1@the-tilghman.com</a>&gt;</dd></dl>
<dl class="extref"><dt><b><a class="el" href="extref.html#_extref000019">ExtRef:</a></b></dt><dd>Depends on the CURL library - <a href="http://curl.haxx.se/">http://curl.haxx.se/</a></dd></dl>

<p>Definition in file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a88b7c88fed6b80fd18f34f97757dfc04"></a><!-- doxytag: member="res_config_curl.c::__reg_module" ref="a88b7c88fed6b80fd18f34f97757dfc04" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __reg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00626">626</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

</div>
</div>
<a class="anchor" id="afeab1257bd17282b95875499393a147a"></a><!-- doxytag: member="res_config_curl.c::__unreg_module" ref="afeab1257bd17282b95875499393a147a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __unreg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00626">626</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

</div>
</div>
<a class="anchor" id="a3726af88bb9d84219f373338a7c01399"></a><!-- doxytag: member="res_config_curl.c::config_curl" ref="a3726af88bb9d84219f373338a7c01399" args="(const char *url, const char *unused, const char *file, struct ast_config *cfg, struct ast_flags flags, const char *sugg_incl, const char *who_asked)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__config.html">ast_config</a>* config_curl </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>url</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>unused</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__config.html">ast_config</a> *&nbsp;</td>
          <td class="paramname"> <em>cfg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__flags.html">ast_flags</a>&nbsp;</td>
          <td class="paramname"> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>sugg_incl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>who_asked</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00518">518</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

<p>References <a class="el" href="config_8c_source.html#l00522">ast_category_append()</a>, <a class="el" href="config_8c_source.html#l00483">ast_category_new()</a>, <a class="el" href="config_8c_source.html#l00845">ast_config_get_current_category()</a>, <a class="el" href="config_8c_source.html#l02031">ast_config_internal_load()</a>, <a class="el" href="pbx_8c_source.html#l03202">ast_custom_function_find()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astmm_8h_source.html#l00081">ast_malloc</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8c_source.html#l00414">ast_uri_decode()</a>, <a class="el" href="utils_8c_source.html#l00383">ast_uri_encode()</a>, <a class="el" href="config_8c_source.html#l00348">ast_variable_append()</a>, <a class="el" href="config_8c_source.html#l00223">ast_variable_new()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="pbx_8c_source.html#l03598">pbx_substitute_variables_helper()</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, and <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00519"></a>00519 {
<a name="l00520"></a>00520    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *query;
<a name="l00521"></a>00521    <span class="keywordtype">char</span> buf1[200];
<a name="l00522"></a>00522    <span class="keywordtype">char</span> *stringp, *line, *pair, *key;
<a name="l00523"></a>00523    <span class="keyword">const</span> <span class="keywordtype">int</span> EncodeSpecialChars = 1, bufsize = 256000;
<a name="l00524"></a>00524    <span class="keywordtype">int</span> last_cat_metric = -1, cat_metric = -1;
<a name="l00525"></a>00525    <span class="keyword">struct </span><a class="code" href="structast__category.html">ast_category</a> *cat=NULL;
<a name="l00526"></a>00526    <span class="keywordtype">char</span> *buffer, *cur_cat = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00527"></a>00527    <span class="keywordtype">char</span> *category = <span class="stringliteral">&quot;&quot;</span>, *var_name = <span class="stringliteral">&quot;&quot;</span>, *var_val = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00528"></a>00528    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> loader_flags = { 0 };
<a name="l00529"></a>00529 
<a name="l00530"></a>00530    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a5e0f8c2ce2a3c8994648254799a0c3b7">ast_custom_function_find</a>(<span class="stringliteral">&quot;CURL&quot;</span>)) {
<a name="l00531"></a>00531       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;func_curl.so must be loaded in order to use res_config_curl.so!!\n&quot;</span>);
<a name="l00532"></a>00532       <span class="keywordflow">return</span> NULL;
<a name="l00533"></a>00533    }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535    <span class="keywordflow">if</span> (!(query = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(1000)))
<a name="l00536"></a>00536       <span class="keywordflow">return</span> NULL;
<a name="l00537"></a>00537 
<a name="l00538"></a>00538    <span class="keywordflow">if</span> (!(buffer = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(bufsize))) {
<a name="l00539"></a>00539       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00540"></a>00540       <span class="keywordflow">return</span> NULL;
<a name="l00541"></a>00541    }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543    <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(file, buf1, <span class="keyword">sizeof</span>(buf1), EncodeSpecialChars);
<a name="l00544"></a>00544    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;query, 0, <span class="stringliteral">&quot;${CURL(%s/static?file=%s)}&quot;</span>, <a class="code" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>, buf1);
<a name="l00545"></a>00545 
<a name="l00546"></a>00546    <span class="comment">/* Do the CURL query */</span>
<a name="l00547"></a>00547    <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(query), buffer, bufsize);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549    <span class="comment">/* Line oriented output */</span>
<a name="l00550"></a>00550    stringp = buffer;
<a name="l00551"></a>00551    cat = <a class="code" href="config_8h.html#a6884d439424ba2be31ef259213da4e8b" title="Retrieve the current category name being built. API for backend configuration engines...">ast_config_get_current_category</a>(cfg);
<a name="l00552"></a>00552 
<a name="l00553"></a>00553    <span class="keywordflow">while</span> ((line = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;\r\n&quot;</span>))) {
<a name="l00554"></a>00554       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(line))
<a name="l00555"></a>00555          <span class="keywordflow">continue</span>;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557       <span class="keywordflow">while</span> ((pair = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;line, <span class="stringliteral">&quot;&amp;&quot;</span>))) {
<a name="l00558"></a>00558          key = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;pair, <span class="stringliteral">&quot;=&quot;</span>);
<a name="l00559"></a>00559          <a class="code" href="utils_8h.html#adafa7619a91aca23fc519bcc31ae8dff" title="Decode URI, URN, URL (overwrite string).">ast_uri_decode</a>(key);
<a name="l00560"></a>00560          <span class="keywordflow">if</span> (pair)
<a name="l00561"></a>00561             <a class="code" href="utils_8h.html#adafa7619a91aca23fc519bcc31ae8dff" title="Decode URI, URN, URL (overwrite string).">ast_uri_decode</a>(pair);
<a name="l00562"></a>00562 
<a name="l00563"></a>00563          <span class="keywordflow">if</span> (!strcasecmp(key, <span class="stringliteral">&quot;category&quot;</span>))
<a name="l00564"></a>00564             category = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pair, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00565"></a>00565          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(key, <span class="stringliteral">&quot;var_name&quot;</span>))
<a name="l00566"></a>00566             var_name = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pair, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00567"></a>00567          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(key, <span class="stringliteral">&quot;var_val&quot;</span>))
<a name="l00568"></a>00568             var_val = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pair, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00569"></a>00569          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(key, <span class="stringliteral">&quot;cat_metric&quot;</span>))
<a name="l00570"></a>00570             cat_metric = pair ? atoi(pair) : 0;
<a name="l00571"></a>00571       }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573       <span class="keywordflow">if</span> (!strcmp(var_name, <span class="stringliteral">&quot;#include&quot;</span>)) {
<a name="l00574"></a>00574          <span class="keywordflow">if</span> (!<a class="code" href="config_8h.html#a721d5cd60abda2bdd96838336dc09669">ast_config_internal_load</a>(var_val, cfg, loader_flags, <span class="stringliteral">&quot;&quot;</span>, who_asked))
<a name="l00575"></a>00575             <span class="keywordflow">return</span> NULL;
<a name="l00576"></a>00576       }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578       <span class="keywordflow">if</span> (strcmp(category, cur_cat) || last_cat_metric != cat_metric) {
<a name="l00579"></a>00579          <span class="keywordflow">if</span> (!(cat = <a class="code" href="config_8h.html#affebac76d69639677b677037d9871e29" title="Create a category structure.">ast_category_new</a>(category, <span class="stringliteral">&quot;&quot;</span>, 99999)))
<a name="l00580"></a>00580             <span class="keywordflow">break</span>;
<a name="l00581"></a>00581          cur_cat = category;
<a name="l00582"></a>00582          last_cat_metric = cat_metric;
<a name="l00583"></a>00583          <a class="code" href="config_8h.html#ab7b56ec66b058952423f313752c734e7">ast_category_append</a>(cfg, cat);
<a name="l00584"></a>00584       }
<a name="l00585"></a>00585       <a class="code" href="config_8h.html#a132ddbd39dd9d26395c410f7647f76db">ast_variable_append</a>(cat, <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(var_name, var_val, <span class="stringliteral">&quot;&quot;</span>));
<a name="l00586"></a>00586    }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buffer);
<a name="l00589"></a>00589    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00590"></a>00590    <span class="keywordflow">return</span> cfg;
<a name="l00591"></a>00591 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af74fc43e299b0a29397c9cabc0dc5440"></a><!-- doxytag: member="res_config_curl.c::destroy_curl" ref="af74fc43e299b0a29397c9cabc0dc5440" args="(const char *url, const char *unused, const char *keyfield, const char *lookup, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int destroy_curl </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>url</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>unused</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>keyfield</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>lookup</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Execute an DELETE query. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>url</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>unused</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>keyfield</em>&nbsp;</td><td>where clause field </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>lookup</em>&nbsp;</td><td>value of field for where clause </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ap</em>&nbsp;</td><td>list containing one or more field/value set(s)</td></tr>
  </table>
  </dd>
</dl>
<p>Delete a row from a database table, prepare the sql statement using keyfield and lookup control the <a class="el" href="structnumber.html" title="Number structure.">number</a> of records to change. Additional params to match rows are stored in ap list. Sub-in the <a class="el" href="structvalues.html">values</a> to the prepared statement and execute it.</p>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structnumber.html" title="Number structure.">number</a></em>&nbsp;</td><td>of rows affected </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00419">419</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l03202">ast_custom_function_find()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astmm_8h_source.html#l00081">ast_malloc</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="utils_8c_source.html#l00383">ast_uri_encode()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="pbx_8c_source.html#l03598">pbx_substitute_variables_helper()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00420"></a>00420 {
<a name="l00421"></a>00421    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *query;
<a name="l00422"></a>00422    <span class="keywordtype">char</span> buf1[200], buf2[200];
<a name="l00423"></a>00423    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00424"></a>00424    <span class="keywordtype">char</span> *stringp;
<a name="l00425"></a>00425    <span class="keywordtype">int</span> i, rowcount = -1;
<a name="l00426"></a>00426    <span class="keyword">const</span> <span class="keywordtype">int</span> EncodeSpecialChars = 1, bufsize = 100;
<a name="l00427"></a>00427    <span class="keywordtype">char</span> *buffer;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a5e0f8c2ce2a3c8994648254799a0c3b7">ast_custom_function_find</a>(<span class="stringliteral">&quot;CURL&quot;</span>)) {
<a name="l00430"></a>00430       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;func_curl.so must be loaded in order to use res_config_curl.so!!\n&quot;</span>);
<a name="l00431"></a>00431       <span class="keywordflow">return</span> -1;
<a name="l00432"></a>00432    }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434    <span class="keywordflow">if</span> (!(query = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(1000)))
<a name="l00435"></a>00435       <span class="keywordflow">return</span> -1;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437    <span class="keywordflow">if</span> (!(buffer = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(bufsize))) {
<a name="l00438"></a>00438       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00439"></a>00439       <span class="keywordflow">return</span> -1;
<a name="l00440"></a>00440    }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442    <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(keyfield, buf1, <span class="keyword">sizeof</span>(buf1), EncodeSpecialChars);
<a name="l00443"></a>00443    <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(lookup, buf2, <span class="keyword">sizeof</span>(buf2), EncodeSpecialChars);
<a name="l00444"></a>00444    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;query, 0, <span class="stringliteral">&quot;${CURL(%s/destroy,%s=%s&amp;&quot;</span>, <a class="code" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>, buf1, buf2);
<a name="l00445"></a>00445 
<a name="l00446"></a>00446    <span class="keywordflow">for</span> (i = 0; (newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *)); i++) {
<a name="l00447"></a>00447       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00448"></a>00448       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(newparam, buf1, <span class="keyword">sizeof</span>(buf1), EncodeSpecialChars);
<a name="l00449"></a>00449       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(newval, buf2, <span class="keyword">sizeof</span>(buf2), EncodeSpecialChars);
<a name="l00450"></a>00450       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;%s%s=%s&quot;</span>, i &gt; 0 ? <span class="stringliteral">&quot;&amp;&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, buf1, buf2);
<a name="l00451"></a>00451    }
<a name="l00452"></a>00452    va_end(ap);
<a name="l00453"></a>00453 
<a name="l00454"></a>00454    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;)}&quot;</span>);
<a name="l00455"></a>00455    <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(query), buffer, bufsize);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457    <span class="comment">/* Line oriented output */</span>
<a name="l00458"></a>00458    stringp = buffer;
<a name="l00459"></a>00459    <span class="keywordflow">while</span> (*stringp &lt;= <span class="charliteral">&apos; &apos;</span>)
<a name="l00460"></a>00460       stringp++;
<a name="l00461"></a>00461    sscanf(stringp, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;rowcount);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buffer);
<a name="l00464"></a>00464    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466    <span class="keywordflow">if</span> (rowcount &gt;= 0)
<a name="l00467"></a>00467       <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)rowcount;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469    <span class="keywordflow">return</span> -1;
<a name="l00470"></a>00470 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac3382bf6da54c56b37069bd76bbdf4f9"></a><!-- doxytag: member="res_config_curl.c::load_module" ref="ac3382bf6da54c56b37069bd76bbdf4f9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00612">612</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

<p>References <a class="el" href="config_8c_source.html#l01950">ast_config_engine_register()</a>, <a class="el" href="loader_8c_source.html#l00831">ast_load_resource()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="loader_8c_source.html#l01118">ast_module_check()</a>, <a class="el" href="module_8h_source.html#l00062">AST_MODULE_LOAD_DECLINE</a>, <a class="el" href="module_8h_source.html#l00061">AST_MODULE_LOAD_SUCCESS</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, and <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00613"></a>00613 {
<a name="l00614"></a>00614    <span class="keywordflow">if</span> (!<a class="code" href="module_8h.html#a15f7e2f25f4d0c60de6cca164232a6d4" title="Check if module with the name given is loaded.">ast_module_check</a>(<span class="stringliteral">&quot;res_curl.so&quot;</span>)) {
<a name="l00615"></a>00615       <span class="keywordflow">if</span> (<a class="code" href="module_8h.html#a841766995d4e10ebb3950b10aab97d9e" title="Load a module.">ast_load_resource</a>(<span class="stringliteral">&quot;res_curl.so&quot;</span>) != <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>) {
<a name="l00616"></a>00616          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Cannot load res_curl, so res_config_curl cannot be loaded\n&quot;</span>);
<a name="l00617"></a>00617          <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l00618"></a>00618       }
<a name="l00619"></a>00619    }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621    <a class="code" href="config_8h.html#af15c271e1708b251fc938b30baba18f1" title="Register config engine.">ast_config_engine_register</a>(&amp;<a class="code" href="res__config__curl_8c.html#a1b46c7d9dcc38d53fe2510276bd6db83">curl_engine</a>);
<a name="l00622"></a>00622    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;res_config_curl loaded.\n&quot;</span>);
<a name="l00623"></a>00623    <span class="keywordflow">return</span> 0;
<a name="l00624"></a>00624 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5a1dffdce95e120c5f404c8f3b384bb2"></a><!-- doxytag: member="res_config_curl.c::realtime_curl" ref="a5a1dffdce95e120c5f404c8f3b384bb2" args="(const char *url, const char *unused, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__variable.html">ast_variable</a>* realtime_curl </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>url</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>unused</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Execute a curl query and return <a class="el" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> list. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>url</em>&nbsp;</td><td>The base URL from which to retrieve data </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>unused</em>&nbsp;</td><td>Not currently used </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ap</em>&nbsp;</td><td>list containing one or more field/operator/value set.</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>var</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>NULL</em>&nbsp;</td><td>on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00056">56</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l03202">ast_custom_function_find()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astmm_8h_source.html#l00081">ast_malloc</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8c_source.html#l00414">ast_uri_decode()</a>, <a class="el" href="utils_8c_source.html#l00383">ast_uri_encode()</a>, <a class="el" href="config_8c_source.html#l00223">ast_variable_new()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="pbx_8c_source.html#l03598">pbx_substitute_variables_helper()</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>, and <a class="el" href="ast__expr2f_8c_source.html#l00613">var</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00057"></a>00057 {
<a name="l00058"></a>00058    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *query;
<a name="l00059"></a>00059    <span class="keywordtype">char</span> buf1[200], buf2[200];
<a name="l00060"></a>00060    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00061"></a>00061    <span class="keywordtype">char</span> *stringp, *pair, *key;
<a name="l00062"></a>00062    <span class="keywordtype">int</span> i;
<a name="l00063"></a>00063    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>=NULL, *prev=NULL;
<a name="l00064"></a>00064    <span class="keyword">const</span> <span class="keywordtype">int</span> EncodeSpecialChars = 1, bufsize = 64000;
<a name="l00065"></a>00065    <span class="keywordtype">char</span> *buffer;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a5e0f8c2ce2a3c8994648254799a0c3b7">ast_custom_function_find</a>(<span class="stringliteral">&quot;CURL&quot;</span>)) {
<a name="l00068"></a>00068       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;func_curl.so must be loaded in order to use res_config_curl.so!!\n&quot;</span>);
<a name="l00069"></a>00069       <span class="keywordflow">return</span> NULL;
<a name="l00070"></a>00070    }
<a name="l00071"></a>00071 
<a name="l00072"></a>00072    <span class="keywordflow">if</span> (!(query = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(1000)))
<a name="l00073"></a>00073       <span class="keywordflow">return</span> NULL;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075    <span class="keywordflow">if</span> (!(buffer = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(bufsize))) {
<a name="l00076"></a>00076       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00077"></a>00077       <span class="keywordflow">return</span> NULL;
<a name="l00078"></a>00078    }
<a name="l00079"></a>00079 
<a name="l00080"></a>00080    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;query, 0, <span class="stringliteral">&quot;${CURL(%s/single,&quot;</span>, <a class="code" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082    <span class="keywordflow">for</span> (i = 0; (newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *)); i++) {
<a name="l00083"></a>00083       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00084"></a>00084       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(newparam, buf1, <span class="keyword">sizeof</span>(buf1), EncodeSpecialChars);
<a name="l00085"></a>00085       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(newval, buf2, <span class="keyword">sizeof</span>(buf2), EncodeSpecialChars);
<a name="l00086"></a>00086       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;%s%s=%s&quot;</span>, i &gt; 0 ? <span class="stringliteral">&quot;&amp;&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, buf1, buf2);
<a name="l00087"></a>00087    }
<a name="l00088"></a>00088    va_end(ap);
<a name="l00089"></a>00089 
<a name="l00090"></a>00090    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;)}&quot;</span>);
<a name="l00091"></a>00091    <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(query), buffer, bufsize);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093    <span class="comment">/* Remove any trailing newline characters */</span>
<a name="l00094"></a>00094    <span class="keywordflow">if</span> ((stringp = strchr(buffer, <span class="charliteral">&apos;\r&apos;</span>)) || (stringp = strchr(buffer, <span class="charliteral">&apos;\n&apos;</span>)))
<a name="l00095"></a>00095       *stringp = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097    stringp = buffer;
<a name="l00098"></a>00098    <span class="keywordflow">while</span> ((pair = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;&amp;&quot;</span>))) {
<a name="l00099"></a>00099       key = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;pair, <span class="stringliteral">&quot;=&quot;</span>);
<a name="l00100"></a>00100       <a class="code" href="utils_8h.html#adafa7619a91aca23fc519bcc31ae8dff" title="Decode URI, URN, URL (overwrite string).">ast_uri_decode</a>(key);
<a name="l00101"></a>00101       <span class="keywordflow">if</span> (pair)
<a name="l00102"></a>00102          <a class="code" href="utils_8h.html#adafa7619a91aca23fc519bcc31ae8dff" title="Decode URI, URN, URL (overwrite string).">ast_uri_decode</a>(pair);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(key)) {
<a name="l00105"></a>00105          <span class="keywordflow">if</span> (prev) {
<a name="l00106"></a>00106             prev-&gt;next = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(key, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pair, <span class="stringliteral">&quot;&quot;</span>), <span class="stringliteral">&quot;&quot;</span>);
<a name="l00107"></a>00107             <span class="keywordflow">if</span> (prev-&gt;next)
<a name="l00108"></a>00108                prev = prev-&gt;next;
<a name="l00109"></a>00109          } <span class="keywordflow">else</span> 
<a name="l00110"></a>00110             prev = var = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(key, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pair, <span class="stringliteral">&quot;&quot;</span>), <span class="stringliteral">&quot;&quot;</span>);
<a name="l00111"></a>00111       }
<a name="l00112"></a>00112    }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buffer);
<a name="l00115"></a>00115    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00116"></a>00116    <span class="keywordflow">return</span> var;
<a name="l00117"></a>00117 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="acaded522fd492b3c3edd7478ae1f8ce9"></a><!-- doxytag: member="res_config_curl.c::realtime_multi_curl" ref="acaded522fd492b3c3edd7478ae1f8ce9" args="(const char *url, const char *unused, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__config.html">ast_config</a>* realtime_multi_curl </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>url</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>unused</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Excute an Select query and return <a class="el" href="structast__config.html">ast_config</a> list. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>url</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>unused</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ap</em>&nbsp;</td><td>list containing one or more field/operator/value set.</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>struct</em>&nbsp;</td><td><a class="el" href="structast__config.html">ast_config</a> pointer on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>NULL</em>&nbsp;</td><td>on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00128">128</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

<p>References <a class="el" href="config_8c_source.html#l00522">ast_category_append()</a>, <a class="el" href="config_8c_source.html#l00483">ast_category_new()</a>, <a class="el" href="config_8c_source.html#l00656">ast_category_rename()</a>, <a class="el" href="config_8c_source.html#l00673">ast_config_new()</a>, <a class="el" href="pbx_8c_source.html#l03202">ast_custom_function_find()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astmm_8h_source.html#l00081">ast_malloc</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8c_source.html#l00414">ast_uri_decode()</a>, <a class="el" href="utils_8c_source.html#l00383">ast_uri_encode()</a>, <a class="el" href="config_8c_source.html#l00348">ast_variable_append()</a>, <a class="el" href="config_8c_source.html#l00223">ast_variable_new()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="pbx_8c_source.html#l03598">pbx_substitute_variables_helper()</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>, and <a class="el" href="ast__expr2f_8c_source.html#l00613">var</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00129"></a>00129 {
<a name="l00130"></a>00130    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *query;
<a name="l00131"></a>00131    <span class="keywordtype">char</span> buf1[200], buf2[200];
<a name="l00132"></a>00132    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00133"></a>00133    <span class="keywordtype">char</span> *stringp, *line, *pair, *key, *initfield = NULL;
<a name="l00134"></a>00134    <span class="keywordtype">int</span> i;
<a name="l00135"></a>00135    <span class="keyword">const</span> <span class="keywordtype">int</span> EncodeSpecialChars = 1, bufsize = 256000;
<a name="l00136"></a>00136    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>=NULL;
<a name="l00137"></a>00137    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg=NULL;
<a name="l00138"></a>00138    <span class="keyword">struct </span><a class="code" href="structast__category.html">ast_category</a> *cat=NULL;
<a name="l00139"></a>00139    <span class="keywordtype">char</span> *buffer;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a5e0f8c2ce2a3c8994648254799a0c3b7">ast_custom_function_find</a>(<span class="stringliteral">&quot;CURL&quot;</span>)) {
<a name="l00142"></a>00142       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;func_curl.so must be loaded in order to use res_config_curl.so!!\n&quot;</span>);
<a name="l00143"></a>00143       <span class="keywordflow">return</span> NULL;
<a name="l00144"></a>00144    }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146    <span class="keywordflow">if</span> (!(query = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(1000)))
<a name="l00147"></a>00147       <span class="keywordflow">return</span> NULL;
<a name="l00148"></a>00148 
<a name="l00149"></a>00149    <span class="keywordflow">if</span> (!(buffer = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(bufsize))) {
<a name="l00150"></a>00150       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00151"></a>00151       <span class="keywordflow">return</span> NULL;
<a name="l00152"></a>00152    }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;query, 0, <span class="stringliteral">&quot;${CURL(%s/multi,&quot;</span>, <a class="code" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>);
<a name="l00155"></a>00155 
<a name="l00156"></a>00156    <span class="keywordflow">for</span> (i = 0; (newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *)); i++) {
<a name="l00157"></a>00157       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00158"></a>00158       <span class="keywordflow">if</span> (i == 0) {
<a name="l00159"></a>00159          <span class="keywordtype">char</span> *op;
<a name="l00160"></a>00160          initfield = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(newparam);
<a name="l00161"></a>00161          <span class="keywordflow">if</span> ((op = strchr(initfield, <span class="charliteral">&apos; &apos;</span>)))
<a name="l00162"></a>00162             *op = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00163"></a>00163       }
<a name="l00164"></a>00164       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(newparam, buf1, <span class="keyword">sizeof</span>(buf1), EncodeSpecialChars);
<a name="l00165"></a>00165       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(newval, buf2, <span class="keyword">sizeof</span>(buf2), EncodeSpecialChars);
<a name="l00166"></a>00166       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;%s%s=%s&quot;</span>, i &gt; 0 ? <span class="stringliteral">&quot;&amp;&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, buf1, buf2);
<a name="l00167"></a>00167    }
<a name="l00168"></a>00168    va_end(ap);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;)}&quot;</span>);
<a name="l00171"></a>00171 
<a name="l00172"></a>00172    <span class="comment">/* Do the CURL query */</span>
<a name="l00173"></a>00173    <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(query), buffer, bufsize);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8h.html#a45e1a284d7d84c4b4a316764fbb887fb" title="Create a new base configuration structure.">ast_config_new</a>()))
<a name="l00176"></a>00176       <span class="keywordflow">goto</span> exit_multi;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178    <span class="comment">/* Line oriented output */</span>
<a name="l00179"></a>00179    stringp = buffer;
<a name="l00180"></a>00180    <span class="keywordflow">while</span> ((line = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;\r\n&quot;</span>))) {
<a name="l00181"></a>00181       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(line))
<a name="l00182"></a>00182          <span class="keywordflow">continue</span>;
<a name="l00183"></a>00183 
<a name="l00184"></a>00184       <span class="keywordflow">if</span> (!(cat = <a class="code" href="config_8h.html#affebac76d69639677b677037d9871e29" title="Create a category structure.">ast_category_new</a>(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 99999)))
<a name="l00185"></a>00185          <span class="keywordflow">continue</span>;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187       <span class="keywordflow">while</span> ((pair = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;line, <span class="stringliteral">&quot;&amp;&quot;</span>))) {
<a name="l00188"></a>00188          key = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;pair, <span class="stringliteral">&quot;=&quot;</span>);
<a name="l00189"></a>00189          <a class="code" href="utils_8h.html#adafa7619a91aca23fc519bcc31ae8dff" title="Decode URI, URN, URL (overwrite string).">ast_uri_decode</a>(key);
<a name="l00190"></a>00190          <span class="keywordflow">if</span> (pair)
<a name="l00191"></a>00191             <a class="code" href="utils_8h.html#adafa7619a91aca23fc519bcc31ae8dff" title="Decode URI, URN, URL (overwrite string).">ast_uri_decode</a>(pair);
<a name="l00192"></a>00192 
<a name="l00193"></a>00193          <span class="keywordflow">if</span> (!strcasecmp(key, initfield) &amp;&amp; pair)
<a name="l00194"></a>00194             <a class="code" href="config_8h.html#a2a5612ff8eb3595c1be1df75be4d870f">ast_category_rename</a>(cat, pair);
<a name="l00195"></a>00195 
<a name="l00196"></a>00196          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(key)) {
<a name="l00197"></a>00197             var = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(key, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pair, <span class="stringliteral">&quot;&quot;</span>), <span class="stringliteral">&quot;&quot;</span>);
<a name="l00198"></a>00198             <a class="code" href="config_8h.html#a132ddbd39dd9d26395c410f7647f76db">ast_variable_append</a>(cat, var);
<a name="l00199"></a>00199          }
<a name="l00200"></a>00200       }
<a name="l00201"></a>00201       <a class="code" href="config_8h.html#ab7b56ec66b058952423f313752c734e7">ast_category_append</a>(cfg, cat);
<a name="l00202"></a>00202    }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 exit_multi:
<a name="l00205"></a>00205    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buffer);
<a name="l00206"></a>00206    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00207"></a>00207    <span class="keywordflow">return</span> cfg;
<a name="l00208"></a>00208 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1fb05f8c2064f3ca872685ffd3f19f81"></a><!-- doxytag: member="res_config_curl.c::require_curl" ref="a1fb05f8c2064f3ca872685ffd3f19f81" args="(const char *url, const char *unused, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int require_curl </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>url</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>unused</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00472">472</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l03202">ast_custom_function_find()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="utils_8c_source.html#l00383">ast_uri_encode()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="pbx_8c_source.html#l03598">pbx_substitute_variables_helper()</a>, <a class="el" href="config_8h_source.html#l00066">RQ_CHAR</a>, <a class="el" href="config_8h_source.html#l00068">RQ_DATE</a>, <a class="el" href="config_8h_source.html#l00069">RQ_DATETIME</a>, <a class="el" href="config_8h_source.html#l00067">RQ_FLOAT</a>, <a class="el" href="config_8h_source.html#l00056">RQ_INTEGER1</a>, <a class="el" href="config_8h_source.html#l00058">RQ_INTEGER2</a>, <a class="el" href="config_8h_source.html#l00060">RQ_INTEGER3</a>, <a class="el" href="config_8h_source.html#l00062">RQ_INTEGER4</a>, <a class="el" href="config_8h_source.html#l00064">RQ_INTEGER8</a>, <a class="el" href="config_8h_source.html#l00057">RQ_UINTEGER1</a>, <a class="el" href="config_8h_source.html#l00059">RQ_UINTEGER2</a>, <a class="el" href="config_8h_source.html#l00061">RQ_UINTEGER3</a>, <a class="el" href="config_8h_source.html#l00063">RQ_UINTEGER4</a>, <a class="el" href="config_8h_source.html#l00065">RQ_UINTEGER8</a>, and <a class="el" href="evt_8c_source.html#l00071">type</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00473"></a>00473 {
<a name="l00474"></a>00474    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *query;
<a name="l00475"></a>00475    <span class="keywordtype">char</span> *elm, field[256], buffer[128];
<a name="l00476"></a>00476    <span class="keywordtype">int</span> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, size;
<a name="l00477"></a>00477    <span class="keyword">const</span> <span class="keywordtype">int</span> EncodeSpecialChars = 1;
<a name="l00478"></a>00478 
<a name="l00479"></a>00479    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a5e0f8c2ce2a3c8994648254799a0c3b7">ast_custom_function_find</a>(<span class="stringliteral">&quot;CURL&quot;</span>)) {
<a name="l00480"></a>00480       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;func_curl.so must be loaded in order to use res_config_curl.so!!\n&quot;</span>);
<a name="l00481"></a>00481       <span class="keywordflow">return</span> -1;
<a name="l00482"></a>00482    }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484    <span class="keywordflow">if</span> (!(query = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(100))) {
<a name="l00485"></a>00485       <span class="keywordflow">return</span> -1;
<a name="l00486"></a>00486    }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;query, 0, <span class="stringliteral">&quot;${CURL(%s/require,&quot;</span>, <a class="code" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>);
<a name="l00489"></a>00489 
<a name="l00490"></a>00490    <span class="keywordflow">while</span> ((elm = va_arg(ap, <span class="keywordtype">char</span> *))) {
<a name="l00491"></a>00491       type = va_arg(ap, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3" title="Types used in ast_realtime_require_field.">require_type</a>);
<a name="l00492"></a>00492       size = va_arg(ap, <span class="keywordtype">int</span>);
<a name="l00493"></a>00493       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(elm, field, <span class="keyword">sizeof</span>(field), EncodeSpecialChars);
<a name="l00494"></a>00494       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;%s=%s%%3A%d&quot;</span>, field,
<a name="l00495"></a>00495          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a> ? <span class="stringliteral">&quot;char&quot;</span> :
<a name="l00496"></a>00496          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a7b4a9e81298a296d3e066ed369727cc4">RQ_INTEGER1</a> ? <span class="stringliteral">&quot;integer1&quot;</span> :
<a name="l00497"></a>00497          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3ae8c94d6fa08e17f6f86792727b201bf9">RQ_UINTEGER1</a> ? <span class="stringliteral">&quot;uinteger1&quot;</span> :
<a name="l00498"></a>00498          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3af1d7dd0d3aacafdef0d2f0d2db6d7112">RQ_INTEGER2</a> ? <span class="stringliteral">&quot;integer2&quot;</span> :
<a name="l00499"></a>00499          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1ab15af464bf1838c9ca91d32ca7a2a1">RQ_UINTEGER2</a> ? <span class="stringliteral">&quot;uinteger2&quot;</span> :
<a name="l00500"></a>00500          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a75d046b2f103381a62aeb81f42550404">RQ_INTEGER3</a> ? <span class="stringliteral">&quot;integer3&quot;</span> :
<a name="l00501"></a>00501          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3ad3163600ec26815e26092d9eb3e4b0b5">RQ_UINTEGER3</a> ? <span class="stringliteral">&quot;uinteger3&quot;</span> :
<a name="l00502"></a>00502          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a8a9fbbd166ee4918cec8c9303fde70e8">RQ_INTEGER4</a> ? <span class="stringliteral">&quot;integer4&quot;</span> :
<a name="l00503"></a>00503          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a27acda71d87003db19a6e0b4193a32be">RQ_UINTEGER4</a> ? <span class="stringliteral">&quot;uinteger4&quot;</span> :
<a name="l00504"></a>00504          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3aaa7be840b4634cc84021f0c20a17275b">RQ_INTEGER8</a> ? <span class="stringliteral">&quot;integer8&quot;</span> :
<a name="l00505"></a>00505          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a2e4fb4c24a3958e2fbd853d5c53cfbb4">RQ_UINTEGER8</a> ? <span class="stringliteral">&quot;uinteger8&quot;</span> :
<a name="l00506"></a>00506          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a3d3293675f377a4398a25974cba3e7e1">RQ_DATE</a> ? <span class="stringliteral">&quot;date&quot;</span> :
<a name="l00507"></a>00507          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3acf1d0ae3a1d0e3ae12a1f05f485f07c9">RQ_DATETIME</a> ? <span class="stringliteral">&quot;datetime&quot;</span> :
<a name="l00508"></a>00508          type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1133e08bb8b498770188f728ca03e417">RQ_FLOAT</a> ? <span class="stringliteral">&quot;float&quot;</span> :
<a name="l00509"></a>00509          <span class="stringliteral">&quot;unknown&quot;</span>, size);
<a name="l00510"></a>00510    }
<a name="l00511"></a>00511    va_end(ap);
<a name="l00512"></a>00512 
<a name="l00513"></a>00513    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;)}&quot;</span>);
<a name="l00514"></a>00514    <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(query), buffer, <span class="keyword">sizeof</span>(buffer));
<a name="l00515"></a>00515    <span class="keywordflow">return</span> atoi(buffer);
<a name="l00516"></a>00516 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="afadcecbaf4ea7e2252c80f55b839fc27"></a><!-- doxytag: member="res_config_curl.c::store_curl" ref="afadcecbaf4ea7e2252c80f55b839fc27" args="(const char *url, const char *unused, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int store_curl </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>url</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>unused</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Execute an INSERT query. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>url</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>unused</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ap</em>&nbsp;</td><td>list containing one or more field/value set(s)</td></tr>
  </table>
  </dd>
</dl>
<p>Insert a new record into database table, prepare the sql statement. All <a class="el" href="structvalues.html">values</a> to be changed are stored in ap list. Sub-in the <a class="el" href="structvalues.html">values</a> to the prepared statement and execute it.</p>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structnumber.html" title="Number structure.">number</a></em>&nbsp;</td><td>of rows affected </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00354">354</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l03202">ast_custom_function_find()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astmm_8h_source.html#l00081">ast_malloc</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="utils_8c_source.html#l00383">ast_uri_encode()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="pbx_8c_source.html#l03598">pbx_substitute_variables_helper()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00355"></a>00355 {
<a name="l00356"></a>00356    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *query;
<a name="l00357"></a>00357    <span class="keywordtype">char</span> buf1[200], buf2[200];
<a name="l00358"></a>00358    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00359"></a>00359    <span class="keywordtype">char</span> *stringp;
<a name="l00360"></a>00360    <span class="keywordtype">int</span> i, rowcount = -1;
<a name="l00361"></a>00361    <span class="keyword">const</span> <span class="keywordtype">int</span> EncodeSpecialChars = 1, bufsize = 100;
<a name="l00362"></a>00362    <span class="keywordtype">char</span> *buffer;
<a name="l00363"></a>00363 
<a name="l00364"></a>00364    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a5e0f8c2ce2a3c8994648254799a0c3b7">ast_custom_function_find</a>(<span class="stringliteral">&quot;CURL&quot;</span>)) {
<a name="l00365"></a>00365       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;func_curl.so must be loaded in order to use res_config_curl.so!!\n&quot;</span>);
<a name="l00366"></a>00366       <span class="keywordflow">return</span> -1;
<a name="l00367"></a>00367    }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369    <span class="keywordflow">if</span> (!(query = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(1000)))
<a name="l00370"></a>00370       <span class="keywordflow">return</span> -1;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372    <span class="keywordflow">if</span> (!(buffer = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(bufsize))) {
<a name="l00373"></a>00373       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00374"></a>00374       <span class="keywordflow">return</span> -1;
<a name="l00375"></a>00375    }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;query, 0, <span class="stringliteral">&quot;${CURL(%s/store,&quot;</span>, <a class="code" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>);
<a name="l00378"></a>00378 
<a name="l00379"></a>00379    <span class="keywordflow">for</span> (i = 0; (newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *)); i++) {
<a name="l00380"></a>00380       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00381"></a>00381       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(newparam, buf1, <span class="keyword">sizeof</span>(buf1), EncodeSpecialChars);
<a name="l00382"></a>00382       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(newval, buf2, <span class="keyword">sizeof</span>(buf2), EncodeSpecialChars);
<a name="l00383"></a>00383       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;%s%s=%s&quot;</span>, i &gt; 0 ? <span class="stringliteral">&quot;&amp;&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, buf1, buf2);
<a name="l00384"></a>00384    }
<a name="l00385"></a>00385    va_end(ap);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;)}&quot;</span>);
<a name="l00388"></a>00388    <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(query), buffer, bufsize);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390    stringp = buffer;
<a name="l00391"></a>00391    <span class="keywordflow">while</span> (*stringp &lt;= <span class="charliteral">&apos; &apos;</span>)
<a name="l00392"></a>00392       stringp++;
<a name="l00393"></a>00393    sscanf(stringp, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;rowcount);
<a name="l00394"></a>00394 
<a name="l00395"></a>00395    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buffer);
<a name="l00396"></a>00396    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00397"></a>00397 
<a name="l00398"></a>00398    <span class="keywordflow">if</span> (rowcount &gt;= 0)
<a name="l00399"></a>00399       <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)rowcount;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401    <span class="keywordflow">return</span> -1;
<a name="l00402"></a>00402 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad09fa931f468002152a3cc2d5ce25eae"></a><!-- doxytag: member="res_config_curl.c::unload_module" ref="ad09fa931f468002152a3cc2d5ce25eae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unload_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00605">605</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

<p>References <a class="el" href="config_8c_source.html#l01969">ast_config_engine_deregister()</a>, and <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00606"></a>00606 {
<a name="l00607"></a>00607    <a class="code" href="config_8h.html#a7028ff4b11d7167ee4030b4d3e123d76" title="Deregister config engine.">ast_config_engine_deregister</a>(&amp;<a class="code" href="res__config__curl_8c.html#a1b46c7d9dcc38d53fe2510276bd6db83">curl_engine</a>);
<a name="l00608"></a>00608    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;res_config_curl unloaded.\n&quot;</span>);
<a name="l00609"></a>00609    <span class="keywordflow">return</span> 0;
<a name="l00610"></a>00610 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a50bc909e09b1f0203d7806bf5bfe9bf3"></a><!-- doxytag: member="res_config_curl.c::update2_curl" ref="a50bc909e09b1f0203d7806bf5bfe9bf3" args="(const char *url, const char *unused, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int update2_curl </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>url</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>unused</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00278">278</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l03202">ast_custom_function_find()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astmm_8h_source.html#l00081">ast_malloc</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="utils_8c_source.html#l00383">ast_uri_encode()</a>, <a class="el" href="devicestate_8c_source.html#l00198">first</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="pbx_8c_source.html#l03598">pbx_substitute_variables_helper()</a>, and <a class="el" href="compiler_8h_source.html#l00069">SENTINEL</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00279"></a>00279 {
<a name="l00280"></a>00280    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *query;
<a name="l00281"></a>00281    <span class="keywordtype">char</span> buf1[200], buf2[200];
<a name="l00282"></a>00282    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00283"></a>00283    <span class="keywordtype">char</span> *stringp;
<a name="l00284"></a>00284    <span class="keywordtype">int</span> rowcount = -1, lookup = 1, <a class="code" href="devicestate_8c.html#abd2135e6f8a41bc900933b1985d97165">first</a> = 1;
<a name="l00285"></a>00285    <span class="keyword">const</span> <span class="keywordtype">int</span> EncodeSpecialChars = 1, bufsize = 100;
<a name="l00286"></a>00286    <span class="keywordtype">char</span> *buffer;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a5e0f8c2ce2a3c8994648254799a0c3b7">ast_custom_function_find</a>(<span class="stringliteral">&quot;CURL&quot;</span>)) {
<a name="l00289"></a>00289       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;func_curl.so must be loaded in order to use res_config_curl.so!!\n&quot;</span>);
<a name="l00290"></a>00290       <span class="keywordflow">return</span> -1;
<a name="l00291"></a>00291    }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293    <span class="keywordflow">if</span> (!(query = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(1000)))
<a name="l00294"></a>00294       <span class="keywordflow">return</span> -1;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296    <span class="keywordflow">if</span> (!(buffer = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(bufsize))) {
<a name="l00297"></a>00297       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00298"></a>00298       <span class="keywordflow">return</span> -1;
<a name="l00299"></a>00299    }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;query, 0, <span class="stringliteral">&quot;${CURL(%s/update?&quot;</span>, <a class="code" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>);
<a name="l00302"></a>00302 
<a name="l00303"></a>00303    <span class="keywordflow">for</span> (;;) {
<a name="l00304"></a>00304       <span class="keywordflow">if</span> ((newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *)) == <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>) {
<a name="l00305"></a>00305          <span class="keywordflow">if</span> (lookup) {
<a name="l00306"></a>00306             lookup = 0;
<a name="l00307"></a>00307             <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l00308"></a>00308             <span class="comment">/* Back to the first parameter; we don&apos;t need a starting &apos;&amp;&apos; */</span>
<a name="l00309"></a>00309             <a class="code" href="devicestate_8c.html#abd2135e6f8a41bc900933b1985d97165">first</a> = 1;
<a name="l00310"></a>00310             <span class="keywordflow">continue</span>;
<a name="l00311"></a>00311          } <span class="keywordflow">else</span> {
<a name="l00312"></a>00312             <span class="keywordflow">break</span>;
<a name="l00313"></a>00313          }
<a name="l00314"></a>00314       }
<a name="l00315"></a>00315       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00316"></a>00316       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(newparam, buf1, <span class="keyword">sizeof</span>(buf1), EncodeSpecialChars);
<a name="l00317"></a>00317       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(newval, buf2, <span class="keyword">sizeof</span>(buf2), EncodeSpecialChars);
<a name="l00318"></a>00318       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;%s%s=%s&quot;</span>, <a class="code" href="devicestate_8c.html#abd2135e6f8a41bc900933b1985d97165">first</a> ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;&amp;&quot;</span>, buf1, buf2);
<a name="l00319"></a>00319    }
<a name="l00320"></a>00320    va_end(ap);
<a name="l00321"></a>00321 
<a name="l00322"></a>00322    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;)}&quot;</span>);
<a name="l00323"></a>00323    <span class="comment">/* TODO: Make proxies work */</span>
<a name="l00324"></a>00324    <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(query), buffer, bufsize);
<a name="l00325"></a>00325 
<a name="l00326"></a>00326    <span class="comment">/* Line oriented output */</span>
<a name="l00327"></a>00327    stringp = buffer;
<a name="l00328"></a>00328    <span class="keywordflow">while</span> (*stringp &lt;= <span class="charliteral">&apos; &apos;</span>)
<a name="l00329"></a>00329       stringp++;
<a name="l00330"></a>00330    sscanf(stringp, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;rowcount);
<a name="l00331"></a>00331 
<a name="l00332"></a>00332    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buffer);
<a name="l00333"></a>00333    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335    <span class="keywordflow">if</span> (rowcount &gt;= 0)
<a name="l00336"></a>00336       <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)rowcount;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338    <span class="keywordflow">return</span> -1;
<a name="l00339"></a>00339 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a68a5c3694627aedd19a614da83306af7"></a><!-- doxytag: member="res_config_curl.c::update_curl" ref="a68a5c3694627aedd19a614da83306af7" args="(const char *url, const char *unused, const char *keyfield, const char *lookup, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int update_curl </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>url</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>unused</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>keyfield</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>lookup</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Execute an UPDATE query. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>url</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>unused</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>keyfield</em>&nbsp;</td><td>where clause field </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>lookup</em>&nbsp;</td><td>value of field for where clause </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ap</em>&nbsp;</td><td>list containing one or more field/value set(s).</td></tr>
  </table>
  </dd>
</dl>
<p>Update a database table, prepare the sql statement using keyfield and lookup control the <a class="el" href="structnumber.html" title="Number structure.">number</a> of records to change. All <a class="el" href="structvalues.html">values</a> to be changed are stored in ap list. Sub-in the <a class="el" href="structvalues.html">values</a> to the prepared statement and execute it.</p>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structnumber.html" title="Number structure.">number</a></em>&nbsp;</td><td>of rows affected </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00225">225</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l03202">ast_custom_function_find()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astmm_8h_source.html#l00081">ast_malloc</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="utils_8c_source.html#l00383">ast_uri_encode()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="pbx_8c_source.html#l03598">pbx_substitute_variables_helper()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00226"></a>00226 {
<a name="l00227"></a>00227    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *query;
<a name="l00228"></a>00228    <span class="keywordtype">char</span> buf1[200], buf2[200];
<a name="l00229"></a>00229    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00230"></a>00230    <span class="keywordtype">char</span> *stringp;
<a name="l00231"></a>00231    <span class="keywordtype">int</span> i, rowcount = -1;
<a name="l00232"></a>00232    <span class="keyword">const</span> <span class="keywordtype">int</span> EncodeSpecialChars = 1, bufsize = 100;
<a name="l00233"></a>00233    <span class="keywordtype">char</span> *buffer;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a5e0f8c2ce2a3c8994648254799a0c3b7">ast_custom_function_find</a>(<span class="stringliteral">&quot;CURL&quot;</span>)) {
<a name="l00236"></a>00236       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;func_curl.so must be loaded in order to use res_config_curl.so!!\n&quot;</span>);
<a name="l00237"></a>00237       <span class="keywordflow">return</span> -1;
<a name="l00238"></a>00238    }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240    <span class="keywordflow">if</span> (!(query = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(1000)))
<a name="l00241"></a>00241       <span class="keywordflow">return</span> -1;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243    <span class="keywordflow">if</span> (!(buffer = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(bufsize))) {
<a name="l00244"></a>00244       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00245"></a>00245       <span class="keywordflow">return</span> -1;
<a name="l00246"></a>00246    }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248    <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(keyfield, buf1, <span class="keyword">sizeof</span>(buf1), EncodeSpecialChars);
<a name="l00249"></a>00249    <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(lookup, buf2, <span class="keyword">sizeof</span>(buf2), EncodeSpecialChars);
<a name="l00250"></a>00250    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;query, 0, <span class="stringliteral">&quot;${CURL(%s/update?%s=%s,&quot;</span>, <a class="code" href="res__config__ldap_8c.html#a75e4590043edf35241d30fabe2eda546">url</a>, buf1, buf2);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252    <span class="keywordflow">for</span> (i = 0; (newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *)); i++) {
<a name="l00253"></a>00253       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00254"></a>00254       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(newparam, buf1, <span class="keyword">sizeof</span>(buf1), EncodeSpecialChars);
<a name="l00255"></a>00255       <a class="code" href="utils_8h.html#a4736440328d6809ea8d9f57c0606f253" title="Turn text string to URI-encoded XX version.">ast_uri_encode</a>(newval, buf2, <span class="keyword">sizeof</span>(buf2), EncodeSpecialChars);
<a name="l00256"></a>00256       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;%s%s=%s&quot;</span>, i &gt; 0 ? <span class="stringliteral">&quot;&amp;&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, buf1, buf2);
<a name="l00257"></a>00257    }
<a name="l00258"></a>00258    va_end(ap);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;query, 0, <span class="stringliteral">&quot;)}&quot;</span>);
<a name="l00261"></a>00261    <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(query), buffer, bufsize);
<a name="l00262"></a>00262 
<a name="l00263"></a>00263    <span class="comment">/* Line oriented output */</span>
<a name="l00264"></a>00264    stringp = buffer;
<a name="l00265"></a>00265    <span class="keywordflow">while</span> (*stringp &lt;= <span class="charliteral">&apos; &apos;</span>)
<a name="l00266"></a>00266       stringp++;
<a name="l00267"></a>00267    sscanf(stringp, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;rowcount);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buffer);
<a name="l00270"></a>00270    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(query);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272    <span class="keywordflow">if</span> (rowcount &gt;= 0)
<a name="l00273"></a>00273       <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)rowcount;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275    <span class="keywordflow">return</span> -1;
<a name="l00276"></a>00276 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="ab22f32016155f7f403e7178767163d7d"></a><!-- doxytag: member="res_config_curl.c::__mod_info" ref="ab22f32016155f7f403e7178767163d7d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a> <a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_DEFAULT , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;Realtime Curl configuration&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00626">626</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

</div>
</div>
<a class="anchor" id="ae25b9f3970870610911f8850897e8ead"></a><!-- doxytag: member="res_config_curl.c::ast_module_info" ref="ae25b9f3970870610911f8850897e8ead" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a>* <a class="el" href="structast__module__info.html">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00626">626</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

</div>
</div>
<a class="anchor" id="a1b46c7d9dcc38d53fe2510276bd6db83"></a><!-- doxytag: member="res_config_curl.c::curl_engine" ref="a1b46c7d9dcc38d53fe2510276bd6db83" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__config__engine.html">ast_config_engine</a> <a class="el" href="res__config__curl_8c.html#a1b46c7d9dcc38d53fe2510276bd6db83">curl_engine</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__curl_8c_source.html#l00593">593</a> of file <a class="el" href="res__config__curl_8c_source.html">res_config_curl.c</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:23:09 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
