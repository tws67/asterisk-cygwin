<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:23:31 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_1ab815038f534adda65c8b4ae4993449.html">include</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_16d825f1fa9ecca2e70b1a8d9256d0e6.html">asterisk</a>
  </div>
</div>
<div class="contents">
<h1>taskprocessor.h File Reference</h1>
<p>An API for managing task processing threads that can be shared across modules.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="lock_8h_source.html">asterisk/lock.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="linkedlists_8h_source.html">asterisk/linkedlists.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="options_8h_source.html">asterisk/options.h</a>&quot;</code><br/>

<p><a href="taskprocessor_8h_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="taskprocessor_8h.html#a42ae78df3dc5106c133bf2f7b72080f7">ast_tps_options</a> { <a class="el" href="taskprocessor_8h.html#a42ae78df3dc5106c133bf2f7b72080f7ae248d04bb7a6b5e0906e4906af4ee35a">TPS_REF_DEFAULT</a> =  0, 
<a class="el" href="taskprocessor_8h.html#a42ae78df3dc5106c133bf2f7b72080f7abe990199e3796a0f60ff62ab1e36e3c0">TPS_REF_IF_EXISTS</a> =  (1 &lt;&lt; 0)
 }</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><p>ast_tps_options for specification of taskprocessor options </p>
 <a href="taskprocessor_8h.html#a42ae78df3dc5106c133bf2f7b72080f7">More...</a><br/></td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__taskprocessor.html">ast_taskprocessor</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="taskprocessor_8h.html#a3d670ce6d9ed07b5db0dae8d2c11d275">ast_taskprocessor_get</a> (char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, enum <a class="el" href="taskprocessor_8h.html#a42ae78df3dc5106c133bf2f7b72080f7">ast_tps_options</a> create)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get a reference to a taskprocessor with the specified name and create the taskprocessor if necessary.  <a href="#a3d670ce6d9ed07b5db0dae8d2c11d275"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">const char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="taskprocessor_8h.html#aaa6541086de52447afa994cbfcb792ec">ast_taskprocessor_name</a> (struct <a class="el" href="structast__taskprocessor.html">ast_taskprocessor</a> *tps)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Return the name of the taskprocessor singleton.  <a href="#aaa6541086de52447afa994cbfcb792ec"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="taskprocessor_8h.html#a815e690b2db467f47655ebaa5d85fb69">ast_taskprocessor_push</a> (struct <a class="el" href="structast__taskprocessor.html">ast_taskprocessor</a> *tps, int(*task_exe)(void *datap), void *datap)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Push a task into the specified taskprocessor queue and signal the taskprocessor thread.  <a href="#a815e690b2db467f47655ebaa5d85fb69"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="taskprocessor_8h.html#a32492eb2480cb8c46ad669622cff8556">ast_taskprocessor_unreference</a> (struct <a class="el" href="structast__taskprocessor.html">ast_taskprocessor</a> *tps)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Unreference the specified taskprocessor and its reference count will decrement.  <a href="#a32492eb2480cb8c46ad669622cff8556"></a><br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>An API for managing task processing threads that can be shared across modules. </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Dwayne M. Hubbard &lt;<a href="mailto:dhubbard@digium.com">dhubbard@digium.com</a>&gt;</dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>A taskprocessor is a named singleton containing a processing thread and a task queue that serializes tasks pushed into it by [a] module(s) that reference the taskprocessor. A taskprocessor is created the first time its name is requested via the <a class="el" href="taskprocessor_8h.html#a3d670ce6d9ed07b5db0dae8d2c11d275" title="Get a reference to a taskprocessor with the specified name and create the taskprocessor...">ast_taskprocessor_get()</a> function and destroyed when the taskprocessor reference count reaches zero.</dd></dl>
<p>Modules that obtain a reference to a taskprocessor can queue tasks into the taskprocessor to be processed by the singleton processing thread when the task is popped off the front of the queue. A task is a wrapper around a task-handling function pointer and a data pointer. It is the responsibility of the task handling function to free memory allocated for the task data pointer. A task is pushed into a taskprocessor queue using the ast_taskprocessor_push(taskprocessor, taskhandler, taskdata) function and freed by the taskprocessor after the task handling function returns. A module releases its reference to a taskprocessor using the <a class="el" href="taskprocessor_8h.html#a32492eb2480cb8c46ad669622cff8556" title="Unreference the specified taskprocessor and its reference count will decrement.">ast_taskprocessor_unreference()</a> function which may result in the destruction of the taskprocessor if the taskprocessor's reference count reaches zero. Tasks waiting to be processed in the taskprocessor queue when the taskprocessor reference count reaches zero will be purged and released from the taskprocessor queue without being processed. </p>

<p>Definition in file <a class="el" href="taskprocessor_8h_source.html">taskprocessor.h</a>.</p>
<hr/><h2>Enumeration Type Documentation</h2>
<a class="anchor" id="a42ae78df3dc5106c133bf2f7b72080f7"></a><!-- doxytag: member="taskprocessor.h::ast_tps_options" ref="a42ae78df3dc5106c133bf2f7b72080f7" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="taskprocessor_8h.html#a42ae78df3dc5106c133bf2f7b72080f7">ast_tps_options</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>ast_tps_options for specification of taskprocessor options </p>
<p>Specify whether a taskprocessor should be created via <a class="el" href="taskprocessor_8h.html#a3d670ce6d9ed07b5db0dae8d2c11d275" title="Get a reference to a taskprocessor with the specified name and create the taskprocessor...">ast_taskprocessor_get()</a> if the taskprocessor does not already exist. The default behavior is to create a taskprocessor if it does not already exist and provide its reference to the calling function. To only return a reference to a taskprocessor if and only if it exists, use the TPS_REF_IF_EXISTS option in <a class="el" href="taskprocessor_8h.html#a3d670ce6d9ed07b5db0dae8d2c11d275" title="Get a reference to a taskprocessor with the specified name and create the taskprocessor...">ast_taskprocessor_get()</a>. </p>
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="a42ae78df3dc5106c133bf2f7b72080f7ae248d04bb7a6b5e0906e4906af4ee35a"></a><!-- doxytag: member="TPS_REF_DEFAULT" ref="a42ae78df3dc5106c133bf2f7b72080f7ae248d04bb7a6b5e0906e4906af4ee35a" args="" -->TPS_REF_DEFAULT</em>&nbsp;</td><td>
<p>return a reference to a taskprocessor, create one if it does not exist </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="a42ae78df3dc5106c133bf2f7b72080f7abe990199e3796a0f60ff62ab1e36e3c0"></a><!-- doxytag: member="TPS_REF_IF_EXISTS" ref="a42ae78df3dc5106c133bf2f7b72080f7abe990199e3796a0f60ff62ab1e36e3c0" args="" -->TPS_REF_IF_EXISTS</em>&nbsp;</td><td>
<p>return a reference to a taskprocessor ONLY if it already exists </p>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="taskprocessor_8h_source.html#l00058">58</a> of file <a class="el" href="taskprocessor_8h_source.html">taskprocessor.h</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00058"></a>00058                      {<span class="comment"></span>
<a name="l00059"></a>00059 <span class="comment">   /*! \brief return a reference to a taskprocessor, create one if it does not exist */</span>
<a name="l00060"></a>00060    <a class="code" href="taskprocessor_8h.html#a42ae78df3dc5106c133bf2f7b72080f7ae248d04bb7a6b5e0906e4906af4ee35a" title="return a reference to a taskprocessor, create one if it does not exist">TPS_REF_DEFAULT</a> = 0,<span class="comment"></span>
<a name="l00061"></a>00061 <span class="comment">   /*! \brief return a reference to a taskprocessor ONLY if it already exists */</span>
<a name="l00062"></a>00062    <a class="code" href="taskprocessor_8h.html#a42ae78df3dc5106c133bf2f7b72080f7abe990199e3796a0f60ff62ab1e36e3c0" title="return a reference to a taskprocessor ONLY if it already exists">TPS_REF_IF_EXISTS</a> = (1 &lt;&lt; 0),
<a name="l00063"></a>00063 };
</pre></div></p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a3d670ce6d9ed07b5db0dae8d2c11d275"></a><!-- doxytag: member="taskprocessor.h::ast_taskprocessor_get" ref="a3d670ce6d9ed07b5db0dae8d2c11d275" args="(char *name, enum ast_tps_options create)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__taskprocessor.html">ast_taskprocessor</a>* ast_taskprocessor_get </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="taskprocessor_8h.html#a42ae78df3dc5106c133bf2f7b72080f7">ast_tps_options</a>&nbsp;</td>
          <td class="paramname"> <em>create</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get a reference to a taskprocessor with the specified name and create the taskprocessor if necessary. </p>
<p>The default behavior of instantiating a taskprocessor if one does not already exist can be disabled by specifying the TPS_REF_IF_EXISTS ast_tps_options as the second argument to <a class="el" href="taskprocessor_8h.html#a3d670ce6d9ed07b5db0dae8d2c11d275" title="Get a reference to a taskprocessor with the specified name and create the taskprocessor...">ast_taskprocessor_get()</a>. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>name</em>&nbsp;</td><td>The name of the taskprocessor </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>create</em>&nbsp;</td><td>Use 0 by default or specify TPS_REF_IF_EXISTS to return NULL if the taskprocessor does not already exist return A pointer to a reference counted taskprocessor under normal conditions, or NULL if the TPS_REF_IF_EXISTS reference type is specified and the taskprocessor does not exist </td></tr>
  </table>
  </dd>
</dl>
<dl class="since"><dt><b>Since:</b></dt><dd>1.6.1 </dd></dl>

<p>Definition at line <a class="el" href="taskprocessor_8c_source.html#l00407">407</a> of file <a class="el" href="taskprocessor_8c_source.html">taskprocessor.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00413">ao2_alloc</a>, <a class="el" href="astobj2_8h_source.html#l00968">ao2_find</a>, <a class="el" href="astobj2_8h_source.html#l00782">ao2_link</a>, <a class="el" href="astobj2_8c_source.html#l00147">ao2_lock()</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="astobj2_8c_source.html#l00169">ao2_unlock()</a>, <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="lock_8h_source.html#l01729">ast_cond_init()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01692">ast_mutex_init()</a>, <a class="el" href="utils_8h_source.html#l00376">ast_pthread_create</a>, <a class="el" href="lock_8h_source.html#l00082">AST_PTHREADT_NULL</a>, <a class="el" href="astmm_8h_source.html#l00099">ast_strdup</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="taskprocessor_8c_source.html#l00065">ast_taskprocessor::name</a>, <a class="el" href="astobj2_8h_source.html#l00678">OBJ_POINTER</a>, <a class="el" href="taskprocessor_8c_source.html#l00067">ast_taskprocessor::poll_cond</a>, <a class="el" href="taskprocessor_8c_source.html#l00069">ast_taskprocessor::poll_thread</a>, <a class="el" href="taskprocessor_8c_source.html#l00073">ast_taskprocessor::poll_thread_run</a>, <a class="el" href="taskprocessor_8c_source.html#l00075">ast_taskprocessor::stats</a>, <a class="el" href="taskprocessor_8c_source.html#l00071">ast_taskprocessor::taskprocessor_lock</a>, <a class="el" href="taskprocessor_8c_source.html#l00275">tps_processing_function()</a>, <a class="el" href="taskprocessor_8h_source.html#l00062">TPS_REF_IF_EXISTS</a>, <a class="el" href="taskprocessor_8c_source.html#l00085">tps_singletons</a>, and <a class="el" href="taskprocessor_8c_source.html#l00346">tps_taskprocessor_destroy()</a>.</p>

<p>Referenced by <a class="el" href="event_8c_source.html#l01289">ast_event_init()</a>, <a class="el" href="taskprocessor_8c_source.html#l00189">cli_tps_ping()</a>, <a class="el" href="app__queue_8c_source.html#l07220">load_module()</a>, and <a class="el" href="pbx_8c_source.html#l09302">load_pbx()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00408"></a>00408 {
<a name="l00409"></a>00409    <span class="keyword">struct </span><a class="code" href="structast__taskprocessor.html" title="A ast_taskprocessor structure is a singleton by name.">ast_taskprocessor</a> *p, tmp_tps = {
<a name="l00410"></a>00410       .name = <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>,
<a name="l00411"></a>00411    };
<a name="l00412"></a>00412       
<a name="l00413"></a>00413    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)) {
<a name="l00414"></a>00414       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;requesting a nameless taskprocessor!!!\n&quot;</span>);
<a name="l00415"></a>00415       <span class="keywordflow">return</span> NULL;
<a name="l00416"></a>00416    }
<a name="l00417"></a>00417    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>);
<a name="l00418"></a>00418    p = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>, &amp;tmp_tps, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>);
<a name="l00419"></a>00419    <span class="keywordflow">if</span> (p) {
<a name="l00420"></a>00420       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>);
<a name="l00421"></a>00421       <span class="keywordflow">return</span> p;
<a name="l00422"></a>00422    }
<a name="l00423"></a>00423    <span class="keywordflow">if</span> (create &amp; <a class="code" href="taskprocessor_8h.html#a42ae78df3dc5106c133bf2f7b72080f7abe990199e3796a0f60ff62ab1e36e3c0" title="return a reference to a taskprocessor ONLY if it already exists">TPS_REF_IF_EXISTS</a>) {
<a name="l00424"></a>00424       <span class="comment">/* calling function does not want a new taskprocessor to be created if it doesn&apos;t already exist */</span>
<a name="l00425"></a>00425       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>);
<a name="l00426"></a>00426       <span class="keywordflow">return</span> NULL;
<a name="l00427"></a>00427    }
<a name="l00428"></a>00428    <span class="comment">/* create a new taskprocessor */</span>
<a name="l00429"></a>00429    <span class="keywordflow">if</span> (!(p = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*p), <a class="code" href="taskprocessor_8c.html#acc3d83cbcb01b65ee95618a7de03a13e" title="Destroy the taskprocessor when its refcount reaches zero.">tps_taskprocessor_destroy</a>))) {
<a name="l00430"></a>00430       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>);
<a name="l00431"></a>00431       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;failed to create taskprocessor &apos;%s&apos;\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00432"></a>00432       <span class="keywordflow">return</span> NULL;
<a name="l00433"></a>00433    }
<a name="l00434"></a>00434 
<a name="l00435"></a>00435    <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;p-&gt;<a class="code" href="structast__taskprocessor.html#acf07ed2eba262b9d8580db31f6a0bd1f" title="Thread poll condition.">poll_cond</a>, NULL);
<a name="l00436"></a>00436    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;p-&gt;<a class="code" href="structast__taskprocessor.html#a14833ae8a60cf5fc6cc6c86f0d3a9c23" title="Taskprocessor lock.">taskprocessor_lock</a>);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438    <span class="keywordflow">if</span> (!(p-&gt;<a class="code" href="structast__taskprocessor.html#a6de39dfd1d209b9ac5f4225f42942f2b" title="Taskprocessor statistics.">stats</a> = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*p-&gt;<a class="code" href="structast__taskprocessor.html#a6de39dfd1d209b9ac5f4225f42942f2b" title="Taskprocessor statistics.">stats</a>)))) {
<a name="l00439"></a>00439       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>);
<a name="l00440"></a>00440       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;failed to create taskprocessor stats for &apos;%s&apos;\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00441"></a>00441       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(p, -1);
<a name="l00442"></a>00442       <span class="keywordflow">return</span> NULL;
<a name="l00443"></a>00443    }
<a name="l00444"></a>00444    <span class="keywordflow">if</span> (!(p-&gt;<a class="code" href="structast__taskprocessor.html#a5ac083a645d964373f022d03df4849c8" title="Friendly name of the taskprocessor.">name</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>))) {
<a name="l00445"></a>00445       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>);
<a name="l00446"></a>00446       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(p, -1);
<a name="l00447"></a>00447       <span class="keywordflow">return</span> NULL;
<a name="l00448"></a>00448    }
<a name="l00449"></a>00449    p-&gt;<a class="code" href="structast__taskprocessor.html#aa3e040b5c57658872817f5859bc653d4" title="Taskprocesor thread run flag.">poll_thread_run</a> = 1;
<a name="l00450"></a>00450    p-&gt;<a class="code" href="structast__taskprocessor.html#a495591a348e5b9edcf4be80cb688ca89" title="Taskprocessor thread.">poll_thread</a> = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l00451"></a>00451    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a4781fd54a4ca8c7f0f8a32a6cce503c0">ast_pthread_create</a>(&amp;p-&gt;<a class="code" href="structast__taskprocessor.html#a495591a348e5b9edcf4be80cb688ca89" title="Taskprocessor thread.">poll_thread</a>, NULL, <a class="code" href="taskprocessor_8c.html#a3f719aa88f8575f80e79e43f38acdc98" title="The task processing function executed by a taskprocessor.">tps_processing_function</a>, p) &lt; 0) {
<a name="l00452"></a>00452       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>);
<a name="l00453"></a>00453       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Taskprocessor &apos;%s&apos; failed to create the processing thread.\n&quot;</span>, p-&gt;<a class="code" href="structast__taskprocessor.html#a5ac083a645d964373f022d03df4849c8" title="Friendly name of the taskprocessor.">name</a>);
<a name="l00454"></a>00454       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(p, -1);
<a name="l00455"></a>00455       <span class="keywordflow">return</span> NULL;
<a name="l00456"></a>00456    }
<a name="l00457"></a>00457    <span class="keywordflow">if</span> (!(<a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>, p))) {
<a name="l00458"></a>00458       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>);
<a name="l00459"></a>00459       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to add taskprocessor &apos;%s&apos; to container\n&quot;</span>, p-&gt;<a class="code" href="structast__taskprocessor.html#a5ac083a645d964373f022d03df4849c8" title="Friendly name of the taskprocessor.">name</a>);
<a name="l00460"></a>00460       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(p, -1);
<a name="l00461"></a>00461       <span class="keywordflow">return</span> NULL;
<a name="l00462"></a>00462    }
<a name="l00463"></a>00463    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>);
<a name="l00464"></a>00464    <span class="keywordflow">return</span> p;
<a name="l00465"></a>00465 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aaa6541086de52447afa994cbfcb792ec"></a><!-- doxytag: member="taskprocessor.h::ast_taskprocessor_name" ref="aaa6541086de52447afa994cbfcb792ec" args="(struct ast_taskprocessor *tps)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* ast_taskprocessor_name </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__taskprocessor.html">ast_taskprocessor</a> *&nbsp;</td>
          <td class="paramname"> <em>tps</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Return the name of the taskprocessor singleton. </p>
<dl class="since"><dt><b>Since:</b></dt><dd>1.6.1 </dd></dl>

<p>Definition at line <a class="el" href="taskprocessor_8c_source.html#l00395">395</a> of file <a class="el" href="taskprocessor_8c_source.html">taskprocessor.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="taskprocessor_8c_source.html#l00065">ast_taskprocessor::name</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00396"></a>00396 {
<a name="l00397"></a>00397    <span class="keywordflow">if</span> (!tps) {
<a name="l00398"></a>00398       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;no taskprocessor specified!\n&quot;</span>);
<a name="l00399"></a>00399       <span class="keywordflow">return</span> NULL;
<a name="l00400"></a>00400    }
<a name="l00401"></a>00401    <span class="keywordflow">return</span> tps-&gt;<a class="code" href="structast__taskprocessor.html#a5ac083a645d964373f022d03df4849c8" title="Friendly name of the taskprocessor.">name</a>;
<a name="l00402"></a>00402 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a815e690b2db467f47655ebaa5d85fb69"></a><!-- doxytag: member="taskprocessor.h::ast_taskprocessor_push" ref="a815e690b2db467f47655ebaa5d85fb69" args="(struct ast_taskprocessor *tps, int(*task_exe)(void *datap), void *datap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_taskprocessor_push </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__taskprocessor.html">ast_taskprocessor</a> *&nbsp;</td>
          <td class="paramname"> <em>tps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int(*)(void *datap)&nbsp;</td>
          <td class="paramname"> <em>task_exe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>datap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Push a task into the specified taskprocessor queue and signal the taskprocessor thread. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>tps</em>&nbsp;</td><td>The taskprocessor structure </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>task_exe</em>&nbsp;</td><td>The task handling function to push into the taskprocessor queue </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>datap</em>&nbsp;</td><td>The data to be used by the task handling function </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>zero on success, -1 on failure </dd></dl>
<dl class="since"><dt><b>Since:</b></dt><dd>1.6.1 </dd></dl>

<p>Definition at line <a class="el" href="taskprocessor_8c_source.html#l00482">482</a> of file <a class="el" href="taskprocessor_8c_source.html">taskprocessor.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01734">ast_cond_signal()</a>, <a class="el" href="linkedlists_8h_source.html#l00715">AST_LIST_INSERT_TAIL</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="taskprocessor_8c_source.html#l00065">ast_taskprocessor::name</a>, <a class="el" href="taskprocessor_8c_source.html#l00067">ast_taskprocessor::poll_cond</a>, <a class="el" href="taskprocessor_8c_source.html#l00071">ast_taskprocessor::taskprocessor_lock</a>, <a class="el" href="structast__taskprocessor.html#a0d22cef450efe10d63951ee1fcc39599">ast_taskprocessor::tps_queue</a>, <a class="el" href="taskprocessor_8c_source.html#l00077">ast_taskprocessor::tps_queue_size</a>, and <a class="el" href="taskprocessor_8c_source.html#l00136">tps_task_alloc()</a>.</p>

<p>Referenced by <a class="el" href="event_8c_source.html#l01153">ast_event_queue()</a>, <a class="el" href="taskprocessor_8c_source.html#l00189">cli_tps_ping()</a>, <a class="el" href="app__queue_8c_source.html#l01090">device_state_cb()</a>, <a class="el" href="app__voicemail_8c_source.html#l10372">mwi_sub_event_cb()</a>, and <a class="el" href="app__voicemail_8c_source.html#l10356">mwi_unsub_event_cb()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00483"></a>00483 {
<a name="l00484"></a>00484    <span class="keyword">struct </span><a class="code" href="structtps__task.html" title="tps_task structure is queued to a taskprocessor">tps_task</a> *t;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486    <span class="keywordflow">if</span> (!tps || !task_exe) {
<a name="l00487"></a>00487       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;%s is missing!!\n&quot;</span>, (tps) ? <span class="stringliteral">&quot;task callback&quot;</span> : <span class="stringliteral">&quot;taskprocessor&quot;</span>);
<a name="l00488"></a>00488       <span class="keywordflow">return</span> -1;
<a name="l00489"></a>00489    }
<a name="l00490"></a>00490    <span class="keywordflow">if</span> (!(t = <a class="code" href="taskprocessor_8c.html#a1e47192322efd29dd1b30c9f1adc9f52">tps_task_alloc</a>(task_exe, <a class="code" href="structtps__task.html#aeb5cadc7793d3e5ed0c725dbb3c04491" title="The data pointer for the task execute() function.">datap</a>))) {
<a name="l00491"></a>00491       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;failed to allocate task!  Can&apos;t push to &apos;%s&apos;\n&quot;</span>, tps-&gt;<a class="code" href="structast__taskprocessor.html#a5ac083a645d964373f022d03df4849c8" title="Friendly name of the taskprocessor.">name</a>);
<a name="l00492"></a>00492       <span class="keywordflow">return</span> -1;
<a name="l00493"></a>00493    }
<a name="l00494"></a>00494    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;tps-&gt;<a class="code" href="structast__taskprocessor.html#a14833ae8a60cf5fc6cc6c86f0d3a9c23" title="Taskprocessor lock.">taskprocessor_lock</a>);
<a name="l00495"></a>00495    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;tps-&gt;<a class="code" href="structast__taskprocessor.html#a0d22cef450efe10d63951ee1fcc39599" title="Taskprocessor queue.">tps_queue</a>, t, <a class="code" href="structtps__task.html#aeaa78c5923135b517a8d1635a163e578" title="AST_LIST_ENTRY overhead.">list</a>);
<a name="l00496"></a>00496    tps-&gt;<a class="code" href="structast__taskprocessor.html#afe2dfc83eb5b460f39e9e5513023e74e" title="Taskprocessor current queue size.">tps_queue_size</a>++;
<a name="l00497"></a>00497    <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;tps-&gt;<a class="code" href="structast__taskprocessor.html#acf07ed2eba262b9d8580db31f6a0bd1f" title="Thread poll condition.">poll_cond</a>);
<a name="l00498"></a>00498    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;tps-&gt;<a class="code" href="structast__taskprocessor.html#a14833ae8a60cf5fc6cc6c86f0d3a9c23" title="Taskprocessor lock.">taskprocessor_lock</a>);
<a name="l00499"></a>00499    <span class="keywordflow">return</span> 0;
<a name="l00500"></a>00500 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a32492eb2480cb8c46ad669622cff8556"></a><!-- doxytag: member="taskprocessor.h::ast_taskprocessor_unreference" ref="a32492eb2480cb8c46ad669622cff8556" args="(struct ast_taskprocessor *tps)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* ast_taskprocessor_unreference </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__taskprocessor.html">ast_taskprocessor</a> *&nbsp;</td>
          <td class="paramname"> <em>tps</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Unreference the specified taskprocessor and its reference count will decrement. </p>
<p>Taskprocessors use <a class="el" href="structastobj2.html">astobj2</a> and will unlink from the taskprocessor singleton container and destroy themself when the taskprocessor reference count reaches zero. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>tps</em>&nbsp;</td><td>taskprocessor to unreference </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>NULL </dd></dl>
<dl class="since"><dt><b>Since:</b></dt><dd>1.6.1 </dd></dl>

<p>Definition at line <a class="el" href="taskprocessor_8c_source.html#l00468">468</a> of file <a class="el" href="taskprocessor_8c_source.html">taskprocessor.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00782">ao2_link</a>, <a class="el" href="astobj2_8c_source.html#l00147">ao2_lock()</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="astobj2_8h_source.html#l00813">ao2_unlink</a>, <a class="el" href="astobj2_8c_source.html#l00169">ao2_unlock()</a>, and <a class="el" href="taskprocessor_8c_source.html#l00085">tps_singletons</a>.</p>

<p>Referenced by <a class="el" href="app__queue_8c_source.html#l07170">unload_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00469"></a>00469 {
<a name="l00470"></a>00470    <span class="keywordflow">if</span> (tps) {
<a name="l00471"></a>00471       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>);
<a name="l00472"></a>00472       <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>, tps);
<a name="l00473"></a>00473       <span class="keywordflow">if</span> (<a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(tps, -1) &gt; 1) {
<a name="l00474"></a>00474          <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>, tps);
<a name="l00475"></a>00475       }
<a name="l00476"></a>00476       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="taskprocessor_8c.html#ad2465de7eb87991ce5f1d68b2de2a9e2" title="tps_singletons is the astobj2 container for taskprocessor singletons">tps_singletons</a>);
<a name="l00477"></a>00477    }
<a name="l00478"></a>00478    <span class="keywordflow">return</span> NULL;
<a name="l00479"></a>00479 }
</pre></div></p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:23:31 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
