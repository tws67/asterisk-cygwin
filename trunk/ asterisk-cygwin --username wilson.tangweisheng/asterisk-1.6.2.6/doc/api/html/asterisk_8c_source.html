<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:28 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>asterisk.c</h1><a href="asterisk_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2008, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="comment">/* Doxygenified Copyright Header */</span><span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment">/*!</span>
<a name="l00022"></a>00022 <span class="comment"> * \mainpage Asterisk -- An Open Source Telephony Toolkit</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * \par Developer Documentation for Asterisk</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * This is the main developer documentation for Asterisk. It is </span>
<a name="l00027"></a>00027 <span class="comment"> * generated by running &quot;make progdocs&quot; from the Asterisk source tree.  </span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * In addition to the information available on the Asterisk source code, </span>
<a name="l00030"></a>00030 <span class="comment"> * please see the appendices for information on coding guidelines, </span>
<a name="l00031"></a>00031 <span class="comment"> * release management, commit policies, and more.</span>
<a name="l00032"></a>00032 <span class="comment"> *</span>
<a name="l00033"></a>00033 <span class="comment"> * \par Additional documentation</span>
<a name="l00034"></a>00034 <span class="comment"> * \arg \ref Licensing</span>
<a name="l00035"></a>00035 <span class="comment"> * \arg \ref DevDoc </span>
<a name="l00036"></a>00036 <span class="comment"> * \arg \ref ConfigFiles</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> * \section copyright Copyright and Author</span>
<a name="l00039"></a>00039 <span class="comment"> *</span>
<a name="l00040"></a>00040 <span class="comment"> * Copyright (C) 1999 - 2009, Digium, Inc.</span>
<a name="l00041"></a>00041 <span class="comment"> * Asterisk is a &lt;a href=&quot;http://www.digium.com/en/company/view-policy.php?id=Trademark-Policy&quot;&gt;registered trademark&lt;/a&gt;</span>
<a name="l00042"></a>00042 <span class="comment"> * of &lt;a href=&quot;http://www.digium.com&quot;&gt;Digium, Inc&lt;/a&gt;.</span>
<a name="l00043"></a>00043 <span class="comment"> *</span>
<a name="l00044"></a>00044 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00045"></a>00045 <span class="comment"> * Also see \ref AstCREDITS</span>
<a name="l00046"></a>00046 <span class="comment"> *</span>
<a name="l00047"></a>00047 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00048"></a>00048 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00049"></a>00049 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00050"></a>00050 <span class="comment"> * the project provides a web site, mailing lists, and IRC</span>
<a name="l00051"></a>00051 <span class="comment"> * channels for your use.</span>
<a name="l00052"></a>00052 <span class="comment"> */</span>
<a name="l00053"></a>00053 <span class="comment"></span>
<a name="l00054"></a>00054 <span class="comment">/*! \file</span>
<a name="l00055"></a>00055 <span class="comment">  \brief Top level source file for Asterisk  - the Open Source PBX. Implementation</span>
<a name="l00056"></a>00056 <span class="comment">  of PBX core functions and CLI interface.</span>
<a name="l00057"></a>00057 <span class="comment">  </span>
<a name="l00058"></a>00058 <span class="comment"> */</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 248864 $&quot;</span>)
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;asterisk/_private.h&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a>00066 <span class="preprocessor">#undef sched_setscheduler</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="preprocessor">#undef setpriority</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &lt;<a class="code" href="sched_8h.html" title="Scheduler Routines (derived from cheops).">sched.h</a>&gt;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &lt;sys/un.h&gt;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &lt;sys/resource.h&gt;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &lt;grp.h&gt;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#if defined(HAVE_SYSINFO)</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/sysinfo.h&gt;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#elif defined(HAVE_SYSCTL)</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/param.h&gt;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &lt;sys/sysctl.h&gt;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#if !defined(__OpenBSD__)</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/vmmeter.h&gt;</span>
<a name="l00086"></a>00086 <span class="preprocessor">#if defined(__FreeBSD__)</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span><span class="preprocessor">#include &lt;vm/vm_param.h&gt;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#endif</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span><span class="preprocessor">#if defined(HAVE_SWAPCTL)</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/swap.h&gt;</span>
<a name="l00092"></a>00092 <span class="preprocessor">#endif</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor">#include &lt;regex.h&gt;</span>
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="preprocessor">#if defined(SOLARIS)</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span><span class="keywordtype">int</span> daemon(<span class="keywordtype">int</span>, <span class="keywordtype">int</span>);  <span class="comment">/* defined in libresolv of all places */</span>
<a name="l00098"></a>00098 <span class="preprocessor">#include &lt;sys/loadavg.h&gt;</span>
<a name="l00099"></a>00099 <span class="preprocessor">#endif</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>
<a name="l00101"></a>00101 <span class="preprocessor">#ifdef linux</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/prctl.h&gt;</span>
<a name="l00103"></a>00103 <span class="preprocessor">#ifdef HAVE_CAP</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/capability.h&gt;</span>
<a name="l00105"></a>00105 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_CAP */</span>
<a name="l00106"></a>00106 <span class="preprocessor">#endif </span><span class="comment">/* linux */</span>
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="preprocessor">#include &quot;<a class="code" href="paths_8h.html" title="Asterisk file paths, configured in asterisk.conf.">asterisk/paths.h</a>&quot;</span>   <span class="comment">/* we define here the variables so better agree on the prototype */</span>
<a name="l00109"></a>00109 <span class="preprocessor">#include &quot;<a class="code" href="network_8h.html" title="Wrapper for network related headers, masking differences between various operating...">asterisk/network.h</a>&quot;</span>
<a name="l00110"></a>00110 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00111"></a>00111 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00112"></a>00112 <span class="preprocessor">#include &quot;<a class="code" href="features_8h.html" title="Call Parking and Pickup API Includes code and algorithms from the Zapata library...">asterisk/features.h</a>&quot;</span>
<a name="l00113"></a>00113 <span class="preprocessor">#include &quot;<a class="code" href="ulaw_8h.html" title="u-Law to Signed linear conversion">asterisk/ulaw.h</a>&quot;</span>
<a name="l00114"></a>00114 <span class="preprocessor">#include &quot;<a class="code" href="alaw_8h.html" title="A-Law to Signed linear conversion.">asterisk/alaw.h</a>&quot;</span>
<a name="l00115"></a>00115 <span class="preprocessor">#include &quot;<a class="code" href="callerid_8h.html" title="CallerID (and other GR30) management and generation Includes code and algorithms...">asterisk/callerid.h</a>&quot;</span>
<a name="l00116"></a>00116 <span class="preprocessor">#include &quot;<a class="code" href="image_8h.html" title="General Asterisk channel definitions for image handling.">asterisk/image.h</a>&quot;</span>
<a name="l00117"></a>00117 <span class="preprocessor">#include &quot;<a class="code" href="tdd_8h.html" title="TTY/TDD Generation support.">asterisk/tdd.h</a>&quot;</span>
<a name="l00118"></a>00118 <span class="preprocessor">#include &quot;<a class="code" href="term_8h.html" title="Handy terminal functions for vt* terms.">asterisk/term.h</a>&quot;</span>
<a name="l00119"></a>00119 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00120"></a>00120 <span class="preprocessor">#include &quot;<a class="code" href="cdr_8h.html" title="Call Detail Record API.">asterisk/cdr.h</a>&quot;</span>
<a name="l00121"></a>00121 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00122"></a>00122 <span class="preprocessor">#include &quot;<a class="code" href="enum_8h.html" title="DNS and ENUM functions.">asterisk/enum.h</a>&quot;</span>
<a name="l00123"></a>00123 <span class="preprocessor">#include &quot;<a class="code" href="rtp_8h.html" title="Supports RTP and RTCP with Symmetric RTP support for NAT traversal.">asterisk/rtp.h</a>&quot;</span>
<a name="l00124"></a>00124 <span class="preprocessor">#include &quot;<a class="code" href="http_8h.html" title="Support for Private Asterisk HTTP Servers.">asterisk/http.h</a>&quot;</span>
<a name="l00125"></a>00125 <span class="preprocessor">#include &quot;<a class="code" href="udptl_8h.html" title="UDPTL support for T.38.">asterisk/udptl.h</a>&quot;</span>
<a name="l00126"></a>00126 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00127"></a>00127 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00128"></a>00128 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00129"></a>00129 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00130"></a>00130 <span class="preprocessor">#include &quot;<a class="code" href="io_8h.html" title="I/O Management (derived from Cheops-NG).">asterisk/io.h</a>&quot;</span>
<a name="l00131"></a>00131 <span class="preprocessor">#include &quot;editline/histedit.h&quot;</span>
<a name="l00132"></a>00132 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00133"></a>00133 <span class="preprocessor">#include &quot;<a class="code" href="ast__version_8h.html" title="Asterisk version information.">asterisk/ast_version.h</a>&quot;</span>
<a name="l00134"></a>00134 <span class="preprocessor">#include &quot;<a class="code" href="linkedlists_8h.html" title="A set of macros to manage forward-linked lists.">asterisk/linkedlists.h</a>&quot;</span>
<a name="l00135"></a>00135 <span class="preprocessor">#include &quot;<a class="code" href="devicestate_8h.html" title="Device state management.">asterisk/devicestate.h</a>&quot;</span>
<a name="l00136"></a>00136 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00137"></a>00137 <span class="preprocessor">#include &quot;<a class="code" href="dsp_8h.html" title="Convenient Signal Processing routines.">asterisk/dsp.h</a>&quot;</span>
<a name="l00138"></a>00138 <span class="preprocessor">#include &quot;<a class="code" href="buildinfo_8h.html">asterisk/buildinfo.h</a>&quot;</span>
<a name="l00139"></a>00139 <span class="preprocessor">#include &quot;<a class="code" href="xmldoc_8h.html" title="Asterisk XML Documentation API.">asterisk/xmldoc.h</a>&quot;</span>
<a name="l00140"></a>00140 <span class="preprocessor">#include &quot;<a class="code" href="poll-compat_8h.html">asterisk/poll-compat.h</a>&quot;</span>
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="preprocessor">#include &quot;<a class="code" href="doxyref_8h.html" title="This file generates Doxygen pages from files in the /doc directory of the Asterisk...">asterisk/doxyref.h</a>&quot;</span>    <span class="comment">/* Doxygen documentation */</span>
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 <span class="preprocessor">#include &quot;../defaults.h&quot;</span>
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="preprocessor">#ifndef AF_LOCAL</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span><span class="preprocessor">#define AF_LOCAL AF_UNIX</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span><span class="preprocessor">#define PF_LOCAL PF_UNIX</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00150"></a>00150 <span class="preprocessor"></span>
<a name="l00151"></a><a class="code" href="asterisk_8c.html#a6d5a16b321d54d9be2b0592881329fdf">00151</a> <span class="preprocessor">#define AST_MAX_CONNECTS 128</span>
<a name="l00152"></a><a class="code" href="asterisk_8c.html#a8259bbeef0c598730055df66c5e7e9e5">00152</a> <span class="preprocessor"></span><span class="preprocessor">#define NUM_MSGS 64</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00154"></a>00154 <span class="comment">/*! \brief Welcome message when starting a CLI interface */</span>
<a name="l00155"></a><a class="code" href="asterisk_8c.html#a4102c912e07db36235dbf80dc4f9728a">00155</a> <span class="preprocessor">#define WELCOME_MESSAGE \</span>
<a name="l00156"></a>00156 <span class="preprocessor">    ast_verbose(&quot;Asterisk %s, Copyright (C) 1999 - 2010 Digium, Inc. and others.\n&quot; \</span>
<a name="l00157"></a>00157 <span class="preprocessor">                &quot;Created by Mark Spencer &lt;markster@digium.com&gt;\n&quot; \</span>
<a name="l00158"></a>00158 <span class="preprocessor">                &quot;Asterisk comes with ABSOLUTELY NO WARRANTY; type &apos;core show warranty&apos; for details.\n&quot; \</span>
<a name="l00159"></a>00159 <span class="preprocessor">                &quot;This is free software, with components licensed under the GNU General Public\n&quot; \</span>
<a name="l00160"></a>00160 <span class="preprocessor">                &quot;License version 2 and other licenses; you are welcome to redistribute it under\n&quot; \</span>
<a name="l00161"></a>00161 <span class="preprocessor">                &quot;certain conditions. Type &apos;core show license&apos; for details.\n&quot; \</span>
<a name="l00162"></a>00162 <span class="preprocessor">                &quot;=========================================================================\n&quot;, ast_get_version()) \</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span>
<a name="l00164"></a>00164 <span class="preprocessor"></span><span class="comment">/*! \defgroup main_options Main Configuration Options</span>
<a name="l00165"></a>00165 <span class="comment"> * \brief Main configuration options from asterisk.conf or OS command line on starting Asterisk.</span>
<a name="l00166"></a>00166 <span class="comment"> * \arg \ref Config_ast &quot;asterisk.conf&quot;</span>
<a name="l00167"></a>00167 <span class="comment"> * \note Some of them can be changed in the CLI </span>
<a name="l00168"></a>00168 <span class="comment"> */</span><span class="comment"></span>
<a name="l00169"></a>00169 <span class="comment">/*! @{ */</span>
<a name="l00170"></a>00170 
<a name="l00171"></a><a class="code" href="group__main__options.html#gaa5dba371db31dc4ebecdff7c929ff263">00171</a> <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="group__main__options.html#gaa5dba371db31dc4ebecdff7c929ff263">ast_options</a> = { <a class="code" href="options_8h.html#ac8b6db7538fe349d9c4c7d1ee7967e40">AST_DEFAULT_OPTIONS</a> };
<a name="l00172"></a><a class="code" href="group__main__options.html#gaf6e03df24713214755e749df14b31cf7">00172</a> <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="group__main__options.html#gaf6e03df24713214755e749df14b31cf7">ast_compat</a> = { 7 };
<a name="l00173"></a>00173 
<a name="l00174"></a><a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">00174</a> <span class="keywordtype">int</span> <a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">option_verbose</a>;           <span class="comment">/*!&lt; Verbosity level */</span>
<a name="l00175"></a><a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">00175</a> <span class="keywordtype">int</span> <a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>;          <span class="comment">/*!&lt; Debug level */</span>
<a name="l00176"></a><a class="code" href="group__main__options.html#ga58e23258cc1956eab5063c9380e1be9f">00176</a> <span class="keywordtype">double</span> <a class="code" href="group__main__options.html#ga58e23258cc1956eab5063c9380e1be9f">option_maxload</a>;           <span class="comment">/*!&lt; Max load avg on system */</span>
<a name="l00177"></a><a class="code" href="group__main__options.html#ga3e1a333df2c22351f326bbfcc509edf3">00177</a> <span class="keywordtype">int</span> <a class="code" href="group__main__options.html#ga3e1a333df2c22351f326bbfcc509edf3">option_maxcalls</a>;          <span class="comment">/*!&lt; Max number of active calls */</span>
<a name="l00178"></a><a class="code" href="group__main__options.html#ga624b9eccad8865a78e65301ac5a564b8">00178</a> <span class="keywordtype">int</span> <a class="code" href="group__main__options.html#ga624b9eccad8865a78e65301ac5a564b8">option_maxfiles</a>;          <span class="comment">/*!&lt; Max number of open file handles (files, sockets) */</span>
<a name="l00179"></a>00179 <span class="preprocessor">#if defined(HAVE_SYSINFO)</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span><span class="keywordtype">long</span> option_minmemfree;          <span class="comment">/*!&lt; Minimum amount of free system memory - stop accepting calls if free memory falls below this watermark */</span>
<a name="l00181"></a>00181 <span class="preprocessor">#endif</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00183"></a>00183 <span class="comment">/*! @} */</span>
<a name="l00184"></a>00184 
<a name="l00185"></a><a class="code" href="asterisk_8c.html#ad5db11fa27352e2b9a3c669adc76955f">00185</a> <span class="keyword">struct </span><a class="code" href="structast__eid.html" title="An Entity ID is essentially a MAC address, brief and unique.">ast_eid</a> <a class="code" href="utils_8h.html#ad5db11fa27352e2b9a3c669adc76955f" title="Global EID.">ast_eid_default</a>;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="comment">/* XXX tmpdir is a subdir of the spool directory, and no way to remap it */</span>
<a name="l00188"></a><a class="code" href="asterisk_8c.html#a08a845bf43007945cede2f5a6a62225c">00188</a> <span class="keywordtype">char</span> <a class="code" href="options_8h.html#a08a845bf43007945cede2f5a6a62225c">record_cache_dir</a>[<a class="code" href="options_8h.html#a6224ae0daaedaf31c4a8988664b480c4">AST_CACHE_DIR_LEN</a>] = <a class="code" href="defaults_8h.html#a93fd237d6ca42964578be3e17b3835d5">DEFAULT_TMP_DIR</a>;
<a name="l00189"></a>00189 
<a name="l00190"></a><a class="code" href="asterisk_8c.html#ae085d7d87fa48cd621ffa8675e274fd1">00190</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#ae085d7d87fa48cd621ffa8675e274fd1">ast_socket</a> = -1;      <span class="comment">/*!&lt; UNIX Socket for allowing remote control */</span>
<a name="l00191"></a><a class="code" href="asterisk_8c.html#accf54a31ef76de94d205f44c61303f90">00191</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#accf54a31ef76de94d205f44c61303f90">ast_consock</a> = -1;     <span class="comment">/*!&lt; UNIX Socket for controlling another asterisk */</span>
<a name="l00192"></a><a class="code" href="asterisk_8c.html#ae1517891417ae2f6e398e95ae79dadf1">00192</a> pid_t <a class="code" href="options_8h.html#ae1517891417ae2f6e398e95ae79dadf1">ast_mainpid</a>;
<a name="l00193"></a><a class="code" href="structconsole.html">00193</a> <span class="keyword">struct </span><a class="code" href="structconsole.html">console</a> {
<a name="l00194"></a><a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">00194</a>    <span class="keywordtype">int</span> <a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;           <span class="comment">/*!&lt; File descriptor */</span>
<a name="l00195"></a><a class="code" href="structconsole.html#a67bfc5276dfe3c0f1174ebc9ce9d7d31">00195</a>    <span class="keywordtype">int</span> <a class="code" href="structconsole.html#a67bfc5276dfe3c0f1174ebc9ce9d7d31">p</a>[2];         <span class="comment">/*!&lt; Pipe */</span>
<a name="l00196"></a><a class="code" href="structconsole.html#aa49d6a06775253352589280dc7f30018">00196</a>    pthread_t <a class="code" href="structconsole.html#aa49d6a06775253352589280dc7f30018">t</a>;         <span class="comment">/*!&lt; Thread of handler */</span>
<a name="l00197"></a><a class="code" href="structconsole.html#a29128ae5c15a12dea5fe4f263ba6cec1">00197</a>    <span class="keywordtype">int</span> <a class="code" href="structconsole.html#a29128ae5c15a12dea5fe4f263ba6cec1">mute</a>;         <span class="comment">/*!&lt; Is the console muted for logs */</span>
<a name="l00198"></a><a class="code" href="structconsole.html#a60a34315f460179939054acaf3ed8163">00198</a>    <span class="keywordtype">int</span> <a class="code" href="structconsole.html#a60a34315f460179939054acaf3ed8163">uid</a>;       <span class="comment">/*!&lt; Remote user ID. */</span>
<a name="l00199"></a><a class="code" href="structconsole.html#a6567680a890171fbaa1a026477a858d3">00199</a>    <span class="keywordtype">int</span> <a class="code" href="structconsole.html#a6567680a890171fbaa1a026477a858d3">gid</a>;       <span class="comment">/*!&lt; Remote group ID. */</span>
<a name="l00200"></a><a class="code" href="structconsole.html#af74c640613d859156463a4ba7436f023">00200</a>    <span class="keywordtype">int</span> <a class="code" href="structconsole.html#af74c640613d859156463a4ba7436f023">levels</a>[<a class="code" href="logger_8h.html#a3d02ffd5809bdb049c815df859bbfcf4">NUMLOGLEVELS</a>];  <span class="comment">/*!&lt; Which log levels are enabled for the console */</span>
<a name="l00201"></a>00201 };
<a name="l00202"></a>00202 
<a name="l00203"></a><a class="code" href="structast__atexit.html">00203</a> <span class="keyword">struct </span><a class="code" href="structast__atexit.html">ast_atexit</a> {
<a name="l00204"></a>00204    void (*<a class="code" href="structast__atexit.html#af406187a441c51e4589704fae05f15fe">func</a>)(void);
<a name="l00205"></a><a class="code" href="structast__atexit.html#ac5b1ea746b32bcaace4b664dda9a9309">00205</a>    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(<a class="code" href="structast__atexit.html">ast_atexit</a>) <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>;
<a name="l00206"></a>00206 };
<a name="l00207"></a>00207 
<a name="l00208"></a><a class="code" href="structatexits.html#ace4e0066a5b24f84b90536e9906619f6">00208</a> static <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structatexits.html">atexits</a>, <a class="code" href="structast__atexit.html">ast_atexit</a>);
<a name="l00209"></a>00209 
<a name="l00210"></a><a class="code" href="asterisk_8c.html#acd462f81fa607939af36a9fa33cdbf9d">00210</a> struct timeval <a class="code" href="options_8h.html#acd462f81fa607939af36a9fa33cdbf9d">ast_startuptime</a>;
<a name="l00211"></a><a class="code" href="asterisk_8c.html#a7cdafc5a121e87659887ffc9abe36760">00211</a> struct timeval <a class="code" href="options_8h.html#a7cdafc5a121e87659887ffc9abe36760">ast_lastreloadtime</a>;
<a name="l00212"></a>00212 
<a name="l00213"></a><a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">00213</a> static History *<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a>;
<a name="l00214"></a><a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">00214</a> static EditLine *<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>;
<a name="l00215"></a><a class="code" href="asterisk_8c.html#a04e7dcc4737a260fa91c5241b81c0101">00215</a> static <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a04e7dcc4737a260fa91c5241b81c0101">remotehostname</a>;
<a name="l00216"></a>00216 
<a name="l00217"></a><a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">00217</a> struct <a class="code" href="structconsole.html">console</a> <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[<a class="code" href="asterisk_8c.html#a6d5a16b321d54d9be2b0592881329fdf">AST_MAX_CONNECTS</a>];
<a name="l00218"></a>00218 
<a name="l00219"></a><a class="code" href="asterisk_8c.html#a16d83c44a7ed89d82035eb0db12c6ad2">00219</a> <span class="keywordtype">char</span> <a class="code" href="options_8h.html#a6975f3d412909586ee6ba1aa4ab0ba2c">defaultlanguage</a>[<a class="code" href="channel_8h.html#a9238c3318ae8d3bea2cbbe1d1e459eb7">MAX_LANGUAGE</a>] = <a class="code" href="asterisk_8h.html#a2a112ca1c7c7dc54fe43375469738dc4">DEFAULT_LANGUAGE</a>;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 static <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a9aff30b106c705ecc3484dadd6395f64">ast_el_add_history</a>(<span class="keywordtype">char</span> *);
<a name="l00222"></a>00222 static <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a5cd497fbc32fe40a9c3d941ca56a04a0">ast_el_read_history</a>(<span class="keywordtype">char</span> *);
<a name="l00223"></a>00223 static <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#ad1dbb4e490dd946730de06a87531ba9c">ast_el_write_history</a>(<span class="keywordtype">char</span> *);
<a name="l00224"></a>00224 
<a name="l00225"></a><a class="code" href="struct__cfg__paths.html">00225</a> struct <a class="code" href="struct__cfg__paths.html">_cfg_paths</a> {
<a name="l00226"></a><a class="code" href="struct__cfg__paths.html#a2a787698d0bf9e2e1feba95c9e9dc0c6">00226</a>    <span class="keywordtype">char</span> config_dir[PATH_MAX];
<a name="l00227"></a><a class="code" href="struct__cfg__paths.html#ac911358c35b6b1ddd1aed6bcb84c57c5">00227</a>    <span class="keywordtype">char</span> module_dir[PATH_MAX];
<a name="l00228"></a><a class="code" href="struct__cfg__paths.html#a60aa45269a40668187b52a047d7909c6">00228</a>    <span class="keywordtype">char</span> spool_dir[PATH_MAX];
<a name="l00229"></a><a class="code" href="struct__cfg__paths.html#a1eb90b245cb49d77acf222238afcaf30">00229</a>    <span class="keywordtype">char</span> monitor_dir[PATH_MAX];
<a name="l00230"></a><a class="code" href="struct__cfg__paths.html#a77fd1ea5a8365503c30f3e498fd91814">00230</a>    <span class="keywordtype">char</span> var_dir[PATH_MAX];
<a name="l00231"></a><a class="code" href="struct__cfg__paths.html#a8075dfd7bd2be8076fd90ad4e8c2dbf8">00231</a>    <span class="keywordtype">char</span> data_dir[PATH_MAX];
<a name="l00232"></a><a class="code" href="struct__cfg__paths.html#a30a5656eac4b61ac4c323709df7960e6">00232</a>    <span class="keywordtype">char</span> log_dir[PATH_MAX];
<a name="l00233"></a><a class="code" href="struct__cfg__paths.html#af6443747a8c6314ab90e086ad748b73d">00233</a>    <span class="keywordtype">char</span> agi_dir[PATH_MAX];
<a name="l00234"></a><a class="code" href="struct__cfg__paths.html#a25fedda2ff46425cea16ffcefc7f7876">00234</a>    <span class="keywordtype">char</span> run_dir[PATH_MAX];
<a name="l00235"></a><a class="code" href="struct__cfg__paths.html#a432958de9de3057461bb77ea19493d8b">00235</a>    <span class="keywordtype">char</span> key_dir[PATH_MAX];
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="struct__cfg__paths.html#a6f62cc62aaaf65aab477ee3087f87f02">00237</a>    <span class="keywordtype">char</span> <a class="code" href="cdr__odbc_8c.html#ac269be8b91ae4b24df48de5d8ad7e7a7">config_file</a>[PATH_MAX];
<a name="l00238"></a><a class="code" href="struct__cfg__paths.html#ab3a4bb3db5559a103e7f42fdef6f647c">00238</a>    <span class="keywordtype">char</span> db_path[PATH_MAX];
<a name="l00239"></a><a class="code" href="struct__cfg__paths.html#a55bc52b564c65697c3f849ef6eb2125b">00239</a>    <span class="keywordtype">char</span> pid_path[PATH_MAX];
<a name="l00240"></a><a class="code" href="struct__cfg__paths.html#a8a08552e4300432b153a40065429b182">00240</a>    <span class="keywordtype">char</span> socket_path[PATH_MAX];
<a name="l00241"></a><a class="code" href="struct__cfg__paths.html#ac302695683ee10f02d68e6204508da7b">00241</a>    <span class="keywordtype">char</span> run_user[PATH_MAX];
<a name="l00242"></a><a class="code" href="struct__cfg__paths.html#a7fb2d389b8007b951e07454d6a09000a">00242</a>    <span class="keywordtype">char</span> run_group[PATH_MAX];
<a name="l00243"></a><a class="code" href="struct__cfg__paths.html#a005a08d03a4ab3e2a04fe80157ecf510">00243</a>    <span class="keywordtype">char</span> system_name[128];
<a name="l00244"></a>00244 };
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">00246</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct__cfg__paths.html">_cfg_paths</a> <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>;
<a name="l00247"></a>00247 
<a name="l00248"></a><a class="code" href="asterisk_8c.html#a7d3836e5581e433c9f5edd30300cc187">00248</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#a7d3836e5581e433c9f5edd30300cc187">ast_config_AST_CONFIG_DIR</a>  = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a2a787698d0bf9e2e1feba95c9e9dc0c6">config_dir</a>;
<a name="l00249"></a><a class="code" href="asterisk_8c.html#adea5f0a0a8720d1dbb47ca434fe78778">00249</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#adea5f0a0a8720d1dbb47ca434fe78778">ast_config_AST_CONFIG_FILE</a> = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a6f62cc62aaaf65aab477ee3087f87f02">config_file</a>;
<a name="l00250"></a><a class="code" href="asterisk_8c.html#a5852d8e3bf5485c09b0f3d2c2375eec3">00250</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#a5852d8e3bf5485c09b0f3d2c2375eec3">ast_config_AST_MODULE_DIR</a>  = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ac911358c35b6b1ddd1aed6bcb84c57c5">module_dir</a>;
<a name="l00251"></a><a class="code" href="asterisk_8c.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">00251</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">ast_config_AST_SPOOL_DIR</a>   = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a60aa45269a40668187b52a047d7909c6">spool_dir</a>;
<a name="l00252"></a><a class="code" href="asterisk_8c.html#ae8b54021bf362dc04d5783fa3b4b4abd">00252</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#ae8b54021bf362dc04d5783fa3b4b4abd">ast_config_AST_MONITOR_DIR</a> = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a1eb90b245cb49d77acf222238afcaf30">monitor_dir</a>;
<a name="l00253"></a><a class="code" href="asterisk_8c.html#ab6e1cd3d774ab1b31836a8777d3a812d">00253</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#ab6e1cd3d774ab1b31836a8777d3a812d">ast_config_AST_VAR_DIR</a>  = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a77fd1ea5a8365503c30f3e498fd91814">var_dir</a>;
<a name="l00254"></a><a class="code" href="asterisk_8c.html#a63af4213b5b83f717398d8d62008a50d">00254</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a> = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a8075dfd7bd2be8076fd90ad4e8c2dbf8">data_dir</a>;
<a name="l00255"></a><a class="code" href="asterisk_8c.html#aea5e16ca2517e2093fdfa0e7fd112f0f">00255</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a>  = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a30a5656eac4b61ac4c323709df7960e6">log_dir</a>;
<a name="l00256"></a><a class="code" href="asterisk_8c.html#a9b39aef5b661559fc470307cb315a417">00256</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#a9b39aef5b661559fc470307cb315a417">ast_config_AST_AGI_DIR</a>  = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#af6443747a8c6314ab90e086ad748b73d">agi_dir</a>;
<a name="l00257"></a><a class="code" href="asterisk_8c.html#a0334adace37c0e8de8ea89c8651336a2">00257</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#a0334adace37c0e8de8ea89c8651336a2">ast_config_AST_KEY_DIR</a>  = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a432958de9de3057461bb77ea19493d8b">key_dir</a>;
<a name="l00258"></a><a class="code" href="asterisk_8c.html#a6014e29009d7db30e546a244c2cc95b6">00258</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#a6014e29009d7db30e546a244c2cc95b6">ast_config_AST_RUN_DIR</a>  = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a25fedda2ff46425cea16ffcefc7f7876">run_dir</a>;
<a name="l00259"></a>00259 
<a name="l00260"></a><a class="code" href="asterisk_8c.html#af89b8aa53d5b08a03b56f5163805bd97">00260</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#af89b8aa53d5b08a03b56f5163805bd97">ast_config_AST_DB</a>    = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ab3a4bb3db5559a103e7f42fdef6f647c">db_path</a>;
<a name="l00261"></a><a class="code" href="asterisk_8c.html#a59860442b922398568da0236c1576039">00261</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#a59860442b922398568da0236c1576039">ast_config_AST_PID</a>      = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a55bc52b564c65697c3f849ef6eb2125b">pid_path</a>;
<a name="l00262"></a><a class="code" href="asterisk_8c.html#a2f174d3a0019aa9eecb92b83a463e9a6">00262</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>   = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a8a08552e4300432b153a40065429b182">socket_path</a>;
<a name="l00263"></a><a class="code" href="asterisk_8c.html#a37ae09a4cc0e3b46e7b2a2052bde4965">00263</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#a37ae09a4cc0e3b46e7b2a2052bde4965">ast_config_AST_RUN_USER</a> = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ac302695683ee10f02d68e6204508da7b">run_user</a>;
<a name="l00264"></a><a class="code" href="asterisk_8c.html#a2434757afbc16110ff1c7483f3d7ba51">00264</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#a2434757afbc16110ff1c7483f3d7ba51">ast_config_AST_RUN_GROUP</a>   = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a7fb2d389b8007b951e07454d6a09000a">run_group</a>;
<a name="l00265"></a><a class="code" href="asterisk_8c.html#ab9f9346c7a41bdf3720f7b1ed02ec703">00265</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="paths_8h.html#ab9f9346c7a41bdf3720f7b1ed02ec703">ast_config_AST_SYSTEM_NAME</a> = <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a005a08d03a4ab3e2a04fe80157ecf510">system_name</a>;
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="asterisk_8c.html#afe07211d3ad898c81340a2114987bacb">00267</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="asterisk_8c.html#afe07211d3ad898c81340a2114987bacb">ast_config_AST_CTL_PERMISSIONS</a>[PATH_MAX];
<a name="l00268"></a><a class="code" href="asterisk_8c.html#addee6463d8305d615d3c2d6095c13ef7">00268</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="asterisk_8c.html#addee6463d8305d615d3c2d6095c13ef7">ast_config_AST_CTL_OWNER</a>[PATH_MAX] = <span class="stringliteral">&quot;\0&quot;</span>;
<a name="l00269"></a><a class="code" href="asterisk_8c.html#a0ac99db7e33597c95e83068770d2085f">00269</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="asterisk_8c.html#a0ac99db7e33597c95e83068770d2085f">ast_config_AST_CTL_GROUP</a>[PATH_MAX] = <span class="stringliteral">&quot;\0&quot;</span>;
<a name="l00270"></a><a class="code" href="asterisk_8c.html#a3cdc624a4514308286386d081e38b88c">00270</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="asterisk_8c.html#a3cdc624a4514308286386d081e38b88c">ast_config_AST_CTL</a>[PATH_MAX] = <span class="stringliteral">&quot;asterisk.ctl&quot;</span>;
<a name="l00271"></a>00271 
<a name="l00272"></a><a class="code" href="asterisk_8c.html#aac76ac35350d1efd9ddfe5b56739c649">00272</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#aac76ac35350d1efd9ddfe5b56739c649">_argv</a>[256];
<a name="l00273"></a><a class="code" href="asterisk_8c.html#a72c50d9ef6e457be5b578fefecd3147d">00273</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a72c50d9ef6e457be5b578fefecd3147d">shuttingdown</a>;
<a name="l00274"></a><a class="code" href="asterisk_8c.html#a8fbb0f40e9c839384d728aa8e0958dfb">00274</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a8fbb0f40e9c839384d728aa8e0958dfb">restartnow</a>;
<a name="l00275"></a><a class="code" href="asterisk_8c.html#a60dce572870808fbda416eb4c9d60250">00275</a> <span class="keyword">static</span> pthread_t <a class="code" href="asterisk_8c.html#a60dce572870808fbda416eb4c9d60250">consolethread</a> = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l00276"></a><a class="code" href="asterisk_8c.html#ab2acd3f561950f0ab6546314677ad57d">00276</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#ab2acd3f561950f0ab6546314677ad57d">canary_pid</a> = 0;
<a name="l00277"></a><a class="code" href="asterisk_8c.html#a459b692028914da1bf3641b5de9ba6ea">00277</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="asterisk_8c.html#a459b692028914da1bf3641b5de9ba6ea">canary_filename</a>[128];
<a name="l00278"></a>00278 
<a name="l00279"></a><a class="code" href="asterisk_8c.html#a3a662046fe963f773c09fc3b998d3a44">00279</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="asterisk_8c.html#a3a662046fe963f773c09fc3b998d3a44">randompool</a>[256];
<a name="l00280"></a>00280 
<a name="l00281"></a><a class="code" href="asterisk_8c.html#a7bb419fdb0040da24ecbb651b12395fc">00281</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a7bb419fdb0040da24ecbb651b12395fc">sig_alert_pipe</a>[2] = { -1, -1 };
<a name="l00282"></a>00282 <span class="keyword">static</span> <span class="keyword">struct </span>{
<a name="l00283"></a><a class="code" href="asterisk_8c.html#a2c0628cd8683a1fb31dd77db1c566d01">00283</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a2c0628cd8683a1fb31dd77db1c566d01">need_reload</a>:1;
<a name="l00284"></a><a class="code" href="asterisk_8c.html#a59ebc425c4a47d7a5fb011e9448f7806">00284</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a59ebc425c4a47d7a5fb011e9448f7806">need_quit</a>:1;
<a name="l00285"></a>00285 } <a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 <span class="preprocessor">#if !defined(LOW_MEMORY)</span>
<a name="l00288"></a><a class="code" href="structfile__version.html">00288</a> <span class="preprocessor"></span><span class="keyword">struct </span><a class="code" href="structfile__version.html">file_version</a> {
<a name="l00289"></a><a class="code" href="structfile__version.html#a815cfa8f95ff5c08f32c0b2711b4076d">00289</a>    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(<a class="code" href="structfile__version.html">file_version</a>) <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>;
<a name="l00290"></a><a class="code" href="structfile__version.html#af0baa3ccdd9d2a6adf03b72e2bea5789">00290</a>    const <span class="keywordtype">char</span> *file;
<a name="l00291"></a><a class="code" href="structfile__version.html#a56abfaab87c46691c1ef3ad0df23e864">00291</a>    <span class="keywordtype">char</span> *<a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>;
<a name="l00292"></a>00292 };
<a name="l00293"></a>00293 
<a name="l00294"></a><a class="code" href="structfile__versions.html#ace4e0066a5b24f84b90536e9906619f6">00294</a> static <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structfile__versions.html">file_versions</a>, <a class="code" href="structfile__version.html">file_version</a>);
<a name="l00295"></a>00295 
<a name="l00296"></a><a class="code" href="asterisk_8c.html#a71ce879ebcbc81b231fc58e1931780b0">00296</a> <span class="keywordtype">void</span> <a class="code" href="asterisk_8h.html#a71ce879ebcbc81b231fc58e1931780b0" title="Register the version of a source code file with the core.">ast_register_file_version</a>(const <span class="keywordtype">char</span> *file, const <span class="keywordtype">char</span> *version)
<a name="l00297"></a>00297 {
<a name="l00298"></a>00298    <span class="keyword">struct </span>file_version *<span class="keyword">new</span>;
<a name="l00299"></a>00299    <span class="keywordtype">char</span> *work;
<a name="l00300"></a>00300    <span class="keywordtype">size_t</span> version_length;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302    work = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(version);
<a name="l00303"></a>00303    work = <a class="code" href="strings_8h.html#aeb1c54e6e100c63176d8e22b0d5ca865" title="Strip leading/trailing whitespace from a string.">ast_strip</a>(<a class="code" href="strings_8h.html#aeb597bdc9a1209c2e7dd8af04de43485" title="Strip leading/trailing whitespace and quotes from a string.">ast_strip_quoted</a>(work, <span class="stringliteral">&quot;$&quot;</span>, <span class="stringliteral">&quot;$&quot;</span>));
<a name="l00304"></a>00304    version_length = strlen(work) + 1;
<a name="l00305"></a>00305    
<a name="l00306"></a>00306    <span class="keywordflow">if</span> (!(<span class="keyword">new</span> = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*<span class="keyword">new</span>) + version_length)))
<a name="l00307"></a>00307       <span class="keywordflow">return</span>;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309    <span class="keyword">new</span>-&gt;file = file;
<a name="l00310"></a>00310    <span class="keyword">new</span>-&gt;version = (<span class="keywordtype">char</span> *) <span class="keyword">new</span> + <span class="keyword">sizeof</span>(*<span class="keyword">new</span>);
<a name="l00311"></a>00311    memcpy(new-&gt;version, work, version_length);
<a name="l00312"></a>00312    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;file_versions);
<a name="l00313"></a>00313    <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;file_versions, <span class="keyword">new</span>, list);
<a name="l00314"></a>00314    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;file_versions);
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00317"></a><a class="code" href="asterisk_8c.html#a7cda37f8ca9ae7173f49b09f05fac207">00317</a> <span class="keywordtype">void</span> <a class="code" href="asterisk_8h.html#a7cda37f8ca9ae7173f49b09f05fac207" title="Unregister a source code file from the core.">ast_unregister_file_version</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structfile__version.html#af0baa3ccdd9d2a6adf03b72e2bea5789">file</a>)
<a name="l00318"></a>00318 {
<a name="l00319"></a>00319    <span class="keyword">struct </span><a class="code" href="structfile__version.html">file_version</a> *find;
<a name="l00320"></a>00320 
<a name="l00321"></a>00321    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>);
<a name="l00322"></a>00322    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>, find, <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>) {
<a name="l00323"></a>00323       <span class="keywordflow">if</span> (!strcasecmp(find-&gt;<a class="code" href="structfile__version.html#af0baa3ccdd9d2a6adf03b72e2bea5789">file</a>, file)) {
<a name="l00324"></a>00324          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(<a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>);
<a name="l00325"></a>00325          <span class="keywordflow">break</span>;
<a name="l00326"></a>00326       }
<a name="l00327"></a>00327    }
<a name="l00328"></a>00328    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l00329"></a>00329    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>);
<a name="l00330"></a>00330 
<a name="l00331"></a>00331    <span class="keywordflow">if</span> (find)
<a name="l00332"></a>00332       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(find);
<a name="l00333"></a>00333 }
<a name="l00334"></a>00334 
<a name="l00335"></a><a class="code" href="asterisk_8c.html#a826e3c1be1ea772fbdc32c1f312ec830">00335</a> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8h.html#a826e3c1be1ea772fbdc32c1f312ec830">ast_complete_source_filename</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *partial, <span class="keywordtype">int</span> n)
<a name="l00336"></a>00336 {
<a name="l00337"></a>00337    <span class="keyword">struct </span><a class="code" href="structfile__version.html">file_version</a> *find;
<a name="l00338"></a>00338    <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(partial);
<a name="l00339"></a>00339    <span class="keywordtype">int</span> count = 0;
<a name="l00340"></a>00340    <span class="keywordtype">char</span> *res = NULL;
<a name="l00341"></a>00341 
<a name="l00342"></a>00342    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>);
<a name="l00343"></a>00343    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>, find, <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>) {
<a name="l00344"></a>00344       <span class="keywordflow">if</span> (!strncasecmp(find-&gt;<a class="code" href="structfile__version.html#af0baa3ccdd9d2a6adf03b72e2bea5789">file</a>, partial, len) &amp;&amp; ++count &gt; n) {
<a name="l00345"></a>00345          res = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(find-&gt;<a class="code" href="structfile__version.html#af0baa3ccdd9d2a6adf03b72e2bea5789">file</a>);
<a name="l00346"></a>00346          <span class="keywordflow">break</span>;
<a name="l00347"></a>00347       }
<a name="l00348"></a>00348    }
<a name="l00349"></a>00349    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>);
<a name="l00350"></a>00350    <span class="keywordflow">return</span> res;
<a name="l00351"></a>00351 }
<a name="l00352"></a>00352 <span class="comment"></span>
<a name="l00353"></a>00353 <span class="comment">/*! \brief Find version for given module name */</span>
<a name="l00354"></a><a class="code" href="asterisk_8c.html#a08e11e6ad5fe516b0e500509aeb8e271">00354</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8h.html#a08e11e6ad5fe516b0e500509aeb8e271" title="Find version for given module name.">ast_file_version_find</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structfile__version.html#af0baa3ccdd9d2a6adf03b72e2bea5789">file</a>)
<a name="l00355"></a>00355 {
<a name="l00356"></a>00356    <span class="keyword">struct </span><a class="code" href="structfile__version.html">file_version</a> *iterator;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>);
<a name="l00359"></a>00359    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>, iterator, <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>) {
<a name="l00360"></a>00360       <span class="keywordflow">if</span> (!strcasecmp(iterator-&gt;<a class="code" href="structfile__version.html#af0baa3ccdd9d2a6adf03b72e2bea5789">file</a>, file))
<a name="l00361"></a>00361          <span class="keywordflow">break</span>;
<a name="l00362"></a>00362    }
<a name="l00363"></a>00363    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l00364"></a>00364    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>);
<a name="l00365"></a>00365    <span class="keywordflow">if</span> (iterator)
<a name="l00366"></a>00366       <span class="keywordflow">return</span> iterator-&gt;<a class="code" href="structfile__version.html#a56abfaab87c46691c1ef3ad0df23e864">version</a>;
<a name="l00367"></a>00367    <span class="keywordflow">return</span> NULL;
<a name="l00368"></a>00368 }      
<a name="l00369"></a>00369        
<a name="l00370"></a>00370 
<a name="l00371"></a>00371 
<a name="l00372"></a><a class="code" href="structthread__list__t.html">00372</a> <span class="keyword">struct </span><a class="code" href="structthread__list__t.html">thread_list_t</a> {
<a name="l00373"></a><a class="code" href="structthread__list__t.html#a71ad01f5736a735d4a2c48ad5d2cec03">00373</a>    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(<a class="code" href="structthread__list__t.html">thread_list_t</a>) <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>;
<a name="l00374"></a><a class="code" href="structthread__list__t.html#a5ac083a645d964373f022d03df4849c8">00374</a>    <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>;
<a name="l00375"></a><a class="code" href="structthread__list__t.html#a2465fd4497a7402ad72da7d6e03f9934">00375</a>    pthread_t <span class="keywordtype">id</span>;
<a name="l00376"></a>00376 };
<a name="l00377"></a>00377 
<a name="l00378"></a><a class="code" href="structthread__list.html#ace4e0066a5b24f84b90536e9906619f6">00378</a> static <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structthread__list.html">thread_list</a>, <a class="code" href="structthread__list__t.html">thread_list_t</a>);
<a name="l00379"></a>00379 
<a name="l00380"></a><a class="code" href="asterisk_8c.html#a8e450762024db98313129c1a2ea07d0c">00380</a> <span class="keywordtype">void</span> <a class="code" href="utils_8h.html#a8e450762024db98313129c1a2ea07d0c">ast_register_thread</a>(<span class="keywordtype">char</span> *name)
<a name="l00381"></a>00381 { 
<a name="l00382"></a>00382    <span class="keyword">struct </span>thread_list_t *<span class="keyword">new</span> = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*<span class="keyword">new</span>));
<a name="l00383"></a>00383 
<a name="l00384"></a>00384    <span class="keywordflow">if</span> (!<span class="keyword">new</span>)
<a name="l00385"></a>00385       <span class="keywordflow">return</span>;
<a name="l00386"></a>00386    <span class="keyword">new</span>-&gt;id = pthread_self();
<a name="l00387"></a>00387    <span class="keyword">new</span>-&gt;name = name; <span class="comment">/* steal the allocated memory for the thread name */</span>
<a name="l00388"></a>00388    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;thread_list);
<a name="l00389"></a>00389    <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;thread_list, <span class="keyword">new</span>, list);
<a name="l00390"></a>00390    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;thread_list);
<a name="l00391"></a>00391 }
<a name="l00392"></a>00392 
<a name="l00393"></a><a class="code" href="asterisk_8c.html#a9795c12483e42e95d18eae6a92482677">00393</a> <span class="keywordtype">void</span> <a class="code" href="utils_8h.html#a9795c12483e42e95d18eae6a92482677">ast_unregister_thread</a>(<span class="keywordtype">void</span> *<span class="keywordtype">id</span>)
<a name="l00394"></a>00394 {
<a name="l00395"></a>00395    <span class="keyword">struct </span><a class="code" href="structthread__list__t.html">thread_list_t</a> *x;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structthread__list.html">thread_list</a>);
<a name="l00398"></a>00398    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structthread__list.html">thread_list</a>, x, <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>) {
<a name="l00399"></a>00399       <span class="keywordflow">if</span> ((<span class="keywordtype">void</span> *) x-&gt;<a class="code" href="structthread__list__t.html#a2465fd4497a7402ad72da7d6e03f9934">id</a> == <span class="keywordtype">id</span>) {
<a name="l00400"></a>00400          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(<a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>);
<a name="l00401"></a>00401          <span class="keywordflow">break</span>;
<a name="l00402"></a>00402       }
<a name="l00403"></a>00403    }
<a name="l00404"></a>00404    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l00405"></a>00405    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structthread__list.html">thread_list</a>);
<a name="l00406"></a>00406    <span class="keywordflow">if</span> (x) {
<a name="l00407"></a>00407       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(x-&gt;<a class="code" href="structthread__list__t.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00408"></a>00408       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(x);
<a name="l00409"></a>00409    }
<a name="l00410"></a>00410 }
<a name="l00411"></a>00411 <span class="comment"></span>
<a name="l00412"></a>00412 <span class="comment">/*! \brief Give an overview of core settings */</span>
<a name="l00413"></a><a class="code" href="asterisk_8c.html#ad66301d131d35faea1df2e7c5b1a1bf2">00413</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#ad66301d131d35faea1df2e7c5b1a1bf2" title="Give an overview of core settings.">handle_show_settings</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00414"></a>00414 {
<a name="l00415"></a>00415    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[BUFSIZ];
<a name="l00416"></a>00416    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l00417"></a>00417    <span class="keywordtype">char</span> eid_str[128];
<a name="l00418"></a>00418 
<a name="l00419"></a>00419    <span class="keywordflow">switch</span> (cmd) {
<a name="l00420"></a>00420    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00421"></a>00421       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show settings&quot;</span>;
<a name="l00422"></a>00422       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = <span class="stringliteral">&quot;Usage: core show settings\n&quot;</span>
<a name="l00423"></a>00423             <span class="stringliteral">&quot;       Show core misc settings&quot;</span>;
<a name="l00424"></a>00424       <span class="keywordflow">return</span> NULL;
<a name="l00425"></a>00425    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00426"></a>00426       <span class="keywordflow">return</span> NULL;
<a name="l00427"></a>00427    }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429    <a class="code" href="utils_8h.html#a8ebf6841073ea2a063a0c86a5092a85b">ast_eid_to_str</a>(eid_str, <span class="keyword">sizeof</span>(eid_str), &amp;<a class="code" href="utils_8h.html#ad5db11fa27352e2b9a3c669adc76955f" title="Global EID.">ast_eid_default</a>);
<a name="l00430"></a>00430 
<a name="l00431"></a>00431    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\nPBX Core settings\n&quot;</span>);
<a name="l00432"></a>00432    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;-----------------\n&quot;</span>);
<a name="l00433"></a>00433    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Version:                     %s\n&quot;</span>, <a class="code" href="ast__version_8h.html#a7765c608aea948584928643ab3963b2a" title="Retrieve the Asterisk version string.">ast_get_version</a>());
<a name="l00434"></a>00434    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Build Options:               %s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="buildopts_8h.html#a8743b5838c526a409dee361bbf7493b5">AST_BUILDOPTS</a>, <span class="stringliteral">&quot;(none)&quot;</span>));
<a name="l00435"></a>00435    <span class="keywordflow">if</span> (option_maxcalls)
<a name="l00436"></a>00436       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Maximum calls:               %d (Current %d)\n&quot;</span>, option_maxcalls, <a class="code" href="channel_8h.html#a9704ae96ab849e9e5a20040c13d29705" title="returns number of active/allocated channels">ast_active_channels</a>());
<a name="l00437"></a>00437    <span class="keywordflow">else</span>
<a name="l00438"></a>00438       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Maximum calls:               Not set\n&quot;</span>);
<a name="l00439"></a>00439    <span class="keywordflow">if</span> (option_maxfiles)
<a name="l00440"></a>00440       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Maximum open file handles:   %d\n&quot;</span>, option_maxfiles); 
<a name="l00441"></a>00441    <span class="keywordflow">else</span>
<a name="l00442"></a>00442       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Maximum open file handles:   Not set\n&quot;</span>);
<a name="l00443"></a>00443    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Verbosity:                   %d\n&quot;</span>, option_verbose);
<a name="l00444"></a>00444    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Debug level:                 %d\n&quot;</span>, option_debug);
<a name="l00445"></a>00445    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Maximum load average:        %lf\n&quot;</span>, option_maxload);
<a name="l00446"></a>00446 <span class="preprocessor">#if defined(HAVE_SYSINFO)</span>
<a name="l00447"></a>00447 <span class="preprocessor"></span>   <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Minimum free memory:         %ld MB\n&quot;</span>, option_minmemfree);
<a name="l00448"></a>00448 <span class="preprocessor">#endif</span>
<a name="l00449"></a>00449 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;<a class="code" href="options_8h.html#acd462f81fa607939af36a9fa33cdbf9d">ast_startuptime</a>, &amp;tm, NULL)) {
<a name="l00450"></a>00450       <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;%H:%M:%S&quot;</span>, &amp;tm);
<a name="l00451"></a>00451       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Startup time:                %s\n&quot;</span>, buf);
<a name="l00452"></a>00452    }
<a name="l00453"></a>00453    <span class="keywordflow">if</span> (<a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;<a class="code" href="options_8h.html#a7cdafc5a121e87659887ffc9abe36760">ast_lastreloadtime</a>, &amp;tm, NULL)) {
<a name="l00454"></a>00454       <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;%H:%M:%S&quot;</span>, &amp;tm);
<a name="l00455"></a>00455       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Last reload time:            %s\n&quot;</span>, buf);
<a name="l00456"></a>00456    }
<a name="l00457"></a>00457    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  System:                      %s/%s built by %s on %s %s\n&quot;</span>, <a class="code" href="buildinfo_8h.html#a00b5464ec2f306ae8f17f73a0a81f28d">ast_build_os</a>, <a class="code" href="buildinfo_8h.html#af89b2913397f19dc15adb9014bcb5d5a">ast_build_kernel</a>, <a class="code" href="buildinfo_8h.html#ac67b18fb7444d973a733a9757c1ff8f9">ast_build_user</a>, <a class="code" href="buildinfo_8h.html#a6d456a43bdae713459ee5ee67439670c">ast_build_machine</a>, <a class="code" href="buildinfo_8h.html#af1708cda257f6db95f77b34f112ef64b">ast_build_date</a>);
<a name="l00458"></a>00458    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  System name:                 %s\n&quot;</span>, <a class="code" href="paths_8h.html#ab9f9346c7a41bdf3720f7b1ed02ec703">ast_config_AST_SYSTEM_NAME</a>);
<a name="l00459"></a>00459    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Entity ID:                   %s\n&quot;</span>, eid_str);
<a name="l00460"></a>00460    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Default language:            %s\n&quot;</span>, <a class="code" href="options_8h.html#a6975f3d412909586ee6ba1aa4ab0ba2c">defaultlanguage</a>);
<a name="l00461"></a>00461    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Language prefix:             %s\n&quot;</span>, <a class="code" href="options_8h.html#a248e5c086666b04d29a9cd876ad370b3">ast_language_is_prefix</a> ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l00462"></a>00462    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  User name and group:         %s/%s\n&quot;</span>, <a class="code" href="paths_8h.html#a37ae09a4cc0e3b46e7b2a2052bde4965">ast_config_AST_RUN_USER</a>, <a class="code" href="paths_8h.html#a2434757afbc16110ff1c7483f3d7ba51">ast_config_AST_RUN_GROUP</a>);
<a name="l00463"></a>00463    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Executable includes:         %s\n&quot;</span>, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a1ec197321d89052601ec7e5482009807">AST_OPT_FLAG_EXEC_INCLUDES</a>) ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l00464"></a>00464    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Transcode via SLIN:          %s\n&quot;</span>, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a1c360c0f064303244790f6857bd2d847">AST_OPT_FLAG_TRANSCODE_VIA_SLIN</a>) ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l00465"></a>00465    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Internal timing:             %s\n&quot;</span>, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343ae3d9576031f4d21d00c6f1a62b55c745">AST_OPT_FLAG_INTERNAL_TIMING</a>) ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l00466"></a>00466    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Transmit silence during rec: %s\n&quot;</span>, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a48c2766ad365c08930d7966fbcde4dd6">AST_OPT_FLAG_TRANSMIT_SILENCE</a>) ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n* Subsystems\n&quot;</span>);
<a name="l00469"></a>00469    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  -------------\n&quot;</span>);
<a name="l00470"></a>00470    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Manager (AMI):               %s\n&quot;</span>, <a class="code" href="group__Group__AMI.html#gad908dfa4d3b37621b01531d8f9f41df6" title="Check if AMI is enabled.">check_manager_enabled</a>() ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l00471"></a>00471    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Web Manager (AMI/HTTP):      %s\n&quot;</span>, <a class="code" href="group__Group__AMI.html#gafd05c33fae7e3a3db836fede838c0b09" title="Check if AMI/HTTP is enabled.">check_webmanager_enabled</a>() ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l00472"></a>00472    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Call data records:           %s\n&quot;</span>, <a class="code" href="cdr_8h.html#a097451785b99018ce41b21681062ab0a" title="Return TRUE if CDR subsystem is enabled.">check_cdr_enabled</a>() ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l00473"></a>00473    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Realtime Architecture (ARA): %s\n&quot;</span>, <a class="code" href="config_8h.html#a6344200b56202a76de8db05af680f3ac" title="Check if there&amp;#39;s any realtime engines loaded.">ast_realtime_enabled</a>() ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l00474"></a>00474 <span class="comment"></span>
<a name="l00475"></a>00475 <span class="comment">   /*! \todo we could check musiconhold, voicemail, smdi, adsi, queues  */</span>
<a name="l00476"></a>00476 
<a name="l00477"></a>00477    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n* Directories\n&quot;</span>);
<a name="l00478"></a>00478    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  -------------\n&quot;</span>);
<a name="l00479"></a>00479    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Configuration file:          %s\n&quot;</span>, <a class="code" href="paths_8h.html#adea5f0a0a8720d1dbb47ca434fe78778">ast_config_AST_CONFIG_FILE</a>);
<a name="l00480"></a>00480    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Configuration directory:     %s\n&quot;</span>, <a class="code" href="paths_8h.html#a7d3836e5581e433c9f5edd30300cc187">ast_config_AST_CONFIG_DIR</a>);
<a name="l00481"></a>00481    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Module directory:            %s\n&quot;</span>, <a class="code" href="paths_8h.html#a5852d8e3bf5485c09b0f3d2c2375eec3">ast_config_AST_MODULE_DIR</a>);
<a name="l00482"></a>00482    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Spool directory:             %s\n&quot;</span>, <a class="code" href="paths_8h.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">ast_config_AST_SPOOL_DIR</a>);
<a name="l00483"></a>00483    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Log directory:               %s\n&quot;</span>, <a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a>);
<a name="l00484"></a>00484    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n\n&quot;</span>);
<a name="l00485"></a>00485    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00488"></a><a class="code" href="asterisk_8c.html#a3d42dc32df764617e2201c3637f824cc">00488</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a3d42dc32df764617e2201c3637f824cc">handle_show_threads</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00489"></a>00489 {
<a name="l00490"></a>00490    <span class="keywordtype">int</span> count = 0;
<a name="l00491"></a>00491    <span class="keyword">struct </span><a class="code" href="structthread__list__t.html">thread_list_t</a> *cur;
<a name="l00492"></a>00492    <span class="keywordflow">switch</span> (cmd) {
<a name="l00493"></a>00493    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00494"></a>00494       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show threads&quot;</span>;
<a name="l00495"></a>00495       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l00496"></a>00496          <span class="stringliteral">&quot;Usage: core show threads\n&quot;</span>
<a name="l00497"></a>00497          <span class="stringliteral">&quot;       List threads currently active in the system.\n&quot;</span>;
<a name="l00498"></a>00498       <span class="keywordflow">return</span> NULL;
<a name="l00499"></a>00499    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00500"></a>00500       <span class="keywordflow">return</span> NULL;
<a name="l00501"></a>00501    }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structthread__list.html">thread_list</a>);
<a name="l00504"></a>00504    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structthread__list.html">thread_list</a>, cur, <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>) {
<a name="l00505"></a>00505       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%p %s\n&quot;</span>, (<span class="keywordtype">void</span> *)cur-&gt;<a class="code" href="structthread__list__t.html#a2465fd4497a7402ad72da7d6e03f9934">id</a>, cur-&gt;<a class="code" href="structthread__list__t.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00506"></a>00506       count++;
<a name="l00507"></a>00507    }
<a name="l00508"></a>00508         <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structthread__list.html">thread_list</a>);
<a name="l00509"></a>00509    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d threads listed.\n&quot;</span>, count);
<a name="l00510"></a>00510    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513 <span class="preprocessor">#if defined (HAVE_SYSCTL) &amp;&amp; defined(HAVE_SWAPCTL)</span>
<a name="l00514"></a>00514 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00515"></a>00515 <span class="comment"> * swapmode is rewritten by Tobias Weingartner &lt;weingart@openbsd.org&gt;</span>
<a name="l00516"></a>00516 <span class="comment"> * to be based on the new swapctl(2) system call.</span>
<a name="l00517"></a>00517 <span class="comment"> */</span>
<a name="l00518"></a>00518 <span class="keyword">static</span> <span class="keywordtype">int</span> swapmode(<span class="keywordtype">int</span> *used, <span class="keywordtype">int</span> *<a class="code" href="res__adsi_8c.html#ac7af894858cf396a219d632f40afdc8d">total</a>)
<a name="l00519"></a>00519 {
<a name="l00520"></a>00520    <span class="keyword">struct </span>swapent *swdev;
<a name="l00521"></a>00521    <span class="keywordtype">int</span> nswap, rnswap, i;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523    nswap = swapctl(SWAP_NSWAP, 0, 0);
<a name="l00524"></a>00524    <span class="keywordflow">if</span> (nswap == 0)
<a name="l00525"></a>00525       <span class="keywordflow">return</span> 0;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527    swdev = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(nswap, <span class="keyword">sizeof</span>(*swdev));
<a name="l00528"></a>00528    <span class="keywordflow">if</span> (swdev == NULL)
<a name="l00529"></a>00529       <span class="keywordflow">return</span> 0;
<a name="l00530"></a>00530 
<a name="l00531"></a>00531    rnswap = swapctl(SWAP_STATS, swdev, nswap);
<a name="l00532"></a>00532    <span class="keywordflow">if</span> (rnswap == -1) {
<a name="l00533"></a>00533       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(swdev);
<a name="l00534"></a>00534       <span class="keywordflow">return</span> 0;
<a name="l00535"></a>00535    }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537    <span class="comment">/* if rnswap != nswap, then what? */</span>
<a name="l00538"></a>00538 
<a name="l00539"></a>00539    <span class="comment">/* Total things up */</span>
<a name="l00540"></a>00540    *total = *used = 0;
<a name="l00541"></a>00541    <span class="keywordflow">for</span> (i = 0; i &lt; nswap; i++) {
<a name="l00542"></a>00542       <span class="keywordflow">if</span> (swdev[i].se_flags &amp; SWF_ENABLE) {
<a name="l00543"></a>00543          *used += (swdev[i].se_inuse / (1024 / DEV_BSIZE));
<a name="l00544"></a>00544          *total += (swdev[i].se_nblks / (1024 / DEV_BSIZE));
<a name="l00545"></a>00545       }
<a name="l00546"></a>00546    }
<a name="l00547"></a>00547    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(swdev);
<a name="l00548"></a>00548    <span class="keywordflow">return</span> 1;
<a name="l00549"></a>00549 }
<a name="l00550"></a>00550 <span class="preprocessor">#elif defined(HAVE_SYSCTL) &amp;&amp; !defined(HAVE_SYSINFO)</span>
<a name="l00551"></a>00551 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> swapmode(<span class="keywordtype">int</span> *used, <span class="keywordtype">int</span> *total)
<a name="l00552"></a>00552 {
<a name="l00553"></a>00553    *used = *total = 0;
<a name="l00554"></a>00554    <span class="keywordflow">return</span> 1;
<a name="l00555"></a>00555 }
<a name="l00556"></a>00556 <span class="preprocessor">#endif</span>
<a name="l00557"></a>00557 <span class="preprocessor"></span>
<a name="l00558"></a>00558 <span class="preprocessor">#if defined(HAVE_SYSINFO) || defined(HAVE_SYSCTL)</span>
<a name="l00559"></a>00559 <span class="preprocessor"></span><span class="comment">/*! \brief Give an overview of system statistics */</span>
<a name="l00560"></a>00560 <span class="keyword">static</span> <span class="keywordtype">char</span> *handle_show_sysinfo(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00561"></a>00561 {
<a name="l00562"></a>00562    int64_t physmem, freeram;
<a name="l00563"></a>00563    <span class="keywordtype">int</span> totalswap = 0, freeswap = 0, nprocs = 0;
<a name="l00564"></a>00564    <span class="keywordtype">long</span> uptime = 0;
<a name="l00565"></a>00565 <span class="preprocessor">#if defined(HAVE_SYSINFO)</span>
<a name="l00566"></a>00566 <span class="preprocessor"></span>   <span class="keyword">struct </span>sysinfo sys_info;
<a name="l00567"></a>00567    sysinfo(&amp;sys_info);
<a name="l00568"></a>00568    uptime = sys_info.uptime/3600;
<a name="l00569"></a>00569    physmem = sys_info.totalram * sys_info.mem_unit;
<a name="l00570"></a>00570    freeram = (sys_info.freeram * sys_info.mem_unit) / 1024;
<a name="l00571"></a>00571    totalswap = (sys_info.totalswap * sys_info.mem_unit) / 1024;
<a name="l00572"></a>00572    freeswap = (sys_info.freeswap * sys_info.mem_unit) / 1024;
<a name="l00573"></a>00573    nprocs = sys_info.procs;
<a name="l00574"></a>00574 <span class="preprocessor">#elif defined(HAVE_SYSCTL)</span>
<a name="l00575"></a>00575 <span class="preprocessor"></span>   <span class="keyword">static</span> <span class="keywordtype">int</span> pageshift;
<a name="l00576"></a>00576    <span class="keyword">struct </span>vmtotal vmtotal;
<a name="l00577"></a>00577    <span class="keyword">struct </span>timeval boottime;
<a name="l00578"></a>00578    time_t   now;
<a name="l00579"></a>00579    <span class="keywordtype">int</span> mib[2], pagesize, usedswap = 0;
<a name="l00580"></a>00580    <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l00581"></a>00581    <span class="comment">/* calculate the uptime by looking at boottime */</span>
<a name="l00582"></a>00582    time(&amp;now);
<a name="l00583"></a>00583    mib[0] = CTL_KERN;
<a name="l00584"></a>00584    mib[1] = KERN_BOOTTIME;
<a name="l00585"></a>00585    len = <span class="keyword">sizeof</span>(boottime);
<a name="l00586"></a>00586    <span class="keywordflow">if</span> (sysctl(mib, 2, &amp;boottime, &amp;len, NULL, 0) != -1) {
<a name="l00587"></a>00587       uptime = now - boottime.tv_sec;
<a name="l00588"></a>00588    }
<a name="l00589"></a>00589    uptime = uptime/3600;
<a name="l00590"></a>00590    <span class="comment">/* grab total physical memory  */</span>
<a name="l00591"></a>00591    mib[0] = CTL_HW;
<a name="l00592"></a>00592 <span class="preprocessor">#if defined(HW_PHYSMEM64)</span>
<a name="l00593"></a>00593 <span class="preprocessor"></span>   mib[1] = HW_PHYSMEM64;
<a name="l00594"></a>00594 <span class="preprocessor">#else</span>
<a name="l00595"></a>00595 <span class="preprocessor"></span>   mib[1] = HW_PHYSMEM;
<a name="l00596"></a>00596 <span class="preprocessor">#endif</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span>   len = <span class="keyword">sizeof</span>(physmem);
<a name="l00598"></a>00598    sysctl(mib, 2, &amp;physmem, &amp;len, NULL, 0);
<a name="l00599"></a>00599 
<a name="l00600"></a>00600    pagesize = getpagesize();
<a name="l00601"></a>00601    pageshift = 0;
<a name="l00602"></a>00602    <span class="keywordflow">while</span> (pagesize &gt; 1) {
<a name="l00603"></a>00603       pageshift++;
<a name="l00604"></a>00604       pagesize &gt;&gt;= 1;
<a name="l00605"></a>00605    }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607    <span class="comment">/* we only need the amount of log(2)1024 for our conversion */</span>
<a name="l00608"></a>00608    pageshift -= 10;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610    <span class="comment">/* grab vm totals */</span>
<a name="l00611"></a>00611    mib[0] = CTL_VM;
<a name="l00612"></a>00612    mib[1] = VM_METER;
<a name="l00613"></a>00613    len = <span class="keyword">sizeof</span>(vmtotal);
<a name="l00614"></a>00614    sysctl(mib, 2, &amp;vmtotal, &amp;len, NULL, 0);
<a name="l00615"></a>00615    freeram = (vmtotal.t_free &lt;&lt; pageshift);
<a name="l00616"></a>00616    <span class="comment">/* generate swap usage and totals */</span>
<a name="l00617"></a>00617    swapmode(&amp;usedswap, &amp;totalswap); 
<a name="l00618"></a>00618    freeswap = (totalswap - usedswap);
<a name="l00619"></a>00619    <span class="comment">/* grab number of processes */</span>
<a name="l00620"></a>00620 <span class="preprocessor">#if defined(__OpenBSD__)</span>
<a name="l00621"></a>00621 <span class="preprocessor"></span>   mib[0] = CTL_KERN;
<a name="l00622"></a>00622    mib[1] = KERN_NPROCS;
<a name="l00623"></a>00623    len = <span class="keyword">sizeof</span>(nprocs);
<a name="l00624"></a>00624    sysctl(mib, 2, &amp;nprocs, &amp;len, NULL, 0);
<a name="l00625"></a>00625 <span class="preprocessor">#endif</span>
<a name="l00626"></a>00626 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00627"></a>00627 <span class="preprocessor"></span>
<a name="l00628"></a>00628    <span class="keywordflow">switch</span> (cmd) {
<a name="l00629"></a>00629    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00630"></a>00630       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show sysinfo&quot;</span>;
<a name="l00631"></a>00631       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00632"></a>00632          <span class="stringliteral">&quot;Usage: core show sysinfo\n&quot;</span>
<a name="l00633"></a>00633          <span class="stringliteral">&quot;       List current system information.\n&quot;</span>;
<a name="l00634"></a>00634       <span class="keywordflow">return</span> NULL;
<a name="l00635"></a>00635    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00636"></a>00636       <span class="keywordflow">return</span> NULL;
<a name="l00637"></a>00637    }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\nSystem Statistics\n&quot;</span>);
<a name="l00640"></a>00640    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;-----------------\n&quot;</span>);
<a name="l00641"></a>00641    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  System Uptime:             %ld hours\n&quot;</span>, uptime);
<a name="l00642"></a>00642    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Total RAM:                 %ld KiB\n&quot;</span>, (<span class="keywordtype">long</span>)physmem/1024);
<a name="l00643"></a>00643    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Free RAM:                  %ld KiB\n&quot;</span>, (<span class="keywordtype">long</span>)freeram);
<a name="l00644"></a>00644 <span class="preprocessor">#if defined(HAVE_SYSINFO)</span>
<a name="l00645"></a>00645 <span class="preprocessor"></span>   <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Buffer RAM:                %ld KiB\n&quot;</span>, (sys_info.bufferram * sys_info.mem_unit)/1024);
<a name="l00646"></a>00646 <span class="preprocessor">#endif</span>
<a name="l00647"></a>00647 <span class="preprocessor"></span>   <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Total Swap Space:          %ld KiB\n&quot;</span>, (<span class="keywordtype">long</span>)totalswap);
<a name="l00648"></a>00648    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Free Swap Space:           %ld KiB\n\n&quot;</span>, (<span class="keywordtype">long</span>)freeswap);
<a name="l00649"></a>00649    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Number of Processes:       %d \n\n&quot;</span>, nprocs);
<a name="l00650"></a>00650    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 <span class="preprocessor">#endif</span>
<a name="l00653"></a>00653 <span class="preprocessor"></span>
<a name="l00654"></a><a class="code" href="structprofile__entry.html">00654</a> <span class="keyword">struct </span><a class="code" href="structprofile__entry.html">profile_entry</a> {
<a name="l00655"></a><a class="code" href="structprofile__entry.html#a8f8f80d37794cde9472343e4487ba3eb">00655</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>;
<a name="l00656"></a><a class="code" href="structprofile__entry.html#ada66dc311f24213ab6af727a07d97205">00656</a>    uint64_t scale;   <span class="comment">/* if non-zero, values are scaled by this */</span>
<a name="l00657"></a><a class="code" href="structprofile__entry.html#a675daec89f956f8bafc1ff2dc3e86155">00657</a>    int64_t  mark;
<a name="l00658"></a><a class="code" href="structprofile__entry.html#ac072af30c4ffbc834bb4c681f6ecb514">00658</a>    int64_t  value;
<a name="l00659"></a><a class="code" href="structprofile__entry.html#a15cf6039b397e491e02d273d76f3485e">00659</a>    int64_t  <a class="code" href="app__adsiprog_8c.html#a31547b3fbfe860fc4518ce2332297f9b">events</a>;
<a name="l00660"></a>00660 };
<a name="l00661"></a>00661 
<a name="l00662"></a><a class="code" href="structprofile__data.html">00662</a> <span class="keyword">struct </span><a class="code" href="structprofile__data.html">profile_data</a> {
<a name="l00663"></a><a class="code" href="structprofile__data.html#a05de9d2e9fdfcc8bf932ca13b95ede29">00663</a>    <span class="keywordtype">int</span> entries;
<a name="l00664"></a><a class="code" href="structprofile__data.html#a98ca8117bc73d9d7520727c4ce8772e6">00664</a>    <span class="keywordtype">int</span> max_size;
<a name="l00665"></a><a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">00665</a>    <span class="keyword">struct </span><a class="code" href="structprofile__entry.html">profile_entry</a> e[0];
<a name="l00666"></a>00666 };
<a name="l00667"></a>00667 
<a name="l00668"></a><a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">00668</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structprofile__data.html">profile_data</a> *<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>;
<a name="l00669"></a>00669 <span class="comment"></span>
<a name="l00670"></a>00670 <span class="comment">/*! \brief allocates a counter with a given name and scale.</span>
<a name="l00671"></a>00671 <span class="comment"> * \return Returns the identifier of the counter.</span>
<a name="l00672"></a>00672 <span class="comment"> */</span>
<a name="l00673"></a><a class="code" href="asterisk_8c.html#a334294b1940f73a5fec03aceb70a9e2d">00673</a> <span class="keywordtype">int</span> <a class="code" href="asterisk_8h.html#a075573924d385edb22dd8dedbd433256" title="support for event profiling">ast_add_profile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, uint64_t scale)
<a name="l00674"></a>00674 {
<a name="l00675"></a>00675    <span class="keywordtype">int</span> l = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structprofile__data.html">profile_data</a>);
<a name="l00676"></a>00676    <span class="keywordtype">int</span> n = 10; <span class="comment">/* default entries */</span>
<a name="l00677"></a>00677 
<a name="l00678"></a>00678    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a> == NULL) {
<a name="l00679"></a>00679       <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a> = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, l + n*<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structprofile__entry.html">profile_entry</a>));
<a name="l00680"></a>00680       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a> == NULL)
<a name="l00681"></a>00681          <span class="keywordflow">return</span> -1;
<a name="l00682"></a>00682       <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#a05de9d2e9fdfcc8bf932ca13b95ede29">entries</a> = 0;
<a name="l00683"></a>00683       <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#a98ca8117bc73d9d7520727c4ce8772e6">max_size</a> = n;
<a name="l00684"></a>00684    }
<a name="l00685"></a>00685    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#a05de9d2e9fdfcc8bf932ca13b95ede29">entries</a> &gt;= <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#a98ca8117bc73d9d7520727c4ce8772e6">max_size</a>) {
<a name="l00686"></a>00686       <span class="keywordtype">void</span> *p;
<a name="l00687"></a>00687       n = <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#a98ca8117bc73d9d7520727c4ce8772e6">max_size</a> + 20;
<a name="l00688"></a>00688       p = <a class="code" href="astmm_8h.html#aa852314efa0cfeecee97ffc51b649734">ast_realloc</a>(<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>, l + n*<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structprofile__entry.html">profile_entry</a>));
<a name="l00689"></a>00689       <span class="keywordflow">if</span> (p == NULL)
<a name="l00690"></a>00690          <span class="keywordflow">return</span> -1;
<a name="l00691"></a>00691       <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a> = p;
<a name="l00692"></a>00692       <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#a98ca8117bc73d9d7520727c4ce8772e6">max_size</a> = n;
<a name="l00693"></a>00693    }
<a name="l00694"></a>00694    n = <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#a05de9d2e9fdfcc8bf932ca13b95ede29">entries</a>++;
<a name="l00695"></a>00695    <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[n].<a class="code" href="structprofile__entry.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(name);
<a name="l00696"></a>00696    <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[n].<a class="code" href="structprofile__entry.html#ac072af30c4ffbc834bb4c681f6ecb514">value</a> = 0;
<a name="l00697"></a>00697    <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[n].<a class="code" href="structprofile__entry.html#a15cf6039b397e491e02d273d76f3485e">events</a> = 0;
<a name="l00698"></a>00698    <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[n].<a class="code" href="structprofile__entry.html#a675daec89f956f8bafc1ff2dc3e86155">mark</a> = 0;
<a name="l00699"></a>00699    <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[n].<a class="code" href="structprofile__entry.html#ada66dc311f24213ab6af727a07d97205">scale</a> = scale;
<a name="l00700"></a>00700    <span class="keywordflow">return</span> n;
<a name="l00701"></a>00701 }
<a name="l00702"></a>00702 
<a name="l00703"></a><a class="code" href="asterisk_8c.html#af97fa49b90705f0b818d7cc77aaae54c">00703</a> int64_t <a class="code" href="asterisk_8h.html#a9884b316c6b39504d33d89ad6424ddbc">ast_profile</a>(<span class="keywordtype">int</span> i, int64_t delta)
<a name="l00704"></a>00704 {
<a name="l00705"></a>00705    <span class="keywordflow">if</span> (!<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a> || i &lt; 0 || i &gt; <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#a05de9d2e9fdfcc8bf932ca13b95ede29">entries</a>) <span class="comment">/* invalid index */</span>
<a name="l00706"></a>00706       <span class="keywordflow">return</span> 0;
<a name="l00707"></a>00707    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#ada66dc311f24213ab6af727a07d97205">scale</a> &gt; 1)
<a name="l00708"></a>00708       delta /= <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#ada66dc311f24213ab6af727a07d97205">scale</a>;
<a name="l00709"></a>00709    <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#ac072af30c4ffbc834bb4c681f6ecb514">value</a> += delta;
<a name="l00710"></a>00710    <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#a15cf6039b397e491e02d273d76f3485e">events</a>++;
<a name="l00711"></a>00711    <span class="keywordflow">return</span> <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#ac072af30c4ffbc834bb4c681f6ecb514">value</a>;
<a name="l00712"></a>00712 }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 <span class="comment">/* The RDTSC instruction was introduced on the Pentium processor and is not</span>
<a name="l00715"></a>00715 <span class="comment"> * implemented on certain clones, like the Cyrix 586. Hence, the previous</span>
<a name="l00716"></a>00716 <span class="comment"> * expectation of __i386__ was in error. */</span>
<a name="l00717"></a>00717 <span class="preprocessor">#if defined ( __i686__) &amp;&amp; (defined(__FreeBSD__) || defined(linux))</span>
<a name="l00718"></a>00718 <span class="preprocessor"></span><span class="preprocessor">#if defined(__FreeBSD__)</span>
<a name="l00719"></a>00719 <span class="preprocessor"></span><span class="preprocessor">#include &lt;machine/cpufunc.h&gt;</span>
<a name="l00720"></a>00720 <span class="preprocessor">#elif defined(linux)</span>
<a name="l00721"></a>00721 <span class="preprocessor"></span><span class="keyword">static</span> __inline uint64_t
<a name="l00722"></a>00722 <a class="code" href="asterisk_8c.html#a4840b412d71c9ff725760b9d5d3bfe25">rdtsc</a>(<span class="keywordtype">void</span>)
<a name="l00723"></a>00723 { 
<a name="l00724"></a>00724    uint64_t rv;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726    __asm __volatile(<span class="stringliteral">&quot;.byte 0x0f, 0x31&quot;</span> : <span class="stringliteral">&quot;=A&quot;</span> (rv));
<a name="l00727"></a>00727    <span class="keywordflow">return</span> (rv);
<a name="l00728"></a>00728 }
<a name="l00729"></a>00729 <span class="preprocessor">#endif</span>
<a name="l00730"></a>00730 <span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* supply a dummy function on other platforms */</span>
<a name="l00731"></a>00731 <span class="keyword">static</span> __inline uint64_t
<a name="l00732"></a><a class="code" href="asterisk_8c.html#a4840b412d71c9ff725760b9d5d3bfe25">00732</a> <a class="code" href="asterisk_8c.html#a4840b412d71c9ff725760b9d5d3bfe25">rdtsc</a>(<span class="keywordtype">void</span>)
<a name="l00733"></a>00733 {
<a name="l00734"></a>00734    <span class="keywordflow">return</span> 0;
<a name="l00735"></a>00735 }
<a name="l00736"></a>00736 <span class="preprocessor">#endif</span>
<a name="l00737"></a>00737 <span class="preprocessor"></span>
<a name="l00738"></a><a class="code" href="asterisk_8c.html#a080b9ad27161383b1b3f76f04b59753b">00738</a> int64_t <a class="code" href="asterisk_8h.html#a84666fa713cf20e8bc7e2d8524a10ce0">ast_mark</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> startstop)
<a name="l00739"></a>00739 {
<a name="l00740"></a>00740    <span class="keywordflow">if</span> (!<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a> || i &lt; 0 || i &gt; <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#a05de9d2e9fdfcc8bf932ca13b95ede29">entries</a>) <span class="comment">/* invalid index */</span>
<a name="l00741"></a>00741       <span class="keywordflow">return</span> 0;
<a name="l00742"></a>00742    <span class="keywordflow">if</span> (startstop == 1)
<a name="l00743"></a>00743       <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#a675daec89f956f8bafc1ff2dc3e86155">mark</a> = <a class="code" href="asterisk_8c.html#a4840b412d71c9ff725760b9d5d3bfe25">rdtsc</a>();
<a name="l00744"></a>00744    <span class="keywordflow">else</span> {
<a name="l00745"></a>00745       <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#a675daec89f956f8bafc1ff2dc3e86155">mark</a> = (<a class="code" href="asterisk_8c.html#a4840b412d71c9ff725760b9d5d3bfe25">rdtsc</a>() - <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#a675daec89f956f8bafc1ff2dc3e86155">mark</a>);
<a name="l00746"></a>00746       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#ada66dc311f24213ab6af727a07d97205">scale</a> &gt; 1)
<a name="l00747"></a>00747          <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#a675daec89f956f8bafc1ff2dc3e86155">mark</a> /= <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#ada66dc311f24213ab6af727a07d97205">scale</a>;
<a name="l00748"></a>00748       <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#ac072af30c4ffbc834bb4c681f6ecb514">value</a> += <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#a675daec89f956f8bafc1ff2dc3e86155">mark</a>;
<a name="l00749"></a>00749       <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#a15cf6039b397e491e02d273d76f3485e">events</a>++;
<a name="l00750"></a>00750    }
<a name="l00751"></a>00751    <span class="keywordflow">return</span> <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#a675daec89f956f8bafc1ff2dc3e86155">mark</a>;
<a name="l00752"></a>00752 }
<a name="l00753"></a>00753 
<a name="l00754"></a><a class="code" href="asterisk_8c.html#ab0975860bf91fec3bf674341a7cba5ec">00754</a> <span class="preprocessor">#define DEFINE_PROFILE_MIN_MAX_VALUES min = 0; \</span>
<a name="l00755"></a>00755 <span class="preprocessor">   max = prof_data-&gt;entries;\</span>
<a name="l00756"></a>00756 <span class="preprocessor">   if  (a-&gt;argc &gt; 3) { </span><span class="comment">/* specific entries */</span> \
<a name="l00757"></a>00757       if (isdigit(a-&gt;argv[3][0])) { \
<a name="l00758"></a>00758          min = atoi(a-&gt;argv[3]); \
<a name="l00759"></a>00759          if (a-&gt;argc == 5 &amp;&amp; strcmp(a-&gt;argv[4], &quot;-&quot;)) \
<a name="l00760"></a>00760             max = atoi(a-&gt;argv[4]); \
<a name="l00761"></a>00761       } else \
<a name="l00762"></a>00762          search = a-&gt;argv[3]; \
<a name="l00763"></a>00763    } \
<a name="l00764"></a>00764    if (max &gt; prof_data-&gt;entries) \
<a name="l00765"></a>00765       max = prof_data-&gt;entries;
<a name="l00766"></a>00766 
<a name="l00767"></a><a class="code" href="asterisk_8c.html#acd2b29cf44212391e7c62499f7394db5">00767</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#acd2b29cf44212391e7c62499f7394db5">handle_show_profile</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00768"></a>00768 {
<a name="l00769"></a>00769    <span class="keywordtype">int</span> i, min, max;
<a name="l00770"></a>00770    <span class="keywordtype">char</span> *search = NULL;
<a name="l00771"></a>00771    <span class="keywordflow">switch</span> (cmd) {
<a name="l00772"></a>00772    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00773"></a>00773       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show profile&quot;</span>;
<a name="l00774"></a>00774       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = <span class="stringliteral">&quot;Usage: core show profile\n&quot;</span>
<a name="l00775"></a>00775             <span class="stringliteral">&quot;       show profile information&quot;</span>;
<a name="l00776"></a>00776       <span class="keywordflow">return</span> NULL;
<a name="l00777"></a>00777    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00778"></a>00778       <span class="keywordflow">return</span> NULL;
<a name="l00779"></a>00779    }
<a name="l00780"></a>00780 
<a name="l00781"></a>00781    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a> == NULL)
<a name="l00782"></a>00782       <span class="keywordflow">return</span> 0;
<a name="l00783"></a>00783 
<a name="l00784"></a>00784    <a class="code" href="asterisk_8c.html#ab0975860bf91fec3bf674341a7cba5ec">DEFINE_PROFILE_MIN_MAX_VALUES</a>;
<a name="l00785"></a>00785    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;profile values (%d, allocated %d)\n-------------------\n&quot;</span>,
<a name="l00786"></a>00786       <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#a05de9d2e9fdfcc8bf932ca13b95ede29">entries</a>, <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#a98ca8117bc73d9d7520727c4ce8772e6">max_size</a>);
<a name="l00787"></a>00787    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%6s   %8s  %10s %12s %12s  %s\n&quot;</span>, <span class="stringliteral">&quot;ID&quot;</span>, <span class="stringliteral">&quot;Scale&quot;</span>, <span class="stringliteral">&quot;Events&quot;</span>,
<a name="l00788"></a>00788          <span class="stringliteral">&quot;Value&quot;</span>, <span class="stringliteral">&quot;Average&quot;</span>, <span class="stringliteral">&quot;Name&quot;</span>);
<a name="l00789"></a>00789    <span class="keywordflow">for</span> (i = min; i &lt; max; i++) {
<a name="l00790"></a>00790       <span class="keyword">struct </span><a class="code" href="structprofile__entry.html">profile_entry</a> *entry = &amp;<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i];
<a name="l00791"></a>00791       <span class="keywordflow">if</span> (!search || strstr(entry-&gt;<a class="code" href="structprofile__entry.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, search))
<a name="l00792"></a>00792           <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%6d: [%8ld] %10ld %12lld %12lld  %s\n&quot;</span>,
<a name="l00793"></a>00793          i,
<a name="l00794"></a>00794          (<span class="keywordtype">long</span>)entry-&gt;<a class="code" href="structprofile__entry.html#ada66dc311f24213ab6af727a07d97205">scale</a>,
<a name="l00795"></a>00795          (<span class="keywordtype">long</span>)entry-&gt;<a class="code" href="structprofile__entry.html#a15cf6039b397e491e02d273d76f3485e">events</a>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)entry-&gt;<a class="code" href="structprofile__entry.html#ac072af30c4ffbc834bb4c681f6ecb514">value</a>,
<a name="l00796"></a>00796          (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)(entry-&gt;<a class="code" href="structprofile__entry.html#a15cf6039b397e491e02d273d76f3485e">events</a> ? entry-&gt;<a class="code" href="structprofile__entry.html#ac072af30c4ffbc834bb4c681f6ecb514">value</a> / entry-&gt;<a class="code" href="structprofile__entry.html#a15cf6039b397e491e02d273d76f3485e">events</a> : entry-&gt;<a class="code" href="structprofile__entry.html#ac072af30c4ffbc834bb4c681f6ecb514">value</a>),
<a name="l00797"></a>00797          entry-&gt;<a class="code" href="structprofile__entry.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00798"></a>00798    }
<a name="l00799"></a>00799    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00800"></a>00800 }
<a name="l00801"></a>00801 
<a name="l00802"></a><a class="code" href="asterisk_8c.html#aa1b8f26984e7b4f8359502eec3a8cd24">00802</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#aa1b8f26984e7b4f8359502eec3a8cd24">handle_clear_profile</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00803"></a>00803 {
<a name="l00804"></a>00804    <span class="keywordtype">int</span> i, min, max;
<a name="l00805"></a>00805    <span class="keywordtype">char</span> *search = NULL;
<a name="l00806"></a>00806    <span class="keywordflow">switch</span> (cmd) {
<a name="l00807"></a>00807    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00808"></a>00808       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core clear profile&quot;</span>;
<a name="l00809"></a>00809       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = <span class="stringliteral">&quot;Usage: core clear profile\n&quot;</span>
<a name="l00810"></a>00810             <span class="stringliteral">&quot;       clear profile information&quot;</span>;
<a name="l00811"></a>00811       <span class="keywordflow">return</span> NULL;
<a name="l00812"></a>00812    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00813"></a>00813       <span class="keywordflow">return</span> NULL;
<a name="l00814"></a>00814    }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a> == NULL)
<a name="l00817"></a>00817       <span class="keywordflow">return</span> 0;
<a name="l00818"></a>00818 
<a name="l00819"></a>00819    <a class="code" href="asterisk_8c.html#ab0975860bf91fec3bf674341a7cba5ec">DEFINE_PROFILE_MIN_MAX_VALUES</a>;
<a name="l00820"></a>00820    <span class="keywordflow">for</span> (i= min; i &lt; max; i++) {
<a name="l00821"></a>00821       <span class="keywordflow">if</span> (!search || strstr(<a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, search)) {
<a name="l00822"></a>00822          <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#ac072af30c4ffbc834bb4c681f6ecb514">value</a> = 0;
<a name="l00823"></a>00823          <a class="code" href="asterisk_8c.html#a2440f826f27f1682698a5d791e39ce42">prof_data</a>-&gt;<a class="code" href="structprofile__data.html#acd5cf24052b882eb848f02d9e3b24ee4">e</a>[i].<a class="code" href="structprofile__entry.html#a15cf6039b397e491e02d273d76f3485e">events</a> = 0;
<a name="l00824"></a>00824       }
<a name="l00825"></a>00825    }
<a name="l00826"></a>00826    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00827"></a>00827 }
<a name="l00828"></a>00828 <span class="preprocessor">#undef DEFINE_PROFILE_MIN_MAX_VALUES</span>
<a name="l00829"></a>00829 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00830"></a>00830 <span class="comment">/*! \brief CLI command to list module versions */</span>
<a name="l00831"></a><a class="code" href="asterisk_8c.html#a88756d428992323e89c4cc2310bc16b3">00831</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a88756d428992323e89c4cc2310bc16b3" title="CLI command to list module versions.">handle_show_version_files</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833 <span class="preprocessor">#define FORMAT &quot;%-25.25s %-40.40s\n&quot;</span>
<a name="l00834"></a>00834 <span class="preprocessor"></span>   <span class="keyword">struct </span><a class="code" href="structfile__version.html">file_version</a> *iterator;
<a name="l00835"></a>00835    regex_t regexbuf;
<a name="l00836"></a>00836    <span class="keywordtype">int</span> havepattern = 0;
<a name="l00837"></a>00837    <span class="keywordtype">int</span> havename = 0;
<a name="l00838"></a>00838    <span class="keywordtype">int</span> count_files = 0;
<a name="l00839"></a>00839    <span class="keywordtype">char</span> *ret = NULL;
<a name="l00840"></a>00840    <span class="keywordtype">int</span> matchlen, which = 0;
<a name="l00841"></a>00841    <span class="keyword">struct </span><a class="code" href="structfile__version.html">file_version</a> *find;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843    <span class="keywordflow">switch</span> (cmd) {
<a name="l00844"></a>00844    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00845"></a>00845       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show file version [like]&quot;</span>;
<a name="l00846"></a>00846       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l00847"></a>00847          <span class="stringliteral">&quot;Usage: core show file version [like &lt;pattern&gt;]\n&quot;</span>
<a name="l00848"></a>00848          <span class="stringliteral">&quot;       Lists the revision numbers of the files used to build this copy of Asterisk.\n&quot;</span>
<a name="l00849"></a>00849          <span class="stringliteral">&quot;       Optional regular expression pattern is used to filter the file list.\n&quot;</span>;
<a name="l00850"></a>00850       <span class="keywordflow">return</span> NULL;
<a name="l00851"></a>00851    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00852"></a>00852       matchlen = strlen(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>);
<a name="l00853"></a>00853       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> != 3)
<a name="l00854"></a>00854          <span class="keywordflow">return</span> NULL;
<a name="l00855"></a>00855       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>);
<a name="l00856"></a>00856       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>, find, <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>) {
<a name="l00857"></a>00857          <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, find-&gt;<a class="code" href="structfile__version.html#af0baa3ccdd9d2a6adf03b72e2bea5789">file</a>, matchlen) &amp;&amp; ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>) {
<a name="l00858"></a>00858             ret = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(find-&gt;<a class="code" href="structfile__version.html#af0baa3ccdd9d2a6adf03b72e2bea5789">file</a>);
<a name="l00859"></a>00859             <span class="keywordflow">break</span>;
<a name="l00860"></a>00860          }
<a name="l00861"></a>00861       }
<a name="l00862"></a>00862       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>);
<a name="l00863"></a>00863       <span class="keywordflow">return</span> ret;
<a name="l00864"></a>00864    }
<a name="l00865"></a>00865 
<a name="l00866"></a>00866 
<a name="l00867"></a>00867    <span class="keywordflow">switch</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>) {
<a name="l00868"></a>00868    <span class="keywordflow">case</span> 6:
<a name="l00869"></a>00869       <span class="keywordflow">if</span> (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;like&quot;</span>)) {
<a name="l00870"></a>00870          <span class="keywordflow">if</span> (regcomp(&amp;regexbuf, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5], REG_EXTENDED | REG_NOSUB))
<a name="l00871"></a>00871             <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00872"></a>00872          havepattern = 1;
<a name="l00873"></a>00873       } <span class="keywordflow">else</span>
<a name="l00874"></a>00874          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00875"></a>00875       <span class="keywordflow">break</span>;
<a name="l00876"></a>00876    <span class="keywordflow">case</span> 5:
<a name="l00877"></a>00877       havename = 1;
<a name="l00878"></a>00878       <span class="keywordflow">break</span>;
<a name="l00879"></a>00879    <span class="keywordflow">case</span> 4:
<a name="l00880"></a>00880       <span class="keywordflow">break</span>;
<a name="l00881"></a>00881    <span class="keywordflow">default</span>:
<a name="l00882"></a>00882       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00883"></a>00883    }
<a name="l00884"></a>00884 
<a name="l00885"></a>00885    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, <span class="stringliteral">&quot;File&quot;</span>, <span class="stringliteral">&quot;Revision&quot;</span>);
<a name="l00886"></a>00886    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, <span class="stringliteral">&quot;----&quot;</span>, <span class="stringliteral">&quot;--------&quot;</span>);
<a name="l00887"></a>00887    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>);
<a name="l00888"></a>00888    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>, iterator, <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>) {
<a name="l00889"></a>00889       <span class="keywordflow">if</span> (havename &amp;&amp; strcasecmp(iterator-&gt;<a class="code" href="structfile__version.html#af0baa3ccdd9d2a6adf03b72e2bea5789">file</a>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4]))
<a name="l00890"></a>00890          <span class="keywordflow">continue</span>;
<a name="l00891"></a>00891 
<a name="l00892"></a>00892       <span class="keywordflow">if</span> (havepattern &amp;&amp; regexec(&amp;regexbuf, iterator-&gt;<a class="code" href="structfile__version.html#af0baa3ccdd9d2a6adf03b72e2bea5789">file</a>, 0, NULL, 0))
<a name="l00893"></a>00893          <span class="keywordflow">continue</span>;
<a name="l00894"></a>00894 
<a name="l00895"></a>00895       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, iterator-&gt;<a class="code" href="structfile__version.html#af0baa3ccdd9d2a6adf03b72e2bea5789">file</a>, iterator-&gt;<a class="code" href="structfile__version.html#a56abfaab87c46691c1ef3ad0df23e864">version</a>);
<a name="l00896"></a>00896       count_files++;
<a name="l00897"></a>00897       <span class="keywordflow">if</span> (havename)
<a name="l00898"></a>00898          <span class="keywordflow">break</span>;
<a name="l00899"></a>00899    }
<a name="l00900"></a>00900    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfile__versions.html">file_versions</a>);
<a name="l00901"></a>00901    <span class="keywordflow">if</span> (!havename) {
<a name="l00902"></a>00902       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d files listed.\n&quot;</span>, count_files);
<a name="l00903"></a>00903    }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905    <span class="keywordflow">if</span> (havepattern)
<a name="l00906"></a>00906       regfree(&amp;regexbuf);
<a name="l00907"></a>00907 
<a name="l00908"></a>00908    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00909"></a>00909 <span class="preprocessor">#undef FORMAT</span>
<a name="l00910"></a>00910 <span class="preprocessor"></span>}
<a name="l00911"></a>00911 
<a name="l00912"></a>00912 <span class="preprocessor">#endif </span><span class="comment">/* ! LOW_MEMORY */</span>
<a name="l00913"></a>00913 
<a name="l00914"></a><a class="code" href="asterisk_8c.html#a9b09e95876dfecb9a8573819da0b255e">00914</a> <span class="keywordtype">int</span> <a class="code" href="asterisk_8h.html#a9b09e95876dfecb9a8573819da0b255e" title="Register a function to be executed before Asterisk exits.">ast_register_atexit</a>(<span class="keywordtype">void</span> (*<a class="code" href="structast__atexit.html#af406187a441c51e4589704fae05f15fe">func</a>)(<span class="keywordtype">void</span>))
<a name="l00915"></a>00915 {
<a name="l00916"></a>00916    <span class="keyword">struct </span><a class="code" href="structast__atexit.html">ast_atexit</a> *ae;
<a name="l00917"></a>00917 
<a name="l00918"></a>00918    <span class="keywordflow">if</span> (!(ae = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*ae))))
<a name="l00919"></a>00919       <span class="keywordflow">return</span> -1;
<a name="l00920"></a>00920 
<a name="l00921"></a>00921    ae-&gt;<a class="code" href="structast__atexit.html#af406187a441c51e4589704fae05f15fe">func</a> = <a class="code" href="structast__atexit.html#af406187a441c51e4589704fae05f15fe">func</a>;
<a name="l00922"></a>00922 
<a name="l00923"></a>00923    <a class="code" href="asterisk_8h.html#a7f60f486e8e4a322ae5132d791a94bcc" title="Unregister a function registered with ast_register_atexit().">ast_unregister_atexit</a>(<a class="code" href="structast__atexit.html#af406187a441c51e4589704fae05f15fe">func</a>);  
<a name="l00924"></a>00924 
<a name="l00925"></a>00925    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structatexits.html">atexits</a>);
<a name="l00926"></a>00926    <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;<a class="code" href="structatexits.html">atexits</a>, ae, <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>);
<a name="l00927"></a>00927    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structatexits.html">atexits</a>);
<a name="l00928"></a>00928 
<a name="l00929"></a>00929    <span class="keywordflow">return</span> 0;
<a name="l00930"></a>00930 }
<a name="l00931"></a>00931 
<a name="l00932"></a><a class="code" href="asterisk_8c.html#a7f60f486e8e4a322ae5132d791a94bcc">00932</a> <span class="keywordtype">void</span> <a class="code" href="asterisk_8h.html#a7f60f486e8e4a322ae5132d791a94bcc" title="Unregister a function registered with ast_register_atexit().">ast_unregister_atexit</a>(<span class="keywordtype">void</span> (*<a class="code" href="structast__atexit.html#af406187a441c51e4589704fae05f15fe">func</a>)(<span class="keywordtype">void</span>))
<a name="l00933"></a>00933 {
<a name="l00934"></a>00934    <span class="keyword">struct </span><a class="code" href="structast__atexit.html">ast_atexit</a> *ae = NULL;
<a name="l00935"></a>00935 
<a name="l00936"></a>00936    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structatexits.html">atexits</a>);
<a name="l00937"></a>00937    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structatexits.html">atexits</a>, ae, <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>) {
<a name="l00938"></a>00938       <span class="keywordflow">if</span> (ae-&gt;<a class="code" href="structast__atexit.html#af406187a441c51e4589704fae05f15fe">func</a> == <a class="code" href="structast__atexit.html#af406187a441c51e4589704fae05f15fe">func</a>) {
<a name="l00939"></a>00939          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(<a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>);
<a name="l00940"></a>00940          <span class="keywordflow">break</span>;
<a name="l00941"></a>00941       }
<a name="l00942"></a>00942    }
<a name="l00943"></a>00943    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l00944"></a>00944    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structatexits.html">atexits</a>);
<a name="l00945"></a>00945 
<a name="l00946"></a>00946    <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(ae);
<a name="l00947"></a>00947 }
<a name="l00948"></a>00948 
<a name="l00949"></a>00949 <span class="comment">/* Sending commands from consoles back to the daemon requires a terminating NULL */</span>
<a name="l00950"></a><a class="code" href="asterisk_8c.html#ac07499a06d0a0cf1d9ea14cf0693330a">00950</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#ac07499a06d0a0cf1d9ea14cf0693330a">fdsend</a>(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l00951"></a>00951 {
<a name="l00952"></a>00952    <span class="keywordflow">return</span> write(fd, s, strlen(s) + 1);
<a name="l00953"></a>00953 }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955 <span class="comment">/* Sending messages from the daemon back to the display requires _excluding_ the terminating NULL */</span>
<a name="l00956"></a><a class="code" href="asterisk_8c.html#a5fdbbc0b9ac75fff436821b5c16c3442">00956</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a5fdbbc0b9ac75fff436821b5c16c3442">fdprint</a>(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l00957"></a>00957 {
<a name="l00958"></a>00958    <span class="keywordflow">return</span> write(fd, s, strlen(s));
<a name="l00959"></a>00959 }
<a name="l00960"></a>00960 <span class="comment"></span>
<a name="l00961"></a>00961 <span class="comment">/*! \brief NULL handler so we can collect the child exit status */</span>
<a name="l00962"></a><a class="code" href="asterisk_8c.html#a95f3142d76995634e7f13cf69fbb4543">00962</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a95f3142d76995634e7f13cf69fbb4543" title="NULL handler so we can collect the child exit status.">null_sig_handler</a>(<span class="keywordtype">int</span> sig)
<a name="l00963"></a>00963 {
<a name="l00964"></a>00964 
<a name="l00965"></a>00965 }
<a name="l00966"></a>00966 
<a name="l00967"></a><a class="code" href="asterisk_8c.html#a9c7c59d291f21aa5325e793a912d9c26">00967</a> <a class="code" href="lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a>(<a class="code" href="asterisk_8c.html#a9c7c59d291f21aa5325e793a912d9c26">safe_system_lock</a>);<span class="comment"></span>
<a name="l00968"></a>00968 <span class="comment">/*! \brief Keep track of how many threads are currently trying to wait*() on</span>
<a name="l00969"></a>00969 <span class="comment"> *  a child process */</span>
<a name="l00970"></a><a class="code" href="asterisk_8c.html#a36152b6805cc14c6a2a41c2d283b422a">00970</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a36152b6805cc14c6a2a41c2d283b422a" title="Keep track of how many threads are currently trying to wait*() on a child process...">safe_system_level</a> = 0;
<a name="l00971"></a><a class="code" href="asterisk_8c.html#a52058b1d88250497f05cb29ee52c5d4d">00971</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="asterisk_8c.html#a52058b1d88250497f05cb29ee52c5d4d">safe_system_prev_handler</a>;
<a name="l00972"></a>00972 
<a name="l00973"></a><a class="code" href="asterisk_8c.html#a6de8ef28c39cc39978497de1918bfd70">00973</a> <span class="keywordtype">void</span> <a class="code" href="app_8h.html#a6de8ef28c39cc39978497de1918bfd70" title="Replace the SIGCHLD handler.">ast_replace_sigchld</a>(<span class="keywordtype">void</span>)
<a name="l00974"></a>00974 {
<a name="l00975"></a>00975    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="asterisk_8c.html#a9c7c59d291f21aa5325e793a912d9c26">safe_system_lock</a>);
<a name="l00978"></a>00978    level = <a class="code" href="asterisk_8c.html#a36152b6805cc14c6a2a41c2d283b422a" title="Keep track of how many threads are currently trying to wait*() on a child process...">safe_system_level</a>++;
<a name="l00979"></a>00979 
<a name="l00980"></a>00980    <span class="comment">/* only replace the handler if it has not already been done */</span>
<a name="l00981"></a>00981    <span class="keywordflow">if</span> (level == 0)
<a name="l00982"></a>00982       <a class="code" href="asterisk_8c.html#a52058b1d88250497f05cb29ee52c5d4d">safe_system_prev_handler</a> = signal(SIGCHLD, <a class="code" href="asterisk_8c.html#a95f3142d76995634e7f13cf69fbb4543" title="NULL handler so we can collect the child exit status.">null_sig_handler</a>);
<a name="l00983"></a>00983 
<a name="l00984"></a>00984    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="asterisk_8c.html#a9c7c59d291f21aa5325e793a912d9c26">safe_system_lock</a>);
<a name="l00985"></a>00985 }
<a name="l00986"></a>00986 
<a name="l00987"></a><a class="code" href="asterisk_8c.html#ad7c2a7da4125347c06d9719580731228">00987</a> <span class="keywordtype">void</span> <a class="code" href="app_8h.html#ad7c2a7da4125347c06d9719580731228" title="Restore the SIGCHLD handler.">ast_unreplace_sigchld</a>(<span class="keywordtype">void</span>)
<a name="l00988"></a>00988 {
<a name="l00989"></a>00989    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level;
<a name="l00990"></a>00990 
<a name="l00991"></a>00991    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="asterisk_8c.html#a9c7c59d291f21aa5325e793a912d9c26">safe_system_lock</a>);
<a name="l00992"></a>00992    level = --<a class="code" href="asterisk_8c.html#a36152b6805cc14c6a2a41c2d283b422a" title="Keep track of how many threads are currently trying to wait*() on a child process...">safe_system_level</a>;
<a name="l00993"></a>00993 
<a name="l00994"></a>00994    <span class="comment">/* only restore the handler if we are the last one */</span>
<a name="l00995"></a>00995    <span class="keywordflow">if</span> (level == 0)
<a name="l00996"></a>00996       signal(SIGCHLD, <a class="code" href="asterisk_8c.html#a52058b1d88250497f05cb29ee52c5d4d">safe_system_prev_handler</a>);
<a name="l00997"></a>00997 
<a name="l00998"></a>00998    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="asterisk_8c.html#a9c7c59d291f21aa5325e793a912d9c26">safe_system_lock</a>);
<a name="l00999"></a>00999 }
<a name="l01000"></a>01000 
<a name="l01001"></a><a class="code" href="asterisk_8c.html#a9fb5cf0385848033ee3e98625e5f9784">01001</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l01002"></a>01002 {
<a name="l01003"></a>01003    pid_t pid;
<a name="l01004"></a>01004    <span class="keywordtype">int</span> res;
<a name="l01005"></a>01005    <span class="keyword">struct </span>rusage rusage;
<a name="l01006"></a>01006    <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>;
<a name="l01007"></a>01007 
<a name="l01008"></a>01008 <span class="preprocessor">#if defined(HAVE_WORKING_FORK) || defined(HAVE_WORKING_VFORK)</span>
<a name="l01009"></a>01009 <span class="preprocessor"></span>   <a class="code" href="app_8h.html#a6de8ef28c39cc39978497de1918bfd70" title="Replace the SIGCHLD handler.">ast_replace_sigchld</a>();
<a name="l01010"></a>01010 
<a name="l01011"></a>01011 <span class="preprocessor">#ifdef HAVE_WORKING_FORK</span>
<a name="l01012"></a>01012 <span class="preprocessor"></span>   pid = fork();
<a name="l01013"></a>01013 <span class="preprocessor">#else</span>
<a name="l01014"></a>01014 <span class="preprocessor"></span>   pid = vfork();
<a name="l01015"></a>01015 <span class="preprocessor">#endif   </span>
<a name="l01016"></a>01016 <span class="preprocessor"></span>
<a name="l01017"></a>01017    <span class="keywordflow">if</span> (pid == 0) {
<a name="l01018"></a>01018 <span class="preprocessor">#ifdef HAVE_CAP</span>
<a name="l01019"></a>01019 <span class="preprocessor"></span>      cap_t cap = cap_from_text(<span class="stringliteral">&quot;cap_net_admin-eip&quot;</span>);
<a name="l01020"></a>01020 
<a name="l01021"></a>01021       <span class="keywordflow">if</span> (cap_set_proc(cap)) {
<a name="l01022"></a>01022          <span class="comment">/* Careful with order! Logging cannot happen after we close FDs */</span>
<a name="l01023"></a>01023          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to remove capabilities.\n&quot;</span>);
<a name="l01024"></a>01024       }
<a name="l01025"></a>01025       cap_free(cap);
<a name="l01026"></a>01026 <span class="preprocessor">#endif</span>
<a name="l01027"></a>01027 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_WORKING_FORK</span>
<a name="l01028"></a>01028 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a8445b47cb18dde73b1b233358a25ed68">ast_opt_high_priority</a>)
<a name="l01029"></a>01029          <a class="code" href="asterisk_8h.html#ad649acedd512a45c748a440e78a281c9" title="We set ourselves to a high priority, that we might pre-empt everything else. If your...">ast_set_priority</a>(0);
<a name="l01030"></a>01030       <span class="comment">/* Close file descriptors and launch system command */</span>
<a name="l01031"></a>01031       <a class="code" href="app_8h.html#afcbfdd6dfc8c5f0f549b0a5d7e263e97" title="Common routine for child processes, to close all fds prior to exec(2).">ast_close_fds_above_n</a>(STDERR_FILENO);
<a name="l01032"></a>01032 <span class="preprocessor">#endif</span>
<a name="l01033"></a>01033 <span class="preprocessor"></span>      execl(<span class="stringliteral">&quot;/bin/sh&quot;</span>, <span class="stringliteral">&quot;/bin/sh&quot;</span>, <span class="stringliteral">&quot;-c&quot;</span>, s, (<span class="keywordtype">char</span> *) NULL);
<a name="l01034"></a>01034       _exit(1);
<a name="l01035"></a>01035    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid &gt; 0) {
<a name="l01036"></a>01036       <span class="keywordflow">for</span> (;;) {
<a name="l01037"></a>01037          res = wait4(pid, &amp;status, 0, &amp;rusage);
<a name="l01038"></a>01038          <span class="keywordflow">if</span> (res &gt; -1) {
<a name="l01039"></a>01039             res = <a class="code" href="private_8h.html#aa5fda3caf01a15f80a9f2542ccc67b94">WIFEXITED</a>(status) ? <a class="code" href="private_8h.html#a77f17ed4771a558a0f16e5f3aecee222">WEXITSTATUS</a>(status) : -1;
<a name="l01040"></a>01040             <span class="keywordflow">break</span>;
<a name="l01041"></a>01041          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EINTR) 
<a name="l01042"></a>01042             <span class="keywordflow">break</span>;
<a name="l01043"></a>01043       }
<a name="l01044"></a>01044    } <span class="keywordflow">else</span> {
<a name="l01045"></a>01045       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Fork failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01046"></a>01046       res = -1;
<a name="l01047"></a>01047    }
<a name="l01048"></a>01048 
<a name="l01049"></a>01049    <a class="code" href="app_8h.html#ad7c2a7da4125347c06d9719580731228" title="Restore the SIGCHLD handler.">ast_unreplace_sigchld</a>();
<a name="l01050"></a>01050 <span class="preprocessor">#else </span><span class="comment">/* !defined(HAVE_WORKING_FORK) &amp;&amp; !defined(HAVE_WORKING_VFORK) */</span>
<a name="l01051"></a>01051    res = -1;
<a name="l01052"></a>01052 <span class="preprocessor">#endif</span>
<a name="l01053"></a>01053 <span class="preprocessor"></span>
<a name="l01054"></a>01054    <span class="keywordflow">return</span> res;
<a name="l01055"></a>01055 }
<a name="l01056"></a>01056 
<a name="l01057"></a><a class="code" href="asterisk_8c.html#a4f8c3e6c4cf3b41470b9df95f046a48d">01057</a> <span class="keywordtype">void</span> <a class="code" href="logger_8h.html#a4f8c3e6c4cf3b41470b9df95f046a48d">ast_console_toggle_loglevel</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> level, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l01058"></a>01058 {
<a name="l01059"></a>01059    <span class="keywordtype">int</span> x;
<a name="l01060"></a>01060    <span class="keywordflow">for</span> (x = 0;x &lt; <a class="code" href="asterisk_8c.html#a6d5a16b321d54d9be2b0592881329fdf">AST_MAX_CONNECTS</a>; x++) {
<a name="l01061"></a>01061       <span class="keywordflow">if</span> (fd == <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].fd) {
<a name="l01062"></a>01062          <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].<a class="code" href="structconsole.html#af74c640613d859156463a4ba7436f023">levels</a>[level] = state;
<a name="l01063"></a>01063          <span class="keywordflow">return</span>;
<a name="l01064"></a>01064       }
<a name="l01065"></a>01065    }
<a name="l01066"></a>01066 }
<a name="l01067"></a>01067 <span class="comment"></span>
<a name="l01068"></a>01068 <span class="comment">/*!</span>
<a name="l01069"></a>01069 <span class="comment"> * \brief mute or unmute a console from logging</span>
<a name="l01070"></a>01070 <span class="comment"> */</span>
<a name="l01071"></a><a class="code" href="asterisk_8c.html#a564debc26032b2a42212ac285b4113de">01071</a> <span class="keywordtype">void</span> <a class="code" href="logger_8h.html#a564debc26032b2a42212ac285b4113de" title="mute or unmute a console from logging">ast_console_toggle_mute</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> silent) {
<a name="l01072"></a>01072    <span class="keywordtype">int</span> x;
<a name="l01073"></a>01073    <span class="keywordflow">for</span> (x = 0;x &lt; <a class="code" href="asterisk_8c.html#a6d5a16b321d54d9be2b0592881329fdf">AST_MAX_CONNECTS</a>; x++) {
<a name="l01074"></a>01074       <span class="keywordflow">if</span> (fd == <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].fd) {
<a name="l01075"></a>01075          <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].mute) {
<a name="l01076"></a>01076             <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].<a class="code" href="structconsole.html#a29128ae5c15a12dea5fe4f263ba6cec1">mute</a> = 0;
<a name="l01077"></a>01077             <span class="keywordflow">if</span> (!silent)
<a name="l01078"></a>01078                <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;Console is not muted anymore.\n&quot;</span>);
<a name="l01079"></a>01079          } <span class="keywordflow">else</span> {
<a name="l01080"></a>01080             <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].<a class="code" href="structconsole.html#a29128ae5c15a12dea5fe4f263ba6cec1">mute</a> = 1;
<a name="l01081"></a>01081             <span class="keywordflow">if</span> (!silent)
<a name="l01082"></a>01082                <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;Console is muted.\n&quot;</span>);
<a name="l01083"></a>01083          }
<a name="l01084"></a>01084          <span class="keywordflow">return</span>;
<a name="l01085"></a>01085       }
<a name="l01086"></a>01086    }
<a name="l01087"></a>01087    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;Couldn&apos;t find remote console.\n&quot;</span>);
<a name="l01088"></a>01088 }
<a name="l01089"></a>01089 <span class="comment"></span>
<a name="l01090"></a>01090 <span class="comment">/*!</span>
<a name="l01091"></a>01091 <span class="comment"> * \brief log the string to all attached console clients</span>
<a name="l01092"></a>01092 <span class="comment"> */</span>
<a name="l01093"></a><a class="code" href="asterisk_8c.html#a5e9e9cb05fcc78aba3de2c19e99b08cd">01093</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a5e9e9cb05fcc78aba3de2c19e99b08cd" title="log the string to all attached console clients">ast_network_puts_mutable</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">string</span>, <span class="keywordtype">int</span> level)
<a name="l01094"></a>01094 {
<a name="l01095"></a>01095    <span class="keywordtype">int</span> x;
<a name="l01096"></a>01096    <span class="keywordflow">for</span> (x = 0;x &lt; <a class="code" href="asterisk_8c.html#a6d5a16b321d54d9be2b0592881329fdf">AST_MAX_CONNECTS</a>; x++) {
<a name="l01097"></a>01097       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].mute)
<a name="l01098"></a>01098          <span class="keywordflow">continue</span>;
<a name="l01099"></a>01099       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].fd &gt; -1) {
<a name="l01100"></a>01100          <span class="keywordflow">if</span> (!<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].<a class="code" href="logger_8c.html#a004b893a4391189108c29182f992a68a" title="Logging channels used in the Asterisk logging system.">levels</a>[level]) 
<a name="l01101"></a>01101             <a class="code" href="asterisk_8c.html#a5fdbbc0b9ac75fff436821b5c16c3442">fdprint</a>(<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].p[1], <span class="keywordtype">string</span>);
<a name="l01102"></a>01102       }
<a name="l01103"></a>01103    }
<a name="l01104"></a>01104 }
<a name="l01105"></a>01105 <span class="comment"></span>
<a name="l01106"></a>01106 <span class="comment">/*!</span>
<a name="l01107"></a>01107 <span class="comment"> * \brief log the string to the console, and all attached</span>
<a name="l01108"></a>01108 <span class="comment"> * console clients</span>
<a name="l01109"></a>01109 <span class="comment"> */</span>
<a name="l01110"></a><a class="code" href="asterisk_8c.html#a6b74ef8709c2a8f00f06c0933ca993a1">01110</a> <span class="keywordtype">void</span> <a class="code" href="logger_8h.html#a6b74ef8709c2a8f00f06c0933ca993a1" title="log the string to the console, and all attached console clients">ast_console_puts_mutable</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">string</span>, <span class="keywordtype">int</span> level)
<a name="l01111"></a>01111 {
<a name="l01112"></a>01112    fputs(<span class="keywordtype">string</span>, stdout);
<a name="l01113"></a>01113    fflush(stdout);
<a name="l01114"></a>01114    <a class="code" href="asterisk_8c.html#a5e9e9cb05fcc78aba3de2c19e99b08cd" title="log the string to all attached console clients">ast_network_puts_mutable</a>(<span class="keywordtype">string</span>, level);
<a name="l01115"></a>01115 }
<a name="l01116"></a>01116 <span class="comment"></span>
<a name="l01117"></a>01117 <span class="comment">/*!</span>
<a name="l01118"></a>01118 <span class="comment"> * \brief write the string to all attached console clients</span>
<a name="l01119"></a>01119 <span class="comment"> */</span>
<a name="l01120"></a><a class="code" href="asterisk_8c.html#a72d371bd0b4daedd44ad33b25dd52ca6">01120</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a72d371bd0b4daedd44ad33b25dd52ca6" title="write the string to all attached console clients">ast_network_puts</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">string</span>)
<a name="l01121"></a>01121 {
<a name="l01122"></a>01122    <span class="keywordtype">int</span> x;
<a name="l01123"></a>01123    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="asterisk_8c.html#a6d5a16b321d54d9be2b0592881329fdf">AST_MAX_CONNECTS</a>; x++) {
<a name="l01124"></a>01124       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].fd &gt; -1) 
<a name="l01125"></a>01125          <a class="code" href="asterisk_8c.html#a5fdbbc0b9ac75fff436821b5c16c3442">fdprint</a>(<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].p[1], <span class="keywordtype">string</span>);
<a name="l01126"></a>01126    }
<a name="l01127"></a>01127 }
<a name="l01128"></a>01128 <span class="comment"></span>
<a name="l01129"></a>01129 <span class="comment">/*!</span>
<a name="l01130"></a>01130 <span class="comment"> * write the string to the console, and all attached</span>
<a name="l01131"></a>01131 <span class="comment"> * console clients</span>
<a name="l01132"></a>01132 <span class="comment"> */</span>
<a name="l01133"></a><a class="code" href="asterisk_8c.html#a7eae484e1a5e9cfb728cf9e4aea88fc7">01133</a> <span class="keywordtype">void</span> <a class="code" href="logger_8h.html#a7eae484e1a5e9cfb728cf9e4aea88fc7">ast_console_puts</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">string</span>)
<a name="l01134"></a>01134 {
<a name="l01135"></a>01135    fputs(<span class="keywordtype">string</span>, stdout);
<a name="l01136"></a>01136    fflush(stdout);
<a name="l01137"></a>01137    <a class="code" href="asterisk_8c.html#a72d371bd0b4daedd44ad33b25dd52ca6" title="write the string to all attached console clients">ast_network_puts</a>(<span class="keywordtype">string</span>);
<a name="l01138"></a>01138 }
<a name="l01139"></a>01139 
<a name="l01140"></a><a class="code" href="asterisk_8c.html#a4b4b9b2b532616004ba296e4be260268">01140</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a4b4b9b2b532616004ba296e4be260268">network_verboser</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l01141"></a>01141 {
<a name="l01142"></a>01142    <a class="code" href="asterisk_8c.html#a5e9e9cb05fcc78aba3de2c19e99b08cd" title="log the string to all attached console clients">ast_network_puts_mutable</a>(s, <a class="code" href="logger_8h.html#aa11fae1314f286da3d57ae8c07ec4bca">__LOG_VERBOSE</a>);
<a name="l01143"></a>01143 }
<a name="l01144"></a>01144 
<a name="l01145"></a><a class="code" href="asterisk_8c.html#a34ba5e4743afbb6fffbd2eb9900622ca">01145</a> <span class="keyword">static</span> pthread_t <a class="code" href="asterisk_8c.html#a34ba5e4743afbb6fffbd2eb9900622ca">lthread</a>;
<a name="l01146"></a>01146 <span class="comment"></span>
<a name="l01147"></a>01147 <span class="comment">/*!</span>
<a name="l01148"></a>01148 <span class="comment"> * \brief read() function supporting the reception of user credentials.</span>
<a name="l01149"></a>01149 <span class="comment"> *</span>
<a name="l01150"></a>01150 <span class="comment"> * \param fd Socket file descriptor.</span>
<a name="l01151"></a>01151 <span class="comment"> * \param buffer Receive buffer.</span>
<a name="l01152"></a>01152 <span class="comment"> * \param size &apos;buffer&apos; size.</span>
<a name="l01153"></a>01153 <span class="comment"> * \param con Console structure to set received credentials</span>
<a name="l01154"></a>01154 <span class="comment"> * \retval -1 on error</span>
<a name="l01155"></a>01155 <span class="comment"> * \retval the number of bytes received on success.</span>
<a name="l01156"></a>01156 <span class="comment"> */</span>
<a name="l01157"></a><a class="code" href="asterisk_8c.html#a7440e4273bc09db8927cebbfe6adfdbe">01157</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a7440e4273bc09db8927cebbfe6adfdbe" title="read() function supporting the reception of user credentials.">read_credentials</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">size_t</span> size, <span class="keyword">struct</span> <a class="code" href="structconsole.html">console</a> *con)
<a name="l01158"></a>01158 {
<a name="l01159"></a>01159 <span class="preprocessor">#if defined(SO_PEERCRED)</span>
<a name="l01160"></a>01160 <span class="preprocessor"></span>   <span class="keyword">struct </span>ucred cred;
<a name="l01161"></a>01161    socklen_t len = <span class="keyword">sizeof</span>(cred);
<a name="l01162"></a>01162 <span class="preprocessor">#endif</span>
<a name="l01163"></a>01163 <span class="preprocessor"></span><span class="preprocessor">#if defined(HAVE_GETPEEREID)</span>
<a name="l01164"></a>01164 <span class="preprocessor"></span>   uid_t uid;
<a name="l01165"></a>01165    gid_t gid;
<a name="l01166"></a>01166 <span class="preprocessor">#else</span>
<a name="l01167"></a>01167 <span class="preprocessor"></span>   <span class="keywordtype">int</span> uid, gid;
<a name="l01168"></a>01168 <span class="preprocessor">#endif</span>
<a name="l01169"></a>01169 <span class="preprocessor"></span>   <span class="keywordtype">int</span> result;
<a name="l01170"></a>01170 
<a name="l01171"></a>01171    result = read(fd, buffer, size);
<a name="l01172"></a>01172    <span class="keywordflow">if</span> (result &lt; 0) {
<a name="l01173"></a>01173       <span class="keywordflow">return</span> result;
<a name="l01174"></a>01174    }
<a name="l01175"></a>01175 
<a name="l01176"></a>01176 <span class="preprocessor">#if defined(SO_PEERCRED)</span>
<a name="l01177"></a>01177 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (getsockopt(fd, SOL_SOCKET, SO_PEERCRED, &amp;cred, &amp;len)) {
<a name="l01178"></a>01178       <span class="keywordflow">return</span> result;
<a name="l01179"></a>01179    }
<a name="l01180"></a>01180    uid = cred.uid;
<a name="l01181"></a>01181    gid = cred.gid;
<a name="l01182"></a>01182 <span class="preprocessor">#elif defined(HAVE_GETPEEREID)</span>
<a name="l01183"></a>01183 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (getpeereid(fd, &amp;uid, &amp;gid)) {
<a name="l01184"></a>01184       <span class="keywordflow">return</span> result;
<a name="l01185"></a>01185    }
<a name="l01186"></a>01186 <span class="preprocessor">#else</span>
<a name="l01187"></a>01187 <span class="preprocessor"></span>   <span class="keywordflow">return</span> result;
<a name="l01188"></a>01188 <span class="preprocessor">#endif</span>
<a name="l01189"></a>01189 <span class="preprocessor"></span>   con-&gt;<a class="code" href="structconsole.html#a60a34315f460179939054acaf3ed8163">uid</a> = uid;
<a name="l01190"></a>01190    con-&gt;<a class="code" href="structconsole.html#a6567680a890171fbaa1a026477a858d3">gid</a> = gid;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192    <span class="keywordflow">return</span> result;
<a name="l01193"></a>01193 }
<a name="l01194"></a>01194 
<a name="l01195"></a><a class="code" href="asterisk_8c.html#a606ead257c7d0251adf7739b1a5aac53">01195</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="asterisk_8c.html#a606ead257c7d0251adf7739b1a5aac53">netconsole</a>(<span class="keywordtype">void</span> *vconsole)
<a name="l01196"></a>01196 {
<a name="l01197"></a>01197    <span class="keyword">struct </span><a class="code" href="structconsole.html">console</a> *con = vconsole;
<a name="l01198"></a>01198    <span class="keywordtype">char</span> <a class="code" href="logger_8c.html#af31254e3111773fe1dc68e8dc13df2fe">hostname</a>[<a class="code" href="network_8h.html#afd80ecbe3170ca4fc85b65cda8659f82">MAXHOSTNAMELEN</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01199"></a>01199    <span class="keywordtype">char</span> tmp[512];
<a name="l01200"></a>01200    <span class="keywordtype">int</span> res;
<a name="l01201"></a>01201    <span class="keyword">struct </span>pollfd fds[2];
<a name="l01202"></a>01202    
<a name="l01203"></a>01203    <span class="keywordflow">if</span> (gethostname(hostname, <span class="keyword">sizeof</span>(hostname)-1))
<a name="l01204"></a>01204       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(hostname, <span class="stringliteral">&quot;&lt;Unknown&gt;&quot;</span>, <span class="keyword">sizeof</span>(hostname));
<a name="l01205"></a>01205    snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s/%ld/%s\n&quot;</span>, hostname, (<span class="keywordtype">long</span>)ast_mainpid, <a class="code" href="ast__version_8h.html#a7765c608aea948584928643ab3963b2a" title="Retrieve the Asterisk version string.">ast_get_version</a>());
<a name="l01206"></a>01206    <a class="code" href="asterisk_8c.html#a5fdbbc0b9ac75fff436821b5c16c3442">fdprint</a>(con-&gt;<a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, tmp);
<a name="l01207"></a>01207    <span class="keywordflow">for</span> (;;) {
<a name="l01208"></a>01208       fds[0].fd = con-&gt;<a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;
<a name="l01209"></a>01209       fds[0].events = POLLIN;
<a name="l01210"></a>01210       fds[0].revents = 0;
<a name="l01211"></a>01211       fds[1].fd = con-&gt;<a class="code" href="structconsole.html#a67bfc5276dfe3c0f1174ebc9ce9d7d31">p</a>[0];
<a name="l01212"></a>01212       fds[1].events = POLLIN;
<a name="l01213"></a>01213       fds[1].revents = 0;
<a name="l01214"></a>01214 
<a name="l01215"></a>01215       res = <a class="code" href="poll-compat_8h.html#a5a0c58fa8311e94cd0ed34382aa822f9">ast_poll</a>(fds, 2, -1);
<a name="l01216"></a>01216       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01217"></a>01217          <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EINTR)
<a name="l01218"></a>01218             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;poll returned &lt; 0: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01219"></a>01219          <span class="keywordflow">continue</span>;
<a name="l01220"></a>01220       }
<a name="l01221"></a>01221       <span class="keywordflow">if</span> (fds[0].revents) {
<a name="l01222"></a>01222          res = <a class="code" href="asterisk_8c.html#a7440e4273bc09db8927cebbfe6adfdbe" title="read() function supporting the reception of user credentials.">read_credentials</a>(con-&gt;<a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, tmp, <span class="keyword">sizeof</span>(tmp) - 1, con);
<a name="l01223"></a>01223          <span class="keywordflow">if</span> (res &lt; 1) {
<a name="l01224"></a>01224             <span class="keywordflow">break</span>;
<a name="l01225"></a>01225          }
<a name="l01226"></a>01226          tmp[res] = 0;
<a name="l01227"></a>01227          <span class="keywordflow">if</span> (strncmp(tmp, <span class="stringliteral">&quot;cli quit after &quot;</span>, 15) == 0) {
<a name="l01228"></a>01228             <a class="code" href="cli_8h.html#ab1d4a1fb19a2a81cc450e1173b346eca" title="Executes multiple CLI commands Interpret strings separated by NULL and execute each...">ast_cli_command_multiple_full</a>(con-&gt;<a class="code" href="structconsole.html#a60a34315f460179939054acaf3ed8163">uid</a>, con-&gt;<a class="code" href="structconsole.html#a6567680a890171fbaa1a026477a858d3">gid</a>, con-&gt;<a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, res - 15, tmp + 15);
<a name="l01229"></a>01229             <span class="keywordflow">break</span>;
<a name="l01230"></a>01230          }
<a name="l01231"></a>01231          <a class="code" href="cli_8h.html#ab1d4a1fb19a2a81cc450e1173b346eca" title="Executes multiple CLI commands Interpret strings separated by NULL and execute each...">ast_cli_command_multiple_full</a>(con-&gt;<a class="code" href="structconsole.html#a60a34315f460179939054acaf3ed8163">uid</a>, con-&gt;<a class="code" href="structconsole.html#a6567680a890171fbaa1a026477a858d3">gid</a>, con-&gt;<a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, res, tmp);
<a name="l01232"></a>01232       }
<a name="l01233"></a>01233       <span class="keywordflow">if</span> (fds[1].revents) {
<a name="l01234"></a>01234          res = <a class="code" href="asterisk_8c.html#a7440e4273bc09db8927cebbfe6adfdbe" title="read() function supporting the reception of user credentials.">read_credentials</a>(con-&gt;<a class="code" href="structconsole.html#a67bfc5276dfe3c0f1174ebc9ce9d7d31">p</a>[0], tmp, <span class="keyword">sizeof</span>(tmp), con);
<a name="l01235"></a>01235          <span class="keywordflow">if</span> (res &lt; 1) {
<a name="l01236"></a>01236             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;read returned %d\n&quot;</span>, res);
<a name="l01237"></a>01237             <span class="keywordflow">break</span>;
<a name="l01238"></a>01238          }
<a name="l01239"></a>01239          res = write(con-&gt;<a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, tmp, res);
<a name="l01240"></a>01240          <span class="keywordflow">if</span> (res &lt; 1)
<a name="l01241"></a>01241             <span class="keywordflow">break</span>;
<a name="l01242"></a>01242       }
<a name="l01243"></a>01243    }
<a name="l01244"></a>01244    <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#a6b1d9f4913ebf24f80c68a75bb002700">ast_opt_hide_connect</a>) {
<a name="l01245"></a>01245       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Remote UNIX connection disconnected\n&quot;</span>);
<a name="l01246"></a>01246    }
<a name="l01247"></a>01247    close(con-&gt;<a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">fd</a>);
<a name="l01248"></a>01248    close(con-&gt;<a class="code" href="structconsole.html#a67bfc5276dfe3c0f1174ebc9ce9d7d31">p</a>[0]);
<a name="l01249"></a>01249    close(con-&gt;<a class="code" href="structconsole.html#a67bfc5276dfe3c0f1174ebc9ce9d7d31">p</a>[1]);
<a name="l01250"></a>01250    con-&gt;<a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = -1;
<a name="l01251"></a>01251    
<a name="l01252"></a>01252    <span class="keywordflow">return</span> NULL;
<a name="l01253"></a>01253 }
<a name="l01254"></a>01254 
<a name="l01255"></a><a class="code" href="asterisk_8c.html#adc01bca6281492dfec5ae217cf32fc34">01255</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="asterisk_8c.html#adc01bca6281492dfec5ae217cf32fc34">listener</a>(<span class="keywordtype">void</span> *unused)
<a name="l01256"></a>01256 {
<a name="l01257"></a>01257    <span class="keyword">struct </span>sockaddr_un sunaddr;
<a name="l01258"></a>01258    <span class="keywordtype">int</span> <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l01259"></a>01259    socklen_t len;
<a name="l01260"></a>01260    <span class="keywordtype">int</span> x;
<a name="l01261"></a>01261    <span class="keywordtype">int</span> flags;
<a name="l01262"></a>01262    <span class="keyword">struct </span>pollfd fds[1];
<a name="l01263"></a>01263    <span class="keywordflow">for</span> (;;) {
<a name="l01264"></a>01264       <span class="keywordflow">if</span> (ast_socket &lt; 0)
<a name="l01265"></a>01265          <span class="keywordflow">return</span> NULL;
<a name="l01266"></a>01266       fds[0].fd = ast_socket;
<a name="l01267"></a>01267       fds[0].events = POLLIN;
<a name="l01268"></a>01268       s = <a class="code" href="poll-compat_8h.html#a5a0c58fa8311e94cd0ed34382aa822f9">ast_poll</a>(fds, 1, -1);
<a name="l01269"></a>01269       pthread_testcancel();
<a name="l01270"></a>01270       <span class="keywordflow">if</span> (s &lt; 0) {
<a name="l01271"></a>01271          <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EINTR)
<a name="l01272"></a>01272             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;poll returned error: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01273"></a>01273          <span class="keywordflow">continue</span>;
<a name="l01274"></a>01274       }
<a name="l01275"></a>01275       len = <span class="keyword">sizeof</span>(sunaddr);
<a name="l01276"></a>01276       s = accept(ast_socket, (<span class="keyword">struct</span> sockaddr *)&amp;sunaddr, &amp;len);
<a name="l01277"></a>01277       <span class="keywordflow">if</span> (s &lt; 0) {
<a name="l01278"></a>01278          <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EINTR)
<a name="l01279"></a>01279             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Accept returned %d: %s\n&quot;</span>, s, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01280"></a>01280       } <span class="keywordflow">else</span> {
<a name="l01281"></a>01281 <span class="preprocessor">#if !defined(SO_PASSCRED)</span>
<a name="l01282"></a>01282 <span class="preprocessor"></span>         {
<a name="l01283"></a>01283 <span class="preprocessor">#else</span>
<a name="l01284"></a>01284 <span class="preprocessor"></span>         <span class="keywordtype">int</span> sckopt = 1;
<a name="l01285"></a>01285          <span class="comment">/* turn on socket credentials passing. */</span>
<a name="l01286"></a>01286          <span class="keywordflow">if</span> (setsockopt(s, SOL_SOCKET, SO_PASSCRED, &amp;sckopt, <span class="keyword">sizeof</span>(sckopt)) &lt; 0) {
<a name="l01287"></a>01287             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to turn on socket credentials passing\n&quot;</span>);
<a name="l01288"></a>01288          } <span class="keywordflow">else</span> {
<a name="l01289"></a>01289 <span class="preprocessor">#endif</span>
<a name="l01290"></a>01290 <span class="preprocessor"></span>            <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="asterisk_8c.html#a6d5a16b321d54d9be2b0592881329fdf">AST_MAX_CONNECTS</a>; x++) {
<a name="l01291"></a>01291                <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].fd &gt;= 0) {
<a name="l01292"></a>01292                   <span class="keywordflow">continue</span>;
<a name="l01293"></a>01293                }
<a name="l01294"></a>01294                <span class="keywordflow">if</span> (socketpair(<a class="code" href="app__nbscat_8c.html#ae24f1f9ea44fcce3affcb2137f593dc1">AF_LOCAL</a>, SOCK_STREAM, 0, <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].p)) {
<a name="l01295"></a>01295                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create pipe: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01296"></a>01296                   <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].<a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = -1;
<a name="l01297"></a>01297                   <a class="code" href="asterisk_8c.html#a5fdbbc0b9ac75fff436821b5c16c3442">fdprint</a>(s, <span class="stringliteral">&quot;Server failed to create pipe\n&quot;</span>);
<a name="l01298"></a>01298                   close(s);
<a name="l01299"></a>01299                   <span class="keywordflow">break</span>;
<a name="l01300"></a>01300                }
<a name="l01301"></a>01301                flags = fcntl(<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].p[1], F_GETFL);
<a name="l01302"></a>01302                fcntl(<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].p[1], F_SETFL, flags | O_NONBLOCK);
<a name="l01303"></a>01303                <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].<a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = s;
<a name="l01304"></a>01304                <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].<a class="code" href="structconsole.html#a29128ae5c15a12dea5fe4f263ba6cec1">mute</a> = 1; <span class="comment">/* Default is muted, we will un-mute if necessary */</span>
<a name="l01305"></a>01305                <span class="comment">/* Default uid and gid to -2, so then in cli.c/cli_has_permissions() we will be able</span>
<a name="l01306"></a>01306 <span class="comment">                  to know if the user didn&apos;t send the credentials. */</span>
<a name="l01307"></a>01307                <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].<a class="code" href="structconsole.html#a60a34315f460179939054acaf3ed8163">uid</a> = -2;
<a name="l01308"></a>01308                <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].<a class="code" href="structconsole.html#a6567680a890171fbaa1a026477a858d3">gid</a> = -2;
<a name="l01309"></a>01309                <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#aa73be876e3a4024b91ce2e09d8b945d1">ast_pthread_create_detached_background</a>(&amp;<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].t, NULL, <a class="code" href="asterisk_8c.html#a606ead257c7d0251adf7739b1a5aac53">netconsole</a>, &amp;<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x])) {
<a name="l01310"></a>01310                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to spawn thread to handle connection: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01311"></a>01311                   close(<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].p[0]);
<a name="l01312"></a>01312                   close(<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].p[1]);
<a name="l01313"></a>01313                   <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].<a class="code" href="structconsole.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = -1;
<a name="l01314"></a>01314                   <a class="code" href="asterisk_8c.html#a5fdbbc0b9ac75fff436821b5c16c3442">fdprint</a>(s, <span class="stringliteral">&quot;Server failed to spawn thread\n&quot;</span>);
<a name="l01315"></a>01315                   close(s);
<a name="l01316"></a>01316                }
<a name="l01317"></a>01317                <span class="keywordflow">break</span>;
<a name="l01318"></a>01318             }
<a name="l01319"></a>01319             <span class="keywordflow">if</span> (x &gt;= AST_MAX_CONNECTS) {
<a name="l01320"></a>01320                <a class="code" href="asterisk_8c.html#a5fdbbc0b9ac75fff436821b5c16c3442">fdprint</a>(s, <span class="stringliteral">&quot;No more connections allowed\n&quot;</span>);
<a name="l01321"></a>01321                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No more connections allowed\n&quot;</span>);
<a name="l01322"></a>01322                close(s);
<a name="l01323"></a>01323             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].fd &gt; -1) &amp;&amp; (!<a class="code" href="options_8h.html#a6b1d9f4913ebf24f80c68a75bb002700">ast_opt_hide_connect</a>)) {
<a name="l01324"></a>01324                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Remote UNIX connection\n&quot;</span>);
<a name="l01325"></a>01325             }
<a name="l01326"></a>01326          }
<a name="l01327"></a>01327       }
<a name="l01328"></a>01328    }
<a name="l01329"></a>01329    <span class="keywordflow">return</span> NULL;
<a name="l01330"></a>01330 }
<a name="l01331"></a>01331 
<a name="l01332"></a><a class="code" href="asterisk_8c.html#ab08a4af1fa3e6efc9a1242ded75e0437">01332</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#ab08a4af1fa3e6efc9a1242ded75e0437">ast_makesocket</a>(<span class="keywordtype">void</span>)
<a name="l01333"></a>01333 {
<a name="l01334"></a>01334    <span class="keyword">struct </span>sockaddr_un sunaddr;
<a name="l01335"></a>01335    <span class="keywordtype">int</span> res;
<a name="l01336"></a>01336    <span class="keywordtype">int</span> x;
<a name="l01337"></a>01337    uid_t uid = -1;
<a name="l01338"></a>01338    gid_t gid = -1;
<a name="l01339"></a>01339 
<a name="l01340"></a>01340    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="asterisk_8c.html#a6d5a16b321d54d9be2b0592881329fdf">AST_MAX_CONNECTS</a>; x++) 
<a name="l01341"></a>01341       <a class="code" href="asterisk_8c.html#af7e83931024e973b7157b87398b9a2bc">consoles</a>[x].fd = -1;
<a name="l01342"></a>01342    unlink(<a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>);
<a name="l01343"></a>01343    ast_socket = socket(PF_LOCAL, SOCK_STREAM, 0);
<a name="l01344"></a>01344    <span class="keywordflow">if</span> (ast_socket &lt; 0) {
<a name="l01345"></a>01345       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create control socket: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01346"></a>01346       <span class="keywordflow">return</span> -1;
<a name="l01347"></a>01347    }     
<a name="l01348"></a>01348    memset(&amp;sunaddr, 0, <span class="keyword">sizeof</span>(sunaddr));
<a name="l01349"></a>01349    sunaddr.sun_family = <a class="code" href="app__nbscat_8c.html#ae24f1f9ea44fcce3affcb2137f593dc1">AF_LOCAL</a>;
<a name="l01350"></a>01350    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(sunaddr.sun_path, <a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>, <span class="keyword">sizeof</span>(sunaddr.sun_path));
<a name="l01351"></a>01351    res = bind(ast_socket, (<span class="keyword">struct</span> sockaddr *)&amp;sunaddr, <span class="keyword">sizeof</span>(sunaddr));
<a name="l01352"></a>01352    <span class="keywordflow">if</span> (res) {
<a name="l01353"></a>01353       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to bind socket to %s: %s\n&quot;</span>, <a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01354"></a>01354       close(ast_socket);
<a name="l01355"></a>01355       ast_socket = -1;
<a name="l01356"></a>01356       <span class="keywordflow">return</span> -1;
<a name="l01357"></a>01357    }
<a name="l01358"></a>01358    res = listen(ast_socket, 2);
<a name="l01359"></a>01359    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01360"></a>01360       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to listen on socket %s: %s\n&quot;</span>, <a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01361"></a>01361       close(ast_socket);
<a name="l01362"></a>01362       ast_socket = -1;
<a name="l01363"></a>01363       <span class="keywordflow">return</span> -1;
<a name="l01364"></a>01364    }
<a name="l01365"></a>01365    <span class="keywordflow">if</span> (<a class="code" href="logger_8h.html#a88db6a9fa710d601734eb260ad30348f">ast_register_verbose</a>(<a class="code" href="asterisk_8c.html#a4b4b9b2b532616004ba296e4be260268">network_verboser</a>)) {
<a name="l01366"></a>01366       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to register network verboser?\n&quot;</span>);
<a name="l01367"></a>01367    }
<a name="l01368"></a>01368 
<a name="l01369"></a>01369    <a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;<a class="code" href="asterisk_8c.html#a34ba5e4743afbb6fffbd2eb9900622ca">lthread</a>, NULL, <a class="code" href="asterisk_8c.html#adc01bca6281492dfec5ae217cf32fc34">listener</a>, NULL);
<a name="l01370"></a>01370 
<a name="l01371"></a>01371    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="asterisk_8c.html#addee6463d8305d615d3c2d6095c13ef7">ast_config_AST_CTL_OWNER</a>)) {
<a name="l01372"></a>01372       <span class="keyword">struct </span>passwd *pw;
<a name="l01373"></a>01373       <span class="keywordflow">if</span> ((pw = getpwnam(<a class="code" href="asterisk_8c.html#addee6463d8305d615d3c2d6095c13ef7">ast_config_AST_CTL_OWNER</a>)) == NULL)
<a name="l01374"></a>01374          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to find uid of user %s\n&quot;</span>, <a class="code" href="asterisk_8c.html#addee6463d8305d615d3c2d6095c13ef7">ast_config_AST_CTL_OWNER</a>);
<a name="l01375"></a>01375       <span class="keywordflow">else</span>
<a name="l01376"></a>01376          uid = pw-&gt;pw_uid;
<a name="l01377"></a>01377    }
<a name="l01378"></a>01378       
<a name="l01379"></a>01379    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="asterisk_8c.html#a0ac99db7e33597c95e83068770d2085f">ast_config_AST_CTL_GROUP</a>)) {
<a name="l01380"></a>01380       <span class="keyword">struct </span><a class="code" href="structgroup.html">group</a> *grp;
<a name="l01381"></a>01381       <span class="keywordflow">if</span> ((grp = getgrnam(<a class="code" href="asterisk_8c.html#a0ac99db7e33597c95e83068770d2085f">ast_config_AST_CTL_GROUP</a>)) == NULL)
<a name="l01382"></a>01382          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to find gid of group %s\n&quot;</span>, <a class="code" href="asterisk_8c.html#a0ac99db7e33597c95e83068770d2085f">ast_config_AST_CTL_GROUP</a>);
<a name="l01383"></a>01383       <span class="keywordflow">else</span>
<a name="l01384"></a>01384          gid = grp-&gt;gr_gid;
<a name="l01385"></a>01385    }
<a name="l01386"></a>01386 
<a name="l01387"></a>01387    <span class="keywordflow">if</span> (chown(<a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>, uid, gid) &lt; 0)
<a name="l01388"></a>01388       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to change ownership of %s: %s\n&quot;</span>, <a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01389"></a>01389 
<a name="l01390"></a>01390    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="asterisk_8c.html#afe07211d3ad898c81340a2114987bacb">ast_config_AST_CTL_PERMISSIONS</a>)) {
<a name="l01391"></a>01391       <span class="keywordtype">int</span> p1;
<a name="l01392"></a>01392       mode_t p;
<a name="l01393"></a>01393       sscanf(<a class="code" href="asterisk_8c.html#afe07211d3ad898c81340a2114987bacb">ast_config_AST_CTL_PERMISSIONS</a>, <span class="stringliteral">&quot;%30o&quot;</span>, &amp;p1);
<a name="l01394"></a>01394       p = p1;
<a name="l01395"></a>01395       <span class="keywordflow">if</span> ((chmod(<a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>, p)) &lt; 0)
<a name="l01396"></a>01396          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to change file permissions of %s: %s\n&quot;</span>, <a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01397"></a>01397    }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399    <span class="keywordflow">return</span> 0;
<a name="l01400"></a>01400 }
<a name="l01401"></a>01401 
<a name="l01402"></a><a class="code" href="asterisk_8c.html#ab48b6f8cdddee48aed2f4fba4a6c18fe">01402</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#ab48b6f8cdddee48aed2f4fba4a6c18fe">ast_tryconnect</a>(<span class="keywordtype">void</span>)
<a name="l01403"></a>01403 {
<a name="l01404"></a>01404    <span class="keyword">struct </span>sockaddr_un sunaddr;
<a name="l01405"></a>01405    <span class="keywordtype">int</span> res;
<a name="l01406"></a>01406    ast_consock = socket(PF_LOCAL, SOCK_STREAM, 0);
<a name="l01407"></a>01407    <span class="keywordflow">if</span> (ast_consock &lt; 0) {
<a name="l01408"></a>01408       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create socket: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01409"></a>01409       <span class="keywordflow">return</span> 0;
<a name="l01410"></a>01410    }
<a name="l01411"></a>01411    memset(&amp;sunaddr, 0, <span class="keyword">sizeof</span>(sunaddr));
<a name="l01412"></a>01412    sunaddr.sun_family = <a class="code" href="app__nbscat_8c.html#ae24f1f9ea44fcce3affcb2137f593dc1">AF_LOCAL</a>;
<a name="l01413"></a>01413    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(sunaddr.sun_path, <a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>, <span class="keyword">sizeof</span>(sunaddr.sun_path));
<a name="l01414"></a>01414    res = connect(ast_consock, (<span class="keyword">struct</span> sockaddr *)&amp;sunaddr, <span class="keyword">sizeof</span>(sunaddr));
<a name="l01415"></a>01415    <span class="keywordflow">if</span> (res) {
<a name="l01416"></a>01416       close(ast_consock);
<a name="l01417"></a>01417       ast_consock = -1;
<a name="l01418"></a>01418       <span class="keywordflow">return</span> 0;
<a name="l01419"></a>01419    } <span class="keywordflow">else</span>
<a name="l01420"></a>01420       <span class="keywordflow">return</span> 1;
<a name="l01421"></a>01421 }
<a name="l01422"></a>01422 <span class="comment"></span>
<a name="l01423"></a>01423 <span class="comment">/*! \brief Urgent handler</span>
<a name="l01424"></a>01424 <span class="comment"></span>
<a name="l01425"></a>01425 <span class="comment"> Called by soft_hangup to interrupt the poll, read, or other</span>
<a name="l01426"></a>01426 <span class="comment"> system call.  We don&apos;t actually need to do anything though.  </span>
<a name="l01427"></a>01427 <span class="comment"> Remember: Cannot EVER ast_log from within a signal handler </span>
<a name="l01428"></a>01428 <span class="comment"> */</span>
<a name="l01429"></a><a class="code" href="asterisk_8c.html#ac132d00d9469a926426e872ca059f378">01429</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#ac132d00d9469a926426e872ca059f378" title="Urgent handler.">urg_handler</a>(<span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>)
<a name="l01430"></a>01430 {
<a name="l01431"></a>01431    signal(num, <a class="code" href="asterisk_8c.html#ac132d00d9469a926426e872ca059f378" title="Urgent handler.">urg_handler</a>);
<a name="l01432"></a>01432    <span class="keywordflow">return</span>;
<a name="l01433"></a>01433 }
<a name="l01434"></a>01434 
<a name="l01435"></a><a class="code" href="asterisk_8c.html#a003bbe47ca5ed15b7cfd4f2f126022c0">01435</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a003bbe47ca5ed15b7cfd4f2f126022c0">hup_handler</a>(<span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>)
<a name="l01436"></a>01436 {
<a name="l01437"></a>01437    <span class="keywordtype">int</span> a = 0;
<a name="l01438"></a>01438    <span class="keywordflow">if</span> (option_verbose &gt; 1) 
<a name="l01439"></a>01439       printf(<span class="stringliteral">&quot;Received HUP signal -- Reloading configs\n&quot;</span>);
<a name="l01440"></a>01440    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a8fbb0f40e9c839384d728aa8e0958dfb">restartnow</a>)
<a name="l01441"></a>01441       execvp(<a class="code" href="asterisk_8c.html#aac76ac35350d1efd9ddfe5b56739c649">_argv</a>[0], <a class="code" href="asterisk_8c.html#aac76ac35350d1efd9ddfe5b56739c649">_argv</a>);
<a name="l01442"></a>01442    <a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>.need_reload = 1;
<a name="l01443"></a>01443    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a7bb419fdb0040da24ecbb651b12395fc">sig_alert_pipe</a>[1] != -1) {
<a name="l01444"></a>01444       <span class="keywordflow">if</span> (write(<a class="code" href="asterisk_8c.html#a7bb419fdb0040da24ecbb651b12395fc">sig_alert_pipe</a>[1], &amp;a, <span class="keyword">sizeof</span>(a)) &lt; 0) {
<a name="l01445"></a>01445          fprintf(stderr, <span class="stringliteral">&quot;hup_handler: write() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01446"></a>01446       }
<a name="l01447"></a>01447    }
<a name="l01448"></a>01448    signal(num, <a class="code" href="asterisk_8c.html#a003bbe47ca5ed15b7cfd4f2f126022c0">hup_handler</a>);
<a name="l01449"></a>01449 }
<a name="l01450"></a>01450 
<a name="l01451"></a><a class="code" href="asterisk_8c.html#a6762a45b0c5d8def958675277dc692a4">01451</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a6762a45b0c5d8def958675277dc692a4">child_handler</a>(<span class="keywordtype">int</span> sig)
<a name="l01452"></a>01452 {
<a name="l01453"></a>01453    <span class="comment">/* Must not ever ast_log or ast_verbose within signal handler */</span>
<a name="l01454"></a>01454    <span class="keywordtype">int</span> n, <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>;
<a name="l01455"></a>01455 
<a name="l01456"></a>01456    <span class="comment">/*</span>
<a name="l01457"></a>01457 <span class="comment">    * Reap all dead children -- not just one</span>
<a name="l01458"></a>01458 <span class="comment">    */</span>
<a name="l01459"></a>01459    <span class="keywordflow">for</span> (n = 0; wait4(-1, &amp;status, WNOHANG, NULL) &gt; 0; n++)
<a name="l01460"></a>01460       ;
<a name="l01461"></a>01461    <span class="keywordflow">if</span> (n == 0 &amp;&amp; option_debug)   
<a name="l01462"></a>01462       printf(<span class="stringliteral">&quot;Huh?  Child handler, but nobody there?\n&quot;</span>);
<a name="l01463"></a>01463    signal(sig, <a class="code" href="asterisk_8c.html#a6762a45b0c5d8def958675277dc692a4">child_handler</a>);
<a name="l01464"></a>01464 }
<a name="l01465"></a>01465 <span class="comment"></span>
<a name="l01466"></a>01466 <span class="comment">/*! \brief Set maximum open files */</span>
<a name="l01467"></a><a class="code" href="asterisk_8c.html#aebad2831849819f834b0f043cea21ad4">01467</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#aebad2831849819f834b0f043cea21ad4" title="Set maximum open files.">set_ulimit</a>(<span class="keywordtype">int</span> value)
<a name="l01468"></a>01468 {
<a name="l01469"></a>01469    <span class="keyword">struct </span>rlimit l = {0, 0};
<a name="l01470"></a>01470    
<a name="l01471"></a>01471    <span class="keywordflow">if</span> (value &lt;= 0) {
<a name="l01472"></a>01472       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to change max files open to invalid value %i\n&quot;</span>,value);
<a name="l01473"></a>01473       <span class="keywordflow">return</span>;
<a name="l01474"></a>01474    }
<a name="l01475"></a>01475    
<a name="l01476"></a>01476    l.rlim_cur = value;
<a name="l01477"></a>01477    l.rlim_max = value;
<a name="l01478"></a>01478    
<a name="l01479"></a>01479    <span class="keywordflow">if</span> (setrlimit(RLIMIT_NOFILE, &amp;l)) {
<a name="l01480"></a>01480       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to disable core size resource limit: %s\n&quot;</span>,strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01481"></a>01481       <span class="keywordflow">return</span>;
<a name="l01482"></a>01482    }
<a name="l01483"></a>01483    
<a name="l01484"></a>01484    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Setting max files open to %d\n&quot;</span>,value);
<a name="l01485"></a>01485    
<a name="l01486"></a>01486    <span class="keywordflow">return</span>;
<a name="l01487"></a>01487 }
<a name="l01488"></a>01488 <span class="comment"></span>
<a name="l01489"></a>01489 <span class="comment">/*! \brief Set an X-term or screen title */</span>
<a name="l01490"></a><a class="code" href="asterisk_8c.html#aabb54677daf95f5c6f575645b1ccf46d">01490</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#aabb54677daf95f5c6f575645b1ccf46d" title="Set an X-term or screen title.">set_title</a>(<span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>)
<a name="l01491"></a>01491 {
<a name="l01492"></a>01492    <span class="keywordflow">if</span> (getenv(<span class="stringliteral">&quot;TERM&quot;</span>) &amp;&amp; strstr(getenv(<span class="stringliteral">&quot;TERM&quot;</span>), <span class="stringliteral">&quot;xterm&quot;</span>))
<a name="l01493"></a>01493       fprintf(stdout, <span class="stringliteral">&quot;\033]2;%s\007&quot;</span>, text);
<a name="l01494"></a>01494 }
<a name="l01495"></a>01495 
<a name="l01496"></a><a class="code" href="asterisk_8c.html#aebef75d1917768a6921d6157becf0780">01496</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#aebef75d1917768a6921d6157becf0780">set_icon</a>(<span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>)
<a name="l01497"></a>01497 {
<a name="l01498"></a>01498    <span class="keywordflow">if</span> (getenv(<span class="stringliteral">&quot;TERM&quot;</span>) &amp;&amp; strstr(getenv(<span class="stringliteral">&quot;TERM&quot;</span>), <span class="stringliteral">&quot;xterm&quot;</span>))
<a name="l01499"></a>01499       fprintf(stdout, <span class="stringliteral">&quot;\033]1;%s\007&quot;</span>, text);
<a name="l01500"></a>01500 }
<a name="l01501"></a>01501 <span class="comment"></span>
<a name="l01502"></a>01502 <span class="comment">/*! \brief We set ourselves to a high priority, that we might pre-empt everything</span>
<a name="l01503"></a>01503 <span class="comment">   else.  If your PBX has heavy activity on it, this is a good thing.  */</span>
<a name="l01504"></a><a class="code" href="asterisk_8c.html#a4c46b35c4f4320b2f841520a849eee91">01504</a> <span class="keywordtype">int</span> <a class="code" href="asterisk_8h.html#ad649acedd512a45c748a440e78a281c9" title="We set ourselves to a high priority, that we might pre-empt everything else. If your...">ast_set_priority</a>(<span class="keywordtype">int</span> pri)
<a name="l01505"></a>01505 {
<a name="l01506"></a>01506    <span class="keyword">struct </span>sched_param sched;
<a name="l01507"></a>01507    memset(&amp;sched, 0, <span class="keyword">sizeof</span>(sched));
<a name="l01508"></a>01508 <span class="preprocessor">#ifdef __linux__</span>
<a name="l01509"></a>01509 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (pri) {  
<a name="l01510"></a>01510       sched.sched_priority = 10;
<a name="l01511"></a>01511       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8h.html#a6d2a9d4bb3ad87d2d532018e5348dadb">sched_setscheduler</a>(0, SCHED_RR, &amp;sched)) {
<a name="l01512"></a>01512          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set high priority\n&quot;</span>);
<a name="l01513"></a>01513          <span class="keywordflow">return</span> -1;
<a name="l01514"></a>01514       } <span class="keywordflow">else</span>
<a name="l01515"></a>01515          <span class="keywordflow">if</span> (option_verbose)
<a name="l01516"></a>01516             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Set to realtime thread\n&quot;</span>);
<a name="l01517"></a>01517    } <span class="keywordflow">else</span> {
<a name="l01518"></a>01518       sched.sched_priority = 0;
<a name="l01519"></a>01519       <span class="comment">/* According to the manpage, these parameters can never fail. */</span>
<a name="l01520"></a>01520       <a class="code" href="asterisk_8h.html#a6d2a9d4bb3ad87d2d532018e5348dadb">sched_setscheduler</a>(0, SCHED_OTHER, &amp;sched);
<a name="l01521"></a>01521    }
<a name="l01522"></a>01522 <span class="preprocessor">#else</span>
<a name="l01523"></a>01523 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (pri) {
<a name="l01524"></a>01524       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8h.html#aa074a86999c2684cd7ed271c4d275081">setpriority</a>(PRIO_PROCESS, 0, -10) == -1) {
<a name="l01525"></a>01525          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set high priority\n&quot;</span>);
<a name="l01526"></a>01526          <span class="keywordflow">return</span> -1;
<a name="l01527"></a>01527       } <span class="keywordflow">else</span>
<a name="l01528"></a>01528          <span class="keywordflow">if</span> (option_verbose)
<a name="l01529"></a>01529             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Set to high priority\n&quot;</span>);
<a name="l01530"></a>01530    } <span class="keywordflow">else</span> {
<a name="l01531"></a>01531       <span class="comment">/* According to the manpage, these parameters can never fail. */</span>
<a name="l01532"></a>01532       <a class="code" href="asterisk_8h.html#aa074a86999c2684cd7ed271c4d275081">setpriority</a>(PRIO_PROCESS, 0, 0);
<a name="l01533"></a>01533    }
<a name="l01534"></a>01534 <span class="preprocessor">#endif</span>
<a name="l01535"></a>01535 <span class="preprocessor"></span>   <span class="keywordflow">return</span> 0;
<a name="l01536"></a>01536 }
<a name="l01537"></a>01537 
<a name="l01538"></a><a class="code" href="asterisk_8c.html#a90eb22f5aa5feb8263c0c2803e0fee4e">01538</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a90eb22f5aa5feb8263c0c2803e0fee4e">ast_run_atexits</a>(<span class="keywordtype">void</span>)
<a name="l01539"></a>01539 {
<a name="l01540"></a>01540    <span class="keyword">struct </span><a class="code" href="structast__atexit.html">ast_atexit</a> *ae;
<a name="l01541"></a>01541    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structatexits.html">atexits</a>);
<a name="l01542"></a>01542    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structatexits.html">atexits</a>, ae, <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>) {
<a name="l01543"></a>01543       <span class="keywordflow">if</span> (ae-&gt;<a class="code" href="structast__atexit.html#af406187a441c51e4589704fae05f15fe">func</a>) 
<a name="l01544"></a>01544          ae-&gt;<a class="code" href="structast__atexit.html#af406187a441c51e4589704fae05f15fe">func</a>();
<a name="l01545"></a>01545    }
<a name="l01546"></a>01546    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structatexits.html">atexits</a>);
<a name="l01547"></a>01547 }
<a name="l01548"></a>01548 
<a name="l01549"></a><a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">01549</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(<span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>, <span class="keywordtype">int</span> niceness, <span class="keywordtype">int</span> safeshutdown, <span class="keywordtype">int</span> restart)
<a name="l01550"></a>01550 {
<a name="l01551"></a>01551    <span class="keywordtype">char</span> filename[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01552"></a>01552    time_t s,e;
<a name="l01553"></a>01553    <span class="keywordtype">int</span> x;
<a name="l01554"></a>01554    <span class="comment">/* Try to get as many CDRs as possible submitted to the backend engines (if in batch mode) */</span>
<a name="l01555"></a>01555    <a class="code" href="cdr_8h.html#a5634f8ea707fb2fdf87abdd55a539764">ast_cdr_engine_term</a>();
<a name="l01556"></a>01556    <span class="keywordflow">if</span> (safeshutdown) {
<a name="l01557"></a>01557       <a class="code" href="asterisk_8c.html#a72c50d9ef6e457be5b578fefecd3147d">shuttingdown</a> = 1;
<a name="l01558"></a>01558       <span class="keywordflow">if</span> (!niceness) {
<a name="l01559"></a>01559          <span class="comment">/* Begin shutdown routine, hanging up active channels */</span>
<a name="l01560"></a>01560          <a class="code" href="channel_8h.html#abfff88810f1ead9e04b3e826265db91b" title="Initiate system shutdown.">ast_begin_shutdown</a>(1);
<a name="l01561"></a>01561          <span class="keywordflow">if</span> (option_verbose &amp;&amp; <a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a>)
<a name="l01562"></a>01562             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Beginning asterisk %s....\n&quot;</span>, restart ? <span class="stringliteral">&quot;restart&quot;</span> : <span class="stringliteral">&quot;shutdown&quot;</span>);
<a name="l01563"></a>01563          time(&amp;s);
<a name="l01564"></a>01564          <span class="keywordflow">for</span> (;;) {
<a name="l01565"></a>01565             time(&amp;e);
<a name="l01566"></a>01566             <span class="comment">/* Wait up to 15 seconds for all channels to go away */</span>
<a name="l01567"></a>01567             <span class="keywordflow">if</span> ((e - s) &gt; 15)
<a name="l01568"></a>01568                <span class="keywordflow">break</span>;
<a name="l01569"></a>01569             <span class="keywordflow">if</span> (!<a class="code" href="channel_8h.html#a9704ae96ab849e9e5a20040c13d29705" title="returns number of active/allocated channels">ast_active_channels</a>())
<a name="l01570"></a>01570                <span class="keywordflow">break</span>;
<a name="l01571"></a>01571             <span class="keywordflow">if</span> (!<a class="code" href="asterisk_8c.html#a72c50d9ef6e457be5b578fefecd3147d">shuttingdown</a>)
<a name="l01572"></a>01572                <span class="keywordflow">break</span>;
<a name="l01573"></a>01573             <span class="comment">/* Sleep 1/10 of a second */</span>
<a name="l01574"></a>01574             usleep(100000);
<a name="l01575"></a>01575          }
<a name="l01576"></a>01576       } <span class="keywordflow">else</span> {
<a name="l01577"></a>01577          <span class="keywordflow">if</span> (niceness &lt; 2)
<a name="l01578"></a>01578             <a class="code" href="channel_8h.html#abfff88810f1ead9e04b3e826265db91b" title="Initiate system shutdown.">ast_begin_shutdown</a>(0);
<a name="l01579"></a>01579          <span class="keywordflow">if</span> (option_verbose &amp;&amp; <a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a>)
<a name="l01580"></a>01580             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Waiting for inactivity to perform %s...\n&quot;</span>, restart ? <span class="stringliteral">&quot;restart&quot;</span> : <span class="stringliteral">&quot;halt&quot;</span>);
<a name="l01581"></a>01581          <span class="keywordflow">for</span> (;;) {
<a name="l01582"></a>01582             <span class="keywordflow">if</span> (!<a class="code" href="channel_8h.html#a9704ae96ab849e9e5a20040c13d29705" title="returns number of active/allocated channels">ast_active_channels</a>())
<a name="l01583"></a>01583                <span class="keywordflow">break</span>;
<a name="l01584"></a>01584             <span class="keywordflow">if</span> (!<a class="code" href="asterisk_8c.html#a72c50d9ef6e457be5b578fefecd3147d">shuttingdown</a>)
<a name="l01585"></a>01585                <span class="keywordflow">break</span>;
<a name="l01586"></a>01586             sleep(1);
<a name="l01587"></a>01587          }
<a name="l01588"></a>01588       }
<a name="l01589"></a>01589 
<a name="l01590"></a>01590       <span class="keywordflow">if</span> (!<a class="code" href="asterisk_8c.html#a72c50d9ef6e457be5b578fefecd3147d">shuttingdown</a>) {
<a name="l01591"></a>01591          <span class="keywordflow">if</span> (option_verbose &amp;&amp; <a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a>)
<a name="l01592"></a>01592             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Asterisk %s cancelled.\n&quot;</span>, restart ? <span class="stringliteral">&quot;restart&quot;</span> : <span class="stringliteral">&quot;shutdown&quot;</span>);
<a name="l01593"></a>01593          <span class="keywordflow">return</span>;
<a name="l01594"></a>01594       }
<a name="l01595"></a>01595 
<a name="l01596"></a>01596       <span class="keywordflow">if</span> (niceness)
<a name="l01597"></a>01597          <a class="code" href="module_8h.html#a6bf911eb6793b87d52a792053fb1ce60" title="Run the unload() callback for all loaded modules.">ast_module_shutdown</a>();
<a name="l01598"></a>01598    }
<a name="l01599"></a>01599    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a> || (<a class="code" href="options_8h.html#a17d4d9ef04ffa9034f6c6b6c1fd2bb0b">ast_opt_remote</a> &amp;&amp; !<a class="code" href="options_8h.html#a301d032d1d86ba46348691f6d135e98a">ast_opt_exec</a>)) {
<a name="l01600"></a>01600       <span class="keywordflow">if</span> (getenv(<span class="stringliteral">&quot;HOME&quot;</span>)) 
<a name="l01601"></a>01601          snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s/.asterisk_history&quot;</span>, getenv(<span class="stringliteral">&quot;HOME&quot;</span>));
<a name="l01602"></a>01602       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(filename))
<a name="l01603"></a>01603          <a class="code" href="asterisk_8c.html#ad1dbb4e490dd946730de06a87531ba9c">ast_el_write_history</a>(filename);
<a name="l01604"></a>01604       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a> != NULL)
<a name="l01605"></a>01605          el_end(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>);
<a name="l01606"></a>01606       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a> != NULL)
<a name="l01607"></a>01607          history_end(<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a>);
<a name="l01608"></a>01608    }
<a name="l01609"></a>01609    <span class="keywordflow">if</span> (option_verbose)
<a name="l01610"></a>01610       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Executing last minute cleanups\n&quot;</span>);
<a name="l01611"></a>01611    <a class="code" href="asterisk_8c.html#a90eb22f5aa5feb8263c0c2803e0fee4e">ast_run_atexits</a>();
<a name="l01612"></a>01612    <span class="comment">/* Called on exit */</span>
<a name="l01613"></a>01613    <span class="keywordflow">if</span> (option_verbose &amp;&amp; <a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a>)
<a name="l01614"></a>01614       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Asterisk %s ending (%d).\n&quot;</span>, <a class="code" href="channel_8h.html#a9704ae96ab849e9e5a20040c13d29705" title="returns number of active/allocated channels">ast_active_channels</a>() ? <span class="stringliteral">&quot;uncleanly&quot;</span> : <span class="stringliteral">&quot;cleanly&quot;</span>, num);
<a name="l01615"></a>01615    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Asterisk ending (%d).\n&quot;</span>, num);
<a name="l01616"></a>01616    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;Shutdown&quot;</span>, <span class="stringliteral">&quot;Shutdown: %s\r\nRestart: %s\r\n&quot;</span>, <a class="code" href="channel_8h.html#a9704ae96ab849e9e5a20040c13d29705" title="returns number of active/allocated channels">ast_active_channels</a>() ? <span class="stringliteral">&quot;Uncleanly&quot;</span> : <span class="stringliteral">&quot;Cleanly&quot;</span>, restart ? <span class="stringliteral">&quot;True&quot;</span> : <span class="stringliteral">&quot;False&quot;</span>);
<a name="l01617"></a>01617    <span class="keywordflow">if</span> (ast_socket &gt; -1) {
<a name="l01618"></a>01618       pthread_cancel(<a class="code" href="asterisk_8c.html#a34ba5e4743afbb6fffbd2eb9900622ca">lthread</a>);
<a name="l01619"></a>01619       close(ast_socket);
<a name="l01620"></a>01620       ast_socket = -1;
<a name="l01621"></a>01621       unlink(<a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>);
<a name="l01622"></a>01622    }
<a name="l01623"></a>01623    <span class="keywordflow">if</span> (ast_consock &gt; -1)
<a name="l01624"></a>01624       close(ast_consock);
<a name="l01625"></a>01625    <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#a17d4d9ef04ffa9034f6c6b6c1fd2bb0b">ast_opt_remote</a>)
<a name="l01626"></a>01626       unlink(<a class="code" href="paths_8h.html#a59860442b922398568da0236c1576039">ast_config_AST_PID</a>);
<a name="l01627"></a>01627    printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l01628"></a>01628    <span class="keywordflow">if</span> (restart) {
<a name="l01629"></a>01629       <span class="keywordflow">if</span> (option_verbose || <a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a>)
<a name="l01630"></a>01630          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Preparing for Asterisk restart...\n&quot;</span>);
<a name="l01631"></a>01631       <span class="comment">/* Mark all FD&apos;s for closing on exec */</span>
<a name="l01632"></a>01632       <span class="keywordflow">for</span> (x=3; x &lt; 32768; x++) {
<a name="l01633"></a>01633          fcntl(x, F_SETFD, FD_CLOEXEC);
<a name="l01634"></a>01634       }
<a name="l01635"></a>01635       <span class="keywordflow">if</span> (option_verbose || <a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a>)
<a name="l01636"></a>01636          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Asterisk is now restarting...\n&quot;</span>);
<a name="l01637"></a>01637       <a class="code" href="asterisk_8c.html#a8fbb0f40e9c839384d728aa8e0958dfb">restartnow</a> = 1;
<a name="l01638"></a>01638 
<a name="l01639"></a>01639       <span class="comment">/* close logger */</span>
<a name="l01640"></a>01640       <a class="code" href="__private_8h.html#a472851d5655c8a9b9492c40e5ff32d2d">close_logger</a>();
<a name="l01641"></a>01641 
<a name="l01642"></a>01642       <span class="comment">/* If there is a consolethread running send it a SIGHUP </span>
<a name="l01643"></a>01643 <span class="comment">         so it can execvp, otherwise we can do it ourselves */</span>
<a name="l01644"></a>01644       <span class="keywordflow">if</span> ((<a class="code" href="asterisk_8c.html#a60dce572870808fbda416eb4c9d60250">consolethread</a> != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) &amp;&amp; (<a class="code" href="asterisk_8c.html#a60dce572870808fbda416eb4c9d60250">consolethread</a> != pthread_self())) {
<a name="l01645"></a>01645          pthread_kill(<a class="code" href="asterisk_8c.html#a60dce572870808fbda416eb4c9d60250">consolethread</a>, SIGHUP);
<a name="l01646"></a>01646          <span class="comment">/* Give the signal handler some time to complete */</span>
<a name="l01647"></a>01647          sleep(2);
<a name="l01648"></a>01648       } <span class="keywordflow">else</span>
<a name="l01649"></a>01649          execvp(<a class="code" href="asterisk_8c.html#aac76ac35350d1efd9ddfe5b56739c649">_argv</a>[0], <a class="code" href="asterisk_8c.html#aac76ac35350d1efd9ddfe5b56739c649">_argv</a>);
<a name="l01650"></a>01650    
<a name="l01651"></a>01651    } <span class="keywordflow">else</span> {
<a name="l01652"></a>01652       <span class="comment">/* close logger */</span>
<a name="l01653"></a>01653       <a class="code" href="__private_8h.html#a472851d5655c8a9b9492c40e5ff32d2d">close_logger</a>();
<a name="l01654"></a>01654    }
<a name="l01655"></a>01655    exit(0);
<a name="l01656"></a>01656 }
<a name="l01657"></a>01657 
<a name="l01658"></a><a class="code" href="asterisk_8c.html#ae60d292daa4fe3a13b0a0d01c5beb305">01658</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#ae60d292daa4fe3a13b0a0d01c5beb305">__quit_handler</a>(<span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>)
<a name="l01659"></a>01659 {
<a name="l01660"></a>01660    <span class="keywordtype">int</span> a = 0;
<a name="l01661"></a>01661    <a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>.need_quit = 1;
<a name="l01662"></a>01662    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a7bb419fdb0040da24ecbb651b12395fc">sig_alert_pipe</a>[1] != -1) {
<a name="l01663"></a>01663       <span class="keywordflow">if</span> (write(<a class="code" href="asterisk_8c.html#a7bb419fdb0040da24ecbb651b12395fc">sig_alert_pipe</a>[1], &amp;a, <span class="keyword">sizeof</span>(a)) &lt; 0) {
<a name="l01664"></a>01664          fprintf(stderr, <span class="stringliteral">&quot;hup_handler: write() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01665"></a>01665       }
<a name="l01666"></a>01666    }
<a name="l01667"></a>01667    <span class="comment">/* There is no need to restore the signal handler here, since the app</span>
<a name="l01668"></a>01668 <span class="comment">    * is going to exit */</span>
<a name="l01669"></a>01669 }
<a name="l01670"></a>01670 
<a name="l01671"></a><a class="code" href="asterisk_8c.html#a128997a8231cdc87af7181da9ac78b7b">01671</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a128997a8231cdc87af7181da9ac78b7b">__remote_quit_handler</a>(<span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>)
<a name="l01672"></a>01672 {
<a name="l01673"></a>01673    <a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>.need_quit = 1;
<a name="l01674"></a>01674 }
<a name="l01675"></a>01675 
<a name="l01676"></a><a class="code" href="asterisk_8c.html#acc87e555b4ae500879b50c19abcad8c7">01676</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#acc87e555b4ae500879b50c19abcad8c7">fix_header</a>(<span class="keywordtype">char</span> *outbuf, <span class="keywordtype">int</span> maxout, <span class="keyword">const</span> <span class="keywordtype">char</span> *s, <span class="keywordtype">char</span> *cmp)
<a name="l01677"></a>01677 {
<a name="l01678"></a>01678    <span class="keyword">const</span> <span class="keywordtype">char</span> *c;
<a name="l01679"></a>01679 
<a name="l01680"></a>01680    <span class="comment">/* Check for verboser preamble */</span>
<a name="l01681"></a>01681    <span class="keywordflow">if</span> (*s == 127) {
<a name="l01682"></a>01682       s++;
<a name="l01683"></a>01683    }
<a name="l01684"></a>01684 
<a name="l01685"></a>01685    <span class="keywordflow">if</span> (!strncmp(s, cmp, strlen(cmp))) {
<a name="l01686"></a>01686       c = s + strlen(cmp);
<a name="l01687"></a>01687       <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(outbuf, cmp, <a class="code" href="term_8h.html#a3aaf3b0287d26dfb6ecb3b1c46e950c8">COLOR_GRAY</a>, 0, maxout);
<a name="l01688"></a>01688       <span class="keywordflow">return</span> c;
<a name="l01689"></a>01689    }
<a name="l01690"></a>01690    <span class="keywordflow">return</span> NULL;
<a name="l01691"></a>01691 }
<a name="l01692"></a>01692 
<a name="l01693"></a><a class="code" href="asterisk_8c.html#a2e5de7662c3c8090bb8cdd170b04a07f">01693</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a2e5de7662c3c8090bb8cdd170b04a07f">console_verboser</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *s)
<a name="l01694"></a>01694 {
<a name="l01695"></a>01695    <span class="keywordtype">char</span> tmp[80];
<a name="l01696"></a>01696    <span class="keyword">const</span> <span class="keywordtype">char</span> *c = NULL;
<a name="l01697"></a>01697 
<a name="l01698"></a>01698    <span class="keywordflow">if</span> ((c = <a class="code" href="asterisk_8c.html#acc87e555b4ae500879b50c19abcad8c7">fix_header</a>(tmp, <span class="keyword">sizeof</span>(tmp), s, <a class="code" href="logger_8h.html#a9aaf93f121b63d51444d573673d4b791">VERBOSE_PREFIX_4</a>)) ||
<a name="l01699"></a>01699        (c = <a class="code" href="asterisk_8c.html#acc87e555b4ae500879b50c19abcad8c7">fix_header</a>(tmp, <span class="keyword">sizeof</span>(tmp), s, <a class="code" href="logger_8h.html#a24b0f46e22f4ea3226fa082e955dd4ef">VERBOSE_PREFIX_3</a>)) ||
<a name="l01700"></a>01700        (c = <a class="code" href="asterisk_8c.html#acc87e555b4ae500879b50c19abcad8c7">fix_header</a>(tmp, <span class="keyword">sizeof</span>(tmp), s, <a class="code" href="logger_8h.html#a5623b2747e49964e0eae2795057bc92e">VERBOSE_PREFIX_2</a>)) ||
<a name="l01701"></a>01701        (c = <a class="code" href="asterisk_8c.html#acc87e555b4ae500879b50c19abcad8c7">fix_header</a>(tmp, <span class="keyword">sizeof</span>(tmp), s, <a class="code" href="logger_8h.html#aad3298cde7f9cc6ea7f3f60b797cef11">VERBOSE_PREFIX_1</a>))) {
<a name="l01702"></a>01702       fputs(tmp, stdout);
<a name="l01703"></a>01703       fputs(c, stdout);
<a name="l01704"></a>01704    } <span class="keywordflow">else</span> {
<a name="l01705"></a>01705       <span class="keywordflow">if</span> (*s == 127) {
<a name="l01706"></a>01706          s++;
<a name="l01707"></a>01707       }
<a name="l01708"></a>01708       fputs(s, stdout);
<a name="l01709"></a>01709    }
<a name="l01710"></a>01710 
<a name="l01711"></a>01711    fflush(stdout);
<a name="l01712"></a>01712    
<a name="l01713"></a>01713    <span class="comment">/* Wake up a poll()ing console */</span>
<a name="l01714"></a>01714    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a> &amp;&amp; <a class="code" href="asterisk_8c.html#a60dce572870808fbda416eb4c9d60250">consolethread</a> != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>)
<a name="l01715"></a>01715       pthread_kill(<a class="code" href="asterisk_8c.html#a60dce572870808fbda416eb4c9d60250">consolethread</a>, SIGURG);
<a name="l01716"></a>01716 }
<a name="l01717"></a>01717 
<a name="l01718"></a><a class="code" href="asterisk_8c.html#ab784c35637d8cd3a88aaacd75cdb90d2">01718</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#ab784c35637d8cd3a88aaacd75cdb90d2">ast_all_zeros</a>(<span class="keywordtype">char</span> *s)
<a name="l01719"></a>01719 {
<a name="l01720"></a>01720    <span class="keywordflow">while</span> (*s) {
<a name="l01721"></a>01721       <span class="keywordflow">if</span> (*s &gt; 32)
<a name="l01722"></a>01722          <span class="keywordflow">return</span> 0;
<a name="l01723"></a>01723       s++;  
<a name="l01724"></a>01724    }
<a name="l01725"></a>01725    <span class="keywordflow">return</span> 1;
<a name="l01726"></a>01726 }
<a name="l01727"></a>01727 
<a name="l01728"></a><a class="code" href="asterisk_8c.html#abe8bca2e641977833990af2605439947">01728</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#abe8bca2e641977833990af2605439947">consolehandler</a>(<span class="keywordtype">char</span> *s)
<a name="l01729"></a>01729 {
<a name="l01730"></a>01730    printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#a7c737dda11a1138a30529adcffaf56ff">term_end</a>());
<a name="l01731"></a>01731    fflush(stdout);
<a name="l01732"></a>01732 
<a name="l01733"></a>01733    <span class="comment">/* Called when readline data is available */</span>
<a name="l01734"></a>01734    <span class="keywordflow">if</span> (!<a class="code" href="asterisk_8c.html#ab784c35637d8cd3a88aaacd75cdb90d2">ast_all_zeros</a>(s))
<a name="l01735"></a>01735       <a class="code" href="asterisk_8c.html#a9aff30b106c705ecc3484dadd6395f64">ast_el_add_history</a>(s);
<a name="l01736"></a>01736    <span class="comment">/* The real handler for bang */</span>
<a name="l01737"></a>01737    <span class="keywordflow">if</span> (s[0] == <span class="charliteral">&apos;!&apos;</span>) {
<a name="l01738"></a>01738       <span class="keywordflow">if</span> (s[1])
<a name="l01739"></a>01739          <a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(s+1);
<a name="l01740"></a>01740       <span class="keywordflow">else</span>
<a name="l01741"></a>01741          <a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(getenv(<span class="stringliteral">&quot;SHELL&quot;</span>) ? getenv(<span class="stringliteral">&quot;SHELL&quot;</span>) : <span class="stringliteral">&quot;/bin/sh&quot;</span>);
<a name="l01742"></a>01742    } <span class="keywordflow">else</span> 
<a name="l01743"></a>01743       <a class="code" href="cli_8h.html#a9c772ebcb8e1a0d2cecbf551f089f58f">ast_cli_command</a>(STDOUT_FILENO, s);
<a name="l01744"></a>01744 }
<a name="l01745"></a>01745 
<a name="l01746"></a><a class="code" href="asterisk_8c.html#a84a9beadb8d73516c4b1cbe838453ff9">01746</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a84a9beadb8d73516c4b1cbe838453ff9">remoteconsolehandler</a>(<span class="keywordtype">char</span> *s)
<a name="l01747"></a>01747 {
<a name="l01748"></a>01748    <span class="keywordtype">int</span> ret = 0;
<a name="l01749"></a>01749 
<a name="l01750"></a>01750    <span class="comment">/* Called when readline data is available */</span>
<a name="l01751"></a>01751    <span class="keywordflow">if</span> (!<a class="code" href="asterisk_8c.html#ab784c35637d8cd3a88aaacd75cdb90d2">ast_all_zeros</a>(s))
<a name="l01752"></a>01752       <a class="code" href="asterisk_8c.html#a9aff30b106c705ecc3484dadd6395f64">ast_el_add_history</a>(s);
<a name="l01753"></a>01753    <span class="comment">/* The real handler for bang */</span>
<a name="l01754"></a>01754    <span class="keywordflow">if</span> (s[0] == <span class="charliteral">&apos;!&apos;</span>) {
<a name="l01755"></a>01755       <span class="keywordflow">if</span> (s[1])
<a name="l01756"></a>01756          <a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(s+1);
<a name="l01757"></a>01757       <span class="keywordflow">else</span>
<a name="l01758"></a>01758          <a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(getenv(<span class="stringliteral">&quot;SHELL&quot;</span>) ? getenv(<span class="stringliteral">&quot;SHELL&quot;</span>) : <span class="stringliteral">&quot;/bin/sh&quot;</span>);
<a name="l01759"></a>01759       ret = 1;
<a name="l01760"></a>01760    }
<a name="l01761"></a>01761    <span class="keywordflow">if</span> ((strncasecmp(s, <span class="stringliteral">&quot;quit&quot;</span>, 4) == 0 || strncasecmp(s, <span class="stringliteral">&quot;exit&quot;</span>, 4) == 0) &amp;&amp;
<a name="l01762"></a>01762        (s[4] == <span class="charliteral">&apos;\0&apos;</span> || isspace(s[4]))) {
<a name="l01763"></a>01763       <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 0, 0, 0);
<a name="l01764"></a>01764       ret = 1;
<a name="l01765"></a>01765    }
<a name="l01766"></a>01766 
<a name="l01767"></a>01767    <span class="keywordflow">return</span> ret;
<a name="l01768"></a>01768 }
<a name="l01769"></a>01769 
<a name="l01770"></a><a class="code" href="asterisk_8c.html#a828de0b261785adf20714bbcdf9391c6">01770</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a828de0b261785adf20714bbcdf9391c6">handle_version</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01771"></a>01771 {
<a name="l01772"></a>01772    <span class="keywordflow">switch</span> (cmd) {
<a name="l01773"></a>01773    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01774"></a>01774       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show version&quot;</span>;
<a name="l01775"></a>01775       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01776"></a>01776          <span class="stringliteral">&quot;Usage: core show version\n&quot;</span>
<a name="l01777"></a>01777          <span class="stringliteral">&quot;       Shows Asterisk version information.\n&quot;</span>;
<a name="l01778"></a>01778       <span class="keywordflow">return</span> NULL;
<a name="l01779"></a>01779    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01780"></a>01780       <span class="keywordflow">return</span> NULL;
<a name="l01781"></a>01781    }
<a name="l01782"></a>01782 
<a name="l01783"></a>01783    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l01784"></a>01784       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01785"></a>01785    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Asterisk %s built by %s @ %s on a %s running %s on %s\n&quot;</span>,
<a name="l01786"></a>01786       <a class="code" href="ast__version_8h.html#a7765c608aea948584928643ab3963b2a" title="Retrieve the Asterisk version string.">ast_get_version</a>(), <a class="code" href="buildinfo_8h.html#ac67b18fb7444d973a733a9757c1ff8f9">ast_build_user</a>, <a class="code" href="buildinfo_8h.html#aae3c7406e483c475f34063c84048ab89">ast_build_hostname</a>,
<a name="l01787"></a>01787       <a class="code" href="buildinfo_8h.html#a6d456a43bdae713459ee5ee67439670c">ast_build_machine</a>, <a class="code" href="buildinfo_8h.html#a00b5464ec2f306ae8f17f73a0a81f28d">ast_build_os</a>, <a class="code" href="buildinfo_8h.html#af1708cda257f6db95f77b34f112ef64b">ast_build_date</a>);
<a name="l01788"></a>01788    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01789"></a>01789 }
<a name="l01790"></a>01790 
<a name="l01791"></a>01791 <span class="preprocessor">#if 0</span>
<a name="l01792"></a>01792 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> handle_quit(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01793"></a>01793 {
<a name="l01794"></a>01794    <span class="keywordflow">if</span> (argc != 1)
<a name="l01795"></a>01795       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l01796"></a>01796    <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 0, 1, 0);
<a name="l01797"></a>01797    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l01798"></a>01798 }
<a name="l01799"></a>01799 <span class="preprocessor">#endif</span>
<a name="l01800"></a>01800 <span class="preprocessor"></span>
<a name="l01801"></a><a class="code" href="asterisk_8c.html#ae70030dcf6d4e96327fcd5bc0285b9d7">01801</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#ae70030dcf6d4e96327fcd5bc0285b9d7">handle_stop_now</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01802"></a>01802 {
<a name="l01803"></a>01803    <span class="keywordflow">switch</span> (cmd) {
<a name="l01804"></a>01804    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01805"></a>01805       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core stop now&quot;</span>;
<a name="l01806"></a>01806       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01807"></a>01807          <span class="stringliteral">&quot;Usage: core stop now\n&quot;</span>
<a name="l01808"></a>01808          <span class="stringliteral">&quot;       Shuts down a running Asterisk immediately, hanging up all active calls .\n&quot;</span>;
<a name="l01809"></a>01809       <span class="keywordflow">return</span> NULL;
<a name="l01810"></a>01810    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01811"></a>01811       <span class="keywordflow">return</span> NULL;
<a name="l01812"></a>01812    }
<a name="l01813"></a>01813 
<a name="l01814"></a>01814    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01815"></a>01815       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01816"></a>01816    <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 0 <span class="comment">/* Not nice */</span>, 1 <span class="comment">/* safely */</span>, 0 <span class="comment">/* not restart */</span>);
<a name="l01817"></a>01817    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01818"></a>01818 }
<a name="l01819"></a>01819 
<a name="l01820"></a><a class="code" href="asterisk_8c.html#a6bd02774fe0979cefec3d88594749076">01820</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a6bd02774fe0979cefec3d88594749076">handle_stop_gracefully</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01821"></a>01821 {
<a name="l01822"></a>01822    <span class="keywordflow">switch</span> (cmd) {
<a name="l01823"></a>01823    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01824"></a>01824       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core stop gracefully&quot;</span>;
<a name="l01825"></a>01825       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01826"></a>01826          <span class="stringliteral">&quot;Usage: core stop gracefully\n&quot;</span>
<a name="l01827"></a>01827          <span class="stringliteral">&quot;       Causes Asterisk to not accept new calls, and exit when all\n&quot;</span>
<a name="l01828"></a>01828          <span class="stringliteral">&quot;       active calls have terminated normally.\n&quot;</span>;
<a name="l01829"></a>01829       <span class="keywordflow">return</span> NULL;
<a name="l01830"></a>01830    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01831"></a>01831       <span class="keywordflow">return</span> NULL;
<a name="l01832"></a>01832    }
<a name="l01833"></a>01833 
<a name="l01834"></a>01834    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01835"></a>01835       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01836"></a>01836    <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 1 <span class="comment">/* nicely */</span>, 1 <span class="comment">/* safely */</span>, 0 <span class="comment">/* no restart */</span>);
<a name="l01837"></a>01837    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01838"></a>01838 }
<a name="l01839"></a>01839 
<a name="l01840"></a><a class="code" href="asterisk_8c.html#acc0f80a205edf9eff08b24f2748f9247">01840</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#acc0f80a205edf9eff08b24f2748f9247">handle_stop_when_convenient</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01841"></a>01841 {
<a name="l01842"></a>01842    <span class="keywordflow">switch</span> (cmd) {
<a name="l01843"></a>01843    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01844"></a>01844       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core stop when convenient&quot;</span>;
<a name="l01845"></a>01845       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01846"></a>01846          <span class="stringliteral">&quot;Usage: core stop when convenient\n&quot;</span>
<a name="l01847"></a>01847          <span class="stringliteral">&quot;       Causes Asterisk to perform a shutdown when all active calls have ended.\n&quot;</span>;
<a name="l01848"></a>01848       <span class="keywordflow">return</span> NULL;
<a name="l01849"></a>01849    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01850"></a>01850       <span class="keywordflow">return</span> NULL;
<a name="l01851"></a>01851    }
<a name="l01852"></a>01852 
<a name="l01853"></a>01853    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01854"></a>01854       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01855"></a>01855    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Waiting for inactivity to perform halt\n&quot;</span>);
<a name="l01856"></a>01856    <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 2 <span class="comment">/* really nicely */</span>, 1 <span class="comment">/* safely */</span>, 0 <span class="comment">/* don&apos;t restart */</span>);
<a name="l01857"></a>01857    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01858"></a>01858 }
<a name="l01859"></a>01859 
<a name="l01860"></a><a class="code" href="asterisk_8c.html#a2da6d477c1f0b2dd06e8010645b495da">01860</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a2da6d477c1f0b2dd06e8010645b495da">handle_restart_now</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01861"></a>01861 {
<a name="l01862"></a>01862    <span class="keywordflow">switch</span> (cmd) {
<a name="l01863"></a>01863    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01864"></a>01864       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core restart now&quot;</span>;
<a name="l01865"></a>01865       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01866"></a>01866          <span class="stringliteral">&quot;Usage: core restart now\n&quot;</span>
<a name="l01867"></a>01867          <span class="stringliteral">&quot;       Causes Asterisk to hangup all calls and exec() itself performing a cold\n&quot;</span>
<a name="l01868"></a>01868          <span class="stringliteral">&quot;       restart.\n&quot;</span>;
<a name="l01869"></a>01869       <span class="keywordflow">return</span> NULL;
<a name="l01870"></a>01870    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01871"></a>01871       <span class="keywordflow">return</span> NULL;
<a name="l01872"></a>01872    }
<a name="l01873"></a>01873 
<a name="l01874"></a>01874    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01875"></a>01875       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01876"></a>01876    <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 0 <span class="comment">/* not nicely */</span>, 1 <span class="comment">/* safely */</span>, 1 <span class="comment">/* restart */</span>);
<a name="l01877"></a>01877    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01878"></a>01878 }
<a name="l01879"></a>01879 
<a name="l01880"></a><a class="code" href="asterisk_8c.html#ac8a53f8c12fe766728372e845a99c822">01880</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#ac8a53f8c12fe766728372e845a99c822">handle_restart_gracefully</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01881"></a>01881 {
<a name="l01882"></a>01882    <span class="keywordflow">switch</span> (cmd) {
<a name="l01883"></a>01883    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01884"></a>01884       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core restart gracefully&quot;</span>;
<a name="l01885"></a>01885       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01886"></a>01886          <span class="stringliteral">&quot;Usage: core restart gracefully\n&quot;</span>
<a name="l01887"></a>01887          <span class="stringliteral">&quot;       Causes Asterisk to stop accepting new calls and exec() itself performing a cold\n&quot;</span>
<a name="l01888"></a>01888          <span class="stringliteral">&quot;       restart when all active calls have ended.\n&quot;</span>;
<a name="l01889"></a>01889       <span class="keywordflow">return</span> NULL;
<a name="l01890"></a>01890    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01891"></a>01891       <span class="keywordflow">return</span> NULL;
<a name="l01892"></a>01892    }
<a name="l01893"></a>01893 
<a name="l01894"></a>01894    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01895"></a>01895       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01896"></a>01896    <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 1 <span class="comment">/* nicely */</span>, 1 <span class="comment">/* safely */</span>, 1 <span class="comment">/* restart */</span>);
<a name="l01897"></a>01897    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01898"></a>01898 }
<a name="l01899"></a>01899 
<a name="l01900"></a><a class="code" href="asterisk_8c.html#a3f98716c804b0bea3acc983956483ebd">01900</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a3f98716c804b0bea3acc983956483ebd">handle_restart_when_convenient</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01901"></a>01901 {
<a name="l01902"></a>01902    <span class="keywordflow">switch</span> (cmd) {
<a name="l01903"></a>01903    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01904"></a>01904       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core restart when convenient&quot;</span>;
<a name="l01905"></a>01905       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01906"></a>01906          <span class="stringliteral">&quot;Usage: core restart when convenient\n&quot;</span>
<a name="l01907"></a>01907          <span class="stringliteral">&quot;       Causes Asterisk to perform a cold restart when all active calls have ended.\n&quot;</span>;
<a name="l01908"></a>01908       <span class="keywordflow">return</span> NULL;
<a name="l01909"></a>01909    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01910"></a>01910       <span class="keywordflow">return</span> NULL;
<a name="l01911"></a>01911    }
<a name="l01912"></a>01912 
<a name="l01913"></a>01913    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01914"></a>01914       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01915"></a>01915    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Waiting for inactivity to perform restart\n&quot;</span>);
<a name="l01916"></a>01916    <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 2 <span class="comment">/* really nicely */</span>, 1 <span class="comment">/* safely */</span>, 1 <span class="comment">/* restart */</span>);
<a name="l01917"></a>01917    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01918"></a>01918 }
<a name="l01919"></a>01919 
<a name="l01920"></a><a class="code" href="asterisk_8c.html#ac4fd79d36385b27a0b8f995f53e47f23">01920</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#ac4fd79d36385b27a0b8f995f53e47f23">handle_abort_shutdown</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01921"></a>01921 {
<a name="l01922"></a>01922    <span class="keywordflow">switch</span> (cmd) {
<a name="l01923"></a>01923    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01924"></a>01924       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core abort shutdown&quot;</span>;
<a name="l01925"></a>01925       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01926"></a>01926          <span class="stringliteral">&quot;Usage: core abort shutdown\n&quot;</span>
<a name="l01927"></a>01927          <span class="stringliteral">&quot;       Causes Asterisk to abort an executing shutdown or restart, and resume normal\n&quot;</span>
<a name="l01928"></a>01928          <span class="stringliteral">&quot;       call operations.\n&quot;</span>;
<a name="l01929"></a>01929       <span class="keywordflow">return</span> NULL;
<a name="l01930"></a>01930    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01931"></a>01931       <span class="keywordflow">return</span> NULL;
<a name="l01932"></a>01932    }
<a name="l01933"></a>01933 
<a name="l01934"></a>01934    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01935"></a>01935       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01936"></a>01936    <a class="code" href="channel_8h.html#ace6102c072609981f5c400a2d8e282b7" title="Cancel a shutdown in progress.">ast_cancel_shutdown</a>();
<a name="l01937"></a>01937    <a class="code" href="asterisk_8c.html#a72c50d9ef6e457be5b578fefecd3147d">shuttingdown</a> = 0;
<a name="l01938"></a>01938    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01939"></a>01939 }
<a name="l01940"></a>01940 
<a name="l01941"></a><a class="code" href="asterisk_8c.html#a2eac41ec93c1f53371ed01a94b7640ac">01941</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a2eac41ec93c1f53371ed01a94b7640ac">handle_bang</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01942"></a>01942 {
<a name="l01943"></a>01943    <span class="keywordflow">switch</span> (cmd) {
<a name="l01944"></a>01944    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01945"></a>01945       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;!&quot;</span>;
<a name="l01946"></a>01946       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01947"></a>01947          <span class="stringliteral">&quot;Usage: !&lt;command&gt;\n&quot;</span>
<a name="l01948"></a>01948          <span class="stringliteral">&quot;       Executes a given shell command\n&quot;</span>;
<a name="l01949"></a>01949       <span class="keywordflow">return</span> NULL;
<a name="l01950"></a>01950    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01951"></a>01951       <span class="keywordflow">return</span> NULL;
<a name="l01952"></a>01952    }
<a name="l01953"></a>01953 
<a name="l01954"></a>01954    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01955"></a>01955 }
<a name="l01956"></a><a class="code" href="asterisk_8c.html#a7d9339be3f345df196e3b9f26dc51253">01956</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="asterisk_8c.html#a7d9339be3f345df196e3b9f26dc51253">warranty_lines</a>[] = {
<a name="l01957"></a>01957    <span class="stringliteral">&quot;\n&quot;</span>
<a name="l01958"></a>01958    <span class="stringliteral">&quot;            NO WARRANTY\n&quot;</span>
<a name="l01959"></a>01959    <span class="stringliteral">&quot;\n&quot;</span>
<a name="l01960"></a>01960    <span class="stringliteral">&quot;BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY\n&quot;</span>
<a name="l01961"></a>01961    <span class="stringliteral">&quot;FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN\n&quot;</span>
<a name="l01962"></a>01962    <span class="stringliteral">&quot;OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES\n&quot;</span>
<a name="l01963"></a>01963    <span class="stringliteral">&quot;PROVIDE THE PROGRAM \&quot;AS IS\&quot; WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED\n&quot;</span>
<a name="l01964"></a>01964    <span class="stringliteral">&quot;OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF\n&quot;</span>
<a name="l01965"></a>01965    <span class="stringliteral">&quot;MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS\n&quot;</span>
<a name="l01966"></a>01966    <span class="stringliteral">&quot;TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE\n&quot;</span>
<a name="l01967"></a>01967    <span class="stringliteral">&quot;PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,\n&quot;</span>
<a name="l01968"></a>01968    <span class="stringliteral">&quot;REPAIR OR CORRECTION.\n&quot;</span>
<a name="l01969"></a>01969    <span class="stringliteral">&quot;\n&quot;</span>
<a name="l01970"></a>01970    <span class="stringliteral">&quot;IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING\n&quot;</span>
<a name="l01971"></a>01971    <span class="stringliteral">&quot;WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR\n&quot;</span>
<a name="l01972"></a>01972    <span class="stringliteral">&quot;REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,\n&quot;</span>
<a name="l01973"></a>01973    <span class="stringliteral">&quot;INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING\n&quot;</span>
<a name="l01974"></a>01974    <span class="stringliteral">&quot;OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED\n&quot;</span>
<a name="l01975"></a>01975    <span class="stringliteral">&quot;TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY\n&quot;</span>
<a name="l01976"></a>01976    <span class="stringliteral">&quot;YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER\n&quot;</span>
<a name="l01977"></a>01977    <span class="stringliteral">&quot;PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE\n&quot;</span>
<a name="l01978"></a>01978    <span class="stringliteral">&quot;POSSIBILITY OF SUCH DAMAGES.\n&quot;</span>
<a name="l01979"></a>01979 };
<a name="l01980"></a>01980 
<a name="l01981"></a><a class="code" href="asterisk_8c.html#a6113c4ebbbc993cf7054a1af8e99da9a">01981</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a6113c4ebbbc993cf7054a1af8e99da9a">show_warranty</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01982"></a>01982 {
<a name="l01983"></a>01983    <span class="keywordflow">switch</span> (cmd) {
<a name="l01984"></a>01984    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01985"></a>01985       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show warranty&quot;</span>;
<a name="l01986"></a>01986       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01987"></a>01987          <span class="stringliteral">&quot;Usage: core show warranty\n&quot;</span>
<a name="l01988"></a>01988          <span class="stringliteral">&quot;       Shows the warranty (if any) for this copy of Asterisk.\n&quot;</span>;
<a name="l01989"></a>01989       <span class="keywordflow">return</span> NULL;
<a name="l01990"></a>01990    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01991"></a>01991       <span class="keywordflow">return</span> NULL;
<a name="l01992"></a>01992    }
<a name="l01993"></a>01993 
<a name="l01994"></a>01994    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s&quot;</span>, warranty_lines);
<a name="l01995"></a>01995 
<a name="l01996"></a>01996    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01997"></a>01997 }
<a name="l01998"></a>01998 
<a name="l01999"></a><a class="code" href="asterisk_8c.html#ad715261b1b9cd2646cb66feac127aef0">01999</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="asterisk_8c.html#ad715261b1b9cd2646cb66feac127aef0">license_lines</a>[] = {
<a name="l02000"></a>02000    <span class="stringliteral">&quot;\n&quot;</span>
<a name="l02001"></a>02001    <span class="stringliteral">&quot;This program is free software; you can redistribute it and/or modify\n&quot;</span>
<a name="l02002"></a>02002    <span class="stringliteral">&quot;it under the terms of the GNU General Public License version 2 as\n&quot;</span>
<a name="l02003"></a>02003    <span class="stringliteral">&quot;published by the Free Software Foundation.\n&quot;</span>
<a name="l02004"></a>02004    <span class="stringliteral">&quot;\n&quot;</span>
<a name="l02005"></a>02005    <span class="stringliteral">&quot;This program also contains components licensed under other licenses.\n&quot;</span>
<a name="l02006"></a>02006    <span class="stringliteral">&quot;They include:\n&quot;</span>
<a name="l02007"></a>02007    <span class="stringliteral">&quot;\n&quot;</span>
<a name="l02008"></a>02008    <span class="stringliteral">&quot;This program is distributed in the hope that it will be useful,\n&quot;</span>
<a name="l02009"></a>02009    <span class="stringliteral">&quot;but WITHOUT ANY WARRANTY; without even the implied warranty of\n&quot;</span>
<a name="l02010"></a>02010    <span class="stringliteral">&quot;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n&quot;</span>
<a name="l02011"></a>02011    <span class="stringliteral">&quot;GNU General Public License for more details.\n&quot;</span>
<a name="l02012"></a>02012    <span class="stringliteral">&quot;\n&quot;</span>
<a name="l02013"></a>02013    <span class="stringliteral">&quot;You should have received a copy of the GNU General Public License\n&quot;</span>
<a name="l02014"></a>02014    <span class="stringliteral">&quot;along with this program; if not, write to the Free Software\n&quot;</span>
<a name="l02015"></a>02015    <span class="stringliteral">&quot;Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA\n&quot;</span>
<a name="l02016"></a>02016 };
<a name="l02017"></a>02017 
<a name="l02018"></a><a class="code" href="asterisk_8c.html#a162ffd8e3544ee0038895ad79971dc8a">02018</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a162ffd8e3544ee0038895ad79971dc8a">show_license</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l02019"></a>02019 {
<a name="l02020"></a>02020    <span class="keywordflow">switch</span> (cmd) {
<a name="l02021"></a>02021    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l02022"></a>02022       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show license&quot;</span>;
<a name="l02023"></a>02023       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l02024"></a>02024          <span class="stringliteral">&quot;Usage: core show license\n&quot;</span>
<a name="l02025"></a>02025          <span class="stringliteral">&quot;       Shows the license(s) for this copy of Asterisk.\n&quot;</span>;
<a name="l02026"></a>02026       <span class="keywordflow">return</span> NULL;
<a name="l02027"></a>02027    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l02028"></a>02028       <span class="keywordflow">return</span> NULL;
<a name="l02029"></a>02029    }
<a name="l02030"></a>02030 
<a name="l02031"></a>02031    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s&quot;</span>, license_lines);
<a name="l02032"></a>02032 
<a name="l02033"></a>02033    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02034"></a>02034 }
<a name="l02035"></a>02035 
<a name="l02036"></a><a class="code" href="asterisk_8c.html#a5c70f918dc3849f6f6e22425394ddb5f">02036</a> <span class="preprocessor">#define ASTERISK_PROMPT &quot;*CLI&gt; &quot;</span>
<a name="l02037"></a>02037 <span class="preprocessor"></span>
<a name="l02038"></a><a class="code" href="asterisk_8c.html#ab3c751b4374c79fe9a81bfb69efef22b">02038</a> <span class="preprocessor">#define ASTERISK_PROMPT2 &quot;%s*CLI&gt; &quot;</span>
<a name="l02039"></a>02039 <span class="preprocessor"></span>
<a name="l02040"></a><a class="code" href="asterisk_8c.html#abb2456dfd78af8ed6d6876d214e7e064">02040</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="asterisk_8c.html#abb2456dfd78af8ed6d6876d214e7e064">cli_asterisk</a>[] = {
<a name="l02041"></a>02041    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#ac4fd79d36385b27a0b8f995f53e47f23">handle_abort_shutdown</a>, <span class="stringliteral">&quot;Cancel a running shutdown&quot;</span>),
<a name="l02042"></a>02042    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#ae70030dcf6d4e96327fcd5bc0285b9d7">handle_stop_now</a>, <span class="stringliteral">&quot;Shut down Asterisk immediately&quot;</span>),
<a name="l02043"></a>02043    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#a6bd02774fe0979cefec3d88594749076">handle_stop_gracefully</a>, <span class="stringliteral">&quot;Gracefully shut down Asterisk&quot;</span>),
<a name="l02044"></a>02044    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#acc0f80a205edf9eff08b24f2748f9247">handle_stop_when_convenient</a>, <span class="stringliteral">&quot;Shut down Asterisk at empty call volume&quot;</span>),
<a name="l02045"></a>02045    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#a2da6d477c1f0b2dd06e8010645b495da">handle_restart_now</a>, <span class="stringliteral">&quot;Restart Asterisk immediately&quot;</span>), 
<a name="l02046"></a>02046    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#ac8a53f8c12fe766728372e845a99c822">handle_restart_gracefully</a>, <span class="stringliteral">&quot;Restart Asterisk gracefully&quot;</span>),
<a name="l02047"></a>02047    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#a3f98716c804b0bea3acc983956483ebd">handle_restart_when_convenient</a>, <span class="stringliteral">&quot;Restart Asterisk at empty call volume&quot;</span>),
<a name="l02048"></a>02048    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#a6113c4ebbbc993cf7054a1af8e99da9a">show_warranty</a>, <span class="stringliteral">&quot;Show the warranty (if any) for this copy of Asterisk&quot;</span>),
<a name="l02049"></a>02049    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#a162ffd8e3544ee0038895ad79971dc8a">show_license</a>, <span class="stringliteral">&quot;Show the license(s) for this copy of Asterisk&quot;</span>),
<a name="l02050"></a>02050    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#a828de0b261785adf20714bbcdf9391c6">handle_version</a>, <span class="stringliteral">&quot;Display version info&quot;</span>),
<a name="l02051"></a>02051    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#a2eac41ec93c1f53371ed01a94b7640ac">handle_bang</a>, <span class="stringliteral">&quot;Execute a shell command&quot;</span>),
<a name="l02052"></a>02052 <span class="preprocessor">#if !defined(LOW_MEMORY)</span>
<a name="l02053"></a>02053 <span class="preprocessor"></span>   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#a88756d428992323e89c4cc2310bc16b3" title="CLI command to list module versions.">handle_show_version_files</a>, <span class="stringliteral">&quot;List versions of files used to build Asterisk&quot;</span>),
<a name="l02054"></a>02054    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#a3d42dc32df764617e2201c3637f824cc">handle_show_threads</a>, <span class="stringliteral">&quot;Show running threads&quot;</span>),
<a name="l02055"></a>02055 <span class="preprocessor">#if defined(HAVE_SYSINFO) || defined(HAVE_SYSCTL)</span>
<a name="l02056"></a>02056 <span class="preprocessor"></span>   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(handle_show_sysinfo, <span class="stringliteral">&quot;Show System Information&quot;</span>),
<a name="l02057"></a>02057 <span class="preprocessor">#endif</span>
<a name="l02058"></a>02058 <span class="preprocessor"></span>   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#acd2b29cf44212391e7c62499f7394db5">handle_show_profile</a>, <span class="stringliteral">&quot;Display profiling info&quot;</span>),
<a name="l02059"></a>02059    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#ad66301d131d35faea1df2e7c5b1a1bf2" title="Give an overview of core settings.">handle_show_settings</a>, <span class="stringliteral">&quot;Show some core settings&quot;</span>),
<a name="l02060"></a>02060    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="asterisk_8c.html#aa1b8f26984e7b4f8359502eec3a8cd24">handle_clear_profile</a>, <span class="stringliteral">&quot;Clear profiling info&quot;</span>),
<a name="l02061"></a>02061 <span class="preprocessor">#endif </span><span class="comment">/* ! LOW_MEMORY */</span>
<a name="l02062"></a>02062 };
<a name="l02063"></a>02063 
<a name="l02064"></a><a class="code" href="asterisk_8c.html#a8c676239685680a1e08e1ec8186f50ec">02064</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a8c676239685680a1e08e1ec8186f50ec">ast_el_read_char</a>(EditLine *editline, <span class="keywordtype">char</span> *cp)
<a name="l02065"></a>02065 {
<a name="l02066"></a>02066    <span class="keywordtype">int</span> num_read = 0;
<a name="l02067"></a>02067    <span class="keywordtype">int</span> lastpos = 0;
<a name="l02068"></a>02068    <span class="keyword">struct </span>pollfd fds[2];
<a name="l02069"></a>02069    <span class="keywordtype">int</span> res;
<a name="l02070"></a>02070    <span class="keywordtype">int</span> max;
<a name="l02071"></a>02071 <span class="preprocessor">#define EL_BUF_SIZE 512</span>
<a name="l02072"></a>02072 <span class="preprocessor"></span>   <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="asterisk_8c.html#a85cb51aebe0254ccf6f12cd8a35223de">EL_BUF_SIZE</a>];
<a name="l02073"></a>02073 
<a name="l02074"></a>02074    <span class="keywordflow">for</span> (;;) {
<a name="l02075"></a>02075       max = 1;
<a name="l02076"></a>02076       fds[0].fd = ast_consock;
<a name="l02077"></a>02077       fds[0].events = POLLIN;
<a name="l02078"></a>02078       <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#a301d032d1d86ba46348691f6d135e98a">ast_opt_exec</a>) {
<a name="l02079"></a>02079          fds[1].fd = STDIN_FILENO;
<a name="l02080"></a>02080          fds[1].events = POLLIN;
<a name="l02081"></a>02081          max++;
<a name="l02082"></a>02082       }
<a name="l02083"></a>02083       res = <a class="code" href="poll-compat_8h.html#a5a0c58fa8311e94cd0ed34382aa822f9">ast_poll</a>(fds, max, -1);
<a name="l02084"></a>02084       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l02085"></a>02085          <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>.need_quit)
<a name="l02086"></a>02086             <span class="keywordflow">break</span>;
<a name="l02087"></a>02087          <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EINTR)
<a name="l02088"></a>02088             <span class="keywordflow">continue</span>;
<a name="l02089"></a>02089          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;poll failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02090"></a>02090          <span class="keywordflow">break</span>;
<a name="l02091"></a>02091       }
<a name="l02092"></a>02092 
<a name="l02093"></a>02093       <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#a301d032d1d86ba46348691f6d135e98a">ast_opt_exec</a> &amp;&amp; fds[1].revents) {
<a name="l02094"></a>02094          num_read = read(STDIN_FILENO, cp, 1);
<a name="l02095"></a>02095          <span class="keywordflow">if</span> (num_read &lt; 1) {
<a name="l02096"></a>02096             <span class="keywordflow">break</span>;
<a name="l02097"></a>02097          } <span class="keywordflow">else</span> 
<a name="l02098"></a>02098             <span class="keywordflow">return</span> (num_read);
<a name="l02099"></a>02099       }
<a name="l02100"></a>02100       <span class="keywordflow">if</span> (fds[0].revents) {
<a name="l02101"></a>02101          <span class="keywordtype">char</span> *tmp;
<a name="l02102"></a>02102          res = read(ast_consock, buf, <span class="keyword">sizeof</span>(buf) - 1);
<a name="l02103"></a>02103          <span class="comment">/* if the remote side disappears exit */</span>
<a name="l02104"></a>02104          <span class="keywordflow">if</span> (res &lt; 1) {
<a name="l02105"></a>02105             fprintf(stderr, <span class="stringliteral">&quot;\nDisconnected from Asterisk server\n&quot;</span>);
<a name="l02106"></a>02106             <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#a49c5512f6feedb3629d559dd9f5f4416">ast_opt_reconnect</a>) {
<a name="l02107"></a>02107                <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 0, 0, 0);
<a name="l02108"></a>02108             } <span class="keywordflow">else</span> {
<a name="l02109"></a>02109                <span class="keywordtype">int</span> tries;
<a name="l02110"></a>02110                <span class="keywordtype">int</span> reconnects_per_second = 20;
<a name="l02111"></a>02111                fprintf(stderr, <span class="stringliteral">&quot;Attempting to reconnect for 30 seconds\n&quot;</span>);
<a name="l02112"></a>02112                <span class="keywordflow">for</span> (tries = 0; tries &lt; 30 * reconnects_per_second; tries++) {
<a name="l02113"></a>02113                   <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#ab48b6f8cdddee48aed2f4fba4a6c18fe">ast_tryconnect</a>()) {
<a name="l02114"></a>02114                      fprintf(stderr, <span class="stringliteral">&quot;Reconnect succeeded after %.3f seconds\n&quot;</span>, 1.0 / reconnects_per_second * tries);
<a name="l02115"></a>02115                      printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l02116"></a>02116                      <a class="code" href="asterisk_8c.html#a4102c912e07db36235dbf80dc4f9728a" title="Welcome message when starting a CLI interface.">WELCOME_MESSAGE</a>;
<a name="l02117"></a>02117                      <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#a83121f1ce9acec9e71313b69066aaf79">ast_opt_mute</a>)
<a name="l02118"></a>02118                         <a class="code" href="asterisk_8c.html#ac07499a06d0a0cf1d9ea14cf0693330a">fdsend</a>(ast_consock, <span class="stringliteral">&quot;logger mute silent&quot;</span>);
<a name="l02119"></a>02119                      <span class="keywordflow">else</span> 
<a name="l02120"></a>02120                         printf(<span class="stringliteral">&quot;log and verbose output currently muted (&apos;logger mute&apos; to unmute)\n&quot;</span>);
<a name="l02121"></a>02121                      <span class="keywordflow">break</span>;
<a name="l02122"></a>02122                   } <span class="keywordflow">else</span>
<a name="l02123"></a>02123                      usleep(1000000 / reconnects_per_second);
<a name="l02124"></a>02124                }
<a name="l02125"></a>02125                <span class="keywordflow">if</span> (tries &gt;= 30 * reconnects_per_second) {
<a name="l02126"></a>02126                   fprintf(stderr, <span class="stringliteral">&quot;Failed to reconnect for 30 seconds.  Quitting.\n&quot;</span>);
<a name="l02127"></a>02127                   <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 0, 0, 0);
<a name="l02128"></a>02128                }
<a name="l02129"></a>02129             }
<a name="l02130"></a>02130          }
<a name="l02131"></a>02131 
<a name="l02132"></a>02132          buf[res] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02133"></a>02133 
<a name="l02134"></a>02134          <span class="comment">/* Strip preamble from asynchronous events, too */</span>
<a name="l02135"></a>02135          <span class="keywordflow">for</span> (tmp = buf; *tmp; tmp++) {
<a name="l02136"></a>02136             <span class="keywordflow">if</span> (*tmp == 127) {
<a name="l02137"></a>02137                memmove(tmp, tmp + 1, strlen(tmp));
<a name="l02138"></a>02138                tmp--;
<a name="l02139"></a>02139                res--;
<a name="l02140"></a>02140             }
<a name="l02141"></a>02141          }
<a name="l02142"></a>02142 
<a name="l02143"></a>02143          <span class="comment">/* Write over the CLI prompt */</span>
<a name="l02144"></a>02144          <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#a301d032d1d86ba46348691f6d135e98a">ast_opt_exec</a> &amp;&amp; !lastpos) {
<a name="l02145"></a>02145             <span class="keywordflow">if</span> (write(STDOUT_FILENO, <span class="stringliteral">&quot;\r&quot;</span>, 1) &lt; 0) {
<a name="l02146"></a>02146             }
<a name="l02147"></a>02147          }
<a name="l02148"></a>02148          <span class="keywordflow">if</span> (write(STDOUT_FILENO, buf, res) &lt; 0) {
<a name="l02149"></a>02149          }
<a name="l02150"></a>02150          <span class="keywordflow">if</span> ((res &lt; <a class="code" href="asterisk_8c.html#a85cb51aebe0254ccf6f12cd8a35223de">EL_BUF_SIZE</a> - 1) &amp;&amp; ((buf[res-1] == <span class="charliteral">&apos;\n&apos;</span>) || (buf[res-2] == <span class="charliteral">&apos;\n&apos;</span>))) {
<a name="l02151"></a>02151             *cp = CC_REFRESH;
<a name="l02152"></a>02152             <span class="keywordflow">return</span>(1);
<a name="l02153"></a>02153          } <span class="keywordflow">else</span>
<a name="l02154"></a>02154             lastpos = 1;
<a name="l02155"></a>02155       }
<a name="l02156"></a>02156    }
<a name="l02157"></a>02157 
<a name="l02158"></a>02158    *cp = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02159"></a>02159    <span class="keywordflow">return</span> (0);
<a name="l02160"></a>02160 }
<a name="l02161"></a>02161 
<a name="l02162"></a><a class="code" href="asterisk_8c.html#a299365a3d8977a6c410c6cd924e33136">02162</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *<a class="code" href="asterisk_8c.html#a299365a3d8977a6c410c6cd924e33136">prompt</a> = NULL;
<a name="l02163"></a>02163 
<a name="l02164"></a><a class="code" href="asterisk_8c.html#a76e9858fdda453c648f37aede9f3005c">02164</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a76e9858fdda453c648f37aede9f3005c">cli_prompt</a>(EditLine *editline)
<a name="l02165"></a>02165 {
<a name="l02166"></a>02166    <span class="keywordtype">char</span> tmp[100];
<a name="l02167"></a>02167    <span class="keywordtype">char</span> *pfmt;
<a name="l02168"></a>02168    <span class="keywordtype">int</span> color_used = 0;
<a name="l02169"></a>02169    <span class="keyword">static</span> <span class="keywordtype">int</span> cli_prompt_changes = 0;
<a name="l02170"></a>02170    <span class="keywordtype">char</span> term_code[20];
<a name="l02171"></a>02171    <span class="keyword">struct </span>passwd *pw;
<a name="l02172"></a>02172    <span class="keyword">struct </span><a class="code" href="structgroup.html">group</a> *gr;
<a name="l02173"></a>02173 
<a name="l02174"></a>02174    <span class="keywordflow">if</span> (prompt == NULL) {
<a name="l02175"></a>02175       prompt = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(100);
<a name="l02176"></a>02176    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!cli_prompt_changes) {
<a name="l02177"></a>02177       <span class="keywordflow">return</span> <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(prompt);
<a name="l02178"></a>02178    } <span class="keywordflow">else</span> {
<a name="l02179"></a>02179       <a class="code" href="strings_8h.html#a7820deea616cbb2e28f16d518de91c80" title="Reset the content of a dynamic string. Useful before a series of ast_str_append.">ast_str_reset</a>(prompt);
<a name="l02180"></a>02180    }
<a name="l02181"></a>02181 
<a name="l02182"></a>02182    <span class="keywordflow">if</span> ((pfmt = getenv(<span class="stringliteral">&quot;ASTERISK_PROMPT&quot;</span>))) {
<a name="l02183"></a>02183       <span class="keywordtype">char</span> *t = pfmt;
<a name="l02184"></a>02184       <span class="keyword">struct </span>timeval ts = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l02185"></a>02185       <span class="keywordflow">while</span> (*t != <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l02186"></a>02186          <span class="keywordflow">if</span> (*t == <span class="charliteral">&apos;%&apos;</span>) {
<a name="l02187"></a>02187             <span class="keywordtype">char</span> <a class="code" href="logger_8c.html#af31254e3111773fe1dc68e8dc13df2fe">hostname</a>[<a class="code" href="network_8h.html#afd80ecbe3170ca4fc85b65cda8659f82">MAXHOSTNAMELEN</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02188"></a>02188             <span class="keywordtype">int</span> i, which;
<a name="l02189"></a>02189             <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm = { 0, };
<a name="l02190"></a>02190             <span class="keywordtype">int</span> fgcolor = <a class="code" href="term_8h.html#a9b44987ffdc2af19b635206b94334b69">COLOR_WHITE</a>, bgcolor = <a class="code" href="term_8h.html#aba2a7fe77a7501e5844370eec0185207">COLOR_BLACK</a>;
<a name="l02191"></a>02191 
<a name="l02192"></a>02192             t++;
<a name="l02193"></a>02193             <span class="keywordflow">switch</span> (*t) {
<a name="l02194"></a>02194             <span class="keywordflow">case</span> <span class="charliteral">&apos;C&apos;</span>: <span class="comment">/* color */</span>
<a name="l02195"></a>02195                t++;
<a name="l02196"></a>02196                <span class="keywordflow">if</span> (sscanf(t, <span class="stringliteral">&quot;%30d;%30d%n&quot;</span>, &amp;fgcolor, &amp;bgcolor, &amp;i) == 2) {
<a name="l02197"></a>02197                   <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#ae30b99b6bfddc15d4e37127155752bbe" title="Write a color sequence to a string.">term_color_code</a>(term_code, fgcolor, bgcolor, <span class="keyword">sizeof</span>(term_code)));
<a name="l02198"></a>02198                   t += i - 1;
<a name="l02199"></a>02199                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(t, <span class="stringliteral">&quot;%30d%n&quot;</span>, &amp;fgcolor, &amp;i) == 1) {
<a name="l02200"></a>02200                   <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#ae30b99b6bfddc15d4e37127155752bbe" title="Write a color sequence to a string.">term_color_code</a>(term_code, fgcolor, 0, <span class="keyword">sizeof</span>(term_code)));
<a name="l02201"></a>02201                   t += i - 1;
<a name="l02202"></a>02202                }
<a name="l02203"></a>02203 
<a name="l02204"></a>02204                <span class="comment">/* If the color has been reset correctly, then there&apos;s no need to reset it later */</span>
<a name="l02205"></a>02205                color_used = ((fgcolor == <a class="code" href="term_8h.html#a9b44987ffdc2af19b635206b94334b69">COLOR_WHITE</a>) &amp;&amp; (bgcolor == <a class="code" href="term_8h.html#aba2a7fe77a7501e5844370eec0185207">COLOR_BLACK</a>)) ? 0 : 1;
<a name="l02206"></a>02206                <span class="keywordflow">break</span>;
<a name="l02207"></a>02207             <span class="keywordflow">case</span> <span class="charliteral">&apos;d&apos;</span>: <span class="comment">/* date */</span>
<a name="l02208"></a>02208                <span class="keywordflow">if</span> (<a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;ts, &amp;tm, NULL)) {
<a name="l02209"></a>02209                   <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%Y-%m-%d&quot;</span>, &amp;tm);
<a name="l02210"></a>02210                   <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, tmp);
<a name="l02211"></a>02211                   cli_prompt_changes++;
<a name="l02212"></a>02212                }
<a name="l02213"></a>02213                <span class="keywordflow">break</span>;
<a name="l02214"></a>02214             <span class="keywordflow">case</span> <span class="charliteral">&apos;g&apos;</span>: <span class="comment">/* group */</span>
<a name="l02215"></a>02215                <span class="keywordflow">if</span> ((gr = getgrgid(getgid()))) {
<a name="l02216"></a>02216                   <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, gr-&gt;gr_name);
<a name="l02217"></a>02217                }
<a name="l02218"></a>02218                <span class="keywordflow">break</span>;
<a name="l02219"></a>02219             <span class="keywordflow">case</span> <span class="charliteral">&apos;h&apos;</span>: <span class="comment">/* hostname */</span>
<a name="l02220"></a>02220                <span class="keywordflow">if</span> (!gethostname(hostname, <span class="keyword">sizeof</span>(hostname) - 1)) {
<a name="l02221"></a>02221                   <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, hostname);
<a name="l02222"></a>02222                } <span class="keywordflow">else</span> {
<a name="l02223"></a>02223                   <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;localhost&quot;</span>);
<a name="l02224"></a>02224                }
<a name="l02225"></a>02225                <span class="keywordflow">break</span>;
<a name="l02226"></a>02226             <span class="keywordflow">case</span> <span class="charliteral">&apos;H&apos;</span>: <span class="comment">/* short hostname */</span>
<a name="l02227"></a>02227                <span class="keywordflow">if</span> (!gethostname(hostname, <span class="keyword">sizeof</span>(hostname) - 1)) {
<a name="l02228"></a>02228                   <span class="keywordtype">char</span> *dotptr;
<a name="l02229"></a>02229                   <span class="keywordflow">if</span> ((dotptr = strchr(hostname, <span class="charliteral">&apos;.&apos;</span>))) {
<a name="l02230"></a>02230                      *dotptr = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02231"></a>02231                   }
<a name="l02232"></a>02232                   <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, hostname);
<a name="l02233"></a>02233                } <span class="keywordflow">else</span> {
<a name="l02234"></a>02234                   <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;localhost&quot;</span>);
<a name="l02235"></a>02235                }
<a name="l02236"></a>02236                <span class="keywordflow">break</span>;
<a name="l02237"></a>02237 <span class="preprocessor">#ifdef HAVE_GETLOADAVG</span>
<a name="l02238"></a>02238 <span class="preprocessor"></span>            <span class="keywordflow">case</span> <span class="charliteral">&apos;l&apos;</span>: <span class="comment">/* load avg */</span>
<a name="l02239"></a>02239                t++;
<a name="l02240"></a>02240                <span class="keywordflow">if</span> (sscanf(t, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;which) == 1 &amp;&amp; which &gt; 0 &amp;&amp; which &lt;= 3) {
<a name="l02241"></a>02241                   <span class="keywordtype">double</span> <a class="code" href="structast__atexit.html#a56a8dd0a90ceeac591968d916dc3ecc7">list</a>[3];
<a name="l02242"></a>02242                   <a class="code" href="agi_2strcompat_8c.html#a40e0da58ab6964e3264b90f79ad6d476" title="Return something that won&amp;#39;t cancel the call, but still return -1, in case we...">getloadavg</a>(list, 3);
<a name="l02243"></a>02243                   <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%.2f&quot;</span>, list[which - 1]);
<a name="l02244"></a>02244                   cli_prompt_changes++;
<a name="l02245"></a>02245                }
<a name="l02246"></a>02246                <span class="keywordflow">break</span>;
<a name="l02247"></a>02247 <span class="preprocessor">#endif</span>
<a name="l02248"></a>02248 <span class="preprocessor"></span>            <span class="keywordflow">case</span> <span class="charliteral">&apos;s&apos;</span>: <span class="comment">/* Asterisk system name (from asterisk.conf) */</span>
<a name="l02249"></a>02249                <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="paths_8h.html#ab9f9346c7a41bdf3720f7b1ed02ec703">ast_config_AST_SYSTEM_NAME</a>);
<a name="l02250"></a>02250                <span class="keywordflow">break</span>;
<a name="l02251"></a>02251             <span class="keywordflow">case</span> <span class="charliteral">&apos;t&apos;</span>: <span class="comment">/* time */</span>
<a name="l02252"></a>02252                <span class="keywordflow">if</span> (<a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;ts, &amp;tm, NULL)) {
<a name="l02253"></a>02253                   <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%H:%M:%S&quot;</span>, &amp;tm);
<a name="l02254"></a>02254                   <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, tmp);
<a name="l02255"></a>02255                   cli_prompt_changes++;
<a name="l02256"></a>02256                }
<a name="l02257"></a>02257                <span class="keywordflow">break</span>;
<a name="l02258"></a>02258             <span class="keywordflow">case</span> <span class="charliteral">&apos;u&apos;</span>: <span class="comment">/* username */</span>
<a name="l02259"></a>02259                <span class="keywordflow">if</span> ((pw = getpwuid(getuid()))) {
<a name="l02260"></a>02260                   <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, pw-&gt;pw_name);
<a name="l02261"></a>02261                }
<a name="l02262"></a>02262                <span class="keywordflow">break</span>;
<a name="l02263"></a>02263             <span class="keywordflow">case</span> <span class="charliteral">&apos;#&apos;</span>: <span class="comment">/* process console or remote? */</span>
<a name="l02264"></a>02264                <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%c&quot;</span>, <a class="code" href="options_8h.html#a17d4d9ef04ffa9034f6c6b6c1fd2bb0b">ast_opt_remote</a> ? <span class="charliteral">&apos;&gt;&apos;</span> : <span class="charliteral">&apos;#&apos;</span>);
<a name="l02265"></a>02265                <span class="keywordflow">break</span>;
<a name="l02266"></a>02266             <span class="keywordflow">case</span> <span class="charliteral">&apos;%&apos;</span>: <span class="comment">/* literal % */</span>
<a name="l02267"></a>02267                <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%c&quot;</span>, <span class="charliteral">&apos;%&apos;</span>);
<a name="l02268"></a>02268                <span class="keywordflow">break</span>;
<a name="l02269"></a>02269             <span class="keywordflow">case</span> <span class="charliteral">&apos;\0&apos;</span>: <span class="comment">/* % is last character - prevent bug */</span>
<a name="l02270"></a>02270                t--;
<a name="l02271"></a>02271                <span class="keywordflow">break</span>;
<a name="l02272"></a>02272             }
<a name="l02273"></a>02273          } <span class="keywordflow">else</span> {
<a name="l02274"></a>02274             <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%c&quot;</span>, *t);
<a name="l02275"></a>02275          }
<a name="l02276"></a>02276          t++;
<a name="l02277"></a>02277       }
<a name="l02278"></a>02278       <span class="keywordflow">if</span> (color_used) {
<a name="l02279"></a>02279          <span class="comment">/* Force colors back to normal at end */</span>
<a name="l02280"></a>02280          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#ae30b99b6bfddc15d4e37127155752bbe" title="Write a color sequence to a string.">term_color_code</a>(term_code, 0, 0, <span class="keyword">sizeof</span>(term_code)));
<a name="l02281"></a>02281       }
<a name="l02282"></a>02282    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a04e7dcc4737a260fa91c5241b81c0101">remotehostname</a>) {
<a name="l02283"></a>02283       <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;prompt, 0, <a class="code" href="asterisk_8c.html#ab3c751b4374c79fe9a81bfb69efef22b">ASTERISK_PROMPT2</a>, <a class="code" href="asterisk_8c.html#a04e7dcc4737a260fa91c5241b81c0101">remotehostname</a>);
<a name="l02284"></a>02284    } <span class="keywordflow">else</span> {
<a name="l02285"></a>02285       <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;prompt, 0, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="asterisk_8c.html#a5c70f918dc3849f6f6e22425394ddb5f">ASTERISK_PROMPT</a>);
<a name="l02286"></a>02286    }
<a name="l02287"></a>02287 
<a name="l02288"></a>02288    <span class="keywordflow">return</span> <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(prompt);   
<a name="l02289"></a>02289 }
<a name="l02290"></a>02290 
<a name="l02291"></a><a class="code" href="asterisk_8c.html#a70e0fee16d6500a3c34435cd1c5ea498">02291</a> <span class="keyword">static</span> <span class="keywordtype">char</span> **<a class="code" href="asterisk_8c.html#a70e0fee16d6500a3c34435cd1c5ea498">ast_el_strtoarr</a>(<span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)
<a name="l02292"></a>02292 {
<a name="l02293"></a>02293    <span class="keywordtype">char</span> **match_list = NULL, **match_list_tmp, *retstr;
<a name="l02294"></a>02294    <span class="keywordtype">size_t</span> match_list_len;
<a name="l02295"></a>02295    <span class="keywordtype">int</span> matches = 0;
<a name="l02296"></a>02296 
<a name="l02297"></a>02297    match_list_len = 1;
<a name="l02298"></a>02298    <span class="keywordflow">while</span> ( (retstr = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;buf, <span class="stringliteral">&quot; &quot;</span>)) != NULL) {
<a name="l02299"></a>02299 
<a name="l02300"></a>02300       <span class="keywordflow">if</span> (!strcmp(retstr, <a class="code" href="cli_8h.html#a4970cad1f99a12bc6f6838d538496079">AST_CLI_COMPLETE_EOF</a>))
<a name="l02301"></a>02301          <span class="keywordflow">break</span>;
<a name="l02302"></a>02302       <span class="keywordflow">if</span> (matches + 1 &gt;= match_list_len) {
<a name="l02303"></a>02303          match_list_len &lt;&lt;= 1;
<a name="l02304"></a>02304          <span class="keywordflow">if</span> ((match_list_tmp = <a class="code" href="astmm_8h.html#aa852314efa0cfeecee97ffc51b649734">ast_realloc</a>(match_list, match_list_len * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *)))) {
<a name="l02305"></a>02305             match_list = match_list_tmp;
<a name="l02306"></a>02306          } <span class="keywordflow">else</span> {
<a name="l02307"></a>02307             <span class="keywordflow">if</span> (match_list)
<a name="l02308"></a>02308                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(match_list);
<a name="l02309"></a>02309             <span class="keywordflow">return</span> (<span class="keywordtype">char</span> **) NULL;
<a name="l02310"></a>02310          }
<a name="l02311"></a>02311       }
<a name="l02312"></a>02312 
<a name="l02313"></a>02313       match_list[matches++] = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(retstr);
<a name="l02314"></a>02314    }
<a name="l02315"></a>02315 
<a name="l02316"></a>02316    <span class="keywordflow">if</span> (!match_list)
<a name="l02317"></a>02317       <span class="keywordflow">return</span> (<span class="keywordtype">char</span> **) NULL;
<a name="l02318"></a>02318 
<a name="l02319"></a>02319    <span class="keywordflow">if</span> (matches &gt;= match_list_len) {
<a name="l02320"></a>02320       <span class="keywordflow">if</span> ((match_list_tmp = <a class="code" href="astmm_8h.html#aa852314efa0cfeecee97ffc51b649734">ast_realloc</a>(match_list, (match_list_len + 1) * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *)))) {
<a name="l02321"></a>02321          match_list = match_list_tmp;
<a name="l02322"></a>02322       } <span class="keywordflow">else</span> {
<a name="l02323"></a>02323          <span class="keywordflow">if</span> (match_list)
<a name="l02324"></a>02324             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(match_list);
<a name="l02325"></a>02325          <span class="keywordflow">return</span> (<span class="keywordtype">char</span> **) NULL;
<a name="l02326"></a>02326       }
<a name="l02327"></a>02327    }
<a name="l02328"></a>02328 
<a name="l02329"></a>02329    match_list[matches] = (<span class="keywordtype">char</span> *) NULL;
<a name="l02330"></a>02330 
<a name="l02331"></a>02331    <span class="keywordflow">return</span> match_list;
<a name="l02332"></a>02332 }
<a name="l02333"></a>02333 
<a name="l02334"></a><a class="code" href="asterisk_8c.html#a96dbb19aa82daee03648889632a8805a">02334</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a96dbb19aa82daee03648889632a8805a">ast_el_sort_compare</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *i1, <span class="keyword">const</span> <span class="keywordtype">void</span> *i2)
<a name="l02335"></a>02335 {
<a name="l02336"></a>02336    <span class="keywordtype">char</span> *s1, *s2;
<a name="l02337"></a>02337 
<a name="l02338"></a>02338    s1 = ((<span class="keywordtype">char</span> **)i1)[0];
<a name="l02339"></a>02339    s2 = ((<span class="keywordtype">char</span> **)i2)[0];
<a name="l02340"></a>02340 
<a name="l02341"></a>02341    <span class="keywordflow">return</span> strcasecmp(s1, s2);
<a name="l02342"></a>02342 }
<a name="l02343"></a>02343 
<a name="l02344"></a><a class="code" href="asterisk_8c.html#a98a781e15da569de796171307ea122e0">02344</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a98a781e15da569de796171307ea122e0">ast_cli_display_match_list</a>(<span class="keywordtype">char</span> **matches, <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> max)
<a name="l02345"></a>02345 {
<a name="l02346"></a>02346    <span class="keywordtype">int</span> i, idx, limit, count;
<a name="l02347"></a>02347    <span class="keywordtype">int</span> screenwidth = 0;
<a name="l02348"></a>02348    <span class="keywordtype">int</span> numoutput = 0, numoutputline = 0;
<a name="l02349"></a>02349 
<a name="l02350"></a>02350    screenwidth = <a class="code" href="io_8h.html#a8942a1f4804edc930a130dd74f91ed17">ast_get_termcols</a>(STDOUT_FILENO);
<a name="l02351"></a>02351 
<a name="l02352"></a>02352    <span class="comment">/* find out how many entries can be put on one line, with two spaces between strings */</span>
<a name="l02353"></a>02353    limit = screenwidth / (max + 2);
<a name="l02354"></a>02354    <span class="keywordflow">if</span> (limit == 0)
<a name="l02355"></a>02355       limit = 1;
<a name="l02356"></a>02356 
<a name="l02357"></a>02357    <span class="comment">/* how many lines of output */</span>
<a name="l02358"></a>02358    count = len / limit;
<a name="l02359"></a>02359    <span class="keywordflow">if</span> (count * limit &lt; len)
<a name="l02360"></a>02360       count++;
<a name="l02361"></a>02361 
<a name="l02362"></a>02362    idx = 1;
<a name="l02363"></a>02363 
<a name="l02364"></a>02364    qsort(&amp;matches[0], (<span class="keywordtype">size_t</span>)(len), <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *), <a class="code" href="asterisk_8c.html#a96dbb19aa82daee03648889632a8805a">ast_el_sort_compare</a>);
<a name="l02365"></a>02365 
<a name="l02366"></a>02366    <span class="keywordflow">for</span> (; count &gt; 0; count--) {
<a name="l02367"></a>02367       numoutputline = 0;
<a name="l02368"></a>02368       <span class="keywordflow">for</span> (i = 0; i &lt; limit &amp;&amp; matches[idx]; i++, idx++) {
<a name="l02369"></a>02369 
<a name="l02370"></a>02370          <span class="comment">/* Don&apos;t print dupes */</span>
<a name="l02371"></a>02371          <span class="keywordflow">if</span> ( (matches[idx+1] != NULL &amp;&amp; strcmp(matches[idx], matches[idx+1]) == 0 ) ) {
<a name="l02372"></a>02372             i--;
<a name="l02373"></a>02373             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(matches[idx]);
<a name="l02374"></a>02374             matches[idx] = NULL;
<a name="l02375"></a>02375             <span class="keywordflow">continue</span>;
<a name="l02376"></a>02376          }
<a name="l02377"></a>02377 
<a name="l02378"></a>02378          numoutput++;
<a name="l02379"></a>02379          numoutputline++;
<a name="l02380"></a>02380          fprintf(stdout, <span class="stringliteral">&quot;%-*s  &quot;</span>, max, matches[idx]);
<a name="l02381"></a>02381          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(matches[idx]);
<a name="l02382"></a>02382          matches[idx] = NULL;
<a name="l02383"></a>02383       }
<a name="l02384"></a>02384       <span class="keywordflow">if</span> (numoutputline &gt; 0)
<a name="l02385"></a>02385          fprintf(stdout, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02386"></a>02386    }
<a name="l02387"></a>02387 
<a name="l02388"></a>02388    <span class="keywordflow">return</span> numoutput;
<a name="l02389"></a>02389 }
<a name="l02390"></a>02390 
<a name="l02391"></a>02391 
<a name="l02392"></a><a class="code" href="asterisk_8c.html#a31d30092ec56ba10a14cfdfcb613d1b2">02392</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a31d30092ec56ba10a14cfdfcb613d1b2">cli_complete</a>(EditLine *editline, <span class="keywordtype">int</span> ch)
<a name="l02393"></a>02393 {
<a name="l02394"></a>02394    <span class="keywordtype">int</span> len = 0;
<a name="l02395"></a>02395    <span class="keywordtype">char</span> *ptr;
<a name="l02396"></a>02396    <span class="keywordtype">int</span> nummatches = 0;
<a name="l02397"></a>02397    <span class="keywordtype">char</span> **matches;
<a name="l02398"></a>02398    <span class="keywordtype">int</span> retval = CC_ERROR;
<a name="l02399"></a>02399    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[2048], savechr;
<a name="l02400"></a>02400    <span class="keywordtype">int</span> res;
<a name="l02401"></a>02401 
<a name="l02402"></a>02402    LineInfo *lf = (LineInfo *)el_line(editline);
<a name="l02403"></a>02403 
<a name="l02404"></a>02404    savechr = *(<span class="keywordtype">char</span> *)lf-&gt;cursor;
<a name="l02405"></a>02405    *(<span class="keywordtype">char</span> *)lf-&gt;cursor = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02406"></a>02406    ptr = (<span class="keywordtype">char</span> *)lf-&gt;cursor;
<a name="l02407"></a>02407    if (ptr) {
<a name="l02408"></a>02408       <span class="keywordflow">while</span> (ptr &gt; lf-&gt;buffer) {
<a name="l02409"></a>02409          <span class="keywordflow">if</span> (isspace(*ptr)) {
<a name="l02410"></a>02410             ptr++;
<a name="l02411"></a>02411             <span class="keywordflow">break</span>;
<a name="l02412"></a>02412          }
<a name="l02413"></a>02413          ptr--;
<a name="l02414"></a>02414       }
<a name="l02415"></a>02415    }
<a name="l02416"></a>02416 
<a name="l02417"></a>02417    len = lf-&gt;cursor - ptr;
<a name="l02418"></a>02418 
<a name="l02419"></a>02419    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a17d4d9ef04ffa9034f6c6b6c1fd2bb0b">ast_opt_remote</a>) {
<a name="l02420"></a>02420       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;_COMMAND NUMMATCHES \&quot;%s\&quot; \&quot;%s\&quot;&quot;</span>, lf-&gt;buffer, ptr); 
<a name="l02421"></a>02421       <a class="code" href="asterisk_8c.html#ac07499a06d0a0cf1d9ea14cf0693330a">fdsend</a>(ast_consock, buf);
<a name="l02422"></a>02422       res = read(ast_consock, buf, <span class="keyword">sizeof</span>(buf) - 1);
<a name="l02423"></a>02423       buf[res] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02424"></a>02424       nummatches = atoi(buf);
<a name="l02425"></a>02425 
<a name="l02426"></a>02426       <span class="keywordflow">if</span> (nummatches &gt; 0) {
<a name="l02427"></a>02427          <span class="keywordtype">char</span> *mbuf;
<a name="l02428"></a>02428          <span class="keywordtype">int</span> mlen = 0, maxmbuf = 2048;
<a name="l02429"></a>02429          <span class="comment">/* Start with a 2048 byte buffer */</span>       
<a name="l02430"></a>02430          <span class="keywordflow">if</span> (!(mbuf = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(maxmbuf))) {
<a name="l02431"></a>02431             lf-&gt;cursor[0] = savechr;
<a name="l02432"></a>02432             <span class="keywordflow">return</span> (<span class="keywordtype">char</span> *)(CC_ERROR);
<a name="l02433"></a>02433          }
<a name="l02434"></a>02434          snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;_COMMAND MATCHESARRAY \&quot;%s\&quot; \&quot;%s\&quot;&quot;</span>, lf-&gt;buffer, ptr); 
<a name="l02435"></a>02435          <a class="code" href="asterisk_8c.html#ac07499a06d0a0cf1d9ea14cf0693330a">fdsend</a>(ast_consock, buf);
<a name="l02436"></a>02436          res = 0;
<a name="l02437"></a>02437          mbuf[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02438"></a>02438          <span class="keywordflow">while</span> (!strstr(mbuf, <a class="code" href="cli_8h.html#a4970cad1f99a12bc6f6838d538496079">AST_CLI_COMPLETE_EOF</a>) &amp;&amp; res != -1) {
<a name="l02439"></a>02439             <span class="keywordflow">if</span> (mlen + 1024 &gt; maxmbuf) {
<a name="l02440"></a>02440                <span class="comment">/* Every step increment buffer 1024 bytes */</span>
<a name="l02441"></a>02441                maxmbuf += 1024;              
<a name="l02442"></a>02442                <span class="keywordflow">if</span> (!(mbuf = <a class="code" href="astmm_8h.html#aa852314efa0cfeecee97ffc51b649734">ast_realloc</a>(mbuf, maxmbuf))) {
<a name="l02443"></a>02443                   lf-&gt;cursor[0] = savechr;
<a name="l02444"></a>02444                   <span class="keywordflow">return</span> (<span class="keywordtype">char</span> *)(CC_ERROR);
<a name="l02445"></a>02445                }
<a name="l02446"></a>02446             }
<a name="l02447"></a>02447             <span class="comment">/* Only read 1024 bytes at a time */</span>
<a name="l02448"></a>02448             res = read(ast_consock, mbuf + mlen, 1024);
<a name="l02449"></a>02449             <span class="keywordflow">if</span> (res &gt; 0)
<a name="l02450"></a>02450                mlen += res;
<a name="l02451"></a>02451          }
<a name="l02452"></a>02452          mbuf[mlen] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02453"></a>02453 
<a name="l02454"></a>02454          matches = <a class="code" href="asterisk_8c.html#a70e0fee16d6500a3c34435cd1c5ea498">ast_el_strtoarr</a>(mbuf);
<a name="l02455"></a>02455          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(mbuf);
<a name="l02456"></a>02456       } <span class="keywordflow">else</span>
<a name="l02457"></a>02457          matches = (<span class="keywordtype">char</span> **) NULL;
<a name="l02458"></a>02458    } <span class="keywordflow">else</span> {
<a name="l02459"></a>02459       <span class="keywordtype">char</span> **p, *oldbuf=NULL;
<a name="l02460"></a>02460       nummatches = 0;
<a name="l02461"></a>02461       matches = <a class="code" href="cli_8h.html#a068d40212b118f7bc09e851af6a45015" title="Generates a NULL-terminated array of strings that 1) begin with the string in the...">ast_cli_completion_matches</a>((<span class="keywordtype">char</span> *)lf-&gt;buffer,ptr);
<a name="l02462"></a>02462       <span class="keywordflow">for</span> (p = matches; p &amp;&amp; *p; p++) {
<a name="l02463"></a>02463          <span class="keywordflow">if</span> (!oldbuf || strcmp(*p,oldbuf))
<a name="l02464"></a>02464             nummatches++;
<a name="l02465"></a>02465          oldbuf = *p;
<a name="l02466"></a>02466       }
<a name="l02467"></a>02467    }
<a name="l02468"></a>02468 
<a name="l02469"></a>02469    <span class="keywordflow">if</span> (matches) {
<a name="l02470"></a>02470       <span class="keywordtype">int</span> i;
<a name="l02471"></a>02471       <span class="keywordtype">int</span> matches_num, maxlen, match_len;
<a name="l02472"></a>02472 
<a name="l02473"></a>02473       <span class="keywordflow">if</span> (matches[0][0] != <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l02474"></a>02474          el_deletestr(editline, (<span class="keywordtype">int</span>) len);
<a name="l02475"></a>02475          el_insertstr(editline, matches[0]);
<a name="l02476"></a>02476          retval = CC_REFRESH;
<a name="l02477"></a>02477       }
<a name="l02478"></a>02478 
<a name="l02479"></a>02479       <span class="keywordflow">if</span> (nummatches == 1) {
<a name="l02480"></a>02480          <span class="comment">/* Found an exact match */</span>
<a name="l02481"></a>02481          el_insertstr(editline, <span class="stringliteral">&quot; &quot;</span>);
<a name="l02482"></a>02482          retval = CC_REFRESH;
<a name="l02483"></a>02483       } <span class="keywordflow">else</span> {
<a name="l02484"></a>02484          <span class="comment">/* Must be more than one match */</span>
<a name="l02485"></a>02485          <span class="keywordflow">for</span> (i = 1, maxlen = 0; matches[i]; i++) {
<a name="l02486"></a>02486             match_len = strlen(matches[i]);
<a name="l02487"></a>02487             <span class="keywordflow">if</span> (match_len &gt; maxlen)
<a name="l02488"></a>02488                maxlen = match_len;
<a name="l02489"></a>02489          }
<a name="l02490"></a>02490          matches_num = i - 1;
<a name="l02491"></a>02491          <span class="keywordflow">if</span> (matches_num &gt;1) {
<a name="l02492"></a>02492             fprintf(stdout, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02493"></a>02493             <a class="code" href="asterisk_8c.html#a98a781e15da569de796171307ea122e0">ast_cli_display_match_list</a>(matches, nummatches, maxlen);
<a name="l02494"></a>02494             retval = CC_REDISPLAY;
<a name="l02495"></a>02495          } <span class="keywordflow">else</span> { 
<a name="l02496"></a>02496             el_insertstr(editline,<span class="stringliteral">&quot; &quot;</span>);
<a name="l02497"></a>02497             retval = CC_REFRESH;
<a name="l02498"></a>02498          }
<a name="l02499"></a>02499       }
<a name="l02500"></a>02500       <span class="keywordflow">for</span> (i = 0; matches[i]; i++)
<a name="l02501"></a>02501          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(matches[i]);
<a name="l02502"></a>02502       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(matches);
<a name="l02503"></a>02503    }
<a name="l02504"></a>02504 
<a name="l02505"></a>02505    lf-&gt;cursor[0] = savechr;
<a name="l02506"></a>02506 
<a name="l02507"></a>02507    <span class="keywordflow">return</span> (<span class="keywordtype">char</span> *)(long)retval;
<a name="l02508"></a>02508 }
<a name="l02509"></a>02509 
<a name="l02510"></a><a class="code" href="asterisk_8c.html#a6314c179e2d65f03b48aab48fcfc430f">02510</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a6314c179e2d65f03b48aab48fcfc430f">ast_el_initialize</a>(<span class="keywordtype">void</span>)
<a name="l02511"></a>02511 {
<a name="l02512"></a>02512    HistEvent ev;
<a name="l02513"></a>02513    <span class="keywordtype">char</span> *editor = getenv(<span class="stringliteral">&quot;AST_EDITOR&quot;</span>);
<a name="l02514"></a>02514 
<a name="l02515"></a>02515    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a> != NULL)
<a name="l02516"></a>02516       el_end(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>);
<a name="l02517"></a>02517    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a> != NULL)
<a name="l02518"></a>02518       history_end(<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a>);
<a name="l02519"></a>02519 
<a name="l02520"></a>02520    <a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a> = el_init(<span class="stringliteral">&quot;asterisk&quot;</span>, stdin, stdout, stderr);
<a name="l02521"></a>02521    el_set(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, EL_PROMPT, <a class="code" href="asterisk_8c.html#a76e9858fdda453c648f37aede9f3005c">cli_prompt</a>);
<a name="l02522"></a>02522 
<a name="l02523"></a>02523    el_set(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, EL_EDITMODE, 1);      
<a name="l02524"></a>02524    el_set(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, EL_EDITOR, editor ? editor : <span class="stringliteral">&quot;emacs&quot;</span>);     
<a name="l02525"></a>02525    <a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a> = history_init();
<a name="l02526"></a>02526    <span class="keywordflow">if</span> (!<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a> || !<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a>)
<a name="l02527"></a>02527       <span class="keywordflow">return</span> -1;
<a name="l02528"></a>02528 
<a name="l02529"></a>02529    <span class="comment">/* setup history with 100 entries */</span>
<a name="l02530"></a>02530    history(<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a>, &amp;ev, H_SETSIZE, 100);
<a name="l02531"></a>02531 
<a name="l02532"></a>02532    el_set(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, EL_HIST, history, <a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a>);
<a name="l02533"></a>02533 
<a name="l02534"></a>02534    el_set(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, EL_ADDFN, <span class="stringliteral">&quot;ed-complete&quot;</span>, <span class="stringliteral">&quot;Complete argument&quot;</span>, <a class="code" href="asterisk_8c.html#a31d30092ec56ba10a14cfdfcb613d1b2">cli_complete</a>);
<a name="l02535"></a>02535    <span class="comment">/* Bind &lt;tab&gt; to command completion */</span>
<a name="l02536"></a>02536    el_set(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, EL_BIND, <span class="stringliteral">&quot;^I&quot;</span>, <span class="stringliteral">&quot;ed-complete&quot;</span>, NULL);
<a name="l02537"></a>02537    <span class="comment">/* Bind ? to command completion */</span>
<a name="l02538"></a>02538    el_set(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, EL_BIND, <span class="stringliteral">&quot;?&quot;</span>, <span class="stringliteral">&quot;ed-complete&quot;</span>, NULL);
<a name="l02539"></a>02539    <span class="comment">/* Bind ^D to redisplay */</span>
<a name="l02540"></a>02540    el_set(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, EL_BIND, <span class="stringliteral">&quot;^D&quot;</span>, <span class="stringliteral">&quot;ed-redisplay&quot;</span>, NULL);
<a name="l02541"></a>02541 
<a name="l02542"></a>02542    <span class="keywordflow">return</span> 0;
<a name="l02543"></a>02543 }
<a name="l02544"></a>02544 
<a name="l02545"></a><a class="code" href="asterisk_8c.html#a8912c9eedfa2f08023a2a0901bac3af3">02545</a> <span class="preprocessor">#define MAX_HISTORY_COMMAND_LENGTH 256</span>
<a name="l02546"></a>02546 <span class="preprocessor"></span>
<a name="l02547"></a><a class="code" href="asterisk_8c.html#a9aff30b106c705ecc3484dadd6395f64">02547</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a9aff30b106c705ecc3484dadd6395f64">ast_el_add_history</a>(<span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)
<a name="l02548"></a>02548 {
<a name="l02549"></a>02549    HistEvent ev;
<a name="l02550"></a>02550 
<a name="l02551"></a>02551    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a> == NULL || <a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a> == NULL)
<a name="l02552"></a>02552       <a class="code" href="asterisk_8c.html#a6314c179e2d65f03b48aab48fcfc430f">ast_el_initialize</a>();
<a name="l02553"></a>02553    <span class="keywordflow">if</span> (strlen(buf) &gt; (<a class="code" href="asterisk_8c.html#a8912c9eedfa2f08023a2a0901bac3af3">MAX_HISTORY_COMMAND_LENGTH</a> - 1))
<a name="l02554"></a>02554       <span class="keywordflow">return</span> 0;
<a name="l02555"></a>02555    <span class="keywordflow">return</span> (history(<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a>, &amp;ev, H_ENTER, <a class="code" href="strings_8h.html#aeb1c54e6e100c63176d8e22b0d5ca865" title="Strip leading/trailing whitespace from a string.">ast_strip</a>(<a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(buf))));
<a name="l02556"></a>02556 }
<a name="l02557"></a>02557 
<a name="l02558"></a><a class="code" href="asterisk_8c.html#ad1dbb4e490dd946730de06a87531ba9c">02558</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#ad1dbb4e490dd946730de06a87531ba9c">ast_el_write_history</a>(<span class="keywordtype">char</span> *filename)
<a name="l02559"></a>02559 {
<a name="l02560"></a>02560    HistEvent ev;
<a name="l02561"></a>02561 
<a name="l02562"></a>02562    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a> == NULL || <a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a> == NULL)
<a name="l02563"></a>02563       <a class="code" href="asterisk_8c.html#a6314c179e2d65f03b48aab48fcfc430f">ast_el_initialize</a>();
<a name="l02564"></a>02564 
<a name="l02565"></a>02565    <span class="keywordflow">return</span> (history(<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a>, &amp;ev, H_SAVE, filename));
<a name="l02566"></a>02566 }
<a name="l02567"></a>02567 
<a name="l02568"></a><a class="code" href="asterisk_8c.html#a5cd497fbc32fe40a9c3d941ca56a04a0">02568</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a5cd497fbc32fe40a9c3d941ca56a04a0">ast_el_read_history</a>(<span class="keywordtype">char</span> *filename)
<a name="l02569"></a>02569 {
<a name="l02570"></a>02570    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="asterisk_8c.html#a8912c9eedfa2f08023a2a0901bac3af3">MAX_HISTORY_COMMAND_LENGTH</a>];
<a name="l02571"></a>02571    FILE *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l02572"></a>02572    <span class="keywordtype">int</span> ret = -1;
<a name="l02573"></a>02573 
<a name="l02574"></a>02574    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a> == NULL || <a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a> == NULL)
<a name="l02575"></a>02575       <a class="code" href="asterisk_8c.html#a6314c179e2d65f03b48aab48fcfc430f">ast_el_initialize</a>();
<a name="l02576"></a>02576 
<a name="l02577"></a>02577    <span class="keywordflow">if</span> ((f = fopen(filename, <span class="stringliteral">&quot;r&quot;</span>)) == NULL)
<a name="l02578"></a>02578       <span class="keywordflow">return</span> ret;
<a name="l02579"></a>02579 
<a name="l02580"></a>02580    <span class="keywordflow">while</span> (!feof(f)) {
<a name="l02581"></a>02581       <span class="keywordflow">if</span> (!fgets(buf, <span class="keyword">sizeof</span>(buf), f))
<a name="l02582"></a>02582          <span class="keywordflow">break</span>;
<a name="l02583"></a>02583       <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;_HiStOrY_V2_\n&quot;</span>))
<a name="l02584"></a>02584          <span class="keywordflow">continue</span>;
<a name="l02585"></a>02585       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#ab784c35637d8cd3a88aaacd75cdb90d2">ast_all_zeros</a>(buf))
<a name="l02586"></a>02586          <span class="keywordflow">continue</span>;
<a name="l02587"></a>02587       <span class="keywordflow">if</span> ((ret = <a class="code" href="asterisk_8c.html#a9aff30b106c705ecc3484dadd6395f64">ast_el_add_history</a>(buf)) == -1)
<a name="l02588"></a>02588          <span class="keywordflow">break</span>;
<a name="l02589"></a>02589    }
<a name="l02590"></a>02590    fclose(f);
<a name="l02591"></a>02591 
<a name="l02592"></a>02592    <span class="keywordflow">return</span> ret;
<a name="l02593"></a>02593 }
<a name="l02594"></a>02594 
<a name="l02595"></a><a class="code" href="asterisk_8c.html#a8f0bd75717a5fd70f289769dd7698339">02595</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a8f0bd75717a5fd70f289769dd7698339">ast_remotecontrol</a>(<span class="keywordtype">char</span> *data)
<a name="l02596"></a>02596 {
<a name="l02597"></a>02597    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[80];
<a name="l02598"></a>02598    <span class="keywordtype">int</span> res;
<a name="l02599"></a>02599    <span class="keywordtype">char</span> filename[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02600"></a>02600    <span class="keywordtype">char</span> *<a class="code" href="logger_8c.html#af31254e3111773fe1dc68e8dc13df2fe">hostname</a>;
<a name="l02601"></a>02601    <span class="keywordtype">char</span> *cpid;
<a name="l02602"></a>02602    <span class="keywordtype">char</span> *<a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>;
<a name="l02603"></a>02603    <span class="keywordtype">int</span> pid;
<a name="l02604"></a>02604    <span class="keywordtype">char</span> *stringp = NULL;
<a name="l02605"></a>02605 
<a name="l02606"></a>02606    <span class="keywordtype">char</span> *ebuf;
<a name="l02607"></a>02607    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a> = 0;
<a name="l02608"></a>02608 
<a name="l02609"></a>02609    memset(&amp;<a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>));
<a name="l02610"></a>02610    signal(SIGINT, <a class="code" href="asterisk_8c.html#a128997a8231cdc87af7181da9ac78b7b">__remote_quit_handler</a>);
<a name="l02611"></a>02611    signal(SIGTERM, <a class="code" href="asterisk_8c.html#a128997a8231cdc87af7181da9ac78b7b">__remote_quit_handler</a>);
<a name="l02612"></a>02612    signal(SIGHUP, <a class="code" href="asterisk_8c.html#a128997a8231cdc87af7181da9ac78b7b">__remote_quit_handler</a>);
<a name="l02613"></a>02613 
<a name="l02614"></a>02614    <span class="keywordflow">if</span> (read(ast_consock, buf, <span class="keyword">sizeof</span>(buf)) &lt; 0) {
<a name="l02615"></a>02615       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;read() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02616"></a>02616       <span class="keywordflow">return</span>;
<a name="l02617"></a>02617    }
<a name="l02618"></a>02618    <span class="keywordflow">if</span> (data) {
<a name="l02619"></a>02619       <span class="keywordtype">char</span> <a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>[] = <span class="stringliteral">&quot;cli quit after &quot;</span>;
<a name="l02620"></a>02620       <span class="keywordtype">char</span> *tmp = alloca(strlen(data) + strlen(prefix) + 1);
<a name="l02621"></a>02621       sprintf(tmp, <span class="stringliteral">&quot;%s%s&quot;</span>, prefix, data);
<a name="l02622"></a>02622       <span class="keywordflow">if</span> (write(ast_consock, tmp, strlen(tmp) + 1) &lt; 0) {
<a name="l02623"></a>02623          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;write() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02624"></a>02624          <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>.need_quit == 1) {
<a name="l02625"></a>02625             <span class="keywordflow">return</span>;
<a name="l02626"></a>02626          }
<a name="l02627"></a>02627       }
<a name="l02628"></a>02628    }
<a name="l02629"></a>02629    stringp = buf;
<a name="l02630"></a>02630    hostname = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l02631"></a>02631    cpid = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l02632"></a>02632    version = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02633"></a>02633    <span class="keywordflow">if</span> (!version)
<a name="l02634"></a>02634       version = <span class="stringliteral">&quot;&lt;Version Unknown&gt;&quot;</span>;
<a name="l02635"></a>02635    stringp = hostname;
<a name="l02636"></a>02636    <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;.&quot;</span>);
<a name="l02637"></a>02637    <span class="keywordflow">if</span> (cpid)
<a name="l02638"></a>02638       pid = atoi(cpid);
<a name="l02639"></a>02639    <span class="keywordflow">else</span>
<a name="l02640"></a>02640       pid = -1;
<a name="l02641"></a>02641    <span class="keywordflow">if</span> (!data) {
<a name="l02642"></a>02642       <span class="keywordtype">char</span> tmp[80];
<a name="l02643"></a>02643       snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;core set verbose atleast %d&quot;</span>, option_verbose);
<a name="l02644"></a>02644       <a class="code" href="asterisk_8c.html#ac07499a06d0a0cf1d9ea14cf0693330a">fdsend</a>(ast_consock, tmp);
<a name="l02645"></a>02645       snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;core set debug atleast %d&quot;</span>, option_debug);
<a name="l02646"></a>02646       <a class="code" href="asterisk_8c.html#ac07499a06d0a0cf1d9ea14cf0693330a">fdsend</a>(ast_consock, tmp);
<a name="l02647"></a>02647       <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#a83121f1ce9acec9e71313b69066aaf79">ast_opt_mute</a>)
<a name="l02648"></a>02648          <a class="code" href="asterisk_8c.html#ac07499a06d0a0cf1d9ea14cf0693330a">fdsend</a>(ast_consock, <span class="stringliteral">&quot;logger mute silent&quot;</span>);
<a name="l02649"></a>02649       <span class="keywordflow">else</span> 
<a name="l02650"></a>02650          printf(<span class="stringliteral">&quot;log and verbose output currently muted (&apos;logger mute&apos; to unmute)\n&quot;</span>);
<a name="l02651"></a>02651    }
<a name="l02652"></a>02652 
<a name="l02653"></a>02653    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a301d032d1d86ba46348691f6d135e98a">ast_opt_exec</a> &amp;&amp; data) {  <span class="comment">/* hack to print output then exit if asterisk -rx is used */</span>
<a name="l02654"></a>02654       <span class="keyword">struct </span>pollfd fds;
<a name="l02655"></a>02655       fds.fd = ast_consock;
<a name="l02656"></a>02656       fds.events = POLLIN;
<a name="l02657"></a>02657       fds.revents = 0;
<a name="l02658"></a>02658       <span class="keywordflow">while</span> (<a class="code" href="poll-compat_8h.html#a5a0c58fa8311e94cd0ed34382aa822f9">ast_poll</a>(&amp;fds, 1, 500) &gt; 0) {
<a name="l02659"></a>02659          <span class="keywordtype">char</span> buffer[512] = <span class="stringliteral">&quot;&quot;</span>, *curline = buffer, *nextline;
<a name="l02660"></a>02660          <span class="keywordtype">int</span> not_written = 1;
<a name="l02661"></a>02661 
<a name="l02662"></a>02662          <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>.need_quit == 1) {
<a name="l02663"></a>02663             <span class="keywordflow">break</span>;
<a name="l02664"></a>02664          }
<a name="l02665"></a>02665 
<a name="l02666"></a>02666          <span class="keywordflow">if</span> (read(ast_consock, buffer, <span class="keyword">sizeof</span>(buffer) - 1) &lt;= 0) {
<a name="l02667"></a>02667             <span class="keywordflow">break</span>;
<a name="l02668"></a>02668          }
<a name="l02669"></a>02669 
<a name="l02670"></a>02670          <span class="keywordflow">do</span> {
<a name="l02671"></a>02671             <span class="keywordflow">if</span> ((nextline = strchr(curline, <span class="charliteral">&apos;\n&apos;</span>))) {
<a name="l02672"></a>02672                nextline++;
<a name="l02673"></a>02673             } <span class="keywordflow">else</span> {
<a name="l02674"></a>02674                nextline = strchr(curline, <span class="charliteral">&apos;\0&apos;</span>);
<a name="l02675"></a>02675             }
<a name="l02676"></a>02676 
<a name="l02677"></a>02677             <span class="comment">/* Skip verbose lines */</span>
<a name="l02678"></a>02678             <span class="keywordflow">if</span> (*curline != 127) {
<a name="l02679"></a>02679                not_written = 0;
<a name="l02680"></a>02680                <span class="keywordflow">if</span> (write(STDOUT_FILENO, curline, nextline - curline) &lt; 0) {
<a name="l02681"></a>02681                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;write() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02682"></a>02682                }
<a name="l02683"></a>02683             }
<a name="l02684"></a>02684             curline = nextline;
<a name="l02685"></a>02685          } <span class="keywordflow">while</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(curline));
<a name="l02686"></a>02686 
<a name="l02687"></a>02687          <span class="comment">/* No non-verbose output in 500ms */</span>
<a name="l02688"></a>02688          <span class="keywordflow">if</span> (not_written) {
<a name="l02689"></a>02689             <span class="keywordflow">break</span>;
<a name="l02690"></a>02690          }
<a name="l02691"></a>02691       }
<a name="l02692"></a>02692       <span class="keywordflow">return</span>;
<a name="l02693"></a>02693    }
<a name="l02694"></a>02694 
<a name="l02695"></a>02695    <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Connected to Asterisk %s currently running on %s (pid = %d)\n&quot;</span>, version, hostname, pid);
<a name="l02696"></a>02696    <a class="code" href="asterisk_8c.html#a04e7dcc4737a260fa91c5241b81c0101">remotehostname</a> = hostname;
<a name="l02697"></a>02697    <span class="keywordflow">if</span> (getenv(<span class="stringliteral">&quot;HOME&quot;</span>)) 
<a name="l02698"></a>02698       snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s/.asterisk_history&quot;</span>, getenv(<span class="stringliteral">&quot;HOME&quot;</span>));
<a name="l02699"></a>02699    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a> == NULL || <a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a> == NULL)
<a name="l02700"></a>02700       <a class="code" href="asterisk_8c.html#a6314c179e2d65f03b48aab48fcfc430f">ast_el_initialize</a>();
<a name="l02701"></a>02701 
<a name="l02702"></a>02702    el_set(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, EL_GETCFN, <a class="code" href="asterisk_8c.html#a8c676239685680a1e08e1ec8186f50ec">ast_el_read_char</a>);
<a name="l02703"></a>02703 
<a name="l02704"></a>02704    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(filename))
<a name="l02705"></a>02705       <a class="code" href="asterisk_8c.html#a5cd497fbc32fe40a9c3d941ca56a04a0">ast_el_read_history</a>(filename);
<a name="l02706"></a>02706 
<a name="l02707"></a>02707    <span class="keywordflow">for</span> (;;) {
<a name="l02708"></a>02708       ebuf = (<span class="keywordtype">char</span> *)el_gets(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, &amp;num);
<a name="l02709"></a>02709 
<a name="l02710"></a>02710       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>.need_quit == 1) {
<a name="l02711"></a>02711          <span class="keywordflow">break</span>;
<a name="l02712"></a>02712       }
<a name="l02713"></a>02713 
<a name="l02714"></a>02714       <span class="keywordflow">if</span> (!ebuf &amp;&amp; write(1, <span class="stringliteral">&quot;&quot;</span>, 1) &lt; 0)
<a name="l02715"></a>02715          <span class="keywordflow">break</span>;
<a name="l02716"></a>02716 
<a name="l02717"></a>02717       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(ebuf)) {
<a name="l02718"></a>02718          <span class="keywordflow">if</span> (ebuf[strlen(ebuf)-1] == <span class="charliteral">&apos;\n&apos;</span>)
<a name="l02719"></a>02719             ebuf[strlen(ebuf)-1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02720"></a>02720          <span class="keywordflow">if</span> (!<a class="code" href="asterisk_8c.html#a84a9beadb8d73516c4b1cbe838453ff9">remoteconsolehandler</a>(ebuf)) {
<a name="l02721"></a>02721             <span class="comment">/* Strip preamble from output */</span>
<a name="l02722"></a>02722             <span class="keywordtype">char</span> *temp;
<a name="l02723"></a>02723             <span class="keywordflow">for</span> (temp = ebuf; *temp; temp++) {
<a name="l02724"></a>02724                <span class="keywordflow">if</span> (*temp == 127) {
<a name="l02725"></a>02725                   memmove(temp, temp + 1, strlen(temp));
<a name="l02726"></a>02726                   temp--;
<a name="l02727"></a>02727                }
<a name="l02728"></a>02728             }
<a name="l02729"></a>02729             res = write(ast_consock, ebuf, strlen(ebuf) + 1);
<a name="l02730"></a>02730             <span class="keywordflow">if</span> (res &lt; 1) {
<a name="l02731"></a>02731                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to write: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02732"></a>02732                <span class="keywordflow">break</span>;
<a name="l02733"></a>02733             }
<a name="l02734"></a>02734          }
<a name="l02735"></a>02735       }
<a name="l02736"></a>02736    }
<a name="l02737"></a>02737    printf(<span class="stringliteral">&quot;\nDisconnected from Asterisk server\n&quot;</span>);
<a name="l02738"></a>02738 }
<a name="l02739"></a>02739 
<a name="l02740"></a><a class="code" href="asterisk_8c.html#a2ea358bef646393c728f1c81bd649bae">02740</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#a2ea358bef646393c728f1c81bd649bae">show_version</a>(<span class="keywordtype">void</span>)
<a name="l02741"></a>02741 {
<a name="l02742"></a>02742    printf(<span class="stringliteral">&quot;Asterisk %s\n&quot;</span>, <a class="code" href="ast__version_8h.html#a7765c608aea948584928643ab3963b2a" title="Retrieve the Asterisk version string.">ast_get_version</a>());
<a name="l02743"></a>02743    <span class="keywordflow">return</span> 0;
<a name="l02744"></a>02744 }
<a name="l02745"></a>02745 
<a name="l02746"></a><a class="code" href="asterisk_8c.html#ac4583a51482ac439c1aef7615f7379cd">02746</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="asterisk_8c.html#ac4583a51482ac439c1aef7615f7379cd">show_cli_help</a>(<span class="keywordtype">void</span>) {
<a name="l02747"></a>02747    printf(<span class="stringliteral">&quot;Asterisk %s, Copyright (C) 1999 - 2010, Digium, Inc. and others.\n&quot;</span>, <a class="code" href="ast__version_8h.html#a7765c608aea948584928643ab3963b2a" title="Retrieve the Asterisk version string.">ast_get_version</a>());
<a name="l02748"></a>02748    printf(<span class="stringliteral">&quot;Usage: asterisk [OPTIONS]\n&quot;</span>);
<a name="l02749"></a>02749    printf(<span class="stringliteral">&quot;Valid Options:\n&quot;</span>);
<a name="l02750"></a>02750    printf(<span class="stringliteral">&quot;   -V              Display version number and exit\n&quot;</span>);
<a name="l02751"></a>02751    printf(<span class="stringliteral">&quot;   -C &lt;configfile&gt; Use an alternate configuration file\n&quot;</span>);
<a name="l02752"></a>02752    printf(<span class="stringliteral">&quot;   -G &lt;group&gt;      Run as a group other than the caller\n&quot;</span>);
<a name="l02753"></a>02753    printf(<span class="stringliteral">&quot;   -U &lt;user&gt;       Run as a user other than the caller\n&quot;</span>);
<a name="l02754"></a>02754    printf(<span class="stringliteral">&quot;   -c              Provide console CLI\n&quot;</span>);
<a name="l02755"></a>02755    printf(<span class="stringliteral">&quot;   -d              Enable extra debugging\n&quot;</span>);
<a name="l02756"></a>02756 <span class="preprocessor">#if HAVE_WORKING_FORK</span>
<a name="l02757"></a>02757 <span class="preprocessor"></span>   printf(<span class="stringliteral">&quot;   -f              Do not fork\n&quot;</span>);
<a name="l02758"></a>02758    printf(<span class="stringliteral">&quot;   -F              Always fork\n&quot;</span>);
<a name="l02759"></a>02759 <span class="preprocessor">#endif</span>
<a name="l02760"></a>02760 <span class="preprocessor"></span>   printf(<span class="stringliteral">&quot;   -g              Dump core in case of a crash\n&quot;</span>);
<a name="l02761"></a>02761    printf(<span class="stringliteral">&quot;   -h              This help screen\n&quot;</span>);
<a name="l02762"></a>02762    printf(<span class="stringliteral">&quot;   -i              Initialize crypto keys at startup\n&quot;</span>);
<a name="l02763"></a>02763    printf(<span class="stringliteral">&quot;   -I              Enable internal timing if DAHDI timer is available\n&quot;</span>);
<a name="l02764"></a>02764    printf(<span class="stringliteral">&quot;   -L &lt;load&gt;       Limit the maximum load average before rejecting new calls\n&quot;</span>);
<a name="l02765"></a>02765    printf(<span class="stringliteral">&quot;   -M &lt;value&gt;      Limit the maximum number of calls to the specified value\n&quot;</span>);
<a name="l02766"></a>02766    printf(<span class="stringliteral">&quot;   -m              Mute debugging and console output on the console\n&quot;</span>);
<a name="l02767"></a>02767    printf(<span class="stringliteral">&quot;   -n              Disable console colorization\n&quot;</span>);
<a name="l02768"></a>02768    printf(<span class="stringliteral">&quot;   -p              Run as pseudo-realtime thread\n&quot;</span>);
<a name="l02769"></a>02769    printf(<span class="stringliteral">&quot;   -q              Quiet mode (suppress output)\n&quot;</span>);
<a name="l02770"></a>02770    printf(<span class="stringliteral">&quot;   -r              Connect to Asterisk on this machine\n&quot;</span>);
<a name="l02771"></a>02771    printf(<span class="stringliteral">&quot;   -R              Same as -r, except attempt to reconnect if disconnected\n&quot;</span>);
<a name="l02772"></a>02772    printf(<span class="stringliteral">&quot;   -s &lt;socket&gt;     Connect to Asterisk via socket &lt;socket&gt; (only valid with -r)\n&quot;</span>);
<a name="l02773"></a>02773    printf(<span class="stringliteral">&quot;   -t              Record soundfiles in /var/tmp and move them where they\n&quot;</span>);
<a name="l02774"></a>02774    printf(<span class="stringliteral">&quot;                   belong after they are done\n&quot;</span>);
<a name="l02775"></a>02775    printf(<span class="stringliteral">&quot;   -T              Display the time in [Mmm dd hh:mm:ss] format for each line\n&quot;</span>);
<a name="l02776"></a>02776    printf(<span class="stringliteral">&quot;                   of output to the CLI\n&quot;</span>);
<a name="l02777"></a>02777    printf(<span class="stringliteral">&quot;   -v              Increase verbosity (multiple v&apos;s = more verbose)\n&quot;</span>);
<a name="l02778"></a>02778    printf(<span class="stringliteral">&quot;   -x &lt;cmd&gt;        Execute command &lt;cmd&gt; (only valid with -r)\n&quot;</span>);
<a name="l02779"></a>02779    printf(<span class="stringliteral">&quot;   -W              Adjust terminal colors to compensate for a light background\n&quot;</span>);
<a name="l02780"></a>02780    printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02781"></a>02781    <span class="keywordflow">return</span> 0;
<a name="l02782"></a>02782 }
<a name="l02783"></a>02783 
<a name="l02784"></a><a class="code" href="asterisk_8c.html#a802a890a7b649a202d95d274ae2b354e">02784</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a802a890a7b649a202d95d274ae2b354e">ast_readconfig</a>(<span class="keywordtype">void</span>) 
<a name="l02785"></a>02785 {
<a name="l02786"></a>02786    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l02787"></a>02787    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l02788"></a>02788    <span class="keywordtype">char</span> *<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a> = <a class="code" href="defaults_8h.html#a33cca38c576ada1ba69225b47cd975a4">DEFAULT_CONFIG_FILE</a>;
<a name="l02789"></a>02789    <span class="keywordtype">char</span> <a class="code" href="logger_8c.html#af31254e3111773fe1dc68e8dc13df2fe">hostname</a>[<a class="code" href="network_8h.html#afd80ecbe3170ca4fc85b65cda8659f82">MAXHOSTNAMELEN</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02790"></a>02790    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { 0 };
<a name="l02791"></a>02791    <span class="keyword">struct </span>{
<a name="l02792"></a>02792       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dbdir:1;
<a name="l02793"></a>02793       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> keydir:1;
<a name="l02794"></a>02794    } found = { 0, 0 };
<a name="l02795"></a>02795 
<a name="l02796"></a>02796    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a8ff64ad3aa39328ab5c2845111b523ca">ast_opt_override_config</a>) {
<a name="l02797"></a>02797       cfg = <a class="code" href="config_8h.html#aab3eac8fa82a86a93c074deb7b77dbc9" title="Load a config file.">ast_config_load2</a>(<a class="code" href="paths_8h.html#adea5f0a0a8720d1dbb47ca434fe78778">ast_config_AST_CONFIG_FILE</a>, <span class="stringliteral">&quot;&quot;</span> <span class="comment">/* core, can&apos;t reload */</span>, config_flags);
<a name="l02798"></a>02798       <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a> || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>)
<a name="l02799"></a>02799          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open specified master config file &apos;%s&apos;, using built-in defaults\n&quot;</span>, <a class="code" href="paths_8h.html#adea5f0a0a8720d1dbb47ca434fe78778">ast_config_AST_CONFIG_FILE</a>);
<a name="l02800"></a>02800    } <span class="keywordflow">else</span> 
<a name="l02801"></a>02801       cfg = <a class="code" href="config_8h.html#aab3eac8fa82a86a93c074deb7b77dbc9" title="Load a config file.">ast_config_load2</a>(config, <span class="stringliteral">&quot;&quot;</span> <span class="comment">/* core, can&apos;t reload */</span>, config_flags);
<a name="l02802"></a>02802 
<a name="l02803"></a>02803    <span class="comment">/* init with buildtime config */</span>
<a name="l02804"></a>02804    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a2a787698d0bf9e2e1feba95c9e9dc0c6">config_dir</a>, <a class="code" href="defaults_8h.html#a3e535652a6a9608e8bda98044454fa89">DEFAULT_CONFIG_DIR</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a2a787698d0bf9e2e1feba95c9e9dc0c6">config_dir</a>));
<a name="l02805"></a>02805    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a60aa45269a40668187b52a047d7909c6">spool_dir</a>, <a class="code" href="defaults_8h.html#ade2b68a89c247eb4c1de3f2d39ae4fd6">DEFAULT_SPOOL_DIR</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a60aa45269a40668187b52a047d7909c6">spool_dir</a>));
<a name="l02806"></a>02806    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ac911358c35b6b1ddd1aed6bcb84c57c5">module_dir</a>, <a class="code" href="defaults_8h.html#a26421c351b5b559f461e753b6ec5d5fa">DEFAULT_MODULE_DIR</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ac911358c35b6b1ddd1aed6bcb84c57c5">module_dir</a>));
<a name="l02807"></a>02807    snprintf(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a1eb90b245cb49d77acf222238afcaf30">monitor_dir</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a1eb90b245cb49d77acf222238afcaf30">monitor_dir</a>), <span class="stringliteral">&quot;%s/monitor&quot;</span>, <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a60aa45269a40668187b52a047d7909c6">spool_dir</a>);
<a name="l02808"></a>02808    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a77fd1ea5a8365503c30f3e498fd91814">var_dir</a>, <a class="code" href="defaults_8h.html#a81cc7fb9a5fbc8397f33ee72a215b1f4">DEFAULT_VAR_DIR</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a77fd1ea5a8365503c30f3e498fd91814">var_dir</a>));
<a name="l02809"></a>02809    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a8075dfd7bd2be8076fd90ad4e8c2dbf8">data_dir</a>, <a class="code" href="defaults_8h.html#a89d9b90dbc1df3ab30a2d08519e40e49">DEFAULT_DATA_DIR</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a8075dfd7bd2be8076fd90ad4e8c2dbf8">data_dir</a>));
<a name="l02810"></a>02810    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a30a5656eac4b61ac4c323709df7960e6">log_dir</a>, <a class="code" href="defaults_8h.html#ae7b4f44e9eb42f206a337c506817d4b8">DEFAULT_LOG_DIR</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a30a5656eac4b61ac4c323709df7960e6">log_dir</a>));
<a name="l02811"></a>02811    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#af6443747a8c6314ab90e086ad748b73d">agi_dir</a>, <a class="code" href="defaults_8h.html#a67401cf4d95969b8e3d4b24038d65822">DEFAULT_AGI_DIR</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#af6443747a8c6314ab90e086ad748b73d">agi_dir</a>));
<a name="l02812"></a>02812    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ab3a4bb3db5559a103e7f42fdef6f647c">db_path</a>, <a class="code" href="defaults_8h.html#a83342431bb4ab41b644d44c69fee5d6c">DEFAULT_DB</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ab3a4bb3db5559a103e7f42fdef6f647c">db_path</a>));
<a name="l02813"></a>02813    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a432958de9de3057461bb77ea19493d8b">key_dir</a>, <a class="code" href="defaults_8h.html#ad43b7075d6f29e904903297c1afe7309">DEFAULT_KEY_DIR</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a432958de9de3057461bb77ea19493d8b">key_dir</a>));
<a name="l02814"></a>02814    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a55bc52b564c65697c3f849ef6eb2125b">pid_path</a>, <a class="code" href="defaults_8h.html#a4e86841ee18f538bac646b914f5e77b8">DEFAULT_PID</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a55bc52b564c65697c3f849ef6eb2125b">pid_path</a>));
<a name="l02815"></a>02815    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a8a08552e4300432b153a40065429b182">socket_path</a>, <a class="code" href="defaults_8h.html#aa34bbe317848752be07ca598f396d4b6">DEFAULT_SOCKET</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a8a08552e4300432b153a40065429b182">socket_path</a>));
<a name="l02816"></a>02816    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a25fedda2ff46425cea16ffcefc7f7876">run_dir</a>, <a class="code" href="defaults_8h.html#ad3bf501459de03b82c99c025a1830829">DEFAULT_RUN_DIR</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a25fedda2ff46425cea16ffcefc7f7876">run_dir</a>));
<a name="l02817"></a>02817 
<a name="l02818"></a>02818    <a class="code" href="utils_8h.html#a4c527f8466f7653b16cb694ba5668092" title="Fill in an ast_eid with the default eid of this machine.">ast_set_default_eid</a>(&amp;<a class="code" href="utils_8h.html#ad5db11fa27352e2b9a3c669adc76955f" title="Global EID.">ast_eid_default</a>);
<a name="l02819"></a>02819 
<a name="l02820"></a>02820    <span class="comment">/* no asterisk.conf? no problem, use buildtime config! */</span>
<a name="l02821"></a>02821    <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a> || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l02822"></a>02822       <span class="keywordflow">return</span>;
<a name="l02823"></a>02823    }
<a name="l02824"></a>02824 
<a name="l02825"></a>02825    <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;files&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l02826"></a>02826       <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astctlpermissions&quot;</span>))
<a name="l02827"></a>02827          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#afe07211d3ad898c81340a2114987bacb">ast_config_AST_CTL_PERMISSIONS</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#afe07211d3ad898c81340a2114987bacb">ast_config_AST_CTL_PERMISSIONS</a>));
<a name="l02828"></a>02828       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astctlowner&quot;</span>))
<a name="l02829"></a>02829          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#addee6463d8305d615d3c2d6095c13ef7">ast_config_AST_CTL_OWNER</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#addee6463d8305d615d3c2d6095c13ef7">ast_config_AST_CTL_OWNER</a>));
<a name="l02830"></a>02830       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astctlgroup&quot;</span>))
<a name="l02831"></a>02831          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a0ac99db7e33597c95e83068770d2085f">ast_config_AST_CTL_GROUP</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a0ac99db7e33597c95e83068770d2085f">ast_config_AST_CTL_GROUP</a>));
<a name="l02832"></a>02832       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astctl&quot;</span>))
<a name="l02833"></a>02833          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a3cdc624a4514308286386d081e38b88c">ast_config_AST_CTL</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a3cdc624a4514308286386d081e38b88c">ast_config_AST_CTL</a>));
<a name="l02834"></a>02834    }
<a name="l02835"></a>02835 
<a name="l02836"></a>02836    <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;directories&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l02837"></a>02837       <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astetcdir&quot;</span>)) {
<a name="l02838"></a>02838          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a2a787698d0bf9e2e1feba95c9e9dc0c6">config_dir</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a2a787698d0bf9e2e1feba95c9e9dc0c6">config_dir</a>));
<a name="l02839"></a>02839       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astspooldir&quot;</span>)) {
<a name="l02840"></a>02840          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a60aa45269a40668187b52a047d7909c6">spool_dir</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a60aa45269a40668187b52a047d7909c6">spool_dir</a>));
<a name="l02841"></a>02841          snprintf(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a1eb90b245cb49d77acf222238afcaf30">monitor_dir</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a1eb90b245cb49d77acf222238afcaf30">monitor_dir</a>), <span class="stringliteral">&quot;%s/monitor&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02842"></a>02842       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astvarlibdir&quot;</span>)) {
<a name="l02843"></a>02843          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a77fd1ea5a8365503c30f3e498fd91814">var_dir</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a77fd1ea5a8365503c30f3e498fd91814">var_dir</a>));
<a name="l02844"></a>02844          <span class="keywordflow">if</span> (!found.dbdir)
<a name="l02845"></a>02845             snprintf(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ab3a4bb3db5559a103e7f42fdef6f647c">db_path</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ab3a4bb3db5559a103e7f42fdef6f647c">db_path</a>), <span class="stringliteral">&quot;%s/astdb&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02846"></a>02846       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astdbdir&quot;</span>)) {
<a name="l02847"></a>02847          snprintf(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ab3a4bb3db5559a103e7f42fdef6f647c">db_path</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ab3a4bb3db5559a103e7f42fdef6f647c">db_path</a>), <span class="stringliteral">&quot;%s/astdb&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02848"></a>02848          found.dbdir = 1;
<a name="l02849"></a>02849       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astdatadir&quot;</span>)) {
<a name="l02850"></a>02850          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a8075dfd7bd2be8076fd90ad4e8c2dbf8">data_dir</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a8075dfd7bd2be8076fd90ad4e8c2dbf8">data_dir</a>));
<a name="l02851"></a>02851          <span class="keywordflow">if</span> (!found.keydir)
<a name="l02852"></a>02852             snprintf(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a432958de9de3057461bb77ea19493d8b">key_dir</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a432958de9de3057461bb77ea19493d8b">key_dir</a>), <span class="stringliteral">&quot;%s/keys&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02853"></a>02853       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astkeydir&quot;</span>)) {
<a name="l02854"></a>02854          snprintf(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a432958de9de3057461bb77ea19493d8b">key_dir</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a432958de9de3057461bb77ea19493d8b">key_dir</a>), <span class="stringliteral">&quot;%s/keys&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02855"></a>02855          found.keydir = 1;
<a name="l02856"></a>02856       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astlogdir&quot;</span>)) {
<a name="l02857"></a>02857          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a30a5656eac4b61ac4c323709df7960e6">log_dir</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a30a5656eac4b61ac4c323709df7960e6">log_dir</a>));
<a name="l02858"></a>02858       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astagidir&quot;</span>)) {
<a name="l02859"></a>02859          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#af6443747a8c6314ab90e086ad748b73d">agi_dir</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#af6443747a8c6314ab90e086ad748b73d">agi_dir</a>));
<a name="l02860"></a>02860       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astrundir&quot;</span>)) {
<a name="l02861"></a>02861          snprintf(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a55bc52b564c65697c3f849ef6eb2125b">pid_path</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a55bc52b564c65697c3f849ef6eb2125b">pid_path</a>), <span class="stringliteral">&quot;%s/%s&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;asterisk.pid&quot;</span>);
<a name="l02862"></a>02862          snprintf(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a8a08552e4300432b153a40065429b182">socket_path</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a8a08552e4300432b153a40065429b182">socket_path</a>), <span class="stringliteral">&quot;%s/%s&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <a class="code" href="asterisk_8c.html#a3cdc624a4514308286386d081e38b88c">ast_config_AST_CTL</a>);
<a name="l02863"></a>02863          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a25fedda2ff46425cea16ffcefc7f7876">run_dir</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a25fedda2ff46425cea16ffcefc7f7876">run_dir</a>));
<a name="l02864"></a>02864       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;astmoddir&quot;</span>)) {
<a name="l02865"></a>02865          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ac911358c35b6b1ddd1aed6bcb84c57c5">module_dir</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ac911358c35b6b1ddd1aed6bcb84c57c5">module_dir</a>));
<a name="l02866"></a>02866       }
<a name="l02867"></a>02867    }
<a name="l02868"></a>02868 
<a name="l02869"></a>02869    <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;options&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l02870"></a>02870       <span class="comment">/* verbose level (-v at startup) */</span>
<a name="l02871"></a>02871       <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;verbose&quot;</span>)) {
<a name="l02872"></a>02872          option_verbose = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02873"></a>02873       <span class="comment">/* whether or not to force timestamping in CLI verbose output. (-T at startup) */</span>
<a name="l02874"></a>02874       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;timestamp&quot;</span>)) {
<a name="l02875"></a>02875          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343ab67222445fbb614adeaeec26811e289e">AST_OPT_FLAG_TIMESTAMP</a>);
<a name="l02876"></a>02876       <span class="comment">/* whether or not to support #exec in config files */</span>
<a name="l02877"></a>02877       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;execincludes&quot;</span>)) {
<a name="l02878"></a>02878          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a1ec197321d89052601ec7e5482009807">AST_OPT_FLAG_EXEC_INCLUDES</a>);
<a name="l02879"></a>02879       <span class="comment">/* debug level (-d at startup) */</span>
<a name="l02880"></a>02880       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;debug&quot;</span>)) {
<a name="l02881"></a>02881          option_debug = 0;
<a name="l02882"></a>02882          <span class="keywordflow">if</span> (sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;option_debug) != 1) {
<a name="l02883"></a>02883             option_debug = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02884"></a>02884          }
<a name="l02885"></a>02885 <span class="preprocessor">#if HAVE_WORKING_FORK</span>
<a name="l02886"></a>02886 <span class="preprocessor"></span>      <span class="comment">/* Disable forking (-f at startup) */</span>
<a name="l02887"></a>02887       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;nofork&quot;</span>)) {
<a name="l02888"></a>02888          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a3ee00a27b39985b8f392ef8bc082173f">AST_OPT_FLAG_NO_FORK</a>);
<a name="l02889"></a>02889       <span class="comment">/* Always fork, even if verbose or debug are enabled (-F at startup) */</span>
<a name="l02890"></a>02890       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;alwaysfork&quot;</span>)) {
<a name="l02891"></a>02891          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a4db94b06d1fd0cf7e3f15fa89337d27b">AST_OPT_FLAG_ALWAYS_FORK</a>);
<a name="l02892"></a>02892 <span class="preprocessor">#endif</span>
<a name="l02893"></a>02893 <span class="preprocessor"></span>      <span class="comment">/* Run quietly (-q at startup ) */</span>
<a name="l02894"></a>02894       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;quiet&quot;</span>)) {
<a name="l02895"></a>02895          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a5a972bf8c28c241823fbe62ff4b215bc">AST_OPT_FLAG_QUIET</a>);
<a name="l02896"></a>02896       <span class="comment">/* Run as console (-c at startup, implies nofork) */</span>
<a name="l02897"></a>02897       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;console&quot;</span>)) {
<a name="l02898"></a>02898          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343aec2be2c2ea39268bc434b19a19fa5f49">AST_OPT_FLAG_CONSOLE</a>);
<a name="l02899"></a>02899       <span class="comment">/* Run with high priority if the O/S permits (-p at startup) */</span>
<a name="l02900"></a>02900       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;highpriority&quot;</span>)) {
<a name="l02901"></a>02901          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a120f92831d8bb5ab6c714cbb8074079b">AST_OPT_FLAG_HIGH_PRIORITY</a>);
<a name="l02902"></a>02902       <span class="comment">/* Initialize RSA auth keys (IAX2) (-i at startup) */</span>
<a name="l02903"></a>02903       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;initcrypto&quot;</span>)) {
<a name="l02904"></a>02904          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343ae6e12c269763841877fc651c0cbc7c52">AST_OPT_FLAG_INIT_KEYS</a>);
<a name="l02905"></a>02905       <span class="comment">/* Disable ANSI colors for console (-c at startup) */</span>
<a name="l02906"></a>02906       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;nocolor&quot;</span>)) {
<a name="l02907"></a>02907          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a303915e0a28761be8b90018495d0a9ec">AST_OPT_FLAG_NO_COLOR</a>);
<a name="l02908"></a>02908       <span class="comment">/* Disable some usage warnings for picky people :p */</span>
<a name="l02909"></a>02909       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;dontwarn&quot;</span>)) {
<a name="l02910"></a>02910          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343af65642ebf10be5f08d30c1b079d6f3d8">AST_OPT_FLAG_DONT_WARN</a>);
<a name="l02911"></a>02911       <span class="comment">/* Dump core in case of crash (-g) */</span>
<a name="l02912"></a>02912       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;dumpcore&quot;</span>)) {
<a name="l02913"></a>02913          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343afdbd86f6d03de205a8b2f7a8afc1d919">AST_OPT_FLAG_DUMP_CORE</a>);
<a name="l02914"></a>02914       <span class="comment">/* Cache recorded sound files to another directory during recording */</span>
<a name="l02915"></a>02915       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;cache_record_files&quot;</span>)) {
<a name="l02916"></a>02916          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343ad5a13ab624cf8420f6aa5aaa74b5e097">AST_OPT_FLAG_CACHE_RECORD_FILES</a>);
<a name="l02917"></a>02917       <span class="comment">/* Specify cache directory */</span>
<a name="l02918"></a>02918       }  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;record_cache_dir&quot;</span>)) {
<a name="l02919"></a>02919          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(record_cache_dir, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <a class="code" href="options_8h.html#a6224ae0daaedaf31c4a8988664b480c4">AST_CACHE_DIR_LEN</a>);
<a name="l02920"></a>02920       <span class="comment">/* Build transcode paths via SLINEAR, instead of directly */</span>
<a name="l02921"></a>02921       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;transcode_via_sln&quot;</span>)) {
<a name="l02922"></a>02922          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a1c360c0f064303244790f6857bd2d847">AST_OPT_FLAG_TRANSCODE_VIA_SLIN</a>);
<a name="l02923"></a>02923       <span class="comment">/* Transmit SLINEAR silence while a channel is being recorded or DTMF is being generated on a channel */</span>
<a name="l02924"></a>02924       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;transmit_silence_during_record&quot;</span>) || !strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;transmit_silence&quot;</span>)) {
<a name="l02925"></a>02925          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a48c2766ad365c08930d7966fbcde4dd6">AST_OPT_FLAG_TRANSMIT_SILENCE</a>);
<a name="l02926"></a>02926       <span class="comment">/* Enable internal timing */</span>
<a name="l02927"></a>02927       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;internal_timing&quot;</span>)) {
<a name="l02928"></a>02928          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343ae3d9576031f4d21d00c6f1a62b55c745">AST_OPT_FLAG_INTERNAL_TIMING</a>);
<a name="l02929"></a>02929       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxcalls&quot;</span>)) {
<a name="l02930"></a>02930          <span class="keywordflow">if</span> ((sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;option_maxcalls) != 1) || (option_maxcalls &lt; 0)) {
<a name="l02931"></a>02931             option_maxcalls = 0;
<a name="l02932"></a>02932          }
<a name="l02933"></a>02933       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxload&quot;</span>)) {
<a name="l02934"></a>02934          <span class="keywordtype">double</span> test[1];
<a name="l02935"></a>02935 
<a name="l02936"></a>02936          <span class="keywordflow">if</span> (<a class="code" href="agi_2strcompat_8c.html#a40e0da58ab6964e3264b90f79ad6d476" title="Return something that won&amp;#39;t cancel the call, but still return -1, in case we...">getloadavg</a>(test, 1) == -1) {
<a name="l02937"></a>02937             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Cannot obtain load average on this system. &apos;maxload&apos; option disabled.\n&quot;</span>);
<a name="l02938"></a>02938             option_maxload = 0.0;
<a name="l02939"></a>02939          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30lf&quot;</span>, &amp;option_maxload) != 1) || (option_maxload &lt; 0.0)) {
<a name="l02940"></a>02940             option_maxload = 0.0;
<a name="l02941"></a>02941          }
<a name="l02942"></a>02942       <span class="comment">/* Set the maximum amount of open files */</span>
<a name="l02943"></a>02943       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxfiles&quot;</span>)) {
<a name="l02944"></a>02944          option_maxfiles = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02945"></a>02945          <a class="code" href="asterisk_8c.html#aebad2831849819f834b0f043cea21ad4" title="Set maximum open files.">set_ulimit</a>(option_maxfiles);
<a name="l02946"></a>02946       <span class="comment">/* What user to run as */</span>
<a name="l02947"></a>02947       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;runuser&quot;</span>)) {
<a name="l02948"></a>02948          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ac302695683ee10f02d68e6204508da7b">run_user</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#ac302695683ee10f02d68e6204508da7b">run_user</a>));
<a name="l02949"></a>02949       <span class="comment">/* What group to run as */</span>
<a name="l02950"></a>02950       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;rungroup&quot;</span>)) {
<a name="l02951"></a>02951          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a7fb2d389b8007b951e07454d6a09000a">run_group</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a7fb2d389b8007b951e07454d6a09000a">run_group</a>));
<a name="l02952"></a>02952       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;systemname&quot;</span>)) {
<a name="l02953"></a>02953          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a005a08d03a4ab3e2a04fe80157ecf510">system_name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a005a08d03a4ab3e2a04fe80157ecf510">system_name</a>));
<a name="l02954"></a>02954       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autosystemname&quot;</span>)) {
<a name="l02955"></a>02955          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l02956"></a>02956             <span class="keywordflow">if</span> (!gethostname(hostname, <span class="keyword">sizeof</span>(hostname) - 1))
<a name="l02957"></a>02957                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a005a08d03a4ab3e2a04fe80157ecf510">system_name</a>, hostname, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a005a08d03a4ab3e2a04fe80157ecf510">system_name</a>));
<a name="l02958"></a>02958             <span class="keywordflow">else</span> {
<a name="l02959"></a>02959                <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="paths_8h.html#ab9f9346c7a41bdf3720f7b1ed02ec703">ast_config_AST_SYSTEM_NAME</a>)){
<a name="l02960"></a>02960                   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a005a08d03a4ab3e2a04fe80157ecf510">system_name</a>, <span class="stringliteral">&quot;localhost&quot;</span>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a005a08d03a4ab3e2a04fe80157ecf510">system_name</a>));
<a name="l02961"></a>02961                }
<a name="l02962"></a>02962                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Cannot obtain hostname for this system.  Using &apos;%s&apos; instead.\n&quot;</span>, <a class="code" href="paths_8h.html#ab9f9346c7a41bdf3720f7b1ed02ec703">ast_config_AST_SYSTEM_NAME</a>);
<a name="l02963"></a>02963             }
<a name="l02964"></a>02964          }
<a name="l02965"></a>02965       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;languageprefix&quot;</span>)) {
<a name="l02966"></a>02966          <a class="code" href="options_8h.html#a248e5c086666b04d29a9cd876ad370b3">ast_language_is_prefix</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02967"></a>02967       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;lockmode&quot;</span>)) {
<a name="l02968"></a>02968          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;lockfile&quot;</span>)) {
<a name="l02969"></a>02969             <a class="code" href="app_8h.html#aaef9c9ee6c9e05a6675201486ea2f02e" title="Set the type of locks used by ast_lock_path().">ast_set_lock_type</a>(<a class="code" href="app_8h.html#a889fad4c6cc627add80454ae61b53241a599f18fdf355d7530bb754b8c66d6de7">AST_LOCK_TYPE_LOCKFILE</a>);
<a name="l02970"></a>02970          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;flock&quot;</span>)) {
<a name="l02971"></a>02971             <a class="code" href="app_8h.html#aaef9c9ee6c9e05a6675201486ea2f02e" title="Set the type of locks used by ast_lock_path().">ast_set_lock_type</a>(<a class="code" href="app_8h.html#a889fad4c6cc627add80454ae61b53241a78cd7e44280d287fc0168a0c31b75e3f">AST_LOCK_TYPE_FLOCK</a>);
<a name="l02972"></a>02972          } <span class="keywordflow">else</span> {
<a name="l02973"></a>02973             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;&apos;%s&apos; is not a valid setting for the lockmode option, &quot;</span>
<a name="l02974"></a>02974                <span class="stringliteral">&quot;defaulting to &apos;lockfile&apos;\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02975"></a>02975             <a class="code" href="app_8h.html#aaef9c9ee6c9e05a6675201486ea2f02e" title="Set the type of locks used by ast_lock_path().">ast_set_lock_type</a>(<a class="code" href="app_8h.html#a889fad4c6cc627add80454ae61b53241a599f18fdf355d7530bb754b8c66d6de7">AST_LOCK_TYPE_LOCKFILE</a>);
<a name="l02976"></a>02976          }
<a name="l02977"></a>02977 <span class="preprocessor">#if defined(HAVE_SYSINFO)</span>
<a name="l02978"></a>02978 <span class="preprocessor"></span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;minmemfree&quot;</span>)) {
<a name="l02979"></a>02979          <span class="comment">/* specify the minimum amount of free memory to retain.  Asterisk should stop accepting new calls</span>
<a name="l02980"></a>02980 <span class="comment">          * if the amount of free memory falls below this watermark */</span>
<a name="l02981"></a>02981          <span class="keywordflow">if</span> ((sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30ld&quot;</span>, &amp;option_minmemfree) != 1) || (option_minmemfree &lt; 0)) {
<a name="l02982"></a>02982             option_minmemfree = 0;
<a name="l02983"></a>02983          }
<a name="l02984"></a>02984 <span class="preprocessor">#endif</span>
<a name="l02985"></a>02985 <span class="preprocessor"></span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;entityid&quot;</span>)) {
<a name="l02986"></a>02986          <span class="keyword">struct </span><a class="code" href="structast__eid.html" title="An Entity ID is essentially a MAC address, brief and unique.">ast_eid</a> tmp_eid;
<a name="l02987"></a>02987          <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#ad60a8c795e1f64b7beeed705425c555f" title="Convert a string into an EID.">ast_str_to_eid</a>(&amp;tmp_eid, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l02988"></a>02988             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Successfully set global EID to &apos;%s&apos;\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02989"></a>02989             <a class="code" href="utils_8h.html#ad5db11fa27352e2b9a3c669adc76955f" title="Global EID.">ast_eid_default</a> = tmp_eid;
<a name="l02990"></a>02990          } <span class="keywordflow">else</span>
<a name="l02991"></a>02991             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Invalid Entity ID &apos;%s&apos; provided\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02992"></a>02992       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;lightbackground&quot;</span>)) {
<a name="l02993"></a>02993          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343af6be95474d0021d99a2402b2e6f1e23e">AST_OPT_FLAG_LIGHT_BACKGROUND</a>);
<a name="l02994"></a>02994       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;forceblackbackground&quot;</span>)) {
<a name="l02995"></a>02995          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343af68369edcd9b93645cfca1be521276a5">AST_OPT_FLAG_FORCE_BLACK_BACKGROUND</a>);
<a name="l02996"></a>02996       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;hideconnect&quot;</span>)) {
<a name="l02997"></a>02997          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_options, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a1e1f4179b430df944713e08314490e5f">AST_OPT_FLAG_HIDE_CONSOLE_CONNECT</a>);
<a name="l02998"></a>02998       }
<a name="l02999"></a>02999    }
<a name="l03000"></a>03000    <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;compat&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l03001"></a>03001       <span class="keywordtype">float</span> <a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>;
<a name="l03002"></a>03002       <span class="keywordflow">if</span> (sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30f&quot;</span>, &amp;version) != 1) {
<a name="l03003"></a>03003          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Compatibility version for option &apos;%s&apos; is not a number: &apos;%s&apos;\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03004"></a>03004          <span class="keywordflow">continue</span>;
<a name="l03005"></a>03005       }
<a name="l03006"></a>03006       <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;app_set&quot;</span>)) {
<a name="l03007"></a>03007          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_compat, version &lt; 1.5 ? 1 : 0, <a class="code" href="options_8h.html#a53afe776fcb252fe24f1127d1f6a4e97a92ebf6964274633b6e47ac9e76124917">AST_COMPAT_APP_SET</a>);
<a name="l03008"></a>03008       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;res_agi&quot;</span>)) {
<a name="l03009"></a>03009          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_compat, version &lt; 1.5 ? 1 : 0, <a class="code" href="options_8h.html#a53afe776fcb252fe24f1127d1f6a4e97aa2b551ee76f72c6a7525d83d3526b96d">AST_COMPAT_DELIM_RES_AGI</a>);
<a name="l03010"></a>03010       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;pbx_realtime&quot;</span>)) {
<a name="l03011"></a>03011          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;ast_compat, version &lt; 1.5 ? 1 : 0, <a class="code" href="options_8h.html#a53afe776fcb252fe24f1127d1f6a4e97aa1bf0cc44266b4bc64149adcc3eb372e">AST_COMPAT_DELIM_PBX_REALTIME</a>);
<a name="l03012"></a>03012       }
<a name="l03013"></a>03013    }
<a name="l03014"></a>03014    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l03015"></a>03015 }
<a name="l03016"></a>03016 
<a name="l03017"></a><a class="code" href="asterisk_8c.html#a643319c1ef479a7d90ed02ec9c8b1a68">03017</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="asterisk_8c.html#a643319c1ef479a7d90ed02ec9c8b1a68">monitor_sig_flags</a>(<span class="keywordtype">void</span> *unused)
<a name="l03018"></a>03018 {
<a name="l03019"></a>03019    <span class="keywordflow">for</span> (;;) {
<a name="l03020"></a>03020       <span class="keyword">struct </span>pollfd p = { <a class="code" href="asterisk_8c.html#a7bb419fdb0040da24ecbb651b12395fc">sig_alert_pipe</a>[0], POLLIN, 0 };
<a name="l03021"></a>03021       <span class="keywordtype">int</span> a;
<a name="l03022"></a>03022       <a class="code" href="poll-compat_8h.html#a5a0c58fa8311e94cd0ed34382aa822f9">ast_poll</a>(&amp;p, 1, -1);
<a name="l03023"></a>03023       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>.need_reload) {
<a name="l03024"></a>03024          <a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>.need_reload = 0;
<a name="l03025"></a>03025          <a class="code" href="__private_8h.html#a0d0ff279ff3f2dbbbfb1b49ee6f57add" title="Reload asterisk modules.">ast_module_reload</a>(NULL);
<a name="l03026"></a>03026       }
<a name="l03027"></a>03027       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>.need_quit) {
<a name="l03028"></a>03028          <a class="code" href="asterisk_8c.html#a97c7ecdb88a9a7e57735aaadaf0bdbb3">sig_flags</a>.need_quit = 0;
<a name="l03029"></a>03029          <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 0, 1, 0);
<a name="l03030"></a>03030       }
<a name="l03031"></a>03031       <span class="keywordflow">if</span> (read(<a class="code" href="asterisk_8c.html#a7bb419fdb0040da24ecbb651b12395fc">sig_alert_pipe</a>[0], &amp;a, <span class="keyword">sizeof</span>(a)) != <span class="keyword">sizeof</span>(a)) {
<a name="l03032"></a>03032       }
<a name="l03033"></a>03033    }
<a name="l03034"></a>03034 
<a name="l03035"></a>03035    <span class="keywordflow">return</span> NULL;
<a name="l03036"></a>03036 }
<a name="l03037"></a>03037 
<a name="l03038"></a><a class="code" href="asterisk_8c.html#a1dab70ac26334f4acece46d997255563">03038</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="asterisk_8c.html#a1dab70ac26334f4acece46d997255563">canary_thread</a>(<span class="keywordtype">void</span> *unused)
<a name="l03039"></a>03039 {
<a name="l03040"></a>03040    <span class="keyword">struct </span>stat canary_stat;
<a name="l03041"></a>03041    <span class="keyword">struct </span>timeval now;
<a name="l03042"></a>03042 
<a name="l03043"></a>03043    <span class="comment">/* Give the canary time to sing */</span>
<a name="l03044"></a>03044    sleep(120);
<a name="l03045"></a>03045 
<a name="l03046"></a>03046    <span class="keywordflow">for</span> (;;) {
<a name="l03047"></a>03047       stat(<a class="code" href="asterisk_8c.html#a459b692028914da1bf3641b5de9ba6ea">canary_filename</a>, &amp;canary_stat);
<a name="l03048"></a>03048       now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l03049"></a>03049       <span class="keywordflow">if</span> (now.tv_sec &gt; canary_stat.st_mtime + 60) {
<a name="l03050"></a>03050          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;The canary is no more.  He has ceased to be!  He&apos;s expired and gone to meet his maker!  He&apos;s a stiff!  Bereft of life, he rests in peace.  His metabolic processes are now history!  He&apos;s off the twig!  He&apos;s kicked the bucket.  He&apos;s shuffled off his mortal coil, run down the curtain, and joined the bleeding choir invisible!!  THIS is an EX-CANARY.  (Reducing priority)\n&quot;</span>);
<a name="l03051"></a>03051          <a class="code" href="asterisk_8h.html#ad649acedd512a45c748a440e78a281c9" title="We set ourselves to a high priority, that we might pre-empt everything else. If your...">ast_set_priority</a>(0);
<a name="l03052"></a>03052          pthread_exit(NULL);
<a name="l03053"></a>03053       }
<a name="l03054"></a>03054 
<a name="l03055"></a>03055       <span class="comment">/* Check the canary once a minute */</span>
<a name="l03056"></a>03056       sleep(60);
<a name="l03057"></a>03057    }
<a name="l03058"></a>03058 }
<a name="l03059"></a>03059 
<a name="l03060"></a>03060 <span class="comment">/* Used by libc&apos;s atexit(3) function */</span>
<a name="l03061"></a><a class="code" href="asterisk_8c.html#a0fb077af6d08a4c0be395841196b12fd">03061</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#a0fb077af6d08a4c0be395841196b12fd">canary_exit</a>(<span class="keywordtype">void</span>)
<a name="l03062"></a>03062 {
<a name="l03063"></a>03063    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#ab2acd3f561950f0ab6546314677ad57d">canary_pid</a> &gt; 0)
<a name="l03064"></a>03064       kill(<a class="code" href="asterisk_8c.html#ab2acd3f561950f0ab6546314677ad57d">canary_pid</a>, SIGKILL);
<a name="l03065"></a>03065 }
<a name="l03066"></a>03066 
<a name="l03067"></a><a class="code" href="asterisk_8c.html#ac3e31dd03ea540885ef4359f5f4443a9">03067</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="asterisk_8c.html#ac3e31dd03ea540885ef4359f5f4443a9">run_startup_commands</a>(<span class="keywordtype">void</span>)
<a name="l03068"></a>03068 {
<a name="l03069"></a>03069    <span class="keywordtype">int</span> fd;
<a name="l03070"></a>03070    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l03071"></a>03071    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> cfg_flags = { 0 };
<a name="l03072"></a>03072    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l03073"></a>03073 
<a name="l03074"></a>03074    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8h.html#aab3eac8fa82a86a93c074deb7b77dbc9" title="Load a config file.">ast_config_load2</a>(<span class="stringliteral">&quot;cli.conf&quot;</span>, <span class="stringliteral">&quot;&quot;</span> <span class="comment">/* core, can&apos;t reload */</span>, cfg_flags)))
<a name="l03075"></a>03075       <span class="keywordflow">return</span>;
<a name="l03076"></a>03076    <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a> || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l03077"></a>03077       <span class="keywordflow">return</span>;
<a name="l03078"></a>03078    }
<a name="l03079"></a>03079 
<a name="l03080"></a>03080    fd = open(<span class="stringliteral">&quot;/dev/null&quot;</span>, O_RDWR);
<a name="l03081"></a>03081    <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l03082"></a>03082       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l03083"></a>03083       <span class="keywordflow">return</span>;
<a name="l03084"></a>03084    }
<a name="l03085"></a>03085 
<a name="l03086"></a>03086    <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;startup_commands&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l03087"></a>03087       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))
<a name="l03088"></a>03088          <a class="code" href="cli_8h.html#a9c772ebcb8e1a0d2cecbf551f089f58f">ast_cli_command</a>(fd, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03089"></a>03089    }
<a name="l03090"></a>03090 
<a name="l03091"></a>03091    close(fd);
<a name="l03092"></a>03092    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l03093"></a>03093 }
<a name="l03094"></a>03094 
<a name="l03095"></a><a class="code" href="asterisk_8c.html#a0ddf1224851353fc92bfbff6f499fa97">03095</a> <span class="keywordtype">int</span> <a class="code" href="eagi-sphinx-test_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l03096"></a>03096 {
<a name="l03097"></a>03097    <span class="keywordtype">int</span> c;
<a name="l03098"></a>03098    <span class="keywordtype">char</span> filename[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03099"></a>03099    <span class="keywordtype">char</span> <a class="code" href="logger_8c.html#af31254e3111773fe1dc68e8dc13df2fe">hostname</a>[<a class="code" href="network_8h.html#afd80ecbe3170ca4fc85b65cda8659f82">MAXHOSTNAMELEN</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03100"></a>03100    <span class="keywordtype">char</span> tmp[80];
<a name="l03101"></a>03101    <span class="keywordtype">char</span> * xarg = NULL;
<a name="l03102"></a>03102    <span class="keywordtype">int</span> x;
<a name="l03103"></a>03103    FILE *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l03104"></a>03104    sigset_t sigs;
<a name="l03105"></a>03105    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>;
<a name="l03106"></a>03106    <span class="keywordtype">int</span> isroot = 1;
<a name="l03107"></a>03107    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l03108"></a>03108    <span class="keyword">const</span> <span class="keywordtype">char</span> *runuser = NULL, *rungroup = NULL;
<a name="l03109"></a>03109    <span class="keywordtype">char</span> *remotesock = NULL;
<a name="l03110"></a>03110 
<a name="l03111"></a>03111    <span class="comment">/* Remember original args for restart */</span>
<a name="l03112"></a>03112    <span class="keywordflow">if</span> (argc &gt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="asterisk_8c.html#aac76ac35350d1efd9ddfe5b56739c649">_argv</a>) - 1) {
<a name="l03113"></a>03113       fprintf(stderr, <span class="stringliteral">&quot;Truncating argument size to %d\n&quot;</span>, (<span class="keywordtype">int</span>)<a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="asterisk_8c.html#aac76ac35350d1efd9ddfe5b56739c649">_argv</a>) - 1);
<a name="l03114"></a>03114       argc = <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="asterisk_8c.html#aac76ac35350d1efd9ddfe5b56739c649">_argv</a>) - 1;
<a name="l03115"></a>03115    }
<a name="l03116"></a>03116    <span class="keywordflow">for</span> (x = 0; x &lt; argc; x++)
<a name="l03117"></a>03117       <a class="code" href="asterisk_8c.html#aac76ac35350d1efd9ddfe5b56739c649">_argv</a>[x] = argv[x];
<a name="l03118"></a>03118    <a class="code" href="asterisk_8c.html#aac76ac35350d1efd9ddfe5b56739c649">_argv</a>[x] = NULL;
<a name="l03119"></a>03119 
<a name="l03120"></a>03120    <span class="keywordflow">if</span> (geteuid() != 0)
<a name="l03121"></a>03121       isroot = 0;
<a name="l03122"></a>03122 
<a name="l03123"></a>03123    <span class="comment">/* if the progname is rasterisk consider it a remote console */</span>
<a name="l03124"></a>03124    <span class="keywordflow">if</span> (argv[0] &amp;&amp; (strstr(argv[0], <span class="stringliteral">&quot;rasterisk&quot;</span>)) != NULL) {
<a name="l03125"></a>03125       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a3ee00a27b39985b8f392ef8bc082173f">AST_OPT_FLAG_NO_FORK</a> | <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343afa8b350fb1896cad6eef4ef5a0a9d00d">AST_OPT_FLAG_REMOTE</a>);
<a name="l03126"></a>03126    }
<a name="l03127"></a>03127    <span class="keywordflow">if</span> (gethostname(hostname, <span class="keyword">sizeof</span>(hostname)-1))
<a name="l03128"></a>03128       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(hostname, <span class="stringliteral">&quot;&lt;Unknown&gt;&quot;</span>, <span class="keyword">sizeof</span>(hostname));
<a name="l03129"></a>03129    ast_mainpid = getpid();
<a name="l03130"></a>03130    <a class="code" href="ulaw_8h.html#aad7e1afe4212418e036f434c4cca05ae" title="Set up mu-law conversion table.">ast_ulaw_init</a>();
<a name="l03131"></a>03131    <a class="code" href="alaw_8h.html#ae34ffa042dcd0ba03e43a3bca292810f" title="To init the alaw to slinear conversion stuff, this needs to be run.">ast_alaw_init</a>();
<a name="l03132"></a>03132    <a class="code" href="callerid_8h.html#a9c1767ffd4ca30651bcc241c16d1f071" title="CallerID Initialization.">callerid_init</a>();
<a name="l03133"></a>03133    <a class="code" href="__private_8h.html#aa0cfcd5a898ed77170a7f2c09581d91a" title="initialize the _full_cmd string in * each of the builtins.">ast_builtins_init</a>();
<a name="l03134"></a>03134    <a class="code" href="utils_8h.html#a7f67fc7c9501569b338913c796d86c45">ast_utils_init</a>();
<a name="l03135"></a>03135    <a class="code" href="tdd_8h.html#af7a3dc2c6c96a4ef80ba95d2dcaf31d4">tdd_init</a>();
<a name="l03136"></a>03136    <a class="code" href="__private_8h.html#a58f95b0d90cc7fe0d44ec5aae481c819">ast_tps_init</a>();
<a name="l03137"></a>03137    <a class="code" href="asterisk_8h.html#ade4aafcd250b794e0fba6250c8b26a0b">ast_fd_init</a>();
<a name="l03138"></a>03138 
<a name="l03139"></a>03139    <span class="keywordflow">if</span> (getenv(<span class="stringliteral">&quot;HOME&quot;</span>)) 
<a name="l03140"></a>03140       snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s/.asterisk_history&quot;</span>, getenv(<span class="stringliteral">&quot;HOME&quot;</span>));
<a name="l03141"></a>03141    <span class="comment">/* Check for options */</span>
<a name="l03142"></a>03142    <span class="keywordflow">while</span> ((c = getopt(argc, argv, <span class="stringliteral">&quot;mtThfFdvVqprRgciInx:U:G:C:L:M:e:s:WB&quot;</span>)) != -1) {
<a name="l03143"></a>03143       <span class="keywordflow">switch</span> (c) {
<a name="l03144"></a>03144 <span class="preprocessor">#if defined(HAVE_SYSINFO)</span>
<a name="l03145"></a>03145 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <span class="charliteral">&apos;e&apos;</span>:
<a name="l03146"></a>03146          <span class="keywordflow">if</span> ((sscanf(&amp;optarg[1], <span class="stringliteral">&quot;%30ld&quot;</span>, &amp;option_minmemfree) != 1) || (option_minmemfree &lt; 0)) {
<a name="l03147"></a>03147             option_minmemfree = 0;
<a name="l03148"></a>03148          }
<a name="l03149"></a>03149          <span class="keywordflow">break</span>;
<a name="l03150"></a>03150 <span class="preprocessor">#endif</span>
<a name="l03151"></a>03151 <span class="preprocessor"></span><span class="preprocessor">#if HAVE_WORKING_FORK</span>
<a name="l03152"></a>03152 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <span class="charliteral">&apos;F&apos;</span>:
<a name="l03153"></a>03153          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a4db94b06d1fd0cf7e3f15fa89337d27b">AST_OPT_FLAG_ALWAYS_FORK</a>);
<a name="l03154"></a>03154          <span class="keywordflow">break</span>;
<a name="l03155"></a>03155       <span class="keywordflow">case</span> <span class="charliteral">&apos;f&apos;</span>:
<a name="l03156"></a>03156          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a3ee00a27b39985b8f392ef8bc082173f">AST_OPT_FLAG_NO_FORK</a>);
<a name="l03157"></a>03157          <span class="keywordflow">break</span>;
<a name="l03158"></a>03158 <span class="preprocessor">#endif</span>
<a name="l03159"></a>03159 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <span class="charliteral">&apos;d&apos;</span>:
<a name="l03160"></a>03160          option_debug++;
<a name="l03161"></a>03161          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a3ee00a27b39985b8f392ef8bc082173f">AST_OPT_FLAG_NO_FORK</a>);
<a name="l03162"></a>03162          <span class="keywordflow">break</span>;
<a name="l03163"></a>03163       <span class="keywordflow">case</span> <span class="charliteral">&apos;c&apos;</span>:
<a name="l03164"></a>03164          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a3ee00a27b39985b8f392ef8bc082173f">AST_OPT_FLAG_NO_FORK</a> | <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343aec2be2c2ea39268bc434b19a19fa5f49">AST_OPT_FLAG_CONSOLE</a>);
<a name="l03165"></a>03165          <span class="keywordflow">break</span>;
<a name="l03166"></a>03166       <span class="keywordflow">case</span> <span class="charliteral">&apos;n&apos;</span>:
<a name="l03167"></a>03167          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a303915e0a28761be8b90018495d0a9ec">AST_OPT_FLAG_NO_COLOR</a>);
<a name="l03168"></a>03168          <span class="keywordflow">break</span>;
<a name="l03169"></a>03169       <span class="keywordflow">case</span> <span class="charliteral">&apos;r&apos;</span>:
<a name="l03170"></a>03170          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a3ee00a27b39985b8f392ef8bc082173f">AST_OPT_FLAG_NO_FORK</a> | <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343afa8b350fb1896cad6eef4ef5a0a9d00d">AST_OPT_FLAG_REMOTE</a>);
<a name="l03171"></a>03171          <span class="keywordflow">break</span>;
<a name="l03172"></a>03172       <span class="keywordflow">case</span> <span class="charliteral">&apos;R&apos;</span>:
<a name="l03173"></a>03173          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a3ee00a27b39985b8f392ef8bc082173f">AST_OPT_FLAG_NO_FORK</a> | <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343afa8b350fb1896cad6eef4ef5a0a9d00d">AST_OPT_FLAG_REMOTE</a> | <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343afe9b9459a58a5f1a6ae3537a002e00b1">AST_OPT_FLAG_RECONNECT</a>);
<a name="l03174"></a>03174          <span class="keywordflow">break</span>;
<a name="l03175"></a>03175       <span class="keywordflow">case</span> <span class="charliteral">&apos;p&apos;</span>:
<a name="l03176"></a>03176          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a120f92831d8bb5ab6c714cbb8074079b">AST_OPT_FLAG_HIGH_PRIORITY</a>);
<a name="l03177"></a>03177          <span class="keywordflow">break</span>;
<a name="l03178"></a>03178       <span class="keywordflow">case</span> <span class="charliteral">&apos;v&apos;</span>:
<a name="l03179"></a>03179          option_verbose++;
<a name="l03180"></a>03180          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a3ee00a27b39985b8f392ef8bc082173f">AST_OPT_FLAG_NO_FORK</a>);
<a name="l03181"></a>03181          <span class="keywordflow">break</span>;
<a name="l03182"></a>03182       <span class="keywordflow">case</span> <span class="charliteral">&apos;m&apos;</span>:
<a name="l03183"></a>03183          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a8f7161d6a92865af737b7624eb226bf4">AST_OPT_FLAG_MUTE</a>);
<a name="l03184"></a>03184          <span class="keywordflow">break</span>;
<a name="l03185"></a>03185       <span class="keywordflow">case</span> <span class="charliteral">&apos;M&apos;</span>:
<a name="l03186"></a>03186          <span class="keywordflow">if</span> ((sscanf(optarg, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;option_maxcalls) != 1) || (option_maxcalls &lt; 0))
<a name="l03187"></a>03187             option_maxcalls = 0;
<a name="l03188"></a>03188          <span class="keywordflow">break</span>;
<a name="l03189"></a>03189       <span class="keywordflow">case</span> <span class="charliteral">&apos;L&apos;</span>:
<a name="l03190"></a>03190          <span class="keywordflow">if</span> ((sscanf(optarg, <span class="stringliteral">&quot;%30lf&quot;</span>, &amp;option_maxload) != 1) || (option_maxload &lt; 0.0))
<a name="l03191"></a>03191             option_maxload = 0.0;
<a name="l03192"></a>03192          <span class="keywordflow">break</span>;
<a name="l03193"></a>03193       <span class="keywordflow">case</span> <span class="charliteral">&apos;q&apos;</span>:
<a name="l03194"></a>03194          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a5a972bf8c28c241823fbe62ff4b215bc">AST_OPT_FLAG_QUIET</a>);
<a name="l03195"></a>03195          <span class="keywordflow">break</span>;
<a name="l03196"></a>03196       <span class="keywordflow">case</span> <span class="charliteral">&apos;t&apos;</span>:
<a name="l03197"></a>03197          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343ad5a13ab624cf8420f6aa5aaa74b5e097">AST_OPT_FLAG_CACHE_RECORD_FILES</a>);
<a name="l03198"></a>03198          <span class="keywordflow">break</span>;
<a name="l03199"></a>03199       <span class="keywordflow">case</span> <span class="charliteral">&apos;T&apos;</span>:
<a name="l03200"></a>03200          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343ab67222445fbb614adeaeec26811e289e">AST_OPT_FLAG_TIMESTAMP</a>);
<a name="l03201"></a>03201          <span class="keywordflow">break</span>;
<a name="l03202"></a>03202       <span class="keywordflow">case</span> <span class="charliteral">&apos;x&apos;</span>:
<a name="l03203"></a>03203          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343ad2e1d34d01ce072525be7fa9b72ca833">AST_OPT_FLAG_EXEC</a>);
<a name="l03204"></a>03204          xarg = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(optarg);
<a name="l03205"></a>03205          <span class="keywordflow">break</span>;
<a name="l03206"></a>03206       <span class="keywordflow">case</span> <span class="charliteral">&apos;C&apos;</span>:
<a name="l03207"></a>03207          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a6f62cc62aaaf65aab477ee3087f87f02">config_file</a>, optarg, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a6f62cc62aaaf65aab477ee3087f87f02">config_file</a>));
<a name="l03208"></a>03208          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a962085cdeb5d849d1f31716c799a0409">AST_OPT_FLAG_OVERRIDE_CONFIG</a>);
<a name="l03209"></a>03209          <span class="keywordflow">break</span>;
<a name="l03210"></a>03210       <span class="keywordflow">case</span> <span class="charliteral">&apos;I&apos;</span>:
<a name="l03211"></a>03211          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343ae3d9576031f4d21d00c6f1a62b55c745">AST_OPT_FLAG_INTERNAL_TIMING</a>);
<a name="l03212"></a>03212          <span class="keywordflow">break</span>;
<a name="l03213"></a>03213       <span class="keywordflow">case</span> <span class="charliteral">&apos;i&apos;</span>:
<a name="l03214"></a>03214          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343ae6e12c269763841877fc651c0cbc7c52">AST_OPT_FLAG_INIT_KEYS</a>);
<a name="l03215"></a>03215          <span class="keywordflow">break</span>;
<a name="l03216"></a>03216       <span class="keywordflow">case</span> <span class="charliteral">&apos;g&apos;</span>:
<a name="l03217"></a>03217          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343afdbd86f6d03de205a8b2f7a8afc1d919">AST_OPT_FLAG_DUMP_CORE</a>);
<a name="l03218"></a>03218          <span class="keywordflow">break</span>;
<a name="l03219"></a>03219       <span class="keywordflow">case</span> <span class="charliteral">&apos;h&apos;</span>:
<a name="l03220"></a>03220          <a class="code" href="asterisk_8c.html#ac4583a51482ac439c1aef7615f7379cd">show_cli_help</a>();
<a name="l03221"></a>03221          exit(0);
<a name="l03222"></a>03222       <span class="keywordflow">case</span> <span class="charliteral">&apos;V&apos;</span>:
<a name="l03223"></a>03223          <a class="code" href="asterisk_8c.html#a2ea358bef646393c728f1c81bd649bae">show_version</a>();
<a name="l03224"></a>03224          exit(0);
<a name="l03225"></a>03225       <span class="keywordflow">case</span> <span class="charliteral">&apos;U&apos;</span>:
<a name="l03226"></a>03226          runuser = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(optarg);
<a name="l03227"></a>03227          <span class="keywordflow">break</span>;
<a name="l03228"></a>03228       <span class="keywordflow">case</span> <span class="charliteral">&apos;G&apos;</span>:
<a name="l03229"></a>03229          rungroup = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(optarg);
<a name="l03230"></a>03230          <span class="keywordflow">break</span>;
<a name="l03231"></a>03231       <span class="keywordflow">case</span> <span class="charliteral">&apos;s&apos;</span>:
<a name="l03232"></a>03232          remotesock = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(optarg);
<a name="l03233"></a>03233          <span class="keywordflow">break</span>;
<a name="l03234"></a>03234       <span class="keywordflow">case</span> <span class="charliteral">&apos;W&apos;</span>: <span class="comment">/* White background */</span>
<a name="l03235"></a>03235          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343af6be95474d0021d99a2402b2e6f1e23e">AST_OPT_FLAG_LIGHT_BACKGROUND</a>);
<a name="l03236"></a>03236          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343af68369edcd9b93645cfca1be521276a5">AST_OPT_FLAG_FORCE_BLACK_BACKGROUND</a>);
<a name="l03237"></a>03237          <span class="keywordflow">break</span>;
<a name="l03238"></a>03238       <span class="keywordflow">case</span> <span class="charliteral">&apos;B&apos;</span>: <span class="comment">/* Force black background */</span>
<a name="l03239"></a>03239          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343af68369edcd9b93645cfca1be521276a5">AST_OPT_FLAG_FORCE_BLACK_BACKGROUND</a>);
<a name="l03240"></a>03240          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343af6be95474d0021d99a2402b2e6f1e23e">AST_OPT_FLAG_LIGHT_BACKGROUND</a>);
<a name="l03241"></a>03241          <span class="keywordflow">break</span>;
<a name="l03242"></a>03242       <span class="keywordflow">case</span> <span class="charliteral">&apos;?&apos;</span>:
<a name="l03243"></a>03243          exit(1);
<a name="l03244"></a>03244       }
<a name="l03245"></a>03245    }
<a name="l03246"></a>03246 
<a name="l03247"></a>03247    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a> || option_verbose || (<a class="code" href="options_8h.html#a17d4d9ef04ffa9034f6c6b6c1fd2bb0b">ast_opt_remote</a> &amp;&amp; !<a class="code" href="options_8h.html#a301d032d1d86ba46348691f6d135e98a">ast_opt_exec</a>)) {
<a name="l03248"></a>03248       <span class="keywordflow">if</span> (<a class="code" href="logger_8h.html#a88db6a9fa710d601734eb260ad30348f">ast_register_verbose</a>(<a class="code" href="asterisk_8c.html#a2e5de7662c3c8090bb8cdd170b04a07f">console_verboser</a>)) {
<a name="l03249"></a>03249          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to register console verboser?\n&quot;</span>);
<a name="l03250"></a>03250       }
<a name="l03251"></a>03251       <a class="code" href="asterisk_8c.html#a4102c912e07db36235dbf80dc4f9728a" title="Welcome message when starting a CLI interface.">WELCOME_MESSAGE</a>;
<a name="l03252"></a>03252    }
<a name="l03253"></a>03253 
<a name="l03254"></a>03254    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a> &amp;&amp; !option_verbose) 
<a name="l03255"></a>03255       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;[ Booting...\n&quot;</span>);
<a name="l03256"></a>03256 
<a name="l03257"></a>03257    <span class="comment">/* For remote connections, change the name of the remote connection.</span>
<a name="l03258"></a>03258 <span class="comment">    * We do this for the benefit of init scripts (which need to know if/when</span>
<a name="l03259"></a>03259 <span class="comment">    * the main asterisk process has died yet). */</span>
<a name="l03260"></a>03260    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a17d4d9ef04ffa9034f6c6b6c1fd2bb0b">ast_opt_remote</a>) {
<a name="l03261"></a>03261       strcpy(argv[0], <span class="stringliteral">&quot;rasterisk&quot;</span>);
<a name="l03262"></a>03262       <span class="keywordflow">for</span> (x = 1; x &lt; argc; x++) {
<a name="l03263"></a>03263          argv[x] = argv[0] + 10;
<a name="l03264"></a>03264       }
<a name="l03265"></a>03265    }
<a name="l03266"></a>03266 
<a name="l03267"></a>03267    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a> &amp;&amp; !option_verbose) {
<a name="l03268"></a>03268       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;[ Reading Master Configuration ]\n&quot;</span>);
<a name="l03269"></a>03269    }
<a name="l03270"></a>03270 
<a name="l03271"></a>03271    <a class="code" href="asterisk_8c.html#a802a890a7b649a202d95d274ae2b354e">ast_readconfig</a>();
<a name="l03272"></a>03272 
<a name="l03273"></a>03273    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a17d4d9ef04ffa9034f6c6b6c1fd2bb0b">ast_opt_remote</a> &amp;&amp; remotesock != NULL)
<a name="l03274"></a>03274       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>((<span class="keywordtype">char</span> *) <a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a8a08552e4300432b153a40065429b182">socket_path</a>, remotesock, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a04b451eacddd84b45bde2463b4cdad0e">cfg_paths</a>.<a class="code" href="struct__cfg__paths.html#a8a08552e4300432b153a40065429b182">socket_path</a>));
<a name="l03275"></a>03275 
<a name="l03276"></a>03276    <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#a248e5c086666b04d29a9cd876ad370b3">ast_language_is_prefix</a> &amp;&amp; !<a class="code" href="options_8h.html#a17d4d9ef04ffa9034f6c6b6c1fd2bb0b">ast_opt_remote</a>)
<a name="l03277"></a>03277       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;The &apos;languageprefix&apos; option in asterisk.conf is deprecated; in a future release it will be removed, and your sound files will need to be organized in the &apos;new style&apos; language layout.\n&quot;</span>);
<a name="l03278"></a>03278 
<a name="l03279"></a>03279    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a8d91ba28757f5a3b942673cd8dda40ae">ast_opt_always_fork</a> &amp;&amp; (<a class="code" href="options_8h.html#a17d4d9ef04ffa9034f6c6b6c1fd2bb0b">ast_opt_remote</a> || <a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a>)) {
<a name="l03280"></a>03280       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;&apos;alwaysfork&apos; is not compatible with console or remote console mode; ignored\n&quot;</span>);
<a name="l03281"></a>03281       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a4db94b06d1fd0cf7e3f15fa89337d27b">AST_OPT_FLAG_ALWAYS_FORK</a>);
<a name="l03282"></a>03282    }
<a name="l03283"></a>03283 
<a name="l03284"></a>03284    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a0c0575cf738010e8da8b1db869542493">ast_opt_dump_core</a>) {
<a name="l03285"></a>03285       <span class="keyword">struct </span>rlimit l;
<a name="l03286"></a>03286       memset(&amp;l, 0, <span class="keyword">sizeof</span>(l));
<a name="l03287"></a>03287       l.rlim_cur = RLIM_INFINITY;
<a name="l03288"></a>03288       l.rlim_max = RLIM_INFINITY;
<a name="l03289"></a>03289       <span class="keywordflow">if</span> (setrlimit(RLIMIT_CORE, &amp;l)) {
<a name="l03290"></a>03290          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to disable core size resource limit: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03291"></a>03291       }
<a name="l03292"></a>03292    }
<a name="l03293"></a>03293 
<a name="l03294"></a>03294    <span class="keywordflow">if</span> ((!rungroup) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="paths_8h.html#a2434757afbc16110ff1c7483f3d7ba51">ast_config_AST_RUN_GROUP</a>))
<a name="l03295"></a>03295       rungroup = <a class="code" href="paths_8h.html#a2434757afbc16110ff1c7483f3d7ba51">ast_config_AST_RUN_GROUP</a>;
<a name="l03296"></a>03296    <span class="keywordflow">if</span> ((!runuser) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="paths_8h.html#a37ae09a4cc0e3b46e7b2a2052bde4965">ast_config_AST_RUN_USER</a>))
<a name="l03297"></a>03297       runuser = <a class="code" href="paths_8h.html#a37ae09a4cc0e3b46e7b2a2052bde4965">ast_config_AST_RUN_USER</a>;
<a name="l03298"></a>03298 
<a name="l03299"></a>03299    <span class="comment">/* Must install this signal handler up here to ensure that if the canary</span>
<a name="l03300"></a>03300 <span class="comment">    * fails to execute that it doesn&apos;t kill the Asterisk process.</span>
<a name="l03301"></a>03301 <span class="comment">    */</span>
<a name="l03302"></a>03302    signal(SIGCHLD, <a class="code" href="asterisk_8c.html#a6762a45b0c5d8def958675277dc692a4">child_handler</a>);
<a name="l03303"></a>03303 
<a name="l03304"></a>03304    <span class="comment">/* It&apos;s common on some platforms to clear /var/run at boot.  Create the</span>
<a name="l03305"></a>03305 <span class="comment">    * socket file directory before we drop privileges. */</span>
<a name="l03306"></a>03306    <span class="keywordflow">if</span> (mkdir(<a class="code" href="paths_8h.html#a6014e29009d7db30e546a244c2cc95b6">ast_config_AST_RUN_DIR</a>, 0755) &amp;&amp; <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EEXIST) {
<a name="l03307"></a>03307       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create socket file directory.  Remote consoles will not be able to connect! (%s)\n&quot;</span>, strerror(x));
<a name="l03308"></a>03308    }
<a name="l03309"></a>03309 
<a name="l03310"></a>03310 <span class="preprocessor">#ifndef __CYGWIN__</span>
<a name="l03311"></a>03311 <span class="preprocessor"></span>
<a name="l03312"></a>03312    <span class="keywordflow">if</span> (isroot) {
<a name="l03313"></a>03313       <a class="code" href="asterisk_8h.html#ad649acedd512a45c748a440e78a281c9" title="We set ourselves to a high priority, that we might pre-empt everything else. If your...">ast_set_priority</a>(<a class="code" href="options_8h.html#a8445b47cb18dde73b1b233358a25ed68">ast_opt_high_priority</a>);
<a name="l03314"></a>03314    }
<a name="l03315"></a>03315 
<a name="l03316"></a>03316    <span class="keywordflow">if</span> (isroot &amp;&amp; rungroup) {
<a name="l03317"></a>03317       <span class="keyword">struct </span><a class="code" href="structgroup.html">group</a> *gr;
<a name="l03318"></a>03318       gr = getgrnam(rungroup);
<a name="l03319"></a>03319       <span class="keywordflow">if</span> (!gr) {
<a name="l03320"></a>03320          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such group &apos;%s&apos;!\n&quot;</span>, rungroup);
<a name="l03321"></a>03321          exit(1);
<a name="l03322"></a>03322       }
<a name="l03323"></a>03323       <span class="keywordflow">if</span> (chown(<a class="code" href="paths_8h.html#a6014e29009d7db30e546a244c2cc95b6">ast_config_AST_RUN_DIR</a>, -1, gr-&gt;gr_gid)) {
<a name="l03324"></a>03324          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to chgrp run directory to %d (%s)\n&quot;</span>, (<span class="keywordtype">int</span>) gr-&gt;gr_gid, rungroup);
<a name="l03325"></a>03325       }
<a name="l03326"></a>03326       <span class="keywordflow">if</span> (setgid(gr-&gt;gr_gid)) {
<a name="l03327"></a>03327          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to setgid to %d (%s)\n&quot;</span>, (<span class="keywordtype">int</span>)gr-&gt;gr_gid, rungroup);
<a name="l03328"></a>03328          exit(1);
<a name="l03329"></a>03329       }
<a name="l03330"></a>03330       <span class="keywordflow">if</span> (setgroups(0, NULL)) {
<a name="l03331"></a>03331          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to drop unneeded groups\n&quot;</span>);
<a name="l03332"></a>03332          exit(1);
<a name="l03333"></a>03333       }
<a name="l03334"></a>03334       <span class="keywordflow">if</span> (option_verbose)
<a name="l03335"></a>03335          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Running as group &apos;%s&apos;\n&quot;</span>, rungroup);
<a name="l03336"></a>03336    }
<a name="l03337"></a>03337 
<a name="l03338"></a>03338    <span class="keywordflow">if</span> (runuser &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343afa8b350fb1896cad6eef4ef5a0a9d00d">AST_OPT_FLAG_REMOTE</a>)) {
<a name="l03339"></a>03339 <span class="preprocessor">#ifdef HAVE_CAP</span>
<a name="l03340"></a>03340 <span class="preprocessor"></span>      <span class="keywordtype">int</span> has_cap = 1;
<a name="l03341"></a>03341 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_CAP */</span>
<a name="l03342"></a>03342       <span class="keyword">struct </span>passwd *pw;
<a name="l03343"></a>03343       pw = getpwnam(runuser);
<a name="l03344"></a>03344       <span class="keywordflow">if</span> (!pw) {
<a name="l03345"></a>03345          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such user &apos;%s&apos;!\n&quot;</span>, runuser);
<a name="l03346"></a>03346          exit(1);
<a name="l03347"></a>03347       }
<a name="l03348"></a>03348       <span class="keywordflow">if</span> (chown(<a class="code" href="paths_8h.html#a6014e29009d7db30e546a244c2cc95b6">ast_config_AST_RUN_DIR</a>, pw-&gt;pw_uid, -1)) {
<a name="l03349"></a>03349          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to chown run directory to %d (%s)\n&quot;</span>, (<span class="keywordtype">int</span>) pw-&gt;pw_uid, runuser);
<a name="l03350"></a>03350       }
<a name="l03351"></a>03351 <span class="preprocessor">#ifdef HAVE_CAP</span>
<a name="l03352"></a>03352 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (prctl(PR_SET_KEEPCAPS, 1, 0, 0, 0)) {
<a name="l03353"></a>03353          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to keep capabilities.\n&quot;</span>);
<a name="l03354"></a>03354          has_cap = 0;
<a name="l03355"></a>03355       }
<a name="l03356"></a>03356 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_CAP */</span>
<a name="l03357"></a>03357       <span class="keywordflow">if</span> (!isroot &amp;&amp; pw-&gt;pw_uid != geteuid()) {
<a name="l03358"></a>03358          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Asterisk started as nonroot, but runuser &apos;%s&apos; requested.\n&quot;</span>, runuser);
<a name="l03359"></a>03359          exit(1);
<a name="l03360"></a>03360       }
<a name="l03361"></a>03361       <span class="keywordflow">if</span> (!rungroup) {
<a name="l03362"></a>03362          <span class="keywordflow">if</span> (setgid(pw-&gt;pw_gid)) {
<a name="l03363"></a>03363             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to setgid to %d!\n&quot;</span>, (<span class="keywordtype">int</span>)pw-&gt;pw_gid);
<a name="l03364"></a>03364             exit(1);
<a name="l03365"></a>03365          }
<a name="l03366"></a>03366          <span class="keywordflow">if</span> (isroot &amp;&amp; initgroups(pw-&gt;pw_name, pw-&gt;pw_gid)) {
<a name="l03367"></a>03367             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to init groups for &apos;%s&apos;\n&quot;</span>, runuser);
<a name="l03368"></a>03368             exit(1);
<a name="l03369"></a>03369          }
<a name="l03370"></a>03370       }
<a name="l03371"></a>03371       <span class="keywordflow">if</span> (setuid(pw-&gt;pw_uid)) {
<a name="l03372"></a>03372          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to setuid to %d (%s)\n&quot;</span>, (<span class="keywordtype">int</span>)pw-&gt;pw_uid, runuser);
<a name="l03373"></a>03373          exit(1);
<a name="l03374"></a>03374       }
<a name="l03375"></a>03375       <span class="keywordflow">if</span> (option_verbose)
<a name="l03376"></a>03376          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Running as user &apos;%s&apos;\n&quot;</span>, runuser);
<a name="l03377"></a>03377 <span class="preprocessor">#ifdef HAVE_CAP</span>
<a name="l03378"></a>03378 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (has_cap) {
<a name="l03379"></a>03379          cap_t cap;
<a name="l03380"></a>03380 
<a name="l03381"></a>03381          cap = cap_from_text(<span class="stringliteral">&quot;cap_net_admin=eip&quot;</span>);
<a name="l03382"></a>03382 
<a name="l03383"></a>03383          <span class="keywordflow">if</span> (cap_set_proc(cap))
<a name="l03384"></a>03384             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to install capabilities.\n&quot;</span>);
<a name="l03385"></a>03385 
<a name="l03386"></a>03386          <span class="keywordflow">if</span> (cap_free(cap))
<a name="l03387"></a>03387             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to drop capabilities.\n&quot;</span>);
<a name="l03388"></a>03388       }
<a name="l03389"></a>03389 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_CAP */</span>
<a name="l03390"></a>03390    }
<a name="l03391"></a>03391 
<a name="l03392"></a>03392 <span class="preprocessor">#endif </span><span class="comment">/* __CYGWIN__ */</span>
<a name="l03393"></a>03393 
<a name="l03394"></a>03394 <span class="preprocessor">#ifdef linux</span>
<a name="l03395"></a>03395 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (geteuid() &amp;&amp; <a class="code" href="options_8h.html#a0c0575cf738010e8da8b1db869542493">ast_opt_dump_core</a>) {
<a name="l03396"></a>03396       <span class="keywordflow">if</span> (prctl(PR_SET_DUMPABLE, 1, 0, 0, 0) &lt; 0) {
<a name="l03397"></a>03397          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set the process for core dumps after changing to a non-root user. %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03398"></a>03398       }
<a name="l03399"></a>03399    }
<a name="l03400"></a>03400 <span class="preprocessor">#endif</span>
<a name="l03401"></a>03401 <span class="preprocessor"></span>
<a name="l03402"></a>03402    {
<a name="l03403"></a>03403 <span class="preprocessor">#if defined(HAVE_EACCESS) || defined(HAVE_EUIDACCESS)</span>
<a name="l03404"></a>03404 <span class="preprocessor"></span><span class="preprocessor">#if defined(HAVE_EUIDACCESS) &amp;&amp; !defined(HAVE_EACCESS)</span>
<a name="l03405"></a>03405 <span class="preprocessor"></span><span class="preprocessor">#define eaccess euidaccess</span>
<a name="l03406"></a>03406 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l03407"></a>03407 <span class="preprocessor"></span>      <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>[PATH_MAX];
<a name="l03408"></a>03408       <span class="keywordflow">if</span> (!getcwd(dir, <span class="keyword">sizeof</span>(dir)) || eaccess(dir, R_OK | X_OK | F_OK)) {
<a name="l03409"></a>03409          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to access the running directory (%s).  Changing to &apos;/&apos; for compatibility.\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03410"></a>03410          <span class="comment">/* If we cannot access the CWD, then we couldn&apos;t dump core anyway,</span>
<a name="l03411"></a>03411 <span class="comment">          * so chdir(&quot;/&quot;) won&apos;t break anything. */</span>
<a name="l03412"></a>03412          <span class="keywordflow">if</span> (chdir(<span class="stringliteral">&quot;/&quot;</span>)) {
<a name="l03413"></a>03413             <span class="comment">/* chdir(/) should never fail, so this ends up being a no-op */</span>
<a name="l03414"></a>03414             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;chdir(\&quot;/\&quot;) failed?!! %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03415"></a>03415          }
<a name="l03416"></a>03416       } <span class="keywordflow">else</span>
<a name="l03417"></a>03417 <span class="preprocessor">#endif </span><span class="comment">/* defined(HAVE_EACCESS) || defined(HAVE_EUIDACCESS) */</span>
<a name="l03418"></a>03418       <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#a93b280adefdad68d13fb557f495d2ead">ast_opt_no_fork</a> &amp;&amp; !<a class="code" href="options_8h.html#a0c0575cf738010e8da8b1db869542493">ast_opt_dump_core</a>) {
<a name="l03419"></a>03419          <span class="comment">/* Backgrounding, but no cores, so chdir won&apos;t break anything. */</span>
<a name="l03420"></a>03420          <span class="keywordflow">if</span> (chdir(<span class="stringliteral">&quot;/&quot;</span>)) {
<a name="l03421"></a>03421             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to chdir(\&quot;/\&quot;) ?!! %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03422"></a>03422          }
<a name="l03423"></a>03423       }
<a name="l03424"></a>03424    }
<a name="l03425"></a>03425 
<a name="l03426"></a>03426    <a class="code" href="__private_8h.html#a1997b4ca4fdf17e715fddf00f44c9651">ast_term_init</a>();
<a name="l03427"></a>03427    printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#a7c737dda11a1138a30529adcffaf56ff">term_end</a>());
<a name="l03428"></a>03428    fflush(stdout);
<a name="l03429"></a>03429 
<a name="l03430"></a>03430    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a> &amp;&amp; !option_verbose) 
<a name="l03431"></a>03431       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;[ Initializing Custom Configuration Options ]\n&quot;</span>);
<a name="l03432"></a>03432    <span class="comment">/* custom config setup */</span>
<a name="l03433"></a>03433    <a class="code" href="config_8h.html#afd849f1845a148b2ea62cbd92c0112db" title="Exposed initialization method for core process This method is intended for use only...">register_config_cli</a>();
<a name="l03434"></a>03434    <a class="code" href="config_8h.html#a07c61425fd6ef97bb27383e493fdf553" title="Exposed re-initialization method for core process This method is intended for use...">read_config_maps</a>();
<a name="l03435"></a>03435    
<a name="l03436"></a>03436    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a>) {
<a name="l03437"></a>03437       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#a82f2111e80f216832412fd345d1020ac">el_hist</a> == NULL || <a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a> == NULL)
<a name="l03438"></a>03438          <a class="code" href="asterisk_8c.html#a6314c179e2d65f03b48aab48fcfc430f">ast_el_initialize</a>();
<a name="l03439"></a>03439 
<a name="l03440"></a>03440       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(filename))
<a name="l03441"></a>03441          <a class="code" href="asterisk_8c.html#a5cd497fbc32fe40a9c3d941ca56a04a0">ast_el_read_history</a>(filename);
<a name="l03442"></a>03442    }
<a name="l03443"></a>03443 
<a name="l03444"></a>03444    <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#ab48b6f8cdddee48aed2f4fba4a6c18fe">ast_tryconnect</a>()) {
<a name="l03445"></a>03445       <span class="comment">/* One is already running */</span>
<a name="l03446"></a>03446       <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a17d4d9ef04ffa9034f6c6b6c1fd2bb0b">ast_opt_remote</a>) {
<a name="l03447"></a>03447          <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a301d032d1d86ba46348691f6d135e98a">ast_opt_exec</a>) {
<a name="l03448"></a>03448             <a class="code" href="asterisk_8c.html#a8f0bd75717a5fd70f289769dd7698339">ast_remotecontrol</a>(xarg);
<a name="l03449"></a>03449             <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 0, 0, 0);
<a name="l03450"></a>03450             exit(0);
<a name="l03451"></a>03451          }
<a name="l03452"></a>03452          printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03453"></a>03453          <a class="code" href="asterisk_8c.html#a8f0bd75717a5fd70f289769dd7698339">ast_remotecontrol</a>(NULL);
<a name="l03454"></a>03454          <a class="code" href="asterisk_8c.html#a4b1e4fccbe35fcdcea95cf515d1b2a00">quit_handler</a>(0, 0, 0, 0);
<a name="l03455"></a>03455          exit(0);
<a name="l03456"></a>03456       } <span class="keywordflow">else</span> {
<a name="l03457"></a>03457          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Asterisk already running on %s.  Use &apos;asterisk -r&apos; to connect.\n&quot;</span>, <a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>);
<a name="l03458"></a>03458          printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03459"></a>03459          exit(1);
<a name="l03460"></a>03460       }
<a name="l03461"></a>03461    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a17d4d9ef04ffa9034f6c6b6c1fd2bb0b">ast_opt_remote</a> || <a class="code" href="options_8h.html#a301d032d1d86ba46348691f6d135e98a">ast_opt_exec</a>) {
<a name="l03462"></a>03462       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to connect to remote asterisk (does %s exist?)\n&quot;</span>, <a class="code" href="paths_8h.html#a2f174d3a0019aa9eecb92b83a463e9a6">ast_config_AST_SOCKET</a>);
<a name="l03463"></a>03463       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03464"></a>03464       exit(1);
<a name="l03465"></a>03465    }
<a name="l03466"></a>03466    <span class="comment">/* Blindly write pid file since we couldn&apos;t connect */</span>
<a name="l03467"></a>03467    unlink(<a class="code" href="paths_8h.html#a59860442b922398568da0236c1576039">ast_config_AST_PID</a>);
<a name="l03468"></a>03468    f = fopen(<a class="code" href="paths_8h.html#a59860442b922398568da0236c1576039">ast_config_AST_PID</a>, <span class="stringliteral">&quot;w&quot;</span>);
<a name="l03469"></a>03469    <span class="keywordflow">if</span> (f) {
<a name="l03470"></a>03470       fprintf(f, <span class="stringliteral">&quot;%ld\n&quot;</span>, (<span class="keywordtype">long</span>)getpid());
<a name="l03471"></a>03471       fclose(f);
<a name="l03472"></a>03472    } <span class="keywordflow">else</span>
<a name="l03473"></a>03473       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open pid file &apos;%s&apos;: %s\n&quot;</span>, <a class="code" href="paths_8h.html#a59860442b922398568da0236c1576039">ast_config_AST_PID</a>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03474"></a>03474 
<a name="l03475"></a>03475 <span class="preprocessor">#if HAVE_WORKING_FORK</span>
<a name="l03476"></a>03476 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a8d91ba28757f5a3b942673cd8dda40ae">ast_opt_always_fork</a> || !<a class="code" href="options_8h.html#a93b280adefdad68d13fb557f495d2ead">ast_opt_no_fork</a>) {
<a name="l03477"></a>03477 <span class="preprocessor">#ifndef HAVE_SBIN_LAUNCHD</span>
<a name="l03478"></a>03478 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (daemon(1, 0) &lt; 0) {
<a name="l03479"></a>03479          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;daemon() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03480"></a>03480       }
<a name="l03481"></a>03481       ast_mainpid = getpid();
<a name="l03482"></a>03482       <span class="comment">/* Blindly re-write pid file since we are forking */</span>
<a name="l03483"></a>03483       unlink(<a class="code" href="paths_8h.html#a59860442b922398568da0236c1576039">ast_config_AST_PID</a>);
<a name="l03484"></a>03484       f = fopen(<a class="code" href="paths_8h.html#a59860442b922398568da0236c1576039">ast_config_AST_PID</a>, <span class="stringliteral">&quot;w&quot;</span>);
<a name="l03485"></a>03485       <span class="keywordflow">if</span> (f) {
<a name="l03486"></a>03486          fprintf(f, <span class="stringliteral">&quot;%ld\n&quot;</span>, (<span class="keywordtype">long</span>)ast_mainpid);
<a name="l03487"></a>03487          fclose(f);
<a name="l03488"></a>03488       } <span class="keywordflow">else</span>
<a name="l03489"></a>03489          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open pid file &apos;%s&apos;: %s\n&quot;</span>, <a class="code" href="paths_8h.html#a59860442b922398568da0236c1576039">ast_config_AST_PID</a>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03490"></a>03490 <span class="preprocessor">#else</span>
<a name="l03491"></a>03491 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Mac OS X detected.  Use &apos;/sbin/launchd -d&apos; to launch with the nofork option.\n&quot;</span>);
<a name="l03492"></a>03492 <span class="preprocessor">#endif</span>
<a name="l03493"></a>03493 <span class="preprocessor"></span>   }
<a name="l03494"></a>03494 <span class="preprocessor">#endif</span>
<a name="l03495"></a>03495 <span class="preprocessor"></span>
<a name="l03496"></a>03496    <span class="comment">/* Spawning of astcanary must happen AFTER the call to daemon(3) */</span>
<a name="l03497"></a>03497    <span class="keywordflow">if</span> (isroot &amp;&amp; <a class="code" href="options_8h.html#a8445b47cb18dde73b1b233358a25ed68">ast_opt_high_priority</a>) {
<a name="l03498"></a>03498       snprintf(<a class="code" href="asterisk_8c.html#a459b692028914da1bf3641b5de9ba6ea">canary_filename</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a459b692028914da1bf3641b5de9ba6ea">canary_filename</a>), <span class="stringliteral">&quot;%s/alt.asterisk.canary.tweet.tweet.tweet&quot;</span>, <a class="code" href="paths_8h.html#a6014e29009d7db30e546a244c2cc95b6">ast_config_AST_RUN_DIR</a>);
<a name="l03499"></a>03499 
<a name="l03500"></a>03500       <span class="comment">/* Don&apos;t let the canary child kill Asterisk, if it dies immediately */</span>
<a name="l03501"></a>03501       signal(SIGPIPE, SIG_IGN);
<a name="l03502"></a>03502 
<a name="l03503"></a>03503       <a class="code" href="asterisk_8c.html#ab2acd3f561950f0ab6546314677ad57d">canary_pid</a> = fork();
<a name="l03504"></a>03504       <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#ab2acd3f561950f0ab6546314677ad57d">canary_pid</a> == 0) {
<a name="l03505"></a>03505          <span class="keywordtype">char</span> canary_binary[128], *lastslash, ppid[12];
<a name="l03506"></a>03506 
<a name="l03507"></a>03507          <span class="comment">/* Reset signal handler */</span>
<a name="l03508"></a>03508          signal(SIGCHLD, SIG_DFL);
<a name="l03509"></a>03509          signal(SIGPIPE, SIG_DFL);
<a name="l03510"></a>03510 
<a name="l03511"></a>03511          <a class="code" href="app_8h.html#afcbfdd6dfc8c5f0f549b0a5d7e263e97" title="Common routine for child processes, to close all fds prior to exec(2).">ast_close_fds_above_n</a>(0);
<a name="l03512"></a>03512          <a class="code" href="asterisk_8h.html#ad649acedd512a45c748a440e78a281c9" title="We set ourselves to a high priority, that we might pre-empt everything else. If your...">ast_set_priority</a>(0);
<a name="l03513"></a>03513          snprintf(ppid, <span class="keyword">sizeof</span>(ppid), <span class="stringliteral">&quot;%d&quot;</span>, (<span class="keywordtype">int</span>) getpid());
<a name="l03514"></a>03514 
<a name="l03515"></a>03515          execlp(<span class="stringliteral">&quot;astcanary&quot;</span>, <span class="stringliteral">&quot;astcanary&quot;</span>, <a class="code" href="asterisk_8c.html#a459b692028914da1bf3641b5de9ba6ea">canary_filename</a>, ppid, (<span class="keywordtype">char</span> *)NULL);
<a name="l03516"></a>03516 
<a name="l03517"></a>03517          <span class="comment">/* If not found, try the same path as used to execute asterisk */</span>
<a name="l03518"></a>03518          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(canary_binary, argv[0], <span class="keyword">sizeof</span>(canary_binary));
<a name="l03519"></a>03519          <span class="keywordflow">if</span> ((lastslash = strrchr(canary_binary, <span class="charliteral">&apos;/&apos;</span>))) {
<a name="l03520"></a>03520             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(lastslash + 1, <span class="stringliteral">&quot;astcanary&quot;</span>, <span class="keyword">sizeof</span>(canary_binary) + canary_binary - (lastslash + 1));
<a name="l03521"></a>03521             execl(canary_binary, <span class="stringliteral">&quot;astcanary&quot;</span>, <a class="code" href="asterisk_8c.html#a459b692028914da1bf3641b5de9ba6ea">canary_filename</a>, (<span class="keywordtype">char</span> *)NULL);
<a name="l03522"></a>03522          }
<a name="l03523"></a>03523 
<a name="l03524"></a>03524          <span class="comment">/* Should never happen */</span>
<a name="l03525"></a>03525          _exit(1);
<a name="l03526"></a>03526       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#ab2acd3f561950f0ab6546314677ad57d">canary_pid</a> &gt; 0) {
<a name="l03527"></a>03527          pthread_t dont_care;
<a name="l03528"></a>03528          <a class="code" href="utils_8h.html#a832647380b1f97e7ac1b4492f8816d46">ast_pthread_create_detached</a>(&amp;dont_care, NULL, <a class="code" href="asterisk_8c.html#a1dab70ac26334f4acece46d997255563">canary_thread</a>, NULL);
<a name="l03529"></a>03529       }
<a name="l03530"></a>03530 
<a name="l03531"></a>03531       <span class="comment">/* Kill the canary when we exit */</span>
<a name="l03532"></a>03532       <a class="code" href="asterisk_8h.html#a9b09e95876dfecb9a8573819da0b255e" title="Register a function to be executed before Asterisk exits.">ast_register_atexit</a>(<a class="code" href="asterisk_8c.html#a0fb077af6d08a4c0be395841196b12fd">canary_exit</a>);
<a name="l03533"></a>03533    }
<a name="l03534"></a>03534 
<a name="l03535"></a>03535    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#aec784d4f5e2d7d9d6115f85531f17536">ast_event_init</a>()) {
<a name="l03536"></a>03536       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03537"></a>03537       exit(1);
<a name="l03538"></a>03538    }
<a name="l03539"></a>03539 
<a name="l03540"></a>03540    <a class="code" href="asterisk_8c.html#ab08a4af1fa3e6efc9a1242ded75e0437">ast_makesocket</a>();
<a name="l03541"></a>03541    sigemptyset(&amp;sigs);
<a name="l03542"></a>03542    sigaddset(&amp;sigs, SIGHUP);
<a name="l03543"></a>03543    sigaddset(&amp;sigs, SIGTERM);
<a name="l03544"></a>03544    sigaddset(&amp;sigs, SIGINT);
<a name="l03545"></a>03545    sigaddset(&amp;sigs, SIGPIPE);
<a name="l03546"></a>03546    sigaddset(&amp;sigs, SIGWINCH);
<a name="l03547"></a>03547    pthread_sigmask(SIG_BLOCK, &amp;sigs, NULL);
<a name="l03548"></a>03548    signal(SIGURG, <a class="code" href="asterisk_8c.html#ac132d00d9469a926426e872ca059f378" title="Urgent handler.">urg_handler</a>);
<a name="l03549"></a>03549    signal(SIGINT, <a class="code" href="asterisk_8c.html#ae60d292daa4fe3a13b0a0d01c5beb305">__quit_handler</a>);
<a name="l03550"></a>03550    signal(SIGTERM, <a class="code" href="asterisk_8c.html#ae60d292daa4fe3a13b0a0d01c5beb305">__quit_handler</a>);
<a name="l03551"></a>03551    signal(SIGHUP, <a class="code" href="asterisk_8c.html#a003bbe47ca5ed15b7cfd4f2f126022c0">hup_handler</a>);
<a name="l03552"></a>03552    signal(SIGPIPE, SIG_IGN);
<a name="l03553"></a>03553 
<a name="l03554"></a>03554    <span class="comment">/* ensure that the random number generators are seeded with a different value every time</span>
<a name="l03555"></a>03555 <span class="comment">      Asterisk is started</span>
<a name="l03556"></a>03556 <span class="comment">   */</span>
<a name="l03557"></a>03557    srand((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) getpid() + (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) time(NULL));
<a name="l03558"></a>03558    initstate((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) getpid() * 65536 + (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) time(NULL), <a class="code" href="asterisk_8c.html#a3a662046fe963f773c09fc3b998d3a44">randompool</a>, <span class="keyword">sizeof</span>(<a class="code" href="asterisk_8c.html#a3a662046fe963f773c09fc3b998d3a44">randompool</a>));
<a name="l03559"></a>03559 
<a name="l03560"></a>03560    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#aaa750bd60d48780b89622bb62520dff0">init_logger</a>()) {    <span class="comment">/* Start logging subsystem */</span>
<a name="l03561"></a>03561       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03562"></a>03562       exit(1);
<a name="l03563"></a>03563    }
<a name="l03564"></a>03564 
<a name="l03565"></a>03565    <a class="code" href="__private_8h.html#a06393c3702f8ab3864a2fdd7857daa90">threadstorage_init</a>();
<a name="l03566"></a>03566 
<a name="l03567"></a>03567    <a class="code" href="__private_8h.html#abe6bfa12a840493461afe4cb65c935da">astobj2_init</a>();
<a name="l03568"></a>03568 
<a name="l03569"></a>03569    <a class="code" href="__private_8h.html#aa3322128c2188bf3d8405d7373c5c483">ast_autoservice_init</a>();
<a name="l03570"></a>03570 
<a name="l03571"></a>03571    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#a14d1423f33a1d054171143c28490368f">ast_timing_init</a>()) {
<a name="l03572"></a>03572       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03573"></a>03573       exit(1);
<a name="l03574"></a>03574    }
<a name="l03575"></a>03575 
<a name="l03576"></a>03576    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#adb76df37ea8ca7aae2791a447db82430">ast_ssl_init</a>()) {
<a name="l03577"></a>03577       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03578"></a>03578       exit(1);
<a name="l03579"></a>03579    }
<a name="l03580"></a>03580 
<a name="l03581"></a>03581 <span class="preprocessor">#ifdef AST_XML_DOCS</span>
<a name="l03582"></a>03582 <span class="preprocessor"></span>   <span class="comment">/* Load XML documentation. */</span>
<a name="l03583"></a>03583    <a class="code" href="__private_8h.html#a9069f9a0490be2b041ca552ef07757f0" title="Load XML documentation. Provided by xmldoc.c.">ast_xmldoc_load_documentation</a>();
<a name="l03584"></a>03584 <span class="preprocessor">#endif</span>
<a name="l03585"></a>03585 <span class="preprocessor"></span>
<a name="l03586"></a>03586    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#ad68c7bef65928ccdadddf889f105ed9c">load_modules</a>(1)) {     <span class="comment">/* Load modules, pre-load only */</span>
<a name="l03587"></a>03587       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03588"></a>03588       exit(1);
<a name="l03589"></a>03589    }
<a name="l03590"></a>03590 
<a name="l03591"></a>03591    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#abc95730f7f0f9420f52e56e525056e6c">dnsmgr_init</a>()) {    <span class="comment">/* Initialize the DNS manager */</span>
<a name="l03592"></a>03592       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03593"></a>03593       exit(1);
<a name="l03594"></a>03594    }
<a name="l03595"></a>03595 
<a name="l03596"></a>03596    <a class="code" href="__private_8h.html#ab02497431dec0900ac24fafa1c8599c6">ast_http_init</a>();     <span class="comment">/* Start the HTTP server, if needed */</span>
<a name="l03597"></a>03597 
<a name="l03598"></a>03598    <a class="code" href="__private_8h.html#acfffdd54a4bb4777e110dcb3e5118b4c">ast_channels_init</a>();
<a name="l03599"></a>03599 
<a name="l03600"></a>03600    <span class="keywordflow">if</span> (<a class="code" href="manager_8h.html#abd67495092f6edf4b7e5b6ae94be3154" title="Called by Asterisk initialization.">init_manager</a>()) {
<a name="l03601"></a>03601       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03602"></a>03602       exit(1);
<a name="l03603"></a>03603    }
<a name="l03604"></a>03604 
<a name="l03605"></a>03605    <span class="keywordflow">if</span> (<a class="code" href="cdr_8h.html#a6f39a1289d793c9d485fc02f18ce7757" title="Load the configuration file cdr.conf and possibly start the CDR scheduling thread...">ast_cdr_engine_init</a>()) {
<a name="l03606"></a>03606       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03607"></a>03607       exit(1);
<a name="l03608"></a>03608    }
<a name="l03609"></a>03609 
<a name="l03610"></a>03610    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#a1613dc2954f81c1131ad5acd24c1e574" title="Initialize the device state engine in separate thread.">ast_device_state_engine_init</a>()) {
<a name="l03611"></a>03611       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03612"></a>03612       exit(1);
<a name="l03613"></a>03613    }
<a name="l03614"></a>03614 
<a name="l03615"></a>03615    <a class="code" href="rtp_8h.html#a2e910d500d92f02ebf8d571f585d6dd3" title="Initialize the RTP system in Asterisk.">ast_rtp_init</a>();
<a name="l03616"></a>03616    <a class="code" href="dsp_8h.html#a5179a06481a45d1ce645e5f69c0e82c5" title="Load dsp settings from dsp.conf.">ast_dsp_init</a>();
<a name="l03617"></a>03617    <a class="code" href="udptl_8h.html#ad68827c8f88b83c06791a96e595ed978">ast_udptl_init</a>();
<a name="l03618"></a>03618 
<a name="l03619"></a>03619    <span class="keywordflow">if</span> (<a class="code" href="image_8h.html#a370019746b1a87e8ad1a433af897ea9e" title="Initialize image stuff Initializes all the various image stuff. Basically just registers...">ast_image_init</a>()) {
<a name="l03620"></a>03620       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03621"></a>03621       exit(1);
<a name="l03622"></a>03622    }
<a name="l03623"></a>03623 
<a name="l03624"></a>03624    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#aeac4fbc3c21ddf2548bc7ae7fab717f3">ast_file_init</a>()) {
<a name="l03625"></a>03625       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03626"></a>03626       exit(1);
<a name="l03627"></a>03627    }
<a name="l03628"></a>03628 
<a name="l03629"></a>03629    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#ab9a2fcd7b22827d129fc37fc2777c6f4">load_pbx</a>()) {
<a name="l03630"></a>03630       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03631"></a>03631       exit(1);
<a name="l03632"></a>03632    }
<a name="l03633"></a>03633 
<a name="l03634"></a>03634    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#af9629ecd6340cb99bf474736b97433d7" title="Load indications module.">ast_indications_init</a>()) {
<a name="l03635"></a>03635       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03636"></a>03636       exit(1);
<a name="l03637"></a>03637    }
<a name="l03638"></a>03638 
<a name="l03639"></a>03639    <a class="code" href="__private_8h.html#a6b2ac231f2658dd8169218a8e4cad4ae">ast_features_init</a>();
<a name="l03640"></a>03640 
<a name="l03641"></a>03641    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#ae8a701b0b688879d84514bd36d63ff82">init_framer</a>()) {
<a name="l03642"></a>03642       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03643"></a>03643       exit(1);
<a name="l03644"></a>03644    }
<a name="l03645"></a>03645 
<a name="l03646"></a>03646    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#a52d9808db8eba7a1ff32fc6686042f04">astdb_init</a>()) {
<a name="l03647"></a>03647       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03648"></a>03648       exit(1);
<a name="l03649"></a>03649    }
<a name="l03650"></a>03650 
<a name="l03651"></a>03651    <span class="keywordflow">if</span> (<a class="code" href="enum_8h.html#a78f8028f7987a9cd7815482a6821eff0">ast_enum_init</a>()) {
<a name="l03652"></a>03652       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03653"></a>03653       exit(1);
<a name="l03654"></a>03654    }
<a name="l03655"></a>03655 
<a name="l03656"></a>03656    <span class="keywordflow">if</span> (<a class="code" href="__private_8h.html#ad68c7bef65928ccdadddf889f105ed9c">load_modules</a>(0)) {
<a name="l03657"></a>03657       printf(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#acafc2e7f952f86830a69b5c90cfcb0dd">term_quit</a>());
<a name="l03658"></a>03658       exit(1);
<a name="l03659"></a>03659    }
<a name="l03660"></a>03660 
<a name="l03661"></a>03661    <span class="comment">/* loads the cli_permissoins.conf file needed to implement cli restrictions. */</span>
<a name="l03662"></a>03662    <a class="code" href="__private_8h.html#ade6dbc4196f2fc99250aaafededfb41b">ast_cli_perms_init</a>(0);
<a name="l03663"></a>03663 
<a name="l03664"></a>03664    <a class="code" href="__private_8h.html#a0ede7ff922fb2764dfd455e49dc59bc8">dnsmgr_start_refresh</a>();
<a name="l03665"></a>03665 
<a name="l03666"></a>03666    <span class="comment">/* We might have the option of showing a console, but for now just</span>
<a name="l03667"></a>03667 <span class="comment">      do nothing... */</span>
<a name="l03668"></a>03668    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a> &amp;&amp; !option_verbose)
<a name="l03669"></a>03669       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot; ]\n&quot;</span>);
<a name="l03670"></a>03670    <span class="keywordflow">if</span> (option_verbose || <a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a>)
<a name="l03671"></a>03671       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmp, <span class="stringliteral">&quot;Asterisk Ready.\n&quot;</span>, <a class="code" href="term_8h.html#aa25d3faed7c00a4612beb33f7306d251">COLOR_BRWHITE</a>, <a class="code" href="term_8h.html#aba2a7fe77a7501e5844370eec0185207">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(tmp)));
<a name="l03672"></a>03672    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a93b280adefdad68d13fb557f495d2ead">ast_opt_no_fork</a>)
<a name="l03673"></a>03673       <a class="code" href="asterisk_8c.html#a60dce572870808fbda416eb4c9d60250">consolethread</a> = pthread_self();
<a name="l03674"></a>03674 
<a name="l03675"></a>03675    <span class="keywordflow">if</span> (pipe(<a class="code" href="asterisk_8c.html#a7bb419fdb0040da24ecbb651b12395fc">sig_alert_pipe</a>))
<a name="l03676"></a>03676       <a class="code" href="asterisk_8c.html#a7bb419fdb0040da24ecbb651b12395fc">sig_alert_pipe</a>[0] = <a class="code" href="asterisk_8c.html#a7bb419fdb0040da24ecbb651b12395fc">sig_alert_pipe</a>[1] = -1;
<a name="l03677"></a>03677 
<a name="l03678"></a>03678    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;ast_options, <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343ade4cf3231c69af57ad0527bd46244680">AST_OPT_FLAG_FULLY_BOOTED</a>);
<a name="l03679"></a>03679 
<a name="l03680"></a>03680    <a class="code" href="__private_8h.html#a07bf5448c6189024cbc925a3e8ecb5e0" title="Process reload requests received during startup.">ast_process_pending_reloads</a>();
<a name="l03681"></a>03681 
<a name="l03682"></a>03682    pthread_sigmask(SIG_UNBLOCK, &amp;sigs, NULL);
<a name="l03683"></a>03683 
<a name="l03684"></a>03684 <span class="preprocessor">#ifdef __AST_DEBUG_MALLOC</span>
<a name="l03685"></a>03685 <span class="preprocessor"></span>   <a class="code" href="astmm_8h.html#a4d385402bf00a6f75e6f5432faf3cd86">__ast_mm_init</a>();
<a name="l03686"></a>03686 <span class="preprocessor">#endif   </span>
<a name="l03687"></a>03687 <span class="preprocessor"></span>
<a name="l03688"></a>03688    <a class="code" href="options_8h.html#a7cdafc5a121e87659887ffc9abe36760">ast_lastreloadtime</a> = <a class="code" href="options_8h.html#acd462f81fa607939af36a9fa33cdbf9d">ast_startuptime</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l03689"></a>03689    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(cli_asterisk, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_asterisk));
<a name="l03690"></a>03690 
<a name="l03691"></a>03691    <a class="code" href="asterisk_8c.html#ac3e31dd03ea540885ef4359f5f4443a9">run_startup_commands</a>();
<a name="l03692"></a>03692 
<a name="l03693"></a>03693    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a4fe31af40146104d64d4a31535e44400">ast_opt_console</a>) {
<a name="l03694"></a>03694       <span class="comment">/* Console stuff now... */</span>
<a name="l03695"></a>03695       <span class="comment">/* Register our quit function */</span>
<a name="l03696"></a>03696       <span class="keywordtype">char</span> title[256];
<a name="l03697"></a>03697       pthread_t dont_care;
<a name="l03698"></a>03698 
<a name="l03699"></a>03699       <a class="code" href="utils_8h.html#a832647380b1f97e7ac1b4492f8816d46">ast_pthread_create_detached</a>(&amp;dont_care, NULL, <a class="code" href="asterisk_8c.html#a643319c1ef479a7d90ed02ec9c8b1a68">monitor_sig_flags</a>, NULL);
<a name="l03700"></a>03700 
<a name="l03701"></a>03701       <a class="code" href="asterisk_8c.html#aebef75d1917768a6921d6157becf0780">set_icon</a>(<span class="stringliteral">&quot;Asterisk&quot;</span>);
<a name="l03702"></a>03702       snprintf(title, <span class="keyword">sizeof</span>(title), <span class="stringliteral">&quot;Asterisk Console on &apos;%s&apos; (pid %ld)&quot;</span>, hostname, (<span class="keywordtype">long</span>)ast_mainpid);
<a name="l03703"></a>03703       <a class="code" href="asterisk_8c.html#aabb54677daf95f5c6f575645b1ccf46d" title="Set an X-term or screen title.">set_title</a>(title);
<a name="l03704"></a>03704 
<a name="l03705"></a>03705       <span class="keywordflow">for</span> (;;) {
<a name="l03706"></a>03706          buf = (<span class="keywordtype">char</span> *) el_gets(<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a>, &amp;num);
<a name="l03707"></a>03707 
<a name="l03708"></a>03708          <span class="keywordflow">if</span> (!buf &amp;&amp; write(1, <span class="stringliteral">&quot;&quot;</span>, 1) &lt; 0)
<a name="l03709"></a>03709             <span class="keywordflow">goto</span> lostterm;
<a name="l03710"></a>03710 
<a name="l03711"></a>03711          <span class="keywordflow">if</span> (buf) {
<a name="l03712"></a>03712             <span class="keywordflow">if</span> (buf[strlen(buf)-1] == <span class="charliteral">&apos;\n&apos;</span>)
<a name="l03713"></a>03713                buf[strlen(buf)-1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03714"></a>03714 
<a name="l03715"></a>03715             <a class="code" href="asterisk_8c.html#abe8bca2e641977833990af2605439947">consolehandler</a>((<span class="keywordtype">char</span> *)buf);
<a name="l03716"></a>03716          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a17d4d9ef04ffa9034f6c6b6c1fd2bb0b">ast_opt_remote</a> &amp;&amp; (write(STDOUT_FILENO, <span class="stringliteral">&quot;\nUse EXIT or QUIT to exit the asterisk console\n&quot;</span>,
<a name="l03717"></a>03717                strlen(<span class="stringliteral">&quot;\nUse EXIT or QUIT to exit the asterisk console\n&quot;</span>)) &lt; 0)) {
<a name="l03718"></a>03718             <span class="comment">/* Whoa, stdout disappeared from under us... Make /dev/null&apos;s */</span>
<a name="l03719"></a>03719             <span class="keywordtype">int</span> fd;
<a name="l03720"></a>03720             fd = open(<span class="stringliteral">&quot;/dev/null&quot;</span>, O_RDWR);
<a name="l03721"></a>03721             <span class="keywordflow">if</span> (fd &gt; -1) {
<a name="l03722"></a>03722                dup2(fd, STDOUT_FILENO);
<a name="l03723"></a>03723                dup2(fd, STDIN_FILENO);
<a name="l03724"></a>03724             } <span class="keywordflow">else</span>
<a name="l03725"></a>03725                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to open /dev/null to recover from dead console. Bad things will happen!\n&quot;</span>);
<a name="l03726"></a>03726             <span class="keywordflow">break</span>;
<a name="l03727"></a>03727          }
<a name="l03728"></a>03728       }
<a name="l03729"></a>03729    }
<a name="l03730"></a>03730 
<a name="l03731"></a>03731    <a class="code" href="asterisk_8c.html#a643319c1ef479a7d90ed02ec9c8b1a68">monitor_sig_flags</a>(NULL);
<a name="l03732"></a>03732 
<a name="l03733"></a>03733 lostterm:
<a name="l03734"></a>03734    <span class="keywordflow">return</span> 0;
<a name="l03735"></a>03735 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:28 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
