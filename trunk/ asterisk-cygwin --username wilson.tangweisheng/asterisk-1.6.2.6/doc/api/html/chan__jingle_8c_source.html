<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:33 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_0ca6ff3bf6b340411b2c6edd15b1a34d.html">channels</a>
  </div>
</div>
<div class="contents">
<h1>chan_jingle.c</h1><a href="chan__jingle_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2005, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Matt O&apos;Gorman &lt;mogorman@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \author Matt O&apos;Gorman &lt;mogorman@digium.com&gt;</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \brief Jingle Channel Driver</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * \extref Iksemel http://iksemel.jabberstudio.org/</span>
<a name="l00026"></a>00026 <span class="comment"> * </span>
<a name="l00027"></a>00027 <span class="comment"> * \ingroup channel_drivers</span>
<a name="l00028"></a>00028 <span class="comment"> */</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="comment">/*** MODULEINFO</span>
<a name="l00031"></a>00031 <span class="comment">   &lt;depend&gt;iksemel&lt;/depend&gt;</span>
<a name="l00032"></a>00032 <span class="comment">   &lt;depend&gt;res_jabber&lt;/depend&gt;</span>
<a name="l00033"></a>00033 <span class="comment">   &lt;use&gt;openssl&lt;/use&gt;</span>
<a name="l00034"></a>00034 <span class="comment"> ***/</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 249895 $&quot;</span>)
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;sys/signal.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;iksemel.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="sched_8h.html" title="Scheduler Routines (derived from cheops).">asterisk/sched.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="io_8h.html" title="I/O Management (derived from Cheops-NG).">asterisk/io.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="rtp_8h.html" title="Supports RTP and RTCP with Symmetric RTP support for NAT traversal.">asterisk/rtp.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="acl_8h.html" title="Access Control of various sorts.">asterisk/acl.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="callerid_8h.html" title="CallerID (and other GR30) management and generation Includes code and algorithms...">asterisk/callerid.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="musiconhold_8h.html" title="Music on hold handling.">asterisk/musiconhold.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="stringfields_8h.html" title="String fields in structures.">asterisk/stringfields.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="causes_8h.html" title="Internal Asterisk hangup causes.">asterisk/causes.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="astobj_8h.html" title="A set of macros implementing objects and containers. Macros are used for maximum...">asterisk/astobj.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="abstract__jb_8h.html" title="Common implementation-independent jitterbuffer stuff.">asterisk/abstract_jb.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="jabber_8h.html" title="AJI - The Asterisk Jabber Interface.">asterisk/jabber.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="jingle_8h.html" title="Jingle definitions for chan_jingle.">asterisk/jingle.h</a>&quot;</span>
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="chan__jingle_8c.html#a0290b580e4c1cbac25d7e5dd388265ec">00072</a> <span class="preprocessor">#define JINGLE_CONFIG &quot;jingle.conf&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00074"></a>00074 <span class="comment">/*! Global jitterbuffer configuration - by default, jb is disabled */</span>
<a name="l00075"></a><a class="code" href="chan__jingle_8c.html#a2d8d5920e90ccbad7832926becdadb29">00075</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__jb__conf.html" title="General jitterbuffer configuration.">ast_jb_conf</a> <a class="code" href="chan__jingle_8c.html#a2d8d5920e90ccbad7832926becdadb29">default_jbconf</a> =
<a name="l00076"></a>00076 {
<a name="l00077"></a>00077    .<a class="code" href="structast__jb__conf.html#ac92588540e8c1d014a08cd8a45462b19" title="Combination of the AST_JB_ENABLED, AST_JB_FORCED and AST_JB_LOG flags.">flags</a> = 0,
<a name="l00078"></a>00078    .max_size = -1,
<a name="l00079"></a>00079    .resync_threshold = -1,
<a name="l00080"></a>00080    .impl = <span class="stringliteral">&quot;&quot;</span>,
<a name="l00081"></a>00081    .target_extra = -1,
<a name="l00082"></a>00082 };
<a name="l00083"></a><a class="code" href="chan__jingle_8c.html#abaabcb7f4349cc632dde3af5c6a5e1bd">00083</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__jb__conf.html" title="General jitterbuffer configuration.">ast_jb_conf</a> <a class="code" href="chan__jingle_8c.html#abaabcb7f4349cc632dde3af5c6a5e1bd">global_jbconf</a>;
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="chan__jingle_8c.html#aebb98fb4c32fd2499224429599b849de">00085</a> <span class="keyword">enum</span> <a class="code" href="chan__jingle_8c.html#aebb98fb4c32fd2499224429599b849de">jingle_protocol</a> {
<a name="l00086"></a><a class="code" href="chan__jingle_8c.html#aebb98fb4c32fd2499224429599b849deac913daa556e052c68933b9c428707ee3">00086</a>    <a class="code" href="chan__gtalk_8c.html#a4735ec2011c291c5213a858fe007c851ac913daa556e052c68933b9c428707ee3">AJI_PROTOCOL_UDP</a>,
<a name="l00087"></a><a class="code" href="chan__jingle_8c.html#aebb98fb4c32fd2499224429599b849dea8d65aeba8254d08131b4672b7a06221c">00087</a>    <a class="code" href="chan__gtalk_8c.html#a4735ec2011c291c5213a858fe007c851a8d65aeba8254d08131b4672b7a06221c">AJI_PROTOCOL_SSLTCP</a>,
<a name="l00088"></a>00088 };
<a name="l00089"></a>00089 
<a name="l00090"></a><a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964">00090</a> <span class="keyword">enum</span> <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964">jingle_connect_type</a> {
<a name="l00091"></a><a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964afc7bbb745763ffe4069a28ffc61989de">00091</a>    <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964afc7bbb745763ffe4069a28ffc61989de">AJI_CONNECT_HOST</a>,
<a name="l00092"></a><a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964a865ab2dd828faf9586858725a8bb6e78">00092</a>    <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964a865ab2dd828faf9586858725a8bb6e78">AJI_CONNECT_PRFLX</a>,
<a name="l00093"></a><a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964a2ef123abfa8253ea9f67f7750dbdc421">00093</a>    <a class="code" href="chan__gtalk_8c.html#aabf7ea7d1c280c2d91d5ad67ea5ab883a2ef123abfa8253ea9f67f7750dbdc421">AJI_CONNECT_RELAY</a>,
<a name="l00094"></a><a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964a1dfde46e9cdd8b227e1ccb83579d0b90">00094</a>    <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964a1dfde46e9cdd8b227e1ccb83579d0b90">AJI_CONNECT_SRFLX</a>,
<a name="l00095"></a>00095 };
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="structjingle__pvt.html">00097</a> <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> {
<a name="l00098"></a><a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">00098</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>;                <span class="comment">/*!&lt; Channel private lock */</span>
<a name="l00099"></a><a class="code" href="structjingle__pvt.html#afea13c69c31226a6607e67b85f0231e2">00099</a>    time_t <a class="code" href="structjingle__pvt.html#afea13c69c31226a6607e67b85f0231e2">laststun</a>;
<a name="l00100"></a><a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">00100</a>    <span class="keyword">struct </span><a class="code" href="structjingle.html">jingle</a> *<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a>;           <span class="comment">/*!&lt; Parent client */</span>
<a name="l00101"></a><a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">00101</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>[100];
<a name="l00102"></a><a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">00102</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>[<a class="code" href="jabber_8h.html#aff8969a8d91846c9e669eb4f0ec5208a">AJI_MAX_JIDLEN</a>];
<a name="l00103"></a><a class="code" href="structjingle__pvt.html#a4b47cdfa1ed7bb8a6323cdf070e50c97">00103</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle__pvt.html#a4b47cdfa1ed7bb8a6323cdf070e50c97">ring</a>[10];                   <span class="comment">/*!&lt; Message ID of ring */</span>
<a name="l00104"></a><a class="code" href="structjingle__pvt.html#a48b56664545a8ea58b25639b74f863b5">00104</a>    iksrule *<a class="code" href="structjingle__pvt.html#a48b56664545a8ea58b25639b74f863b5">ringrule</a>;               <span class="comment">/*!&lt; Rule for matching RING request */</span>
<a name="l00105"></a><a class="code" href="structjingle__pvt.html#ad65c66f9895c8d58b388365ac363e91c">00105</a>    <span class="keywordtype">int</span> <a class="code" href="structjingle__pvt.html#ad65c66f9895c8d58b388365ac363e91c">initiator</a>;                   <span class="comment">/*!&lt; If we&apos;re the initiator */</span>
<a name="l00106"></a><a class="code" href="structjingle__pvt.html#ac43993a73742eff145b861107a1afa0d">00106</a>    <span class="keywordtype">int</span> <a class="code" href="structjingle__pvt.html#ac43993a73742eff145b861107a1afa0d">alreadygone</a>;
<a name="l00107"></a><a class="code" href="structjingle__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">00107</a>    <span class="keywordtype">int</span> <a class="code" href="structjingle__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;
<a name="l00108"></a><a class="code" href="structjingle__pvt.html#a46262e3cc2baf55a72542567ccfe86d9">00108</a>    <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> <a class="code" href="structjingle__pvt.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;
<a name="l00109"></a><a class="code" href="structjingle__pvt.html#a84649dc7eb0c0e718bdabe4c4ce677d9">00109</a>    <span class="keyword">struct </span><a class="code" href="structjingle__candidate.html">jingle_candidate</a> *<a class="code" href="structjingle__pvt.html#a84649dc7eb0c0e718bdabe4c4ce677d9">theircandidates</a>;
<a name="l00110"></a><a class="code" href="structjingle__pvt.html#a9c80666d44c369110e80d0a57be3deaa">00110</a>    <span class="keyword">struct </span><a class="code" href="structjingle__candidate.html">jingle_candidate</a> *<a class="code" href="structjingle__pvt.html#a9c80666d44c369110e80d0a57be3deaa">ourcandidates</a>;
<a name="l00111"></a><a class="code" href="structjingle__pvt.html#a7b41ba5c947adf528a0615b688a4c5d1">00111</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle__pvt.html#a7b41ba5c947adf528a0615b688a4c5d1">cid_num</a>[80];                <span class="comment">/*!&lt; Caller ID num */</span>
<a name="l00112"></a><a class="code" href="structjingle__pvt.html#abeca50433a6b06e370cf0aacb8af5444">00112</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle__pvt.html#abeca50433a6b06e370cf0aacb8af5444">cid_name</a>[80];               <span class="comment">/*!&lt; Caller ID name */</span>
<a name="l00113"></a><a class="code" href="structjingle__pvt.html#a1a25ab316fdbfb7a045251cf4d1f9b0f">00113</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle__pvt.html#a1a25ab316fdbfb7a045251cf4d1f9b0f">exten</a>[80];                  <span class="comment">/*!&lt; Called extension */</span>
<a name="l00114"></a><a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">00114</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>;       <span class="comment">/*!&lt; Master Channel */</span>
<a name="l00115"></a><a class="code" href="structjingle__pvt.html#a2838424b1bbea277d7a129ca9bcff181">00115</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle__pvt.html#a2838424b1bbea277d7a129ca9bcff181">audio_content_name</a>[100];    <span class="comment">/*!&lt; name attribute of content tag */</span>
<a name="l00116"></a><a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">00116</a>    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>;             <span class="comment">/*!&lt; RTP audio session */</span>
<a name="l00117"></a><a class="code" href="structjingle__pvt.html#a27a715e578b128ce6e82de064840e450">00117</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle__pvt.html#a27a715e578b128ce6e82de064840e450">video_content_name</a>[100];    <span class="comment">/*!&lt; name attribute of content tag */</span>
<a name="l00118"></a><a class="code" href="structjingle__pvt.html#a65e8f978abd3f0206026969c627200a9">00118</a>    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *<a class="code" href="structjingle__pvt.html#a65e8f978abd3f0206026969c627200a9">vrtp</a>;            <span class="comment">/*!&lt; RTP video session */</span>
<a name="l00119"></a><a class="code" href="structjingle__pvt.html#a38f5730c90d9315eb1c0df6cfdc37da6">00119</a>    <span class="keywordtype">int</span> <a class="code" href="structjingle__pvt.html#a38f5730c90d9315eb1c0df6cfdc37da6">jointcapability</a>;             <span class="comment">/*!&lt; Supported capability at both ends (codecs ) */</span>
<a name="l00120"></a><a class="code" href="structjingle__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">00120</a>    <span class="keywordtype">int</span> <a class="code" href="structjingle__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">peercapability</a>;
<a name="l00121"></a><a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">00121</a>    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a>;   <span class="comment">/* Next entity */</span>
<a name="l00122"></a>00122 };
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="structjingle__candidate.html">00124</a> <span class="keyword">struct </span><a class="code" href="structjingle__candidate.html">jingle_candidate</a> {
<a name="l00125"></a><a class="code" href="structjingle__candidate.html#a55bf24e79eaef69b16885c69adee1a6a">00125</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structjingle__candidate.html#a55bf24e79eaef69b16885c69adee1a6a">component</a>;          <span class="comment">/*!&lt; ex. : 1 for RTP, 2 for RTCP */</span>
<a name="l00126"></a><a class="code" href="structjingle__candidate.html#a1abf825b4c3b776e47853a1037b0cf17">00126</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structjingle__candidate.html#a1abf825b4c3b776e47853a1037b0cf17">foundation</a>;         <span class="comment">/*!&lt; Function of IP, protocol, type */</span>
<a name="l00127"></a><a class="code" href="structjingle__candidate.html#aca2885db1fed1f8fe3fee29caa90e292">00127</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structjingle__candidate.html#aca2885db1fed1f8fe3fee29caa90e292">generation</a>;
<a name="l00128"></a><a class="code" href="structjingle__candidate.html#ac03ec605186c0c6d17c4beaab73d615c">00128</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle__candidate.html#ac03ec605186c0c6d17c4beaab73d615c">ip</a>[16];
<a name="l00129"></a><a class="code" href="structjingle__candidate.html#adabbfd79a2d8ac3935245cd061f045b2">00129</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structjingle__candidate.html#adabbfd79a2d8ac3935245cd061f045b2">network</a>;
<a name="l00130"></a><a class="code" href="structjingle__candidate.html#a938bdc6ae46c346147b6d4f67ad1e704">00130</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structjingle__candidate.html#a938bdc6ae46c346147b6d4f67ad1e704">port</a>;
<a name="l00131"></a><a class="code" href="structjingle__candidate.html#a1e440af9e86f7a3c2784c3e2bd687d25">00131</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structjingle__candidate.html#a1e440af9e86f7a3c2784c3e2bd687d25">priority</a>;
<a name="l00132"></a><a class="code" href="structjingle__candidate.html#a78d25527095fa65cb6f62d3b25e26cd2">00132</a>    <span class="keyword">enum</span> <a class="code" href="chan__jingle_8c.html#aebb98fb4c32fd2499224429599b849de">jingle_protocol</a> <a class="code" href="structjingle__candidate.html#a78d25527095fa65cb6f62d3b25e26cd2">protocol</a>;
<a name="l00133"></a><a class="code" href="structjingle__candidate.html#a20218b63ca6f0a6ce74d704d915cb90a">00133</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle__candidate.html#a20218b63ca6f0a6ce74d704d915cb90a">password</a>[100];
<a name="l00134"></a><a class="code" href="structjingle__candidate.html#af24b2d40de5e44ddf3e38e1b2821b619">00134</a>    <span class="keyword">enum</span> <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964">jingle_connect_type</a> <a class="code" href="structjingle__candidate.html#af24b2d40de5e44ddf3e38e1b2821b619">type</a>;
<a name="l00135"></a><a class="code" href="structjingle__candidate.html#a419e5addc503b21ab58e8229ccf2256b">00135</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle__candidate.html#a419e5addc503b21ab58e8229ccf2256b">ufrag</a>[100];
<a name="l00136"></a><a class="code" href="structjingle__candidate.html#a39a3f91544d874e467899b9c096d1ad9">00136</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structjingle__candidate.html#a39a3f91544d874e467899b9c096d1ad9">preference</a>;
<a name="l00137"></a><a class="code" href="structjingle__candidate.html#a345235cfff36c891ac94d7ea9a42a117">00137</a>    <span class="keyword">struct </span><a class="code" href="structjingle__candidate.html">jingle_candidate</a> *<a class="code" href="structjingle__candidate.html#a345235cfff36c891ac94d7ea9a42a117">next</a>;
<a name="l00138"></a>00138 };
<a name="l00139"></a>00139 
<a name="l00140"></a><a class="code" href="structjingle.html">00140</a> <span class="keyword">struct </span><a class="code" href="structjingle.html">jingle</a> {
<a name="l00141"></a>00141    <a class="code" href="structjingle.html#a500d7cf30e1ac3f892120ff534b60767">ASTOBJ_COMPONENTS</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a>);
<a name="l00142"></a><a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">00142</a>    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>;
<a name="l00143"></a><a class="code" href="structjingle.html#a2704a75322ea2a93cfbfd9ba4d08dad6">00143</a>    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *<a class="code" href="structjingle.html#a2704a75322ea2a93cfbfd9ba4d08dad6">buddy</a>;
<a name="l00144"></a><a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">00144</a>    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a>;
<a name="l00145"></a><a class="code" href="structjingle.html#a46262e3cc2baf55a72542567ccfe86d9">00145</a>    <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> <a class="code" href="structjingle.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;
<a name="l00146"></a><a class="code" href="structjingle.html#ad2cfb0f821c065261382a9298bb5a16b">00146</a>    <span class="keywordtype">int</span> <a class="code" href="structjingle.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>;        <span class="comment">/*!&lt; AMA Flags */</span>
<a name="l00147"></a><a class="code" href="structjingle.html#a5f369a232fb94d2f22a2d320d922ad7e">00147</a>    <span class="keywordtype">char</span> <a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>[100];
<a name="l00148"></a><a class="code" href="structjingle.html#aab27e7175d9a6d62b18d5968963820df">00148</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle.html#aab27e7175d9a6d62b18d5968963820df">context</a>[100];
<a name="l00149"></a><a class="code" href="structjingle.html#adfee50d07a98645d4d20b896ce03785a">00149</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle.html#adfee50d07a98645d4d20b896ce03785a">accountcode</a>[<a class="code" href="cdr_8h.html#aa5a0589e78ac9e010524872ca0a3cf49">AST_MAX_ACCOUNT_CODE</a>];   <span class="comment">/*!&lt; Account code */</span>
<a name="l00150"></a><a class="code" href="structjingle.html#afa05b14ff7f76f303c784c00c4c63fa7">00150</a>    <span class="keywordtype">int</span> <a class="code" href="structjingle.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;
<a name="l00151"></a><a class="code" href="structjingle.html#af0f007b48a9c8cf0629428bd0483e0d1">00151</a>    <a class="code" href="channel_8h.html#a641d81d0c5c8df99d43eff69aede3bfd">ast_group_t</a> <a class="code" href="structjingle.html#af0f007b48a9c8cf0629428bd0483e0d1">callgroup</a>;  <span class="comment">/*!&lt; Call group */</span>
<a name="l00152"></a><a class="code" href="structjingle.html#abc0651bcec68410023c036b7d8ec4d11">00152</a>    <a class="code" href="channel_8h.html#a641d81d0c5c8df99d43eff69aede3bfd">ast_group_t</a> <a class="code" href="structjingle.html#abc0651bcec68410023c036b7d8ec4d11">pickupgroup</a>;   <span class="comment">/*!&lt; Pickup group */</span>
<a name="l00153"></a><a class="code" href="structjingle.html#abd29b99884a9fc8a54fc021555190fb8">00153</a>    <span class="keywordtype">int</span> <a class="code" href="structjingle.html#abd29b99884a9fc8a54fc021555190fb8">callingpres</a>;     <span class="comment">/*!&lt; Calling presentation */</span>
<a name="l00154"></a><a class="code" href="structjingle.html#aba1ad8c6c1c296a19e3a11c50ed7c8d5">00154</a>    <span class="keywordtype">int</span> <a class="code" href="structjingle.html#aba1ad8c6c1c296a19e3a11c50ed7c8d5">allowguest</a>;
<a name="l00155"></a><a class="code" href="structjingle.html#adf416dc058363e2fd5750c77e2d78bee">00155</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle.html#adf416dc058363e2fd5750c77e2d78bee">language</a>[<a class="code" href="channel_8h.html#a9238c3318ae8d3bea2cbbe1d1e459eb7">MAX_LANGUAGE</a>];  <span class="comment">/*!&lt;  Default language for prompts */</span>
<a name="l00156"></a><a class="code" href="structjingle.html#abc34958c9b03014779727e5ca61b93e5">00156</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle.html#abc34958c9b03014779727e5ca61b93e5">musicclass</a>[<a class="code" href="channel_8h.html#afb2ae2e53d6676f3ca44a98aa3f92a2c">MAX_MUSICCLASS</a>]; <span class="comment">/*!&lt;  Music on Hold class */</span>
<a name="l00157"></a><a class="code" href="structjingle.html#a6b31bfcc769a5b5c31e13aa6d8a9a286">00157</a>    <span class="keywordtype">char</span> <a class="code" href="structjingle.html#a6b31bfcc769a5b5c31e13aa6d8a9a286">parkinglot</a>[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>];   <span class="comment">/*!&lt; Parkinglot */</span>
<a name="l00158"></a>00158 };
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="structjingle__container.html">00160</a> <span class="keyword">struct </span><a class="code" href="structjingle__container.html">jingle_container</a> {
<a name="l00161"></a>00161    <a class="code" href="structjingle__container.html#aa8ea89c3328e34d4e5de6e85dbf8fa83">ASTOBJ_CONTAINER_COMPONENTS</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a>);
<a name="l00162"></a>00162 };
<a name="l00163"></a>00163 
<a name="l00164"></a><a class="code" href="chan__jingle_8c.html#a787f82faccb7c1f40a2539a14855601b">00164</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="cdr__radius_8c.html#a3aad16fd4bea1b9717f232ea75ad6449">desc</a>[] = <span class="stringliteral">&quot;Jingle Channel&quot;</span>;
<a name="l00165"></a><a class="code" href="chan__jingle_8c.html#aab0df6f9b19263e2a45ed03a8bef4a0d">00165</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="chan__jingle_8c.html#aab0df6f9b19263e2a45ed03a8bef4a0d">channel_type</a>[] = <span class="stringliteral">&quot;Jingle&quot;</span>;
<a name="l00166"></a>00166 
<a name="l00167"></a><a class="code" href="chan__jingle_8c.html#a10fc9006937dcda26877acc36353aad4">00167</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a10fc9006937dcda26877acc36353aad4">global_capability</a> = <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a> | <a class="code" href="frame_8h.html#aa58cc980a9c9108522effc64e9aff2d6">AST_FORMAT_ALAW</a> | <a class="code" href="frame_8h.html#a85106ada66147a674b36f0a55297d29d">AST_FORMAT_GSM</a> | <a class="code" href="frame_8h.html#a750506bc6e9117c66a5a6ad2dc82bc85">AST_FORMAT_H263</a>;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <a class="code" href="lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a>(jinglelock); <span class="comment">/*!&lt; Protect the interface list (of jingle_pvt&apos;s) */</span>
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="comment">/* Forward declarations */</span>
<a name="l00172"></a>00172 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__jingle_8c.html#ac4453005c6ba12a95a5d84c03198aab2" title="Part of PBX interface.">jingle_request</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="keywordtype">int</span> *<a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>);
<a name="l00173"></a>00173 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#aed2fad8c3e2cfd71abc967ce250f4610">jingle_digit_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> digit);
<a name="l00174"></a>00174 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a878ae10818fe2b7400489171828779ea">jingle_digit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> digit, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration);
<a name="l00175"></a>00175 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#aec720230103d5362e3b3ac18d228b33a" title="Initiate new call, part of PBX interface dest is the dial string.">jingle_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> timeout);
<a name="l00176"></a>00176 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#aed2fd62a476d9265cf1a1ac5dcaaeadd" title="Hangup a call through the jingle proxy channel.">jingle_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast);
<a name="l00177"></a>00177 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a08c307d7906cde7815a140b8b7192e55">jingle_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast);
<a name="l00178"></a>00178 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a31ea3edffa52cddd40a4d09e72ca4e22">jingle_newcall</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, ikspak *pak);
<a name="l00179"></a>00179 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="chan__jingle_8c.html#aa4ba94ea2d224195fa03f2c216adc5e6">jingle_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast);
<a name="l00180"></a>00180 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#aa9f6991cdd96de140d7d86996286062e" title="Send frame to media channel (rtp).">jingle_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>);
<a name="l00181"></a>00181 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a03a76533acc66cc42615f3e5ca2f9d93">jingle_indicate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">int</span> condition, <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">size_t</span> <a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l00182"></a>00182 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a882726a9559c340d4a0257c81c7e3f10">jingle_fixup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *oldchan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *newchan);
<a name="l00183"></a>00183 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a82e6534a45b0cf99e198b5b143fb105f">jingle_sendhtml</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l00184"></a>00184 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *<a class="code" href="chan__jingle_8c.html#ad444b828242ff0e8e380b1fe9037fbac">jingle_alloc</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, <span class="keyword">const</span> <span class="keywordtype">char</span> *from, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>);
<a name="l00185"></a>00185 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__jingle_8c.html#acbb7216b9bb3337b10531dd209038a87" title="CLI command &amp;quot;jingle show channels&amp;quot;.">jingle_show_channels</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a);
<a name="l00186"></a>00186 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__jingle_8c.html#a6dcc779144f39ee5d4177c47d79646fe" title="CLI command &amp;quot;jingle reload&amp;quot;.">jingle_do_reload</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a);
<a name="l00187"></a>00187 <span class="comment">/*----- RTP interface functions */</span>
<a name="l00188"></a>00188 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a93323a5913cd35dfd0ff76284c895860">jingle_set_rtp_peer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>,
<a name="l00189"></a>00189                         <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *<a class="code" href="structjingle__pvt.html#a65e8f978abd3f0206026969c627200a9">vrtp</a>, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *tpeer, <span class="keywordtype">int</span> codecs, <span class="keywordtype">int</span> nat_active);
<a name="l00190"></a>00190 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95">ast_rtp_get_result</a> <a class="code" href="chan__jingle_8c.html#a3723abb6d90ab82dd2bc150dc909c717">jingle_get_rtp_peer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> **<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>);
<a name="l00191"></a>00191 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a79160534cbb19065b329c62c134e0e59">jingle_get_codec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>);
<a name="l00192"></a>00192 <span class="comment"></span>
<a name="l00193"></a>00193 <span class="comment">/*! \brief PBX interface structure for channel registration */</span>
<a name="l00194"></a><a class="code" href="chan__jingle_8c.html#af8ce56a09389447c4d8d9331287c109d">00194</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html" title="Structure to describe a channel &amp;quot;technology&amp;quot;, ie a channel driver See for...">ast_channel_tech</a> <a class="code" href="chan__jingle_8c.html#af8ce56a09389447c4d8d9331287c109d" title="PBX interface structure for channel registration.">jingle_tech</a> = {
<a name="l00195"></a>00195    .<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a> = <span class="stringliteral">&quot;Jingle&quot;</span>,
<a name="l00196"></a>00196    .description = <span class="stringliteral">&quot;Jingle Channel Driver&quot;</span>,
<a name="l00197"></a>00197    .capabilities = <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a>,
<a name="l00198"></a>00198    .requester = <a class="code" href="chan__jingle_8c.html#ac4453005c6ba12a95a5d84c03198aab2" title="Part of PBX interface.">jingle_request</a>,
<a name="l00199"></a>00199    .send_digit_begin = <a class="code" href="chan__jingle_8c.html#aed2fad8c3e2cfd71abc967ce250f4610">jingle_digit_begin</a>,
<a name="l00200"></a>00200    .send_digit_end = <a class="code" href="chan__jingle_8c.html#a878ae10818fe2b7400489171828779ea">jingle_digit_end</a>,
<a name="l00201"></a>00201    .bridge = <a class="code" href="rtp_8h.html#af45b92414bcb435f50e82c819e77649c" title="The RTP bridge.">ast_rtp_bridge</a>,
<a name="l00202"></a>00202    .call = <a class="code" href="chan__jingle_8c.html#aec720230103d5362e3b3ac18d228b33a" title="Initiate new call, part of PBX interface dest is the dial string.">jingle_call</a>,
<a name="l00203"></a>00203    .hangup = <a class="code" href="chan__jingle_8c.html#aed2fd62a476d9265cf1a1ac5dcaaeadd" title="Hangup a call through the jingle proxy channel.">jingle_hangup</a>,
<a name="l00204"></a>00204    .answer = <a class="code" href="chan__jingle_8c.html#a08c307d7906cde7815a140b8b7192e55">jingle_answer</a>,
<a name="l00205"></a>00205    .read = <a class="code" href="chan__jingle_8c.html#aa4ba94ea2d224195fa03f2c216adc5e6">jingle_read</a>,
<a name="l00206"></a>00206    .write = <a class="code" href="chan__jingle_8c.html#aa9f6991cdd96de140d7d86996286062e" title="Send frame to media channel (rtp).">jingle_write</a>,
<a name="l00207"></a>00207    .exception = <a class="code" href="chan__jingle_8c.html#aa4ba94ea2d224195fa03f2c216adc5e6">jingle_read</a>,
<a name="l00208"></a>00208    .indicate = <a class="code" href="chan__jingle_8c.html#a03a76533acc66cc42615f3e5ca2f9d93">jingle_indicate</a>,
<a name="l00209"></a>00209    .fixup = <a class="code" href="chan__jingle_8c.html#a882726a9559c340d4a0257c81c7e3f10">jingle_fixup</a>,
<a name="l00210"></a>00210    .send_html = <a class="code" href="chan__jingle_8c.html#a82e6534a45b0cf99e198b5b143fb105f">jingle_sendhtml</a>,
<a name="l00211"></a>00211    .properties = <a class="code" href="channel_8h.html#a4f126a0a9b1d8c6a8f46a051ef8830bba54130226ec87f80c48ee98aa5cc9168c" title="Channels have this property if they can accept input with jitter; i.e. most VoIP...">AST_CHAN_TP_WANTSJITTER</a> | <a class="code" href="channel_8h.html#a4f126a0a9b1d8c6a8f46a051ef8830bbafb2c9cea57f7fc8e0350ed6f60cbb892" title="Channels have this property if they can create jitter; i.e. most VoIP channels.">AST_CHAN_TP_CREATESJITTER</a>
<a name="l00212"></a>00212 };
<a name="l00213"></a>00213 
<a name="l00214"></a><a class="code" href="chan__jingle_8c.html#a4ec29229510a2e3ea6ce34d520f06e90">00214</a> <span class="keyword">static</span> <span class="keyword">struct </span>sockaddr_in <a class="code" href="chan__jingle_8c.html#a4ec29229510a2e3ea6ce34d520f06e90">bindaddr</a> = { 0, }; <span class="comment">/*!&lt; The address we bind to */</span>
<a name="l00215"></a>00215 
<a name="l00216"></a><a class="code" href="chan__jingle_8c.html#aea6233539fc73fc5303bf7525ec27e73">00216</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsched__context.html">sched_context</a> *<a class="code" href="structsched.html">sched</a>; <span class="comment">/*!&lt; The scheduling context */</span>
<a name="l00217"></a><a class="code" href="chan__jingle_8c.html#abda48311b6abe5a4dd8b6904ddde0a6d">00217</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structio__context.html" title="Global IO variables are now in a struct in order to be made threadsafe.">io_context</a> *<a class="code" href="chan__jingle_8c.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a>; <span class="comment">/*!&lt; The IO context */</span>
<a name="l00218"></a><a class="code" href="chan__jingle_8c.html#a1d084b82cb21102ba46ea60d3cd9c085">00218</a> <span class="keyword">static</span> <span class="keyword">struct </span>in_addr <a class="code" href="chan__jingle_8c.html#a1d084b82cb21102ba46ea60d3cd9c085">__ourip</a>;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="comment"></span>
<a name="l00221"></a>00221 <span class="comment">/*! \brief RTP driver interface */</span>
<a name="l00222"></a><a class="code" href="chan__jingle_8c.html#a7829b303dcccbd015ba7c6e66d3ccdc6">00222</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__rtp__protocol.html" title="This is the structure that binds a channel (SIP/Jingle/H.323) to the RTP subsystem...">ast_rtp_protocol</a> <a class="code" href="chan__jingle_8c.html#a7829b303dcccbd015ba7c6e66d3ccdc6" title="RTP driver interface.">jingle_rtp</a> = {
<a name="l00223"></a>00223    <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>: <span class="stringliteral">&quot;Jingle&quot;</span>,
<a name="l00224"></a>00224    <a class="code" href="structast__rtp__protocol.html#aad2be0227a36efe9efc1fea51dd407a5">get_rtp_info</a>: <a class="code" href="chan__jingle_8c.html#a3723abb6d90ab82dd2bc150dc909c717">jingle_get_rtp_peer</a>,
<a name="l00225"></a>00225    <a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>: <a class="code" href="chan__jingle_8c.html#a93323a5913cd35dfd0ff76284c895860">jingle_set_rtp_peer</a>,
<a name="l00226"></a>00226    <a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a>: <a class="code" href="chan__jingle_8c.html#a79160534cbb19065b329c62c134e0e59">jingle_get_codec</a>,
<a name="l00227"></a>00227 };
<a name="l00228"></a>00228 
<a name="l00229"></a><a class="code" href="chan__jingle_8c.html#a8eb88ab84048a960e7fc507bb7832e4a">00229</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="chan__jingle_8c.html#a8eb88ab84048a960e7fc507bb7832e4a">jingle_cli</a>[] = {
<a name="l00230"></a>00230    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__jingle_8c.html#a6dcc779144f39ee5d4177c47d79646fe" title="CLI command &amp;quot;jingle reload&amp;quot;.">jingle_do_reload</a>, <span class="stringliteral">&quot;Reload Jingle configuration&quot;</span>),
<a name="l00231"></a>00231    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__jingle_8c.html#acbb7216b9bb3337b10531dd209038a87" title="CLI command &amp;quot;jingle show channels&amp;quot;.">jingle_show_channels</a>, <span class="stringliteral">&quot;Show Jingle channels&quot;</span>),
<a name="l00232"></a>00232 };
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 
<a name="l00235"></a><a class="code" href="chan__jingle_8c.html#a651c2e6c15fed139c3dd5bf54ab01ff2">00235</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__jingle_8c.html#a651c2e6c15fed139c3dd5bf54ab01ff2">externip</a>[16];
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="chan__jingle_8c.html#a42d49d41c6e229f83e18d7623ca150f5">00237</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structjingle__container.html">jingle_container</a> <a class="code" href="chan__jingle_8c.html#a42d49d41c6e229f83e18d7623ca150f5">jingle_list</a>;
<a name="l00238"></a>00238 
<a name="l00239"></a><a class="code" href="chan__jingle_8c.html#a93c625eb4d713d669ca85bc087ea6940">00239</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__jingle_8c.html#a93c625eb4d713d669ca85bc087ea6940">jingle_member_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *obj)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(obj);
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 
<a name="l00244"></a><a class="code" href="chan__jingle_8c.html#a4eaecfb356a5331aa7ebcb052a5d6680">00244</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structjingle.html">jingle</a> *<a class="code" href="chan__jingle_8c.html#a4eaecfb356a5331aa7ebcb052a5d6680">find_jingle</a>(<span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keywordtype">char</span> *<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>)
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246    <span class="keyword">struct </span><a class="code" href="structjingle.html">jingle</a> *<a class="code" href="structjingle.html">jingle</a> = NULL;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248    jingle = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="chan__jingle_8c.html#a42d49d41c6e229f83e18d7623ca150f5">jingle_list</a>, name);
<a name="l00249"></a>00249    <span class="keywordflow">if</span> (!jingle &amp;&amp; strchr(name, <span class="charliteral">&apos;@&apos;</span>))
<a name="l00250"></a>00250       jingle = <a class="code" href="astobj_8h.html#a2714c822060df6eec7241ee4b250cc3c" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND_FULL</a>(&amp;<a class="code" href="chan__jingle_8c.html#a42d49d41c6e229f83e18d7623ca150f5">jingle_list</a>, name, <a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>,,, strcasecmp);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252    <span class="keywordflow">if</span> (!jingle) {          
<a name="l00253"></a>00253       <span class="comment">/* guest call */</span>
<a name="l00254"></a>00254       <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="chan__jingle_8c.html#a42d49d41c6e229f83e18d7623ca150f5">jingle_list</a>, 1, {
<a name="l00255"></a>00255          <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l00256"></a>00256          <span class="keywordflow">if</span> (!strcasecmp(iterator-&gt;name, <span class="stringliteral">&quot;guest&quot;</span>)) {
<a name="l00257"></a>00257             jingle = iterator;
<a name="l00258"></a>00258          }
<a name="l00259"></a>00259          <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l00260"></a>00260 
<a name="l00261"></a>00261          <span class="keywordflow">if</span> (jingle)
<a name="l00262"></a>00262             <span class="keywordflow">break</span>;
<a name="l00263"></a>00263       });
<a name="l00264"></a>00264 
<a name="l00265"></a>00265    }
<a name="l00266"></a>00266    <span class="keywordflow">return</span> jingle;
<a name="l00267"></a>00267 }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269 
<a name="l00270"></a><a class="code" href="chan__jingle_8c.html#aa01e0ba94ca78f72d4b55b025873fd88">00270</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__jingle_8c.html#aa01e0ba94ca78f72d4b55b025873fd88">add_codec_to_answer</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structjingle__pvt.html">jingle_pvt</a> *<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a>, <span class="keywordtype">int</span> codec, iks *dcodecs)
<a name="l00271"></a>00271 {
<a name="l00272"></a>00272    <span class="keywordtype">char</span> *<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a> = <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(codec);
<a name="l00273"></a>00273 
<a name="l00274"></a>00274    <span class="keywordflow">if</span> (!strcasecmp(<span class="stringliteral">&quot;ulaw&quot;</span>, format)) {
<a name="l00275"></a>00275       iks *payload_eg711u, *payload_pcmu;
<a name="l00276"></a>00276       payload_pcmu = iks_new(<span class="stringliteral">&quot;payload-type&quot;</span>);
<a name="l00277"></a>00277       iks_insert_attrib(payload_pcmu, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>);
<a name="l00278"></a>00278       iks_insert_attrib(payload_pcmu, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;PCMU&quot;</span>);
<a name="l00279"></a>00279       payload_eg711u = iks_new(<span class="stringliteral">&quot;payload-type&quot;</span>);
<a name="l00280"></a>00280       iks_insert_attrib(payload_eg711u, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;100&quot;</span>);
<a name="l00281"></a>00281       iks_insert_attrib(payload_eg711u, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;EG711U&quot;</span>);
<a name="l00282"></a>00282       iks_insert_node(dcodecs, payload_pcmu);
<a name="l00283"></a>00283       iks_insert_node(dcodecs, payload_eg711u);
<a name="l00284"></a>00284    }
<a name="l00285"></a>00285    <span class="keywordflow">if</span> (!strcasecmp(<span class="stringliteral">&quot;alaw&quot;</span>, format)) {
<a name="l00286"></a>00286       iks *payload_eg711a;
<a name="l00287"></a>00287       iks *payload_pcma = iks_new(<span class="stringliteral">&quot;payload-type&quot;</span>);
<a name="l00288"></a>00288       iks_insert_attrib(payload_pcma, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;8&quot;</span>);
<a name="l00289"></a>00289       iks_insert_attrib(payload_pcma, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;PCMA&quot;</span>);
<a name="l00290"></a>00290       payload_eg711a = iks_new(<span class="stringliteral">&quot;payload-type&quot;</span>);
<a name="l00291"></a>00291       iks_insert_attrib(payload_eg711a, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;101&quot;</span>);
<a name="l00292"></a>00292       iks_insert_attrib(payload_eg711a, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;EG711A&quot;</span>);
<a name="l00293"></a>00293       iks_insert_node(dcodecs, payload_pcma);
<a name="l00294"></a>00294       iks_insert_node(dcodecs, payload_eg711a);
<a name="l00295"></a>00295    }
<a name="l00296"></a>00296    <span class="keywordflow">if</span> (!strcasecmp(<span class="stringliteral">&quot;ilbc&quot;</span>, format)) {
<a name="l00297"></a>00297       iks *payload_ilbc = iks_new(<span class="stringliteral">&quot;payload-type&quot;</span>);
<a name="l00298"></a>00298       iks_insert_attrib(payload_ilbc, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;97&quot;</span>);
<a name="l00299"></a>00299       iks_insert_attrib(payload_ilbc, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;iLBC&quot;</span>);
<a name="l00300"></a>00300       iks_insert_node(dcodecs, payload_ilbc);
<a name="l00301"></a>00301    }
<a name="l00302"></a>00302    <span class="keywordflow">if</span> (!strcasecmp(<span class="stringliteral">&quot;g723&quot;</span>, format)) {
<a name="l00303"></a>00303       iks *payload_g723 = iks_new(<span class="stringliteral">&quot;payload-type&quot;</span>);
<a name="l00304"></a>00304       iks_insert_attrib(payload_g723, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;4&quot;</span>);
<a name="l00305"></a>00305       iks_insert_attrib(payload_g723, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;G723&quot;</span>);
<a name="l00306"></a>00306       iks_insert_node(dcodecs, payload_g723);
<a name="l00307"></a>00307    }
<a name="l00308"></a>00308    <a class="code" href="rtp_8h.html#a4daa559b8f2ef25bc33d8f5d8fd937d1" title="Looks up an RTP code out of our *static* outbound list.">ast_rtp_lookup_code</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>, 1, codec);
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a><a class="code" href="chan__jingle_8c.html#a7bc2e79b907feeaebda7132768034f13">00311</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a7bc2e79b907feeaebda7132768034f13">jingle_accept_call</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, <span class="keyword">struct</span> <a class="code" href="structjingle__pvt.html">jingle_pvt</a> *<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a>)
<a name="l00312"></a>00312 {
<a name="l00313"></a>00313    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *tmp = client-&gt;<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a>;
<a name="l00314"></a>00314    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *c = client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>;
<a name="l00315"></a>00315    iks *iq, *<a class="code" href="structjingle.html">jingle</a>, *dcodecs, *payload_red, *payload_audio, *payload_cn;
<a name="l00316"></a>00316    <span class="keywordtype">int</span> x;
<a name="l00317"></a>00317    <span class="keywordtype">int</span> pref_codec = 0;
<a name="l00318"></a>00318    <span class="keywordtype">int</span> alreadysent = 0;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structjingle__pvt.html#ad65c66f9895c8d58b388365ac363e91c">initiator</a>)
<a name="l00321"></a>00321       <span class="keywordflow">return</span> 1;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323    iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l00324"></a>00324    jingle = iks_new(<a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>);
<a name="l00325"></a>00325    dcodecs = iks_new(<span class="stringliteral">&quot;description&quot;</span>);
<a name="l00326"></a>00326    <span class="keywordflow">if</span> (iq &amp;&amp; jingle &amp;&amp; dcodecs) {
<a name="l00327"></a>00327       iks_insert_attrib(dcodecs, <span class="stringliteral">&quot;xmlns&quot;</span>, <a class="code" href="jingle_8h.html#a7fab96291ad1dce0b48bc61887a0f4f3">JINGLE_AUDIO_RTP_NS</a>);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329       <span class="keywordflow">for</span> (x = 0; x &lt; 32; x++) {
<a name="l00330"></a>00330          <span class="keywordflow">if</span> (!(pref_codec = <a class="code" href="frame_8h.html#af9dd4cbc4b715644df1afe4964169c9b" title="Codec located at a particular place in the preference index.">ast_codec_pref_index</a>(&amp;client-&gt;<a class="code" href="structjingle.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, x)))
<a name="l00331"></a>00331             <span class="keywordflow">break</span>;
<a name="l00332"></a>00332          <span class="keywordflow">if</span> (!(client-&gt;<a class="code" href="structjingle.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a> &amp; pref_codec))
<a name="l00333"></a>00333             <span class="keywordflow">continue</span>;
<a name="l00334"></a>00334          <span class="keywordflow">if</span> (alreadysent &amp; pref_codec)
<a name="l00335"></a>00335             <span class="keywordflow">continue</span>;
<a name="l00336"></a>00336          <a class="code" href="chan__jingle_8c.html#aa01e0ba94ca78f72d4b55b025873fd88">add_codec_to_answer</a>(p, pref_codec, dcodecs);
<a name="l00337"></a>00337          alreadysent |= pref_codec;
<a name="l00338"></a>00338       }
<a name="l00339"></a>00339       payload_red = iks_new(<span class="stringliteral">&quot;payload-type&quot;</span>);
<a name="l00340"></a>00340       iks_insert_attrib(payload_red, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;117&quot;</span>);
<a name="l00341"></a>00341       iks_insert_attrib(payload_red, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;red&quot;</span>);
<a name="l00342"></a>00342       payload_audio = iks_new(<span class="stringliteral">&quot;payload-type&quot;</span>);
<a name="l00343"></a>00343       iks_insert_attrib(payload_audio, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;106&quot;</span>);
<a name="l00344"></a>00344       iks_insert_attrib(payload_audio, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;audio/telephone-event&quot;</span>);
<a name="l00345"></a>00345       payload_cn = iks_new(<span class="stringliteral">&quot;payload-type&quot;</span>);
<a name="l00346"></a>00346       iks_insert_attrib(payload_cn, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;13&quot;</span>);
<a name="l00347"></a>00347       iks_insert_attrib(payload_cn, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;CN&quot;</span>);
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 
<a name="l00350"></a>00350       iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;set&quot;</span>);
<a name="l00351"></a>00351       iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, (p-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>) ? p-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a> : client-&gt;<a class="code" href="structjingle.html#a5f369a232fb94d2f22a2d320d922ad7e">user</a>);
<a name="l00352"></a>00352       iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l00353"></a>00353       <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355       iks_insert_attrib(jingle, <span class="stringliteral">&quot;xmlns&quot;</span>, <a class="code" href="jingle_8h.html#aea60c021ce1b84cb1e3fb03c325bf29d">JINGLE_NS</a>);
<a name="l00356"></a>00356       iks_insert_attrib(jingle, <span class="stringliteral">&quot;action&quot;</span>, <a class="code" href="jingle_8h.html#ad67040ebd300cf34ffe584220bd41bc9">JINGLE_ACCEPT</a>);
<a name="l00357"></a>00357       iks_insert_attrib(jingle, <span class="stringliteral">&quot;initiator&quot;</span>, p-&gt;<a class="code" href="structjingle__pvt.html#ad65c66f9895c8d58b388365ac363e91c">initiator</a> ? client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full : p-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>);
<a name="l00358"></a>00358       iks_insert_attrib(jingle, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>, tmp-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>);
<a name="l00359"></a>00359       iks_insert_node(iq, jingle);
<a name="l00360"></a>00360       iks_insert_node(jingle, dcodecs);
<a name="l00361"></a>00361       iks_insert_node(dcodecs, payload_red);
<a name="l00362"></a>00362       iks_insert_node(dcodecs, payload_audio);
<a name="l00363"></a>00363       iks_insert_node(dcodecs, payload_cn);
<a name="l00364"></a>00364 
<a name="l00365"></a>00365       <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(c, iq);
<a name="l00366"></a>00366 
<a name="l00367"></a>00367       iks_delete(payload_red);
<a name="l00368"></a>00368       iks_delete(payload_audio);
<a name="l00369"></a>00369       iks_delete(payload_cn);
<a name="l00370"></a>00370       iks_delete(dcodecs);
<a name="l00371"></a>00371       iks_delete(jingle);
<a name="l00372"></a>00372       iks_delete(iq);
<a name="l00373"></a>00373    }
<a name="l00374"></a>00374    <span class="keywordflow">return</span> 1;
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 
<a name="l00377"></a><a class="code" href="chan__jingle_8c.html#adb8e25a5e4aab990e6d37cda542fdd8c">00377</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#adb8e25a5e4aab990e6d37cda542fdd8c">jingle_ringing_ack</a>(<span class="keywordtype">void</span> *data, ikspak *pak)
<a name="l00378"></a>00378 {
<a name="l00379"></a>00379    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p = data;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structjingle__pvt.html#a48b56664545a8ea58b25639b74f863b5">ringrule</a>)
<a name="l00382"></a>00382       iks_filter_remove_rule(p-&gt;<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a>-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, p-&gt;<a class="code" href="structjingle__pvt.html#a48b56664545a8ea58b25639b74f863b5">ringrule</a>);
<a name="l00383"></a>00383    p-&gt;<a class="code" href="structjingle__pvt.html#a48b56664545a8ea58b25639b74f863b5">ringrule</a> = NULL;
<a name="l00384"></a>00384    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)
<a name="l00385"></a>00385       <a class="code" href="channel_8h.html#a60f9d2b0ab8b7a839902313321163b28" title="Queue a control frame with payload.">ast_queue_control</a>(p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>);
<a name="l00386"></a>00386    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l00387"></a>00387 }
<a name="l00388"></a>00388 
<a name="l00389"></a><a class="code" href="chan__jingle_8c.html#a08c307d7906cde7815a140b8b7192e55">00389</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a08c307d7906cde7815a140b8b7192e55">jingle_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast)
<a name="l00390"></a>00390 {
<a name="l00391"></a>00391    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00392"></a>00392    <span class="keyword">struct </span><a class="code" href="structjingle.html">jingle</a> *client = p-&gt;<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a>;
<a name="l00393"></a>00393    <span class="keywordtype">int</span> res = 0;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Answer!\n&quot;</span>);
<a name="l00396"></a>00396    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00397"></a>00397    <a class="code" href="chan__jingle_8c.html#a7bc2e79b907feeaebda7132768034f13">jingle_accept_call</a>(client, p);
<a name="l00398"></a>00398    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00399"></a>00399    <span class="keywordflow">return</span> res;
<a name="l00400"></a>00400 }
<a name="l00401"></a>00401 
<a name="l00402"></a><a class="code" href="chan__jingle_8c.html#a3723abb6d90ab82dd2bc150dc909c717">00402</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95">ast_rtp_get_result</a> <a class="code" href="chan__jingle_8c.html#a3723abb6d90ab82dd2bc150dc909c717">jingle_get_rtp_peer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> **rtp)
<a name="l00403"></a>00403 {
<a name="l00404"></a>00404    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p = chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00405"></a>00405    <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95">ast_rtp_get_result</a> res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407    <span class="keywordflow">if</span> (!p)
<a name="l00408"></a>00408       <span class="keywordflow">return</span> res;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00411"></a>00411    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>) {
<a name="l00412"></a>00412       *rtp = p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>;
<a name="l00413"></a>00413       res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95a8bc993394ab95ca4c2ac98f9477518fe">AST_RTP_TRY_PARTIAL</a>;
<a name="l00414"></a>00414    }
<a name="l00415"></a>00415    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417    <span class="keywordflow">return</span> res;
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00420"></a><a class="code" href="chan__jingle_8c.html#a79160534cbb19065b329c62c134e0e59">00420</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a79160534cbb19065b329c62c134e0e59">jingle_get_codec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)
<a name="l00421"></a>00421 {
<a name="l00422"></a>00422    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p = chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00423"></a>00423    <span class="keywordflow">return</span> p-&gt;<a class="code" href="structjingle__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">peercapability</a>;
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00426"></a><a class="code" href="chan__jingle_8c.html#a93323a5913cd35dfd0ff76284c895860">00426</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a93323a5913cd35dfd0ff76284c895860">jingle_set_rtp_peer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *<a class="code" href="structjingle__pvt.html#a65e8f978abd3f0206026969c627200a9">vrtp</a>, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *tpeer, <span class="keywordtype">int</span> codecs, <span class="keywordtype">int</span> nat_active)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430    p = chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00431"></a>00431    <span class="keywordflow">if</span> (!p)
<a name="l00432"></a>00432       <span class="keywordflow">return</span> -1;
<a name="l00433"></a>00433    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 <span class="comment">/* if (rtp)</span>
<a name="l00436"></a>00436 <span class="comment">      ast_rtp_get_peer(rtp, &amp;p-&gt;redirip);</span>
<a name="l00437"></a>00437 <span class="comment">   else</span>
<a name="l00438"></a>00438 <span class="comment">      memset(&amp;p-&gt;redirip, 0, sizeof(p-&gt;redirip));</span>
<a name="l00439"></a>00439 <span class="comment">   p-&gt;redircodecs = codecs; */</span>
<a name="l00440"></a>00440 
<a name="l00441"></a>00441    <span class="comment">/* Reset lastrtprx timer */</span>
<a name="l00442"></a>00442    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00443"></a>00443    <span class="keywordflow">return</span> 0;
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 
<a name="l00446"></a><a class="code" href="chan__jingle_8c.html#aaff55fd50b50df0032b11b4ad22b9f3b">00446</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#aaff55fd50b50df0032b11b4ad22b9f3b">jingle_response</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, ikspak *pak, <span class="keyword">const</span> <span class="keywordtype">char</span> *reasonstr, <span class="keyword">const</span> <span class="keywordtype">char</span> *reasonstr2)
<a name="l00447"></a>00447 {
<a name="l00448"></a>00448    iks *response = NULL, *error = NULL, *reason = NULL;
<a name="l00449"></a>00449    <span class="keywordtype">int</span> res = -1;
<a name="l00450"></a>00450 
<a name="l00451"></a>00451    response = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l00452"></a>00452    <span class="keywordflow">if</span> (response) {
<a name="l00453"></a>00453       iks_insert_attrib(response, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l00454"></a>00454       iks_insert_attrib(response, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l00455"></a>00455       iks_insert_attrib(response, <span class="stringliteral">&quot;to&quot;</span>, iks_find_attrib(pak-&gt;x, <span class="stringliteral">&quot;from&quot;</span>));
<a name="l00456"></a>00456       iks_insert_attrib(response, <span class="stringliteral">&quot;id&quot;</span>, iks_find_attrib(pak-&gt;x, <span class="stringliteral">&quot;id&quot;</span>));
<a name="l00457"></a>00457       <span class="keywordflow">if</span> (reasonstr) {
<a name="l00458"></a>00458          error = iks_new(<span class="stringliteral">&quot;error&quot;</span>);
<a name="l00459"></a>00459          <span class="keywordflow">if</span> (error) {
<a name="l00460"></a>00460             iks_insert_attrib(error, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;cancel&quot;</span>);
<a name="l00461"></a>00461             reason = iks_new(reasonstr);
<a name="l00462"></a>00462             <span class="keywordflow">if</span> (reason)
<a name="l00463"></a>00463                iks_insert_node(error, reason);
<a name="l00464"></a>00464             iks_insert_node(response, error);
<a name="l00465"></a>00465          }
<a name="l00466"></a>00466       }
<a name="l00467"></a>00467       <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>, response);
<a name="l00468"></a>00468       res = 0;
<a name="l00469"></a>00469    }
<a name="l00470"></a>00470    
<a name="l00471"></a>00471    iks_delete(reason);
<a name="l00472"></a>00472    iks_delete(error);
<a name="l00473"></a>00473    iks_delete(response);
<a name="l00474"></a>00474 
<a name="l00475"></a>00475    <span class="keywordflow">return</span> res;
<a name="l00476"></a>00476 }
<a name="l00477"></a>00477 
<a name="l00478"></a><a class="code" href="chan__jingle_8c.html#a53d306c6b246e8533657ae7e0f8f7e4d">00478</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a53d306c6b246e8533657ae7e0f8f7e4d">jingle_is_answered</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, ikspak *pak)
<a name="l00479"></a>00479 {
<a name="l00480"></a>00480    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *tmp;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;The client is %s\n&quot;</span>, client-&gt;name);
<a name="l00483"></a>00483    <span class="comment">/* Make sure our new call doesn&apos;t exist yet */</span>
<a name="l00484"></a>00484    <span class="keywordflow">for</span> (tmp = client-&gt;<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a>; tmp; tmp = tmp-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a>) {
<a name="l00485"></a>00485       <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;x, <a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>, tmp-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>))
<a name="l00486"></a>00486          <span class="keywordflow">break</span>;
<a name="l00487"></a>00487    }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489    <span class="keywordflow">if</span> (tmp) {
<a name="l00490"></a>00490       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)
<a name="l00491"></a>00491          <a class="code" href="channel_8h.html#a60f9d2b0ab8b7a839902313321163b28" title="Queue a control frame with payload.">ast_queue_control</a>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a9e3135920bd5bdbfd8c57fdaaa6b1dbe">AST_CONTROL_ANSWER</a>);
<a name="l00492"></a>00492    } <span class="keywordflow">else</span>
<a name="l00493"></a>00493       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Whoa, didn&apos;t find call!\n&quot;</span>);
<a name="l00494"></a>00494    <a class="code" href="chan__jingle_8c.html#aaff55fd50b50df0032b11b4ad22b9f3b">jingle_response</a>(client, pak, NULL, NULL);
<a name="l00495"></a>00495    <span class="keywordflow">return</span> 1;
<a name="l00496"></a>00496 }
<a name="l00497"></a>00497 
<a name="l00498"></a><a class="code" href="chan__jingle_8c.html#aa55267bdc9fcd7969f520178957f92e8">00498</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#aa55267bdc9fcd7969f520178957f92e8">jingle_handle_dtmf</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, ikspak *pak)
<a name="l00499"></a>00499 {
<a name="l00500"></a>00500    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *tmp;
<a name="l00501"></a>00501    iks *dtmfnode = NULL, *dtmfchild = NULL;
<a name="l00502"></a>00502    <span class="keywordtype">char</span> *dtmf;
<a name="l00503"></a>00503    <span class="comment">/* Make sure our new call doesn&apos;t exist yet */</span>
<a name="l00504"></a>00504    <span class="keywordflow">for</span> (tmp = client-&gt;<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a>; tmp; tmp = tmp-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a>) {
<a name="l00505"></a>00505       <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;x, <a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>, tmp-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>))
<a name="l00506"></a>00506          <span class="keywordflow">break</span>;
<a name="l00507"></a>00507    }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509    <span class="keywordflow">if</span> (tmp) {
<a name="l00510"></a>00510       <span class="keywordflow">if</span>(iks_find_with_attrib(pak-&gt;x, <span class="stringliteral">&quot;dtmf-method&quot;</span>, <span class="stringliteral">&quot;method&quot;</span>, <span class="stringliteral">&quot;rtp&quot;</span>)) {
<a name="l00511"></a>00511          <a class="code" href="chan__jingle_8c.html#aaff55fd50b50df0032b11b4ad22b9f3b">jingle_response</a>(client,pak,
<a name="l00512"></a>00512                <span class="stringliteral">&quot;feature-not-implemented xmlns=&apos;urn:ietf:params:xml:ns:xmpp-stanzas&apos;&quot;</span>,
<a name="l00513"></a>00513                <span class="stringliteral">&quot;unsupported-dtmf-method xmlns=&apos;http://www.xmpp.org/extensions/xep-0181.html#ns-errors&apos;&quot;</span>);
<a name="l00514"></a>00514          <span class="keywordflow">return</span> -1;
<a name="l00515"></a>00515       }
<a name="l00516"></a>00516       <span class="keywordflow">if</span> ((dtmfnode = iks_find(pak-&gt;x, <span class="stringliteral">&quot;dtmf&quot;</span>))) {
<a name="l00517"></a>00517          <span class="keywordflow">if</span>((dtmf = iks_find_attrib(dtmfnode, <span class="stringliteral">&quot;code&quot;</span>))) {
<a name="l00518"></a>00518             <span class="keywordflow">if</span>(iks_find_with_attrib(pak-&gt;x, <span class="stringliteral">&quot;dtmf&quot;</span>, <span class="stringliteral">&quot;action&quot;</span>, <span class="stringliteral">&quot;button-up&quot;</span>)) {
<a name="l00519"></a>00519                <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = {<a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a>, };
<a name="l00520"></a>00520                f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = dtmf[0];
<a name="l00521"></a>00521                <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, &amp;f);
<a name="l00522"></a>00522                <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;JINGLE! DTMF-relay event received: %c\n&quot;</span>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00523"></a>00523             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(iks_find_with_attrib(pak-&gt;x, <span class="stringliteral">&quot;dtmf&quot;</span>, <span class="stringliteral">&quot;action&quot;</span>, <span class="stringliteral">&quot;button-down&quot;</span>)) {
<a name="l00524"></a>00524                <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = {<a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>, };
<a name="l00525"></a>00525                f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = dtmf[0];
<a name="l00526"></a>00526                <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, &amp;f);
<a name="l00527"></a>00527                <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;JINGLE! DTMF-relay event received: %c\n&quot;</span>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00528"></a>00528             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(iks_find_attrib(pak-&gt;x, <span class="stringliteral">&quot;dtmf&quot;</span>)) { <span class="comment">/* 250 millasecond default */</span>
<a name="l00529"></a>00529                <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = {<a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>, };
<a name="l00530"></a>00530                f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = dtmf[0];
<a name="l00531"></a>00531                <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, &amp;f);
<a name="l00532"></a>00532                <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;JINGLE! DTMF-relay event received: %c\n&quot;</span>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00533"></a>00533             }
<a name="l00534"></a>00534          }
<a name="l00535"></a>00535       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((dtmfnode = iks_find_with_attrib(pak-&gt;x, <a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>, <span class="stringliteral">&quot;action&quot;</span>, <span class="stringliteral">&quot;session-info&quot;</span>))) {
<a name="l00536"></a>00536          <span class="keywordflow">if</span>((dtmfchild = iks_find(dtmfnode, <span class="stringliteral">&quot;dtmf&quot;</span>))) {
<a name="l00537"></a>00537             <span class="keywordflow">if</span>((dtmf = iks_find_attrib(dtmfchild, <span class="stringliteral">&quot;code&quot;</span>))) {
<a name="l00538"></a>00538                <span class="keywordflow">if</span>(iks_find_with_attrib(dtmfnode, <span class="stringliteral">&quot;dtmf&quot;</span>, <span class="stringliteral">&quot;action&quot;</span>, <span class="stringliteral">&quot;button-up&quot;</span>)) {
<a name="l00539"></a>00539                   <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = {<a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>, };
<a name="l00540"></a>00540                   f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = dtmf[0];
<a name="l00541"></a>00541                   <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, &amp;f);
<a name="l00542"></a>00542                   <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;JINGLE! DTMF-relay event received: %c\n&quot;</span>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00543"></a>00543                } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(iks_find_with_attrib(dtmfnode, <span class="stringliteral">&quot;dtmf&quot;</span>, <span class="stringliteral">&quot;action&quot;</span>, <span class="stringliteral">&quot;button-down&quot;</span>)) {
<a name="l00544"></a>00544                   <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = {<a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a>, };
<a name="l00545"></a>00545                   f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = dtmf[0];
<a name="l00546"></a>00546                   <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, &amp;f);
<a name="l00547"></a>00547                   <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;JINGLE! DTMF-relay event received: %c\n&quot;</span>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00548"></a>00548                }
<a name="l00549"></a>00549             }
<a name="l00550"></a>00550          }
<a name="l00551"></a>00551       }
<a name="l00552"></a>00552       <a class="code" href="chan__jingle_8c.html#aaff55fd50b50df0032b11b4ad22b9f3b">jingle_response</a>(client, pak, NULL, NULL);
<a name="l00553"></a>00553       <span class="keywordflow">return</span> 1;
<a name="l00554"></a>00554    } <span class="keywordflow">else</span>
<a name="l00555"></a>00555       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Whoa, didn&apos;t find call!\n&quot;</span>);
<a name="l00556"></a>00556 
<a name="l00557"></a>00557    <a class="code" href="chan__jingle_8c.html#aaff55fd50b50df0032b11b4ad22b9f3b">jingle_response</a>(client, pak, NULL, NULL);
<a name="l00558"></a>00558    <span class="keywordflow">return</span> 1;
<a name="l00559"></a>00559 }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561 
<a name="l00562"></a><a class="code" href="chan__jingle_8c.html#a978d85fda394a28219d944dfec8982bc">00562</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a978d85fda394a28219d944dfec8982bc">jingle_hangup_farend</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, ikspak *pak)
<a name="l00563"></a>00563 {
<a name="l00564"></a>00564    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *tmp;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;The client is %s\n&quot;</span>, client-&gt;name);
<a name="l00567"></a>00567    <span class="comment">/* Make sure our new call doesn&apos;t exist yet */</span>
<a name="l00568"></a>00568    <span class="keywordflow">for</span> (tmp = client-&gt;<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a>; tmp; tmp = tmp-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a>) {
<a name="l00569"></a>00569       <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;x, <a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>, tmp-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>))
<a name="l00570"></a>00570          <span class="keywordflow">break</span>;
<a name="l00571"></a>00571    }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573    <span class="keywordflow">if</span> (tmp) {
<a name="l00574"></a>00574       tmp-&gt;<a class="code" href="structjingle__pvt.html#ac43993a73742eff145b861107a1afa0d">alreadygone</a> = 1;
<a name="l00575"></a>00575       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)
<a name="l00576"></a>00576          <a class="code" href="channel_8h.html#a30bcf0418189567bc84ff32034f79f28" title="Queue a hangup frame.">ast_queue_hangup</a>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>);
<a name="l00577"></a>00577    } <span class="keywordflow">else</span>
<a name="l00578"></a>00578       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Whoa, didn&apos;t find call!\n&quot;</span>);
<a name="l00579"></a>00579    <a class="code" href="chan__jingle_8c.html#aaff55fd50b50df0032b11b4ad22b9f3b">jingle_response</a>(client, pak, NULL, NULL);
<a name="l00580"></a>00580    <span class="keywordflow">return</span> 1;
<a name="l00581"></a>00581 }
<a name="l00582"></a>00582 
<a name="l00583"></a><a class="code" href="chan__jingle_8c.html#adccb2b493f7c932700d619647281d686">00583</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#adccb2b493f7c932700d619647281d686">jingle_create_candidates</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, <span class="keyword">struct</span> <a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p, <span class="keywordtype">char</span> *<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>, <span class="keywordtype">char</span> *from)
<a name="l00584"></a>00584 {
<a name="l00585"></a>00585    <span class="keyword">struct </span><a class="code" href="structjingle__candidate.html">jingle_candidate</a> *tmp;
<a name="l00586"></a>00586    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *c = client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>;
<a name="l00587"></a>00587    <span class="keyword">struct </span><a class="code" href="structjingle__candidate.html">jingle_candidate</a> *ours1 = NULL, *ours2 = NULL;
<a name="l00588"></a>00588    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l00589"></a>00589    <span class="keyword">struct </span>sockaddr_in dest;
<a name="l00590"></a>00590    <span class="keyword">struct </span>in_addr us;
<a name="l00591"></a>00591    <span class="keyword">struct </span>in_addr externaddr;
<a name="l00592"></a>00592    iks *iq, *<a class="code" href="structjingle.html">jingle</a>, *content, *transport, *candidate;
<a name="l00593"></a>00593    <span class="keywordtype">char</span> component[16], foundation[16], generation[16], network[16], <a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>[16], port[7], priority[16], <a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>[16];
<a name="l00594"></a>00594 
<a name="l00595"></a>00595 
<a name="l00596"></a>00596    iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l00597"></a>00597    jingle = iks_new(<a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>);
<a name="l00598"></a>00598    content = iks_new(<span class="stringliteral">&quot;content&quot;</span>);
<a name="l00599"></a>00599    transport = iks_new(<span class="stringliteral">&quot;transport&quot;</span>);
<a name="l00600"></a>00600    candidate = iks_new(<span class="stringliteral">&quot;candidate&quot;</span>);
<a name="l00601"></a>00601    <span class="keywordflow">if</span> (!iq || !jingle || !content || !transport || !candidate) {
<a name="l00602"></a>00602       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error\n&quot;</span>);
<a name="l00603"></a>00603       <span class="keywordflow">goto</span> safeout;
<a name="l00604"></a>00604    }
<a name="l00605"></a>00605    ours1 = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*ours1));
<a name="l00606"></a>00606    ours2 = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*ours2));
<a name="l00607"></a>00607    <span class="keywordflow">if</span> (!ours1 || !ours2)
<a name="l00608"></a>00608       <span class="keywordflow">goto</span> safeout;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610    iks_insert_node(iq, jingle);
<a name="l00611"></a>00611    iks_insert_node(jingle, content);
<a name="l00612"></a>00612    iks_insert_node(content, transport);
<a name="l00613"></a>00613    iks_insert_node(transport, candidate);
<a name="l00614"></a>00614 
<a name="l00615"></a>00615    <span class="keywordflow">for</span> (; p; p = p-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a>) {
<a name="l00616"></a>00616       <span class="keywordflow">if</span> (!strcasecmp(p-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>, sid))
<a name="l00617"></a>00617          <span class="keywordflow">break</span>;
<a name="l00618"></a>00618    }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620    <span class="keywordflow">if</span> (!p) {
<a name="l00621"></a>00621       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No matching jingle session - SID %s!\n&quot;</span>, sid);
<a name="l00622"></a>00622       <span class="keywordflow">goto</span> safeout;
<a name="l00623"></a>00623    }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625    <a class="code" href="rtp_8h.html#a307269685e6f067a6abe35a184c3bae6">ast_rtp_get_us</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>, &amp;sin);
<a name="l00626"></a>00626    <a class="code" href="acl_8h.html#a4fbb9258573d41461c7389afbcbba377">ast_find_ourip</a>(&amp;us, bindaddr);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628    <span class="comment">/* Setup our first jingle candidate */</span>
<a name="l00629"></a>00629    ours1-&gt;<a class="code" href="structjingle__candidate.html#a55bf24e79eaef69b16885c69adee1a6a">component</a> = 1;
<a name="l00630"></a>00630    ours1-&gt;<a class="code" href="structjingle__candidate.html#a1abf825b4c3b776e47853a1037b0cf17">foundation</a> = (<span class="keywordtype">unsigned</span> int)bindaddr.sin_addr.s_addr | <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964afc7bbb745763ffe4069a28ffc61989de">AJI_CONNECT_HOST</a> | <a class="code" href="chan__gtalk_8c.html#a4735ec2011c291c5213a858fe007c851ac913daa556e052c68933b9c428707ee3">AJI_PROTOCOL_UDP</a>;
<a name="l00631"></a>00631    ours1-&gt;<a class="code" href="structjingle__candidate.html#aca2885db1fed1f8fe3fee29caa90e292">generation</a> = 0;
<a name="l00632"></a>00632    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(ours1-&gt;<a class="code" href="structjingle__candidate.html#ac03ec605186c0c6d17c4beaab73d615c">ip</a>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(us), <span class="keyword">sizeof</span>(ours1-&gt;<a class="code" href="structjingle__candidate.html#ac03ec605186c0c6d17c4beaab73d615c">ip</a>));
<a name="l00633"></a>00633    ours1-&gt;<a class="code" href="structjingle__candidate.html#adabbfd79a2d8ac3935245cd061f045b2">network</a> = 0;
<a name="l00634"></a>00634    ours1-&gt;<a class="code" href="structjingle__candidate.html#a938bdc6ae46c346147b6d4f67ad1e704">port</a> = ntohs(sin.sin_port);
<a name="l00635"></a>00635    ours1-&gt;<a class="code" href="structjingle__candidate.html#a1e440af9e86f7a3c2784c3e2bd687d25">priority</a> = 1678246398;
<a name="l00636"></a>00636    ours1-&gt;<a class="code" href="structjingle__candidate.html#a78d25527095fa65cb6f62d3b25e26cd2">protocol</a> = <a class="code" href="chan__gtalk_8c.html#a4735ec2011c291c5213a858fe007c851ac913daa556e052c68933b9c428707ee3">AJI_PROTOCOL_UDP</a>;
<a name="l00637"></a>00637    snprintf(pass, <span class="keyword">sizeof</span>(pass), <span class="stringliteral">&quot;%08lx%08lx&quot;</span>, <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>(), <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l00638"></a>00638    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(ours1-&gt;<a class="code" href="structjingle__candidate.html#a20218b63ca6f0a6ce74d704d915cb90a">password</a>, pass, <span class="keyword">sizeof</span>(ours1-&gt;<a class="code" href="structjingle__candidate.html#a20218b63ca6f0a6ce74d704d915cb90a">password</a>));
<a name="l00639"></a>00639    ours1-&gt;<a class="code" href="structjingle__candidate.html#af24b2d40de5e44ddf3e38e1b2821b619">type</a> = <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964afc7bbb745763ffe4069a28ffc61989de">AJI_CONNECT_HOST</a>;
<a name="l00640"></a>00640    snprintf(user, <span class="keyword">sizeof</span>(user), <span class="stringliteral">&quot;%08lx%08lx&quot;</span>, <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>(), <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l00641"></a>00641    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(ours1-&gt;<a class="code" href="structjingle__candidate.html#a419e5addc503b21ab58e8229ccf2256b">ufrag</a>, user, <span class="keyword">sizeof</span>(ours1-&gt;<a class="code" href="structjingle__candidate.html#a419e5addc503b21ab58e8229ccf2256b">ufrag</a>));
<a name="l00642"></a>00642    p-&gt;<a class="code" href="structjingle__pvt.html#a9c80666d44c369110e80d0a57be3deaa">ourcandidates</a> = ours1;
<a name="l00643"></a>00643 
<a name="l00644"></a>00644    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(externip)) {
<a name="l00645"></a>00645       <span class="comment">/* XXX We should really stun for this one not just go with externip XXX */</span>
<a name="l00646"></a>00646       <span class="keywordflow">if</span> (inet_aton(externip, &amp;externaddr))
<a name="l00647"></a>00647          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid extern IP : %s\n&quot;</span>, externip);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649       ours2-&gt;component = 1;
<a name="l00650"></a>00650       ours2-&gt;foundation = (<span class="keywordtype">unsigned</span> int)externaddr.s_addr | <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964a865ab2dd828faf9586858725a8bb6e78">AJI_CONNECT_PRFLX</a> | <a class="code" href="chan__gtalk_8c.html#a4735ec2011c291c5213a858fe007c851ac913daa556e052c68933b9c428707ee3">AJI_PROTOCOL_UDP</a>;
<a name="l00651"></a>00651       ours2-&gt;generation = 0;
<a name="l00652"></a>00652       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(ours2-&gt;ip, externip, <span class="keyword">sizeof</span>(ours2-&gt;ip));
<a name="l00653"></a>00653       ours2-&gt;network = 0;
<a name="l00654"></a>00654       ours2-&gt;port = ntohs(sin.sin_port);
<a name="l00655"></a>00655       ours2-&gt;priority = 1678246397;
<a name="l00656"></a>00656       ours2-&gt;protocol = <a class="code" href="chan__gtalk_8c.html#a4735ec2011c291c5213a858fe007c851ac913daa556e052c68933b9c428707ee3">AJI_PROTOCOL_UDP</a>;
<a name="l00657"></a>00657       snprintf(pass, <span class="keyword">sizeof</span>(pass), <span class="stringliteral">&quot;%08lx%08lx&quot;</span>, <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>(), <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l00658"></a>00658       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(ours2-&gt;password, pass, <span class="keyword">sizeof</span>(ours2-&gt;password));
<a name="l00659"></a>00659       ours2-&gt;type = <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964a865ab2dd828faf9586858725a8bb6e78">AJI_CONNECT_PRFLX</a>;
<a name="l00660"></a>00660 
<a name="l00661"></a>00661       snprintf(user, <span class="keyword">sizeof</span>(user), <span class="stringliteral">&quot;%08lx%08lx&quot;</span>, <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>(), <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l00662"></a>00662       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(ours2-&gt;ufrag, user, <span class="keyword">sizeof</span>(ours2-&gt;ufrag));
<a name="l00663"></a>00663       ours1-&gt;<a class="code" href="structjingle__candidate.html#a345235cfff36c891ac94d7ea9a42a117">next</a> = ours2;
<a name="l00664"></a>00664       ours2 = NULL;
<a name="l00665"></a>00665    }
<a name="l00666"></a>00666    ours1 = NULL;
<a name="l00667"></a>00667    dest.sin_addr = <a class="code" href="chan__jingle_8c.html#a1d084b82cb21102ba46ea60d3cd9c085">__ourip</a>;
<a name="l00668"></a>00668    dest.sin_port = sin.sin_port;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670 
<a name="l00671"></a>00671    <span class="keywordflow">for</span> (tmp = p-&gt;<a class="code" href="structjingle__pvt.html#a9c80666d44c369110e80d0a57be3deaa">ourcandidates</a>; tmp; tmp = tmp-&gt;<a class="code" href="structjingle__candidate.html#a345235cfff36c891ac94d7ea9a42a117">next</a>) {
<a name="l00672"></a>00672       snprintf(component, <span class="keyword">sizeof</span>(component), <span class="stringliteral">&quot;%u&quot;</span>, tmp-&gt;<a class="code" href="structjingle__candidate.html#a55bf24e79eaef69b16885c69adee1a6a">component</a>);
<a name="l00673"></a>00673       snprintf(foundation, <span class="keyword">sizeof</span>(foundation), <span class="stringliteral">&quot;%u&quot;</span>, tmp-&gt;<a class="code" href="structjingle__candidate.html#a1abf825b4c3b776e47853a1037b0cf17">foundation</a>);
<a name="l00674"></a>00674       snprintf(generation, <span class="keyword">sizeof</span>(generation), <span class="stringliteral">&quot;%u&quot;</span>, tmp-&gt;<a class="code" href="structjingle__candidate.html#aca2885db1fed1f8fe3fee29caa90e292">generation</a>);
<a name="l00675"></a>00675       snprintf(network, <span class="keyword">sizeof</span>(network), <span class="stringliteral">&quot;%u&quot;</span>, tmp-&gt;<a class="code" href="structjingle__candidate.html#adabbfd79a2d8ac3935245cd061f045b2">network</a>);
<a name="l00676"></a>00676       snprintf(port, <span class="keyword">sizeof</span>(port), <span class="stringliteral">&quot;%u&quot;</span>, tmp-&gt;<a class="code" href="structjingle__candidate.html#a938bdc6ae46c346147b6d4f67ad1e704">port</a>);
<a name="l00677"></a>00677       snprintf(priority, <span class="keyword">sizeof</span>(priority), <span class="stringliteral">&quot;%u&quot;</span>, tmp-&gt;<a class="code" href="structjingle__candidate.html#a1e440af9e86f7a3c2784c3e2bd687d25">priority</a>);
<a name="l00678"></a>00678 
<a name="l00679"></a>00679       iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, c-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l00680"></a>00680       iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, from);
<a name="l00681"></a>00681       iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;set&quot;</span>);
<a name="l00682"></a>00682       iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, c-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l00683"></a>00683       <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(c-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l00684"></a>00684       iks_insert_attrib(jingle, <span class="stringliteral">&quot;action&quot;</span>, <a class="code" href="jingle_8h.html#a277775bf41c7046d80633540e35eb44a">JINGLE_NEGOTIATE</a>);
<a name="l00685"></a>00685       iks_insert_attrib(jingle, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>, sid);
<a name="l00686"></a>00686       iks_insert_attrib(jingle, <span class="stringliteral">&quot;initiator&quot;</span>, (p-&gt;<a class="code" href="structjingle__pvt.html#ad65c66f9895c8d58b388365ac363e91c">initiator</a>) ? c-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full : from);
<a name="l00687"></a>00687       iks_insert_attrib(jingle, <span class="stringliteral">&quot;xmlns&quot;</span>, <a class="code" href="jingle_8h.html#aea60c021ce1b84cb1e3fb03c325bf29d">JINGLE_NS</a>);
<a name="l00688"></a>00688       iks_insert_attrib(content, <span class="stringliteral">&quot;creator&quot;</span>, p-&gt;<a class="code" href="structjingle__pvt.html#ad65c66f9895c8d58b388365ac363e91c">initiator</a> ? <span class="stringliteral">&quot;initiator&quot;</span> : <span class="stringliteral">&quot;responder&quot;</span>);
<a name="l00689"></a>00689       iks_insert_attrib(content, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;asterisk-audio-content&quot;</span>);
<a name="l00690"></a>00690       iks_insert_attrib(transport, <span class="stringliteral">&quot;xmlns&quot;</span>, <a class="code" href="jingle_8h.html#aff2e284f7794a901c712191ecb6908d1">JINGLE_ICE_UDP_NS</a>);
<a name="l00691"></a>00691       iks_insert_attrib(candidate, <span class="stringliteral">&quot;component&quot;</span>, component);
<a name="l00692"></a>00692       iks_insert_attrib(candidate, <span class="stringliteral">&quot;foundation&quot;</span>, foundation);
<a name="l00693"></a>00693       iks_insert_attrib(candidate, <span class="stringliteral">&quot;generation&quot;</span>, generation);
<a name="l00694"></a>00694       iks_insert_attrib(candidate, <span class="stringliteral">&quot;ip&quot;</span>, tmp-&gt;<a class="code" href="structjingle__candidate.html#ac03ec605186c0c6d17c4beaab73d615c">ip</a>);
<a name="l00695"></a>00695       iks_insert_attrib(candidate, <span class="stringliteral">&quot;network&quot;</span>, network);
<a name="l00696"></a>00696       iks_insert_attrib(candidate, <span class="stringliteral">&quot;port&quot;</span>, port);
<a name="l00697"></a>00697       iks_insert_attrib(candidate, <span class="stringliteral">&quot;priority&quot;</span>, priority);
<a name="l00698"></a>00698       <span class="keywordflow">switch</span> (tmp-&gt;<a class="code" href="structjingle__candidate.html#a78d25527095fa65cb6f62d3b25e26cd2">protocol</a>) {
<a name="l00699"></a>00699       <span class="keywordflow">case</span> <a class="code" href="chan__gtalk_8c.html#a4735ec2011c291c5213a858fe007c851ac913daa556e052c68933b9c428707ee3">AJI_PROTOCOL_UDP</a>:
<a name="l00700"></a>00700          iks_insert_attrib(candidate, <span class="stringliteral">&quot;protocol&quot;</span>, <span class="stringliteral">&quot;udp&quot;</span>);
<a name="l00701"></a>00701          <span class="keywordflow">break</span>;
<a name="l00702"></a>00702       <span class="keywordflow">case</span> <a class="code" href="chan__gtalk_8c.html#a4735ec2011c291c5213a858fe007c851a8d65aeba8254d08131b4672b7a06221c">AJI_PROTOCOL_SSLTCP</a>:
<a name="l00703"></a>00703          iks_insert_attrib(candidate, <span class="stringliteral">&quot;protocol&quot;</span>, <span class="stringliteral">&quot;ssltcp&quot;</span>);
<a name="l00704"></a>00704          <span class="keywordflow">break</span>;
<a name="l00705"></a>00705       }
<a name="l00706"></a>00706       iks_insert_attrib(candidate, <span class="stringliteral">&quot;pwd&quot;</span>, tmp-&gt;<a class="code" href="structjingle__candidate.html#a20218b63ca6f0a6ce74d704d915cb90a">password</a>);
<a name="l00707"></a>00707       <span class="keywordflow">switch</span> (tmp-&gt;<a class="code" href="structjingle__candidate.html#af24b2d40de5e44ddf3e38e1b2821b619">type</a>) {
<a name="l00708"></a>00708       <span class="keywordflow">case</span> <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964afc7bbb745763ffe4069a28ffc61989de">AJI_CONNECT_HOST</a>:
<a name="l00709"></a>00709          iks_insert_attrib(candidate, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;host&quot;</span>);
<a name="l00710"></a>00710          <span class="keywordflow">break</span>;
<a name="l00711"></a>00711       <span class="keywordflow">case</span> <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964a865ab2dd828faf9586858725a8bb6e78">AJI_CONNECT_PRFLX</a>:
<a name="l00712"></a>00712          iks_insert_attrib(candidate, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;prflx&quot;</span>);
<a name="l00713"></a>00713          <span class="keywordflow">break</span>;
<a name="l00714"></a>00714       <span class="keywordflow">case</span> <a class="code" href="chan__gtalk_8c.html#aabf7ea7d1c280c2d91d5ad67ea5ab883a2ef123abfa8253ea9f67f7750dbdc421">AJI_CONNECT_RELAY</a>:
<a name="l00715"></a>00715          iks_insert_attrib(candidate, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;relay&quot;</span>);
<a name="l00716"></a>00716          <span class="keywordflow">break</span>;
<a name="l00717"></a>00717       <span class="keywordflow">case</span> <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964a1dfde46e9cdd8b227e1ccb83579d0b90">AJI_CONNECT_SRFLX</a>:
<a name="l00718"></a>00718          iks_insert_attrib(candidate, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;srflx&quot;</span>);
<a name="l00719"></a>00719          <span class="keywordflow">break</span>;
<a name="l00720"></a>00720       }
<a name="l00721"></a>00721       iks_insert_attrib(candidate, <span class="stringliteral">&quot;ufrag&quot;</span>, tmp-&gt;<a class="code" href="structjingle__candidate.html#a419e5addc503b21ab58e8229ccf2256b">ufrag</a>);
<a name="l00722"></a>00722 
<a name="l00723"></a>00723       <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(c, iq);
<a name="l00724"></a>00724    }
<a name="l00725"></a>00725    p-&gt;<a class="code" href="structjingle__pvt.html#afea13c69c31226a6607e67b85f0231e2">laststun</a> = 0;
<a name="l00726"></a>00726 
<a name="l00727"></a>00727 safeout:
<a name="l00728"></a>00728    <span class="keywordflow">if</span> (ours1)
<a name="l00729"></a>00729       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ours1);
<a name="l00730"></a>00730    <span class="keywordflow">if</span> (ours2)
<a name="l00731"></a>00731       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ours2);
<a name="l00732"></a>00732    iks_delete(iq);
<a name="l00733"></a>00733    iks_delete(jingle);
<a name="l00734"></a>00734    iks_delete(content);
<a name="l00735"></a>00735    iks_delete(transport);
<a name="l00736"></a>00736    iks_delete(candidate);
<a name="l00737"></a>00737 
<a name="l00738"></a>00738    <span class="keywordflow">return</span> 1;
<a name="l00739"></a>00739 }
<a name="l00740"></a>00740 
<a name="l00741"></a><a class="code" href="chan__jingle_8c.html#ad444b828242ff0e8e380b1fe9037fbac">00741</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *<a class="code" href="chan__jingle_8c.html#ad444b828242ff0e8e380b1fe9037fbac">jingle_alloc</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, <span class="keyword">const</span> <span class="keywordtype">char</span> *from, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>)
<a name="l00742"></a>00742 {
<a name="l00743"></a>00743    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *tmp = NULL;
<a name="l00744"></a>00744    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *resources = NULL;
<a name="l00745"></a>00745    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy;
<a name="l00746"></a>00746    <span class="keywordtype">char</span> idroster[200];
<a name="l00747"></a>00747 
<a name="l00748"></a>00748    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;The client is %s for alloc\n&quot;</span>, client-&gt;name);
<a name="l00749"></a>00749    <span class="keywordflow">if</span> (!sid &amp;&amp; !strchr(from, <span class="charliteral">&apos;/&apos;</span>)) {   <span class="comment">/* I started call! */</span>
<a name="l00750"></a>00750       <span class="keywordflow">if</span> (!strcasecmp(client-&gt;name, <span class="stringliteral">&quot;guest&quot;</span>)) {
<a name="l00751"></a>00751          buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, from);
<a name="l00752"></a>00752          <span class="keywordflow">if</span> (buddy)
<a name="l00753"></a>00753             resources = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l00754"></a>00754       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structjingle.html#a2704a75322ea2a93cfbfd9ba4d08dad6">buddy</a>)
<a name="l00755"></a>00755          resources = client-&gt;<a class="code" href="structjingle.html#a2704a75322ea2a93cfbfd9ba4d08dad6">buddy</a>-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l00756"></a>00756       <span class="keywordflow">while</span> (resources) {
<a name="l00757"></a>00757          <span class="keywordflow">if</span> (resources-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a>) {
<a name="l00758"></a>00758             <span class="keywordflow">break</span>;
<a name="l00759"></a>00759          }
<a name="l00760"></a>00760          resources = resources-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l00761"></a>00761       }
<a name="l00762"></a>00762       <span class="keywordflow">if</span> (resources)
<a name="l00763"></a>00763          snprintf(idroster, <span class="keyword">sizeof</span>(idroster), <span class="stringliteral">&quot;%s/%s&quot;</span>, from, resources-&gt;<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>);
<a name="l00764"></a>00764       <span class="keywordflow">else</span> {
<a name="l00765"></a>00765          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;no jingle capable clients to talk to.\n&quot;</span>);
<a name="l00766"></a>00766          <span class="keywordflow">return</span> NULL;
<a name="l00767"></a>00767       }
<a name="l00768"></a>00768    }
<a name="l00769"></a>00769    <span class="keywordflow">if</span> (!(tmp = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tmp)))) {
<a name="l00770"></a>00770       <span class="keywordflow">return</span> NULL;
<a name="l00771"></a>00771    }
<a name="l00772"></a>00772 
<a name="l00773"></a>00773    memcpy(&amp;tmp-&gt;<a class="code" href="structjingle__pvt.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, &amp;client-&gt;<a class="code" href="structjingle.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>));
<a name="l00774"></a>00774 
<a name="l00775"></a>00775    <span class="keywordflow">if</span> (sid) {
<a name="l00776"></a>00776       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>, sid, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>));
<a name="l00777"></a>00777       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>, from, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>));
<a name="l00778"></a>00778    } <span class="keywordflow">else</span> {
<a name="l00779"></a>00779       snprintf(tmp-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>), <span class="stringliteral">&quot;%08lx%08lx&quot;</span>, <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>(), <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l00780"></a>00780       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>, idroster, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>));
<a name="l00781"></a>00781       tmp-&gt;<a class="code" href="structjingle__pvt.html#ad65c66f9895c8d58b388365ac363e91c">initiator</a> = 1;
<a name="l00782"></a>00782    }
<a name="l00783"></a>00783    tmp-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a> = <a class="code" href="rtp_8h.html#a10d5296cd50be78954103b0a0c754640" title="Initializate a RTP session using an in_addr structure.">ast_rtp_new_with_bindaddr</a>(sched, io, 1, 0, bindaddr.sin_addr);
<a name="l00784"></a>00784    tmp-&gt;<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a> = client;
<a name="l00785"></a>00785    <span class="keywordflow">if</span> (!tmp-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>) {
<a name="l00786"></a>00786       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of RTP sessions?\n&quot;</span>);
<a name="l00787"></a>00787       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l00788"></a>00788       <span class="keywordflow">return</span> NULL;
<a name="l00789"></a>00789    }
<a name="l00790"></a>00790    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a1a25ab316fdbfb7a045251cf4d1f9b0f">exten</a>, <span class="stringliteral">&quot;s&quot;</span>, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structjingle__pvt.html#a1a25ab316fdbfb7a045251cf4d1f9b0f">exten</a>));
<a name="l00791"></a>00791    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;tmp-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00792"></a>00792    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;jinglelock);
<a name="l00793"></a>00793    tmp-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a> = client-&gt;<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a>;
<a name="l00794"></a>00794    client-&gt;<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a> = tmp;
<a name="l00795"></a>00795    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;jinglelock);
<a name="l00796"></a>00796    <span class="keywordflow">return</span> tmp;
<a name="l00797"></a>00797 }
<a name="l00798"></a>00798 <span class="comment"></span>
<a name="l00799"></a>00799 <span class="comment">/*! \brief Start new jingle channel */</span>
<a name="l00800"></a><a class="code" href="chan__jingle_8c.html#aa87eec48e0d0a7bea213d2d1aba90a2f">00800</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__jingle_8c.html#aa87eec48e0d0a7bea213d2d1aba90a2f" title="Start new jingle channel.">jingle_new</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, <span class="keyword">struct</span> <a class="code" href="structjingle__pvt.html">jingle_pvt</a> *i, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *title)
<a name="l00801"></a>00801 {
<a name="l00802"></a>00802    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *tmp;
<a name="l00803"></a>00803    <span class="keywordtype">int</span> fmt;
<a name="l00804"></a>00804    <span class="keywordtype">int</span> what;
<a name="l00805"></a>00805    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>;
<a name="l00806"></a>00806 
<a name="l00807"></a>00807    <span class="keywordflow">if</span> (title)
<a name="l00808"></a>00808       str = title;
<a name="l00809"></a>00809    <span class="keywordflow">else</span>
<a name="l00810"></a>00810       str = i-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>;
<a name="l00811"></a>00811    tmp = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(1, state, i-&gt;<a class="code" href="structjingle__pvt.html#a7b41ba5c947adf528a0615b688a4c5d1">cid_num</a>, i-&gt;<a class="code" href="structjingle__pvt.html#abeca50433a6b06e370cf0aacb8af5444">cid_name</a>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Jingle/%s-%04lx&quot;</span>, str, <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() &amp; 0xffff);
<a name="l00812"></a>00812    <span class="keywordflow">if</span> (!tmp) {
<a name="l00813"></a>00813       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate Jingle channel structure!\n&quot;</span>);
<a name="l00814"></a>00814       <span class="keywordflow">return</span> NULL;
<a name="l00815"></a>00815    }
<a name="l00816"></a>00816    tmp-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a> = &amp;jingle_tech;
<a name="l00817"></a>00817 
<a name="l00818"></a>00818    <span class="comment">/* Select our native format based on codec preference until we receive</span>
<a name="l00819"></a>00819 <span class="comment">      something from another device to the contrary. */</span>
<a name="l00820"></a>00820    <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structjingle__pvt.html#a38f5730c90d9315eb1c0df6cfdc37da6">jointcapability</a>)
<a name="l00821"></a>00821       what = i-&gt;<a class="code" href="structjingle__pvt.html#a38f5730c90d9315eb1c0df6cfdc37da6">jointcapability</a>;
<a name="l00822"></a>00822    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structjingle__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>)
<a name="l00823"></a>00823       what = i-&gt;<a class="code" href="structjingle__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;
<a name="l00824"></a>00824    <span class="keywordflow">else</span>
<a name="l00825"></a>00825       what = global_capability;
<a name="l00826"></a>00826 
<a name="l00827"></a>00827    <span class="comment">/* Set Frame packetization */</span>
<a name="l00828"></a>00828    <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>)
<a name="l00829"></a>00829       <a class="code" href="rtp_8h.html#ae6a1acd75aaf08afc6954bd5ac671c6a" title="Set codec preference.">ast_rtp_codec_setpref</a>(i-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>, &amp;i-&gt;<a class="code" href="structjingle__pvt.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>);
<a name="l00830"></a>00830 
<a name="l00831"></a>00831    tmp-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> = <a class="code" href="frame_8h.html#a123ec7e6e90e279b75bc6447eab5d3b2" title="Select the best audio format according to preference list from supplied options....">ast_codec_choose</a>(&amp;i-&gt;<a class="code" href="structjingle__pvt.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, what, 1) | (i-&gt;<a class="code" href="structjingle__pvt.html#a38f5730c90d9315eb1c0df6cfdc37da6">jointcapability</a> &amp; <a class="code" href="frame_8h.html#ad048231af8a6271706585e3c8630dc69">AST_FORMAT_VIDEO_MASK</a>);
<a name="l00832"></a>00832    fmt = <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(tmp-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>);
<a name="l00833"></a>00833 
<a name="l00834"></a>00834    <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>) {
<a name="l00835"></a>00835       <a class="code" href="channel_8h.html#aca37ca2f3d55a223d26617329ed48a3e">ast_channel_set_fd</a>(tmp, 0, <a class="code" href="rtp_8h.html#a9a990d85fb0aac29bda48777f0f86108">ast_rtp_fd</a>(i-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>));
<a name="l00836"></a>00836       <a class="code" href="channel_8h.html#aca37ca2f3d55a223d26617329ed48a3e">ast_channel_set_fd</a>(tmp, 1, <a class="code" href="rtp_8h.html#ac3e115dfd0bfe82479060b55dd41601f">ast_rtcp_fd</a>(i-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>));
<a name="l00837"></a>00837    }
<a name="l00838"></a>00838    <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structjingle__pvt.html#a65e8f978abd3f0206026969c627200a9">vrtp</a>) {
<a name="l00839"></a>00839       <a class="code" href="channel_8h.html#aca37ca2f3d55a223d26617329ed48a3e">ast_channel_set_fd</a>(tmp, 2, <a class="code" href="rtp_8h.html#a9a990d85fb0aac29bda48777f0f86108">ast_rtp_fd</a>(i-&gt;<a class="code" href="structjingle__pvt.html#a65e8f978abd3f0206026969c627200a9">vrtp</a>));
<a name="l00840"></a>00840       <a class="code" href="channel_8h.html#aca37ca2f3d55a223d26617329ed48a3e">ast_channel_set_fd</a>(tmp, 3, <a class="code" href="rtp_8h.html#ac3e115dfd0bfe82479060b55dd41601f">ast_rtcp_fd</a>(i-&gt;<a class="code" href="structjingle__pvt.html#a65e8f978abd3f0206026969c627200a9">vrtp</a>));
<a name="l00841"></a>00841    }
<a name="l00842"></a>00842    <span class="keywordflow">if</span> (state == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>)
<a name="l00843"></a>00843       tmp-&gt;<a class="code" href="structast__channel.html#a358fd14658a0c5276190e48f1b1f251a">rings</a> = 1;
<a name="l00844"></a>00844    tmp-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> = <a class="code" href="channel_8h.html#a828f537544a2ad2352c56c078390a0bda5f0673b46cfdba3094393b3fbce084ff">AST_ADSI_UNAVAILABLE</a>;
<a name="l00845"></a>00845    tmp-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = fmt;
<a name="l00846"></a>00846    tmp-&gt;<a class="code" href="structast__channel.html#a045b6dfdee84adceb7e86b6c5c4f9a86">rawwriteformat</a> = fmt;
<a name="l00847"></a>00847    tmp-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = fmt;
<a name="l00848"></a>00848    tmp-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a> = fmt;
<a name="l00849"></a>00849    tmp-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = i;
<a name="l00850"></a>00850 
<a name="l00851"></a>00851    tmp-&gt;<a class="code" href="structast__channel.html#af0f007b48a9c8cf0629428bd0483e0d1">callgroup</a> = client-&gt;<a class="code" href="structjingle.html#af0f007b48a9c8cf0629428bd0483e0d1">callgroup</a>;
<a name="l00852"></a>00852    tmp-&gt;<a class="code" href="structast__channel.html#abc0651bcec68410023c036b7d8ec4d11">pickupgroup</a> = client-&gt;<a class="code" href="structjingle.html#abc0651bcec68410023c036b7d8ec4d11">pickupgroup</a>;
<a name="l00853"></a>00853    tmp-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a5674af3fa5ce1dd1fe052be1477d4110">cid_pres</a> = client-&gt;<a class="code" href="structjingle.html#abd29b99884a9fc8a54fc021555190fb8">callingpres</a>;
<a name="l00854"></a>00854    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(client-&gt;<a class="code" href="structjingle.html#adfee50d07a98645d4d20b896ce03785a">accountcode</a>))
<a name="l00855"></a>00855       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, <a class="code" href="chan__iax2_8c.html#adfee50d07a98645d4d20b896ce03785a">accountcode</a>, client-&gt;<a class="code" href="structjingle.html#adfee50d07a98645d4d20b896ce03785a">accountcode</a>);
<a name="l00856"></a>00856    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structjingle.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>)
<a name="l00857"></a>00857       tmp-&gt;<a class="code" href="structast__channel.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a> = client-&gt;<a class="code" href="structjingle.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>;
<a name="l00858"></a>00858    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(client-&gt;<a class="code" href="structjingle.html#adf416dc058363e2fd5750c77e2d78bee">language</a>))
<a name="l00859"></a>00859       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, <a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>, client-&gt;<a class="code" href="structjingle.html#adf416dc058363e2fd5750c77e2d78bee">language</a>);
<a name="l00860"></a>00860    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(client-&gt;<a class="code" href="structjingle.html#abc34958c9b03014779727e5ca61b93e5">musicclass</a>))
<a name="l00861"></a>00861       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, <a class="code" href="chan__mgcp_8c.html#abc34958c9b03014779727e5ca61b93e5">musicclass</a>, client-&gt;<a class="code" href="structjingle.html#abc34958c9b03014779727e5ca61b93e5">musicclass</a>);
<a name="l00862"></a>00862    i-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = tmp;
<a name="l00863"></a>00863    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, client-&gt;<a class="code" href="structjingle.html#aab27e7175d9a6d62b18d5968963820df">context</a>, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l00864"></a>00864    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, i-&gt;<a class="code" href="structjingle__pvt.html#a1a25ab316fdbfb7a045251cf4d1f9b0f">exten</a>, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l00865"></a>00865    <span class="comment">/* Don&apos;t use ast_set_callerid() here because it will</span>
<a name="l00866"></a>00866 <span class="comment">    * generate an unnecessary NewCallerID event  */</span>
<a name="l00867"></a>00867    tmp-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(i-&gt;<a class="code" href="structjingle__pvt.html#a7b41ba5c947adf528a0615b688a4c5d1">cid_num</a>);
<a name="l00868"></a>00868    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(i-&gt;<a class="code" href="structjingle__pvt.html#a1a25ab316fdbfb7a045251cf4d1f9b0f">exten</a>) &amp;&amp; strcmp(i-&gt;<a class="code" href="structjingle__pvt.html#a1a25ab316fdbfb7a045251cf4d1f9b0f">exten</a>, <span class="stringliteral">&quot;s&quot;</span>))
<a name="l00869"></a>00869       tmp-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aa54ab157f47ac529034d524781e2a7e2">cid_dnid</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(i-&gt;<a class="code" href="structjingle__pvt.html#a1a25ab316fdbfb7a045251cf4d1f9b0f">exten</a>);
<a name="l00870"></a>00870    tmp-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 1;
<a name="l00871"></a>00871    <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>)
<a name="l00872"></a>00872       <a class="code" href="abstract__jb_8h.html#a0981c84ac90dd79bc2a0fdd90aa6efba" title="Configures a jitterbuffer on a channel.">ast_jb_configure</a>(tmp, &amp;<a class="code" href="chan__jingle_8c.html#abaabcb7f4349cc632dde3af5c6a5e1bd">global_jbconf</a>);
<a name="l00873"></a>00873    <span class="keywordflow">if</span> (state != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a> &amp;&amp; <a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(tmp)) {
<a name="l00874"></a>00874       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to start PBX on %s\n&quot;</span>, tmp-&gt;name);
<a name="l00875"></a>00875       tmp-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a> = <a class="code" href="causes_8h.html#a02b3785262e0be6843e8e9d235d8d78d">AST_CAUSE_SWITCH_CONGESTION</a>;
<a name="l00876"></a>00876       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tmp);
<a name="l00877"></a>00877       tmp = NULL;
<a name="l00878"></a>00878    }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880    <span class="keywordflow">return</span> tmp;
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a><a class="code" href="chan__jingle_8c.html#ab88779160b19698b9627c6778ea4123f">00883</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#ab88779160b19698b9627c6778ea4123f">jingle_action</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, <span class="keyword">struct</span> <a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p, <span class="keyword">const</span> <span class="keywordtype">char</span> *action)
<a name="l00884"></a>00884 {
<a name="l00885"></a>00885    iks *iq, *<a class="code" href="structjingle.html">jingle</a> = NULL;
<a name="l00886"></a>00886    <span class="keywordtype">int</span> res = -1;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888    iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l00889"></a>00889    jingle = iks_new(<span class="stringliteral">&quot;jingle&quot;</span>);
<a name="l00890"></a>00890    
<a name="l00891"></a>00891    <span class="keywordflow">if</span> (iq) {
<a name="l00892"></a>00892       iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;set&quot;</span>);
<a name="l00893"></a>00893       iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l00894"></a>00894       iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, p-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>);
<a name="l00895"></a>00895       iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l00896"></a>00896       <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l00897"></a>00897       <span class="keywordflow">if</span> (jingle) {
<a name="l00898"></a>00898          iks_insert_attrib(jingle, <span class="stringliteral">&quot;action&quot;</span>, action);
<a name="l00899"></a>00899          iks_insert_attrib(jingle, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>, p-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>);
<a name="l00900"></a>00900          iks_insert_attrib(jingle, <span class="stringliteral">&quot;initiator&quot;</span>, p-&gt;<a class="code" href="structjingle__pvt.html#ad65c66f9895c8d58b388365ac363e91c">initiator</a> ? client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full : p-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>);
<a name="l00901"></a>00901          iks_insert_attrib(jingle, <span class="stringliteral">&quot;xmlns&quot;</span>, <a class="code" href="jingle_8h.html#aea60c021ce1b84cb1e3fb03c325bf29d">JINGLE_NS</a>);
<a name="l00902"></a>00902 
<a name="l00903"></a>00903          iks_insert_node(iq, jingle);
<a name="l00904"></a>00904 
<a name="l00905"></a>00905          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>, iq);
<a name="l00906"></a>00906          res = 0;
<a name="l00907"></a>00907       }
<a name="l00908"></a>00908    }
<a name="l00909"></a>00909    
<a name="l00910"></a>00910    iks_delete(jingle);
<a name="l00911"></a>00911    iks_delete(iq);
<a name="l00912"></a>00912    
<a name="l00913"></a>00913    <span class="keywordflow">return</span> res;
<a name="l00914"></a>00914 }
<a name="l00915"></a>00915 
<a name="l00916"></a><a class="code" href="chan__jingle_8c.html#a0bdba68d7d2438f2629353986609ee19">00916</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__jingle_8c.html#a0bdba68d7d2438f2629353986609ee19">jingle_free_candidates</a>(<span class="keyword">struct</span> <a class="code" href="structjingle__candidate.html">jingle_candidate</a> *candidate)
<a name="l00917"></a>00917 {
<a name="l00918"></a>00918    <span class="keyword">struct </span><a class="code" href="structjingle__candidate.html">jingle_candidate</a> *<a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a>;
<a name="l00919"></a>00919    <span class="keywordflow">while</span> (candidate) {
<a name="l00920"></a>00920       last = candidate;
<a name="l00921"></a>00921       candidate = candidate-&gt;<a class="code" href="structjingle__candidate.html#a345235cfff36c891ac94d7ea9a42a117">next</a>;
<a name="l00922"></a>00922       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(last);
<a name="l00923"></a>00923    }
<a name="l00924"></a>00924 }
<a name="l00925"></a>00925 
<a name="l00926"></a><a class="code" href="chan__jingle_8c.html#a3b60b49ed3571b6ad4f60bfc72fdf0b3">00926</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__jingle_8c.html#a3b60b49ed3571b6ad4f60bfc72fdf0b3">jingle_free_pvt</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, <span class="keyword">struct</span> <a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p)
<a name="l00927"></a>00927 {
<a name="l00928"></a>00928    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *cur, *prev = NULL;
<a name="l00929"></a>00929    cur = client-&gt;<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a>;
<a name="l00930"></a>00930    <span class="keywordflow">while</span> (cur) {
<a name="l00931"></a>00931       <span class="keywordflow">if</span> (cur == p) {
<a name="l00932"></a>00932          <span class="keywordflow">if</span> (prev)
<a name="l00933"></a>00933             prev-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a> = p-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a>;
<a name="l00934"></a>00934          <span class="keywordflow">else</span>
<a name="l00935"></a>00935             client-&gt;<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a> = p-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a>;
<a name="l00936"></a>00936          <span class="keywordflow">break</span>;
<a name="l00937"></a>00937       }
<a name="l00938"></a>00938       prev = cur;
<a name="l00939"></a>00939       cur = cur-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a>;
<a name="l00940"></a>00940    }
<a name="l00941"></a>00941    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structjingle__pvt.html#a48b56664545a8ea58b25639b74f863b5">ringrule</a>)
<a name="l00942"></a>00942       iks_filter_remove_rule(p-&gt;<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a>-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, p-&gt;<a class="code" href="structjingle__pvt.html#a48b56664545a8ea58b25639b74f863b5">ringrule</a>);
<a name="l00943"></a>00943    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)
<a name="l00944"></a>00944       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Uh oh, there&apos;s an owner, this is going to be messy.\n&quot;</span>);
<a name="l00945"></a>00945    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>)
<a name="l00946"></a>00946       <a class="code" href="rtp_8h.html#a6d2addabf879eb321a660932e3bd57eb">ast_rtp_destroy</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>);
<a name="l00947"></a>00947    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structjingle__pvt.html#a65e8f978abd3f0206026969c627200a9">vrtp</a>)
<a name="l00948"></a>00948       <a class="code" href="rtp_8h.html#a6d2addabf879eb321a660932e3bd57eb">ast_rtp_destroy</a>(p-&gt;<a class="code" href="structjingle__pvt.html#a65e8f978abd3f0206026969c627200a9">vrtp</a>);
<a name="l00949"></a>00949    <a class="code" href="chan__jingle_8c.html#a0bdba68d7d2438f2629353986609ee19">jingle_free_candidates</a>(p-&gt;<a class="code" href="structjingle__pvt.html#a84649dc7eb0c0e718bdabe4c4ce677d9">theircandidates</a>);
<a name="l00950"></a>00950    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(p);
<a name="l00951"></a>00951 }
<a name="l00952"></a>00952 
<a name="l00953"></a>00953 
<a name="l00954"></a><a class="code" href="chan__jingle_8c.html#a31ea3edffa52cddd40a4d09e72ca4e22">00954</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a31ea3edffa52cddd40a4d09e72ca4e22">jingle_newcall</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, ikspak *pak)
<a name="l00955"></a>00955 {
<a name="l00956"></a>00956    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p, *tmp = client-&gt;<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a>;
<a name="l00957"></a>00957    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00958"></a>00958    <span class="keywordtype">int</span> res;
<a name="l00959"></a>00959    iks *codec, *content, *<a class="code" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a>;
<a name="l00960"></a>00960    <span class="keywordtype">char</span> *from = NULL;
<a name="l00961"></a>00961 
<a name="l00962"></a>00962    <span class="comment">/* Make sure our new call doesn&apos;t exist yet */</span>
<a name="l00963"></a>00963    from = iks_find_attrib(pak-&gt;x,<span class="stringliteral">&quot;to&quot;</span>);
<a name="l00964"></a>00964    <span class="keywordflow">if</span>(!from)
<a name="l00965"></a>00965       from = client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full;
<a name="l00966"></a>00966 
<a name="l00967"></a>00967    <span class="keywordflow">while</span> (tmp) {
<a name="l00968"></a>00968       <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;x, <a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>, tmp-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>)) {
<a name="l00969"></a>00969          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Ignoring duplicate call setup on SID %s\n&quot;</span>, tmp-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>);
<a name="l00970"></a>00970          <a class="code" href="chan__jingle_8c.html#aaff55fd50b50df0032b11b4ad22b9f3b">jingle_response</a>(client, pak, <span class="stringliteral">&quot;out-of-order&quot;</span>, NULL);
<a name="l00971"></a>00971          <span class="keywordflow">return</span> -1;
<a name="l00972"></a>00972       }
<a name="l00973"></a>00973       tmp = tmp-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a>;
<a name="l00974"></a>00974    }
<a name="l00975"></a>00975 
<a name="l00976"></a>00976    <span class="keywordflow">if</span> (!strcasecmp(client-&gt;name, <span class="stringliteral">&quot;guest&quot;</span>)){
<a name="l00977"></a>00977       <span class="comment">/* the guest account is not tied to any configured XMPP client,</span>
<a name="l00978"></a>00978 <span class="comment">         let&apos;s set it now */</span>
<a name="l00979"></a>00979       client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a> = <a class="code" href="jabber_8h.html#a6689c8e948c8d55e092f30277336fde7" title="grab a aji_client structure by label name or JID (without the resource string)">ast_aji_get_client</a>(from);
<a name="l00980"></a>00980       <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>) {
<a name="l00981"></a>00981          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;No XMPP client to talk to, us (partial JID) : %s\n&quot;</span>, from);
<a name="l00982"></a>00982          <span class="keywordflow">return</span> -1;
<a name="l00983"></a>00983       }
<a name="l00984"></a>00984    }
<a name="l00985"></a>00985 
<a name="l00986"></a>00986    p = <a class="code" href="chan__jingle_8c.html#ad444b828242ff0e8e380b1fe9037fbac">jingle_alloc</a>(client, pak-&gt;from-&gt;partial, iks_find_attrib(pak-&gt;query, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>));
<a name="l00987"></a>00987    <span class="keywordflow">if</span> (!p) {
<a name="l00988"></a>00988       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate jingle structure!\n&quot;</span>);
<a name="l00989"></a>00989       <span class="keywordflow">return</span> -1;
<a name="l00990"></a>00990    }
<a name="l00991"></a>00991    chan = <a class="code" href="chan__jingle_8c.html#aa87eec48e0d0a7bea213d2d1aba90a2f" title="Start new jingle channel.">jingle_new</a>(client, p, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, pak-&gt;from-&gt;user);
<a name="l00992"></a>00992    <span class="keywordflow">if</span> (!chan) {
<a name="l00993"></a>00993       <a class="code" href="chan__jingle_8c.html#a3b60b49ed3571b6ad4f60bfc72fdf0b3">jingle_free_pvt</a>(client, p);
<a name="l00994"></a>00994       <span class="keywordflow">return</span> -1;
<a name="l00995"></a>00995    }
<a name="l00996"></a>00996    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00997"></a>00997    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(p-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>, pak-&gt;from-&gt;full, <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>));
<a name="l00998"></a>00998    <span class="keywordflow">if</span> (iks_find_attrib(pak-&gt;query, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>)) {
<a name="l00999"></a>00999       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(p-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>, iks_find_attrib(pak-&gt;query, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>),
<a name="l01000"></a>01000             <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>));
<a name="l01001"></a>01001    }
<a name="l01002"></a>01002    
<a name="l01003"></a>01003    <span class="comment">/* content points to the first &lt;content/&gt; tag */</span>   
<a name="l01004"></a>01004    content = iks_child(iks_child(pak-&gt;x));
<a name="l01005"></a>01005    <span class="keywordflow">while</span> (content) {
<a name="l01006"></a>01006       description = iks_find_with_attrib(content, <span class="stringliteral">&quot;description&quot;</span>, <span class="stringliteral">&quot;xmlns&quot;</span>, <a class="code" href="jingle_8h.html#a7fab96291ad1dce0b48bc61887a0f4f3">JINGLE_AUDIO_RTP_NS</a>);
<a name="l01007"></a>01007       <span class="keywordflow">if</span> (description) {
<a name="l01008"></a>01008          <span class="comment">/* audio content found */</span>
<a name="l01009"></a>01009          codec = iks_child(iks_child(content));
<a name="l01010"></a>01010               <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(p-&gt;<a class="code" href="structjingle__pvt.html#a2838424b1bbea277d7a129ca9bcff181">audio_content_name</a>, iks_find_attrib(content, <span class="stringliteral">&quot;name&quot;</span>), <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structjingle__pvt.html#a2838424b1bbea277d7a129ca9bcff181">audio_content_name</a>));
<a name="l01011"></a>01011 
<a name="l01012"></a>01012          <span class="keywordflow">while</span> (codec) {
<a name="l01013"></a>01013             <a class="code" href="rtp_8h.html#a83fe16478ba4b99f0bc1798f1064baef" title="Activate payload type.">ast_rtp_set_m_type</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>, atoi(iks_find_attrib(codec, <span class="stringliteral">&quot;id&quot;</span>)));
<a name="l01014"></a>01014             <a class="code" href="rtp_8h.html#a02a3ba4e11691cafd933cbb1e6225b3e" title="Set payload type to a known MIME media type for a codec.">ast_rtp_set_rtpmap_type</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>, atoi(iks_find_attrib(codec, <span class="stringliteral">&quot;id&quot;</span>)), <span class="stringliteral">&quot;audio&quot;</span>, iks_find_attrib(codec, <span class="stringliteral">&quot;name&quot;</span>), 0);
<a name="l01015"></a>01015             codec = iks_next(codec);
<a name="l01016"></a>01016          }
<a name="l01017"></a>01017       }
<a name="l01018"></a>01018       
<a name="l01019"></a>01019       description = NULL;
<a name="l01020"></a>01020       codec = NULL;
<a name="l01021"></a>01021 
<a name="l01022"></a>01022       description = iks_find_with_attrib(content, <span class="stringliteral">&quot;description&quot;</span>, <span class="stringliteral">&quot;xmlns&quot;</span>, <a class="code" href="jingle_8h.html#a6d5d95256cffea23e17871e18ebc3d6f">JINGLE_VIDEO_RTP_NS</a>);
<a name="l01023"></a>01023       <span class="keywordflow">if</span> (description) {
<a name="l01024"></a>01024          <span class="comment">/* video content found */</span>
<a name="l01025"></a>01025          codec = iks_child(iks_child(content));
<a name="l01026"></a>01026               <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(p-&gt;<a class="code" href="structjingle__pvt.html#a27a715e578b128ce6e82de064840e450">video_content_name</a>, iks_find_attrib(content, <span class="stringliteral">&quot;name&quot;</span>), <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structjingle__pvt.html#a27a715e578b128ce6e82de064840e450">video_content_name</a>));
<a name="l01027"></a>01027 
<a name="l01028"></a>01028          <span class="keywordflow">while</span> (codec) {
<a name="l01029"></a>01029             <a class="code" href="rtp_8h.html#a83fe16478ba4b99f0bc1798f1064baef" title="Activate payload type.">ast_rtp_set_m_type</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>, atoi(iks_find_attrib(codec, <span class="stringliteral">&quot;id&quot;</span>)));
<a name="l01030"></a>01030             <a class="code" href="rtp_8h.html#a02a3ba4e11691cafd933cbb1e6225b3e" title="Set payload type to a known MIME media type for a codec.">ast_rtp_set_rtpmap_type</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>, atoi(iks_find_attrib(codec, <span class="stringliteral">&quot;id&quot;</span>)), <span class="stringliteral">&quot;audio&quot;</span>, iks_find_attrib(codec, <span class="stringliteral">&quot;name&quot;</span>), 0);
<a name="l01031"></a>01031             codec = iks_next(codec);
<a name="l01032"></a>01032          }
<a name="l01033"></a>01033       }
<a name="l01034"></a>01034       
<a name="l01035"></a>01035       content = iks_next(content);
<a name="l01036"></a>01036    }
<a name="l01037"></a>01037 
<a name="l01038"></a>01038    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01039"></a>01039    <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(chan, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>);
<a name="l01040"></a>01040    res = <a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(chan);
<a name="l01041"></a>01041    
<a name="l01042"></a>01042    <span class="keywordflow">switch</span> (res) {
<a name="l01043"></a>01043    <span class="keywordflow">case</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735a4a46cde728f5cd375af4f2d5b1542490">AST_PBX_FAILED</a>:
<a name="l01044"></a>01044       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to start PBX :(\n&quot;</span>);
<a name="l01045"></a>01045       <a class="code" href="chan__jingle_8c.html#aaff55fd50b50df0032b11b4ad22b9f3b">jingle_response</a>(client, pak, <span class="stringliteral">&quot;service-unavailable&quot;</span>, NULL);
<a name="l01046"></a>01046       <span class="keywordflow">break</span>;
<a name="l01047"></a>01047    <span class="keywordflow">case</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735ab69a419c47206542956e9d933b6605f5">AST_PBX_CALL_LIMIT</a>:
<a name="l01048"></a>01048       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to start PBX (call limit reached) \n&quot;</span>);
<a name="l01049"></a>01049       <a class="code" href="chan__jingle_8c.html#aaff55fd50b50df0032b11b4ad22b9f3b">jingle_response</a>(client, pak, <span class="stringliteral">&quot;service-unavailable&quot;</span>, NULL);
<a name="l01050"></a>01050       <span class="keywordflow">break</span>;
<a name="l01051"></a>01051    <span class="keywordflow">case</span> <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735ae1482e87c137b03ef9f9c17cf4fb5ec4">AST_PBX_SUCCESS</a>:
<a name="l01052"></a>01052       <a class="code" href="chan__jingle_8c.html#aaff55fd50b50df0032b11b4ad22b9f3b">jingle_response</a>(client, pak, NULL, NULL);
<a name="l01053"></a>01053       <a class="code" href="chan__jingle_8c.html#adccb2b493f7c932700d619647281d686">jingle_create_candidates</a>(client, p,
<a name="l01054"></a>01054                 iks_find_attrib(pak-&gt;query, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>),
<a name="l01055"></a>01055                 iks_find_attrib(pak-&gt;x, <span class="stringliteral">&quot;from&quot;</span>));
<a name="l01056"></a>01056       <span class="comment">/* nothing to do */</span>
<a name="l01057"></a>01057       <span class="keywordflow">break</span>;
<a name="l01058"></a>01058    }
<a name="l01059"></a>01059 
<a name="l01060"></a>01060    <span class="keywordflow">return</span> 1;
<a name="l01061"></a>01061 }
<a name="l01062"></a>01062 
<a name="l01063"></a><a class="code" href="chan__jingle_8c.html#a2567fd16f1e25fbe085862ae22d4a789">01063</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a2567fd16f1e25fbe085862ae22d4a789">jingle_update_stun</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, <span class="keyword">struct</span> <a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p)
<a name="l01064"></a>01064 {
<a name="l01065"></a>01065    <span class="keyword">struct </span><a class="code" href="structjingle__candidate.html">jingle_candidate</a> *tmp;
<a name="l01066"></a>01066    <span class="keyword">struct </span>hostent *<a class="code" href="chan__skinny_8c.html#aa0f575fa3882aa394cc287edba645a35">hp</a>;
<a name="l01067"></a>01067    <span class="keyword">struct </span><a class="code" href="structast__hostent.html">ast_hostent</a> ahp;
<a name="l01068"></a>01068    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l01069"></a>01069 
<a name="l01070"></a>01070    <span class="keywordflow">if</span> (time(NULL) == p-&gt;<a class="code" href="structjingle__pvt.html#afea13c69c31226a6607e67b85f0231e2">laststun</a>)
<a name="l01071"></a>01071       <span class="keywordflow">return</span> 0;
<a name="l01072"></a>01072 
<a name="l01073"></a>01073    tmp = p-&gt;<a class="code" href="structjingle__pvt.html#a84649dc7eb0c0e718bdabe4c4ce677d9">theircandidates</a>;
<a name="l01074"></a>01074    p-&gt;<a class="code" href="structjingle__pvt.html#afea13c69c31226a6607e67b85f0231e2">laststun</a> = time(NULL);
<a name="l01075"></a>01075    <span class="keywordflow">while</span> (tmp) {
<a name="l01076"></a>01076       <span class="keywordtype">char</span> username[256];
<a name="l01077"></a>01077       hp = <a class="code" href="utils_8h.html#ad3b63ee1041593219ef0765b28d70442" title="Thread-safe gethostbyname function to use in Asterisk.">ast_gethostbyname</a>(tmp-&gt;<a class="code" href="structjingle__candidate.html#ac03ec605186c0c6d17c4beaab73d615c">ip</a>, &amp;ahp);
<a name="l01078"></a>01078       sin.sin_family = AF_INET;
<a name="l01079"></a>01079       memcpy(&amp;sin.sin_addr, hp-&gt;h_addr, <span class="keyword">sizeof</span>(sin.sin_addr));
<a name="l01080"></a>01080       sin.sin_port = htons(tmp-&gt;<a class="code" href="structjingle__candidate.html#a938bdc6ae46c346147b6d4f67ad1e704">port</a>);
<a name="l01081"></a>01081       snprintf(username, <span class="keyword">sizeof</span>(username), <span class="stringliteral">&quot;%s:%s&quot;</span>, tmp-&gt;<a class="code" href="structjingle__candidate.html#a419e5addc503b21ab58e8229ccf2256b">ufrag</a>, p-&gt;<a class="code" href="structjingle__pvt.html#a9c80666d44c369110e80d0a57be3deaa">ourcandidates</a>-&gt;<a class="code" href="structjingle__candidate.html#a419e5addc503b21ab58e8229ccf2256b">ufrag</a>);
<a name="l01082"></a>01082 
<a name="l01083"></a>01083       <a class="code" href="rtp_8h.html#a07235f64f5a9df68065cfe08ee6d9f44" title="Send STUN request for an RTP socket Deprecated, this is just a wrapper for ast_rtp_stun_request()...">ast_rtp_stun_request</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>, &amp;sin, username);
<a name="l01084"></a>01084       tmp = tmp-&gt;<a class="code" href="structjingle__candidate.html#a345235cfff36c891ac94d7ea9a42a117">next</a>;
<a name="l01085"></a>01085    }
<a name="l01086"></a>01086    <span class="keywordflow">return</span> 1;
<a name="l01087"></a>01087 }
<a name="l01088"></a>01088 
<a name="l01089"></a><a class="code" href="chan__jingle_8c.html#a82d949d005a515d982d334710a630d05">01089</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a82d949d005a515d982d334710a630d05">jingle_add_candidate</a>(<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *client, ikspak *pak)
<a name="l01090"></a>01090 {
<a name="l01091"></a>01091    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p = NULL, *tmp = NULL;
<a name="l01092"></a>01092    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *c = client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>;
<a name="l01093"></a>01093    <span class="keyword">struct </span><a class="code" href="structjingle__candidate.html">jingle_candidate</a> *newcandidate = NULL;
<a name="l01094"></a>01094    iks *traversenodes = NULL, *receipt = NULL;
<a name="l01095"></a>01095 
<a name="l01096"></a>01096    <span class="keywordflow">for</span> (tmp = client-&gt;<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a>; tmp; tmp = tmp-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a>) {
<a name="l01097"></a>01097       <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;x, <a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>, tmp-&gt;sid)) {
<a name="l01098"></a>01098          p = tmp;
<a name="l01099"></a>01099          <span class="keywordflow">break</span>;
<a name="l01100"></a>01100       }
<a name="l01101"></a>01101    }
<a name="l01102"></a>01102 
<a name="l01103"></a>01103    <span class="keywordflow">if</span> (!p)
<a name="l01104"></a>01104       <span class="keywordflow">return</span> -1;
<a name="l01105"></a>01105 
<a name="l01106"></a>01106    traversenodes = pak-&gt;query;
<a name="l01107"></a>01107    <span class="keywordflow">while</span>(traversenodes) {
<a name="l01108"></a>01108       <span class="keywordflow">if</span>(!strcasecmp(iks_name(traversenodes), <span class="stringliteral">&quot;jingle&quot;</span>)) {
<a name="l01109"></a>01109          traversenodes = iks_child(traversenodes);
<a name="l01110"></a>01110          <span class="keywordflow">continue</span>;
<a name="l01111"></a>01111       }
<a name="l01112"></a>01112       <span class="keywordflow">if</span>(!strcasecmp(iks_name(traversenodes), <span class="stringliteral">&quot;content&quot;</span>)) {
<a name="l01113"></a>01113          traversenodes = iks_child(traversenodes);
<a name="l01114"></a>01114          <span class="keywordflow">continue</span>;
<a name="l01115"></a>01115       }
<a name="l01116"></a>01116       <span class="keywordflow">if</span>(!strcasecmp(iks_name(traversenodes), <span class="stringliteral">&quot;transport&quot;</span>)) {
<a name="l01117"></a>01117          traversenodes = iks_child(traversenodes);
<a name="l01118"></a>01118          <span class="keywordflow">continue</span>;
<a name="l01119"></a>01119       }
<a name="l01120"></a>01120 
<a name="l01121"></a>01121       <span class="keywordflow">if</span>(!strcasecmp(iks_name(traversenodes), <span class="stringliteral">&quot;candidate&quot;</span>)) {
<a name="l01122"></a>01122          newcandidate = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*newcandidate));
<a name="l01123"></a>01123          <span class="keywordflow">if</span> (!newcandidate)
<a name="l01124"></a>01124             <span class="keywordflow">return</span> 0;
<a name="l01125"></a>01125          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(newcandidate-&gt;<a class="code" href="structjingle__candidate.html#ac03ec605186c0c6d17c4beaab73d615c">ip</a>, iks_find_attrib(traversenodes, <span class="stringliteral">&quot;ip&quot;</span>), <span class="keyword">sizeof</span>(newcandidate-&gt;<a class="code" href="structjingle__candidate.html#ac03ec605186c0c6d17c4beaab73d615c">ip</a>));
<a name="l01126"></a>01126          newcandidate-&gt;<a class="code" href="structjingle__candidate.html#a938bdc6ae46c346147b6d4f67ad1e704">port</a> = atoi(iks_find_attrib(traversenodes, <span class="stringliteral">&quot;port&quot;</span>));
<a name="l01127"></a>01127          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(newcandidate-&gt;<a class="code" href="structjingle__candidate.html#a20218b63ca6f0a6ce74d704d915cb90a">password</a>, iks_find_attrib(traversenodes, <span class="stringliteral">&quot;pwd&quot;</span>), <span class="keyword">sizeof</span>(newcandidate-&gt;<a class="code" href="structjingle__candidate.html#a20218b63ca6f0a6ce74d704d915cb90a">password</a>));
<a name="l01128"></a>01128          <span class="keywordflow">if</span> (!strcasecmp(iks_find_attrib(traversenodes, <span class="stringliteral">&quot;protocol&quot;</span>), <span class="stringliteral">&quot;udp&quot;</span>))
<a name="l01129"></a>01129             newcandidate-&gt;<a class="code" href="structjingle__candidate.html#a78d25527095fa65cb6f62d3b25e26cd2">protocol</a> = <a class="code" href="chan__gtalk_8c.html#a4735ec2011c291c5213a858fe007c851ac913daa556e052c68933b9c428707ee3">AJI_PROTOCOL_UDP</a>;
<a name="l01130"></a>01130          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(iks_find_attrib(traversenodes, <span class="stringliteral">&quot;protocol&quot;</span>), <span class="stringliteral">&quot;ssltcp&quot;</span>))
<a name="l01131"></a>01131             newcandidate-&gt;<a class="code" href="structjingle__candidate.html#a78d25527095fa65cb6f62d3b25e26cd2">protocol</a> = <a class="code" href="chan__gtalk_8c.html#a4735ec2011c291c5213a858fe007c851a8d65aeba8254d08131b4672b7a06221c">AJI_PROTOCOL_SSLTCP</a>;
<a name="l01132"></a>01132          
<a name="l01133"></a>01133          <span class="keywordflow">if</span> (!strcasecmp(iks_find_attrib(traversenodes, <span class="stringliteral">&quot;type&quot;</span>), <span class="stringliteral">&quot;host&quot;</span>))
<a name="l01134"></a>01134             newcandidate-&gt;<a class="code" href="structjingle__candidate.html#af24b2d40de5e44ddf3e38e1b2821b619">type</a> = <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964afc7bbb745763ffe4069a28ffc61989de">AJI_CONNECT_HOST</a>;
<a name="l01135"></a>01135          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(iks_find_attrib(traversenodes, <span class="stringliteral">&quot;type&quot;</span>), <span class="stringliteral">&quot;prflx&quot;</span>))
<a name="l01136"></a>01136             newcandidate-&gt;<a class="code" href="structjingle__candidate.html#af24b2d40de5e44ddf3e38e1b2821b619">type</a> = <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964a865ab2dd828faf9586858725a8bb6e78">AJI_CONNECT_PRFLX</a>;
<a name="l01137"></a>01137          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(iks_find_attrib(traversenodes, <span class="stringliteral">&quot;type&quot;</span>), <span class="stringliteral">&quot;relay&quot;</span>))
<a name="l01138"></a>01138             newcandidate-&gt;<a class="code" href="structjingle__candidate.html#af24b2d40de5e44ddf3e38e1b2821b619">type</a> = <a class="code" href="chan__gtalk_8c.html#aabf7ea7d1c280c2d91d5ad67ea5ab883a2ef123abfa8253ea9f67f7750dbdc421">AJI_CONNECT_RELAY</a>;
<a name="l01139"></a>01139          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(iks_find_attrib(traversenodes, <span class="stringliteral">&quot;type&quot;</span>), <span class="stringliteral">&quot;srflx&quot;</span>))
<a name="l01140"></a>01140             newcandidate-&gt;<a class="code" href="structjingle__candidate.html#af24b2d40de5e44ddf3e38e1b2821b619">type</a> = <a class="code" href="chan__jingle_8c.html#abf1ce246119bae95265fad481f9d5964a1dfde46e9cdd8b227e1ccb83579d0b90">AJI_CONNECT_SRFLX</a>;
<a name="l01141"></a>01141 
<a name="l01142"></a>01142          newcandidate-&gt;<a class="code" href="structjingle__candidate.html#adabbfd79a2d8ac3935245cd061f045b2">network</a> = atoi(iks_find_attrib(traversenodes, <span class="stringliteral">&quot;network&quot;</span>));
<a name="l01143"></a>01143          newcandidate-&gt;<a class="code" href="structjingle__candidate.html#aca2885db1fed1f8fe3fee29caa90e292">generation</a> = atoi(iks_find_attrib(traversenodes, <span class="stringliteral">&quot;generation&quot;</span>));
<a name="l01144"></a>01144          newcandidate-&gt;<a class="code" href="structjingle__candidate.html#a345235cfff36c891ac94d7ea9a42a117">next</a> = NULL;
<a name="l01145"></a>01145       
<a name="l01146"></a>01146          newcandidate-&gt;<a class="code" href="structjingle__candidate.html#a345235cfff36c891ac94d7ea9a42a117">next</a> = p-&gt;<a class="code" href="structjingle__pvt.html#a84649dc7eb0c0e718bdabe4c4ce677d9">theircandidates</a>;
<a name="l01147"></a>01147          p-&gt;<a class="code" href="structjingle__pvt.html#a84649dc7eb0c0e718bdabe4c4ce677d9">theircandidates</a> = newcandidate;
<a name="l01148"></a>01148          p-&gt;<a class="code" href="structjingle__pvt.html#afea13c69c31226a6607e67b85f0231e2">laststun</a> = 0;
<a name="l01149"></a>01149          <a class="code" href="chan__jingle_8c.html#a2567fd16f1e25fbe085862ae22d4a789">jingle_update_stun</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a>, p);
<a name="l01150"></a>01150          newcandidate = NULL;
<a name="l01151"></a>01151       }
<a name="l01152"></a>01152       traversenodes = iks_next(traversenodes);
<a name="l01153"></a>01153    }
<a name="l01154"></a>01154    
<a name="l01155"></a>01155    receipt = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01156"></a>01156    iks_insert_attrib(receipt, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01157"></a>01157    iks_insert_attrib(receipt, <span class="stringliteral">&quot;from&quot;</span>, c-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01158"></a>01158    iks_insert_attrib(receipt, <span class="stringliteral">&quot;to&quot;</span>, iks_find_attrib(pak-&gt;x, <span class="stringliteral">&quot;from&quot;</span>));
<a name="l01159"></a>01159    iks_insert_attrib(receipt, <span class="stringliteral">&quot;id&quot;</span>, iks_find_attrib(pak-&gt;x, <span class="stringliteral">&quot;id&quot;</span>));
<a name="l01160"></a>01160    <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(c, receipt);
<a name="l01161"></a>01161 
<a name="l01162"></a>01162    iks_delete(receipt);
<a name="l01163"></a>01163 
<a name="l01164"></a>01164    <span class="keywordflow">return</span> 1;
<a name="l01165"></a>01165 }
<a name="l01166"></a>01166 
<a name="l01167"></a><a class="code" href="chan__jingle_8c.html#acd3a8fb0666a1709bbc524999f654f67">01167</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="chan__jingle_8c.html#acd3a8fb0666a1709bbc524999f654f67">jingle_rtp_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">struct</span> <a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p)
<a name="l01168"></a>01168 {
<a name="l01169"></a>01169    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l01170"></a>01170 
<a name="l01171"></a>01171    <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>)
<a name="l01172"></a>01172       <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01173"></a>01173    f = <a class="code" href="rtp_8h.html#ac0a9d31f175e3de83fa1dda629c11674">ast_rtp_read</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>);
<a name="l01174"></a>01174    <a class="code" href="chan__jingle_8c.html#a2567fd16f1e25fbe085862ae22d4a789">jingle_update_stun</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a>, p);
<a name="l01175"></a>01175    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l01176"></a>01176       <span class="comment">/* We already hold the channel lock */</span>
<a name="l01177"></a>01177       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {
<a name="l01178"></a>01178          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != (p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> &amp; <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a>)) {
<a name="l01179"></a>01179             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Oooh, format changed to %d\n&quot;</span>, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l01180"></a>01180             p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> =
<a name="l01181"></a>01181                (p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> &amp; <a class="code" href="frame_8h.html#ad048231af8a6271706585e3c8630dc69">AST_FORMAT_VIDEO_MASK</a>) | f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l01182"></a>01182             <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>);
<a name="l01183"></a>01183             <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>);
<a name="l01184"></a>01184          }
<a name="l01185"></a>01185 <span class="comment">/*       if ((ast_test_flag(p, SIP_DTMF) == SIP_DTMF_INBAND) &amp;&amp; p-&gt;vad) {</span>
<a name="l01186"></a>01186 <span class="comment">            f = ast_dsp_process(p-&gt;owner, p-&gt;vad, f);</span>
<a name="l01187"></a>01187 <span class="comment">            if (f &amp;&amp; (f-&gt;frametype == AST_FRAME_DTMF))</span>
<a name="l01188"></a>01188 <span class="comment">               ast_debug(1, &quot;* Detected inband DTMF &apos;%c&apos;\n&quot;, f-&gt;subclass);</span>
<a name="l01189"></a>01189 <span class="comment">              } */</span>
<a name="l01190"></a>01190       }
<a name="l01191"></a>01191    }
<a name="l01192"></a>01192    <span class="keywordflow">return</span> f;
<a name="l01193"></a>01193 }
<a name="l01194"></a>01194 
<a name="l01195"></a><a class="code" href="chan__jingle_8c.html#aa4ba94ea2d224195fa03f2c216adc5e6">01195</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="chan__jingle_8c.html#aa4ba94ea2d224195fa03f2c216adc5e6">jingle_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast)
<a name="l01196"></a>01196 {
<a name="l01197"></a>01197    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *fr;
<a name="l01198"></a>01198    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01201"></a>01201    fr = <a class="code" href="chan__jingle_8c.html#acd3a8fb0666a1709bbc524999f654f67">jingle_rtp_read</a>(ast, p);
<a name="l01202"></a>01202    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01203"></a>01203    <span class="keywordflow">return</span> fr;
<a name="l01204"></a>01204 }
<a name="l01205"></a>01205 <span class="comment"></span>
<a name="l01206"></a>01206 <span class="comment">/*! \brief Send frame to media channel (rtp) */</span>
<a name="l01207"></a><a class="code" href="chan__jingle_8c.html#aa9f6991cdd96de140d7d86996286062e">01207</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#aa9f6991cdd96de140d7d86996286062e" title="Send frame to media channel (rtp).">jingle_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *frame)
<a name="l01208"></a>01208 {
<a name="l01209"></a>01209    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l01210"></a>01210    <span class="keywordtype">int</span> res = 0;
<a name="l01211"></a>01211 
<a name="l01212"></a>01212    <span class="keywordflow">switch</span> (frame-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>) {
<a name="l01213"></a>01213    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>:
<a name="l01214"></a>01214       <span class="keywordflow">if</span> (!(frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; ast-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>)) {
<a name="l01215"></a>01215          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01216"></a>01216                <span class="stringliteral">&quot;Asked to transmit frame type %d, while native formats is %d (read/write = %d/%d)\n&quot;</span>,
<a name="l01217"></a>01217                frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, ast-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>, ast-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>,
<a name="l01218"></a>01218                ast-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>);
<a name="l01219"></a>01219          <span class="keywordflow">return</span> 0;
<a name="l01220"></a>01220       }
<a name="l01221"></a>01221       <span class="keywordflow">if</span> (p) {
<a name="l01222"></a>01222          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01223"></a>01223          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>) {
<a name="l01224"></a>01224             res = <a class="code" href="rtp_8h.html#a7a8ffdcbe10f04c3ca29e7cad359a68c">ast_rtp_write</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aba39773f04fd6540d56897b3d0396086">rtp</a>, frame);
<a name="l01225"></a>01225          }
<a name="l01226"></a>01226          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01227"></a>01227       }
<a name="l01228"></a>01228       <span class="keywordflow">break</span>;
<a name="l01229"></a>01229    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>:
<a name="l01230"></a>01230       <span class="keywordflow">if</span> (p) {
<a name="l01231"></a>01231          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01232"></a>01232          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structjingle__pvt.html#a65e8f978abd3f0206026969c627200a9">vrtp</a>) {
<a name="l01233"></a>01233             res = <a class="code" href="rtp_8h.html#a7a8ffdcbe10f04c3ca29e7cad359a68c">ast_rtp_write</a>(p-&gt;<a class="code" href="structjingle__pvt.html#a65e8f978abd3f0206026969c627200a9">vrtp</a>, frame);
<a name="l01234"></a>01234          }
<a name="l01235"></a>01235          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01236"></a>01236       }
<a name="l01237"></a>01237       <span class="keywordflow">break</span>;
<a name="l01238"></a>01238    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a6c9398ee8989239124295d096a87bf32">AST_FRAME_IMAGE</a>:
<a name="l01239"></a>01239       <span class="keywordflow">return</span> 0;
<a name="l01240"></a>01240       <span class="keywordflow">break</span>;
<a name="l01241"></a>01241    <span class="keywordflow">default</span>:
<a name="l01242"></a>01242       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t send %d type frames with Jingle write\n&quot;</span>,
<a name="l01243"></a>01243             frame-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>);
<a name="l01244"></a>01244       <span class="keywordflow">return</span> 0;
<a name="l01245"></a>01245    }
<a name="l01246"></a>01246 
<a name="l01247"></a>01247    <span class="keywordflow">return</span> res;
<a name="l01248"></a>01248 }
<a name="l01249"></a>01249 
<a name="l01250"></a><a class="code" href="chan__jingle_8c.html#a882726a9559c340d4a0257c81c7e3f10">01250</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a882726a9559c340d4a0257c81c7e3f10">jingle_fixup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *oldchan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *newchan)
<a name="l01251"></a>01251 {
<a name="l01252"></a>01252    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p = newchan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l01253"></a>01253    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01254"></a>01254 
<a name="l01255"></a>01255    <span class="keywordflow">if</span> ((p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> != oldchan)) {
<a name="l01256"></a>01256       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01257"></a>01257       <span class="keywordflow">return</span> -1;
<a name="l01258"></a>01258    }
<a name="l01259"></a>01259    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> == oldchan)
<a name="l01260"></a>01260       p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = newchan;
<a name="l01261"></a>01261    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01262"></a>01262    <span class="keywordflow">return</span> 0;
<a name="l01263"></a>01263 }
<a name="l01264"></a>01264 
<a name="l01265"></a><a class="code" href="chan__jingle_8c.html#a03a76533acc66cc42615f3e5ca2f9d93">01265</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a03a76533acc66cc42615f3e5ca2f9d93">jingle_indicate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">int</span> condition, <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> datalen)
<a name="l01266"></a>01266 {
<a name="l01267"></a>01267    <span class="keywordtype">int</span> res = 0;
<a name="l01268"></a>01268 
<a name="l01269"></a>01269    <span class="keywordflow">switch</span> (condition) {
<a name="l01270"></a>01270    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>:
<a name="l01271"></a>01271       <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(ast, data, NULL);
<a name="l01272"></a>01272       <span class="keywordflow">break</span>;
<a name="l01273"></a>01273    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>:
<a name="l01274"></a>01274       <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(ast);
<a name="l01275"></a>01275       <span class="keywordflow">break</span>;
<a name="l01276"></a>01276    <span class="keywordflow">default</span>:
<a name="l01277"></a>01277       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Don&apos;t know how to indicate condition &apos;%d&apos;\n&quot;</span>, condition);
<a name="l01278"></a>01278       res = -1;
<a name="l01279"></a>01279    }
<a name="l01280"></a>01280 
<a name="l01281"></a>01281    <span class="keywordflow">return</span> res;
<a name="l01282"></a>01282 }
<a name="l01283"></a>01283 
<a name="l01284"></a><a class="code" href="chan__jingle_8c.html#a1800875c2660c8d326a1aab730224eb8">01284</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a1800875c2660c8d326a1aab730224eb8">jingle_digit</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> digit, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration)
<a name="l01285"></a>01285 {
<a name="l01286"></a>01286    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l01287"></a>01287    <span class="keyword">struct </span><a class="code" href="structjingle.html">jingle</a> *client = p-&gt;<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a>;
<a name="l01288"></a>01288    iks *iq, *<a class="code" href="structjingle.html">jingle</a>, *dtmf;
<a name="l01289"></a>01289    <span class="keywordtype">char</span> buffer[2] = {digit, <span class="charliteral">&apos;\0&apos;</span>};
<a name="l01290"></a>01290    iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01291"></a>01291    jingle = iks_new(<span class="stringliteral">&quot;jingle&quot;</span>);
<a name="l01292"></a>01292    dtmf = iks_new(<span class="stringliteral">&quot;dtmf&quot;</span>);
<a name="l01293"></a>01293    <span class="keywordflow">if</span>(!iq || !jingle || !dtmf) {
<a name="l01294"></a>01294       iks_delete(iq);
<a name="l01295"></a>01295       iks_delete(jingle);
<a name="l01296"></a>01296       iks_delete(dtmf);
<a name="l01297"></a>01297       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Did not send dtmf do to memory issue\n&quot;</span>);
<a name="l01298"></a>01298       <span class="keywordflow">return</span> -1;
<a name="l01299"></a>01299    }
<a name="l01300"></a>01300 
<a name="l01301"></a>01301    iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;set&quot;</span>);
<a name="l01302"></a>01302    iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, p-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>);
<a name="l01303"></a>01303    iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01304"></a>01304    iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01305"></a>01305    <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01306"></a>01306    iks_insert_attrib(jingle, <span class="stringliteral">&quot;xmlns&quot;</span>, <a class="code" href="jingle_8h.html#aea60c021ce1b84cb1e3fb03c325bf29d">JINGLE_NS</a>);
<a name="l01307"></a>01307    iks_insert_attrib(jingle, <span class="stringliteral">&quot;action&quot;</span>, <span class="stringliteral">&quot;session-info&quot;</span>);
<a name="l01308"></a>01308    iks_insert_attrib(jingle, <span class="stringliteral">&quot;initiator&quot;</span>, p-&gt;<a class="code" href="structjingle__pvt.html#ad65c66f9895c8d58b388365ac363e91c">initiator</a> ? client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full : p-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>);
<a name="l01309"></a>01309    iks_insert_attrib(jingle, <span class="stringliteral">&quot;sid&quot;</span>, p-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>);
<a name="l01310"></a>01310    iks_insert_attrib(dtmf, <span class="stringliteral">&quot;xmlns&quot;</span>, <a class="code" href="jingle_8h.html#a2150f17d5f37efaa379d03b3f676564e">JINGLE_DTMF_NS</a>);
<a name="l01311"></a>01311    iks_insert_attrib(dtmf, <span class="stringliteral">&quot;code&quot;</span>, buffer);
<a name="l01312"></a>01312    iks_insert_node(iq, jingle);
<a name="l01313"></a>01313    iks_insert_node(jingle, dtmf);
<a name="l01314"></a>01314 
<a name="l01315"></a>01315    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01316"></a>01316    <span class="keywordflow">if</span> (ast-&gt;<a class="code" href="structast__channel.html#a2d07143627b03360ff4de0097553dbcc">dtmff</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a> || duration == 0) {
<a name="l01317"></a>01317       iks_insert_attrib(dtmf, <span class="stringliteral">&quot;action&quot;</span>, <span class="stringliteral">&quot;button-down&quot;</span>);
<a name="l01318"></a>01318    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ast-&gt;<a class="code" href="structast__channel.html#a2d07143627b03360ff4de0097553dbcc">dtmff</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a> || duration != 0) {
<a name="l01319"></a>01319       iks_insert_attrib(dtmf, <span class="stringliteral">&quot;action&quot;</span>, <span class="stringliteral">&quot;button-up&quot;</span>);
<a name="l01320"></a>01320    }
<a name="l01321"></a>01321    <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>, iq);
<a name="l01322"></a>01322 
<a name="l01323"></a>01323    iks_delete(iq);
<a name="l01324"></a>01324    iks_delete(jingle);
<a name="l01325"></a>01325    iks_delete(dtmf);
<a name="l01326"></a>01326    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01327"></a>01327    <span class="keywordflow">return</span> 0;
<a name="l01328"></a>01328 }
<a name="l01329"></a>01329 
<a name="l01330"></a><a class="code" href="chan__jingle_8c.html#aed2fad8c3e2cfd71abc967ce250f4610">01330</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#aed2fad8c3e2cfd71abc967ce250f4610">jingle_digit_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> digit)
<a name="l01331"></a>01331 {
<a name="l01332"></a>01332    <span class="keywordflow">return</span> <a class="code" href="chan__jingle_8c.html#a1800875c2660c8d326a1aab730224eb8">jingle_digit</a>(chan, digit, 0);
<a name="l01333"></a>01333 }
<a name="l01334"></a>01334 
<a name="l01335"></a><a class="code" href="chan__jingle_8c.html#a878ae10818fe2b7400489171828779ea">01335</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a878ae10818fe2b7400489171828779ea">jingle_digit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> digit, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration)
<a name="l01336"></a>01336 {
<a name="l01337"></a>01337    <span class="keywordflow">return</span> <a class="code" href="chan__jingle_8c.html#a1800875c2660c8d326a1aab730224eb8">jingle_digit</a>(ast, digit, duration);
<a name="l01338"></a>01338 }
<a name="l01339"></a>01339 
<a name="l01340"></a><a class="code" href="chan__jingle_8c.html#a82e6534a45b0cf99e198b5b143fb105f">01340</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a82e6534a45b0cf99e198b5b143fb105f">jingle_sendhtml</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">int</span> subclass, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> datalen)
<a name="l01341"></a>01341 {
<a name="l01342"></a>01342    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;XXX Implement jingle sendhtml XXX\n&quot;</span>);
<a name="l01343"></a>01343 
<a name="l01344"></a>01344    <span class="keywordflow">return</span> -1;
<a name="l01345"></a>01345 }
<a name="l01346"></a><a class="code" href="chan__jingle_8c.html#a8ff4e9f76513169bb3b0bb5023904629">01346</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a8ff4e9f76513169bb3b0bb5023904629">jingle_transmit_invite</a>(<span class="keyword">struct</span> <a class="code" href="structjingle__pvt.html">jingle_pvt</a> *<a class="code" href="structjingle.html#a132ee575a7879b45604474bad981f7a3">p</a>)
<a name="l01347"></a>01347 {
<a name="l01348"></a>01348    <span class="keyword">struct </span><a class="code" href="structjingle.html">jingle</a> *aux = NULL;
<a name="l01349"></a>01349    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l01350"></a>01350    iks *iq, *<a class="code" href="structjingle.html">jingle</a>, *content, *<a class="code" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a>, *transport;
<a name="l01351"></a>01351    iks *payload_eg711u, *payload_pcmu;
<a name="l01352"></a>01352 
<a name="l01353"></a>01353    aux = p-&gt;<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a>;
<a name="l01354"></a>01354    client = aux-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>;
<a name="l01355"></a>01355    iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01356"></a>01356    jingle = iks_new(<a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>);
<a name="l01357"></a>01357    content = iks_new(<span class="stringliteral">&quot;content&quot;</span>);
<a name="l01358"></a>01358    description = iks_new(<span class="stringliteral">&quot;description&quot;</span>);
<a name="l01359"></a>01359    transport = iks_new(<span class="stringliteral">&quot;transport&quot;</span>);
<a name="l01360"></a>01360    payload_pcmu = iks_new(<span class="stringliteral">&quot;payload-type&quot;</span>);
<a name="l01361"></a>01361    payload_eg711u = iks_new(<span class="stringliteral">&quot;payload-type&quot;</span>);
<a name="l01362"></a>01362 
<a name="l01363"></a>01363    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(p-&gt;<a class="code" href="structjingle__pvt.html#a2838424b1bbea277d7a129ca9bcff181">audio_content_name</a>, <span class="stringliteral">&quot;asterisk-audio-content&quot;</span>, <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structjingle__pvt.html#a2838424b1bbea277d7a129ca9bcff181">audio_content_name</a>));
<a name="l01364"></a>01364 
<a name="l01365"></a>01365    iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;set&quot;</span>);
<a name="l01366"></a>01366    iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, p-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>);
<a name="l01367"></a>01367    iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01368"></a>01368    iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01369"></a>01369    <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01370"></a>01370    iks_insert_attrib(jingle, <span class="stringliteral">&quot;action&quot;</span>, <a class="code" href="jingle_8h.html#ad05540eb25cc052cd82a4c583cba6c04">JINGLE_INITIATE</a>);
<a name="l01371"></a>01371    iks_insert_attrib(jingle, <a class="code" href="jingle_8h.html#acd0886328081ada1e62a1229486e099f">JINGLE_SID</a>, p-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>);
<a name="l01372"></a>01372    iks_insert_attrib(jingle, <span class="stringliteral">&quot;initiator&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01373"></a>01373    iks_insert_attrib(jingle, <span class="stringliteral">&quot;xmlns&quot;</span>, <a class="code" href="jingle_8h.html#aea60c021ce1b84cb1e3fb03c325bf29d">JINGLE_NS</a>);
<a name="l01374"></a>01374 
<a name="l01375"></a>01375    <span class="comment">/* For now, we only send one audio based content */</span>
<a name="l01376"></a>01376    iks_insert_attrib(content, <span class="stringliteral">&quot;creator&quot;</span>, <span class="stringliteral">&quot;initiator&quot;</span>);
<a name="l01377"></a>01377    iks_insert_attrib(content, <span class="stringliteral">&quot;name&quot;</span>, p-&gt;<a class="code" href="structjingle__pvt.html#a2838424b1bbea277d7a129ca9bcff181">audio_content_name</a>);
<a name="l01378"></a>01378    iks_insert_attrib(content, <span class="stringliteral">&quot;profile&quot;</span>, <span class="stringliteral">&quot;RTP/AVP&quot;</span>);
<a name="l01379"></a>01379    iks_insert_attrib(description, <span class="stringliteral">&quot;xmlns&quot;</span>, <a class="code" href="jingle_8h.html#a7fab96291ad1dce0b48bc61887a0f4f3">JINGLE_AUDIO_RTP_NS</a>);
<a name="l01380"></a>01380    iks_insert_attrib(transport, <span class="stringliteral">&quot;xmlns&quot;</span>, <a class="code" href="jingle_8h.html#aff2e284f7794a901c712191ecb6908d1">JINGLE_ICE_UDP_NS</a>);
<a name="l01381"></a>01381    iks_insert_attrib(payload_pcmu, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>);
<a name="l01382"></a>01382    iks_insert_attrib(payload_pcmu, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;PCMU&quot;</span>);
<a name="l01383"></a>01383    iks_insert_attrib(payload_eg711u, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;100&quot;</span>);
<a name="l01384"></a>01384    iks_insert_attrib(payload_eg711u, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;EG711U&quot;</span>);
<a name="l01385"></a>01385    iks_insert_node(description, payload_pcmu);
<a name="l01386"></a>01386    iks_insert_node(description, payload_eg711u);
<a name="l01387"></a>01387    iks_insert_node(content, description);
<a name="l01388"></a>01388    iks_insert_node(content, transport);
<a name="l01389"></a>01389    iks_insert_node(jingle, content);
<a name="l01390"></a>01390    iks_insert_node(iq, jingle);
<a name="l01391"></a>01391 
<a name="l01392"></a>01392    <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01393"></a>01393 
<a name="l01394"></a>01394    iks_delete(iq);
<a name="l01395"></a>01395    iks_delete(jingle);
<a name="l01396"></a>01396    iks_delete(content);
<a name="l01397"></a>01397    iks_delete(description);
<a name="l01398"></a>01398    iks_delete(transport);
<a name="l01399"></a>01399    iks_delete(payload_eg711u);
<a name="l01400"></a>01400    iks_delete(payload_pcmu);
<a name="l01401"></a>01401    <span class="keywordflow">return</span> 0;
<a name="l01402"></a>01402 }
<a name="l01403"></a>01403 
<a name="l01404"></a>01404 <span class="comment">/* Not in use right now.</span>
<a name="l01405"></a>01405 <span class="comment">static int jingle_auto_congest(void *nothing)</span>
<a name="l01406"></a>01406 <span class="comment">{</span>
<a name="l01407"></a>01407 <span class="comment">   struct jingle_pvt *p = nothing;</span>
<a name="l01408"></a>01408 <span class="comment"></span>
<a name="l01409"></a>01409 <span class="comment">   ast_mutex_lock(&amp;p-&gt;lock);</span>
<a name="l01410"></a>01410 <span class="comment">   if (p-&gt;owner) {</span>
<a name="l01411"></a>01411 <span class="comment">      if (!ast_channel_trylock(p-&gt;owner)) {</span>
<a name="l01412"></a>01412 <span class="comment">         ast_log(LOG_NOTICE, &quot;Auto-congesting %s\n&quot;, p-&gt;owner-&gt;name);</span>
<a name="l01413"></a>01413 <span class="comment">         ast_queue_control(p-&gt;owner, AST_CONTROL_CONGESTION);</span>
<a name="l01414"></a>01414 <span class="comment">         ast_channel_unlock(p-&gt;owner);</span>
<a name="l01415"></a>01415 <span class="comment">      }</span>
<a name="l01416"></a>01416 <span class="comment">   }</span>
<a name="l01417"></a>01417 <span class="comment">   ast_mutex_unlock(&amp;p-&gt;lock);</span>
<a name="l01418"></a>01418 <span class="comment">   return 0;</span>
<a name="l01419"></a>01419 <span class="comment">}</span>
<a name="l01420"></a>01420 <span class="comment">*/</span>
<a name="l01421"></a>01421 <span class="comment"></span>
<a name="l01422"></a>01422 <span class="comment">/*! \brief Initiate new call, part of PBX interface </span>
<a name="l01423"></a>01423 <span class="comment"> *    dest is the dial string */</span>
<a name="l01424"></a><a class="code" href="chan__jingle_8c.html#aec720230103d5362e3b3ac18d228b33a">01424</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#aec720230103d5362e3b3ac18d228b33a" title="Initiate new call, part of PBX interface dest is the dial string.">jingle_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> <a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>)
<a name="l01425"></a>01425 {
<a name="l01426"></a>01426    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l01427"></a>01427 
<a name="l01428"></a>01428    <span class="keywordflow">if</span> ((ast-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>) &amp;&amp; (ast-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660addb60fd97b55a4aea24f992e30fe3c84">AST_STATE_RESERVED</a>)) {
<a name="l01429"></a>01429       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;jingle_call called on %s, neither down nor reserved\n&quot;</span>, ast-&gt;name);
<a name="l01430"></a>01430       <span class="keywordflow">return</span> -1;
<a name="l01431"></a>01431    }
<a name="l01432"></a>01432 
<a name="l01433"></a>01433    <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(ast, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>);
<a name="l01434"></a>01434    p-&gt;<a class="code" href="structjingle__pvt.html#a38f5730c90d9315eb1c0df6cfdc37da6">jointcapability</a> = p-&gt;<a class="code" href="structjingle__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;
<a name="l01435"></a>01435    <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structjingle__pvt.html#a48b56664545a8ea58b25639b74f863b5">ringrule</a>) {
<a name="l01436"></a>01436       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(p-&gt;<a class="code" href="structjingle__pvt.html#a4b47cdfa1ed7bb8a6323cdf070e50c97">ring</a>, p-&gt;<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a>-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>, <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structjingle__pvt.html#a4b47cdfa1ed7bb8a6323cdf070e50c97">ring</a>));
<a name="l01437"></a>01437       p-&gt;<a class="code" href="structjingle__pvt.html#a48b56664545a8ea58b25639b74f863b5">ringrule</a> = iks_filter_add_rule(p-&gt;<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a>-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="chan__jingle_8c.html#adb8e25a5e4aab990e6d37cda542fdd8c">jingle_ringing_ack</a>, p,
<a name="l01438"></a>01438                      IKS_RULE_ID, p-&gt;<a class="code" href="structjingle__pvt.html#a4b47cdfa1ed7bb8a6323cdf070e50c97">ring</a>, IKS_RULE_DONE);
<a name="l01439"></a>01439    } <span class="keywordflow">else</span>
<a name="l01440"></a>01440       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Whoa, already have a ring rule!\n&quot;</span>);
<a name="l01441"></a>01441 
<a name="l01442"></a>01442    <a class="code" href="chan__jingle_8c.html#a8ff4e9f76513169bb3b0bb5023904629">jingle_transmit_invite</a>(p);
<a name="l01443"></a>01443    <a class="code" href="chan__jingle_8c.html#adccb2b493f7c932700d619647281d686">jingle_create_candidates</a>(p-&gt;<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a>, p, p-&gt;<a class="code" href="structjingle__pvt.html#a11855a8fa7877d4395e800ce1bb3ed8d">sid</a>, p-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>);
<a name="l01444"></a>01444 
<a name="l01445"></a>01445    <span class="keywordflow">return</span> 0;
<a name="l01446"></a>01446 }
<a name="l01447"></a>01447 <span class="comment"></span>
<a name="l01448"></a>01448 <span class="comment">/*! \brief Hangup a call through the jingle proxy channel */</span>
<a name="l01449"></a><a class="code" href="chan__jingle_8c.html#aed2fd62a476d9265cf1a1ac5dcaaeadd">01449</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#aed2fd62a476d9265cf1a1ac5dcaaeadd" title="Hangup a call through the jingle proxy channel.">jingle_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast)
<a name="l01450"></a>01450 {
<a name="l01451"></a>01451    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l01452"></a>01452    <span class="keyword">struct </span><a class="code" href="structjingle.html">jingle</a> *client;
<a name="l01453"></a>01453 
<a name="l01454"></a>01454    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01455"></a>01455    client = p-&gt;<a class="code" href="structjingle__pvt.html#aed0d235531473917f7f0d5c44efee60f">parent</a>;
<a name="l01456"></a>01456    p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = NULL;
<a name="l01457"></a>01457    ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = NULL;
<a name="l01458"></a>01458    <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structjingle__pvt.html#ac43993a73742eff145b861107a1afa0d">alreadygone</a>)
<a name="l01459"></a>01459       <a class="code" href="chan__jingle_8c.html#ab88779160b19698b9627c6778ea4123f">jingle_action</a>(client, p, <a class="code" href="jingle_8h.html#acccffceb2c3133ae5b1aca465add5591">JINGLE_TERMINATE</a>);
<a name="l01460"></a>01460    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structjingle__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01461"></a>01461 
<a name="l01462"></a>01462    <a class="code" href="chan__jingle_8c.html#a3b60b49ed3571b6ad4f60bfc72fdf0b3">jingle_free_pvt</a>(client, p);
<a name="l01463"></a>01463 
<a name="l01464"></a>01464    <span class="keywordflow">return</span> 0;
<a name="l01465"></a>01465 }
<a name="l01466"></a>01466 <span class="comment"></span>
<a name="l01467"></a>01467 <span class="comment">/*! \brief Part of PBX interface */</span>
<a name="l01468"></a><a class="code" href="chan__jingle_8c.html#ac4453005c6ba12a95a5d84c03198aab2">01468</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__jingle_8c.html#ac4453005c6ba12a95a5d84c03198aab2" title="Part of PBX interface.">jingle_request</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *request_type, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="keywordtype">int</span> *<a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>)
<a name="l01469"></a>01469 {
<a name="l01470"></a>01470    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p = NULL;
<a name="l01471"></a>01471    <span class="keyword">struct </span><a class="code" href="structjingle.html">jingle</a> *client = NULL;
<a name="l01472"></a>01472    <span class="keywordtype">char</span> *sender = NULL, *to = NULL, *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = NULL;
<a name="l01473"></a>01473    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a> = NULL;
<a name="l01474"></a>01474 
<a name="l01475"></a>01475    <span class="keywordflow">if</span> (data) {
<a name="l01476"></a>01476       s = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l01477"></a>01477       <span class="keywordflow">if</span> (s) {
<a name="l01478"></a>01478          sender = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;s, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l01479"></a>01479          <span class="keywordflow">if</span> (sender &amp;&amp; (sender[0] != <span class="charliteral">&apos;\0&apos;</span>))
<a name="l01480"></a>01480             to = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;s, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l01481"></a>01481          <span class="keywordflow">if</span> (!to) {
<a name="l01482"></a>01482             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Bad arguments in Jingle Dialstring: %s\n&quot;</span>, (<span class="keywordtype">char</span>*) data);
<a name="l01483"></a>01483             <span class="keywordflow">return</span> NULL;
<a name="l01484"></a>01484          }
<a name="l01485"></a>01485       }
<a name="l01486"></a>01486    }
<a name="l01487"></a>01487 
<a name="l01488"></a>01488    client = <a class="code" href="chan__jingle_8c.html#a4eaecfb356a5331aa7ebcb052a5d6680">find_jingle</a>(to, sender);
<a name="l01489"></a>01489    <span class="keywordflow">if</span> (!client) {
<a name="l01490"></a>01490       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find recipient.\n&quot;</span>);
<a name="l01491"></a>01491       <span class="keywordflow">return</span> NULL;
<a name="l01492"></a>01492    }
<a name="l01493"></a>01493    <span class="keywordflow">if</span> (!strcasecmp(client-&gt;name, <span class="stringliteral">&quot;guest&quot;</span>)){
<a name="l01494"></a>01494       <span class="comment">/* the guest account is not tied to any configured XMPP client,</span>
<a name="l01495"></a>01495 <span class="comment">         let&apos;s set it now */</span>
<a name="l01496"></a>01496       client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a> = <a class="code" href="jabber_8h.html#a6689c8e948c8d55e092f30277336fde7" title="grab a aji_client structure by label name or JID (without the resource string)">ast_aji_get_client</a>(sender);
<a name="l01497"></a>01497       <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>) {
<a name="l01498"></a>01498          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;No XMPP client to talk to, us (partial JID) : %s\n&quot;</span>, sender);
<a name="l01499"></a>01499          <span class="keywordflow">return</span> NULL;
<a name="l01500"></a>01500       }
<a name="l01501"></a>01501    }
<a name="l01502"></a>01502        
<a name="l01503"></a>01503    <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(client);
<a name="l01504"></a>01504    p = <a class="code" href="chan__jingle_8c.html#ad444b828242ff0e8e380b1fe9037fbac">jingle_alloc</a>(client, to, NULL);
<a name="l01505"></a>01505    <span class="keywordflow">if</span> (p)
<a name="l01506"></a>01506       chan = <a class="code" href="chan__jingle_8c.html#aa87eec48e0d0a7bea213d2d1aba90a2f" title="Start new jingle channel.">jingle_new</a>(client, p, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, to);
<a name="l01507"></a>01507    <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(client);
<a name="l01508"></a>01508 
<a name="l01509"></a>01509    <span class="keywordflow">return</span> chan;
<a name="l01510"></a>01510 }
<a name="l01511"></a>01511 <span class="comment"></span>
<a name="l01512"></a>01512 <span class="comment">/*! \brief CLI command &quot;jingle show channels&quot; */</span>
<a name="l01513"></a><a class="code" href="chan__jingle_8c.html#acbb7216b9bb3337b10531dd209038a87">01513</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__jingle_8c.html#acbb7216b9bb3337b10531dd209038a87" title="CLI command &amp;quot;jingle show channels&amp;quot;.">jingle_show_channels</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01514"></a>01514 {
<a name="l01515"></a>01515 <span class="preprocessor">#define FORMAT  &quot;%-30.30s  %-30.30s  %-15.15s  %-5.5s %-5.5s \n&quot;</span>
<a name="l01516"></a>01516 <span class="preprocessor"></span>   <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *p;
<a name="l01517"></a>01517    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l01518"></a>01518    <span class="keywordtype">int</span> numchans = 0;
<a name="l01519"></a>01519    <span class="keywordtype">char</span> them[<a class="code" href="jabber_8h.html#aff8969a8d91846c9e669eb4f0ec5208a">AJI_MAX_JIDLEN</a>];
<a name="l01520"></a>01520    <span class="keywordtype">char</span> *jid = NULL;
<a name="l01521"></a>01521    <span class="keywordtype">char</span> *resource = NULL;
<a name="l01522"></a>01522 
<a name="l01523"></a>01523    <span class="keywordflow">switch</span> (cmd) {
<a name="l01524"></a>01524    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01525"></a>01525       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;jingle show channels&quot;</span>;
<a name="l01526"></a>01526       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01527"></a>01527          <span class="stringliteral">&quot;Usage: jingle show channels\n&quot;</span>
<a name="l01528"></a>01528          <span class="stringliteral">&quot;       Shows current state of the Jingle channels.\n&quot;</span>;
<a name="l01529"></a>01529       <span class="keywordflow">return</span> NULL;
<a name="l01530"></a>01530    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01531"></a>01531       <span class="keywordflow">return</span> NULL;
<a name="l01532"></a>01532    }
<a name="l01533"></a>01533 
<a name="l01534"></a>01534    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l01535"></a>01535       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01536"></a>01536 
<a name="l01537"></a>01537    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;jinglelock);
<a name="l01538"></a>01538    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, <span class="stringliteral">&quot;Channel&quot;</span>, <span class="stringliteral">&quot;Jabber ID&quot;</span>, <span class="stringliteral">&quot;Resource&quot;</span>, <span class="stringliteral">&quot;Read&quot;</span>, <span class="stringliteral">&quot;Write&quot;</span>);
<a name="l01539"></a>01539    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="chan__jingle_8c.html#a42d49d41c6e229f83e18d7623ca150f5">jingle_list</a>, 1, {
<a name="l01540"></a>01540       <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(iterator);
<a name="l01541"></a>01541       p = iterator-&gt;p;
<a name="l01542"></a>01542       <span class="keywordflow">while</span>(p) {
<a name="l01543"></a>01543          chan = p-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>;
<a name="l01544"></a>01544          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(them, p-&gt;<a class="code" href="structjingle__pvt.html#a7c3b41a9f87238ef5a35607e6655f02e">them</a>, <span class="keyword">sizeof</span>(them));
<a name="l01545"></a>01545          jid = them;
<a name="l01546"></a>01546          resource = strchr(them, <span class="charliteral">&apos;/&apos;</span>);
<a name="l01547"></a>01547          <span class="keywordflow">if</span> (!resource)
<a name="l01548"></a>01548             resource = <span class="stringliteral">&quot;None&quot;</span>;
<a name="l01549"></a>01549          <span class="keywordflow">else</span> {
<a name="l01550"></a>01550             *resource = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01551"></a>01551             resource ++;
<a name="l01552"></a>01552          }
<a name="l01553"></a>01553          <span class="keywordflow">if</span> (chan)
<a name="l01554"></a>01554             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, 
<a name="l01555"></a>01555                chan-&gt;name,
<a name="l01556"></a>01556                jid,
<a name="l01557"></a>01557                resource,
<a name="l01558"></a>01558                <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(chan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>),
<a name="l01559"></a>01559                <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>)               
<a name="l01560"></a>01560                );
<a name="l01561"></a>01561          <span class="keywordflow">else</span> 
<a name="l01562"></a>01562             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No available channel\n&quot;</span>);
<a name="l01563"></a>01563          numchans ++;
<a name="l01564"></a>01564          p = p-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a>;
<a name="l01565"></a>01565       }
<a name="l01566"></a>01566       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l01567"></a>01567    });
<a name="l01568"></a>01568 
<a name="l01569"></a>01569    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;jinglelock);
<a name="l01570"></a>01570 
<a name="l01571"></a>01571    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d active jingle channel%s\n&quot;</span>, numchans, (numchans != 1) ? <span class="stringliteral">&quot;s&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l01572"></a>01572    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01573"></a>01573 <span class="preprocessor">#undef FORMAT</span>
<a name="l01574"></a>01574 <span class="preprocessor"></span>}
<a name="l01575"></a>01575 <span class="comment"></span>
<a name="l01576"></a>01576 <span class="comment">/*! \brief CLI command &quot;jingle reload&quot; */</span>
<a name="l01577"></a><a class="code" href="chan__jingle_8c.html#a6dcc779144f39ee5d4177c47d79646fe">01577</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__jingle_8c.html#a6dcc779144f39ee5d4177c47d79646fe" title="CLI command &amp;quot;jingle reload&amp;quot;.">jingle_do_reload</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01578"></a>01578 {
<a name="l01579"></a>01579    <span class="keywordflow">switch</span> (cmd) {
<a name="l01580"></a>01580    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01581"></a>01581       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;jingle reload&quot;</span>;
<a name="l01582"></a>01582       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01583"></a>01583          <span class="stringliteral">&quot;Usage: jingle reload\n&quot;</span>
<a name="l01584"></a>01584          <span class="stringliteral">&quot;       Reload jingle channel driver.\n&quot;</span>;
<a name="l01585"></a>01585       <span class="keywordflow">return</span> NULL;
<a name="l01586"></a>01586    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01587"></a>01587       <span class="keywordflow">return</span> NULL;
<a name="l01588"></a>01588    }  
<a name="l01589"></a>01589    
<a name="l01590"></a>01590    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01591"></a>01591 }
<a name="l01592"></a>01592 
<a name="l01593"></a><a class="code" href="chan__jingle_8c.html#ae41dca6e6b09e23978bc504c73f5e9b3">01593</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#ae41dca6e6b09e23978bc504c73f5e9b3">jingle_parser</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, ikspak *pak)
<a name="l01594"></a>01594 {
<a name="l01595"></a>01595    <span class="keyword">struct </span><a class="code" href="structjingle.html">jingle</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *) data);
<a name="l01596"></a>01596    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Filter matched\n&quot;</span>);
<a name="l01597"></a>01597 
<a name="l01598"></a>01598    <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;x, <a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>, <span class="stringliteral">&quot;action&quot;</span>, <a class="code" href="jingle_8h.html#ad05540eb25cc052cd82a4c583cba6c04">JINGLE_INITIATE</a>)) {
<a name="l01599"></a>01599       <span class="comment">/* New call */</span>
<a name="l01600"></a>01600       <a class="code" href="chan__jingle_8c.html#a31ea3edffa52cddd40a4d09e72ca4e22">jingle_newcall</a>(client, pak);
<a name="l01601"></a>01601    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;x, <a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>, <span class="stringliteral">&quot;action&quot;</span>, <a class="code" href="jingle_8h.html#a277775bf41c7046d80633540e35eb44a">JINGLE_NEGOTIATE</a>)) {
<a name="l01602"></a>01602       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;About to add candidate!\n&quot;</span>);
<a name="l01603"></a>01603       <a class="code" href="chan__jingle_8c.html#a82d949d005a515d982d334710a630d05">jingle_add_candidate</a>(client, pak);
<a name="l01604"></a>01604       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Candidate Added!\n&quot;</span>);
<a name="l01605"></a>01605    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;x, <a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>, <span class="stringliteral">&quot;action&quot;</span>, <a class="code" href="jingle_8h.html#ad67040ebd300cf34ffe584220bd41bc9">JINGLE_ACCEPT</a>)) {
<a name="l01606"></a>01606       <a class="code" href="chan__jingle_8c.html#a53d306c6b246e8533657ae7e0f8f7e4d">jingle_is_answered</a>(client, pak);
<a name="l01607"></a>01607    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;x, <a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>, <span class="stringliteral">&quot;action&quot;</span>, <a class="code" href="jingle_8h.html#ac7a3ba4bc3969d938188332d8829ac2a">JINGLE_INFO</a>)) {
<a name="l01608"></a>01608       <a class="code" href="chan__jingle_8c.html#aa55267bdc9fcd7969f520178957f92e8">jingle_handle_dtmf</a>(client, pak);
<a name="l01609"></a>01609    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;x, <a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>, <span class="stringliteral">&quot;action&quot;</span>, <a class="code" href="jingle_8h.html#acccffceb2c3133ae5b1aca465add5591">JINGLE_TERMINATE</a>)) {
<a name="l01610"></a>01610       <a class="code" href="chan__jingle_8c.html#a978d85fda394a28219d944dfec8982bc">jingle_hangup_farend</a>(client, pak);
<a name="l01611"></a>01611    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;x, <a class="code" href="jingle_8h.html#abf1e331949a1e9d28eda6653d8e7cb3d">JINGLE_NODE</a>, <span class="stringliteral">&quot;action&quot;</span>, <span class="stringliteral">&quot;reject&quot;</span>)) {
<a name="l01612"></a>01612       <a class="code" href="chan__jingle_8c.html#a978d85fda394a28219d944dfec8982bc">jingle_hangup_farend</a>(client, pak);
<a name="l01613"></a>01613    }
<a name="l01614"></a>01614    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="chan__jingle_8c.html#a93c625eb4d713d669ca85bc087ea6940">jingle_member_destroy</a>);
<a name="l01615"></a>01615    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01616"></a>01616 }
<a name="l01617"></a>01617 <span class="comment">/* Not using this anymore probably take out soon </span>
<a name="l01618"></a>01618 <span class="comment">static struct jingle_candidate *jingle_create_candidate(char *args)</span>
<a name="l01619"></a>01619 <span class="comment">{</span>
<a name="l01620"></a>01620 <span class="comment">   char *name, *type, *preference, *protocol;</span>
<a name="l01621"></a>01621 <span class="comment">   struct jingle_candidate *res;</span>
<a name="l01622"></a>01622 <span class="comment">   res = ast_calloc(1, sizeof(*res));</span>
<a name="l01623"></a>01623 <span class="comment">   if (args)</span>
<a name="l01624"></a>01624 <span class="comment">      name = args;</span>
<a name="l01625"></a>01625 <span class="comment">   if ((args = strchr(args, &apos;,&apos;))) {</span>
<a name="l01626"></a>01626 <span class="comment">      *args = &apos;\0&apos;;</span>
<a name="l01627"></a>01627 <span class="comment">      args++;</span>
<a name="l01628"></a>01628 <span class="comment">      preference = args;</span>
<a name="l01629"></a>01629 <span class="comment">   }</span>
<a name="l01630"></a>01630 <span class="comment">   if ((args = strchr(args, &apos;,&apos;))) {</span>
<a name="l01631"></a>01631 <span class="comment">      *args = &apos;\0&apos;;</span>
<a name="l01632"></a>01632 <span class="comment">      args++;</span>
<a name="l01633"></a>01633 <span class="comment">      protocol = args;</span>
<a name="l01634"></a>01634 <span class="comment">   }</span>
<a name="l01635"></a>01635 <span class="comment">   if ((args = strchr(args, &apos;,&apos;))) {</span>
<a name="l01636"></a>01636 <span class="comment">      *args = &apos;\0&apos;;</span>
<a name="l01637"></a>01637 <span class="comment">      args++;</span>
<a name="l01638"></a>01638 <span class="comment">      type = args;</span>
<a name="l01639"></a>01639 <span class="comment">   }</span>
<a name="l01640"></a>01640 <span class="comment">   if (name)</span>
<a name="l01641"></a>01641 <span class="comment">      ast_copy_string(res-&gt;name, name, sizeof(res-&gt;name));</span>
<a name="l01642"></a>01642 <span class="comment">   if (preference) {</span>
<a name="l01643"></a>01643 <span class="comment">      res-&gt;preference = atof(preference);</span>
<a name="l01644"></a>01644 <span class="comment">   }</span>
<a name="l01645"></a>01645 <span class="comment">   if (protocol) {</span>
<a name="l01646"></a>01646 <span class="comment">      if (!strcasecmp(&quot;udp&quot;, protocol))</span>
<a name="l01647"></a>01647 <span class="comment">         res-&gt;protocol = AJI_PROTOCOL_UDP;</span>
<a name="l01648"></a>01648 <span class="comment">      if (!strcasecmp(&quot;ssltcp&quot;, protocol))</span>
<a name="l01649"></a>01649 <span class="comment">         res-&gt;protocol = AJI_PROTOCOL_SSLTCP;</span>
<a name="l01650"></a>01650 <span class="comment">   }</span>
<a name="l01651"></a>01651 <span class="comment">   if (type) {</span>
<a name="l01652"></a>01652 <span class="comment">      if (!strcasecmp(&quot;host&quot;, type))</span>
<a name="l01653"></a>01653 <span class="comment">         res-&gt;type = AJI_CONNECT_HOST;</span>
<a name="l01654"></a>01654 <span class="comment">      if (!strcasecmp(&quot;prflx&quot;, type))</span>
<a name="l01655"></a>01655 <span class="comment">         res-&gt;type = AJI_CONNECT_PRFLX;</span>
<a name="l01656"></a>01656 <span class="comment">      if (!strcasecmp(&quot;relay&quot;, type))</span>
<a name="l01657"></a>01657 <span class="comment">         res-&gt;type = AJI_CONNECT_RELAY;</span>
<a name="l01658"></a>01658 <span class="comment">      if (!strcasecmp(&quot;srflx&quot;, type))</span>
<a name="l01659"></a>01659 <span class="comment">         res-&gt;type = AJI_CONNECT_SRFLX;</span>
<a name="l01660"></a>01660 <span class="comment">   }</span>
<a name="l01661"></a>01661 <span class="comment"></span>
<a name="l01662"></a>01662 <span class="comment">   return res;</span>
<a name="l01663"></a>01663 <span class="comment">}</span>
<a name="l01664"></a>01664 <span class="comment">*/</span>
<a name="l01665"></a>01665 
<a name="l01666"></a><a class="code" href="chan__jingle_8c.html#aa1c76c9e3fdb5f17bdf6721ca10bd0f3">01666</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#aa1c76c9e3fdb5f17bdf6721ca10bd0f3">jingle_create_member</a>(<span class="keywordtype">char</span> *label, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, <span class="keywordtype">int</span> <a class="code" href="structjingle.html#aba1ad8c6c1c296a19e3a11c50ed7c8d5">allowguest</a>,
<a name="l01667"></a>01667                         <span class="keyword">struct</span> <a class="code" href="structast__codec__pref.html">ast_codec_pref</a> <a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>,
<a name="l01668"></a>01668                         <span class="keyword">struct</span> <a class="code" href="structjingle.html">jingle</a> *<a class="code" href="structmember.html">member</a>)
<a name="l01669"></a>01669 {
<a name="l01670"></a>01670    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client;
<a name="l01671"></a>01671 
<a name="l01672"></a>01672    <span class="keywordflow">if</span> (!member)
<a name="l01673"></a>01673       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01674"></a>01674 
<a name="l01675"></a>01675    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(member-&gt;name, label, <span class="keyword">sizeof</span>(member-&gt;name));
<a name="l01676"></a>01676    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(member-&gt;<a class="code" href="structjingle.html#a5f369a232fb94d2f22a2d320d922ad7e">user</a>, label, <span class="keyword">sizeof</span>(member-&gt;<a class="code" href="structjingle.html#a5f369a232fb94d2f22a2d320d922ad7e">user</a>));
<a name="l01677"></a>01677    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(member-&gt;<a class="code" href="structjingle.html#aab27e7175d9a6d62b18d5968963820df">context</a>, context, <span class="keyword">sizeof</span>(member-&gt;<a class="code" href="structjingle.html#aab27e7175d9a6d62b18d5968963820df">context</a>));
<a name="l01678"></a>01678    member-&gt;<a class="code" href="structjingle.html#aba1ad8c6c1c296a19e3a11c50ed7c8d5">allowguest</a> = allowguest;
<a name="l01679"></a>01679    member-&gt;<a class="code" href="structjingle.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a> = prefs;
<a name="l01680"></a>01680    <span class="keywordflow">while</span> (var) {
<a name="l01681"></a>01681 <span class="preprocessor">#if 0</span>
<a name="l01682"></a>01682 <span class="preprocessor"></span>      <span class="keyword">struct </span><a class="code" href="structjingle__candidate.html">jingle_candidate</a> *candidate = NULL;
<a name="l01683"></a>01683 <span class="preprocessor">#endif</span>
<a name="l01684"></a>01684 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;username&quot;</span>))
<a name="l01685"></a>01685          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(member-&gt;<a class="code" href="structjingle.html#a5f369a232fb94d2f22a2d320d922ad7e">user</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(member-&gt;<a class="code" href="structjingle.html#a5f369a232fb94d2f22a2d320d922ad7e">user</a>));
<a name="l01686"></a>01686       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;disallow&quot;</span>))
<a name="l01687"></a>01687          <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(&amp;member-&gt;<a class="code" href="structjingle.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, &amp;member-&gt;<a class="code" href="structjingle.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 0);
<a name="l01688"></a>01688       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;allow&quot;</span>))
<a name="l01689"></a>01689          <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(&amp;member-&gt;<a class="code" href="structjingle.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, &amp;member-&gt;<a class="code" href="structjingle.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 1);
<a name="l01690"></a>01690       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;context&quot;</span>))
<a name="l01691"></a>01691          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(member-&gt;<a class="code" href="structjingle.html#aab27e7175d9a6d62b18d5968963820df">context</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(member-&gt;<a class="code" href="structjingle.html#aab27e7175d9a6d62b18d5968963820df">context</a>));
<a name="l01692"></a>01692 <span class="preprocessor">#if 0</span>
<a name="l01693"></a>01693 <span class="preprocessor"></span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;candidate&quot;</span>)) {
<a name="l01694"></a>01694          candidate = jingle_create_candidate(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01695"></a>01695          <span class="keywordflow">if</span> (candidate) {
<a name="l01696"></a>01696             candidate-&gt;<a class="code" href="structjingle__candidate.html#a345235cfff36c891ac94d7ea9a42a117">next</a> = member-&gt;ourcandidates;
<a name="l01697"></a>01697             member-&gt;ourcandidates = candidate;
<a name="l01698"></a>01698          }
<a name="l01699"></a>01699       }
<a name="l01700"></a>01700 <span class="preprocessor">#endif</span>
<a name="l01701"></a>01701 <span class="preprocessor"></span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;connection&quot;</span>)) {
<a name="l01702"></a>01702          <span class="keywordflow">if</span> ((client = <a class="code" href="jabber_8h.html#a6689c8e948c8d55e092f30277336fde7" title="grab a aji_client structure by label name or JID (without the resource string)">ast_aji_get_client</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))) {
<a name="l01703"></a>01703             member-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a> = client;
<a name="l01704"></a>01704             iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="chan__jingle_8c.html#ae41dca6e6b09e23978bc504c73f5e9b3">jingle_parser</a>, member,
<a name="l01705"></a>01705                       IKS_RULE_TYPE, IKS_PAK_IQ,
<a name="l01706"></a>01706                       IKS_RULE_FROM_PARTIAL, member-&gt;<a class="code" href="structjingle.html#a5f369a232fb94d2f22a2d320d922ad7e">user</a>,
<a name="l01707"></a>01707                       IKS_RULE_NS, <a class="code" href="jingle_8h.html#aea60c021ce1b84cb1e3fb03c325bf29d">JINGLE_NS</a>,
<a name="l01708"></a>01708                       IKS_RULE_DONE);
<a name="l01709"></a>01709          } <span class="keywordflow">else</span> {
<a name="l01710"></a>01710             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;connection referenced not found!\n&quot;</span>);
<a name="l01711"></a>01711             <span class="keywordflow">return</span> 0;
<a name="l01712"></a>01712          }
<a name="l01713"></a>01713       }
<a name="l01714"></a>01714       var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l01715"></a>01715    }
<a name="l01716"></a>01716    <span class="keywordflow">if</span> (member-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a> &amp;&amp; member-&gt;<a class="code" href="structjingle.html#a5f369a232fb94d2f22a2d320d922ad7e">user</a>)
<a name="l01717"></a>01717       member-&gt;<a class="code" href="structjingle.html#a2704a75322ea2a93cfbfd9ba4d08dad6">buddy</a> = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;member-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a>-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, member-&gt;<a class="code" href="structjingle.html#a5f369a232fb94d2f22a2d320d922ad7e">user</a>);
<a name="l01718"></a>01718    <span class="keywordflow">else</span> {
<a name="l01719"></a>01719       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;No Connection or Username!\n&quot;</span>);
<a name="l01720"></a>01720    }
<a name="l01721"></a>01721    <span class="keywordflow">return</span> 1;
<a name="l01722"></a>01722 }
<a name="l01723"></a>01723 
<a name="l01724"></a><a class="code" href="chan__jingle_8c.html#a608893b53761eca09ed29b9e1e073ba9">01724</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#a608893b53761eca09ed29b9e1e073ba9">jingle_load_config</a>(<span class="keywordtype">void</span>)
<a name="l01725"></a>01725 {
<a name="l01726"></a>01726    <span class="keywordtype">char</span> *cat = NULL;
<a name="l01727"></a>01727    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg = NULL;
<a name="l01728"></a>01728    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>[100];
<a name="l01729"></a>01729    <span class="keywordtype">int</span> allowguest = 1;
<a name="l01730"></a>01730    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l01731"></a>01731    <span class="keyword">struct </span><a class="code" href="structjingle.html">jingle</a> *<a class="code" href="structmember.html">member</a>;
<a name="l01732"></a>01732    <span class="keyword">struct </span>hostent *<a class="code" href="chan__skinny_8c.html#aa0f575fa3882aa394cc287edba645a35">hp</a>;
<a name="l01733"></a>01733    <span class="keyword">struct </span><a class="code" href="structast__hostent.html">ast_hostent</a> ahp;
<a name="l01734"></a>01734    <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> prefs;
<a name="l01735"></a>01735    <span class="keyword">struct </span><a class="code" href="structaji__client__container.html">aji_client_container</a> *<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>;
<a name="l01736"></a>01736    <span class="keyword">struct </span><a class="code" href="structjingle__candidate.html">jingle_candidate</a> *global_candidates = NULL;
<a name="l01737"></a>01737    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { 0 };
<a name="l01738"></a>01738 
<a name="l01739"></a>01739    cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="chan__jingle_8c.html#a0290b580e4c1cbac25d7e5dd388265ec">JINGLE_CONFIG</a>, config_flags);
<a name="l01740"></a>01740    <span class="keywordflow">if</span> (!cfg || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l01741"></a>01741       <span class="keywordflow">return</span> 0;
<a name="l01742"></a>01742    }
<a name="l01743"></a>01743 
<a name="l01744"></a>01744    <span class="comment">/* Copy the default jb config over global_jbconf */</span>
<a name="l01745"></a>01745    memcpy(&amp;<a class="code" href="chan__jingle_8c.html#abaabcb7f4349cc632dde3af5c6a5e1bd">global_jbconf</a>, &amp;default_jbconf, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__jb__conf.html" title="General jitterbuffer configuration.">ast_jb_conf</a>));
<a name="l01746"></a>01746 
<a name="l01747"></a>01747    cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, NULL);
<a name="l01748"></a>01748    <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01749"></a>01749       <span class="comment">/* handle jb conf */</span>
<a name="l01750"></a>01750       <span class="keywordflow">if</span> (!<a class="code" href="abstract__jb_8h.html#ae50ad081bd2ae6b58bcfc4687916c586" title="Sets jitterbuffer configuration property.">ast_jb_read_conf</a>(&amp;<a class="code" href="chan__jingle_8c.html#abaabcb7f4349cc632dde3af5c6a5e1bd">global_jbconf</a>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))
<a name="l01751"></a>01751          <span class="keywordflow">continue</span>;
<a name="l01752"></a>01752 
<a name="l01753"></a>01753       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;allowguest&quot;</span>))
<a name="l01754"></a>01754          allowguest =
<a name="l01755"></a>01755             (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;allowguest&quot;</span>))) ? 1 : 0;
<a name="l01756"></a>01756       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;disallow&quot;</span>))
<a name="l01757"></a>01757          <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(&amp;prefs, &amp;global_capability, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 0);
<a name="l01758"></a>01758       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;allow&quot;</span>))
<a name="l01759"></a>01759          <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(&amp;prefs, &amp;global_capability, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 1);
<a name="l01760"></a>01760       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;context&quot;</span>))
<a name="l01761"></a>01761          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(context, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(context));
<a name="l01762"></a>01762       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;externip&quot;</span>))
<a name="l01763"></a>01763          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(externip, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(externip));
<a name="l01764"></a>01764       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;bindaddr&quot;</span>)) {
<a name="l01765"></a>01765          <span class="keywordflow">if</span> (!(hp = <a class="code" href="utils_8h.html#ad3b63ee1041593219ef0765b28d70442" title="Thread-safe gethostbyname function to use in Asterisk.">ast_gethostbyname</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, &amp;ahp))) {
<a name="l01766"></a>01766             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid address: %s\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01767"></a>01767          } <span class="keywordflow">else</span> {
<a name="l01768"></a>01768             memcpy(&amp;bindaddr.sin_addr, hp-&gt;h_addr, <span class="keyword">sizeof</span>(bindaddr.sin_addr));
<a name="l01769"></a>01769          }
<a name="l01770"></a>01770       }
<a name="l01771"></a>01771 <span class="comment">/*  Idea to allow for custom candidates  */</span>
<a name="l01772"></a>01772 <span class="comment">/*</span>
<a name="l01773"></a>01773 <span class="comment">      else if (!strcasecmp(var-&gt;name, &quot;candidate&quot;)) {</span>
<a name="l01774"></a>01774 <span class="comment">         candidate = jingle_create_candidate(var-&gt;value);</span>
<a name="l01775"></a>01775 <span class="comment">         if (candidate) {</span>
<a name="l01776"></a>01776 <span class="comment">            candidate-&gt;next = global_candidates;</span>
<a name="l01777"></a>01777 <span class="comment">            global_candidates = candidate;</span>
<a name="l01778"></a>01778 <span class="comment">         }</span>
<a name="l01779"></a>01779 <span class="comment">      }</span>
<a name="l01780"></a>01780 <span class="comment">*/</span>
<a name="l01781"></a>01781    }
<a name="l01782"></a>01782    <span class="keywordflow">while</span> (cat) {
<a name="l01783"></a>01783       <span class="keywordflow">if</span> (strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>)) {
<a name="l01784"></a>01784          var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat);
<a name="l01785"></a>01785          member = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*member));
<a name="l01786"></a>01786          <a class="code" href="astobj_8h.html#a996db3d193843755068f61f21e14c3dd" title="Initialize an object.">ASTOBJ_INIT</a>(member);
<a name="l01787"></a>01787          <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(member);
<a name="l01788"></a>01788          <span class="keywordflow">if</span> (!strcasecmp(cat, <span class="stringliteral">&quot;guest&quot;</span>)) {
<a name="l01789"></a>01789             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(member-&gt;name, <span class="stringliteral">&quot;guest&quot;</span>, <span class="keyword">sizeof</span>(member-&gt;name));
<a name="l01790"></a>01790             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(member-&gt;<a class="code" href="structjingle.html#a5f369a232fb94d2f22a2d320d922ad7e">user</a>, <span class="stringliteral">&quot;guest&quot;</span>, <span class="keyword">sizeof</span>(member-&gt;<a class="code" href="structjingle.html#a5f369a232fb94d2f22a2d320d922ad7e">user</a>));
<a name="l01791"></a>01791             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(member-&gt;<a class="code" href="structjingle.html#aab27e7175d9a6d62b18d5968963820df">context</a>, context, <span class="keyword">sizeof</span>(member-&gt;<a class="code" href="structjingle.html#aab27e7175d9a6d62b18d5968963820df">context</a>));
<a name="l01792"></a>01792             member-&gt;<a class="code" href="structjingle.html#aba1ad8c6c1c296a19e3a11c50ed7c8d5">allowguest</a> = allowguest;
<a name="l01793"></a>01793             member-&gt;<a class="code" href="structjingle.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a> = prefs;
<a name="l01794"></a>01794             <span class="keywordflow">while</span> (var) {
<a name="l01795"></a>01795                <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;disallow&quot;</span>))
<a name="l01796"></a>01796                   <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(&amp;member-&gt;<a class="code" href="structjingle.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, &amp;member-&gt;<a class="code" href="structjingle.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>,
<a name="l01797"></a>01797                                      var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 0);
<a name="l01798"></a>01798                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;allow&quot;</span>))
<a name="l01799"></a>01799                   <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(&amp;member-&gt;<a class="code" href="structjingle.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, &amp;member-&gt;<a class="code" href="structjingle.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>,
<a name="l01800"></a>01800                                      var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 1);
<a name="l01801"></a>01801                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;context&quot;</span>))
<a name="l01802"></a>01802                   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(member-&gt;<a class="code" href="structjingle.html#aab27e7175d9a6d62b18d5968963820df">context</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>,
<a name="l01803"></a>01803                               <span class="keyword">sizeof</span>(member-&gt;<a class="code" href="structjingle.html#aab27e7175d9a6d62b18d5968963820df">context</a>));
<a name="l01804"></a>01804                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkinglot&quot;</span>))
<a name="l01805"></a>01805                   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(member-&gt;<a class="code" href="structjingle.html#a6b31bfcc769a5b5c31e13aa6d8a9a286">parkinglot</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>,
<a name="l01806"></a>01806                               <span class="keyword">sizeof</span>(member-&gt;<a class="code" href="structjingle.html#a6b31bfcc769a5b5c31e13aa6d8a9a286">parkinglot</a>));
<a name="l01807"></a>01807 <span class="comment">/*  Idea to allow for custom candidates  */</span>
<a name="l01808"></a>01808 <span class="comment">/*</span>
<a name="l01809"></a>01809 <span class="comment">               else if (!strcasecmp(var-&gt;name, &quot;candidate&quot;)) {</span>
<a name="l01810"></a>01810 <span class="comment">                  candidate = jingle_create_candidate(var-&gt;value);</span>
<a name="l01811"></a>01811 <span class="comment">                  if (candidate) {</span>
<a name="l01812"></a>01812 <span class="comment">                     candidate-&gt;next = member-&gt;ourcandidates;</span>
<a name="l01813"></a>01813 <span class="comment">                     member-&gt;ourcandidates = candidate;</span>
<a name="l01814"></a>01814 <span class="comment">                  }</span>
<a name="l01815"></a>01815 <span class="comment">               }</span>
<a name="l01816"></a>01816 <span class="comment">*/</span>
<a name="l01817"></a>01817                var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l01818"></a>01818             }
<a name="l01819"></a>01819             <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(member);
<a name="l01820"></a>01820             clients = <a class="code" href="jabber_8h.html#a740bf5f4ba6bf40ff9273ca8f7a89710">ast_aji_get_clients</a>();
<a name="l01821"></a>01821             <span class="keywordflow">if</span> (clients) {
<a name="l01822"></a>01822                <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(clients, 1, {
<a name="l01823"></a>01823                   <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(iterator);
<a name="l01824"></a>01824                   <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(member);
<a name="l01825"></a>01825                   member-&gt;<a class="code" href="structjingle.html#a22eb965539587ef7d2b0340d57159e3a">connection</a> = NULL;
<a name="l01826"></a>01826                   iks_filter_add_rule(iterator-&gt;f, <a class="code" href="chan__jingle_8c.html#ae41dca6e6b09e23978bc504c73f5e9b3">jingle_parser</a>, member, IKS_RULE_TYPE, IKS_PAK_IQ, IKS_RULE_NS, <a class="code" href="jingle_8h.html#aea60c021ce1b84cb1e3fb03c325bf29d">JINGLE_NS</a>, IKS_RULE_DONE);
<a name="l01827"></a>01827                   iks_filter_add_rule(iterator-&gt;f, <a class="code" href="chan__jingle_8c.html#ae41dca6e6b09e23978bc504c73f5e9b3">jingle_parser</a>, member, IKS_RULE_TYPE, IKS_PAK_IQ, IKS_RULE_NS, <a class="code" href="jingle_8h.html#a2150f17d5f37efaa379d03b3f676564e">JINGLE_DTMF_NS</a>, IKS_RULE_DONE);
<a name="l01828"></a>01828                   <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(member);
<a name="l01829"></a>01829                   <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l01830"></a>01830                });
<a name="l01831"></a>01831                <a class="code" href="astobj_8h.html#a73bb2d9f59430fd47007a3c6ea651de6" title="Add an object to a container.">ASTOBJ_CONTAINER_LINK</a>(&amp;<a class="code" href="chan__jingle_8c.html#a42d49d41c6e229f83e18d7623ca150f5">jingle_list</a>, member);
<a name="l01832"></a>01832             } <span class="keywordflow">else</span> {
<a name="l01833"></a>01833                <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(member);
<a name="l01834"></a>01834                <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(member, <a class="code" href="chan__jingle_8c.html#a93c625eb4d713d669ca85bc087ea6940">jingle_member_destroy</a>);
<a name="l01835"></a>01835             }
<a name="l01836"></a>01836          } <span class="keywordflow">else</span> {
<a name="l01837"></a>01837             <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(member);
<a name="l01838"></a>01838             <span class="keywordflow">if</span> (<a class="code" href="chan__jingle_8c.html#aa1c76c9e3fdb5f17bdf6721ca10bd0f3">jingle_create_member</a>(cat, var, allowguest, prefs, context, member))
<a name="l01839"></a>01839                <a class="code" href="astobj_8h.html#a73bb2d9f59430fd47007a3c6ea651de6" title="Add an object to a container.">ASTOBJ_CONTAINER_LINK</a>(&amp;<a class="code" href="chan__jingle_8c.html#a42d49d41c6e229f83e18d7623ca150f5">jingle_list</a>, member);
<a name="l01840"></a>01840             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(member, <a class="code" href="chan__jingle_8c.html#a93c625eb4d713d669ca85bc087ea6940">jingle_member_destroy</a>);
<a name="l01841"></a>01841          }
<a name="l01842"></a>01842       }
<a name="l01843"></a>01843       cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, cat);
<a name="l01844"></a>01844    }
<a name="l01845"></a>01845    <a class="code" href="chan__jingle_8c.html#a0bdba68d7d2438f2629353986609ee19">jingle_free_candidates</a>(global_candidates);
<a name="l01846"></a>01846    <span class="keywordflow">return</span> 1;
<a name="l01847"></a>01847 }
<a name="l01848"></a>01848 <span class="comment"></span>
<a name="l01849"></a>01849 <span class="comment">/*! \brief Load module into PBX, register channel */</span>
<a name="l01850"></a><a class="code" href="chan__jingle_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">01850</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9" title="Load module into PBX, register channel.">load_module</a>(<span class="keywordtype">void</span>)
<a name="l01851"></a>01851 {
<a name="l01852"></a>01852    <span class="keywordtype">char</span> *jabber_loaded = <a class="code" href="module_8h.html#a2114c90d58e7c3c3638965d1811301e9" title="Match modules names for the Asterisk cli.">ast_module_helper</a>(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;res_jabber.so&quot;</span>, 0, 0, 0, 0);
<a name="l01853"></a>01853    <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(jabber_loaded);
<a name="l01854"></a>01854    <span class="keywordflow">if</span> (!jabber_loaded) {
<a name="l01855"></a>01855       <span class="comment">/* Dependency module has a different name, if embedded */</span>
<a name="l01856"></a>01856       jabber_loaded = <a class="code" href="module_8h.html#a2114c90d58e7c3c3638965d1811301e9" title="Match modules names for the Asterisk cli.">ast_module_helper</a>(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;res_jabber&quot;</span>, 0, 0, 0, 0);
<a name="l01857"></a>01857       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(jabber_loaded);
<a name="l01858"></a>01858       <span class="keywordflow">if</span> (!jabber_loaded) {
<a name="l01859"></a>01859          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;chan_jingle.so depends upon res_jabber.so\n&quot;</span>);
<a name="l01860"></a>01860          <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01861"></a>01861       }
<a name="l01862"></a>01862    }
<a name="l01863"></a>01863 
<a name="l01864"></a>01864    <a class="code" href="astobj_8h.html#a8551f606c8aecc4797ef7728c7792827" title="Initialize a container.">ASTOBJ_CONTAINER_INIT</a>(&amp;<a class="code" href="chan__jingle_8c.html#a42d49d41c6e229f83e18d7623ca150f5">jingle_list</a>);
<a name="l01865"></a>01865    <span class="keywordflow">if</span> (!<a class="code" href="chan__jingle_8c.html#a608893b53761eca09ed29b9e1e073ba9">jingle_load_config</a>()) {
<a name="l01866"></a>01866       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to read config file %s. Not loading module.\n&quot;</span>, <a class="code" href="chan__jingle_8c.html#a0290b580e4c1cbac25d7e5dd388265ec">JINGLE_CONFIG</a>);
<a name="l01867"></a>01867       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01868"></a>01868    }
<a name="l01869"></a>01869 
<a name="l01870"></a>01870    sched = <a class="code" href="sched_8h.html#ad4fd5c63d5d3dcc8e11bec644c601017" title="New schedule context.">sched_context_create</a>();
<a name="l01871"></a>01871    <span class="keywordflow">if</span> (!sched) 
<a name="l01872"></a>01872       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create schedule context\n&quot;</span>);
<a name="l01873"></a>01873 
<a name="l01874"></a>01874    io = <a class="code" href="io_8h.html#a7d66d121ef63109c2f55188a38b8240f" title="Creates a context Create a context for I/O operations Basically mallocs an IO structure...">io_context_create</a>();
<a name="l01875"></a>01875    <span class="keywordflow">if</span> (!io) 
<a name="l01876"></a>01876       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create I/O context\n&quot;</span>);
<a name="l01877"></a>01877 
<a name="l01878"></a>01878    <span class="keywordflow">if</span> (<a class="code" href="acl_8h.html#a4fbb9258573d41461c7389afbcbba377">ast_find_ourip</a>(&amp;<a class="code" href="chan__jingle_8c.html#a1d084b82cb21102ba46ea60d3cd9c085">__ourip</a>, bindaddr)) {
<a name="l01879"></a>01879       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to get own IP address, Jingle disabled\n&quot;</span>);
<a name="l01880"></a>01880       <span class="keywordflow">return</span> 0;
<a name="l01881"></a>01881    }
<a name="l01882"></a>01882 
<a name="l01883"></a>01883    <a class="code" href="rtp_8h.html#a00b94396faf3f52b0c3ea612a9af334d" title="Register an RTP channel client.">ast_rtp_proto_register</a>(&amp;jingle_rtp);
<a name="l01884"></a>01884    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(jingle_cli, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(jingle_cli));
<a name="l01885"></a>01885    <span class="comment">/* Make sure we can register our channel type */</span>
<a name="l01886"></a>01886    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#ab5f3776fda943e52820ceeee5835c1b4" title="Register a channel technology (a new channel driver) Called by a channel module to...">ast_channel_register</a>(&amp;jingle_tech)) {
<a name="l01887"></a>01887       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to register channel class %s\n&quot;</span>, channel_type);
<a name="l01888"></a>01888       <span class="keywordflow">return</span> -1;
<a name="l01889"></a>01889    }
<a name="l01890"></a>01890    <span class="keywordflow">return</span> 0;
<a name="l01891"></a>01891 }
<a name="l01892"></a>01892 <span class="comment"></span>
<a name="l01893"></a>01893 <span class="comment">/*! \brief Reload module */</span>
<a name="l01894"></a><a class="code" href="chan__jingle_8c.html#ad1982509765f4870f1f63412a53ea668">01894</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__jingle_8c.html#ad1982509765f4870f1f63412a53ea668" title="Reload module.">reload</a>(<span class="keywordtype">void</span>)
<a name="l01895"></a>01895 {
<a name="l01896"></a>01896    <span class="keywordflow">return</span> 0;
<a name="l01897"></a>01897 }
<a name="l01898"></a>01898 <span class="comment"></span>
<a name="l01899"></a>01899 <span class="comment">/*! \brief Unload the jingle channel from Asterisk */</span>
<a name="l01900"></a><a class="code" href="chan__jingle_8c.html#ad09fa931f468002152a3cc2d5ce25eae">01900</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l01901"></a>01901 {
<a name="l01902"></a>01902    <span class="keyword">struct </span><a class="code" href="structjingle__pvt.html">jingle_pvt</a> *privates = NULL;
<a name="l01903"></a>01903    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(jingle_cli, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(jingle_cli));
<a name="l01904"></a>01904    <span class="comment">/* First, take us out of the channel loop */</span>
<a name="l01905"></a>01905    <a class="code" href="channel_8h.html#a53b708b7fc71dcbcd33acae0ad4d7ef8" title="Unregister a channel technology.">ast_channel_unregister</a>(&amp;jingle_tech);
<a name="l01906"></a>01906    <a class="code" href="rtp_8h.html#a39d797fe6097e914323998f72b13420c" title="Unregister an RTP channel client.">ast_rtp_proto_unregister</a>(&amp;jingle_rtp);
<a name="l01907"></a>01907 
<a name="l01908"></a>01908    <span class="keywordflow">if</span> (!<a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;jinglelock)) {
<a name="l01909"></a>01909       <span class="comment">/* Hangup all interfaces if they have an owner */</span>
<a name="l01910"></a>01910       <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="chan__jingle_8c.html#a42d49d41c6e229f83e18d7623ca150f5">jingle_list</a>, 1, {
<a name="l01911"></a>01911          <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(iterator);
<a name="l01912"></a>01912          privates = iterator-&gt;p;
<a name="l01913"></a>01913          <span class="keywordflow">while</span>(privates) {
<a name="l01914"></a>01914             <span class="keywordflow">if</span> (privates-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)
<a name="l01915"></a>01915                <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(privates-&gt;<a class="code" href="structjingle__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709aeeafae6abd77156800ec76b0ff7d3867">AST_SOFTHANGUP_APPUNLOAD</a>);
<a name="l01916"></a>01916             privates = privates-&gt;<a class="code" href="structjingle__pvt.html#ab1428ea08884c0a60e2fbe3d29ba1a3c">next</a>;
<a name="l01917"></a>01917          }
<a name="l01918"></a>01918          iterator-&gt;p = NULL;
<a name="l01919"></a>01919          <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l01920"></a>01920       });
<a name="l01921"></a>01921       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;jinglelock);
<a name="l01922"></a>01922    } <span class="keywordflow">else</span> {
<a name="l01923"></a>01923       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to lock the monitor\n&quot;</span>);
<a name="l01924"></a>01924       <span class="keywordflow">return</span> -1;
<a name="l01925"></a>01925    }
<a name="l01926"></a>01926    <a class="code" href="astobj_8h.html#a5b923418ce1d4908359bb3b27b211411" title="Empty a container.">ASTOBJ_CONTAINER_DESTROYALL</a>(&amp;<a class="code" href="chan__jingle_8c.html#a42d49d41c6e229f83e18d7623ca150f5">jingle_list</a>, <a class="code" href="chan__jingle_8c.html#a93c625eb4d713d669ca85bc087ea6940">jingle_member_destroy</a>);
<a name="l01927"></a>01927    <a class="code" href="astobj_8h.html#a49ab9467549d53be33f3f9f3ecae97f9" title="Destroy a container.">ASTOBJ_CONTAINER_DESTROY</a>(&amp;<a class="code" href="chan__jingle_8c.html#a42d49d41c6e229f83e18d7623ca150f5">jingle_list</a>);
<a name="l01928"></a>01928    <span class="keywordflow">return</span> 0;
<a name="l01929"></a>01929 }
<a name="l01930"></a>01930 
<a name="l01931"></a>01931 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <span class="stringliteral">&quot;Jingle Channel Driver&quot;</span>,
<a name="l01932"></a>01932       .load = <a class="code" href="chan__jingle_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9" title="Load module into PBX, register channel.">load_module</a>,
<a name="l01933"></a>01933       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l01934"></a>01934       .<a class="code" href="chan__jingle_8c.html#ad1982509765f4870f1f63412a53ea668" title="Reload module.">reload</a> = <a class="code" href="chan__jingle_8c.html#ad1982509765f4870f1f63412a53ea668" title="Reload module.">reload</a>,
<a name="l01935"></a>01935           );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:33 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
