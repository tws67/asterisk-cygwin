<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:23:31 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_1ab815038f534adda65c8b4ae4993449.html">include</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_16d825f1fa9ecca2e70b1a8d9256d0e6.html">asterisk</a>
  </div>
</div>
<div class="contents">
<h1>tcptls.h File Reference</h1>
<p>Generic support for tcp/tls servers in Asterisk.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &lt;openssl/ssl.h&gt;</code><br/>
<code>#include &lt;openssl/err.h&gt;</code><br/>

<p><a href="tcptls_8h_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__tcptls__session__args.html">ast_tcptls_session_args</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">arguments for the accepting thread  <a href="structast__tcptls__session__args.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__tls__config.html">ast_tls_config</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#a1850a109f5255895d75980912723ae7c">AST_CERTFILE</a>&nbsp;&nbsp;&nbsp;&quot;asterisk.pem&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#a7771602f42db0453fab887c997cd05e1">DO_SSL</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#aa63ba314dbe0a2b65c79f047de3244c6">HOOK_T</a>&nbsp;&nbsp;&nbsp;int</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#a5af8c911aa793e61d90637ed34b3a0b1">LEN_T</a>&nbsp;&nbsp;&nbsp;int</td></tr>
<tr><td colspan="2"><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#a667a09d76fe878551ac296875754971c">ast_ssl_flags</a> { <a class="el" href="tcptls_8h.html#a667a09d76fe878551ac296875754971ca26806f8aa1f6534c10f6bfe0989948ab">AST_SSL_VERIFY_CLIENT</a> =  (1 &lt;&lt; 0), 
<a class="el" href="tcptls_8h.html#a667a09d76fe878551ac296875754971ca53c54dbfbad41c1a7ecd6caaf0b06cba">AST_SSL_DONT_VERIFY_SERVER</a> =  (1 &lt;&lt; 1), 
<a class="el" href="tcptls_8h.html#a667a09d76fe878551ac296875754971ca8845bda4b8cce494a3c4bbc2828143f7">AST_SSL_IGNORE_COMMON_NAME</a> =  (1 &lt;&lt; 2)
 }</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#a24ff4bad1d2894ae3cae4e555d508fd0">ast_ssl_setup</a> (struct <a class="el" href="structast__tls__config.html">ast_tls_config</a> *cfg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <br class="typebreak"/>
<a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#a9bf6d5b9eb8b646983d127c2b1ac1822">ast_tcptls_client_create</a> (struct <a class="el" href="structast__tcptls__session__args.html">ast_tcptls_session_args</a> *<a class="el" href="channel_8c.html#a710bce51374aba96ab04912897666c35">desc</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <br class="typebreak"/>
<a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#afbdc75838c2b7c41b7cb4a7740f49851">ast_tcptls_client_start</a> (struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *tcptls_session)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">attempts to connect and start tcptls session, on error the tcptls_session's ref count is decremented, fd and file are closed, and NULL is returned.  <a href="#afbdc75838c2b7c41b7cb4a7740f49851"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">HOOK_T&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#a426e0abcf151912ad078e9655bd8e4b7">ast_tcptls_server_read</a> (struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *ser, void *<a class="el" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, size_t count)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#ac1fd2d3038c57a8f8f28f4b558eb5583">ast_tcptls_server_root</a> (void *)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#a29375a4482c8de1e9879b97be2e88bf0">ast_tcptls_server_start</a> (struct <a class="el" href="structast__tcptls__session__args.html">ast_tcptls_session_args</a> *<a class="el" href="channel_8c.html#a710bce51374aba96ab04912897666c35">desc</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This is a generic (re)start routine for a TCP server, which does the socket/bind/listen and starts a thread for handling accept().  <a href="#a29375a4482c8de1e9879b97be2e88bf0"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#a1fd4aa5038c9a488acc0f8017fe94fda">ast_tcptls_server_stop</a> (struct <a class="el" href="structast__tcptls__session__args.html">ast_tcptls_session_args</a> *<a class="el" href="channel_8c.html#a710bce51374aba96ab04912897666c35">desc</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Shutdown a running server if there is one.  <a href="#a1fd4aa5038c9a488acc0f8017fe94fda"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">HOOK_T&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="tcptls_8h.html#aed875d836e7109975c3a1710f9cf6760">ast_tcptls_server_write</a> (struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *ser, const void *<a class="el" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, size_t count)</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Generic support for tcp/tls servers in Asterisk. </p>
<dl class="note"><dt><b>Note:</b></dt><dd>In order to have TLS/SSL support, we need the openssl libraries. Still we can decide whether or not to use them by commenting in or out the DO_SSL macro.</dd></dl>
<p>TLS/SSL support is basically implemented by reading from a config file (currently http.conf and sip.conf) the names of the certificate and cipher to use, and then run ssl_setup() to create an appropriate SSL_CTX (ssl_ctx) If we support multiple domains, presumably we need to read multiple certificates.</p>
<p>When we are requested to open a TLS socket, we run make_file_from_fd() on the socket, to do the necessary setup. At the moment the context's name is hardwired in the function, but we can certainly make it into an extra parameter to the function.</p>
<p>We declare most of ssl support variables unconditionally, because their <a class="el" href="structnumber.html" title="Number structure.">number</a> is small and this simplifies the code.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>The ssl-support variables (ssl_ctx, do_ssl, certfile, cipher) and their setup should be moved to a more central place, e.g. asterisk.conf and the source files that processes it. Similarly, ssl_setup() should be run earlier in the startup process so modules have it available. </dd></dl>

<p>Definition in file <a class="el" href="tcptls_8h_source.html">tcptls.h</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a1850a109f5255895d75980912723ae7c"></a><!-- doxytag: member="tcptls.h::AST_CERTFILE" ref="a1850a109f5255895d75980912723ae7c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define AST_CERTFILE&nbsp;&nbsp;&nbsp;&quot;asterisk.pem&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>SSL support </p>

<p>Definition at line <a class="el" href="tcptls_8h_source.html#l00067">67</a> of file <a class="el" href="tcptls_8h_source.html">tcptls.h</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l00848">__ast_http_load()</a>, <a class="el" href="manager_8c_source.html#l04061">__init_manager()</a>, and <a class="el" href="chan__sip_8c_source.html#l24245">reload_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a7771602f42db0453fab887c997cd05e1"></a><!-- doxytag: member="tcptls.h::DO_SSL" ref="a7771602f42db0453fab887c997cd05e1" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DO_SSL</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="tcptls_8h_source.html#l00054">54</a> of file <a class="el" href="tcptls_8h_source.html">tcptls.h</a>.</p>

</div>
</div>
<a class="anchor" id="aa63ba314dbe0a2b65c79f047de3244c6"></a><!-- doxytag: member="tcptls.h::HOOK_T" ref="aa63ba314dbe0a2b65c79f047de3244c6" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define HOOK_T&nbsp;&nbsp;&nbsp;int</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="tcptls_8h_source.html#l00145">145</a> of file <a class="el" href="tcptls_8h_source.html">tcptls.h</a>.</p>

</div>
</div>
<a class="anchor" id="a5af8c911aa793e61d90637ed34b3a0b1"></a><!-- doxytag: member="tcptls.h::LEN_T" ref="a5af8c911aa793e61d90637ed34b3a0b1" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LEN_T&nbsp;&nbsp;&nbsp;int</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="tcptls_8h_source.html#l00146">146</a> of file <a class="el" href="tcptls_8h_source.html">tcptls.h</a>.</p>

</div>
</div>
<hr/><h2>Enumeration Type Documentation</h2>
<a class="anchor" id="a667a09d76fe878551ac296875754971c"></a><!-- doxytag: member="tcptls.h::ast_ssl_flags" ref="a667a09d76fe878551ac296875754971c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="tcptls_8h.html#a667a09d76fe878551ac296875754971c">ast_ssl_flags</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="a667a09d76fe878551ac296875754971ca26806f8aa1f6534c10f6bfe0989948ab"></a><!-- doxytag: member="AST_SSL_VERIFY_CLIENT" ref="a667a09d76fe878551ac296875754971ca26806f8aa1f6534c10f6bfe0989948ab" args="" -->AST_SSL_VERIFY_CLIENT</em>&nbsp;</td><td>
<p>Verify certificate when acting as server </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="a667a09d76fe878551ac296875754971ca53c54dbfbad41c1a7ecd6caaf0b06cba"></a><!-- doxytag: member="AST_SSL_DONT_VERIFY_SERVER" ref="a667a09d76fe878551ac296875754971ca53c54dbfbad41c1a7ecd6caaf0b06cba" args="" -->AST_SSL_DONT_VERIFY_SERVER</em>&nbsp;</td><td>
<p>Don't verify certificate when connecting to a server </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="a667a09d76fe878551ac296875754971ca8845bda4b8cce494a3c4bbc2828143f7"></a><!-- doxytag: member="AST_SSL_IGNORE_COMMON_NAME" ref="a667a09d76fe878551ac296875754971ca8845bda4b8cce494a3c4bbc2828143f7" args="" -->AST_SSL_IGNORE_COMMON_NAME</em>&nbsp;</td><td>
<p>Don't compare "Common Name" against IP or hostname </p>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="tcptls_8h_source.html#l00069">69</a> of file <a class="el" href="tcptls_8h_source.html">tcptls.h</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00069"></a>00069                    {<span class="comment"></span>
<a name="l00070"></a>00070 <span class="comment">   /*! Verify certificate when acting as server */</span>
<a name="l00071"></a>00071    <a class="code" href="tcptls_8h.html#a667a09d76fe878551ac296875754971ca26806f8aa1f6534c10f6bfe0989948ab">AST_SSL_VERIFY_CLIENT</a> = (1 &lt;&lt; 0),<span class="comment"></span>
<a name="l00072"></a>00072 <span class="comment">   /*! Don&apos;t verify certificate when connecting to a server */</span>
<a name="l00073"></a>00073    <a class="code" href="tcptls_8h.html#a667a09d76fe878551ac296875754971ca53c54dbfbad41c1a7ecd6caaf0b06cba">AST_SSL_DONT_VERIFY_SERVER</a> = (1 &lt;&lt; 1),<span class="comment"></span>
<a name="l00074"></a>00074 <span class="comment">   /*! Don&apos;t compare &quot;Common Name&quot; against IP or hostname */</span>
<a name="l00075"></a>00075    <a class="code" href="tcptls_8h.html#a667a09d76fe878551ac296875754971ca8845bda4b8cce494a3c4bbc2828143f7">AST_SSL_IGNORE_COMMON_NAME</a> = (1 &lt;&lt; 2)
<a name="l00076"></a>00076 };
</pre></div></p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a24ff4bad1d2894ae3cae4e555d508fd0"></a><!-- doxytag: member="tcptls.h::ast_ssl_setup" ref="a24ff4bad1d2894ae3cae4e555d508fd0" args="(struct ast_tls_config *cfg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_ssl_setup </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__tls__config.html">ast_tls_config</a> *&nbsp;</td>
          <td class="paramname"> <em>cfg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="tcptls_8c_source.html#l00334">334</a> of file <a class="el" href="tcptls_8c_source.html">tcptls.c</a>.</p>

<p>References <a class="el" href="tcptls_8c_source.html#l00284">__ssl_setup()</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l00848">__ast_http_load()</a>, <a class="el" href="manager_8c_source.html#l04061">__init_manager()</a>, and <a class="el" href="chan__sip_8c_source.html#l24245">reload_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00335"></a>00335 {
<a name="l00336"></a>00336    <span class="keywordflow">return</span> <a class="code" href="tcptls_8c.html#a12ec3b45ca50a675005cf5d336a4e496">__ssl_setup</a>(cfg, 0);
<a name="l00337"></a>00337 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9bf6d5b9eb8b646983d127c2b1ac1822"></a><!-- doxytag: member="tcptls.h::ast_tcptls_client_create" ref="a9bf6d5b9eb8b646983d127c2b1ac1822" args="(struct ast_tcptls_session_args *desc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a>* ast_tcptls_client_create </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__tcptls__session__args.html">ast_tcptls_session_args</a> *&nbsp;</td>
          <td class="paramname"> <em>desc</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="tcptls_8c_source.html#l00376">376</a> of file <a class="el" href="tcptls_8c_source.html">tcptls.c</a>.</p>

<p>References <a class="el" href="tcptls_8h_source.html#l00121">ast_tcptls_session_args::accept_fd</a>, <a class="el" href="astobj2_8h_source.html#l00413">ao2_alloc</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="utils_8c_source.html#l00431">ast_inet_ntoa()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01692">ast_mutex_init()</a>, <a class="el" href="tcptls_8h_source.html#l00138">ast_tcptls_session_instance::client</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="tcptls_8h_source.html#l00135">ast_tcptls_session_instance::fd</a>, <a class="el" href="tcptls_8h_source.html#l00116">ast_tcptls_session_args::local_address</a>, <a class="el" href="tcptls_8h_source.html#l00141">ast_tcptls_session_instance::lock</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="tcptls_8h_source.html#l00127">ast_tcptls_session_args::name</a>, <a class="el" href="tcptls_8h_source.html#l00117">ast_tcptls_session_args::old_address</a>, <a class="el" href="tcptls_8h_source.html#l00140">ast_tcptls_session_instance::parent</a>, <a class="el" href="tcptls_8h_source.html#l00139">ast_tcptls_session_instance::remote_address</a>, <a class="el" href="tcptls_8h_source.html#l00118">ast_tcptls_session_args::remote_address</a>, <a class="el" href="tcptls_8c_source.html#l00115">session_instance_destructor()</a>, and <a class="el" href="structast__tcptls__session__args.html#addf44bfb0d3d50ee501094886c42b2cc">ast_tcptls_session_args::worker_fn</a>.</p>

<p>Referenced by <a class="el" href="app__externalivr_8c_source.html#l00314">app_exec()</a>, and <a class="el" href="chan__sip_8c_source.html#l22074">sip_prepare_socket()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00377"></a>00377 {
<a name="l00378"></a>00378    <span class="keywordtype">int</span> x = 1;
<a name="l00379"></a>00379    <span class="keyword">struct </span><a class="code" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *tcptls_session = NULL;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381    <span class="comment">/* Do nothing if nothing has changed */</span>
<a name="l00382"></a>00382    <span class="keywordflow">if</span> (!memcmp(&amp;desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a>, &amp;desc-&gt;<a class="code" href="structast__tcptls__session__args.html#aa328808993fa36d65b987f07ede2e0a4">remote_address</a>, <span class="keyword">sizeof</span>(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a>))) {
<a name="l00383"></a>00383       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Nothing changed in %s\n&quot;</span>, desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00384"></a>00384       <span class="keywordflow">return</span> NULL;
<a name="l00385"></a>00385    }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387    desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a> = desc-&gt;<a class="code" href="structast__tcptls__session__args.html#aa328808993fa36d65b987f07ede2e0a4">remote_address</a>;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a> != -1)
<a name="l00390"></a>00390       close(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>);
<a name="l00391"></a>00391 
<a name="l00392"></a>00392    desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a> = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
<a name="l00393"></a>00393    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a> &lt; 0) {
<a name="l00394"></a>00394       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate socket for %s: %s\n&quot;</span>,
<a name="l00395"></a>00395          desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, strerror(errno));
<a name="l00396"></a>00396       <span class="keywordflow">return</span> NULL;
<a name="l00397"></a>00397    }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399    <span class="comment">/* if a local address was specified, bind to it so the connection will</span>
<a name="l00400"></a>00400 <span class="comment">      originate from the desired address */</span>
<a name="l00401"></a>00401    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_family != 0) {
<a name="l00402"></a>00402       setsockopt(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>, SOL_SOCKET, SO_REUSEADDR, &amp;x, <span class="keyword">sizeof</span>(x));
<a name="l00403"></a>00403       <span class="keywordflow">if</span> (bind(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>, (<span class="keyword">struct</span> sockaddr *) &amp;desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>, <span class="keyword">sizeof</span>(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>))) {
<a name="l00404"></a>00404          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to bind %s to %s:%d: %s\n&quot;</span>,
<a name="l00405"></a>00405          desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>,
<a name="l00406"></a>00406             <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_addr), ntohs(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_port),
<a name="l00407"></a>00407             strerror(errno));
<a name="l00408"></a>00408          <span class="keywordflow">goto</span> error;
<a name="l00409"></a>00409       }
<a name="l00410"></a>00410    }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412    <span class="keywordflow">if</span> (!(tcptls_session = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*tcptls_session), <a class="code" href="tcptls_8c.html#a5914d0d7ed685b4de9807f245de8fe69">session_instance_destructor</a>)))
<a name="l00413"></a>00413       <span class="keywordflow">goto</span> error;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00416"></a>00416    tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#a4bf947cca001e8ca0cd9def2b8d058c7">client</a> = 1;
<a name="l00417"></a>00417    tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>;
<a name="l00418"></a>00418    tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#ac7fc8bed1104b4557f6a183ae1155b75">parent</a> = desc;
<a name="l00419"></a>00419    tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#ac7fc8bed1104b4557f6a183ae1155b75">parent</a>-&gt;<a class="code" href="structast__tcptls__session__args.html#addf44bfb0d3d50ee501094886c42b2cc">worker_fn</a> = NULL;
<a name="l00420"></a>00420    memcpy(&amp;tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#aa328808993fa36d65b987f07ede2e0a4">remote_address</a>, &amp;desc-&gt;<a class="code" href="structast__tcptls__session__args.html#aa328808993fa36d65b987f07ede2e0a4">remote_address</a>, <span class="keyword">sizeof</span>(tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#aa328808993fa36d65b987f07ede2e0a4">remote_address</a>));
<a name="l00421"></a>00421 
<a name="l00422"></a>00422    <span class="keywordflow">return</span> tcptls_session;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424 error:
<a name="l00425"></a>00425    close(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>);
<a name="l00426"></a>00426    desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a> = -1;
<a name="l00427"></a>00427    <span class="keywordflow">if</span> (tcptls_session)
<a name="l00428"></a>00428       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(tcptls_session, -1);
<a name="l00429"></a>00429    <span class="keywordflow">return</span> NULL;
<a name="l00430"></a>00430 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="afbdc75838c2b7c41b7cb4a7740f49851"></a><!-- doxytag: member="tcptls.h::ast_tcptls_client_start" ref="afbdc75838c2b7c41b7cb4a7740f49851" args="(struct ast_tcptls_session_instance *tcptls_session)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a>* ast_tcptls_client_start </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *&nbsp;</td>
          <td class="paramname"> <em>tcptls_session</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>attempts to connect and start tcptls session, on error the tcptls_session's ref count is decremented, fd and file are closed, and NULL is returned. </p>

<p>Definition at line <a class="el" href="tcptls_8c_source.html#l00339">339</a> of file <a class="el" href="tcptls_8c_source.html">tcptls.c</a>.</p>

<p>References <a class="el" href="tcptls_8c_source.html#l00284">__ssl_setup()</a>, <a class="el" href="tcptls_8h_source.html#l00121">ast_tcptls_session_args::accept_fd</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="utils_8c_source.html#l00431">ast_inet_ntoa()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="channel_8c_source.html#l00138">desc</a>, <a class="el" href="tcptls_8h_source.html#l00079">ast_tls_config::enabled</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="tcptls_8c_source.html#l00128">handle_tcptls_connection()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="tcptls_8h_source.html#l00127">ast_tcptls_session_args::name</a>, <a class="el" href="tcptls_8h_source.html#l00140">ast_tcptls_session_instance::parent</a>, <a class="el" href="tcptls_8h_source.html#l00118">ast_tcptls_session_args::remote_address</a>, and <a class="el" href="tcptls_8h_source.html#l00120">ast_tcptls_session_args::tls_cfg</a>.</p>

<p>Referenced by <a class="el" href="chan__sip_8c_source.html#l02910">_sip_tcp_helper_thread()</a>, and <a class="el" href="app__externalivr_8c_source.html#l00314">app_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00340"></a>00340 {
<a name="l00341"></a>00341    <span class="keyword">struct </span><a class="code" href="structast__tcptls__session__args.html" title="arguments for the accepting thread">ast_tcptls_session_args</a> *<a class="code" href="channel_8c.html#a710bce51374aba96ab04912897666c35">desc</a>;
<a name="l00342"></a>00342    <span class="keywordtype">int</span> flags;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344    <span class="keywordflow">if</span> (!(desc = tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#ac7fc8bed1104b4557f6a183ae1155b75">parent</a>)) {
<a name="l00345"></a>00345       <span class="keywordflow">goto</span> client_start_error;
<a name="l00346"></a>00346    }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348    <span class="keywordflow">if</span> (connect(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>, (<span class="keyword">const</span> <span class="keyword">struct</span> sockaddr *) &amp;desc-&gt;<a class="code" href="structast__tcptls__session__args.html#aa328808993fa36d65b987f07ede2e0a4">remote_address</a>, <span class="keyword">sizeof</span>(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#aa328808993fa36d65b987f07ede2e0a4">remote_address</a>))) {
<a name="l00349"></a>00349       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to connect %s to %s:%d: %s\n&quot;</span>,
<a name="l00350"></a>00350          desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>,
<a name="l00351"></a>00351          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#aa328808993fa36d65b987f07ede2e0a4">remote_address</a>.sin_addr), ntohs(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#aa328808993fa36d65b987f07ede2e0a4">remote_address</a>.sin_port),
<a name="l00352"></a>00352          strerror(errno));
<a name="l00353"></a>00353       <span class="keywordflow">goto</span> client_start_error;
<a name="l00354"></a>00354    }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356    flags = fcntl(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>, F_GETFL);
<a name="l00357"></a>00357    fcntl(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>, F_SETFL, flags &amp; ~O_NONBLOCK);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structast__tcptls__session__args.html#aeb4a21e3ae033a326cc9dfd20a7ab074">tls_cfg</a>) {
<a name="l00360"></a>00360       desc-&gt;<a class="code" href="structast__tcptls__session__args.html#aeb4a21e3ae033a326cc9dfd20a7ab074">tls_cfg</a>-&gt;<a class="code" href="structast__tls__config.html#a03e6cca0c879c0443efb431c30c14f76">enabled</a> = 1;
<a name="l00361"></a>00361       <a class="code" href="tcptls_8c.html#a12ec3b45ca50a675005cf5d336a4e496">__ssl_setup</a>(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#aeb4a21e3ae033a326cc9dfd20a7ab074">tls_cfg</a>, 1);
<a name="l00362"></a>00362    }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364    <span class="keywordflow">return</span> <a class="code" href="tcptls_8c.html#aa7a554acdb67dd3845edc19c99cdf2d2" title="creates a FILE * from the fd passed by the accept thread. This operation is potentially...">handle_tcptls_connection</a>(tcptls_session);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366 client_start_error:
<a name="l00367"></a>00367    close(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>);
<a name="l00368"></a>00368    desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a> = -1;
<a name="l00369"></a>00369    <span class="keywordflow">if</span> (tcptls_session) {
<a name="l00370"></a>00370       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(tcptls_session, -1);
<a name="l00371"></a>00371    }
<a name="l00372"></a>00372    <span class="keywordflow">return</span> NULL;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a426e0abcf151912ad078e9655bd8e4b7"></a><!-- doxytag: member="tcptls.h::ast_tcptls_server_read" ref="a426e0abcf151912ad078e9655bd8e4b7" args="(struct ast_tcptls_session_instance *ser, void *buf, size_t count)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HOOK_T ast_tcptls_server_read </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *&nbsp;</td>
          <td class="paramname"> <em>ser</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&nbsp;</td>
          <td class="paramname"> <em>count</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="tcptls_8c_source.html#l00085">85</a> of file <a class="el" href="tcptls_8c_source.html">tcptls.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="tcptls_8h_source.html#l00135">ast_tcptls_session_instance::fd</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="tcptls_8h_source.html#l00136">ast_tcptls_session_instance::ssl</a>, and <a class="el" href="tcptls_8c_source.html#l00054">ssl_read()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00086"></a>00086 {
<a name="l00087"></a>00087    <span class="keywordflow">if</span> (tcptls_session-&gt;fd == -1) {
<a name="l00088"></a>00088       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;server_read called with an fd of -1\n&quot;</span>);
<a name="l00089"></a>00089       <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EIO;
<a name="l00090"></a>00090       <span class="keywordflow">return</span> -1;
<a name="l00091"></a>00091    }
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="preprocessor">#ifdef DO_SSL</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (tcptls_session-&gt;ssl)
<a name="l00095"></a>00095       <span class="keywordflow">return</span> <a class="code" href="tcptls_8c.html#a5810e9f4ed4d9a29feff6a8dc6d62960" title="replacement read/write functions for SSL support. We use wrappers rather than SSL_read/SSL_write...">ssl_read</a>(tcptls_session-&gt;ssl, <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, count);
<a name="l00096"></a>00096 <span class="preprocessor">#endif</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>   <span class="keywordflow">return</span> read(tcptls_session-&gt;fd, <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, count);
<a name="l00098"></a>00098 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac1fd2d3038c57a8f8f28f4b558eb5583"></a><!-- doxytag: member="tcptls.h::ast_tcptls_server_root" ref="ac1fd2d3038c57a8f8f28f4b558eb5583" args="(void *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* ast_tcptls_server_root </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="tcptls_8c_source.html#l00233">233</a> of file <a class="el" href="tcptls_8c_source.html">tcptls.c</a>.</p>

<p>References <a class="el" href="tcptls_8h_source.html#l00121">ast_tcptls_session_args::accept_fd</a>, <a class="el" href="astobj2_8h_source.html#l00413">ao2_alloc</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01692">ast_mutex_init()</a>, <a class="el" href="utils_8h_source.html#l00389">ast_pthread_create_detached_background</a>, <a class="el" href="utils_8c_source.html#l01051">ast_wait_for_input()</a>, <a class="el" href="tcptls_8h_source.html#l00138">ast_tcptls_session_instance::client</a>, <a class="el" href="channel_8c_source.html#l00138">desc</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="tcptls_8h_source.html#l00135">ast_tcptls_session_instance::fd</a>, <a class="el" href="tcptls_8c_source.html#l00128">handle_tcptls_connection()</a>, <a class="el" href="tcptls_8h_source.html#l00141">ast_tcptls_session_instance::lock</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="tcptls_8h_source.html#l00140">ast_tcptls_session_instance::parent</a>, <a class="el" href="structast__tcptls__session__args.html#a70f31b96ba5db127d2a6b4dccc45df4d">ast_tcptls_session_args::periodic_fn</a>, <a class="el" href="tcptls_8h_source.html#l00122">ast_tcptls_session_args::poll_timeout</a>, <a class="el" href="tcptls_8h_source.html#l00139">ast_tcptls_session_instance::remote_address</a>, and <a class="el" href="tcptls_8c_source.html#l00115">session_instance_destructor()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00234"></a>00234 {
<a name="l00235"></a>00235    <span class="keyword">struct </span><a class="code" href="structast__tcptls__session__args.html" title="arguments for the accepting thread">ast_tcptls_session_args</a> *<a class="code" href="channel_8c.html#a710bce51374aba96ab04912897666c35">desc</a> = data;
<a name="l00236"></a>00236    <span class="keywordtype">int</span> fd;
<a name="l00237"></a>00237    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l00238"></a>00238    socklen_t sinlen;
<a name="l00239"></a>00239    <span class="keyword">struct </span><a class="code" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *tcptls_session;
<a name="l00240"></a>00240    pthread_t launched;
<a name="l00241"></a>00241    
<a name="l00242"></a>00242    <span class="keywordflow">for</span> (;;) {
<a name="l00243"></a>00243       <span class="keywordtype">int</span> i, flags;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245       <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a70f31b96ba5db127d2a6b4dccc45df4d">periodic_fn</a>)
<a name="l00246"></a>00246          desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a70f31b96ba5db127d2a6b4dccc45df4d">periodic_fn</a>(desc);
<a name="l00247"></a>00247       i = <a class="code" href="utils_8h.html#a60404ef44696316455e79c3a002cc71e">ast_wait_for_input</a>(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>, desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad4d3065dbbbbf8dc07f813869fccb11a">poll_timeout</a>);
<a name="l00248"></a>00248       <span class="keywordflow">if</span> (i &lt;= 0)
<a name="l00249"></a>00249          <span class="keywordflow">continue</span>;
<a name="l00250"></a>00250       sinlen = <span class="keyword">sizeof</span>(sin);
<a name="l00251"></a>00251       fd = accept(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>, (<span class="keyword">struct</span> sockaddr *) &amp;sin, &amp;sinlen);
<a name="l00252"></a>00252       <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l00253"></a>00253          <span class="keywordflow">if</span> ((errno != EAGAIN) &amp;&amp; (errno != EINTR))
<a name="l00254"></a>00254             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Accept failed: %s\n&quot;</span>, strerror(errno));
<a name="l00255"></a>00255          <span class="keywordflow">continue</span>;
<a name="l00256"></a>00256       }
<a name="l00257"></a>00257       tcptls_session = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*tcptls_session), <a class="code" href="tcptls_8c.html#a5914d0d7ed685b4de9807f245de8fe69">session_instance_destructor</a>);
<a name="l00258"></a>00258       <span class="keywordflow">if</span> (!tcptls_session) {
<a name="l00259"></a>00259          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No memory for new session: %s\n&quot;</span>, strerror(errno));
<a name="l00260"></a>00260          close(fd);
<a name="l00261"></a>00261          <span class="keywordflow">continue</span>;
<a name="l00262"></a>00262       }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264       <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266       flags = fcntl(fd, F_GETFL);
<a name="l00267"></a>00267       fcntl(fd, F_SETFL, flags &amp; ~O_NONBLOCK);
<a name="l00268"></a>00268       tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = fd;
<a name="l00269"></a>00269       tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#ac7fc8bed1104b4557f6a183ae1155b75">parent</a> = desc;
<a name="l00270"></a>00270       memcpy(&amp;tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#aa328808993fa36d65b987f07ede2e0a4">remote_address</a>, &amp;sin, <span class="keyword">sizeof</span>(tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#aa328808993fa36d65b987f07ede2e0a4">remote_address</a>));
<a name="l00271"></a>00271 
<a name="l00272"></a>00272       tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#a4bf947cca001e8ca0cd9def2b8d058c7">client</a> = 0;
<a name="l00273"></a>00273          
<a name="l00274"></a>00274       <span class="comment">/* This thread is now the only place that controls the single ref to tcptls_session */</span>
<a name="l00275"></a>00275       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#aa73be876e3a4024b91ce2e09d8b945d1">ast_pthread_create_detached_background</a>(&amp;launched, NULL, <a class="code" href="tcptls_8c.html#aa7a554acdb67dd3845edc19c99cdf2d2" title="creates a FILE * from the fd passed by the accept thread. This operation is potentially...">handle_tcptls_connection</a>, tcptls_session)) {
<a name="l00276"></a>00276          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to launch helper thread: %s\n&quot;</span>, strerror(errno));
<a name="l00277"></a>00277          close(tcptls_session-&gt;<a class="code" href="structast__tcptls__session__instance.html#a6f8059414f0228f0256115e024eeed4b">fd</a>);
<a name="l00278"></a>00278          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(tcptls_session, -1);
<a name="l00279"></a>00279       }
<a name="l00280"></a>00280    }
<a name="l00281"></a>00281    <span class="keywordflow">return</span> NULL;
<a name="l00282"></a>00282 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a29375a4482c8de1e9879b97be2e88bf0"></a><!-- doxytag: member="tcptls.h::ast_tcptls_server_start" ref="a29375a4482c8de1e9879b97be2e88bf0" args="(struct ast_tcptls_session_args *desc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_tcptls_server_start </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__tcptls__session__args.html">ast_tcptls_session_args</a> *&nbsp;</td>
          <td class="paramname"> <em>desc</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>This is a generic (re)start routine for a TCP server, which does the socket/bind/listen and starts a thread for handling accept(). </p>
<dl class="version"><dt><b>Version:</b></dt><dd>1.6.1 changed desc parameter to be of <a class="el" href="structast__tcptls__session__args.html" title="arguments for the accepting thread">ast_tcptls_session_args</a> type </dd></dl>

<p>Definition at line <a class="el" href="tcptls_8c_source.html#l00432">432</a> of file <a class="el" href="tcptls_8c_source.html">tcptls.c</a>.</p>

<p>References <a class="el" href="tcptls_8h_source.html#l00121">ast_tcptls_session_args::accept_fd</a>, <a class="el" href="structast__tcptls__session__args.html#aa4941ca2f4eff6d9a865f502be6568c5">ast_tcptls_session_args::accept_fn</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="utils_8c_source.html#l00431">ast_inet_ntoa()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8h_source.html#l00384">ast_pthread_create_background</a>, <a class="el" href="lock_8h_source.html#l00082">AST_PTHREADT_NULL</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="tcptls_8h_source.html#l00116">ast_tcptls_session_args::local_address</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="tcptls_8h_source.html#l00123">ast_tcptls_session_args::master</a>, <a class="el" href="tcptls_8h_source.html#l00127">ast_tcptls_session_args::name</a>, and <a class="el" href="tcptls_8h_source.html#l00117">ast_tcptls_session_args::old_address</a>.</p>

<p>Referenced by <a class="el" href="http_8c_source.html#l00848">__ast_http_load()</a>, <a class="el" href="manager_8c_source.html#l04061">__init_manager()</a>, and <a class="el" href="chan__sip_8c_source.html#l24245">reload_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00433"></a>00433 {
<a name="l00434"></a>00434    <span class="keywordtype">int</span> flags;
<a name="l00435"></a>00435    <span class="keywordtype">int</span> x = 1;
<a name="l00436"></a>00436    
<a name="l00437"></a>00437    <span class="comment">/* Do nothing if nothing has changed */</span>
<a name="l00438"></a>00438    <span class="keywordflow">if</span> (!memcmp(&amp;desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a>, &amp;desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>, <span class="keyword">sizeof</span>(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a>))) {
<a name="l00439"></a>00439       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Nothing changed in %s\n&quot;</span>, desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00440"></a>00440       <span class="keywordflow">return</span>;
<a name="l00441"></a>00441    }
<a name="l00442"></a>00442    
<a name="l00443"></a>00443    desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a5ef2d9bb37eba1683395e916a1ec3986">old_address</a> = desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>;
<a name="l00444"></a>00444    
<a name="l00445"></a>00445    <span class="comment">/* Shutdown a running server if there is one */</span>
<a name="l00446"></a>00446    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a9e187fd6e33fd32a888531467786c773">master</a> != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) {
<a name="l00447"></a>00447       pthread_cancel(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a9e187fd6e33fd32a888531467786c773">master</a>);
<a name="l00448"></a>00448       pthread_kill(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a9e187fd6e33fd32a888531467786c773">master</a>, SIGURG);
<a name="l00449"></a>00449       pthread_join(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a9e187fd6e33fd32a888531467786c773">master</a>, NULL);
<a name="l00450"></a>00450    }
<a name="l00451"></a>00451    
<a name="l00452"></a>00452    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a> != -1)
<a name="l00453"></a>00453       close(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455    <span class="comment">/* If there&apos;s no new server, stop here */</span>
<a name="l00456"></a>00456    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_family == 0) {
<a name="l00457"></a>00457       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Server disabled:  %s\n&quot;</span>, desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00458"></a>00458       <span class="keywordflow">return</span>;
<a name="l00459"></a>00459    }
<a name="l00460"></a>00460 
<a name="l00461"></a>00461    desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a> = socket(AF_INET, SOCK_STREAM, 0);
<a name="l00462"></a>00462    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a> &lt; 0) {
<a name="l00463"></a>00463       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to allocate socket for %s: %s\n&quot;</span>, desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, strerror(errno));
<a name="l00464"></a>00464       <span class="keywordflow">return</span>;
<a name="l00465"></a>00465    }
<a name="l00466"></a>00466    
<a name="l00467"></a>00467    setsockopt(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>, SOL_SOCKET, SO_REUSEADDR, &amp;x, <span class="keyword">sizeof</span>(x));
<a name="l00468"></a>00468    <span class="keywordflow">if</span> (bind(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>, (<span class="keyword">struct</span> sockaddr *) &amp;desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>, <span class="keyword">sizeof</span>(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>))) {
<a name="l00469"></a>00469       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to bind %s to %s:%d: %s\n&quot;</span>,
<a name="l00470"></a>00470          desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>,
<a name="l00471"></a>00471          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_addr), ntohs(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_port),
<a name="l00472"></a>00472          strerror(errno));
<a name="l00473"></a>00473       <span class="keywordflow">goto</span> error;
<a name="l00474"></a>00474    }
<a name="l00475"></a>00475    <span class="keywordflow">if</span> (listen(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>, 10)) {
<a name="l00476"></a>00476       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to listen for %s!\n&quot;</span>, desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00477"></a>00477       <span class="keywordflow">goto</span> error;
<a name="l00478"></a>00478    }
<a name="l00479"></a>00479    flags = fcntl(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>, F_GETFL);
<a name="l00480"></a>00480    fcntl(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>, F_SETFL, flags | O_NONBLOCK);
<a name="l00481"></a>00481    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a9e187fd6e33fd32a888531467786c773">master</a>, NULL, desc-&gt;<a class="code" href="structast__tcptls__session__args.html#aa4941ca2f4eff6d9a865f502be6568c5">accept_fn</a>, desc)) {
<a name="l00482"></a>00482       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to launch thread for %s on %s:%d: %s\n&quot;</span>,
<a name="l00483"></a>00483          desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>,
<a name="l00484"></a>00484          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_addr), ntohs(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_port),
<a name="l00485"></a>00485          strerror(errno));
<a name="l00486"></a>00486       <span class="keywordflow">goto</span> error;
<a name="l00487"></a>00487    }
<a name="l00488"></a>00488    <span class="keywordflow">return</span>;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490 error:
<a name="l00491"></a>00491    close(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>);
<a name="l00492"></a>00492    desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a> = -1;
<a name="l00493"></a>00493 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1fd4aa5038c9a488acc0f8017fe94fda"></a><!-- doxytag: member="tcptls.h::ast_tcptls_server_stop" ref="a1fd4aa5038c9a488acc0f8017fe94fda" args="(struct ast_tcptls_session_args *desc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_tcptls_server_stop </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__tcptls__session__args.html">ast_tcptls_session_args</a> *&nbsp;</td>
          <td class="paramname"> <em>desc</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Shutdown a running server if there is one. </p>
<dl class="version"><dt><b>Version:</b></dt><dd>1.6.1 changed desc parameter to be of <a class="el" href="structast__tcptls__session__args.html" title="arguments for the accepting thread">ast_tcptls_session_args</a> type </dd></dl>

<p>Definition at line <a class="el" href="tcptls_8c_source.html#l00495">495</a> of file <a class="el" href="tcptls_8c_source.html">tcptls.c</a>.</p>

<p>References <a class="el" href="tcptls_8h_source.html#l00121">ast_tcptls_session_args::accept_fd</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="lock_8h_source.html#l00082">AST_PTHREADT_NULL</a>, <a class="el" href="tcptls_8h_source.html#l00123">ast_tcptls_session_args::master</a>, and <a class="el" href="tcptls_8h_source.html#l00127">ast_tcptls_session_args::name</a>.</p>

<p>Referenced by <a class="el" href="chan__sip_8c_source.html#l25834">unload_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00496"></a>00496 {
<a name="l00497"></a>00497    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a9e187fd6e33fd32a888531467786c773">master</a> != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) {
<a name="l00498"></a>00498       pthread_cancel(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a9e187fd6e33fd32a888531467786c773">master</a>);
<a name="l00499"></a>00499       pthread_kill(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a9e187fd6e33fd32a888531467786c773">master</a>, SIGURG);
<a name="l00500"></a>00500       pthread_join(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a9e187fd6e33fd32a888531467786c773">master</a>, NULL);
<a name="l00501"></a>00501    }
<a name="l00502"></a>00502    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a> != -1)
<a name="l00503"></a>00503       close(desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a>);
<a name="l00504"></a>00504    desc-&gt;<a class="code" href="structast__tcptls__session__args.html#ad6d7a8463d59a02084cf9d4360f46b79">accept_fd</a> = -1;
<a name="l00505"></a>00505    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Stopped server :: %s\n&quot;</span>, desc-&gt;<a class="code" href="structast__tcptls__session__args.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00506"></a>00506 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aed875d836e7109975c3a1710f9cf6760"></a><!-- doxytag: member="tcptls.h::ast_tcptls_server_write" ref="aed875d836e7109975c3a1710f9cf6760" args="(struct ast_tcptls_session_instance *ser, const void *buf, size_t count)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HOOK_T ast_tcptls_server_write </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *&nbsp;</td>
          <td class="paramname"> <em>ser</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&nbsp;</td>
          <td class="paramname"> <em>count</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="tcptls_8c_source.html#l00100">100</a> of file <a class="el" href="tcptls_8c_source.html">tcptls.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="tcptls_8h_source.html#l00135">ast_tcptls_session_instance::fd</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="tcptls_8h_source.html#l00136">ast_tcptls_session_instance::ssl</a>, and <a class="el" href="tcptls_8c_source.html#l00065">ssl_write()</a>.</p>

<p>Referenced by <a class="el" href="chan__sip_8c_source.html#l02910">_sip_tcp_helper_thread()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00101"></a>00101 {
<a name="l00102"></a>00102    <span class="keywordflow">if</span> (tcptls_session-&gt;fd == -1) {
<a name="l00103"></a>00103       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;server_write called with an fd of -1\n&quot;</span>);
<a name="l00104"></a>00104       <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EIO;
<a name="l00105"></a>00105       <span class="keywordflow">return</span> -1;
<a name="l00106"></a>00106    }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="preprocessor">#ifdef DO_SSL</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (tcptls_session-&gt;ssl)
<a name="l00110"></a>00110       <span class="keywordflow">return</span> <a class="code" href="tcptls_8c.html#a4d9c8e7b53c55d1edd9c37df19c1415b">ssl_write</a>(tcptls_session-&gt;ssl, <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, count);
<a name="l00111"></a>00111 <span class="preprocessor">#endif</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span>   <span class="keywordflow">return</span> write(tcptls_session-&gt;fd, <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, count);
<a name="l00113"></a>00113 }
</pre></div></p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:23:31 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
