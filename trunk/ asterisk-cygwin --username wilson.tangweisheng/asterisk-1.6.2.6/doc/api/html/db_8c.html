<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:21:58 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>db.c File Reference</h1>
<p>ASTdb Management.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="__private_8h_source.html">asterisk/_private.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="paths_8h_source.html">asterisk/paths.h</a>&quot;</code><br/>
<code>#include &lt;sys/time.h&gt;</code><br/>
<code>#include &lt;signal.h&gt;</code><br/>
<code>#include &lt;dirent.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="channel_8h_source.html">asterisk/channel.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="file_8h_source.html">asterisk/file.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="app_8h_source.html">asterisk/app.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="dsp_8h_source.html">asterisk/dsp.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="astdb_8h_source.html">asterisk/astdb.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cli_8h_source.html">asterisk/cli.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="lock_8h_source.html">asterisk/lock.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="manager_8h_source.html">asterisk/manager.h</a>&quot;</code><br/>
<code>#include &quot;db1-ast/include/db.h&quot;</code><br/>

<p><a href="db_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#ada44a77a58daf50e4bf7b03164b4503b">ast_db_del</a> (const char *family, const char *<a class="el" href="structkeys.html">keys</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Delete entry in astdb.  <a href="#ada44a77a58daf50e4bf7b03164b4503b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#af251d986cfe884ffd5ca864531253f62">ast_db_deltree</a> (const char *family, const char *keytree)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Delete a whole family (for some reason also called "tree".  <a href="#af251d986cfe884ffd5ca864531253f62"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a3387fe63f8d0b59067f32d626dea29be">ast_db_freetree</a> (struct <a class="el" href="structast__db__entry.html">ast_db_entry</a> *dbe)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Free in-memory data.  <a href="#a3387fe63f8d0b59067f32d626dea29be"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a0cf080186f549021d302d703fa71e814">ast_db_get</a> (const char *family, const char *<a class="el" href="structkeys.html">keys</a>, char *value, int valuelen)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get key value specified by family/key.  <a href="#a0cf080186f549021d302d703fa71e814"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__db__entry.html">ast_db_entry</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#afeb9839f89da4fc24838de74739d181e">ast_db_gettree</a> (const char *family, const char *keytree)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get a whole family.  <a href="#afeb9839f89da4fc24838de74739d181e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a34522d18f4fa2880f22b203cebda37f0">ast_db_put</a> (const char *family, const char *<a class="el" href="structkeys.html">keys</a>, const char *value)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Store value addressed by family/key.  <a href="#a34522d18f4fa2880f22b203cebda37f0"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a52d9808db8eba7a1ff32fc6686042f04">astdb_init</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#aa0a32443a3a66aae82eab44edfc22304">dbinit</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#ab2ffb685a189bc273c1de00753c31091">handle_cli_database_del</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#ac0dc7f1713e81aee579767f2269b6ce1">handle_cli_database_deltree</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#afb5ce976f5d19ec85c79189213596d96">handle_cli_database_get</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a05c446a72a078b710425b61d0d999e07">handle_cli_database_put</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#aed10f708f89ad5111a2f1ca77013305e">handle_cli_database_show</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#ade1bc05ba29175fe3f6a5f2b67143ffd">handle_cli_database_showkey</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a58c92732ca410e48df4ea7f8d524a840">keymatch</a> (const char *key, const char *<a class="el" href="res__http__post_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a03f7dee6cad1dff30caf7133244cd811">manager_dbdel</a> (struct <a class="el" href="structmansession.html">mansession</a> *s, const struct <a class="el" href="structmessage.html">message</a> *m)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a274fd536a82bf71830421f6b0ff63702">manager_dbdeltree</a> (struct <a class="el" href="structmansession.html">mansession</a> *s, const struct <a class="el" href="structmessage.html">message</a> *m)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a415a23bb61c561440bc3ae9d263461ad">manager_dbget</a> (struct <a class="el" href="structmansession.html">mansession</a> *s, const struct <a class="el" href="structmessage.html">message</a> *m)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a63408b76b1f9eed31bcd1211d2081f03">manager_dbput</a> (struct <a class="el" href="structmansession.html">mansession</a> *s, const struct <a class="el" href="structmessage.html">message</a> *m)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#ae4876bea6a08b2f9d90815ad39d455cf">subkeymatch</a> (const char *key, const char *suffix)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static DB *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a2956356b5eeaacfec5a223ce1417fc6d">cli_database</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static <a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a> = ((<a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>) PTHREAD_MUTEX_INITIALIZER )</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>ASTdb Management. </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Mark Spencer &lt;<a href="mailto:markster@digium.com">markster@digium.com</a>&gt;</dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>DB3 is licensed under Sleepycat Public License and is thus incompatible with GPL. To avoid having to make another exception (and complicate licensing even further) we elect to use DB1 which is BSD licensed </dd></dl>

<p>Definition in file <a class="el" href="db_8c_source.html">db.c</a>.</p>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ada44a77a58daf50e4bf7b03164b4503b"></a><!-- doxytag: member="db.c::ast_db_del" ref="ada44a77a58daf50e4bf7b03164b4503b" args="(const char *family, const char *keys)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_db_del </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>family</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>keys</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Delete entry in astdb. </p>

<p>Definition at line <a class="el" href="db_8c_source.html#l00209">209</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="db_8c_source.html#l00054">dbinit()</a>, and <a class="el" href="db_8c_source.html#l00052">dblock</a>.</p>

<p>Referenced by <a class="el" href="chan__iax2_8c_source.html#l08254">__expire_registry()</a>, <a class="el" href="privacy_8c_source.html#l00080">ast_privacy_set()</a>, <a class="el" href="app__authenticate_8c_source.html#l00108">auth_exec()</a>, <a class="el" href="pbx__dundi_8c_source.html#l01147">cache_lookup_internal()</a>, <a class="el" href="app__db_8c_source.html#l00117">del_exec()</a>, <a class="el" href="chan__sip_8c_source.html#l11990">destroy_association()</a>, <a class="el" href="func__dialgroup_8c_source.html#l00168">dialgroup_refreshdb()</a>, <a class="el" href="chan__agent_8c_source.html#l02362">dump_agents()</a>, <a class="el" href="app__queue_8c_source.html#l04356">dump_queue_members()</a>, <a class="el" href="func__db_8c_source.html#l00206">function_db_delete()</a>, <a class="el" href="db_8c_source.html#l00292">handle_cli_database_del()</a>, <a class="el" href="res__agi_8c_source.html#l01925">handle_dbdel()</a>, <a class="el" href="db_8c_source.html#l00616">manager_dbdel()</a>, <a class="el" href="pbx__dundi_8c_source.html#l02192">process_clearcache()</a>, <a class="el" href="chan__agent_8c_source.html#l02387">reload_agents()</a>, <a class="el" href="app__queue_8c_source.html#l04667">reload_queue_members()</a>, and <a class="el" href="chan__iax2_8c_source.html#l08346">update_registry()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00210"></a>00210 {
<a name="l00211"></a>00211    <span class="keywordtype">char</span> fullkey[256];
<a name="l00212"></a>00212    DBT key;
<a name="l00213"></a>00213    <span class="keywordtype">int</span> res, fullkeylen;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00216"></a>00216    <span class="keywordflow">if</span> (<a class="code" href="db_8c.html#aa0a32443a3a66aae82eab44edfc22304">dbinit</a>()) {
<a name="l00217"></a>00217       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00218"></a>00218       <span class="keywordflow">return</span> -1;
<a name="l00219"></a>00219    }
<a name="l00220"></a>00220    
<a name="l00221"></a>00221    fullkeylen = snprintf(fullkey, <span class="keyword">sizeof</span>(fullkey), <span class="stringliteral">&quot;/%s/%s&quot;</span>, family, <a class="code" href="structkeys.html">keys</a>);
<a name="l00222"></a>00222    memset(&amp;key, 0, <span class="keyword">sizeof</span>(key));
<a name="l00223"></a>00223    key.data = fullkey;
<a name="l00224"></a>00224    key.size = fullkeylen + 1;
<a name="l00225"></a>00225    
<a name="l00226"></a>00226    res = <a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>-&gt;del(<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>, &amp;key, 0);
<a name="l00227"></a>00227    <a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>-&gt;sync(<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>, 0);
<a name="l00228"></a>00228    
<a name="l00229"></a>00229    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00230"></a>00230 
<a name="l00231"></a>00231    <span class="keywordflow">if</span> (res) {
<a name="l00232"></a>00232       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Unable to find key &apos;%s&apos; in family &apos;%s&apos;\n&quot;</span>, <a class="code" href="structkeys.html">keys</a>, family);
<a name="l00233"></a>00233    }
<a name="l00234"></a>00234    <span class="keywordflow">return</span> res;
<a name="l00235"></a>00235 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af251d986cfe884ffd5ca864531253f62"></a><!-- doxytag: member="db.c::ast_db_deltree" ref="af251d986cfe884ffd5ca864531253f62" args="(const char *family, const char *keytree)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_db_deltree </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>family</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>keytree</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Delete a whole family (for some reason also called "tree". </p>

<p>Definition at line <a class="el" href="db_8c_source.html#l00091">91</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="db_8c_source.html#l00054">dbinit()</a>, <a class="el" href="db_8c_source.html#l00052">dblock</a>, <a class="el" href="db_8c_source.html#l00064">keymatch()</a>, <a class="el" href="res__config__ldap_8c_source.html#l00069">pass</a>, and <a class="el" href="http_8c_source.html#l00092">prefix</a>.</p>

<p>Referenced by <a class="el" href="privacy_8c_source.html#l00073">ast_privacy_reset()</a>, <a class="el" href="app__db_8c_source.html#l00086">deltree_exec()</a>, <a class="el" href="pbx__dundi_8c_source.html#l02324">dundi_flush()</a>, <a class="el" href="db_8c_source.html#l00319">handle_cli_database_deltree()</a>, <a class="el" href="res__agi_8c_source.html#l01936">handle_dbdeltree()</a>, <a class="el" href="iax2-provision_8c_source.html#l00522">iax_provision_reload()</a>, and <a class="el" href="db_8c_source.html#l00641">manager_dbdeltree()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00092"></a>00092 {
<a name="l00093"></a>00093    <span class="keywordtype">char</span> <a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>[256];
<a name="l00094"></a>00094    DBT key, <a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00095"></a>00095    <span class="keywordtype">char</span> *<a class="code" href="structkeys.html">keys</a>;
<a name="l00096"></a>00096    <span class="keywordtype">int</span> res;
<a name="l00097"></a>00097    <span class="keywordtype">int</span> <a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>;
<a name="l00098"></a>00098    <span class="keywordtype">int</span> counter = 0;
<a name="l00099"></a>00099    
<a name="l00100"></a>00100    <span class="keywordflow">if</span> (family) {
<a name="l00101"></a>00101       <span class="keywordflow">if</span> (keytree) {
<a name="l00102"></a>00102          snprintf(prefix, <span class="keyword">sizeof</span>(prefix), <span class="stringliteral">&quot;/%s/%s&quot;</span>, family, keytree);
<a name="l00103"></a>00103       } <span class="keywordflow">else</span> {
<a name="l00104"></a>00104          snprintf(prefix, <span class="keyword">sizeof</span>(prefix), <span class="stringliteral">&quot;/%s&quot;</span>, family);
<a name="l00105"></a>00105       }
<a name="l00106"></a>00106    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keytree) {
<a name="l00107"></a>00107       <span class="keywordflow">return</span> -1;
<a name="l00108"></a>00108    } <span class="keywordflow">else</span> {
<a name="l00109"></a>00109       prefix[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00110"></a>00110    }
<a name="l00111"></a>00111    
<a name="l00112"></a>00112    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00113"></a>00113    <span class="keywordflow">if</span> (<a class="code" href="db_8c.html#aa0a32443a3a66aae82eab44edfc22304">dbinit</a>()) {
<a name="l00114"></a>00114       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00115"></a>00115       <span class="keywordflow">return</span> -1;
<a name="l00116"></a>00116    }
<a name="l00117"></a>00117    
<a name="l00118"></a>00118    memset(&amp;key, 0, <span class="keyword">sizeof</span>(key));
<a name="l00119"></a>00119    memset(&amp;data, 0, <span class="keyword">sizeof</span>(data));
<a name="l00120"></a>00120    pass = 0;
<a name="l00121"></a>00121    <span class="keywordflow">while</span> (!(res = <a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>-&gt;seq(<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>, &amp;key, &amp;data, pass++ ? R_NEXT : R_FIRST))) {
<a name="l00122"></a>00122       <span class="keywordflow">if</span> (key.size) {
<a name="l00123"></a>00123          keys = key.data;
<a name="l00124"></a>00124          keys[key.size - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00125"></a>00125       } <span class="keywordflow">else</span> {
<a name="l00126"></a>00126          keys = <span class="stringliteral">&quot;&lt;bad key&gt;&quot;</span>;
<a name="l00127"></a>00127       }
<a name="l00128"></a>00128       <span class="keywordflow">if</span> (<a class="code" href="db_8c.html#a58c92732ca410e48df4ea7f8d524a840">keymatch</a>(keys, prefix)) {
<a name="l00129"></a>00129          <a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>-&gt;del(<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>, &amp;key, 0);
<a name="l00130"></a>00130          counter++;
<a name="l00131"></a>00131       }
<a name="l00132"></a>00132    }
<a name="l00133"></a>00133    <a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>-&gt;sync(<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>, 0);
<a name="l00134"></a>00134    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00135"></a>00135    <span class="keywordflow">return</span> counter;
<a name="l00136"></a>00136 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3387fe63f8d0b59067f32d626dea29be"></a><!-- doxytag: member="db.c::ast_db_freetree" ref="a3387fe63f8d0b59067f32d626dea29be" args="(struct ast_db_entry *dbe)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_db_freetree </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__db__entry.html">ast_db_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>dbe</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Free in-memory data. </p>

<p>Definition at line <a class="el" href="db_8c_source.html#l00535">535</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="devicestate_8c_source.html#l00198">last</a>, and <a class="el" href="astdb_8h_source.html#l00031">ast_db_entry::next</a>.</p>

<p>Referenced by <a class="el" href="func__devstate_8c_source.html#l00191">handle_cli_devstate_list()</a>, <a class="el" href="func__devstate_8c_source.html#l00326">load_module()</a>, <a class="el" href="pbx__dundi_8c_source.html#l02192">process_clearcache()</a>, <a class="el" href="chan__agent_8c_source.html#l02387">reload_agents()</a>, and <a class="el" href="app__queue_8c_source.html#l04667">reload_queue_members()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00536"></a>00536 {
<a name="l00537"></a>00537    <span class="keyword">struct </span><a class="code" href="structast__db__entry.html">ast_db_entry</a> *<a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a>;
<a name="l00538"></a>00538    <span class="keywordflow">while</span> (dbe) {
<a name="l00539"></a>00539       last = dbe;
<a name="l00540"></a>00540       dbe = dbe-&gt;<a class="code" href="structast__db__entry.html#a3fee4a0a4bff112e0262fb8d49f41b5e">next</a>;
<a name="l00541"></a>00541       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(last);
<a name="l00542"></a>00542    }
<a name="l00543"></a>00543 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0cf080186f549021d302d703fa71e814"></a><!-- doxytag: member="db.c::ast_db_get" ref="a0cf080186f549021d302d703fa71e814" args="(const char *family, const char *keys, char *value, int valuelen)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_db_get </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>family</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>keys</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>value</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>valuelen</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get key value specified by family/key. </p>

<p>Definition at line <a class="el" href="db_8c_source.html#l00165">165</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="db_8c_source.html#l00054">dbinit()</a>, <a class="el" href="db_8c_source.html#l00052">dblock</a>, and <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>.</p>

<p>Referenced by <a class="el" href="privacy_8c_source.html#l00044">ast_privacy_check()</a>, <a class="el" href="app__authenticate_8c_source.html#l00108">auth_exec()</a>, <a class="el" href="func__blacklist_8c_source.html#l00055">blacklist_read()</a>, <a class="el" href="pbx__dundi_8c_source.html#l01147">cache_lookup_internal()</a>, <a class="el" href="chan__iax2_8c_source.html#l07197">check_access()</a>, <a class="el" href="chan__iax2_8c_source.html#l04337">create_addr()</a>, <a class="el" href="func__devstate_8c_source.html#l00182">custom_devstate_callback()</a>, <a class="el" href="app__alarmreceiver_8c_source.html#l00108">database_increment()</a>, <a class="el" href="func__db_8c_source.html#l00206">function_db_delete()</a>, <a class="el" href="func__db_8c_source.html#l00169">function_db_exists()</a>, <a class="el" href="func__db_8c_source.html#l00105">function_db_read()</a>, <a class="el" href="db_8c_source.html#l00264">handle_cli_database_get()</a>, <a class="el" href="res__agi_8c_source.html#l01881">handle_dbget()</a>, <a class="el" href="iax2-provision_8c_source.html#l00255">iax_provision_version()</a>, <a class="el" href="pbx__dundi_8c_source.html#l02110">load_password()</a>, <a class="el" href="db_8c_source.html#l00579">manager_dbget()</a>, <a class="el" href="pbx__dundi_8c_source.html#l04347">populate_addr()</a>, <a class="el" href="chan__iax2_8c_source.html#l08297">reg_source_db()</a>, <a class="el" href="chan__agent_8c_source.html#l02387">reload_agents()</a>, and <a class="el" href="app__queue_8c_source.html#l04667">reload_queue_members()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00166"></a>00166 {
<a name="l00167"></a>00167    <span class="keywordtype">char</span> fullkey[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00168"></a>00168    DBT <a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>, <a class="code" href="structast__db__entry.html#a9a3b4be1b9151b0369d7fca9911c7ecd">data</a>;
<a name="l00169"></a>00169    <span class="keywordtype">int</span> res, fullkeylen;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00172"></a>00172    <span class="keywordflow">if</span> (<a class="code" href="db_8c.html#aa0a32443a3a66aae82eab44edfc22304">dbinit</a>()) {
<a name="l00173"></a>00173       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00174"></a>00174       <span class="keywordflow">return</span> -1;
<a name="l00175"></a>00175    }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177    fullkeylen = snprintf(fullkey, <span class="keyword">sizeof</span>(fullkey), <span class="stringliteral">&quot;/%s/%s&quot;</span>, family, <a class="code" href="structkeys.html">keys</a>);
<a name="l00178"></a>00178    memset(&amp;key, 0, <span class="keyword">sizeof</span>(key));
<a name="l00179"></a>00179    memset(&amp;data, 0, <span class="keyword">sizeof</span>(data));
<a name="l00180"></a>00180    memset(value, 0, valuelen);
<a name="l00181"></a>00181    key.data = fullkey;
<a name="l00182"></a>00182    key.size = fullkeylen + 1;
<a name="l00183"></a>00183 
<a name="l00184"></a>00184    res = <a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>-&gt;get(<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>, &amp;key, &amp;data, 0);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186    <span class="comment">/* Be sure to NULL terminate our data either way */</span>
<a name="l00187"></a>00187    <span class="keywordflow">if</span> (res) {
<a name="l00188"></a>00188       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Unable to find key &apos;%s&apos; in family &apos;%s&apos;\n&quot;</span>, <a class="code" href="structkeys.html">keys</a>, family);
<a name="l00189"></a>00189    } <span class="keywordflow">else</span> {
<a name="l00190"></a>00190 <span class="preprocessor">#if 0</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span>      printf(<span class="stringliteral">&quot;Got value of size %d\n&quot;</span>, data.size);
<a name="l00192"></a>00192 <span class="preprocessor">#endif</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (data.size) {
<a name="l00194"></a>00194          ((<span class="keywordtype">char</span> *)data.data)[data.size - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00195"></a>00195          <span class="comment">/* Make sure that we don&apos;t write too much to the dst pointer or we don&apos;t read too much from the source pointer */</span>
<a name="l00196"></a>00196          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(value, data.data, (valuelen &gt; data.size) ? data.size : valuelen);
<a name="l00197"></a>00197       } <span class="keywordflow">else</span> {
<a name="l00198"></a>00198          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Strange, empty value for /%s/%s\n&quot;</span>, family, <a class="code" href="structkeys.html">keys</a>);
<a name="l00199"></a>00199       }
<a name="l00200"></a>00200    }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202    <span class="comment">/* Data is not fully isolated for concurrency, so the lock must be extended</span>
<a name="l00203"></a>00203 <span class="comment">    * to after the copy to the output buffer. */</span>
<a name="l00204"></a>00204    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00205"></a>00205 
<a name="l00206"></a>00206    <span class="keywordflow">return</span> res;
<a name="l00207"></a>00207 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="afeb9839f89da4fc24838de74739d181e"></a><!-- doxytag: member="db.c::ast_db_gettree" ref="afeb9839f89da4fc24838de74739d181e" args="(const char *family, const char *keytree)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__db__entry.html">ast_db_entry</a>* ast_db_gettree </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>family</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>keytree</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get a whole family. </p>

<p>Definition at line <a class="el" href="db_8c_source.html#l00473">473</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astmm_8h_source.html#l00081">ast_malloc</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="astdb_8h_source.html#l00033">ast_db_entry::data</a>, <a class="el" href="db_8c_source.html#l00054">dbinit()</a>, <a class="el" href="db_8c_source.html#l00052">dblock</a>, <a class="el" href="astdb_8h_source.html#l00032">ast_db_entry::key</a>, <a class="el" href="db_8c_source.html#l00064">keymatch()</a>, <a class="el" href="devicestate_8c_source.html#l00198">last</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="astdb_8h_source.html#l00031">ast_db_entry::next</a>, <a class="el" href="res__config__ldap_8c_source.html#l00069">pass</a>, and <a class="el" href="http_8c_source.html#l00092">prefix</a>.</p>

<p>Referenced by <a class="el" href="func__devstate_8c_source.html#l00191">handle_cli_devstate_list()</a>, <a class="el" href="func__devstate_8c_source.html#l00326">load_module()</a>, <a class="el" href="pbx__dundi_8c_source.html#l02192">process_clearcache()</a>, <a class="el" href="chan__agent_8c_source.html#l02387">reload_agents()</a>, and <a class="el" href="app__queue_8c_source.html#l04667">reload_queue_members()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00474"></a>00474 {
<a name="l00475"></a>00475    <span class="keywordtype">char</span> <a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>[256];
<a name="l00476"></a>00476    DBT <a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>, <a class="code" href="structast__db__entry.html#a9a3b4be1b9151b0369d7fca9911c7ecd">data</a>;
<a name="l00477"></a>00477    <span class="keywordtype">char</span> *<a class="code" href="structkeys.html">keys</a>, *<a class="code" href="structvalues.html">values</a>;
<a name="l00478"></a>00478    <span class="keywordtype">int</span> values_len;
<a name="l00479"></a>00479    <span class="keywordtype">int</span> res;
<a name="l00480"></a>00480    <span class="keywordtype">int</span> <a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>;
<a name="l00481"></a>00481    <span class="keyword">struct </span><a class="code" href="structast__db__entry.html">ast_db_entry</a> *<a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a> = NULL;
<a name="l00482"></a>00482    <span class="keyword">struct </span><a class="code" href="structast__db__entry.html">ast_db_entry</a> *cur, *ret=NULL;
<a name="l00483"></a>00483 
<a name="l00484"></a>00484    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(family)) {
<a name="l00485"></a>00485       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(keytree)) {
<a name="l00486"></a>00486          <span class="comment">/* Family and key tree */</span>
<a name="l00487"></a>00487          snprintf(prefix, <span class="keyword">sizeof</span>(prefix), <span class="stringliteral">&quot;/%s/%s&quot;</span>, family, keytree);
<a name="l00488"></a>00488       } <span class="keywordflow">else</span> {
<a name="l00489"></a>00489          <span class="comment">/* Family only */</span>
<a name="l00490"></a>00490          snprintf(prefix, <span class="keyword">sizeof</span>(prefix), <span class="stringliteral">&quot;/%s&quot;</span>, family);
<a name="l00491"></a>00491       }
<a name="l00492"></a>00492    } <span class="keywordflow">else</span> {
<a name="l00493"></a>00493       prefix[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00494"></a>00494    }
<a name="l00495"></a>00495    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00496"></a>00496    <span class="keywordflow">if</span> (<a class="code" href="db_8c.html#aa0a32443a3a66aae82eab44edfc22304">dbinit</a>()) {
<a name="l00497"></a>00497       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00498"></a>00498       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Database unavailable\n&quot;</span>);
<a name="l00499"></a>00499       <span class="keywordflow">return</span> NULL;   
<a name="l00500"></a>00500    }
<a name="l00501"></a>00501    memset(&amp;key, 0, <span class="keyword">sizeof</span>(key));
<a name="l00502"></a>00502    memset(&amp;data, 0, <span class="keyword">sizeof</span>(data));
<a name="l00503"></a>00503    pass = 0;
<a name="l00504"></a>00504    <span class="keywordflow">while</span> (!(res = <a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>-&gt;seq(<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>, &amp;key, &amp;data, pass++ ? R_NEXT : R_FIRST))) {
<a name="l00505"></a>00505       <span class="keywordflow">if</span> (key.size) {
<a name="l00506"></a>00506          keys = key.data;
<a name="l00507"></a>00507          keys[key.size - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00508"></a>00508       } <span class="keywordflow">else</span> {
<a name="l00509"></a>00509          keys = <span class="stringliteral">&quot;&lt;bad key&gt;&quot;</span>;
<a name="l00510"></a>00510       }
<a name="l00511"></a>00511       <span class="keywordflow">if</span> (data.size) {
<a name="l00512"></a>00512          values = data.data;
<a name="l00513"></a>00513          values[data.size - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00514"></a>00514       } <span class="keywordflow">else</span> {
<a name="l00515"></a>00515          values = <span class="stringliteral">&quot;&lt;bad value&gt;&quot;</span>;
<a name="l00516"></a>00516       }
<a name="l00517"></a>00517       values_len = strlen(values) + 1;
<a name="l00518"></a>00518       <span class="keywordflow">if</span> (<a class="code" href="db_8c.html#a58c92732ca410e48df4ea7f8d524a840">keymatch</a>(keys, prefix) &amp;&amp; (cur = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(<span class="keyword">sizeof</span>(*cur) + strlen(keys) + 1 + values_len))) {
<a name="l00519"></a>00519          cur-&gt;<a class="code" href="structast__db__entry.html#a3fee4a0a4bff112e0262fb8d49f41b5e">next</a> = NULL;
<a name="l00520"></a>00520          cur-&gt;<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a> = cur-&gt;<a class="code" href="structast__db__entry.html#a9a3b4be1b9151b0369d7fca9911c7ecd">data</a> + values_len;
<a name="l00521"></a>00521          strcpy(cur-&gt;<a class="code" href="structast__db__entry.html#a9a3b4be1b9151b0369d7fca9911c7ecd">data</a>, values);
<a name="l00522"></a>00522          strcpy(cur-&gt;<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>, keys);
<a name="l00523"></a>00523          <span class="keywordflow">if</span> (last) {
<a name="l00524"></a>00524             last-&gt;<a class="code" href="structast__db__entry.html#a3fee4a0a4bff112e0262fb8d49f41b5e">next</a> = cur;
<a name="l00525"></a>00525          } <span class="keywordflow">else</span> {
<a name="l00526"></a>00526             ret = cur;
<a name="l00527"></a>00527          }
<a name="l00528"></a>00528          last = cur;
<a name="l00529"></a>00529       }
<a name="l00530"></a>00530    }
<a name="l00531"></a>00531    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00532"></a>00532    <span class="keywordflow">return</span> ret; 
<a name="l00533"></a>00533 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a34522d18f4fa2880f22b203cebda37f0"></a><!-- doxytag: member="db.c::ast_db_put" ref="a34522d18f4fa2880f22b203cebda37f0" args="(const char *family, const char *keys, const char *value)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_db_put </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>family</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>keys</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>value</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Store value addressed by family/key. </p>

<p>Definition at line <a class="el" href="db_8c_source.html#l00138">138</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="db_8c_source.html#l00054">dbinit()</a>, <a class="el" href="db_8c_source.html#l00052">dblock</a>, and <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>.</p>

<p>Referenced by <a class="el" href="privacy_8c_source.html#l00080">ast_privacy_set()</a>, <a class="el" href="pbx__dundi_8c_source.html#l00876">cache_save()</a>, <a class="el" href="pbx__dundi_8c_source.html#l00841">cache_save_hint()</a>, <a class="el" href="app__alarmreceiver_8c_source.html#l00108">database_increment()</a>, <a class="el" href="func__devstate_8c_source.html#l00107">devstate_write()</a>, <a class="el" href="func__dialgroup_8c_source.html#l00168">dialgroup_refreshdb()</a>, <a class="el" href="chan__agent_8c_source.html#l02362">dump_agents()</a>, <a class="el" href="app__queue_8c_source.html#l04356">dump_queue_members()</a>, <a class="el" href="func__db_8c_source.html#l00136">function_db_write()</a>, <a class="el" href="db_8c_source.html#l00237">handle_cli_database_put()</a>, <a class="el" href="func__devstate_8c_source.html#l00235">handle_cli_devstate_change()</a>, <a class="el" href="pbx__dundi_8c_source.html#l01553">handle_command_response()</a>, <a class="el" href="res__agi_8c_source.html#l01914">handle_dbput()</a>, <a class="el" href="iax2-provision_8c_source.html#l00206">iax_provision_build()</a>, <a class="el" href="db_8c_source.html#l00554">manager_dbput()</a>, <a class="el" href="chan__mgcp_8c_source.html#l02637">mgcp_ss()</a>, <a class="el" href="chan__sip_8c_source.html#l12222">parse_register_contact()</a>, <a class="el" href="pbx__dundi_8c_source.html#l02097">save_secret()</a>, <a class="el" href="chan__dahdi_8c_source.html#l07675">ss_thread()</a>, and <a class="el" href="chan__iax2_8c_source.html#l08346">update_registry()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00139"></a>00139 {
<a name="l00140"></a>00140    <span class="keywordtype">char</span> fullkey[256];
<a name="l00141"></a>00141    DBT <a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>, <a class="code" href="structast__db__entry.html#a9a3b4be1b9151b0369d7fca9911c7ecd">data</a>;
<a name="l00142"></a>00142    <span class="keywordtype">int</span> res, fullkeylen;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00145"></a>00145    <span class="keywordflow">if</span> (<a class="code" href="db_8c.html#aa0a32443a3a66aae82eab44edfc22304">dbinit</a>()) {
<a name="l00146"></a>00146       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00147"></a>00147       <span class="keywordflow">return</span> -1;
<a name="l00148"></a>00148    }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150    fullkeylen = snprintf(fullkey, <span class="keyword">sizeof</span>(fullkey), <span class="stringliteral">&quot;/%s/%s&quot;</span>, family, <a class="code" href="structkeys.html">keys</a>);
<a name="l00151"></a>00151    memset(&amp;key, 0, <span class="keyword">sizeof</span>(key));
<a name="l00152"></a>00152    memset(&amp;data, 0, <span class="keyword">sizeof</span>(data));
<a name="l00153"></a>00153    key.data = fullkey;
<a name="l00154"></a>00154    key.size = fullkeylen + 1;
<a name="l00155"></a>00155    data.data = (<span class="keywordtype">char</span> *) value;
<a name="l00156"></a>00156    data.size = strlen(value) + 1;
<a name="l00157"></a>00157    res = <a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>-&gt;put(<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>, &amp;key, &amp;data, 0);
<a name="l00158"></a>00158    <a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>-&gt;sync(<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>, 0);
<a name="l00159"></a>00159    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00160"></a>00160    <span class="keywordflow">if</span> (res)
<a name="l00161"></a>00161       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to put value &apos;%s&apos; for key &apos;%s&apos; in family &apos;%s&apos;\n&quot;</span>, value, <a class="code" href="structkeys.html">keys</a>, family);
<a name="l00162"></a>00162    <span class="keywordflow">return</span> res;
<a name="l00163"></a>00163 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a52d9808db8eba7a1ff32fc6686042f04"></a><!-- doxytag: member="db.c::astdb_init" ref="a52d9808db8eba7a1ff32fc6686042f04" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int astdb_init </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Provided by <a class="el" href="db_8c.html" title="ASTdb Management.">db.c</a> </p>

<p>Definition at line <a class="el" href="db_8c_source.html#l00665">665</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="isdn__lib_8c_source.html#l00040">ARRAY_LEN</a>, <a class="el" href="cli_8c_source.html#l01927">ast_cli_register_multiple()</a>, <a class="el" href="manager_8h_source.html#l00133">ast_manager_register</a>, <a class="el" href="db_8c_source.html#l00054">dbinit()</a>, <a class="el" href="manager_8h_source.html#l00070">EVENT_FLAG_REPORTING</a>, <a class="el" href="manager_8h_source.html#l00061">EVENT_FLAG_SYSTEM</a>, <a class="el" href="db_8c_source.html#l00616">manager_dbdel()</a>, <a class="el" href="db_8c_source.html#l00641">manager_dbdeltree()</a>, <a class="el" href="db_8c_source.html#l00579">manager_dbget()</a>, and <a class="el" href="db_8c_source.html#l00554">manager_dbput()</a>.</p>

<p>Referenced by <a class="el" href="asterisk_8c_source.html#l03095">main()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00666"></a>00666 {
<a name="l00667"></a>00667    <a class="code" href="db_8c.html#aa0a32443a3a66aae82eab44edfc22304">dbinit</a>();
<a name="l00668"></a>00668    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="db_8c.html#a2956356b5eeaacfec5a223ce1417fc6d">cli_database</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="db_8c.html#a2956356b5eeaacfec5a223ce1417fc6d">cli_database</a>));
<a name="l00669"></a>00669    <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;DBGet&quot;</span>, <a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a> | <a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <a class="code" href="db_8c.html#a415a23bb61c561440bc3ae9d263461ad">manager_dbget</a>, <span class="stringliteral">&quot;Get DB Entry&quot;</span>);
<a name="l00670"></a>00670    <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;DBPut&quot;</span>, <a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <a class="code" href="db_8c.html#a63408b76b1f9eed31bcd1211d2081f03">manager_dbput</a>, <span class="stringliteral">&quot;Put DB Entry&quot;</span>);
<a name="l00671"></a>00671    <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;DBDel&quot;</span>, <a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <a class="code" href="db_8c.html#a03f7dee6cad1dff30caf7133244cd811">manager_dbdel</a>, <span class="stringliteral">&quot;Delete DB Entry&quot;</span>);
<a name="l00672"></a>00672    <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;DBDelTree&quot;</span>, <a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <a class="code" href="db_8c.html#a274fd536a82bf71830421f6b0ff63702">manager_dbdeltree</a>, <span class="stringliteral">&quot;Delete DB Tree&quot;</span>);
<a name="l00673"></a>00673    <span class="keywordflow">return</span> 0;
<a name="l00674"></a>00674 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa0a32443a3a66aae82eab44edfc22304"></a><!-- doxytag: member="db.c::dbinit" ref="aa0a32443a3a66aae82eab44edfc22304" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int dbinit </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00054">54</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="asterisk_8c_source.html#l00260">ast_config_AST_DB</a>, <a class="el" href="asterisk_8h_source.html#l00036">AST_FILE_MODE</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, and <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>.</p>

<p>Referenced by <a class="el" href="db_8c_source.html#l00209">ast_db_del()</a>, <a class="el" href="db_8c_source.html#l00091">ast_db_deltree()</a>, <a class="el" href="db_8c_source.html#l00165">ast_db_get()</a>, <a class="el" href="db_8c_source.html#l00473">ast_db_gettree()</a>, <a class="el" href="db_8c_source.html#l00138">ast_db_put()</a>, <a class="el" href="db_8c_source.html#l00665">astdb_init()</a>, <a class="el" href="db_8c_source.html#l00350">handle_cli_database_show()</a>, <a class="el" href="db_8c_source.html#l00415">handle_cli_database_showkey()</a>, and <a class="el" href="cdr__tds_8c_source.html#l00524">load_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00055"></a>00055 {
<a name="l00056"></a>00056    <span class="keywordflow">if</span> (!<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a> &amp;&amp; !(<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a> = dbopen(<a class="code" href="paths_8h.html#af89b8aa53d5b08a03b56f5163805bd97">ast_config_AST_DB</a>, O_CREAT | O_RDWR, <a class="code" href="asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>, DB_BTREE, NULL))) {
<a name="l00057"></a>00057       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open Asterisk database &apos;%s&apos;: %s\n&quot;</span>, <a class="code" href="paths_8h.html#af89b8aa53d5b08a03b56f5163805bd97">ast_config_AST_DB</a>, strerror(errno));
<a name="l00058"></a>00058       <span class="keywordflow">return</span> -1;
<a name="l00059"></a>00059    }
<a name="l00060"></a>00060    <span class="keywordflow">return</span> 0;
<a name="l00061"></a>00061 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab2ffb685a189bc273c1de00753c31091"></a><!-- doxytag: member="db.c::handle_cli_database_del" ref="ab2ffb685a189bc273c1de00753c31091" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_cli_database_del </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00292">292</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8h_source.html#l00141">ast_cli_args::argv</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="db_8c_source.html#l00209">ast_db_del()</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00293"></a>00293 {
<a name="l00294"></a>00294    <span class="keywordtype">int</span> res;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296    <span class="keywordflow">switch</span> (cmd) {
<a name="l00297"></a>00297    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00298"></a>00298       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;database del&quot;</span>;
<a name="l00299"></a>00299       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00300"></a>00300          <span class="stringliteral">&quot;Usage: database del &lt;family&gt; &lt;key&gt;\n&quot;</span>
<a name="l00301"></a>00301          <span class="stringliteral">&quot;       Deletes an entry in the Asterisk database for a given\n&quot;</span>
<a name="l00302"></a>00302          <span class="stringliteral">&quot;       family and key.\n&quot;</span>;
<a name="l00303"></a>00303       <span class="keywordflow">return</span> NULL;
<a name="l00304"></a>00304    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00305"></a>00305       <span class="keywordflow">return</span> NULL;
<a name="l00306"></a>00306    }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l00309"></a>00309       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00310"></a>00310    res = <a class="code" href="astdb_8h.html#a71e8d5ab1757b184683a99125d1c8160" title="Delete entry in astdb.">ast_db_del</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l00311"></a>00311    <span class="keywordflow">if</span> (res) {
<a name="l00312"></a>00312       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Database entry does not exist.\n&quot;</span>);
<a name="l00313"></a>00313    } <span class="keywordflow">else</span> {
<a name="l00314"></a>00314       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Database entry removed.\n&quot;</span>);
<a name="l00315"></a>00315    }
<a name="l00316"></a>00316    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00317"></a>00317 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac0dc7f1713e81aee579767f2269b6ce1"></a><!-- doxytag: member="db.c::handle_cli_database_deltree" ref="ac0dc7f1713e81aee579767f2269b6ce1" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_cli_database_deltree </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00319">319</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8h_source.html#l00141">ast_cli_args::argv</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="db_8c_source.html#l00091">ast_db_deltree()</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00320"></a>00320 {
<a name="l00321"></a>00321    <span class="keywordtype">int</span> res;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323    <span class="keywordflow">switch</span> (cmd) {
<a name="l00324"></a>00324    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00325"></a>00325       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;database deltree&quot;</span>;
<a name="l00326"></a>00326       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00327"></a>00327          <span class="stringliteral">&quot;Usage: database deltree &lt;family&gt; [keytree]\n&quot;</span>
<a name="l00328"></a>00328          <span class="stringliteral">&quot;       Deletes a family or specific keytree within a family\n&quot;</span>
<a name="l00329"></a>00329          <span class="stringliteral">&quot;       in the Asterisk database.\n&quot;</span>;
<a name="l00330"></a>00330       <span class="keywordflow">return</span> NULL;
<a name="l00331"></a>00331    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00332"></a>00332       <span class="keywordflow">return</span> NULL;
<a name="l00333"></a>00333    }
<a name="l00334"></a>00334 
<a name="l00335"></a>00335    <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 3) || (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 4))
<a name="l00336"></a>00336       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00337"></a>00337    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 4) {
<a name="l00338"></a>00338       res = <a class="code" href="astdb_8h.html#af251d986cfe884ffd5ca864531253f62" title="Delete a whole family (for some reason also called &amp;quot;tree&amp;quot;.">ast_db_deltree</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l00339"></a>00339    } <span class="keywordflow">else</span> {
<a name="l00340"></a>00340       res = <a class="code" href="astdb_8h.html#af251d986cfe884ffd5ca864531253f62" title="Delete a whole family (for some reason also called &amp;quot;tree&amp;quot;.">ast_db_deltree</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], NULL);
<a name="l00341"></a>00341    }
<a name="l00342"></a>00342    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00343"></a>00343       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Database entries do not exist.\n&quot;</span>);
<a name="l00344"></a>00344    } <span class="keywordflow">else</span> {
<a name="l00345"></a>00345       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d database entries removed.\n&quot;</span>,res);
<a name="l00346"></a>00346    }
<a name="l00347"></a>00347    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00348"></a>00348 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="afb5ce976f5d19ec85c79189213596d96"></a><!-- doxytag: member="db.c::handle_cli_database_get" ref="afb5ce976f5d19ec85c79189213596d96" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_cli_database_get </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00264">264</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8h_source.html#l00141">ast_cli_args::argv</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="db_8c_source.html#l00165">ast_db_get()</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00265"></a>00265 {
<a name="l00266"></a>00266    <span class="keywordtype">int</span> res;
<a name="l00267"></a>00267    <span class="keywordtype">char</span> tmp[256];
<a name="l00268"></a>00268 
<a name="l00269"></a>00269    <span class="keywordflow">switch</span> (cmd) {
<a name="l00270"></a>00270    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00271"></a>00271       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;database get&quot;</span>;
<a name="l00272"></a>00272       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00273"></a>00273          <span class="stringliteral">&quot;Usage: database get &lt;family&gt; &lt;key&gt;\n&quot;</span>
<a name="l00274"></a>00274          <span class="stringliteral">&quot;       Retrieves an entry in the Asterisk database for a given\n&quot;</span>
<a name="l00275"></a>00275          <span class="stringliteral">&quot;       family and key.\n&quot;</span>;
<a name="l00276"></a>00276       <span class="keywordflow">return</span> NULL;
<a name="l00277"></a>00277    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00278"></a>00278       <span class="keywordflow">return</span> NULL;
<a name="l00279"></a>00279    }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l00282"></a>00282       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00283"></a>00283    res = <a class="code" href="astdb_8h.html#a48033762bf6ab77f15dd72277a1fe7fa" title="Get key value specified by family/key.">ast_db_get</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], tmp, <span class="keyword">sizeof</span>(tmp));
<a name="l00284"></a>00284    <span class="keywordflow">if</span> (res) {
<a name="l00285"></a>00285       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Database entry not found.\n&quot;</span>);
<a name="l00286"></a>00286    } <span class="keywordflow">else</span> {
<a name="l00287"></a>00287       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Value: %s\n&quot;</span>, tmp);
<a name="l00288"></a>00288    }
<a name="l00289"></a>00289    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00290"></a>00290 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a05c446a72a078b710425b61d0d999e07"></a><!-- doxytag: member="db.c::handle_cli_database_put" ref="a05c446a72a078b710425b61d0d999e07" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_cli_database_put </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00237">237</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8h_source.html#l00141">ast_cli_args::argv</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="db_8c_source.html#l00138">ast_db_put()</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00238"></a>00238 {
<a name="l00239"></a>00239    <span class="keywordtype">int</span> res;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241    <span class="keywordflow">switch</span> (cmd) {
<a name="l00242"></a>00242    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00243"></a>00243       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;database put&quot;</span>;
<a name="l00244"></a>00244       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00245"></a>00245          <span class="stringliteral">&quot;Usage: database put &lt;family&gt; &lt;key&gt; &lt;value&gt;\n&quot;</span>
<a name="l00246"></a>00246          <span class="stringliteral">&quot;       Adds or updates an entry in the Asterisk database for\n&quot;</span>
<a name="l00247"></a>00247          <span class="stringliteral">&quot;       a given family, key, and value.\n&quot;</span>;
<a name="l00248"></a>00248       <span class="keywordflow">return</span> NULL;
<a name="l00249"></a>00249    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00250"></a>00250       <span class="keywordflow">return</span> NULL;
<a name="l00251"></a>00251    }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 5)
<a name="l00254"></a>00254       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00255"></a>00255    res = <a class="code" href="astdb_8h.html#a0f14f6bff4f412c88b50aba34d3a5e35" title="Store value addressed by family/key.">ast_db_put</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4]);
<a name="l00256"></a>00256    <span class="keywordflow">if</span> (res)  {
<a name="l00257"></a>00257       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to update entry\n&quot;</span>);
<a name="l00258"></a>00258    } <span class="keywordflow">else</span> {
<a name="l00259"></a>00259       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Updated database successfully\n&quot;</span>);
<a name="l00260"></a>00260    }
<a name="l00261"></a>00261    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00262"></a>00262 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aed10f708f89ad5111a2f1ca77013305e"></a><!-- doxytag: member="db.c::handle_cli_database_show" ref="aed10f708f89ad5111a2f1ca77013305e" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_cli_database_show </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00350">350</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8h_source.html#l00141">ast_cli_args::argv</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="db_8c_source.html#l00054">dbinit()</a>, <a class="el" href="db_8c_source.html#l00052">dblock</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="db_8c_source.html#l00064">keymatch()</a>, <a class="el" href="res__config__ldap_8c_source.html#l00069">pass</a>, <a class="el" href="http_8c_source.html#l00092">prefix</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00351"></a>00351 {
<a name="l00352"></a>00352    <span class="keywordtype">char</span> <a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>[256];
<a name="l00353"></a>00353    DBT <a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>, <a class="code" href="structast__db__entry.html#a9a3b4be1b9151b0369d7fca9911c7ecd">data</a>;
<a name="l00354"></a>00354    <span class="keywordtype">char</span> *<a class="code" href="structkeys.html">keys</a>, *<a class="code" href="structvalues.html">values</a>;
<a name="l00355"></a>00355    <span class="keywordtype">int</span> res;
<a name="l00356"></a>00356    <span class="keywordtype">int</span> <a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>;
<a name="l00357"></a>00357    <span class="keywordtype">int</span> counter = 0;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359    <span class="keywordflow">switch</span> (cmd) {
<a name="l00360"></a>00360    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00361"></a>00361       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;database show&quot;</span>;
<a name="l00362"></a>00362       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00363"></a>00363          <span class="stringliteral">&quot;Usage: database show [family [keytree]]\n&quot;</span>
<a name="l00364"></a>00364          <span class="stringliteral">&quot;       Shows Asterisk database contents, optionally restricted\n&quot;</span>
<a name="l00365"></a>00365          <span class="stringliteral">&quot;       to a given family, or family and keytree.\n&quot;</span>;
<a name="l00366"></a>00366       <span class="keywordflow">return</span> NULL;
<a name="l00367"></a>00367    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00368"></a>00368       <span class="keywordflow">return</span> NULL;
<a name="l00369"></a>00369    }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 4) {
<a name="l00372"></a>00372       <span class="comment">/* Family and key tree */</span>
<a name="l00373"></a>00373       snprintf(prefix, <span class="keyword">sizeof</span>(prefix), <span class="stringliteral">&quot;/%s/%s&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l00374"></a>00374    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3) {
<a name="l00375"></a>00375       <span class="comment">/* Family only */</span>
<a name="l00376"></a>00376       snprintf(prefix, <span class="keyword">sizeof</span>(prefix), <span class="stringliteral">&quot;/%s&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);
<a name="l00377"></a>00377    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 2) {
<a name="l00378"></a>00378       <span class="comment">/* Neither */</span>
<a name="l00379"></a>00379       prefix[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00380"></a>00380    } <span class="keywordflow">else</span> {
<a name="l00381"></a>00381       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00382"></a>00382    }
<a name="l00383"></a>00383    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00384"></a>00384    <span class="keywordflow">if</span> (<a class="code" href="db_8c.html#aa0a32443a3a66aae82eab44edfc22304">dbinit</a>()) {
<a name="l00385"></a>00385       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00386"></a>00386       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Database unavailable\n&quot;</span>);
<a name="l00387"></a>00387       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;  
<a name="l00388"></a>00388    }
<a name="l00389"></a>00389    memset(&amp;key, 0, <span class="keyword">sizeof</span>(key));
<a name="l00390"></a>00390    memset(&amp;data, 0, <span class="keyword">sizeof</span>(data));
<a name="l00391"></a>00391    pass = 0;
<a name="l00392"></a>00392    <span class="keywordflow">while</span> (!(res = <a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>-&gt;seq(<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>, &amp;key, &amp;data, pass++ ? R_NEXT : R_FIRST))) {
<a name="l00393"></a>00393       <span class="keywordflow">if</span> (key.size) {
<a name="l00394"></a>00394          keys = key.data;
<a name="l00395"></a>00395          keys[key.size - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00396"></a>00396       } <span class="keywordflow">else</span> {
<a name="l00397"></a>00397          keys = <span class="stringliteral">&quot;&lt;bad key&gt;&quot;</span>;
<a name="l00398"></a>00398       }
<a name="l00399"></a>00399       <span class="keywordflow">if</span> (data.size) {
<a name="l00400"></a>00400          values = data.data;
<a name="l00401"></a>00401          values[data.size - 1]=<span class="charliteral">&apos;\0&apos;</span>;
<a name="l00402"></a>00402       } <span class="keywordflow">else</span> {
<a name="l00403"></a>00403          values = <span class="stringliteral">&quot;&lt;bad value&gt;&quot;</span>;
<a name="l00404"></a>00404       }
<a name="l00405"></a>00405       <span class="keywordflow">if</span> (<a class="code" href="db_8c.html#a58c92732ca410e48df4ea7f8d524a840">keymatch</a>(keys, prefix)) {
<a name="l00406"></a>00406          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-50s: %-25s\n&quot;</span>, keys, values);
<a name="l00407"></a>00407          counter++;
<a name="l00408"></a>00408       }
<a name="l00409"></a>00409    }
<a name="l00410"></a>00410    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00411"></a>00411    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d results found.\n&quot;</span>, counter);
<a name="l00412"></a>00412    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;  
<a name="l00413"></a>00413 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ade1bc05ba29175fe3f6a5f2b67143ffd"></a><!-- doxytag: member="db.c::handle_cli_database_showkey" ref="ade1bc05ba29175fe3f6a5f2b67143ffd" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_cli_database_showkey </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00415">415</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8h_source.html#l00141">ast_cli_args::argv</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="db_8c_source.html#l00054">dbinit()</a>, <a class="el" href="db_8c_source.html#l00052">dblock</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="res__config__ldap_8c_source.html#l00069">pass</a>, <a class="el" href="db_8c_source.html#l00078">subkeymatch()</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00416"></a>00416 {
<a name="l00417"></a>00417    <span class="keywordtype">char</span> suffix[256];
<a name="l00418"></a>00418    DBT <a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>, <a class="code" href="structast__db__entry.html#a9a3b4be1b9151b0369d7fca9911c7ecd">data</a>;
<a name="l00419"></a>00419    <span class="keywordtype">char</span> *<a class="code" href="structkeys.html">keys</a>, *<a class="code" href="structvalues.html">values</a>;
<a name="l00420"></a>00420    <span class="keywordtype">int</span> res;
<a name="l00421"></a>00421    <span class="keywordtype">int</span> <a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>;
<a name="l00422"></a>00422    <span class="keywordtype">int</span> counter = 0;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424    <span class="keywordflow">switch</span> (cmd) {
<a name="l00425"></a>00425    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00426"></a>00426       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;database showkey&quot;</span>;
<a name="l00427"></a>00427       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00428"></a>00428          <span class="stringliteral">&quot;Usage: database showkey &lt;keytree&gt;\n&quot;</span>
<a name="l00429"></a>00429          <span class="stringliteral">&quot;       Shows Asterisk database contents, restricted to a given key.\n&quot;</span>;
<a name="l00430"></a>00430       <span class="keywordflow">return</span> NULL;
<a name="l00431"></a>00431    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00432"></a>00432       <span class="keywordflow">return</span> NULL;
<a name="l00433"></a>00433    }
<a name="l00434"></a>00434 
<a name="l00435"></a>00435    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3) {
<a name="l00436"></a>00436       <span class="comment">/* Key only */</span>
<a name="l00437"></a>00437       snprintf(suffix, <span class="keyword">sizeof</span>(suffix), <span class="stringliteral">&quot;/%s&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);
<a name="l00438"></a>00438    } <span class="keywordflow">else</span> {
<a name="l00439"></a>00439       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00440"></a>00440    }
<a name="l00441"></a>00441    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00442"></a>00442    <span class="keywordflow">if</span> (<a class="code" href="db_8c.html#aa0a32443a3a66aae82eab44edfc22304">dbinit</a>()) {
<a name="l00443"></a>00443       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00444"></a>00444       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Database unavailable\n&quot;</span>);
<a name="l00445"></a>00445       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;  
<a name="l00446"></a>00446    }
<a name="l00447"></a>00447    memset(&amp;key, 0, <span class="keyword">sizeof</span>(key));
<a name="l00448"></a>00448    memset(&amp;data, 0, <span class="keyword">sizeof</span>(data));
<a name="l00449"></a>00449    pass = 0;
<a name="l00450"></a>00450    <span class="keywordflow">while</span> (!(res = <a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>-&gt;seq(<a class="code" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a>, &amp;key, &amp;data, pass++ ? R_NEXT : R_FIRST))) {
<a name="l00451"></a>00451       <span class="keywordflow">if</span> (key.size) {
<a name="l00452"></a>00452          keys = key.data;
<a name="l00453"></a>00453          keys[key.size - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00454"></a>00454       } <span class="keywordflow">else</span> {
<a name="l00455"></a>00455          keys = <span class="stringliteral">&quot;&lt;bad key&gt;&quot;</span>;
<a name="l00456"></a>00456       }
<a name="l00457"></a>00457       <span class="keywordflow">if</span> (data.size) {
<a name="l00458"></a>00458          values = data.data;
<a name="l00459"></a>00459          values[data.size - 1]=<span class="charliteral">&apos;\0&apos;</span>;
<a name="l00460"></a>00460       } <span class="keywordflow">else</span> {
<a name="l00461"></a>00461          values = <span class="stringliteral">&quot;&lt;bad value&gt;&quot;</span>;
<a name="l00462"></a>00462       }
<a name="l00463"></a>00463       <span class="keywordflow">if</span> (<a class="code" href="db_8c.html#ae4876bea6a08b2f9d90815ad39d455cf">subkeymatch</a>(keys, suffix)) {
<a name="l00464"></a>00464          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-50s: %-25s\n&quot;</span>, keys, values);
<a name="l00465"></a>00465          counter++;
<a name="l00466"></a>00466       }
<a name="l00467"></a>00467    }
<a name="l00468"></a>00468    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a>);
<a name="l00469"></a>00469    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d results found.\n&quot;</span>, counter);
<a name="l00470"></a>00470    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;  
<a name="l00471"></a>00471 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a58c92732ca410e48df4ea7f8d524a840"></a><!-- doxytag: member="db.c::keymatch" ref="a58c92732ca410e48df4ea7f8d524a840" args="(const char *key, const char *prefix)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int keymatch </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>prefix</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00064">64</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>Referenced by <a class="el" href="db_8c_source.html#l00091">ast_db_deltree()</a>, <a class="el" href="db_8c_source.html#l00473">ast_db_gettree()</a>, and <a class="el" href="db_8c_source.html#l00350">handle_cli_database_show()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00065"></a>00065 {
<a name="l00066"></a>00066    <span class="keywordtype">int</span> preflen = strlen(<a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>);
<a name="l00067"></a>00067    <span class="keywordflow">if</span> (!preflen)
<a name="l00068"></a>00068       <span class="keywordflow">return</span> 1;
<a name="l00069"></a>00069    <span class="keywordflow">if</span> (!strcasecmp(<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>, <a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>))
<a name="l00070"></a>00070       <span class="keywordflow">return</span> 1;
<a name="l00071"></a>00071    <span class="keywordflow">if</span> ((strlen(<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>) &gt; preflen) &amp;&amp; !strncasecmp(<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>, <a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>, preflen)) {
<a name="l00072"></a>00072       <span class="keywordflow">if</span> (<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>[preflen] == <span class="charliteral">&apos;/&apos;</span>)
<a name="l00073"></a>00073          <span class="keywordflow">return</span> 1;
<a name="l00074"></a>00074    }
<a name="l00075"></a>00075    <span class="keywordflow">return</span> 0;
<a name="l00076"></a>00076 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a03f7dee6cad1dff30caf7133244cd811"></a><!-- doxytag: member="db.c::manager_dbdel" ref="a03f7dee6cad1dff30caf7133244cd811" args="(struct mansession *s, const struct message *m)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int manager_dbdel </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structmansession.html">mansession</a> *&nbsp;</td>
          <td class="paramname"> <em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structmessage.html">message</a> *&nbsp;</td>
          <td class="paramname"> <em>m</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00616">616</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="db_8c_source.html#l00209">ast_db_del()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="manager_8c_source.html#l00897">astman_get_header()</a>, <a class="el" href="manager_8c_source.html#l01032">astman_send_ack()</a>, and <a class="el" href="manager_8c_source.html#l01027">astman_send_error()</a>.</p>

<p>Referenced by <a class="el" href="db_8c_source.html#l00665">astdb_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00617"></a>00617 {
<a name="l00618"></a>00618    <span class="keyword">const</span> <span class="keywordtype">char</span> *family = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Family&quot;</span>);
<a name="l00619"></a>00619    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Key&quot;</span>);
<a name="l00620"></a>00620    <span class="keywordtype">int</span> res;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(family)) {
<a name="l00623"></a>00623       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No family specified.&quot;</span>);
<a name="l00624"></a>00624       <span class="keywordflow">return</span> 0;
<a name="l00625"></a>00625    }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(key)) {
<a name="l00628"></a>00628       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No key specified.&quot;</span>);
<a name="l00629"></a>00629       <span class="keywordflow">return</span> 0;
<a name="l00630"></a>00630    }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632    res = <a class="code" href="astdb_8h.html#a71e8d5ab1757b184683a99125d1c8160" title="Delete entry in astdb.">ast_db_del</a>(family, key);
<a name="l00633"></a>00633    <span class="keywordflow">if</span> (res)
<a name="l00634"></a>00634       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Database entry not found&quot;</span>);
<a name="l00635"></a>00635    <span class="keywordflow">else</span>
<a name="l00636"></a>00636       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Key deleted successfully&quot;</span>);
<a name="l00637"></a>00637 
<a name="l00638"></a>00638    <span class="keywordflow">return</span> 0;
<a name="l00639"></a>00639 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a274fd536a82bf71830421f6b0ff63702"></a><!-- doxytag: member="db.c::manager_dbdeltree" ref="a274fd536a82bf71830421f6b0ff63702" args="(struct mansession *s, const struct message *m)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int manager_dbdeltree </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structmansession.html">mansession</a> *&nbsp;</td>
          <td class="paramname"> <em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structmessage.html">message</a> *&nbsp;</td>
          <td class="paramname"> <em>m</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00641">641</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="db_8c_source.html#l00091">ast_db_deltree()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="manager_8c_source.html#l00897">astman_get_header()</a>, <a class="el" href="manager_8c_source.html#l01032">astman_send_ack()</a>, and <a class="el" href="manager_8c_source.html#l01027">astman_send_error()</a>.</p>

<p>Referenced by <a class="el" href="db_8c_source.html#l00665">astdb_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00642"></a>00642 {
<a name="l00643"></a>00643    <span class="keyword">const</span> <span class="keywordtype">char</span> *family = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Family&quot;</span>);
<a name="l00644"></a>00644    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Key&quot;</span>);
<a name="l00645"></a>00645    <span class="keywordtype">int</span> res;
<a name="l00646"></a>00646 
<a name="l00647"></a>00647    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(family)) {
<a name="l00648"></a>00648       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No family specified.&quot;</span>);
<a name="l00649"></a>00649       <span class="keywordflow">return</span> 0;
<a name="l00650"></a>00650    }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(key))
<a name="l00653"></a>00653       res = <a class="code" href="astdb_8h.html#af251d986cfe884ffd5ca864531253f62" title="Delete a whole family (for some reason also called &amp;quot;tree&amp;quot;.">ast_db_deltree</a>(family, key);
<a name="l00654"></a>00654    <span class="keywordflow">else</span>
<a name="l00655"></a>00655       res = <a class="code" href="astdb_8h.html#af251d986cfe884ffd5ca864531253f62" title="Delete a whole family (for some reason also called &amp;quot;tree&amp;quot;.">ast_db_deltree</a>(family, NULL);
<a name="l00656"></a>00656 
<a name="l00657"></a>00657    <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00658"></a>00658       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Database entry not found&quot;</span>);
<a name="l00659"></a>00659    <span class="keywordflow">else</span>
<a name="l00660"></a>00660       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Key tree deleted successfully&quot;</span>);
<a name="l00661"></a>00661    
<a name="l00662"></a>00662    <span class="keywordflow">return</span> 0;
<a name="l00663"></a>00663 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a415a23bb61c561440bc3ae9d263461ad"></a><!-- doxytag: member="db.c::manager_dbget" ref="a415a23bb61c561440bc3ae9d263461ad" args="(struct mansession *s, const struct message *m)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int manager_dbget </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structmansession.html">mansession</a> *&nbsp;</td>
          <td class="paramname"> <em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structmessage.html">message</a> *&nbsp;</td>
          <td class="paramname"> <em>m</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00579">579</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="db_8c_source.html#l00165">ast_db_get()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="manager_8c_source.html#l00969">astman_append()</a>, <a class="el" href="manager_8c_source.html#l00897">astman_get_header()</a>, <a class="el" href="manager_8c_source.html#l01032">astman_send_ack()</a>, and <a class="el" href="manager_8c_source.html#l01027">astman_send_error()</a>.</p>

<p>Referenced by <a class="el" href="db_8c_source.html#l00665">astdb_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00580"></a>00580 {
<a name="l00581"></a>00581    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l00582"></a>00582    <span class="keywordtype">char</span> idText[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00583"></a>00583    <span class="keyword">const</span> <span class="keywordtype">char</span> *family = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Family&quot;</span>);
<a name="l00584"></a>00584    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Key&quot;</span>);
<a name="l00585"></a>00585    <span class="keywordtype">char</span> tmp[256];
<a name="l00586"></a>00586    <span class="keywordtype">int</span> res;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(family)) {
<a name="l00589"></a>00589       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No family specified.&quot;</span>);
<a name="l00590"></a>00590       <span class="keywordflow">return</span> 0;
<a name="l00591"></a>00591    }
<a name="l00592"></a>00592    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(key)) {
<a name="l00593"></a>00593       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No key specified.&quot;</span>);
<a name="l00594"></a>00594       <span class="keywordflow">return</span> 0;
<a name="l00595"></a>00595    }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l00598"></a>00598       snprintf(idText, <span class="keyword">sizeof</span>(idText) ,<span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, <span class="keywordtype">id</span>);
<a name="l00599"></a>00599 
<a name="l00600"></a>00600    res = <a class="code" href="astdb_8h.html#a48033762bf6ab77f15dd72277a1fe7fa" title="Get key value specified by family/key.">ast_db_get</a>(family, key, tmp, <span class="keyword">sizeof</span>(tmp));
<a name="l00601"></a>00601    <span class="keywordflow">if</span> (res) {
<a name="l00602"></a>00602       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Database entry not found&quot;</span>);
<a name="l00603"></a>00603    } <span class="keywordflow">else</span> {
<a name="l00604"></a>00604       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Result will follow&quot;</span>);
<a name="l00605"></a>00605       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: DBGetResponse\r\n&quot;</span>
<a name="l00606"></a>00606             <span class="stringliteral">&quot;Family: %s\r\n&quot;</span>
<a name="l00607"></a>00607             <span class="stringliteral">&quot;Key: %s\r\n&quot;</span>
<a name="l00608"></a>00608             <span class="stringliteral">&quot;Val: %s\r\n&quot;</span>
<a name="l00609"></a>00609             <span class="stringliteral">&quot;%s&quot;</span>
<a name="l00610"></a>00610             <span class="stringliteral">&quot;\r\n&quot;</span>,
<a name="l00611"></a>00611             family, key, tmp, idText);
<a name="l00612"></a>00612    }
<a name="l00613"></a>00613    <span class="keywordflow">return</span> 0;
<a name="l00614"></a>00614 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a63408b76b1f9eed31bcd1211d2081f03"></a><!-- doxytag: member="db.c::manager_dbput" ref="a63408b76b1f9eed31bcd1211d2081f03" args="(struct mansession *s, const struct message *m)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int manager_dbput </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structmansession.html">mansession</a> *&nbsp;</td>
          <td class="paramname"> <em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structmessage.html">message</a> *&nbsp;</td>
          <td class="paramname"> <em>m</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00554">554</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>References <a class="el" href="db_8c_source.html#l00138">ast_db_put()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="manager_8c_source.html#l00897">astman_get_header()</a>, <a class="el" href="manager_8c_source.html#l01032">astman_send_ack()</a>, <a class="el" href="manager_8c_source.html#l01027">astman_send_error()</a>, and <a class="el" href="strings_8h_source.html#l00072">S_OR</a>.</p>

<p>Referenced by <a class="el" href="db_8c_source.html#l00665">astdb_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00555"></a>00555 {
<a name="l00556"></a>00556    <span class="keyword">const</span> <span class="keywordtype">char</span> *family = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Family&quot;</span>);
<a name="l00557"></a>00557    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Key&quot;</span>);
<a name="l00558"></a>00558    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structval.html">val</a> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Val&quot;</span>);
<a name="l00559"></a>00559    <span class="keywordtype">int</span> res;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(family)) {
<a name="l00562"></a>00562       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No family specified&quot;</span>);
<a name="l00563"></a>00563       <span class="keywordflow">return</span> 0;
<a name="l00564"></a>00564    }
<a name="l00565"></a>00565    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(key)) {
<a name="l00566"></a>00566       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No key specified&quot;</span>);
<a name="l00567"></a>00567       <span class="keywordflow">return</span> 0;
<a name="l00568"></a>00568    }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570    res = <a class="code" href="astdb_8h.html#a0f14f6bff4f412c88b50aba34d3a5e35" title="Store value addressed by family/key.">ast_db_put</a>(family, key, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(val, <span class="stringliteral">&quot;&quot;</span>));
<a name="l00571"></a>00571    <span class="keywordflow">if</span> (res) {
<a name="l00572"></a>00572       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Failed to update entry&quot;</span>);
<a name="l00573"></a>00573    } <span class="keywordflow">else</span> {
<a name="l00574"></a>00574       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Updated database successfully&quot;</span>);
<a name="l00575"></a>00575    }
<a name="l00576"></a>00576    <span class="keywordflow">return</span> 0;
<a name="l00577"></a>00577 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae4876bea6a08b2f9d90815ad39d455cf"></a><!-- doxytag: member="db.c::subkeymatch" ref="ae4876bea6a08b2f9d90815ad39d455cf" args="(const char *key, const char *suffix)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int subkeymatch </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>suffix</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00078">78</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>Referenced by <a class="el" href="db_8c_source.html#l00415">handle_cli_database_showkey()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00079"></a>00079 {
<a name="l00080"></a>00080    <span class="keywordtype">int</span> suffixlen = strlen(suffix);
<a name="l00081"></a>00081    <span class="keywordflow">if</span> (suffixlen) {
<a name="l00082"></a>00082       <span class="keyword">const</span> <span class="keywordtype">char</span> *subkey = <a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a> + strlen(<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>) - suffixlen;
<a name="l00083"></a>00083       <span class="keywordflow">if</span> (subkey &lt; <a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>)
<a name="l00084"></a>00084          <span class="keywordflow">return</span> 0;
<a name="l00085"></a>00085       <span class="keywordflow">if</span> (!strcasecmp(subkey, suffix))
<a name="l00086"></a>00086          <span class="keywordflow">return</span> 1;
<a name="l00087"></a>00087    }
<a name="l00088"></a>00088    <span class="keywordflow">return</span> 0;
<a name="l00089"></a>00089 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a9d3003dc9f77f52e42af8174c2b25a97"></a><!-- doxytag: member="db.c::astdb" ref="a9d3003dc9f77f52e42af8174c2b25a97" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DB* <a class="el" href="db_8c.html#a9d3003dc9f77f52e42af8174c2b25a97">astdb</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00051">51</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

</div>
</div>
<a class="anchor" id="a2956356b5eeaacfec5a223ce1417fc6d"></a><!-- doxytag: member="db.c::cli_database" ref="a2956356b5eeaacfec5a223ce1417fc6d" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> <a class="el" href="db_8c.html#a2956356b5eeaacfec5a223ce1417fc6d">cli_database</a>[]</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00545">545</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

</div>
</div>
<a class="anchor" id="a885611b04f0f81cde233f5648aa58b7c"></a><!-- doxytag: member="db.c::dblock" ref="a885611b04f0f81cde233f5648aa58b7c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="el" href="db_8c.html#a885611b04f0f81cde233f5648aa58b7c">dblock</a> = ((<a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>) PTHREAD_MUTEX_INITIALIZER )<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="db_8c_source.html#l00052">52</a> of file <a class="el" href="db_8c_source.html">db.c</a>.</p>

<p>Referenced by <a class="el" href="db_8c_source.html#l00209">ast_db_del()</a>, <a class="el" href="db_8c_source.html#l00091">ast_db_deltree()</a>, <a class="el" href="db_8c_source.html#l00165">ast_db_get()</a>, <a class="el" href="db_8c_source.html#l00473">ast_db_gettree()</a>, <a class="el" href="db_8c_source.html#l00138">ast_db_put()</a>, <a class="el" href="db_8c_source.html#l00350">handle_cli_database_show()</a>, and <a class="el" href="db_8c_source.html#l00415">handle_cli_database_showkey()</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:21:58 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
