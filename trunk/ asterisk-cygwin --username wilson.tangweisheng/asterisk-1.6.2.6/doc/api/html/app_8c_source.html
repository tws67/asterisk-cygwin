<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:24 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>app.c</h1><a href="app_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2005, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Convenient Application Routines</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 231689 $&quot;</span>)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#ifdef HAVE_SYS_STAT_H</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#endif</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#include &lt;regex.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;sys/file.h&gt;</span> <span class="comment">/* added this to allow to compile, sorry! */</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>       <span class="comment">/* for getrlimit(2) */</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;sys/resource.h&gt;</span>   <span class="comment">/* for getrlimit(2) */</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>         <span class="comment">/* for closefrom(3) */</span>
<a name="l00039"></a>00039 <span class="preprocessor">#ifdef HAVE_CAP</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/capability.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_CAP */</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="paths_8h.html" title="Asterisk file paths, configured in asterisk.conf.">asterisk/paths.h</a>&quot;</span>   <span class="comment">/* use ast_config_AST_DATA_DIR */</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="dsp_8h.html" title="Convenient Signal Processing routines.">asterisk/dsp.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="indications_8h.html" title="Tone Indication Support.">asterisk/indications.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="linkedlists_8h.html" title="A set of macros to manage forward-linked lists.">asterisk/linkedlists.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="threadstorage_8h.html" title="Definitions to aid in the use of thread local storage.">asterisk/threadstorage.h</a>&quot;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <a class="code" href="threadstorage_8h.html#a4db23c8f7564d3d916d7934265ca474f">AST_THREADSTORAGE_PUBLIC</a>(ast_str_thread_global_buf);
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="app_8c.html#aa932272aad0c1610b79e9b04e54e57ea">00058</a> <span class="preprocessor">#define AST_MAX_FORMATS 10</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>
<a name="l00060"></a><a class="code" href="structgroups.html#ace4e0066a5b24f84b90536e9906619f6">00060</a> <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structgroups.html">groups</a>, <a class="code" href="structast__group__info.html" title="channel group info">ast_group_info</a>);
<a name="l00061"></a>00061 <span class="comment"></span>
<a name="l00062"></a>00062 <span class="comment">/*!</span>
<a name="l00063"></a>00063 <span class="comment"> * \brief This function presents a dialtone and reads an extension into &apos;collect&apos;</span>
<a name="l00064"></a>00064 <span class="comment"> * which must be a pointer to a **pre-initialized** array of char having a</span>
<a name="l00065"></a>00065 <span class="comment"> * size of &apos;size&apos; suitable for writing to.  It will collect no more than the smaller</span>
<a name="l00066"></a>00066 <span class="comment"> * of &apos;maxlen&apos; or &apos;size&apos; minus the original strlen() of collect digits.</span>
<a name="l00067"></a>00067 <span class="comment"> * \param chan struct.</span>
<a name="l00068"></a>00068 <span class="comment"> * \param context</span>
<a name="l00069"></a>00069 <span class="comment"> * \param collect</span>
<a name="l00070"></a>00070 <span class="comment"> * \param size</span>
<a name="l00071"></a>00071 <span class="comment"> * \param maxlen</span>
<a name="l00072"></a>00072 <span class="comment"> * \param timeout timeout in seconds</span>
<a name="l00073"></a>00073 <span class="comment"> *</span>
<a name="l00074"></a>00074 <span class="comment"> * \return 0 if extension does not exist, 1 if extension exists</span>
<a name="l00075"></a>00075 <span class="comment">*/</span>
<a name="l00076"></a><a class="code" href="app_8c.html#af4825b337b9cd145a059852ce85ec6cd">00076</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#af4825b337b9cd145a059852ce85ec6cd" title="Present a dialtone and collect a certain length extension.">ast_app_dtget</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keywordtype">char</span> *collect, <span class="keywordtype">size_t</span> size, <span class="keywordtype">int</span> maxlen, <span class="keywordtype">int</span> timeout)
<a name="l00077"></a>00077 {
<a name="l00078"></a>00078    <span class="keyword">struct </span><a class="code" href="structast__tone__zone__sound.html" title="Description of a tone.">ast_tone_zone_sound</a> *ts;
<a name="l00079"></a>00079    <span class="keywordtype">int</span> res = 0, x = 0;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081    <span class="keywordflow">if</span> (maxlen &gt; size) {
<a name="l00082"></a>00082       maxlen = size;
<a name="l00083"></a>00083    }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085    <span class="keywordflow">if</span> (!timeout &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>) {
<a name="l00086"></a>00086       timeout = chan-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a> / 1000.0;
<a name="l00087"></a>00087    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!timeout) {
<a name="l00088"></a>00088       timeout = 5;
<a name="l00089"></a>00089    }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091    <span class="keywordflow">if</span> ((ts = <a class="code" href="indications_8h.html#a516be2823557000dcd4be685a44d1d09" title="Locate a tone zone sound.">ast_get_indication_tone</a>(chan-&gt;<a class="code" href="structast__channel.html#a3b50931566324162ca5ebdd52fb5874c">zone</a>, <span class="stringliteral">&quot;dial&quot;</span>))) {
<a name="l00092"></a>00092       res = <a class="code" href="app__rpt_8c.html#a544e8a1dd4a986b00754103dda6a7d3b">ast_playtones_start</a>(chan, 0, ts-&gt;<a class="code" href="structast__tone__zone__sound.html#a8f64897c7ccc5c13f276d1d07c4e7095" title="Description of a tone.">data</a>, 0);
<a name="l00093"></a>00093       ts = <a class="code" href="indications_8h.html#a8b52ace68f21c0ac24414f038471647d" title="Release a reference to an ast_tone_zone_sound.">ast_tone_zone_sound_unref</a>(ts);
<a name="l00094"></a>00094    } <span class="keywordflow">else</span> {
<a name="l00095"></a>00095       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Huh....? no dial for indications?\n&quot;</span>);
<a name="l00096"></a>00096    }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098    <span class="keywordflow">for</span> (x = strlen(collect); x &lt; maxlen; ) {
<a name="l00099"></a>00099       res = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, timeout);
<a name="l00100"></a>00100       <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#aa73d176ed4f1ce51e5db6beafba45fe3" title="Checks to see if a number should be ignored.">ast_ignore_pattern</a>(context, collect)) {
<a name="l00101"></a>00101          <a class="code" href="app__rpt_8c.html#a9d5be069b7060d326a213f5d60b8dc77">ast_playtones_stop</a>(chan);
<a name="l00102"></a>00102       }
<a name="l00103"></a>00103       <span class="keywordflow">if</span> (res &lt; 1) {
<a name="l00104"></a>00104          <span class="keywordflow">break</span>;
<a name="l00105"></a>00105       }
<a name="l00106"></a>00106       <span class="keywordflow">if</span> (res == <span class="charliteral">&apos;#&apos;</span>) {
<a name="l00107"></a>00107          <span class="keywordflow">break</span>;
<a name="l00108"></a>00108       }
<a name="l00109"></a>00109       collect[x++] = res;
<a name="l00110"></a>00110       <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#ac359af75b9494f50904583d2168a7577" title="Looks to see if adding anything to this extension might match something. (exists...">ast_matchmore_extension</a>(chan, context, collect, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l00111"></a>00111          <span class="keywordflow">break</span>;
<a name="l00112"></a>00112       }
<a name="l00113"></a>00113    }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115    <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l00116"></a>00116       res = <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, context, collect, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>) ? 1 : 0;
<a name="l00117"></a>00117    }
<a name="l00118"></a>00118 
<a name="l00119"></a>00119    <span class="keywordflow">return</span> res;
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 <span class="comment"></span>
<a name="l00122"></a>00122 <span class="comment">/*!</span>
<a name="l00123"></a>00123 <span class="comment"> * \brief ast_app_getdata</span>
<a name="l00124"></a>00124 <span class="comment"> * \param c The channel to read from</span>
<a name="l00125"></a>00125 <span class="comment"> * \param prompt The file to stream to the channel</span>
<a name="l00126"></a>00126 <span class="comment"> * \param s The string to read in to.  Must be at least the size of your length</span>
<a name="l00127"></a>00127 <span class="comment"> * \param maxlen How many digits to read (maximum)</span>
<a name="l00128"></a>00128 <span class="comment"> * \param timeout set timeout to 0 for &quot;standard&quot; timeouts. Set timeout to -1 for </span>
<a name="l00129"></a>00129 <span class="comment"> *      &quot;ludicrous time&quot; (essentially never times out) */</span>
<a name="l00130"></a><a class="code" href="app_8c.html#a5d7f1014795ff9db542b44fbf4a83ce1">00130</a> <span class="keyword">enum</span> <a class="code" href="app_8h.html#a10624bc470a4ac2634221dfa74bdb17f">ast_getdata_result</a> <a class="code" href="app_8h.html#af3f76858d4dd513e59dbe5e67bc46220" title="Plays a stream and gets DTMF data from a channel.">ast_app_getdata</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a299365a3d8977a6c410c6cd924e33136">prompt</a>, <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> maxlen, <span class="keywordtype">int</span> timeout)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132    <span class="keywordtype">int</span> res = 0, to, fto;
<a name="l00133"></a>00133    <span class="keywordtype">char</span> *front, *filename;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135    <span class="comment">/* XXX Merge with full version? XXX */</span>
<a name="l00136"></a>00136 
<a name="l00137"></a>00137    <span class="keywordflow">if</span> (maxlen)
<a name="l00138"></a>00138       s[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140    <span class="keywordflow">if</span> (!prompt)
<a name="l00141"></a>00141       prompt = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143    filename = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(prompt);
<a name="l00144"></a>00144    <span class="keywordflow">while</span> ((front = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;filename, <span class="stringliteral">&quot;&amp;&quot;</span>))) {
<a name="l00145"></a>00145       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(front)) {
<a name="l00146"></a>00146          res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(c, front, c-&gt;language);
<a name="l00147"></a>00147          <span class="keywordflow">if</span> (res)
<a name="l00148"></a>00148             <span class="keywordflow">continue</span>;
<a name="l00149"></a>00149       }
<a name="l00150"></a>00150       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(filename)) {
<a name="l00151"></a>00151          <span class="comment">/* set timeouts for the last prompt */</span>
<a name="l00152"></a>00152          fto = c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a> ? c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a765bfb11e07b0f90c235c9af9d7f46fa">rtimeoutms</a> : 6000;
<a name="l00153"></a>00153          to = c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a> ? c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a> : 2000;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155          <span class="keywordflow">if</span> (timeout &gt; 0) {
<a name="l00156"></a>00156             fto = to = timeout;
<a name="l00157"></a>00157          }
<a name="l00158"></a>00158          <span class="keywordflow">if</span> (timeout &lt; 0) {
<a name="l00159"></a>00159             fto = to = 1000000000;
<a name="l00160"></a>00160          }
<a name="l00161"></a>00161       } <span class="keywordflow">else</span> {
<a name="l00162"></a>00162          <span class="comment">/* there is more than one prompt, so</span>
<a name="l00163"></a>00163 <span class="comment">          * get rid of the long timeout between</span>
<a name="l00164"></a>00164 <span class="comment">          * prompts, and make it 50ms */</span>
<a name="l00165"></a>00165          fto = 50;
<a name="l00166"></a>00166          to = c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a> ? c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a> : 2000;
<a name="l00167"></a>00167       }
<a name="l00168"></a>00168       res = <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(c, s, maxlen, to, fto, <span class="stringliteral">&quot;#&quot;</span>);
<a name="l00169"></a>00169       <span class="keywordflow">if</span> (res == <a class="code" href="app_8h.html#a10624bc470a4ac2634221dfa74bdb17fa94425459ee6ac7993c6289fde4d4ea8c">AST_GETDATA_EMPTY_END_TERMINATED</a>) {
<a name="l00170"></a>00170          <span class="keywordflow">return</span> res;
<a name="l00171"></a>00171       }
<a name="l00172"></a>00172       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(s)) {
<a name="l00173"></a>00173          <span class="keywordflow">return</span> res;
<a name="l00174"></a>00174       }
<a name="l00175"></a>00175    }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177    <span class="keywordflow">return</span> res;
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="comment">/* The lock type used by ast_lock_path() / ast_unlock_path() */</span>
<a name="l00181"></a><a class="code" href="app_8c.html#a6bcfb001b39f6049c25a2635de1dc17f">00181</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="app_8h.html#a889fad4c6cc627add80454ae61b53241" title="Type of locking to use in ast_lock_path / ast_unlock_path.">AST_LOCK_TYPE</a> <a class="code" href="app_8c.html#a6bcfb001b39f6049c25a2635de1dc17f">ast_lock_type</a> = <a class="code" href="app_8h.html#a889fad4c6cc627add80454ae61b53241a599f18fdf355d7530bb754b8c66d6de7">AST_LOCK_TYPE_LOCKFILE</a>;
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="app_8c.html#a9fc880ff0cd0b42ef6212b43deb4b98f">00183</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a9fc880ff0cd0b42ef6212b43deb4b98f" title="Full version with audiofd and controlfd. NOTE: returns &amp;#39;2&amp;#39; on ctrlfd available...">ast_app_getdata_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a299365a3d8977a6c410c6cd924e33136">prompt</a>, <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> maxlen, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> audiofd, <span class="keywordtype">int</span> ctrlfd)
<a name="l00184"></a>00184 {
<a name="l00185"></a>00185    <span class="keywordtype">int</span> res, to = 2000, fto = 6000;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(prompt)) {
<a name="l00188"></a>00188       res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(c, prompt, c-&gt;language);
<a name="l00189"></a>00189       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00190"></a>00190          <span class="keywordflow">return</span> res;
<a name="l00191"></a>00191       }
<a name="l00192"></a>00192    }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194    <span class="keywordflow">if</span> (timeout &gt; 0) {
<a name="l00195"></a>00195       fto = to = timeout;
<a name="l00196"></a>00196    }
<a name="l00197"></a>00197    <span class="keywordflow">if</span> (timeout &lt; 0) {
<a name="l00198"></a>00198       fto = to = 1000000000;
<a name="l00199"></a>00199    }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201    res = <a class="code" href="channel_8h.html#a1d7f4bf19db3f1b8a3524593f002fedf">ast_readstring_full</a>(c, s, maxlen, to, fto, <span class="stringliteral">&quot;#&quot;</span>, audiofd, ctrlfd);
<a name="l00202"></a>00202 
<a name="l00203"></a>00203    <span class="keywordflow">return</span> res;
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 <span class="keyword">static</span> int (*<a class="code" href="app_8c.html#a5fe433cbd1421c19f6bd997fb74778d8">ast_has_voicemail_func</a>)(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder) = NULL;
<a name="l00207"></a>00207 <span class="keyword">static</span> int (*<a class="code" href="app_8c.html#a2923cea3347f03b8a7cb4779b1962fd2">ast_inboxcount_func</a>)(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs) = NULL;
<a name="l00208"></a>00208 <span class="keyword">static</span> int (*<a class="code" href="app_8c.html#a8951323b5b85c9a255e97c181286056c">ast_inboxcount2_func</a>)(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> *urgentmsgs, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs) = NULL;
<a name="l00209"></a>00209 <span class="keyword">static</span> int (*<a class="code" href="app_8c.html#a826d29acb5b5a2bcf5a03b04bf841559">ast_sayname_func</a>)(<span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>) = NULL;
<a name="l00210"></a>00210 <span class="keyword">static</span> int (*<a class="code" href="app_8c.html#afed3b3e5f05182892712ca3064c9b7ed">ast_messagecount_func</a>)(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder) = NULL;
<a name="l00211"></a>00211 
<a name="l00212"></a><a class="code" href="app_8c.html#a27992e5c39b818ff6b190f726a80cb50">00212</a> <span class="keywordtype">void</span> <a class="code" href="app_8h.html#a27992e5c39b818ff6b190f726a80cb50" title="Set voicemail function callbacks.">ast_install_vm_functions</a>(<span class="keywordtype">int</span> (*has_voicemail_func)(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder),
<a name="l00213"></a>00213                <span class="keywordtype">int</span> (*inboxcount_func)(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs),
<a name="l00214"></a>00214                <span class="keywordtype">int</span> (*inboxcount2_func)(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> *urgentmsgs, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs),
<a name="l00215"></a>00215                <span class="keywordtype">int</span> (*messagecount_func)(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder),
<a name="l00216"></a>00216                <span class="keywordtype">int</span> (*sayname_func)(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *context))
<a name="l00217"></a>00217 {
<a name="l00218"></a>00218    <a class="code" href="app_8c.html#a5fe433cbd1421c19f6bd997fb74778d8">ast_has_voicemail_func</a> = has_voicemail_func;
<a name="l00219"></a>00219    <a class="code" href="app_8c.html#a2923cea3347f03b8a7cb4779b1962fd2">ast_inboxcount_func</a> = inboxcount_func;
<a name="l00220"></a>00220    <a class="code" href="app_8c.html#a8951323b5b85c9a255e97c181286056c">ast_inboxcount2_func</a> = inboxcount2_func;
<a name="l00221"></a>00221    <a class="code" href="app_8c.html#afed3b3e5f05182892712ca3064c9b7ed">ast_messagecount_func</a> = messagecount_func;
<a name="l00222"></a>00222    <a class="code" href="app_8c.html#a826d29acb5b5a2bcf5a03b04bf841559">ast_sayname_func</a> = sayname_func;
<a name="l00223"></a>00223 }
<a name="l00224"></a>00224 
<a name="l00225"></a><a class="code" href="app_8c.html#a65d1324f7632267a35a6d933fdbdc6f9">00225</a> <span class="keywordtype">void</span> <a class="code" href="app_8h.html#a65d1324f7632267a35a6d933fdbdc6f9">ast_uninstall_vm_functions</a>(<span class="keywordtype">void</span>)
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227    <a class="code" href="app_8c.html#a5fe433cbd1421c19f6bd997fb74778d8">ast_has_voicemail_func</a> = NULL;
<a name="l00228"></a>00228    <a class="code" href="app_8c.html#a2923cea3347f03b8a7cb4779b1962fd2">ast_inboxcount_func</a> = NULL;
<a name="l00229"></a>00229    <a class="code" href="app_8c.html#a8951323b5b85c9a255e97c181286056c">ast_inboxcount2_func</a> = NULL;
<a name="l00230"></a>00230    <a class="code" href="app_8c.html#afed3b3e5f05182892712ca3064c9b7ed">ast_messagecount_func</a> = NULL;
<a name="l00231"></a>00231    <a class="code" href="app_8c.html#a826d29acb5b5a2bcf5a03b04bf841559">ast_sayname_func</a> = NULL;
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00234"></a><a class="code" href="app_8c.html#ae5953304e56862ac7efc1fed0ac6732f">00234</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#ae5953304e56862ac7efc1fed0ac6732f" title="Determine if a given mailbox has any voicemail If folder is NULL, defaults to &amp;quot;INBOX&amp;quot;...">ast_app_has_voicemail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)
<a name="l00235"></a>00235 {
<a name="l00236"></a>00236    <span class="keyword">static</span> <span class="keywordtype">int</span> warned = 0;
<a name="l00237"></a>00237    <span class="keywordflow">if</span> (<a class="code" href="app_8c.html#a5fe433cbd1421c19f6bd997fb74778d8">ast_has_voicemail_func</a>) {
<a name="l00238"></a>00238       <span class="keywordflow">return</span> <a class="code" href="app_8c.html#a5fe433cbd1421c19f6bd997fb74778d8">ast_has_voicemail_func</a>(mailbox, folder);
<a name="l00239"></a>00239    }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241    <span class="keywordflow">if</span> (warned++ % 10 == 0) {
<a name="l00242"></a>00242       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Message check requested for mailbox %s/folder %s but voicemail not loaded.\n&quot;</span>, mailbox, folder ? folder : <span class="stringliteral">&quot;INBOX&quot;</span>);
<a name="l00243"></a>00243    }
<a name="l00244"></a>00244    <span class="keywordflow">return</span> 0;
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 
<a name="l00248"></a><a class="code" href="app_8c.html#a318582ad072d31085d4623e634edf46c">00248</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a318582ad072d31085d4623e634edf46c" title="Determine number of new/old messages in a mailbox.">ast_app_inboxcount</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs)
<a name="l00249"></a>00249 {
<a name="l00250"></a>00250    <span class="keyword">static</span> <span class="keywordtype">int</span> warned = 0;
<a name="l00251"></a>00251    <span class="keywordflow">if</span> (newmsgs) {
<a name="l00252"></a>00252       *newmsgs = 0;
<a name="l00253"></a>00253    }
<a name="l00254"></a>00254    <span class="keywordflow">if</span> (oldmsgs) {
<a name="l00255"></a>00255       *oldmsgs = 0;
<a name="l00256"></a>00256    }
<a name="l00257"></a>00257    <span class="keywordflow">if</span> (<a class="code" href="app_8c.html#a2923cea3347f03b8a7cb4779b1962fd2">ast_inboxcount_func</a>) {
<a name="l00258"></a>00258       <span class="keywordflow">return</span> <a class="code" href="app_8c.html#a2923cea3347f03b8a7cb4779b1962fd2">ast_inboxcount_func</a>(mailbox, newmsgs, oldmsgs);
<a name="l00259"></a>00259    }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261    <span class="keywordflow">if</span> (warned++ % 10 == 0) {
<a name="l00262"></a>00262       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Message count requested for mailbox %s but voicemail not loaded.\n&quot;</span>, mailbox);
<a name="l00263"></a>00263    }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265    <span class="keywordflow">return</span> 0;
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 
<a name="l00268"></a><a class="code" href="app_8c.html#a6f9a8f7a54dd80f1b5363b6cadfd4939">00268</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a6f9a8f7a54dd80f1b5363b6cadfd4939" title="Determine number of urgent/new/old messages in a mailbox.">ast_app_inboxcount2</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> *urgentmsgs, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs)
<a name="l00269"></a>00269 {
<a name="l00270"></a>00270    <span class="keyword">static</span> <span class="keywordtype">int</span> warned = 0;
<a name="l00271"></a>00271    <span class="keywordflow">if</span> (newmsgs) {
<a name="l00272"></a>00272       *newmsgs = 0;
<a name="l00273"></a>00273    }
<a name="l00274"></a>00274    <span class="keywordflow">if</span> (oldmsgs) {
<a name="l00275"></a>00275       *oldmsgs = 0;
<a name="l00276"></a>00276    }
<a name="l00277"></a>00277    <span class="keywordflow">if</span> (urgentmsgs) {
<a name="l00278"></a>00278       *urgentmsgs = 0;
<a name="l00279"></a>00279    }
<a name="l00280"></a>00280    <span class="keywordflow">if</span> (<a class="code" href="app_8c.html#a2923cea3347f03b8a7cb4779b1962fd2">ast_inboxcount_func</a>) {
<a name="l00281"></a>00281       <span class="keywordflow">return</span> <a class="code" href="app_8c.html#a8951323b5b85c9a255e97c181286056c">ast_inboxcount2_func</a>(mailbox, urgentmsgs, newmsgs, oldmsgs);
<a name="l00282"></a>00282    }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284    <span class="keywordflow">if</span> (warned++ % 10 == 0) {
<a name="l00285"></a>00285       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Message count requested for mailbox %s but voicemail not loaded.\n&quot;</span>, mailbox);
<a name="l00286"></a>00286    }
<a name="l00287"></a>00287 
<a name="l00288"></a>00288    <span class="keywordflow">return</span> 0;
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a><a class="code" href="app_8c.html#a3c444cef1f29205f033db05bfeee8298">00291</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a3c444cef1f29205f033db05bfeee8298" title="Given a mailbox and context, play that mailbox owner&amp;#39;s name to the channel specified...">ast_app_sayname</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *context)
<a name="l00292"></a>00292 {
<a name="l00293"></a>00293    <span class="keywordflow">if</span> (<a class="code" href="app_8c.html#a826d29acb5b5a2bcf5a03b04bf841559">ast_sayname_func</a>) {
<a name="l00294"></a>00294       <span class="keywordflow">return</span> <a class="code" href="app_8c.html#a826d29acb5b5a2bcf5a03b04bf841559">ast_sayname_func</a>(chan, mailbox, context);
<a name="l00295"></a>00295    }
<a name="l00296"></a>00296    <span class="keywordflow">return</span> -1;
<a name="l00297"></a>00297 }
<a name="l00298"></a>00298 
<a name="l00299"></a><a class="code" href="app_8c.html#aa34e72e01cab2e09f4a195eb79175f95">00299</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#aa34e72e01cab2e09f4a195eb79175f95" title="Check number of messages in a given context, mailbox, and folder.">ast_app_messagecount</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)
<a name="l00300"></a>00300 {
<a name="l00301"></a>00301    <span class="keyword">static</span> <span class="keywordtype">int</span> warned = 0;
<a name="l00302"></a>00302    <span class="keywordflow">if</span> (<a class="code" href="app_8c.html#afed3b3e5f05182892712ca3064c9b7ed">ast_messagecount_func</a>) {
<a name="l00303"></a>00303       <span class="keywordflow">return</span> <a class="code" href="app_8c.html#afed3b3e5f05182892712ca3064c9b7ed">ast_messagecount_func</a>(context, mailbox, folder);
<a name="l00304"></a>00304    }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306    <span class="keywordflow">if</span> (!warned) {
<a name="l00307"></a>00307       warned++;
<a name="l00308"></a>00308       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Message count requested for mailbox %s@%s/%s but voicemail not loaded.\n&quot;</span>, mailbox, context, folder);
<a name="l00309"></a>00309    }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311    <span class="keywordflow">return</span> 0;
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00314"></a><a class="code" href="app_8c.html#af20b8ac2e28e659be352bbaecdf0ab03">00314</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#af20b8ac2e28e659be352bbaecdf0ab03" title="Send DTMF to a channel.">ast_dtmf_stream</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *peer, <span class="keyword">const</span> <span class="keywordtype">char</span> *digits, <span class="keywordtype">int</span> between, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration) 
<a name="l00315"></a>00315 {
<a name="l00316"></a>00316    <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;
<a name="l00317"></a>00317    <span class="keywordtype">int</span> res = 0;
<a name="l00318"></a>00318    <span class="keyword">struct </span><a class="code" href="structast__silence__generator.html">ast_silence_generator</a> *silgen = NULL;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320    <span class="keywordflow">if</span> (!between) {
<a name="l00321"></a>00321       between = 100;
<a name="l00322"></a>00322    }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324    <span class="keywordflow">if</span> (peer) {
<a name="l00325"></a>00325       res = <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(peer);
<a name="l00326"></a>00326    }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328    <span class="keywordflow">if</span> (!res) {
<a name="l00329"></a>00329       res = <a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, 100);
<a name="l00330"></a>00330    }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332    <span class="comment">/* ast_waitfor will return the number of remaining ms on success */</span>
<a name="l00333"></a>00333    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00334"></a>00334       <span class="keywordflow">if</span> (peer) {
<a name="l00335"></a>00335          <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(peer);
<a name="l00336"></a>00336       }
<a name="l00337"></a>00337       <span class="keywordflow">return</span> res;
<a name="l00338"></a>00338    }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#afe8795c4ec744506a9300700fc0813dc">ast_opt_transmit_silence</a>) {
<a name="l00341"></a>00341       silgen = <a class="code" href="channel_8h.html#a2a2e0ff24c57491a877cac39cb670024" title="Starts a silence generator on the given channel.">ast_channel_start_silence_generator</a>(chan);
<a name="l00342"></a>00342    }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344    <span class="keywordflow">for</span> (ptr = digits; *ptr; ptr++) {
<a name="l00345"></a>00345       <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&apos;w&apos;</span>) {
<a name="l00346"></a>00346          <span class="comment">/* &apos;w&apos; -- wait half a second */</span>
<a name="l00347"></a>00347          <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(chan, 500))) {
<a name="l00348"></a>00348             <span class="keywordflow">break</span>;
<a name="l00349"></a>00349          }
<a name="l00350"></a>00350       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;0123456789*#abcdfABCDF&quot;</span>, *ptr)) {
<a name="l00351"></a>00351          <span class="comment">/* Character represents valid DTMF */</span>
<a name="l00352"></a>00352          <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&apos;f&apos;</span> || *ptr == <span class="charliteral">&apos;F&apos;</span>) {
<a name="l00353"></a>00353             <span class="comment">/* ignore return values if not supported by channel */</span>
<a name="l00354"></a>00354             <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ae8f2cd460fdc81e0a774434fa002e4bf">AST_CONTROL_FLASH</a>);
<a name="l00355"></a>00355          } <span class="keywordflow">else</span> {
<a name="l00356"></a>00356             <a class="code" href="channel_8h.html#a48a8b376caf908979e96af8641591c92" title="Send a DTMF digit to a channel Send a DTMF digit to a channel.">ast_senddigit</a>(chan, *ptr, duration);
<a name="l00357"></a>00357          }
<a name="l00358"></a>00358          <span class="comment">/* pause between digits */</span>
<a name="l00359"></a>00359          <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(chan, between))) {
<a name="l00360"></a>00360             <span class="keywordflow">break</span>;
<a name="l00361"></a>00361          }
<a name="l00362"></a>00362       } <span class="keywordflow">else</span> {
<a name="l00363"></a>00363          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Illegal DTMF character &apos;%c&apos; in string. (0-9*#aAbBcCdD allowed)\n&quot;</span>, *ptr);
<a name="l00364"></a>00364       }
<a name="l00365"></a>00365    }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367    <span class="keywordflow">if</span> (peer) {
<a name="l00368"></a>00368       <span class="comment">/* Stop autoservice on the peer channel, but don&apos;t overwrite any error condition</span>
<a name="l00369"></a>00369 <span class="comment">         that has occurred previously while acting on the primary channel */</span>
<a name="l00370"></a>00370       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(peer) &amp;&amp; !res) {
<a name="l00371"></a>00371          res = -1;
<a name="l00372"></a>00372       }
<a name="l00373"></a>00373    }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375    <span class="keywordflow">if</span> (silgen) {
<a name="l00376"></a>00376       <a class="code" href="channel_8h.html#a6643cbe766a051d2d06750ab5b3e933d" title="Stops a previously-started silence generator on the given channel.">ast_channel_stop_silence_generator</a>(chan, silgen);
<a name="l00377"></a>00377    }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379    <span class="keywordflow">return</span> res;
<a name="l00380"></a>00380 }
<a name="l00381"></a>00381 
<a name="l00382"></a><a class="code" href="structlinear__state.html">00382</a> <span class="keyword">struct </span><a class="code" href="structlinear__state.html">linear_state</a> {
<a name="l00383"></a><a class="code" href="structlinear__state.html#a6f8059414f0228f0256115e024eeed4b">00383</a>    <span class="keywordtype">int</span> <a class="code" href="structlinear__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;
<a name="l00384"></a><a class="code" href="structlinear__state.html#a766c6d52861f6f0ddb14b6d579ecb331">00384</a>    <span class="keywordtype">int</span> <a class="code" href="structlinear__state.html#a766c6d52861f6f0ddb14b6d579ecb331">autoclose</a>;
<a name="l00385"></a><a class="code" href="structlinear__state.html#ab6d0ae4f4fba3a46c253a118a8d1bf72">00385</a>    <span class="keywordtype">int</span> <a class="code" href="structlinear__state.html#ab6d0ae4f4fba3a46c253a118a8d1bf72">allowoverride</a>;
<a name="l00386"></a><a class="code" href="structlinear__state.html#a5ef8e42d1eab1890f7eeb29e4af357eb">00386</a>    <span class="keywordtype">int</span> <a class="code" href="structlinear__state.html#a5ef8e42d1eab1890f7eeb29e4af357eb">origwfmt</a>;
<a name="l00387"></a>00387 };
<a name="l00388"></a>00388 
<a name="l00389"></a><a class="code" href="app_8c.html#afc3d301641817be1e994258ceb1960c4">00389</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app_8c.html#afc3d301641817be1e994258ceb1960c4">linear_release</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *params)
<a name="l00390"></a>00390 {
<a name="l00391"></a>00391    <span class="keyword">struct </span><a class="code" href="structlinear__state.html">linear_state</a> *ls = params;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393    <span class="keywordflow">if</span> (ls-&gt;<a class="code" href="structlinear__state.html#a5ef8e42d1eab1890f7eeb29e4af357eb">origwfmt</a> &amp;&amp; <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, ls-&gt;<a class="code" href="structlinear__state.html#a5ef8e42d1eab1890f7eeb29e4af357eb">origwfmt</a>)) {
<a name="l00394"></a>00394       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to restore channel &apos;%s&apos; to format &apos;%d&apos;\n&quot;</span>, chan-&gt;name, ls-&gt;<a class="code" href="structlinear__state.html#a5ef8e42d1eab1890f7eeb29e4af357eb">origwfmt</a>);
<a name="l00395"></a>00395    }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397    <span class="keywordflow">if</span> (ls-&gt;<a class="code" href="structlinear__state.html#a766c6d52861f6f0ddb14b6d579ecb331">autoclose</a>) {
<a name="l00398"></a>00398       close(ls-&gt;<a class="code" href="structlinear__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>);
<a name="l00399"></a>00399    }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l00402"></a>00402 }
<a name="l00403"></a>00403 
<a name="l00404"></a><a class="code" href="app_8c.html#a3c664af67de1b256b0fa742ec5b8fff2">00404</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app_8c.html#a3c664af67de1b256b0fa742ec5b8fff2">linear_generator</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keywordtype">int</span> samples)
<a name="l00405"></a>00405 {
<a name="l00406"></a>00406    <span class="keywordtype">short</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[2048 + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a> / 2];
<a name="l00407"></a>00407    <span class="keyword">struct </span><a class="code" href="structlinear__state.html">linear_state</a> *ls = data;
<a name="l00408"></a>00408    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = {
<a name="l00409"></a>00409       .<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>,
<a name="l00410"></a>00410       .subclass = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>,
<a name="l00411"></a>00411       .data.ptr = buf + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a> / 2,
<a name="l00412"></a>00412       .offset = <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>,
<a name="l00413"></a>00413    };
<a name="l00414"></a>00414    <span class="keywordtype">int</span> res;
<a name="l00415"></a>00415 
<a name="l00416"></a>00416    len = samples * 2;
<a name="l00417"></a>00417    <span class="keywordflow">if</span> (len &gt; <span class="keyword">sizeof</span>(buf) - <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>) {
<a name="l00418"></a>00418       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t generate %d bytes of data!\n&quot;</span> , len);
<a name="l00419"></a>00419       len = <span class="keyword">sizeof</span>(buf) - <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>;
<a name="l00420"></a>00420    }
<a name="l00421"></a>00421    res = read(ls-&gt;<a class="code" href="structlinear__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, buf + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>/2, len);
<a name="l00422"></a>00422    <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l00423"></a>00423       f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = res;
<a name="l00424"></a>00424       f.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = res / 2;
<a name="l00425"></a>00425       <a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(chan, &amp;f);
<a name="l00426"></a>00426       <span class="keywordflow">if</span> (res == len) {
<a name="l00427"></a>00427          <span class="keywordflow">return</span> 0;
<a name="l00428"></a>00428       }
<a name="l00429"></a>00429    }
<a name="l00430"></a>00430    <span class="keywordflow">return</span> -1;
<a name="l00431"></a>00431 }
<a name="l00432"></a>00432 
<a name="l00433"></a><a class="code" href="app_8c.html#a9917c0ec59881e0ae404e044bf8628cb">00433</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="app_8c.html#a9917c0ec59881e0ae404e044bf8628cb">linear_alloc</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *params)
<a name="l00434"></a>00434 {
<a name="l00435"></a>00435    <span class="keyword">struct </span><a class="code" href="structlinear__state.html">linear_state</a> *ls = params;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437    <span class="keywordflow">if</span> (!params) {
<a name="l00438"></a>00438       <span class="keywordflow">return</span> NULL;
<a name="l00439"></a>00439    }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441    <span class="comment">/* In this case, params is already malloc&apos;d */</span>
<a name="l00442"></a>00442    <span class="keywordflow">if</span> (ls-&gt;<a class="code" href="structlinear__state.html#ab6d0ae4f4fba3a46c253a118a8d1bf72">allowoverride</a>) {
<a name="l00443"></a>00443       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a9deec175d13a40a6a5fdb527b13c6878">AST_FLAG_WRITE_INT</a>);
<a name="l00444"></a>00444    } <span class="keywordflow">else</span> {
<a name="l00445"></a>00445       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a9deec175d13a40a6a5fdb527b13c6878">AST_FLAG_WRITE_INT</a>);
<a name="l00446"></a>00446    }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448    ls-&gt;<a class="code" href="structlinear__state.html#a5ef8e42d1eab1890f7eeb29e4af357eb">origwfmt</a> = chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>)) {
<a name="l00451"></a>00451       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set &apos;%s&apos; to linear format (write)\n&quot;</span>, chan-&gt;name);
<a name="l00452"></a>00452       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ls);
<a name="l00453"></a>00453       ls = params = NULL;
<a name="l00454"></a>00454    }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456    <span class="keywordflow">return</span> params;
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00459"></a><a class="code" href="app_8c.html#a50b7bd92df6d7d96811b86030c0265b1">00459</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__generator.html">ast_generator</a> <a class="code" href="app_8c.html#a50b7bd92df6d7d96811b86030c0265b1">linearstream</a> =
<a name="l00460"></a>00460 {
<a name="l00461"></a>00461    <a class="code" href="structast__generator.html#a4cdb1ccb0ee9d0a97af1862c625e6bc8">alloc</a>: <a class="code" href="app_8c.html#a9917c0ec59881e0ae404e044bf8628cb">linear_alloc</a>,
<a name="l00462"></a>00462    <a class="code" href="structast__generator.html#af1e67c15ec62c02506efc4f2f305bbe0">release</a>: <a class="code" href="app_8c.html#afc3d301641817be1e994258ceb1960c4">linear_release</a>,
<a name="l00463"></a>00463    <a class="code" href="structast__generator.html#a92f5f90f97b5e9124c843b5e81d8b53a">generate</a>: <a class="code" href="app_8c.html#a3c664af67de1b256b0fa742ec5b8fff2">linear_generator</a>,
<a name="l00464"></a>00464 };
<a name="l00465"></a>00465 
<a name="l00466"></a><a class="code" href="app_8c.html#a2566e275a6e912943c68cbfc867cc60a">00466</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a2566e275a6e912943c68cbfc867cc60a" title="Stream a filename (or file descriptor) as a generator.">ast_linear_stream</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> allowoverride)
<a name="l00467"></a>00467 {
<a name="l00468"></a>00468    <span class="keyword">struct </span><a class="code" href="structlinear__state.html">linear_state</a> *lin;
<a name="l00469"></a>00469    <span class="keywordtype">char</span> tmpf[256];
<a name="l00470"></a>00470    <span class="keywordtype">int</span> res = -1;
<a name="l00471"></a>00471    <span class="keywordtype">int</span> <a class="code" href="structlinear__state.html#a766c6d52861f6f0ddb14b6d579ecb331">autoclose</a> = 0;
<a name="l00472"></a>00472    <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l00473"></a>00473       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(filename)) {
<a name="l00474"></a>00474          <span class="keywordflow">return</span> -1;
<a name="l00475"></a>00475       }
<a name="l00476"></a>00476       autoclose = 1;
<a name="l00477"></a>00477       <span class="keywordflow">if</span> (filename[0] == <span class="charliteral">&apos;/&apos;</span>) {
<a name="l00478"></a>00478          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmpf, filename, <span class="keyword">sizeof</span>(tmpf));
<a name="l00479"></a>00479       } <span class="keywordflow">else</span> {
<a name="l00480"></a>00480          snprintf(tmpf, <span class="keyword">sizeof</span>(tmpf), <span class="stringliteral">&quot;%s/%s/%s&quot;</span>, <a class="code" href="paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a>, <span class="stringliteral">&quot;sounds&quot;</span>, filename);
<a name="l00481"></a>00481       }
<a name="l00482"></a>00482       <span class="keywordflow">if</span> ((fd = open(tmpf, O_RDONLY)) &lt; 0) {
<a name="l00483"></a>00483          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open file &apos;%s&apos;: %s\n&quot;</span>, tmpf, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00484"></a>00484          <span class="keywordflow">return</span> -1;
<a name="l00485"></a>00485       }
<a name="l00486"></a>00486    }
<a name="l00487"></a>00487    <span class="keywordflow">if</span> ((lin = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*lin)))) {
<a name="l00488"></a>00488       lin-&gt;<a class="code" href="structlinear__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = fd;
<a name="l00489"></a>00489       lin-&gt;<a class="code" href="structlinear__state.html#ab6d0ae4f4fba3a46c253a118a8d1bf72">allowoverride</a> = allowoverride;
<a name="l00490"></a>00490       lin-&gt;<a class="code" href="structlinear__state.html#a766c6d52861f6f0ddb14b6d579ecb331">autoclose</a> = autoclose;
<a name="l00491"></a>00491       res = <a class="code" href="channel_8h.html#a12a58dda74a19f383f6b77cf7fa88b54">ast_activate_generator</a>(chan, &amp;linearstream, lin);
<a name="l00492"></a>00492    }
<a name="l00493"></a>00493    <span class="keywordflow">return</span> res;
<a name="l00494"></a>00494 }
<a name="l00495"></a>00495 
<a name="l00496"></a><a class="code" href="app_8c.html#a47eb74d2a849cccfb2e159714295ac56">00496</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a3405b1282cefdceebba734b8e756c55d" title="Stream a file with fast forward, pause, reverse, restart.">ast_control_streamfile</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *file,
<a name="l00497"></a>00497             <span class="keyword">const</span> <span class="keywordtype">char</span> *fwd, <span class="keyword">const</span> <span class="keywordtype">char</span> *rev,
<a name="l00498"></a>00498             <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="res__ais_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *suspend,
<a name="l00499"></a>00499             <span class="keyword">const</span> <span class="keywordtype">char</span> *restart, <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">skipms</a>, <span class="keywordtype">long</span> *offsetms)
<a name="l00500"></a>00500 {
<a name="l00501"></a>00501    <span class="keywordtype">char</span> *breaks = NULL;
<a name="l00502"></a>00502    <span class="keywordtype">char</span> *end = NULL;
<a name="l00503"></a>00503    <span class="keywordtype">int</span> blen = 2;
<a name="l00504"></a>00504    <span class="keywordtype">int</span> res;
<a name="l00505"></a>00505    <span class="keywordtype">long</span> pause_restart_point = 0;
<a name="l00506"></a>00506    <span class="keywordtype">long</span> offset = 0;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508    <span class="keywordflow">if</span> (offsetms) {
<a name="l00509"></a>00509       offset = *offsetms * 8; <span class="comment">/* XXX Assumes 8kHz */</span>
<a name="l00510"></a>00510    }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512    <span class="keywordflow">if</span> (stop) {
<a name="l00513"></a>00513       blen += strlen(stop);
<a name="l00514"></a>00514    }
<a name="l00515"></a>00515    <span class="keywordflow">if</span> (suspend) {
<a name="l00516"></a>00516       blen += strlen(suspend);
<a name="l00517"></a>00517    }
<a name="l00518"></a>00518    <span class="keywordflow">if</span> (restart) {
<a name="l00519"></a>00519       blen += strlen(restart);
<a name="l00520"></a>00520    }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522    <span class="keywordflow">if</span> (blen &gt; 2) {
<a name="l00523"></a>00523       breaks = alloca(blen + 1);
<a name="l00524"></a>00524       breaks[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00525"></a>00525       <span class="keywordflow">if</span> (stop) {
<a name="l00526"></a>00526          strcat(breaks, stop);
<a name="l00527"></a>00527       }
<a name="l00528"></a>00528       <span class="keywordflow">if</span> (suspend) {
<a name="l00529"></a>00529          strcat(breaks, suspend);
<a name="l00530"></a>00530       }
<a name="l00531"></a>00531       <span class="keywordflow">if</span> (restart) {
<a name="l00532"></a>00532          strcat(breaks, restart);
<a name="l00533"></a>00533       }
<a name="l00534"></a>00534    }
<a name="l00535"></a>00535    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l00536"></a>00536       res = <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l00537"></a>00537    }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539    <span class="keywordflow">if</span> (file) {
<a name="l00540"></a>00540       <span class="keywordflow">if</span> ((end = strchr(file, <span class="charliteral">&apos;:&apos;</span>))) {
<a name="l00541"></a>00541          <span class="keywordflow">if</span> (!strcasecmp(end, <span class="stringliteral">&quot;:end&quot;</span>)) {
<a name="l00542"></a>00542             *end = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00543"></a>00543             end++;
<a name="l00544"></a>00544          }
<a name="l00545"></a>00545       }
<a name="l00546"></a>00546    }
<a name="l00547"></a>00547 
<a name="l00548"></a>00548    <span class="keywordflow">for</span> (;;) {
<a name="l00549"></a>00549       <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l00550"></a>00550       res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, file, chan-&gt;language);
<a name="l00551"></a>00551       <span class="keywordflow">if</span> (!res) {
<a name="l00552"></a>00552          <span class="keywordflow">if</span> (pause_restart_point) {
<a name="l00553"></a>00553             <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>, pause_restart_point, SEEK_SET);
<a name="l00554"></a>00554             pause_restart_point = 0;
<a name="l00555"></a>00555          }
<a name="l00556"></a>00556          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (end || offset &lt; 0) {
<a name="l00557"></a>00557             <span class="keywordflow">if</span> (offset == -8) {
<a name="l00558"></a>00558                offset = 0;
<a name="l00559"></a>00559             }
<a name="l00560"></a>00560             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;ControlPlayback seek to offset %ld from end\n&quot;</span>, offset);
<a name="l00561"></a>00561 
<a name="l00562"></a>00562             <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>, offset, SEEK_END);
<a name="l00563"></a>00563             end = NULL;
<a name="l00564"></a>00564             offset = 0;
<a name="l00565"></a>00565          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (offset) {
<a name="l00566"></a>00566             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;ControlPlayback seek to offset %ld\n&quot;</span>, offset);
<a name="l00567"></a>00567             <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>, offset, SEEK_SET);
<a name="l00568"></a>00568             offset = 0;
<a name="l00569"></a>00569          }
<a name="l00570"></a>00570          res = <a class="code" href="file_8h.html#a5ce837632e3746a3af17f8311060e510" title="Same as waitstream but allows stream to be forwarded or rewound.">ast_waitstream_fr</a>(chan, breaks, fwd, rev, skipms);
<a name="l00571"></a>00571       }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573       <span class="keywordflow">if</span> (res &lt; 1) {
<a name="l00574"></a>00574          <span class="keywordflow">break</span>;
<a name="l00575"></a>00575       }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577       <span class="comment">/* We go at next loop if we got the restart char */</span>
<a name="l00578"></a>00578       <span class="keywordflow">if</span> (restart &amp;&amp; strchr(restart, res)) {
<a name="l00579"></a>00579          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;we&apos;ll restart the stream here at next loop\n&quot;</span>);
<a name="l00580"></a>00580          pause_restart_point = 0;
<a name="l00581"></a>00581          <span class="keywordflow">continue</span>;
<a name="l00582"></a>00582       }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584       <span class="keywordflow">if</span> (suspend &amp;&amp; strchr(suspend, res)) {
<a name="l00585"></a>00585          pause_restart_point = <a class="code" href="file_8h.html#a01771a318e7adea51499040f27b4278a" title="Tell where we are in a stream.">ast_tellstream</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>);
<a name="l00586"></a>00586          <span class="keywordflow">for</span> (;;) {
<a name="l00587"></a>00587             <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l00588"></a>00588             <span class="keywordflow">if</span> (!(res = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 1000))) {
<a name="l00589"></a>00589                <span class="keywordflow">continue</span>;
<a name="l00590"></a>00590             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == -1 || strchr(suspend, res) || (stop &amp;&amp; strchr(stop, res))) {
<a name="l00591"></a>00591                <span class="keywordflow">break</span>;
<a name="l00592"></a>00592             }
<a name="l00593"></a>00593          }
<a name="l00594"></a>00594          <span class="keywordflow">if</span> (res == *suspend) {
<a name="l00595"></a>00595             res = 0;
<a name="l00596"></a>00596             <span class="keywordflow">continue</span>;
<a name="l00597"></a>00597          }
<a name="l00598"></a>00598       }
<a name="l00599"></a>00599 
<a name="l00600"></a>00600       <span class="keywordflow">if</span> (res == -1) {
<a name="l00601"></a>00601          <span class="keywordflow">break</span>;
<a name="l00602"></a>00602       }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604       <span class="comment">/* if we get one of our stop chars, return it to the calling function */</span>
<a name="l00605"></a>00605       <span class="keywordflow">if</span> (stop &amp;&amp; strchr(stop, res)) {
<a name="l00606"></a>00606          <span class="keywordflow">break</span>;
<a name="l00607"></a>00607       }
<a name="l00608"></a>00608    }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610    <span class="keywordflow">if</span> (pause_restart_point) {
<a name="l00611"></a>00611       offset = pause_restart_point;
<a name="l00612"></a>00612    } <span class="keywordflow">else</span> {
<a name="l00613"></a>00613       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>) {
<a name="l00614"></a>00614          offset = <a class="code" href="file_8h.html#a01771a318e7adea51499040f27b4278a" title="Tell where we are in a stream.">ast_tellstream</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>);
<a name="l00615"></a>00615       } <span class="keywordflow">else</span> {
<a name="l00616"></a>00616          offset = -8;  <span class="comment">/* indicate end of file */</span>
<a name="l00617"></a>00617       }
<a name="l00618"></a>00618    }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620    <span class="keywordflow">if</span> (offsetms) {
<a name="l00621"></a>00621       *offsetms = offset / 8; <span class="comment">/* samples --&gt; ms ... XXX Assumes 8 kHz */</span>
<a name="l00622"></a>00622    }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624    <span class="comment">/* If we are returning a digit cast it as char */</span>
<a name="l00625"></a>00625    <span class="keywordflow">if</span> (res &gt; 0 || chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>) {
<a name="l00626"></a>00626       res = (char)res;
<a name="l00627"></a>00627    }
<a name="l00628"></a>00628 
<a name="l00629"></a>00629    <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l00630"></a>00630 
<a name="l00631"></a>00631    <span class="keywordflow">return</span> res;
<a name="l00632"></a>00632 }
<a name="l00633"></a>00633 
<a name="l00634"></a><a class="code" href="app_8c.html#abbbec6ab9a303e865a1d1a261152540d">00634</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *fn)
<a name="l00635"></a>00635 {
<a name="l00636"></a>00636    <span class="keywordtype">int</span> d = 0;
<a name="l00637"></a>00637 
<a name="l00638"></a>00638    <span class="keywordflow">if</span> ((d = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, fn, chan-&gt;language))) {
<a name="l00639"></a>00639       <span class="keywordflow">return</span> d;
<a name="l00640"></a>00640    }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642    d = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l00643"></a>00643 
<a name="l00644"></a>00644    <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l00645"></a>00645 
<a name="l00646"></a>00646    <span class="keywordflow">return</span> d;
<a name="l00647"></a>00647 }
<a name="l00648"></a>00648 
<a name="l00649"></a><a class="code" href="app_8c.html#a3773ab842af7870b63ad24f3c4d4a541">00649</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app_8c.html#a3773ab842af7870b63ad24f3c4d4a541">global_silence_threshold</a> = 128;
<a name="l00650"></a><a class="code" href="app_8c.html#a0442dc13ea144464c2b3f9aa6e2d6417">00650</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app_8c.html#a0442dc13ea144464c2b3f9aa6e2d6417">global_maxsilence</a> = 0;
<a name="l00651"></a>00651 <span class="comment"></span>
<a name="l00652"></a>00652 <span class="comment">/*! Optionally play a sound file or a beep, then record audio and video from the channel.</span>
<a name="l00653"></a>00653 <span class="comment"> * \param chan Channel to playback to/record from.</span>
<a name="l00654"></a>00654 <span class="comment"> * \param playfile Filename of sound to play before recording begins.</span>
<a name="l00655"></a>00655 <span class="comment"> * \param recordfile Filename to record to.</span>
<a name="l00656"></a>00656 <span class="comment"> * \param maxtime Maximum length of recording (in milliseconds).</span>
<a name="l00657"></a>00657 <span class="comment"> * \param fmt Format(s) to record message in. Multiple formats may be specified by separating them with a &apos;|&apos;.</span>
<a name="l00658"></a>00658 <span class="comment"> * \param duration Where to store actual length of the recorded message (in milliseconds).</span>
<a name="l00659"></a>00659 <span class="comment"> * \param beep Whether to play a beep before starting to record.</span>
<a name="l00660"></a>00660 <span class="comment"> * \param silencethreshold</span>
<a name="l00661"></a>00661 <span class="comment"> * \param maxsilence Length of silence that will end a recording (in milliseconds).</span>
<a name="l00662"></a>00662 <span class="comment"> * \param path Optional filesystem path to unlock.</span>
<a name="l00663"></a>00663 <span class="comment"> * \param prepend If true, prepend the recorded audio to an existing file.</span>
<a name="l00664"></a>00664 <span class="comment"> * \param acceptdtmf DTMF digits that will end the recording.</span>
<a name="l00665"></a>00665 <span class="comment"> * \param canceldtmf DTMF digits that will cancel the recording.</span>
<a name="l00666"></a>00666 <span class="comment"> */</span>
<a name="l00667"></a>00667 
<a name="l00668"></a><a class="code" href="app_8c.html#a3a2d88b2b8c4964fac4255816f9dedcf">00668</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app_8c.html#a3a2d88b2b8c4964fac4255816f9dedcf">__ast_play_and_record</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *playfile, <span class="keyword">const</span> <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> *duration, <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a690b549792f347bebb6a13518822bcf7">beep</a>, <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a>, <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> prepend, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#a97629727ac11792aa963aed4457abde8">acceptdtmf</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *canceldtmf)
<a name="l00669"></a>00669 {
<a name="l00670"></a>00670    <span class="keywordtype">int</span> d = 0;
<a name="l00671"></a>00671    <span class="keywordtype">char</span> *fmts;
<a name="l00672"></a>00672    <span class="keywordtype">char</span> <a class="code" href="ael__lex_8c.html#a43be22b7a1b528eaf759e034ec581543">comment</a>[256];
<a name="l00673"></a>00673    <span class="keywordtype">int</span> x, fmtcnt = 1, res = -1, outmsg = 0;
<a name="l00674"></a>00674    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *others[<a class="code" href="file_8h.html#aa932272aad0c1610b79e9b04e54e57ea">AST_MAX_FORMATS</a>];
<a name="l00675"></a>00675    <span class="keywordtype">char</span> *sfmt[<a class="code" href="file_8h.html#aa932272aad0c1610b79e9b04e54e57ea">AST_MAX_FORMATS</a>];
<a name="l00676"></a>00676    <span class="keywordtype">char</span> *stringp = NULL;
<a name="l00677"></a>00677    time_t start, end;
<a name="l00678"></a>00678    <span class="keyword">struct </span><a class="code" href="structast__dsp.html">ast_dsp</a> *sildet = NULL;   <span class="comment">/* silence detector dsp */</span>
<a name="l00679"></a>00679    <span class="keywordtype">int</span> <a class="code" href="structast__dsp.html#a37f3ccbb8c8ee286cec59a4b0340e924">totalsilence</a> = 0;
<a name="l00680"></a>00680    <span class="keywordtype">int</span> rfmt = 0;
<a name="l00681"></a>00681    <span class="keyword">struct </span><a class="code" href="structast__silence__generator.html">ast_silence_generator</a> *silgen = NULL;
<a name="l00682"></a>00682    <span class="keywordtype">char</span> prependfile[80];
<a name="l00683"></a>00683 
<a name="l00684"></a>00684    <span class="keywordflow">if</span> (silencethreshold &lt; 0) {
<a name="l00685"></a>00685       silencethreshold = global_silence_threshold;
<a name="l00686"></a>00686    }
<a name="l00687"></a>00687 
<a name="l00688"></a>00688    <span class="keywordflow">if</span> (maxsilence &lt; 0) {
<a name="l00689"></a>00689       maxsilence = global_maxsilence;
<a name="l00690"></a>00690    }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692    <span class="comment">/* barf if no pointer passed to store duration in */</span>
<a name="l00693"></a>00693    <span class="keywordflow">if</span> (!duration) {
<a name="l00694"></a>00694       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error play_and_record called without duration pointer\n&quot;</span>);
<a name="l00695"></a>00695       <span class="keywordflow">return</span> -1;
<a name="l00696"></a>00696    }
<a name="l00697"></a>00697 
<a name="l00698"></a>00698    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;play_and_record: %s, %s, &apos;%s&apos;\n&quot;</span>, playfile ? playfile : <span class="stringliteral">&quot;&lt;None&gt;&quot;</span>, recordfile, fmt);
<a name="l00699"></a>00699    snprintf(comment, <span class="keyword">sizeof</span>(comment), <span class="stringliteral">&quot;Playing %s, Recording to: %s on %s\n&quot;</span>, playfile ? playfile : <span class="stringliteral">&quot;&lt;None&gt;&quot;</span>, recordfile, chan-&gt;name);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701    <span class="keywordflow">if</span> (playfile || beep) {
<a name="l00702"></a>00702       <span class="keywordflow">if</span> (!beep) {
<a name="l00703"></a>00703          d = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, playfile);
<a name="l00704"></a>00704       }
<a name="l00705"></a>00705       <span class="keywordflow">if</span> (d &gt; -1) {
<a name="l00706"></a>00706          d = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;beep&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00707"></a>00707       }
<a name="l00708"></a>00708       <span class="keywordflow">if</span> (d &lt; 0) {
<a name="l00709"></a>00709          <span class="keywordflow">return</span> -1;
<a name="l00710"></a>00710       }
<a name="l00711"></a>00711    }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713    <span class="keywordflow">if</span> (prepend) {
<a name="l00714"></a>00714       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(prependfile, recordfile, <span class="keyword">sizeof</span>(prependfile));
<a name="l00715"></a>00715       strncat(prependfile, <span class="stringliteral">&quot;-prepend&quot;</span>, <span class="keyword">sizeof</span>(prependfile) - strlen(prependfile) - 1);
<a name="l00716"></a>00716    }
<a name="l00717"></a>00717 
<a name="l00718"></a>00718    fmts = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(fmt);
<a name="l00719"></a>00719 
<a name="l00720"></a>00720    stringp = fmts;
<a name="l00721"></a>00721    <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>);
<a name="l00722"></a>00722    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Recording Formats: sfmts=%s\n&quot;</span>, fmts);
<a name="l00723"></a>00723    sfmt[0] = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(fmts);
<a name="l00724"></a>00724 
<a name="l00725"></a>00725    <span class="keywordflow">while</span> ((fmt = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>))) {
<a name="l00726"></a>00726       <span class="keywordflow">if</span> (fmtcnt &gt; <a class="code" href="file_8h.html#aa932272aad0c1610b79e9b04e54e57ea">AST_MAX_FORMATS</a> - 1) {
<a name="l00727"></a>00727          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Please increase AST_MAX_FORMATS in file.h\n&quot;</span>);
<a name="l00728"></a>00728          <span class="keywordflow">break</span>;
<a name="l00729"></a>00729       }
<a name="l00730"></a>00730       sfmt[fmtcnt++] = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(fmt);
<a name="l00731"></a>00731    }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733    end = start = time(NULL);  <span class="comment">/* pre-initialize end to be same as start in case we never get into loop */</span>
<a name="l00734"></a>00734    <span class="keywordflow">for</span> (x = 0; x &lt; fmtcnt; x++) {
<a name="l00735"></a>00735       others[x] = <a class="code" href="file_8h.html#a964f8ef393c07609d7b9e02937faed52" title="Starts writing a file.">ast_writefile</a>(prepend ? prependfile : recordfile, sfmt[x], comment, O_TRUNC, 0, <a class="code" href="asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>);
<a name="l00736"></a>00736       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;x=%d, open writing:  %s format: %s, %p\n&quot;</span>, x, prepend ? prependfile : recordfile, sfmt[x], others[x]);
<a name="l00737"></a>00737 
<a name="l00738"></a>00738       <span class="keywordflow">if</span> (!others[x]) {
<a name="l00739"></a>00739          <span class="keywordflow">break</span>;
<a name="l00740"></a>00740       }
<a name="l00741"></a>00741    }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743    <span class="keywordflow">if</span> (path) {
<a name="l00744"></a>00744       <a class="code" href="app_8h.html#af6428878db94a4adf8136850e6a654f5" title="Unlock a path.">ast_unlock_path</a>(path);
<a name="l00745"></a>00745    }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747    <span class="keywordflow">if</span> (maxsilence &gt; 0) {
<a name="l00748"></a>00748       sildet = <a class="code" href="dsp_8h.html#a0a60e93006c8e1ca8fda922ae0e0da2c">ast_dsp_new</a>(); <span class="comment">/* Create the silence detector */</span>
<a name="l00749"></a>00749       <span class="keywordflow">if</span> (!sildet) {
<a name="l00750"></a>00750          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create silence detector :(\n&quot;</span>);
<a name="l00751"></a>00751          <span class="keywordflow">return</span> -1;
<a name="l00752"></a>00752       }
<a name="l00753"></a>00753       <a class="code" href="dsp_8h.html#a06a0b883127ba1f853e9e0fa5f29d81b" title="Set threshold value for silence.">ast_dsp_set_threshold</a>(sildet, silencethreshold);
<a name="l00754"></a>00754       rfmt = chan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l00755"></a>00755       res = <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(chan, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>);
<a name="l00756"></a>00756       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00757"></a>00757          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set to linear mode, giving up\n&quot;</span>);
<a name="l00758"></a>00758          <a class="code" href="dsp_8h.html#a0a57a1e374549eb2705068688f4046db">ast_dsp_free</a>(sildet);
<a name="l00759"></a>00759          <span class="keywordflow">return</span> -1;
<a name="l00760"></a>00760       }
<a name="l00761"></a>00761    }
<a name="l00762"></a>00762 
<a name="l00763"></a>00763    <span class="keywordflow">if</span> (!prepend) {
<a name="l00764"></a>00764       <span class="comment">/* Request a video update */</span>
<a name="l00765"></a>00765       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a417bc8ac5817cc1525a3b530abfc1528">AST_CONTROL_VIDUPDATE</a>);
<a name="l00766"></a>00766 
<a name="l00767"></a>00767       <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#afe8795c4ec744506a9300700fc0813dc">ast_opt_transmit_silence</a>) {
<a name="l00768"></a>00768          silgen = <a class="code" href="channel_8h.html#a2a2e0ff24c57491a877cac39cb670024" title="Starts a silence generator on the given channel.">ast_channel_start_silence_generator</a>(chan);
<a name="l00769"></a>00769       }
<a name="l00770"></a>00770    }
<a name="l00771"></a>00771 
<a name="l00772"></a>00772    <span class="keywordflow">if</span> (x == fmtcnt) {
<a name="l00773"></a>00773       <span class="comment">/* Loop forever, writing the packets we read to the writer(s), until</span>
<a name="l00774"></a>00774 <span class="comment">         we read a digit or get a hangup */</span>
<a name="l00775"></a>00775       <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00776"></a>00776       <span class="keywordflow">for</span> (;;) {
<a name="l00777"></a>00777          <span class="keywordflow">if</span> (!(res = <a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, 2000))) {
<a name="l00778"></a>00778             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;One waitfor failed, trying another\n&quot;</span>);
<a name="l00779"></a>00779             <span class="comment">/* Try one more time in case of masq */</span>
<a name="l00780"></a>00780             <span class="keywordflow">if</span> (!(res = <a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, 2000))) {
<a name="l00781"></a>00781                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No audio available on %s??\n&quot;</span>, chan-&gt;name);
<a name="l00782"></a>00782                res = -1;
<a name="l00783"></a>00783             }
<a name="l00784"></a>00784          }
<a name="l00785"></a>00785 
<a name="l00786"></a>00786          <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00787"></a>00787             f = NULL;
<a name="l00788"></a>00788             <span class="keywordflow">break</span>;
<a name="l00789"></a>00789          }
<a name="l00790"></a>00790          <span class="keywordflow">if</span> (!(f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan))) {
<a name="l00791"></a>00791             <span class="keywordflow">break</span>;
<a name="l00792"></a>00792          }
<a name="l00793"></a>00793          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {
<a name="l00794"></a>00794             <span class="comment">/* write each format */</span>
<a name="l00795"></a>00795             <span class="keywordflow">for</span> (x = 0; x &lt; fmtcnt; x++) {
<a name="l00796"></a>00796                <span class="keywordflow">if</span> (prepend &amp;&amp; !others[x]) {
<a name="l00797"></a>00797                   <span class="keywordflow">break</span>;
<a name="l00798"></a>00798                }
<a name="l00799"></a>00799                res = <a class="code" href="file_8h.html#a3608386b919ef0949d2858cdeb02d12e" title="Writes a frame to a stream.">ast_writestream</a>(others[x], f);
<a name="l00800"></a>00800             }
<a name="l00801"></a>00801 
<a name="l00802"></a>00802             <span class="comment">/* Silence Detection */</span>
<a name="l00803"></a>00803             <span class="keywordflow">if</span> (maxsilence &gt; 0) {
<a name="l00804"></a>00804                <span class="keywordtype">int</span> dspsilence = 0;
<a name="l00805"></a>00805                <a class="code" href="dsp_8h.html#a3f3b67988bffb3addfbc8a4688fa466d" title="Return non-zero if this is silence. Updates &amp;quot;totalsilence&amp;quot; with the total...">ast_dsp_silence</a>(sildet, f, &amp;dspsilence);
<a name="l00806"></a>00806                <span class="keywordflow">if</span> (dspsilence) {
<a name="l00807"></a>00807                   totalsilence = dspsilence;
<a name="l00808"></a>00808                } <span class="keywordflow">else</span> {
<a name="l00809"></a>00809                   totalsilence = 0;
<a name="l00810"></a>00810                }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812                <span class="keywordflow">if</span> (totalsilence &gt; maxsilence) {
<a name="l00813"></a>00813                   <span class="comment">/* Ended happily with silence */</span>
<a name="l00814"></a>00814                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Recording automatically stopped after a silence of %d seconds\n&quot;</span>, totalsilence/1000);
<a name="l00815"></a>00815                   res = <span class="charliteral">&apos;S&apos;</span>;
<a name="l00816"></a>00816                   outmsg = 2;
<a name="l00817"></a>00817                   <span class="keywordflow">break</span>;
<a name="l00818"></a>00818                }
<a name="l00819"></a>00819             }
<a name="l00820"></a>00820             <span class="comment">/* Exit on any error */</span>
<a name="l00821"></a>00821             <span class="keywordflow">if</span> (res) {
<a name="l00822"></a>00822                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error writing frame\n&quot;</span>);
<a name="l00823"></a>00823                <span class="keywordflow">break</span>;
<a name="l00824"></a>00824             }
<a name="l00825"></a>00825          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) {
<a name="l00826"></a>00826             <span class="comment">/* Write only once */</span>
<a name="l00827"></a>00827             <a class="code" href="file_8h.html#a3608386b919ef0949d2858cdeb02d12e" title="Writes a frame to a stream.">ast_writestream</a>(others[0], f);
<a name="l00828"></a>00828          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) {
<a name="l00829"></a>00829             <span class="keywordflow">if</span> (prepend) {
<a name="l00830"></a>00830             <span class="comment">/* stop recording with any digit */</span>
<a name="l00831"></a>00831                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User ended message by pressing %c\n&quot;</span>, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00832"></a>00832                res = <span class="charliteral">&apos;t&apos;</span>;
<a name="l00833"></a>00833                outmsg = 2;
<a name="l00834"></a>00834                <span class="keywordflow">break</span>;
<a name="l00835"></a>00835             }
<a name="l00836"></a>00836             <span class="keywordflow">if</span> (strchr(acceptdtmf, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>)) {
<a name="l00837"></a>00837                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User ended message by pressing %c\n&quot;</span>, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00838"></a>00838                res = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l00839"></a>00839                outmsg = 2;
<a name="l00840"></a>00840                <span class="keywordflow">break</span>;
<a name="l00841"></a>00841             }
<a name="l00842"></a>00842             <span class="keywordflow">if</span> (strchr(canceldtmf, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>)) {
<a name="l00843"></a>00843                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User cancelled message by pressing %c\n&quot;</span>, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00844"></a>00844                res = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l00845"></a>00845                outmsg = 0;
<a name="l00846"></a>00846                <span class="keywordflow">break</span>;
<a name="l00847"></a>00847             }
<a name="l00848"></a>00848          }
<a name="l00849"></a>00849          <span class="keywordflow">if</span> (maxtime) {
<a name="l00850"></a>00850             end = time(NULL);
<a name="l00851"></a>00851             <span class="keywordflow">if</span> (maxtime &lt; (end - start)) {
<a name="l00852"></a>00852                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Took too long, cutting it short...\n&quot;</span>);
<a name="l00853"></a>00853                res = <span class="charliteral">&apos;t&apos;</span>;
<a name="l00854"></a>00854                outmsg = 2;
<a name="l00855"></a>00855                <span class="keywordflow">break</span>;
<a name="l00856"></a>00856             }
<a name="l00857"></a>00857          }
<a name="l00858"></a>00858          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00859"></a>00859       }
<a name="l00860"></a>00860       <span class="keywordflow">if</span> (!f) {
<a name="l00861"></a>00861          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User hung up\n&quot;</span>);
<a name="l00862"></a>00862          res = -1;
<a name="l00863"></a>00863          outmsg = 1;
<a name="l00864"></a>00864       } <span class="keywordflow">else</span> {
<a name="l00865"></a>00865          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00866"></a>00866       }
<a name="l00867"></a>00867    } <span class="keywordflow">else</span> {
<a name="l00868"></a>00868       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error creating writestream &apos;%s&apos;, format &apos;%s&apos;\n&quot;</span>, recordfile, sfmt[x]);
<a name="l00869"></a>00869    }
<a name="l00870"></a>00870 
<a name="l00871"></a>00871    <span class="keywordflow">if</span> (!prepend) {
<a name="l00872"></a>00872       <span class="keywordflow">if</span> (silgen) {
<a name="l00873"></a>00873          <a class="code" href="channel_8h.html#a6643cbe766a051d2d06750ab5b3e933d" title="Stops a previously-started silence generator on the given channel.">ast_channel_stop_silence_generator</a>(chan, silgen);
<a name="l00874"></a>00874       }
<a name="l00875"></a>00875    }
<a name="l00876"></a>00876 <span class="comment"></span>
<a name="l00877"></a>00877 <span class="comment">   /*!\note</span>
<a name="l00878"></a>00878 <span class="comment">    * Instead of asking how much time passed (end - start), calculate the number</span>
<a name="l00879"></a>00879 <span class="comment">    * of seconds of audio which actually went into the file.  This fixes a</span>
<a name="l00880"></a>00880 <span class="comment">    * problem where audio is stopped up on the network and never gets to us.</span>
<a name="l00881"></a>00881 <span class="comment">    *</span>
<a name="l00882"></a>00882 <span class="comment">    * Note that we still want to use the number of seconds passed for the max</span>
<a name="l00883"></a>00883 <span class="comment">    * message, otherwise we could get a situation where this stream is never</span>
<a name="l00884"></a>00884 <span class="comment">    * closed (which would create a resource leak).</span>
<a name="l00885"></a>00885 <span class="comment">    */</span>
<a name="l00886"></a>00886    *duration = others[0] ? <a class="code" href="file_8h.html#a01771a318e7adea51499040f27b4278a" title="Tell where we are in a stream.">ast_tellstream</a>(others[0]) / 8000 : 0;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888    <span class="keywordflow">if</span> (!prepend) {
<a name="l00889"></a>00889       <span class="keywordflow">for</span> (x = 0; x &lt; fmtcnt; x++) {
<a name="l00890"></a>00890          <span class="keywordflow">if</span> (!others[x]) {
<a name="l00891"></a>00891             <span class="keywordflow">break</span>;
<a name="l00892"></a>00892          }<span class="comment"></span>
<a name="l00893"></a>00893 <span class="comment">         /*!\note</span>
<a name="l00894"></a>00894 <span class="comment">          * If we ended with silence, trim all but the first 200ms of silence</span>
<a name="l00895"></a>00895 <span class="comment">          * off the recording.  However, if we ended with &apos;#&apos;, we don&apos;t want</span>
<a name="l00896"></a>00896 <span class="comment">          * to trim ANY part of the recording.</span>
<a name="l00897"></a>00897 <span class="comment">          */</span>
<a name="l00898"></a>00898          <span class="keywordflow">if</span> (res &gt; 0 &amp;&amp; totalsilence) {
<a name="l00899"></a>00899             <a class="code" href="file_8h.html#a4c7c02a659b09bb06dd63e1f42692666" title="Rewind stream ms.">ast_stream_rewind</a>(others[x], totalsilence - 200);
<a name="l00900"></a>00900             <span class="comment">/* Reduce duration by a corresponding amount */</span>
<a name="l00901"></a>00901             <span class="keywordflow">if</span> (x == 0 &amp;&amp; *duration) {
<a name="l00902"></a>00902                *duration -= (totalsilence - 200) / 1000;
<a name="l00903"></a>00903                <span class="keywordflow">if</span> (*duration &lt; 0) {
<a name="l00904"></a>00904                   *duration = 0;
<a name="l00905"></a>00905                }
<a name="l00906"></a>00906             }
<a name="l00907"></a>00907          }
<a name="l00908"></a>00908          <a class="code" href="file_8h.html#aa647ac352a00b559131f90ffffea2c3c" title="Trunc stream at current location.">ast_truncstream</a>(others[x]);
<a name="l00909"></a>00909          <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(others[x]);
<a name="l00910"></a>00910       }
<a name="l00911"></a>00911    }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913    <span class="keywordflow">if</span> (prepend &amp;&amp; outmsg) {
<a name="l00914"></a>00914       <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *realfiles[<a class="code" href="file_8h.html#aa932272aad0c1610b79e9b04e54e57ea">AST_MAX_FORMATS</a>];
<a name="l00915"></a>00915       <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *fr;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917       <span class="keywordflow">for</span> (x = 0; x &lt; fmtcnt; x++) {
<a name="l00918"></a>00918          snprintf(comment, <span class="keyword">sizeof</span>(comment), <span class="stringliteral">&quot;Opening the real file %s.%s\n&quot;</span>, recordfile, sfmt[x]);
<a name="l00919"></a>00919          realfiles[x] = <a class="code" href="file_8h.html#ad572060ea434390db3d1ccde4511dfcd" title="Starts reading from a file.">ast_readfile</a>(recordfile, sfmt[x], comment, O_RDONLY, 0, 0);
<a name="l00920"></a>00920          <span class="keywordflow">if</span> (!others[x] || !realfiles[x]) {
<a name="l00921"></a>00921             <span class="keywordflow">break</span>;
<a name="l00922"></a>00922          }<span class="comment"></span>
<a name="l00923"></a>00923 <span class="comment">         /*!\note Same logic as above. */</span>
<a name="l00924"></a>00924          <span class="keywordflow">if</span> (totalsilence) {
<a name="l00925"></a>00925             <a class="code" href="file_8h.html#a4c7c02a659b09bb06dd63e1f42692666" title="Rewind stream ms.">ast_stream_rewind</a>(others[x], totalsilence - 200);
<a name="l00926"></a>00926          }
<a name="l00927"></a>00927          <a class="code" href="file_8h.html#aa647ac352a00b559131f90ffffea2c3c" title="Trunc stream at current location.">ast_truncstream</a>(others[x]);
<a name="l00928"></a>00928          <span class="comment">/* add the original file too */</span>
<a name="l00929"></a>00929          <span class="keywordflow">while</span> ((fr = <a class="code" href="file_8h.html#a962bc31d7a953b0a0290c72b168d41a7" title="Read a frame from a filestream.">ast_readframe</a>(realfiles[x]))) {
<a name="l00930"></a>00930             <a class="code" href="file_8h.html#a3608386b919ef0949d2858cdeb02d12e" title="Writes a frame to a stream.">ast_writestream</a>(others[x], fr);
<a name="l00931"></a>00931             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l00932"></a>00932          }
<a name="l00933"></a>00933          <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(others[x]);
<a name="l00934"></a>00934          <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(realfiles[x]);
<a name="l00935"></a>00935          <a class="code" href="file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba" title="Renames a file.">ast_filerename</a>(prependfile, recordfile, sfmt[x]);
<a name="l00936"></a>00936          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Recording Format: sfmts=%s, prependfile %s, recordfile %s\n&quot;</span>, sfmt[x], prependfile, recordfile);
<a name="l00937"></a>00937          <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(prependfile, sfmt[x]);
<a name="l00938"></a>00938       }
<a name="l00939"></a>00939    }
<a name="l00940"></a>00940    <span class="keywordflow">if</span> (rfmt &amp;&amp; <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(chan, rfmt)) {
<a name="l00941"></a>00941       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to restore format %s to channel &apos;%s&apos;\n&quot;</span>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(rfmt), chan-&gt;name);
<a name="l00942"></a>00942    }
<a name="l00943"></a>00943    <span class="keywordflow">if</span> (outmsg == 2) {
<a name="l00944"></a>00944       <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;auth-thankyou&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00945"></a>00945    }
<a name="l00946"></a>00946    <span class="keywordflow">if</span> (sildet) {
<a name="l00947"></a>00947       <a class="code" href="dsp_8h.html#a0a57a1e374549eb2705068688f4046db">ast_dsp_free</a>(sildet);
<a name="l00948"></a>00948    }
<a name="l00949"></a>00949    <span class="keywordflow">return</span> res;
<a name="l00950"></a>00950 }
<a name="l00951"></a>00951 
<a name="l00952"></a><a class="code" href="app_8c.html#aa4d81f9babb2bb33d249f998a4918577">00952</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app_8c.html#aa4d81f9babb2bb33d249f998a4918577">default_acceptdtmf</a>[] = <span class="stringliteral">&quot;#&quot;</span>;
<a name="l00953"></a><a class="code" href="app_8c.html#ad32d8b985e0bbce48b30bcaeb7d0968a">00953</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app_8c.html#ad32d8b985e0bbce48b30bcaeb7d0968a">default_canceldtmf</a>[] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00954"></a>00954 
<a name="l00955"></a><a class="code" href="app_8c.html#a2d98be9e632629828ec85b14bef82104">00955</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a7f35e9e75513344d3ed7c56b22b8ea1f">ast_play_and_record_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *playfile, <span class="keyword">const</span> <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> *duration, <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a>, <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#a97629727ac11792aa963aed4457abde8">acceptdtmf</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *canceldtmf)
<a name="l00956"></a>00956 {
<a name="l00957"></a>00957    <span class="keywordflow">return</span> <a class="code" href="app_8c.html#a3a2d88b2b8c4964fac4255816f9dedcf">__ast_play_and_record</a>(chan, playfile, recordfile, maxtime, fmt, duration, 0, silencethreshold, maxsilence, path, 0, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(acceptdtmf, default_acceptdtmf), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(canceldtmf, default_canceldtmf));
<a name="l00958"></a>00958 }
<a name="l00959"></a>00959 
<a name="l00960"></a><a class="code" href="app_8c.html#a553d14a558f43861da68fc43705acd1b">00960</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a5189403102ce3cae44bd1b1644ee97a2" title="Record a file for a max amount of time (in seconds), in a given list of formats separated...">ast_play_and_record</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *playfile, <span class="keyword">const</span> <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> *duration, <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a>, <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l00961"></a>00961 {
<a name="l00962"></a>00962    <span class="keywordflow">return</span> <a class="code" href="app_8c.html#a3a2d88b2b8c4964fac4255816f9dedcf">__ast_play_and_record</a>(chan, playfile, recordfile, maxtime, fmt, duration, 0, silencethreshold, maxsilence, path, 0, default_acceptdtmf, default_canceldtmf);
<a name="l00963"></a>00963 }
<a name="l00964"></a>00964 
<a name="l00965"></a><a class="code" href="app_8c.html#a25bde96e37c696cfafaf53e59762d08e">00965</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a46e323bf2b852abe8ed7490fcb6e1f6d" title="Record a message and prepend the message to the given record file after playing the...">ast_play_and_prepend</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">char</span> *playfile, <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> *duration, <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a690b549792f347bebb6a13518822bcf7">beep</a>, <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a>, <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a>)
<a name="l00966"></a>00966 {
<a name="l00967"></a>00967    <span class="keywordflow">return</span> <a class="code" href="app_8c.html#a3a2d88b2b8c4964fac4255816f9dedcf">__ast_play_and_record</a>(chan, playfile, recordfile, maxtime, fmt, duration, beep, silencethreshold, maxsilence, NULL, 1, default_acceptdtmf, default_canceldtmf);
<a name="l00968"></a>00968 }
<a name="l00969"></a>00969 
<a name="l00970"></a>00970 <span class="comment">/* Channel group core functions */</span>
<a name="l00971"></a>00971 
<a name="l00972"></a><a class="code" href="app_8c.html#ab926dd29fc418cde5b67a00ba914cd2c">00972</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#ab926dd29fc418cde5b67a00ba914cd2c" title="Split a group string into group and category, returning a default category if none...">ast_app_group_split_group</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">char</span> *<a class="code" href="structgroup.html">group</a>, <span class="keywordtype">int</span> group_max, <span class="keywordtype">char</span> *category, <span class="keywordtype">int</span> category_max)
<a name="l00973"></a>00973 {
<a name="l00974"></a>00974    <span class="keywordtype">int</span> res = 0;
<a name="l00975"></a>00975    <span class="keywordtype">char</span> tmp[256];
<a name="l00976"></a>00976    <span class="keywordtype">char</span> *grp = NULL, *cat = NULL;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l00979"></a>00979       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, data, <span class="keyword">sizeof</span>(tmp));
<a name="l00980"></a>00980       grp = tmp;
<a name="l00981"></a>00981       <span class="keywordflow">if</span> ((cat = strchr(tmp, <span class="charliteral">&apos;@&apos;</span>))) {
<a name="l00982"></a>00982          *cat++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00983"></a>00983       }
<a name="l00984"></a>00984    }
<a name="l00985"></a>00985 
<a name="l00986"></a>00986    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(grp)) {
<a name="l00987"></a>00987       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(group, grp, group_max);
<a name="l00988"></a>00988    } <span class="keywordflow">else</span> {
<a name="l00989"></a>00989       *group = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00990"></a>00990    }
<a name="l00991"></a>00991 
<a name="l00992"></a>00992    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cat)) {
<a name="l00993"></a>00993       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(category, cat, category_max);
<a name="l00994"></a>00994    }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996    <span class="keywordflow">return</span> res;
<a name="l00997"></a>00997 }
<a name="l00998"></a>00998 
<a name="l00999"></a><a class="code" href="app_8c.html#a6bd3fac13a76cd864600a84ffd66724e">00999</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a6bd3fac13a76cd864600a84ffd66724e" title="Set the group for a channel, splitting the provided data into group and category...">ast_app_group_set_channel</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>)
<a name="l01000"></a>01000 {
<a name="l01001"></a>01001    <span class="keywordtype">int</span> res = 0;
<a name="l01002"></a>01002    <span class="keywordtype">char</span> <a class="code" href="structgroup.html">group</a>[80] = <span class="stringliteral">&quot;&quot;</span>, category[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01003"></a>01003    <span class="keyword">struct </span><a class="code" href="structast__group__info.html" title="channel group info">ast_group_info</a> *gi = NULL;
<a name="l01004"></a>01004    <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = 0;
<a name="l01005"></a>01005 
<a name="l01006"></a>01006    <span class="keywordflow">if</span> (<a class="code" href="app_8h.html#ab926dd29fc418cde5b67a00ba914cd2c" title="Split a group string into group and category, returning a default category if none...">ast_app_group_split_group</a>(data, group, <span class="keyword">sizeof</span>(group), <a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>, <span class="keyword">sizeof</span>(<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>))) {
<a name="l01007"></a>01007       <span class="keywordflow">return</span> -1;
<a name="l01008"></a>01008    }
<a name="l01009"></a>01009 
<a name="l01010"></a>01010    <span class="comment">/* Calculate memory we will need if this is new */</span>
<a name="l01011"></a>01011    len = <span class="keyword">sizeof</span>(*gi) + strlen(group) + 1;
<a name="l01012"></a>01012    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>)) {
<a name="l01013"></a>01013       len += strlen(<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>) + 1;
<a name="l01014"></a>01014    }
<a name="l01015"></a>01015 
<a name="l01016"></a>01016    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01017"></a>01017    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structgroups.html">groups</a>, gi, group_list) {
<a name="l01018"></a>01018       <span class="keywordflow">if</span> ((gi-&gt;<a class="code" href="structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a> == chan) &amp;&amp; ((<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(gi-&gt;<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>)) || (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(gi-&gt;<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>) &amp;&amp; !strcasecmp(gi-&gt;<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>, <a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>)))) {
<a name="l01019"></a>01019          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(group_list);
<a name="l01020"></a>01020          <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(gi);
<a name="l01021"></a>01021          <span class="keywordflow">break</span>;
<a name="l01022"></a>01022       }
<a name="l01023"></a>01023    }
<a name="l01024"></a>01024    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l01025"></a>01025 
<a name="l01026"></a>01026    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(group)) {
<a name="l01027"></a>01027       <span class="comment">/* Enable unsetting the group */</span>
<a name="l01028"></a>01028    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((gi = <a class="code" href="astmm_8h.html#a7cbb7b79af9d539af55b59dfc3598390">calloc</a>(1, len))) {
<a name="l01029"></a>01029       gi-&gt;<a class="code" href="structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = chan;
<a name="l01030"></a>01030       gi-&gt;<a class="code" href="structast__group__info.html#a443519726cbe3c4f2b2fe1d42ce2fd2f">group</a> = (<span class="keywordtype">char</span> *) gi + <span class="keyword">sizeof</span>(*gi);
<a name="l01031"></a>01031       strcpy(gi-&gt;<a class="code" href="structast__group__info.html#a443519726cbe3c4f2b2fe1d42ce2fd2f">group</a>, group);
<a name="l01032"></a>01032       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>)) {
<a name="l01033"></a>01033          gi-&gt;<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a> = (<span class="keywordtype">char</span> *) gi + <span class="keyword">sizeof</span>(*gi) + strlen(group) + 1;
<a name="l01034"></a>01034          strcpy(gi-&gt;<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>, <a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>);
<a name="l01035"></a>01035       }
<a name="l01036"></a>01036       <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;<a class="code" href="structgroups.html">groups</a>, gi, group_list);
<a name="l01037"></a>01037    } <span class="keywordflow">else</span> {
<a name="l01038"></a>01038       res = -1;
<a name="l01039"></a>01039    }
<a name="l01040"></a>01040 
<a name="l01041"></a>01041    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01042"></a>01042 
<a name="l01043"></a>01043    <span class="keywordflow">return</span> res;
<a name="l01044"></a>01044 }
<a name="l01045"></a>01045 
<a name="l01046"></a><a class="code" href="app_8c.html#a026ae712c21ad8f1e8cde66467153838">01046</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a026ae712c21ad8f1e8cde66467153838" title="Get the current channel count of the specified group and category.">ast_app_group_get_count</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structgroup.html">group</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>)
<a name="l01047"></a>01047 {
<a name="l01048"></a>01048    <span class="keyword">struct </span><a class="code" href="structast__group__info.html" title="channel group info">ast_group_info</a> *gi = NULL;
<a name="l01049"></a>01049    <span class="keywordtype">int</span> count = 0;
<a name="l01050"></a>01050 
<a name="l01051"></a>01051    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(group)) {
<a name="l01052"></a>01052       <span class="keywordflow">return</span> 0;
<a name="l01053"></a>01053    }
<a name="l01054"></a>01054 
<a name="l01055"></a>01055    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01056"></a>01056    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structgroups.html">groups</a>, gi, group_list) {
<a name="l01057"></a>01057       <span class="keywordflow">if</span> (!strcasecmp(gi-&gt;<a class="code" href="structast__group__info.html#a443519726cbe3c4f2b2fe1d42ce2fd2f">group</a>, group) &amp;&amp; (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(category) || (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(gi-&gt;<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>) &amp;&amp; !strcasecmp(gi-&gt;<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>, category)))) {
<a name="l01058"></a>01058          count++;
<a name="l01059"></a>01059       }
<a name="l01060"></a>01060    }
<a name="l01061"></a>01061    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01062"></a>01062 
<a name="l01063"></a>01063    <span class="keywordflow">return</span> count;
<a name="l01064"></a>01064 }
<a name="l01065"></a>01065 
<a name="l01066"></a><a class="code" href="app_8c.html#a687e664c7fb3bb2acb4f5fa17f28d3a2">01066</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a687e664c7fb3bb2acb4f5fa17f28d3a2" title="Get the current channel count of all groups that match the specified pattern and...">ast_app_group_match_get_count</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *groupmatch, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>)
<a name="l01067"></a>01067 {
<a name="l01068"></a>01068    <span class="keyword">struct </span><a class="code" href="structast__group__info.html" title="channel group info">ast_group_info</a> *gi = NULL;
<a name="l01069"></a>01069    regex_t regexbuf;
<a name="l01070"></a>01070    <span class="keywordtype">int</span> count = 0;
<a name="l01071"></a>01071 
<a name="l01072"></a>01072    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(groupmatch)) {
<a name="l01073"></a>01073       <span class="keywordflow">return</span> 0;
<a name="l01074"></a>01074    }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076    <span class="comment">/* if regex compilation fails, return zero matches */</span>
<a name="l01077"></a>01077    <span class="keywordflow">if</span> (regcomp(&amp;regexbuf, groupmatch, REG_EXTENDED | REG_NOSUB)) {
<a name="l01078"></a>01078       <span class="keywordflow">return</span> 0;
<a name="l01079"></a>01079    }
<a name="l01080"></a>01080 
<a name="l01081"></a>01081    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01082"></a>01082    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structgroups.html">groups</a>, gi, group_list) {
<a name="l01083"></a>01083       <span class="keywordflow">if</span> (!regexec(&amp;regexbuf, gi-&gt;<a class="code" href="structast__group__info.html#a443519726cbe3c4f2b2fe1d42ce2fd2f">group</a>, 0, NULL, 0) &amp;&amp; (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(category) || (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(gi-&gt;<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>) &amp;&amp; !strcasecmp(gi-&gt;<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>, category)))) {
<a name="l01084"></a>01084          count++;
<a name="l01085"></a>01085       }
<a name="l01086"></a>01086    }
<a name="l01087"></a>01087    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01088"></a>01088 
<a name="l01089"></a>01089    regfree(&amp;regexbuf);
<a name="l01090"></a>01090 
<a name="l01091"></a>01091    <span class="keywordflow">return</span> count;
<a name="l01092"></a>01092 }
<a name="l01093"></a>01093 
<a name="l01094"></a><a class="code" href="app_8c.html#a3411b27185b9133f3084fa2de8cc4260">01094</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a69e90e401aa3da48a6eef5139727cbb3" title="Update all group counting for a channel to a new one.">ast_app_group_update</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *old, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<span class="keyword">new</span>)
<a name="l01095"></a>01095 {
<a name="l01096"></a>01096    <span class="keyword">struct </span><a class="code" href="structast__group__info.html" title="channel group info">ast_group_info</a> *gi = NULL;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01099"></a>01099    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structgroups.html">groups</a>, gi, group_list) {
<a name="l01100"></a>01100       <span class="keywordflow">if</span> (gi-&gt;<a class="code" href="structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a> == old) {
<a name="l01101"></a>01101          gi-&gt;<a class="code" href="structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = <span class="keyword">new</span>;
<a name="l01102"></a>01102       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gi-&gt;<a class="code" href="structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a> == <span class="keyword">new</span>) {
<a name="l01103"></a>01103          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(group_list);
<a name="l01104"></a>01104          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(gi);
<a name="l01105"></a>01105       }
<a name="l01106"></a>01106    }
<a name="l01107"></a>01107    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l01108"></a>01108    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01109"></a>01109 
<a name="l01110"></a>01110    <span class="keywordflow">return</span> 0;
<a name="l01111"></a>01111 }
<a name="l01112"></a>01112 
<a name="l01113"></a><a class="code" href="app_8c.html#add0f96b4b815205f528f5248ccb3d515">01113</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#add0f96b4b815205f528f5248ccb3d515" title="Discard all group counting for a channel.">ast_app_group_discard</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan)
<a name="l01114"></a>01114 {
<a name="l01115"></a>01115    <span class="keyword">struct </span><a class="code" href="structast__group__info.html" title="channel group info">ast_group_info</a> *gi = NULL;
<a name="l01116"></a>01116 
<a name="l01117"></a>01117    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01118"></a>01118    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structgroups.html">groups</a>, gi, group_list) {
<a name="l01119"></a>01119       <span class="keywordflow">if</span> (gi-&gt;<a class="code" href="structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a> == chan) {
<a name="l01120"></a>01120          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(group_list);
<a name="l01121"></a>01121          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(gi);
<a name="l01122"></a>01122       }
<a name="l01123"></a>01123    }
<a name="l01124"></a>01124    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l01125"></a>01125    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127    <span class="keywordflow">return</span> 0;
<a name="l01128"></a>01128 }
<a name="l01129"></a>01129 
<a name="l01130"></a><a class="code" href="app_8c.html#a6d1783b818b130e529c611e710beafe9">01130</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a6d1783b818b130e529c611e710beafe9" title="Write Lock the group count list.">ast_app_group_list_wrlock</a>(<span class="keywordtype">void</span>)
<a name="l01131"></a>01131 {
<a name="l01132"></a>01132    <span class="keywordflow">return</span> <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01133"></a>01133 }
<a name="l01134"></a>01134 
<a name="l01135"></a><a class="code" href="app_8c.html#afa354da7388ee1882ac981396f143bda">01135</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#afa354da7388ee1882ac981396f143bda" title="Read Lock the group count list.">ast_app_group_list_rdlock</a>(<span class="keywordtype">void</span>)
<a name="l01136"></a>01136 {
<a name="l01137"></a>01137    <span class="keywordflow">return</span> <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01138"></a>01138 }
<a name="l01139"></a>01139 
<a name="l01140"></a><a class="code" href="app_8c.html#ae351dc6f23997a800e7a743d6411b8e7">01140</a> <span class="keyword">struct </span><a class="code" href="structast__group__info.html" title="channel group info">ast_group_info</a> *<a class="code" href="app_8h.html#ae351dc6f23997a800e7a743d6411b8e7" title="Get the head of the group count list.">ast_app_group_list_head</a>(<span class="keywordtype">void</span>)
<a name="l01141"></a>01141 {
<a name="l01142"></a>01142    <span class="keywordflow">return</span> <a class="code" href="linkedlists_8h.html#a64835fe6d570951b2a0404799c3d116f">AST_RWLIST_FIRST</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01143"></a>01143 }
<a name="l01144"></a>01144 
<a name="l01145"></a><a class="code" href="app_8c.html#aa3d01e65e04cddfa84781590b37732e8">01145</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#aa3d01e65e04cddfa84781590b37732e8" title="Unlock the group count list.">ast_app_group_list_unlock</a>(<span class="keywordtype">void</span>)
<a name="l01146"></a>01146 {
<a name="l01147"></a>01147    <span class="keywordflow">return</span> <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structgroups.html">groups</a>);
<a name="l01148"></a>01148 }
<a name="l01149"></a>01149 
<a name="l01150"></a>01150 <span class="preprocessor">#undef ast_app_separate_args</span>
<a name="l01151"></a>01151 <span class="preprocessor"></span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a588ed7395623b8493efcf229024af9c5">ast_app_separate_args</a>(<span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">char</span> delim, <span class="keywordtype">char</span> **<a class="code" href="func__strings_8c.html#ab6e308b3a41c01e08d252e071511495c">array</a>, <span class="keywordtype">int</span> arraylen);
<a name="l01152"></a>01152 
<a name="l01153"></a><a class="code" href="app_8c.html#a1b65265bef5e0d7110092144ba9ee4da">01153</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a1b65265bef5e0d7110092144ba9ee4da" title="Separate a string into arguments in an array.">__ast_app_separate_args</a>(<span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">char</span> delim, <span class="keywordtype">int</span> remove_chars, <span class="keywordtype">char</span> **<a class="code" href="func__strings_8c.html#ab6e308b3a41c01e08d252e071511495c">array</a>, <span class="keywordtype">int</span> arraylen)
<a name="l01154"></a>01154 {
<a name="l01155"></a>01155    <span class="keywordtype">int</span> argc;
<a name="l01156"></a>01156    <span class="keywordtype">char</span> *scan, *wasdelim = NULL;
<a name="l01157"></a>01157    <span class="keywordtype">int</span> <a class="code" href="ael__lex_8c.html#a0dec70156318396f15cc8305df9918ab">paren</a> = 0, <a class="code" href="app__voicemail_8c.html#a0d851e2ec853422973f33c7d0d77035f" title="Wraps a character sequence in double quotes, escaping occurences of quotes within...">quote</a> = 0;
<a name="l01158"></a>01158 
<a name="l01159"></a>01159    <span class="keywordflow">if</span> (!buf || !array || !arraylen) {
<a name="l01160"></a>01160       <span class="keywordflow">return</span> 0;
<a name="l01161"></a>01161    }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163    memset(array, 0, arraylen * <span class="keyword">sizeof</span>(*array));
<a name="l01164"></a>01164 
<a name="l01165"></a>01165    scan = buf;
<a name="l01166"></a>01166 
<a name="l01167"></a>01167    <span class="keywordflow">for</span> (argc = 0; *scan &amp;&amp; (argc &lt; arraylen - 1); argc++) {
<a name="l01168"></a>01168       array[argc] = scan;
<a name="l01169"></a>01169       <span class="keywordflow">for</span> (; *scan; scan++) {
<a name="l01170"></a>01170          <span class="keywordflow">if</span> (*scan == <span class="charliteral">&apos;(&apos;</span>) {
<a name="l01171"></a>01171             paren++;
<a name="l01172"></a>01172          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*scan == <span class="charliteral">&apos;)&apos;</span>) {
<a name="l01173"></a>01173             <span class="keywordflow">if</span> (paren) {
<a name="l01174"></a>01174                paren--;
<a name="l01175"></a>01175             }
<a name="l01176"></a>01176          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*scan == <span class="charliteral">&apos;&quot;&apos;</span> &amp;&amp; delim != <span class="charliteral">&apos;&quot;&apos;</span>) {
<a name="l01177"></a>01177             <a class="code" href="app__voicemail_8c.html#a0d851e2ec853422973f33c7d0d77035f" title="Wraps a character sequence in double quotes, escaping occurences of quotes within...">quote</a> = <a class="code" href="app__voicemail_8c.html#a0d851e2ec853422973f33c7d0d77035f" title="Wraps a character sequence in double quotes, escaping occurences of quotes within...">quote</a> ? 0 : 1;
<a name="l01178"></a>01178             <span class="keywordflow">if</span> (remove_chars) {
<a name="l01179"></a>01179                <span class="comment">/* Remove quote character from argument */</span>
<a name="l01180"></a>01180                memmove(scan, scan + 1, strlen(scan));
<a name="l01181"></a>01181                scan--;
<a name="l01182"></a>01182             }
<a name="l01183"></a>01183          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*scan == <span class="charliteral">&apos;\\&apos;</span>) {
<a name="l01184"></a>01184             <span class="keywordflow">if</span> (remove_chars) {
<a name="l01185"></a>01185                <span class="comment">/* Literal character, don&apos;t parse */</span>
<a name="l01186"></a>01186                memmove(scan, scan + 1, strlen(scan));
<a name="l01187"></a>01187             } <span class="keywordflow">else</span> {
<a name="l01188"></a>01188                scan++;
<a name="l01189"></a>01189             }
<a name="l01190"></a>01190          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*scan == delim) &amp;&amp; !paren &amp;&amp; !<a class="code" href="app__voicemail_8c.html#a0d851e2ec853422973f33c7d0d77035f" title="Wraps a character sequence in double quotes, escaping occurences of quotes within...">quote</a>) {
<a name="l01191"></a>01191             wasdelim = scan;
<a name="l01192"></a>01192             *scan++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01193"></a>01193             <span class="keywordflow">break</span>;
<a name="l01194"></a>01194          }
<a name="l01195"></a>01195       }
<a name="l01196"></a>01196    }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198    <span class="comment">/* If the last character in the original string was the delimiter, then</span>
<a name="l01199"></a>01199 <span class="comment">    * there is one additional argument. */</span>
<a name="l01200"></a>01200    <span class="keywordflow">if</span> (*scan || (scan &gt; buf &amp;&amp; (scan - 1) == wasdelim)) {
<a name="l01201"></a>01201       array[argc++] = scan;
<a name="l01202"></a>01202    }
<a name="l01203"></a>01203 
<a name="l01204"></a>01204    <span class="keywordflow">return</span> argc;
<a name="l01205"></a>01205 }
<a name="l01206"></a>01206 
<a name="l01207"></a>01207 <span class="comment">/* ABI compatible function */</span>
<a name="l01208"></a><a class="code" href="app_8c.html#a70b736a751604bff025e3582cf13ae84">01208</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a588ed7395623b8493efcf229024af9c5">ast_app_separate_args</a>(<span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">char</span> delim, <span class="keywordtype">char</span> **<a class="code" href="func__strings_8c.html#ab6e308b3a41c01e08d252e071511495c">array</a>, <span class="keywordtype">int</span> arraylen)
<a name="l01209"></a>01209 {
<a name="l01210"></a>01210    <span class="keywordflow">return</span> <a class="code" href="app_8h.html#a1b65265bef5e0d7110092144ba9ee4da" title="Separate a string into arguments in an array.">__ast_app_separate_args</a>(buf, delim, 1, array, arraylen);
<a name="l01211"></a>01211 }
<a name="l01212"></a>01212 
<a name="l01213"></a><a class="code" href="app_8c.html#a5e3efda31e8018f394246681664d447c">01213</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8c">AST_LOCK_RESULT</a> <a class="code" href="app_8c.html#a5e3efda31e8018f394246681664d447c">ast_lock_path_lockfile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l01214"></a>01214 {
<a name="l01215"></a>01215    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l01216"></a>01216    <span class="keywordtype">char</span> *fs;
<a name="l01217"></a>01217    <span class="keywordtype">int</span> res;
<a name="l01218"></a>01218    <span class="keywordtype">int</span> fd;
<a name="l01219"></a>01219    <span class="keywordtype">int</span> lp = strlen(path);
<a name="l01220"></a>01220    time_t start;
<a name="l01221"></a>01221 
<a name="l01222"></a>01222    s = alloca(lp + 10);
<a name="l01223"></a>01223    fs = alloca(lp + 20);
<a name="l01224"></a>01224 
<a name="l01225"></a>01225    snprintf(fs, strlen(path) + 19, <span class="stringliteral">&quot;%s/.lock-%08lx&quot;</span>, path, <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l01226"></a>01226    fd = open(fs, O_WRONLY | O_CREAT | O_EXCL, <a class="code" href="asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>);
<a name="l01227"></a>01227    <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l01228"></a>01228       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create lock file &apos;%s&apos;: %s\n&quot;</span>, path, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01229"></a>01229       <span class="keywordflow">return</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca46f6f55c5ee9576afd8dde6376c2b01a">AST_LOCK_PATH_NOT_FOUND</a>;
<a name="l01230"></a>01230    }
<a name="l01231"></a>01231    close(fd);
<a name="l01232"></a>01232 
<a name="l01233"></a>01233    snprintf(s, strlen(path) + 9, <span class="stringliteral">&quot;%s/.lock&quot;</span>, path);
<a name="l01234"></a>01234    start = time(NULL);
<a name="l01235"></a>01235    <span class="keywordflow">while</span> (((res = link(fs, s)) &lt; 0) &amp;&amp; (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EEXIST) &amp;&amp; (time(NULL) - start &lt; 5)) {
<a name="l01236"></a>01236       sched_yield();
<a name="l01237"></a>01237    }
<a name="l01238"></a>01238 
<a name="l01239"></a>01239    unlink(fs);
<a name="l01240"></a>01240 
<a name="l01241"></a>01241    <span class="keywordflow">if</span> (res) {
<a name="l01242"></a>01242       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to lock path &apos;%s&apos;: %s\n&quot;</span>, path, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01243"></a>01243       <span class="keywordflow">return</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca9c0f41302de02bb0130a92669d17333d">AST_LOCK_TIMEOUT</a>;
<a name="l01244"></a>01244    } <span class="keywordflow">else</span> {
<a name="l01245"></a>01245       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Locked path &apos;%s&apos;\n&quot;</span>, path);
<a name="l01246"></a>01246       <span class="keywordflow">return</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca37bdbc92223520af2a24d5bfd6f561bb">AST_LOCK_SUCCESS</a>;
<a name="l01247"></a>01247    }
<a name="l01248"></a>01248 }
<a name="l01249"></a>01249 
<a name="l01250"></a><a class="code" href="app_8c.html#a41764988af00a30b8de64b8a37e8228d">01250</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app_8c.html#a41764988af00a30b8de64b8a37e8228d">ast_unlock_path_lockfile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l01251"></a>01251 {
<a name="l01252"></a>01252    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l01253"></a>01253    <span class="keywordtype">int</span> res;
<a name="l01254"></a>01254 
<a name="l01255"></a>01255    s = alloca(strlen(path) + 10);
<a name="l01256"></a>01256 
<a name="l01257"></a>01257    snprintf(s, strlen(path) + 9, <span class="stringliteral">&quot;%s/%s&quot;</span>, path, <span class="stringliteral">&quot;.lock&quot;</span>);
<a name="l01258"></a>01258 
<a name="l01259"></a>01259    <span class="keywordflow">if</span> ((res = unlink(s))) {
<a name="l01260"></a>01260       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not unlock path &apos;%s&apos;: %s\n&quot;</span>, path, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01261"></a>01261    } <span class="keywordflow">else</span> {
<a name="l01262"></a>01262       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Unlocked path &apos;%s&apos;\n&quot;</span>, path);
<a name="l01263"></a>01263    }
<a name="l01264"></a>01264 
<a name="l01265"></a>01265    <span class="keywordflow">return</span> res;
<a name="l01266"></a>01266 }
<a name="l01267"></a>01267 
<a name="l01268"></a><a class="code" href="structpath__lock.html">01268</a> <span class="keyword">struct </span><a class="code" href="structpath__lock.html">path_lock</a> {
<a name="l01269"></a><a class="code" href="structpath__lock.html#a5b9310d351505da95be0fd790e4032c2">01269</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structpath__lock.html">path_lock</a>) <a class="code" href="structpath__lock.html#abd05414a4f5f150ec8ffa01151d2d1ed">le</a>;
<a name="l01270"></a><a class="code" href="structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">01270</a>    <span class="keywordtype">int</span> <a class="code" href="structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;
<a name="l01271"></a><a class="code" href="structpath__lock.html#a44196e6a5696d10442c29e639437196e">01271</a>    <span class="keywordtype">char</span> *<a class="code" href="structpath__lock.html#a44196e6a5696d10442c29e639437196e">path</a>;
<a name="l01272"></a>01272 };
<a name="l01273"></a>01273 
<a name="l01274"></a><a class="code" href="structpath__lock__list.html#adf04f66344e3fb0a6f6a69bf39d19902">01274</a> static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(<a class="code" href="structpath__lock__list.html">path_lock_list</a>, <a class="code" href="structpath__lock.html">path_lock</a>);
<a name="l01275"></a>01275 
<a name="l01276"></a><a class="code" href="app_8c.html#a76f6ec06f0249fceeecd10687cb62e7d">01276</a> static <span class="keywordtype">void</span> <a class="code" href="app_8c.html#a76f6ec06f0249fceeecd10687cb62e7d">path_lock_destroy</a>(struct path_lock *obj)
<a name="l01277"></a>01277 {
<a name="l01278"></a>01278    <span class="keywordflow">if</span> (obj-&gt;fd &gt;= 0) {
<a name="l01279"></a>01279       close(obj-&gt;fd);
<a name="l01280"></a>01280    }
<a name="l01281"></a>01281    <span class="keywordflow">if</span> (obj-&gt;path) {
<a name="l01282"></a>01282       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(obj-&gt;path);
<a name="l01283"></a>01283    }
<a name="l01284"></a>01284    <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(obj);
<a name="l01285"></a>01285 }
<a name="l01286"></a>01286 
<a name="l01287"></a><a class="code" href="app_8c.html#a631aa3756c80daa3b4c825189cfc183c">01287</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8c">AST_LOCK_RESULT</a> <a class="code" href="app_8c.html#a631aa3756c80daa3b4c825189cfc183c">ast_lock_path_flock</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structpath__lock.html#a44196e6a5696d10442c29e639437196e">path</a>)
<a name="l01288"></a>01288 {
<a name="l01289"></a>01289    <span class="keywordtype">char</span> *fs;
<a name="l01290"></a>01290    <span class="keywordtype">int</span> res;
<a name="l01291"></a>01291    <span class="keywordtype">int</span> <a class="code" href="structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;
<a name="l01292"></a>01292    time_t start;
<a name="l01293"></a>01293    <span class="keyword">struct </span><a class="code" href="structpath__lock.html">path_lock</a> *pl;
<a name="l01294"></a>01294    <span class="keyword">struct </span>stat st, ost;
<a name="l01295"></a>01295 
<a name="l01296"></a>01296    fs = alloca(strlen(path) + 20);
<a name="l01297"></a>01297 
<a name="l01298"></a>01298    snprintf(fs, strlen(path) + 19, <span class="stringliteral">&quot;%s/lock&quot;</span>, path);
<a name="l01299"></a>01299    <span class="keywordflow">if</span> (lstat(fs, &amp;st) == 0) {
<a name="l01300"></a>01300       <span class="keywordflow">if</span> ((st.st_mode &amp; S_IFMT) == S_IFLNK) {
<a name="l01301"></a>01301          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create lock file &quot;</span>
<a name="l01302"></a>01302                <span class="stringliteral">&quot;&apos;%s&apos;: it&apos;s already a symbolic link\n&quot;</span>,
<a name="l01303"></a>01303                fs);
<a name="l01304"></a>01304          <span class="keywordflow">return</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8cac59129c6f641d69ad14017c1ba1f2635">AST_LOCK_FAILURE</a>;
<a name="l01305"></a>01305       }
<a name="l01306"></a>01306       <span class="keywordflow">if</span> (st.st_nlink &gt; 1) {
<a name="l01307"></a>01307          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create lock file &quot;</span>
<a name="l01308"></a>01308                <span class="stringliteral">&quot;&apos;%s&apos;: %u hard links exist\n&quot;</span>,
<a name="l01309"></a>01309                fs, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) st.st_nlink);
<a name="l01310"></a>01310          <span class="keywordflow">return</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8cac59129c6f641d69ad14017c1ba1f2635">AST_LOCK_FAILURE</a>;
<a name="l01311"></a>01311       }
<a name="l01312"></a>01312    }
<a name="l01313"></a>01313    <span class="keywordflow">if</span> ((fd = open(fs, O_WRONLY | O_CREAT, 0600)) &lt; 0) {
<a name="l01314"></a>01314       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create lock file &apos;%s&apos;: %s\n&quot;</span>,
<a name="l01315"></a>01315             fs, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01316"></a>01316       <span class="keywordflow">return</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca46f6f55c5ee9576afd8dde6376c2b01a">AST_LOCK_PATH_NOT_FOUND</a>;
<a name="l01317"></a>01317    }
<a name="l01318"></a>01318    <span class="keywordflow">if</span> (!(pl = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*pl)))) {
<a name="l01319"></a>01319       <span class="comment">/* We don&apos;t unlink the lock file here, on the possibility that</span>
<a name="l01320"></a>01320 <span class="comment">       * someone else created it - better to leave a little mess</span>
<a name="l01321"></a>01321 <span class="comment">       * than create a big one by destroying someone else&apos;s lock</span>
<a name="l01322"></a>01322 <span class="comment">       * and causing something to be corrupted.</span>
<a name="l01323"></a>01323 <span class="comment">       */</span>
<a name="l01324"></a>01324       close(fd);
<a name="l01325"></a>01325       <span class="keywordflow">return</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8cac59129c6f641d69ad14017c1ba1f2635">AST_LOCK_FAILURE</a>;
<a name="l01326"></a>01326    }
<a name="l01327"></a>01327    pl-&gt;<a class="code" href="structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = fd;
<a name="l01328"></a>01328    pl-&gt;<a class="code" href="structpath__lock.html#a44196e6a5696d10442c29e639437196e">path</a> = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(path);
<a name="l01329"></a>01329 
<a name="l01330"></a>01330    time(&amp;start);
<a name="l01331"></a>01331    <span class="keywordflow">while</span> (
<a name="l01332"></a>01332       #ifdef SOLARIS
<a name="l01333"></a>01333       ((res = fcntl(pl-&gt;<a class="code" href="structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, F_SETLK, fcntl(pl-&gt;<a class="code" href="structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, F_GETFL) | O_NONBLOCK)) &lt; 0) &amp;&amp;
<a name="l01334"></a>01334       #else
<a name="l01335"></a>01335       ((res = flock(pl-&gt;<a class="code" href="structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, LOCK_EX | LOCK_NB)) &lt; 0) &amp;&amp;
<a name="l01336"></a>01336       #endif
<a name="l01337"></a>01337          (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EWOULDBLOCK) &amp;&amp;
<a name="l01338"></a>01338          (time(NULL) - start &lt; 5))
<a name="l01339"></a>01339       usleep(1000);
<a name="l01340"></a>01340    <span class="keywordflow">if</span> (res) {
<a name="l01341"></a>01341       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to lock path &apos;%s&apos;: %s\n&quot;</span>,
<a name="l01342"></a>01342             path, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01343"></a>01343       <span class="comment">/* No unlinking of lock done, since we tried and failed to</span>
<a name="l01344"></a>01344 <span class="comment">       * flock() it.</span>
<a name="l01345"></a>01345 <span class="comment">       */</span>
<a name="l01346"></a>01346       <a class="code" href="app_8c.html#a76f6ec06f0249fceeecd10687cb62e7d">path_lock_destroy</a>(pl);
<a name="l01347"></a>01347       <span class="keywordflow">return</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca9c0f41302de02bb0130a92669d17333d">AST_LOCK_TIMEOUT</a>;
<a name="l01348"></a>01348    }
<a name="l01349"></a>01349 
<a name="l01350"></a>01350    <span class="comment">/* Check for the race where the file is recreated or deleted out from</span>
<a name="l01351"></a>01351 <span class="comment">    * underneath us.</span>
<a name="l01352"></a>01352 <span class="comment">    */</span>
<a name="l01353"></a>01353    <span class="keywordflow">if</span> (lstat(fs, &amp;st) != 0 &amp;&amp; fstat(pl-&gt;<a class="code" href="structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, &amp;ost) != 0 &amp;&amp;
<a name="l01354"></a>01354          st.st_dev != ost.st_dev &amp;&amp;
<a name="l01355"></a>01355          st.st_ino != ost.st_ino) {
<a name="l01356"></a>01356       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create lock file &apos;%s&apos;: &quot;</span>
<a name="l01357"></a>01357             <span class="stringliteral">&quot;file changed underneath us\n&quot;</span>, fs);
<a name="l01358"></a>01358       <a class="code" href="app_8c.html#a76f6ec06f0249fceeecd10687cb62e7d">path_lock_destroy</a>(pl);
<a name="l01359"></a>01359       <span class="keywordflow">return</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8cac59129c6f641d69ad14017c1ba1f2635">AST_LOCK_FAILURE</a>;
<a name="l01360"></a>01360    }
<a name="l01361"></a>01361 
<a name="l01362"></a>01362    <span class="comment">/* Success: file created, flocked, and is the one we started with */</span>
<a name="l01363"></a>01363    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structpath__lock__list.html">path_lock_list</a>);
<a name="l01364"></a>01364    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="structpath__lock__list.html">path_lock_list</a>, pl, <a class="code" href="structpath__lock.html#abd05414a4f5f150ec8ffa01151d2d1ed">le</a>);
<a name="l01365"></a>01365    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structpath__lock__list.html">path_lock_list</a>);
<a name="l01366"></a>01366 
<a name="l01367"></a>01367    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Locked path &apos;%s&apos;\n&quot;</span>, path);
<a name="l01368"></a>01368 
<a name="l01369"></a>01369    <span class="keywordflow">return</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca37bdbc92223520af2a24d5bfd6f561bb">AST_LOCK_SUCCESS</a>;
<a name="l01370"></a>01370 }
<a name="l01371"></a>01371 
<a name="l01372"></a><a class="code" href="app_8c.html#a195e5dc48a8d508fb6d85597ce9df398">01372</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app_8c.html#a195e5dc48a8d508fb6d85597ce9df398">ast_unlock_path_flock</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structpath__lock.html#a44196e6a5696d10442c29e639437196e">path</a>)
<a name="l01373"></a>01373 {
<a name="l01374"></a>01374    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l01375"></a>01375    <span class="keyword">struct </span><a class="code" href="structpath__lock.html">path_lock</a> *p;
<a name="l01376"></a>01376 
<a name="l01377"></a>01377    s = alloca(strlen(path) + 20);
<a name="l01378"></a>01378 
<a name="l01379"></a>01379    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structpath__lock__list.html">path_lock_list</a>);
<a name="l01380"></a>01380    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structpath__lock__list.html">path_lock_list</a>, p, <a class="code" href="structpath__lock.html#abd05414a4f5f150ec8ffa01151d2d1ed">le</a>) {
<a name="l01381"></a>01381       <span class="keywordflow">if</span> (!strcmp(p-&gt;<a class="code" href="structpath__lock.html#a44196e6a5696d10442c29e639437196e">path</a>, path)) {
<a name="l01382"></a>01382          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(<a class="code" href="structpath__lock.html#abd05414a4f5f150ec8ffa01151d2d1ed">le</a>);
<a name="l01383"></a>01383          <span class="keywordflow">break</span>;
<a name="l01384"></a>01384       }
<a name="l01385"></a>01385    }
<a name="l01386"></a>01386    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l01387"></a>01387    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structpath__lock__list.html">path_lock_list</a>);
<a name="l01388"></a>01388 
<a name="l01389"></a>01389    <span class="keywordflow">if</span> (p) {
<a name="l01390"></a>01390       snprintf(s, strlen(path) + 19, <span class="stringliteral">&quot;%s/lock&quot;</span>, path);
<a name="l01391"></a>01391       unlink(s);
<a name="l01392"></a>01392       <a class="code" href="app_8c.html#a76f6ec06f0249fceeecd10687cb62e7d">path_lock_destroy</a>(p);
<a name="l01393"></a>01393       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Unlocked path &apos;%s&apos;\n&quot;</span>, path);
<a name="l01394"></a>01394    } <span class="keywordflow">else</span> {
<a name="l01395"></a>01395       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Failed to unlock path &apos;%s&apos;: &quot;</span>
<a name="l01396"></a>01396             <span class="stringliteral">&quot;lock not found\n&quot;</span>, path);
<a name="l01397"></a>01397    }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399    <span class="keywordflow">return</span> 0;
<a name="l01400"></a>01400 }
<a name="l01401"></a>01401 
<a name="l01402"></a><a class="code" href="app_8c.html#aaef9c9ee6c9e05a6675201486ea2f02e">01402</a> <span class="keywordtype">void</span> <a class="code" href="app_8h.html#aaef9c9ee6c9e05a6675201486ea2f02e" title="Set the type of locks used by ast_lock_path().">ast_set_lock_type</a>(<span class="keyword">enum</span> <a class="code" href="app_8h.html#a889fad4c6cc627add80454ae61b53241" title="Type of locking to use in ast_lock_path / ast_unlock_path.">AST_LOCK_TYPE</a> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)
<a name="l01403"></a>01403 {
<a name="l01404"></a>01404    ast_lock_type = type;
<a name="l01405"></a>01405 }
<a name="l01406"></a>01406 
<a name="l01407"></a><a class="code" href="app_8c.html#a74c57b5a842dcbc15cc991a31f679a13">01407</a> <span class="keyword">enum</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8c">AST_LOCK_RESULT</a> <a class="code" href="app_8h.html#a74c57b5a842dcbc15cc991a31f679a13" title="Lock a filesystem path.">ast_lock_path</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structpath__lock.html#a44196e6a5696d10442c29e639437196e">path</a>)
<a name="l01408"></a>01408 {
<a name="l01409"></a>01409    <span class="keyword">enum</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8c">AST_LOCK_RESULT</a> r = <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8cac59129c6f641d69ad14017c1ba1f2635">AST_LOCK_FAILURE</a>;
<a name="l01410"></a>01410 
<a name="l01411"></a>01411    <span class="keywordflow">switch</span> (ast_lock_type) {
<a name="l01412"></a>01412    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#a889fad4c6cc627add80454ae61b53241a599f18fdf355d7530bb754b8c66d6de7">AST_LOCK_TYPE_LOCKFILE</a>:
<a name="l01413"></a>01413       r = <a class="code" href="app_8c.html#a5e3efda31e8018f394246681664d447c">ast_lock_path_lockfile</a>(path);
<a name="l01414"></a>01414       <span class="keywordflow">break</span>;
<a name="l01415"></a>01415    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#a889fad4c6cc627add80454ae61b53241a78cd7e44280d287fc0168a0c31b75e3f">AST_LOCK_TYPE_FLOCK</a>:
<a name="l01416"></a>01416       r = <a class="code" href="app_8c.html#a631aa3756c80daa3b4c825189cfc183c">ast_lock_path_flock</a>(path);
<a name="l01417"></a>01417       <span class="keywordflow">break</span>;
<a name="l01418"></a>01418    }
<a name="l01419"></a>01419 
<a name="l01420"></a>01420    <span class="keywordflow">return</span> r;
<a name="l01421"></a>01421 }
<a name="l01422"></a>01422 
<a name="l01423"></a><a class="code" href="app_8c.html#af6428878db94a4adf8136850e6a654f5">01423</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#af6428878db94a4adf8136850e6a654f5" title="Unlock a path.">ast_unlock_path</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structpath__lock.html#a44196e6a5696d10442c29e639437196e">path</a>)
<a name="l01424"></a>01424 {
<a name="l01425"></a>01425    <span class="keywordtype">int</span> r = 0;
<a name="l01426"></a>01426 
<a name="l01427"></a>01427    <span class="keywordflow">switch</span> (ast_lock_type) {
<a name="l01428"></a>01428    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#a889fad4c6cc627add80454ae61b53241a599f18fdf355d7530bb754b8c66d6de7">AST_LOCK_TYPE_LOCKFILE</a>:
<a name="l01429"></a>01429       r = <a class="code" href="app_8c.html#a41764988af00a30b8de64b8a37e8228d">ast_unlock_path_lockfile</a>(path);
<a name="l01430"></a>01430       <span class="keywordflow">break</span>;
<a name="l01431"></a>01431    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#a889fad4c6cc627add80454ae61b53241a78cd7e44280d287fc0168a0c31b75e3f">AST_LOCK_TYPE_FLOCK</a>:
<a name="l01432"></a>01432       r = <a class="code" href="app_8c.html#a195e5dc48a8d508fb6d85597ce9df398">ast_unlock_path_flock</a>(path);
<a name="l01433"></a>01433       <span class="keywordflow">break</span>;
<a name="l01434"></a>01434    }
<a name="l01435"></a>01435 
<a name="l01436"></a>01436    <span class="keywordflow">return</span> r;
<a name="l01437"></a>01437 }
<a name="l01438"></a>01438 
<a name="l01439"></a><a class="code" href="app_8c.html#a88b6ee77eea0c8a6cc0a315e1c1fc815">01439</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a88b6ee77eea0c8a6cc0a315e1c1fc815" title="Allow to record message and have a review option.">ast_record_review</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *playfile, <span class="keyword">const</span> <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> *duration, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structpath__lock.html#a44196e6a5696d10442c29e639437196e">path</a>) 
<a name="l01440"></a>01440 {
<a name="l01441"></a>01441    <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a>;
<a name="l01442"></a>01442    <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a> = 0;
<a name="l01443"></a>01443    <span class="keywordtype">int</span> res = 0;
<a name="l01444"></a>01444    <span class="keywordtype">int</span> cmd = 0;
<a name="l01445"></a>01445    <span class="keywordtype">int</span> max_attempts = 3;
<a name="l01446"></a>01446    <span class="keywordtype">int</span> attempts = 0;
<a name="l01447"></a>01447    <span class="keywordtype">int</span> recorded = 0;
<a name="l01448"></a>01448    <span class="keywordtype">int</span> message_exists = 0;
<a name="l01449"></a>01449    <span class="comment">/* Note that urgent and private are for flagging messages as such in the future */</span>
<a name="l01450"></a>01450 
<a name="l01451"></a>01451    <span class="comment">/* barf if no pointer passed to store duration in */</span>
<a name="l01452"></a>01452    <span class="keywordflow">if</span> (!duration) {
<a name="l01453"></a>01453       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error ast_record_review called without duration pointer\n&quot;</span>);
<a name="l01454"></a>01454       <span class="keywordflow">return</span> -1;
<a name="l01455"></a>01455    }
<a name="l01456"></a>01456 
<a name="l01457"></a>01457    cmd = <span class="charliteral">&apos;3&apos;</span>;   <span class="comment">/* Want to start by recording */</span>
<a name="l01458"></a>01458 
<a name="l01459"></a>01459    silencethreshold = <a class="code" href="dsp_8h.html#aab28c68838eaed4e0c89460a4e554cca" title="Get silence threshold from dsp.conf.">ast_dsp_get_threshold_from_settings</a>(<a class="code" href="dsp_8h.html#a11a8ce2b7eba2230cab37aad708d9abfa40278495f8621707b864e57e1110d20f">THRESHOLD_SILENCE</a>);
<a name="l01460"></a>01460 
<a name="l01461"></a>01461    <span class="keywordflow">while</span> ((cmd &gt;= 0) &amp;&amp; (cmd != <span class="charliteral">&apos;t&apos;</span>)) {
<a name="l01462"></a>01462       <span class="keywordflow">switch</span> (cmd) {
<a name="l01463"></a>01463       <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>:
<a name="l01464"></a>01464          <span class="keywordflow">if</span> (!message_exists) {
<a name="l01465"></a>01465             <span class="comment">/* In this case, 1 is to record a message */</span>
<a name="l01466"></a>01466             cmd = <span class="charliteral">&apos;3&apos;</span>;
<a name="l01467"></a>01467             <span class="keywordflow">break</span>;
<a name="l01468"></a>01468          } <span class="keywordflow">else</span> {
<a name="l01469"></a>01469             <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;vm-msgsaved&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01470"></a>01470             cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l01471"></a>01471             <span class="keywordflow">return</span> res;
<a name="l01472"></a>01472          }
<a name="l01473"></a>01473       <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>:
<a name="l01474"></a>01474          <span class="comment">/* Review */</span>
<a name="l01475"></a>01475          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Reviewing the recording\n&quot;</span>);
<a name="l01476"></a>01476          cmd = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, recordfile, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l01477"></a>01477          <span class="keywordflow">break</span>;
<a name="l01478"></a>01478       <span class="keywordflow">case</span> <span class="charliteral">&apos;3&apos;</span>:
<a name="l01479"></a>01479          message_exists = 0;
<a name="l01480"></a>01480          <span class="comment">/* Record */</span>
<a name="l01481"></a>01481          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;R%secording\n&quot;</span>, recorded == 1 ? <span class="stringliteral">&quot;e-r&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l01482"></a>01482          recorded = 1;
<a name="l01483"></a>01483          <span class="keywordflow">if</span> ((cmd = <a class="code" href="app_8h.html#a5189403102ce3cae44bd1b1644ee97a2" title="Record a file for a max amount of time (in seconds), in a given list of formats separated...">ast_play_and_record</a>(chan, playfile, recordfile, maxtime, fmt, duration, silencethreshold, maxsilence, path)) == -1) {
<a name="l01484"></a>01484             <span class="comment">/* User has hung up, no options to give */</span>
<a name="l01485"></a>01485             <span class="keywordflow">return</span> cmd;
<a name="l01486"></a>01486          }
<a name="l01487"></a>01487          <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;0&apos;</span>) {
<a name="l01488"></a>01488             <span class="keywordflow">break</span>;
<a name="l01489"></a>01489          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;*&apos;</span>) {
<a name="l01490"></a>01490             <span class="keywordflow">break</span>;
<a name="l01491"></a>01491          } <span class="keywordflow">else</span> {
<a name="l01492"></a>01492             <span class="comment">/* If all is well, a message exists */</span>
<a name="l01493"></a>01493             message_exists = 1;
<a name="l01494"></a>01494             cmd = 0;
<a name="l01495"></a>01495          }
<a name="l01496"></a>01496          <span class="keywordflow">break</span>;
<a name="l01497"></a>01497       <span class="keywordflow">case</span> <span class="charliteral">&apos;4&apos;</span>:
<a name="l01498"></a>01498       <span class="keywordflow">case</span> <span class="charliteral">&apos;5&apos;</span>:
<a name="l01499"></a>01499       <span class="keywordflow">case</span> <span class="charliteral">&apos;6&apos;</span>:
<a name="l01500"></a>01500       <span class="keywordflow">case</span> <span class="charliteral">&apos;7&apos;</span>:
<a name="l01501"></a>01501       <span class="keywordflow">case</span> <span class="charliteral">&apos;8&apos;</span>:
<a name="l01502"></a>01502       <span class="keywordflow">case</span> <span class="charliteral">&apos;9&apos;</span>:
<a name="l01503"></a>01503       <span class="keywordflow">case</span> <span class="charliteral">&apos;*&apos;</span>:
<a name="l01504"></a>01504       <span class="keywordflow">case</span> <span class="charliteral">&apos;#&apos;</span>:
<a name="l01505"></a>01505          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);
<a name="l01506"></a>01506          <span class="keywordflow">break</span>;
<a name="l01507"></a>01507       <span class="keywordflow">default</span>:
<a name="l01508"></a>01508          <span class="keywordflow">if</span> (message_exists) {
<a name="l01509"></a>01509             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-review&quot;</span>);
<a name="l01510"></a>01510          } <span class="keywordflow">else</span> {
<a name="l01511"></a>01511             <span class="keywordflow">if</span> (!(cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-torerecord&quot;</span>))) {
<a name="l01512"></a>01512                cmd = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 600);
<a name="l01513"></a>01513             }
<a name="l01514"></a>01514          }
<a name="l01515"></a>01515 
<a name="l01516"></a>01516          <span class="keywordflow">if</span> (!cmd) {
<a name="l01517"></a>01517             cmd = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 6000);
<a name="l01518"></a>01518          }
<a name="l01519"></a>01519          <span class="keywordflow">if</span> (!cmd) {
<a name="l01520"></a>01520             attempts++;
<a name="l01521"></a>01521          }
<a name="l01522"></a>01522          <span class="keywordflow">if</span> (attempts &gt; max_attempts) {
<a name="l01523"></a>01523             cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l01524"></a>01524          }
<a name="l01525"></a>01525       }
<a name="l01526"></a>01526    }
<a name="l01527"></a>01527    <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;t&apos;</span>) {
<a name="l01528"></a>01528       cmd = 0;
<a name="l01529"></a>01529    }
<a name="l01530"></a>01530    <span class="keywordflow">return</span> cmd;
<a name="l01531"></a>01531 }
<a name="l01532"></a>01532 
<a name="l01533"></a><a class="code" href="app_8c.html#a99e8fc9c191dce9a869c02541d31d178">01533</a> <span class="preprocessor">#define RES_UPONE (1 &lt;&lt; 16)</span>
<a name="l01534"></a><a class="code" href="app_8c.html#ac68f484b9b363ef1c76def178529aadf">01534</a> <span class="preprocessor"></span><span class="preprocessor">#define RES_EXIT  (1 &lt;&lt; 17)</span>
<a name="l01535"></a><a class="code" href="app_8c.html#add236e92599b4e2157db3bb1fc4a2757">01535</a> <span class="preprocessor"></span><span class="preprocessor">#define RES_REPEAT (1 &lt;&lt; 18)</span>
<a name="l01536"></a><a class="code" href="app_8c.html#afe510b02adee23bac957dd9db3333dba">01536</a> <span class="preprocessor"></span><span class="preprocessor">#define RES_RESTART ((1 &lt;&lt; 19) | RES_REPEAT)</span>
<a name="l01537"></a>01537 <span class="preprocessor"></span>
<a name="l01538"></a>01538 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app_8c.html#a09ef1fec8abab2315272f9300705ef04">ast_ivr_menu_run_internal</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__ivr__menu.html">ast_ivr_menu</a> *menu, <span class="keywordtype">void</span> *cbdata);
<a name="l01539"></a>01539 
<a name="l01540"></a><a class="code" href="app_8c.html#af708a8d2a35e2699cd5b4851c20110e1">01540</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app_8c.html#af708a8d2a35e2699cd5b4851c20110e1">ivr_dispatch</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__ivr__option.html">ast_ivr_option</a> *option, <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keywordtype">void</span> *cbdata)
<a name="l01541"></a>01541 {
<a name="l01542"></a>01542    <span class="keywordtype">int</span> res;
<a name="l01543"></a>01543    int (*ivr_func)(<span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *, <span class="keywordtype">void</span> *);
<a name="l01544"></a>01544    <span class="keywordtype">char</span> *c;
<a name="l01545"></a>01545    <span class="keywordtype">char</span> *n;
<a name="l01546"></a>01546 
<a name="l01547"></a>01547    <span class="keywordflow">switch</span> (option-&gt;<a class="code" href="structast__ivr__option.html#af5aafe3716e15fcb2fb46ac4a7dc10d1">action</a>) {
<a name="l01548"></a>01548    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a23d56e69a479b44ce2f89034fda4ed9a">AST_ACTION_UPONE</a>:
<a name="l01549"></a>01549       <span class="keywordflow">return</span> <a class="code" href="app_8c.html#a99e8fc9c191dce9a869c02541d31d178">RES_UPONE</a>;
<a name="l01550"></a>01550    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a9f49762cd1386370ddc2f8fc64965b88">AST_ACTION_EXIT</a>:
<a name="l01551"></a>01551       <span class="keywordflow">return</span> <a class="code" href="app_8c.html#ac68f484b9b363ef1c76def178529aadf">RES_EXIT</a> | (((<span class="keywordtype">unsigned</span> long)(option-&gt;<a class="code" href="structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>)) &amp; 0xffff);
<a name="l01552"></a>01552    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5ae951cfbea814df40816b70a1eeba65e8">AST_ACTION_REPEAT</a>:
<a name="l01553"></a>01553       <span class="keywordflow">return</span> <a class="code" href="app_8c.html#add236e92599b4e2157db3bb1fc4a2757">RES_REPEAT</a> | (((<span class="keywordtype">unsigned</span> long)(option-&gt;<a class="code" href="structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>)) &amp; 0xffff);
<a name="l01554"></a>01554    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a53ddb6911a10ea526b86f4cde6b2ce80">AST_ACTION_RESTART</a>:
<a name="l01555"></a>01555       <span class="keywordflow">return</span> <a class="code" href="app_8c.html#afe510b02adee23bac957dd9db3333dba">RES_RESTART</a> ;
<a name="l01556"></a>01556    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a9470126e5a37e3044d577f6ba1140644">AST_ACTION_NOOP</a>:
<a name="l01557"></a>01557       <span class="keywordflow">return</span> 0;
<a name="l01558"></a>01558    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5ab738e4ae4a7e6b7cd68b13d2a58985ba">AST_ACTION_BACKGROUND</a>:
<a name="l01559"></a>01559       res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, (<span class="keywordtype">char</span> *)option-&gt;<a class="code" href="structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l01560"></a>01560       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01561"></a>01561          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to find file &apos;%s&apos;!\n&quot;</span>, (<span class="keywordtype">char</span> *)option-&gt;<a class="code" href="structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>);
<a name="l01562"></a>01562          res = 0;
<a name="l01563"></a>01563       }
<a name="l01564"></a>01564       <span class="keywordflow">return</span> res;
<a name="l01565"></a>01565    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a4bd0306ccd5256f1b150ec9b1d220f0f">AST_ACTION_PLAYBACK</a>:
<a name="l01566"></a>01566       res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, (<span class="keywordtype">char</span> *)option-&gt;<a class="code" href="structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01567"></a>01567       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01568"></a>01568          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to find file &apos;%s&apos;!\n&quot;</span>, (<span class="keywordtype">char</span> *)option-&gt;<a class="code" href="structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>);
<a name="l01569"></a>01569          res = 0;
<a name="l01570"></a>01570       }
<a name="l01571"></a>01571       <span class="keywordflow">return</span> res;
<a name="l01572"></a>01572    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5adc38e521e86969765c95912988cf6e2a">AST_ACTION_MENU</a>:
<a name="l01573"></a>01573       <span class="keywordflow">if</span> ((res = <a class="code" href="app_8c.html#a09ef1fec8abab2315272f9300705ef04">ast_ivr_menu_run_internal</a>(chan, (<span class="keyword">struct</span> <a class="code" href="structast__ivr__menu.html">ast_ivr_menu</a> *)option-&gt;<a class="code" href="structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>, cbdata)) == -2) {
<a name="l01574"></a>01574          <span class="comment">/* Do not pass entry errors back up, treat as though it was an &quot;UPONE&quot; */</span>
<a name="l01575"></a>01575          res = 0;
<a name="l01576"></a>01576       }
<a name="l01577"></a>01577       <span class="keywordflow">return</span> res;
<a name="l01578"></a>01578    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5ac8b97828ca2347ecf4bf942478ddf0ba">AST_ACTION_WAITOPTION</a>:
<a name="l01579"></a>01579       <span class="keywordflow">if</span> (!(res = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a> ? chan-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a765bfb11e07b0f90c235c9af9d7f46fa">rtimeoutms</a> : 10000))) {
<a name="l01580"></a>01580          <span class="keywordflow">return</span> <span class="charliteral">&apos;t&apos;</span>;
<a name="l01581"></a>01581       }
<a name="l01582"></a>01582       <span class="keywordflow">return</span> res;
<a name="l01583"></a>01583    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a911a0be3e05292936e4e6f8646194f7f">AST_ACTION_CALLBACK</a>:
<a name="l01584"></a>01584       ivr_func = option-&gt;<a class="code" href="structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>;
<a name="l01585"></a>01585       res = ivr_func(chan, cbdata);
<a name="l01586"></a>01586       <span class="keywordflow">return</span> res;
<a name="l01587"></a>01587    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5af34630ccb66618ee9dfef4d14423a6d0">AST_ACTION_TRANSFER</a>:
<a name="l01588"></a>01588       res = <a class="code" href="pbx_8h.html#ae9b65b0515d88371a5293dd354bfd92f">ast_parseable_goto</a>(chan, option-&gt;<a class="code" href="structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>);
<a name="l01589"></a>01589       <span class="keywordflow">return</span> 0;
<a name="l01590"></a>01590    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a5a5e2a82ee86aab6a69decbb02514e68">AST_ACTION_PLAYLIST</a>:
<a name="l01591"></a>01591    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a363ce24d1bbcbf4687e4fd21aa1ee621">AST_ACTION_BACKLIST</a>:
<a name="l01592"></a>01592       res = 0;
<a name="l01593"></a>01593       c = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(option-&gt;<a class="code" href="structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>);
<a name="l01594"></a>01594       <span class="keywordflow">while</span> ((n = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;c, <span class="stringliteral">&quot;;&quot;</span>))) {
<a name="l01595"></a>01595          <span class="keywordflow">if</span> ((res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, n,
<a name="l01596"></a>01596                (option-&gt;<a class="code" href="structast__ivr__option.html#af5aafe3716e15fcb2fb46ac4a7dc10d1">action</a> == <a class="code" href="app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a363ce24d1bbcbf4687e4fd21aa1ee621">AST_ACTION_BACKLIST</a>) ? <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a> : <span class="stringliteral">&quot;&quot;</span>))) {
<a name="l01597"></a>01597             <span class="keywordflow">break</span>;
<a name="l01598"></a>01598          }
<a name="l01599"></a>01599       }
<a name="l01600"></a>01600       <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l01601"></a>01601       <span class="keywordflow">return</span> res;
<a name="l01602"></a>01602    <span class="keywordflow">default</span>:
<a name="l01603"></a>01603       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unknown dispatch function %d, ignoring!\n&quot;</span>, option-&gt;<a class="code" href="structast__ivr__option.html#af5aafe3716e15fcb2fb46ac4a7dc10d1">action</a>);
<a name="l01604"></a>01604       <span class="keywordflow">return</span> 0;
<a name="l01605"></a>01605    }
<a name="l01606"></a>01606    <span class="keywordflow">return</span> -1;
<a name="l01607"></a>01607 }
<a name="l01608"></a>01608 
<a name="l01609"></a><a class="code" href="app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">01609</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(<span class="keyword">struct</span> <a class="code" href="structast__ivr__menu.html">ast_ivr_menu</a> *menu, <span class="keywordtype">char</span> *option)
<a name="l01610"></a>01610 {
<a name="l01611"></a>01611    <span class="keywordtype">int</span> x;
<a name="l01612"></a>01612    <span class="keywordflow">for</span> (x = 0; menu-&gt;<a class="code" href="structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[x].<a class="code" href="structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>; x++) {
<a name="l01613"></a>01613       <span class="keywordflow">if</span> (!strcasecmp(menu-&gt;<a class="code" href="structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[x].<a class="code" href="structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>, option)) {
<a name="l01614"></a>01614          <span class="keywordflow">return</span> x;
<a name="l01615"></a>01615       }
<a name="l01616"></a>01616    }
<a name="l01617"></a>01617    <span class="keywordflow">return</span> -1;
<a name="l01618"></a>01618 }
<a name="l01619"></a>01619 
<a name="l01620"></a><a class="code" href="app_8c.html#a490ba593992b218981f3dc2a41f15ac4">01620</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app_8c.html#a490ba593992b218981f3dc2a41f15ac4">option_matchmore</a>(<span class="keyword">struct</span> <a class="code" href="structast__ivr__menu.html">ast_ivr_menu</a> *menu, <span class="keywordtype">char</span> *option)
<a name="l01621"></a>01621 {
<a name="l01622"></a>01622    <span class="keywordtype">int</span> x;
<a name="l01623"></a>01623    <span class="keywordflow">for</span> (x = 0; menu-&gt;<a class="code" href="structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[x].<a class="code" href="structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>; x++) {
<a name="l01624"></a>01624       <span class="keywordflow">if</span> ((!strncasecmp(menu-&gt;<a class="code" href="structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[x].<a class="code" href="structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>, option, strlen(option))) &amp;&amp;
<a name="l01625"></a>01625             (menu-&gt;<a class="code" href="structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[x].<a class="code" href="structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>[strlen(option)])) {
<a name="l01626"></a>01626          <span class="keywordflow">return</span> x;
<a name="l01627"></a>01627       }
<a name="l01628"></a>01628    }
<a name="l01629"></a>01629    <span class="keywordflow">return</span> -1;
<a name="l01630"></a>01630 }
<a name="l01631"></a>01631 
<a name="l01632"></a><a class="code" href="app_8c.html#a8e4d0cf43a02ec7e663a50cee18315d2">01632</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app_8c.html#a8e4d0cf43a02ec7e663a50cee18315d2">read_newoption</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__ivr__menu.html">ast_ivr_menu</a> *menu, <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keywordtype">int</span> maxexten)
<a name="l01633"></a>01633 {
<a name="l01634"></a>01634    <span class="keywordtype">int</span> res = 0;
<a name="l01635"></a>01635    <span class="keywordtype">int</span> ms;
<a name="l01636"></a>01636    <span class="keywordflow">while</span> (<a class="code" href="app_8c.html#a490ba593992b218981f3dc2a41f15ac4">option_matchmore</a>(menu, exten)) {
<a name="l01637"></a>01637       ms = chan-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a> ? chan-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>-&gt;<a class="code" href="structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a> : 5000;
<a name="l01638"></a>01638       <span class="keywordflow">if</span> (strlen(exten) &gt;= maxexten - 1) {
<a name="l01639"></a>01639          <span class="keywordflow">break</span>;
<a name="l01640"></a>01640       }
<a name="l01641"></a>01641       <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, ms)) &lt; 1) {
<a name="l01642"></a>01642          <span class="keywordflow">break</span>;
<a name="l01643"></a>01643       }
<a name="l01644"></a>01644       exten[strlen(exten) + 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01645"></a>01645       exten[strlen(exten)] = res;
<a name="l01646"></a>01646    }
<a name="l01647"></a>01647    <span class="keywordflow">return</span> res &gt; 0 ? 0 : res;
<a name="l01648"></a>01648 }
<a name="l01649"></a>01649 
<a name="l01650"></a><a class="code" href="app_8c.html#a09ef1fec8abab2315272f9300705ef04">01650</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app_8c.html#a09ef1fec8abab2315272f9300705ef04">ast_ivr_menu_run_internal</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__ivr__menu.html">ast_ivr_menu</a> *menu, <span class="keywordtype">void</span> *cbdata)
<a name="l01651"></a>01651 {
<a name="l01652"></a>01652    <span class="comment">/* Execute an IVR menu structure */</span>
<a name="l01653"></a>01653    <span class="keywordtype">int</span> res = 0;
<a name="l01654"></a>01654    <span class="keywordtype">int</span> pos = 0;
<a name="l01655"></a>01655    <span class="keywordtype">int</span> retries = 0;
<a name="l01656"></a>01656    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>] = <span class="stringliteral">&quot;s&quot;</span>;
<a name="l01657"></a>01657    <span class="keywordflow">if</span> (<a class="code" href="app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(menu, <span class="stringliteral">&quot;s&quot;</span>) &lt; 0) {
<a name="l01658"></a>01658       strcpy(exten, <span class="stringliteral">&quot;g&quot;</span>);
<a name="l01659"></a>01659       <span class="keywordflow">if</span> (<a class="code" href="app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(menu, <span class="stringliteral">&quot;g&quot;</span>) &lt; 0) {
<a name="l01660"></a>01660          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No &apos;s&apos; nor &apos;g&apos; extension in menu &apos;%s&apos;!\n&quot;</span>, menu-&gt;<a class="code" href="structast__ivr__menu.html#af06d911bb9e05f491ef3da520d03796c">title</a>);
<a name="l01661"></a>01661          <span class="keywordflow">return</span> -1;
<a name="l01662"></a>01662       }
<a name="l01663"></a>01663    }
<a name="l01664"></a>01664    <span class="keywordflow">while</span> (!res) {
<a name="l01665"></a>01665       <span class="keywordflow">while</span> (menu-&gt;<a class="code" href="structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[pos].<a class="code" href="structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>) {
<a name="l01666"></a>01666          <span class="keywordflow">if</span> (!strcasecmp(menu-&gt;<a class="code" href="structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[pos].<a class="code" href="structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>, exten)) {
<a name="l01667"></a>01667             res = <a class="code" href="app_8c.html#af708a8d2a35e2699cd5b4851c20110e1">ivr_dispatch</a>(chan, menu-&gt;<a class="code" href="structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a> + pos, exten, cbdata);
<a name="l01668"></a>01668             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;IVR Dispatch of &apos;%s&apos; (pos %d) yields %d\n&quot;</span>, exten, pos, res);
<a name="l01669"></a>01669             <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01670"></a>01670                <span class="keywordflow">break</span>;
<a name="l01671"></a>01671             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &amp; <a class="code" href="app_8c.html#a99e8fc9c191dce9a869c02541d31d178">RES_UPONE</a>) {
<a name="l01672"></a>01672                <span class="keywordflow">return</span> 0;
<a name="l01673"></a>01673             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &amp; <a class="code" href="app_8c.html#ac68f484b9b363ef1c76def178529aadf">RES_EXIT</a>) {
<a name="l01674"></a>01674                <span class="keywordflow">return</span> res;
<a name="l01675"></a>01675             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &amp; <a class="code" href="app_8c.html#add236e92599b4e2157db3bb1fc4a2757">RES_REPEAT</a>) {
<a name="l01676"></a>01676                <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ac35730743cfe5d3cb0971c186fb1788a">maxretries</a> = res &amp; 0xffff;
<a name="l01677"></a>01677                <span class="keywordflow">if</span> ((res &amp; <a class="code" href="app_8c.html#afe510b02adee23bac957dd9db3333dba">RES_RESTART</a>) == RES_RESTART) {
<a name="l01678"></a>01678                   retries = 0;
<a name="l01679"></a>01679                } <span class="keywordflow">else</span> {
<a name="l01680"></a>01680                   retries++;
<a name="l01681"></a>01681                }
<a name="l01682"></a>01682                <span class="keywordflow">if</span> (!maxretries) {
<a name="l01683"></a>01683                   maxretries = 3;
<a name="l01684"></a>01684                }
<a name="l01685"></a>01685                <span class="keywordflow">if</span> ((maxretries &gt; 0) &amp;&amp; (retries &gt;= maxretries)) {
<a name="l01686"></a>01686                   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Max retries %d exceeded\n&quot;</span>, maxretries);
<a name="l01687"></a>01687                   <span class="keywordflow">return</span> -2;
<a name="l01688"></a>01688                } <span class="keywordflow">else</span> {
<a name="l01689"></a>01689                   <span class="keywordflow">if</span> (<a class="code" href="app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(menu, <span class="stringliteral">&quot;g&quot;</span>) &gt; -1) {
<a name="l01690"></a>01690                      strcpy(exten, <span class="stringliteral">&quot;g&quot;</span>);
<a name="l01691"></a>01691                   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(menu, <span class="stringliteral">&quot;s&quot;</span>) &gt; -1) {
<a name="l01692"></a>01692                      strcpy(exten, <span class="stringliteral">&quot;s&quot;</span>);
<a name="l01693"></a>01693                   }
<a name="l01694"></a>01694                }
<a name="l01695"></a>01695                pos = 0;
<a name="l01696"></a>01696                <span class="keywordflow">continue</span>;
<a name="l01697"></a>01697             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &amp;&amp; strchr(<a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, res)) {
<a name="l01698"></a>01698                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Got start of extension, %c\n&quot;</span>, res);
<a name="l01699"></a>01699                exten[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01700"></a>01700                exten[0] = res;
<a name="l01701"></a>01701                <span class="keywordflow">if</span> ((res = <a class="code" href="app_8c.html#a8e4d0cf43a02ec7e663a50cee18315d2">read_newoption</a>(chan, menu, exten, <span class="keyword">sizeof</span>(exten)))) {
<a name="l01702"></a>01702                   <span class="keywordflow">break</span>;
<a name="l01703"></a>01703                }
<a name="l01704"></a>01704                <span class="keywordflow">if</span> (<a class="code" href="app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(menu, exten) &lt; 0) {
<a name="l01705"></a>01705                   <span class="keywordflow">if</span> (<a class="code" href="app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(menu, <span class="stringliteral">&quot;i&quot;</span>)) {
<a name="l01706"></a>01706                      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Invalid extension entered, going to &apos;i&apos;!\n&quot;</span>);
<a name="l01707"></a>01707                      strcpy(exten, <span class="stringliteral">&quot;i&quot;</span>);
<a name="l01708"></a>01708                      pos = 0;
<a name="l01709"></a>01709                      <span class="keywordflow">continue</span>;
<a name="l01710"></a>01710                   } <span class="keywordflow">else</span> {
<a name="l01711"></a>01711                      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Aborting on invalid entry, with no &apos;i&apos; option!\n&quot;</span>);
<a name="l01712"></a>01712                      res = -2;
<a name="l01713"></a>01713                      <span class="keywordflow">break</span>;
<a name="l01714"></a>01714                   }
<a name="l01715"></a>01715                } <span class="keywordflow">else</span> {
<a name="l01716"></a>01716                   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;New existing extension: %s\n&quot;</span>, exten);
<a name="l01717"></a>01717                   pos = 0;
<a name="l01718"></a>01718                   <span class="keywordflow">continue</span>;
<a name="l01719"></a>01719                }
<a name="l01720"></a>01720             }
<a name="l01721"></a>01721          }
<a name="l01722"></a>01722          pos++;
<a name="l01723"></a>01723       }
<a name="l01724"></a>01724       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Stopping option &apos;%s&apos;, res is %d\n&quot;</span>, exten, res);
<a name="l01725"></a>01725       pos = 0;
<a name="l01726"></a>01726       <span class="keywordflow">if</span> (!strcasecmp(exten, <span class="stringliteral">&quot;s&quot;</span>)) {
<a name="l01727"></a>01727          strcpy(exten, <span class="stringliteral">&quot;g&quot;</span>);
<a name="l01728"></a>01728       } <span class="keywordflow">else</span> {
<a name="l01729"></a>01729          <span class="keywordflow">break</span>;
<a name="l01730"></a>01730       }
<a name="l01731"></a>01731    }
<a name="l01732"></a>01732    <span class="keywordflow">return</span> res;
<a name="l01733"></a>01733 }
<a name="l01734"></a>01734 
<a name="l01735"></a><a class="code" href="app_8c.html#ac8ce675aa305c7c3236ab1816d78d611">01735</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a855c3d16ea8884345a7b1c3fe5a16577" title="Runs an IVR menu.">ast_ivr_menu_run</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__ivr__menu.html">ast_ivr_menu</a> *menu, <span class="keywordtype">void</span> *cbdata)
<a name="l01736"></a>01736 {
<a name="l01737"></a>01737    <span class="keywordtype">int</span> res = <a class="code" href="app_8c.html#a09ef1fec8abab2315272f9300705ef04">ast_ivr_menu_run_internal</a>(chan, menu, cbdata);
<a name="l01738"></a>01738    <span class="comment">/* Hide internal coding */</span>
<a name="l01739"></a>01739    <span class="keywordflow">return</span> res &gt; 0 ? 0 : res;
<a name="l01740"></a>01740 }
<a name="l01741"></a>01741 
<a name="l01742"></a><a class="code" href="app_8c.html#ada8f5c9b9add1caf6e275238d46cec8c">01742</a> <span class="keywordtype">char</span> *<a class="code" href="app_8h.html#ac5aea5ca8a190e3a89d29b74a09cdb3e" title="Read a file into asterisk.">ast_read_textfile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename)
<a name="l01743"></a>01743 {
<a name="l01744"></a>01744    <span class="keywordtype">int</span> <a class="code" href="structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, count = 0, res;
<a name="l01745"></a>01745    <span class="keywordtype">char</span> *output = NULL;
<a name="l01746"></a>01746    <span class="keyword">struct </span>stat filesize;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748    <span class="keywordflow">if</span> (stat(filename, &amp;filesize) == -1) {
<a name="l01749"></a>01749       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error can&apos;t stat %s\n&quot;</span>, filename);
<a name="l01750"></a>01750       <span class="keywordflow">return</span> NULL;
<a name="l01751"></a>01751    }
<a name="l01752"></a>01752 
<a name="l01753"></a>01753    count = filesize.st_size + 1;
<a name="l01754"></a>01754 
<a name="l01755"></a>01755    <span class="keywordflow">if</span> ((fd = open(filename, O_RDONLY)) &lt; 0) {
<a name="l01756"></a>01756       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot open file &apos;%s&apos; for reading: %s\n&quot;</span>, filename, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01757"></a>01757       <span class="keywordflow">return</span> NULL;
<a name="l01758"></a>01758    }
<a name="l01759"></a>01759 
<a name="l01760"></a>01760    <span class="keywordflow">if</span> ((output = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(count))) {
<a name="l01761"></a>01761       res = read(fd, output, count - 1);
<a name="l01762"></a>01762       <span class="keywordflow">if</span> (res == count - 1) {
<a name="l01763"></a>01763          output[res] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01764"></a>01764       } <span class="keywordflow">else</span> {
<a name="l01765"></a>01765          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Short read of %s (%d of %d): %s\n&quot;</span>, filename, res, count - 1, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01766"></a>01766          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(output);
<a name="l01767"></a>01767          output = NULL;
<a name="l01768"></a>01768       }
<a name="l01769"></a>01769    }
<a name="l01770"></a>01770 
<a name="l01771"></a>01771    close(fd);
<a name="l01772"></a>01772 
<a name="l01773"></a>01773    <span class="keywordflow">return</span> output;
<a name="l01774"></a>01774 }
<a name="l01775"></a>01775 
<a name="l01776"></a><a class="code" href="app_8c.html#af40039f1c49c16d0f6fa33fe9c43a0cb">01776</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__app__option.html" title="A structure to hold the description of an application &amp;#39;option&amp;#39;.">ast_app_option</a> *options, <span class="keyword">struct</span> <a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> *flags, <span class="keywordtype">char</span> **args, <span class="keywordtype">char</span> *optstr)
<a name="l01777"></a>01777 {
<a name="l01778"></a>01778    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, *arg;
<a name="l01779"></a>01779    <span class="keywordtype">int</span> curarg, res = 0;
<a name="l01780"></a>01780    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> argloc;
<a name="l01781"></a>01781 
<a name="l01782"></a>01782    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(flags, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l01783"></a>01783 
<a name="l01784"></a>01784    <span class="keywordflow">if</span> (!optstr) {
<a name="l01785"></a>01785       <span class="keywordflow">return</span> 0;
<a name="l01786"></a>01786    }
<a name="l01787"></a>01787 
<a name="l01788"></a>01788    s = optstr;
<a name="l01789"></a>01789    <span class="keywordflow">while</span> (*s) {
<a name="l01790"></a>01790       curarg = *s++ &amp; 0x7f;   <span class="comment">/* the array (in app.h) has 128 entries */</span>
<a name="l01791"></a>01791       argloc = options[curarg].<a class="code" href="structast__app__option.html#a7fba4686db1ab2c33d8920fb7019d916" title="The index of the entry in the arguments array that should be used for this option&amp;#39;s...">arg_index</a>;
<a name="l01792"></a>01792       <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;(&apos;</span>) {
<a name="l01793"></a>01793          <span class="comment">/* Has argument */</span>
<a name="l01794"></a>01794          arg = ++s;
<a name="l01795"></a>01795          <span class="keywordflow">if</span> ((s = strchr(s, <span class="charliteral">&apos;)&apos;</span>))) {
<a name="l01796"></a>01796             <span class="keywordflow">if</span> (argloc) {
<a name="l01797"></a>01797                args[argloc - 1] = arg;
<a name="l01798"></a>01798             }
<a name="l01799"></a>01799             *s++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01800"></a>01800          } <span class="keywordflow">else</span> {
<a name="l01801"></a>01801             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Missing closing parenthesis for argument &apos;%c&apos; in string &apos;%s&apos;\n&quot;</span>, curarg, arg);
<a name="l01802"></a>01802             res = -1;
<a name="l01803"></a>01803             <span class="keywordflow">break</span>;
<a name="l01804"></a>01804          }
<a name="l01805"></a>01805       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argloc) {
<a name="l01806"></a>01806          args[argloc - 1] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01807"></a>01807       }
<a name="l01808"></a>01808       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(flags, options[curarg].flag);
<a name="l01809"></a>01809    }
<a name="l01810"></a>01810 
<a name="l01811"></a>01811    <span class="keywordflow">return</span> res;
<a name="l01812"></a>01812 }
<a name="l01813"></a>01813 
<a name="l01814"></a>01814 <span class="comment">/* the following function will probably only be used in app_dial, until app_dial is reorganized to</span>
<a name="l01815"></a>01815 <span class="comment">   better handle the large number of options it provides. After it is, you need to get rid of this variant </span>
<a name="l01816"></a>01816 <span class="comment">   -- unless, of course, someone else digs up some use for large flag fields. */</span>
<a name="l01817"></a>01817 
<a name="l01818"></a><a class="code" href="app_8c.html#af85cb9dfd2fea9cfe820d2323c7dd471">01818</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#af85cb9dfd2fea9cfe820d2323c7dd471" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options64</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__app__option.html" title="A structure to hold the description of an application &amp;#39;option&amp;#39;.">ast_app_option</a> *options, <span class="keyword">struct</span> <a class="code" href="structast__flags64.html" title="Structure used to handle a large number of boolean flags == used only in app_dial...">ast_flags64</a> *flags, <span class="keywordtype">char</span> **args, <span class="keywordtype">char</span> *optstr)
<a name="l01819"></a>01819 {
<a name="l01820"></a>01820    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, *arg;
<a name="l01821"></a>01821    <span class="keywordtype">int</span> curarg, res = 0;
<a name="l01822"></a>01822    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> argloc;
<a name="l01823"></a>01823 
<a name="l01824"></a>01824    flags-&gt;<a class="code" href="structast__flags64.html#a899a76dc5f03f0d4ea3793c339e07ee9">flags</a> = 0;
<a name="l01825"></a>01825 
<a name="l01826"></a>01826    <span class="keywordflow">if</span> (!optstr) {
<a name="l01827"></a>01827       <span class="keywordflow">return</span> 0;
<a name="l01828"></a>01828    }
<a name="l01829"></a>01829 
<a name="l01830"></a>01830    s = optstr;
<a name="l01831"></a>01831    <span class="keywordflow">while</span> (*s) {
<a name="l01832"></a>01832       curarg = *s++ &amp; 0x7f;   <span class="comment">/* the array (in app.h) has 128 entries */</span>
<a name="l01833"></a>01833       <a class="code" href="utils_8h.html#ab2de736b42974f12ec7d57c41d234bf4">ast_set_flag64</a>(flags, options[curarg].flag);
<a name="l01834"></a>01834       argloc = options[curarg].<a class="code" href="structast__app__option.html#a7fba4686db1ab2c33d8920fb7019d916" title="The index of the entry in the arguments array that should be used for this option&amp;#39;s...">arg_index</a>;
<a name="l01835"></a>01835       <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;(&apos;</span>) {
<a name="l01836"></a>01836          <span class="comment">/* Has argument */</span>
<a name="l01837"></a>01837          arg = ++s;
<a name="l01838"></a>01838          <span class="keywordflow">if</span> ((s = strchr(s, <span class="charliteral">&apos;)&apos;</span>))) {
<a name="l01839"></a>01839             <span class="keywordflow">if</span> (argloc) {
<a name="l01840"></a>01840                args[argloc - 1] = arg;
<a name="l01841"></a>01841             }
<a name="l01842"></a>01842             *s++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01843"></a>01843          } <span class="keywordflow">else</span> {
<a name="l01844"></a>01844             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Missing closing parenthesis for argument &apos;%c&apos; in string &apos;%s&apos;\n&quot;</span>, curarg, arg);
<a name="l01845"></a>01845             res = -1;
<a name="l01846"></a>01846             <span class="keywordflow">break</span>;
<a name="l01847"></a>01847          }
<a name="l01848"></a>01848       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argloc) {
<a name="l01849"></a>01849          args[argloc - 1] = NULL;
<a name="l01850"></a>01850       }
<a name="l01851"></a>01851    }
<a name="l01852"></a>01852 
<a name="l01853"></a>01853    <span class="keywordflow">return</span> res;
<a name="l01854"></a>01854 }
<a name="l01855"></a>01855 
<a name="l01856"></a><a class="code" href="app_8c.html#adc36d870f1a77a726a74f4891f1365d3">01856</a> <span class="keywordtype">void</span> <a class="code" href="app_8h.html#adc36d870f1a77a726a74f4891f1365d3" title="Given a list of options array, return an option string based on passed flags.">ast_app_options2str64</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__app__option.html" title="A structure to hold the description of an application &amp;#39;option&amp;#39;.">ast_app_option</a> *options, <span class="keyword">struct</span> <a class="code" href="structast__flags64.html" title="Structure used to handle a large number of boolean flags == used only in app_dial...">ast_flags64</a> *flags, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l01857"></a>01857 {
<a name="l01858"></a>01858    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, found = 0;
<a name="l01859"></a>01859    <span class="keywordflow">for</span> (i = 32; i &lt; 128 &amp;&amp; found &lt; len; i++) {
<a name="l01860"></a>01860       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a17ef965a8317b037c32e9b58c3765b1a">ast_test_flag64</a>(flags, options[i].flag)) {
<a name="l01861"></a>01861          buf[found++] = i;
<a name="l01862"></a>01862       }
<a name="l01863"></a>01863    }
<a name="l01864"></a>01864    buf[found] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01865"></a>01865 }
<a name="l01866"></a>01866 
<a name="l01867"></a><a class="code" href="app_8c.html#a1e8f73e62b3c2243eca582ee0d8d6147">01867</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a1e8f73e62b3c2243eca582ee0d8d6147" title="Decode an encoded control or extended ASCII character.">ast_get_encoded_char</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *stream, <span class="keywordtype">char</span> *result, <span class="keywordtype">size_t</span> *consumed)
<a name="l01868"></a>01868 {
<a name="l01869"></a>01869    <span class="keywordtype">int</span> i;
<a name="l01870"></a>01870    *consumed = 1;
<a name="l01871"></a>01871    *result = 0;
<a name="l01872"></a>01872    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(stream)) {
<a name="l01873"></a>01873       *consumed = 0;
<a name="l01874"></a>01874       <span class="keywordflow">return</span> -1;
<a name="l01875"></a>01875    }
<a name="l01876"></a>01876 
<a name="l01877"></a>01877    <span class="keywordflow">if</span> (*stream == <span class="charliteral">&apos;\\&apos;</span>) {
<a name="l01878"></a>01878       *consumed = 2;
<a name="l01879"></a>01879       <span class="keywordflow">switch</span> (*(stream + 1)) {
<a name="l01880"></a>01880       <span class="keywordflow">case</span> <span class="charliteral">&apos;n&apos;</span>:
<a name="l01881"></a>01881          *result = <span class="charliteral">&apos;\n&apos;</span>;
<a name="l01882"></a>01882          <span class="keywordflow">break</span>;
<a name="l01883"></a>01883       <span class="keywordflow">case</span> <span class="charliteral">&apos;r&apos;</span>:
<a name="l01884"></a>01884          *result = <span class="charliteral">&apos;\r&apos;</span>;
<a name="l01885"></a>01885          <span class="keywordflow">break</span>;
<a name="l01886"></a>01886       <span class="keywordflow">case</span> <span class="charliteral">&apos;t&apos;</span>:
<a name="l01887"></a>01887          *result = <span class="charliteral">&apos;\t&apos;</span>;
<a name="l01888"></a>01888          <span class="keywordflow">break</span>;
<a name="l01889"></a>01889       <span class="keywordflow">case</span> <span class="charliteral">&apos;x&apos;</span>:
<a name="l01890"></a>01890          <span class="comment">/* Hexadecimal */</span>
<a name="l01891"></a>01891          <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;0123456789ABCDEFabcdef&quot;</span>, *(stream + 2)) &amp;&amp; *(stream + 2) != <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01892"></a>01892             *consumed = 3;
<a name="l01893"></a>01893             <span class="keywordflow">if</span> (*(stream + 2) &lt;= <span class="charliteral">&apos;9&apos;</span>) {
<a name="l01894"></a>01894                *result = *(stream + 2) - <span class="charliteral">&apos;0&apos;</span>;
<a name="l01895"></a>01895             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(stream + 2) &lt;= <span class="charliteral">&apos;F&apos;</span>) {
<a name="l01896"></a>01896                *result = *(stream + 2) - <span class="charliteral">&apos;A&apos;</span> + 10;
<a name="l01897"></a>01897             } <span class="keywordflow">else</span> {
<a name="l01898"></a>01898                *result = *(stream + 2) - <span class="charliteral">&apos;a&apos;</span> + 10;
<a name="l01899"></a>01899             }
<a name="l01900"></a>01900          } <span class="keywordflow">else</span> {
<a name="l01901"></a>01901             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Illegal character &apos;%c&apos; in hexadecimal string\n&quot;</span>, *(stream + 2));
<a name="l01902"></a>01902             <span class="keywordflow">return</span> -1;
<a name="l01903"></a>01903          }
<a name="l01904"></a>01904 
<a name="l01905"></a>01905          <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;0123456789ABCDEFabcdef&quot;</span>, *(stream + 3)) &amp;&amp; *(stream + 3) != <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01906"></a>01906             *consumed = 4;
<a name="l01907"></a>01907             *result &lt;&lt;= 4;
<a name="l01908"></a>01908             <span class="keywordflow">if</span> (*(stream + 3) &lt;= <span class="charliteral">&apos;9&apos;</span>) {
<a name="l01909"></a>01909                *result += *(stream + 3) - <span class="charliteral">&apos;0&apos;</span>;
<a name="l01910"></a>01910             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(stream + 3) &lt;= <span class="charliteral">&apos;F&apos;</span>) {
<a name="l01911"></a>01911                *result += *(stream + 3) - <span class="charliteral">&apos;A&apos;</span> + 10;
<a name="l01912"></a>01912             } <span class="keywordflow">else</span> {
<a name="l01913"></a>01913                *result += *(stream + 3) - <span class="charliteral">&apos;a&apos;</span> + 10;
<a name="l01914"></a>01914             }
<a name="l01915"></a>01915          }
<a name="l01916"></a>01916          <span class="keywordflow">break</span>;
<a name="l01917"></a>01917       <span class="keywordflow">case</span> <span class="charliteral">&apos;0&apos;</span>:
<a name="l01918"></a>01918          <span class="comment">/* Octal */</span>
<a name="l01919"></a>01919          *consumed = 2;
<a name="l01920"></a>01920          <span class="keywordflow">for</span> (i = 2; ; i++) {
<a name="l01921"></a>01921             <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;01234567&quot;</span>, *(stream + i)) &amp;&amp; *(stream + i) != <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01922"></a>01922                (*consumed)++;
<a name="l01923"></a>01923                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;result was %d, &quot;</span>, *result);
<a name="l01924"></a>01924                *result &lt;&lt;= 3;
<a name="l01925"></a>01925                *result += *(stream + i) - <span class="charliteral">&apos;0&apos;</span>;
<a name="l01926"></a>01926                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;is now %d\n&quot;</span>, *result);
<a name="l01927"></a>01927             } <span class="keywordflow">else</span> {
<a name="l01928"></a>01928                <span class="keywordflow">break</span>;
<a name="l01929"></a>01929             }
<a name="l01930"></a>01930          }
<a name="l01931"></a>01931          <span class="keywordflow">break</span>;
<a name="l01932"></a>01932       <span class="keywordflow">default</span>:
<a name="l01933"></a>01933          *result = *(stream + 1);
<a name="l01934"></a>01934       }
<a name="l01935"></a>01935    } <span class="keywordflow">else</span> {
<a name="l01936"></a>01936       *result = *stream;
<a name="l01937"></a>01937       *consumed = 1;
<a name="l01938"></a>01938    }
<a name="l01939"></a>01939    <span class="keywordflow">return</span> 0;
<a name="l01940"></a>01940 }
<a name="l01941"></a>01941 
<a name="l01942"></a><a class="code" href="app_8c.html#a7bfeeacfbb61627afb3bc534e208d48e">01942</a> <span class="keywordtype">char</span> *<a class="code" href="app_8h.html#a2fdf311701900d162bced0d30e923b92" title="Decode a stream of encoded control or extended ASCII characters.">ast_get_encoded_str</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *stream, <span class="keywordtype">char</span> *result, <span class="keywordtype">size_t</span> result_size)
<a name="l01943"></a>01943 {
<a name="l01944"></a>01944    <span class="keywordtype">char</span> *cur = result;
<a name="l01945"></a>01945    <span class="keywordtype">size_t</span> consumed;
<a name="l01946"></a>01946 
<a name="l01947"></a>01947    <span class="keywordflow">while</span> (cur &lt; result + result_size - 1 &amp;&amp; !<a class="code" href="app_8h.html#a1e8f73e62b3c2243eca582ee0d8d6147" title="Decode an encoded control or extended ASCII character.">ast_get_encoded_char</a>(stream, cur, &amp;consumed)) {
<a name="l01948"></a>01948       cur++;
<a name="l01949"></a>01949       stream += consumed;
<a name="l01950"></a>01950    }
<a name="l01951"></a>01951    *cur = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01952"></a>01952    <span class="keywordflow">return</span> result;
<a name="l01953"></a>01953 }
<a name="l01954"></a>01954 
<a name="l01955"></a><a class="code" href="app_8c.html#a1528703fa0e2ea11fcab7e04f8e0a6cb">01955</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a1528703fa0e2ea11fcab7e04f8e0a6cb" title="Decode a stream of encoded control or extended ASCII characters.">ast_str_get_encoded_str</a>(<span class="keyword">struct</span> <a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> **<a class="code" href="app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>, <span class="keywordtype">int</span> maxlen, <span class="keyword">const</span> <span class="keywordtype">char</span> *stream)
<a name="l01956"></a>01956 {
<a name="l01957"></a>01957    <span class="keywordtype">char</span> <a class="code" href="structpath__lock.html#a5b9310d351505da95be0fd790e4032c2">next</a>, *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l01958"></a>01958    <span class="keywordtype">size_t</span> offset = 0;
<a name="l01959"></a>01959    <span class="keywordtype">size_t</span> consumed;
<a name="l01960"></a>01960 
<a name="l01961"></a>01961    <span class="keywordflow">if</span> (strchr(stream, <span class="charliteral">&apos;\\&apos;</span>)) {
<a name="l01962"></a>01962       <span class="keywordflow">while</span> (!<a class="code" href="app_8h.html#a1e8f73e62b3c2243eca582ee0d8d6147" title="Decode an encoded control or extended ASCII character.">ast_get_encoded_char</a>(stream, &amp;next, &amp;consumed)) {
<a name="l01963"></a>01963          <span class="keywordflow">if</span> (offset + 2 &gt; <a class="code" href="strings_8h.html#ab9726d03e7f9f4746876d71bea28de33" title="Returns the current maximum length (without reallocation) of the current buffer.">ast_str_size</a>(*str) &amp;&amp; maxlen &gt; -1) {
<a name="l01964"></a>01964             <a class="code" href="strings_8h.html#a7f20a4560b028f55b5d723f02f5830cb">ast_str_make_space</a>(str, maxlen &gt; 0 ? maxlen : (<a class="code" href="strings_8h.html#ab9726d03e7f9f4746876d71bea28de33" title="Returns the current maximum length (without reallocation) of the current buffer.">ast_str_size</a>(*str) + 48) * 2 - 48);
<a name="l01965"></a>01965          }
<a name="l01966"></a>01966          <span class="keywordflow">if</span> (offset + 2 &gt; <a class="code" href="strings_8h.html#ab9726d03e7f9f4746876d71bea28de33" title="Returns the current maximum length (without reallocation) of the current buffer.">ast_str_size</a>(*str)) {
<a name="l01967"></a>01967             <span class="keywordflow">break</span>;
<a name="l01968"></a>01968          }
<a name="l01969"></a>01969          buf = <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(*str);
<a name="l01970"></a>01970          buf[offset++] = next;
<a name="l01971"></a>01971          stream += consumed;
<a name="l01972"></a>01972       }
<a name="l01973"></a>01973       buf = <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(*str);
<a name="l01974"></a>01974       buf[offset++] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01975"></a>01975       <a class="code" href="strings_8h.html#a8887fcac1220a7528e88efc16f751415" title="Update the length of the buffer, after using ast_str merely as a buffer.">ast_str_update</a>(*str);
<a name="l01976"></a>01976    } <span class="keywordflow">else</span> {
<a name="l01977"></a>01977       <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(str, maxlen, <span class="stringliteral">&quot;%s&quot;</span>, stream);
<a name="l01978"></a>01978    }
<a name="l01979"></a>01979    <span class="keywordflow">return</span> 0;
<a name="l01980"></a>01980 }
<a name="l01981"></a>01981 
<a name="l01982"></a><a class="code" href="app_8c.html#afcbfdd6dfc8c5f0f549b0a5d7e263e97">01982</a> <span class="keywordtype">void</span> <a class="code" href="app_8h.html#afcbfdd6dfc8c5f0f549b0a5d7e263e97" title="Common routine for child processes, to close all fds prior to exec(2).">ast_close_fds_above_n</a>(<span class="keywordtype">int</span> n)
<a name="l01983"></a>01983 {
<a name="l01984"></a>01984 <span class="preprocessor">#ifdef HAVE_CLOSEFROM</span>
<a name="l01985"></a>01985 <span class="preprocessor"></span>   closefrom(n + 1);
<a name="l01986"></a>01986 <span class="preprocessor">#else</span>
<a name="l01987"></a>01987 <span class="preprocessor"></span>   <span class="keywordtype">int</span> x, null;
<a name="l01988"></a>01988    <span class="keyword">struct </span>rlimit rl;
<a name="l01989"></a>01989    getrlimit(RLIMIT_NOFILE, &amp;rl);
<a name="l01990"></a>01990    null = open(<span class="stringliteral">&quot;/dev/null&quot;</span>, O_RDONLY);
<a name="l01991"></a>01991    <span class="keywordflow">for</span> (x = n + 1; x &lt; rl.rlim_cur; x++) {
<a name="l01992"></a>01992       <span class="keywordflow">if</span> (x != null) {
<a name="l01993"></a>01993          <span class="comment">/* Side effect of dup2 is that it closes any existing fd without error.</span>
<a name="l01994"></a>01994 <span class="comment">          * This prevents valgrind and other debugging tools from sending up</span>
<a name="l01995"></a>01995 <span class="comment">          * false error reports. */</span>
<a name="l01996"></a>01996          <span class="keywordflow">while</span> (dup2(null, x) &lt; 0 &amp;&amp; <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EINTR);
<a name="l01997"></a>01997          close(x);
<a name="l01998"></a>01998       }
<a name="l01999"></a>01999    }
<a name="l02000"></a>02000    close(null);
<a name="l02001"></a>02001 <span class="preprocessor">#endif</span>
<a name="l02002"></a>02002 <span class="preprocessor"></span>}
<a name="l02003"></a>02003 
<a name="l02004"></a><a class="code" href="app_8c.html#a7a4c7e208ffc4d11a1918beb0e920ec0">02004</a> <span class="keywordtype">int</span> <a class="code" href="app_8h.html#a7a4c7e208ffc4d11a1918beb0e920ec0" title="Common routine to safely fork without a chance of a signal handler firing badly in...">ast_safe_fork</a>(<span class="keywordtype">int</span> stop_reaper)
<a name="l02005"></a>02005 {
<a name="l02006"></a>02006    sigset_t signal_set, old_set;
<a name="l02007"></a>02007    <span class="keywordtype">int</span> pid;
<a name="l02008"></a>02008 
<a name="l02009"></a>02009    <span class="comment">/* Don&apos;t let the default signal handler for children reap our status */</span>
<a name="l02010"></a>02010    <span class="keywordflow">if</span> (stop_reaper) {
<a name="l02011"></a>02011       <a class="code" href="app_8h.html#a6de8ef28c39cc39978497de1918bfd70" title="Replace the SIGCHLD handler.">ast_replace_sigchld</a>();
<a name="l02012"></a>02012    }
<a name="l02013"></a>02013 
<a name="l02014"></a>02014    sigfillset(&amp;signal_set);
<a name="l02015"></a>02015    pthread_sigmask(SIG_BLOCK, &amp;signal_set, &amp;old_set);
<a name="l02016"></a>02016 
<a name="l02017"></a>02017    pid = fork();
<a name="l02018"></a>02018 
<a name="l02019"></a>02019    <span class="keywordflow">if</span> (pid != 0) {
<a name="l02020"></a>02020       <span class="comment">/* Fork failed or parent */</span>
<a name="l02021"></a>02021       pthread_sigmask(SIG_SETMASK, &amp;old_set, NULL);
<a name="l02022"></a>02022       <span class="keywordflow">return</span> pid;
<a name="l02023"></a>02023    } <span class="keywordflow">else</span> {
<a name="l02024"></a>02024       <span class="comment">/* Child */</span>
<a name="l02025"></a>02025 <span class="preprocessor">#ifdef HAVE_CAP</span>
<a name="l02026"></a>02026 <span class="preprocessor"></span>      cap_t cap = cap_from_text(<span class="stringliteral">&quot;cap_net_admin-eip&quot;</span>);
<a name="l02027"></a>02027 
<a name="l02028"></a>02028       <span class="keywordflow">if</span> (cap_set_proc(cap)) {
<a name="l02029"></a>02029          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to remove capabilities.\n&quot;</span>);
<a name="l02030"></a>02030       }
<a name="l02031"></a>02031       cap_free(cap);
<a name="l02032"></a>02032 <span class="preprocessor">#endif</span>
<a name="l02033"></a>02033 <span class="preprocessor"></span>
<a name="l02034"></a>02034       <span class="comment">/* Before we unblock our signals, return our trapped signals back to the defaults */</span>
<a name="l02035"></a>02035       signal(SIGHUP, SIG_DFL);
<a name="l02036"></a>02036       signal(SIGCHLD, SIG_DFL);
<a name="l02037"></a>02037       signal(SIGINT, SIG_DFL);
<a name="l02038"></a>02038       signal(SIGURG, SIG_DFL);
<a name="l02039"></a>02039       signal(SIGTERM, SIG_DFL);
<a name="l02040"></a>02040       signal(SIGPIPE, SIG_DFL);
<a name="l02041"></a>02041       signal(SIGXFSZ, SIG_DFL);
<a name="l02042"></a>02042 
<a name="l02043"></a>02043       <span class="comment">/* unblock important signal handlers */</span>
<a name="l02044"></a>02044       <span class="keywordflow">if</span> (pthread_sigmask(SIG_UNBLOCK, &amp;signal_set, NULL)) {
<a name="l02045"></a>02045          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;unable to unblock signals: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02046"></a>02046          _exit(1);
<a name="l02047"></a>02047       }
<a name="l02048"></a>02048 
<a name="l02049"></a>02049       <span class="keywordflow">return</span> pid;
<a name="l02050"></a>02050    }
<a name="l02051"></a>02051 }
<a name="l02052"></a>02052 
<a name="l02053"></a><a class="code" href="app_8c.html#a1044fae6847dc8986a212af0af492a23">02053</a> <span class="keywordtype">void</span> <a class="code" href="app_8h.html#a1044fae6847dc8986a212af0af492a23" title="Common routine to cleanup after fork&amp;#39;ed process is complete (if reaping was stopped)...">ast_safe_fork_cleanup</a>(<span class="keywordtype">void</span>)
<a name="l02054"></a>02054 {
<a name="l02055"></a>02055    <a class="code" href="app_8h.html#ad7c2a7da4125347c06d9719580731228" title="Restore the SIGCHLD handler.">ast_unreplace_sigchld</a>();
<a name="l02056"></a>02056 }
<a name="l02057"></a>02057 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:24 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
