<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:38 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>devicestate.c</h1><a href="devicestate_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2008, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> * Russell Bryant &lt;russell@digium.com&gt;</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00010"></a>00010 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00011"></a>00011 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00012"></a>00012 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00013"></a>00013 <span class="comment"> * channels for your use.</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00016"></a>00016 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00017"></a>00017 <span class="comment"> * at the top of the source tree.</span>
<a name="l00018"></a>00018 <span class="comment"> */</span>
<a name="l00019"></a>00019 <span class="comment"></span>
<a name="l00020"></a>00020 <span class="comment">/*! \file</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * \brief Device state management</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt; </span>
<a name="l00025"></a>00025 <span class="comment"> * \author Russell Bryant &lt;russell@digium.com&gt;</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * \arg \ref AstExtState</span>
<a name="l00028"></a>00028 <span class="comment"> */</span>
<a name="l00029"></a>00029 <span class="comment"></span>
<a name="l00030"></a>00030 <span class="comment">/*! \page AstExtState Extension and device states in Asterisk</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * (Note that these descriptions of device states and extension</span>
<a name="l00033"></a>00033 <span class="comment"> * states have not been updated to the way things work</span>
<a name="l00034"></a>00034 <span class="comment"> * in Asterisk 1.6.)</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> * Asterisk has an internal system that reports states</span>
<a name="l00037"></a>00037 <span class="comment"> * for an extension. By using the dialplan priority -1,</span>
<a name="l00038"></a>00038 <span class="comment"> * also called a \b hint, a connection can be made from an</span>
<a name="l00039"></a>00039 <span class="comment"> * extension to one or many devices. The state of the extension</span>
<a name="l00040"></a>00040 <span class="comment"> * now depends on the combined state of the devices.</span>
<a name="l00041"></a>00041 <span class="comment"> *</span>
<a name="l00042"></a>00042 <span class="comment"> * The device state is basically based on the current calls.</span>
<a name="l00043"></a>00043 <span class="comment"> * If the devicestate engine can find a call from or to the</span>
<a name="l00044"></a>00044 <span class="comment"> * device, it&apos;s in use.</span>
<a name="l00045"></a>00045 <span class="comment"> * </span>
<a name="l00046"></a>00046 <span class="comment"> * Some channel drivers implement a callback function for </span>
<a name="l00047"></a>00047 <span class="comment"> * a better level of reporting device states. The SIP channel</span>
<a name="l00048"></a>00048 <span class="comment"> * has a complicated system for this, which is improved </span>
<a name="l00049"></a>00049 <span class="comment"> * by adding call limits to the configuration.</span>
<a name="l00050"></a>00050 <span class="comment"> * </span>
<a name="l00051"></a>00051 <span class="comment"> * Functions that want to check the status of an extension</span>
<a name="l00052"></a>00052 <span class="comment"> * register themself as a \b watcher.</span>
<a name="l00053"></a>00053 <span class="comment"> * Watchers in this system can subscribe either to all extensions</span>
<a name="l00054"></a>00054 <span class="comment"> * or just a specific extensions.</span>
<a name="l00055"></a>00055 <span class="comment"> *</span>
<a name="l00056"></a>00056 <span class="comment"> * For non-device related states, there&apos;s an API called</span>
<a name="l00057"></a>00057 <span class="comment"> * devicestate providers. This is an extendible system for</span>
<a name="l00058"></a>00058 <span class="comment"> * delivering state information from outside sources or</span>
<a name="l00059"></a>00059 <span class="comment"> * functions within Asterisk. Currently we have providers</span>
<a name="l00060"></a>00060 <span class="comment"> * for app_meetme.c - the conference bridge - and call</span>
<a name="l00061"></a>00061 <span class="comment"> * parking (metermaids).</span>
<a name="l00062"></a>00062 <span class="comment"> *</span>
<a name="l00063"></a>00063 <span class="comment"> * There are manly three subscribers to extension states </span>
<a name="l00064"></a>00064 <span class="comment"> * within Asterisk:</span>
<a name="l00065"></a>00065 <span class="comment"> * - AMI, the manager interface</span>
<a name="l00066"></a>00066 <span class="comment"> * - app_queue.c - the Queue dialplan application</span>
<a name="l00067"></a>00067 <span class="comment"> * - SIP subscriptions, a.k.a. &quot;blinking lamps&quot; or </span>
<a name="l00068"></a>00068 <span class="comment"> *   &quot;buddy lists&quot;</span>
<a name="l00069"></a>00069 <span class="comment"> *</span>
<a name="l00070"></a>00070 <span class="comment"> * The CLI command &quot;show hints&quot; show last known state</span>
<a name="l00071"></a>00071 <span class="comment"> *</span>
<a name="l00072"></a>00072 <span class="comment"> * \note None of these handle user states, like an IM presence</span>
<a name="l00073"></a>00073 <span class="comment"> * system. res_jabber.c can subscribe and watch such states</span>
<a name="l00074"></a>00074 <span class="comment"> * in jabber/xmpp based systems.</span>
<a name="l00075"></a>00075 <span class="comment"> *</span>
<a name="l00076"></a>00076 <span class="comment"> * \section AstDevStateArch Architecture for devicestates</span>
<a name="l00077"></a>00077 <span class="comment"> *</span>
<a name="l00078"></a>00078 <span class="comment"> * When a channel driver or asterisk app changes state for </span>
<a name="l00079"></a>00079 <span class="comment"> * a watched object, it alerts the core. The core queues</span>
<a name="l00080"></a>00080 <span class="comment"> * a change. When the change is processed, there&apos;s a query</span>
<a name="l00081"></a>00081 <span class="comment"> * sent to the channel driver/provider if there&apos;s a function</span>
<a name="l00082"></a>00082 <span class="comment"> * to handle that, otherwise a channel walk is issued to find</span>
<a name="l00083"></a>00083 <span class="comment"> * a channel that involves the object.</span>
<a name="l00084"></a>00084 <span class="comment"> * </span>
<a name="l00085"></a>00085 <span class="comment"> * The changes are queued and processed by a separate thread.</span>
<a name="l00086"></a>00086 <span class="comment"> * This thread calls the watchers subscribing to status </span>
<a name="l00087"></a>00087 <span class="comment"> * changes for the object. For manager, this results </span>
<a name="l00088"></a>00088 <span class="comment"> * in events. For SIP, NOTIFY requests.</span>
<a name="l00089"></a>00089 <span class="comment"> *</span>
<a name="l00090"></a>00090 <span class="comment"> * - Device states</span>
<a name="l00091"></a>00091 <span class="comment"> *    \arg \ref devicestate.c </span>
<a name="l00092"></a>00092 <span class="comment"> *    \arg \ref devicestate.h </span>
<a name="l00093"></a>00093 <span class="comment"> *</span>
<a name="l00094"></a>00094 <span class="comment"> * \section AstExtStateArch Architecture for extension states</span>
<a name="l00095"></a>00095 <span class="comment"> * </span>
<a name="l00096"></a>00096 <span class="comment"> * Hints are connected to extension. If an extension changes state</span>
<a name="l00097"></a>00097 <span class="comment"> * it checks the hint devices. If there is a hint, the callbacks into</span>
<a name="l00098"></a>00098 <span class="comment"> * device states are checked. The aggregated state is set for the hint</span>
<a name="l00099"></a>00099 <span class="comment"> * and reported back.</span>
<a name="l00100"></a>00100 <span class="comment"> *</span>
<a name="l00101"></a>00101 <span class="comment"> * - Extension states</span>
<a name="l00102"></a>00102 <span class="comment"> *    \arg \ref AstENUM ast_extension_states</span>
<a name="l00103"></a>00103 <span class="comment"> *    \arg \ref pbx.c </span>
<a name="l00104"></a>00104 <span class="comment"> *    \arg \ref pbx.h </span>
<a name="l00105"></a>00105 <span class="comment"> * - Structures</span>
<a name="l00106"></a>00106 <span class="comment"> *    - \ref ast_state_cb struct.  Callbacks for watchers</span>
<a name="l00107"></a>00107 <span class="comment"> *    - Callback ast_state_cb_type</span>
<a name="l00108"></a>00108 <span class="comment"> *    - \ref ast_hint struct.</span>
<a name="l00109"></a>00109 <span class="comment"> *    - Functions</span>
<a name="l00110"></a>00110 <span class="comment"> *    - ast_extension_state_add()</span>
<a name="l00111"></a>00111 <span class="comment"> *    - ast_extension_state_del()</span>
<a name="l00112"></a>00112 <span class="comment"> *    - ast_get_hint()</span>
<a name="l00113"></a>00113 <span class="comment"> * </span>
<a name="l00114"></a>00114 <span class="comment"> */</span>
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 205413 $&quot;</span>)
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 <span class="preprocessor">#include &quot;asterisk/_private.h&quot;</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00122"></a>00122 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00123"></a>00123 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00124"></a>00124 <span class="preprocessor">#include &quot;<a class="code" href="linkedlists_8h.html" title="A set of macros to manage forward-linked lists.">asterisk/linkedlists.h</a>&quot;</span>
<a name="l00125"></a>00125 <span class="preprocessor">#include &quot;<a class="code" href="devicestate_8h.html" title="Device state management.">asterisk/devicestate.h</a>&quot;</span>
<a name="l00126"></a>00126 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00127"></a>00127 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00128"></a>00128 <span class="preprocessor">#include &quot;<a class="code" href="event_8h.html">asterisk/event.h</a>&quot;</span>
<a name="l00129"></a>00129 <span class="comment"></span>
<a name="l00130"></a>00130 <span class="comment">/*! \brief Device state strings for printing */</span>
<a name="l00131"></a><a class="code" href="devicestate_8c.html#ac35aab157772024788c572a575a19703">00131</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="devicestate_8c.html#ac35aab157772024788c572a575a19703" title="Device state strings for printing.">devstatestring</a>[][2] = {
<a name="l00132"></a>00132    { <span class="comment">/* 0 AST_DEVICE_UNKNOWN */</span>     <span class="stringliteral">&quot;Unknown&quot;</span>,     <span class="stringliteral">&quot;UNKNOWN&quot;</span>     }, <span class="comment">/*!&lt; Valid, but unknown state */</span>
<a name="l00133"></a>00133    { <span class="comment">/* 1 AST_DEVICE_NOT_INUSE */</span>   <span class="stringliteral">&quot;Not in use&quot;</span>,  <span class="stringliteral">&quot;NOT_INUSE&quot;</span>   }, <span class="comment">/*!&lt; Not used */</span>
<a name="l00134"></a>00134    { <span class="comment">/* 2 AST_DEVICE IN USE */</span>      <span class="stringliteral">&quot;In use&quot;</span>,      <span class="stringliteral">&quot;INUSE&quot;</span>       }, <span class="comment">/*!&lt; In use */</span>
<a name="l00135"></a>00135    { <span class="comment">/* 3 AST_DEVICE_BUSY */</span>        <span class="stringliteral">&quot;Busy&quot;</span>,        <span class="stringliteral">&quot;BUSY&quot;</span>        }, <span class="comment">/*!&lt; Busy */</span>
<a name="l00136"></a>00136    { <span class="comment">/* 4 AST_DEVICE_INVALID */</span>     <span class="stringliteral">&quot;Invalid&quot;</span>,     <span class="stringliteral">&quot;INVALID&quot;</span>     }, <span class="comment">/*!&lt; Invalid - not known to Asterisk */</span>
<a name="l00137"></a>00137    { <span class="comment">/* 5 AST_DEVICE_UNAVAILABLE */</span> <span class="stringliteral">&quot;Unavailable&quot;</span>, <span class="stringliteral">&quot;UNAVAILABLE&quot;</span> }, <span class="comment">/*!&lt; Unavailable (not registered) */</span>
<a name="l00138"></a>00138    { <span class="comment">/* 6 AST_DEVICE_RINGING */</span>     <span class="stringliteral">&quot;Ringing&quot;</span>,     <span class="stringliteral">&quot;RINGING&quot;</span>     }, <span class="comment">/*!&lt; Ring, ring, ring */</span>
<a name="l00139"></a>00139    { <span class="comment">/* 7 AST_DEVICE_RINGINUSE */</span>   <span class="stringliteral">&quot;Ring+Inuse&quot;</span>,  <span class="stringliteral">&quot;RINGINUSE&quot;</span>   }, <span class="comment">/*!&lt; Ring and in use */</span>
<a name="l00140"></a>00140    { <span class="comment">/* 8 AST_DEVICE_ONHOLD */</span>      <span class="stringliteral">&quot;On Hold&quot;</span>,      <span class="stringliteral">&quot;ONHOLD&quot;</span>      }, <span class="comment">/*!&lt; On Hold */</span>
<a name="l00141"></a>00141 };
<a name="l00142"></a>00142 <span class="comment"></span>
<a name="l00143"></a>00143 <span class="comment">/*!\brief Mapping for channel states to device states */</span>
<a name="l00144"></a><a class="code" href="structchan2dev.html">00144</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structchan2dev.html" title="Mapping for channel states to device states.">chan2dev</a> {
<a name="l00145"></a><a class="code" href="structchan2dev.html#aa0be2557c955728a78a4a13b5357e6e8">00145</a>    <span class="keyword">enum</span> <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660" title="ast_channel states">ast_channel_state</a> <a class="code" href="structchan2dev.html#aa0be2557c955728a78a4a13b5357e6e8">chan</a>;
<a name="l00146"></a><a class="code" href="structchan2dev.html#a08551d203da323363be57ed1f699016f">00146</a>    <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> <a class="code" href="structchan2dev.html#a08551d203da323363be57ed1f699016f">dev</a>;
<a name="l00147"></a>00147 } <a class="code" href="structchan2dev.html" title="Mapping for channel states to device states.">chan2dev</a>[] = {
<a name="l00148"></a>00148    { <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>,            <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a> },
<a name="l00149"></a>00149    { <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660addb60fd97b55a4aea24f992e30fe3c84">AST_STATE_RESERVED</a>,        <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a> },
<a name="l00150"></a>00150    { <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a9d7b264ddca4b05135add5d9d48e6271">AST_STATE_OFFHOOK</a>,         <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a> },
<a name="l00151"></a>00151    { <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa70881e902c6c29f27ffba80bb43554f">AST_STATE_DIALING</a>,         <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a> },
<a name="l00152"></a>00152    { <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>,            <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a> },
<a name="l00153"></a>00153    { <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a5bf03bd84f434acaeefdacb0096e1baa">AST_STATE_RINGING</a>,         <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea76d91d5d654cfa3edafb2afbe3e09b46">AST_DEVICE_RINGING</a> },
<a name="l00154"></a>00154    { <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>,              <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a> },
<a name="l00155"></a>00155    { <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa00d313d1a4f4502932f1c10bd619591">AST_STATE_BUSY</a>,            <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeab43afabf5bcd4ad1f531ad78c48ccb6f">AST_DEVICE_BUSY</a> },
<a name="l00156"></a>00156    { <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a4e5d21d1ab20653e36109919d6ea72e1">AST_STATE_DIALING_OFFHOOK</a>, <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a> },
<a name="l00157"></a>00157    { <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a70a2b40aa2ec0f6f0e7378df7a0810db">AST_STATE_PRERING</a>,         <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea76d91d5d654cfa3edafb2afbe3e09b46">AST_DEVICE_RINGING</a> },
<a name="l00158"></a>00158    { -100,                      -100 },
<a name="l00159"></a>00159 };
<a name="l00160"></a>00160 <span class="comment"></span>
<a name="l00161"></a>00161 <span class="comment">/*! \brief  A device state provider (not a channel) */</span>
<a name="l00162"></a><a class="code" href="structdevstate__prov.html">00162</a> <span class="keyword">struct </span><a class="code" href="structdevstate__prov.html" title="A device state provider (not a channel).">devstate_prov</a> {
<a name="l00163"></a><a class="code" href="structdevstate__prov.html#a48e23fa2154347c433b24e799187ee4f">00163</a>    <span class="keywordtype">char</span> <a class="code" href="structdevstate__prov.html#a48e23fa2154347c433b24e799187ee4f">label</a>[40];
<a name="l00164"></a><a class="code" href="structdevstate__prov.html#a255429574a13fcf8e3deacdc16211d00">00164</a>    <a class="code" href="devicestate_8h.html#a93c7236225b5fd76d197b8e5afba2de5" title="Devicestate provider call back.">ast_devstate_prov_cb_type</a> <a class="code" href="structdevstate__prov.html#a255429574a13fcf8e3deacdc16211d00">callback</a>;
<a name="l00165"></a><a class="code" href="structdevstate__prov.html#a29c30c4438a1b71acd896b9a3e2093ec">00165</a>    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(<a class="code" href="structdevstate__prov.html" title="A device state provider (not a channel).">devstate_prov</a>) <a class="code" href="structdevstate__prov.html#a6c499d1fde36b0bee0c362bd431a2108">list</a>;
<a name="l00166"></a>00166 };
<a name="l00167"></a>00167 <span class="comment"></span>
<a name="l00168"></a>00168 <span class="comment">/*! \brief A list of providers */</span>
<a name="l00169"></a><a class="code" href="structdevstate__provs.html#ace4e0066a5b24f84b90536e9906619f6">00169</a> static <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structdevstate__provs.html" title="A list of providers.">devstate_provs</a>, <a class="code" href="structdevstate__prov.html" title="A device state provider (not a channel).">devstate_prov</a>);
<a name="l00170"></a>00170 
<a name="l00171"></a><a class="code" href="structstate__change.html">00171</a> struct <a class="code" href="structstate__change.html">state_change</a> {
<a name="l00172"></a><a class="code" href="structstate__change.html#aa8bbe16f456f8afd0bbed2c8b4f75715">00172</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(state_change) list;
<a name="l00173"></a><a class="code" href="structstate__change.html#ad4a4f6bb9638907e0d14b2d8b05c86a0">00173</a>    <span class="keywordtype">char</span> device[1];
<a name="l00174"></a>00174 };
<a name="l00175"></a>00175 <span class="comment"></span>
<a name="l00176"></a>00176 <span class="comment">/*! \brief The state change queue. State changes are queued</span>
<a name="l00177"></a>00177 <span class="comment">   for processing by a separate thread */</span>
<a name="l00178"></a><a class="code" href="structstate__changes.html#adf04f66344e3fb0a6f6a69bf39d19902">00178</a> static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(<a class="code" href="structstate__changes.html" title="The state change queue. State changes are queued for processing by a separate thread...">state_changes</a>, state_change);
<a name="l00179"></a>00179 <span class="comment"></span>
<a name="l00180"></a>00180 <span class="comment">/*! \brief The device state change notification thread */</span>
<a name="l00181"></a><a class="code" href="devicestate_8c.html#a767b566dd113e1ee0de1634e07c5618d">00181</a> static pthread_t <a class="code" href="devicestate_8c.html#a767b566dd113e1ee0de1634e07c5618d" title="The device state change notification thread.">change_thread</a> = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l00182"></a>00182 <span class="comment"></span>
<a name="l00183"></a>00183 <span class="comment">/*! \brief Flag for the queue */</span>
<a name="l00184"></a><a class="code" href="devicestate_8c.html#aa33e22b03fb6e00eb7f27a34f0e630f1">00184</a> static <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> <a class="code" href="devicestate_8c.html#aa33e22b03fb6e00eb7f27a34f0e630f1" title="Flag for the queue.">change_pending</a>;
<a name="l00185"></a>00185 
<a name="l00186"></a><a class="code" href="structdevstate__change.html">00186</a> struct <a class="code" href="structdevstate__change.html">devstate_change</a> {
<a name="l00187"></a><a class="code" href="structdevstate__change.html#a5be0910133a83449327841b9b1ea7fa2">00187</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(devstate_change) entry;
<a name="l00188"></a><a class="code" href="structdevstate__change.html#a1b0c7bd4d79798ef4e0ce23894c9aeb2">00188</a>    uint32_t <a class="code" href="structstate.html">state</a>;
<a name="l00189"></a><a class="code" href="structdevstate__change.html#aa1d7e6e6eb6d297e62f2d79dbdfaafb4">00189</a>    struct <a class="code" href="structast__eid.html" title="An Entity ID is essentially a MAC address, brief and unique.">ast_eid</a> eid;
<a name="l00190"></a><a class="code" href="structdevstate__change.html#ad4a4f6bb9638907e0d14b2d8b05c86a0">00190</a>    <span class="keywordtype">char</span> device[1];
<a name="l00191"></a>00191 };
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 struct {
<a name="l00194"></a><a class="code" href="devicestate_8c.html#a01f75a9ad916f63a94e06a27635ba278">00194</a>    pthread_t <a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>;
<a name="l00195"></a><a class="code" href="devicestate_8c.html#a513dfcfff59f0204dab3a9b22ed3c6c0">00195</a>    <span class="keyword">struct </span><a class="code" href="structast__event__sub.html" title="Event subscription.">ast_event_sub</a> *<a class="code" href="devicestate_8c.html#a513dfcfff59f0204dab3a9b22ed3c6c0">event_sub</a>;
<a name="l00196"></a><a class="code" href="devicestate_8c.html#a1c7181c39f99ee801943a0d0aa9872b9">00196</a>    <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> <a class="code" href="app__meetme_8c.html#a1c7181c39f99ee801943a0d0aa9872b9">cond</a>;
<a name="l00197"></a><a class="code" href="devicestate_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">00197</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="app__meetme_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>;
<a name="l00198"></a><a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">00198</a>    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, devstate_change) <a class="code" href="devicestate_8c.html#a9eed9fde4b4fa69c3974af65cee78004">devstate_change_q</a>;
<a name="l00199"></a><a class="code" href="devicestate_8c.html#a63be54a0beac1f5717217e1d9e629c71">00199</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="devicestate_8c.html#a63be54a0beac1f5717217e1d9e629c71">enabled</a>:1;
<a name="l00200"></a>00200 } <a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a> = {
<a name="l00201"></a>00201    .thread = AST_PTHREADT_NULL,
<a name="l00202"></a>00202    .enabled = 0,
<a name="l00203"></a>00203 };
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="comment">/* Forward declarations */</span>
<a name="l00206"></a>00206 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="devicestate_8c.html#a7fbd14a6df5d1578371e19c4bb3de563" title="Get provider device state.">getproviderstate</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *provider, <span class="keyword">const</span> <span class="keywordtype">char</span> *address);
<a name="l00207"></a>00207 <span class="comment"></span>
<a name="l00208"></a>00208 <span class="comment">/*! \brief Find devicestate as text message for output */</span>
<a name="l00209"></a><a class="code" href="devicestate_8c.html#a3bdc3375abe6eb1da81c1eb1df5618b6">00209</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="devicestate_8h.html#ac3a57910a6eb04d12d793fe3df796b8e" title="Find devicestate as text message for output.">ast_devstate2str</a>(<span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> devstate) 
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211    <span class="keywordflow">return</span> devstatestring[devstate][0];
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 <span class="comment">/* Deprecated interface (not prefixed with ast_) */</span>
<a name="l00215"></a><a class="code" href="devicestate_8c.html#aa870d9317f745dbb62b491dcc32ec8d8">00215</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="devicestate_8h.html#a753243b1af643942b39a7c7434dd902c" title="Convert device state to text string for output.">devstate2str</a>(<span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> devstate) 
<a name="l00216"></a>00216 {
<a name="l00217"></a>00217    <span class="keywordflow">return</span> devstatestring[devstate][0];
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a><a class="code" href="devicestate_8c.html#a8e0c5acc035f43741343b8ed2fcb14ea">00220</a> <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> <a class="code" href="devicestate_8h.html#a8e0c5acc035f43741343b8ed2fcb14ea" title="Convert channel state to devicestate.">ast_state_chan2dev</a>(<span class="keyword">enum</span> <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660" title="ast_channel states">ast_channel_state</a> chanstate)
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222    <span class="keywordtype">int</span> i;
<a name="l00223"></a>00223    chanstate &amp;= 0xFFFF;
<a name="l00224"></a>00224    <span class="keywordflow">for</span> (i = 0; <a class="code" href="structchan2dev.html" title="Mapping for channel states to device states.">chan2dev</a>[i].chan != -100; i++) {
<a name="l00225"></a>00225       <span class="keywordflow">if</span> (<a class="code" href="structchan2dev.html" title="Mapping for channel states to device states.">chan2dev</a>[i].<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a> == chanstate) {
<a name="l00226"></a>00226          <span class="keywordflow">return</span> <a class="code" href="structchan2dev.html" title="Mapping for channel states to device states.">chan2dev</a>[i].dev;
<a name="l00227"></a>00227       }
<a name="l00228"></a>00228    }
<a name="l00229"></a>00229    <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>;
<a name="l00230"></a>00230 }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 <span class="comment">/* Parseable */</span>
<a name="l00233"></a><a class="code" href="devicestate_8c.html#a3573a25e7e8a395fe8332f1b1ca42097">00233</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="devicestate_8h.html#a6190de57ac370315e51f2c46724d5b10" title="Convert device state to text string that is easier to parse.">ast_devstate_str</a>(<span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> state)
<a name="l00234"></a>00234 {
<a name="l00235"></a>00235    <span class="keywordflow">return</span> devstatestring[state][1];
<a name="l00236"></a>00236 }
<a name="l00237"></a>00237 
<a name="l00238"></a><a class="code" href="devicestate_8c.html#ae148e0b95218b57b0348ab53f2f82657">00238</a> <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> <a class="code" href="devicestate_8h.html#ae148e0b95218b57b0348ab53f2f82657" title="Convert device state from text to integer value.">ast_devstate_val</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structval.html">val</a>)
<a name="l00239"></a>00239 {
<a name="l00240"></a>00240    <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;NOT_INUSE&quot;</span>))
<a name="l00241"></a>00241       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>;
<a name="l00242"></a>00242    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;INUSE&quot;</span>))
<a name="l00243"></a>00243       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>;
<a name="l00244"></a>00244    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;BUSY&quot;</span>))
<a name="l00245"></a>00245       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeab43afabf5bcd4ad1f531ad78c48ccb6f">AST_DEVICE_BUSY</a>;
<a name="l00246"></a>00246    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;INVALID&quot;</span>))
<a name="l00247"></a>00247       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>;
<a name="l00248"></a>00248    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;UNAVAILABLE&quot;</span>))
<a name="l00249"></a>00249       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>;
<a name="l00250"></a>00250    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;RINGING&quot;</span>))
<a name="l00251"></a>00251       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea76d91d5d654cfa3edafb2afbe3e09b46">AST_DEVICE_RINGING</a>;
<a name="l00252"></a>00252    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;RINGINUSE&quot;</span>))
<a name="l00253"></a>00253       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea17b87dfa3f4de5909b401017e229091d">AST_DEVICE_RINGINUSE</a>;
<a name="l00254"></a>00254    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(val, <span class="stringliteral">&quot;ONHOLD&quot;</span>))
<a name="l00255"></a>00255       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea6b7416bea92d3bc5ee8e36f0a484cdc1">AST_DEVICE_ONHOLD</a>;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257    <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>;
<a name="l00258"></a>00258 }
<a name="l00259"></a>00259 <span class="comment"></span>
<a name="l00260"></a>00260 <span class="comment">/*! \brief Find out if device is active in a call or not </span>
<a name="l00261"></a>00261 <span class="comment">   \note find channels with the device&apos;s name in it</span>
<a name="l00262"></a>00262 <span class="comment">   This function is only used for channels that does not implement </span>
<a name="l00263"></a>00263 <span class="comment">   devicestate natively</span>
<a name="l00264"></a>00264 <span class="comment">*/</span>
<a name="l00265"></a><a class="code" href="devicestate_8c.html#a9da9a09e65a9332176a523407ccac611">00265</a> <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> <a class="code" href="devicestate_8h.html#a9da9a09e65a9332176a523407ccac611" title="Search the Channels by Name.">ast_parse_device_state</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *device)
<a name="l00266"></a>00266 {
<a name="l00267"></a>00267    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00268"></a>00268    <span class="keywordtype">char</span> <a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">match</a>[<a class="code" href="channel_8h.html#ab57c278099ea5f8d7cedbb41eba58b56">AST_CHANNEL_NAME</a>];
<a name="l00269"></a>00269    <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> res;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(match, device, <span class="keyword">sizeof</span>(match)-1);
<a name="l00272"></a>00272    strcat(match, <span class="stringliteral">&quot;-&quot;</span>);
<a name="l00273"></a>00273    chan = <a class="code" href="channel_8h.html#a67239a95ab93867fb9da5a8b20281224" title="Get channel by name or uniqueid prefix (locks channel).">ast_get_channel_by_name_prefix_locked</a>(match, strlen(match));
<a name="l00274"></a>00274 
<a name="l00275"></a>00275    <span class="keywordflow">if</span> (!chan)
<a name="l00276"></a>00276       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a5bf03bd84f434acaeefdacb0096e1baa">AST_STATE_RINGING</a>)
<a name="l00279"></a>00279       res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea76d91d5d654cfa3edafb2afbe3e09b46">AST_DEVICE_RINGING</a>;
<a name="l00280"></a>00280    <span class="keywordflow">else</span>
<a name="l00281"></a>00281       res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>;
<a name="l00282"></a>00282    
<a name="l00283"></a>00283    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285    <span class="keywordflow">return</span> res;
<a name="l00286"></a>00286 }
<a name="l00287"></a>00287 
<a name="l00288"></a><a class="code" href="devicestate_8c.html#a4dc83bd04a1b6182961ab99f96e720cf">00288</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> <a class="code" href="devicestate_8c.html#a4dc83bd04a1b6182961ab99f96e720cf">devstate_cached</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *device)
<a name="l00289"></a>00289 {
<a name="l00290"></a>00290    <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>;
<a name="l00291"></a>00291    <span class="keyword">struct </span><a class="code" href="structast__event.html" title="An event.">ast_event</a> *event;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293    <span class="keyword">event</span> = <a class="code" href="event_8h.html#a419385710c135873656b047df8f72e7e" title="Retrieve an event from the cache.">ast_event_get_cached</a>(<a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa8900374a138e7dbbc9da893f27923846">AST_EVENT_DEVICE_STATE</a>,
<a name="l00294"></a>00294       <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a675632af9f21fe7696772885593140e3" title="Device Name Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: STR.">AST_EVENT_IE_DEVICE</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6ab82ac16f0791be2f8f918429a73430be">AST_EVENT_IE_PLTYPE_STR</a>, device,
<a name="l00295"></a>00295       <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a04c78c1362e97d548344c354001c151f">AST_EVENT_IE_END</a>);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297    <span class="keywordflow">if</span> (!event)
<a name="l00298"></a>00298       <span class="keywordflow">return</span> res;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300    res = <a class="code" href="event_8h.html#a317f6947b933acd0da82df6e9a4672e5" title="Get the value of an information element that has an integer payload.">ast_event_get_ie_uint</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a17f475640d923666e2c755e4985b61f8" title="Generic State IE Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: UINT The actual...">AST_EVENT_IE_STATE</a>);
<a name="l00301"></a>00301 
<a name="l00302"></a>00302    <a class="code" href="event_8h.html#a50b34e0161630dbbc0880a06eb78ad7a" title="Destroy an event.">ast_event_destroy</a>(event);
<a name="l00303"></a>00303 
<a name="l00304"></a>00304    <span class="keywordflow">return</span> res;
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 <span class="comment"></span>
<a name="l00307"></a>00307 <span class="comment">/*! \brief Check device state through channel specific function or generic function */</span>
<a name="l00308"></a><a class="code" href="devicestate_8c.html#ad30dfe7cd43ef4cd64feed84656a856c">00308</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> <a class="code" href="devicestate_8c.html#ad30dfe7cd43ef4cd64feed84656a856c" title="Check device state through channel specific function or generic function.">_ast_device_state</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *device, <span class="keywordtype">int</span> check_cache)
<a name="l00309"></a>00309 {
<a name="l00310"></a>00310    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l00311"></a>00311    <span class="keywordtype">char</span> *<a class="code" href="structnumber.html" title="Number structure.">number</a>;
<a name="l00312"></a>00312    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html" title="Structure to describe a channel &amp;quot;technology&amp;quot;, ie a channel driver See for...">ast_channel_tech</a> *chan_tech;
<a name="l00313"></a>00313    <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> res;<span class="comment"></span>
<a name="l00314"></a>00314 <span class="comment">   /*! \brief Channel driver that provides device state */</span>
<a name="l00315"></a>00315    <span class="keywordtype">char</span> *tech;<span class="comment"></span>
<a name="l00316"></a>00316 <span class="comment">   /*! \brief Another provider of device state */</span>
<a name="l00317"></a>00317    <span class="keywordtype">char</span> *provider = NULL;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319    <span class="comment">/* If the last known state is cached, just return that */</span>
<a name="l00320"></a>00320    <span class="keywordflow">if</span> (check_cache) {
<a name="l00321"></a>00321       res = <a class="code" href="devicestate_8c.html#a4dc83bd04a1b6182961ab99f96e720cf">devstate_cached</a>(device);
<a name="l00322"></a>00322       <span class="keywordflow">if</span> (res != <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>) {
<a name="l00323"></a>00323          <span class="keywordflow">return</span> res;
<a name="l00324"></a>00324       }
<a name="l00325"></a>00325    }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327    buf = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(device);
<a name="l00328"></a>00328    tech = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;buf, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l00329"></a>00329    <span class="keywordflow">if</span> (!(number = buf)) {
<a name="l00330"></a>00330       <span class="keywordflow">if</span> (!(provider = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tech, <span class="stringliteral">&quot;:&quot;</span>)))
<a name="l00331"></a>00331          <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>;
<a name="l00332"></a>00332       <span class="comment">/* We have a provider */</span>
<a name="l00333"></a>00333       number = tech;
<a name="l00334"></a>00334       tech = NULL;
<a name="l00335"></a>00335    }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337    <span class="keywordflow">if</span> (provider)  {
<a name="l00338"></a>00338       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Checking if I can find provider for \&quot;%s\&quot; - number: %s\n&quot;</span>, provider, number);
<a name="l00339"></a>00339       <span class="keywordflow">return</span> <a class="code" href="devicestate_8c.html#a7fbd14a6df5d1578371e19c4bb3de563" title="Get provider device state.">getproviderstate</a>(provider, number);
<a name="l00340"></a>00340    }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;No provider found, checking channel drivers for %s - %s\n&quot;</span>, tech, number);
<a name="l00343"></a>00343 
<a name="l00344"></a>00344    <span class="keywordflow">if</span> (!(chan_tech = <a class="code" href="channel_8h.html#a646e90d1a57effdd627779b93f21f4cf" title="Get a channel technology structure by name.">ast_get_channel_tech</a>(tech)))
<a name="l00345"></a>00345       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347    <span class="keywordflow">if</span> (!(chan_tech-&gt;<a class="code" href="structast__channel__tech.html#a3686404e825be25c25c6cff50970e1de">devicestate</a>)) <span class="comment">/* Does the channel driver support device state notification? */</span>
<a name="l00348"></a>00348       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#a9da9a09e65a9332176a523407ccac611" title="Search the Channels by Name.">ast_parse_device_state</a>(device); <span class="comment">/* No, try the generic function */</span>
<a name="l00349"></a>00349 
<a name="l00350"></a>00350    res = chan_tech-&gt;<a class="code" href="structast__channel__tech.html#a3686404e825be25c25c6cff50970e1de">devicestate</a>(number);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352    <span class="keywordflow">if</span> (res != <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>)
<a name="l00353"></a>00353       <span class="keywordflow">return</span> res;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355    res = <a class="code" href="devicestate_8h.html#a9da9a09e65a9332176a523407ccac611" title="Search the Channels by Name.">ast_parse_device_state</a>(device);
<a name="l00356"></a>00356 
<a name="l00357"></a>00357    <span class="keywordflow">return</span> res;
<a name="l00358"></a>00358 }
<a name="l00359"></a>00359 
<a name="l00360"></a><a class="code" href="devicestate_8c.html#a4691aa279b25aa0cb167a75bc4caa76c">00360</a> <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *device)
<a name="l00361"></a>00361 {
<a name="l00362"></a>00362    <span class="comment">/* This function is called from elsewhere in the code to find out the</span>
<a name="l00363"></a>00363 <span class="comment">    * current state of a device.  Check the cache, first. */</span>
<a name="l00364"></a>00364 
<a name="l00365"></a>00365    <span class="keywordflow">return</span> <a class="code" href="devicestate_8c.html#ad30dfe7cd43ef4cd64feed84656a856c" title="Check device state through channel specific function or generic function.">_ast_device_state</a>(device, 1);
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 <span class="comment"></span>
<a name="l00368"></a>00368 <span class="comment">/*! \brief Add device state provider */</span>
<a name="l00369"></a><a class="code" href="devicestate_8c.html#ae832fcc32c88962e73025ffeafe2961e">00369</a> <span class="keywordtype">int</span> <a class="code" href="devicestate_8h.html#ae832fcc32c88962e73025ffeafe2961e" title="Add device state provider.">ast_devstate_prov_add</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structdevstate__prov.html#a48e23fa2154347c433b24e799187ee4f">label</a>, <a class="code" href="devicestate_8h.html#a93c7236225b5fd76d197b8e5afba2de5" title="Devicestate provider call back.">ast_devstate_prov_cb_type</a> <a class="code" href="structdevstate__prov.html#a255429574a13fcf8e3deacdc16211d00">callback</a>)
<a name="l00370"></a>00370 {
<a name="l00371"></a>00371    <span class="keyword">struct </span>devstate_prov *devprov;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373    <span class="keywordflow">if</span> (!callback || !(devprov = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*devprov))))
<a name="l00374"></a>00374       <span class="keywordflow">return</span> -1;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376    devprov-&gt;<a class="code" href="structdevstate__prov.html#a255429574a13fcf8e3deacdc16211d00">callback</a> = callback;
<a name="l00377"></a>00377    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(devprov-&gt;<a class="code" href="structdevstate__prov.html#a48e23fa2154347c433b24e799187ee4f">label</a>, label, <span class="keyword">sizeof</span>(devprov-&gt;<a class="code" href="structdevstate__prov.html#a48e23fa2154347c433b24e799187ee4f">label</a>));
<a name="l00378"></a>00378 
<a name="l00379"></a>00379    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;devstate_provs);
<a name="l00380"></a>00380    <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;devstate_provs, devprov, list);
<a name="l00381"></a>00381    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;devstate_provs);
<a name="l00382"></a>00382 
<a name="l00383"></a>00383    <span class="keywordflow">return</span> 0;
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 <span class="comment"></span>
<a name="l00386"></a>00386 <span class="comment">/*! \brief Remove device state provider */</span>
<a name="l00387"></a><a class="code" href="devicestate_8c.html#a1ab579ae15aaca64a904c3c41d8b8b01">00387</a> <span class="keywordtype">int</span> <a class="code" href="devicestate_8h.html#a1ab579ae15aaca64a904c3c41d8b8b01" title="Remove device state provider.">ast_devstate_prov_del</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structdevstate__prov.html#a48e23fa2154347c433b24e799187ee4f">label</a>)
<a name="l00388"></a>00388 {
<a name="l00389"></a>00389    <span class="keyword">struct </span>devstate_prov *devcb;
<a name="l00390"></a>00390    <span class="keywordtype">int</span> res = -1;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;devstate_provs);
<a name="l00393"></a>00393    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;devstate_provs, devcb, list) {
<a name="l00394"></a>00394       <span class="keywordflow">if</span> (!strcasecmp(devcb-&gt;<a class="code" href="structdevstate__prov.html#a48e23fa2154347c433b24e799187ee4f">label</a>, label)) {
<a name="l00395"></a>00395          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(list);
<a name="l00396"></a>00396          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(devcb);
<a name="l00397"></a>00397          res = 0;
<a name="l00398"></a>00398          <span class="keywordflow">break</span>;
<a name="l00399"></a>00399       }
<a name="l00400"></a>00400    }
<a name="l00401"></a>00401    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l00402"></a>00402    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;devstate_provs);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404    <span class="keywordflow">return</span> res;
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 <span class="comment"></span>
<a name="l00407"></a>00407 <span class="comment">/*! \brief Get provider device state */</span>
<a name="l00408"></a><a class="code" href="devicestate_8c.html#a7fbd14a6df5d1578371e19c4bb3de563">00408</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="devicestate_8c.html#a7fbd14a6df5d1578371e19c4bb3de563" title="Get provider device state.">getproviderstate</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *provider, <span class="keyword">const</span> <span class="keywordtype">char</span> *address)
<a name="l00409"></a>00409 {
<a name="l00410"></a>00410    <span class="keyword">struct </span>devstate_prov *devprov;
<a name="l00411"></a>00411    <span class="keywordtype">int</span> res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;devstate_provs);
<a name="l00414"></a>00414    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;devstate_provs, devprov, list) {
<a name="l00415"></a>00415       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;Checking provider %s with %s\n&quot;</span>, devprov-&gt;<a class="code" href="structdevstate__prov.html#a48e23fa2154347c433b24e799187ee4f">label</a>, provider);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417       <span class="keywordflow">if</span> (!strcasecmp(devprov-&gt;<a class="code" href="structdevstate__prov.html#a48e23fa2154347c433b24e799187ee4f">label</a>, provider)) {
<a name="l00418"></a>00418          res = devprov-&gt;<a class="code" href="structdevstate__prov.html#a255429574a13fcf8e3deacdc16211d00">callback</a>(address);
<a name="l00419"></a>00419          <span class="keywordflow">break</span>;
<a name="l00420"></a>00420       }
<a name="l00421"></a>00421    }
<a name="l00422"></a>00422    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;devstate_provs);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424    <span class="keywordflow">return</span> res;
<a name="l00425"></a>00425 }
<a name="l00426"></a>00426 
<a name="l00427"></a><a class="code" href="devicestate_8c.html#a87e192ec02bfdad7363a0afd21163d97">00427</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="devicestate_8c.html#a87e192ec02bfdad7363a0afd21163d97">devstate_event</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *device, <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> state)
<a name="l00428"></a>00428 {
<a name="l00429"></a>00429    <span class="keyword">struct </span><a class="code" href="structast__event.html" title="An event.">ast_event</a> *event;
<a name="l00430"></a>00430    <span class="keyword">enum</span> <a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79f" title="Event types.">ast_event_type</a> event_type;
<a name="l00431"></a>00431 
<a name="l00432"></a>00432    <span class="keywordflow">if</span> (<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.enabled) {
<a name="l00433"></a>00433       <span class="comment">/* Distributed device state is enabled, so this state change is a change</span>
<a name="l00434"></a>00434 <span class="comment">       * for a single server, not the real state. */</span>
<a name="l00435"></a>00435       event_type = <a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa641bc805cee9b8829fa265e566df9d58">AST_EVENT_DEVICE_STATE_CHANGE</a>;
<a name="l00436"></a>00436    } <span class="keywordflow">else</span> {
<a name="l00437"></a>00437       event_type = <a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa8900374a138e7dbbc9da893f27923846">AST_EVENT_DEVICE_STATE</a>;
<a name="l00438"></a>00438    }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;device &apos;%s&apos; state &apos;%d&apos;\n&quot;</span>, device, state);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442    <span class="keywordflow">if</span> (!(event = <a class="code" href="event_8h.html#afb4a2a00de28bb0733037060da8c4bac" title="Create a new event.">ast_event_new</a>(event_type,
<a name="l00443"></a>00443          <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a675632af9f21fe7696772885593140e3" title="Device Name Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: STR.">AST_EVENT_IE_DEVICE</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6ab82ac16f0791be2f8f918429a73430be">AST_EVENT_IE_PLTYPE_STR</a>, device,
<a name="l00444"></a>00444          <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a17f475640d923666e2c755e4985b61f8" title="Generic State IE Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: UINT The actual...">AST_EVENT_IE_STATE</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6a4647cbfacd475cb5067f9f9906107641">AST_EVENT_IE_PLTYPE_UINT</a>, state,
<a name="l00445"></a>00445          <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a04c78c1362e97d548344c354001c151f">AST_EVENT_IE_END</a>))) {
<a name="l00446"></a>00446       <span class="keywordflow">return</span>;
<a name="l00447"></a>00447    }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449    <a class="code" href="event_8h.html#a5ef4e1053ab8a91ebdcf4dd6ad1c81c4" title="Queue and cache an event.">ast_event_queue_and_cache</a>(event);
<a name="l00450"></a>00450 }
<a name="l00451"></a>00451 <span class="comment"></span>
<a name="l00452"></a>00452 <span class="comment">/*! Called by the state change thread to find out what the state is, and then</span>
<a name="l00453"></a>00453 <span class="comment"> *  to queue up the state change event */</span>
<a name="l00454"></a><a class="code" href="devicestate_8c.html#accc5f57962e9a0e3bbf8d7c2046525f7">00454</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="devicestate_8c.html#accc5f57962e9a0e3bbf8d7c2046525f7">do_state_change</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *device)
<a name="l00455"></a>00455 {
<a name="l00456"></a>00456    <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> state;
<a name="l00457"></a>00457 
<a name="l00458"></a>00458    state = <a class="code" href="devicestate_8c.html#ad30dfe7cd43ef4cd64feed84656a856c" title="Check device state through channel specific function or generic function.">_ast_device_state</a>(device, 0);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Changing state for %s - state %d (%s)\n&quot;</span>, device, state, <a class="code" href="devicestate_8h.html#ac3a57910a6eb04d12d793fe3df796b8e" title="Find devicestate as text message for output.">ast_devstate2str</a>(state));
<a name="l00461"></a>00461 
<a name="l00462"></a>00462    <a class="code" href="devicestate_8c.html#a87e192ec02bfdad7363a0afd21163d97">devstate_event</a>(device, state);
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00465"></a><a class="code" href="devicestate_8c.html#a0cc33ebff1ed76c113d17785814b5a47">00465</a> <span class="keywordtype">int</span> <a class="code" href="devicestate_8h.html#a0cc33ebff1ed76c113d17785814b5a47" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed_literal</a>(<span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> state, <span class="keyword">const</span> <span class="keywordtype">char</span> *device)
<a name="l00466"></a>00466 {
<a name="l00467"></a>00467    <span class="keyword">struct </span>state_change *change;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469    <span class="comment">/* </span>
<a name="l00470"></a>00470 <span class="comment">    * If we know the state change (how nice of the caller of this function!)</span>
<a name="l00471"></a>00471 <span class="comment">    * then we can just generate a device state event. </span>
<a name="l00472"></a>00472 <span class="comment">    *</span>
<a name="l00473"></a>00473 <span class="comment">    * Otherwise, we do the following:</span>
<a name="l00474"></a>00474 <span class="comment">    *   - Queue an event up to another thread that the state has changed</span>
<a name="l00475"></a>00475 <span class="comment">    *   - In the processing thread, it calls the callback provided by the</span>
<a name="l00476"></a>00476 <span class="comment">    *     device state provider (which may or may not be a channel driver)</span>
<a name="l00477"></a>00477 <span class="comment">    *     to determine the state.</span>
<a name="l00478"></a>00478 <span class="comment">    *   - If the device state provider does not know the state, or this is</span>
<a name="l00479"></a>00479 <span class="comment">    *     for a channel and the channel driver does not implement a device</span>
<a name="l00480"></a>00480 <span class="comment">    *     state callback, then we will look through the channel list to</span>
<a name="l00481"></a>00481 <span class="comment">    *     see if we can determine a state based on active calls.</span>
<a name="l00482"></a>00482 <span class="comment">    *   - Once a state has been determined, a device state event is generated.</span>
<a name="l00483"></a>00483 <span class="comment">    */</span>
<a name="l00484"></a>00484 
<a name="l00485"></a>00485    <span class="keywordflow">if</span> (state != <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>) {
<a name="l00486"></a>00486       <a class="code" href="devicestate_8c.html#a87e192ec02bfdad7363a0afd21163d97">devstate_event</a>(device, state);
<a name="l00487"></a>00487    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="devicestate_8c.html#a767b566dd113e1ee0de1634e07c5618d" title="The device state change notification thread.">change_thread</a> == AST_PTHREADT_NULL || !(change = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*change) + strlen(device)))) {
<a name="l00488"></a>00488       <span class="comment">/* we could not allocate a change struct, or */</span>
<a name="l00489"></a>00489       <span class="comment">/* there is no background thread, so process the change now */</span>
<a name="l00490"></a>00490       <a class="code" href="devicestate_8c.html#accc5f57962e9a0e3bbf8d7c2046525f7">do_state_change</a>(device);
<a name="l00491"></a>00491    } <span class="keywordflow">else</span> {
<a name="l00492"></a>00492       <span class="comment">/* queue the change */</span>
<a name="l00493"></a>00493       strcpy(change-&gt;<a class="code" href="structstate__change.html#ad4a4f6bb9638907e0d14b2d8b05c86a0">device</a>, device);
<a name="l00494"></a>00494       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;state_changes);
<a name="l00495"></a>00495       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;state_changes, change, list);
<a name="l00496"></a>00496       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;change_pending);
<a name="l00497"></a>00497       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;state_changes);
<a name="l00498"></a>00498    }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500    <span class="keywordflow">return</span> 1;
<a name="l00501"></a>00501 }
<a name="l00502"></a>00502 
<a name="l00503"></a><a class="code" href="devicestate_8c.html#a660c973250fcf7b5f7a389e6fc36257b">00503</a> <span class="keywordtype">int</span> <a class="code" href="devicestate_8h.html#a1c5845c2bf63a18da29eec8de9d50d18" title="Tells Asterisk the State for Device is changed.">ast_device_state_changed_literal</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *dev)
<a name="l00504"></a>00504 {
<a name="l00505"></a>00505    <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#a0cc33ebff1ed76c113d17785814b5a47" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed_literal</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>, dev);
<a name="l00506"></a>00506 }
<a name="l00507"></a>00507 
<a name="l00508"></a><a class="code" href="devicestate_8c.html#ac91fd8b93a2095c18ab86bd61c19ae46">00508</a> <span class="keywordtype">int</span> <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> state, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...) 
<a name="l00509"></a>00509 {
<a name="l00510"></a>00510    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l00511"></a>00511    va_list ap;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513    va_start(ap, fmt);
<a name="l00514"></a>00514    vsnprintf(buf, <span class="keyword">sizeof</span>(buf), fmt, ap);
<a name="l00515"></a>00515    va_end(ap);
<a name="l00516"></a>00516 
<a name="l00517"></a>00517    <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#a0cc33ebff1ed76c113d17785814b5a47" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed_literal</a>(state, buf);
<a name="l00518"></a>00518 }
<a name="l00519"></a>00519 
<a name="l00520"></a><a class="code" href="devicestate_8c.html#a0d1e5bc5582dc40fc828a8d7f45c8796">00520</a> <span class="keywordtype">int</span> <a class="code" href="devicestate_8h.html#a0d1e5bc5582dc40fc828a8d7f45c8796" title="Tells Asterisk the State for Device is changed. (Accept change notification, add...">ast_device_state_changed</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...) 
<a name="l00521"></a>00521 {
<a name="l00522"></a>00522    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l00523"></a>00523    va_list ap;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525    va_start(ap, fmt);
<a name="l00526"></a>00526    vsnprintf(buf, <span class="keyword">sizeof</span>(buf), fmt, ap);
<a name="l00527"></a>00527    va_end(ap);
<a name="l00528"></a>00528 
<a name="l00529"></a>00529    <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#a0cc33ebff1ed76c113d17785814b5a47" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed_literal</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>, buf);
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 <span class="comment"></span>
<a name="l00532"></a>00532 <span class="comment">/*! \brief Go through the dev state change queue and update changes in the dev state thread */</span>
<a name="l00533"></a><a class="code" href="devicestate_8c.html#ad9f83f8d47fb83b4ccff95cb88f43d2b">00533</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="devicestate_8c.html#ad9f83f8d47fb83b4ccff95cb88f43d2b" title="Go through the dev state change queue and update changes in the dev state thread...">do_devstate_changes</a>(<span class="keywordtype">void</span> *data)
<a name="l00534"></a>00534 {
<a name="l00535"></a>00535    <span class="keyword">struct </span>state_change *<a class="code" href="structdevstate__prov.html#a29c30c4438a1b71acd896b9a3e2093ec">next</a>, *current;
<a name="l00536"></a>00536 
<a name="l00537"></a>00537    <span class="keywordflow">for</span> (;;) {
<a name="l00538"></a>00538       <span class="comment">/* This basically pops off any state change entries, resets the list back to NULL, unlocks, and processes each state change */</span>
<a name="l00539"></a>00539       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;state_changes);
<a name="l00540"></a>00540       <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;state_changes))
<a name="l00541"></a>00541          <a class="code" href="lock_8h.html#ae454b1ebfb5f5e9948876d470865d9dc">ast_cond_wait</a>(&amp;change_pending, &amp;state_changes.lock);
<a name="l00542"></a>00542       next = <a class="code" href="linkedlists_8h.html#adf1959c5c03a3a706da97ad2f49617e5" title="Returns the first entry contained in a list.">AST_LIST_FIRST</a>(&amp;state_changes);
<a name="l00543"></a>00543       <a class="code" href="linkedlists_8h.html#a0d1f922e093ac18824a7863fe3f5fa27" title="Initializes a list head structure.">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;state_changes);
<a name="l00544"></a>00544       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;state_changes);
<a name="l00545"></a>00545 
<a name="l00546"></a>00546       <span class="comment">/* Process each state change */</span>
<a name="l00547"></a>00547       <span class="keywordflow">while</span> ((current = next)) {
<a name="l00548"></a>00548          next = <a class="code" href="linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6" title="Returns the next entry in the list after the given entry.">AST_LIST_NEXT</a>(current, list);
<a name="l00549"></a>00549          <a class="code" href="devicestate_8c.html#accc5f57962e9a0e3bbf8d7c2046525f7">do_state_change</a>(current-&gt;<a class="code" href="structstate__change.html#ad4a4f6bb9638907e0d14b2d8b05c86a0">device</a>);
<a name="l00550"></a>00550          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(current);
<a name="l00551"></a>00551       }
<a name="l00552"></a>00552    }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554    <span class="keywordflow">return</span> NULL;
<a name="l00555"></a>00555 }
<a name="l00556"></a>00556 
<a name="l00557"></a><a class="code" href="devicestate_8c.html#ad157407a4e75e687610159a1676d00db">00557</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="devicestate_8c.html#ad157407a4e75e687610159a1676d00db">destroy_devstate_change</a>(<span class="keyword">struct</span> devstate_change *sc)
<a name="l00558"></a>00558 {
<a name="l00559"></a>00559    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sc);
<a name="l00560"></a>00560 }
<a name="l00561"></a>00561 
<a name="l00562"></a><a class="code" href="devicestate_8c.html#aaf8d2ae1c0e1c6413c3a70c4526ace9f">00562</a> <span class="preprocessor">#define MAX_SERVERS 64</span>
<a name="l00563"></a><a class="code" href="structchange__collection.html">00563</a> <span class="preprocessor"></span><span class="keyword">struct </span><a class="code" href="structchange__collection.html">change_collection</a> {
<a name="l00564"></a><a class="code" href="structchange__collection.html#a3e7c6ab9bc81f5914ac435c09412615f">00564</a>    <span class="keyword">struct </span>devstate_change states[<a class="code" href="devicestate_8c.html#aaf8d2ae1c0e1c6413c3a70c4526ace9f">MAX_SERVERS</a>];
<a name="l00565"></a><a class="code" href="structchange__collection.html#a5e034d2106494002b7f00bf09e9e6982">00565</a>    <span class="keywordtype">size_t</span> num_states;
<a name="l00566"></a>00566 };
<a name="l00567"></a>00567 
<a name="l00568"></a><a class="code" href="devicestate_8c.html#ab22d051f46950c0eb53bbafd489357ec">00568</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="devicestate_8c.html#ab22d051f46950c0eb53bbafd489357ec">devstate_cache_cb</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__event.html" title="An event.">ast_event</a> *event, <span class="keywordtype">void</span> *data)
<a name="l00569"></a>00569 {
<a name="l00570"></a>00570    <span class="keyword">struct </span><a class="code" href="structchange__collection.html">change_collection</a> *collection = data;
<a name="l00571"></a>00571    <span class="keywordtype">int</span> i;
<a name="l00572"></a>00572    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__eid.html" title="An Entity ID is essentially a MAC address, brief and unique.">ast_eid</a> *eid;
<a name="l00573"></a>00573 
<a name="l00574"></a>00574    <span class="keywordflow">if</span> (collection-&gt;<a class="code" href="structchange__collection.html#a5e034d2106494002b7f00bf09e9e6982">num_states</a> == <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(collection-&gt;<a class="code" href="structchange__collection.html#a3e7c6ab9bc81f5914ac435c09412615f">states</a>)) {
<a name="l00575"></a>00575       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;More per-server state values than we have room for (MAX_SERVERS is %d)\n&quot;</span>,
<a name="l00576"></a>00576          <a class="code" href="devicestate_8c.html#aaf8d2ae1c0e1c6413c3a70c4526ace9f">MAX_SERVERS</a>);
<a name="l00577"></a>00577       <span class="keywordflow">return</span>;
<a name="l00578"></a>00578    }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580    <span class="keywordflow">if</span> (!(eid = <a class="code" href="event_8h.html#acaf805e5e914c76e884a5722efd2c0da" title="Get the value of an information element that has a raw payload.">ast_event_get_ie_raw</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a8e38c9805132c95123e80568ba508b17" title="Entity ID Used by All events Payload type: RAW This IE indicates which server the...">AST_EVENT_IE_EID</a>))) {
<a name="l00581"></a>00581       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Device state change event with no EID\n&quot;</span>);
<a name="l00582"></a>00582       <span class="keywordflow">return</span>;
<a name="l00583"></a>00583    }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585    i = collection-&gt;<a class="code" href="structchange__collection.html#a5e034d2106494002b7f00bf09e9e6982">num_states</a>;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587    collection-&gt;<a class="code" href="structchange__collection.html#a3e7c6ab9bc81f5914ac435c09412615f">states</a>[i].<a class="code" href="structdevstate__change.html#a1b0c7bd4d79798ef4e0ce23894c9aeb2">state</a> = <a class="code" href="event_8h.html#a317f6947b933acd0da82df6e9a4672e5" title="Get the value of an information element that has an integer payload.">ast_event_get_ie_uint</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a17f475640d923666e2c755e4985b61f8" title="Generic State IE Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: UINT The actual...">AST_EVENT_IE_STATE</a>);
<a name="l00588"></a>00588    collection-&gt;<a class="code" href="structchange__collection.html#a3e7c6ab9bc81f5914ac435c09412615f">states</a>[i].<a class="code" href="structdevstate__change.html#aa1d7e6e6eb6d297e62f2d79dbdfaafb4">eid</a> = *eid;
<a name="l00589"></a>00589 
<a name="l00590"></a>00590    collection-&gt;<a class="code" href="structchange__collection.html#a5e034d2106494002b7f00bf09e9e6982">num_states</a>++;
<a name="l00591"></a>00591 }
<a name="l00592"></a>00592 
<a name="l00593"></a><a class="code" href="devicestate_8c.html#a80b936b6f745e6913eb31c063aa851c5">00593</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="devicestate_8c.html#a80b936b6f745e6913eb31c063aa851c5">process_collection</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *device, <span class="keyword">struct</span> <a class="code" href="structchange__collection.html">change_collection</a> *collection)
<a name="l00594"></a>00594 {
<a name="l00595"></a>00595    <span class="keywordtype">int</span> i;
<a name="l00596"></a>00596    <span class="keyword">struct </span><a class="code" href="structast__devstate__aggregate.html" title="You shouldn&amp;#39;t care about the contents of this struct.">ast_devstate_aggregate</a> agg;
<a name="l00597"></a>00597    <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> state;
<a name="l00598"></a>00598    <span class="keyword">struct </span><a class="code" href="structast__event.html" title="An event.">ast_event</a> *event;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600    <a class="code" href="devicestate_8h.html#a65ebe8f28497b09769ab9edeb4eb9b86" title="Initialize aggregate device state.">ast_devstate_aggregate_init</a>(&amp;agg);
<a name="l00601"></a>00601 
<a name="l00602"></a>00602    <span class="keywordflow">for</span> (i = 0; i &lt; collection-&gt;<a class="code" href="structchange__collection.html#a5e034d2106494002b7f00bf09e9e6982">num_states</a>; i++) {
<a name="l00603"></a>00603       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Adding per-server state of &apos;%s&apos; for &apos;%s&apos;\n&quot;</span>, 
<a name="l00604"></a>00604          <a class="code" href="devicestate_8h.html#ac3a57910a6eb04d12d793fe3df796b8e" title="Find devicestate as text message for output.">ast_devstate2str</a>(collection-&gt;<a class="code" href="structchange__collection.html#a3e7c6ab9bc81f5914ac435c09412615f">states</a>[i].<a class="code" href="structdevstate__change.html#a1b0c7bd4d79798ef4e0ce23894c9aeb2">state</a>), device);
<a name="l00605"></a>00605       <a class="code" href="devicestate_8h.html#a45534707838d05125f409430b371854a" title="Add a device state to the aggregate device state.">ast_devstate_aggregate_add</a>(&amp;agg, collection-&gt;<a class="code" href="structchange__collection.html#a3e7c6ab9bc81f5914ac435c09412615f">states</a>[i].<a class="code" href="structdevstate__change.html#a1b0c7bd4d79798ef4e0ce23894c9aeb2">state</a>);
<a name="l00606"></a>00606    }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608    state = <a class="code" href="devicestate_8h.html#a852d7e936d4385c3bb903812de5d6403" title="Get the aggregate device state result.">ast_devstate_aggregate_result</a>(&amp;agg);
<a name="l00609"></a>00609 
<a name="l00610"></a>00610    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Aggregate devstate result is %d\n&quot;</span>, state);
<a name="l00611"></a>00611 
<a name="l00612"></a>00612    <span class="keyword">event</span> = <a class="code" href="event_8h.html#a419385710c135873656b047df8f72e7e" title="Retrieve an event from the cache.">ast_event_get_cached</a>(<a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa8900374a138e7dbbc9da893f27923846">AST_EVENT_DEVICE_STATE</a>,
<a name="l00613"></a>00613       <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a675632af9f21fe7696772885593140e3" title="Device Name Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: STR.">AST_EVENT_IE_DEVICE</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6ab82ac16f0791be2f8f918429a73430be">AST_EVENT_IE_PLTYPE_STR</a>, device,
<a name="l00614"></a>00614       <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a04c78c1362e97d548344c354001c151f">AST_EVENT_IE_END</a>);
<a name="l00615"></a>00615    
<a name="l00616"></a>00616    <span class="keywordflow">if</span> (event) {
<a name="l00617"></a>00617       <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> old_state;
<a name="l00618"></a>00618 
<a name="l00619"></a>00619       old_state = <a class="code" href="event_8h.html#a317f6947b933acd0da82df6e9a4672e5" title="Get the value of an information element that has an integer payload.">ast_event_get_ie_uint</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a17f475640d923666e2c755e4985b61f8" title="Generic State IE Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: UINT The actual...">AST_EVENT_IE_STATE</a>);
<a name="l00620"></a>00620       
<a name="l00621"></a>00621       <a class="code" href="event_8h.html#a50b34e0161630dbbc0880a06eb78ad7a" title="Destroy an event.">ast_event_destroy</a>(event);
<a name="l00622"></a>00622 
<a name="l00623"></a>00623       <span class="keywordflow">if</span> (state == old_state) {
<a name="l00624"></a>00624          <span class="comment">/* No change since last reported device state */</span>
<a name="l00625"></a>00625          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Aggregate state for device &apos;%s&apos; has not changed from &apos;%s&apos;\n&quot;</span>,
<a name="l00626"></a>00626             device, <a class="code" href="devicestate_8h.html#ac3a57910a6eb04d12d793fe3df796b8e" title="Find devicestate as text message for output.">ast_devstate2str</a>(state));
<a name="l00627"></a>00627          <span class="keywordflow">return</span>;
<a name="l00628"></a>00628       }
<a name="l00629"></a>00629    }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Aggregate state for device &apos;%s&apos; has changed to &apos;%s&apos;\n&quot;</span>,
<a name="l00632"></a>00632       device, <a class="code" href="devicestate_8h.html#ac3a57910a6eb04d12d793fe3df796b8e" title="Find devicestate as text message for output.">ast_devstate2str</a>(state));
<a name="l00633"></a>00633 
<a name="l00634"></a>00634    <span class="keyword">event</span> = <a class="code" href="event_8h.html#afb4a2a00de28bb0733037060da8c4bac" title="Create a new event.">ast_event_new</a>(<a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa8900374a138e7dbbc9da893f27923846">AST_EVENT_DEVICE_STATE</a>,
<a name="l00635"></a>00635       <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a675632af9f21fe7696772885593140e3" title="Device Name Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: STR.">AST_EVENT_IE_DEVICE</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6ab82ac16f0791be2f8f918429a73430be">AST_EVENT_IE_PLTYPE_STR</a>, device,
<a name="l00636"></a>00636       <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a17f475640d923666e2c755e4985b61f8" title="Generic State IE Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: UINT The actual...">AST_EVENT_IE_STATE</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6a4647cbfacd475cb5067f9f9906107641">AST_EVENT_IE_PLTYPE_UINT</a>, state,
<a name="l00637"></a>00637       <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a04c78c1362e97d548344c354001c151f">AST_EVENT_IE_END</a>);
<a name="l00638"></a>00638 
<a name="l00639"></a>00639    <span class="keywordflow">if</span> (!event) {
<a name="l00640"></a>00640       <span class="keywordflow">return</span>;
<a name="l00641"></a>00641    }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643    <a class="code" href="event_8h.html#a5ef4e1053ab8a91ebdcf4dd6ad1c81c4" title="Queue and cache an event.">ast_event_queue_and_cache</a>(event);
<a name="l00644"></a>00644 }
<a name="l00645"></a>00645 
<a name="l00646"></a><a class="code" href="devicestate_8c.html#a1d87ddbf9d7aa9d6aaf93690de3faa5d">00646</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="devicestate_8c.html#a1d87ddbf9d7aa9d6aaf93690de3faa5d">handle_devstate_change</a>(<span class="keyword">struct</span> devstate_change *sc)
<a name="l00647"></a>00647 {
<a name="l00648"></a>00648    <span class="keyword">struct </span><a class="code" href="structast__event__sub.html" title="Event subscription.">ast_event_sub</a> *tmp_sub;
<a name="l00649"></a>00649    <span class="keyword">struct </span><a class="code" href="structchange__collection.html">change_collection</a> collection = {
<a name="l00650"></a>00650       .<a class="code" href="structchange__collection.html#a5e034d2106494002b7f00bf09e9e6982">num_states</a> = 0,
<a name="l00651"></a>00651    };
<a name="l00652"></a>00652 
<a name="l00653"></a>00653    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Processing device state change for &apos;%s&apos;\n&quot;</span>, sc-&gt;<a class="code" href="structdevstate__change.html#ad4a4f6bb9638907e0d14b2d8b05c86a0">device</a>);
<a name="l00654"></a>00654 
<a name="l00655"></a>00655    <span class="keywordflow">if</span> (!(tmp_sub = <a class="code" href="event_8h.html#abbf3a2d3f2ccc44cd6a8864e5b95600c" title="Allocate a subscription, but do not activate it.">ast_event_subscribe_new</a>(<a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa641bc805cee9b8829fa265e566df9d58">AST_EVENT_DEVICE_STATE_CHANGE</a>, <a class="code" href="devicestate_8c.html#ab22d051f46950c0eb53bbafd489357ec">devstate_cache_cb</a>, &amp;collection))) {
<a name="l00656"></a>00656       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to create subscription\n&quot;</span>);
<a name="l00657"></a>00657       <span class="keywordflow">return</span>;
<a name="l00658"></a>00658    }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660    <span class="keywordflow">if</span> (<a class="code" href="event_8h.html#a5f74d5a16df9f79c01741ebd6c00988c" title="Append a string parameter to a subscription.">ast_event_sub_append_ie_str</a>(tmp_sub, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a675632af9f21fe7696772885593140e3" title="Device Name Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: STR.">AST_EVENT_IE_DEVICE</a>, sc-&gt;<a class="code" href="structdevstate__change.html#ad4a4f6bb9638907e0d14b2d8b05c86a0">device</a>)) {
<a name="l00661"></a>00661       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to append device IE\n&quot;</span>);
<a name="l00662"></a>00662       <a class="code" href="event_8h.html#a46f2b4218be0062cf49cfcf7b0b810f3" title="Destroy an allocated subscription.">ast_event_sub_destroy</a>(tmp_sub);
<a name="l00663"></a>00663       <span class="keywordflow">return</span>;
<a name="l00664"></a>00664    }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666    <span class="comment">/* Populate the collection of device states from the cache */</span>
<a name="l00667"></a>00667    <a class="code" href="event_8h.html#a5bf46b1495a96ddf1de399a324795ddc" title="Dump the event cache for the subscriber.">ast_event_dump_cache</a>(tmp_sub);
<a name="l00668"></a>00668 
<a name="l00669"></a>00669    <a class="code" href="devicestate_8c.html#a80b936b6f745e6913eb31c063aa851c5">process_collection</a>(sc-&gt;<a class="code" href="structdevstate__change.html#ad4a4f6bb9638907e0d14b2d8b05c86a0">device</a>, &amp;collection);
<a name="l00670"></a>00670 
<a name="l00671"></a>00671    <a class="code" href="event_8h.html#a46f2b4218be0062cf49cfcf7b0b810f3" title="Destroy an allocated subscription.">ast_event_sub_destroy</a>(tmp_sub);
<a name="l00672"></a>00672 }
<a name="l00673"></a>00673 
<a name="l00674"></a><a class="code" href="devicestate_8c.html#aba2b4557d1f67626534da2a47d3ad39e">00674</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="devicestate_8c.html#aba2b4557d1f67626534da2a47d3ad39e">run_devstate_collector</a>(<span class="keywordtype">void</span> *data)
<a name="l00675"></a>00675 {
<a name="l00676"></a>00676    <span class="keywordflow">for</span> (;;) {
<a name="l00677"></a>00677       <span class="keyword">struct </span>devstate_change *sc;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.lock);
<a name="l00680"></a>00680       <span class="keywordflow">while</span> (!(sc = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.devstate_change_q, entry)))
<a name="l00681"></a>00681          <a class="code" href="lock_8h.html#ae454b1ebfb5f5e9948876d470865d9dc">ast_cond_wait</a>(&amp;<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.cond, &amp;<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.lock);
<a name="l00682"></a>00682       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.lock);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684       <a class="code" href="devicestate_8c.html#a1d87ddbf9d7aa9d6aaf93690de3faa5d">handle_devstate_change</a>(sc);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686       <a class="code" href="devicestate_8c.html#ad157407a4e75e687610159a1676d00db">destroy_devstate_change</a>(sc);
<a name="l00687"></a>00687    }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689    <span class="keywordflow">return</span> NULL;
<a name="l00690"></a>00690 }
<a name="l00691"></a>00691 
<a name="l00692"></a><a class="code" href="devicestate_8c.html#a6328f4d8f6d6b35b38f2acb39258cd2f">00692</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="devicestate_8c.html#a6328f4d8f6d6b35b38f2acb39258cd2f">devstate_change_collector_cb</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__event.html" title="An event.">ast_event</a> *event, <span class="keywordtype">void</span> *data)
<a name="l00693"></a>00693 {
<a name="l00694"></a>00694    <span class="keyword">struct </span>devstate_change *sc;
<a name="l00695"></a>00695    <span class="keyword">const</span> <span class="keywordtype">char</span> *device;
<a name="l00696"></a>00696    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__eid.html" title="An Entity ID is essentially a MAC address, brief and unique.">ast_eid</a> *eid;
<a name="l00697"></a>00697    uint32_t state;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699    device = <a class="code" href="event_8h.html#a0cfdd21162f4795714da583c31477151" title="Get the value of an information element that has a string payload.">ast_event_get_ie_str</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a675632af9f21fe7696772885593140e3" title="Device Name Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: STR.">AST_EVENT_IE_DEVICE</a>);
<a name="l00700"></a>00700    eid = <a class="code" href="event_8h.html#acaf805e5e914c76e884a5722efd2c0da" title="Get the value of an information element that has a raw payload.">ast_event_get_ie_raw</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a8e38c9805132c95123e80568ba508b17" title="Entity ID Used by All events Payload type: RAW This IE indicates which server the...">AST_EVENT_IE_EID</a>);
<a name="l00701"></a>00701    state = <a class="code" href="event_8h.html#a317f6947b933acd0da82df6e9a4672e5" title="Get the value of an information element that has an integer payload.">ast_event_get_ie_uint</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a17f475640d923666e2c755e4985b61f8" title="Generic State IE Used by AST_EVENT_DEVICE_STATE_CHANGE Payload type: UINT The actual...">AST_EVENT_IE_STATE</a>);
<a name="l00702"></a>00702 
<a name="l00703"></a>00703    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(device) || !eid) {
<a name="l00704"></a>00704       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid device state change event received\n&quot;</span>);
<a name="l00705"></a>00705       <span class="keywordflow">return</span>;
<a name="l00706"></a>00706    }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708    <span class="keywordflow">if</span> (!(sc = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*sc) + strlen(device))))
<a name="l00709"></a>00709       <span class="keywordflow">return</span>;
<a name="l00710"></a>00710 
<a name="l00711"></a>00711    strcpy(sc-&gt;<a class="code" href="structdevstate__change.html#ad4a4f6bb9638907e0d14b2d8b05c86a0">device</a>, device);
<a name="l00712"></a>00712    sc-&gt;<a class="code" href="structdevstate__change.html#aa1d7e6e6eb6d297e62f2d79dbdfaafb4">eid</a> = *eid;
<a name="l00713"></a>00713    sc-&gt;<a class="code" href="structdevstate__change.html#a1b0c7bd4d79798ef4e0ce23894c9aeb2">state</a> = state;
<a name="l00714"></a>00714 
<a name="l00715"></a>00715    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.lock);
<a name="l00716"></a>00716    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.devstate_change_q, sc, entry);
<a name="l00717"></a>00717    <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.cond);
<a name="l00718"></a>00718    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.lock);
<a name="l00719"></a>00719 }
<a name="l00720"></a>00720 <span class="comment"></span>
<a name="l00721"></a>00721 <span class="comment">/*! \brief Initialize the device state engine in separate thread */</span>
<a name="l00722"></a><a class="code" href="devicestate_8c.html#a1613dc2954f81c1131ad5acd24c1e574">00722</a> <span class="keywordtype">int</span> <a class="code" href="__private_8h.html#a1613dc2954f81c1131ad5acd24c1e574" title="Initialize the device state engine in separate thread.">ast_device_state_engine_init</a>(<span class="keywordtype">void</span>)
<a name="l00723"></a>00723 {
<a name="l00724"></a>00724    <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;change_pending, NULL);
<a name="l00725"></a>00725    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;<a class="code" href="devicestate_8c.html#a767b566dd113e1ee0de1634e07c5618d" title="The device state change notification thread.">change_thread</a>, NULL, <a class="code" href="devicestate_8c.html#ad9f83f8d47fb83b4ccff95cb88f43d2b" title="Go through the dev state change queue and update changes in the dev state thread...">do_devstate_changes</a>, NULL) &lt; 0) {
<a name="l00726"></a>00726       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to start device state change thread.\n&quot;</span>);
<a name="l00727"></a>00727       <span class="keywordflow">return</span> -1;
<a name="l00728"></a>00728    }
<a name="l00729"></a>00729 
<a name="l00730"></a>00730    <span class="keywordflow">return</span> 0;
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00733"></a><a class="code" href="devicestate_8c.html#a65ebe8f28497b09769ab9edeb4eb9b86">00733</a> <span class="keywordtype">void</span> <a class="code" href="devicestate_8h.html#a65ebe8f28497b09769ab9edeb4eb9b86" title="Initialize aggregate device state.">ast_devstate_aggregate_init</a>(<span class="keyword">struct</span> <a class="code" href="structast__devstate__aggregate.html" title="You shouldn&amp;#39;t care about the contents of this struct.">ast_devstate_aggregate</a> *agg)
<a name="l00734"></a>00734 {
<a name="l00735"></a>00735    memset(agg, 0, <span class="keyword">sizeof</span>(*agg));
<a name="l00736"></a>00736 
<a name="l00737"></a>00737    agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a89222ce0f74e56a855e1be89537fdb02">all_unknown</a> = 1;
<a name="l00738"></a>00738    agg-&gt;<a class="code" href="structast__devstate__aggregate.html#aec50b9db1640cefa9c219d63e1b7ade4">all_unavail</a> = 1;
<a name="l00739"></a>00739    agg-&gt;<a class="code" href="structast__devstate__aggregate.html#af7df3d089a03d0acb4e8e18c28d58700">all_busy</a> = 1;
<a name="l00740"></a>00740    agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a7dcbb2425e6da769d44603778432db0f">all_free</a> = 1;
<a name="l00741"></a>00741 }
<a name="l00742"></a>00742 
<a name="l00743"></a><a class="code" href="devicestate_8c.html#a45534707838d05125f409430b371854a">00743</a> <span class="keywordtype">void</span> <a class="code" href="devicestate_8h.html#a45534707838d05125f409430b371854a" title="Add a device state to the aggregate device state.">ast_devstate_aggregate_add</a>(<span class="keyword">struct</span> <a class="code" href="structast__devstate__aggregate.html" title="You shouldn&amp;#39;t care about the contents of this struct.">ast_devstate_aggregate</a> *agg, <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> state)
<a name="l00744"></a>00744 {
<a name="l00745"></a>00745    <span class="keywordflow">switch</span> (state) {
<a name="l00746"></a>00746    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>:
<a name="l00747"></a>00747       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a89222ce0f74e56a855e1be89537fdb02">all_unknown</a> = 0;
<a name="l00748"></a>00748       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#aec50b9db1640cefa9c219d63e1b7ade4">all_unavail</a> = 0;
<a name="l00749"></a>00749       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#af7df3d089a03d0acb4e8e18c28d58700">all_busy</a> = 0;
<a name="l00750"></a>00750       <span class="keywordflow">break</span>;
<a name="l00751"></a>00751    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>:
<a name="l00752"></a>00752       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#ae90f2e4a448082950b7e1e7a7a508464">in_use</a> = 1;
<a name="l00753"></a>00753       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#aec50b9db1640cefa9c219d63e1b7ade4">all_unavail</a> = 0;
<a name="l00754"></a>00754       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a7dcbb2425e6da769d44603778432db0f">all_free</a> = 0;
<a name="l00755"></a>00755       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a89222ce0f74e56a855e1be89537fdb02">all_unknown</a> = 0;
<a name="l00756"></a>00756       <span class="keywordflow">break</span>;
<a name="l00757"></a>00757    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea76d91d5d654cfa3edafb2afbe3e09b46">AST_DEVICE_RINGING</a>:
<a name="l00758"></a>00758       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a055700e8ae7f31029bebd7a4353cf04b">ring</a> = 1;
<a name="l00759"></a>00759       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#aec50b9db1640cefa9c219d63e1b7ade4">all_unavail</a> = 0;
<a name="l00760"></a>00760       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a7dcbb2425e6da769d44603778432db0f">all_free</a> = 0;
<a name="l00761"></a>00761       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a89222ce0f74e56a855e1be89537fdb02">all_unknown</a> = 0;
<a name="l00762"></a>00762       <span class="keywordflow">break</span>;
<a name="l00763"></a>00763    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea17b87dfa3f4de5909b401017e229091d">AST_DEVICE_RINGINUSE</a>:
<a name="l00764"></a>00764       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#ae90f2e4a448082950b7e1e7a7a508464">in_use</a> = 1;
<a name="l00765"></a>00765       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a055700e8ae7f31029bebd7a4353cf04b">ring</a> = 1;
<a name="l00766"></a>00766       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#aec50b9db1640cefa9c219d63e1b7ade4">all_unavail</a> = 0;
<a name="l00767"></a>00767       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a7dcbb2425e6da769d44603778432db0f">all_free</a> = 0;
<a name="l00768"></a>00768       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a89222ce0f74e56a855e1be89537fdb02">all_unknown</a> = 0;
<a name="l00769"></a>00769       <span class="keywordflow">break</span>;
<a name="l00770"></a>00770    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea6b7416bea92d3bc5ee8e36f0a484cdc1">AST_DEVICE_ONHOLD</a>:
<a name="l00771"></a>00771       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a89222ce0f74e56a855e1be89537fdb02">all_unknown</a> = 0;
<a name="l00772"></a>00772       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#aec50b9db1640cefa9c219d63e1b7ade4">all_unavail</a> = 0;
<a name="l00773"></a>00773       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a7dcbb2425e6da769d44603778432db0f">all_free</a> = 0;
<a name="l00774"></a>00774       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#adbb5ea13ff67a0f65a71edddb0eef433">on_hold</a> = 1;
<a name="l00775"></a>00775       <span class="keywordflow">break</span>;
<a name="l00776"></a>00776    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeab43afabf5bcd4ad1f531ad78c48ccb6f">AST_DEVICE_BUSY</a>:
<a name="l00777"></a>00777       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a89222ce0f74e56a855e1be89537fdb02">all_unknown</a> = 0;
<a name="l00778"></a>00778       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#aec50b9db1640cefa9c219d63e1b7ade4">all_unavail</a> = 0;
<a name="l00779"></a>00779       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a7dcbb2425e6da769d44603778432db0f">all_free</a> = 0;
<a name="l00780"></a>00780       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a062fb7f88f25f3a783a4f30f7174d1dc">busy</a> = 1;
<a name="l00781"></a>00781       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#ae90f2e4a448082950b7e1e7a7a508464">in_use</a> = 1;
<a name="l00782"></a>00782       <span class="keywordflow">break</span>;
<a name="l00783"></a>00783    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>:
<a name="l00784"></a>00784       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a89222ce0f74e56a855e1be89537fdb02">all_unknown</a> = 0;
<a name="l00785"></a>00785    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>:
<a name="l00786"></a>00786       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#af7df3d089a03d0acb4e8e18c28d58700">all_busy</a> = 0;
<a name="l00787"></a>00787       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a7dcbb2425e6da769d44603778432db0f">all_free</a> = 0;
<a name="l00788"></a>00788       <span class="keywordflow">break</span>;
<a name="l00789"></a>00789    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>:
<a name="l00790"></a>00790       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#af7df3d089a03d0acb4e8e18c28d58700">all_busy</a> = 0;
<a name="l00791"></a>00791       agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a7dcbb2425e6da769d44603778432db0f">all_free</a> = 0;
<a name="l00792"></a>00792       <span class="keywordflow">break</span>;
<a name="l00793"></a>00793    <span class="keywordflow">case</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeaf790c1f212837af8d2db5193228102d7">AST_DEVICE_TOTAL</a>: <span class="comment">/* not a device state, included for completeness. */</span>
<a name="l00794"></a>00794       <span class="keywordflow">break</span>;
<a name="l00795"></a>00795    }
<a name="l00796"></a>00796 }
<a name="l00797"></a>00797 
<a name="l00798"></a>00798 
<a name="l00799"></a><a class="code" href="devicestate_8c.html#a852d7e936d4385c3bb903812de5d6403">00799</a> <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> <a class="code" href="devicestate_8h.html#a852d7e936d4385c3bb903812de5d6403" title="Get the aggregate device state result.">ast_devstate_aggregate_result</a>(<span class="keyword">struct</span> <a class="code" href="structast__devstate__aggregate.html" title="You shouldn&amp;#39;t care about the contents of this struct.">ast_devstate_aggregate</a> *agg)
<a name="l00800"></a>00800 {
<a name="l00801"></a>00801    <span class="keywordflow">if</span> (agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a7dcbb2425e6da769d44603778432db0f">all_free</a>)
<a name="l00802"></a>00802       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>;
<a name="l00803"></a>00803    <span class="keywordflow">if</span> ((agg-&gt;<a class="code" href="structast__devstate__aggregate.html#ae90f2e4a448082950b7e1e7a7a508464">in_use</a> || agg-&gt;<a class="code" href="structast__devstate__aggregate.html#adbb5ea13ff67a0f65a71edddb0eef433">on_hold</a>) &amp;&amp; agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a055700e8ae7f31029bebd7a4353cf04b">ring</a>)
<a name="l00804"></a>00804       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea17b87dfa3f4de5909b401017e229091d">AST_DEVICE_RINGINUSE</a>;
<a name="l00805"></a>00805    <span class="keywordflow">if</span> (agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a055700e8ae7f31029bebd7a4353cf04b">ring</a>)
<a name="l00806"></a>00806       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea76d91d5d654cfa3edafb2afbe3e09b46">AST_DEVICE_RINGING</a>;
<a name="l00807"></a>00807    <span class="keywordflow">if</span> (agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a062fb7f88f25f3a783a4f30f7174d1dc">busy</a>)
<a name="l00808"></a>00808       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeab43afabf5bcd4ad1f531ad78c48ccb6f">AST_DEVICE_BUSY</a>;
<a name="l00809"></a>00809    <span class="keywordflow">if</span> (agg-&gt;<a class="code" href="structast__devstate__aggregate.html#ae90f2e4a448082950b7e1e7a7a508464">in_use</a>)
<a name="l00810"></a>00810       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>;
<a name="l00811"></a>00811    <span class="keywordflow">if</span> (agg-&gt;<a class="code" href="structast__devstate__aggregate.html#adbb5ea13ff67a0f65a71edddb0eef433">on_hold</a>)
<a name="l00812"></a>00812       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea6b7416bea92d3bc5ee8e36f0a484cdc1">AST_DEVICE_ONHOLD</a>;
<a name="l00813"></a>00813    <span class="keywordflow">if</span> (agg-&gt;<a class="code" href="structast__devstate__aggregate.html#af7df3d089a03d0acb4e8e18c28d58700">all_busy</a>)
<a name="l00814"></a>00814       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeab43afabf5bcd4ad1f531ad78c48ccb6f">AST_DEVICE_BUSY</a>;
<a name="l00815"></a>00815    <span class="keywordflow">if</span> (agg-&gt;<a class="code" href="structast__devstate__aggregate.html#a89222ce0f74e56a855e1be89537fdb02">all_unknown</a>)
<a name="l00816"></a>00816       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>;
<a name="l00817"></a>00817    <span class="keywordflow">if</span> (agg-&gt;<a class="code" href="structast__devstate__aggregate.html#aec50b9db1640cefa9c219d63e1b7ade4">all_unavail</a>)
<a name="l00818"></a>00818       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>;
<a name="l00819"></a>00819 
<a name="l00820"></a>00820    <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>;
<a name="l00821"></a>00821 }
<a name="l00822"></a>00822 
<a name="l00823"></a><a class="code" href="devicestate_8c.html#aab3f3dcda2662dc291fc4c17b9a602f4">00823</a> <span class="keywordtype">int</span> <a class="code" href="devicestate_8h.html#aab3f3dcda2662dc291fc4c17b9a602f4" title="Enable distributed device state processing.">ast_enable_distributed_devstate</a>(<span class="keywordtype">void</span>)
<a name="l00824"></a>00824 {
<a name="l00825"></a>00825    <span class="keywordflow">if</span> (<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.enabled) {
<a name="l00826"></a>00826       <span class="keywordflow">return</span> 0;
<a name="l00827"></a>00827    }
<a name="l00828"></a>00828 
<a name="l00829"></a>00829    <a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.event_sub = <a class="code" href="event_8h.html#a517ac17630e7658463b66b309a6ce78f" title="Subscribe to events.">ast_event_subscribe</a>(<a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa641bc805cee9b8829fa265e566df9d58">AST_EVENT_DEVICE_STATE_CHANGE</a>,
<a name="l00830"></a>00830       <a class="code" href="devicestate_8c.html#a6328f4d8f6d6b35b38f2acb39258cd2f">devstate_change_collector_cb</a>, NULL, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a04c78c1362e97d548344c354001c151f">AST_EVENT_IE_END</a>);
<a name="l00831"></a>00831 
<a name="l00832"></a>00832    <span class="keywordflow">if</span> (!<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.event_sub) {
<a name="l00833"></a>00833       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to create subscription for the device state change collector\n&quot;</span>);
<a name="l00834"></a>00834       <span class="keywordflow">return</span> -1;
<a name="l00835"></a>00835    }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.lock);
<a name="l00838"></a>00838    <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.cond, NULL);
<a name="l00839"></a>00839    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;<a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.thread, NULL, <a class="code" href="devicestate_8c.html#aba2b4557d1f67626534da2a47d3ad39e">run_devstate_collector</a>, NULL) &lt; 0) {
<a name="l00840"></a>00840       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to start device state collector thread.\n&quot;</span>);
<a name="l00841"></a>00841       <span class="keywordflow">return</span> -1;
<a name="l00842"></a>00842    }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844    <a class="code" href="devicestate_8c.html#a21d826fdbe789058ca74e83f4f052c37">devstate_collector</a>.enabled = 1;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846    <span class="keywordflow">return</span> 0;
<a name="l00847"></a>00847 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:38 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
