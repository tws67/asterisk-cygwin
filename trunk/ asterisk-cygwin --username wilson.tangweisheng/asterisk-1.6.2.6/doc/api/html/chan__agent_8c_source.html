<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:30 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_0ca6ff3bf6b340411b2c6edd15b1a34d.html">channels</a>
  </div>
</div>
<div class="contents">
<h1>chan_agent.c</h1><a href="chan__agent_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="comment"></span>
<a name="l00020"></a>00020 <span class="comment">/*! \file</span>
<a name="l00021"></a>00021 <span class="comment"> * </span>
<a name="l00022"></a>00022 <span class="comment"> * \brief Implementation of Agents (proxy channel)</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * This file is the implementation of Agents modules.</span>
<a name="l00027"></a>00027 <span class="comment"> * It is a dynamic module that is loaded by Asterisk. </span>
<a name="l00028"></a>00028 <span class="comment"> * \par See also</span>
<a name="l00029"></a>00029 <span class="comment"> * \arg \ref Config_agent</span>
<a name="l00030"></a>00030 <span class="comment"> *</span>
<a name="l00031"></a>00031 <span class="comment"> * \ingroup channel_drivers</span>
<a name="l00032"></a>00032 <span class="comment"> */</span>
<a name="l00033"></a>00033 <span class="comment">/*** MODULEINFO</span>
<a name="l00034"></a>00034 <span class="comment">        &lt;depend&gt;chan_local&lt;/depend&gt;</span>
<a name="l00035"></a>00035 <span class="comment"> ***/</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 241318 $&quot;</span>)
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span><span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;sys/signal.h&gt;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="sched_8h.html" title="Scheduler Routines (derived from cheops).">asterisk/sched.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="io_8h.html" title="I/O Management (derived from Cheops-NG).">asterisk/io.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="rtp_8h.html" title="Supports RTP and RTCP with Symmetric RTP support for NAT traversal.">asterisk/rtp.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="acl_8h.html" title="Access Control of various sorts.">asterisk/acl.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="callerid_8h.html" title="CallerID (and other GR30) management and generation Includes code and algorithms...">asterisk/callerid.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="musiconhold_8h.html" title="Music on hold handling.">asterisk/musiconhold.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="features_8h.html" title="Call Parking and Pickup API Includes code and algorithms from the Zapata library...">asterisk/features.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="causes_8h.html" title="Internal Asterisk hangup causes.">asterisk/causes.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="astdb_8h.html" title="Persistant data storage (akin to *doze registry).">asterisk/astdb.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="devicestate_8h.html" title="Device state management.">asterisk/devicestate.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="monitor_8h.html" title="Channel monitoring.">asterisk/monitor.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="stringfields_8h.html" title="String fields in structures.">asterisk/stringfields.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="event_8h.html">asterisk/event.h</a>&quot;</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="comment">/*** DOCUMENTATION</span>
<a name="l00073"></a>00073 <span class="comment">   &lt;application name=&quot;AgentLogin&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00074"></a>00074 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00075"></a>00075 <span class="comment">         Call agent login.</span>
<a name="l00076"></a>00076 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00077"></a>00077 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00078"></a>00078 <span class="comment">         &lt;parameter name=&quot;AgentNo&quot; /&gt;</span>
<a name="l00079"></a>00079 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00080"></a>00080 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00081"></a>00081 <span class="comment">               &lt;option name=&quot;s&quot;&gt;</span>
<a name="l00082"></a>00082 <span class="comment">                  &lt;para&gt;silent login - do not announce the login ok segment after</span>
<a name="l00083"></a>00083 <span class="comment">                  agent logged on/off&lt;/para&gt;</span>
<a name="l00084"></a>00084 <span class="comment">               &lt;/option&gt;</span>
<a name="l00085"></a>00085 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00086"></a>00086 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00087"></a>00087 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00088"></a>00088 <span class="comment">      &lt;description&gt;</span>
<a name="l00089"></a>00089 <span class="comment">         &lt;para&gt;Asks the agent to login to the system. Always returns &lt;literal&gt;-1&lt;/literal&gt;.</span>
<a name="l00090"></a>00090 <span class="comment">         While logged in, the agent can receive calls and will hear a &lt;literal&gt;beep&lt;/literal&gt;</span>
<a name="l00091"></a>00091 <span class="comment">         when a new call comes in. The agent can dump the call by pressing the star key.&lt;/para&gt;</span>
<a name="l00092"></a>00092 <span class="comment">      &lt;/description&gt;</span>
<a name="l00093"></a>00093 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00094"></a>00094 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;Queue&lt;/ref&gt;</span>
<a name="l00095"></a>00095 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;AddQueueMember&lt;/ref&gt;</span>
<a name="l00096"></a>00096 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;RemoveQueueMember&lt;/ref&gt;</span>
<a name="l00097"></a>00097 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;PauseQueueMember&lt;/ref&gt;</span>
<a name="l00098"></a>00098 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;UnpauseQueueMember&lt;/ref&gt;</span>
<a name="l00099"></a>00099 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;AGENT&lt;/ref&gt;</span>
<a name="l00100"></a>00100 <span class="comment">         &lt;ref type=&quot;filename&quot;&gt;agents.conf&lt;/ref&gt;</span>
<a name="l00101"></a>00101 <span class="comment">         &lt;ref type=&quot;filename&quot;&gt;queues.conf&lt;/ref&gt;</span>
<a name="l00102"></a>00102 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00103"></a>00103 <span class="comment">   &lt;/application&gt;</span>
<a name="l00104"></a>00104 <span class="comment">   &lt;application name=&quot;AgentMonitorOutgoing&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00105"></a>00105 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00106"></a>00106 <span class="comment">         Record agent&apos;s outgoing call.</span>
<a name="l00107"></a>00107 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00108"></a>00108 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00109"></a>00109 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00110"></a>00110 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00111"></a>00111 <span class="comment">               &lt;option name=&quot;d&quot;&gt;</span>
<a name="l00112"></a>00112 <span class="comment">                  &lt;para&gt;make the app return &lt;literal&gt;-1&lt;/literal&gt; if there is an error condition.&lt;/para&gt;</span>
<a name="l00113"></a>00113 <span class="comment">               &lt;/option&gt;</span>
<a name="l00114"></a>00114 <span class="comment">               &lt;option name=&quot;c&quot;&gt;</span>
<a name="l00115"></a>00115 <span class="comment">                  &lt;para&gt;change the CDR so that the source of the call is</span>
<a name="l00116"></a>00116 <span class="comment">                  &lt;literal&gt;Agent/agent_id&lt;/literal&gt;&lt;/para&gt;</span>
<a name="l00117"></a>00117 <span class="comment">               &lt;/option&gt;</span>
<a name="l00118"></a>00118 <span class="comment">               &lt;option name=&quot;n&quot;&gt;</span>
<a name="l00119"></a>00119 <span class="comment">                  &lt;para&gt;don&apos;t generate the warnings when there is no callerid or the</span>
<a name="l00120"></a>00120 <span class="comment">                  agentid is not known. It&apos;s handy if you want to have one context</span>
<a name="l00121"></a>00121 <span class="comment">                  for agent and non-agent calls.&lt;/para&gt;</span>
<a name="l00122"></a>00122 <span class="comment">               &lt;/option&gt;</span>
<a name="l00123"></a>00123 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00124"></a>00124 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00125"></a>00125 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00126"></a>00126 <span class="comment">      &lt;description&gt;</span>
<a name="l00127"></a>00127 <span class="comment">         &lt;para&gt;Tries to figure out the id of the agent who is placing outgoing call based on</span>
<a name="l00128"></a>00128 <span class="comment">         comparison of the callerid of the current interface and the global variable</span>
<a name="l00129"></a>00129 <span class="comment">         placed by the AgentCallbackLogin application. That&apos;s why it should be used only</span>
<a name="l00130"></a>00130 <span class="comment">         with the AgentCallbackLogin app. Uses the monitoring functions in chan_agent</span>
<a name="l00131"></a>00131 <span class="comment">         instead of Monitor application. That has to be configured in the</span>
<a name="l00132"></a>00132 <span class="comment">         &lt;filename&gt;agents.conf&lt;/filename&gt; file.&lt;/para&gt;</span>
<a name="l00133"></a>00133 <span class="comment">         &lt;para&gt;Normally the app returns &lt;literal&gt;0&lt;/literal&gt; unless the options are passed.&lt;/para&gt;</span>
<a name="l00134"></a>00134 <span class="comment">      &lt;/description&gt;</span>
<a name="l00135"></a>00135 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00136"></a>00136 <span class="comment">         &lt;ref type=&quot;filename&quot;&gt;agents.conf&lt;/ref&gt;</span>
<a name="l00137"></a>00137 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00138"></a>00138 <span class="comment">   &lt;/application&gt;</span>
<a name="l00139"></a>00139 <span class="comment">   &lt;function name=&quot;AGENT&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00140"></a>00140 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00141"></a>00141 <span class="comment">         Gets information about an Agent</span>
<a name="l00142"></a>00142 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00143"></a>00143 <span class="comment">      &lt;syntax argsep=&quot;:&quot;&gt;</span>
<a name="l00144"></a>00144 <span class="comment">         &lt;parameter name=&quot;agentid&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00145"></a>00145 <span class="comment">         &lt;parameter name=&quot;item&quot;&gt;</span>
<a name="l00146"></a>00146 <span class="comment">            &lt;para&gt;The valid items to retrieve are:&lt;/para&gt;</span>
<a name="l00147"></a>00147 <span class="comment">            &lt;enumlist&gt;</span>
<a name="l00148"></a>00148 <span class="comment">               &lt;enum name=&quot;status&quot;&gt;</span>
<a name="l00149"></a>00149 <span class="comment">                  &lt;para&gt;(default) The status of the agent (LOGGEDIN | LOGGEDOUT)&lt;/para&gt;</span>
<a name="l00150"></a>00150 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00151"></a>00151 <span class="comment">               &lt;enum name=&quot;password&quot;&gt;</span>
<a name="l00152"></a>00152 <span class="comment">                  &lt;para&gt;The password of the agent&lt;/para&gt;</span>
<a name="l00153"></a>00153 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00154"></a>00154 <span class="comment">               &lt;enum name=&quot;name&quot;&gt;</span>
<a name="l00155"></a>00155 <span class="comment">                  &lt;para&gt;The name of the agent&lt;/para&gt;</span>
<a name="l00156"></a>00156 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00157"></a>00157 <span class="comment">               &lt;enum name=&quot;mohclass&quot;&gt;</span>
<a name="l00158"></a>00158 <span class="comment">                  &lt;para&gt;MusicOnHold class&lt;/para&gt;</span>
<a name="l00159"></a>00159 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00160"></a>00160 <span class="comment">               &lt;enum name=&quot;exten&quot;&gt;</span>
<a name="l00161"></a>00161 <span class="comment">                  &lt;para&gt;The callback extension for the Agent (AgentCallbackLogin)&lt;/para&gt;</span>
<a name="l00162"></a>00162 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00163"></a>00163 <span class="comment">               &lt;enum name=&quot;channel&quot;&gt;</span>
<a name="l00164"></a>00164 <span class="comment">                  &lt;para&gt;The name of the active channel for the Agent (AgentLogin)&lt;/para&gt;</span>
<a name="l00165"></a>00165 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00166"></a>00166 <span class="comment">            &lt;/enumlist&gt;</span>
<a name="l00167"></a>00167 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00168"></a>00168 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00169"></a>00169 <span class="comment">      &lt;description /&gt;</span>
<a name="l00170"></a>00170 <span class="comment">   &lt;/function&gt;</span>
<a name="l00171"></a>00171 <span class="comment"> ***/</span>
<a name="l00172"></a>00172 
<a name="l00173"></a><a class="code" href="chan__agent_8c.html#a71535bf985a1a06d548fd73a0a0ec32c">00173</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#adb02bb3719cdf90c200c1ca30caa26a2">tdesc</a>[] = <span class="stringliteral">&quot;Call Agent Proxy Channel&quot;</span>;
<a name="l00174"></a><a class="code" href="chan__agent_8c.html#a9ee8d742a1fbcff45f97842b92952610">00174</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a9ee8d742a1fbcff45f97842b92952610">config</a>[] = <span class="stringliteral">&quot;agents.conf&quot;</span>;
<a name="l00175"></a>00175 
<a name="l00176"></a><a class="code" href="chan__agent_8c.html#a1d9b1eccfc259a14525ce817482a3f88">00176</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a>[] = <span class="stringliteral">&quot;AgentLogin&quot;</span>;
<a name="l00177"></a><a class="code" href="chan__agent_8c.html#aad58282d90fddc0dcc234189388a6b01">00177</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#aad58282d90fddc0dcc234189388a6b01">app3</a>[] = <span class="stringliteral">&quot;AgentMonitorOutgoing&quot;</span>;
<a name="l00178"></a>00178 
<a name="l00179"></a><a class="code" href="chan__agent_8c.html#a218180436d51f7890967aa423b7a8b13">00179</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a218180436d51f7890967aa423b7a8b13">mandescr_agents</a>[] =
<a name="l00180"></a>00180 <span class="stringliteral">&quot;Description: Will list info about all possible agents.\n&quot;</span>
<a name="l00181"></a>00181 <span class="stringliteral">&quot;Variables: NONE\n&quot;</span>;
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="chan__agent_8c.html#a7fe6884d8a491078c943cf00f67fe418">00183</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a7fe6884d8a491078c943cf00f67fe418">mandescr_agent_logoff</a>[] =
<a name="l00184"></a>00184 <span class="stringliteral">&quot;Description: Sets an agent as no longer logged in.\n&quot;</span>
<a name="l00185"></a>00185 <span class="stringliteral">&quot;Variables: (Names marked with * are required)\n&quot;</span>
<a name="l00186"></a>00186 <span class="stringliteral">&quot;  *Agent: Agent ID of the agent to log off\n&quot;</span>
<a name="l00187"></a>00187 <span class="stringliteral">&quot;  Soft: Set to &apos;true&apos; to not hangup existing calls\n&quot;</span>;
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="chan__agent_8c.html#a0f66f061490edf209d9ff6e2f18be109">00189</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>[80] = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="chan__agent_8c.html#a493e7a4ae707f3f4dc9beda1d33e77e8">00191</a> <span class="preprocessor">#define AST_MAX_AGENT   80                          </span><span class="comment">/*!&lt; Agent ID or Password max length */</span>
<a name="l00192"></a><a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">00192</a> <span class="preprocessor">#define AST_MAX_BUF  256</span>
<a name="l00193"></a><a class="code" href="chan__agent_8c.html#a70f9f919042ae338d621b61ac5e3828e">00193</a> <span class="preprocessor"></span><span class="preprocessor">#define AST_MAX_FILENAME_LEN  256</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>
<a name="l00195"></a><a class="code" href="chan__agent_8c.html#a9f1c21c025fa3dfd3b7e8a4181f3308b">00195</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a9f1c21c025fa3dfd3b7e8a4181f3308b">pa_family</a>[] = <span class="stringliteral">&quot;Agents&quot;</span>;          <span class="comment">/*!&lt; Persistent Agents astdb family */</span>
<a name="l00196"></a><a class="code" href="chan__agent_8c.html#a2ec047017aa971456a8e5c002a132e0c">00196</a> <span class="preprocessor">#define PA_MAX_LEN 2048                             </span><span class="comment">/*!&lt; The maximum length of each persistent member agent database entry */</span>
<a name="l00197"></a>00197 
<a name="l00198"></a><a class="code" href="chan__agent_8c.html#a3ade68b88f4f4f75766f5fd7632d963a">00198</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a3ade68b88f4f4f75766f5fd7632d963a">persistent_agents</a> = 0;                   <span class="comment">/*!&lt; queues.conf [general] option */</span>
<a name="l00199"></a>00199 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__agent_8c.html#a25dc3d6cf242ab703a5212535685d41e" title="Dump AgentCallbackLogin agents to the ASTdb database for persistence.">dump_agents</a>(<span class="keywordtype">void</span>);
<a name="l00200"></a>00200 
<a name="l00201"></a><a class="code" href="chan__agent_8c.html#a31e11356f347391fec32b6bf58ae11a0">00201</a> <span class="preprocessor">#define DEFAULT_ACCEPTDTMF &apos;#&apos;</span>
<a name="l00202"></a><a class="code" href="chan__agent_8c.html#a0a759ea73058c53774e006185b5533df">00202</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_ENDDTMF &apos;*&apos;</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span>
<a name="l00204"></a><a class="code" href="chan__agent_8c.html#a2f66424184fe1873f7b46b19de589b57">00204</a> <span class="keyword">static</span> <a class="code" href="channel_8h.html#a641d81d0c5c8df99d43eff69aede3bfd">ast_group_t</a> <a class="code" href="structgroup.html">group</a>;
<a name="l00205"></a><a class="code" href="chan__agent_8c.html#acd7840ef12b52f1c109cda04e1550ae5">00205</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a>;
<a name="l00206"></a><a class="code" href="chan__agent_8c.html#a9298f7c0bf15cf275f4664d6959a6da6">00206</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a>;
<a name="l00207"></a><a class="code" href="chan__agent_8c.html#a50e50c503992dc6171d97a0d72b8dba7">00207</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a>;
<a name="l00208"></a><a class="code" href="chan__agent_8c.html#a72d58f3c7454910fce4b1f06ce81823c">00208</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a72d58f3c7454910fce4b1f06ce81823c">endcall</a>;
<a name="l00209"></a><a class="code" href="chan__agent_8c.html#acb2a06aefb001fbb04cc4387772f9f25">00209</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#acb2a06aefb001fbb04cc4387772f9f25">multiplelogin</a> = 1;
<a name="l00210"></a><a class="code" href="chan__agent_8c.html#ab1e6bf77fb269afaf494f63e9bbed5ae">00210</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#ab1e6bf77fb269afaf494f63e9bbed5ae">autologoffunavail</a> = 0;
<a name="l00211"></a><a class="code" href="chan__agent_8c.html#a97629727ac11792aa963aed4457abde8">00211</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a97629727ac11792aa963aed4457abde8">acceptdtmf</a> = <a class="code" href="chan__agent_8c.html#a31e11356f347391fec32b6bf58ae11a0">DEFAULT_ACCEPTDTMF</a>;
<a name="l00212"></a><a class="code" href="chan__agent_8c.html#a064a847aaeac6f1dc116434663517d16">00212</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a064a847aaeac6f1dc116434663517d16">enddtmf</a> = <a class="code" href="chan__agent_8c.html#a0a759ea73058c53774e006185b5533df">DEFAULT_ENDDTMF</a>;
<a name="l00213"></a>00213 
<a name="l00214"></a><a class="code" href="chan__agent_8c.html#a4be0216d4ba2648c410f5bd1d7d94ede">00214</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a4be0216d4ba2648c410f5bd1d7d94ede">maxlogintries</a> = 3;
<a name="l00215"></a><a class="code" href="chan__agent_8c.html#a63715c6706eefa4d286ef49d9aebea5e">00215</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a63715c6706eefa4d286ef49d9aebea5e">agentgoodbye</a>[<a class="code" href="chan__agent_8c.html#a70f9f919042ae338d621b61ac5e3828e">AST_MAX_FILENAME_LEN</a>] = <span class="stringliteral">&quot;vm-goodbye&quot;</span>;
<a name="l00216"></a>00216 
<a name="l00217"></a><a class="code" href="chan__agent_8c.html#a9cb6e25988c7fa2b7af7ccd3efb486a0">00217</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a9cb6e25988c7fa2b7af7ccd3efb486a0">recordagentcalls</a> = 0;
<a name="l00218"></a><a class="code" href="chan__agent_8c.html#a8740f7d34455aa767a5463ae9bf1236d">00218</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a8740f7d34455aa767a5463ae9bf1236d">recordformat</a>[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00219"></a><a class="code" href="chan__agent_8c.html#a611a6c69b23e3a009daedc25328b72d1">00219</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a611a6c69b23e3a009daedc25328b72d1">recordformatext</a>[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00220"></a><a class="code" href="chan__agent_8c.html#a4f8c9d48afaf63e678a2169491ea2df2">00220</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a4f8c9d48afaf63e678a2169491ea2df2">urlprefix</a>[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00221"></a><a class="code" href="chan__agent_8c.html#a71b700c9d403cd1ba39d45a8ecafeb81">00221</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a71b700c9d403cd1ba39d45a8ecafeb81">savecallsin</a>[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00222"></a><a class="code" href="chan__agent_8c.html#a843b3994c6ce90a661d86ff0aee06104">00222</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a843b3994c6ce90a661d86ff0aee06104">updatecdr</a> = 0;
<a name="l00223"></a><a class="code" href="chan__agent_8c.html#a690b549792f347bebb6a13518822bcf7">00223</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a690b549792f347bebb6a13518822bcf7">beep</a>[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>] = <span class="stringliteral">&quot;beep&quot;</span>;
<a name="l00224"></a>00224 
<a name="l00225"></a><a class="code" href="chan__agent_8c.html#a8bdad3e572ba87281b8face9e122917e">00225</a> <span class="preprocessor">#define GETAGENTBYCALLERID &quot;AGENTBYCALLERID&quot;</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span>
<a name="l00227"></a>00227 <span class="keyword">enum</span> {
<a name="l00228"></a><a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173a95b3856eae5d97e0aa2993019cba8a2d">00228</a>    <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173a95b3856eae5d97e0aa2993019cba8a2d">AGENT_FLAG_ACKCALL</a> = (1 &lt;&lt; 0),
<a name="l00229"></a><a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173ac649bc6edb894d204cdf584c319a73fd">00229</a>    <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173ac649bc6edb894d204cdf584c319a73fd">AGENT_FLAG_AUTOLOGOFF</a> = (1 &lt;&lt; 1),
<a name="l00230"></a><a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173adb917e73669ec6ef37d8ba1fdf3d287a">00230</a>    <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173adb917e73669ec6ef37d8ba1fdf3d287a">AGENT_FLAG_WRAPUPTIME</a> = (1 &lt;&lt; 2),
<a name="l00231"></a><a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173a4c5894c85df72565d9ba1cb16e6b3bfc">00231</a>    <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173a4c5894c85df72565d9ba1cb16e6b3bfc">AGENT_FLAG_ACCEPTDTMF</a> = (1 &lt;&lt; 3),
<a name="l00232"></a><a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173a4542cbcf2199a92543eee76c28666ec3">00232</a>    <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173a4542cbcf2199a92543eee76c28666ec3">AGENT_FLAG_ENDDTMF</a> = (1 &lt;&lt; 4),
<a name="l00233"></a>00233 };
<a name="l00234"></a>00234 <span class="comment"></span>
<a name="l00235"></a>00235 <span class="comment">/*! \brief Structure representing an agent.  */</span>
<a name="l00236"></a><a class="code" href="structagent__pvt.html">00236</a> <span class="keyword">struct </span><a class="code" href="structagent__pvt.html" title="Structure representing an agent.">agent_pvt</a> {
<a name="l00237"></a><a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">00237</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>;              <span class="comment">/*!&lt; Channel private lock */</span>
<a name="l00238"></a><a class="code" href="structagent__pvt.html#aeddb1df77f26fbe111539b1c4c0c1929">00238</a>    <span class="keywordtype">int</span> <a class="code" href="structagent__pvt.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a>;                      <span class="comment">/*!&lt; Poised for destruction? */</span>
<a name="l00239"></a><a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">00239</a>    <span class="keywordtype">int</span> <a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a>;                   <span class="comment">/*!&lt; Not a real agent -- just pending a match */</span>
<a name="l00240"></a><a class="code" href="structagent__pvt.html#a6855f972df14160c6e762120e1589670">00240</a>    <span class="keywordtype">int</span> <a class="code" href="structagent__pvt.html#a6855f972df14160c6e762120e1589670">abouttograb</a>;               <span class="comment">/*!&lt; About to grab */</span>
<a name="l00241"></a><a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">00241</a>    <span class="keywordtype">int</span> autologoff;                <span class="comment">/*!&lt; Auto timeout time */</span>
<a name="l00242"></a><a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">00242</a>    <span class="keywordtype">int</span> ackcall;                   <span class="comment">/*!&lt; ackcall */</span>
<a name="l00243"></a><a class="code" href="structagent__pvt.html#ae6634ed33949784643bc0c217c419bb5">00243</a>    <span class="keywordtype">int</span> <a class="code" href="structagent__pvt.html#ae6634ed33949784643bc0c217c419bb5">deferlogoff</a>;               <span class="comment">/*!&lt; Defer logoff to hangup */</span>
<a name="l00244"></a><a class="code" href="structagent__pvt.html#a97629727ac11792aa963aed4457abde8">00244</a>    <span class="keywordtype">char</span> acceptdtmf;
<a name="l00245"></a><a class="code" href="structagent__pvt.html#a064a847aaeac6f1dc116434663517d16">00245</a>    <span class="keywordtype">char</span> enddtmf;
<a name="l00246"></a><a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">00246</a>    time_t <a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>;             <span class="comment">/*!&lt; When agent first logged in (0 when logged off) */</span>
<a name="l00247"></a><a class="code" href="structagent__pvt.html#ada310e7f72b38fadd4b24d80ed3438ee">00247</a>    time_t <a class="code" href="structagent__pvt.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;                  <span class="comment">/*!&lt; When call started */</span>
<a name="l00248"></a><a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">00248</a>    <span class="keyword">struct </span>timeval <a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>;       <span class="comment">/*!&lt; When last disconnected */</span>
<a name="l00249"></a><a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">00249</a>    <span class="keywordtype">int</span> wrapuptime;                <span class="comment">/*!&lt; Wrapup time in ms */</span>
<a name="l00250"></a><a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">00250</a>    <a class="code" href="channel_8h.html#a641d81d0c5c8df99d43eff69aede3bfd">ast_group_t</a> group;             <span class="comment">/*!&lt; Group memberships */</span>
<a name="l00251"></a><a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">00251</a>    <span class="keywordtype">int</span> <a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a>;              <span class="comment">/*!&lt; Acknowledged */</span>
<a name="l00252"></a><a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">00252</a>    <span class="keywordtype">char</span> moh[80];                  <span class="comment">/*!&lt; Which music on hold */</span>
<a name="l00253"></a><a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">00253</a>    <span class="keywordtype">char</span> <a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>[<a class="code" href="chan__agent_8c.html#a493e7a4ae707f3f4dc9beda1d33e77e8">AST_MAX_AGENT</a>];     <span class="comment">/*!&lt; Agent ID */</span>
<a name="l00254"></a><a class="code" href="structagent__pvt.html#a89ef5ad192d222ee54b1e0c4edf45cb6">00254</a>    <span class="keywordtype">char</span> <a class="code" href="structagent__pvt.html#a89ef5ad192d222ee54b1e0c4edf45cb6">password</a>[<a class="code" href="chan__agent_8c.html#a493e7a4ae707f3f4dc9beda1d33e77e8">AST_MAX_AGENT</a>];  <span class="comment">/*!&lt; Password for Agent login */</span>
<a name="l00255"></a><a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">00255</a>    <span class="keywordtype">char</span> <a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>[<a class="code" href="chan__agent_8c.html#a493e7a4ae707f3f4dc9beda1d33e77e8">AST_MAX_AGENT</a>];
<a name="l00256"></a><a class="code" href="structagent__pvt.html#a16a593c509d04ae4f46b21ada53c2ea6">00256</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="structagent__pvt.html#a16a593c509d04ae4f46b21ada53c2ea6">app_lock</a>;          <span class="comment">/**&lt; Synchronization between owning applications */</span>
<a name="l00257"></a><a class="code" href="structagent__pvt.html#a13b86677f5f5b6ebc899aba01af8466a">00257</a>    <span class="keywordtype">int</span> <a class="code" href="structagent__pvt.html#a13b86677f5f5b6ebc899aba01af8466a">app_lock_flag</a>;
<a name="l00258"></a><a class="code" href="structagent__pvt.html#aedc0136c518c393de8b46d60b9018c3f">00258</a>    <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> <a class="code" href="structagent__pvt.html#aedc0136c518c393de8b46d60b9018c3f">app_complete_cond</a>;
<a name="l00259"></a><a class="code" href="structagent__pvt.html#aef61dcc55e364d349e1b7420eb7c4ec9">00259</a>    <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="structagent__pvt.html#aef61dcc55e364d349e1b7420eb7c4ec9">app_sleep_cond</a>;   <span class="comment">/**&lt; Sleep condition for the login app */</span>
<a name="l00260"></a><a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">00260</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>;     <span class="comment">/**&lt; Agent */</span>
<a name="l00261"></a><a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">00261</a>    <span class="keywordtype">char</span> <a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>[80];            <span class="comment">/**&lt; channel they logged in from */</span>
<a name="l00262"></a><a class="code" href="structagent__pvt.html#a1d0896f3c265b2304808016f90742479">00262</a>    <span class="keywordtype">char</span> <a class="code" href="structagent__pvt.html#a1d0896f3c265b2304808016f90742479">logincallerid</a>[80];        <span class="comment">/**&lt; Caller ID they had when they logged in */</span>
<a name="l00263"></a><a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">00263</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;      <span class="comment">/**&lt; Channel we use */</span>
<a name="l00264"></a><a class="code" href="structagent__pvt.html#ac92588540e8c1d014a08cd8a45462b19">00264</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structagent__pvt.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>;            <span class="comment">/**&lt; Flags show if settings were applied with channel vars */</span>
<a name="l00265"></a>00265    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structagent__pvt.html" title="Structure representing an agent.">agent_pvt</a>) list;  <span class="comment">/**&lt; Next Agent in the linked list. */</span>
<a name="l00266"></a>00266 };
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(agents, <a class="code" href="structagent__pvt.html" title="Structure representing an agent.">agent_pvt</a>); <span class="comment">/*!&lt; Holds the list of agents (loaded form agents.conf). */</span>
<a name="l00269"></a>00269 
<a name="l00270"></a><a class="code" href="chan__agent_8c.html#a7c8f932558a7a591a38f7db0b35acf01">00270</a> <span class="preprocessor">#define CHECK_FORMATS(ast, p) do { \</span>
<a name="l00271"></a>00271 <span class="preprocessor">   if (p-&gt;chan) {\</span>
<a name="l00272"></a>00272 <span class="preprocessor">      if (ast-&gt;nativeformats != p-&gt;chan-&gt;nativeformats) { \</span>
<a name="l00273"></a>00273 <span class="preprocessor">         ast_debug(1, &quot;Native formats changing from %d to %d\n&quot;, ast-&gt;nativeformats, p-&gt;chan-&gt;nativeformats); \</span>
<a name="l00274"></a>00274 <span class="preprocessor">         </span><span class="comment">/* Native formats changed, reset things */</span> \
<a name="l00275"></a>00275          ast-&gt;nativeformats = p-&gt;chan-&gt;nativeformats; \
<a name="l00276"></a>00276          ast_debug(1, &quot;Resetting read to %d and write to %d\n&quot;, ast-&gt;readformat, ast-&gt;writeformat);\
<a name="l00277"></a>00277          ast_set_read_format(ast, ast-&gt;readformat); \
<a name="l00278"></a>00278          ast_set_write_format(ast, ast-&gt;writeformat); \
<a name="l00279"></a>00279       } \
<a name="l00280"></a>00280       if (p-&gt;chan-&gt;readformat != ast-&gt;rawreadformat &amp;&amp; !p-&gt;chan-&gt;generator)  \
<a name="l00281"></a>00281          ast_set_read_format(p-&gt;chan, ast-&gt;rawreadformat); \
<a name="l00282"></a>00282       if (p-&gt;chan-&gt;writeformat != ast-&gt;rawwriteformat &amp;&amp; !p-&gt;chan-&gt;generator) \
<a name="l00283"></a>00283          ast_set_write_format(p-&gt;chan, ast-&gt;rawwriteformat); \
<a name="l00284"></a>00284    } \
<a name="l00285"></a>00285 } while(0)
<a name="l00286"></a>00286 <span class="comment"></span>
<a name="l00287"></a>00287 <span class="comment">/*! \brief Cleanup moves all the relevant FD&apos;s from the 2nd to the first, but retains things</span>
<a name="l00288"></a>00288 <span class="comment">   properly for a timingfd XXX This might need more work if agents were logged in as agents or other</span>
<a name="l00289"></a>00289 <span class="comment">   totally impractical combinations XXX */</span>
<a name="l00290"></a>00290 
<a name="l00291"></a><a class="code" href="chan__agent_8c.html#a83ca79d80f5e17956e7a50bf35994bcb">00291</a> <span class="preprocessor">#define CLEANUP(ast, p) do { \</span>
<a name="l00292"></a>00292 <span class="preprocessor">   int x; \</span>
<a name="l00293"></a>00293 <span class="preprocessor">   if (p-&gt;chan) { \</span>
<a name="l00294"></a>00294 <span class="preprocessor">      for (x=0;x&lt;AST_MAX_FDS;x++) {\</span>
<a name="l00295"></a>00295 <span class="preprocessor">         if (x != AST_TIMING_FD) \</span>
<a name="l00296"></a>00296 <span class="preprocessor">            ast_channel_set_fd(ast, x, p-&gt;chan-&gt;fds[x]); \</span>
<a name="l00297"></a>00297 <span class="preprocessor">      } \</span>
<a name="l00298"></a>00298 <span class="preprocessor">      ast_channel_set_fd(ast, AST_AGENT_FD, p-&gt;chan-&gt;fds[AST_TIMING_FD]); \</span>
<a name="l00299"></a>00299 <span class="preprocessor">   } \</span>
<a name="l00300"></a>00300 <span class="preprocessor">} while(0)</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>
<a name="l00302"></a>00302 <span class="comment">/*--- Forward declarations */</span>
<a name="l00303"></a>00303 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__agent_8c.html#a913d85b0e869dbff8a7c948b26476965" title="Part of the Asterisk PBX interface.">agent_request</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="keywordtype">int</span> *<a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>);
<a name="l00304"></a>00304 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a4e38cdd1eb6523a328b26d25b5e3eedc" title="Part of PBX channel interface.">agent_devicestate</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>);
<a name="l00305"></a>00305 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__agent_8c.html#a79fc2c717c9271fd4b5a3da318cc489c">agent_logoff_maintenance</a>(<span class="keyword">struct</span> agent_pvt *p, <span class="keywordtype">char</span> *<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, <span class="keywordtype">long</span> logintime, <span class="keyword">const</span> <span class="keywordtype">char</span> *uniqueid, <span class="keywordtype">char</span> *logcommand);
<a name="l00306"></a>00306 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#ac024a2bb36ff8f5230acfde506e36aed">agent_digit_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> digit);
<a name="l00307"></a>00307 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a0e7b82a6c726ad55417af0cc314ecd51">agent_digit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> digit, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration);
<a name="l00308"></a>00308 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#aba8dc70f68a51ff9af11c751d438195d">agent_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> timeout);
<a name="l00309"></a>00309 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a758a57d73f94e44c4df778a804b03c97">agent_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast);
<a name="l00310"></a>00310 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a668fa4c341de32b01c8dadd209853e57">agent_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast);
<a name="l00311"></a>00311 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="chan__agent_8c.html#ab09227c04051d8b1a0c421b6ba68cc29">agent_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast);
<a name="l00312"></a>00312 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#ab21b4d4720f9ee2a4c9af80e8c752da1">agent_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>);
<a name="l00313"></a>00313 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#ae1d9818e04452dd0d2efed16ba8f91d2">agent_sendhtml</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l00314"></a>00314 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a6a274684b44aca5084022c8b50c81309">agent_sendtext</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>);
<a name="l00315"></a>00315 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a8e7c69e6b30d08458067cb669bcce289">agent_indicate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">int</span> condition, <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">size_t</span> <a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l00316"></a>00316 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a3c12367375202f815f2d2707c3234057">agent_fixup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *oldchan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *newchan);
<a name="l00317"></a>00317 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__agent_8c.html#a2f64da89547dd17397ddd13e621ecf56">agent_bridgedchannel</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__channel.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>);
<a name="l00318"></a>00318 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__agent_8c.html#a2b0c86613090f2a5ff7c16eaca4601d5" title="store/clear the global variable that stores agentid based on the callerid">set_agentbycallerid</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l00319"></a>00319 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#af2f9489c4c0858afef7c36d87b7b22aa">complete_agent_logoff_cmd</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>);
<a name="l00320"></a>00320 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a>* <a class="code" href="chan__agent_8c.html#ac7b1aa68055aa0f5651729d538a6ec3e" title="return the channel or base channel if one exists. This function assumes the channel...">agent_get_base_channel</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00321"></a>00321 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#aedc0a581008a430e15554c6971b5640c">agent_set_base_channel</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *base);
<a name="l00322"></a>00322 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a6334ca5682dabafc368734fdb16f85bb">agent_logoff</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, <span class="keywordtype">int</span> soft);
<a name="l00323"></a>00323 <span class="comment"></span>
<a name="l00324"></a>00324 <span class="comment">/*! \brief Channel interface description for PBX integration */</span>
<a name="l00325"></a><a class="code" href="chan__agent_8c.html#a7495473ec0e365de7c32942518358dea">00325</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html" title="Structure to describe a channel &amp;quot;technology&amp;quot;, ie a channel driver See for...">ast_channel_tech</a> <a class="code" href="chan__agent_8c.html#a7495473ec0e365de7c32942518358dea" title="Channel interface description for PBX integration.">agent_tech</a> = {
<a name="l00326"></a>00326    .<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a> = <span class="stringliteral">&quot;Agent&quot;</span>,
<a name="l00327"></a>00327    .description = tdesc,
<a name="l00328"></a>00328    .capabilities = -1,
<a name="l00329"></a>00329    .requester = <a class="code" href="chan__agent_8c.html#a913d85b0e869dbff8a7c948b26476965" title="Part of the Asterisk PBX interface.">agent_request</a>,
<a name="l00330"></a>00330    .devicestate = <a class="code" href="chan__agent_8c.html#a4e38cdd1eb6523a328b26d25b5e3eedc" title="Part of PBX channel interface.">agent_devicestate</a>,
<a name="l00331"></a>00331    .send_digit_begin = <a class="code" href="chan__agent_8c.html#ac024a2bb36ff8f5230acfde506e36aed">agent_digit_begin</a>,
<a name="l00332"></a>00332    .send_digit_end = <a class="code" href="chan__agent_8c.html#a0e7b82a6c726ad55417af0cc314ecd51">agent_digit_end</a>,
<a name="l00333"></a>00333    .call = <a class="code" href="chan__agent_8c.html#aba8dc70f68a51ff9af11c751d438195d">agent_call</a>,
<a name="l00334"></a>00334    .hangup = <a class="code" href="chan__agent_8c.html#a758a57d73f94e44c4df778a804b03c97">agent_hangup</a>,
<a name="l00335"></a>00335    .answer = <a class="code" href="chan__agent_8c.html#a668fa4c341de32b01c8dadd209853e57">agent_answer</a>,
<a name="l00336"></a>00336    .read = <a class="code" href="chan__agent_8c.html#ab09227c04051d8b1a0c421b6ba68cc29">agent_read</a>,
<a name="l00337"></a>00337    .write = <a class="code" href="chan__agent_8c.html#ab21b4d4720f9ee2a4c9af80e8c752da1">agent_write</a>,
<a name="l00338"></a>00338    .write_video = <a class="code" href="chan__agent_8c.html#ab21b4d4720f9ee2a4c9af80e8c752da1">agent_write</a>,
<a name="l00339"></a>00339    .send_html = <a class="code" href="chan__agent_8c.html#ae1d9818e04452dd0d2efed16ba8f91d2">agent_sendhtml</a>,
<a name="l00340"></a>00340    .send_text = <a class="code" href="chan__agent_8c.html#a6a274684b44aca5084022c8b50c81309">agent_sendtext</a>,
<a name="l00341"></a>00341    .exception = <a class="code" href="chan__agent_8c.html#ab09227c04051d8b1a0c421b6ba68cc29">agent_read</a>,
<a name="l00342"></a>00342    .indicate = <a class="code" href="chan__agent_8c.html#a8e7c69e6b30d08458067cb669bcce289">agent_indicate</a>,
<a name="l00343"></a>00343    .fixup = <a class="code" href="chan__agent_8c.html#a3c12367375202f815f2d2707c3234057">agent_fixup</a>,
<a name="l00344"></a>00344    .bridged_channel = <a class="code" href="chan__agent_8c.html#a2f64da89547dd17397ddd13e621ecf56">agent_bridgedchannel</a>,
<a name="l00345"></a>00345    .get_base_channel = <a class="code" href="chan__agent_8c.html#ac7b1aa68055aa0f5651729d538a6ec3e" title="return the channel or base channel if one exists. This function assumes the channel...">agent_get_base_channel</a>,
<a name="l00346"></a>00346    .set_base_channel = <a class="code" href="chan__agent_8c.html#aedc0a581008a430e15554c6971b5640c">agent_set_base_channel</a>,
<a name="l00347"></a>00347 };
<a name="l00348"></a>00348 <span class="comment"></span>
<a name="l00349"></a>00349 <span class="comment">/*!</span>
<a name="l00350"></a>00350 <span class="comment"> * Adds an agent to the global list of agents.</span>
<a name="l00351"></a>00351 <span class="comment"> *</span>
<a name="l00352"></a>00352 <span class="comment"> * \param agent A string with the username, password and real name of an agent. As defined in agents.conf. Example: &quot;13,169,John Smith&quot;</span>
<a name="l00353"></a>00353 <span class="comment"> * \param pending If it is pending or not.</span>
<a name="l00354"></a>00354 <span class="comment"> * @return The just created agent.</span>
<a name="l00355"></a>00355 <span class="comment"> * \sa agent_pvt, agents.</span>
<a name="l00356"></a>00356 <span class="comment"> */</span>
<a name="l00357"></a><a class="code" href="chan__agent_8c.html#aadf5bf36195ebd800f3dd7eeeef9049b">00357</a> <span class="keyword">static</span> <span class="keyword">struct </span>agent_pvt *<a class="code" href="chan__agent_8c.html#aadf5bf36195ebd800f3dd7eeeef9049b">add_agent</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, <span class="keywordtype">int</span> <a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a>)
<a name="l00358"></a>00358 {
<a name="l00359"></a>00359    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l00360"></a>00360    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l00361"></a>00361       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(agt);
<a name="l00362"></a>00362       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structagent__pvt.html#a89ef5ad192d222ee54b1e0c4edf45cb6">password</a>);
<a name="l00363"></a>00363       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>);
<a name="l00364"></a>00364    );
<a name="l00365"></a>00365    <span class="keywordtype">char</span> *<a class="code" href="structagent__pvt.html#a89ef5ad192d222ee54b1e0c4edf45cb6">password</a> = NULL;
<a name="l00366"></a>00366    <span class="keywordtype">char</span> *<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a> = NULL;
<a name="l00367"></a>00367    <span class="keywordtype">char</span> *agt = NULL;
<a name="l00368"></a>00368    <span class="keyword">struct </span>agent_pvt *p;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(agent);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372    <span class="comment">/* Extract username (agt), password and name from agent (args). */</span>
<a name="l00373"></a>00373    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l00374"></a>00374 
<a name="l00375"></a>00375    <span class="keywordflow">if</span>(args.argc == 0) {
<a name="l00376"></a>00376       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;A blank agent line!\n&quot;</span>);
<a name="l00377"></a>00377       <span class="keywordflow">return</span> NULL;
<a name="l00378"></a>00378    }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380    <span class="keywordflow">if</span>(<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.agt) ) {
<a name="l00381"></a>00381       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;An agent line with no agentid!\n&quot;</span>);
<a name="l00382"></a>00382       <span class="keywordflow">return</span> NULL;
<a name="l00383"></a>00383    } <span class="keywordflow">else</span>
<a name="l00384"></a>00384       agt = args.agt;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386    <span class="keywordflow">if</span>(!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.password)) {
<a name="l00387"></a>00387       password = args.password;
<a name="l00388"></a>00388       <span class="keywordflow">while</span> (*password &amp;&amp; *password &lt; 33) password++;
<a name="l00389"></a>00389    }
<a name="l00390"></a>00390    <span class="keywordflow">if</span>(!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.name)) {
<a name="l00391"></a>00391       name = args.name;
<a name="l00392"></a>00392       <span class="keywordflow">while</span> (*name &amp;&amp; *name &lt; 33) name++;
<a name="l00393"></a>00393    }
<a name="l00394"></a>00394    
<a name="l00395"></a>00395    <span class="comment">/* Are we searching for the agent here ? To see if it exists already ? */</span>
<a name="l00396"></a>00396    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l00397"></a>00397       <span class="keywordflow">if</span> (!pending &amp;&amp; !strcmp(p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, agt))
<a name="l00398"></a>00398          <span class="keywordflow">break</span>;
<a name="l00399"></a>00399    }
<a name="l00400"></a>00400    <span class="keywordflow">if</span> (!p) {
<a name="l00401"></a>00401       <span class="comment">// Build the agent.</span>
<a name="l00402"></a>00402       <span class="keywordflow">if</span> (!(p = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*p))))
<a name="l00403"></a>00403          <span class="keywordflow">return</span> NULL;
<a name="l00404"></a>00404       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, agt, <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>));
<a name="l00405"></a>00405       <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00406"></a>00406       <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#a16a593c509d04ae4f46b21ada53c2ea6">app_lock</a>);
<a name="l00407"></a>00407       <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#aedc0136c518c393de8b46d60b9018c3f">app_complete_cond</a>, NULL);
<a name="l00408"></a>00408       p-&gt;<a class="code" href="structagent__pvt.html#a13b86677f5f5b6ebc899aba01af8466a">app_lock_flag</a> = 0;
<a name="l00409"></a>00409       p-&gt;<a class="code" href="structagent__pvt.html#aef61dcc55e364d349e1b7420eb7c4ec9">app_sleep_cond</a> = 1;
<a name="l00410"></a>00410       p-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a> = group;
<a name="l00411"></a>00411       p-&gt;<a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a> = pending;
<a name="l00412"></a>00412       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;agents, p, list);
<a name="l00413"></a>00413    }
<a name="l00414"></a>00414    
<a name="l00415"></a>00415    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(p-&gt;<a class="code" href="structagent__pvt.html#a89ef5ad192d222ee54b1e0c4edf45cb6">password</a>, password ? password : <span class="stringliteral">&quot;&quot;</span>, <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structagent__pvt.html#a89ef5ad192d222ee54b1e0c4edf45cb6">password</a>));
<a name="l00416"></a>00416    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(p-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>, name ? name : <span class="stringliteral">&quot;&quot;</span>, <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>));
<a name="l00417"></a>00417    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(p-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>, moh, <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>));
<a name="l00418"></a>00418    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173a95b3856eae5d97e0aa2993019cba8a2d">AGENT_FLAG_ACKCALL</a>)) {
<a name="l00419"></a>00419       p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a> = ackcall;
<a name="l00420"></a>00420    }
<a name="l00421"></a>00421    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173ac649bc6edb894d204cdf584c319a73fd">AGENT_FLAG_AUTOLOGOFF</a>)) {
<a name="l00422"></a>00422       p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a> = autologoff;
<a name="l00423"></a>00423    }
<a name="l00424"></a>00424    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173a4c5894c85df72565d9ba1cb16e6b3bfc">AGENT_FLAG_ACCEPTDTMF</a>)) {
<a name="l00425"></a>00425       p-&gt;<a class="code" href="structagent__pvt.html#a97629727ac11792aa963aed4457abde8">acceptdtmf</a> = acceptdtmf;
<a name="l00426"></a>00426    }
<a name="l00427"></a>00427    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173a4542cbcf2199a92543eee76c28666ec3">AGENT_FLAG_ENDDTMF</a>)) {
<a name="l00428"></a>00428       p-&gt;<a class="code" href="structagent__pvt.html#a064a847aaeac6f1dc116434663517d16">enddtmf</a> = enddtmf;
<a name="l00429"></a>00429    }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431    <span class="comment">/* If someone reduces the wrapuptime and reloads, we want it</span>
<a name="l00432"></a>00432 <span class="comment">    * to change the wrapuptime immediately on all calls */</span>
<a name="l00433"></a>00433    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173adb917e73669ec6ef37d8ba1fdf3d287a">AGENT_FLAG_WRAPUPTIME</a>) &amp;&amp; p-&gt;<a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> &gt; wrapuptime) {
<a name="l00434"></a>00434       <span class="keyword">struct </span>timeval now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00435"></a>00435       <span class="comment">/* XXX check what is this exactly */</span>
<a name="l00436"></a>00436 
<a name="l00437"></a>00437       <span class="comment">/* We won&apos;t be pedantic and check the tv_usec val */</span>
<a name="l00438"></a>00438       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>.tv_sec &gt; (now.tv_sec + wrapuptime/1000)) {
<a name="l00439"></a>00439          p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>.tv_sec = now.tv_sec + wrapuptime/1000;
<a name="l00440"></a>00440          p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>.tv_usec = now.tv_usec;
<a name="l00441"></a>00441       }
<a name="l00442"></a>00442    }
<a name="l00443"></a>00443    p-&gt;<a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> = wrapuptime;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445    <span class="keywordflow">if</span> (pending)
<a name="l00446"></a>00446       p-&gt;<a class="code" href="structagent__pvt.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a> = 1;
<a name="l00447"></a>00447    <span class="keywordflow">else</span>
<a name="l00448"></a>00448       p-&gt;<a class="code" href="structagent__pvt.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a> = 0;
<a name="l00449"></a>00449    <span class="keywordflow">return</span> p;
<a name="l00450"></a>00450 }
<a name="l00451"></a>00451 <span class="comment"></span>
<a name="l00452"></a>00452 <span class="comment">/*!</span>
<a name="l00453"></a>00453 <span class="comment"> * Deletes an agent after doing some clean up.</span>
<a name="l00454"></a>00454 <span class="comment"> * Further documentation: How safe is this function ? What state should the agent be to be cleaned.</span>
<a name="l00455"></a>00455 <span class="comment"> * \param p Agent to be deleted.</span>
<a name="l00456"></a>00456 <span class="comment"> * \returns Always 0.</span>
<a name="l00457"></a>00457 <span class="comment"> */</span>
<a name="l00458"></a><a class="code" href="chan__agent_8c.html#abbb457e1f863facf1478eabb21e60032">00458</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#abbb457e1f863facf1478eabb21e60032">agent_cleanup</a>(<span class="keyword">struct</span> agent_pvt *p)
<a name="l00459"></a>00459 {
<a name="l00460"></a>00460    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>;
<a name="l00461"></a>00461    p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = NULL;
<a name="l00462"></a>00462    chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = NULL;
<a name="l00463"></a>00463    p-&gt;<a class="code" href="structagent__pvt.html#aef61dcc55e364d349e1b7420eb7c4ec9">app_sleep_cond</a> = 1;
<a name="l00464"></a>00464    <span class="comment">/* Release ownership of the agent to other threads (presumably running the login app). */</span>
<a name="l00465"></a>00465    p-&gt;<a class="code" href="structagent__pvt.html#a13b86677f5f5b6ebc899aba01af8466a">app_lock_flag</a> = 0;
<a name="l00466"></a>00466    <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#aedc0136c518c393de8b46d60b9018c3f">app_complete_cond</a>);
<a name="l00467"></a>00467    <span class="keywordflow">if</span> (chan)
<a name="l00468"></a>00468       <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>(chan);
<a name="l00469"></a>00469    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a>) {
<a name="l00470"></a>00470       <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00471"></a>00471       <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#a16a593c509d04ae4f46b21ada53c2ea6">app_lock</a>);
<a name="l00472"></a>00472       <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#aedc0136c518c393de8b46d60b9018c3f">app_complete_cond</a>);
<a name="l00473"></a>00473       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(p);
<a name="l00474"></a>00474         }
<a name="l00475"></a>00475    <span class="keywordflow">return</span> 0;
<a name="l00476"></a>00476 }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#adf789d0946fb080c371702bbcd2b5e81">check_availability</a>(<span class="keyword">struct</span> agent_pvt *newlyavailable, <span class="keywordtype">int</span> needlock);
<a name="l00479"></a>00479 
<a name="l00480"></a><a class="code" href="chan__agent_8c.html#a668fa4c341de32b01c8dadd209853e57">00480</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a668fa4c341de32b01c8dadd209853e57">agent_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast)
<a name="l00481"></a>00481 {
<a name="l00482"></a>00482    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Huh?  Agent is being asked to answer?\n&quot;</span>);
<a name="l00483"></a>00483    <span class="keywordflow">return</span> -1;
<a name="l00484"></a>00484 }
<a name="l00485"></a>00485 
<a name="l00486"></a><a class="code" href="chan__agent_8c.html#aed9ca74dc149ae2d4a5903ea9ebf512e">00486</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#aed9ca74dc149ae2d4a5903ea9ebf512e">__agent_start_monitoring</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">struct</span> agent_pvt *p, <span class="keywordtype">int</span> needlock)
<a name="l00487"></a>00487 {
<a name="l00488"></a>00488    <span class="keywordtype">char</span> tmp[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>],tmp2[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>], *pointer;
<a name="l00489"></a>00489    <span class="keywordtype">char</span> filename[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>];
<a name="l00490"></a>00490    <span class="keywordtype">int</span> res = -1;
<a name="l00491"></a>00491    <span class="keywordflow">if</span> (!p)
<a name="l00492"></a>00492       <span class="keywordflow">return</span> -1;
<a name="l00493"></a>00493    <span class="keywordflow">if</span> (!ast-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>) {
<a name="l00494"></a>00494       snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;agent-%s-%s&quot;</span>,p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, ast-&gt;uniqueid);
<a name="l00495"></a>00495       <span class="comment">/* substitute . for - */</span>
<a name="l00496"></a>00496       <span class="keywordflow">if</span> ((pointer = strchr(filename, <span class="charliteral">&apos;.&apos;</span>)))
<a name="l00497"></a>00497          *pointer = <span class="charliteral">&apos;-&apos;</span>;
<a name="l00498"></a>00498       snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s%s&quot;</span>, savecallsin, filename);
<a name="l00499"></a>00499       <a class="code" href="monitor_8h.html#a5c2b029a972b1819e2baaa63906d5bc6" title="Start monitoring a channel.">ast_monitor_start</a>(ast, recordformat, tmp, needlock, <a class="code" href="monitor_8h.html#a95b90f61870300ea984afae5123dd44f">X_REC_IN</a> | <a class="code" href="monitor_8h.html#ac03869f26afacb6d45355d401ced19d8">X_REC_OUT</a>);
<a name="l00500"></a>00500       <a class="code" href="monitor_8h.html#a170e08ebc79dab55c1ff3a5fd4d9214e">ast_monitor_setjoinfiles</a>(ast, 1);
<a name="l00501"></a>00501       snprintf(tmp2, <span class="keyword">sizeof</span>(tmp2), <span class="stringliteral">&quot;%s%s.%s&quot;</span>, urlprefix, filename, recordformatext);
<a name="l00502"></a>00502 <span class="preprocessor">#if 0</span>
<a name="l00503"></a>00503 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;name is %s, link is %s\n&quot;</span>,tmp, tmp2);
<a name="l00504"></a>00504 <span class="preprocessor">#endif</span>
<a name="l00505"></a>00505 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (!ast-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l00506"></a>00506          ast-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> = <a class="code" href="cdr_8h.html#a29ba08b358224b4c820e5df826273b5b" title="Allocate a CDR record.">ast_cdr_alloc</a>();
<a name="l00507"></a>00507       <a class="code" href="cdr_8h.html#a6c3458fc19a7e9eb5bdcff22378b30a4" title="Set CDR user field for channel (stored in CDR).">ast_cdr_setuserfield</a>(ast, tmp2);
<a name="l00508"></a>00508       res = 0;
<a name="l00509"></a>00509    } <span class="keywordflow">else</span>
<a name="l00510"></a>00510       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Recording already started on that call.\n&quot;</span>);
<a name="l00511"></a>00511    <span class="keywordflow">return</span> res;
<a name="l00512"></a>00512 }
<a name="l00513"></a>00513 
<a name="l00514"></a><a class="code" href="chan__agent_8c.html#a4f473892bce27a05251ca4e6f48dddef">00514</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a4f473892bce27a05251ca4e6f48dddef">agent_start_monitoring</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">int</span> needlock)
<a name="l00515"></a>00515 {
<a name="l00516"></a>00516    <span class="keywordflow">return</span> <a class="code" href="chan__agent_8c.html#aed9ca74dc149ae2d4a5903ea9ebf512e">__agent_start_monitoring</a>(ast, ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>, needlock);
<a name="l00517"></a>00517 }
<a name="l00518"></a>00518 
<a name="l00519"></a><a class="code" href="chan__agent_8c.html#ab09227c04051d8b1a0c421b6ba68cc29">00519</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="chan__agent_8c.html#ab09227c04051d8b1a0c421b6ba68cc29">agent_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast)
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521    <span class="keyword">struct </span>agent_pvt *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00522"></a>00522    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l00523"></a>00523    <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> answer_frame = { <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a9e3135920bd5bdbfd8c57fdaaa6b1dbe">AST_CONTROL_ANSWER</a> };
<a name="l00524"></a>00524    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>;
<a name="l00525"></a>00525    <span class="keywordtype">int</span> cur_time = time(NULL);
<a name="l00526"></a>00526    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00527"></a>00527    <a class="code" href="chan__agent_8c.html#a7c8f932558a7a591a38f7db0b35acf01">CHECK_FORMATS</a>(ast, p);
<a name="l00528"></a>00528    <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>) {
<a name="l00529"></a>00529       p-&gt;<a class="code" href="structagent__pvt.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a> = cur_time;
<a name="l00530"></a>00530    }
<a name="l00531"></a>00531    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l00532"></a>00532       <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, ast, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a75202bcfa58fce5d40e2daddc73b8d11">AST_FLAG_EXCEPTION</a>);
<a name="l00533"></a>00533       p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a3a804162c4be609a8def28f69b3e93b2">fdno</a> = (ast-&gt;<a class="code" href="structast__channel.html#a3a804162c4be609a8def28f69b3e93b2">fdno</a> == <a class="code" href="channel_8h.html#af031dd0c210dbd6cd67cc65abd104412">AST_AGENT_FD</a>) ? <a class="code" href="channel_8h.html#aa2c87e87fcb0c34e45f4596448dea70e">AST_TIMING_FD</a> : ast-&gt;<a class="code" href="structast__channel.html#a3a804162c4be609a8def28f69b3e93b2">fdno</a>;
<a name="l00534"></a>00534       f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00535"></a>00535    } <span class="keywordflow">else</span>
<a name="l00536"></a>00536       f = &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l00537"></a>00537    <span class="keywordflow">if</span> (!f) {
<a name="l00538"></a>00538       <span class="comment">/* If there&apos;s a channel, hang it up (if it&apos;s on a callback) make it NULL */</span>
<a name="l00539"></a>00539       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l00540"></a>00540          p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a81ab061f1622c159fe55ba4f17309cc5">_bridge</a> = NULL;
<a name="l00541"></a>00541          <span class="comment">/* Note that we don&apos;t hangup if it&apos;s not a callback because Asterisk will do it</span>
<a name="l00542"></a>00542 <span class="comment">            for us when the PBX instance that called login finishes */</span>
<a name="l00543"></a>00543          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>)) {
<a name="l00544"></a>00544             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l00545"></a>00545                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Bridge on &apos;%s&apos; being cleared (2)\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l00546"></a>00546             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l00547"></a>00547                <span class="keywordtype">int</span> howlong = cur_time - p-&gt;<a class="code" href="structagent__pvt.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;
<a name="l00548"></a>00548                <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a> &amp;&amp; howlong &gt;= p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a>) {
<a name="l00549"></a>00549                   p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a> = 0;
<a name="l00550"></a>00550                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Agent &apos;%s&apos; didn&apos;t answer/confirm within %d seconds (waited %d)\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>, p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a>, howlong);
<a name="l00551"></a>00551                   <a class="code" href="chan__agent_8c.html#a79fc2c717c9271fd4b5a3da318cc489c">agent_logoff_maintenance</a>(p, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, (cur_time = p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>), ast-&gt;uniqueid, <span class="stringliteral">&quot;Autologoff&quot;</span>);
<a name="l00552"></a>00552                }
<a name="l00553"></a>00553             }
<a name="l00554"></a>00554             status = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;CHANLOCALSTATUS&quot;</span>);
<a name="l00555"></a>00555             <span class="keywordflow">if</span> (autologoffunavail &amp;&amp; status &amp;&amp; !strcasecmp(status, <span class="stringliteral">&quot;CHANUNAVAIL&quot;</span>)) {
<a name="l00556"></a>00556                <span class="keywordtype">long</span> logintime = cur_time - p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>;
<a name="l00557"></a>00557                p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a> = 0;
<a name="l00558"></a>00558                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Agent read: &apos;%s&apos; is not available now, auto logoff\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>);
<a name="l00559"></a>00559                <a class="code" href="chan__agent_8c.html#a79fc2c717c9271fd4b5a3da318cc489c">agent_logoff_maintenance</a>(p, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, logintime, ast-&gt;uniqueid, <span class="stringliteral">&quot;Chanunavail&quot;</span>);
<a name="l00560"></a>00560             }
<a name="l00561"></a>00561             <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00562"></a>00562             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> &amp;&amp; p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a>)
<a name="l00563"></a>00563                p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a> = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a>, 1000));
<a name="l00564"></a>00564          }
<a name="l00565"></a>00565          p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = NULL;
<a name="l00566"></a>00566          <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>, <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l00567"></a>00567          p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> = 0;
<a name="l00568"></a>00568       }
<a name="l00569"></a>00569    } <span class="keywordflow">else</span> {
<a name="l00570"></a>00570       <span class="comment">/* if acknowledgement is not required, and the channel is up, we may have missed</span>
<a name="l00571"></a>00571 <span class="comment">         an AST_CONTROL_ANSWER (if there was one), so mark the call acknowledged anyway */</span>
<a name="l00572"></a>00572       <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a> &amp;&amp; !p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> &amp;&amp; p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp; (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)) {
<a name="l00573"></a>00573          p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> = 1;
<a name="l00574"></a>00574       }
<a name="l00575"></a>00575 
<a name="l00576"></a>00576       <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a>) {
<a name="l00577"></a>00577          <span class="keywordtype">int</span> howlong = cur_time - p-&gt;<a class="code" href="structagent__pvt.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;
<a name="l00578"></a>00578          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a> &amp;&amp; (howlong &gt;= p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a>)) {
<a name="l00579"></a>00579             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Agent &apos;%s&apos; didn&apos;t answer/confirm within %d seconds (waited %d)\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>, p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a>, howlong);
<a name="l00580"></a>00580             <a class="code" href="chan__agent_8c.html#a79fc2c717c9271fd4b5a3da318cc489c">agent_logoff_maintenance</a>(p, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, (cur_time - p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>), ast-&gt;uniqueid, <span class="stringliteral">&quot;Autologoff&quot;</span>);
<a name="l00581"></a>00581             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> || p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l00582"></a>00582                <span class="keywordflow">while</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; <a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)) {
<a name="l00583"></a>00583                   <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00584"></a>00584                }
<a name="l00585"></a>00585                <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l00586"></a>00586                   <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2b3b711afc65059c4b51008c9fbc7aee">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l00587"></a>00587                   <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>);
<a name="l00588"></a>00588                }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590                <span class="keywordflow">while</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp; <a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)) {
<a name="l00591"></a>00591                   <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00592"></a>00592                }
<a name="l00593"></a>00593                <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l00594"></a>00594                   <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2b3b711afc65059c4b51008c9fbc7aee">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l00595"></a>00595                   <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00596"></a>00596                }
<a name="l00597"></a>00597             } <span class="keywordflow">else</span> {
<a name="l00598"></a>00598                <span class="keywordtype">long</span> logintime;
<a name="l00599"></a>00599                logintime = time(NULL) - p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>;
<a name="l00600"></a>00600                p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a> = 0;
<a name="l00601"></a>00601                <a class="code" href="chan__agent_8c.html#a79fc2c717c9271fd4b5a3da318cc489c">agent_logoff_maintenance</a>(p, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, logintime, NULL, <span class="stringliteral">&quot;CommandLogoff&quot;</span>);
<a name="l00602"></a>00602             }
<a name="l00603"></a>00603          }
<a name="l00604"></a>00604       }
<a name="l00605"></a>00605       <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>) {
<a name="l00606"></a>00606       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>:
<a name="l00607"></a>00607          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a9e3135920bd5bdbfd8c57fdaaa6b1dbe">AST_CONTROL_ANSWER</a>) {
<a name="l00608"></a>00608             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a>) {
<a name="l00609"></a>00609                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;%s answered, waiting for &apos;%c&apos; to acknowledge\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, p-&gt;<a class="code" href="structagent__pvt.html#a97629727ac11792aa963aed4457abde8">acceptdtmf</a>);
<a name="l00610"></a>00610                <span class="comment">/* Don&apos;t pass answer along */</span>
<a name="l00611"></a>00611                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00612"></a>00612                f = &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l00613"></a>00613             } <span class="keywordflow">else</span> {
<a name="l00614"></a>00614                p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> = 1;
<a name="l00615"></a>00615                <span class="comment">/* Use the builtin answer frame for the </span>
<a name="l00616"></a>00616 <span class="comment">                  recording start check below. */</span>
<a name="l00617"></a>00617                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00618"></a>00618                f = &amp;answer_frame;
<a name="l00619"></a>00619             }
<a name="l00620"></a>00620          }
<a name="l00621"></a>00621          <span class="keywordflow">break</span>;
<a name="l00622"></a>00622       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a>:
<a name="l00623"></a>00623          <span class="comment">/*ignore DTMF begin&apos;s as it can cause issues with queue announce files*/</span>
<a name="l00624"></a>00624          <span class="keywordflow">if</span>((!p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == p-&gt;<a class="code" href="structagent__pvt.html#a97629727ac11792aa963aed4457abde8">acceptdtmf</a>) || (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == p-&gt;<a class="code" href="structagent__pvt.html#a064a847aaeac6f1dc116434663517d16">enddtmf</a> &amp;&amp; endcall)){
<a name="l00625"></a>00625             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00626"></a>00626             f = &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l00627"></a>00627          }
<a name="l00628"></a>00628          <span class="keywordflow">break</span>;
<a name="l00629"></a>00629       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>:
<a name="l00630"></a>00630          <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == p-&gt;<a class="code" href="structagent__pvt.html#a97629727ac11792aa963aed4457abde8">acceptdtmf</a>)) {
<a name="l00631"></a>00631             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;%s acknowledged\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l00632"></a>00632             p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> = 1;
<a name="l00633"></a>00633             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00634"></a>00634             f = &amp;answer_frame;
<a name="l00635"></a>00635          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == p-&gt;<a class="code" href="structagent__pvt.html#a064a847aaeac6f1dc116434663517d16">enddtmf</a> &amp;&amp; endcall) {
<a name="l00636"></a>00636             <span class="comment">/* terminates call */</span>
<a name="l00637"></a>00637             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00638"></a>00638             f = NULL;
<a name="l00639"></a>00639          }
<a name="l00640"></a>00640          <span class="keywordflow">break</span>;
<a name="l00641"></a>00641       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>:
<a name="l00642"></a>00642       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>:
<a name="l00643"></a>00643          <span class="comment">/* don&apos;t pass voice or video until the call is acknowledged */</span>
<a name="l00644"></a>00644          <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a>) {
<a name="l00645"></a>00645             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00646"></a>00646             f = &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l00647"></a>00647          }
<a name="l00648"></a>00648       <span class="keywordflow">default</span>:
<a name="l00649"></a>00649          <span class="comment">/* pass everything else on through */</span>
<a name="l00650"></a>00650          <span class="keywordflow">break</span>;
<a name="l00651"></a>00651       }
<a name="l00652"></a>00652    }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654    <a class="code" href="chan__agent_8c.html#a83ca79d80f5e17956e7a50bf35994bcb" title="Cleanup moves all the relevant FD&amp;#39;s from the 2nd to the first, but retains things...">CLEANUP</a>(ast,p);
<a name="l00655"></a>00655    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp; !p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a81ab061f1622c159fe55ba4f17309cc5">_bridge</a>) {
<a name="l00656"></a>00656       <span class="keywordflow">if</span> (strcasecmp(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a>, <span class="stringliteral">&quot;Local&quot;</span>)) {
<a name="l00657"></a>00657          p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a81ab061f1622c159fe55ba4f17309cc5">_bridge</a> = ast;
<a name="l00658"></a>00658          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l00659"></a>00659             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Bridge on &apos;%s&apos; being set to &apos;%s&apos; (3)\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a81ab061f1622c159fe55ba4f17309cc5">_bridge</a>-&gt;name);
<a name="l00660"></a>00660       }
<a name="l00661"></a>00661    }
<a name="l00662"></a>00662    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00663"></a>00663    <span class="keywordflow">if</span> (recordagentcalls &amp;&amp; f == &amp;answer_frame)
<a name="l00664"></a>00664       <a class="code" href="chan__agent_8c.html#a4f473892bce27a05251ca4e6f48dddef">agent_start_monitoring</a>(ast,0);
<a name="l00665"></a>00665    <span class="keywordflow">return</span> f;
<a name="l00666"></a>00666 }
<a name="l00667"></a>00667 
<a name="l00668"></a><a class="code" href="chan__agent_8c.html#ae1d9818e04452dd0d2efed16ba8f91d2">00668</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#ae1d9818e04452dd0d2efed16ba8f91d2">agent_sendhtml</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>)
<a name="l00669"></a>00669 {
<a name="l00670"></a>00670    <span class="keyword">struct </span>agent_pvt *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00671"></a>00671    <span class="keywordtype">int</span> res = -1;
<a name="l00672"></a>00672    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00673"></a>00673    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) 
<a name="l00674"></a>00674       res = <a class="code" href="channel_8h.html#a3e312ad1e633f10ca1ddde436a117ef4">ast_channel_sendhtml</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, subclass, data, datalen);
<a name="l00675"></a>00675    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00676"></a>00676    <span class="keywordflow">return</span> res;
<a name="l00677"></a>00677 }
<a name="l00678"></a>00678 
<a name="l00679"></a><a class="code" href="chan__agent_8c.html#a6a274684b44aca5084022c8b50c81309">00679</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a6a274684b44aca5084022c8b50c81309">agent_sendtext</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>)
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681    <span class="keyword">struct </span>agent_pvt *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00682"></a>00682    <span class="keywordtype">int</span> res = -1;
<a name="l00683"></a>00683    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00684"></a>00684    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) 
<a name="l00685"></a>00685       res = <a class="code" href="channel_8h.html#a83631e0dc02a50802cf857caa3fdc1d7" title="Sends text to a channel.">ast_sendtext</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, text);
<a name="l00686"></a>00686    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00687"></a>00687    <span class="keywordflow">return</span> res;
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689 
<a name="l00690"></a><a class="code" href="chan__agent_8c.html#ab21b4d4720f9ee2a4c9af80e8c752da1">00690</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#ab21b4d4720f9ee2a4c9af80e8c752da1">agent_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)
<a name="l00691"></a>00691 {
<a name="l00692"></a>00692    <span class="keyword">struct </span>agent_pvt *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00693"></a>00693    <span class="keywordtype">int</span> res = -1;
<a name="l00694"></a>00694    <a class="code" href="chan__agent_8c.html#a7c8f932558a7a591a38f7db0b35acf01">CHECK_FORMATS</a>(ast, p);
<a name="l00695"></a>00695    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00696"></a>00696    <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) 
<a name="l00697"></a>00697       res = 0;
<a name="l00698"></a>00698    <span class="keywordflow">else</span> {
<a name="l00699"></a>00699       <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) ||
<a name="l00700"></a>00700           (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) ||
<a name="l00701"></a>00701           (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>)) {
<a name="l00702"></a>00702          res = <a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, f);
<a name="l00703"></a>00703       } <span class="keywordflow">else</span> {
<a name="l00704"></a>00704          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Dropping one incompatible %s frame on &apos;%s&apos; to &apos;%s&apos;\n&quot;</span>, 
<a name="l00705"></a>00705             f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a> ? <span class="stringliteral">&quot;audio&quot;</span> : <span class="stringliteral">&quot;video&quot;</span>,
<a name="l00706"></a>00706             ast-&gt;name, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l00707"></a>00707          res = 0;
<a name="l00708"></a>00708       }
<a name="l00709"></a>00709    }
<a name="l00710"></a>00710    <a class="code" href="chan__agent_8c.html#a83ca79d80f5e17956e7a50bf35994bcb" title="Cleanup moves all the relevant FD&amp;#39;s from the 2nd to the first, but retains things...">CLEANUP</a>(ast, p);
<a name="l00711"></a>00711    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00712"></a>00712    <span class="keywordflow">return</span> res;
<a name="l00713"></a>00713 }
<a name="l00714"></a>00714 
<a name="l00715"></a><a class="code" href="chan__agent_8c.html#a3c12367375202f815f2d2707c3234057">00715</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a3c12367375202f815f2d2707c3234057">agent_fixup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *oldchan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *newchan)
<a name="l00716"></a>00716 {
<a name="l00717"></a>00717    <span class="keyword">struct </span>agent_pvt *p = newchan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00718"></a>00718    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00719"></a>00719    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> != oldchan) {
<a name="l00720"></a>00720       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;old channel wasn&apos;t %p but was %p\n&quot;</span>, oldchan, p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>);
<a name="l00721"></a>00721       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00722"></a>00722       <span class="keywordflow">return</span> -1;
<a name="l00723"></a>00723    }
<a name="l00724"></a>00724    p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = newchan;
<a name="l00725"></a>00725    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00726"></a>00726    <span class="keywordflow">return</span> 0;
<a name="l00727"></a>00727 }
<a name="l00728"></a>00728 
<a name="l00729"></a><a class="code" href="chan__agent_8c.html#a8e7c69e6b30d08458067cb669bcce289">00729</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a8e7c69e6b30d08458067cb669bcce289">agent_indicate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">int</span> condition, <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> datalen)
<a name="l00730"></a>00730 {
<a name="l00731"></a>00731    <span class="keyword">struct </span>agent_pvt *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00732"></a>00732    <span class="keywordtype">int</span> res = -1;
<a name="l00733"></a>00733    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00734"></a>00734    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp; !<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)) {
<a name="l00735"></a>00735       <span class="keywordflow">while</span> (<a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)) {
<a name="l00736"></a>00736          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(ast);
<a name="l00737"></a>00737          usleep(1);
<a name="l00738"></a>00738          <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(ast);
<a name="l00739"></a>00739       }
<a name="l00740"></a>00740       res = p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a21e97c64bf4c9c328fa344d29ee1c065" title="Indicate a particular condition (e.g. AST_CONTROL_BUSY or AST_CONTROL_RINGING or...">indicate</a> ? p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a21e97c64bf4c9c328fa344d29ee1c065" title="Indicate a particular condition (e.g. AST_CONTROL_BUSY or AST_CONTROL_RINGING or...">indicate</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, condition, data, datalen) : -1;
<a name="l00741"></a>00741       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00742"></a>00742    } <span class="keywordflow">else</span>
<a name="l00743"></a>00743       res = 0;
<a name="l00744"></a>00744    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00745"></a>00745    <span class="keywordflow">return</span> res;
<a name="l00746"></a>00746 }
<a name="l00747"></a>00747 
<a name="l00748"></a><a class="code" href="chan__agent_8c.html#ac024a2bb36ff8f5230acfde506e36aed">00748</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#ac024a2bb36ff8f5230acfde506e36aed">agent_digit_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> digit)
<a name="l00749"></a>00749 {
<a name="l00750"></a>00750    <span class="keyword">struct </span>agent_pvt *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00751"></a>00751    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00752"></a>00752    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l00753"></a>00753       <a class="code" href="channel_8h.html#a38f90349e730b6556cfe8b99b134d574" title="Send a DTMF digit to a channel Send a DTMF digit to a channel.">ast_senddigit_begin</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, digit);
<a name="l00754"></a>00754    }
<a name="l00755"></a>00755    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00756"></a>00756    <span class="keywordflow">return</span> 0;
<a name="l00757"></a>00757 }
<a name="l00758"></a>00758 
<a name="l00759"></a><a class="code" href="chan__agent_8c.html#a0e7b82a6c726ad55417af0cc314ecd51">00759</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a0e7b82a6c726ad55417af0cc314ecd51">agent_digit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> digit, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration)
<a name="l00760"></a>00760 {
<a name="l00761"></a>00761    <span class="keyword">struct </span>agent_pvt *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00762"></a>00762    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00763"></a>00763    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l00764"></a>00764       <a class="code" href="channel_8h.html#ab45db8cf33a706a5831d553d5199c143" title="Send a DTMF digit to a channel.">ast_senddigit_end</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, digit, duration);
<a name="l00765"></a>00765    }
<a name="l00766"></a>00766    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00767"></a>00767    <span class="keywordflow">return</span> 0;
<a name="l00768"></a>00768 }
<a name="l00769"></a>00769 
<a name="l00770"></a><a class="code" href="chan__agent_8c.html#aba8dc70f68a51ff9af11c751d438195d">00770</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#aba8dc70f68a51ff9af11c751d438195d">agent_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> timeout)
<a name="l00771"></a>00771 {
<a name="l00772"></a>00772    <span class="keyword">struct </span>agent_pvt *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00773"></a>00773    <span class="keywordtype">int</span> res = -1;
<a name="l00774"></a>00774    <span class="keywordtype">int</span> newstate=0;
<a name="l00775"></a>00775    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00776"></a>00776    p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> = 0;
<a name="l00777"></a>00777    <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l00778"></a>00778       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a>) {
<a name="l00779"></a>00779          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Pretending to dial on pending agent\n&quot;</span>);
<a name="l00780"></a>00780          newstate = <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa70881e902c6c29f27ffba80bb43554f">AST_STATE_DIALING</a>;
<a name="l00781"></a>00781          res = 0;
<a name="l00782"></a>00782       } <span class="keywordflow">else</span> {
<a name="l00783"></a>00783          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Whoa, they hung up between alloc and call...  what are the odds of that?\n&quot;</span>);
<a name="l00784"></a>00784          res = -1;
<a name="l00785"></a>00785       }
<a name="l00786"></a>00786       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00787"></a>00787       <span class="keywordflow">if</span> (newstate)
<a name="l00788"></a>00788          <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(ast, newstate);
<a name="l00789"></a>00789       <span class="keywordflow">return</span> res;
<a name="l00790"></a>00790    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>)) {
<a name="l00791"></a>00791       time(&amp;p-&gt;<a class="code" href="structagent__pvt.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>);
<a name="l00792"></a>00792       <span class="comment">/* Call on this agent */</span>
<a name="l00793"></a>00793       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;outgoing agentcall, to agent &apos;%s&apos;, on &apos;%s&apos;\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l00794"></a>00794       <a class="code" href="channel_8h.html#a88d833a56ea7de33e230281c5c12b75d" title="Set caller ID number, name and ANI.">ast_set_callerid</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>,
<a name="l00795"></a>00795          ast-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, ast-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, NULL);
<a name="l00796"></a>00796       <a class="code" href="channel_8h.html#a892b6550a4f90b70ad92198c9d05cedc" title="Inherits channel variable from parent to child channel.">ast_channel_inherit_variables</a>(ast, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00797"></a>00797       res = <a class="code" href="channel_8h.html#ae212e5f3ae50a869bbf859fe9db7dee0" title="Make a call.">ast_call</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, 0);
<a name="l00798"></a>00798       <a class="code" href="chan__agent_8c.html#a83ca79d80f5e17956e7a50bf35994bcb" title="Cleanup moves all the relevant FD&amp;#39;s from the 2nd to the first, but retains things...">CLEANUP</a>(ast,p);
<a name="l00799"></a>00799       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00800"></a>00800       <span class="keywordflow">return</span> res;
<a name="l00801"></a>00801    }
<a name="l00802"></a>00802    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;agent_call, call to agent &apos;%s&apos; call on &apos;%s&apos;\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l00803"></a>00803    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Playing beep, lang &apos;%s&apos;\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language);
<a name="l00804"></a>00804    res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, beep, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language);
<a name="l00805"></a>00805    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Played beep, result &apos;%d&apos;\n&quot;</span>, res);
<a name="l00806"></a>00806    <span class="keywordflow">if</span> (!res) {
<a name="l00807"></a>00807       res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00808"></a>00808       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Waited for stream, result &apos;%d&apos;\n&quot;</span>, res);
<a name="l00809"></a>00809    }
<a name="l00810"></a>00810    <span class="keywordflow">if</span> (!res) {
<a name="l00811"></a>00811       res = <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>));
<a name="l00812"></a>00812       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Set read format, result &apos;%d&apos;\n&quot;</span>, res);
<a name="l00813"></a>00813       <span class="keywordflow">if</span> (res)
<a name="l00814"></a>00814          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set read format to %s\n&quot;</span>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(<a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>)));
<a name="l00815"></a>00815    } <span class="keywordflow">else</span> {
<a name="l00816"></a>00816       <span class="comment">/* Agent hung-up */</span>
<a name="l00817"></a>00817       p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = NULL;
<a name="l00818"></a>00818       <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>, <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l00819"></a>00819    }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821    <span class="keywordflow">if</span> (!res) {
<a name="l00822"></a>00822       res = <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>));
<a name="l00823"></a>00823       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Set write format, result &apos;%d&apos;\n&quot;</span>, res);
<a name="l00824"></a>00824       <span class="keywordflow">if</span> (res)
<a name="l00825"></a>00825          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set write format to %s\n&quot;</span>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(<a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>)));
<a name="l00826"></a>00826    }
<a name="l00827"></a>00827    <span class="keywordflow">if</span>(!res) {
<a name="l00828"></a>00828       <span class="comment">/* Call is immediately up, or might need ack */</span>
<a name="l00829"></a>00829       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a> &gt; 1)
<a name="l00830"></a>00830          newstate = <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a5bf03bd84f434acaeefdacb0096e1baa">AST_STATE_RINGING</a>;
<a name="l00831"></a>00831       <span class="keywordflow">else</span> {
<a name="l00832"></a>00832          newstate = <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>;
<a name="l00833"></a>00833          <span class="keywordflow">if</span> (recordagentcalls)
<a name="l00834"></a>00834             <a class="code" href="chan__agent_8c.html#a4f473892bce27a05251ca4e6f48dddef">agent_start_monitoring</a>(ast, 0);
<a name="l00835"></a>00835          p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> = 1;
<a name="l00836"></a>00836       }
<a name="l00837"></a>00837       res = 0;
<a name="l00838"></a>00838    }
<a name="l00839"></a>00839    <a class="code" href="chan__agent_8c.html#a83ca79d80f5e17956e7a50bf35994bcb" title="Cleanup moves all the relevant FD&amp;#39;s from the 2nd to the first, but retains things...">CLEANUP</a>(ast, p);
<a name="l00840"></a>00840    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00841"></a>00841    <span class="keywordflow">if</span> (newstate)
<a name="l00842"></a>00842       <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(ast, newstate);
<a name="l00843"></a>00843    <span class="keywordflow">return</span> res;
<a name="l00844"></a>00844 }
<a name="l00845"></a>00845 <span class="comment"></span>
<a name="l00846"></a>00846 <span class="comment">/*! \brief store/clear the global variable that stores agentid based on the callerid */</span>
<a name="l00847"></a><a class="code" href="chan__agent_8c.html#a2b0c86613090f2a5ff7c16eaca4601d5">00847</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__agent_8c.html#a2b0c86613090f2a5ff7c16eaca4601d5" title="store/clear the global variable that stores agentid based on the callerid">set_agentbycallerid</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>)
<a name="l00848"></a>00848 {
<a name="l00849"></a>00849    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>];
<a name="l00850"></a>00850 
<a name="l00851"></a>00851    <span class="comment">/* if there is no Caller ID, nothing to do */</span>
<a name="l00852"></a>00852    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(callerid))
<a name="l00853"></a>00853       <span class="keywordflow">return</span>;
<a name="l00854"></a>00854 
<a name="l00855"></a>00855    snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;%s_%s&quot;</span>, <a class="code" href="chan__agent_8c.html#a8bdad3e572ba87281b8face9e122917e">GETAGENTBYCALLERID</a>, callerid);
<a name="l00856"></a>00856    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(NULL, buf, agent);
<a name="l00857"></a>00857 }
<a name="l00858"></a>00858 <span class="comment"></span>
<a name="l00859"></a>00859 <span class="comment">/*! \brief return the channel or base channel if one exists.  This function assumes the channel it is called on is already locked */</span>
<a name="l00860"></a><a class="code" href="chan__agent_8c.html#ac7b1aa68055aa0f5651729d538a6ec3e">00860</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a>* <a class="code" href="chan__agent_8c.html#ac7b1aa68055aa0f5651729d538a6ec3e" title="return the channel or base channel if one exists. This function assumes the channel...">agent_get_base_channel</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l00861"></a>00861 {
<a name="l00862"></a>00862    <span class="keyword">struct </span>agent_pvt *p = NULL;
<a name="l00863"></a>00863    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *base = chan;
<a name="l00864"></a>00864 
<a name="l00865"></a>00865    <span class="comment">/* chan is locked by the calling function */</span>
<a name="l00866"></a>00866    <span class="keywordflow">if</span> (!chan || !chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>) {
<a name="l00867"></a>00867       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;whoa, you need a channel (0x%ld) with a tech_pvt (0x%ld) to get a base channel.\n&quot;</span>, (<span class="keywordtype">long</span>)chan, (chan)?(<span class="keywordtype">long</span>)chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>:(<span class="keywordtype">long</span>)NULL);
<a name="l00868"></a>00868       <span class="keywordflow">return</span> NULL;
<a name="l00869"></a>00869    }
<a name="l00870"></a>00870    p = chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00871"></a>00871    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) 
<a name="l00872"></a>00872       base = p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l00873"></a>00873    <span class="keywordflow">return</span> base;
<a name="l00874"></a>00874 }
<a name="l00875"></a>00875 
<a name="l00876"></a><a class="code" href="chan__agent_8c.html#aedc0a581008a430e15554c6971b5640c">00876</a> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#aedc0a581008a430e15554c6971b5640c">agent_set_base_channel</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *base)
<a name="l00877"></a>00877 {
<a name="l00878"></a>00878    <span class="keyword">struct </span>agent_pvt *p = NULL;
<a name="l00879"></a>00879    
<a name="l00880"></a>00880    <span class="keywordflow">if</span> (!chan || !base) {
<a name="l00881"></a>00881       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;whoa, you need a channel (0x%ld) and a base channel (0x%ld) for setting.\n&quot;</span>, (<span class="keywordtype">long</span>)chan, (<span class="keywordtype">long</span>)base);
<a name="l00882"></a>00882       <span class="keywordflow">return</span> -1;
<a name="l00883"></a>00883    }
<a name="l00884"></a>00884    p = chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00885"></a>00885    <span class="keywordflow">if</span> (!p) {
<a name="l00886"></a>00886       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;whoa, channel %s is missing his tech_pvt structure!!.\n&quot;</span>, chan-&gt;name);
<a name="l00887"></a>00887       <span class="keywordflow">return</span> -1;
<a name="l00888"></a>00888    }
<a name="l00889"></a>00889    p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = base;
<a name="l00890"></a>00890    <span class="keywordflow">return</span> 0;
<a name="l00891"></a>00891 }
<a name="l00892"></a>00892 
<a name="l00893"></a><a class="code" href="chan__agent_8c.html#a758a57d73f94e44c4df778a804b03c97">00893</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a758a57d73f94e44c4df778a804b03c97">agent_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast)
<a name="l00894"></a>00894 {
<a name="l00895"></a>00895    <span class="keyword">struct </span>agent_pvt *p = ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00896"></a>00896    <span class="keywordtype">int</span> howlong = 0;
<a name="l00897"></a>00897    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>;
<a name="l00898"></a>00898    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00899"></a>00899    p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = NULL;
<a name="l00900"></a>00900    ast-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = NULL;
<a name="l00901"></a>00901    p-&gt;<a class="code" href="structagent__pvt.html#aef61dcc55e364d349e1b7420eb7c4ec9">app_sleep_cond</a> = 1;
<a name="l00902"></a>00902    p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> = 0;
<a name="l00903"></a>00903 
<a name="l00904"></a>00904    <span class="comment">/* if they really are hung up then set start to 0 so the test</span>
<a name="l00905"></a>00905 <span class="comment">    * later if we&apos;re called on an already downed channel</span>
<a name="l00906"></a>00906 <span class="comment">    * doesn&apos;t cause an agent to be logged out like when</span>
<a name="l00907"></a>00907 <span class="comment">    * agent_request() is followed immediately by agent_hangup()</span>
<a name="l00908"></a>00908 <span class="comment">    * as in apps/app_chanisavail.c:chanavail_exec()</span>
<a name="l00909"></a>00909 <span class="comment">    */</span>
<a name="l00910"></a>00910 
<a name="l00911"></a>00911    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Hangup called for state %s\n&quot;</span>, <a class="code" href="channel_8h.html#ac97b5983ea4bf3cc217ea898ca002759" title="Gives the string form of a given channel state.">ast_state2str</a>(ast-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a>));
<a name="l00912"></a>00912    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a> &amp;&amp; (ast-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)) {
<a name="l00913"></a>00913       howlong = time(NULL) - p-&gt;<a class="code" href="structagent__pvt.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;
<a name="l00914"></a>00914       p-&gt;<a class="code" href="structagent__pvt.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a> = 0;
<a name="l00915"></a>00915    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ast-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660addb60fd97b55a4aea24f992e30fe3c84">AST_STATE_RESERVED</a>) 
<a name="l00916"></a>00916       howlong = 0;
<a name="l00917"></a>00917    <span class="keywordflow">else</span>
<a name="l00918"></a>00918       p-&gt;<a class="code" href="structagent__pvt.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a> = 0; 
<a name="l00919"></a>00919    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l00920"></a>00920       p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a81ab061f1622c159fe55ba4f17309cc5">_bridge</a> = NULL;
<a name="l00921"></a>00921       <span class="comment">/* If they&apos;re dead, go ahead and hang up on the agent now */</span>
<a name="l00922"></a>00922       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>)) {
<a name="l00923"></a>00923          <span class="comment">/* Store last disconnect time */</span>
<a name="l00924"></a>00924          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a>)
<a name="l00925"></a>00925             p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a> = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a>, 1000));
<a name="l00926"></a>00926          <span class="keywordflow">else</span>
<a name="l00927"></a>00927             p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a> = <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0,0);
<a name="l00928"></a>00928          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l00929"></a>00929             status = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;CHANLOCALSTATUS&quot;</span>);
<a name="l00930"></a>00930             <span class="keywordflow">if</span> (autologoffunavail &amp;&amp; status &amp;&amp; !strcasecmp(status, <span class="stringliteral">&quot;CHANUNAVAIL&quot;</span>)) {
<a name="l00931"></a>00931                <span class="keywordtype">long</span> logintime = time(NULL) - p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>;
<a name="l00932"></a>00932                p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a> = 0;
<a name="l00933"></a>00933                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Agent hangup: &apos;%s&apos; is not available now, auto logoff\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>);
<a name="l00934"></a>00934                <a class="code" href="chan__agent_8c.html#a79fc2c717c9271fd4b5a3da318cc489c">agent_logoff_maintenance</a>(p, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, logintime, ast-&gt;uniqueid, <span class="stringliteral">&quot;Chanunavail&quot;</span>);
<a name="l00935"></a>00935             }
<a name="l00936"></a>00936             <span class="comment">/* Recognize the hangup and pass it along immediately */</span>
<a name="l00937"></a>00937             <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00938"></a>00938             p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = NULL;
<a name="l00939"></a>00939             <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>, <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l00940"></a>00940          }
<a name="l00941"></a>00941          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Hungup, howlong is %d, autologoff is %d\n&quot;</span>, howlong, p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a>);
<a name="l00942"></a>00942          <span class="keywordflow">if</span> ((p-&gt;<a class="code" href="structagent__pvt.html#ae6634ed33949784643bc0c217c419bb5">deferlogoff</a>) || (howlong &amp;&amp; p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a> &amp;&amp; (howlong &gt; p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a>))) {
<a name="l00943"></a>00943             <span class="keywordtype">long</span> logintime = time(NULL) - p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>;
<a name="l00944"></a>00944             p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a> = 0;
<a name="l00945"></a>00945             <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#ae6634ed33949784643bc0c217c419bb5">deferlogoff</a>)
<a name="l00946"></a>00946                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Agent &apos;%s&apos; didn&apos;t answer/confirm within %d seconds (waited %d)\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>, p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a>, howlong);
<a name="l00947"></a>00947             p-&gt;<a class="code" href="structagent__pvt.html#ae6634ed33949784643bc0c217c419bb5">deferlogoff</a> = 0;
<a name="l00948"></a>00948             <a class="code" href="chan__agent_8c.html#a79fc2c717c9271fd4b5a3da318cc489c">agent_logoff_maintenance</a>(p, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, logintime, ast-&gt;uniqueid, <span class="stringliteral">&quot;Autologoff&quot;</span>);
<a name="l00949"></a>00949             <span class="keywordflow">if</span> (persistent_agents)
<a name="l00950"></a>00950                <a class="code" href="chan__agent_8c.html#a25dc3d6cf242ab703a5212535685d41e" title="Dump AgentCallbackLogin agents to the ASTdb database for persistence.">dump_agents</a>();
<a name="l00951"></a>00951          }
<a name="l00952"></a>00952       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a>) {
<a name="l00953"></a>00953          <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00954"></a>00954          <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2b3b711afc65059c4b51008c9fbc7aee">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l00955"></a>00955          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00956"></a>00956       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>) {
<a name="l00957"></a>00957          <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00958"></a>00958          <a class="code" href="channel_8h.html#aa8c3522af1bc639cbd5b38f5fdf171fa" title="Indicates condition of channel, with payload.">ast_indicate_data</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>, 
<a name="l00959"></a>00959             <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(p-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>, NULL),
<a name="l00960"></a>00960             !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>) ? strlen(p-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>) + 1 : 0);
<a name="l00961"></a>00961          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00962"></a>00962       }
<a name="l00963"></a>00963    }
<a name="l00964"></a>00964    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00965"></a>00965 
<a name="l00966"></a>00966    <span class="comment">/* Only register a device state change if the agent is still logged in */</span>
<a name="l00967"></a>00967    <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>) {
<a name="l00968"></a>00968       p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00969"></a>00969       p-&gt;<a class="code" href="structagent__pvt.html#a1d0896f3c265b2304808016f90742479">logincallerid</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00970"></a>00970       <span class="keywordflow">if</span> (persistent_agents)
<a name="l00971"></a>00971          <a class="code" href="chan__agent_8c.html#a25dc3d6cf242ab703a5212535685d41e" title="Dump AgentCallbackLogin agents to the ASTdb database for persistence.">dump_agents</a>();
<a name="l00972"></a>00972    } <span class="keywordflow">else</span> {
<a name="l00973"></a>00973       <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>, <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l00974"></a>00974    }
<a name="l00975"></a>00975 
<a name="l00976"></a>00976    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a>) {
<a name="l00977"></a>00977       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l00978"></a>00978       <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;agents, p, list);
<a name="l00979"></a>00979       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l00980"></a>00980    }
<a name="l00981"></a>00981    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a6855f972df14160c6e762120e1589670">abouttograb</a>) {
<a name="l00982"></a>00982       <span class="comment">/* Let the &quot;about to grab&quot; thread know this isn&apos;t valid anymore, and let it</span>
<a name="l00983"></a>00983 <span class="comment">         kill it later */</span>
<a name="l00984"></a>00984       p-&gt;<a class="code" href="structagent__pvt.html#a6855f972df14160c6e762120e1589670">abouttograb</a> = 0;
<a name="l00985"></a>00985    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a>) {
<a name="l00986"></a>00986       <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00987"></a>00987       <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#a16a593c509d04ae4f46b21ada53c2ea6">app_lock</a>);
<a name="l00988"></a>00988       <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#aedc0136c518c393de8b46d60b9018c3f">app_complete_cond</a>);
<a name="l00989"></a>00989       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(p);
<a name="l00990"></a>00990    } <span class="keywordflow">else</span> {
<a name="l00991"></a>00991       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l00992"></a>00992          <span class="comment">/* Not dead -- check availability now */</span>
<a name="l00993"></a>00993          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00994"></a>00994          <span class="comment">/* Store last disconnect time */</span>
<a name="l00995"></a>00995          p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a> = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a>, 1000));
<a name="l00996"></a>00996          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00997"></a>00997       }
<a name="l00998"></a>00998       <span class="comment">/* Release ownership of the agent to other threads (presumably running the login app). */</span>
<a name="l00999"></a>00999       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>)) {
<a name="l01000"></a>01000          p-&gt;<a class="code" href="structagent__pvt.html#a13b86677f5f5b6ebc899aba01af8466a">app_lock_flag</a> = 0;
<a name="l01001"></a>01001          <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#aedc0136c518c393de8b46d60b9018c3f">app_complete_cond</a>);
<a name="l01002"></a>01002       }
<a name="l01003"></a>01003    }
<a name="l01004"></a>01004    <span class="keywordflow">return</span> 0;
<a name="l01005"></a>01005 }
<a name="l01006"></a>01006 
<a name="l01007"></a><a class="code" href="chan__agent_8c.html#adf2ecd2a40faf8d2620fa5b5ac776b01">01007</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#adf2ecd2a40faf8d2620fa5b5ac776b01">agent_cont_sleep</a>( <span class="keywordtype">void</span> *data )
<a name="l01008"></a>01008 {
<a name="l01009"></a>01009    <span class="keyword">struct </span>agent_pvt *p;
<a name="l01010"></a>01010    <span class="keywordtype">int</span> res;
<a name="l01011"></a>01011 
<a name="l01012"></a>01012    p = (<span class="keyword">struct </span>agent_pvt *)data;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01015"></a>01015    res = p-&gt;<a class="code" href="structagent__pvt.html#aef61dcc55e364d349e1b7420eb7c4ec9">app_sleep_cond</a>;
<a name="l01016"></a>01016    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>.tv_sec) {
<a name="l01017"></a>01017       <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>) &gt; 0) 
<a name="l01018"></a>01018          res = 1;
<a name="l01019"></a>01019    }
<a name="l01020"></a>01020    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022    <span class="keywordflow">if</span> (!res)
<a name="l01023"></a>01023       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;agent_cont_sleep() returning %d\n&quot;</span>, res );
<a name="l01024"></a>01024 
<a name="l01025"></a>01025    <span class="keywordflow">return</span> res;
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01028"></a><a class="code" href="chan__agent_8c.html#a7d255097bf9c120a32b78a0f744df34e">01028</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a7d255097bf9c120a32b78a0f744df34e">agent_ack_sleep</a>(<span class="keywordtype">void</span> *data)
<a name="l01029"></a>01029 {
<a name="l01030"></a>01030    <span class="keyword">struct </span>agent_pvt *p;
<a name="l01031"></a>01031    <span class="keywordtype">int</span> res=0;
<a name="l01032"></a>01032    <span class="keywordtype">int</span> to = 1000;
<a name="l01033"></a>01033    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l01034"></a>01034 
<a name="l01035"></a>01035    <span class="comment">/* Wait a second and look for something */</span>
<a name="l01036"></a>01036 
<a name="l01037"></a>01037    p = (<span class="keyword">struct </span>agent_pvt *) data;
<a name="l01038"></a>01038    <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) 
<a name="l01039"></a>01039       <span class="keywordflow">return</span> -1;
<a name="l01040"></a>01040 
<a name="l01041"></a>01041    <span class="keywordflow">for</span>(;;) {
<a name="l01042"></a>01042       to = <a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, to);
<a name="l01043"></a>01043       <span class="keywordflow">if</span> (to &lt; 0) 
<a name="l01044"></a>01044          <span class="keywordflow">return</span> -1;
<a name="l01045"></a>01045       <span class="keywordflow">if</span> (!to) 
<a name="l01046"></a>01046          <span class="keywordflow">return</span> 0;
<a name="l01047"></a>01047       f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l01048"></a>01048       <span class="keywordflow">if</span> (!f) 
<a name="l01049"></a>01049          <span class="keywordflow">return</span> -1;
<a name="l01050"></a>01050       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>)
<a name="l01051"></a>01051          res = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l01052"></a>01052       <span class="keywordflow">else</span>
<a name="l01053"></a>01053          res = 0;
<a name="l01054"></a>01054       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l01055"></a>01055       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01056"></a>01056       <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#aef61dcc55e364d349e1b7420eb7c4ec9">app_sleep_cond</a>) {
<a name="l01057"></a>01057          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01058"></a>01058          <span class="keywordflow">return</span> 0;
<a name="l01059"></a>01059       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == p-&gt;<a class="code" href="structagent__pvt.html#a97629727ac11792aa963aed4457abde8">acceptdtmf</a>) {
<a name="l01060"></a>01060          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01061"></a>01061          <span class="keywordflow">return</span> 1;
<a name="l01062"></a>01062       }
<a name="l01063"></a>01063       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01064"></a>01064       res = 0;
<a name="l01065"></a>01065    }
<a name="l01066"></a>01066    <span class="keywordflow">return</span> res;
<a name="l01067"></a>01067 }
<a name="l01068"></a>01068 
<a name="l01069"></a><a class="code" href="chan__agent_8c.html#a2f64da89547dd17397ddd13e621ecf56">01069</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__agent_8c.html#a2f64da89547dd17397ddd13e621ecf56">agent_bridgedchannel</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__channel.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>)
<a name="l01070"></a>01070 {
<a name="l01071"></a>01071    <span class="keyword">struct </span>agent_pvt *p = bridge-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l01072"></a>01072    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ret = NULL;
<a name="l01073"></a>01073 
<a name="l01074"></a>01074    <span class="keywordflow">if</span> (p) {
<a name="l01075"></a>01075       <span class="keywordflow">if</span> (chan == p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l01076"></a>01076          ret = bridge-&gt;<a class="code" href="structast__channel.html#a81ab061f1622c159fe55ba4f17309cc5">_bridge</a>;
<a name="l01077"></a>01077       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan == bridge-&gt;<a class="code" href="structast__channel.html#a81ab061f1622c159fe55ba4f17309cc5">_bridge</a>)
<a name="l01078"></a>01078          ret = p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l01079"></a>01079    }
<a name="l01080"></a>01080 
<a name="l01081"></a>01081    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Asked for bridged channel on &apos;%s&apos;/&apos;%s&apos;, returning &apos;%s&apos;\n&quot;</span>, chan-&gt;name, bridge-&gt;name, ret ? ret-&gt;name : <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>);
<a name="l01082"></a>01082    <span class="keywordflow">return</span> ret;
<a name="l01083"></a>01083 }
<a name="l01084"></a>01084 <span class="comment"></span>
<a name="l01085"></a>01085 <span class="comment">/*! \brief Create new agent channel */</span>
<a name="l01086"></a><a class="code" href="chan__agent_8c.html#aa122afe2165de7cd02e3c3305a6a6b9d">01086</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__agent_8c.html#aa122afe2165de7cd02e3c3305a6a6b9d" title="Create new agent channel.">agent_new</a>(<span class="keyword">struct</span> agent_pvt *p, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l01087"></a>01087 {
<a name="l01088"></a>01088    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *tmp;
<a name="l01089"></a>01089    <span class="keywordtype">int</span> alreadylocked;
<a name="l01090"></a>01090 <span class="preprocessor">#if 0</span>
<a name="l01091"></a>01091 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01092"></a>01092       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No channel? :(\n&quot;</span>);
<a name="l01093"></a>01093       <span class="keywordflow">return</span> NULL;
<a name="l01094"></a>01094    }
<a name="l01095"></a>01095 <span class="preprocessor">#endif   </span>
<a name="l01096"></a>01096 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a>)
<a name="l01097"></a>01097       tmp = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, state, 0, 0, <span class="stringliteral">&quot;&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> ? p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>:<span class="stringliteral">&quot;&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> ? p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>:<span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Agent/P%s-%d&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, (<span class="keywordtype">int</span>) <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() &amp; 0xffff);
<a name="l01098"></a>01098    <span class="keywordflow">else</span>
<a name="l01099"></a>01099       tmp = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, state, 0, 0, <span class="stringliteral">&quot;&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> ? p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>:<span class="stringliteral">&quot;&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> ? p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>:<span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l01100"></a>01100    <span class="keywordflow">if</span> (!tmp) {
<a name="l01101"></a>01101       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate agent channel structure\n&quot;</span>);
<a name="l01102"></a>01102       <span class="keywordflow">return</span> NULL;
<a name="l01103"></a>01103    }
<a name="l01104"></a>01104 
<a name="l01105"></a>01105    tmp-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a> = &amp;<a class="code" href="chan__agent_8c.html#a7495473ec0e365de7c32942518358dea" title="Channel interface description for PBX integration.">agent_tech</a>;
<a name="l01106"></a>01106    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01107"></a>01107       tmp-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> = p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>;
<a name="l01108"></a>01108       tmp-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l01109"></a>01109       tmp-&gt;<a class="code" href="structast__channel.html#a045b6dfdee84adceb7e86b6c5c4f9a86">rawwriteformat</a> = p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l01110"></a>01110       tmp-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l01111"></a>01111       tmp-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a> = p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l01112"></a>01112       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, <a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language);
<a name="l01113"></a>01113       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l01114"></a>01114       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l01115"></a>01115       <span class="comment">/* XXX Is this really all we copy form the originating channel?? */</span>
<a name="l01116"></a>01116    } <span class="keywordflow">else</span> {
<a name="l01117"></a>01117       tmp-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l01118"></a>01118       tmp-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l01119"></a>01119       tmp-&gt;<a class="code" href="structast__channel.html#a045b6dfdee84adceb7e86b6c5c4f9a86">rawwriteformat</a> = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l01120"></a>01120       tmp-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l01121"></a>01121       tmp-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a> = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l01122"></a>01122    }
<a name="l01123"></a>01123    <span class="comment">/* Safe, agentlock already held */</span>
<a name="l01124"></a>01124    tmp-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = p;
<a name="l01125"></a>01125    p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = tmp;
<a name="l01126"></a>01126    tmp-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 1;
<a name="l01127"></a>01127    <span class="comment">/* Wake up and wait for other applications (by definition the login app)</span>
<a name="l01128"></a>01128 <span class="comment">    * to release this channel). Takes ownership of the agent channel</span>
<a name="l01129"></a>01129 <span class="comment">    * to this thread only.</span>
<a name="l01130"></a>01130 <span class="comment">    * For signalling the other thread, ast_queue_frame is used until we</span>
<a name="l01131"></a>01131 <span class="comment">    * can safely use signals for this purpose. The pselect() needs to be</span>
<a name="l01132"></a>01132 <span class="comment">    * implemented in the kernel for this.</span>
<a name="l01133"></a>01133 <span class="comment">    */</span>
<a name="l01134"></a>01134    p-&gt;<a class="code" href="structagent__pvt.html#aef61dcc55e364d349e1b7420eb7c4ec9">app_sleep_cond</a> = 0;
<a name="l01135"></a>01135 
<a name="l01136"></a>01136    alreadylocked = p-&gt;<a class="code" href="structagent__pvt.html#a13b86677f5f5b6ebc899aba01af8466a">app_lock_flag</a>;
<a name="l01137"></a>01137    p-&gt;<a class="code" href="structagent__pvt.html#a13b86677f5f5b6ebc899aba01af8466a">app_lock_flag</a> = 1;
<a name="l01138"></a>01138 
<a name="l01139"></a>01139    <span class="keywordflow">if</span>(<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>) &amp;&amp; alreadylocked) {
<a name="l01140"></a>01140       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01141"></a>01141          <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>);
<a name="l01142"></a>01142          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);   <span class="comment">/* For other thread to read the condition. */</span>
<a name="l01143"></a>01143          p-&gt;<a class="code" href="structagent__pvt.html#a13b86677f5f5b6ebc899aba01af8466a">app_lock_flag</a> = 1;
<a name="l01144"></a>01144          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01145"></a>01145       } <span class="keywordflow">else</span> {
<a name="l01146"></a>01146          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Agent disconnected while we were connecting the call\n&quot;</span>);
<a name="l01147"></a>01147          p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = NULL;
<a name="l01148"></a>01148          tmp-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = NULL;
<a name="l01149"></a>01149          p-&gt;<a class="code" href="structagent__pvt.html#aef61dcc55e364d349e1b7420eb7c4ec9">app_sleep_cond</a> = 1;
<a name="l01150"></a>01150          <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>( tmp );
<a name="l01151"></a>01151          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);   <span class="comment">/* For other thread to read the condition. */</span>
<a name="l01152"></a>01152          p-&gt;<a class="code" href="structagent__pvt.html#a13b86677f5f5b6ebc899aba01af8466a">app_lock_flag</a> = 0;
<a name="l01153"></a>01153          <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#aedc0136c518c393de8b46d60b9018c3f">app_complete_cond</a>);
<a name="l01154"></a>01154          <span class="keywordflow">return</span> NULL;
<a name="l01155"></a>01155       }
<a name="l01156"></a>01156    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>)) {
<a name="l01157"></a>01157       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l01158"></a>01158          <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>);
<a name="l01159"></a>01159       <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01160"></a>01160          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Agent disconnected while we were connecting the call\n&quot;</span>);
<a name="l01161"></a>01161          p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = NULL;
<a name="l01162"></a>01162          tmp-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = NULL;
<a name="l01163"></a>01163          p-&gt;<a class="code" href="structagent__pvt.html#aef61dcc55e364d349e1b7420eb7c4ec9">app_sleep_cond</a> = 1;
<a name="l01164"></a>01164          <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>( tmp );
<a name="l01165"></a>01165          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);     <span class="comment">/* For other thread to read the condition. */</span>
<a name="l01166"></a>01166          <span class="keywordflow">return</span> NULL;
<a name="l01167"></a>01167       }  
<a name="l01168"></a>01168    } 
<a name="l01169"></a>01169    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l01170"></a>01170       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>);
<a name="l01171"></a>01171    <span class="keywordflow">return</span> tmp;
<a name="l01172"></a>01172 }
<a name="l01173"></a>01173 
<a name="l01174"></a>01174 <span class="comment"></span>
<a name="l01175"></a>01175 <span class="comment">/*!</span>
<a name="l01176"></a>01176 <span class="comment"> * Read configuration data. The file named agents.conf.</span>
<a name="l01177"></a>01177 <span class="comment"> *</span>
<a name="l01178"></a>01178 <span class="comment"> * \returns Always 0, or so it seems.</span>
<a name="l01179"></a>01179 <span class="comment"> */</span>
<a name="l01180"></a><a class="code" href="chan__agent_8c.html#a8ffba0f0e19fa437517d8c13950f1068">01180</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a8ffba0f0e19fa437517d8c13950f1068">read_agent_config</a>(<span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l01181"></a>01181 {
<a name="l01182"></a>01182    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l01183"></a>01183    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *ucfg;
<a name="l01184"></a>01184    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l01185"></a>01185    <span class="keyword">struct </span>agent_pvt *p;
<a name="l01186"></a>01186    <span class="keyword">const</span> <span class="keywordtype">char</span> *general_val;
<a name="l01187"></a>01187    <span class="keyword">const</span> <span class="keywordtype">char</span> *catname;
<a name="l01188"></a>01188    <span class="keyword">const</span> <span class="keywordtype">char</span> *hasagent;
<a name="l01189"></a>01189    <span class="keywordtype">int</span> genhasagent;
<a name="l01190"></a>01190    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { reload ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l01191"></a>01191 
<a name="l01192"></a>01192    group = 0;
<a name="l01193"></a>01193    autologoff = 0;
<a name="l01194"></a>01194    wrapuptime = 0;
<a name="l01195"></a>01195    ackcall = 0;
<a name="l01196"></a>01196    endcall = 1;
<a name="l01197"></a>01197    cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(config, config_flags);
<a name="l01198"></a>01198    <span class="keywordflow">if</span> (!cfg) {
<a name="l01199"></a>01199       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No agent configuration found -- agent support disabled\n&quot;</span>);
<a name="l01200"></a>01200       <span class="keywordflow">return</span> 0;
<a name="l01201"></a>01201    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {
<a name="l01202"></a>01202       <span class="keywordflow">return</span> -1;
<a name="l01203"></a>01203    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l01204"></a>01204       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;%s contains a parsing error.  Aborting\n&quot;</span>, config);
<a name="l01205"></a>01205       <span class="keywordflow">return</span> 0;
<a name="l01206"></a>01206    }
<a name="l01207"></a>01207    <span class="keywordflow">if</span> ((ucfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;users.conf&quot;</span>, config_flags))) {
<a name="l01208"></a>01208       <span class="keywordflow">if</span> (ucfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {
<a name="l01209"></a>01209          ucfg = NULL;
<a name="l01210"></a>01210       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ucfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l01211"></a>01211          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;users.conf contains a parsing error.  Aborting\n&quot;</span>);
<a name="l01212"></a>01212          <span class="keywordflow">return</span> 0;
<a name="l01213"></a>01213       }
<a name="l01214"></a>01214    }
<a name="l01215"></a>01215 
<a name="l01216"></a>01216    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l01217"></a>01217    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l01218"></a>01218       p-&gt;<a class="code" href="structagent__pvt.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a> = 1;
<a name="l01219"></a>01219    }
<a name="l01220"></a>01220    strcpy(moh, <span class="stringliteral">&quot;default&quot;</span>);
<a name="l01221"></a>01221    <span class="comment">/* set the default recording values */</span>
<a name="l01222"></a>01222    recordagentcalls = 0;
<a name="l01223"></a>01223    strcpy(recordformat, <span class="stringliteral">&quot;wav&quot;</span>);
<a name="l01224"></a>01224    strcpy(recordformatext, <span class="stringliteral">&quot;wav&quot;</span>);
<a name="l01225"></a>01225    urlprefix[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01226"></a>01226    savecallsin[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01227"></a>01227 
<a name="l01228"></a>01228    <span class="comment">/* Read in [general] section for persistence */</span>
<a name="l01229"></a>01229    <span class="keywordflow">if</span> ((general_val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;persistentagents&quot;</span>)))
<a name="l01230"></a>01230       persistent_agents = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(general_val);
<a name="l01231"></a>01231    multiplelogin = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;multiplelogin&quot;</span>));
<a name="l01232"></a>01232 
<a name="l01233"></a>01233    <span class="comment">/* Read in the [agents] section */</span>
<a name="l01234"></a>01234    v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;agents&quot;</span>);
<a name="l01235"></a>01235    <span class="keywordflow">while</span>(v) {
<a name="l01236"></a>01236       <span class="comment">/* Create the interface list */</span>
<a name="l01237"></a>01237       <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;agent&quot;</span>)) {
<a name="l01238"></a>01238          <a class="code" href="chan__agent_8c.html#aadf5bf36195ebd800f3dd7eeeef9049b">add_agent</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 0);
<a name="l01239"></a>01239       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;group&quot;</span>)) {
<a name="l01240"></a>01240          group = <a class="code" href="channel_8h.html#aee83e23058d0a4111fda1f506cbda107">ast_get_group</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01241"></a>01241       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autologoff&quot;</span>)) {
<a name="l01242"></a>01242          autologoff = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01243"></a>01243          <span class="keywordflow">if</span> (autologoff &lt; 0)
<a name="l01244"></a>01244             autologoff = 0;
<a name="l01245"></a>01245       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;ackcall&quot;</span>)) {
<a name="l01246"></a>01246          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;always&quot;</span>))
<a name="l01247"></a>01247             ackcall = 2;
<a name="l01248"></a>01248          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))
<a name="l01249"></a>01249             ackcall = 1;
<a name="l01250"></a>01250          <span class="keywordflow">else</span>
<a name="l01251"></a>01251             ackcall = 0;
<a name="l01252"></a>01252       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;endcall&quot;</span>)) {
<a name="l01253"></a>01253          endcall = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01254"></a>01254       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;acceptdtmf&quot;</span>)) {
<a name="l01255"></a>01255          acceptdtmf = *(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01256"></a>01256          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Set acceptdtmf to %c\n&quot;</span>, acceptdtmf);
<a name="l01257"></a>01257       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;enddtmf&quot;</span>)) {
<a name="l01258"></a>01258          enddtmf = *(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01259"></a>01259       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;wrapuptime&quot;</span>)) {
<a name="l01260"></a>01260          wrapuptime = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01261"></a>01261          <span class="keywordflow">if</span> (wrapuptime &lt; 0)
<a name="l01262"></a>01262             wrapuptime = 0;
<a name="l01263"></a>01263       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxlogintries&quot;</span>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l01264"></a>01264          maxlogintries = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01265"></a>01265          <span class="keywordflow">if</span> (maxlogintries &lt; 0)
<a name="l01266"></a>01266             maxlogintries = 0;
<a name="l01267"></a>01267       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;goodbye&quot;</span>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l01268"></a>01268          strcpy(agentgoodbye,v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01269"></a>01269       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;musiconhold&quot;</span>)) {
<a name="l01270"></a>01270          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(moh, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(moh));
<a name="l01271"></a>01271       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;updatecdr&quot;</span>)) {
<a name="l01272"></a>01272          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))
<a name="l01273"></a>01273             updatecdr = 1;
<a name="l01274"></a>01274          <span class="keywordflow">else</span>
<a name="l01275"></a>01275             updatecdr = 0;
<a name="l01276"></a>01276       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autologoffunavail&quot;</span>)) {
<a name="l01277"></a>01277          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))
<a name="l01278"></a>01278             autologoffunavail = 1;
<a name="l01279"></a>01279          <span class="keywordflow">else</span>
<a name="l01280"></a>01280             autologoffunavail = 0;
<a name="l01281"></a>01281       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;recordagentcalls&quot;</span>)) {
<a name="l01282"></a>01282          recordagentcalls = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01283"></a>01283       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;recordformat&quot;</span>)) {
<a name="l01284"></a>01284          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(recordformat, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(recordformat));
<a name="l01285"></a>01285          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;wav49&quot;</span>))
<a name="l01286"></a>01286             strcpy(recordformatext, <span class="stringliteral">&quot;WAV&quot;</span>);
<a name="l01287"></a>01287          <span class="keywordflow">else</span>
<a name="l01288"></a>01288             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(recordformatext, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(recordformatext));
<a name="l01289"></a>01289       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;urlprefix&quot;</span>)) {
<a name="l01290"></a>01290          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(urlprefix, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(urlprefix));
<a name="l01291"></a>01291          <span class="keywordflow">if</span> (urlprefix[strlen(urlprefix) - 1] != <span class="charliteral">&apos;/&apos;</span>)
<a name="l01292"></a>01292             strncat(urlprefix, <span class="stringliteral">&quot;/&quot;</span>, <span class="keyword">sizeof</span>(urlprefix) - strlen(urlprefix) - 1);
<a name="l01293"></a>01293       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;savecallsin&quot;</span>)) {
<a name="l01294"></a>01294          <span class="keywordflow">if</span> (v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>[0] == <span class="charliteral">&apos;/&apos;</span>)
<a name="l01295"></a>01295             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(savecallsin, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(savecallsin));
<a name="l01296"></a>01296          <span class="keywordflow">else</span>
<a name="l01297"></a>01297             snprintf(savecallsin, <span class="keyword">sizeof</span>(savecallsin) - 2, <span class="stringliteral">&quot;/%s&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01298"></a>01298          <span class="keywordflow">if</span> (savecallsin[strlen(savecallsin) - 1] != <span class="charliteral">&apos;/&apos;</span>)
<a name="l01299"></a>01299             strncat(savecallsin, <span class="stringliteral">&quot;/&quot;</span>, <span class="keyword">sizeof</span>(savecallsin) - strlen(savecallsin) - 1);
<a name="l01300"></a>01300       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;custom_beep&quot;</span>)) {
<a name="l01301"></a>01301          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(beep, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(beep));
<a name="l01302"></a>01302       }
<a name="l01303"></a>01303       v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l01304"></a>01304    }
<a name="l01305"></a>01305    <span class="keywordflow">if</span> (ucfg) {
<a name="l01306"></a>01306       genhasagent = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;hasagent&quot;</span>));
<a name="l01307"></a>01307       catname = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(ucfg, NULL);
<a name="l01308"></a>01308       <span class="keywordflow">while</span>(catname) {
<a name="l01309"></a>01309          <span class="keywordflow">if</span> (strcasecmp(catname, <span class="stringliteral">&quot;general&quot;</span>)) {
<a name="l01310"></a>01310             hasagent = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, catname, <span class="stringliteral">&quot;hasagent&quot;</span>);
<a name="l01311"></a>01311             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(hasagent) || (!hasagent &amp;&amp; genhasagent)) {
<a name="l01312"></a>01312                <span class="keywordtype">char</span> tmp[256];
<a name="l01313"></a>01313                <span class="keyword">const</span> <span class="keywordtype">char</span> *fullname = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, catname, <span class="stringliteral">&quot;fullname&quot;</span>);
<a name="l01314"></a>01314                <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a> = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, catname, <span class="stringliteral">&quot;secret&quot;</span>);
<a name="l01315"></a>01315                <span class="keywordflow">if</span> (!fullname)
<a name="l01316"></a>01316                   fullname = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01317"></a>01317                <span class="keywordflow">if</span> (!secret)
<a name="l01318"></a>01318                   secret = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01319"></a>01319                snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s,%s,%s&quot;</span>, catname, secret,fullname);
<a name="l01320"></a>01320                <a class="code" href="chan__agent_8c.html#aadf5bf36195ebd800f3dd7eeeef9049b">add_agent</a>(tmp, 0);
<a name="l01321"></a>01321             }
<a name="l01322"></a>01322          }
<a name="l01323"></a>01323          catname = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(ucfg, catname);
<a name="l01324"></a>01324       }
<a name="l01325"></a>01325       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(ucfg);
<a name="l01326"></a>01326    }
<a name="l01327"></a>01327    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;agents, p, list) {
<a name="l01328"></a>01328       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a>) {
<a name="l01329"></a>01329          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l01330"></a>01330          <span class="comment">/* Destroy if  appropriate */</span>
<a name="l01331"></a>01331          <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l01332"></a>01332             <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01333"></a>01333                <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01334"></a>01334                <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#a16a593c509d04ae4f46b21ada53c2ea6">app_lock</a>);
<a name="l01335"></a>01335                <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#aedc0136c518c393de8b46d60b9018c3f">app_complete_cond</a>);
<a name="l01336"></a>01336                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(p);
<a name="l01337"></a>01337             } <span class="keywordflow">else</span> {
<a name="l01338"></a>01338                <span class="comment">/* Cause them to hang up */</span>
<a name="l01339"></a>01339                <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2b3b711afc65059c4b51008c9fbc7aee">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l01340"></a>01340             }
<a name="l01341"></a>01341          }
<a name="l01342"></a>01342       }
<a name="l01343"></a>01343    }
<a name="l01344"></a>01344    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l01345"></a>01345    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l01346"></a>01346    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01347"></a>01347    <span class="keywordflow">return</span> 1;
<a name="l01348"></a>01348 }
<a name="l01349"></a>01349 
<a name="l01350"></a><a class="code" href="chan__agent_8c.html#adf789d0946fb080c371702bbcd2b5e81">01350</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#adf789d0946fb080c371702bbcd2b5e81">check_availability</a>(<span class="keyword">struct</span> agent_pvt *newlyavailable, <span class="keywordtype">int</span> needlock)
<a name="l01351"></a>01351 {
<a name="l01352"></a>01352    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>=NULL, *parent=NULL;
<a name="l01353"></a>01353    <span class="keyword">struct </span>agent_pvt *p;
<a name="l01354"></a>01354    <span class="keywordtype">int</span> res;
<a name="l01355"></a>01355 
<a name="l01356"></a>01356    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Checking availability of &apos;%s&apos;\n&quot;</span>, newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l01357"></a>01357    <span class="keywordflow">if</span> (needlock)
<a name="l01358"></a>01358       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l01359"></a>01359    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l01360"></a>01360       <span class="keywordflow">if</span> (p == newlyavailable) {
<a name="l01361"></a>01361          <span class="keywordflow">continue</span>;
<a name="l01362"></a>01362       }
<a name="l01363"></a>01363       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01364"></a>01364       <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a6855f972df14160c6e762120e1589670">abouttograb</a> &amp;&amp; p-&gt;<a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a> &amp;&amp; ((p-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a> &amp;&amp; (newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a> &amp; p-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a>)) || !strcmp(p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>))) {
<a name="l01365"></a>01365          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Call &apos;%s&apos; looks like a winner for agent &apos;%s&apos;\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;name, newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l01366"></a>01366          <span class="comment">/* We found a pending call, time to merge */</span>
<a name="l01367"></a>01367          chan = <a class="code" href="chan__agent_8c.html#aa122afe2165de7cd02e3c3305a6a6b9d" title="Create new agent channel.">agent_new</a>(newlyavailable, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>);
<a name="l01368"></a>01368          parent = p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>;
<a name="l01369"></a>01369          p-&gt;<a class="code" href="structagent__pvt.html#a6855f972df14160c6e762120e1589670">abouttograb</a> = 1;
<a name="l01370"></a>01370          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01371"></a>01371          <span class="keywordflow">break</span>;
<a name="l01372"></a>01372       }
<a name="l01373"></a>01373       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01374"></a>01374    }
<a name="l01375"></a>01375    <span class="keywordflow">if</span> (needlock)
<a name="l01376"></a>01376       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l01377"></a>01377    <span class="keywordflow">if</span> (parent &amp;&amp; chan)  {
<a name="l01378"></a>01378       <span class="keywordflow">if</span> (newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a> &gt; 1) {
<a name="l01379"></a>01379          <span class="comment">/* Don&apos;t do beep here */</span>
<a name="l01380"></a>01380          res = 0;
<a name="l01381"></a>01381       } <span class="keywordflow">else</span> {
<a name="l01382"></a>01382          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Playing beep, lang &apos;%s&apos;\n&quot;</span>, newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language);
<a name="l01383"></a>01383          res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, beep, newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language);
<a name="l01384"></a>01384          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Played beep, result &apos;%d&apos;\n&quot;</span>, res);
<a name="l01385"></a>01385          <span class="keywordflow">if</span> (!res) {
<a name="l01386"></a>01386             res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01387"></a>01387             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Waited for stream, result &apos;%d&apos;\n&quot;</span>, res);
<a name="l01388"></a>01388          }
<a name="l01389"></a>01389       }
<a name="l01390"></a>01390       <span class="keywordflow">if</span> (!res) {
<a name="l01391"></a>01391          <span class="comment">/* Note -- parent may have disappeared */</span>
<a name="l01392"></a>01392          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a6855f972df14160c6e762120e1589670">abouttograb</a>) {
<a name="l01393"></a>01393             newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> = 1;
<a name="l01394"></a>01394             <span class="comment">/* Safe -- agent lock already held */</span>
<a name="l01395"></a>01395             <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(parent, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>);
<a name="l01396"></a>01396             <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(chan, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>);
<a name="l01397"></a>01397             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(parent-&gt;context, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(parent-&gt;context));
<a name="l01398"></a>01398             <span class="comment">/* Go ahead and mark the channel as a zombie so that masquerade will</span>
<a name="l01399"></a>01399 <span class="comment">               destroy it for us, and we need not call ast_hangup */</span>
<a name="l01400"></a>01400             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a26796fa52cc5857446eec8d16a4b718d">AST_FLAG_ZOMBIE</a>);
<a name="l01401"></a>01401             <a class="code" href="channel_8h.html#a84fa04f019436467dc17f9bdd5341dce" title="Weird function made for call transfers.">ast_channel_masquerade</a>(parent, chan);
<a name="l01402"></a>01402             p-&gt;<a class="code" href="structagent__pvt.html#a6855f972df14160c6e762120e1589670">abouttograb</a> = 0;
<a name="l01403"></a>01403          } <span class="keywordflow">else</span> {
<a name="l01404"></a>01404             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Sneaky, parent disappeared in the mean time...\n&quot;</span>);
<a name="l01405"></a>01405             <a class="code" href="chan__agent_8c.html#abbb457e1f863facf1478eabb21e60032">agent_cleanup</a>(newlyavailable);
<a name="l01406"></a>01406          }
<a name="l01407"></a>01407       } <span class="keywordflow">else</span> {
<a name="l01408"></a>01408          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Ugh...  Agent hung up at exactly the wrong time\n&quot;</span>);
<a name="l01409"></a>01409          <a class="code" href="chan__agent_8c.html#abbb457e1f863facf1478eabb21e60032">agent_cleanup</a>(newlyavailable);
<a name="l01410"></a>01410       }
<a name="l01411"></a>01411    }
<a name="l01412"></a>01412    <span class="keywordflow">return</span> 0;
<a name="l01413"></a>01413 }
<a name="l01414"></a>01414 
<a name="l01415"></a><a class="code" href="chan__agent_8c.html#aec462df64d494caa7f43502f7ec84f53">01415</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#aec462df64d494caa7f43502f7ec84f53">check_beep</a>(<span class="keyword">struct</span> agent_pvt *newlyavailable, <span class="keywordtype">int</span> needlock)
<a name="l01416"></a>01416 {
<a name="l01417"></a>01417    <span class="keyword">struct </span>agent_pvt *p;
<a name="l01418"></a>01418    <span class="keywordtype">int</span> res=0;
<a name="l01419"></a>01419 
<a name="l01420"></a>01420    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Checking beep availability of &apos;%s&apos;\n&quot;</span>, newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l01421"></a>01421    <span class="keywordflow">if</span> (needlock)
<a name="l01422"></a>01422       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l01423"></a>01423    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l01424"></a>01424       <span class="keywordflow">if</span> (p == newlyavailable) {
<a name="l01425"></a>01425          <span class="keywordflow">continue</span>;
<a name="l01426"></a>01426       }
<a name="l01427"></a>01427       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01428"></a>01428       <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a6855f972df14160c6e762120e1589670">abouttograb</a> &amp;&amp; p-&gt;<a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a> &amp;&amp; ((p-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a> &amp;&amp; (newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a> &amp; p-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a>)) || !strcmp(p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>))) {
<a name="l01429"></a>01429          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Call &apos;%s&apos; looks like a would-be winner for agent &apos;%s&apos;\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;name, newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l01430"></a>01430          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01431"></a>01431          <span class="keywordflow">break</span>;
<a name="l01432"></a>01432       }
<a name="l01433"></a>01433       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01434"></a>01434    }
<a name="l01435"></a>01435    <span class="keywordflow">if</span> (needlock)
<a name="l01436"></a>01436       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l01437"></a>01437    <span class="keywordflow">if</span> (p) {
<a name="l01438"></a>01438       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;newlyavailable-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01439"></a>01439       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Playing beep, lang &apos;%s&apos;\n&quot;</span>, newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language);
<a name="l01440"></a>01440       res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, beep, newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language);
<a name="l01441"></a>01441       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Played beep, result &apos;%d&apos;\n&quot;</span>, res);
<a name="l01442"></a>01442       <span class="keywordflow">if</span> (!res) {
<a name="l01443"></a>01443          res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(newlyavailable-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01444"></a>01444          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Waited for stream, result &apos;%d&apos;\n&quot;</span>, res);
<a name="l01445"></a>01445       }
<a name="l01446"></a>01446       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;newlyavailable-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01447"></a>01447    }
<a name="l01448"></a>01448    <span class="keywordflow">return</span> res;
<a name="l01449"></a>01449 }
<a name="l01450"></a>01450 <span class="comment"></span>
<a name="l01451"></a>01451 <span class="comment">/*! \brief Part of the Asterisk PBX interface */</span>
<a name="l01452"></a><a class="code" href="chan__agent_8c.html#a913d85b0e869dbff8a7c948b26476965">01452</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__agent_8c.html#a913d85b0e869dbff8a7c948b26476965" title="Part of the Asterisk PBX interface.">agent_request</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="keywordtype">int</span> *<a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>)
<a name="l01453"></a>01453 {
<a name="l01454"></a>01454    <span class="keyword">struct </span>agent_pvt *p;
<a name="l01455"></a>01455    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = NULL;
<a name="l01456"></a>01456    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l01457"></a>01457    <a class="code" href="channel_8h.html#a641d81d0c5c8df99d43eff69aede3bfd">ast_group_t</a> groupmatch;
<a name="l01458"></a>01458    <span class="keywordtype">int</span> groupoff;
<a name="l01459"></a>01459    <span class="keywordtype">int</span> waitforagent=0;
<a name="l01460"></a>01460    <span class="keywordtype">int</span> hasagent = 0;
<a name="l01461"></a>01461    <span class="keyword">struct </span>timeval now;
<a name="l01462"></a>01462 
<a name="l01463"></a>01463    s = data;
<a name="l01464"></a>01464    <span class="keywordflow">if</span> ((s[0] == <span class="charliteral">&apos;@&apos;</span>) &amp;&amp; (sscanf(s + 1, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;groupoff) == 1)) {
<a name="l01465"></a>01465       groupmatch = (1 &lt;&lt; groupoff);
<a name="l01466"></a>01466    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((s[0] == <span class="charliteral">&apos;:&apos;</span>) &amp;&amp; (sscanf(s + 1, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;groupoff) == 1)) {
<a name="l01467"></a>01467       groupmatch = (1 &lt;&lt; groupoff);
<a name="l01468"></a>01468       waitforagent = 1;
<a name="l01469"></a>01469    } <span class="keywordflow">else</span> 
<a name="l01470"></a>01470       groupmatch = 0;
<a name="l01471"></a>01471 
<a name="l01472"></a>01472    <span class="comment">/* Check actual logged in agents first */</span>
<a name="l01473"></a>01473    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l01474"></a>01474    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l01475"></a>01475       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01476"></a>01476       <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a> &amp;&amp; ((groupmatch &amp;&amp; (p-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a> &amp; groupmatch)) || !strcmp(data, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>)) &amp;&amp;
<a name="l01477"></a>01477           <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>)) {
<a name="l01478"></a>01478          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l01479"></a>01479             hasagent++;
<a name="l01480"></a>01480          now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l01481"></a>01481          <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>.tv_sec || (now.tv_sec &gt;= p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>.tv_sec)) {
<a name="l01482"></a>01482             p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a> = <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0, 0);
<a name="l01483"></a>01483             <span class="comment">/* Agent must be registered, but not have any active call, and not be in a waiting state */</span>
<a name="l01484"></a>01484             <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01485"></a>01485                <span class="comment">/* Fixed agent */</span>
<a name="l01486"></a>01486                chan = <a class="code" href="chan__agent_8c.html#aa122afe2165de7cd02e3c3305a6a6b9d" title="Create new agent channel.">agent_new</a>(p, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>);
<a name="l01487"></a>01487             }
<a name="l01488"></a>01488             <span class="keywordflow">if</span> (chan) {
<a name="l01489"></a>01489                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01490"></a>01490                <span class="keywordflow">break</span>;
<a name="l01491"></a>01491             }
<a name="l01492"></a>01492          }
<a name="l01493"></a>01493       }
<a name="l01494"></a>01494       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01495"></a>01495    }
<a name="l01496"></a>01496    <span class="keywordflow">if</span> (!p) {
<a name="l01497"></a>01497       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l01498"></a>01498          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01499"></a>01499          <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a> &amp;&amp; ((groupmatch &amp;&amp; (p-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a> &amp; groupmatch)) || !strcmp(data, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>))) {
<a name="l01500"></a>01500             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> || !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>))
<a name="l01501"></a>01501                hasagent++;
<a name="l01502"></a>01502             now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l01503"></a>01503 <span class="preprocessor">#if 0</span>
<a name="l01504"></a>01504 <span class="preprocessor"></span>            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Time now: %ld, Time of lastdisc: %ld\n&quot;</span>, now.tv_sec, p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>.tv_sec);
<a name="l01505"></a>01505 <span class="preprocessor">#endif</span>
<a name="l01506"></a>01506 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>.tv_sec || (now.tv_sec &gt;= p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>.tv_sec)) {
<a name="l01507"></a>01507                p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a> = <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0, 0);
<a name="l01508"></a>01508                <span class="comment">/* Agent must be registered, but not have any active call, and not be in a waiting state */</span>
<a name="l01509"></a>01509                <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01510"></a>01510                   <span class="comment">/* Could still get a fixed agent */</span>
<a name="l01511"></a>01511                   chan = <a class="code" href="chan__agent_8c.html#aa122afe2165de7cd02e3c3305a6a6b9d" title="Create new agent channel.">agent_new</a>(p, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>);
<a name="l01512"></a>01512                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>)) {
<a name="l01513"></a>01513                   <span class="comment">/* Adjustable agent */</span>
<a name="l01514"></a>01514                   p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = <a class="code" href="channel_8h.html#a922b0c040026477b8e2020211abf604a" title="Requests a channel.">ast_request</a>(<span class="stringliteral">&quot;Local&quot;</span>, format, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, cause);
<a name="l01515"></a>01515                   <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l01516"></a>01516                      chan = <a class="code" href="chan__agent_8c.html#aa122afe2165de7cd02e3c3305a6a6b9d" title="Create new agent channel.">agent_new</a>(p, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>);
<a name="l01517"></a>01517                }
<a name="l01518"></a>01518                <span class="keywordflow">if</span> (chan) {
<a name="l01519"></a>01519                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01520"></a>01520                   <span class="keywordflow">break</span>;
<a name="l01521"></a>01521                }
<a name="l01522"></a>01522             }
<a name="l01523"></a>01523          }
<a name="l01524"></a>01524          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01525"></a>01525       }
<a name="l01526"></a>01526    }
<a name="l01527"></a>01527 
<a name="l01528"></a>01528    <span class="keywordflow">if</span> (!chan &amp;&amp; waitforagent) {
<a name="l01529"></a>01529       <span class="comment">/* No agent available -- but we&apos;re requesting to wait for one.</span>
<a name="l01530"></a>01530 <span class="comment">         Allocate a place holder */</span>
<a name="l01531"></a>01531       <span class="keywordflow">if</span> (hasagent) {
<a name="l01532"></a>01532          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Creating place holder for &apos;%s&apos;\n&quot;</span>, s);
<a name="l01533"></a>01533          p = <a class="code" href="chan__agent_8c.html#aadf5bf36195ebd800f3dd7eeeef9049b">add_agent</a>(data, 1);
<a name="l01534"></a>01534          p-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a> = groupmatch;
<a name="l01535"></a>01535          chan = <a class="code" href="chan__agent_8c.html#aa122afe2165de7cd02e3c3305a6a6b9d" title="Create new agent channel.">agent_new</a>(p, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>);
<a name="l01536"></a>01536          <span class="keywordflow">if</span> (!chan) 
<a name="l01537"></a>01537             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Weird...  Fix this to drop the unused pending agent\n&quot;</span>);
<a name="l01538"></a>01538       } <span class="keywordflow">else</span> {
<a name="l01539"></a>01539          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Not creating place holder for &apos;%s&apos; since nobody logged in\n&quot;</span>, s);
<a name="l01540"></a>01540       }
<a name="l01541"></a>01541    }
<a name="l01542"></a>01542    *cause = hasagent ? <a class="code" href="causes_8h.html#ae009c193522491f7de7ea28b23f20868">AST_CAUSE_BUSY</a> : <a class="code" href="causes_8h.html#acfea62de81ffbf78fd4856ad9ded150b">AST_CAUSE_UNREGISTERED</a>;
<a name="l01543"></a>01543    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l01544"></a>01544    <span class="keywordflow">return</span> chan;
<a name="l01545"></a>01545 }
<a name="l01546"></a>01546 
<a name="l01547"></a><a class="code" href="chan__agent_8c.html#a1c7c763fec10eeb2cc2614cd229c59e1">01547</a> <span class="keyword">static</span> <a class="code" href="compiler_8h.html#ae8c57c7218a376f10cbdf0e50f1189ee">force_inline</a> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a1c7c763fec10eeb2cc2614cd229c59e1">powerof</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d)
<a name="l01548"></a>01548 {
<a name="l01549"></a>01549    <span class="keywordtype">int</span> x = ffs(d);
<a name="l01550"></a>01550 
<a name="l01551"></a>01551    <span class="keywordflow">if</span> (x)
<a name="l01552"></a>01552       <span class="keywordflow">return</span> x - 1;
<a name="l01553"></a>01553 
<a name="l01554"></a>01554    <span class="keywordflow">return</span> 0;
<a name="l01555"></a>01555 }
<a name="l01556"></a>01556 <span class="comment"></span>
<a name="l01557"></a>01557 <span class="comment">/*!</span>
<a name="l01558"></a>01558 <span class="comment"> * Lists agents and their status to the Manager API.</span>
<a name="l01559"></a>01559 <span class="comment"> * It is registered on load_module() and it gets called by the manager backend.</span>
<a name="l01560"></a>01560 <span class="comment"> * \param s</span>
<a name="l01561"></a>01561 <span class="comment"> * \param m</span>
<a name="l01562"></a>01562 <span class="comment"> * \returns </span>
<a name="l01563"></a>01563 <span class="comment"> * \sa action_agent_logoff(), load_module().</span>
<a name="l01564"></a>01564 <span class="comment"> */</span>
<a name="l01565"></a><a class="code" href="chan__agent_8c.html#a0c9069d554e6ace86b060a06c56d2ba3">01565</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a0c9069d554e6ace86b060a06c56d2ba3">action_agents</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01566"></a>01566 {
<a name="l01567"></a>01567    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l01568"></a>01568    <span class="keywordtype">char</span> idText[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01569"></a>01569    <span class="keywordtype">char</span> chanbuf[256];
<a name="l01570"></a>01570    <span class="keyword">struct </span>agent_pvt *p;
<a name="l01571"></a>01571    <span class="keywordtype">char</span> *username = NULL;
<a name="l01572"></a>01572    <span class="keywordtype">char</span> *loginChan = NULL;
<a name="l01573"></a>01573    <span class="keywordtype">char</span> *talkingto = NULL;
<a name="l01574"></a>01574    <span class="keywordtype">char</span> *talkingtoChan = NULL;
<a name="l01575"></a>01575    <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = NULL;
<a name="l01576"></a>01576 
<a name="l01577"></a>01577    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l01578"></a>01578       snprintf(idText, <span class="keyword">sizeof</span>(idText) ,<span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, <span class="keywordtype">id</span>);
<a name="l01579"></a>01579    <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Agents will follow&quot;</span>);
<a name="l01580"></a>01580    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l01581"></a>01581    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l01582"></a>01582          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01583"></a>01583 
<a name="l01584"></a>01584       <span class="comment">/* Status Values:</span>
<a name="l01585"></a>01585 <span class="comment">         AGENT_LOGGEDOFF - Agent isn&apos;t logged in</span>
<a name="l01586"></a>01586 <span class="comment">         AGENT_IDLE      - Agent is logged in, and waiting for call</span>
<a name="l01587"></a>01587 <span class="comment">         AGENT_ONCALL    - Agent is logged in, and on a call</span>
<a name="l01588"></a>01588 <span class="comment">         AGENT_UNKNOWN   - Don&apos;t know anything about agent. Shouldn&apos;t ever get this. */</span>
<a name="l01589"></a>01589 
<a name="l01590"></a>01590       username = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(p-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>, <span class="stringliteral">&quot;None&quot;</span>);
<a name="l01591"></a>01591 
<a name="l01592"></a>01592       <span class="comment">/* Set a default status. It &apos;should&apos; get changed. */</span>
<a name="l01593"></a>01593       status = <span class="stringliteral">&quot;AGENT_UNKNOWN&quot;</span>;
<a name="l01594"></a>01594 
<a name="l01595"></a>01595       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>) &amp;&amp; !p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01596"></a>01596          loginChan = p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>;
<a name="l01597"></a>01597          talkingto = <span class="stringliteral">&quot;n/a&quot;</span>;
<a name="l01598"></a>01598          talkingtoChan = <span class="stringliteral">&quot;n/a&quot;</span>;
<a name="l01599"></a>01599          status = <span class="stringliteral">&quot;AGENT_IDLE&quot;</span>;
<a name="l01600"></a>01600          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a>) {
<a name="l01601"></a>01601             snprintf(chanbuf, <span class="keyword">sizeof</span>(chanbuf), <span class="stringliteral">&quot; %s (Confirmed)&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>);
<a name="l01602"></a>01602             loginChan = chanbuf;
<a name="l01603"></a>01603          }
<a name="l01604"></a>01604       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01605"></a>01605          loginChan = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l01606"></a>01606          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a81ab061f1622c159fe55ba4f17309cc5">_bridge</a>) {
<a name="l01607"></a>01607             talkingto = p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>;
<a name="l01608"></a>01608             <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>))
<a name="l01609"></a>01609                talkingtoChan = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)-&gt;name);
<a name="l01610"></a>01610             <span class="keywordflow">else</span>
<a name="l01611"></a>01611                talkingtoChan = <span class="stringliteral">&quot;n/a&quot;</span>;
<a name="l01612"></a>01612                status = <span class="stringliteral">&quot;AGENT_ONCALL&quot;</span>;
<a name="l01613"></a>01613          } <span class="keywordflow">else</span> {
<a name="l01614"></a>01614             talkingto = <span class="stringliteral">&quot;n/a&quot;</span>;
<a name="l01615"></a>01615             talkingtoChan = <span class="stringliteral">&quot;n/a&quot;</span>;
<a name="l01616"></a>01616                status = <span class="stringliteral">&quot;AGENT_IDLE&quot;</span>;
<a name="l01617"></a>01617          }
<a name="l01618"></a>01618       } <span class="keywordflow">else</span> {
<a name="l01619"></a>01619          loginChan = <span class="stringliteral">&quot;n/a&quot;</span>;
<a name="l01620"></a>01620          talkingto = <span class="stringliteral">&quot;n/a&quot;</span>;
<a name="l01621"></a>01621          talkingtoChan = <span class="stringliteral">&quot;n/a&quot;</span>;
<a name="l01622"></a>01622          status = <span class="stringliteral">&quot;AGENT_LOGGEDOFF&quot;</span>;
<a name="l01623"></a>01623       }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: Agents\r\n&quot;</span>
<a name="l01626"></a>01626          <span class="stringliteral">&quot;Agent: %s\r\n&quot;</span>
<a name="l01627"></a>01627          <span class="stringliteral">&quot;Name: %s\r\n&quot;</span>
<a name="l01628"></a>01628          <span class="stringliteral">&quot;Status: %s\r\n&quot;</span>
<a name="l01629"></a>01629          <span class="stringliteral">&quot;LoggedInChan: %s\r\n&quot;</span>
<a name="l01630"></a>01630          <span class="stringliteral">&quot;LoggedInTime: %d\r\n&quot;</span>
<a name="l01631"></a>01631          <span class="stringliteral">&quot;TalkingTo: %s\r\n&quot;</span>
<a name="l01632"></a>01632          <span class="stringliteral">&quot;TalkingToChan: %s\r\n&quot;</span>
<a name="l01633"></a>01633          <span class="stringliteral">&quot;%s&quot;</span>
<a name="l01634"></a>01634          <span class="stringliteral">&quot;\r\n&quot;</span>,
<a name="l01635"></a>01635          p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, username, status, loginChan, (<span class="keywordtype">int</span>)p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>, talkingto, talkingtoChan, idText);
<a name="l01636"></a>01636       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01637"></a>01637    }
<a name="l01638"></a>01638    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l01639"></a>01639    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: AgentsComplete\r\n&quot;</span>
<a name="l01640"></a>01640       <span class="stringliteral">&quot;%s&quot;</span>
<a name="l01641"></a>01641       <span class="stringliteral">&quot;\r\n&quot;</span>,idText);
<a name="l01642"></a>01642    <span class="keywordflow">return</span> 0;
<a name="l01643"></a>01643 }
<a name="l01644"></a>01644 
<a name="l01645"></a><a class="code" href="chan__agent_8c.html#a79fc2c717c9271fd4b5a3da318cc489c">01645</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__agent_8c.html#a79fc2c717c9271fd4b5a3da318cc489c">agent_logoff_maintenance</a>(<span class="keyword">struct</span> agent_pvt *p, <span class="keywordtype">char</span> *<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, <span class="keywordtype">long</span> logintime, <span class="keyword">const</span> <span class="keywordtype">char</span> *uniqueid, <span class="keywordtype">char</span> *logcommand)
<a name="l01646"></a>01646 {
<a name="l01647"></a>01647    <span class="keywordtype">char</span> *tmp = NULL;
<a name="l01648"></a>01648    <span class="keywordtype">char</span> <a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>[<a class="code" href="chan__agent_8c.html#a493e7a4ae707f3f4dc9beda1d33e77e8">AST_MAX_AGENT</a>];
<a name="l01649"></a>01649 
<a name="l01650"></a>01650    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(logcommand))
<a name="l01651"></a>01651       tmp = logcommand;
<a name="l01652"></a>01652    <span class="keywordflow">else</span>
<a name="l01653"></a>01653       tmp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<span class="stringliteral">&quot;&quot;</span>);
<a name="l01654"></a>01654 
<a name="l01655"></a>01655    snprintf(agent, <span class="keyword">sizeof</span>(agent), <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l01656"></a>01656 
<a name="l01657"></a>01657    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(uniqueid)) {
<a name="l01658"></a>01658       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;Agentcallbacklogoff&quot;</span>,
<a name="l01659"></a>01659             <span class="stringliteral">&quot;Agent: %s\r\n&quot;</span>
<a name="l01660"></a>01660             <span class="stringliteral">&quot;Reason: %s\r\n&quot;</span>
<a name="l01661"></a>01661             <span class="stringliteral">&quot;Loginchan: %s\r\n&quot;</span>
<a name="l01662"></a>01662             <span class="stringliteral">&quot;Logintime: %ld\r\n&quot;</span>
<a name="l01663"></a>01663             <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>, 
<a name="l01664"></a>01664             p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, tmp, loginchan, logintime, uniqueid);
<a name="l01665"></a>01665    } <span class="keywordflow">else</span> {
<a name="l01666"></a>01666       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;Agentcallbacklogoff&quot;</span>,
<a name="l01667"></a>01667             <span class="stringliteral">&quot;Agent: %s\r\n&quot;</span>
<a name="l01668"></a>01668             <span class="stringliteral">&quot;Reason: %s\r\n&quot;</span>
<a name="l01669"></a>01669             <span class="stringliteral">&quot;Loginchan: %s\r\n&quot;</span>
<a name="l01670"></a>01670             <span class="stringliteral">&quot;Logintime: %ld\r\n&quot;</span>,
<a name="l01671"></a>01671             p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, tmp, loginchan, logintime);
<a name="l01672"></a>01672    }
<a name="l01673"></a>01673 
<a name="l01674"></a>01674    <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(<span class="stringliteral">&quot;NONE&quot;</span>, <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(uniqueid) ? <span class="stringliteral">&quot;NONE&quot;</span> : uniqueid, agent, <span class="stringliteral">&quot;AGENTCALLBACKLOGOFF&quot;</span>, <span class="stringliteral">&quot;%s|%ld|%s&quot;</span>, loginchan, logintime, tmp);
<a name="l01675"></a>01675    <a class="code" href="chan__agent_8c.html#a2b0c86613090f2a5ff7c16eaca4601d5" title="store/clear the global variable that stores agentid based on the callerid">set_agentbycallerid</a>(p-&gt;<a class="code" href="structagent__pvt.html#a1d0896f3c265b2304808016f90742479">logincallerid</a>, NULL);
<a name="l01676"></a>01676    p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>[0] =<span class="charliteral">&apos;\0&apos;</span>;
<a name="l01677"></a>01677    p-&gt;<a class="code" href="structagent__pvt.html#a1d0896f3c265b2304808016f90742479">logincallerid</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01678"></a>01678    <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>, <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l01679"></a>01679    <span class="keywordflow">if</span> (persistent_agents)
<a name="l01680"></a>01680       <a class="code" href="chan__agent_8c.html#a25dc3d6cf242ab703a5212535685d41e" title="Dump AgentCallbackLogin agents to the ASTdb database for persistence.">dump_agents</a>();
<a name="l01681"></a>01681 
<a name="l01682"></a>01682 }
<a name="l01683"></a>01683 
<a name="l01684"></a><a class="code" href="chan__agent_8c.html#a6334ca5682dabafc368734fdb16f85bb">01684</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a6334ca5682dabafc368734fdb16f85bb">agent_logoff</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, <span class="keywordtype">int</span> soft)
<a name="l01685"></a>01685 {
<a name="l01686"></a>01686    <span class="keyword">struct </span>agent_pvt *p;
<a name="l01687"></a>01687    <span class="keywordtype">long</span> logintime;
<a name="l01688"></a>01688    <span class="keywordtype">int</span> ret = -1; <span class="comment">/* Return -1 if no agent if found */</span>
<a name="l01689"></a>01689 
<a name="l01690"></a>01690    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l01691"></a>01691    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l01692"></a>01692       <span class="keywordflow">if</span> (!strcasecmp(p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, agent)) {
<a name="l01693"></a>01693          ret = 0;
<a name="l01694"></a>01694          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> || p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01695"></a>01695             <span class="keywordflow">if</span> (!soft) {
<a name="l01696"></a>01696                <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01697"></a>01697 
<a name="l01698"></a>01698                <span class="keywordflow">while</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; <a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)) {
<a name="l01699"></a>01699                   <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01700"></a>01700                }
<a name="l01701"></a>01701                <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l01702"></a>01702                   <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2b3b711afc65059c4b51008c9fbc7aee">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l01703"></a>01703                   <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>);
<a name="l01704"></a>01704                }
<a name="l01705"></a>01705 
<a name="l01706"></a>01706                <span class="keywordflow">while</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp; <a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)) {
<a name="l01707"></a>01707                   <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01708"></a>01708                }
<a name="l01709"></a>01709                <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01710"></a>01710                   <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2b3b711afc65059c4b51008c9fbc7aee">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l01711"></a>01711                   <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l01712"></a>01712                }
<a name="l01713"></a>01713 
<a name="l01714"></a>01714                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01715"></a>01715             } <span class="keywordflow">else</span>
<a name="l01716"></a>01716                p-&gt;<a class="code" href="structagent__pvt.html#ae6634ed33949784643bc0c217c419bb5">deferlogoff</a> = 1;
<a name="l01717"></a>01717          } <span class="keywordflow">else</span> {
<a name="l01718"></a>01718             logintime = time(NULL) - p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>;
<a name="l01719"></a>01719             p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a> = 0;
<a name="l01720"></a>01720             <a class="code" href="chan__agent_8c.html#a79fc2c717c9271fd4b5a3da318cc489c">agent_logoff_maintenance</a>(p, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, logintime, NULL, <span class="stringliteral">&quot;CommandLogoff&quot;</span>);
<a name="l01721"></a>01721          }
<a name="l01722"></a>01722          <span class="keywordflow">break</span>;
<a name="l01723"></a>01723       }
<a name="l01724"></a>01724    }
<a name="l01725"></a>01725    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l01726"></a>01726 
<a name="l01727"></a>01727    <span class="keywordflow">return</span> ret;
<a name="l01728"></a>01728 }
<a name="l01729"></a>01729 
<a name="l01730"></a><a class="code" href="chan__agent_8c.html#a3c4ce0c58fedfd7ee8bc25795029644c">01730</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#a3c4ce0c58fedfd7ee8bc25795029644c">agent_logoff_cmd</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01731"></a>01731 {
<a name="l01732"></a>01732    <span class="keywordtype">int</span> ret;
<a name="l01733"></a>01733    <span class="keywordtype">char</span> *<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>;
<a name="l01734"></a>01734 
<a name="l01735"></a>01735    <span class="keywordflow">switch</span> (cmd) {
<a name="l01736"></a>01736    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01737"></a>01737       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;agent logoff&quot;</span>;
<a name="l01738"></a>01738       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01739"></a>01739          <span class="stringliteral">&quot;Usage: agent logoff &lt;channel&gt; [soft]\n&quot;</span>
<a name="l01740"></a>01740          <span class="stringliteral">&quot;       Sets an agent as no longer logged in.\n&quot;</span>
<a name="l01741"></a>01741          <span class="stringliteral">&quot;       If &apos;soft&apos; is specified, do not hangup existing calls.\n&quot;</span>;
<a name="l01742"></a>01742       <span class="keywordflow">return</span> NULL;
<a name="l01743"></a>01743    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01744"></a>01744       <span class="keywordflow">return</span> <a class="code" href="chan__agent_8c.html#af2f9489c4c0858afef7c36d87b7b22aa">complete_agent_logoff_cmd</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>); 
<a name="l01745"></a>01745    }
<a name="l01746"></a>01746 
<a name="l01747"></a>01747    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 3 || a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 4)
<a name="l01748"></a>01748       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01749"></a>01749    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 4 &amp;&amp; strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;soft&quot;</span>))
<a name="l01750"></a>01750       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01751"></a>01751 
<a name="l01752"></a>01752    agent = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2] + 6;
<a name="l01753"></a>01753    ret = <a class="code" href="chan__agent_8c.html#a6334ca5682dabafc368734fdb16f85bb">agent_logoff</a>(agent, a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 4);
<a name="l01754"></a>01754    <span class="keywordflow">if</span> (ret == 0)
<a name="l01755"></a>01755       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Logging out %s\n&quot;</span>, agent);
<a name="l01756"></a>01756 
<a name="l01757"></a>01757    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01758"></a>01758 }
<a name="l01759"></a>01759 <span class="comment"></span>
<a name="l01760"></a>01760 <span class="comment">/*!</span>
<a name="l01761"></a>01761 <span class="comment"> * Sets an agent as no longer logged in in the Manager API.</span>
<a name="l01762"></a>01762 <span class="comment"> * It is registered on load_module() and it gets called by the manager backend.</span>
<a name="l01763"></a>01763 <span class="comment"> * \param s</span>
<a name="l01764"></a>01764 <span class="comment"> * \param m</span>
<a name="l01765"></a>01765 <span class="comment"> * \returns </span>
<a name="l01766"></a>01766 <span class="comment"> * \sa action_agents(), load_module().</span>
<a name="l01767"></a>01767 <span class="comment"> */</span>
<a name="l01768"></a><a class="code" href="chan__agent_8c.html#a6558aa820bc9dd1eebac76ee2e2951f0">01768</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a6558aa820bc9dd1eebac76ee2e2951f0">action_agent_logoff</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01769"></a>01769 {
<a name="l01770"></a>01770    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Agent&quot;</span>);
<a name="l01771"></a>01771    <span class="keyword">const</span> <span class="keywordtype">char</span> *soft_s = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Soft&quot;</span>); <span class="comment">/* &quot;true&quot; is don&apos;t hangup */</span>
<a name="l01772"></a>01772    <span class="keywordtype">int</span> soft;
<a name="l01773"></a>01773    <span class="keywordtype">int</span> ret; <span class="comment">/* return value of agent_logoff */</span>
<a name="l01774"></a>01774 
<a name="l01775"></a>01775    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(agent)) {
<a name="l01776"></a>01776       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No agent specified&quot;</span>);
<a name="l01777"></a>01777       <span class="keywordflow">return</span> 0;
<a name="l01778"></a>01778    }
<a name="l01779"></a>01779 
<a name="l01780"></a>01780    soft = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(soft_s) ? 1 : 0;
<a name="l01781"></a>01781    ret = <a class="code" href="chan__agent_8c.html#a6334ca5682dabafc368734fdb16f85bb">agent_logoff</a>(agent, soft);
<a name="l01782"></a>01782    <span class="keywordflow">if</span> (ret == 0)
<a name="l01783"></a>01783       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Agent logged out&quot;</span>);
<a name="l01784"></a>01784    <span class="keywordflow">else</span>
<a name="l01785"></a>01785       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No such agent&quot;</span>);
<a name="l01786"></a>01786 
<a name="l01787"></a>01787    <span class="keywordflow">return</span> 0;
<a name="l01788"></a>01788 }
<a name="l01789"></a>01789 
<a name="l01790"></a><a class="code" href="chan__agent_8c.html#af2f9489c4c0858afef7c36d87b7b22aa">01790</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#af2f9489c4c0858afef7c36d87b7b22aa">complete_agent_logoff_cmd</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l01791"></a>01791 {
<a name="l01792"></a>01792    <span class="keywordtype">char</span> *ret = NULL;
<a name="l01793"></a>01793 
<a name="l01794"></a>01794    <span class="keywordflow">if</span> (pos == 2) {
<a name="l01795"></a>01795       <span class="keyword">struct </span>agent_pvt *p;
<a name="l01796"></a>01796       <span class="keywordtype">char</span> <a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>[<a class="code" href="chan__agent_8c.html#a493e7a4ae707f3f4dc9beda1d33e77e8">AST_MAX_AGENT</a>];
<a name="l01797"></a>01797       <span class="keywordtype">int</span> which = 0, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(word);
<a name="l01798"></a>01798 
<a name="l01799"></a>01799       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l01800"></a>01800       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l01801"></a>01801          snprintf(name, <span class="keyword">sizeof</span>(name), <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l01802"></a>01802          <span class="keywordflow">if</span> (!strncasecmp(word, name, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>) &amp;&amp; p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a> &amp;&amp; ++which &gt; state) {
<a name="l01803"></a>01803             ret = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(name);
<a name="l01804"></a>01804             <span class="keywordflow">break</span>;
<a name="l01805"></a>01805          }
<a name="l01806"></a>01806       }
<a name="l01807"></a>01807       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l01808"></a>01808    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pos == 3 &amp;&amp; state == 0) 
<a name="l01809"></a>01809       <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;soft&quot;</span>);
<a name="l01810"></a>01810    
<a name="l01811"></a>01811    <span class="keywordflow">return</span> ret;
<a name="l01812"></a>01812 }
<a name="l01813"></a>01813 <span class="comment"></span>
<a name="l01814"></a>01814 <span class="comment">/*!</span>
<a name="l01815"></a>01815 <span class="comment"> * Show agents in cli.</span>
<a name="l01816"></a>01816 <span class="comment"> */</span>
<a name="l01817"></a><a class="code" href="chan__agent_8c.html#a7163d6437c33d7fa3ecc231fa98a8ec8">01817</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#a7163d6437c33d7fa3ecc231fa98a8ec8">agents_show</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01818"></a>01818 {
<a name="l01819"></a>01819    <span class="keyword">struct </span>agent_pvt *p;
<a name="l01820"></a>01820    <span class="keywordtype">char</span> username[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>];
<a name="l01821"></a>01821    <span class="keywordtype">char</span> location[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01822"></a>01822    <span class="keywordtype">char</span> talkingto[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01823"></a>01823    <span class="keywordtype">char</span> music[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>];
<a name="l01824"></a>01824    <span class="keywordtype">int</span> count_agents = 0;      <span class="comment">/*!&lt; Number of agents configured */</span>
<a name="l01825"></a>01825    <span class="keywordtype">int</span> online_agents = 0;     <span class="comment">/*!&lt; Number of online agents */</span>
<a name="l01826"></a>01826    <span class="keywordtype">int</span> offline_agents = 0;    <span class="comment">/*!&lt; Number of offline agents */</span>
<a name="l01827"></a>01827 
<a name="l01828"></a>01828    <span class="keywordflow">switch</span> (cmd) {
<a name="l01829"></a>01829    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01830"></a>01830       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;agent show&quot;</span>;
<a name="l01831"></a>01831       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01832"></a>01832          <span class="stringliteral">&quot;Usage: agent show\n&quot;</span>
<a name="l01833"></a>01833          <span class="stringliteral">&quot;       Provides summary information on agents.\n&quot;</span>;
<a name="l01834"></a>01834       <span class="keywordflow">return</span> NULL;
<a name="l01835"></a>01835    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01836"></a>01836       <span class="keywordflow">return</span> NULL;
<a name="l01837"></a>01837    }
<a name="l01838"></a>01838 
<a name="l01839"></a>01839    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 2)
<a name="l01840"></a>01840       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01841"></a>01841 
<a name="l01842"></a>01842    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l01843"></a>01843    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l01844"></a>01844       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01845"></a>01845       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a>) {
<a name="l01846"></a>01846          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a>)
<a name="l01847"></a>01847             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;-- Pending call to group %d\n&quot;</span>, <a class="code" href="chan__agent_8c.html#a1c7c763fec10eeb2cc2614cd229c59e1">powerof</a>(p-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a>));
<a name="l01848"></a>01848          <span class="keywordflow">else</span>
<a name="l01849"></a>01849             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;-- Pending call to agent %s\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l01850"></a>01850       } <span class="keywordflow">else</span> {
<a name="l01851"></a>01851          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>))
<a name="l01852"></a>01852             snprintf(username, <span class="keyword">sizeof</span>(username), <span class="stringliteral">&quot;(%s) &quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>);
<a name="l01853"></a>01853          <span class="keywordflow">else</span>
<a name="l01854"></a>01854             username[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01855"></a>01855          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01856"></a>01856             snprintf(location, <span class="keyword">sizeof</span>(location), <span class="stringliteral">&quot;logged in on %s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l01857"></a>01857             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>))
<a name="l01858"></a>01858                snprintf(talkingto, <span class="keyword">sizeof</span>(talkingto), <span class="stringliteral">&quot; talking to %s&quot;</span>, <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)-&gt;name);
<a name="l01859"></a>01859              <span class="keywordflow">else</span> 
<a name="l01860"></a>01860                strcpy(talkingto, <span class="stringliteral">&quot; is idle&quot;</span>);
<a name="l01861"></a>01861             online_agents++;
<a name="l01862"></a>01862          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>)) {
<a name="l01863"></a>01863             <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>) &gt; 0 || !(p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>.tv_sec)) 
<a name="l01864"></a>01864                snprintf(location, <span class="keyword">sizeof</span>(location) - 20, <span class="stringliteral">&quot;available at &apos;%s&apos;&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>);
<a name="l01865"></a>01865             <span class="keywordflow">else</span> 
<a name="l01866"></a>01866                snprintf(location, <span class="keyword">sizeof</span>(location) - 20, <span class="stringliteral">&quot;wrapping up at &apos;%s&apos;&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>);
<a name="l01867"></a>01867             talkingto[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01868"></a>01868             online_agents++;
<a name="l01869"></a>01869             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a>)
<a name="l01870"></a>01870                strncat(location, <span class="stringliteral">&quot; (Confirmed)&quot;</span>, <span class="keyword">sizeof</span>(location) - strlen(location) - 1);
<a name="l01871"></a>01871          } <span class="keywordflow">else</span> {
<a name="l01872"></a>01872             strcpy(location, <span class="stringliteral">&quot;not logged in&quot;</span>);
<a name="l01873"></a>01873             talkingto[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01874"></a>01874             offline_agents++;
<a name="l01875"></a>01875          }
<a name="l01876"></a>01876          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>))
<a name="l01877"></a>01877             snprintf(music, <span class="keyword">sizeof</span>(music), <span class="stringliteral">&quot; (musiconhold is &apos;%s&apos;)&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>);
<a name="l01878"></a>01878          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-12.12s %s%s%s%s\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, 
<a name="l01879"></a>01879             username, location, talkingto, music);
<a name="l01880"></a>01880          count_agents++;
<a name="l01881"></a>01881       }
<a name="l01882"></a>01882       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01883"></a>01883    }
<a name="l01884"></a>01884    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l01885"></a>01885    <span class="keywordflow">if</span> ( !count_agents ) 
<a name="l01886"></a>01886       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No Agents are configured in %s\n&quot;</span>,config);
<a name="l01887"></a>01887    <span class="keywordflow">else</span> 
<a name="l01888"></a>01888       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d agents configured [%d online , %d offline]\n&quot;</span>,count_agents, online_agents, offline_agents);
<a name="l01889"></a>01889    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01890"></a>01890                    
<a name="l01891"></a>01891    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01892"></a>01892 }
<a name="l01893"></a>01893 
<a name="l01894"></a>01894 
<a name="l01895"></a><a class="code" href="chan__agent_8c.html#a1abc5305d74998f0e7afa174b0d07bd5">01895</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#a1abc5305d74998f0e7afa174b0d07bd5">agents_show_online</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01896"></a>01896 {
<a name="l01897"></a>01897    <span class="keyword">struct </span>agent_pvt *p;
<a name="l01898"></a>01898    <span class="keywordtype">char</span> username[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>];
<a name="l01899"></a>01899    <span class="keywordtype">char</span> location[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01900"></a>01900    <span class="keywordtype">char</span> talkingto[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01901"></a>01901    <span class="keywordtype">char</span> music[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>];
<a name="l01902"></a>01902    <span class="keywordtype">int</span> count_agents = 0;           <span class="comment">/* Number of agents configured */</span>
<a name="l01903"></a>01903    <span class="keywordtype">int</span> online_agents = 0;          <span class="comment">/* Number of online agents */</span>
<a name="l01904"></a>01904    <span class="keywordtype">int</span> agent_status = 0;           <span class="comment">/* 0 means offline, 1 means online */</span>
<a name="l01905"></a>01905 
<a name="l01906"></a>01906    <span class="keywordflow">switch</span> (cmd) {
<a name="l01907"></a>01907    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01908"></a>01908       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;agent show online&quot;</span>;
<a name="l01909"></a>01909       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01910"></a>01910          <span class="stringliteral">&quot;Usage: agent show online\n&quot;</span>
<a name="l01911"></a>01911          <span class="stringliteral">&quot;       Provides a list of all online agents.\n&quot;</span>;
<a name="l01912"></a>01912       <span class="keywordflow">return</span> NULL;
<a name="l01913"></a>01913    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01914"></a>01914       <span class="keywordflow">return</span> NULL;
<a name="l01915"></a>01915    }
<a name="l01916"></a>01916 
<a name="l01917"></a>01917    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l01918"></a>01918       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01919"></a>01919 
<a name="l01920"></a>01920    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l01921"></a>01921    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l01922"></a>01922       agent_status = 0;       <span class="comment">/* reset it to offline */</span>
<a name="l01923"></a>01923       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01924"></a>01924       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>))
<a name="l01925"></a>01925          snprintf(username, <span class="keyword">sizeof</span>(username), <span class="stringliteral">&quot;(%s) &quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>);
<a name="l01926"></a>01926       <span class="keywordflow">else</span>
<a name="l01927"></a>01927          username[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01928"></a>01928       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01929"></a>01929          snprintf(location, <span class="keyword">sizeof</span>(location), <span class="stringliteral">&quot;logged in on %s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l01930"></a>01930          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)) 
<a name="l01931"></a>01931             snprintf(talkingto, <span class="keyword">sizeof</span>(talkingto), <span class="stringliteral">&quot; talking to %s&quot;</span>, <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)-&gt;name);
<a name="l01932"></a>01932          <span class="keywordflow">else</span> 
<a name="l01933"></a>01933             strcpy(talkingto, <span class="stringliteral">&quot; is idle&quot;</span>);
<a name="l01934"></a>01934          agent_status = 1;
<a name="l01935"></a>01935          online_agents++;
<a name="l01936"></a>01936       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>)) {
<a name="l01937"></a>01937          snprintf(location, <span class="keyword">sizeof</span>(location) - 20, <span class="stringliteral">&quot;available at &apos;%s&apos;&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>);
<a name="l01938"></a>01938          talkingto[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01939"></a>01939          agent_status = 1;
<a name="l01940"></a>01940          online_agents++;
<a name="l01941"></a>01941          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a>)
<a name="l01942"></a>01942             strncat(location, <span class="stringliteral">&quot; (Confirmed)&quot;</span>, <span class="keyword">sizeof</span>(location) - strlen(location) - 1);
<a name="l01943"></a>01943       }
<a name="l01944"></a>01944       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>))
<a name="l01945"></a>01945          snprintf(music, <span class="keyword">sizeof</span>(music), <span class="stringliteral">&quot; (musiconhold is &apos;%s&apos;)&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>);
<a name="l01946"></a>01946       <span class="keywordflow">if</span> (agent_status)
<a name="l01947"></a>01947          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-12.12s %s%s%s%s\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, username, location, talkingto, music);
<a name="l01948"></a>01948       count_agents++;
<a name="l01949"></a>01949       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01950"></a>01950    }
<a name="l01951"></a>01951    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l01952"></a>01952    <span class="keywordflow">if</span> (!count_agents) 
<a name="l01953"></a>01953       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No Agents are configured in %s\n&quot;</span>, config);
<a name="l01954"></a>01954    <span class="keywordflow">else</span>
<a name="l01955"></a>01955       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d agents online\n&quot;</span>, online_agents);
<a name="l01956"></a>01956    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01957"></a>01957    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01958"></a>01958 }
<a name="l01959"></a>01959 
<a name="l01960"></a><a class="code" href="chan__agent_8c.html#a373909fdc8307bd4a214632610ff6c07">01960</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="chan__agent_8c.html#a373909fdc8307bd4a214632610ff6c07">agent_logoff_usage</a>[] =
<a name="l01961"></a>01961 <span class="stringliteral">&quot;Usage: agent logoff &lt;channel&gt; [soft]\n&quot;</span>
<a name="l01962"></a>01962 <span class="stringliteral">&quot;       Sets an agent as no longer logged in.\n&quot;</span>
<a name="l01963"></a>01963 <span class="stringliteral">&quot;       If &apos;soft&apos; is specified, do not hangup existing calls.\n&quot;</span>;
<a name="l01964"></a>01964 
<a name="l01965"></a><a class="code" href="chan__agent_8c.html#a86ce161e89fb61c8534e1eca1cdcf618">01965</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="chan__agent_8c.html#a86ce161e89fb61c8534e1eca1cdcf618">cli_agents</a>[] = {
<a name="l01966"></a>01966    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__agent_8c.html#a7163d6437c33d7fa3ecc231fa98a8ec8">agents_show</a>, <span class="stringliteral">&quot;Show status of agents&quot;</span>),
<a name="l01967"></a>01967    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__agent_8c.html#a1abc5305d74998f0e7afa174b0d07bd5">agents_show_online</a>, <span class="stringliteral">&quot;Show all online agents&quot;</span>),
<a name="l01968"></a>01968    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__agent_8c.html#a3c4ce0c58fedfd7ee8bc25795029644c">agent_logoff_cmd</a>, <span class="stringliteral">&quot;Sets an agent offline&quot;</span>),
<a name="l01969"></a>01969 };
<a name="l01970"></a>01970 <span class="comment"></span>
<a name="l01971"></a>01971 <span class="comment">/*!</span>
<a name="l01972"></a>01972 <span class="comment"> * Called by the AgentLogin application (from the dial plan).</span>
<a name="l01973"></a>01973 <span class="comment"> * </span>
<a name="l01974"></a>01974 <span class="comment"> * \brief Log in agent application.</span>
<a name="l01975"></a>01975 <span class="comment"> *</span>
<a name="l01976"></a>01976 <span class="comment"> * \param chan</span>
<a name="l01977"></a>01977 <span class="comment"> * \param data</span>
<a name="l01978"></a>01978 <span class="comment"> * \returns</span>
<a name="l01979"></a>01979 <span class="comment"> * \sa agentmonitoroutgoing_exec(), load_module().</span>
<a name="l01980"></a>01980 <span class="comment"> */</span>
<a name="l01981"></a><a class="code" href="chan__agent_8c.html#a03b3d0db1411e70375d8455667aa8c35">01981</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a03b3d0db1411e70375d8455667aa8c35" title="Log in agent application.">login_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l01982"></a>01982 {
<a name="l01983"></a>01983    <span class="keywordtype">int</span> res=0;
<a name="l01984"></a>01984    <span class="keywordtype">int</span> tries = 0;
<a name="l01985"></a>01985    <span class="keywordtype">int</span> max_login_tries = maxlogintries;
<a name="l01986"></a>01986    <span class="keyword">struct </span>agent_pvt *p;
<a name="l01987"></a>01987    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u;
<a name="l01988"></a>01988    <span class="keywordtype">int</span> login_state = 0;
<a name="l01989"></a>01989    <span class="keywordtype">char</span> <a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>[<a class="code" href="chan__agent_8c.html#a493e7a4ae707f3f4dc9beda1d33e77e8">AST_MAX_AGENT</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01990"></a>01990    <span class="keywordtype">char</span> <a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>[<a class="code" href="chan__agent_8c.html#a493e7a4ae707f3f4dc9beda1d33e77e8">AST_MAX_AGENT</a>];
<a name="l01991"></a>01991    <span class="keywordtype">char</span> <a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>[<a class="code" href="chan__agent_8c.html#a493e7a4ae707f3f4dc9beda1d33e77e8">AST_MAX_AGENT</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01992"></a>01992    <span class="keywordtype">char</span> xpass[<a class="code" href="chan__agent_8c.html#a493e7a4ae707f3f4dc9beda1d33e77e8">AST_MAX_AGENT</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01993"></a>01993    <span class="keywordtype">char</span> *errmsg;
<a name="l01994"></a>01994    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l01995"></a>01995    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l01996"></a>01996               <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(agent_id);
<a name="l01997"></a>01997               <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l01998"></a>01998               <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structextension.html">extension</a>);
<a name="l01999"></a>01999       );
<a name="l02000"></a>02000    <span class="keyword">const</span> <span class="keywordtype">char</span> *tmpoptions = NULL;
<a name="l02001"></a>02001    <span class="keywordtype">int</span> play_announcement = 1;
<a name="l02002"></a>02002    <span class="keywordtype">char</span> agent_goodbye[<a class="code" href="chan__agent_8c.html#a70f9f919042ae338d621b61ac5e3828e">AST_MAX_FILENAME_LEN</a>];
<a name="l02003"></a>02003    <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ac74b177160ca0597a5878ddcb95d9579" title="queues.conf [general] option">update_cdr</a> = updatecdr;
<a name="l02004"></a>02004    <span class="keywordtype">char</span> *filename = <span class="stringliteral">&quot;agent-loginok&quot;</span>;
<a name="l02005"></a>02005 
<a name="l02006"></a>02006    u = <a class="code" href="module_8h.html#ab941a600dc47b469ab225f140bc0973f">ast_module_user_add</a>(chan);
<a name="l02007"></a>02007 
<a name="l02008"></a>02008    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l02009"></a>02009 
<a name="l02010"></a>02010    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l02011"></a>02011 
<a name="l02012"></a>02012    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(agent_goodbye, agentgoodbye, <span class="keyword">sizeof</span>(agent_goodbye));
<a name="l02013"></a>02013 
<a name="l02014"></a>02014    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l02015"></a>02015    <span class="comment">/* Set Channel Specific Login Overrides */</span>
<a name="l02016"></a>02016    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTLMAXLOGINTRIES&quot;</span>))) {
<a name="l02017"></a>02017       max_login_tries = atoi(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTMAXLOGINTRIES&quot;</span>));
<a name="l02018"></a>02018       <span class="keywordflow">if</span> (max_login_tries &lt; 0)
<a name="l02019"></a>02019          max_login_tries = 0;
<a name="l02020"></a>02020       tmpoptions=<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTMAXLOGINTRIES&quot;</span>);
<a name="l02021"></a>02021       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Saw variable AGENTMAXLOGINTRIES=%s, setting max_login_tries to: %d on Channel &apos;%s&apos;.\n&quot;</span>,tmpoptions,max_login_tries,chan-&gt;name);
<a name="l02022"></a>02022    }
<a name="l02023"></a>02023    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTUPDATECDR&quot;</span>))) {
<a name="l02024"></a>02024       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTUPDATECDR&quot;</span>)))
<a name="l02025"></a>02025          update_cdr = 1;
<a name="l02026"></a>02026       <span class="keywordflow">else</span>
<a name="l02027"></a>02027          update_cdr = 0;
<a name="l02028"></a>02028       tmpoptions=<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTUPDATECDR&quot;</span>);
<a name="l02029"></a>02029       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Saw variable AGENTUPDATECDR=%s, setting update_cdr to: %d on Channel &apos;%s&apos;.\n&quot;</span>,tmpoptions,update_cdr,chan-&gt;name);
<a name="l02030"></a>02030    }
<a name="l02031"></a>02031    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTGOODBYE&quot;</span>))) {
<a name="l02032"></a>02032       strcpy(agent_goodbye, <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTGOODBYE&quot;</span>));
<a name="l02033"></a>02033       tmpoptions=<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTGOODBYE&quot;</span>);
<a name="l02034"></a>02034       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Saw variable AGENTGOODBYE=%s, setting agent_goodbye to: %s on Channel &apos;%s&apos;.\n&quot;</span>,tmpoptions,agent_goodbye,chan-&gt;name);
<a name="l02035"></a>02035    }
<a name="l02036"></a>02036    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l02037"></a>02037    <span class="comment">/* End Channel Specific Login Overrides */</span>
<a name="l02038"></a>02038    
<a name="l02039"></a>02039    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.options)) {
<a name="l02040"></a>02040       <span class="keywordflow">if</span> (strchr(args.options, <span class="charliteral">&apos;s&apos;</span>)) {
<a name="l02041"></a>02041          play_announcement = 0;
<a name="l02042"></a>02042       }
<a name="l02043"></a>02043    }
<a name="l02044"></a>02044 
<a name="l02045"></a>02045    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)
<a name="l02046"></a>02046       res = <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l02047"></a>02047    <span class="keywordflow">if</span> (!res) {
<a name="l02048"></a>02048       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.agent_id))
<a name="l02049"></a>02049          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(user, args.agent_id, <a class="code" href="chan__agent_8c.html#a493e7a4ae707f3f4dc9beda1d33e77e8">AST_MAX_AGENT</a>);
<a name="l02050"></a>02050       <span class="keywordflow">else</span>
<a name="l02051"></a>02051          res = <a class="code" href="app_8h.html#af3f76858d4dd513e59dbe5e67bc46220" title="Plays a stream and gets DTMF data from a channel.">ast_app_getdata</a>(chan, <span class="stringliteral">&quot;agent-user&quot;</span>, user, <span class="keyword">sizeof</span>(user) - 1, 0);
<a name="l02052"></a>02052    }
<a name="l02053"></a>02053    <span class="keywordflow">while</span> (!res &amp;&amp; (max_login_tries==0 || tries &lt; max_login_tries)) {
<a name="l02054"></a>02054       tries++;
<a name="l02055"></a>02055       <span class="comment">/* Check for password */</span>
<a name="l02056"></a>02056       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l02057"></a>02057       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l02058"></a>02058          <span class="keywordflow">if</span> (!strcmp(p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, user) &amp;&amp; !p-&gt;<a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a>)
<a name="l02059"></a>02059             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(xpass, p-&gt;<a class="code" href="structagent__pvt.html#a89ef5ad192d222ee54b1e0c4edf45cb6">password</a>, <span class="keyword">sizeof</span>(xpass));
<a name="l02060"></a>02060       }
<a name="l02061"></a>02061       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l02062"></a>02062       <span class="keywordflow">if</span> (!res) {
<a name="l02063"></a>02063          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(xpass))
<a name="l02064"></a>02064             res = <a class="code" href="app_8h.html#af3f76858d4dd513e59dbe5e67bc46220" title="Plays a stream and gets DTMF data from a channel.">ast_app_getdata</a>(chan, <span class="stringliteral">&quot;agent-pass&quot;</span>, pass, <span class="keyword">sizeof</span>(pass) - 1, 0);
<a name="l02065"></a>02065          <span class="keywordflow">else</span>
<a name="l02066"></a>02066             pass[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02067"></a>02067       }
<a name="l02068"></a>02068       errmsg = <span class="stringliteral">&quot;agent-incorrect&quot;</span>;
<a name="l02069"></a>02069 
<a name="l02070"></a>02070 <span class="preprocessor">#if 0</span>
<a name="l02071"></a>02071 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;user: %s, pass: %s\n&quot;</span>, user, pass);
<a name="l02072"></a>02072 <span class="preprocessor">#endif      </span>
<a name="l02073"></a>02073 <span class="preprocessor"></span>
<a name="l02074"></a>02074       <span class="comment">/* Check again for accuracy */</span>
<a name="l02075"></a>02075       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l02076"></a>02076       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l02077"></a>02077          <span class="keywordtype">int</span> unlock_channel = 1;
<a name="l02078"></a>02078          <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l02079"></a>02079          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02080"></a>02080          <span class="keywordflow">if</span> (!strcmp(p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, user) &amp;&amp;
<a name="l02081"></a>02081              !strcmp(p-&gt;<a class="code" href="structagent__pvt.html#a89ef5ad192d222ee54b1e0c4edf45cb6">password</a>, pass) &amp;&amp; !p-&gt;<a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a>) {
<a name="l02082"></a>02082             login_state = 1; <span class="comment">/* Successful Login */</span>
<a name="l02083"></a>02083 
<a name="l02084"></a>02084             <span class="comment">/* Ensure we can&apos;t be gotten until we&apos;re done */</span>
<a name="l02085"></a>02085             p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l02086"></a>02086             p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>.tv_sec++;
<a name="l02087"></a>02087 
<a name="l02088"></a>02088             <span class="comment">/* Set Channel Specific Agent Overrides */</span>
<a name="l02089"></a>02089             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTACKCALL&quot;</span>))) {
<a name="l02090"></a>02090                <span class="keywordflow">if</span> (!strcasecmp(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTACKCALL&quot;</span>), <span class="stringliteral">&quot;always&quot;</span>))
<a name="l02091"></a>02091                   p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a> = 2;
<a name="l02092"></a>02092                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTACKCALL&quot;</span>)))
<a name="l02093"></a>02093                   p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a> = 1;
<a name="l02094"></a>02094                <span class="keywordflow">else</span>
<a name="l02095"></a>02095                   p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a> = 0;
<a name="l02096"></a>02096                tmpoptions=<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTACKCALL&quot;</span>);
<a name="l02097"></a>02097                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Saw variable AGENTACKCALL=%s, setting ackcall to: %d for Agent &apos;%s&apos;.\n&quot;</span>, tmpoptions, p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02098"></a>02098                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(p, <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173a95b3856eae5d97e0aa2993019cba8a2d">AGENT_FLAG_ACKCALL</a>);
<a name="l02099"></a>02099             } <span class="keywordflow">else</span> {
<a name="l02100"></a>02100                p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a> = ackcall;
<a name="l02101"></a>02101             }
<a name="l02102"></a>02102             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTAUTOLOGOFF&quot;</span>))) {
<a name="l02103"></a>02103                p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a> = atoi(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTAUTOLOGOFF&quot;</span>));
<a name="l02104"></a>02104                <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a> &lt; 0)
<a name="l02105"></a>02105                   p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a> = 0;
<a name="l02106"></a>02106                tmpoptions=<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTAUTOLOGOFF&quot;</span>);
<a name="l02107"></a>02107                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Saw variable AGENTAUTOLOGOFF=%s, setting autologff to: %d for Agent &apos;%s&apos;.\n&quot;</span>, tmpoptions, p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02108"></a>02108                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(p, <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173ac649bc6edb894d204cdf584c319a73fd">AGENT_FLAG_AUTOLOGOFF</a>);
<a name="l02109"></a>02109             } <span class="keywordflow">else</span> {
<a name="l02110"></a>02110                p-&gt;<a class="code" href="structagent__pvt.html#acd7840ef12b52f1c109cda04e1550ae5">autologoff</a> = autologoff;
<a name="l02111"></a>02111             }
<a name="l02112"></a>02112             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTWRAPUPTIME&quot;</span>))) {
<a name="l02113"></a>02113                p-&gt;<a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> = atoi(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTWRAPUPTIME&quot;</span>));
<a name="l02114"></a>02114                <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> &lt; 0)
<a name="l02115"></a>02115                   p-&gt;<a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> = 0;
<a name="l02116"></a>02116                tmpoptions=<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTWRAPUPTIME&quot;</span>);
<a name="l02117"></a>02117                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Saw variable AGENTWRAPUPTIME=%s, setting wrapuptime to: %d for Agent &apos;%s&apos;.\n&quot;</span>, tmpoptions, p-&gt;<a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02118"></a>02118                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(p, <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173adb917e73669ec6ef37d8ba1fdf3d287a">AGENT_FLAG_WRAPUPTIME</a>);
<a name="l02119"></a>02119             } <span class="keywordflow">else</span> {
<a name="l02120"></a>02120                p-&gt;<a class="code" href="structagent__pvt.html#a9298f7c0bf15cf275f4664d6959a6da6">wrapuptime</a> = wrapuptime;
<a name="l02121"></a>02121             }
<a name="l02122"></a>02122             tmpoptions = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTACCEPTDTMF&quot;</span>);
<a name="l02123"></a>02123             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(tmpoptions)) {
<a name="l02124"></a>02124                p-&gt;<a class="code" href="structagent__pvt.html#a97629727ac11792aa963aed4457abde8">acceptdtmf</a> = *tmpoptions;
<a name="l02125"></a>02125                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Saw variable AGENTACCEPTDTMF=%s, setting acceptdtmf to: %c for Agent &apos;%s&apos;.\n&quot;</span>, tmpoptions, p-&gt;<a class="code" href="structagent__pvt.html#a97629727ac11792aa963aed4457abde8">acceptdtmf</a>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02126"></a>02126                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(p, <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173a4c5894c85df72565d9ba1cb16e6b3bfc">AGENT_FLAG_ACCEPTDTMF</a>);
<a name="l02127"></a>02127             }
<a name="l02128"></a>02128             tmpoptions = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AGENTENDDTMF&quot;</span>);
<a name="l02129"></a>02129             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(tmpoptions)) {
<a name="l02130"></a>02130                p-&gt;<a class="code" href="structagent__pvt.html#a064a847aaeac6f1dc116434663517d16">enddtmf</a> = *tmpoptions;
<a name="l02131"></a>02131                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Saw variable AGENTENDDTMF=%s, setting enddtmf to: %c for Agent &apos;%s&apos;.\n&quot;</span>, tmpoptions, p-&gt;<a class="code" href="structagent__pvt.html#a064a847aaeac6f1dc116434663517d16">enddtmf</a>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02132"></a>02132                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(p, <a class="code" href="chan__agent_8c.html#a56a0f36da7f9eaaf54bd05cc2bf49173a4542cbcf2199a92543eee76c28666ec3">AGENT_FLAG_ENDDTMF</a>);
<a name="l02133"></a>02133             }
<a name="l02134"></a>02134             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l02135"></a>02135             unlock_channel = 0;
<a name="l02136"></a>02136             <span class="comment">/* End Channel Specific Agent Overrides */</span>
<a name="l02137"></a>02137             <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l02138"></a>02138                <span class="keywordtype">long</span> logintime;
<a name="l02139"></a>02139                snprintf(agent, <span class="keyword">sizeof</span>(agent), <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02140"></a>02140 
<a name="l02141"></a>02141                p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02142"></a>02142                p-&gt;<a class="code" href="structagent__pvt.html#a1d0896f3c265b2304808016f90742479">logincallerid</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02143"></a>02143                p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> = 0;
<a name="l02144"></a>02144                
<a name="l02145"></a>02145                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02146"></a>02146                <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l02147"></a>02147                <span class="keywordflow">if</span>( !res &amp;&amp; play_announcement==1 )
<a name="l02148"></a>02148                   res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, filename, chan-&gt;language);
<a name="l02149"></a>02149                <span class="keywordflow">if</span> (!res)
<a name="l02150"></a>02150                   <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02151"></a>02151                <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l02152"></a>02152                <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02153"></a>02153                <span class="keywordflow">if</span> (!res) {
<a name="l02154"></a>02154                   res = <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(chan, <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(chan-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>));
<a name="l02155"></a>02155                   <span class="keywordflow">if</span> (res)
<a name="l02156"></a>02156                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set read format to %d\n&quot;</span>, <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(chan-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>));
<a name="l02157"></a>02157                }
<a name="l02158"></a>02158                <span class="keywordflow">if</span> (!res) {
<a name="l02159"></a>02159                   res = <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(chan-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>));
<a name="l02160"></a>02160                   <span class="keywordflow">if</span> (res)
<a name="l02161"></a>02161                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set write format to %d\n&quot;</span>, <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(chan-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>));
<a name="l02162"></a>02162                }
<a name="l02163"></a>02163                <span class="comment">/* Check once more just in case */</span>
<a name="l02164"></a>02164                <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l02165"></a>02165                   res = -1;
<a name="l02166"></a>02166                <span class="keywordflow">if</span> (!res) {
<a name="l02167"></a>02167                   <a class="code" href="channel_8h.html#aa8c3522af1bc639cbd5b38f5fdf171fa" title="Indicates condition of channel, with payload.">ast_indicate_data</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>, 
<a name="l02168"></a>02168                      <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(p-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>, NULL), 
<a name="l02169"></a>02169                      !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>) ? strlen(p-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>) + 1 : 0);
<a name="l02170"></a>02170                   <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a> == 0)
<a name="l02171"></a>02171                      time(&amp;p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>);
<a name="l02172"></a>02172                   <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;Agentlogin&quot;</span>,
<a name="l02173"></a>02173                            <span class="stringliteral">&quot;Agent: %s\r\n&quot;</span>
<a name="l02174"></a>02174                            <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l02175"></a>02175                            <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>,
<a name="l02176"></a>02176                            p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, chan-&gt;name, chan-&gt;uniqueid);
<a name="l02177"></a>02177                   <span class="keywordflow">if</span> (update_cdr &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>)
<a name="l02178"></a>02178                      snprintf(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a6396dbd53fd6fedc1fc3ba2743f00eca">channel</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a6396dbd53fd6fedc1fc3ba2743f00eca">channel</a>), <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02179"></a>02179                   <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(<span class="stringliteral">&quot;NONE&quot;</span>, chan-&gt;uniqueid, agent, <span class="stringliteral">&quot;AGENTLOGIN&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, chan-&gt;name);
<a name="l02180"></a>02180                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Agent &apos;%s&apos; logged in (format %s/%s)\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>,
<a name="l02181"></a>02181                             <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(chan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>), <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>));
<a name="l02182"></a>02182                   <span class="comment">/* Login this channel and wait for it to go away */</span>
<a name="l02183"></a>02183                   p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = chan;
<a name="l02184"></a>02184                   <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a> &gt; 1)
<a name="l02185"></a>02185                      <a class="code" href="chan__agent_8c.html#aec462df64d494caa7f43502f7ec84f53">check_beep</a>(p, 0);
<a name="l02186"></a>02186                   <span class="keywordflow">else</span>
<a name="l02187"></a>02187                      <a class="code" href="chan__agent_8c.html#adf789d0946fb080c371702bbcd2b5e81">check_availability</a>(p, 0);
<a name="l02188"></a>02188                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02189"></a>02189                   <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l02190"></a>02190                   <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>, <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02191"></a>02191                   <span class="keywordflow">while</span> (res &gt;= 0) {
<a name="l02192"></a>02192                      <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02193"></a>02193                      <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#ae6634ed33949784643bc0c217c419bb5">deferlogoff</a> &amp;&amp; p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l02194"></a>02194                         <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2b3b711afc65059c4b51008c9fbc7aee">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l02195"></a>02195                         p-&gt;<a class="code" href="structagent__pvt.html#ae6634ed33949784643bc0c217c419bb5">deferlogoff</a> = 0;
<a name="l02196"></a>02196                      }
<a name="l02197"></a>02197                      <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> != chan)
<a name="l02198"></a>02198                         res = -1;
<a name="l02199"></a>02199                      <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02200"></a>02200                      <span class="comment">/* Yield here so other interested threads can kick in. */</span>
<a name="l02201"></a>02201                      sched_yield();
<a name="l02202"></a>02202                      <span class="keywordflow">if</span> (res)
<a name="l02203"></a>02203                         <span class="keywordflow">break</span>;
<a name="l02204"></a>02204 
<a name="l02205"></a>02205                      <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l02206"></a>02206                      <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02207"></a>02207                      <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>.tv_sec) {
<a name="l02208"></a>02208                         <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a>) &gt; 0) {
<a name="l02209"></a>02209                            <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Wrapup time for %s expired!\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02210"></a>02210                            p-&gt;<a class="code" href="structagent__pvt.html#a0367cc6527665c53100e274103f97a4b">lastdisc</a> = <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0, 0);
<a name="l02211"></a>02211                            <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>, <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02212"></a>02212                            <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a> &gt; 1)
<a name="l02213"></a>02213                               <a class="code" href="chan__agent_8c.html#aec462df64d494caa7f43502f7ec84f53">check_beep</a>(p, 0);
<a name="l02214"></a>02214                            <span class="keywordflow">else</span>
<a name="l02215"></a>02215                               <a class="code" href="chan__agent_8c.html#adf789d0946fb080c371702bbcd2b5e81">check_availability</a>(p, 0);
<a name="l02216"></a>02216                         }
<a name="l02217"></a>02217                      }
<a name="l02218"></a>02218                      <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02219"></a>02219                      <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l02220"></a>02220                      <span class="comment">/* Synchronize channel ownership between call to agent and itself. */</span>
<a name="l02221"></a>02221                      <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#a16a593c509d04ae4f46b21ada53c2ea6">app_lock</a>);
<a name="l02222"></a>02222                      <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a13b86677f5f5b6ebc899aba01af8466a">app_lock_flag</a> == 1) {
<a name="l02223"></a>02223                         <a class="code" href="lock_8h.html#ae454b1ebfb5f5e9948876d470865d9dc">ast_cond_wait</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#aedc0136c518c393de8b46d60b9018c3f">app_complete_cond</a>, &amp;p-&gt;<a class="code" href="structagent__pvt.html#a16a593c509d04ae4f46b21ada53c2ea6">app_lock</a>);
<a name="l02224"></a>02224                      }
<a name="l02225"></a>02225                      <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#a16a593c509d04ae4f46b21ada53c2ea6">app_lock</a>);
<a name="l02226"></a>02226                      <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02227"></a>02227                      <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02228"></a>02228                      <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a> &gt; 1) 
<a name="l02229"></a>02229                         res = <a class="code" href="chan__agent_8c.html#a7d255097bf9c120a32b78a0f744df34e">agent_ack_sleep</a>(p);
<a name="l02230"></a>02230                      <span class="keywordflow">else</span>
<a name="l02231"></a>02231                         res = <a class="code" href="channel_8h.html#ac23326dea0fc5f850ecd80fccef3424e" title="Wait for a specified amount of time, looking for hangups and a condition argument...">ast_safe_sleep_conditional</a>( chan, 1000, <a class="code" href="chan__agent_8c.html#adf2ecd2a40faf8d2620fa5b5ac776b01">agent_cont_sleep</a>, p );
<a name="l02232"></a>02232                      <span class="keywordflow">if</span> ((p-&gt;<a class="code" href="structagent__pvt.html#a50e50c503992dc6171d97a0d72b8dba7">ackcall</a> &gt; 1)  &amp;&amp; (res == 1)) {
<a name="l02233"></a>02233                         <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l02234"></a>02234                         <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02235"></a>02235                         <a class="code" href="chan__agent_8c.html#adf789d0946fb080c371702bbcd2b5e81">check_availability</a>(p, 0);
<a name="l02236"></a>02236                         <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02237"></a>02237                         <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l02238"></a>02238                         res = 0;
<a name="l02239"></a>02239                      }
<a name="l02240"></a>02240                      sched_yield();
<a name="l02241"></a>02241                   }
<a name="l02242"></a>02242                   <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02243"></a>02243                   <span class="keywordflow">if</span> (res &amp;&amp; p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) 
<a name="l02244"></a>02244                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Huh?  We broke out when there was still an owner?\n&quot;</span>);
<a name="l02245"></a>02245                   <span class="comment">/* Log us off if appropriate */</span>
<a name="l02246"></a>02246                   <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> == chan) {
<a name="l02247"></a>02247                      p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = NULL;
<a name="l02248"></a>02248                   }
<a name="l02249"></a>02249                   p-&gt;<a class="code" href="structagent__pvt.html#a0955165d56ebca78a23cc5257ea3b594">acknowledged</a> = 0;
<a name="l02250"></a>02250                   logintime = time(NULL) - p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>;
<a name="l02251"></a>02251                   p-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a> = 0;
<a name="l02252"></a>02252                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02253"></a>02253                   <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <span class="stringliteral">&quot;Agentlogoff&quot;</span>,
<a name="l02254"></a>02254                            <span class="stringliteral">&quot;Agent: %s\r\n&quot;</span>
<a name="l02255"></a>02255                            <span class="stringliteral">&quot;Logintime: %ld\r\n&quot;</span>
<a name="l02256"></a>02256                            <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>,
<a name="l02257"></a>02257                            p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, logintime, chan-&gt;uniqueid);
<a name="l02258"></a>02258                   <a class="code" href="logger_8h.html#a9f7a6acbec3680a06af27ae561772915">ast_queue_log</a>(<span class="stringliteral">&quot;NONE&quot;</span>, chan-&gt;uniqueid, agent, <span class="stringliteral">&quot;AGENTLOGOFF&quot;</span>, <span class="stringliteral">&quot;%s|%ld&quot;</span>, chan-&gt;name, logintime);
<a name="l02259"></a>02259                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Agent &apos;%s&apos; logged out\n&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02260"></a>02260                   <span class="comment">/* If there is no owner, go ahead and kill it now */</span>
<a name="l02261"></a>02261                   <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>, <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02262"></a>02262                   <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#aeddb1df77f26fbe111539b1c4c0c1929">dead</a> &amp;&amp; !p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l02263"></a>02263                      <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02264"></a>02264                      <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#a16a593c509d04ae4f46b21ada53c2ea6">app_lock</a>);
<a name="l02265"></a>02265                      <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#aedc0136c518c393de8b46d60b9018c3f">app_complete_cond</a>);
<a name="l02266"></a>02266                      <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(p);
<a name="l02267"></a>02267                   }
<a name="l02268"></a>02268                }
<a name="l02269"></a>02269                <span class="keywordflow">else</span> {
<a name="l02270"></a>02270                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02271"></a>02271                   p = NULL;
<a name="l02272"></a>02272                }
<a name="l02273"></a>02273                res = -1;
<a name="l02274"></a>02274             } <span class="keywordflow">else</span> {
<a name="l02275"></a>02275                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02276"></a>02276                errmsg = <span class="stringliteral">&quot;agent-alreadyon&quot;</span>;
<a name="l02277"></a>02277                p = NULL;
<a name="l02278"></a>02278             }
<a name="l02279"></a>02279             <span class="keywordflow">break</span>;
<a name="l02280"></a>02280          }
<a name="l02281"></a>02281          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02282"></a>02282          <span class="keywordflow">if</span> (unlock_channel) {
<a name="l02283"></a>02283             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l02284"></a>02284          }
<a name="l02285"></a>02285       }
<a name="l02286"></a>02286       <span class="keywordflow">if</span> (!p)
<a name="l02287"></a>02287          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l02288"></a>02288 
<a name="l02289"></a>02289       <span class="keywordflow">if</span> (!res &amp;&amp; (max_login_tries==0 || tries &lt; max_login_tries))
<a name="l02290"></a>02290          res = <a class="code" href="app_8h.html#af3f76858d4dd513e59dbe5e67bc46220" title="Plays a stream and gets DTMF data from a channel.">ast_app_getdata</a>(chan, errmsg, user, <span class="keyword">sizeof</span>(user) - 1, 0);
<a name="l02291"></a>02291    }
<a name="l02292"></a>02292       
<a name="l02293"></a>02293    <span class="keywordflow">if</span> (!res)
<a name="l02294"></a>02294       res = <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(chan, 500);
<a name="l02295"></a>02295 
<a name="l02296"></a>02296    <a class="code" href="module_8h.html#aac87725d61b6daf4ce7d7b505f1b68c9">ast_module_user_remove</a>(u);
<a name="l02297"></a>02297    
<a name="l02298"></a>02298    <span class="keywordflow">return</span> -1;
<a name="l02299"></a>02299 }
<a name="l02300"></a>02300 <span class="comment"></span>
<a name="l02301"></a>02301 <span class="comment">/*!</span>
<a name="l02302"></a>02302 <span class="comment"> *  \brief Called by the AgentMonitorOutgoing application (from the dial plan).</span>
<a name="l02303"></a>02303 <span class="comment"> *</span>
<a name="l02304"></a>02304 <span class="comment"> * \param chan</span>
<a name="l02305"></a>02305 <span class="comment"> * \param data</span>
<a name="l02306"></a>02306 <span class="comment"> * \returns</span>
<a name="l02307"></a>02307 <span class="comment"> * \sa login_exec(), load_module().</span>
<a name="l02308"></a>02308 <span class="comment"> */</span>
<a name="l02309"></a><a class="code" href="chan__agent_8c.html#a808632dd1338e3c338c95194939964ff">02309</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a808632dd1338e3c338c95194939964ff" title="Called by the AgentMonitorOutgoing application (from the dial plan).">agentmonitoroutgoing_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l02310"></a>02310 {
<a name="l02311"></a>02311    <span class="keywordtype">int</span> exitifnoagentid = 0;
<a name="l02312"></a>02312    <span class="keywordtype">int</span> nowarnings = 0;
<a name="l02313"></a>02313    <span class="keywordtype">int</span> changeoutgoing = 0;
<a name="l02314"></a>02314    <span class="keywordtype">int</span> res = 0;
<a name="l02315"></a>02315    <span class="keywordtype">char</span> <a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>[<a class="code" href="chan__agent_8c.html#a493e7a4ae707f3f4dc9beda1d33e77e8">AST_MAX_AGENT</a>];
<a name="l02316"></a>02316 
<a name="l02317"></a>02317    <span class="keywordflow">if</span> (data) {
<a name="l02318"></a>02318       <span class="keywordflow">if</span> (strchr(data, <span class="charliteral">&apos;d&apos;</span>))
<a name="l02319"></a>02319          exitifnoagentid = 1;
<a name="l02320"></a>02320       <span class="keywordflow">if</span> (strchr(data, <span class="charliteral">&apos;n&apos;</span>))
<a name="l02321"></a>02321          nowarnings = 1;
<a name="l02322"></a>02322       <span class="keywordflow">if</span> (strchr(data, <span class="charliteral">&apos;c&apos;</span>))
<a name="l02323"></a>02323          changeoutgoing = 1;
<a name="l02324"></a>02324    }
<a name="l02325"></a>02325    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>) {
<a name="l02326"></a>02326       <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp;
<a name="l02327"></a>02327       <span class="keywordtype">char</span> agentvar[<a class="code" href="chan__agent_8c.html#a34d3e99d5529e36506d0ee8a9982c281">AST_MAX_BUF</a>];
<a name="l02328"></a>02328       snprintf(agentvar, <span class="keyword">sizeof</span>(agentvar), <span class="stringliteral">&quot;%s_%s&quot;</span>, <a class="code" href="chan__agent_8c.html#a8bdad3e572ba87281b8face9e122917e">GETAGENTBYCALLERID</a>, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>);
<a name="l02329"></a>02329       <span class="keywordflow">if</span> ((tmp = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(NULL, agentvar))) {
<a name="l02330"></a>02330          <span class="keyword">struct </span>agent_pvt *p;
<a name="l02331"></a>02331          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(agent, tmp, <span class="keyword">sizeof</span>(agent));
<a name="l02332"></a>02332          <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l02333"></a>02333          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l02334"></a>02334             <span class="keywordflow">if</span> (!strcasecmp(p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, tmp)) {
<a name="l02335"></a>02335                <span class="keywordflow">if</span> (changeoutgoing) snprintf(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a6396dbd53fd6fedc1fc3ba2743f00eca">channel</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a6396dbd53fd6fedc1fc3ba2743f00eca">channel</a>), <span class="stringliteral">&quot;Agent/%s&quot;</span>, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02336"></a>02336                <a class="code" href="chan__agent_8c.html#aed9ca74dc149ae2d4a5903ea9ebf512e">__agent_start_monitoring</a>(chan, p, 1);
<a name="l02337"></a>02337                <span class="keywordflow">break</span>;
<a name="l02338"></a>02338             }
<a name="l02339"></a>02339          }
<a name="l02340"></a>02340          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l02341"></a>02341          
<a name="l02342"></a>02342       } <span class="keywordflow">else</span> {
<a name="l02343"></a>02343          res = -1;
<a name="l02344"></a>02344          <span class="keywordflow">if</span> (!nowarnings)
<a name="l02345"></a>02345             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&apos;t find the global variable %s, so I can&apos;t figure out which agent (if it&apos;s an agent) is placing outgoing call.\n&quot;</span>, agentvar);
<a name="l02346"></a>02346       }
<a name="l02347"></a>02347    } <span class="keywordflow">else</span> {
<a name="l02348"></a>02348       res = -1;
<a name="l02349"></a>02349       <span class="keywordflow">if</span> (!nowarnings)
<a name="l02350"></a>02350          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;There is no callerid on that call, so I can&apos;t figure out which agent (if it&apos;s an agent) is placing outgoing call.\n&quot;</span>);
<a name="l02351"></a>02351    }
<a name="l02352"></a>02352    <span class="keywordflow">if</span> (res) {
<a name="l02353"></a>02353       <span class="keywordflow">if</span> (exitifnoagentid)
<a name="l02354"></a>02354          <span class="keywordflow">return</span> res;
<a name="l02355"></a>02355    }
<a name="l02356"></a>02356    <span class="keywordflow">return</span> 0;
<a name="l02357"></a>02357 }
<a name="l02358"></a>02358 <span class="comment"></span>
<a name="l02359"></a>02359 <span class="comment">/*!</span>
<a name="l02360"></a>02360 <span class="comment"> * \brief Dump AgentCallbackLogin agents to the ASTdb database for persistence</span>
<a name="l02361"></a>02361 <span class="comment"> */</span>
<a name="l02362"></a><a class="code" href="chan__agent_8c.html#a25dc3d6cf242ab703a5212535685d41e">02362</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__agent_8c.html#a25dc3d6cf242ab703a5212535685d41e" title="Dump AgentCallbackLogin agents to the ASTdb database for persistence.">dump_agents</a>(<span class="keywordtype">void</span>)
<a name="l02363"></a>02363 {
<a name="l02364"></a>02364    <span class="keyword">struct </span>agent_pvt *cur_agent = NULL;
<a name="l02365"></a>02365    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256];
<a name="l02366"></a>02366 
<a name="l02367"></a>02367    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, cur_agent, list) {
<a name="l02368"></a>02368       <span class="keywordflow">if</span> (cur_agent-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l02369"></a>02369          <span class="keywordflow">continue</span>;
<a name="l02370"></a>02370 
<a name="l02371"></a>02371       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cur_agent-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>)) {
<a name="l02372"></a>02372          snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;%s;%s&quot;</span>, cur_agent-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, cur_agent-&gt;<a class="code" href="structagent__pvt.html#a1d0896f3c265b2304808016f90742479">logincallerid</a>);
<a name="l02373"></a>02373          <span class="keywordflow">if</span> (<a class="code" href="astdb_8h.html#a0f14f6bff4f412c88b50aba34d3a5e35" title="Store value addressed by family/key.">ast_db_put</a>(pa_family, cur_agent-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, buf))
<a name="l02374"></a>02374             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;failed to create persistent entry in ASTdb for %s!\n&quot;</span>, buf);
<a name="l02375"></a>02375          <span class="keywordflow">else</span>
<a name="l02376"></a>02376             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Saved Agent: %s on %s\n&quot;</span>, cur_agent-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, cur_agent-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>);
<a name="l02377"></a>02377       } <span class="keywordflow">else</span> {
<a name="l02378"></a>02378          <span class="comment">/* Delete -  no agent or there is an error */</span>
<a name="l02379"></a>02379          <a class="code" href="astdb_8h.html#a71e8d5ab1757b184683a99125d1c8160" title="Delete entry in astdb.">ast_db_del</a>(pa_family, cur_agent-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02380"></a>02380       }
<a name="l02381"></a>02381    }
<a name="l02382"></a>02382 }
<a name="l02383"></a>02383 <span class="comment"></span>
<a name="l02384"></a>02384 <span class="comment">/*!</span>
<a name="l02385"></a>02385 <span class="comment"> * \brief Reload the persistent agents from astdb.</span>
<a name="l02386"></a>02386 <span class="comment"> */</span>
<a name="l02387"></a><a class="code" href="chan__agent_8c.html#a0c4367b9eb8fa5092e7d82985a4f9cc9">02387</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__agent_8c.html#a0c4367b9eb8fa5092e7d82985a4f9cc9" title="Reload the persistent agents from astdb.">reload_agents</a>(<span class="keywordtype">void</span>)
<a name="l02388"></a>02388 {
<a name="l02389"></a>02389    <span class="keywordtype">char</span> *agent_num;
<a name="l02390"></a>02390    <span class="keyword">struct </span><a class="code" href="structast__db__entry.html">ast_db_entry</a> *db_tree;
<a name="l02391"></a>02391    <span class="keyword">struct </span><a class="code" href="structast__db__entry.html">ast_db_entry</a> *entry;
<a name="l02392"></a>02392    <span class="keyword">struct </span>agent_pvt *cur_agent;
<a name="l02393"></a>02393    <span class="keywordtype">char</span> agent_data[256];
<a name="l02394"></a>02394    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l02395"></a>02395    <span class="keywordtype">char</span> *agent_chan;
<a name="l02396"></a>02396    <span class="keywordtype">char</span> *agent_callerid;
<a name="l02397"></a>02397 
<a name="l02398"></a>02398    db_tree = <a class="code" href="astdb_8h.html#afeb9839f89da4fc24838de74739d181e" title="Get a whole family.">ast_db_gettree</a>(pa_family, NULL);
<a name="l02399"></a>02399 
<a name="l02400"></a>02400    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l02401"></a>02401    <span class="keywordflow">for</span> (entry = db_tree; entry; entry = entry-&gt;<a class="code" href="structast__db__entry.html#a3fee4a0a4bff112e0262fb8d49f41b5e">next</a>) {
<a name="l02402"></a>02402       agent_num = entry-&gt;<a class="code" href="structast__db__entry.html#a5892a9181e6a332f84d27aecd41dcd12">key</a> + strlen(pa_family) + 2;
<a name="l02403"></a>02403       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, cur_agent, list) {
<a name="l02404"></a>02404          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;cur_agent-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02405"></a>02405          <span class="keywordflow">if</span> (strcmp(agent_num, cur_agent-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>) == 0)
<a name="l02406"></a>02406             <span class="keywordflow">break</span>;
<a name="l02407"></a>02407          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;cur_agent-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02408"></a>02408       }
<a name="l02409"></a>02409       <span class="keywordflow">if</span> (!cur_agent) {
<a name="l02410"></a>02410          <a class="code" href="astdb_8h.html#a71e8d5ab1757b184683a99125d1c8160" title="Delete entry in astdb.">ast_db_del</a>(pa_family, agent_num);
<a name="l02411"></a>02411          <span class="keywordflow">continue</span>;
<a name="l02412"></a>02412       } <span class="keywordflow">else</span>
<a name="l02413"></a>02413          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;cur_agent-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02414"></a>02414       <span class="keywordflow">if</span> (!<a class="code" href="astdb_8h.html#a48033762bf6ab77f15dd72277a1fe7fa" title="Get key value specified by family/key.">ast_db_get</a>(pa_family, agent_num, agent_data, <span class="keyword">sizeof</span>(agent_data)-1)) {
<a name="l02415"></a>02415          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Reload Agent from AstDB: %s on %s\n&quot;</span>, cur_agent-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, agent_data);
<a name="l02416"></a>02416          parse = agent_data;
<a name="l02417"></a>02417          agent_chan = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;parse, <span class="stringliteral">&quot;;&quot;</span>);
<a name="l02418"></a>02418          agent_callerid = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;parse, <span class="stringliteral">&quot;;&quot;</span>);
<a name="l02419"></a>02419          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cur_agent-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, agent_chan, <span class="keyword">sizeof</span>(cur_agent-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>));
<a name="l02420"></a>02420          <span class="keywordflow">if</span> (agent_callerid) {
<a name="l02421"></a>02421             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cur_agent-&gt;<a class="code" href="structagent__pvt.html#a1d0896f3c265b2304808016f90742479">logincallerid</a>, agent_callerid, <span class="keyword">sizeof</span>(cur_agent-&gt;<a class="code" href="structagent__pvt.html#a1d0896f3c265b2304808016f90742479">logincallerid</a>));
<a name="l02422"></a>02422             <a class="code" href="chan__agent_8c.html#a2b0c86613090f2a5ff7c16eaca4601d5" title="store/clear the global variable that stores agentid based on the callerid">set_agentbycallerid</a>(cur_agent-&gt;<a class="code" href="structagent__pvt.html#a1d0896f3c265b2304808016f90742479">logincallerid</a>, cur_agent-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>);
<a name="l02423"></a>02423          } <span class="keywordflow">else</span>
<a name="l02424"></a>02424             cur_agent-&gt;<a class="code" href="structagent__pvt.html#a1d0896f3c265b2304808016f90742479">logincallerid</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02425"></a>02425          <span class="keywordflow">if</span> (cur_agent-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a> == 0)
<a name="l02426"></a>02426             time(&amp;cur_agent-&gt;<a class="code" href="structagent__pvt.html#aeee2cbe8bbdb4798c0585b5ea6688213">loginstart</a>);
<a name="l02427"></a>02427          <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>, <span class="stringliteral">&quot;Agent/%s&quot;</span>, cur_agent-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>); 
<a name="l02428"></a>02428       }
<a name="l02429"></a>02429    }
<a name="l02430"></a>02430    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l02431"></a>02431    <span class="keywordflow">if</span> (db_tree) {
<a name="l02432"></a>02432       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Agents successfully reloaded from database.\n&quot;</span>);
<a name="l02433"></a>02433       <a class="code" href="astdb_8h.html#af9ab454a70a91551b2bf6c55199fc514" title="Free in-memory data.">ast_db_freetree</a>(db_tree);
<a name="l02434"></a>02434    }
<a name="l02435"></a>02435 }
<a name="l02436"></a>02436 <span class="comment"></span>
<a name="l02437"></a>02437 <span class="comment">/*! \brief Part of PBX channel interface */</span>
<a name="l02438"></a><a class="code" href="chan__agent_8c.html#a4e38cdd1eb6523a328b26d25b5e3eedc">02438</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a4e38cdd1eb6523a328b26d25b5e3eedc" title="Part of PBX channel interface.">agent_devicestate</a>(<span class="keywordtype">void</span> *data)
<a name="l02439"></a>02439 {
<a name="l02440"></a>02440    <span class="keyword">struct </span>agent_pvt *p;
<a name="l02441"></a>02441    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l02442"></a>02442    <a class="code" href="channel_8h.html#a641d81d0c5c8df99d43eff69aede3bfd">ast_group_t</a> groupmatch;
<a name="l02443"></a>02443    <span class="keywordtype">int</span> groupoff;
<a name="l02444"></a>02444    <span class="keywordtype">int</span> res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>;
<a name="l02445"></a>02445    
<a name="l02446"></a>02446    s = data;
<a name="l02447"></a>02447    <span class="keywordflow">if</span> ((s[0] == <span class="charliteral">&apos;@&apos;</span>) &amp;&amp; (sscanf(s + 1, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;groupoff) == 1))
<a name="l02448"></a>02448       groupmatch = (1 &lt;&lt; groupoff);
<a name="l02449"></a>02449    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((s[0] == <span class="charliteral">&apos;:&apos;</span>) &amp;&amp; (sscanf(s + 1, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;groupoff) == 1)) {
<a name="l02450"></a>02450       groupmatch = (1 &lt;&lt; groupoff);
<a name="l02451"></a>02451    } <span class="keywordflow">else</span> 
<a name="l02452"></a>02452       groupmatch = 0;
<a name="l02453"></a>02453 
<a name="l02454"></a>02454    <span class="comment">/* Check actual logged in agents first */</span>
<a name="l02455"></a>02455    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l02456"></a>02456    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, p, list) {
<a name="l02457"></a>02457       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02458"></a>02458       <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structagent__pvt.html#a79ec26d453dcd29aec17f5536233e849">pending</a> &amp;&amp; ((groupmatch &amp;&amp; (p-&gt;<a class="code" href="structagent__pvt.html#a2f66424184fe1873f7b46b19de589b57">group</a> &amp; groupmatch)) || !strcmp(data, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>))) {
<a name="l02459"></a>02459          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l02460"></a>02460             <span class="keywordflow">if</span> (res != <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>)
<a name="l02461"></a>02461                res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeab43afabf5bcd4ad1f531ad78c48ccb6f">AST_DEVICE_BUSY</a>;
<a name="l02462"></a>02462          } <span class="keywordflow">else</span> {
<a name="l02463"></a>02463             <span class="keywordflow">if</span> (res == <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeab43afabf5bcd4ad1f531ad78c48ccb6f">AST_DEVICE_BUSY</a>)
<a name="l02464"></a>02464                res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>;
<a name="l02465"></a>02465             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> || !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>)) {
<a name="l02466"></a>02466                <span class="keywordflow">if</span> (res == <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>)
<a name="l02467"></a>02467                   res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>;
<a name="l02468"></a>02468             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>)  
<a name="l02469"></a>02469                res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>;
<a name="l02470"></a>02470          }
<a name="l02471"></a>02471          <span class="keywordflow">if</span> (!strcmp(data, p-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>)) {
<a name="l02472"></a>02472             <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02473"></a>02473             <span class="keywordflow">break</span>;
<a name="l02474"></a>02474          }
<a name="l02475"></a>02475       }
<a name="l02476"></a>02476       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;p-&gt;<a class="code" href="structagent__pvt.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l02477"></a>02477    }
<a name="l02478"></a>02478    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l02479"></a>02479    <span class="keywordflow">return</span> res;
<a name="l02480"></a>02480 }
<a name="l02481"></a>02481 <span class="comment"></span>
<a name="l02482"></a>02482 <span class="comment">/*!</span>
<a name="l02483"></a>02483 <span class="comment"> * \note This function expects the agent list to be locked</span>
<a name="l02484"></a>02484 <span class="comment"> */</span>
<a name="l02485"></a><a class="code" href="chan__agent_8c.html#a72432ad77d031aeb510ca4f5df659f4d">02485</a> <span class="keyword">static</span> <span class="keyword">struct </span>agent_pvt *<a class="code" href="chan__agent_8c.html#a72432ad77d031aeb510ca4f5df659f4d">find_agent</a>(<span class="keywordtype">char</span> *agentid)
<a name="l02486"></a>02486 {
<a name="l02487"></a>02487    <span class="keyword">struct </span>agent_pvt *cur;
<a name="l02488"></a>02488 
<a name="l02489"></a>02489    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;agents, cur, list) {
<a name="l02490"></a>02490       <span class="keywordflow">if</span> (!strcmp(cur-&gt;<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>, agentid))
<a name="l02491"></a>02491          <span class="keywordflow">break</span>;   
<a name="l02492"></a>02492    }
<a name="l02493"></a>02493 
<a name="l02494"></a>02494    <span class="keywordflow">return</span> cur; 
<a name="l02495"></a>02495 }
<a name="l02496"></a>02496 
<a name="l02497"></a><a class="code" href="chan__agent_8c.html#a652d768e2578ca1e181e5efb1a80d446">02497</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#a652d768e2578ca1e181e5efb1a80d446">function_agent</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l02498"></a>02498 {
<a name="l02499"></a>02499    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;    
<a name="l02500"></a>02500    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l02501"></a>02501       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(agentid);
<a name="l02502"></a>02502       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(item);
<a name="l02503"></a>02503    );
<a name="l02504"></a>02504    <span class="keywordtype">char</span> *tmp;
<a name="l02505"></a>02505    <span class="keyword">struct </span>agent_pvt *<a class="code" href="structagent__pvt.html#a5717d834922e2b42f6ba6b73817073b4">agent</a>;
<a name="l02506"></a>02506 
<a name="l02507"></a>02507    buf[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02508"></a>02508 
<a name="l02509"></a>02509    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l02510"></a>02510       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;The AGENT function requires an argument - agentid!\n&quot;</span>);
<a name="l02511"></a>02511       <span class="keywordflow">return</span> -1;
<a name="l02512"></a>02512    }
<a name="l02513"></a>02513 
<a name="l02514"></a>02514    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l02515"></a>02515 
<a name="l02516"></a>02516    <a class="code" href="app_8h.html#accfcb380df76a64251d88ef49c2dd4e3" title="Performs the &amp;#39;nonstandard&amp;#39; argument separation process for an application...">AST_NONSTANDARD_APP_ARGS</a>(args, parse, <span class="charliteral">&apos;:&apos;</span>);
<a name="l02517"></a>02517    <span class="keywordflow">if</span> (!args.item)
<a name="l02518"></a>02518       args.item = <span class="stringliteral">&quot;status&quot;</span>;
<a name="l02519"></a>02519 
<a name="l02520"></a>02520    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l02521"></a>02521 
<a name="l02522"></a>02522    <span class="keywordflow">if</span> (!(agent = <a class="code" href="chan__agent_8c.html#a72432ad77d031aeb510ca4f5df659f4d">find_agent</a>(args.agentid))) {
<a name="l02523"></a>02523       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l02524"></a>02524       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Agent &apos;%s&apos; not found!\n&quot;</span>, args.agentid);
<a name="l02525"></a>02525       <span class="keywordflow">return</span> -1;
<a name="l02526"></a>02526    }
<a name="l02527"></a>02527 
<a name="l02528"></a>02528    <span class="keywordflow">if</span> (!strcasecmp(args.item, <span class="stringliteral">&quot;status&quot;</span>)) {
<a name="l02529"></a>02529       <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = <span class="stringliteral">&quot;LOGGEDOUT&quot;</span>;
<a name="l02530"></a>02530       <span class="keywordflow">if</span> (agent-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a> || !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(agent-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>)) 
<a name="l02531"></a>02531          status = <span class="stringliteral">&quot;LOGGEDIN&quot;</span>; 
<a name="l02532"></a>02532       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, status, len);
<a name="l02533"></a>02533    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(args.item, <span class="stringliteral">&quot;password&quot;</span>)) 
<a name="l02534"></a>02534       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, agent-&gt;<a class="code" href="structagent__pvt.html#a89ef5ad192d222ee54b1e0c4edf45cb6">password</a>, len);
<a name="l02535"></a>02535    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(args.item, <span class="stringliteral">&quot;name&quot;</span>))
<a name="l02536"></a>02536       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, agent-&gt;<a class="code" href="structagent__pvt.html#a121837a04d888b50bfa5fe1619b853a2">name</a>, len);
<a name="l02537"></a>02537    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(args.item, <span class="stringliteral">&quot;mohclass&quot;</span>))
<a name="l02538"></a>02538       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, agent-&gt;<a class="code" href="structagent__pvt.html#a0f66f061490edf209d9ff6e2f18be109">moh</a>, len);
<a name="l02539"></a>02539    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(args.item, <span class="stringliteral">&quot;channel&quot;</span>)) {
<a name="l02540"></a>02540       <span class="keywordflow">if</span> (agent-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l02541"></a>02541          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, agent-&gt;<a class="code" href="structagent__pvt.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, len);
<a name="l02542"></a>02542          tmp = strrchr(buf, <span class="charliteral">&apos;-&apos;</span>);
<a name="l02543"></a>02543          <span class="keywordflow">if</span> (tmp)
<a name="l02544"></a>02544             *tmp = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02545"></a>02545       } 
<a name="l02546"></a>02546    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(args.item, <span class="stringliteral">&quot;exten&quot;</span>))
<a name="l02547"></a>02547       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, agent-&gt;<a class="code" href="structagent__pvt.html#ab8c125f04c4cbc3cb30078b7cf10ebf1">loginchan</a>, len); 
<a name="l02548"></a>02548 
<a name="l02549"></a>02549    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l02550"></a>02550 
<a name="l02551"></a>02551    <span class="keywordflow">return</span> 0;
<a name="l02552"></a>02552 }
<a name="l02553"></a>02553 
<a name="l02554"></a><a class="code" href="chan__agent_8c.html#a1ef7f429bd53528befc06ac4d0f5ff3b">02554</a> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="chan__agent_8c.html#a1ef7f429bd53528befc06ac4d0f5ff3b">agent_function</a> = {
<a name="l02555"></a>02555    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;AGENT&quot;</span>,
<a name="l02556"></a>02556    .read = <a class="code" href="chan__agent_8c.html#a652d768e2578ca1e181e5efb1a80d446">function_agent</a>,
<a name="l02557"></a>02557 };
<a name="l02558"></a>02558 
<a name="l02559"></a>02559 <span class="comment"></span>
<a name="l02560"></a>02560 <span class="comment">/*!</span>
<a name="l02561"></a>02561 <span class="comment"> * \brief Initialize the Agents module.</span>
<a name="l02562"></a>02562 <span class="comment"> * This function is being called by Asterisk when loading the module. </span>
<a name="l02563"></a>02563 <span class="comment"> * Among other things it registers applications, cli commands and reads the cofiguration file.</span>
<a name="l02564"></a>02564 <span class="comment"> *</span>
<a name="l02565"></a>02565 <span class="comment"> * \returns int Always 0.</span>
<a name="l02566"></a>02566 <span class="comment"> */</span>
<a name="l02567"></a><a class="code" href="chan__agent_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">02567</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9" title="Initialize the Agents module. This function is being called by Asterisk when loading...">load_module</a>(<span class="keywordtype">void</span>)
<a name="l02568"></a>02568 {
<a name="l02569"></a>02569    <span class="comment">/* Make sure we can register our agent channel type */</span>
<a name="l02570"></a>02570    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#ab5f3776fda943e52820ceeee5835c1b4" title="Register a channel technology (a new channel driver) Called by a channel module to...">ast_channel_register</a>(&amp;<a class="code" href="chan__agent_8c.html#a7495473ec0e365de7c32942518358dea" title="Channel interface description for PBX integration.">agent_tech</a>)) {
<a name="l02571"></a>02571       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to register channel class &apos;Agent&apos;\n&quot;</span>);
<a name="l02572"></a>02572       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l02573"></a>02573    }
<a name="l02574"></a>02574    <span class="comment">/* Read in the config */</span>
<a name="l02575"></a>02575    <span class="keywordflow">if</span> (!<a class="code" href="chan__agent_8c.html#a8ffba0f0e19fa437517d8c13950f1068">read_agent_config</a>(0))
<a name="l02576"></a>02576       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l02577"></a>02577    <span class="keywordflow">if</span> (persistent_agents)
<a name="l02578"></a>02578       <a class="code" href="chan__agent_8c.html#a0c4367b9eb8fa5092e7d82985a4f9cc9" title="Reload the persistent agents from astdb.">reload_agents</a>();
<a name="l02579"></a>02579    <span class="comment">/* Dialplan applications */</span>
<a name="l02580"></a>02580    <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app, <a class="code" href="chan__agent_8c.html#a03b3d0db1411e70375d8455667aa8c35" title="Log in agent application.">login_exec</a>);
<a name="l02581"></a>02581    <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app3, <a class="code" href="chan__agent_8c.html#a808632dd1338e3c338c95194939964ff" title="Called by the AgentMonitorOutgoing application (from the dial plan).">agentmonitoroutgoing_exec</a>);
<a name="l02582"></a>02582 
<a name="l02583"></a>02583    <span class="comment">/* Manager commands */</span>
<a name="l02584"></a>02584    <a class="code" href="group__Group__AMI.html#ga332bf7ef48f67d63d849dd9febb18fb2" title="Register a manager command with the manager interface.">ast_manager_register2</a>(<span class="stringliteral">&quot;Agents&quot;</span>, <a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <a class="code" href="chan__agent_8c.html#a0c9069d554e6ace86b060a06c56d2ba3">action_agents</a>, <span class="stringliteral">&quot;Lists agents and their status&quot;</span>, mandescr_agents);
<a name="l02585"></a>02585    <a class="code" href="group__Group__AMI.html#ga332bf7ef48f67d63d849dd9febb18fb2" title="Register a manager command with the manager interface.">ast_manager_register2</a>(<span class="stringliteral">&quot;AgentLogoff&quot;</span>, <a class="code" href="manager_8h.html#acd32bc0b58b87cc22c60ffff79496c7f">EVENT_FLAG_AGENT</a>, <a class="code" href="chan__agent_8c.html#a6558aa820bc9dd1eebac76ee2e2951f0">action_agent_logoff</a>, <span class="stringliteral">&quot;Sets an agent as no longer logged in&quot;</span>, mandescr_agent_logoff);
<a name="l02586"></a>02586 
<a name="l02587"></a>02587    <span class="comment">/* CLI Commands */</span>
<a name="l02588"></a>02588    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="chan__agent_8c.html#a86ce161e89fb61c8534e1eca1cdcf618">cli_agents</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="chan__agent_8c.html#a86ce161e89fb61c8534e1eca1cdcf618">cli_agents</a>));
<a name="l02589"></a>02589 
<a name="l02590"></a>02590    <span class="comment">/* Dialplan Functions */</span>
<a name="l02591"></a>02591    <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;<a class="code" href="chan__agent_8c.html#a1ef7f429bd53528befc06ac4d0f5ff3b">agent_function</a>);
<a name="l02592"></a>02592 
<a name="l02593"></a>02593    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l02594"></a>02594 }
<a name="l02595"></a>02595 
<a name="l02596"></a><a class="code" href="chan__agent_8c.html#ad1982509765f4870f1f63412a53ea668">02596</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>)
<a name="l02597"></a>02597 {
<a name="l02598"></a>02598    <span class="keywordflow">if</span> (!<a class="code" href="chan__agent_8c.html#a8ffba0f0e19fa437517d8c13950f1068">read_agent_config</a>(1)) {
<a name="l02599"></a>02599       <span class="keywordflow">if</span> (persistent_agents)
<a name="l02600"></a>02600          <a class="code" href="chan__agent_8c.html#a0c4367b9eb8fa5092e7d82985a4f9cc9" title="Reload the persistent agents from astdb.">reload_agents</a>();
<a name="l02601"></a>02601    }
<a name="l02602"></a>02602    <span class="keywordflow">return</span> 0;
<a name="l02603"></a>02603 }
<a name="l02604"></a>02604 
<a name="l02605"></a><a class="code" href="chan__agent_8c.html#ad09fa931f468002152a3cc2d5ce25eae">02605</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l02606"></a>02606 {
<a name="l02607"></a>02607    <span class="keyword">struct </span>agent_pvt *p;
<a name="l02608"></a>02608    <span class="comment">/* First, take us out of the channel loop */</span>
<a name="l02609"></a>02609    <a class="code" href="channel_8h.html#a53b708b7fc71dcbcd33acae0ad4d7ef8" title="Unregister a channel technology.">ast_channel_unregister</a>(&amp;<a class="code" href="chan__agent_8c.html#a7495473ec0e365de7c32942518358dea" title="Channel interface description for PBX integration.">agent_tech</a>);
<a name="l02610"></a>02610    <span class="comment">/* Unregister dialplan functions */</span>
<a name="l02611"></a>02611    <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;<a class="code" href="chan__agent_8c.html#a1ef7f429bd53528befc06ac4d0f5ff3b">agent_function</a>);   
<a name="l02612"></a>02612    <span class="comment">/* Unregister CLI commands */</span>
<a name="l02613"></a>02613    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(<a class="code" href="chan__agent_8c.html#a86ce161e89fb61c8534e1eca1cdcf618">cli_agents</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="chan__agent_8c.html#a86ce161e89fb61c8534e1eca1cdcf618">cli_agents</a>));
<a name="l02614"></a>02614    <span class="comment">/* Unregister dialplan applications */</span>
<a name="l02615"></a>02615    <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app);
<a name="l02616"></a>02616    <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app3);
<a name="l02617"></a>02617    <span class="comment">/* Unregister manager command */</span>
<a name="l02618"></a>02618    <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;Agents&quot;</span>);
<a name="l02619"></a>02619    <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;AgentLogoff&quot;</span>);
<a name="l02620"></a>02620    <span class="comment">/* Unregister channel */</span>
<a name="l02621"></a>02621    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;agents);
<a name="l02622"></a>02622    <span class="comment">/* Hangup all interfaces if they have an owner */</span>
<a name="l02623"></a>02623    <span class="keywordflow">while</span> ((p = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;agents, list))) {
<a name="l02624"></a>02624       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)
<a name="l02625"></a>02625          <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(p-&gt;<a class="code" href="structagent__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709aeeafae6abd77156800ec76b0ff7d3867">AST_SOFTHANGUP_APPUNLOAD</a>);
<a name="l02626"></a>02626       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(p);
<a name="l02627"></a>02627    }
<a name="l02628"></a>02628    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;agents);
<a name="l02629"></a>02629    <span class="keywordflow">return</span> 0;
<a name="l02630"></a>02630 }
<a name="l02631"></a>02631 
<a name="l02632"></a>02632 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <span class="stringliteral">&quot;Agent Proxy Channel&quot;</span>,
<a name="l02633"></a>02633       .load = <a class="code" href="chan__agent_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9" title="Initialize the Agents module. This function is being called by Asterisk when loading...">load_module</a>,
<a name="l02634"></a>02634       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l02635"></a>02635       .<a class="code" href="chan__agent_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> = <a class="code" href="chan__agent_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>,
<a name="l02636"></a>02636           );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:30 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
