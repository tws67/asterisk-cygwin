<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:23:10 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_318a70d4e812a718d9ecaeea98fff199.html">res</a>
  </div>
</div>
<div class="contents">
<h1>res_config_pgsql.c File Reference</h1>
<p>PostgreSQL plugin for Asterisk RealTime Architecture.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &lt;libpq-fe.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="file_8h_source.html">asterisk/file.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="channel_8h_source.html">asterisk/channel.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pbx_8h_source.html">asterisk/pbx.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="config_8h_source.html">asterisk/config.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="module_8h_source.html">asterisk/module.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="lock_8h_source.html">asterisk/lock.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cli_8h_source.html">asterisk/cli.h</a>&quot;</code><br/>

<p><a href="res__config__pgsql_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structcolumns.html">columns</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structtables_1_1psql__columns.html">psql_columns</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structpsql__tables.html">psql_tables</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structtables.html">tables</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(buffer, stringname)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a906e665d74012c49cc132dcdfdf64ad4">has_schema_support</a>&nbsp;&nbsp;&nbsp;(<a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> &gt; 70300 ? 1 : 0)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ae1ffcaf1dfe6cddb6203f16092afcfbe">MAX_DB_OPTION_SIZE</a>&nbsp;&nbsp;&nbsp;64</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(<a class="el" href="cdr__sqlite3__custom_8c.html#aa334abe35e252ebf7a2c7c29572bc60f">table</a>)&nbsp;&nbsp;&nbsp;ast_rwlock_unlock(&amp;(<a class="el" href="cdr__sqlite3__custom_8c.html#aa334abe35e252ebf7a2c7c29572bc60f">table</a>)-&gt;<a class="el" href="res__timing__pthread_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a8e1434e7d1f44ef3694d535f7bc39863">RES_CONFIG_PGSQL_CONF</a>&nbsp;&nbsp;&nbsp;&quot;res_pgsql.conf&quot;</td></tr>
<tr><td colspan="2"><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom">{ <a class="el" href="res__config__pgsql_8c.html#a5ff73139485369f629981d087e744c90ae34342905ba5c4d85039c4ed6270d924">RQ_WARN</a>, 
<a class="el" href="res__config__pgsql_8c.html#a5ff73139485369f629981d087e744c90ae58872dc5a003cbc6e19ac835e34c44a">RQ_CREATECLOSE</a>, 
<a class="el" href="res__config__pgsql_8c.html#a5ff73139485369f629981d087e744c90a4d8c7cc7c92af38dbeae94777bcd612f">RQ_CREATECHAR</a>
 }</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a7176fc5d7b0c76a836b5cea3ebd602ae">__init_escapebuf_buf</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ad54f579cfd3553c909c4ed082e5e5589">__init_findtable_buf</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a2ff160eb8cc768ef928c90bb61ded670">__init_sql_buf</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ae4f1f17b984a00ca0d3e210095ca5f2f">__init_where_buf</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a88b7c88fed6b80fd18f34f97757dfc04">__reg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#afeab1257bd17282b95875499393a147a">__unreg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__config.html">ast_config</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ab76e97dce7918722bf7ca4698308bed3">config_pgsql</a> (const char *database, const char *<a class="el" href="cdr__sqlite3__custom_8c.html#aa334abe35e252ebf7a2c7c29572bc60f">table</a>, const char *file, struct <a class="el" href="structast__config.html">ast_config</a> *cfg, struct <a class="el" href="structast__flags.html">ast_flags</a> flags, const char *suggested_incl, const char *who_asked)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a6024fe770f95cf135838424041e785d1">destroy_pgsql</a> (const char *database, const char *<a class="el" href="cdr__sqlite3__custom_8c.html#aa334abe35e252ebf7a2c7c29572bc60f">table</a>, const char *keyfield, const char *lookup, va_list ap)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a40989424551303763ab1bae2aa13ba11">destroy_table</a> (struct <a class="el" href="structtables.html">tables</a> *<a class="el" href="cdr__sqlite3__custom_8c.html#aa334abe35e252ebf7a2c7c29572bc60f">table</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structcolumns.html">columns</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a185e8c10da20a980396fb08bd4dd82b5">find_column</a> (struct <a class="el" href="structtables.html">tables</a> *t, const char *colname)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structtables.html">tables</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#aaeb0f59e00eee1f4c11c427865821127">find_table</a> (const char *orig_tablename)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ad4b5e121aaba3306fc6a19abacff9a5c">handle_cli_realtime_pgsql_cache</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a8b98835879e51580aabf8a411acf6f14">handle_cli_realtime_pgsql_status</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a0dc068d63cb9df28d4b885bb7b5c5560">parse_config</a> (int reload)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ac2ee0af8a28eebbaf6d50a2ba63bd9a6">pgsql_reconnect</a> (const char *database)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__config.html">ast_config</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ac271d44246a40ff4832e57492fd58f75">realtime_multi_pgsql</a> (const char *database, const char *<a class="el" href="cdr__sqlite3__custom_8c.html#aa334abe35e252ebf7a2c7c29572bc60f">table</a>, va_list ap)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a02d5b855c8351705b09cc2bb1da50d20">realtime_pgsql</a> (const char *database, const char *tablename, va_list ap)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ac969b3fee6a0925f75d328ab19b9bd53">require_pgsql</a> (const char *database, const char *tablename, va_list ap)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a498a3d904d1397b60d0e80b8534c6bc1">store_pgsql</a> (const char *database, const char *<a class="el" href="cdr__sqlite3__custom_8c.html#aa334abe35e252ebf7a2c7c29572bc60f">table</a>, va_list ap)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a8573a2981afd4073c00dc0431531384c">unload_pgsql</a> (const char *database, const char *tablename)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#aef3fb618b0ca215f06b24be4197e7245">update2_pgsql</a> (const char *database, const char *tablename, va_list ap)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#aa6d2878b1b310c1666b662231d3a25ad">update_pgsql</a> (const char *database, const char *tablename, const char *keyfield, const char *lookup, va_list ap)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_GLOBAL_SYMBOLS , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;PostgreSQL RealTime Configuration Driver&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, .reload = reload }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ae25b9f3970870610911f8850897e8ead">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a5978a10899c3c5e1db25f2eb882180ce">cli_realtime</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static time_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ac4ae24c7b766713b82921c04d1a4b699">connect_time</a> = 0</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a> [MAX_DB_OPTION_SIZE] = &quot;&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a6904a1f9115898f7691f4e8a405b8b98">dbname</a> [MAX_DB_OPTION_SIZE] = &quot;&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a6c0213e458980748dc52ffc409668ada">dbpass</a> [MAX_DB_OPTION_SIZE] = &quot;&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ad76d37dfe4b000f0e1113be85bf2c41f">dbport</a> = 5432</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ac4ba6066077517f4c70aa20a44d61e8d">dbsock</a> [MAX_DB_OPTION_SIZE] = &quot;&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a1db90a8699d1255793e9d9accfe04e3c">dbuser</a> [MAX_DB_OPTION_SIZE] = &quot;&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__threadstorage.html">ast_threadstorage</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a5276aefbf1d003abafa0b7c7ff5449b9">escapebuf_buf</a> = { .once = PTHREAD_ONCE_INIT , .key_init = __init_escapebuf_buf , .custom_init = NULL , }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__threadstorage.html">ast_threadstorage</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#ad10b165b24bb77fd0137e9f7a26d83aa">findtable_buf</a> = { .once = PTHREAD_ONCE_INIT , .key_init = __init_findtable_buf , .custom_init = NULL , }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__config__engine.html">ast_config_engine</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a981435c3dda0517ead4c0fb9080fb9e8">pgsql_engine</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static <a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a> = ((<a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>) PTHREAD_MUTEX_INITIALIZER )</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">PGconn *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> = NULL</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum  { ... } &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a7e2f1debddb2f7bbdddc82ef5aeb0332">requirements</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__threadstorage.html">ast_threadstorage</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#afc4bfa5a94710e6f323a1033f82425b3">sql_buf</a> = { .once = PTHREAD_ONCE_INIT , .key_init = __init_sql_buf , .custom_init = NULL , }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__threadstorage.html">ast_threadstorage</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__config__pgsql_8c.html#a2b636f309367e4fa49ffb2c0a55e5bdd">where_buf</a> = { .once = PTHREAD_ONCE_INIT , .key_init = __init_where_buf , .custom_init = NULL , }</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>PostgreSQL plugin for Asterisk RealTime Architecture. </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Mark Spencer &lt;<a href="mailto:markster@digium.com">markster@digium.com</a>&gt; </dd>
<dd>
Manuel Guesdon &lt;<a href="mailto:mguesdon@oxymium.net">mguesdon@oxymium.net</a>&gt; - PostgreSQL RealTime Driver Author/Adaptor</dd></dl>
<ul>
<li><a href="http://www.postgresql.org">http://www.postgresql.org</a> </li>
</ul>

<p>Definition in file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="aa2c6ce9cd5b94e99551c6f59425eddc1"></a><!-- doxytag: member="res_config_pgsql.c::ESCAPE_STRING" ref="aa2c6ce9cd5b94e99551c6f59425eddc1" args="(buffer, stringname)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ESCAPE_STRING</td>
          <td>(</td>
          <td class="paramtype">buffer, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">stringname&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00096">96</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l00938">destroy_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00418">realtime_multi_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00283">realtime_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00846">store_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00714">update2_pgsql()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00576">update_pgsql()</a>.</p>

</div>
</div>
<a class="anchor" id="a906e665d74012c49cc132dcdfdf64ad4"></a><!-- doxytag: member="res_config_pgsql.c::has_schema_support" ref="a906e665d74012c49cc132dcdfdf64ad4" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define has_schema_support&nbsp;&nbsp;&nbsp;(<a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> &gt; 70300 ? 1 : 0)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00054">54</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l00117">find_table()</a>.</p>

</div>
</div>
<a class="anchor" id="ae1ffcaf1dfe6cddb6203f16092afcfbe"></a><!-- doxytag: member="res_config_pgsql.c::MAX_DB_OPTION_SIZE" ref="ae1ffcaf1dfe6cddb6203f16092afcfbe" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_DB_OPTION_SIZE&nbsp;&nbsp;&nbsp;64</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00056">56</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

</div>
</div>
<a class="anchor" id="a82afbdbc2221a2a7323b0b40c6b99879"></a><!-- doxytag: member="res_config_pgsql.c::release_table" ref="a82afbdbc2221a2a7323b0b40c6b99879" args="(table)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define release_table</td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="cdr__sqlite3__custom_8c.html#aa334abe35e252ebf7a2c7c29572bc60f">table</a>&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td>&nbsp;&nbsp;&nbsp;ast_rwlock_unlock(&amp;(<a class="el" href="cdr__sqlite3__custom_8c.html#aa334abe35e252ebf7a2c7c29572bc60f">table</a>)-&gt;<a class="el" href="res__timing__pthread_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00268">268</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__sqlite_8c_source.html#l00785">cdr_handler()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01484">handle_cli_realtime_pgsql_cache()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01125">require_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00714">update2_pgsql()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00576">update_pgsql()</a>.</p>

</div>
</div>
<a class="anchor" id="a8e1434e7d1f44ef3694d535f7bc39863"></a><!-- doxytag: member="res_config_pgsql.c::RES_CONFIG_PGSQL_CONF" ref="a8e1434e7d1f44ef3694d535f7bc39863" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RES_CONFIG_PGSQL_CONF&nbsp;&nbsp;&nbsp;&quot;res_pgsql.conf&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00050">50</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01030">config_pgsql()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l01327">parse_config()</a>.</p>

</div>
</div>
<hr/><h2>Enumeration Type Documentation</h2>
<a class="anchor" id="a5ff73139485369f629981d087e744c90"></a><!-- doxytag: member="res_config_pgsql.c::@239" ref="a5ff73139485369f629981d087e744c90" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="a5ff73139485369f629981d087e744c90ae34342905ba5c4d85039c4ed6270d924"></a><!-- doxytag: member="RQ_WARN" ref="a5ff73139485369f629981d087e744c90ae34342905ba5c4d85039c4ed6270d924" args="" -->RQ_WARN</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="a5ff73139485369f629981d087e744c90ae58872dc5a003cbc6e19ac835e34c44a"></a><!-- doxytag: member="RQ_CREATECLOSE" ref="a5ff73139485369f629981d087e744c90ae58872dc5a003cbc6e19ac835e34c44a" args="" -->RQ_CREATECLOSE</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="a5ff73139485369f629981d087e744c90a4d8c7cc7c92af38dbeae94777bcd612f"></a><!-- doxytag: member="RQ_CREATECHAR" ref="a5ff73139485369f629981d087e744c90a4d8c7cc7c92af38dbeae94777bcd612f" args="" -->RQ_CREATECHAR</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00089">89</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00089"></a>00089 { <a class="code" href="res__config__pgsql_8c.html#a5ff73139485369f629981d087e744c90ae34342905ba5c4d85039c4ed6270d924">RQ_WARN</a>, <a class="code" href="res__config__pgsql_8c.html#a5ff73139485369f629981d087e744c90ae58872dc5a003cbc6e19ac835e34c44a">RQ_CREATECLOSE</a>, <a class="code" href="res__config__pgsql_8c.html#a5ff73139485369f629981d087e744c90a4d8c7cc7c92af38dbeae94777bcd612f">RQ_CREATECHAR</a> } <a class="code" href="res__config__pgsql_8c.html#a7e2f1debddb2f7bbdddc82ef5aeb0332">requirements</a>;
</pre></div></p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a7176fc5d7b0c76a836b5cea3ebd602ae"></a><!-- doxytag: member="res_config_pgsql.c::__init_escapebuf_buf" ref="a7176fc5d7b0c76a836b5cea3ebd602ae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __init_escapebuf_buf </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00048">48</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00054"></a>00054 : 0)
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad54f579cfd3553c909c4ed082e5e5589"></a><!-- doxytag: member="res_config_pgsql.c::__init_findtable_buf" ref="ad54f579cfd3553c909c4ed082e5e5589" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __init_findtable_buf </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00046">46</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00054"></a>00054 : 0)
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2ff160eb8cc768ef928c90bb61ded670"></a><!-- doxytag: member="res_config_pgsql.c::__init_sql_buf" ref="a2ff160eb8cc768ef928c90bb61ded670" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __init_sql_buf </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00045">45</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00054"></a>00054 : 0)
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae4f1f17b984a00ca0d3e210095ca5f2f"></a><!-- doxytag: member="res_config_pgsql.c::__init_where_buf" ref="ae4f1f17b984a00ca0d3e210095ca5f2f" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __init_where_buf </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00047">47</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00054"></a>00054 : 0)
</pre></div></p>

</div>
</div>
<a class="anchor" id="a88b7c88fed6b80fd18f34f97757dfc04"></a><!-- doxytag: member="res_config_pgsql.c::__reg_module" ref="a88b7c88fed6b80fd18f34f97757dfc04" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __reg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01596">1596</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

</div>
</div>
<a class="anchor" id="afeab1257bd17282b95875499393a147a"></a><!-- doxytag: member="res_config_pgsql.c::__unreg_module" ref="afeab1257bd17282b95875499393a147a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __unreg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01596">1596</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab76e97dce7918722bf7ca4698308bed3"></a><!-- doxytag: member="res_config_pgsql.c::config_pgsql" ref="ab76e97dce7918722bf7ca4698308bed3" args="(const char *database, const char *table, const char *file, struct ast_config *cfg, struct ast_flags flags, const char *suggested_incl, const char *who_asked)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__config.html">ast_config</a>* config_pgsql </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>table</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__config.html">ast_config</a> *&nbsp;</td>
          <td class="paramname"> <em>cfg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__flags.html">ast_flags</a>&nbsp;</td>
          <td class="paramname"> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>suggested_incl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>who_asked</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01030">1030</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="config_8c_source.html#l00522">ast_category_append()</a>, <a class="el" href="config_8c_source.html#l00483">ast_category_new()</a>, <a class="el" href="config_8c_source.html#l02031">ast_config_internal_load()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="strings_8h_source.html#l00637">ast_str_thread_get()</a>, <a class="el" href="config_8c_source.html#l00348">ast_variable_append()</a>, <a class="el" href="config_8c_source.html#l00223">ast_variable_new()</a>, <a class="el" href="devicestate_8c_source.html#l00198">last</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00044">pgsql_lock</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00050">RES_CONFIG_PGSQL_CONF</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00045">sql_buf</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01033"></a>01033 {
<a name="l01034"></a>01034    PGresult *result = NULL;
<a name="l01035"></a>01035    <span class="keywordtype">long</span> num_rows;
<a name="l01036"></a>01036    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *new_v;
<a name="l01037"></a>01037    <span class="keyword">struct </span><a class="code" href="structast__category.html">ast_category</a> *cur_cat = NULL;
<a name="l01038"></a>01038    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sql = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#afc4bfa5a94710e6f323a1033f82425b3">sql_buf</a>, 100);
<a name="l01039"></a>01039    <span class="keywordtype">char</span> <a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a>[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01040"></a>01040    <span class="keywordtype">int</span> last_cat_metric = 0;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042    last[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01043"></a>01043 
<a name="l01044"></a>01044    <span class="keywordflow">if</span> (!file || !strcmp(file, <a class="code" href="res__config__pgsql_8c.html#a8e1434e7d1f44ef3694d535f7bc39863">RES_CONFIG_PGSQL_CONF</a>)) {
<a name="l01045"></a>01045       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;PostgreSQL RealTime: Cannot configure myself.\n&quot;</span>);
<a name="l01046"></a>01046       <span class="keywordflow">return</span> NULL;
<a name="l01047"></a>01047    }
<a name="l01048"></a>01048 
<a name="l01049"></a>01049    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql, 0, <span class="stringliteral">&quot;SELECT category, var_name, var_val, cat_metric FROM %s &quot;</span>
<a name="l01050"></a>01050          <span class="stringliteral">&quot;WHERE filename=&apos;%s&apos; and commented=0&quot;</span>
<a name="l01051"></a>01051          <span class="stringliteral">&quot;ORDER BY cat_metric DESC, var_metric ASC, category, var_name &quot;</span>, <a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, file);
<a name="l01052"></a>01052 
<a name="l01053"></a>01053    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Static SQL: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l01054"></a>01054 
<a name="l01055"></a>01055    <span class="comment">/* We now have our complete statement; Lets connect to the server and execute it. */</span>
<a name="l01056"></a>01056    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01057"></a>01057    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#ac2ee0af8a28eebbaf6d50a2ba63bd9a6">pgsql_reconnect</a>(database)) {
<a name="l01058"></a>01058       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01059"></a>01059       <span class="keywordflow">return</span> NULL;
<a name="l01060"></a>01060    }
<a name="l01061"></a>01061 
<a name="l01062"></a>01062    <span class="keywordflow">if</span> (!(result = PQexec(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql)))) {
<a name="l01063"></a>01063       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01064"></a>01064             <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query &apos;%s@%s&apos;. Check debug for more info.\n&quot;</span>, <a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, database);
<a name="l01065"></a>01065       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l01066"></a>01066       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s\n&quot;</span>, PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>));
<a name="l01067"></a>01067       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01068"></a>01068       <span class="keywordflow">return</span> NULL;
<a name="l01069"></a>01069    } <span class="keywordflow">else</span> {
<a name="l01070"></a>01070       ExecStatusType result_status = PQresultStatus(result);
<a name="l01071"></a>01071       <span class="keywordflow">if</span> (result_status != PGRES_COMMAND_OK
<a name="l01072"></a>01072          &amp;&amp; result_status != PGRES_TUPLES_OK
<a name="l01073"></a>01073          &amp;&amp; result_status != PGRES_NONFATAL_ERROR) {
<a name="l01074"></a>01074          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01075"></a>01075                <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query database. Check debug for more info.\n&quot;</span>);
<a name="l01076"></a>01076          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l01077"></a>01077          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s (%s)\n&quot;</span>,
<a name="l01078"></a>01078                   PQresultErrorMessage(result), PQresStatus(result_status));
<a name="l01079"></a>01079          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01080"></a>01080          <span class="keywordflow">return</span> NULL;
<a name="l01081"></a>01081       }
<a name="l01082"></a>01082    }
<a name="l01083"></a>01083 
<a name="l01084"></a>01084    <span class="keywordflow">if</span> ((num_rows = PQntuples(result)) &gt; 0) {
<a name="l01085"></a>01085       <span class="keywordtype">int</span> rowIndex = 0;
<a name="l01086"></a>01086 
<a name="l01087"></a>01087       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Found %ld rows.\n&quot;</span>, num_rows);
<a name="l01088"></a>01088 
<a name="l01089"></a>01089       <span class="keywordflow">for</span> (rowIndex = 0; rowIndex &lt; num_rows; rowIndex++) {
<a name="l01090"></a>01090          <span class="keywordtype">char</span> *field_category = PQgetvalue(result, rowIndex, 0);
<a name="l01091"></a>01091          <span class="keywordtype">char</span> *field_var_name = PQgetvalue(result, rowIndex, 1);
<a name="l01092"></a>01092          <span class="keywordtype">char</span> *field_var_val = PQgetvalue(result, rowIndex, 2);
<a name="l01093"></a>01093          <span class="keywordtype">char</span> *field_cat_metric = PQgetvalue(result, rowIndex, 3);
<a name="l01094"></a>01094          <span class="keywordflow">if</span> (!strcmp(field_var_name, <span class="stringliteral">&quot;#include&quot;</span>)) {
<a name="l01095"></a>01095             <span class="keywordflow">if</span> (!<a class="code" href="config_8h.html#a721d5cd60abda2bdd96838336dc09669">ast_config_internal_load</a>(field_var_val, cfg, flags, <span class="stringliteral">&quot;&quot;</span>, who_asked)) {
<a name="l01096"></a>01096                PQclear(result);
<a name="l01097"></a>01097                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01098"></a>01098                <span class="keywordflow">return</span> NULL;
<a name="l01099"></a>01099             }
<a name="l01100"></a>01100             <span class="keywordflow">continue</span>;
<a name="l01101"></a>01101          }
<a name="l01102"></a>01102 
<a name="l01103"></a>01103          <span class="keywordflow">if</span> (strcmp(last, field_category) || last_cat_metric != atoi(field_cat_metric)) {
<a name="l01104"></a>01104             cur_cat = <a class="code" href="config_8h.html#affebac76d69639677b677037d9871e29" title="Create a category structure.">ast_category_new</a>(field_category, <span class="stringliteral">&quot;&quot;</span>, 99999);
<a name="l01105"></a>01105             <span class="keywordflow">if</span> (!cur_cat)
<a name="l01106"></a>01106                <span class="keywordflow">break</span>;
<a name="l01107"></a>01107             strcpy(last, field_category);
<a name="l01108"></a>01108             last_cat_metric = atoi(field_cat_metric);
<a name="l01109"></a>01109             <a class="code" href="config_8h.html#ab7b56ec66b058952423f313752c734e7">ast_category_append</a>(cfg, cur_cat);
<a name="l01110"></a>01110          }
<a name="l01111"></a>01111          new_v = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(field_var_name, field_var_val, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01112"></a>01112          <a class="code" href="config_8h.html#a132ddbd39dd9d26395c410f7647f76db">ast_variable_append</a>(cur_cat, new_v);
<a name="l01113"></a>01113       }
<a name="l01114"></a>01114    } <span class="keywordflow">else</span> {
<a name="l01115"></a>01115       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01116"></a>01116             <span class="stringliteral">&quot;PostgreSQL RealTime: Could not find config &apos;%s&apos; in database.\n&quot;</span>, file);
<a name="l01117"></a>01117    }
<a name="l01118"></a>01118 
<a name="l01119"></a>01119    PQclear(result);
<a name="l01120"></a>01120    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01121"></a>01121 
<a name="l01122"></a>01122    <span class="keywordflow">return</span> cfg;
<a name="l01123"></a>01123 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6024fe770f95cf135838424041e785d1"></a><!-- doxytag: member="res_config_pgsql.c::destroy_pgsql" ref="a6024fe770f95cf135838424041e785d1" args="(const char *database, const char *table, const char *keyfield, const char *lookup, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int destroy_pgsql </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>table</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>keyfield</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>lookup</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00938">938</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="strings_8h_source.html#l00637">ast_str_thread_get()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00096">ESCAPE_STRING</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00048">escapebuf_buf</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00044">pgsql_lock</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00045">sql_buf</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00047">where_buf</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00939"></a>00939 {
<a name="l00940"></a>00940    PGresult *result = NULL;
<a name="l00941"></a>00941    <span class="keywordtype">int</span> numrows = 0;
<a name="l00942"></a>00942    <span class="keywordtype">int</span> pgresult;
<a name="l00943"></a>00943    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sql = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#afc4bfa5a94710e6f323a1033f82425b3">sql_buf</a>, 256);
<a name="l00944"></a>00944    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *buf1 = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#a2b636f309367e4fa49ffb2c0a55e5bdd">where_buf</a>, 60), *buf2 = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#a5276aefbf1d003abafa0b7c7ff5449b9">escapebuf_buf</a>, 60);
<a name="l00945"></a>00945    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00946"></a>00946 
<a name="l00947"></a>00947    <span class="keywordflow">if</span> (!<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>) {
<a name="l00948"></a>00948       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;PostgreSQL RealTime: No table specified.\n&quot;</span>);
<a name="l00949"></a>00949       <span class="keywordflow">return</span> -1;
<a name="l00950"></a>00950    }
<a name="l00951"></a>00951 
<a name="l00952"></a>00952    <span class="comment">/* Get the first parameter and first value in our list of passed paramater/value pairs */</span>
<a name="l00953"></a>00953    <span class="comment">/*newparam = va_arg(ap, const char *);</span>
<a name="l00954"></a>00954 <span class="comment">   newval = va_arg(ap, const char *);</span>
<a name="l00955"></a>00955 <span class="comment">   if (!newparam || !newval) {*/</span>
<a name="l00956"></a>00956    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(keyfield) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(lookup))  {
<a name="l00957"></a>00957       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00958"></a>00958             <span class="stringliteral">&quot;PostgreSQL RealTime: Realtime destroy requires at least 1 parameter and 1 value to search on.\n&quot;</span>);
<a name="l00959"></a>00959       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>) {
<a name="l00960"></a>00960          PQfinish(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>);
<a name="l00961"></a>00961          <a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> = NULL;
<a name="l00962"></a>00962       };
<a name="l00963"></a>00963       <span class="keywordflow">return</span> -1;
<a name="l00964"></a>00964    }
<a name="l00965"></a>00965 
<a name="l00966"></a>00966    <span class="comment">/* Must connect to the server before anything else, as the escape function requires the connection handle.. */</span>
<a name="l00967"></a>00967    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00968"></a>00968    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#ac2ee0af8a28eebbaf6d50a2ba63bd9a6">pgsql_reconnect</a>(database)) {
<a name="l00969"></a>00969       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00970"></a>00970       <span class="keywordflow">return</span> -1;
<a name="l00971"></a>00971    }
<a name="l00972"></a>00972 
<a name="l00973"></a>00973 
<a name="l00974"></a>00974    <span class="comment">/* Create the first part of the query using the first parameter/value pairs we just extracted</span>
<a name="l00975"></a>00975 <span class="comment">      If there is only 1 set, then we have our query. Otherwise, loop thru the list and concat */</span>
<a name="l00976"></a>00976 
<a name="l00977"></a>00977    <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(buf1, keyfield);
<a name="l00978"></a>00978    <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(buf2, lookup);
<a name="l00979"></a>00979    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql, 0, <span class="stringliteral">&quot;DELETE FROM %s WHERE %s = &apos;%s&apos;&quot;</span>, <a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf1), <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf2));
<a name="l00980"></a>00980    <span class="keywordflow">while</span> ((newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l00981"></a>00981       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00982"></a>00982       <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(buf1, newparam);
<a name="l00983"></a>00983       <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(buf2, newval);
<a name="l00984"></a>00984       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql, 0, <span class="stringliteral">&quot; AND %s = &apos;%s&apos;&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf1), <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf2));
<a name="l00985"></a>00985    }
<a name="l00986"></a>00986    va_end(ap);
<a name="l00987"></a>00987 
<a name="l00988"></a>00988    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Delete SQL: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00989"></a>00989 
<a name="l00990"></a>00990    <span class="keywordflow">if</span> (!(result = PQexec(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql)))) {
<a name="l00991"></a>00991       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00992"></a>00992             <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query database. Check debug for more info.\n&quot;</span>);
<a name="l00993"></a>00993       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00994"></a>00994       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s\n&quot;</span>, PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>));
<a name="l00995"></a>00995       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00996"></a>00996       <span class="keywordflow">return</span> -1;
<a name="l00997"></a>00997    } <span class="keywordflow">else</span> {
<a name="l00998"></a>00998       ExecStatusType result_status = PQresultStatus(result);
<a name="l00999"></a>00999       <span class="keywordflow">if</span> (result_status != PGRES_COMMAND_OK
<a name="l01000"></a>01000          &amp;&amp; result_status != PGRES_TUPLES_OK
<a name="l01001"></a>01001          &amp;&amp; result_status != PGRES_NONFATAL_ERROR) {
<a name="l01002"></a>01002          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01003"></a>01003                <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query database. Check debug for more info.\n&quot;</span>);
<a name="l01004"></a>01004          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l01005"></a>01005          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s (%s)\n&quot;</span>,
<a name="l01006"></a>01006                   PQresultErrorMessage(result), PQresStatus(result_status));
<a name="l01007"></a>01007          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01008"></a>01008          <span class="keywordflow">return</span> -1;
<a name="l01009"></a>01009       }
<a name="l01010"></a>01010    }
<a name="l01011"></a>01011 
<a name="l01012"></a>01012    numrows = atoi(PQcmdTuples(result));
<a name="l01013"></a>01013    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01014"></a>01014 
<a name="l01015"></a>01015    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Deleted %d rows on table: %s\n&quot;</span>, numrows, <a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>);
<a name="l01016"></a>01016 
<a name="l01017"></a>01017    <span class="comment">/* From http://dev.pgsql.com/doc/pgsql/en/pgsql-affected-rows.html</span>
<a name="l01018"></a>01018 <span class="comment">    * An integer greater than zero indicates the number of rows affected</span>
<a name="l01019"></a>01019 <span class="comment">    * Zero indicates that no records were updated</span>
<a name="l01020"></a>01020 <span class="comment">    * -1 indicates that the query returned an error (although, if the query failed, it should have been caught above.)</span>
<a name="l01021"></a>01021 <span class="comment">    */</span>
<a name="l01022"></a>01022 
<a name="l01023"></a>01023    <span class="keywordflow">if</span> (numrows &gt;= 0)
<a name="l01024"></a>01024       <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) numrows;
<a name="l01025"></a>01025 
<a name="l01026"></a>01026    <span class="keywordflow">return</span> -1;
<a name="l01027"></a>01027 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a40989424551303763ab1bae2aa13ba11"></a><!-- doxytag: member="res_config_pgsql.c::destroy_table" ref="a40989424551303763ab1bae2aa13ba11" args="(struct tables *table)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void destroy_table </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structtables.html">tables</a> *&nbsp;</td>
          <td class="paramname"> <em>table</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00105">105</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="linkedlists_8h_source.html#l00817">AST_LIST_REMOVE_HEAD</a>, <a class="el" href="lock_8h_source.html#l01786">ast_rwlock_destroy()</a>, <a class="el" href="lock_8h_source.html#l01791">ast_rwlock_unlock()</a>, <a class="el" href="lock_8h_source.html#l01827">ast_rwlock_wrlock()</a>, <a class="el" href="structtables.html#acc878587149a78a26fa030feaae016ed">tables::columns</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00068">tables::lock</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l00117">find_table()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01293">unload_module()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l01246">unload_pgsql()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00106"></a>00106 {
<a name="l00107"></a>00107    <span class="keyword">struct </span><a class="code" href="structcolumns.html">columns</a> *column;
<a name="l00108"></a>00108    <a class="code" href="lock_8h.html#a952527792bba2a323118ae911f9aa1f7">ast_rwlock_wrlock</a>(&amp;table-&gt;<a class="code" href="structtables.html#ace4e0066a5b24f84b90536e9906619f6">lock</a>);
<a name="l00109"></a>00109    <span class="keywordflow">while</span> ((column = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;table-&gt;<a class="code" href="structtables.html#acc878587149a78a26fa030feaae016ed">columns</a>, <a class="code" href="structcolumns.html#a7160fb4746cd0e57449db13e15d6b8c1">list</a>))) {
<a name="l00110"></a>00110       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(column);
<a name="l00111"></a>00111    }
<a name="l00112"></a>00112    <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;table-&gt;<a class="code" href="structtables.html#ace4e0066a5b24f84b90536e9906619f6">lock</a>);
<a name="l00113"></a>00113    <a class="code" href="lock_8h.html#aa1e308479619b6e2a20c7b27479cafa9">ast_rwlock_destroy</a>(&amp;table-&gt;<a class="code" href="structtables.html#ace4e0066a5b24f84b90536e9906619f6">lock</a>);
<a name="l00114"></a>00114    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(table);
<a name="l00115"></a>00115 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a185e8c10da20a980396fb08bd4dd82b5"></a><!-- doxytag: member="res_config_pgsql.c::find_column" ref="a185e8c10da20a980396fb08bd4dd82b5" args="(struct tables *t, const char *colname)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structcolumns.html">columns</a>* find_column </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structtables.html">tables</a> *&nbsp;</td>
          <td class="paramname"> <em>t</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>colname</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00270">270</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, <a class="el" href="structtables.html#acc878587149a78a26fa030feaae016ed">tables::columns</a>, and <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00058">columns::name</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l00714">update2_pgsql()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00576">update_pgsql()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00271"></a>00271 {
<a name="l00272"></a>00272    <span class="keyword">struct </span><a class="code" href="structcolumns.html">columns</a> *column;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274    <span class="comment">/* Check that the column exists in the table */</span>
<a name="l00275"></a>00275    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;t-&gt;<a class="code" href="structtables.html#acc878587149a78a26fa030feaae016ed">columns</a>, column, <a class="code" href="structcolumns.html#a7160fb4746cd0e57449db13e15d6b8c1">list</a>) {
<a name="l00276"></a>00276       <span class="keywordflow">if</span> (strcmp(column-&gt;<a class="code" href="structcolumns.html#ad547fb8186b526cb1b588daad4334fbe">name</a>, colname) == 0) {
<a name="l00277"></a>00277          <span class="keywordflow">return</span> column;
<a name="l00278"></a>00278       }
<a name="l00279"></a>00279    }
<a name="l00280"></a>00280    <span class="keywordflow">return</span> NULL;
<a name="l00281"></a>00281 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aaeb0f59e00eee1f4c11c427865821127"></a><!-- doxytag: member="res_config_pgsql.c::find_table" ref="aaeb0f59e00eee1f4c11c427865821127" args="(const char *orig_tablename)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structtables.html">tables</a>* find_table </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>orig_tablename</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00117">117</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="linkedlists_8h_source.html#l00665">AST_LIST_HEAD_INIT_NOLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00715">AST_LIST_INSERT_TAIL</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01770">ast_rwlock_init()</a>, <a class="el" href="lock_8h_source.html#l01796">ast_rwlock_rdlock()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="strings_8h_source.html#l00637">ast_str_thread_get()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="structtables.html#acc878587149a78a26fa030feaae016ed">tables::columns</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00105">destroy_table()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00046">findtable_buf</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00054">has_schema_support</a>, <a class="el" href="cdr__pgsql_8c_source.html#l00070">columns::hasdefault</a>, <a class="el" href="cdr__pgsql_8c_source.html#l00068">columns::len</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00068">tables::lock</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00058">columns::name</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00071">tables::name</a>, <a class="el" href="cdr__pgsql_8c_source.html#l00069">columns::notnull</a>, <a class="el" href="cdr__odbc_8c_source.html#l00052">table</a>, and <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00062">columns::type</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01484">handle_cli_realtime_pgsql_cache()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01125">require_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00714">update2_pgsql()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00576">update_pgsql()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00118"></a>00118 {
<a name="l00119"></a>00119    <span class="keyword">struct </span><a class="code" href="structcolumns.html">columns</a> *column;
<a name="l00120"></a>00120    <span class="keyword">struct </span><a class="code" href="structtables.html">tables</a> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>;
<a name="l00121"></a>00121    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sql = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#ad10b165b24bb77fd0137e9f7a26d83aa">findtable_buf</a>, 330);
<a name="l00122"></a>00122    <span class="keywordtype">char</span> *pgerror;
<a name="l00123"></a>00123    PGresult *result;
<a name="l00124"></a>00124    <span class="keywordtype">char</span> *fname, *ftype, *flen, *fnotnull, *fdef;
<a name="l00125"></a>00125    <span class="keywordtype">int</span> i, rows;
<a name="l00126"></a>00126 
<a name="l00127"></a>00127    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l00128"></a>00128    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>, table, list) {
<a name="l00129"></a>00129       <span class="keywordflow">if</span> (!strcasecmp(table-&gt;<a class="code" href="structtables.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, orig_tablename)) {
<a name="l00130"></a>00130          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Found table in cache; now locking\n&quot;</span>);
<a name="l00131"></a>00131          <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;table-&gt;<a class="code" href="structtables.html#ace4e0066a5b24f84b90536e9906619f6">lock</a>);
<a name="l00132"></a>00132          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Lock cached table; now returning\n&quot;</span>);
<a name="l00133"></a>00133          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l00134"></a>00134          <span class="keywordflow">return</span> table;
<a name="l00135"></a>00135       }
<a name="l00136"></a>00136    }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Table &apos;%s&apos; not found in cache, querying now\n&quot;</span>, orig_tablename);
<a name="l00139"></a>00139 
<a name="l00140"></a>00140    <span class="comment">/* Not found, scan the table */</span>
<a name="l00141"></a>00141    <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a906e665d74012c49cc132dcdfdf64ad4">has_schema_support</a>) {
<a name="l00142"></a>00142       <span class="keywordtype">char</span> *schemaname, *tablename;
<a name="l00143"></a>00143       <span class="keywordflow">if</span> (strchr(orig_tablename, <span class="charliteral">&apos;.&apos;</span>)) {
<a name="l00144"></a>00144          schemaname = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(orig_tablename);
<a name="l00145"></a>00145          tablename = strchr(schemaname, <span class="charliteral">&apos;.&apos;</span>);
<a name="l00146"></a>00146          *tablename++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00147"></a>00147       } <span class="keywordflow">else</span> {
<a name="l00148"></a>00148          schemaname = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00149"></a>00149          tablename = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(orig_tablename);
<a name="l00150"></a>00150       }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152       <span class="comment">/* Escape special characters in schemaname */</span>
<a name="l00153"></a>00153       <span class="keywordflow">if</span> (strchr(schemaname, <span class="charliteral">&apos;\\&apos;</span>) || strchr(schemaname, <span class="charliteral">&apos;\&apos;&apos;</span>)) {
<a name="l00154"></a>00154          <span class="keywordtype">char</span> *tmp = schemaname, *ptr;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156          ptr = schemaname = alloca(strlen(tmp) * 2 + 1);
<a name="l00157"></a>00157          <span class="keywordflow">for</span> (; *tmp; tmp++) {
<a name="l00158"></a>00158             <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;\\&apos;&quot;</span>, *tmp)) {
<a name="l00159"></a>00159                *ptr++ = *tmp;
<a name="l00160"></a>00160             }
<a name="l00161"></a>00161             *ptr++ = *tmp;
<a name="l00162"></a>00162          }
<a name="l00163"></a>00163          *ptr = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00164"></a>00164       }
<a name="l00165"></a>00165       <span class="comment">/* Escape special characters in tablename */</span>
<a name="l00166"></a>00166       <span class="keywordflow">if</span> (strchr(tablename, <span class="charliteral">&apos;\\&apos;</span>) || strchr(tablename, <span class="charliteral">&apos;\&apos;&apos;</span>)) {
<a name="l00167"></a>00167          <span class="keywordtype">char</span> *tmp = tablename, *ptr;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169          ptr = tablename = alloca(strlen(tmp) * 2 + 1);
<a name="l00170"></a>00170          <span class="keywordflow">for</span> (; *tmp; tmp++) {
<a name="l00171"></a>00171             <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;\\&apos;&quot;</span>, *tmp)) {
<a name="l00172"></a>00172                *ptr++ = *tmp;
<a name="l00173"></a>00173             }
<a name="l00174"></a>00174             *ptr++ = *tmp;
<a name="l00175"></a>00175          }
<a name="l00176"></a>00176          *ptr = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00177"></a>00177       }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179       <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql, 0, <span class="stringliteral">&quot;SELECT a.attname, t.typname, a.attlen, a.attnotnull, d.adsrc, a.atttypmod FROM (((pg_catalog.pg_class c INNER JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace AND c.relname = &apos;%s&apos; AND n.nspname = %s%s%s) INNER JOIN pg_catalog.pg_attribute a ON (NOT a.attisdropped) AND a.attnum &gt; 0 AND a.attrelid = c.oid) INNER JOIN pg_catalog.pg_type t ON t.oid = a.atttypid) LEFT OUTER JOIN pg_attrdef d ON a.atthasdef AND d.adrelid = a.attrelid AND d.adnum = a.attnum ORDER BY n.nspname, c.relname, attnum&quot;</span>,
<a name="l00180"></a>00180          tablename,
<a name="l00181"></a>00181          <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(schemaname) ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;&apos;&quot;</span>, <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(schemaname) ? <span class="stringliteral">&quot;current_schema()&quot;</span> : schemaname, <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(schemaname) ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;&apos;&quot;</span>);
<a name="l00182"></a>00182    } <span class="keywordflow">else</span> {
<a name="l00183"></a>00183       <span class="comment">/* Escape special characters in tablename */</span>
<a name="l00184"></a>00184       <span class="keywordflow">if</span> (strchr(orig_tablename, <span class="charliteral">&apos;\\&apos;</span>) || strchr(orig_tablename, <span class="charliteral">&apos;\&apos;&apos;</span>)) {
<a name="l00185"></a>00185          <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp = orig_tablename;
<a name="l00186"></a>00186          <span class="keywordtype">char</span> *ptr;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188          orig_tablename = ptr = alloca(strlen(tmp) * 2 + 1);
<a name="l00189"></a>00189          <span class="keywordflow">for</span> (; *tmp; tmp++) {
<a name="l00190"></a>00190             <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;\\&apos;&quot;</span>, *tmp)) {
<a name="l00191"></a>00191                *ptr++ = *tmp;
<a name="l00192"></a>00192             }
<a name="l00193"></a>00193             *ptr++ = *tmp;
<a name="l00194"></a>00194          }
<a name="l00195"></a>00195          *ptr = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00196"></a>00196       }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198       <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql, 0, <span class="stringliteral">&quot;SELECT a.attname, t.typname, a.attlen, a.attnotnull, d.adsrc, a.atttypmod FROM pg_class c, pg_type t, pg_attribute a LEFT OUTER JOIN pg_attrdef d ON a.atthasdef AND d.adrelid = a.attrelid AND d.adnum = a.attnum WHERE c.oid = a.attrelid AND a.atttypid = t.oid AND (a.attnum &gt; 0) AND c.relname = &apos;%s&apos; ORDER BY c.relname, attnum&quot;</span>, orig_tablename);
<a name="l00199"></a>00199    }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201    result = PQexec(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00202"></a>00202    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Query of table structure complete.  Now retrieving results.\n&quot;</span>);
<a name="l00203"></a>00203    <span class="keywordflow">if</span> (PQresultStatus(result) != PGRES_TUPLES_OK) {
<a name="l00204"></a>00204       pgerror = PQresultErrorMessage(result);
<a name="l00205"></a>00205       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to query database columns: %s\n&quot;</span>, pgerror);
<a name="l00206"></a>00206       PQclear(result);
<a name="l00207"></a>00207       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l00208"></a>00208       <span class="keywordflow">return</span> NULL;
<a name="l00209"></a>00209    }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211    <span class="keywordflow">if</span> (!(table = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*table) + strlen(orig_tablename) + 1))) {
<a name="l00212"></a>00212       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to allocate memory for new table structure\n&quot;</span>);
<a name="l00213"></a>00213       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l00214"></a>00214       <span class="keywordflow">return</span> NULL;
<a name="l00215"></a>00215    }
<a name="l00216"></a>00216    strcpy(table-&gt;<a class="code" href="structtables.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, orig_tablename); <span class="comment">/* SAFE */</span>
<a name="l00217"></a>00217    <a class="code" href="lock_8h.html#aeae3552501126e03a4fa95f4acd0ee67">ast_rwlock_init</a>(&amp;table-&gt;<a class="code" href="structtables.html#ace4e0066a5b24f84b90536e9906619f6">lock</a>);
<a name="l00218"></a>00218    <a class="code" href="linkedlists_8h.html#a0d1f922e093ac18824a7863fe3f5fa27" title="Initializes a list head structure.">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;table-&gt;<a class="code" href="structtables.html#acc878587149a78a26fa030feaae016ed">columns</a>);
<a name="l00219"></a>00219 
<a name="l00220"></a>00220    rows = PQntuples(result);
<a name="l00221"></a>00221    <span class="keywordflow">for</span> (i = 0; i &lt; rows; i++) {
<a name="l00222"></a>00222       fname = PQgetvalue(result, i, 0);
<a name="l00223"></a>00223       ftype = PQgetvalue(result, i, 1);
<a name="l00224"></a>00224       flen = PQgetvalue(result, i, 2);
<a name="l00225"></a>00225       fnotnull = PQgetvalue(result, i, 3);
<a name="l00226"></a>00226       fdef = PQgetvalue(result, i, 4);
<a name="l00227"></a>00227       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Found column &apos;%s&apos; of type &apos;%s&apos;\n&quot;</span>, fname, ftype);
<a name="l00228"></a>00228 
<a name="l00229"></a>00229       <span class="keywordflow">if</span> (!(column = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*column) + strlen(fname) + strlen(ftype) + 2))) {
<a name="l00230"></a>00230          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to allocate column element for %s, %s\n&quot;</span>, orig_tablename, fname);
<a name="l00231"></a>00231          <a class="code" href="res__config__pgsql_8c.html#a40989424551303763ab1bae2aa13ba11">destroy_table</a>(table);
<a name="l00232"></a>00232          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l00233"></a>00233          <span class="keywordflow">return</span> NULL;
<a name="l00234"></a>00234       }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236       <span class="keywordflow">if</span> (strcmp(flen, <span class="stringliteral">&quot;-1&quot;</span>) == 0) {
<a name="l00237"></a>00237          <span class="comment">/* Some types, like chars, have the length stored in a different field */</span>
<a name="l00238"></a>00238          flen = PQgetvalue(result, i, 5);
<a name="l00239"></a>00239          sscanf(flen, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;column-&gt;<a class="code" href="structcolumns.html#afed088663f8704004425cdae2120b9b3">len</a>);
<a name="l00240"></a>00240          column-&gt;<a class="code" href="structcolumns.html#afed088663f8704004425cdae2120b9b3">len</a> -= 4;
<a name="l00241"></a>00241       } <span class="keywordflow">else</span> {
<a name="l00242"></a>00242          sscanf(flen, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;column-&gt;<a class="code" href="structcolumns.html#afed088663f8704004425cdae2120b9b3">len</a>);
<a name="l00243"></a>00243       }
<a name="l00244"></a>00244       column-&gt;<a class="code" href="structcolumns.html#ad547fb8186b526cb1b588daad4334fbe">name</a> = (<span class="keywordtype">char</span> *)column + <span class="keyword">sizeof</span>(*column);
<a name="l00245"></a>00245       column-&gt;<a class="code" href="structcolumns.html#a6daaf29b293f2cd25c794dcdd95f2d63">type</a> = (<span class="keywordtype">char</span> *)column + <span class="keyword">sizeof</span>(*column) + strlen(fname) + 1;
<a name="l00246"></a>00246       strcpy(column-&gt;<a class="code" href="structcolumns.html#ad547fb8186b526cb1b588daad4334fbe">name</a>, fname);
<a name="l00247"></a>00247       strcpy(column-&gt;<a class="code" href="structcolumns.html#a6daaf29b293f2cd25c794dcdd95f2d63">type</a>, ftype);
<a name="l00248"></a>00248       <span class="keywordflow">if</span> (*fnotnull == <span class="charliteral">&apos;t&apos;</span>) {
<a name="l00249"></a>00249          column-&gt;<a class="code" href="structcolumns.html#a9bdc1728ecd728a284d42e1139f5f4ea">notnull</a> = 1;
<a name="l00250"></a>00250       } <span class="keywordflow">else</span> {
<a name="l00251"></a>00251          column-&gt;<a class="code" href="structcolumns.html#a9bdc1728ecd728a284d42e1139f5f4ea">notnull</a> = 0;
<a name="l00252"></a>00252       }
<a name="l00253"></a>00253       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(fdef)) {
<a name="l00254"></a>00254          column-&gt;<a class="code" href="structcolumns.html#a39a510f4ada8c67c179b6d17e9d66b44">hasdefault</a> = 1;
<a name="l00255"></a>00255       } <span class="keywordflow">else</span> {
<a name="l00256"></a>00256          column-&gt;<a class="code" href="structcolumns.html#a39a510f4ada8c67c179b6d17e9d66b44">hasdefault</a> = 0;
<a name="l00257"></a>00257       }
<a name="l00258"></a>00258       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;table-&gt;<a class="code" href="structtables.html#acc878587149a78a26fa030feaae016ed">columns</a>, column, list);
<a name="l00259"></a>00259    }
<a name="l00260"></a>00260    PQclear(result);
<a name="l00261"></a>00261 
<a name="l00262"></a>00262    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>, table, list);
<a name="l00263"></a>00263    <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;table-&gt;<a class="code" href="structtables.html#ace4e0066a5b24f84b90536e9906619f6">lock</a>);
<a name="l00264"></a>00264    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l00265"></a>00265    <span class="keywordflow">return</span> table;
<a name="l00266"></a>00266 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad4b5e121aaba3306fc6a19abacff9a5c"></a><!-- doxytag: member="res_config_pgsql.c::handle_cli_realtime_pgsql_cache" ref="ad4b5e121aaba3306fc6a19abacff9a5c" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char * handle_cli_realtime_pgsql_cache </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01484">1484</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8h_source.html#l00141">ast_cli_args::argv</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="astmm_8h_source.html#l00099">ast_strdup</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="structtables.html#acc878587149a78a26fa030feaae016ed">tables::columns</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00117">find_table()</a>, <a class="el" href="cdr__pgsql_8c_source.html#l00068">columns::len</a>, <a class="el" href="cli_8h_source.html#l00145">ast_cli_args::n</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00058">columns::name</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00071">tables::name</a>, <a class="el" href="cdr__pgsql_8c_source.html#l00069">columns::notnull</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00268">release_table</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00062">columns::type</a>, <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>, and <a class="el" href="cli_8h_source.html#l00143">ast_cli_args::word</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01485"></a>01485 {
<a name="l01486"></a>01486    <span class="keyword">struct </span><a class="code" href="structtables.html">tables</a> *cur;
<a name="l01487"></a>01487    <span class="keywordtype">int</span> l, which;
<a name="l01488"></a>01488    <span class="keywordtype">char</span> *ret = NULL;
<a name="l01489"></a>01489 
<a name="l01490"></a>01490    <span class="keywordflow">switch</span> (cmd) {
<a name="l01491"></a>01491    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01492"></a>01492       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;realtime show pgsql cache&quot;</span>;
<a name="l01493"></a>01493       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01494"></a>01494          <span class="stringliteral">&quot;Usage: realtime show pgsql cache [&lt;table&gt;]\n&quot;</span>
<a name="l01495"></a>01495          <span class="stringliteral">&quot;       Shows table cache for the PostgreSQL RealTime driver\n&quot;</span>;
<a name="l01496"></a>01496       <span class="keywordflow">return</span> NULL;
<a name="l01497"></a>01497    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01498"></a>01498       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4) {
<a name="l01499"></a>01499          <span class="keywordflow">return</span> NULL;
<a name="l01500"></a>01500       }
<a name="l01501"></a>01501       l = strlen(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>);
<a name="l01502"></a>01502       which = 0;
<a name="l01503"></a>01503       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l01504"></a>01504       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>, cur, <a class="code" href="structtables.html#a820ea34b748e7d4cd60f0ceae9b0355d">list</a>) {
<a name="l01505"></a>01505          <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, cur-&gt;<a class="code" href="structtables.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, l) &amp;&amp; ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>) {
<a name="l01506"></a>01506             ret = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(cur-&gt;<a class="code" href="structtables.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l01507"></a>01507             <span class="keywordflow">break</span>;
<a name="l01508"></a>01508          }
<a name="l01509"></a>01509       }
<a name="l01510"></a>01510       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l01511"></a>01511       <span class="keywordflow">return</span> ret;
<a name="l01512"></a>01512    }
<a name="l01513"></a>01513 
<a name="l01514"></a>01514    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 4) {
<a name="l01515"></a>01515       <span class="comment">/* List of tables */</span>
<a name="l01516"></a>01516       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l01517"></a>01517       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>, cur, <a class="code" href="structtables.html#a820ea34b748e7d4cd60f0ceae9b0355d">list</a>) {
<a name="l01518"></a>01518          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, cur-&gt;<a class="code" href="structtables.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>);
<a name="l01519"></a>01519       }
<a name="l01520"></a>01520       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l01521"></a>01521    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 5) {
<a name="l01522"></a>01522       <span class="comment">/* List of columns */</span>
<a name="l01523"></a>01523       <span class="keywordflow">if</span> ((cur = <a class="code" href="res__config__pgsql_8c.html#aaeb0f59e00eee1f4c11c427865821127">find_table</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4]))) {
<a name="l01524"></a>01524          <span class="keyword">struct </span><a class="code" href="structcolumns.html">columns</a> *col;
<a name="l01525"></a>01525          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Columns for Table Cache &apos;%s&apos;:\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4]);
<a name="l01526"></a>01526          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-20.20s %-20.20s %-3.3s %-8.8s\n&quot;</span>, <span class="stringliteral">&quot;Name&quot;</span>, <span class="stringliteral">&quot;Type&quot;</span>, <span class="stringliteral">&quot;Len&quot;</span>, <span class="stringliteral">&quot;Nullable&quot;</span>);
<a name="l01527"></a>01527          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cur-&gt;<a class="code" href="structtables.html#acc878587149a78a26fa030feaae016ed">columns</a>, col, <a class="code" href="structcolumns.html#a7160fb4746cd0e57449db13e15d6b8c1">list</a>) {
<a name="l01528"></a>01528             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-20.20s %-20.20s %3d %-8.8s\n&quot;</span>, col-&gt;<a class="code" href="structcolumns.html#ad547fb8186b526cb1b588daad4334fbe">name</a>, col-&gt;<a class="code" href="structcolumns.html#a6daaf29b293f2cd25c794dcdd95f2d63">type</a>, col-&gt;<a class="code" href="structcolumns.html#afed088663f8704004425cdae2120b9b3">len</a>, col-&gt;<a class="code" href="structcolumns.html#a9bdc1728ecd728a284d42e1139f5f4ea">notnull</a> ? <span class="stringliteral">&quot;NOT NULL&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l01529"></a>01529          }
<a name="l01530"></a>01530          <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(cur);
<a name="l01531"></a>01531       } <span class="keywordflow">else</span> {
<a name="l01532"></a>01532          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No such table &apos;%s&apos;\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4]);
<a name="l01533"></a>01533       }
<a name="l01534"></a>01534    }
<a name="l01535"></a>01535    <span class="keywordflow">return</span> 0;
<a name="l01536"></a>01536 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a8b98835879e51580aabf8a411acf6f14"></a><!-- doxytag: member="res_config_pgsql.c::handle_cli_realtime_pgsql_status" ref="a8b98835879e51580aabf8a411acf6f14" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char * handle_cli_realtime_pgsql_status </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01538">1538</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="cli_8h_source.html#l00045">CLI_FAILURE</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00082">connect_time</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00076">dbhost</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00079">dbname</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00081">dbport</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00080">dbsock</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00077">dbuser</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="app__jack_8c_source.html#l00141">status</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01539"></a>01539 {
<a name="l01540"></a>01540    <span class="keywordtype">char</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>[256], credentials[100] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01541"></a>01541    <span class="keywordtype">int</span> ctimesec = time(NULL) - <a class="code" href="res__config__pgsql_8c.html#ac4ae24c7b766713b82921c04d1a4b699">connect_time</a>;
<a name="l01542"></a>01542 
<a name="l01543"></a>01543    <span class="keywordflow">switch</span> (cmd) {
<a name="l01544"></a>01544    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01545"></a>01545       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;realtime show pgsql status&quot;</span>;
<a name="l01546"></a>01546       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01547"></a>01547          <span class="stringliteral">&quot;Usage: realtime show pgsql status\n&quot;</span>
<a name="l01548"></a>01548          <span class="stringliteral">&quot;       Shows connection information for the PostgreSQL RealTime driver\n&quot;</span>;
<a name="l01549"></a>01549       <span class="keywordflow">return</span> NULL;
<a name="l01550"></a>01550    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01551"></a>01551       <span class="keywordflow">return</span> NULL;
<a name="l01552"></a>01552    }
<a name="l01553"></a>01553 
<a name="l01554"></a>01554    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l01555"></a>01555       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01556"></a>01556 
<a name="l01557"></a>01557    <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> &amp;&amp; PQstatus(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>) == CONNECTION_OK) {
<a name="l01558"></a>01558       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>))
<a name="l01559"></a>01559          snprintf(status, <span class="keyword">sizeof</span>(status), <span class="stringliteral">&quot;Connected to %s@%s, port %d&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#a6904a1f9115898f7691f4e8a405b8b98">dbname</a>, <a class="code" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>, <a class="code" href="res__config__pgsql_8c.html#ad76d37dfe4b000f0e1113be85bf2c41f">dbport</a>);
<a name="l01560"></a>01560       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="res__config__pgsql_8c.html#ac4ba6066077517f4c70aa20a44d61e8d">dbsock</a>))
<a name="l01561"></a>01561          snprintf(status, <span class="keyword">sizeof</span>(status), <span class="stringliteral">&quot;Connected to %s on socket file %s&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#a6904a1f9115898f7691f4e8a405b8b98">dbname</a>, <a class="code" href="res__config__pgsql_8c.html#ac4ba6066077517f4c70aa20a44d61e8d">dbsock</a>);
<a name="l01562"></a>01562       <span class="keywordflow">else</span>
<a name="l01563"></a>01563          snprintf(status, <span class="keyword">sizeof</span>(status), <span class="stringliteral">&quot;Connected to %s@%s&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#a6904a1f9115898f7691f4e8a405b8b98">dbname</a>, <a class="code" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>);
<a name="l01564"></a>01564 
<a name="l01565"></a>01565       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="res__config__pgsql_8c.html#a1db90a8699d1255793e9d9accfe04e3c">dbuser</a>))
<a name="l01566"></a>01566          snprintf(credentials, <span class="keyword">sizeof</span>(credentials), <span class="stringliteral">&quot; with username %s&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#a1db90a8699d1255793e9d9accfe04e3c">dbuser</a>);
<a name="l01567"></a>01567 
<a name="l01568"></a>01568       <span class="keywordflow">if</span> (ctimesec &gt; 31536000)
<a name="l01569"></a>01569          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s%s for %d years, %d days, %d hours, %d minutes, %d seconds.\n&quot;</span>,
<a name="l01570"></a>01570                status, credentials, ctimesec / 31536000, (ctimesec % 31536000) / 86400,
<a name="l01571"></a>01571                (ctimesec % 86400) / 3600, (ctimesec % 3600) / 60, ctimesec % 60);
<a name="l01572"></a>01572       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ctimesec &gt; 86400)
<a name="l01573"></a>01573          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s%s for %d days, %d hours, %d minutes, %d seconds.\n&quot;</span>, status,
<a name="l01574"></a>01574                credentials, ctimesec / 86400, (ctimesec % 86400) / 3600, (ctimesec % 3600) / 60,
<a name="l01575"></a>01575                ctimesec % 60);
<a name="l01576"></a>01576       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ctimesec &gt; 3600)
<a name="l01577"></a>01577          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s%s for %d hours, %d minutes, %d seconds.\n&quot;</span>, status, credentials,
<a name="l01578"></a>01578                ctimesec / 3600, (ctimesec % 3600) / 60, ctimesec % 60);
<a name="l01579"></a>01579       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ctimesec &gt; 60)
<a name="l01580"></a>01580          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s%s for %d minutes, %d seconds.\n&quot;</span>, status, credentials, ctimesec / 60,
<a name="l01581"></a>01581                ctimesec % 60);
<a name="l01582"></a>01582       <span class="keywordflow">else</span>
<a name="l01583"></a>01583          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s%s for %d seconds.\n&quot;</span>, status, credentials, ctimesec);
<a name="l01584"></a>01584 
<a name="l01585"></a>01585       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01586"></a>01586    } <span class="keywordflow">else</span> {
<a name="l01587"></a>01587       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01588"></a>01588    }
<a name="l01589"></a>01589 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac3382bf6da54c56b37069bd76bbdf4f9"></a><!-- doxytag: member="res_config_pgsql.c::load_module" ref="ac3382bf6da54c56b37069bd76bbdf4f9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01281">1281</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="isdn__lib_8c_source.html#l00040">ARRAY_LEN</a>, <a class="el" href="cli_8c_source.html#l01927">ast_cli_register_multiple()</a>, <a class="el" href="config_8c_source.html#l01950">ast_config_engine_register()</a>, <a class="el" href="module_8h_source.html#l00062">AST_MODULE_LOAD_DECLINE</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l01327">parse_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01282"></a>01282 {
<a name="l01283"></a>01283    <span class="keywordflow">if</span>(!<a class="code" href="res__config__pgsql_8c.html#a0dc068d63cb9df28d4b885bb7b5c5560">parse_config</a>(0))
<a name="l01284"></a>01284       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01285"></a>01285 
<a name="l01286"></a>01286    <a class="code" href="config_8h.html#af15c271e1708b251fc938b30baba18f1" title="Register config engine.">ast_config_engine_register</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#a981435c3dda0517ead4c0fb9080fb9e8">pgsql_engine</a>);
<a name="l01287"></a>01287    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime driver loaded.\n&quot;</span>);
<a name="l01288"></a>01288    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="res__config__pgsql_8c.html#a5978a10899c3c5e1db25f2eb882180ce">cli_realtime</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="res__config__pgsql_8c.html#a5978a10899c3c5e1db25f2eb882180ce">cli_realtime</a>));
<a name="l01289"></a>01289 
<a name="l01290"></a>01290    <span class="keywordflow">return</span> 0;
<a name="l01291"></a>01291 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0dc068d63cb9df28d4b885bb7b5c5560"></a><!-- doxytag: member="res_config_pgsql.c::parse_config" ref="a0dc068d63cb9df28d4b885bb7b5c5560" args="(int reload)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int parse_config </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>reload</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01327">1327</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="config_8c_source.html#l00827">ast_config_destroy()</a>, <a class="el" href="config_8h_source.html#l00139">ast_config_load</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="config_8c_source.html#l00435">ast_variable_retrieve()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="cdr__csv_8c_source.html#l00054">config</a>, <a class="el" href="config_8h_source.html#l00043">CONFIG_FLAG_FILEUNCHANGED</a>, <a class="el" href="config_8h_source.html#l00050">CONFIG_STATUS_FILEINVALID</a>, <a class="el" href="config_8h_source.html#l00048">CONFIG_STATUS_FILEMISSING</a>, <a class="el" href="config_8h_source.html#l00049">CONFIG_STATUS_FILEUNCHANGED</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00076">dbhost</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00079">dbname</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00078">dbpass</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00081">dbport</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00080">dbsock</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00077">dbuser</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00044">pgsql_lock</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>, <a class="el" href="res__config__pgsql_8c.html#a7e2f1debddb2f7bbdddc82ef5aeb0332">requirements</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00050">RES_CONFIG_PGSQL_CONF</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00089">RQ_CREATECHAR</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00089">RQ_CREATECLOSE</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00089">RQ_WARN</a>, and <a class="el" href="aesopt_8h_source.html#l00399">s</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01281">load_module()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l01320">reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01328"></a>01328 {
<a name="l01329"></a>01329    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>;
<a name="l01330"></a>01330    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l01331"></a>01331    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="app__rpt_8c.html#a1f57f20c1f46890828791a4827fe8752">config_flags</a> = { is_reload ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l01332"></a>01332 
<a name="l01333"></a>01333    config = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="res__config__pgsql_8c.html#a8e1434e7d1f44ef3694d535f7bc39863">RES_CONFIG_PGSQL_CONF</a>, config_flags);
<a name="l01334"></a>01334    <span class="keywordflow">if</span> (config == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {
<a name="l01335"></a>01335       <span class="keywordflow">return</span> 0;
<a name="l01336"></a>01336    }
<a name="l01337"></a>01337 
<a name="l01338"></a>01338    <span class="keywordflow">if</span> (config == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || config == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l01339"></a>01339       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to load config %s\n&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#a8e1434e7d1f44ef3694d535f7bc39863">RES_CONFIG_PGSQL_CONF</a>);
<a name="l01340"></a>01340       <span class="keywordflow">return</span> 0;
<a name="l01341"></a>01341    }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01344"></a>01344 
<a name="l01345"></a>01345    <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>) {
<a name="l01346"></a>01346       PQfinish(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>);
<a name="l01347"></a>01347       <a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> = NULL;
<a name="l01348"></a>01348    }
<a name="l01349"></a>01349 
<a name="l01350"></a>01350    <span class="keywordflow">if</span> (!(s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(config, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;dbuser&quot;</span>))) {
<a name="l01351"></a>01351       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01352"></a>01352             <span class="stringliteral">&quot;PostgreSQL RealTime: No database user found, using &apos;asterisk&apos; as default.\n&quot;</span>);
<a name="l01353"></a>01353       strcpy(<a class="code" href="res__config__pgsql_8c.html#a1db90a8699d1255793e9d9accfe04e3c">dbuser</a>, <span class="stringliteral">&quot;asterisk&quot;</span>);
<a name="l01354"></a>01354    } <span class="keywordflow">else</span> {
<a name="l01355"></a>01355       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="res__config__pgsql_8c.html#a1db90a8699d1255793e9d9accfe04e3c">dbuser</a>, s, <span class="keyword">sizeof</span>(<a class="code" href="res__config__pgsql_8c.html#a1db90a8699d1255793e9d9accfe04e3c">dbuser</a>));
<a name="l01356"></a>01356    }
<a name="l01357"></a>01357 
<a name="l01358"></a>01358    <span class="keywordflow">if</span> (!(s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(config, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;dbpass&quot;</span>))) {
<a name="l01359"></a>01359       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01360"></a>01360             <span class="stringliteral">&quot;PostgreSQL RealTime: No database password found, using &apos;asterisk&apos; as default.\n&quot;</span>);
<a name="l01361"></a>01361       strcpy(<a class="code" href="res__config__pgsql_8c.html#a6c0213e458980748dc52ffc409668ada">dbpass</a>, <span class="stringliteral">&quot;asterisk&quot;</span>);
<a name="l01362"></a>01362    } <span class="keywordflow">else</span> {
<a name="l01363"></a>01363       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="res__config__pgsql_8c.html#a6c0213e458980748dc52ffc409668ada">dbpass</a>, s, <span class="keyword">sizeof</span>(<a class="code" href="res__config__pgsql_8c.html#a6c0213e458980748dc52ffc409668ada">dbpass</a>));
<a name="l01364"></a>01364    }
<a name="l01365"></a>01365 
<a name="l01366"></a>01366    <span class="keywordflow">if</span> (!(s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(config, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;dbhost&quot;</span>))) {
<a name="l01367"></a>01367       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01368"></a>01368             <span class="stringliteral">&quot;PostgreSQL RealTime: No database host found, using localhost via socket.\n&quot;</span>);
<a name="l01369"></a>01369       <a class="code" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01370"></a>01370    } <span class="keywordflow">else</span> {
<a name="l01371"></a>01371       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>, s, <span class="keyword">sizeof</span>(<a class="code" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>));
<a name="l01372"></a>01372    }
<a name="l01373"></a>01373 
<a name="l01374"></a>01374    <span class="keywordflow">if</span> (!(s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(config, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;dbname&quot;</span>))) {
<a name="l01375"></a>01375       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01376"></a>01376             <span class="stringliteral">&quot;PostgreSQL RealTime: No database name found, using &apos;asterisk&apos; as default.\n&quot;</span>);
<a name="l01377"></a>01377       strcpy(<a class="code" href="res__config__pgsql_8c.html#a6904a1f9115898f7691f4e8a405b8b98">dbname</a>, <span class="stringliteral">&quot;asterisk&quot;</span>);
<a name="l01378"></a>01378    } <span class="keywordflow">else</span> {
<a name="l01379"></a>01379       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="res__config__pgsql_8c.html#a6904a1f9115898f7691f4e8a405b8b98">dbname</a>, s, <span class="keyword">sizeof</span>(<a class="code" href="res__config__pgsql_8c.html#a6904a1f9115898f7691f4e8a405b8b98">dbname</a>));
<a name="l01380"></a>01380    }
<a name="l01381"></a>01381 
<a name="l01382"></a>01382    <span class="keywordflow">if</span> (!(s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(config, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;dbport&quot;</span>))) {
<a name="l01383"></a>01383       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01384"></a>01384             <span class="stringliteral">&quot;PostgreSQL RealTime: No database port found, using 5432 as default.\n&quot;</span>);
<a name="l01385"></a>01385       <a class="code" href="res__config__pgsql_8c.html#ad76d37dfe4b000f0e1113be85bf2c41f">dbport</a> = 5432;
<a name="l01386"></a>01386    } <span class="keywordflow">else</span> {
<a name="l01387"></a>01387       <a class="code" href="res__config__pgsql_8c.html#ad76d37dfe4b000f0e1113be85bf2c41f">dbport</a> = atoi(s);
<a name="l01388"></a>01388    }
<a name="l01389"></a>01389 
<a name="l01390"></a>01390    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>)) {
<a name="l01391"></a>01391       <span class="comment">/* No socket needed */</span>
<a name="l01392"></a>01392    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(config, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;dbsock&quot;</span>))) {
<a name="l01393"></a>01393       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01394"></a>01394             <span class="stringliteral">&quot;PostgreSQL RealTime: No database socket found, using &apos;/tmp/pgsql.sock&apos; as default.\n&quot;</span>);
<a name="l01395"></a>01395       strcpy(<a class="code" href="res__config__pgsql_8c.html#ac4ba6066077517f4c70aa20a44d61e8d">dbsock</a>, <span class="stringliteral">&quot;/tmp/pgsql.sock&quot;</span>);
<a name="l01396"></a>01396    } <span class="keywordflow">else</span> {
<a name="l01397"></a>01397       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="res__config__pgsql_8c.html#ac4ba6066077517f4c70aa20a44d61e8d">dbsock</a>, s, <span class="keyword">sizeof</span>(<a class="code" href="res__config__pgsql_8c.html#ac4ba6066077517f4c70aa20a44d61e8d">dbsock</a>));
<a name="l01398"></a>01398    }
<a name="l01399"></a>01399 
<a name="l01400"></a>01400    <span class="keywordflow">if</span> (!(s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(config, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;requirements&quot;</span>))) {
<a name="l01401"></a>01401       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01402"></a>01402             <span class="stringliteral">&quot;PostgreSQL RealTime: no requirements setting found, using &apos;warn&apos; as default.\n&quot;</span>);
<a name="l01403"></a>01403       <a class="code" href="res__config__pgsql_8c.html#a7e2f1debddb2f7bbdddc82ef5aeb0332">requirements</a> = <a class="code" href="res__config__pgsql_8c.html#a5ff73139485369f629981d087e744c90ae34342905ba5c4d85039c4ed6270d924">RQ_WARN</a>;
<a name="l01404"></a>01404    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(s, <span class="stringliteral">&quot;createclose&quot;</span>)) {
<a name="l01405"></a>01405       <a class="code" href="res__config__pgsql_8c.html#a7e2f1debddb2f7bbdddc82ef5aeb0332">requirements</a> = <a class="code" href="res__config__pgsql_8c.html#a5ff73139485369f629981d087e744c90ae58872dc5a003cbc6e19ac835e34c44a">RQ_CREATECLOSE</a>;
<a name="l01406"></a>01406    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(s, <span class="stringliteral">&quot;createchar&quot;</span>)) {
<a name="l01407"></a>01407       <a class="code" href="res__config__pgsql_8c.html#a7e2f1debddb2f7bbdddc82ef5aeb0332">requirements</a> = <a class="code" href="res__config__pgsql_8c.html#a5ff73139485369f629981d087e744c90a4d8c7cc7c92af38dbeae94777bcd612f">RQ_CREATECHAR</a>;
<a name="l01408"></a>01408    }
<a name="l01409"></a>01409 
<a name="l01410"></a>01410    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(config);
<a name="l01411"></a>01411 
<a name="l01412"></a>01412    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>) {
<a name="l01413"></a>01413       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>)) {
<a name="l01414"></a>01414          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime Host: %s\n&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>);
<a name="l01415"></a>01415          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime Port: %i\n&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#ad76d37dfe4b000f0e1113be85bf2c41f">dbport</a>);
<a name="l01416"></a>01416       } <span class="keywordflow">else</span> {
<a name="l01417"></a>01417          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime Socket: %s\n&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#ac4ba6066077517f4c70aa20a44d61e8d">dbsock</a>);
<a name="l01418"></a>01418       }
<a name="l01419"></a>01419       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime User: %s\n&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#a1db90a8699d1255793e9d9accfe04e3c">dbuser</a>);
<a name="l01420"></a>01420       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime Password: %s\n&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#a6c0213e458980748dc52ffc409668ada">dbpass</a>);
<a name="l01421"></a>01421       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime DBName: %s\n&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#a6904a1f9115898f7691f4e8a405b8b98">dbname</a>);
<a name="l01422"></a>01422    }
<a name="l01423"></a>01423 
<a name="l01424"></a>01424    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#ac2ee0af8a28eebbaf6d50a2ba63bd9a6">pgsql_reconnect</a>(NULL)) {
<a name="l01425"></a>01425       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l01426"></a>01426             <span class="stringliteral">&quot;PostgreSQL RealTime: Couldn&apos;t establish connection. Check debug.\n&quot;</span>);
<a name="l01427"></a>01427       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Cannot Connect: %s\n&quot;</span>, PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>));
<a name="l01428"></a>01428    }
<a name="l01429"></a>01429 
<a name="l01430"></a>01430    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;PostgreSQL RealTime reloaded.\n&quot;</span>);
<a name="l01431"></a>01431 
<a name="l01432"></a>01432    <span class="comment">/* Done reloading. Release lock so others can now use driver. */</span>
<a name="l01433"></a>01433    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01434"></a>01434 
<a name="l01435"></a>01435    <span class="keywordflow">return</span> 1;
<a name="l01436"></a>01436 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac2ee0af8a28eebbaf6d50a2ba63bd9a6"></a><!-- doxytag: member="res_config_pgsql.c::pgsql_reconnect" ref="ac2ee0af8a28eebbaf6d50a2ba63bd9a6" args="(const char *database)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int pgsql_reconnect </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>database</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01438">1438</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="strings_8h_source.html#l00477">ast_str_size()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00082">connect_time</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00076">dbhost</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00079">dbname</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00078">dbpass</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00081">dbport</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00080">dbsock</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00077">dbuser</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="strings_8h_source.html#l00072">S_OR</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01030">config_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00938">destroy_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01327">parse_config()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00418">realtime_multi_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00283">realtime_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01125">require_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00846">store_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00714">update2_pgsql()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00576">update_pgsql()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01439"></a>01439 {
<a name="l01440"></a>01440    <span class="keywordtype">char</span> my_database[50];
<a name="l01441"></a>01441 
<a name="l01442"></a>01442    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(my_database, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(database, <a class="code" href="res__config__pgsql_8c.html#a6904a1f9115898f7691f4e8a405b8b98">dbname</a>), <span class="keyword">sizeof</span>(my_database));
<a name="l01443"></a>01443 
<a name="l01444"></a>01444    <span class="comment">/* mutex lock should have been locked before calling this function. */</span>
<a name="l01445"></a>01445 
<a name="l01446"></a>01446    <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> &amp;&amp; PQstatus(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>) != CONNECTION_OK) {
<a name="l01447"></a>01447       PQfinish(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>);
<a name="l01448"></a>01448       <a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> = NULL;
<a name="l01449"></a>01449    }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451    <span class="comment">/* DB password can legitimately be 0-length */</span>
<a name="l01452"></a>01452    <span class="keywordflow">if</span> ((!<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>) &amp;&amp; (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>) || !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="res__config__pgsql_8c.html#ac4ba6066077517f4c70aa20a44d61e8d">dbsock</a>)) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="res__config__pgsql_8c.html#a1db90a8699d1255793e9d9accfe04e3c">dbuser</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(my_database)) {
<a name="l01453"></a>01453       <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *connInfo = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(32);
<a name="l01454"></a>01454 
<a name="l01455"></a>01455       <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;connInfo, 0, <span class="stringliteral">&quot;host=%s port=%d dbname=%s user=%s&quot;</span>,
<a name="l01456"></a>01456          <a class="code" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>, <a class="code" href="res__config__pgsql_8c.html#ad76d37dfe4b000f0e1113be85bf2c41f">dbport</a>, my_database, <a class="code" href="res__config__pgsql_8c.html#a1db90a8699d1255793e9d9accfe04e3c">dbuser</a>);
<a name="l01457"></a>01457       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="res__config__pgsql_8c.html#a6c0213e458980748dc52ffc409668ada">dbpass</a>))
<a name="l01458"></a>01458          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;connInfo, 0, <span class="stringliteral">&quot; password=%s&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#a6c0213e458980748dc52ffc409668ada">dbpass</a>);
<a name="l01459"></a>01459 
<a name="l01460"></a>01460       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%u connInfo=%s\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="strings_8h.html#ab9726d03e7f9f4746876d71bea28de33" title="Returns the current maximum length (without reallocation) of the current buffer.">ast_str_size</a>(connInfo), <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(connInfo));
<a name="l01461"></a>01461       <a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> = PQconnectdb(<a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(connInfo));
<a name="l01462"></a>01462       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%u connInfo=%s\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="strings_8h.html#ab9726d03e7f9f4746876d71bea28de33" title="Returns the current maximum length (without reallocation) of the current buffer.">ast_str_size</a>(connInfo), <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(connInfo));
<a name="l01463"></a>01463       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(connInfo);
<a name="l01464"></a>01464       connInfo = NULL;
<a name="l01465"></a>01465 
<a name="l01466"></a>01466       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;pgsqlConn=%p\n&quot;</span>, <a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>);
<a name="l01467"></a>01467       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> &amp;&amp; PQstatus(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>) == CONNECTION_OK) {
<a name="l01468"></a>01468          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Successfully connected to database.\n&quot;</span>);
<a name="l01469"></a>01469          <a class="code" href="res__config__pgsql_8c.html#ac4ae24c7b766713b82921c04d1a4b699">connect_time</a> = time(NULL);
<a name="l01470"></a>01470          <a class="code" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> = PQserverVersion(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>);
<a name="l01471"></a>01471          <span class="keywordflow">return</span> 1;
<a name="l01472"></a>01472       } <span class="keywordflow">else</span> {
<a name="l01473"></a>01473          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,
<a name="l01474"></a>01474                <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to connect database %s on %s: %s\n&quot;</span>,
<a name="l01475"></a>01475                <a class="code" href="res__config__pgsql_8c.html#a6904a1f9115898f7691f4e8a405b8b98">dbname</a>, <a class="code" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>, PQresultErrorMessage(NULL));
<a name="l01476"></a>01476          <span class="keywordflow">return</span> 0;
<a name="l01477"></a>01477       }
<a name="l01478"></a>01478    } <span class="keywordflow">else</span> {
<a name="l01479"></a>01479       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: One or more of the parameters in the config does not pass our validity checks.\n&quot;</span>);
<a name="l01480"></a>01480       <span class="keywordflow">return</span> 1;
<a name="l01481"></a>01481    }
<a name="l01482"></a>01482 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac271d44246a40ff4832e57492fd58f75"></a><!-- doxytag: member="res_config_pgsql.c::realtime_multi_pgsql" ref="ac271d44246a40ff4832e57492fd58f75" args="(const char *database, const char *table, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__config.html">ast_config</a>* realtime_multi_pgsql </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>table</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00418">418</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="config_8c_source.html#l00522">ast_category_append()</a>, <a class="el" href="config_8c_source.html#l00483">ast_category_new()</a>, <a class="el" href="config_8c_source.html#l00656">ast_category_rename()</a>, <a class="el" href="config_8c_source.html#l00673">ast_config_new()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="strings_8h_source.html#l00637">ast_str_thread_get()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00150">ast_strip()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="config_8c_source.html#l00348">ast_variable_append()</a>, <a class="el" href="config_8c_source.html#l00223">ast_variable_new()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00096">ESCAPE_STRING</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00048">escapebuf_buf</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00044">pgsql_lock</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00045">sql_buf</a>, <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>, and <a class="el" href="ast__expr2f_8c_source.html#l00613">var</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00419"></a>00419 {
<a name="l00420"></a>00420    PGresult *result = NULL;
<a name="l00421"></a>00421    <span class="keywordtype">int</span> num_rows = 0, pgresult;
<a name="l00422"></a>00422    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sql = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#afc4bfa5a94710e6f323a1033f82425b3">sql_buf</a>, 100);
<a name="l00423"></a>00423    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *escapebuf = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#a5276aefbf1d003abafa0b7c7ff5449b9">escapebuf_buf</a>, 100);
<a name="l00424"></a>00424    <span class="keyword">const</span> <span class="keywordtype">char</span> *initfield = NULL;
<a name="l00425"></a>00425    <span class="keywordtype">char</span> *stringp;
<a name="l00426"></a>00426    <span class="keywordtype">char</span> *chunk;
<a name="l00427"></a>00427    <span class="keywordtype">char</span> *op;
<a name="l00428"></a>00428    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00429"></a>00429    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a> = NULL;
<a name="l00430"></a>00430    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg = NULL;
<a name="l00431"></a>00431    <span class="keyword">struct </span><a class="code" href="structast__category.html">ast_category</a> *cat = NULL;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433    <span class="keywordflow">if</span> (!<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>) {
<a name="l00434"></a>00434       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;PostgreSQL RealTime: No table specified.\n&quot;</span>);
<a name="l00435"></a>00435       <span class="keywordflow">return</span> NULL;
<a name="l00436"></a>00436    }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8h.html#a45e1a284d7d84c4b4a316764fbb887fb" title="Create a new base configuration structure.">ast_config_new</a>()))
<a name="l00439"></a>00439       <span class="keywordflow">return</span> NULL;
<a name="l00440"></a>00440 
<a name="l00441"></a>00441    <span class="comment">/* Get the first parameter and first value in our list of passed paramater/value pairs */</span>
<a name="l00442"></a>00442    newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00443"></a>00443    newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00444"></a>00444    <span class="keywordflow">if</span> (!newparam || !newval) {
<a name="l00445"></a>00445       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00446"></a>00446             <span class="stringliteral">&quot;PostgreSQL RealTime: Realtime retrieval requires at least 1 parameter and 1 value to search on.\n&quot;</span>);
<a name="l00447"></a>00447       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>) {
<a name="l00448"></a>00448          PQfinish(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>);
<a name="l00449"></a>00449          <a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> = NULL;
<a name="l00450"></a>00450       }
<a name="l00451"></a>00451       <span class="keywordflow">return</span> NULL;
<a name="l00452"></a>00452    }
<a name="l00453"></a>00453 
<a name="l00454"></a>00454    initfield = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(newparam);
<a name="l00455"></a>00455    <span class="keywordflow">if</span> ((op = strchr(initfield, <span class="charliteral">&apos; &apos;</span>))) {
<a name="l00456"></a>00456       *op = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00457"></a>00457    }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459    <span class="comment">/* Create the first part of the query using the first parameter/value pairs we just extracted</span>
<a name="l00460"></a>00460 <span class="comment">      If there is only 1 set, then we have our query. Otherwise, loop thru the list and concat */</span>
<a name="l00461"></a>00461 
<a name="l00462"></a>00462    <span class="keywordflow">if</span> (!strchr(newparam, <span class="charliteral">&apos; &apos;</span>))
<a name="l00463"></a>00463       op = <span class="stringliteral">&quot; =&quot;</span>;
<a name="l00464"></a>00464    <span class="keywordflow">else</span>
<a name="l00465"></a>00465       op = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467    <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(escapebuf, newval);
<a name="l00468"></a>00468    <span class="keywordflow">if</span> (pgresult) {
<a name="l00469"></a>00469       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Postgres detected invalid input: &apos;%s&apos;\n&quot;</span>, newval);
<a name="l00470"></a>00470       va_end(ap);
<a name="l00471"></a>00471       <span class="keywordflow">return</span> NULL;
<a name="l00472"></a>00472    }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql, 0, <span class="stringliteral">&quot;SELECT * FROM %s WHERE %s%s &apos;%s&apos;&quot;</span>, <a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, newparam, op, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(escapebuf));
<a name="l00475"></a>00475    <span class="keywordflow">while</span> ((newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l00476"></a>00476       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00477"></a>00477       <span class="keywordflow">if</span> (!strchr(newparam, <span class="charliteral">&apos; &apos;</span>))
<a name="l00478"></a>00478          op = <span class="stringliteral">&quot; =&quot;</span>;
<a name="l00479"></a>00479       <span class="keywordflow">else</span>
<a name="l00480"></a>00480          op = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482       <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(escapebuf, newval);
<a name="l00483"></a>00483       <span class="keywordflow">if</span> (pgresult) {
<a name="l00484"></a>00484          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Postgres detected invalid input: &apos;%s&apos;\n&quot;</span>, newval);
<a name="l00485"></a>00485          va_end(ap);
<a name="l00486"></a>00486          <span class="keywordflow">return</span> NULL;
<a name="l00487"></a>00487       }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql, 0, <span class="stringliteral">&quot; AND %s%s &apos;%s&apos;&quot;</span>, newparam, op, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(escapebuf));
<a name="l00490"></a>00490    }
<a name="l00491"></a>00491 
<a name="l00492"></a>00492    <span class="keywordflow">if</span> (initfield) {
<a name="l00493"></a>00493       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql, 0, <span class="stringliteral">&quot; ORDER BY %s&quot;</span>, initfield);
<a name="l00494"></a>00494    }
<a name="l00495"></a>00495 
<a name="l00496"></a>00496    va_end(ap);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498    <span class="comment">/* We now have our complete statement; Lets connect to the server and execute it. */</span>
<a name="l00499"></a>00499    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00500"></a>00500    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#ac2ee0af8a28eebbaf6d50a2ba63bd9a6">pgsql_reconnect</a>(database)) {
<a name="l00501"></a>00501       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00502"></a>00502       <span class="keywordflow">return</span> NULL;
<a name="l00503"></a>00503    }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505    <span class="keywordflow">if</span> (!(result = PQexec(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql)))) {
<a name="l00506"></a>00506       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00507"></a>00507             <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query %s@%s. Check debug for more info.\n&quot;</span>, <a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, database);
<a name="l00508"></a>00508       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00509"></a>00509       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s\n&quot;</span>, PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>));
<a name="l00510"></a>00510       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00511"></a>00511       <span class="keywordflow">return</span> NULL;
<a name="l00512"></a>00512    } <span class="keywordflow">else</span> {
<a name="l00513"></a>00513       ExecStatusType result_status = PQresultStatus(result);
<a name="l00514"></a>00514       <span class="keywordflow">if</span> (result_status != PGRES_COMMAND_OK
<a name="l00515"></a>00515          &amp;&amp; result_status != PGRES_TUPLES_OK
<a name="l00516"></a>00516          &amp;&amp; result_status != PGRES_NONFATAL_ERROR) {
<a name="l00517"></a>00517          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00518"></a>00518                <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query %s@%s. Check debug for more info.\n&quot;</span>, <a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, database);
<a name="l00519"></a>00519          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00520"></a>00520          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s (%s)\n&quot;</span>,
<a name="l00521"></a>00521                   PQresultErrorMessage(result), PQresStatus(result_status));
<a name="l00522"></a>00522          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00523"></a>00523          <span class="keywordflow">return</span> NULL;
<a name="l00524"></a>00524       }
<a name="l00525"></a>00525    }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Result=%p Query: %s\n&quot;</span>, result, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00528"></a>00528 
<a name="l00529"></a>00529    <span class="keywordflow">if</span> ((num_rows = PQntuples(result)) &gt; 0) {
<a name="l00530"></a>00530       <span class="keywordtype">int</span> numFields = PQnfields(result);
<a name="l00531"></a>00531       <span class="keywordtype">int</span> i = 0;
<a name="l00532"></a>00532       <span class="keywordtype">int</span> rowIndex = 0;
<a name="l00533"></a>00533       <span class="keywordtype">char</span> **fieldnames = NULL;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Found %d rows.\n&quot;</span>, num_rows);
<a name="l00536"></a>00536 
<a name="l00537"></a>00537       <span class="keywordflow">if</span> (!(fieldnames = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, numFields * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *)))) {
<a name="l00538"></a>00538          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00539"></a>00539          PQclear(result);
<a name="l00540"></a>00540          <span class="keywordflow">return</span> NULL;
<a name="l00541"></a>00541       }
<a name="l00542"></a>00542       <span class="keywordflow">for</span> (i = 0; i &lt; numFields; i++)
<a name="l00543"></a>00543          fieldnames[i] = PQfname(result, i);
<a name="l00544"></a>00544 
<a name="l00545"></a>00545       <span class="keywordflow">for</span> (rowIndex = 0; rowIndex &lt; num_rows; rowIndex++) {
<a name="l00546"></a>00546          var = NULL;
<a name="l00547"></a>00547          <span class="keywordflow">if</span> (!(cat = <a class="code" href="config_8h.html#affebac76d69639677b677037d9871e29" title="Create a category structure.">ast_category_new</a>(<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;&quot;</span>,99999)))
<a name="l00548"></a>00548             <span class="keywordflow">continue</span>;
<a name="l00549"></a>00549          <span class="keywordflow">for</span> (i = 0; i &lt; numFields; i++) {
<a name="l00550"></a>00550             stringp = PQgetvalue(result, rowIndex, i);
<a name="l00551"></a>00551             <span class="keywordflow">while</span> (stringp) {
<a name="l00552"></a>00552                chunk = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;;&quot;</span>);
<a name="l00553"></a>00553                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="strings_8h.html#aeb1c54e6e100c63176d8e22b0d5ca865" title="Strip leading/trailing whitespace from a string.">ast_strip</a>(chunk))) {
<a name="l00554"></a>00554                   <span class="keywordflow">if</span> (initfield &amp;&amp; !strcmp(initfield, fieldnames[i])) {
<a name="l00555"></a>00555                      <a class="code" href="config_8h.html#a2a5612ff8eb3595c1be1df75be4d870f">ast_category_rename</a>(cat, chunk);
<a name="l00556"></a>00556                   }
<a name="l00557"></a>00557                   var = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(fieldnames[i], chunk, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00558"></a>00558                   <a class="code" href="config_8h.html#a132ddbd39dd9d26395c410f7647f76db">ast_variable_append</a>(cat, var);
<a name="l00559"></a>00559                }
<a name="l00560"></a>00560             }
<a name="l00561"></a>00561          }
<a name="l00562"></a>00562          <a class="code" href="config_8h.html#ab7b56ec66b058952423f313752c734e7">ast_category_append</a>(cfg, cat);
<a name="l00563"></a>00563       }
<a name="l00564"></a>00564       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fieldnames);
<a name="l00565"></a>00565    } <span class="keywordflow">else</span> {
<a name="l00566"></a>00566       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00567"></a>00567             <span class="stringliteral">&quot;PostgreSQL RealTime: Could not find any rows in table %s.\n&quot;</span>, <a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>);
<a name="l00568"></a>00568    }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00571"></a>00571    PQclear(result);
<a name="l00572"></a>00572 
<a name="l00573"></a>00573    <span class="keywordflow">return</span> cfg;
<a name="l00574"></a>00574 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a02d5b855c8351705b09cc2bb1da50d20"></a><!-- doxytag: member="res_config_pgsql.c::realtime_pgsql" ref="a02d5b855c8351705b09cc2bb1da50d20" args="(const char *database, const char *tablename, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__variable.html">ast_variable</a>* realtime_pgsql </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>tablename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00283">283</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="strings_8h_source.html#l00637">ast_str_thread_get()</a>, <a class="el" href="strings_8h_source.html#l00150">ast_strip()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="config_8c_source.html#l00223">ast_variable_new()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00096">ESCAPE_STRING</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00048">escapebuf_buf</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00044">pgsql_lock</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00045">sql_buf</a>, <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>, and <a class="el" href="ast__expr2f_8c_source.html#l00613">var</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00284"></a>00284 {
<a name="l00285"></a>00285    PGresult *result = NULL;
<a name="l00286"></a>00286    <span class="keywordtype">int</span> num_rows = 0, pgresult;
<a name="l00287"></a>00287    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sql = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#afc4bfa5a94710e6f323a1033f82425b3">sql_buf</a>, 100);
<a name="l00288"></a>00288    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *escapebuf = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#a5276aefbf1d003abafa0b7c7ff5449b9">escapebuf_buf</a>, 100);
<a name="l00289"></a>00289    <span class="keywordtype">char</span> *stringp;
<a name="l00290"></a>00290    <span class="keywordtype">char</span> *chunk;
<a name="l00291"></a>00291    <span class="keywordtype">char</span> *op;
<a name="l00292"></a>00292    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00293"></a>00293    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a> = NULL, *prev = NULL;
<a name="l00294"></a>00294 
<a name="l00295"></a>00295    <span class="keywordflow">if</span> (!tablename) {
<a name="l00296"></a>00296       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;PostgreSQL RealTime: No table specified.\n&quot;</span>);
<a name="l00297"></a>00297       <span class="keywordflow">return</span> NULL;
<a name="l00298"></a>00298    }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300    <span class="comment">/* Get the first parameter and first value in our list of passed paramater/value pairs */</span>
<a name="l00301"></a>00301    newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00302"></a>00302    newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00303"></a>00303    <span class="keywordflow">if</span> (!newparam || !newval) {
<a name="l00304"></a>00304       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00305"></a>00305             <span class="stringliteral">&quot;PostgreSQL RealTime: Realtime retrieval requires at least 1 parameter and 1 value to search on.\n&quot;</span>);
<a name="l00306"></a>00306       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>) {
<a name="l00307"></a>00307          PQfinish(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>);
<a name="l00308"></a>00308          <a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> = NULL;
<a name="l00309"></a>00309       }
<a name="l00310"></a>00310       <span class="keywordflow">return</span> NULL;
<a name="l00311"></a>00311    }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313    <span class="comment">/* Create the first part of the query using the first parameter/value pairs we just extracted</span>
<a name="l00314"></a>00314 <span class="comment">      If there is only 1 set, then we have our query. Otherwise, loop thru the list and concat */</span>
<a name="l00315"></a>00315    op = strchr(newparam, <span class="charliteral">&apos; &apos;</span>) ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot; =&quot;</span>;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317    <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(escapebuf, newval);
<a name="l00318"></a>00318    <span class="keywordflow">if</span> (pgresult) {
<a name="l00319"></a>00319       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Postgres detected invalid input: &apos;%s&apos;\n&quot;</span>, newval);
<a name="l00320"></a>00320       va_end(ap);
<a name="l00321"></a>00321       <span class="keywordflow">return</span> NULL;
<a name="l00322"></a>00322    }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql, 0, <span class="stringliteral">&quot;SELECT * FROM %s WHERE %s%s &apos;%s&apos;&quot;</span>, tablename, newparam, op, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(escapebuf));
<a name="l00325"></a>00325    <span class="keywordflow">while</span> ((newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l00326"></a>00326       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00327"></a>00327       <span class="keywordflow">if</span> (!strchr(newparam, <span class="charliteral">&apos; &apos;</span>))
<a name="l00328"></a>00328          op = <span class="stringliteral">&quot; =&quot;</span>;
<a name="l00329"></a>00329       <span class="keywordflow">else</span>
<a name="l00330"></a>00330          op = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00331"></a>00331 
<a name="l00332"></a>00332       <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(escapebuf, newval);
<a name="l00333"></a>00333       <span class="keywordflow">if</span> (pgresult) {
<a name="l00334"></a>00334          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Postgres detected invalid input: &apos;%s&apos;\n&quot;</span>, newval);
<a name="l00335"></a>00335          va_end(ap);
<a name="l00336"></a>00336          <span class="keywordflow">return</span> NULL;
<a name="l00337"></a>00337       }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql, 0, <span class="stringliteral">&quot; AND %s%s &apos;%s&apos;&quot;</span>, newparam, op, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(escapebuf));
<a name="l00340"></a>00340    }
<a name="l00341"></a>00341    va_end(ap);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343    <span class="comment">/* We now have our complete statement; Lets connect to the server and execute it. */</span>
<a name="l00344"></a>00344    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00345"></a>00345    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#ac2ee0af8a28eebbaf6d50a2ba63bd9a6">pgsql_reconnect</a>(database)) {
<a name="l00346"></a>00346       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00347"></a>00347       <span class="keywordflow">return</span> NULL;
<a name="l00348"></a>00348    }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350    <span class="keywordflow">if</span> (!(result = PQexec(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql)))) {
<a name="l00351"></a>00351       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00352"></a>00352             <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query &apos;%s@%s&apos;. Check debug for more info.\n&quot;</span>, tablename, database);
<a name="l00353"></a>00353       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00354"></a>00354       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s\n&quot;</span>, PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>));
<a name="l00355"></a>00355       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00356"></a>00356       <span class="keywordflow">return</span> NULL;
<a name="l00357"></a>00357    } <span class="keywordflow">else</span> {
<a name="l00358"></a>00358       ExecStatusType result_status = PQresultStatus(result);
<a name="l00359"></a>00359       <span class="keywordflow">if</span> (result_status != PGRES_COMMAND_OK
<a name="l00360"></a>00360          &amp;&amp; result_status != PGRES_TUPLES_OK
<a name="l00361"></a>00361          &amp;&amp; result_status != PGRES_NONFATAL_ERROR) {
<a name="l00362"></a>00362          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00363"></a>00363                <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query &apos;%s@%s&apos;. Check debug for more info.\n&quot;</span>, tablename, database);
<a name="l00364"></a>00364          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00365"></a>00365          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s (%s)\n&quot;</span>,
<a name="l00366"></a>00366                   PQresultErrorMessage(result), PQresStatus(result_status));
<a name="l00367"></a>00367          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00368"></a>00368          <span class="keywordflow">return</span> NULL;
<a name="l00369"></a>00369       }
<a name="l00370"></a>00370    }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Result=%p Query: %s\n&quot;</span>, result, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00373"></a>00373 
<a name="l00374"></a>00374    <span class="keywordflow">if</span> ((num_rows = PQntuples(result)) &gt; 0) {
<a name="l00375"></a>00375       <span class="keywordtype">int</span> i = 0;
<a name="l00376"></a>00376       <span class="keywordtype">int</span> rowIndex = 0;
<a name="l00377"></a>00377       <span class="keywordtype">int</span> numFields = PQnfields(result);
<a name="l00378"></a>00378       <span class="keywordtype">char</span> **fieldnames = NULL;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Found %d rows.\n&quot;</span>, num_rows);
<a name="l00381"></a>00381 
<a name="l00382"></a>00382       <span class="keywordflow">if</span> (!(fieldnames = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, numFields * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *)))) {
<a name="l00383"></a>00383          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00384"></a>00384          PQclear(result);
<a name="l00385"></a>00385          <span class="keywordflow">return</span> NULL;
<a name="l00386"></a>00386       }
<a name="l00387"></a>00387       <span class="keywordflow">for</span> (i = 0; i &lt; numFields; i++)
<a name="l00388"></a>00388          fieldnames[i] = PQfname(result, i);
<a name="l00389"></a>00389       <span class="keywordflow">for</span> (rowIndex = 0; rowIndex &lt; num_rows; rowIndex++) {
<a name="l00390"></a>00390          <span class="keywordflow">for</span> (i = 0; i &lt; numFields; i++) {
<a name="l00391"></a>00391             stringp = PQgetvalue(result, rowIndex, i);
<a name="l00392"></a>00392             <span class="keywordflow">while</span> (stringp) {
<a name="l00393"></a>00393                chunk = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;;&quot;</span>);
<a name="l00394"></a>00394                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="strings_8h.html#aeb1c54e6e100c63176d8e22b0d5ca865" title="Strip leading/trailing whitespace from a string.">ast_strip</a>(chunk))) {
<a name="l00395"></a>00395                   <span class="keywordflow">if</span> (prev) {
<a name="l00396"></a>00396                      prev-&gt;next = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(fieldnames[i], chunk, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00397"></a>00397                      <span class="keywordflow">if</span> (prev-&gt;next) {
<a name="l00398"></a>00398                         prev = prev-&gt;next;
<a name="l00399"></a>00399                      }
<a name="l00400"></a>00400                   } <span class="keywordflow">else</span> {
<a name="l00401"></a>00401                      prev = var = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(fieldnames[i], chunk, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00402"></a>00402                   }
<a name="l00403"></a>00403                }
<a name="l00404"></a>00404             }
<a name="l00405"></a>00405          }
<a name="l00406"></a>00406       }
<a name="l00407"></a>00407       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fieldnames);
<a name="l00408"></a>00408    } <span class="keywordflow">else</span> {
<a name="l00409"></a>00409       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Postgresql RealTime: Could not find any rows in table %s@%s.\n&quot;</span>, tablename, database);
<a name="l00410"></a>00410    }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00413"></a>00413    PQclear(result);
<a name="l00414"></a>00414 
<a name="l00415"></a>00415    <span class="keywordflow">return</span> var;
<a name="l00416"></a>00416 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad1982509765f4870f1f63412a53ea668"></a><!-- doxytag: member="res_config_pgsql.c::reload" ref="ad1982509765f4870f1f63412a53ea668" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int reload </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01320">1320</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="res__config__pgsql_8c_source.html#l01327">parse_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01321"></a>01321 {
<a name="l01322"></a>01322    <a class="code" href="res__config__pgsql_8c.html#a0dc068d63cb9df28d4b885bb7b5c5560">parse_config</a>(1);
<a name="l01323"></a>01323 
<a name="l01324"></a>01324    <span class="keywordflow">return</span> 0;
<a name="l01325"></a>01325 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac969b3fee6a0925f75d328ab19b9bd53"></a><!-- doxytag: member="res_config_pgsql.c::require_pgsql" ref="ac969b3fee6a0925f75d328ab19b9bd53" args="(const char *database, const char *tablename, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int require_pgsql </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>tablename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01125">1125</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="structtables.html#acc878587149a78a26fa030feaae016ed">tables::columns</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00117">find_table()</a>, <a class="el" href="cdr__pgsql_8c_source.html#l00068">columns::len</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00058">columns::name</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00044">pgsql_lock</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00268">release_table</a>, <a class="el" href="res__config__pgsql_8c.html#a7e2f1debddb2f7bbdddc82ef5aeb0332">requirements</a>, <a class="el" href="config_8h_source.html#l00066">RQ_CHAR</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00089">RQ_CREATECHAR</a>, <a class="el" href="config_8h_source.html#l00068">RQ_DATE</a>, <a class="el" href="config_8h_source.html#l00069">RQ_DATETIME</a>, <a class="el" href="config_8h_source.html#l00067">RQ_FLOAT</a>, <a class="el" href="config_8h_source.html#l00056">RQ_INTEGER1</a>, <a class="el" href="config_8h_source.html#l00058">RQ_INTEGER2</a>, <a class="el" href="config_8h_source.html#l00060">RQ_INTEGER3</a>, <a class="el" href="config_8h_source.html#l00062">RQ_INTEGER4</a>, <a class="el" href="config_8h_source.html#l00064">RQ_INTEGER8</a>, <a class="el" href="config_8h_source.html#l00057">RQ_UINTEGER1</a>, <a class="el" href="config_8h_source.html#l00059">RQ_UINTEGER2</a>, <a class="el" href="config_8h_source.html#l00061">RQ_UINTEGER3</a>, <a class="el" href="config_8h_source.html#l00063">RQ_UINTEGER4</a>, <a class="el" href="config_8h_source.html#l00065">RQ_UINTEGER8</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00089">RQ_WARN</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00063">columns::size</a>, <a class="el" href="cdr__odbc_8c_source.html#l00052">table</a>, and <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00062">columns::type</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01126"></a>01126 {
<a name="l01127"></a>01127    <span class="keyword">struct </span><a class="code" href="structcolumns.html">columns</a> *column;
<a name="l01128"></a>01128    <span class="keyword">struct </span><a class="code" href="structtables.html">tables</a> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a> = <a class="code" href="res__config__pgsql_8c.html#aaeb0f59e00eee1f4c11c427865821127">find_table</a>(tablename);
<a name="l01129"></a>01129    <span class="keywordtype">char</span> *elm;
<a name="l01130"></a>01130    <span class="keywordtype">int</span> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, size, res = 0;
<a name="l01131"></a>01131 
<a name="l01132"></a>01132    <span class="keywordflow">if</span> (!table) {
<a name="l01133"></a>01133       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Table %s not found in database.  This table should exist if you&apos;re using realtime.\n&quot;</span>, tablename);
<a name="l01134"></a>01134       <span class="keywordflow">return</span> -1;
<a name="l01135"></a>01135    }
<a name="l01136"></a>01136 
<a name="l01137"></a>01137    <span class="keywordflow">while</span> ((elm = va_arg(ap, <span class="keywordtype">char</span> *))) {
<a name="l01138"></a>01138       type = va_arg(ap, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3" title="Types used in ast_realtime_require_field.">require_type</a>);
<a name="l01139"></a>01139       size = va_arg(ap, <span class="keywordtype">int</span>);
<a name="l01140"></a>01140       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;table-&gt;<a class="code" href="structtables.html#acc878587149a78a26fa030feaae016ed">columns</a>, column, <a class="code" href="structtables.html#a820ea34b748e7d4cd60f0ceae9b0355d">list</a>) {
<a name="l01141"></a>01141          <span class="keywordflow">if</span> (strcmp(column-&gt;<a class="code" href="structcolumns.html#ad547fb8186b526cb1b588daad4334fbe">name</a>, elm) == 0) {
<a name="l01142"></a>01142             <span class="comment">/* Char can hold anything, as long as it is large enough */</span>
<a name="l01143"></a>01143             <span class="keywordflow">if</span> ((strncmp(column-&gt;<a class="code" href="structcolumns.html#a6daaf29b293f2cd25c794dcdd95f2d63">type</a>, <span class="stringliteral">&quot;char&quot;</span>, 4) == 0 || strncmp(column-&gt;<a class="code" href="structcolumns.html#a6daaf29b293f2cd25c794dcdd95f2d63">type</a>, <span class="stringliteral">&quot;varchar&quot;</span>, 7) == 0 || strcmp(column-&gt;<a class="code" href="structcolumns.html#a6daaf29b293f2cd25c794dcdd95f2d63">type</a>, <span class="stringliteral">&quot;bpchar&quot;</span>) == 0)) {
<a name="l01144"></a>01144                <span class="keywordflow">if</span> ((size &gt; column-&gt;<a class="code" href="structcolumns.html#afed088663f8704004425cdae2120b9b3">len</a>) &amp;&amp; column-&gt;<a class="code" href="structcolumns.html#afed088663f8704004425cdae2120b9b3">len</a> != -1) {
<a name="l01145"></a>01145                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Column &apos;%s&apos; should be at least %d long, but is only %d long.\n&quot;</span>, column-&gt;<a class="code" href="structcolumns.html#ad547fb8186b526cb1b588daad4334fbe">name</a>, size, column-&gt;<a class="code" href="structcolumns.html#afed088663f8704004425cdae2120b9b3">len</a>);
<a name="l01146"></a>01146                   res = -1;
<a name="l01147"></a>01147                }
<a name="l01148"></a>01148             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(column-&gt;<a class="code" href="structcolumns.html#a6daaf29b293f2cd25c794dcdd95f2d63">type</a>, <span class="stringliteral">&quot;int&quot;</span>, 3) == 0) {
<a name="l01149"></a>01149                <span class="keywordtype">int</span> typesize = atoi(column-&gt;<a class="code" href="structcolumns.html#a6daaf29b293f2cd25c794dcdd95f2d63">type</a> + 3);
<a name="l01150"></a>01150                <span class="comment">/* Integers can hold only other integers */</span>
<a name="l01151"></a>01151                <span class="keywordflow">if</span> ((type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3aaa7be840b4634cc84021f0c20a17275b">RQ_INTEGER8</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a2e4fb4c24a3958e2fbd853d5c53cfbb4">RQ_UINTEGER8</a> ||
<a name="l01152"></a>01152                   type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a8a9fbbd166ee4918cec8c9303fde70e8">RQ_INTEGER4</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a27acda71d87003db19a6e0b4193a32be">RQ_UINTEGER4</a> ||
<a name="l01153"></a>01153                   type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a75d046b2f103381a62aeb81f42550404">RQ_INTEGER3</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3ad3163600ec26815e26092d9eb3e4b0b5">RQ_UINTEGER3</a> ||
<a name="l01154"></a>01154                   type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1ab15af464bf1838c9ca91d32ca7a2a1">RQ_UINTEGER2</a>) &amp;&amp; typesize == 2) {
<a name="l01155"></a>01155                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Column &apos;%s&apos; may not be large enough for the required data length: %d\n&quot;</span>, column-&gt;<a class="code" href="structcolumns.html#ad547fb8186b526cb1b588daad4334fbe">name</a>, size);
<a name="l01156"></a>01156                   res = -1;
<a name="l01157"></a>01157                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3aaa7be840b4634cc84021f0c20a17275b">RQ_INTEGER8</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a2e4fb4c24a3958e2fbd853d5c53cfbb4">RQ_UINTEGER8</a> ||
<a name="l01158"></a>01158                   type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a27acda71d87003db19a6e0b4193a32be">RQ_UINTEGER4</a>) &amp;&amp; typesize == 4) {
<a name="l01159"></a>01159                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Column &apos;%s&apos; may not be large enough for the required data length: %d\n&quot;</span>, column-&gt;<a class="code" href="structcolumns.html#ad547fb8186b526cb1b588daad4334fbe">name</a>, size);
<a name="l01160"></a>01160                   res = -1;
<a name="l01161"></a>01161                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3acf1d0ae3a1d0e3ae12a1f05f485f07c9">RQ_DATETIME</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1133e08bb8b498770188f728ca03e417">RQ_FLOAT</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a3d3293675f377a4398a25974cba3e7e1">RQ_DATE</a>) {
<a name="l01162"></a>01162                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Column &apos;%s&apos; is of the incorrect type: (need %s(%d) but saw %s)\n&quot;</span>,
<a name="l01163"></a>01163                      column-&gt;<a class="code" href="structcolumns.html#ad547fb8186b526cb1b588daad4334fbe">name</a>,
<a name="l01164"></a>01164                         type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a> ? <span class="stringliteral">&quot;char&quot;</span> :
<a name="l01165"></a>01165                         type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3acf1d0ae3a1d0e3ae12a1f05f485f07c9">RQ_DATETIME</a> ? <span class="stringliteral">&quot;datetime&quot;</span> :
<a name="l01166"></a>01166                         type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a3d3293675f377a4398a25974cba3e7e1">RQ_DATE</a> ? <span class="stringliteral">&quot;date&quot;</span> :
<a name="l01167"></a>01167                         type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1133e08bb8b498770188f728ca03e417">RQ_FLOAT</a> ? <span class="stringliteral">&quot;float&quot;</span> :
<a name="l01168"></a>01168                         <span class="stringliteral">&quot;a rather stiff drink &quot;</span>,
<a name="l01169"></a>01169                      size, column-&gt;<a class="code" href="structcolumns.html#a6daaf29b293f2cd25c794dcdd95f2d63">type</a>);
<a name="l01170"></a>01170                   res = -1;
<a name="l01171"></a>01171                }
<a name="l01172"></a>01172             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(column-&gt;<a class="code" href="structcolumns.html#a6daaf29b293f2cd25c794dcdd95f2d63">type</a>, <span class="stringliteral">&quot;float&quot;</span>, 5) == 0 &amp;&amp; !ast_rq_is_int(type) &amp;&amp; type != <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1133e08bb8b498770188f728ca03e417">RQ_FLOAT</a>) {
<a name="l01173"></a>01173                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Column %s cannot be a %s\n&quot;</span>, column-&gt;<a class="code" href="structcolumns.html#ad547fb8186b526cb1b588daad4334fbe">name</a>, column-&gt;<a class="code" href="structcolumns.html#a6daaf29b293f2cd25c794dcdd95f2d63">type</a>);
<a name="l01174"></a>01174                res = -1;
<a name="l01175"></a>01175             } <span class="keywordflow">else</span> { <span class="comment">/* There are other types that no module implements yet */</span>
<a name="l01176"></a>01176                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Possibly unsupported column type &apos;%s&apos; on column &apos;%s&apos;\n&quot;</span>, column-&gt;<a class="code" href="structcolumns.html#a6daaf29b293f2cd25c794dcdd95f2d63">type</a>, column-&gt;<a class="code" href="structcolumns.html#ad547fb8186b526cb1b588daad4334fbe">name</a>);
<a name="l01177"></a>01177                res = -1;
<a name="l01178"></a>01178             }
<a name="l01179"></a>01179             <span class="keywordflow">break</span>;
<a name="l01180"></a>01180          }
<a name="l01181"></a>01181       }
<a name="l01182"></a>01182 
<a name="l01183"></a>01183       <span class="keywordflow">if</span> (!column) {
<a name="l01184"></a>01184          <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a7e2f1debddb2f7bbdddc82ef5aeb0332">requirements</a> == <a class="code" href="res__config__pgsql_8c.html#a5ff73139485369f629981d087e744c90ae34342905ba5c4d85039c4ed6270d924">RQ_WARN</a>) {
<a name="l01185"></a>01185             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Table %s requires a column &apos;%s&apos; of size &apos;%d&apos;, but no such column exists.\n&quot;</span>, tablename, elm, size);
<a name="l01186"></a>01186          } <span class="keywordflow">else</span> {
<a name="l01187"></a>01187             <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sql = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(100);
<a name="l01188"></a>01188             <span class="keywordtype">char</span> fieldtype[15];
<a name="l01189"></a>01189             PGresult *result;
<a name="l01190"></a>01190 
<a name="l01191"></a>01191             <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a7e2f1debddb2f7bbdddc82ef5aeb0332">requirements</a> == <a class="code" href="res__config__pgsql_8c.html#a5ff73139485369f629981d087e744c90a4d8c7cc7c92af38dbeae94777bcd612f">RQ_CREATECHAR</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a>) {
<a name="l01192"></a>01192                <span class="comment">/* Size is minimum length; make it at least 50% greater,</span>
<a name="l01193"></a>01193 <span class="comment">                * just to be sure, because PostgreSQL doesn&apos;t support</span>
<a name="l01194"></a>01194 <span class="comment">                * resizing columns. */</span>
<a name="l01195"></a>01195                snprintf(fieldtype, <span class="keyword">sizeof</span>(fieldtype), <span class="stringliteral">&quot;CHAR(%d)&quot;</span>,
<a name="l01196"></a>01196                   size &lt; 15 ? size * 2 :
<a name="l01197"></a>01197                   (size * 3 / 2 &gt; 255) ? 255 : size * 3 / 2);
<a name="l01198"></a>01198             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a7b4a9e81298a296d3e066ed369727cc4">RQ_INTEGER1</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3ae8c94d6fa08e17f6f86792727b201bf9">RQ_UINTEGER1</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3af1d7dd0d3aacafdef0d2f0d2db6d7112">RQ_INTEGER2</a>) {
<a name="l01199"></a>01199                snprintf(fieldtype, <span class="keyword">sizeof</span>(fieldtype), <span class="stringliteral">&quot;INT2&quot;</span>);
<a name="l01200"></a>01200             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1ab15af464bf1838c9ca91d32ca7a2a1">RQ_UINTEGER2</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a75d046b2f103381a62aeb81f42550404">RQ_INTEGER3</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3ad3163600ec26815e26092d9eb3e4b0b5">RQ_UINTEGER3</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a8a9fbbd166ee4918cec8c9303fde70e8">RQ_INTEGER4</a>) {
<a name="l01201"></a>01201                snprintf(fieldtype, <span class="keyword">sizeof</span>(fieldtype), <span class="stringliteral">&quot;INT4&quot;</span>);
<a name="l01202"></a>01202             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a27acda71d87003db19a6e0b4193a32be">RQ_UINTEGER4</a> || type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3aaa7be840b4634cc84021f0c20a17275b">RQ_INTEGER8</a>) {
<a name="l01203"></a>01203                snprintf(fieldtype, <span class="keyword">sizeof</span>(fieldtype), <span class="stringliteral">&quot;INT8&quot;</span>);
<a name="l01204"></a>01204             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a2e4fb4c24a3958e2fbd853d5c53cfbb4">RQ_UINTEGER8</a>) {
<a name="l01205"></a>01205                <span class="comment">/* No such type on PostgreSQL */</span>
<a name="l01206"></a>01206                snprintf(fieldtype, <span class="keyword">sizeof</span>(fieldtype), <span class="stringliteral">&quot;CHAR(20)&quot;</span>);
<a name="l01207"></a>01207             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1133e08bb8b498770188f728ca03e417">RQ_FLOAT</a>) {
<a name="l01208"></a>01208                snprintf(fieldtype, <span class="keyword">sizeof</span>(fieldtype), <span class="stringliteral">&quot;FLOAT8&quot;</span>);
<a name="l01209"></a>01209             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a3d3293675f377a4398a25974cba3e7e1">RQ_DATE</a>) {
<a name="l01210"></a>01210                snprintf(fieldtype, <span class="keyword">sizeof</span>(fieldtype), <span class="stringliteral">&quot;DATE&quot;</span>);
<a name="l01211"></a>01211             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3acf1d0ae3a1d0e3ae12a1f05f485f07c9">RQ_DATETIME</a>) {
<a name="l01212"></a>01212                snprintf(fieldtype, <span class="keyword">sizeof</span>(fieldtype), <span class="stringliteral">&quot;TIMESTAMP&quot;</span>);
<a name="l01213"></a>01213             } <span class="keywordflow">else</span> {
<a name="l01214"></a>01214                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unrecognized request type %d\n&quot;</span>, type);
<a name="l01215"></a>01215                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sql);
<a name="l01216"></a>01216                <span class="keywordflow">continue</span>;
<a name="l01217"></a>01217             }
<a name="l01218"></a>01218             <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql, 0, <span class="stringliteral">&quot;ALTER TABLE %s ADD COLUMN %s %s&quot;</span>, tablename, elm, fieldtype);
<a name="l01219"></a>01219             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;About to lock pgsql_lock (running alter on table &apos;%s&apos; to add column &apos;%s&apos;)\n&quot;</span>, tablename, elm);
<a name="l01220"></a>01220 
<a name="l01221"></a>01221             <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01222"></a>01222             <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#ac2ee0af8a28eebbaf6d50a2ba63bd9a6">pgsql_reconnect</a>(database)) {
<a name="l01223"></a>01223                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01224"></a>01224                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to add column: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l01225"></a>01225                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sql);
<a name="l01226"></a>01226                <span class="keywordflow">continue</span>;
<a name="l01227"></a>01227             }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;About to run ALTER query on table &apos;%s&apos; to add column &apos;%s&apos;\n&quot;</span>, tablename, elm);
<a name="l01230"></a>01230             result = PQexec(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l01231"></a>01231             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Finished running ALTER query on table &apos;%s&apos;\n&quot;</span>, tablename);
<a name="l01232"></a>01232             <span class="keywordflow">if</span> (PQresultStatus(result) != PGRES_COMMAND_OK) {
<a name="l01233"></a>01233                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to add column: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l01234"></a>01234             }
<a name="l01235"></a>01235             PQclear(result);
<a name="l01236"></a>01236             <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01237"></a>01237 
<a name="l01238"></a>01238             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sql);
<a name="l01239"></a>01239          }
<a name="l01240"></a>01240       }
<a name="l01241"></a>01241    }
<a name="l01242"></a>01242    <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(table);
<a name="l01243"></a>01243    <span class="keywordflow">return</span> res;
<a name="l01244"></a>01244 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a498a3d904d1397b60d0e80b8534c6bc1"></a><!-- doxytag: member="res_config_pgsql.c::store_pgsql" ref="a498a3d904d1397b60d0e80b8534c6bc1" args="(const char *database, const char *table, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int store_pgsql </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>table</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00846">846</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="strings_8h_source.html#l00637">ast_str_thread_get()</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00096">ESCAPE_STRING</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00048">escapebuf_buf</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00044">pgsql_lock</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00045">sql_buf</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00047">where_buf</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00847"></a>00847 {
<a name="l00848"></a>00848    PGresult *result = NULL;
<a name="l00849"></a>00849    Oid insertid;
<a name="l00850"></a>00850    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a> = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#a5276aefbf1d003abafa0b7c7ff5449b9">escapebuf_buf</a>, 256);
<a name="l00851"></a>00851    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sql1 = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#afc4bfa5a94710e6f323a1033f82425b3">sql_buf</a>, 256);
<a name="l00852"></a>00852    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sql2 = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#a2b636f309367e4fa49ffb2c0a55e5bdd">where_buf</a>, 256);
<a name="l00853"></a>00853    <span class="keywordtype">int</span> pgresult;
<a name="l00854"></a>00854    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00855"></a>00855 
<a name="l00856"></a>00856    <span class="keywordflow">if</span> (!<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>) {
<a name="l00857"></a>00857       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;PostgreSQL RealTime: No table specified.\n&quot;</span>);
<a name="l00858"></a>00858       <span class="keywordflow">return</span> -1;
<a name="l00859"></a>00859    }
<a name="l00860"></a>00860 
<a name="l00861"></a>00861    <span class="comment">/* Get the first parameter and first value in our list of passed paramater/value pairs */</span>
<a name="l00862"></a>00862    newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00863"></a>00863    newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00864"></a>00864    <span class="keywordflow">if</span> (!newparam || !newval) {
<a name="l00865"></a>00865       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00866"></a>00866             <span class="stringliteral">&quot;PostgreSQL RealTime: Realtime storage requires at least 1 parameter and 1 value to store.\n&quot;</span>);
<a name="l00867"></a>00867       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>) {
<a name="l00868"></a>00868          PQfinish(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>);
<a name="l00869"></a>00869          <a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> = NULL;
<a name="l00870"></a>00870       }
<a name="l00871"></a>00871       <span class="keywordflow">return</span> -1;
<a name="l00872"></a>00872    }
<a name="l00873"></a>00873 
<a name="l00874"></a>00874    <span class="comment">/* Must connect to the server before anything else, as the escape function requires the connection handle.. */</span>
<a name="l00875"></a>00875    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00876"></a>00876    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#ac2ee0af8a28eebbaf6d50a2ba63bd9a6">pgsql_reconnect</a>(database)) {
<a name="l00877"></a>00877       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00878"></a>00878       <span class="keywordflow">return</span> -1;
<a name="l00879"></a>00879    }
<a name="l00880"></a>00880 
<a name="l00881"></a>00881    <span class="comment">/* Create the first part of the query using the first parameter/value pairs we just extracted</span>
<a name="l00882"></a>00882 <span class="comment">      If there is only 1 set, then we have our query. Otherwise, loop thru the list and concat */</span>
<a name="l00883"></a>00883    <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(buf, newparam);
<a name="l00884"></a>00884    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql1, 0, <span class="stringliteral">&quot;INSERT INTO %s (%s&quot;</span>, <a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l00885"></a>00885    <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(buf, newval);
<a name="l00886"></a>00886    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql2, 0, <span class="stringliteral">&quot;) VALUES (&apos;%s&apos;&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l00887"></a>00887    <span class="keywordflow">while</span> ((newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l00888"></a>00888       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00889"></a>00889       <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(buf, newparam);
<a name="l00890"></a>00890       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql1, 0, <span class="stringliteral">&quot;, %s&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l00891"></a>00891       <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(buf, newval);
<a name="l00892"></a>00892       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql2, 0, <span class="stringliteral">&quot;, &apos;%s&apos;&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l00893"></a>00893    }
<a name="l00894"></a>00894    va_end(ap);
<a name="l00895"></a>00895    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql1, 0, <span class="stringliteral">&quot;%s)&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql2));
<a name="l00896"></a>00896 
<a name="l00897"></a>00897    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Insert SQL: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql1));
<a name="l00898"></a>00898 
<a name="l00899"></a>00899    <span class="keywordflow">if</span> (!(result = PQexec(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql1)))) {
<a name="l00900"></a>00900       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00901"></a>00901             <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query database. Check debug for more info.\n&quot;</span>);
<a name="l00902"></a>00902       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql1));
<a name="l00903"></a>00903       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s\n&quot;</span>, PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>));
<a name="l00904"></a>00904       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00905"></a>00905       <span class="keywordflow">return</span> -1;
<a name="l00906"></a>00906    } <span class="keywordflow">else</span> {
<a name="l00907"></a>00907       ExecStatusType result_status = PQresultStatus(result);
<a name="l00908"></a>00908       <span class="keywordflow">if</span> (result_status != PGRES_COMMAND_OK
<a name="l00909"></a>00909          &amp;&amp; result_status != PGRES_TUPLES_OK
<a name="l00910"></a>00910          &amp;&amp; result_status != PGRES_NONFATAL_ERROR) {
<a name="l00911"></a>00911          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00912"></a>00912                <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query database. Check debug for more info.\n&quot;</span>);
<a name="l00913"></a>00913          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql1));
<a name="l00914"></a>00914          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s (%s)\n&quot;</span>,
<a name="l00915"></a>00915                   PQresultErrorMessage(result), PQresStatus(result_status));
<a name="l00916"></a>00916          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00917"></a>00917          <span class="keywordflow">return</span> -1;
<a name="l00918"></a>00918       }
<a name="l00919"></a>00919    }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921    insertid = PQoidValue(result);
<a name="l00922"></a>00922    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00923"></a>00923 
<a name="l00924"></a>00924    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: row inserted on table: %s, id: %u\n&quot;</span>, <a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, insertid);
<a name="l00925"></a>00925 
<a name="l00926"></a>00926    <span class="comment">/* From http://dev.pgsql.com/doc/pgsql/en/pgsql-affected-rows.html</span>
<a name="l00927"></a>00927 <span class="comment">    * An integer greater than zero indicates the number of rows affected</span>
<a name="l00928"></a>00928 <span class="comment">    * Zero indicates that no records were updated</span>
<a name="l00929"></a>00929 <span class="comment">    * -1 indicates that the query returned an error (although, if the query failed, it should have been caught above.)</span>
<a name="l00930"></a>00930 <span class="comment">    */</span>
<a name="l00931"></a>00931 
<a name="l00932"></a>00932    <span class="keywordflow">if</span> (insertid &gt;= 0)
<a name="l00933"></a>00933       <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) insertid;
<a name="l00934"></a>00934 
<a name="l00935"></a>00935    <span class="keywordflow">return</span> -1;
<a name="l00936"></a>00936 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad09fa931f468002152a3cc2d5ce25eae"></a><!-- doxytag: member="res_config_pgsql.c::unload_module" ref="ad09fa931f468002152a3cc2d5ce25eae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unload_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01293">1293</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="isdn__lib_8c_source.html#l00040">ARRAY_LEN</a>, <a class="el" href="cli_8c_source.html#l01937">ast_cli_unregister_multiple()</a>, <a class="el" href="config_8c_source.html#l01969">ast_config_engine_deregister()</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00817">AST_LIST_REMOVE_HEAD</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00105">destroy_table()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00044">pgsql_lock</a>, and <a class="el" href="cdr__odbc_8c_source.html#l00052">table</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01294"></a>01294 {
<a name="l01295"></a>01295    <span class="keyword">struct </span><a class="code" href="structtables.html">tables</a> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>;
<a name="l01296"></a>01296    <span class="comment">/* Acquire control before doing anything to the module itself. */</span>
<a name="l01297"></a>01297    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01298"></a>01298 
<a name="l01299"></a>01299    <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>) {
<a name="l01300"></a>01300       PQfinish(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>);
<a name="l01301"></a>01301       <a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> = NULL;
<a name="l01302"></a>01302    }
<a name="l01303"></a>01303    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(<a class="code" href="res__config__pgsql_8c.html#a5978a10899c3c5e1db25f2eb882180ce">cli_realtime</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="res__config__pgsql_8c.html#a5978a10899c3c5e1db25f2eb882180ce">cli_realtime</a>));
<a name="l01304"></a>01304    <a class="code" href="config_8h.html#a7028ff4b11d7167ee4030b4d3e123d76" title="Deregister config engine.">ast_config_engine_deregister</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#a981435c3dda0517ead4c0fb9080fb9e8">pgsql_engine</a>);
<a name="l01305"></a>01305    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime unloaded.\n&quot;</span>);
<a name="l01306"></a>01306 
<a name="l01307"></a>01307    <span class="comment">/* Destroy cached table info */</span>
<a name="l01308"></a>01308    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l01309"></a>01309    <span class="keywordflow">while</span> ((table = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>, <a class="code" href="structtables.html#a820ea34b748e7d4cd60f0ceae9b0355d">list</a>))) {
<a name="l01310"></a>01310       <a class="code" href="res__config__pgsql_8c.html#a40989424551303763ab1bae2aa13ba11">destroy_table</a>(table);
<a name="l01311"></a>01311    }
<a name="l01312"></a>01312    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l01313"></a>01313 
<a name="l01314"></a>01314    <span class="comment">/* Unlock so something else can destroy the lock. */</span>
<a name="l01315"></a>01315    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l01316"></a>01316 
<a name="l01317"></a>01317    <span class="keywordflow">return</span> 0;
<a name="l01318"></a>01318 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a8573a2981afd4073c00dc0431531384c"></a><!-- doxytag: member="res_config_pgsql.c::unload_pgsql" ref="a8573a2981afd4073c00dc0431531384c" args="(const char *database, const char *tablename)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unload_pgsql </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>tablename</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01246">1246</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00553">AST_LIST_REMOVE_CURRENT</a>, <a class="el" href="linkedlists_8h_source.html#l00528">AST_LIST_TRAVERSE_SAFE_BEGIN</a>, <a class="el" href="linkedlists_8h_source.html#l00599">AST_LIST_TRAVERSE_SAFE_END</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00105">destroy_table()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00071">tables::name</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01247"></a>01247 {
<a name="l01248"></a>01248    <span class="keyword">struct </span><a class="code" href="structtables.html">tables</a> *cur;
<a name="l01249"></a>01249    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;About to lock table cache list\n&quot;</span>);
<a name="l01250"></a>01250    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l01251"></a>01251    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;About to traverse table cache list\n&quot;</span>);
<a name="l01252"></a>01252    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>, cur, <a class="code" href="structtables.html#a820ea34b748e7d4cd60f0ceae9b0355d">list</a>) {
<a name="l01253"></a>01253       <span class="keywordflow">if</span> (strcmp(cur-&gt;<a class="code" href="structtables.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, tablename) == 0) {
<a name="l01254"></a>01254          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;About to remove matching cache entry\n&quot;</span>);
<a name="l01255"></a>01255          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(<a class="code" href="structtables.html#a820ea34b748e7d4cd60f0ceae9b0355d">list</a>);
<a name="l01256"></a>01256          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;About to destroy matching cache entry\n&quot;</span>);
<a name="l01257"></a>01257          <a class="code" href="res__config__pgsql_8c.html#a40989424551303763ab1bae2aa13ba11">destroy_table</a>(cur);
<a name="l01258"></a>01258          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Cache entry &apos;%s@%s&apos; destroyed\n&quot;</span>, tablename, database);
<a name="l01259"></a>01259          <span class="keywordflow">break</span>;
<a name="l01260"></a>01260       }
<a name="l01261"></a>01261    }
<a name="l01262"></a>01262    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l01263"></a>01263    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structpsql__tables.html">psql_tables</a>);
<a name="l01264"></a>01264    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;About to return\n&quot;</span>);
<a name="l01265"></a>01265    <span class="keywordflow">return</span> cur ? 0 : -1;
<a name="l01266"></a>01266 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aef3fb618b0ca215f06b24be4197e7245"></a><!-- doxytag: member="res_config_pgsql.c::update2_pgsql" ref="aef3fb618b0ca215f06b24be4197e7245" args="(const char *database, const char *tablename, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int update2_pgsql </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>tablename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00714">714</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="strings_8h_source.html#l00637">ast_str_thread_get()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00096">ESCAPE_STRING</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00048">escapebuf_buf</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00270">find_column()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00117">find_table()</a>, <a class="el" href="devicestate_8c_source.html#l00198">first</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00044">pgsql_lock</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00268">release_table</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00045">sql_buf</a>, <a class="el" href="cdr__odbc_8c_source.html#l00052">table</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00047">where_buf</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00715"></a>00715 {
<a name="l00716"></a>00716    PGresult *result = NULL;
<a name="l00717"></a>00717    <span class="keywordtype">int</span> numrows = 0, pgresult, <a class="code" href="devicestate_8c.html#abd2135e6f8a41bc900933b1985d97165">first</a> = 1;
<a name="l00718"></a>00718    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *escapebuf = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#a5276aefbf1d003abafa0b7c7ff5449b9">escapebuf_buf</a>, 16);
<a name="l00719"></a>00719    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00720"></a>00720    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sql = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#afc4bfa5a94710e6f323a1033f82425b3">sql_buf</a>, 100);
<a name="l00721"></a>00721    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *where = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#a2b636f309367e4fa49ffb2c0a55e5bdd">where_buf</a>, 100);
<a name="l00722"></a>00722    <span class="keyword">struct </span><a class="code" href="structtables.html">tables</a> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724    <span class="keywordflow">if</span> (!tablename) {
<a name="l00725"></a>00725       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;PostgreSQL RealTime: No table specified.\n&quot;</span>);
<a name="l00726"></a>00726       <span class="keywordflow">return</span> -1;
<a name="l00727"></a>00727    }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729    <span class="keywordflow">if</span> (!escapebuf || !sql || !where) {
<a name="l00730"></a>00730       <span class="comment">/* Memory error, already handled */</span>
<a name="l00731"></a>00731       <span class="keywordflow">return</span> -1;
<a name="l00732"></a>00732    }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734    <span class="keywordflow">if</span> (!(table = <a class="code" href="res__config__pgsql_8c.html#aaeb0f59e00eee1f4c11c427865821127">find_table</a>(tablename))) {
<a name="l00735"></a>00735       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Table &apos;%s&apos; does not exist!!\n&quot;</span>, tablename);
<a name="l00736"></a>00736       <span class="keywordflow">return</span> -1;
<a name="l00737"></a>00737    }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql, 0, <span class="stringliteral">&quot;UPDATE %s SET &quot;</span>, tablename);
<a name="l00740"></a>00740    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;where, 0, <span class="stringliteral">&quot;WHERE&quot;</span>);
<a name="l00741"></a>00741 
<a name="l00742"></a>00742    <span class="keywordflow">while</span> ((newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l00743"></a>00743       <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#a185e8c10da20a980396fb08bd4dd82b5">find_column</a>(table, newparam)) {
<a name="l00744"></a>00744          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Attempted to update based on criteria column &apos;%s&apos; (%s@%s), but that column does not exist!\n&quot;</span>, newparam, tablename, database);
<a name="l00745"></a>00745          <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(table);
<a name="l00746"></a>00746          <span class="keywordflow">return</span> -1;
<a name="l00747"></a>00747       }
<a name="l00748"></a>00748          
<a name="l00749"></a>00749       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00750"></a>00750       <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(escapebuf, newval);
<a name="l00751"></a>00751       <span class="keywordflow">if</span> (pgresult) {
<a name="l00752"></a>00752          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Postgres detected invalid input: &apos;%s&apos;\n&quot;</span>, newval);
<a name="l00753"></a>00753          <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(table);
<a name="l00754"></a>00754          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sql);
<a name="l00755"></a>00755          <span class="keywordflow">return</span> -1;
<a name="l00756"></a>00756       }
<a name="l00757"></a>00757       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;where, 0, <span class="stringliteral">&quot;%s %s=&apos;%s&apos;&quot;</span>, first ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot; AND&quot;</span>, newparam, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(escapebuf));
<a name="l00758"></a>00758       first = 0;
<a name="l00759"></a>00759    }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761    <span class="keywordflow">if</span> (first) {
<a name="l00762"></a>00762       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00763"></a>00763             <span class="stringliteral">&quot;PostgreSQL RealTime: Realtime update requires at least 1 parameter and 1 value to search on.\n&quot;</span>);
<a name="l00764"></a>00764       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>) {
<a name="l00765"></a>00765          PQfinish(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>);
<a name="l00766"></a>00766          <a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> = NULL;
<a name="l00767"></a>00767       }
<a name="l00768"></a>00768       <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(table);
<a name="l00769"></a>00769       <span class="keywordflow">return</span> -1;
<a name="l00770"></a>00770    }
<a name="l00771"></a>00771 
<a name="l00772"></a>00772    <span class="comment">/* Now retrieve the columns to update */</span>
<a name="l00773"></a>00773    first = 1;
<a name="l00774"></a>00774    <span class="keywordflow">while</span> ((newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l00775"></a>00775       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00776"></a>00776 
<a name="l00777"></a>00777       <span class="comment">/* If the column is not within the table, then skip it */</span>
<a name="l00778"></a>00778       <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#a185e8c10da20a980396fb08bd4dd82b5">find_column</a>(table, newparam)) {
<a name="l00779"></a>00779          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Attempted to update column &apos;%s&apos; in table &apos;%s@%s&apos;, but column does not exist!\n&quot;</span>, newparam, tablename, database);
<a name="l00780"></a>00780          <span class="keywordflow">continue</span>;
<a name="l00781"></a>00781       }
<a name="l00782"></a>00782 
<a name="l00783"></a>00783       <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(escapebuf, newval);
<a name="l00784"></a>00784       <span class="keywordflow">if</span> (pgresult) {
<a name="l00785"></a>00785          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Postgres detected invalid input: &apos;%s&apos;\n&quot;</span>, newval);
<a name="l00786"></a>00786          <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(table);
<a name="l00787"></a>00787          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sql);
<a name="l00788"></a>00788          <span class="keywordflow">return</span> -1;
<a name="l00789"></a>00789       }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql, 0, <span class="stringliteral">&quot;%s %s=&apos;%s&apos;&quot;</span>, first ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;,&quot;</span>, newparam, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(escapebuf));
<a name="l00792"></a>00792    }
<a name="l00793"></a>00793    <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(table);
<a name="l00794"></a>00794 
<a name="l00795"></a>00795    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql, 0, <span class="stringliteral">&quot; %s&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(where));
<a name="l00796"></a>00796 
<a name="l00797"></a>00797    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Update SQL: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00798"></a>00798 
<a name="l00799"></a>00799    <span class="comment">/* We now have our complete statement; connect to the server and execute it. */</span>
<a name="l00800"></a>00800    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00801"></a>00801    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#ac2ee0af8a28eebbaf6d50a2ba63bd9a6">pgsql_reconnect</a>(database)) {
<a name="l00802"></a>00802       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00803"></a>00803       <span class="keywordflow">return</span> -1;
<a name="l00804"></a>00804    }
<a name="l00805"></a>00805 
<a name="l00806"></a>00806    <span class="keywordflow">if</span> (!(result = PQexec(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql)))) {
<a name="l00807"></a>00807       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00808"></a>00808             <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query database. Check debug for more info.\n&quot;</span>);
<a name="l00809"></a>00809       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00810"></a>00810       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s\n&quot;</span>, PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>));
<a name="l00811"></a>00811       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00812"></a>00812       <span class="keywordflow">return</span> -1;
<a name="l00813"></a>00813    } <span class="keywordflow">else</span> {
<a name="l00814"></a>00814       ExecStatusType result_status = PQresultStatus(result);
<a name="l00815"></a>00815       <span class="keywordflow">if</span> (result_status != PGRES_COMMAND_OK
<a name="l00816"></a>00816          &amp;&amp; result_status != PGRES_TUPLES_OK
<a name="l00817"></a>00817          &amp;&amp; result_status != PGRES_NONFATAL_ERROR) {
<a name="l00818"></a>00818          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00819"></a>00819                <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query database. Check debug for more info.\n&quot;</span>);
<a name="l00820"></a>00820          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00821"></a>00821          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s (%s)\n&quot;</span>,
<a name="l00822"></a>00822                   PQresultErrorMessage(result), PQresStatus(result_status));
<a name="l00823"></a>00823          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00824"></a>00824          <span class="keywordflow">return</span> -1;
<a name="l00825"></a>00825       }
<a name="l00826"></a>00826    }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828    numrows = atoi(PQcmdTuples(result));
<a name="l00829"></a>00829    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00830"></a>00830 
<a name="l00831"></a>00831    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Updated %d rows on table: %s\n&quot;</span>, numrows, tablename);
<a name="l00832"></a>00832 
<a name="l00833"></a>00833    <span class="comment">/* From http://dev.pgsql.com/doc/pgsql/en/pgsql-affected-rows.html</span>
<a name="l00834"></a>00834 <span class="comment">    * An integer greater than zero indicates the number of rows affected</span>
<a name="l00835"></a>00835 <span class="comment">    * Zero indicates that no records were updated</span>
<a name="l00836"></a>00836 <span class="comment">    * -1 indicates that the query returned an error (although, if the query failed, it should have been caught above.)</span>
<a name="l00837"></a>00837 <span class="comment">    */</span>
<a name="l00838"></a>00838 
<a name="l00839"></a>00839    <span class="keywordflow">if</span> (numrows &gt;= 0) {
<a name="l00840"></a>00840       <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) numrows;
<a name="l00841"></a>00841    }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843    <span class="keywordflow">return</span> -1;
<a name="l00844"></a>00844 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa6d2878b1b310c1666b662231d3a25ad"></a><!-- doxytag: member="res_config_pgsql.c::update_pgsql" ref="aa6d2878b1b310c1666b662231d3a25ad" args="(const char *database, const char *tablename, const char *keyfield, const char *lookup, va_list ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int update_pgsql </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>tablename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>keyfield</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>lookup</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">va_list&nbsp;</td>
          <td class="paramname"> <em>ap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00576">576</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00825">ast_str_set()</a>, <a class="el" href="strings_8h_source.html#l00637">ast_str_thread_get()</a>, <a class="el" href="structtables.html#acc878587149a78a26fa030feaae016ed">tables::columns</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00096">ESCAPE_STRING</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00048">escapebuf_buf</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00270">find_column()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00117">find_table()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00058">columns::name</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00044">pgsql_lock</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00268">release_table</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00045">sql_buf</a>, and <a class="el" href="cdr__odbc_8c_source.html#l00052">table</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00578"></a>00578 {
<a name="l00579"></a>00579    PGresult *result = NULL;
<a name="l00580"></a>00580    <span class="keywordtype">int</span> numrows = 0, pgresult;
<a name="l00581"></a>00581    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00582"></a>00582    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sql = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#afc4bfa5a94710e6f323a1033f82425b3">sql_buf</a>, 100);
<a name="l00583"></a>00583    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *escapebuf = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#a5276aefbf1d003abafa0b7c7ff5449b9">escapebuf_buf</a>, 100);
<a name="l00584"></a>00584    <span class="keyword">struct </span><a class="code" href="structtables.html">tables</a> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>;
<a name="l00585"></a>00585    <span class="keyword">struct </span><a class="code" href="structcolumns.html">columns</a> *column = NULL;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587    <span class="keywordflow">if</span> (!tablename) {
<a name="l00588"></a>00588       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;PostgreSQL RealTime: No table specified.\n&quot;</span>);
<a name="l00589"></a>00589       <span class="keywordflow">return</span> -1;
<a name="l00590"></a>00590    }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592    <span class="keywordflow">if</span> (!(table = <a class="code" href="res__config__pgsql_8c.html#aaeb0f59e00eee1f4c11c427865821127">find_table</a>(tablename))) {
<a name="l00593"></a>00593       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Table &apos;%s&apos; does not exist!!\n&quot;</span>, tablename);
<a name="l00594"></a>00594       <span class="keywordflow">return</span> -1;
<a name="l00595"></a>00595    }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597    <span class="comment">/* Get the first parameter and first value in our list of passed paramater/value pairs */</span>
<a name="l00598"></a>00598    newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00599"></a>00599    newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00600"></a>00600    <span class="keywordflow">if</span> (!newparam || !newval) {
<a name="l00601"></a>00601       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00602"></a>00602             <span class="stringliteral">&quot;PostgreSQL RealTime: Realtime retrieval requires at least 1 parameter and 1 value to search on.\n&quot;</span>);
<a name="l00603"></a>00603       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>) {
<a name="l00604"></a>00604          PQfinish(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>);
<a name="l00605"></a>00605          <a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> = NULL;
<a name="l00606"></a>00606       }
<a name="l00607"></a>00607       <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(table);
<a name="l00608"></a>00608       <span class="keywordflow">return</span> -1;
<a name="l00609"></a>00609    }
<a name="l00610"></a>00610 
<a name="l00611"></a>00611    <span class="comment">/* Check that the column exists in the table */</span>
<a name="l00612"></a>00612    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;table-&gt;<a class="code" href="structtables.html#acc878587149a78a26fa030feaae016ed">columns</a>, column, <a class="code" href="structcolumns.html#a7160fb4746cd0e57449db13e15d6b8c1">list</a>) {
<a name="l00613"></a>00613       <span class="keywordflow">if</span> (strcmp(column-&gt;<a class="code" href="structcolumns.html#ad547fb8186b526cb1b588daad4334fbe">name</a>, newparam) == 0) {
<a name="l00614"></a>00614          <span class="keywordflow">break</span>;
<a name="l00615"></a>00615       }
<a name="l00616"></a>00616    }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618    <span class="keywordflow">if</span> (!column) {
<a name="l00619"></a>00619       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;PostgreSQL RealTime: Updating on column &apos;%s&apos;, but that column does not exist within the table &apos;%s&apos;!\n&quot;</span>, newparam, tablename);
<a name="l00620"></a>00620       <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(table);
<a name="l00621"></a>00621       <span class="keywordflow">return</span> -1;
<a name="l00622"></a>00622    }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624    <span class="comment">/* Create the first part of the query using the first parameter/value pairs we just extracted</span>
<a name="l00625"></a>00625 <span class="comment">      If there is only 1 set, then we have our query. Otherwise, loop thru the list and concat */</span>
<a name="l00626"></a>00626 
<a name="l00627"></a>00627    <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(escapebuf, newval);
<a name="l00628"></a>00628    <span class="keywordflow">if</span> (pgresult) {
<a name="l00629"></a>00629       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Postgres detected invalid input: &apos;%s&apos;\n&quot;</span>, newval);
<a name="l00630"></a>00630       va_end(ap);
<a name="l00631"></a>00631       <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(table);
<a name="l00632"></a>00632       <span class="keywordflow">return</span> -1;
<a name="l00633"></a>00633    }
<a name="l00634"></a>00634    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql, 0, <span class="stringliteral">&quot;UPDATE %s SET %s = &apos;%s&apos;&quot;</span>, tablename, newparam, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(escapebuf));
<a name="l00635"></a>00635 
<a name="l00636"></a>00636    <span class="keywordflow">while</span> ((newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l00637"></a>00637       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00638"></a>00638 
<a name="l00639"></a>00639       <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#a185e8c10da20a980396fb08bd4dd82b5">find_column</a>(table, newparam)) {
<a name="l00640"></a>00640          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Attempted to update column &apos;%s&apos; in table &apos;%s&apos;, but column does not exist!\n&quot;</span>, newparam, tablename);
<a name="l00641"></a>00641          <span class="keywordflow">continue</span>;
<a name="l00642"></a>00642       }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644       <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(escapebuf, newval);
<a name="l00645"></a>00645       <span class="keywordflow">if</span> (pgresult) {
<a name="l00646"></a>00646          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Postgres detected invalid input: &apos;%s&apos;\n&quot;</span>, newval);
<a name="l00647"></a>00647          va_end(ap);
<a name="l00648"></a>00648          <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(table);
<a name="l00649"></a>00649          <span class="keywordflow">return</span> -1;
<a name="l00650"></a>00650       }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql, 0, <span class="stringliteral">&quot;, %s = &apos;%s&apos;&quot;</span>, newparam, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(escapebuf));
<a name="l00653"></a>00653    }
<a name="l00654"></a>00654    va_end(ap);
<a name="l00655"></a>00655    <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(table);
<a name="l00656"></a>00656 
<a name="l00657"></a>00657    <a class="code" href="res__config__pgsql_8c.html#aa2c6ce9cd5b94e99551c6f59425eddc1">ESCAPE_STRING</a>(escapebuf, lookup);
<a name="l00658"></a>00658    <span class="keywordflow">if</span> (pgresult) {
<a name="l00659"></a>00659       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Postgres detected invalid input: &apos;%s&apos;\n&quot;</span>, lookup);
<a name="l00660"></a>00660       va_end(ap);
<a name="l00661"></a>00661       <span class="keywordflow">return</span> -1;
<a name="l00662"></a>00662    }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql, 0, <span class="stringliteral">&quot; WHERE %s = &apos;%s&apos;&quot;</span>, keyfield, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(escapebuf));
<a name="l00665"></a>00665 
<a name="l00666"></a>00666    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Update SQL: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00667"></a>00667 
<a name="l00668"></a>00668    <span class="comment">/* We now have our complete statement; Lets connect to the server and execute it. */</span>
<a name="l00669"></a>00669    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00670"></a>00670    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#ac2ee0af8a28eebbaf6d50a2ba63bd9a6">pgsql_reconnect</a>(database)) {
<a name="l00671"></a>00671       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00672"></a>00672       <span class="keywordflow">return</span> -1;
<a name="l00673"></a>00673    }
<a name="l00674"></a>00674 
<a name="l00675"></a>00675    <span class="keywordflow">if</span> (!(result = PQexec(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql)))) {
<a name="l00676"></a>00676       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00677"></a>00677             <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query database. Check debug for more info.\n&quot;</span>);
<a name="l00678"></a>00678       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00679"></a>00679       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s\n&quot;</span>, PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a>));
<a name="l00680"></a>00680       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00681"></a>00681       <span class="keywordflow">return</span> -1;
<a name="l00682"></a>00682    } <span class="keywordflow">else</span> {
<a name="l00683"></a>00683       ExecStatusType result_status = PQresultStatus(result);
<a name="l00684"></a>00684       <span class="keywordflow">if</span> (result_status != PGRES_COMMAND_OK
<a name="l00685"></a>00685          &amp;&amp; result_status != PGRES_TUPLES_OK
<a name="l00686"></a>00686          &amp;&amp; result_status != PGRES_NONFATAL_ERROR) {
<a name="l00687"></a>00687          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,
<a name="l00688"></a>00688                <span class="stringliteral">&quot;PostgreSQL RealTime: Failed to query database. Check debug for more info.\n&quot;</span>);
<a name="l00689"></a>00689          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l00690"></a>00690          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Query Failed because: %s (%s)\n&quot;</span>,
<a name="l00691"></a>00691                   PQresultErrorMessage(result), PQresStatus(result_status));
<a name="l00692"></a>00692          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00693"></a>00693          <span class="keywordflow">return</span> -1;
<a name="l00694"></a>00694       }
<a name="l00695"></a>00695    }
<a name="l00696"></a>00696 
<a name="l00697"></a>00697    numrows = atoi(PQcmdTuples(result));
<a name="l00698"></a>00698    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a>);
<a name="l00699"></a>00699 
<a name="l00700"></a>00700    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;PostgreSQL RealTime: Updated %d rows on table: %s\n&quot;</span>, numrows, tablename);
<a name="l00701"></a>00701 
<a name="l00702"></a>00702    <span class="comment">/* From http://dev.pgsql.com/doc/pgsql/en/pgsql-affected-rows.html</span>
<a name="l00703"></a>00703 <span class="comment">    * An integer greater than zero indicates the number of rows affected</span>
<a name="l00704"></a>00704 <span class="comment">    * Zero indicates that no records were updated</span>
<a name="l00705"></a>00705 <span class="comment">    * -1 indicates that the query returned an error (although, if the query failed, it should have been caught above.)</span>
<a name="l00706"></a>00706 <span class="comment">    */</span>
<a name="l00707"></a>00707 
<a name="l00708"></a>00708    <span class="keywordflow">if</span> (numrows &gt;= 0)
<a name="l00709"></a>00709       <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) numrows;
<a name="l00710"></a>00710 
<a name="l00711"></a>00711    <span class="keywordflow">return</span> -1;
<a name="l00712"></a>00712 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="ab22f32016155f7f403e7178767163d7d"></a><!-- doxytag: member="res_config_pgsql.c::__mod_info" ref="ab22f32016155f7f403e7178767163d7d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a> <a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_GLOBAL_SYMBOLS , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;PostgreSQL RealTime Configuration Driver&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, .reload = reload }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01596">1596</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

</div>
</div>
<a class="anchor" id="ae25b9f3970870610911f8850897e8ead"></a><!-- doxytag: member="res_config_pgsql.c::ast_module_info" ref="ae25b9f3970870610911f8850897e8ead" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a>* <a class="el" href="structast__module__info.html">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01596">1596</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

</div>
</div>
<a class="anchor" id="a5978a10899c3c5e1db25f2eb882180ce"></a><!-- doxytag: member="res_config_pgsql.c::cli_realtime" ref="a5978a10899c3c5e1db25f2eb882180ce" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> <a class="el" href="res__realtime_8c.html#a5978a10899c3c5e1db25f2eb882180ce">cli_realtime</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__config__pgsql_8c.html#a8b98835879e51580aabf8a411acf6f14">handle_cli_realtime_pgsql_status</a>, <span class="stringliteral">&quot;Shows connection information for the PostgreSQL RealTime driver&quot;</span>),
   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__config__pgsql_8c.html#ad4b5e121aaba3306fc6a19abacff9a5c">handle_cli_realtime_pgsql_cache</a>, <span class="stringliteral">&quot;Shows cached tables within the PostgreSQL realtime driver&quot;</span>),
}
</pre></div>
<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00091">91</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

</div>
</div>
<a class="anchor" id="ac4ae24c7b766713b82921c04d1a4b699"></a><!-- doxytag: member="res_config_pgsql.c::connect_time" ref="ac4ae24c7b766713b82921c04d1a4b699" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">time_t <a class="el" href="res__config__pgsql_8c.html#ac4ae24c7b766713b82921c04d1a4b699">connect_time</a> = 0<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00082">82</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01538">handle_cli_realtime_pgsql_status()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>.</p>

</div>
</div>
<a class="anchor" id="ac0b8d5bc4f1cf8e8812c6744159d63fe"></a><!-- doxytag: member="res_config_pgsql.c::dbhost" ref="ac0b8d5bc4f1cf8e8812c6744159d63fe" args="[MAX_DB_OPTION_SIZE]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__config__pgsql_8c.html#ac0b8d5bc4f1cf8e8812c6744159d63fe">dbhost</a>[MAX_DB_OPTION_SIZE] = &quot;&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00076">76</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01538">handle_cli_realtime_pgsql_status()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01327">parse_config()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>.</p>

</div>
</div>
<a class="anchor" id="a6904a1f9115898f7691f4e8a405b8b98"></a><!-- doxytag: member="res_config_pgsql.c::dbname" ref="a6904a1f9115898f7691f4e8a405b8b98" args="[MAX_DB_OPTION_SIZE]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__config__pgsql_8c.html#a6904a1f9115898f7691f4e8a405b8b98">dbname</a>[MAX_DB_OPTION_SIZE] = &quot;&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00079">79</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01538">handle_cli_realtime_pgsql_status()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01327">parse_config()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>.</p>

</div>
</div>
<a class="anchor" id="a6c0213e458980748dc52ffc409668ada"></a><!-- doxytag: member="res_config_pgsql.c::dbpass" ref="a6c0213e458980748dc52ffc409668ada" args="[MAX_DB_OPTION_SIZE]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__config__pgsql_8c.html#a6c0213e458980748dc52ffc409668ada">dbpass</a>[MAX_DB_OPTION_SIZE] = &quot;&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00078">78</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01327">parse_config()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>.</p>

</div>
</div>
<a class="anchor" id="ad76d37dfe4b000f0e1113be85bf2c41f"></a><!-- doxytag: member="res_config_pgsql.c::dbport" ref="ad76d37dfe4b000f0e1113be85bf2c41f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="res__config__pgsql_8c.html#ad76d37dfe4b000f0e1113be85bf2c41f">dbport</a> = 5432<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00081">81</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01538">handle_cli_realtime_pgsql_status()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01327">parse_config()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>.</p>

</div>
</div>
<a class="anchor" id="ac4ba6066077517f4c70aa20a44d61e8d"></a><!-- doxytag: member="res_config_pgsql.c::dbsock" ref="ac4ba6066077517f4c70aa20a44d61e8d" args="[MAX_DB_OPTION_SIZE]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__config__pgsql_8c.html#ac4ba6066077517f4c70aa20a44d61e8d">dbsock</a>[MAX_DB_OPTION_SIZE] = &quot;&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00080">80</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01538">handle_cli_realtime_pgsql_status()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01327">parse_config()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>.</p>

</div>
</div>
<a class="anchor" id="a1db90a8699d1255793e9d9accfe04e3c"></a><!-- doxytag: member="res_config_pgsql.c::dbuser" ref="a1db90a8699d1255793e9d9accfe04e3c" args="[MAX_DB_OPTION_SIZE]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__config__pgsql_8c.html#a1db90a8699d1255793e9d9accfe04e3c">dbuser</a>[MAX_DB_OPTION_SIZE] = &quot;&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00077">77</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01538">handle_cli_realtime_pgsql_status()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01327">parse_config()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l01438">pgsql_reconnect()</a>.</p>

</div>
</div>
<a class="anchor" id="a5276aefbf1d003abafa0b7c7ff5449b9"></a><!-- doxytag: member="res_config_pgsql.c::escapebuf_buf" ref="a5276aefbf1d003abafa0b7c7ff5449b9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__threadstorage.html">ast_threadstorage</a> <a class="el" href="res__config__pgsql_8c.html#a5276aefbf1d003abafa0b7c7ff5449b9">escapebuf_buf</a> = { .once = PTHREAD_ONCE_INIT , .key_init = __init_escapebuf_buf , .custom_init = NULL , }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00048">48</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l00938">destroy_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00418">realtime_multi_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00283">realtime_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00846">store_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00714">update2_pgsql()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00576">update_pgsql()</a>.</p>

</div>
</div>
<a class="anchor" id="ad10b165b24bb77fd0137e9f7a26d83aa"></a><!-- doxytag: member="res_config_pgsql.c::findtable_buf" ref="ad10b165b24bb77fd0137e9f7a26d83aa" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__threadstorage.html">ast_threadstorage</a> <a class="el" href="res__config__pgsql_8c.html#ad10b165b24bb77fd0137e9f7a26d83aa">findtable_buf</a> = { .once = PTHREAD_ONCE_INIT , .key_init = __init_findtable_buf , .custom_init = NULL , }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00046">46</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l00117">find_table()</a>.</p>

</div>
</div>
<a class="anchor" id="a981435c3dda0517ead4c0fb9080fb9e8"></a><!-- doxytag: member="res_config_pgsql.c::pgsql_engine" ref="a981435c3dda0517ead4c0fb9080fb9e8" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__config__engine.html">ast_config_engine</a> <a class="el" href="res__config__pgsql_8c.html#a981435c3dda0517ead4c0fb9080fb9e8">pgsql_engine</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l01268">1268</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

</div>
</div>
<a class="anchor" id="aa09945fa90e0a830f3f0ce54aa6c7782"></a><!-- doxytag: member="res_config_pgsql.c::pgsql_lock" ref="aa09945fa90e0a830f3f0ce54aa6c7782" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="el" href="res__config__pgsql_8c.html#aa09945fa90e0a830f3f0ce54aa6c7782">pgsql_lock</a> = ((<a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>) PTHREAD_MUTEX_INITIALIZER )<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00044">44</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01030">config_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00938">destroy_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01327">parse_config()</a>, <a class="el" href="cdr__pgsql_8c_source.html#l00103">pgsql_log()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00418">realtime_multi_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00283">realtime_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01125">require_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00846">store_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l01293">unload_module()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00714">update2_pgsql()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00576">update_pgsql()</a>.</p>

</div>
</div>
<a class="anchor" id="a94df2738afcedd29322df565b0c336d2"></a><!-- doxytag: member="res_config_pgsql.c::pgsqlConn" ref="a94df2738afcedd29322df565b0c336d2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PGconn* <a class="el" href="res__config__pgsql_8c.html#a94df2738afcedd29322df565b0c336d2">pgsqlConn</a> = NULL</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00052">52</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

</div>
</div>
<a class="anchor" id="a7e2f1debddb2f7bbdddc82ef5aeb0332"></a><!-- doxytag: member="res_config_pgsql.c::requirements" ref="a7e2f1debddb2f7bbdddc82ef5aeb0332" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum { ... }   <a class="el" href="res__config__pgsql_8c.html#a7e2f1debddb2f7bbdddc82ef5aeb0332">requirements</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01327">parse_config()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l01125">require_pgsql()</a>.</p>

</div>
</div>
<a class="anchor" id="afc4bfa5a94710e6f323a1033f82425b3"></a><!-- doxytag: member="res_config_pgsql.c::sql_buf" ref="afc4bfa5a94710e6f323a1033f82425b3" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__threadstorage.html">ast_threadstorage</a> <a class="el" href="res__config__sqlite_8c.html#afc4bfa5a94710e6f323a1033f82425b3">sql_buf</a> = { .once = PTHREAD_ONCE_INIT , .key_init = __init_sql_buf , .custom_init = NULL , }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00045">45</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l01030">config_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00938">destroy_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00418">realtime_multi_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00283">realtime_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00846">store_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00714">update2_pgsql()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00576">update_pgsql()</a>.</p>

</div>
</div>
<a class="anchor" id="aad880fc4455c253781e8968f2239d56f"></a><!-- doxytag: member="res_config_pgsql.c::version" ref="aad880fc4455c253781e8968f2239d56f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00053">53</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

</div>
</div>
<a class="anchor" id="a2b636f309367e4fa49ffb2c0a55e5bdd"></a><!-- doxytag: member="res_config_pgsql.c::where_buf" ref="a2b636f309367e4fa49ffb2c0a55e5bdd" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__threadstorage.html">ast_threadstorage</a> <a class="el" href="res__config__sqlite_8c.html#a2b636f309367e4fa49ffb2c0a55e5bdd">where_buf</a> = { .once = PTHREAD_ONCE_INIT , .key_init = __init_where_buf , .custom_init = NULL , }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__config__pgsql_8c_source.html#l00047">47</a> of file <a class="el" href="res__config__pgsql_8c_source.html">res_config_pgsql.c</a>.</p>

<p>Referenced by <a class="el" href="res__config__pgsql_8c_source.html#l00938">destroy_pgsql()</a>, <a class="el" href="res__config__pgsql_8c_source.html#l00846">store_pgsql()</a>, and <a class="el" href="res__config__pgsql_8c_source.html#l00714">update2_pgsql()</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:23:10 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
