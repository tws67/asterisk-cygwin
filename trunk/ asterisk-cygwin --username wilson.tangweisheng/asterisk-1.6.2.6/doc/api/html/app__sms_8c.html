<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:19:20 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_7739c4bd2a7c382676c2c912043775c7.html">apps</a>
  </div>
</div>
<div class="contents">
<h1>app_sms.c File Reference</h1>
<p>SMS application - ETSI ES 201 912 protocol 1 implementation.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &lt;dirent.h&gt;</code><br/>
<code>#include &lt;ctype.h&gt;</code><br/>
<code>#include &lt;sys/stat.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="paths_8h_source.html">asterisk/paths.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="lock_8h_source.html">asterisk/lock.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="file_8h_source.html">asterisk/file.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="channel_8h_source.html">asterisk/channel.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pbx_8h_source.html">asterisk/pbx.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="module_8h_source.html">asterisk/module.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="alaw_8h_source.html">asterisk/alaw.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="callerid_8h_source.html">asterisk/callerid.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="app_8h_source.html">asterisk/app.h</a>&quot;</code><br/>

<p><a href="app__sms_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structsms__s.html">sms_s</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a534407082ad8ffdc07f2143b239e17c6">__OUT_FMT</a>&nbsp;&nbsp;&nbsp;AST_FORMAT_SLINEAR</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#aa4fbf8951a3590171e5def3f7d4cd666">DIR_RX</a>&nbsp;&nbsp;&nbsp;1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#af85a8c6a09856dbb3bc88c829432db58">DIR_TX</a>&nbsp;&nbsp;&nbsp;2</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a6c597ad0ac2a2eea8e6653e622742287">DLL2_ACK</a>(h)&nbsp;&nbsp;&nbsp;((h-&gt;framenumber &amp; 1) ? DLL2_SMS_ACK1: DLL2_SMS_ACK1)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a8bdd552aa3abf01b520c87815e1c2b24">is16bit</a>(dcs)&nbsp;&nbsp;&nbsp;( ((dcs) &amp; 0xC0) ? 0               : (((dcs) &amp; 0xc) == 8) )</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a39743cbea53fca38237f049acd4cb834">is7bit</a>(dcs)&nbsp;&nbsp;&nbsp;( ((dcs) &amp; 0xC0) ? (!((dcs) &amp; 4) ) : (((dcs) &amp; 0xc) == 0) )</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a5f533f0d22e8b3eac586398fbae67636">is8bit</a>(dcs)&nbsp;&nbsp;&nbsp;( ((dcs) &amp; 0xC0) ? ( ((dcs) &amp; 4) ) : (((dcs) &amp; 0xc) == 4) )</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#ad88625c032fc5b3a096a60ddd129e2f4">MAX_DEBUG_LEN</a>&nbsp;&nbsp;&nbsp;300</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a6706e49765398fb7ec5e9e4bb66c3e64">MAXSAMPLES</a>&nbsp;&nbsp;&nbsp;(800)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#ae0ea1fb3f3d1fdc8111f0c54d71afb1c">OSYNC_BITS</a>&nbsp;&nbsp;&nbsp;80</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a92bf696f8279259f5741564c2c2b2af2">SMSLEN</a>&nbsp;&nbsp;&nbsp;160</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#ac59f0c328bf0668e86f21b74183de226">SMSLEN_8</a>&nbsp;&nbsp;&nbsp;140</td></tr>
<tr><td colspan="2"><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef signed short&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a4008af70ba477f60e932df6815dac38d">output_t</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structsms__s.html">sms_s</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a03faa096cd1695c08d2134dc6ae7d1fe">sms_t</a></td></tr>
<tr><td colspan="2"><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom">{ <br/>
&nbsp;&nbsp;<a class="el" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a6d9f8a190a30fdff2d003fe406ab23f9">OPTION_BE_SMSC</a> =  (1 &lt;&lt; 0), 
<a class="el" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a078a4fe6b4252bcd185df43f051ecd53">OPTION_ANSWER</a> =  (1 &lt;&lt; 1), 
<a class="el" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a6a8237166dcc5e4ec9cf6671b91d8dd4">OPTION_TWO</a> =  (1 &lt;&lt; 2), 
<a class="el" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a72c537a2238414194f4b6f309e3a668e">OPTION_PAUSE</a> =  (1 &lt;&lt; 3), 
<br/>
&nbsp;&nbsp;<a class="el" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a0b148357a99551d297160a7b98600695">OPTION_SRR</a> =  (1 &lt;&lt; 4), 
<a class="el" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a8a74ad47b1edfb9e69bfa73516388781">OPTION_DCS</a> =  (1 &lt;&lt; 5)
<br/>
 }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom">{ <a class="el" href="app__sms_8c.html#af715e26dfffd1f8de1c18449e2770cffa00c83650e6758ad93ede9f7db2dbf567">OPTION_ARG_PAUSE</a> =  0, 
<a class="el" href="app__sms_8c.html#af715e26dfffd1f8de1c18449e2770cffad8be72595381ce66309dcc938077316b">OPTION_ARG_ARRAY_SIZE</a>
 }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9">message_types</a> { <br/>
&nbsp;&nbsp;<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9ab52fa5194e2be3c8953de452277a1ae6">DLL_SMS_MASK</a> =  0x7f, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a3494ff7bd605a6ca055b31309459c65a">DLL1_SMS_DATA</a> =  0x11, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a24bdd3ee7147c8b7eb741cec3198925c">DLL1_SMS_ERROR</a> =  0x12, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9aa93cd3c00de7548f03cc83a73833b626">DLL1_SMS_EST</a> =  0x13, 
<br/>
&nbsp;&nbsp;<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9af63c95cbe39f23e6ad26f2ba0e9923f8">DLL1_SMS_REL</a> =  0x14, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a79172f5903fec0db6f4db43c6d985969">DLL1_SMS_ACK</a> =  0x15, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a5ea467e78e6a31d09860fcb35dec1338">DLL1_SMS_NACK</a> =  0x16, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a96e7ed27f789598728cae97a4f9abbe4">DLL1_SMS_COMPLETE</a> =  0x80, 
<br/>
&nbsp;&nbsp;<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a1f477137c2be1ae63f113d7f08683e51">DLL1_SMS_MORE</a> =  0x00, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a5df5d537055950e483ab1b368c26d73f">DLL2_SMS_EST</a> =  0x7f, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a3d9593f4f21b1e09861ef6ff8787b3e5">DLL2_SMS_INFO_MO</a> =  0x10, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a01cbc78b9b22bc743fa76b52bc31b99b">DLL2_SMS_INFO_MT</a> =  0x11, 
<br/>
&nbsp;&nbsp;<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a250be9e2438762a2a98cfa0c90db9f82">DLL2_SMS_INFO_STA</a> =  0x12, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9ae7948b7f83c79737c57370e63d2b6ea8">DLL2_SMS_NACK</a> =  0x13, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a20c3011fb7a87c560c2defa4de284855">DLL2_SMS_ACK0</a> =  0x14, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a0939445034985054325921b2b0e8403a">DLL2_SMS_ACK1</a> =  0x15, 
<br/>
&nbsp;&nbsp;<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9ae8e8868e7f35bd6dff10f69df0e2b652">DLL2_SMS_ENQ</a> =  0x16, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a4beada5edbf9c5838f1bbc26eb74b8bf">DLL2_SMS_REL</a> =  0x17, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9adcb4bce99e6a020f51aaad2aa1310735">DLL2_SMS_COMPLETE</a> =  0x00, 
<a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a316b96f57093ff10ba8b88d474e27ed4">DLL2_SMS_MORE</a> =  0x80
<br/>
 }</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#adfb54a6105314c1847b33ff2b7f24fb9">adddata_proto2</a> (<a class="el" href="structsms__s.html">sms_t</a> *h, unsigned char <a class="el" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, char *data, int size)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a7d5d2871ceb7379204bf4f57b0425d1a">AST_APP_OPTIONS</a> (sms_options,{AST_APP_OPTION('s', OPTION_BE_SMSC), AST_APP_OPTION('a', OPTION_ANSWER), AST_APP_OPTION('t', OPTION_TWO), AST_APP_OPTION('r', OPTION_SRR), AST_APP_OPTION('o', OPTION_DCS), AST_APP_OPTION_ARG('p', OPTION_PAUSE, OPTION_ARG_PAUSE),})</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a0286051e93e484a687b21cc0e9027fec">AST_MODULE_INFO_STANDARD</a> (ASTERISK_GPL_KEY,&quot;SMS/PSTN handler&quot;)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#aa82dbf6bb6292091b6f9ac19cc841428">isodate</a> (time_t t, char *<a class="el" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, int len)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">static, return a date/time in ISO format  <a href="#aa82dbf6bb6292091b6f9ac19cc841428"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a660b5407faba61b0835356de97c78a0c">numcpy</a> (char *d, char *s)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">copy <a class="el" href="structnumber.html" title="Number structure.">number</a>, skipping non digits apart from leading +  <a href="#a660b5407faba61b0835356de97c78a0c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#aea46af6597884cf32d85f18a52129711">packaddress</a> (unsigned char *o, char *i)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">store an address at o, and return <a class="el" href="structnumber.html" title="Number structure.">number</a> of bytes used  <a href="#aea46af6597884cf32d85f18a52129711"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a902aeb4504023853fd6f91429a2855e3">packdate</a> (unsigned char *o, time_t w)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">pack a date and return  <a href="#a902aeb4504023853fd6f91429a2855e3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a38e1bebc872822985359d2e36c1c0448">packsms</a> (unsigned char dcs, unsigned char *base, unsigned int udhl, unsigned char *udh, int udl, unsigned short *ud)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">general pack, with length and data, returns <a class="el" href="structnumber.html" title="Number structure.">number</a> of bytes of target used  <a href="#a38e1bebc872822985359d2e36c1c0448"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a77ab80a9e6251174378df1f59b5dbc44">packsms16</a> (unsigned char *o, int udhl, unsigned char *udh, int udl, unsigned short *ud)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">takes a binary header (udhl bytes at udh) and UCS-2 <a class="el" href="structmessage.html">message</a> (udl characters at ud) and packs in to o using 16 bit UCS-2 character codes The return value is the <a class="el" href="structnumber.html" title="Number structure.">number</a> of bytes packed in to o, which is internally limited to 140 o can be null, in which case this is used to validate or count only if the input contains invalid characters then the return value is -1  <a href="#a77ab80a9e6251174378df1f59b5dbc44"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a172d0c2bb9c8a56df817acb5ce7bfe3c">packsms7</a> (unsigned char *o, int udhl, unsigned char *udh, int udl, unsigned short *ud)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">takes a binary header (udhl bytes at udh) and UCS-2 <a class="el" href="structmessage.html">message</a> (udl characters at ud) and packs in to o using SMS 7 bit character codes  <a href="#a172d0c2bb9c8a56df817acb5ce7bfe3c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#aa3645875887568a20059ae86c7a66f74">packsms8</a> (unsigned char *o, int udhl, unsigned char *udh, int udl, unsigned short *ud)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">takes a binary header (udhl bytes at udh) and UCS-2 <a class="el" href="structmessage.html">message</a> (udl characters at ud) and packs in to o using 8 bit character codes. The return value is the <a class="el" href="structnumber.html" title="Number structure.">number</a> of bytes packed in to o, which is internally limited to 140. o can be null, in which case this is used to validate or count only. if the input contains invalid characters then the return value is -1  <a href="#aa3645875887568a20059ae86c7a66f74"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a70757b19c8a274d21a1f935767d41426">putdummydata_proto2</a> (<a class="el" href="structsms__s.html">sms_t</a> *h)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct dirent *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#abe8206bb9c2adf04e478cd8e01bd5a94">readdirqueue</a> (DIR *d, char *queue)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">read dir skipping dot files...  <a href="#abe8206bb9c2adf04e478cd8e01bd5a94"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a44ab7b172d33e28647b2383346814b9f">sms_alloc</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *sms_t_ptr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a184a0ba43954b42a5db9a1b1a4854ccb">sms_compose1</a> (<a class="el" href="structsms__s.html">sms_t</a> *h, int more)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">compose a <a class="el" href="structmessage.html">message</a> for protocol 1  <a href="#a184a0ba43954b42a5db9a1b1a4854ccb"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a4cea080950ce2066ed4987ee16fcb8d5">sms_compose2</a> (<a class="el" href="structsms__s.html">sms_t</a> *h, int more)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#aec1ab10167ae5ed9af8793c90c10c475">sms_debug</a> (int <a class="el" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>, <a class="el" href="structsms__s.html">sms_t</a> *h)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a587be46ef6675e0c5477d125dc1e1b27">sms_exec</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#afda4211248e1b0e0083be7bd80a7d4b0">sms_generate</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data, int len, int samples)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a43baf6d9daec56e893ebc9c204d852f3">sms_handleincoming</a> (<a class="el" href="structsms__s.html">sms_t</a> *h)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">handle the incoming <a class="el" href="structmessage.html">message</a>  <a href="#a43baf6d9daec56e893ebc9c204d852f3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#ace3cb96a3f20c144ab6eabc4f6f7304e">sms_handleincoming_proto2</a> (<a class="el" href="structsms__s.html">sms_t</a> *h)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">sms_handleincoming_proto2: handle the incoming <a class="el" href="structmessage.html">message</a>  <a href="#ace3cb96a3f20c144ab6eabc4f6f7304e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a5f9bfb13333d20c981dfa1de202ee13f">sms_hexdump</a> (unsigned char <a class="el" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[], int size, char *s)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#ad5e0ab37f40bc7f8885617847ffd3fee">sms_log</a> (<a class="el" href="structsms__s.html">sms_t</a> *h, char <a class="el" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Log the output, and remove file.  <a href="#ad5e0ab37f40bc7f8885617847ffd3fee"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a24b70dbd9b6b663969974c877a202d61">sms_messagerx</a> (<a class="el" href="structsms__s.html">sms_t</a> *h)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#aa92b5f49b3da5a82098a3011f8bb7947">sms_messagerx2</a> (<a class="el" href="structsms__s.html">sms_t</a> *h)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a47041feede8f04106f4d6221af763e9d">sms_messagetx</a> (<a class="el" href="structsms__s.html">sms_t</a> *h)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#aacb45147ec48b5972784c3cf3086d147">sms_nextoutgoing</a> (<a class="el" href="structsms__s.html">sms_t</a> *h)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">find and fill in next <a class="el" href="structmessage.html">message</a>, or send a REL if none waiting  <a href="#aacb45147ec48b5972784c3cf3086d147"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#aa1cc2166cf9b6a4496caf3bb1d11cb6e">sms_process</a> (<a class="el" href="structsms__s.html">sms_t</a> *h, int samples, signed short *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a35be9014d402309539c591ab37a4e7c4">sms_readfile</a> (<a class="el" href="structsms__s.html">sms_t</a> *h, char *fn)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">parse and delete a file  <a href="#a35be9014d402309539c591ab37a4e7c4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#ab0fd8690c8108023eafe2da490478f56">sms_release</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#af45fa5279582c213474672cf0684d219">sms_writefile</a> (<a class="el" href="structsms__s.html">sms_t</a> *h)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">white a received text <a class="el" href="structmessage.html">message</a> to a file  <a href="#af45fa5279582c213474672cf0684d219"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#ad38c7ea91c75338009d7ef07df937ee9">unpackaddress</a> (char *o, unsigned char *i)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">unpack an address from i, return byte length, unpack to o  <a href="#ad38c7ea91c75338009d7ef07df937ee9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct timeval&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a7c221ca909fed50cb51bd59b0855bc68">unpackdate</a> (unsigned char *i)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">unpack a date and return  <a href="#a7c221ca909fed50cb51bd59b0855bc68"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a0ec2365c36d7af29acf3bdaad02b082a">unpacksms</a> (unsigned char dcs, unsigned char *i, unsigned char *udh, int *udhl, unsigned short *ud, int *udl, char udhi)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">general unpack - starts with length byte (octet or septet) and returns <a class="el" href="structnumber.html" title="Number structure.">number</a> of bytes used, inc length  <a href="#a0ec2365c36d7af29acf3bdaad02b082a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#ab53eb989ad561eab70f9002277d99703">unpacksms16</a> (unsigned char *i, unsigned char l, unsigned char *udh, int *udhl, unsigned short *ud, int *udl, char udhi)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">unpacks bytes (16 bit encoding) at i, len l septets, and places in udh and ud setting udhl and udl. udh not used if udhi not set  <a href="#ab53eb989ad561eab70f9002277d99703"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#aa65901d23702596493c076cac99112f0">unpacksms7</a> (unsigned char *i, unsigned char l, unsigned char *udh, int *udhl, unsigned short *ud, int *udl, char udhi)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">unpacks bytes (7 bit encoding) at i, len l septets, and places in udh and ud setting udhl and udl. udh not used if udhi not set  <a href="#aa65901d23702596493c076cac99112f0"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a6b1ce90cce234e2c4dc75da9046c21b5">unpacksms8</a> (unsigned char *i, unsigned char l, unsigned char *udh, int *udhl, unsigned short *ud, int *udl, char udhi)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">unpacks bytes (8 bit encoding) at i, len l septets, and places in udh and ud setting udhl and udl. udh not used if udhi not set.  <a href="#a6b1ce90cce234e2c4dc75da9046c21b5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static long&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a375cda00ad33985349625ad6f8ae70ef">utf8decode</a> (unsigned char **pp)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Reads next UCS character from NUL terminated UTF-8 string and advance pointer.  <a href="#a375cda00ad33985349625ad6f8ae70ef"></a><br/></td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a> = &quot;SMS&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const unsigned short&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a34ddced579016642f988389bc44752c0">defaultalphabet</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const unsigned short&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a70ca3c30c6f517d2f8ebd04edae4d892">escapes</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#ad0345d4821606480fcb0e28327340660">log_file</a> [255]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static volatile unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a0e5e2d705fb17b7f583cd711a5d47467">message_ref</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static volatile unsigned int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a8514112da88a5d13451aaf8c9b064017">seq</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum  { ... } &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a8caa98f3ff84c7125419ed99ac08631f">sms_flags</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum  { ... } &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a0177ab258c23182996ff959baca1df16">sms_opt_args</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__generator.html">ast_generator</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a1905c14fd0a53bc591a77d9bb4d029ca">smsgen</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static signed short&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#abac9a140958529feb213ec48e0deaca7">wave</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const <a class="el" href="app__sms_8c.html#a4008af70ba477f60e932df6815dac38d">output_t</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__sms_8c.html#a1c6c81d0dd59e7e04ac232639a5db460">wave_out</a> = <a class="el" href="app__sms_8c.html#abac9a140958529feb213ec48e0deaca7">wave</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>SMS application - ETSI ES 201 912 protocol 1 implementation. </p>
<dl class="user"><dt><b>Development notes</b></dt><dd></dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>The ETSI standards are available free of charge from ETSI at <a href="http://pda.etsi.org/pda/queryform.asp">http://pda.etsi.org/pda/queryform.asp</a> Among the relevant documents here we have:</dd></dl>
<p>ES 201 912 SMS for PSTN/ISDN TS 123 040 Technical realization of SMS</p>
<dl class="author"><dt><b>Author:</b></dt><dd>Adrian Kennard (for the original protocol 1 code) </dd>
<dd>
Filippo Grassilli (Hyppo) - protocol 2 support Not fully tested, under development </dd></dl>

<p>Definition in file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a534407082ad8ffdc07f2143b239e17c6"></a><!-- doxytag: member="app_sms.c::__OUT_FMT" ref="a534407082ad8ffdc07f2143b239e17c6" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define __OUT_FMT&nbsp;&nbsp;&nbsp;AST_FORMAT_SLINEAR</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00143">143</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01589">sms_generate()</a>.</p>

</div>
</div>
<a class="anchor" id="aa4fbf8951a3590171e5def3f7d4cd666"></a><!-- doxytag: member="app_sms.c::DIR_RX" ref="aa4fbf8951a3590171e5def3f7d4cd666" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DIR_RX&nbsp;&nbsp;&nbsp;1</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01468">1468</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01470">sms_debug()</a>, and <a class="el" href="app__sms_8c_source.html#l01488">sms_messagerx()</a>.</p>

</div>
</div>
<a class="anchor" id="af85a8c6a09856dbb3bc88c829432db58"></a><!-- doxytag: member="app_sms.c::DIR_TX" ref="af85a8c6a09856dbb3bc88c829432db58" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DIR_TX&nbsp;&nbsp;&nbsp;2</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01469">1469</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01546">sms_messagetx()</a>.</p>

</div>
</div>
<a class="anchor" id="a6c597ad0ac2a2eea8e6653e622742287"></a><!-- doxytag: member="app_sms.c::DLL2_ACK" ref="a6c597ad0ac2a2eea8e6653e622742287" args="(h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DLL2_ACK</td>
          <td>(</td>
          <td class="paramtype">h&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td>&nbsp;&nbsp;&nbsp;((h-&gt;framenumber &amp; 1) ? DLL2_SMS_ACK1: DLL2_SMS_ACK1)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01329">sms_messagerx2()</a>.</p>

</div>
</div>
<a class="anchor" id="a8bdd552aa3abf01b520c87815e1c2b24"></a><!-- doxytag: member="app_sms.c::is16bit" ref="a8bdd552aa3abf01b520c87815e1c2b24" args="(dcs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define is16bit</td>
          <td>(</td>
          <td class="paramtype">dcs&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td>&nbsp;&nbsp;&nbsp;( ((dcs) &amp; 0xC0) ? 0               : (((dcs) &amp; 0xc) == 8) )</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00275">275</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00813">sms_readfile()</a>.</p>

</div>
</div>
<a class="anchor" id="a39743cbea53fca38237f049acd4cb834"></a><!-- doxytag: member="app_sms.c::is7bit" ref="a39743cbea53fca38237f049acd4cb834" args="(dcs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define is7bit</td>
          <td>(</td>
          <td class="paramtype">dcs&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td>&nbsp;&nbsp;&nbsp;( ((dcs) &amp; 0xC0) ? (!((dcs) &amp; 4) ) : (((dcs) &amp; 0xc) == 0) )</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00273">273</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00512">packsms()</a>, <a class="el" href="app__sms_8c_source.html#l00813">sms_readfile()</a>, and <a class="el" href="app__sms_8c_source.html#l00704">unpacksms()</a>.</p>

</div>
</div>
<a class="anchor" id="a5f533f0d22e8b3eac586398fbae67636"></a><!-- doxytag: member="app_sms.c::is8bit" ref="a5f533f0d22e8b3eac586398fbae67636" args="(dcs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define is8bit</td>
          <td>(</td>
          <td class="paramtype">dcs&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td>&nbsp;&nbsp;&nbsp;( ((dcs) &amp; 0xC0) ? ( ((dcs) &amp; 4) ) : (((dcs) &amp; 0xc) == 4) )</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00274">274</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00512">packsms()</a>, <a class="el" href="app__sms_8c_source.html#l00813">sms_readfile()</a>, and <a class="el" href="app__sms_8c_source.html#l00704">unpacksms()</a>.</p>

</div>
</div>
<a class="anchor" id="ad88625c032fc5b3a096a60ddd129e2f4"></a><!-- doxytag: member="app_sms.c::MAX_DEBUG_LEN" ref="ad88625c032fc5b3a096a60ddd129e2f4" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_DEBUG_LEN&nbsp;&nbsp;&nbsp;300</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01234">1234</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01248">sms_handleincoming_proto2()</a>, and <a class="el" href="app__sms_8c_source.html#l01235">sms_hexdump()</a>.</p>

</div>
</div>
<a class="anchor" id="a6706e49765398fb7ec5e9e4bb66c3e64"></a><!-- doxytag: member="app_sms.c::MAXSAMPLES" ref="a6706e49765398fb7ec5e9e4bb66c3e64" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAXSAMPLES&nbsp;&nbsp;&nbsp;(800)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01589">sms_generate()</a>.</p>

</div>
</div>
<a class="anchor" id="ae0ea1fb3f3d1fdc8111f0c54d71afb1c"></a><!-- doxytag: member="app_sms.c::OSYNC_BITS" ref="ae0ea1fb3f3d1fdc8111f0c54d71afb1c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OSYNC_BITS&nbsp;&nbsp;&nbsp;80</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00146">146</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01546">sms_messagetx()</a>.</p>

</div>
</div>
<a class="anchor" id="a92bf696f8279259f5741564c2c2b2af2"></a><!-- doxytag: member="app_sms.c::SMSLEN" ref="a92bf696f8279259f5741564c2c2b2af2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SMSLEN&nbsp;&nbsp;&nbsp;160</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>max SMS length </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00209">209</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00361">packsms7()</a>, and <a class="el" href="app__sms_8c_source.html#l00813">sms_readfile()</a>.</p>

</div>
</div>
<a class="anchor" id="ac59f0c328bf0668e86f21b74183de226"></a><!-- doxytag: member="app_sms.c::SMSLEN_8" ref="ac59f0c328bf0668e86f21b74183de226" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SMSLEN_8&nbsp;&nbsp;&nbsp;140</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>max SMS length for 8-bit char </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00210">210</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00477">packsms16()</a>, and <a class="el" href="app__sms_8c_source.html#l00438">packsms8()</a>.</p>

</div>
</div>
<hr/><h2>Typedef Documentation</h2>
<a class="anchor" id="a4008af70ba477f60e932df6815dac38d"></a><!-- doxytag: member="app_sms.c::output_t" ref="a4008af70ba477f60e932df6815dac38d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef signed short <a class="el" href="app__sms_8c.html#a4008af70ba477f60e932df6815dac38d">output_t</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00141">141</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

</div>
</div>
<a class="anchor" id="a03faa096cd1695c08d2134dc6ae7d1fe"></a><!-- doxytag: member="app_sms.c::sms_t" ref="a03faa096cd1695c08d2134dc6ae7d1fe" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structsms__s.html">sms_s</a>  <a class="el" href="structsms__s.html">sms_t</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Enumeration Type Documentation</h2>
<a class="anchor" id="ae8a3b6a5d0d3244ed73924ab2421a0d0"></a><!-- doxytag: member="app_sms.c::@48" ref="ae8a3b6a5d0d3244ed73924ab2421a0d0" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="ae8a3b6a5d0d3244ed73924ab2421a0d0a6d9f8a190a30fdff2d003fe406ab23f9"></a><!-- doxytag: member="OPTION_BE_SMSC" ref="ae8a3b6a5d0d3244ed73924ab2421a0d0a6d9f8a190a30fdff2d003fe406ab23f9" args="" -->OPTION_BE_SMSC</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="ae8a3b6a5d0d3244ed73924ab2421a0d0a078a4fe6b4252bcd185df43f051ecd53"></a><!-- doxytag: member="OPTION_ANSWER" ref="ae8a3b6a5d0d3244ed73924ab2421a0d0a078a4fe6b4252bcd185df43f051ecd53" args="" -->OPTION_ANSWER</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="ae8a3b6a5d0d3244ed73924ab2421a0d0a6a8237166dcc5e4ec9cf6671b91d8dd4"></a><!-- doxytag: member="OPTION_TWO" ref="ae8a3b6a5d0d3244ed73924ab2421a0d0a6a8237166dcc5e4ec9cf6671b91d8dd4" args="" -->OPTION_TWO</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="ae8a3b6a5d0d3244ed73924ab2421a0d0a72c537a2238414194f4b6f309e3a668e"></a><!-- doxytag: member="OPTION_PAUSE" ref="ae8a3b6a5d0d3244ed73924ab2421a0d0a72c537a2238414194f4b6f309e3a668e" args="" -->OPTION_PAUSE</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="ae8a3b6a5d0d3244ed73924ab2421a0d0a0b148357a99551d297160a7b98600695"></a><!-- doxytag: member="OPTION_SRR" ref="ae8a3b6a5d0d3244ed73924ab2421a0d0a0b148357a99551d297160a7b98600695" args="" -->OPTION_SRR</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="ae8a3b6a5d0d3244ed73924ab2421a0d0a8a74ad47b1edfb9e69bfa73516388781"></a><!-- doxytag: member="OPTION_DCS" ref="ae8a3b6a5d0d3244ed73924ab2421a0d0a8a74ad47b1edfb9e69bfa73516388781" args="" -->OPTION_DCS</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01835">1835</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01835"></a>01835      {
<a name="l01836"></a>01836    <a class="code" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a6d9f8a190a30fdff2d003fe406ab23f9">OPTION_BE_SMSC</a> = (1 &lt;&lt; 0),             <span class="comment">/* act as sms center */</span>
<a name="l01837"></a>01837    <a class="code" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a078a4fe6b4252bcd185df43f051ecd53">OPTION_ANSWER</a>  = (1 &lt;&lt; 1),             <span class="comment">/* answer on incoming calls */</span>
<a name="l01838"></a>01838    <a class="code" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a6a8237166dcc5e4ec9cf6671b91d8dd4">OPTION_TWO</a>  = (1 &lt;&lt; 2),                 <span class="comment">/* Use Protocol Two */</span>
<a name="l01839"></a>01839    <a class="code" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a72c537a2238414194f4b6f309e3a668e">OPTION_PAUSE</a>   = (1 &lt;&lt; 3),             <span class="comment">/* pause before sending data, in ms */</span>
<a name="l01840"></a>01840    <a class="code" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a0b148357a99551d297160a7b98600695">OPTION_SRR</a>  = (1 &lt;&lt; 4),                 <span class="comment">/* set srr */</span>
<a name="l01841"></a>01841    <a class="code" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a8a74ad47b1edfb9e69bfa73516388781">OPTION_DCS</a>  = (1 &lt;&lt; 5),                 <span class="comment">/* set dcs */</span>
<a name="l01842"></a>01842 } <a class="code" href="app__sms_8c.html#a8caa98f3ff84c7125419ed99ac08631f">sms_flags</a>;
</pre></div></p>

</div>
</div>
<a class="anchor" id="af715e26dfffd1f8de1c18449e2770cff"></a><!-- doxytag: member="app_sms.c::@49" ref="af715e26dfffd1f8de1c18449e2770cff" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="af715e26dfffd1f8de1c18449e2770cffa00c83650e6758ad93ede9f7db2dbf567"></a><!-- doxytag: member="OPTION_ARG_PAUSE" ref="af715e26dfffd1f8de1c18449e2770cffa00c83650e6758ad93ede9f7db2dbf567" args="" -->OPTION_ARG_PAUSE</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af715e26dfffd1f8de1c18449e2770cffad8be72595381ce66309dcc938077316b"></a><!-- doxytag: member="OPTION_ARG_ARRAY_SIZE" ref="af715e26dfffd1f8de1c18449e2770cffad8be72595381ce66309dcc938077316b" args="" -->OPTION_ARG_ARRAY_SIZE</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01844">1844</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01844"></a>01844      {
<a name="l01845"></a>01845    <a class="code" href="app__sms_8c.html#af715e26dfffd1f8de1c18449e2770cffa00c83650e6758ad93ede9f7db2dbf567">OPTION_ARG_PAUSE</a> = 0,
<a name="l01846"></a>01846    <a class="code" href="app__skel_8c.html#af3520ff6d43011872bab77edd27d4de3ad8be72595381ce66309dcc938077316b">OPTION_ARG_ARRAY_SIZE</a>
<a name="l01847"></a>01847 } <a class="code" href="app__sms_8c.html#a0177ab258c23182996ff959baca1df16">sms_opt_args</a>;
</pre></div></p>

</div>
</div>
<a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9"></a><!-- doxytag: member="app_sms.c::message_types" ref="aadad57a8949618b7d23705b7d718c9f9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9">message_types</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>The SMS spec ETSI ES 201 912 defines two protocols with different <a class="el" href="structmessage.html">message</a> types. Also note that the high bit is used to indicate whether the <a class="el" href="structmessage.html">message</a> is complete or not, but in two opposite ways: for Protocol 1, 0x80 means that the <a class="el" href="structmessage.html">message</a> is complete; for Protocol 2, 0x00 means that the <a class="el" href="structmessage.html">message</a> is complete; </p>
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9ab52fa5194e2be3c8953de452277a1ae6"></a><!-- doxytag: member="DLL_SMS_MASK" ref="aadad57a8949618b7d23705b7d718c9f9ab52fa5194e2be3c8953de452277a1ae6" args="" -->DLL_SMS_MASK</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a3494ff7bd605a6ca055b31309459c65a"></a><!-- doxytag: member="DLL1_SMS_DATA" ref="aadad57a8949618b7d23705b7d718c9f9a3494ff7bd605a6ca055b31309459c65a" args="" -->DLL1_SMS_DATA</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a24bdd3ee7147c8b7eb741cec3198925c"></a><!-- doxytag: member="DLL1_SMS_ERROR" ref="aadad57a8949618b7d23705b7d718c9f9a24bdd3ee7147c8b7eb741cec3198925c" args="" -->DLL1_SMS_ERROR</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9aa93cd3c00de7548f03cc83a73833b626"></a><!-- doxytag: member="DLL1_SMS_EST" ref="aadad57a8949618b7d23705b7d718c9f9aa93cd3c00de7548f03cc83a73833b626" args="" -->DLL1_SMS_EST</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9af63c95cbe39f23e6ad26f2ba0e9923f8"></a><!-- doxytag: member="DLL1_SMS_REL" ref="aadad57a8949618b7d23705b7d718c9f9af63c95cbe39f23e6ad26f2ba0e9923f8" args="" -->DLL1_SMS_REL</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a79172f5903fec0db6f4db43c6d985969"></a><!-- doxytag: member="DLL1_SMS_ACK" ref="aadad57a8949618b7d23705b7d718c9f9a79172f5903fec0db6f4db43c6d985969" args="" -->DLL1_SMS_ACK</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a5ea467e78e6a31d09860fcb35dec1338"></a><!-- doxytag: member="DLL1_SMS_NACK" ref="aadad57a8949618b7d23705b7d718c9f9a5ea467e78e6a31d09860fcb35dec1338" args="" -->DLL1_SMS_NACK</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a96e7ed27f789598728cae97a4f9abbe4"></a><!-- doxytag: member="DLL1_SMS_COMPLETE" ref="aadad57a8949618b7d23705b7d718c9f9a96e7ed27f789598728cae97a4f9abbe4" args="" -->DLL1_SMS_COMPLETE</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a1f477137c2be1ae63f113d7f08683e51"></a><!-- doxytag: member="DLL1_SMS_MORE" ref="aadad57a8949618b7d23705b7d718c9f9a1f477137c2be1ae63f113d7f08683e51" args="" -->DLL1_SMS_MORE</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a5df5d537055950e483ab1b368c26d73f"></a><!-- doxytag: member="DLL2_SMS_EST" ref="aadad57a8949618b7d23705b7d718c9f9a5df5d537055950e483ab1b368c26d73f" args="" -->DLL2_SMS_EST</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a3d9593f4f21b1e09861ef6ff8787b3e5"></a><!-- doxytag: member="DLL2_SMS_INFO_MO" ref="aadad57a8949618b7d23705b7d718c9f9a3d9593f4f21b1e09861ef6ff8787b3e5" args="" -->DLL2_SMS_INFO_MO</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a01cbc78b9b22bc743fa76b52bc31b99b"></a><!-- doxytag: member="DLL2_SMS_INFO_MT" ref="aadad57a8949618b7d23705b7d718c9f9a01cbc78b9b22bc743fa76b52bc31b99b" args="" -->DLL2_SMS_INFO_MT</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a250be9e2438762a2a98cfa0c90db9f82"></a><!-- doxytag: member="DLL2_SMS_INFO_STA" ref="aadad57a8949618b7d23705b7d718c9f9a250be9e2438762a2a98cfa0c90db9f82" args="" -->DLL2_SMS_INFO_STA</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9ae7948b7f83c79737c57370e63d2b6ea8"></a><!-- doxytag: member="DLL2_SMS_NACK" ref="aadad57a8949618b7d23705b7d718c9f9ae7948b7f83c79737c57370e63d2b6ea8" args="" -->DLL2_SMS_NACK</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a20c3011fb7a87c560c2defa4de284855"></a><!-- doxytag: member="DLL2_SMS_ACK0" ref="aadad57a8949618b7d23705b7d718c9f9a20c3011fb7a87c560c2defa4de284855" args="" -->DLL2_SMS_ACK0</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a0939445034985054325921b2b0e8403a"></a><!-- doxytag: member="DLL2_SMS_ACK1" ref="aadad57a8949618b7d23705b7d718c9f9a0939445034985054325921b2b0e8403a" args="" -->DLL2_SMS_ACK1</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9ae8e8868e7f35bd6dff10f69df0e2b652"></a><!-- doxytag: member="DLL2_SMS_ENQ" ref="aadad57a8949618b7d23705b7d718c9f9ae8e8868e7f35bd6dff10f69df0e2b652" args="" -->DLL2_SMS_ENQ</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a4beada5edbf9c5838f1bbc26eb74b8bf"></a><!-- doxytag: member="DLL2_SMS_REL" ref="aadad57a8949618b7d23705b7d718c9f9a4beada5edbf9c5838f1bbc26eb74b8bf" args="" -->DLL2_SMS_REL</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9adcb4bce99e6a020f51aaad2aa1310735"></a><!-- doxytag: member="DLL2_SMS_COMPLETE" ref="aadad57a8949618b7d23705b7d718c9f9adcb4bce99e6a020f51aaad2aa1310735" args="" -->DLL2_SMS_COMPLETE</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aadad57a8949618b7d23705b7d718c9f9a316b96f57093ff10ba8b88d474e27ed4"></a><!-- doxytag: member="DLL2_SMS_MORE" ref="aadad57a8949618b7d23705b7d718c9f9a316b96f57093ff10ba8b88d474e27ed4" args="" -->DLL2_SMS_MORE</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00155">155</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00155"></a>00155                    {
<a name="l00156"></a>00156    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9ab52fa5194e2be3c8953de452277a1ae6">DLL_SMS_MASK</a>        = 0x7f,             <span class="comment">/* mask for the valid bits */</span>
<a name="l00157"></a>00157 
<a name="l00158"></a>00158    <span class="comment">/* Protocol 1 values */</span>
<a name="l00159"></a>00159    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a3494ff7bd605a6ca055b31309459c65a">DLL1_SMS_DATA</a>       = 0x11,             <span class="comment">/* data packet */</span>
<a name="l00160"></a>00160    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a24bdd3ee7147c8b7eb741cec3198925c">DLL1_SMS_ERROR</a>      = 0x12,
<a name="l00161"></a>00161    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9aa93cd3c00de7548f03cc83a73833b626">DLL1_SMS_EST</a>        = 0x13,             <span class="comment">/* start the connection */</span>
<a name="l00162"></a>00162    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9af63c95cbe39f23e6ad26f2ba0e9923f8">DLL1_SMS_REL</a>        = 0x14,             <span class="comment">/* end the connection */</span>
<a name="l00163"></a>00163    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a79172f5903fec0db6f4db43c6d985969">DLL1_SMS_ACK</a>        = 0x15,
<a name="l00164"></a>00164    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a5ea467e78e6a31d09860fcb35dec1338">DLL1_SMS_NACK</a>       = 0x16,
<a name="l00165"></a>00165 
<a name="l00166"></a>00166    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a96e7ed27f789598728cae97a4f9abbe4">DLL1_SMS_COMPLETE</a>   = 0x80,             <span class="comment">/* packet is complete */</span>
<a name="l00167"></a>00167    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a1f477137c2be1ae63f113d7f08683e51">DLL1_SMS_MORE</a>       = 0x00,             <span class="comment">/* more data to follow */</span>
<a name="l00168"></a>00168 
<a name="l00169"></a>00169    <span class="comment">/* Protocol 2 values */</span>
<a name="l00170"></a>00170    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a5df5d537055950e483ab1b368c26d73f">DLL2_SMS_EST</a>        = 0x7f,             <span class="comment">/* magic number. No message body */</span>
<a name="l00171"></a>00171    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a3d9593f4f21b1e09861ef6ff8787b3e5">DLL2_SMS_INFO_MO</a>    = 0x10,
<a name="l00172"></a>00172    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a01cbc78b9b22bc743fa76b52bc31b99b">DLL2_SMS_INFO_MT</a>    = 0x11,
<a name="l00173"></a>00173    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a250be9e2438762a2a98cfa0c90db9f82">DLL2_SMS_INFO_STA</a>   = 0x12,
<a name="l00174"></a>00174    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9ae7948b7f83c79737c57370e63d2b6ea8">DLL2_SMS_NACK</a>       = 0x13,
<a name="l00175"></a>00175    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a20c3011fb7a87c560c2defa4de284855">DLL2_SMS_ACK0</a>       = 0x14,             <span class="comment">/* ack even-numbered frame */</span>
<a name="l00176"></a>00176    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a0939445034985054325921b2b0e8403a">DLL2_SMS_ACK1</a>       = 0x15,             <span class="comment">/* ack odd-numbered frame */</span>
<a name="l00177"></a>00177    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9ae8e8868e7f35bd6dff10f69df0e2b652">DLL2_SMS_ENQ</a>        = 0x16,
<a name="l00178"></a>00178    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a4beada5edbf9c5838f1bbc26eb74b8bf">DLL2_SMS_REL</a>        = 0x17,             <span class="comment">/* end the connection */</span>
<a name="l00179"></a>00179 
<a name="l00180"></a>00180    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9adcb4bce99e6a020f51aaad2aa1310735">DLL2_SMS_COMPLETE</a>   = 0x00,             <span class="comment">/* packet is complete */</span>
<a name="l00181"></a>00181    <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a316b96f57093ff10ba8b88d474e27ed4">DLL2_SMS_MORE</a>       = 0x80,             <span class="comment">/* more data to follow */</span>
<a name="l00182"></a>00182 };
</pre></div></p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="adfb54a6105314c1847b33ff2b7f24fb9"></a><!-- doxytag: member="app_sms.c::adddata_proto2" ref="adfb54a6105314c1847b33ff2b7f24fb9" args="(sms_t *h, unsigned char msg, char *data, int size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void adddata_proto2 </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>size</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Add data to a protocol 2 <a class="el" href="structmessage.html">message</a>. Use the length field (h-&gt;omsg[1]) as a pointer to the next free position. </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01174">1174</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="app__sms_8c_source.html#l00241">sms_s::omsg</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01199">sms_compose2()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01175"></a>01175 {
<a name="l01176"></a>01176    <span class="keywordtype">int</span> x = h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] + 2;                 <span class="comment">/* Get current position */</span>
<a name="l01177"></a>01177    <span class="keywordflow">if</span> (x == 2) {
<a name="l01178"></a>01178       x += 2;                             <span class="comment">/* First: skip Payload length (set later) */</span>
<a name="l01179"></a>01179    }
<a name="l01180"></a>01180    h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[x++] = <a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>;                     <span class="comment">/* Message code */</span>
<a name="l01181"></a>01181    h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[x++] = (<span class="keywordtype">unsigned</span> char)size;     <span class="comment">/* Data size Low */</span>
<a name="l01182"></a>01182    h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[x++] = 0;                       <span class="comment">/* Data size Hi */</span>
<a name="l01183"></a>01183    <span class="keywordflow">for</span> (; size &gt; 0 ; size--) {
<a name="l01184"></a>01184       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[x++] = *data++;
<a name="l01185"></a>01185    }
<a name="l01186"></a>01186    h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = x - 2;                     <span class="comment">/* Frame size */</span>
<a name="l01187"></a>01187    h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[2] = x - 4;                     <span class="comment">/* Payload length (Lo) */</span>
<a name="l01188"></a>01188    h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[3] = 0;                         <span class="comment">/* Payload length (Hi) */</span>
<a name="l01189"></a>01189 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7d5d2871ceb7379204bf4f57b0425d1a"></a><!-- doxytag: member="app_sms.c::AST_APP_OPTIONS" ref="a7d5d2871ceb7379204bf4f57b0425d1a" args="(sms_options,{AST_APP_OPTION('s', OPTION_BE_SMSC), AST_APP_OPTION('a', OPTION_ANSWER), AST_APP_OPTION('t', OPTION_TWO), AST_APP_OPTION('r', OPTION_SRR), AST_APP_OPTION('o', OPTION_DCS), AST_APP_OPTION_ARG('p', OPTION_PAUSE, OPTION_ARG_PAUSE),})" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">AST_APP_OPTIONS </td>
          <td>(</td>
          <td class="paramtype">sms_options&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a0286051e93e484a687b21cc0e9027fec"></a><!-- doxytag: member="app_sms.c::AST_MODULE_INFO_STANDARD" ref="a0286051e93e484a687b21cc0e9027fec" args="(ASTERISK_GPL_KEY,&quot;SMS/PSTN handler&quot;)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">AST_MODULE_INFO_STANDARD </td>
          <td>(</td>
          <td class="paramtype">ASTERISK_GPL_KEY&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&quot;SMS/PSTN handler&quot;&nbsp;</td>
          <td class="paramname"></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="aa82dbf6bb6292091b6f9ac19cc841428"></a><!-- doxytag: member="app_sms.c::isodate" ref="aa82dbf6bb6292091b6f9ac19cc841428" args="(time_t t, char *buf, int len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* isodate </td>
          <td>(</td>
          <td class="paramtype">time_t&nbsp;</td>
          <td class="paramname"> <em>t</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>static, return a date/time in ISO format </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00295">295</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="localtime_8c_source.html#l01305">ast_localtime()</a>, and <a class="el" href="localtime_8c_source.html#l01928">ast_strftime()</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00765">sms_log()</a>, and <a class="el" href="app__sms_8c_source.html#l00984">sms_writefile()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00296"></a>00296 {
<a name="l00297"></a>00297    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l00298"></a>00298    <span class="keyword">struct </span>timeval local = { t, 0 };
<a name="l00299"></a>00299    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;local, &amp;tm, NULL);
<a name="l00300"></a>00300    <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="stringliteral">&quot;%Y-%m-%dT%H:%M:%S&quot;</span>, &amp;tm);
<a name="l00301"></a>00301    <span class="keywordflow">return</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l00302"></a>00302 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac3382bf6da54c56b37069bd76bbdf4f9"></a><!-- doxytag: member="app_sms.c::load_module" ref="ac3382bf6da54c56b37069bd76bbdf4f9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l02052">2052</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="asterisk_8c_source.html#l00255">ast_config_AST_LOG_DIR</a>, <a class="el" href="alaw_8h_source.html#l00050">AST_LIN2A</a>, <a class="el" href="module_8h_source.html#l00406">ast_register_application_xml</a>, and <a class="el" href="app__sms_8c_source.html#l01858">sms_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02053"></a>02053 {
<a name="l02054"></a>02054 <span class="preprocessor">#ifdef OUTALAW</span>
<a name="l02055"></a>02055 <span class="preprocessor"></span>   <span class="keywordtype">int</span> p;
<a name="l02056"></a>02056    <span class="keywordflow">for</span> (p = 0; p &lt; 80; p++) {
<a name="l02057"></a>02057       wavea[p] = <a class="code" href="alaw_8h.html#a45b65da856bb05f79d22425d41457e0f">AST_LIN2A</a>(<a class="code" href="app__sms_8c.html#abac9a140958529feb213ec48e0deaca7">wave</a>[p]);
<a name="l02058"></a>02058    }
<a name="l02059"></a>02059 <span class="preprocessor">#endif</span>
<a name="l02060"></a>02060 <span class="preprocessor"></span>   snprintf(<a class="code" href="app__sms_8c.html#ad0345d4821606480fcb0e28327340660">log_file</a>, <span class="keyword">sizeof</span>(<a class="code" href="app__sms_8c.html#ad0345d4821606480fcb0e28327340660">log_file</a>), <span class="stringliteral">&quot;%s/sms&quot;</span>, <a class="code" href="paths_8h.html#aea5e16ca2517e2093fdfa0e7fd112f0f">ast_config_AST_LOG_DIR</a>);
<a name="l02061"></a>02061    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a>, <a class="code" href="app__sms_8c.html#a587be46ef6675e0c5477d125dc1e1b27">sms_exec</a>);
<a name="l02062"></a>02062 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a660b5407faba61b0835356de97c78a0c"></a><!-- doxytag: member="app_sms.c::numcpy" ref="a660b5407faba61b0835356de97c78a0c" args="(char *d, char *s)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void numcpy </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>s</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>copy <a class="el" href="structnumber.html" title="Number structure.">number</a>, skipping non digits apart from leading + </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00280">280</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00813">sms_readfile()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00281"></a>00281 {
<a name="l00282"></a>00282    <span class="keywordflow">if</span> (*<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> == <span class="charliteral">&apos;+&apos;</span>) {
<a name="l00283"></a>00283       *d++ = *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>++;
<a name="l00284"></a>00284    }
<a name="l00285"></a>00285    <span class="keywordflow">while</span> (*<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>) {
<a name="l00286"></a>00286       <span class="keywordflow">if</span> (isdigit(*<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)) {
<a name="l00287"></a>00287          *d++ = *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00288"></a>00288       }
<a name="l00289"></a>00289       <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>++;
<a name="l00290"></a>00290    }
<a name="l00291"></a>00291    *d = 0;
<a name="l00292"></a>00292 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aea46af6597884cf32d85f18a52129711"></a><!-- doxytag: member="app_sms.c::packaddress" ref="aea46af6597884cf32d85f18a52129711" args="(unsigned char *o, char *i)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static unsigned char packaddress </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>o</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>i</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>store an address at o, and return <a class="el" href="structnumber.html" title="Number structure.">number</a> of bytes used </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00737">737</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01386">sms_compose1()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00738"></a>00738 {
<a name="l00739"></a>00739    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> p = 2;
<a name="l00740"></a>00740    o[0] = 0;                               <span class="comment">/* number of bytes */</span>
<a name="l00741"></a>00741    <span class="keywordflow">if</span> (*i == <span class="charliteral">&apos;+&apos;</span>) {                        <span class="comment">/* record as bit 0 in byte 1 */</span>
<a name="l00742"></a>00742       i++;
<a name="l00743"></a>00743       o[1] = 0x91;
<a name="l00744"></a>00744    } <span class="keywordflow">else</span> {
<a name="l00745"></a>00745       o[1] = 0x81;
<a name="l00746"></a>00746    }
<a name="l00747"></a>00747    <span class="keywordflow">for</span> ( ; *i ; i++) {
<a name="l00748"></a>00748       <span class="keywordflow">if</span> (!isdigit(*i)) {                 <span class="comment">/* ignore non-digits */</span>
<a name="l00749"></a>00749          <span class="keywordflow">continue</span>;
<a name="l00750"></a>00750       }
<a name="l00751"></a>00751       <span class="keywordflow">if</span> (o[0] &amp; 1) {
<a name="l00752"></a>00752          o[p++] |= ((*i &amp; 0xF) &lt;&lt; 4);
<a name="l00753"></a>00753       } <span class="keywordflow">else</span> {
<a name="l00754"></a>00754          o[p] = (*i &amp; 0xF);
<a name="l00755"></a>00755       }
<a name="l00756"></a>00756       o[0]++;
<a name="l00757"></a>00757    }
<a name="l00758"></a>00758    <span class="keywordflow">if</span> (o[0] &amp; 1) {
<a name="l00759"></a>00759       o[p++] |= 0xF0;                     <span class="comment">/* pad */</span>
<a name="l00760"></a>00760    }
<a name="l00761"></a>00761    <span class="keywordflow">return</span> p;
<a name="l00762"></a>00762 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a902aeb4504023853fd6f91429a2855e3"></a><!-- doxytag: member="app_sms.c::packdate" ref="a902aeb4504023853fd6f91429a2855e3" args="(unsigned char *o, time_t w)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void packdate </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>o</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">time_t&nbsp;</td>
          <td class="paramname"> <em>w</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>pack a date and return </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00545">545</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="localtime_8c_source.html#l01305">ast_localtime()</a>, <a class="el" href="localtime_8h_source.html#l00037">ast_tm::tm_gmtoff</a>, <a class="el" href="localtime_8h_source.html#l00030">ast_tm::tm_hour</a>, <a class="el" href="localtime_8h_source.html#l00031">ast_tm::tm_mday</a>, <a class="el" href="localtime_8h_source.html#l00029">ast_tm::tm_min</a>, <a class="el" href="localtime_8h_source.html#l00032">ast_tm::tm_mon</a>, <a class="el" href="localtime_8h_source.html#l00028">ast_tm::tm_sec</a>, and <a class="el" href="localtime_8h_source.html#l00033">ast_tm::tm_year</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01386">sms_compose1()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00546"></a>00546 {
<a name="l00547"></a>00547    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> t;
<a name="l00548"></a>00548    <span class="keyword">struct </span>timeval topack = { w, 0 };
<a name="l00549"></a>00549    <span class="keywordtype">int</span> z;
<a name="l00550"></a>00550 
<a name="l00551"></a>00551    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;topack, &amp;t, NULL);
<a name="l00552"></a>00552 <span class="preprocessor">#if defined(__FreeBSD__) || defined(__OpenBSD__) || defined( __NetBSD__ ) || defined(__APPLE__) || defined(__CYGWIN__)</span>
<a name="l00553"></a>00553 <span class="preprocessor"></span>   z = -t.tm_gmtoff / 60 / 15;
<a name="l00554"></a>00554 <span class="preprocessor">#else</span>
<a name="l00555"></a>00555 <span class="preprocessor"></span>   z = timezone / 60 / 15;
<a name="l00556"></a>00556 <span class="preprocessor">#endif</span>
<a name="l00557"></a>00557 <span class="preprocessor"></span>   *o++ = ((t.tm_year % 10) &lt;&lt; 4) + (t.tm_year % 100) / 10;
<a name="l00558"></a>00558    *o++ = (((t.tm_mon + 1) % 10) &lt;&lt; 4) + (t.tm_mon + 1) / 10;
<a name="l00559"></a>00559    *o++ = ((t.tm_mday % 10) &lt;&lt; 4) + t.tm_mday / 10;
<a name="l00560"></a>00560    *o++ = ((t.tm_hour % 10) &lt;&lt; 4) + t.tm_hour / 10;
<a name="l00561"></a>00561    *o++ = ((t.tm_min % 10) &lt;&lt; 4) + t.tm_min / 10;
<a name="l00562"></a>00562    *o++ = ((t.tm_sec % 10) &lt;&lt; 4) + t.tm_sec / 10;
<a name="l00563"></a>00563    <span class="keywordflow">if</span> (z &lt; 0) {
<a name="l00564"></a>00564       *o++ = (((-z) % 10) &lt;&lt; 4) + (-z) / 10 + 0x08;
<a name="l00565"></a>00565    } <span class="keywordflow">else</span> {
<a name="l00566"></a>00566       *o++ = ((z % 10) &lt;&lt; 4) + z / 10;
<a name="l00567"></a>00567    }
<a name="l00568"></a>00568 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a38e1bebc872822985359d2e36c1c0448"></a><!-- doxytag: member="app_sms.c::packsms" ref="a38e1bebc872822985359d2e36c1c0448" args="(unsigned char dcs, unsigned char *base, unsigned int udhl, unsigned char *udh, int udl, unsigned short *ud)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int packsms </td>
          <td>(</td>
          <td class="paramtype">unsigned char&nbsp;</td>
          <td class="paramname"> <em>dcs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>base</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>udhl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>udh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>udl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned short *&nbsp;</td>
          <td class="paramname"> <em>ud</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>general pack, with length and data, returns <a class="el" href="structnumber.html" title="Number structure.">number</a> of bytes of target used </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00512">512</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="app__sms_8c_source.html#l00273">is7bit</a>, <a class="el" href="app__sms_8c_source.html#l00274">is8bit</a>, <a class="el" href="app__sms_8c_source.html#l00477">packsms16()</a>, <a class="el" href="app__sms_8c_source.html#l00361">packsms7()</a>, and <a class="el" href="app__sms_8c_source.html#l00438">packsms8()</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01386">sms_compose1()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00513"></a>00513 {
<a name="l00514"></a>00514    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p = base;
<a name="l00515"></a>00515    <span class="keywordflow">if</span> (udl == 0) {
<a name="l00516"></a>00516       *p++ = 0;                           <span class="comment">/* no user data */</span>
<a name="l00517"></a>00517    } <span class="keywordflow">else</span> {
<a name="l00518"></a>00518       
<a name="l00519"></a>00519       <span class="keywordtype">int</span> l = 0;
<a name="l00520"></a>00520       <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#a39743cbea53fca38237f049acd4cb834">is7bit</a>(dcs)) {                  <span class="comment">/* 7 bit */</span>
<a name="l00521"></a>00521          <span class="keywordflow">if</span> ((l = <a class="code" href="app__sms_8c.html#a172d0c2bb9c8a56df817acb5ce7bfe3c" title="takes a binary header (udhl bytes at udh) and UCS-2 message (udl characters at ud)...">packsms7</a>(p + 1, udhl, udh, udl, ud)) &lt; 0) {
<a name="l00522"></a>00522             l = 0;
<a name="l00523"></a>00523          }
<a name="l00524"></a>00524          *p++ = l;
<a name="l00525"></a>00525          p += (l * 7 + 7) / 8;
<a name="l00526"></a>00526       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#a5f533f0d22e8b3eac586398fbae67636">is8bit</a>(dcs)) {           <span class="comment">/* 8 bit */</span>
<a name="l00527"></a>00527          <span class="keywordflow">if</span> ((l = <a class="code" href="app__sms_8c.html#aa3645875887568a20059ae86c7a66f74" title="takes a binary header (udhl bytes at udh) and UCS-2 message (udl characters at ud)...">packsms8</a>(p + 1, udhl, udh, udl, ud)) &lt; 0) {
<a name="l00528"></a>00528             l = 0;
<a name="l00529"></a>00529          }
<a name="l00530"></a>00530          *p++ = l;
<a name="l00531"></a>00531          p += l;
<a name="l00532"></a>00532       } <span class="keywordflow">else</span> {                            <span class="comment">/* UCS-2 */</span>
<a name="l00533"></a>00533          <span class="keywordflow">if</span> ((l = <a class="code" href="app__sms_8c.html#a77ab80a9e6251174378df1f59b5dbc44" title="takes a binary header (udhl bytes at udh) and UCS-2 message (udl characters at ud)...">packsms16</a>(p + 1, udhl, udh, udl, ud)) &lt; 0) {
<a name="l00534"></a>00534             l = 0;
<a name="l00535"></a>00535          }
<a name="l00536"></a>00536          *p++ = l;
<a name="l00537"></a>00537          p += l;
<a name="l00538"></a>00538       }
<a name="l00539"></a>00539    }
<a name="l00540"></a>00540    <span class="keywordflow">return</span> p - base;
<a name="l00541"></a>00541 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a77ab80a9e6251174378df1f59b5dbc44"></a><!-- doxytag: member="app_sms.c::packsms16" ref="a77ab80a9e6251174378df1f59b5dbc44" args="(unsigned char *o, int udhl, unsigned char *udh, int udl, unsigned short *ud)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int packsms16 </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>o</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>udhl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>udh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>udl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned short *&nbsp;</td>
          <td class="paramname"> <em>ud</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>takes a binary header (udhl bytes at udh) and UCS-2 <a class="el" href="structmessage.html">message</a> (udl characters at ud) and packs in to o using 16 bit UCS-2 character codes The return value is the <a class="el" href="structnumber.html" title="Number structure.">number</a> of bytes packed in to o, which is internally limited to 140 o can be null, in which case this is used to validate or count only if the input contains invalid characters then the return value is -1 </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00477">477</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="chan__unistim_8c_source.html#l00183">dummy()</a>, and <a class="el" href="app__sms_8c_source.html#l00210">SMSLEN_8</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00512">packsms()</a>, and <a class="el" href="app__sms_8c_source.html#l00813">sms_readfile()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00478"></a>00478 {
<a name="l00479"></a>00479    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> p = 0;
<a name="l00480"></a>00480    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="chan__unistim_8c.html#abc0ce15d00b4bfb69266c5fd016dc88c">dummy</a>[<a class="code" href="app__sms_8c.html#ac59f0c328bf0668e86f21b74183de226">SMSLEN_8</a>];
<a name="l00481"></a>00481 
<a name="l00482"></a>00482    <span class="keywordflow">if</span> (o == NULL) {
<a name="l00483"></a>00483       o = dummy;
<a name="l00484"></a>00484    }
<a name="l00485"></a>00485    <span class="comment">/* header - no encoding */</span>
<a name="l00486"></a>00486    <span class="keywordflow">if</span> (udhl) {
<a name="l00487"></a>00487       o[p++] = udhl;
<a name="l00488"></a>00488       <span class="keywordflow">while</span> (udhl--) {
<a name="l00489"></a>00489          o[p++] = *udh++;
<a name="l00490"></a>00490          <span class="keywordflow">if</span> (p &gt;= <a class="code" href="app__sms_8c.html#ac59f0c328bf0668e86f21b74183de226">SMSLEN_8</a>) {
<a name="l00491"></a>00491             <span class="keywordflow">return</span> p;
<a name="l00492"></a>00492          }
<a name="l00493"></a>00493       }
<a name="l00494"></a>00494    }
<a name="l00495"></a>00495    <span class="keywordflow">while</span> (udl--) {
<a name="l00496"></a>00496       <span class="keywordtype">long</span> u;
<a name="l00497"></a>00497       u = *ud++;
<a name="l00498"></a>00498       o[p++] = (u &gt;&gt; 8);
<a name="l00499"></a>00499       <span class="keywordflow">if</span> (p &gt;= <a class="code" href="app__sms_8c.html#ac59f0c328bf0668e86f21b74183de226">SMSLEN_8</a>) {
<a name="l00500"></a>00500          <span class="keywordflow">return</span> p - 1;                   <span class="comment">/* could not fit last character */</span>
<a name="l00501"></a>00501       }
<a name="l00502"></a>00502       o[p++] = u;
<a name="l00503"></a>00503       <span class="keywordflow">if</span> (p &gt;= <a class="code" href="app__sms_8c.html#ac59f0c328bf0668e86f21b74183de226">SMSLEN_8</a>) {
<a name="l00504"></a>00504          <span class="keywordflow">return</span> p;
<a name="l00505"></a>00505       }
<a name="l00506"></a>00506    }
<a name="l00507"></a>00507    <span class="keywordflow">return</span> p;
<a name="l00508"></a>00508 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a172d0c2bb9c8a56df817acb5ce7bfe3c"></a><!-- doxytag: member="app_sms.c::packsms7" ref="a172d0c2bb9c8a56df817acb5ce7bfe3c" args="(unsigned char *o, int udhl, unsigned char *udh, int udl, unsigned short *ud)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int packsms7 </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>o</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>udhl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>udh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>udl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned short *&nbsp;</td>
          <td class="paramname"> <em>ud</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>takes a binary header (udhl bytes at udh) and UCS-2 <a class="el" href="structmessage.html">message</a> (udl characters at ud) and packs in to o using SMS 7 bit character codes </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00361">361</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="chan__unistim_8c_source.html#l00183">dummy()</a>, and <a class="el" href="app__sms_8c_source.html#l00209">SMSLEN</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00512">packsms()</a>, and <a class="el" href="app__sms_8c_source.html#l00813">sms_readfile()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00362"></a>00362 {
<a name="l00363"></a>00363    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> p = 0;                    <span class="comment">/* output pointer (bytes) */</span>
<a name="l00364"></a>00364    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> b = 0;                    <span class="comment">/* bit position */</span>
<a name="l00365"></a>00365    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> n = 0;                    <span class="comment">/* output character count */</span>
<a name="l00366"></a>00366    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="chan__unistim_8c.html#abc0ce15d00b4bfb69266c5fd016dc88c">dummy</a>[<a class="code" href="app__sms_8c.html#a92bf696f8279259f5741564c2c2b2af2">SMSLEN</a>];
<a name="l00367"></a>00367 
<a name="l00368"></a>00368    <span class="keywordflow">if</span> (o == NULL) {                        <span class="comment">/* output to a dummy buffer if o not set */</span>
<a name="l00369"></a>00369       o = dummy;
<a name="l00370"></a>00370    }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372    <span class="keywordflow">if</span> (udhl) {                             <span class="comment">/* header */</span>
<a name="l00373"></a>00373       o[p++] = udhl;
<a name="l00374"></a>00374       b = 1;
<a name="l00375"></a>00375       n = 1;
<a name="l00376"></a>00376       <span class="keywordflow">while</span> (udhl--) {
<a name="l00377"></a>00377          o[p++] = *udh++;
<a name="l00378"></a>00378          b += 8;
<a name="l00379"></a>00379          <span class="keywordflow">while</span> (b &gt;= 7) {
<a name="l00380"></a>00380             b -= 7;
<a name="l00381"></a>00381             n++;
<a name="l00382"></a>00382          }
<a name="l00383"></a>00383          <span class="keywordflow">if</span> (n &gt;= <a class="code" href="app__sms_8c.html#a92bf696f8279259f5741564c2c2b2af2">SMSLEN</a>)
<a name="l00384"></a>00384             <span class="keywordflow">return</span> n;
<a name="l00385"></a>00385       }
<a name="l00386"></a>00386       <span class="keywordflow">if</span> (b) {
<a name="l00387"></a>00387          b = 7 - b;
<a name="l00388"></a>00388          <span class="keywordflow">if</span> (++n &gt;= <a class="code" href="app__sms_8c.html#a92bf696f8279259f5741564c2c2b2af2">SMSLEN</a>)
<a name="l00389"></a>00389             <span class="keywordflow">return</span> n;
<a name="l00390"></a>00390       }                                   <span class="comment">/* filling to septet boundary */</span>
<a name="l00391"></a>00391    }
<a name="l00392"></a>00392    o[p] = 0;
<a name="l00393"></a>00393    <span class="comment">/* message */</span>
<a name="l00394"></a>00394    <span class="keywordflow">while</span> (udl--) {
<a name="l00395"></a>00395       <span class="keywordtype">long</span> u;
<a name="l00396"></a>00396       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> v;
<a name="l00397"></a>00397       u = *ud++;
<a name="l00398"></a>00398       <span class="comment">/* XXX 0 is invalid ? */</span>
<a name="l00399"></a>00399       <span class="comment">/* look up in defaultalphabet[]. If found, v is the 7-bit code */</span>
<a name="l00400"></a>00400       <span class="keywordflow">for</span> (v = 0; v &lt; 128 &amp;&amp; <a class="code" href="app__sms_8c.html#a34ddced579016642f988389bc44752c0">defaultalphabet</a>[v] != u; v++);
<a name="l00401"></a>00401       <span class="keywordflow">if</span> (v == 128 <span class="comment">/* not found */</span> &amp;&amp; u &amp;&amp; n + 1 &lt; <a class="code" href="app__sms_8c.html#a92bf696f8279259f5741564c2c2b2af2">SMSLEN</a>) {
<a name="l00402"></a>00402          <span class="comment">/* if not found, look in the escapes table (we need 2 bytes) */</span>
<a name="l00403"></a>00403          <span class="keywordflow">for</span> (v = 0; v &lt; 128 &amp;&amp; <a class="code" href="app__sms_8c.html#a70ca3c30c6f517d2f8ebd04edae4d892">escapes</a>[v] != u; v++);
<a name="l00404"></a>00404          <span class="keywordflow">if</span> (v &lt; 128) { <span class="comment">/* escaped sequence, esc + v */</span>
<a name="l00405"></a>00405             <span class="comment">/* store the low (8-b) bits in o[p], the remaining bits in o[p+1] */</span>
<a name="l00406"></a>00406             o[p] |= (27 &lt;&lt; b);          <span class="comment">/* the low bits go into o[p] */</span> 
<a name="l00407"></a>00407             b += 7;
<a name="l00408"></a>00408             <span class="keywordflow">if</span> (b &gt;= 8) {
<a name="l00409"></a>00409                b -= 8;
<a name="l00410"></a>00410                p++;
<a name="l00411"></a>00411                o[p] = (27 &gt;&gt; (7 - b));
<a name="l00412"></a>00412             }
<a name="l00413"></a>00413             n++;
<a name="l00414"></a>00414          }
<a name="l00415"></a>00415       }
<a name="l00416"></a>00416       <span class="keywordflow">if</span> (v == 128)
<a name="l00417"></a>00417          <span class="keywordflow">return</span> -1;                      <span class="comment">/* invalid character */</span>
<a name="l00418"></a>00418       <span class="comment">/* store, same as above */</span>
<a name="l00419"></a>00419       o[p] |= (v &lt;&lt; b);
<a name="l00420"></a>00420       b += 7;
<a name="l00421"></a>00421       <span class="keywordflow">if</span> (b &gt;= 8) {
<a name="l00422"></a>00422          b -= 8;
<a name="l00423"></a>00423          p++;
<a name="l00424"></a>00424          o[p] = (v &gt;&gt; (7 - b));
<a name="l00425"></a>00425       }
<a name="l00426"></a>00426       <span class="keywordflow">if</span> (++n &gt;= <a class="code" href="app__sms_8c.html#a92bf696f8279259f5741564c2c2b2af2">SMSLEN</a>)
<a name="l00427"></a>00427          <span class="keywordflow">return</span> n;
<a name="l00428"></a>00428    }
<a name="l00429"></a>00429    <span class="keywordflow">return</span> n;
<a name="l00430"></a>00430 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa3645875887568a20059ae86c7a66f74"></a><!-- doxytag: member="app_sms.c::packsms8" ref="aa3645875887568a20059ae86c7a66f74" args="(unsigned char *o, int udhl, unsigned char *udh, int udl, unsigned short *ud)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int packsms8 </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>o</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>udhl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>udh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>udl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned short *&nbsp;</td>
          <td class="paramname"> <em>ud</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>takes a binary header (udhl bytes at udh) and UCS-2 <a class="el" href="structmessage.html">message</a> (udl characters at ud) and packs in to o using 8 bit character codes. The return value is the <a class="el" href="structnumber.html" title="Number structure.">number</a> of bytes packed in to o, which is internally limited to 140. o can be null, in which case this is used to validate or count only. if the input contains invalid characters then the return value is -1 </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00438">438</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="chan__unistim_8c_source.html#l00183">dummy()</a>, and <a class="el" href="app__sms_8c_source.html#l00210">SMSLEN_8</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00512">packsms()</a>, and <a class="el" href="app__sms_8c_source.html#l00813">sms_readfile()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00439"></a>00439 {
<a name="l00440"></a>00440    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> p = 0;
<a name="l00441"></a>00441    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="chan__unistim_8c.html#abc0ce15d00b4bfb69266c5fd016dc88c">dummy</a>[<a class="code" href="app__sms_8c.html#ac59f0c328bf0668e86f21b74183de226">SMSLEN_8</a>];
<a name="l00442"></a>00442 
<a name="l00443"></a>00443    <span class="keywordflow">if</span> (o == NULL)
<a name="l00444"></a>00444       o = dummy;
<a name="l00445"></a>00445    <span class="comment">/* header - no encoding */</span>
<a name="l00446"></a>00446    <span class="keywordflow">if</span> (udhl) {
<a name="l00447"></a>00447       o[p++] = udhl;
<a name="l00448"></a>00448       <span class="keywordflow">while</span> (udhl--) {
<a name="l00449"></a>00449          o[p++] = *udh++;
<a name="l00450"></a>00450          <span class="keywordflow">if</span> (p &gt;= <a class="code" href="app__sms_8c.html#ac59f0c328bf0668e86f21b74183de226">SMSLEN_8</a>) {
<a name="l00451"></a>00451             <span class="keywordflow">return</span> p;
<a name="l00452"></a>00452          }
<a name="l00453"></a>00453       }
<a name="l00454"></a>00454    }
<a name="l00455"></a>00455    <span class="keywordflow">while</span> (udl--) {
<a name="l00456"></a>00456       <span class="keywordtype">long</span> u;
<a name="l00457"></a>00457       u = *ud++;
<a name="l00458"></a>00458       <span class="keywordflow">if</span> (u &lt; 0 || u &gt; 0xFF) {
<a name="l00459"></a>00459          <span class="keywordflow">return</span> -1;                      <span class="comment">/* not valid */</span>
<a name="l00460"></a>00460       }
<a name="l00461"></a>00461       o[p++] = u;
<a name="l00462"></a>00462       <span class="keywordflow">if</span> (p &gt;= <a class="code" href="app__sms_8c.html#ac59f0c328bf0668e86f21b74183de226">SMSLEN_8</a>) {
<a name="l00463"></a>00463          <span class="keywordflow">return</span> p;
<a name="l00464"></a>00464       }
<a name="l00465"></a>00465    }
<a name="l00466"></a>00466    <span class="keywordflow">return</span> p;
<a name="l00467"></a>00467 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a70757b19c8a274d21a1f935767d41426"></a><!-- doxytag: member="app_sms.c::putdummydata_proto2" ref="a70757b19c8a274d21a1f935767d41426" args="(sms_t *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void putdummydata_proto2 </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01199">sms_compose2()</a>.</p>

</div>
</div>
<a class="anchor" id="abe8206bb9c2adf04e478cd8e01bd5a94"></a><!-- doxytag: member="app_sms.c::readdirqueue" ref="abe8206bb9c2adf04e478cd8e01bd5a94" args="(DIR *d, char *queue)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct dirent* readdirqueue </td>
          <td>(</td>
          <td class="paramtype">DIR *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>queue</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>read dir skipping dot files... </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01088">1088</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="format__g726_8c_source.html#l00177">f</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01428">sms_nextoutgoing()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01089"></a>01089 {
<a name="l01090"></a>01090    <span class="keyword">struct </span>dirent *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l01091"></a>01091    <span class="keywordflow">do</span> {
<a name="l01092"></a>01092       f = readdir(d);
<a name="l01093"></a>01093    } <span class="keywordflow">while</span> (f &amp;&amp; (*f-&gt;d_name == <span class="charliteral">&apos;.&apos;</span> || strncmp(f-&gt;d_name, queue, strlen(queue)) || f-&gt;d_name[strlen(queue)] != <span class="charliteral">&apos;.&apos;</span>));
<a name="l01094"></a>01094    <span class="keywordflow">return</span> f;
<a name="l01095"></a>01095 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a44ab7b172d33e28647b2383346814b9f"></a><!-- doxytag: member="app_sms.c::sms_alloc" ref="a44ab7b172d33e28647b2383346814b9f" args="(struct ast_channel *chan, void *sms_t_ptr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* sms_alloc </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>sms_t_ptr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Just return the pointer to the descriptor that we received. </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01667">1667</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01668"></a>01668 {
<a name="l01669"></a>01669    <span class="keywordflow">return</span> sms_t_ptr;
<a name="l01670"></a>01670 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a184a0ba43954b42a5db9a1b1a4854ccb"></a><!-- doxytag: member="app_sms.c::sms_compose1" ref="a184a0ba43954b42a5db9a1b1a4854ccb" args="(sms_t *h, int more)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void sms_compose1 </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>more</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>compose a <a class="el" href="structmessage.html">message</a> for protocol 1 </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01386">1386</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="app__sms_8c_source.html#l00219">sms_s::da</a>, <a class="el" href="app__sms_8c_source.html#l00222">sms_s::dcs</a>, <a class="el" href="app__sms_8c_source.html#l00223">sms_s::mr</a>, <a class="el" href="app__sms_8c_source.html#l00218">sms_s::oa</a>, <a class="el" href="app__sms_8c_source.html#l00241">sms_s::omsg</a>, <a class="el" href="app__sms_8c_source.html#l00737">packaddress()</a>, <a class="el" href="app__sms_8c_source.html#l00545">packdate()</a>, <a class="el" href="app__sms_8c_source.html#l00512">packsms()</a>, <a class="el" href="app__sms_8c_source.html#l00221">sms_s::pid</a>, <a class="el" href="app__sms_8c_source.html#l00228">sms_s::rp</a>, <a class="el" href="app__sms_8c_source.html#l00220">sms_s::scts</a>, <a class="el" href="app__sms_8c_source.html#l00215">sms_s::smsc</a>, <a class="el" href="app__sms_8c_source.html#l00226">sms_s::srr</a>, <a class="el" href="app__sms_8c_source.html#l00230">sms_s::ud</a>, <a class="el" href="app__sms_8c_source.html#l00231">sms_s::udh</a>, <a class="el" href="app__sms_8c_source.html#l00227">sms_s::udhi</a>, <a class="el" href="app__sms_8c_source.html#l00225">sms_s::udhl</a>, <a class="el" href="app__sms_8c_source.html#l00224">sms_s::udl</a>, and <a class="el" href="app__sms_8c_source.html#l00229">sms_s::vp</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01428">sms_nextoutgoing()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01387"></a>01387 {
<a name="l01388"></a>01388    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p = 2;                     <span class="comment">/* next byte to write. Skip type and len */</span>
<a name="l01389"></a>01389 
<a name="l01390"></a>01390    h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = 0x91;                      <span class="comment">/* SMS_DATA */</span>
<a name="l01391"></a>01391    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ac407ce793f99be51a1804050b3565deb">smsc</a>) {                          <span class="comment">/* deliver */</span>
<a name="l01392"></a>01392       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p++] = (more ? 4 : 0) + ((h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a> &gt; 0) ? 0x40 : 0);
<a name="l01393"></a>01393       p += <a class="code" href="app__sms_8c.html#aea46af6597884cf32d85f18a52129711" title="store an address at o, and return number of bytes used">packaddress</a>(h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a> + p, h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>);
<a name="l01394"></a>01394       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p++] = h-&gt;<a class="code" href="structsms__s.html#a2c7d9a176d66d466f3e8c54fd519460e">pid</a>;
<a name="l01395"></a>01395       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p++] = h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>;
<a name="l01396"></a>01396       <a class="code" href="app__sms_8c.html#a902aeb4504023853fd6f91429a2855e3" title="pack a date and return">packdate</a>(h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a> + p, h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a>.tv_sec);
<a name="l01397"></a>01397       p += 7;
<a name="l01398"></a>01398       p += <a class="code" href="app__sms_8c.html#a38e1bebc872822985359d2e36c1c0448" title="general pack, with length and data, returns number of bytes of target used">packsms</a>(h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>, h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a> + p, h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h-&gt;<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>);
<a name="l01399"></a>01399    } <span class="keywordflow">else</span> {                                <span class="comment">/* submit */</span>
<a name="l01400"></a>01400       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p++] =
<a name="l01401"></a>01401          0x01 + (more ? 4 : 0) + (h-&gt;<a class="code" href="structsms__s.html#a0f7adeccf32fc4c52946d5d20b34c1cd">srr</a> ? 0x20 : 0) + (h-&gt;<a class="code" href="structsms__s.html#aa04ad9c90e68d8a6f92b612f798db482">rp</a> ? 0x80 : 0) + (h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> ? 0x10 : 0) + (h-&gt;<a class="code" href="structsms__s.html#a50b93d20a60c5ca8290725dff70be020">udhi</a> ? 0x40 : 0);
<a name="l01402"></a>01402       <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a423cb59610482ae25dcd3df51afdde25">mr</a> &lt; 0) {
<a name="l01403"></a>01403          h-&gt;<a class="code" href="structsms__s.html#a423cb59610482ae25dcd3df51afdde25">mr</a> = <a class="code" href="app__sms_8c.html#a0e5e2d705fb17b7f583cd711a5d47467">message_ref</a>++;
<a name="l01404"></a>01404       }
<a name="l01405"></a>01405       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p++] = h-&gt;<a class="code" href="structsms__s.html#a423cb59610482ae25dcd3df51afdde25">mr</a>;
<a name="l01406"></a>01406       p += <a class="code" href="app__sms_8c.html#aea46af6597884cf32d85f18a52129711" title="store an address at o, and return number of bytes used">packaddress</a>(h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a> + p, h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a>);
<a name="l01407"></a>01407       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p++] = h-&gt;<a class="code" href="structsms__s.html#a2c7d9a176d66d466f3e8c54fd519460e">pid</a>;
<a name="l01408"></a>01408       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p++] = h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>;
<a name="l01409"></a>01409       <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a>) {                        <span class="comment">/* relative VP */</span>
<a name="l01410"></a>01410          <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> &lt; 720) {
<a name="l01411"></a>01411             h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p++] = (h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> + 4) / 5 - 1;
<a name="l01412"></a>01412          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> &lt; 1440) {
<a name="l01413"></a>01413             h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p++] = (h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> - 720 + 29) / 30 + 143;
<a name="l01414"></a>01414          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> &lt; 43200) {
<a name="l01415"></a>01415             h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p++] = (h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> + 1439) / 1440 + 166;
<a name="l01416"></a>01416          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> &lt; 635040) {
<a name="l01417"></a>01417             h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p++] = (h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> + 10079) / 10080 + 192;
<a name="l01418"></a>01418          } <span class="keywordflow">else</span> {
<a name="l01419"></a>01419             h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p++] = 255;         <span class="comment">/* max */</span>
<a name="l01420"></a>01420          }
<a name="l01421"></a>01421       }
<a name="l01422"></a>01422       p += <a class="code" href="app__sms_8c.html#a38e1bebc872822985359d2e36c1c0448" title="general pack, with length and data, returns number of bytes of target used">packsms</a>(h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>, h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a> + p, h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h-&gt;<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>);
<a name="l01423"></a>01423    }
<a name="l01424"></a>01424    h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = p - 2;
<a name="l01425"></a>01425 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a4cea080950ce2066ed4987ee16fcb8d5"></a><!-- doxytag: member="app_sms.c::sms_compose2" ref="a4cea080950ce2066ed4987ee16fcb8d5" args="(sms_t *h, int more)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void sms_compose2 </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>more</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01199">1199</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="app__sms_8c_source.html#l01174">adddata_proto2()</a>, <a class="el" href="localtime_8c_source.html#l01305">ast_localtime()</a>, <a class="el" href="app__sms_8c_source.html#l00219">sms_s::da</a>, <a class="el" href="app__sms_8c_source.html#l00218">sms_s::oa</a>, <a class="el" href="app__sms_8c_source.html#l00241">sms_s::omsg</a>, <a class="el" href="app__sms_8c.html#a70757b19c8a274d21a1f935767d41426">putdummydata_proto2()</a>, <a class="el" href="app__sms_8c_source.html#l00220">sms_s::scts</a>, <a class="el" href="app__sms_8c_source.html#l00215">sms_s::smsc</a>, <a class="el" href="localtime_8h_source.html#l00030">ast_tm::tm_hour</a>, <a class="el" href="localtime_8h_source.html#l00031">ast_tm::tm_mday</a>, <a class="el" href="localtime_8h_source.html#l00029">ast_tm::tm_min</a>, and <a class="el" href="localtime_8h_source.html#l00032">ast_tm::tm_mon</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01428">sms_nextoutgoing()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01200"></a>01200 {
<a name="l01201"></a>01201    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l01202"></a>01202    <span class="keyword">struct </span>timeval now = h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a>;
<a name="l01203"></a>01203    <span class="keywordtype">char</span> stm[9];
<a name="l01204"></a>01204 
<a name="l01205"></a>01205    h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = 0x00;                      <span class="comment">/* set later... */</span>
<a name="l01206"></a>01206    h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = 0;
<a name="l01207"></a>01207    <a class="code" href="app__sms_8c.html#a70757b19c8a274d21a1f935767d41426">putdummydata_proto2</a>(h);
<a name="l01208"></a>01208    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ac407ce793f99be51a1804050b3565deb">smsc</a>) {                          <span class="comment">/* deliver */</span>
<a name="l01209"></a>01209       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = 0x11;                  <span class="comment">/* SMS_DELIVERY */</span>
<a name="l01210"></a>01210       <span class="comment">/* Required: 10 11 12 13 14 15 17 (seems they must be ordered!) */</span>
<a name="l01211"></a>01211       <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;tm, NULL);
<a name="l01212"></a>01212       sprintf(stm, <span class="stringliteral">&quot;%02d%02d%02d%02d&quot;</span>, tm.tm_mon + 1, tm.tm_mday, tm.tm_hour, tm.tm_min);  <span class="comment">/* Date mmddHHMM */</span>
<a name="l01213"></a>01213       <a class="code" href="app__sms_8c.html#adfb54a6105314c1847b33ff2b7f24fb9">adddata_proto2</a>(h, 0x14, stm, 8);    <span class="comment">/* Date */</span>
<a name="l01214"></a>01214       <span class="keywordflow">if</span> (*h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a> == 0) {
<a name="l01215"></a>01215          strcpy(h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>, <span class="stringliteral">&quot;00000000&quot;</span>);
<a name="l01216"></a>01216       }
<a name="l01217"></a>01217       <a class="code" href="app__sms_8c.html#adfb54a6105314c1847b33ff2b7f24fb9">adddata_proto2</a>(h, 0x15, h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>, strlen(h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>)); <span class="comment">/* Originator */</span>
<a name="l01218"></a>01218       <a class="code" href="app__sms_8c.html#adfb54a6105314c1847b33ff2b7f24fb9">adddata_proto2</a>(h, 0x17, <span class="stringliteral">&quot;\1&quot;</span>, 1);   <span class="comment">/* Calling Terminal ID */</span>
<a name="l01219"></a>01219    } <span class="keywordflow">else</span> {                                <span class="comment">/* submit */</span>
<a name="l01220"></a>01220       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = 0x10;                  <span class="comment">/* SMS_SUBMIT */</span>
<a name="l01221"></a>01221       <span class="comment">/* Required: 10 11 12 13 17 18 1B 1C (seems they must be ordered!) */</span>
<a name="l01222"></a>01222       <a class="code" href="app__sms_8c.html#adfb54a6105314c1847b33ff2b7f24fb9">adddata_proto2</a>(h, 0x17, <span class="stringliteral">&quot;\1&quot;</span>, 1);   <span class="comment">/* Calling Terminal ID */</span>
<a name="l01223"></a>01223       <span class="keywordflow">if</span> (*h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a> == 0) {
<a name="l01224"></a>01224          strcpy(h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a>, <span class="stringliteral">&quot;00000000&quot;</span>);
<a name="l01225"></a>01225       }
<a name="l01226"></a>01226       <a class="code" href="app__sms_8c.html#adfb54a6105314c1847b33ff2b7f24fb9">adddata_proto2</a>(h, 0x18, h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a>, strlen(h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a>)); <span class="comment">/* Originator */</span>
<a name="l01227"></a>01227       <a class="code" href="app__sms_8c.html#adfb54a6105314c1847b33ff2b7f24fb9">adddata_proto2</a>(h, 0x1B, <span class="stringliteral">&quot;\1&quot;</span>, 1);         <span class="comment">/* Called Terminal ID */</span>
<a name="l01228"></a>01228       <a class="code" href="app__sms_8c.html#adfb54a6105314c1847b33ff2b7f24fb9">adddata_proto2</a>(h, 0x1C, <span class="stringliteral">&quot;\0\0\0&quot;</span>, 3);    <span class="comment">/* Notification */</span>
<a name="l01229"></a>01229    }
<a name="l01230"></a>01230 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aec1ab10167ae5ed9af8793c90c10c475"></a><!-- doxytag: member="app_sms.c::sms_debug" ref="aec1ab10167ae5ed9af8793c90c10c475" args="(int dir, sms_t *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void sms_debug </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01470">1470</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="app__sms_8c_source.html#l01468">DIR_RX</a>, <a class="el" href="app__sms_8c_source.html#l00258">sms_s::ibytep</a>, <a class="el" href="app__sms_8c_source.html#l00242">sms_s::imsg</a>, <a class="el" href="adsistub_8c_source.html#l00055">msg</a>, and <a class="el" href="app__sms_8c_source.html#l00241">sms_s::omsg</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01488">sms_messagerx()</a>, and <a class="el" href="app__sms_8c_source.html#l01546">sms_messagetx()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01471"></a>01471 {
<a name="l01472"></a>01472    <span class="keywordtype">char</span> txt[259 * 3 + 1];
<a name="l01473"></a>01473    <span class="keywordtype">char</span> *p = txt;                          <span class="comment">/* always long enough */</span>
<a name="l01474"></a>01474    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a> = (<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a> == <a class="code" href="app__sms_8c.html#aa4fbf8951a3590171e5def3f7d4cd666">DIR_RX</a>) ? h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a> : h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>;
<a name="l01475"></a>01475    <span class="keywordtype">int</span> n = (<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a> == <a class="code" href="app__sms_8c.html#aa4fbf8951a3590171e5def3f7d4cd666">DIR_RX</a>) ? h-&gt;<a class="code" href="structsms__s.html#a3130aa304b0c5b6b85bf740f27eeaac7">ibytep</a> : msg[1] + 2;
<a name="l01476"></a>01476    <span class="keywordtype">int</span> q = 0;
<a name="l01477"></a>01477    <span class="keywordflow">while</span> (q &lt; n &amp;&amp; q &lt; 30) {
<a name="l01478"></a>01478       sprintf(p, <span class="stringliteral">&quot; %02X&quot;</span>, msg[q++]);
<a name="l01479"></a>01479       p += 3;
<a name="l01480"></a>01480    }
<a name="l01481"></a>01481    <span class="keywordflow">if</span> (q &lt; n) {
<a name="l01482"></a>01482       sprintf(p, <span class="stringliteral">&quot;...&quot;</span>);
<a name="l01483"></a>01483    }
<a name="l01484"></a>01484    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;SMS %s%s\n&quot;</span>, <a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a> == <a class="code" href="app__sms_8c.html#aa4fbf8951a3590171e5def3f7d4cd666">DIR_RX</a> ? <span class="stringliteral">&quot;RX&quot;</span> : <span class="stringliteral">&quot;TX&quot;</span>, txt);
<a name="l01485"></a>01485 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a587be46ef6675e0c5477d125dc1e1b27"></a><!-- doxytag: member="app_sms.c::sms_exec" ref="a587be46ef6675e0c5477d125dc1e1b27" args="(struct ast_channel *chan, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int sms_exec </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01858">1858</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="app_8h_source.html#l00338">AST_APP_ARG</a>, <a class="el" href="app_8c_source.html#l01776">ast_app_parse_options()</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="app_8h_source.html#l00355">AST_DECLARE_APP_ARGS</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="app_8h_source.html#l00387">AST_STANDARD_APP_ARGS</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="channel_8h_source.html#l00444">ast_channel::cid</a>, <a class="el" href="channel_8h_source.html#l00203">ast_callerid::cid_num</a>, <a class="el" href="app__sms_8c_source.html#l00232">sms_s::cli</a>, <a class="el" href="app__sms_8c_source.html#l00222">sms_s::dcs</a>, <a class="el" href="app__sms_8c_source.html#l00251">sms_s::ipc0</a>, <a class="el" href="app__sms_8c_source.html#l00252">sms_s::ipc1</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="app__sms_8c_source.html#l00265">sms_s::opause_0</a>, <a class="el" href="app__skel_8c_source.html#l00087">OPTION_ARG_ARRAY_SIZE</a>, <a class="el" href="app__sms_8c_source.html#l01845">OPTION_ARG_PAUSE</a>, <a class="el" href="app__sms_8c_source.html#l01836">OPTION_BE_SMSC</a>, <a class="el" href="app__sms_8c_source.html#l01841">OPTION_DCS</a>, <a class="el" href="app__sms_8c_source.html#l01840">OPTION_SRR</a>, <a class="el" href="app__sms_8c_source.html#l01838">OPTION_TWO</a>, <a class="el" href="chan__mgcp_8c_source.html#l01737">parse()</a>, <a class="el" href="app__sms_8c_source.html#l00221">sms_s::pid</a>, <a class="el" href="app__sms_8c_source.html#l00266">sms_s::protocol</a>, <a class="el" href="app__sms_8c_source.html#l00217">sms_s::queue</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, <a class="el" href="app__sms_8c_source.html#l00215">sms_s::smsc</a>, and <a class="el" href="app__sms_8c_source.html#l00226">sms_s::srr</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l02052">load_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01859"></a>01859 {
<a name="l01860"></a>01860    <span class="keywordtype">int</span> res = -1;
<a name="l01861"></a>01861    <a class="code" href="structsms__s.html">sms_t</a> h = { 0 };
<a name="l01862"></a>01862    <span class="comment">/* argument parsing support */</span>
<a name="l01863"></a>01863    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>;
<a name="l01864"></a>01864    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>, *sms_opts[<a class="code" href="app__skel_8c.html#af3520ff6d43011872bab77edd27d4de3ad8be72595381ce66309dcc938077316b">OPTION_ARG_ARRAY_SIZE</a>] = { 0, };
<a name="l01865"></a>01865    <span class="keywordtype">char</span> *p;
<a name="l01866"></a>01866    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(sms_args,
<a name="l01867"></a>01867       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(queue);
<a name="l01868"></a>01868       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l01869"></a>01869       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(addr);
<a name="l01870"></a>01870       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(body);
<a name="l01871"></a>01871    );
<a name="l01872"></a>01872 
<a name="l01873"></a>01873    <span class="keywordflow">if</span> (!data) {
<a name="l01874"></a>01874       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Requires queue name at least\n&quot;</span>);
<a name="l01875"></a>01875       <span class="keywordflow">return</span> -1;
<a name="l01876"></a>01876    }
<a name="l01877"></a>01877 
<a name="l01878"></a>01878    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);              <span class="comment">/* create a local copy */</span>
<a name="l01879"></a>01879    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(sms_args, parse);
<a name="l01880"></a>01880    <span class="keywordflow">if</span> (sms_args.argc &gt; 1) {
<a name="l01881"></a>01881       <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(sms_options, &amp;<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, sms_opts, sms_args.options);
<a name="l01882"></a>01882    }
<a name="l01883"></a>01883 
<a name="l01884"></a>01884    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;sms argc %d queue &lt;%s&gt; opts &lt;%s&gt; addr &lt;%s&gt; body &lt;%s&gt;\n&quot;</span>,
<a name="l01885"></a>01885       sms_args.argc, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(sms_args.queue, <span class="stringliteral">&quot;&quot;</span>),
<a name="l01886"></a>01886       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(sms_args.options, <span class="stringliteral">&quot;&quot;</span>),
<a name="l01887"></a>01887       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(sms_args.addr, <span class="stringliteral">&quot;&quot;</span>),
<a name="l01888"></a>01888       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(sms_args.body, <span class="stringliteral">&quot;&quot;</span>) );
<a name="l01889"></a>01889 
<a name="l01890"></a>01890    h.<a class="code" href="structsms__s.html#adb1bd77faccb1c8198882df8475b5979">ipc0</a> = h.<a class="code" href="structsms__s.html#a60ee36698e956201dc2fd920eacf25fe">ipc1</a> = 20;                   <span class="comment">/* phase for cosine */</span>
<a name="l01891"></a>01891    h.<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a> = 0xF1;                           <span class="comment">/* default */</span>
<a name="l01892"></a>01892 
<a name="l01893"></a>01893    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)
<a name="l01894"></a>01894       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(h.<a class="code" href="structsms__s.html#a306f4c1d73939a3ccb91b0caf7127453">cli</a>, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="keyword">sizeof</span>(h.<a class="code" href="structsms__s.html#a306f4c1d73939a3ccb91b0caf7127453">cli</a>));
<a name="l01895"></a>01895 
<a name="l01896"></a>01896    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(sms_args.queue)) {
<a name="l01897"></a>01897       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Requires queue name\n&quot;</span>);
<a name="l01898"></a>01898       <span class="keywordflow">goto</span> done;
<a name="l01899"></a>01899    }
<a name="l01900"></a>01900    <span class="keywordflow">if</span> (strlen(sms_args.queue) &gt;= <span class="keyword">sizeof</span>(h.<a class="code" href="structsms__s.html#ae029547c37a01a171c894cefb942743f">queue</a>)) {
<a name="l01901"></a>01901       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Queue name too long\n&quot;</span>);
<a name="l01902"></a>01902       <span class="keywordflow">goto</span> done;
<a name="l01903"></a>01903    }
<a name="l01904"></a>01904    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(h.<a class="code" href="structsms__s.html#ae029547c37a01a171c894cefb942743f">queue</a>, sms_args.queue, <span class="keyword">sizeof</span>(h.<a class="code" href="structsms__s.html#ae029547c37a01a171c894cefb942743f">queue</a>));
<a name="l01905"></a>01905 
<a name="l01906"></a>01906    <span class="keywordflow">for</span> (p = h.<a class="code" href="structsms__s.html#ae029547c37a01a171c894cefb942743f">queue</a>; *p; p++) {
<a name="l01907"></a>01907       <span class="keywordflow">if</span> (!isalnum(*p)) {
<a name="l01908"></a>01908          *p = <span class="charliteral">&apos;-&apos;</span>;                       <span class="comment">/* make very safe for filenames */</span>
<a name="l01909"></a>01909       }
<a name="l01910"></a>01910    }
<a name="l01911"></a>01911 
<a name="l01912"></a>01912    h.<a class="code" href="structsms__s.html#ac407ce793f99be51a1804050b3565deb">smsc</a> = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, <a class="code" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a6d9f8a190a30fdff2d003fe406ab23f9">OPTION_BE_SMSC</a>);
<a name="l01913"></a>01913    h.<a class="code" href="structsms__s.html#ab30e8d7e05ae904d3248e0d51255c005">protocol</a> = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, <a class="code" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a6a8237166dcc5e4ec9cf6671b91d8dd4">OPTION_TWO</a>) ? 2 : 1;
<a name="l01914"></a>01914    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(sms_opts[<a class="code" href="app__sms_8c.html#af715e26dfffd1f8de1c18449e2770cffa00c83650e6758ad93ede9f7db2dbf567">OPTION_ARG_PAUSE</a>])) {
<a name="l01915"></a>01915       h.<a class="code" href="structsms__s.html#a07d0d1d8e847071c2d9e766749c03da3">opause_0</a> = atoi(sms_opts[OPTION_ARG_PAUSE]);
<a name="l01916"></a>01916    }
<a name="l01917"></a>01917    <span class="keywordflow">if</span> (h.<a class="code" href="structsms__s.html#a07d0d1d8e847071c2d9e766749c03da3">opause_0</a> &lt; 25 || h.<a class="code" href="structsms__s.html#a07d0d1d8e847071c2d9e766749c03da3">opause_0</a> &gt; 2000) {
<a name="l01918"></a>01918       h.<a class="code" href="structsms__s.html#a07d0d1d8e847071c2d9e766749c03da3">opause_0</a> = 300;                   <span class="comment">/* default 300ms */</span>
<a name="l01919"></a>01919    }
<a name="l01920"></a>01920    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <span class="stringliteral">&quot;initial delay %dms\n&quot;</span>, h.<a class="code" href="structsms__s.html#a07d0d1d8e847071c2d9e766749c03da3">opause_0</a>);
<a name="l01921"></a>01921 
<a name="l01922"></a>01922 
<a name="l01923"></a>01923    <span class="comment">/* the following apply if there is an arg3/4 and apply to the created message file */</span>
<a name="l01924"></a>01924    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, <a class="code" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a0b148357a99551d297160a7b98600695">OPTION_SRR</a>)) {
<a name="l01925"></a>01925       h.<a class="code" href="structsms__s.html#a0f7adeccf32fc4c52946d5d20b34c1cd">srr</a> = 1;
<a name="l01926"></a>01926    }
<a name="l01927"></a>01927    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, <a class="code" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a8a74ad47b1edfb9e69bfa73516388781">OPTION_DCS</a>)) {
<a name="l01928"></a>01928       h.<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a> = 1;
<a name="l01929"></a>01929    }
<a name="l01930"></a>01930 <span class="preprocessor">#if 0 </span>
<a name="l01931"></a>01931 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>:
<a name="l01932"></a>01932       <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>:
<a name="l01933"></a>01933       <span class="keywordflow">case</span> <span class="charliteral">&apos;3&apos;</span>:
<a name="l01934"></a>01934       <span class="keywordflow">case</span> <span class="charliteral">&apos;4&apos;</span>:
<a name="l01935"></a>01935       <span class="keywordflow">case</span> <span class="charliteral">&apos;5&apos;</span>:
<a name="l01936"></a>01936       <span class="keywordflow">case</span> <span class="charliteral">&apos;6&apos;</span>:
<a name="l01937"></a>01937       <span class="keywordflow">case</span> <span class="charliteral">&apos;7&apos;</span>:                           <span class="comment">/* set the pid for saved local message */</span>
<a name="l01938"></a>01938          h.<a class="code" href="structsms__s.html#a2c7d9a176d66d466f3e8c54fd519460e">pid</a> = 0x40 + (*d &amp; 0xF);
<a name="l01939"></a>01939          <span class="keywordflow">break</span>;
<a name="l01940"></a>01940       }
<a name="l01941"></a>01941 <span class="preprocessor">#endif</span>
<a name="l01942"></a>01942 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (sms_args.argc &gt; 2) {
<a name="l01943"></a>01943       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *up;
<a name="l01944"></a>01944 
<a name="l01945"></a>01945       <span class="comment">/* submitting a message, not taking call. */</span>
<a name="l01946"></a>01946       <span class="comment">/* deprecated, use smsq instead */</span>
<a name="l01947"></a>01947       h.<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l01948"></a>01948       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(sms_args.addr) || strlen(sms_args.addr) &gt;= <span class="keyword">sizeof</span>(h.<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>)) {
<a name="l01949"></a>01949          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Address too long %s\n&quot;</span>, sms_args.addr);
<a name="l01950"></a>01950          <span class="keywordflow">goto</span> done;
<a name="l01951"></a>01951       }
<a name="l01952"></a>01952       <span class="keywordflow">if</span> (h.<a class="code" href="structsms__s.html#ac407ce793f99be51a1804050b3565deb">smsc</a>) {
<a name="l01953"></a>01953          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(h.<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>, sms_args.addr, <span class="keyword">sizeof</span>(h.<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>));
<a name="l01954"></a>01954       } <span class="keywordflow">else</span> {
<a name="l01955"></a>01955          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(h.<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a>, sms_args.addr, <span class="keyword">sizeof</span>(h.<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a>));
<a name="l01956"></a>01956          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(h.<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>, h.<a class="code" href="structsms__s.html#a306f4c1d73939a3ccb91b0caf7127453">cli</a>, <span class="keyword">sizeof</span>(h.<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>));
<a name="l01957"></a>01957       }
<a name="l01958"></a>01958       h.<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> = 0;
<a name="l01959"></a>01959       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(sms_args.body)) {
<a name="l01960"></a>01960          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Missing body for %s\n&quot;</span>, sms_args.addr);
<a name="l01961"></a>01961          <span class="keywordflow">goto</span> done;
<a name="l01962"></a>01962       }
<a name="l01963"></a>01963       up = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)sms_args.body;
<a name="l01964"></a>01964       while (*up &amp;&amp; h.<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> &lt; <a class="code" href="app__sms_8c.html#a92bf696f8279259f5741564c2c2b2af2">SMSLEN</a>) {
<a name="l01965"></a>01965          h.<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[h.<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>++] = <a class="code" href="app__sms_8c.html#a375cda00ad33985349625ad6f8ae70ef" title="Reads next UCS character from NUL terminated UTF-8 string and advance pointer.">utf8decode</a>(&amp;up);
<a name="l01966"></a>01966       }
<a name="l01967"></a>01967       <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#a39743cbea53fca38237f049acd4cb834">is7bit</a>(h.<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>) &amp;&amp; <a class="code" href="app__sms_8c.html#a172d0c2bb9c8a56df817acb5ce7bfe3c" title="takes a binary header (udhl bytes at udh) and UCS-2 message (udl characters at ud)...">packsms7</a>(0, h.<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h.<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, h.<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h.<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>) &lt; 0) {
<a name="l01968"></a>01968          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid 7 bit GSM data\n&quot;</span>);
<a name="l01969"></a>01969          <span class="keywordflow">goto</span> done;
<a name="l01970"></a>01970       }
<a name="l01971"></a>01971       <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#a5f533f0d22e8b3eac586398fbae67636">is8bit</a>(h.<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>) &amp;&amp; <a class="code" href="app__sms_8c.html#aa3645875887568a20059ae86c7a66f74" title="takes a binary header (udhl bytes at udh) and UCS-2 message (udl characters at ud)...">packsms8</a>(0, h.<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h.<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, h.<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h.<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>) &lt; 0) {
<a name="l01972"></a>01972          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid 8 bit data\n&quot;</span>);
<a name="l01973"></a>01973          <span class="keywordflow">goto</span> done;
<a name="l01974"></a>01974       }
<a name="l01975"></a>01975       <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#a8bdd552aa3abf01b520c87815e1c2b24">is16bit</a>(h.<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>) &amp;&amp; <a class="code" href="app__sms_8c.html#a77ab80a9e6251174378df1f59b5dbc44" title="takes a binary header (udhl bytes at udh) and UCS-2 message (udl characters at ud)...">packsms16</a>(0, h.<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h.<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, h.<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h.<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>) &lt; 0) {
<a name="l01976"></a>01976          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid 16 bit data\n&quot;</span>);
<a name="l01977"></a>01977          <span class="keywordflow">goto</span> done;
<a name="l01978"></a>01978       }
<a name="l01979"></a>01979       h.<a class="code" href="structsms__s.html#adae482bcbee5489cc0717323eb521082">rx</a> = 0;                           <span class="comment">/* sent message */</span>
<a name="l01980"></a>01980       h.<a class="code" href="structsms__s.html#a423cb59610482ae25dcd3df51afdde25">mr</a> = -1;
<a name="l01981"></a>01981       <a class="code" href="app__sms_8c.html#af45fa5279582c213474672cf0684d219" title="white a received text message to a file">sms_writefile</a>(&amp;h);
<a name="l01982"></a>01982       res = h.<a class="code" href="structsms__s.html#a157434392012e4ce1590980a31f692ac">err</a>;
<a name="l01983"></a>01983       <span class="keywordflow">goto</span> done;
<a name="l01984"></a>01984    }
<a name="l01985"></a>01985    
<a name="l01986"></a>01986    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {    <span class="comment">/* make sure channel is answered before any TX */</span>
<a name="l01987"></a>01987       <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l01988"></a>01988    }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, <a class="code" href="app__sms_8c.html#ae8a3b6a5d0d3244ed73924ab2421a0d0a078a4fe6b4252bcd185df43f051ecd53">OPTION_ANSWER</a>)) {
<a name="l01991"></a>01991       h.<a class="code" href="structsms__s.html#a68ed7cd4df73b8c9bf4b23d948d1e638">framenumber</a> = 1;                  <span class="comment">/* Proto 2 */</span>
<a name="l01992"></a>01992       <span class="comment">/* set up SMS_EST initial message */</span>
<a name="l01993"></a>01993       <span class="keywordflow">if</span> (h.<a class="code" href="structsms__s.html#ab30e8d7e05ae904d3248e0d51255c005">protocol</a> == 2) {
<a name="l01994"></a>01994          h.<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a5df5d537055950e483ab1b368c26d73f">DLL2_SMS_EST</a>;
<a name="l01995"></a>01995          h.<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = 0;
<a name="l01996"></a>01996       } <span class="keywordflow">else</span> {
<a name="l01997"></a>01997          h.<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9aa93cd3c00de7548f03cc83a73833b626">DLL1_SMS_EST</a> | <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a96e7ed27f789598728cae97a4f9abbe4">DLL1_SMS_COMPLETE</a>;
<a name="l01998"></a>01998          h.<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = 0;
<a name="l01999"></a>01999       }
<a name="l02000"></a>02000       <a class="code" href="app__sms_8c.html#a47041feede8f04106f4d6221af763e9d">sms_messagetx</a>(&amp;h);
<a name="l02001"></a>02001    }
<a name="l02002"></a>02002 
<a name="l02003"></a>02003    res = <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, <a class="code" href="app__sms_8c.html#a534407082ad8ffdc07f2143b239e17c6">__OUT_FMT</a>);
<a name="l02004"></a>02004    <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l02005"></a>02005       res = <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(chan, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>);
<a name="l02006"></a>02006    }
<a name="l02007"></a>02007    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l02008"></a>02008       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to set to linear mode, giving up\n&quot;</span>);
<a name="l02009"></a>02009       <span class="keywordflow">goto</span> done;
<a name="l02010"></a>02010    }
<a name="l02011"></a>02011 
<a name="l02012"></a>02012    <span class="keywordflow">if</span> ( (res = <a class="code" href="channel_8h.html#a12a58dda74a19f383f6b77cf7fa88b54">ast_activate_generator</a>(chan, &amp;<a class="code" href="app__sms_8c.html#a1905c14fd0a53bc591a77d9bb4d029ca">smsgen</a>, &amp;h)) &lt; 0) {
<a name="l02013"></a>02013       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to activate generator on &apos;%s&apos;\n&quot;</span>, chan-&gt;name);
<a name="l02014"></a>02014       <span class="keywordflow">goto</span> done;
<a name="l02015"></a>02015    }
<a name="l02016"></a>02016 
<a name="l02017"></a>02017    <span class="comment">/* Do our thing here */</span>
<a name="l02018"></a>02018    <span class="keywordflow">for</span> (;;) {
<a name="l02019"></a>02019       <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l02020"></a>02020       <span class="keywordtype">int</span> i = <a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, -1);
<a name="l02021"></a>02021       <span class="keywordflow">if</span> (i &lt; 0) {
<a name="l02022"></a>02022          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;waitfor failed\n&quot;</span>);
<a name="l02023"></a>02023          <span class="keywordflow">break</span>;
<a name="l02024"></a>02024       }
<a name="l02025"></a>02025       <span class="keywordflow">if</span> (h.<a class="code" href="structsms__s.html#ada449bf15f71bb79ab0e662561c78706">hangup</a>) {
<a name="l02026"></a>02026          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;channel hangup\n&quot;</span>);
<a name="l02027"></a>02027          <span class="keywordflow">break</span>;
<a name="l02028"></a>02028       }
<a name="l02029"></a>02029       f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan);
<a name="l02030"></a>02030       <span class="keywordflow">if</span> (!f) {
<a name="l02031"></a>02031          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;ast_read failed\n&quot;</span>);
<a name="l02032"></a>02032          <span class="keywordflow">break</span>;
<a name="l02033"></a>02033       }
<a name="l02034"></a>02034       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {
<a name="l02035"></a>02035          <a class="code" href="app__sms_8c.html#aa1cc2166cf9b6a4496caf3bb1d11cb6e">sms_process</a>(&amp;h, f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>, f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>);
<a name="l02036"></a>02036       }
<a name="l02037"></a>02037 
<a name="l02038"></a>02038       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l02039"></a>02039    }
<a name="l02040"></a>02040    res = h.<a class="code" href="structsms__s.html#a157434392012e4ce1590980a31f692ac">err</a>;                            <span class="comment">/* XXX */</span>
<a name="l02041"></a>02041 
<a name="l02042"></a>02042    <a class="code" href="app__sms_8c.html#ad5e0ab37f40bc7f8885617847ffd3fee" title="Log the output, and remove file.">sms_log</a>(&amp;h, <span class="charliteral">&apos;?&apos;</span>);                       <span class="comment">/* log incomplete message */</span>
<a name="l02043"></a>02043 done:
<a name="l02044"></a>02044    <span class="keywordflow">return</span> (res);
<a name="l02045"></a>02045 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="afda4211248e1b0e0083be7bd80a7d4b0"></a><!-- doxytag: member="app_sms.c::sms_generate" ref="afda4211248e1b0e0083be7bd80a7d4b0" args="(struct ast_channel *chan, void *data, int len, int samples)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int sms_generate </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>samples</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p><a class="el" href="structoutgoing.html">outgoing</a> data are produced by this generator function, that reads from the descriptor whether it has data to send and which ones. </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01589">1589</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="app__sms_8c_source.html#l00143">__OUT_FMT</a>, <a class="el" href="frame_8h_source.html#l00101">AST_FRAME_VOICE</a>, <a class="el" href="frame_8h_source.html#l00203">AST_FRIENDLY_OFFSET</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="channel_8c_source.html#l03411">ast_write()</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">ast_frame::data</a>, <a class="el" href="frame_8h_source.html#l00147">ast_frame::datalen</a>, <a class="el" href="app__sms_8c_source.html#l00170">DLL2_SMS_EST</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="frame_8h_source.html#l00143">ast_frame::frametype</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="frame_8h_source.html#l00151">ast_frame::mallocd</a>, <a class="el" href="app__sms_8c.html#a6706e49765398fb7ec5e9e4bb66c3e64">MAXSAMPLES</a>, <a class="el" href="app__sms_8c_source.html#l00237">sms_s::obitp</a>, <a class="el" href="app__sms_8c_source.html#l00235">sms_s::obyte</a>, <a class="el" href="app__sms_8c_source.html#l00240">sms_s::obyten</a>, <a class="el" href="app__sms_8c_source.html#l00239">sms_s::obytep</a>, <a class="el" href="frame_8h_source.html#l00155">ast_frame::offset</a>, <a class="el" href="app__sms_8c_source.html#l00241">sms_s::omsg</a>, <a class="el" href="app__sms_8c_source.html#l00236">sms_s::opause</a>, <a class="el" href="app__sms_8c_source.html#l00233">sms_s::ophase</a>, <a class="el" href="app__sms_8c_source.html#l00234">sms_s::ophasep</a>, <a class="el" href="app__sms_8c_source.html#l00267">sms_s::oseizure</a>, <a class="el" href="app__sms_8c_source.html#l00238">sms_s::osync</a>, <a class="el" href="app__sms_8c_source.html#l00266">sms_s::protocol</a>, <a class="el" href="frame_8h_source.html#l00159">ast_frame::ptr</a>, <a class="el" href="frame_8h_source.html#l00149">ast_frame::samples</a>, <a class="el" href="frame_8h_source.html#l00157">ast_frame::src</a>, and <a class="el" href="frame_8h_source.html#l00145">ast_frame::subclass</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01590"></a>01590 {
<a name="l01591"></a>01591    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> <a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = { 0 };
<a name="l01592"></a>01592 <span class="preprocessor">#define MAXSAMPLES (800)</span>
<a name="l01593"></a>01593 <span class="preprocessor"></span>   <a class="code" href="app__sms_8c.html#a4008af70ba477f60e932df6815dac38d">output_t</a> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l01594"></a>01594    <a class="code" href="structsms__s.html">sms_t</a> *h = <a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>;
<a name="l01595"></a>01595    <span class="keywordtype">int</span> i;
<a name="l01596"></a>01596 
<a name="l01597"></a>01597    <span class="keywordflow">if</span> (<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> &gt; MAXSAMPLES) {
<a name="l01598"></a>01598       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Only doing %d samples (%d requested)\n&quot;</span>,
<a name="l01599"></a>01599           MAXSAMPLES, <a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>);
<a name="l01600"></a>01600       <a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = <a class="code" href="app__sms_8c.html#a6706e49765398fb7ec5e9e4bb66c3e64">MAXSAMPLES</a>;
<a name="l01601"></a>01601    }
<a name="l01602"></a>01602    <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = <a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> * <span class="keyword">sizeof</span>(*buf) + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>;
<a name="l01603"></a>01603    buf = alloca(<a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l01604"></a>01604 
<a name="l01605"></a>01605    f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>;
<a name="l01606"></a>01606    f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="app__sms_8c.html#a534407082ad8ffdc07f2143b239e17c6">__OUT_FMT</a>;
<a name="l01607"></a>01607    f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = <a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> * <span class="keyword">sizeof</span>(*buf);
<a name="l01608"></a>01608    f.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = AST_FRIENDLY_OFFSET;
<a name="l01609"></a>01609    f.<a class="code" href="structast__frame.html#aed16590d48f41d89f31e0cf347f5cd99">mallocd</a> = 0;
<a name="l01610"></a>01610    f.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = buf;
<a name="l01611"></a>01611    f.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = <a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l01612"></a>01612    f.<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a> = <span class="stringliteral">&quot;app_sms&quot;</span>;
<a name="l01613"></a>01613    <span class="comment">/* create a buffer containing the digital sms pattern */</span>
<a name="l01614"></a>01614    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>; i++) {
<a name="l01615"></a>01615       buf[i] = <a class="code" href="app__sms_8c.html#a1c6c81d0dd59e7e04ac232639a5db460">wave_out</a>[0];               <span class="comment">/* default is silence */</span>
<a name="l01616"></a>01616 
<a name="l01617"></a>01617       <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a600d3882475c4c4c8e0855a8516562aa">opause</a>) {
<a name="l01618"></a>01618          h-&gt;<a class="code" href="structsms__s.html#a600d3882475c4c4c8e0855a8516562aa">opause</a>--;
<a name="l01619"></a>01619       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a299a3166d8ff58de5a5510b0715c552c">obyten</a> || h-&gt;<a class="code" href="structsms__s.html#a3fd2579a2aaf53083eb8d3d85094554c">osync</a>) { <span class="comment">/* sending data */</span>
<a name="l01620"></a>01620          buf[i] = <a class="code" href="app__sms_8c.html#a1c6c81d0dd59e7e04ac232639a5db460">wave_out</a>[h-&gt;<a class="code" href="structsms__s.html#af95b86d8613bac4c53c954205511ec23">ophase</a>];
<a name="l01621"></a>01621          h-&gt;<a class="code" href="structsms__s.html#af95b86d8613bac4c53c954205511ec23">ophase</a> += (h-&gt;<a class="code" href="structsms__s.html#a91573120b8594c3c1581a187c1abbca3">obyte</a> &amp; 1) ? 13 : 21; <span class="comment">/* compute next phase */</span>
<a name="l01622"></a>01622          <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#af95b86d8613bac4c53c954205511ec23">ophase</a> &gt;= 80)
<a name="l01623"></a>01623             h-&gt;<a class="code" href="structsms__s.html#af95b86d8613bac4c53c954205511ec23">ophase</a> -= 80;
<a name="l01624"></a>01624          <span class="keywordflow">if</span> ((h-&gt;<a class="code" href="structsms__s.html#a55eba9c806e66b04fd52a4bdd09a3ce3">ophasep</a> += 12) &gt;= 80) { <span class="comment">/* time to send the next bit */</span>
<a name="l01625"></a>01625             h-&gt;<a class="code" href="structsms__s.html#a55eba9c806e66b04fd52a4bdd09a3ce3">ophasep</a> -= 80;
<a name="l01626"></a>01626             <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a8468bed3bf799ea150212c167133e6ef">oseizure</a> &gt; 0) {      <span class="comment">/* sending channel seizure (proto 2) */</span>
<a name="l01627"></a>01627                h-&gt;<a class="code" href="structsms__s.html#a8468bed3bf799ea150212c167133e6ef">oseizure</a>--;
<a name="l01628"></a>01628                h-&gt;<a class="code" href="structsms__s.html#a91573120b8594c3c1581a187c1abbca3">obyte</a> ^= 1;          <span class="comment">/* toggle low bit */</span>
<a name="l01629"></a>01629             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a3fd2579a2aaf53083eb8d3d85094554c">osync</a>) {
<a name="l01630"></a>01630                h-&gt;<a class="code" href="structsms__s.html#a91573120b8594c3c1581a187c1abbca3">obyte</a> = 1;           <span class="comment">/* send mark as sync bit */</span>
<a name="l01631"></a>01631                h-&gt;<a class="code" href="structsms__s.html#a3fd2579a2aaf53083eb8d3d85094554c">osync</a>--;             <span class="comment">/* sending sync bits */</span>
<a name="l01632"></a>01632                <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a3fd2579a2aaf53083eb8d3d85094554c">osync</a> == 0 &amp;&amp; h-&gt;<a class="code" href="structsms__s.html#ab30e8d7e05ae904d3248e0d51255c005">protocol</a> == 2 &amp;&amp; h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] == <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a5df5d537055950e483ab1b368c26d73f">DLL2_SMS_EST</a>) {
<a name="l01633"></a>01633                   h-&gt;<a class="code" href="structsms__s.html#a8fa429a43fa2c62a852096b184fbcdc4">obytep</a> = h-&gt;<a class="code" href="structsms__s.html#a299a3166d8ff58de5a5510b0715c552c">obyten</a> = 0; <span class="comment">/* we are done */</span>
<a name="l01634"></a>01634                }
<a name="l01635"></a>01635             } <span class="keywordflow">else</span> {
<a name="l01636"></a>01636                h-&gt;<a class="code" href="structsms__s.html#aebe123f864a95e87c1178e3c295aba49">obitp</a>++;
<a name="l01637"></a>01637                <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aebe123f864a95e87c1178e3c295aba49">obitp</a> == 1) {
<a name="l01638"></a>01638                   h-&gt;<a class="code" href="structsms__s.html#a91573120b8594c3c1581a187c1abbca3">obyte</a> = 0;       <span class="comment">/* start bit; */</span>
<a name="l01639"></a>01639                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aebe123f864a95e87c1178e3c295aba49">obitp</a> == 2) {
<a name="l01640"></a>01640                   h-&gt;<a class="code" href="structsms__s.html#a91573120b8594c3c1581a187c1abbca3">obyte</a> = h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[h-&gt;<a class="code" href="structsms__s.html#a8fa429a43fa2c62a852096b184fbcdc4">obytep</a>];
<a name="l01641"></a>01641                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aebe123f864a95e87c1178e3c295aba49">obitp</a> == 10) {
<a name="l01642"></a>01642                   h-&gt;<a class="code" href="structsms__s.html#a91573120b8594c3c1581a187c1abbca3">obyte</a> = 1; <span class="comment">/* stop bit */</span>
<a name="l01643"></a>01643                   h-&gt;<a class="code" href="structsms__s.html#aebe123f864a95e87c1178e3c295aba49">obitp</a> = 0;
<a name="l01644"></a>01644                   h-&gt;<a class="code" href="structsms__s.html#a8fa429a43fa2c62a852096b184fbcdc4">obytep</a>++;
<a name="l01645"></a>01645                   <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a8fa429a43fa2c62a852096b184fbcdc4">obytep</a> == h-&gt;<a class="code" href="structsms__s.html#a299a3166d8ff58de5a5510b0715c552c">obyten</a>) {
<a name="l01646"></a>01646                      h-&gt;<a class="code" href="structsms__s.html#a8fa429a43fa2c62a852096b184fbcdc4">obytep</a> = h-&gt;<a class="code" href="structsms__s.html#a299a3166d8ff58de5a5510b0715c552c">obyten</a> = 0; <span class="comment">/* sent */</span>
<a name="l01647"></a>01647                      h-&gt;<a class="code" href="structsms__s.html#a3fd2579a2aaf53083eb8d3d85094554c">osync</a> = 10;   <span class="comment">/* trailing marks */</span>
<a name="l01648"></a>01648                   }
<a name="l01649"></a>01649                } <span class="keywordflow">else</span> {
<a name="l01650"></a>01650                   h-&gt;<a class="code" href="structsms__s.html#a91573120b8594c3c1581a187c1abbca3">obyte</a> &gt;&gt;= 1;
<a name="l01651"></a>01651                }
<a name="l01652"></a>01652             }
<a name="l01653"></a>01653          }
<a name="l01654"></a>01654       }
<a name="l01655"></a>01655    }
<a name="l01656"></a>01656    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(chan, &amp;f) &lt; 0) {
<a name="l01657"></a>01657       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to write frame to &apos;%s&apos;: %s\n&quot;</span>, chan-&gt;name, strerror(errno));
<a name="l01658"></a>01658       <span class="keywordflow">return</span> -1;
<a name="l01659"></a>01659    }
<a name="l01660"></a>01660    <span class="keywordflow">return</span> 0;
<a name="l01661"></a>01661 <span class="preprocessor">#undef MAXSAMPLES</span>
<a name="l01662"></a>01662 <span class="preprocessor"></span>}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a43baf6d9daec56e893ebc9c204d852f3"></a><!-- doxytag: member="app_sms.c::sms_handleincoming" ref="a43baf6d9daec56e893ebc9c204d852f3" args="(sms_t *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static unsigned char sms_handleincoming </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>handle the incoming <a class="el" href="structmessage.html">message</a> </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01098">1098</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="app__sms_8c_source.html#l00232">sms_s::cli</a>, <a class="el" href="app__sms_8c_source.html#l00219">sms_s::da</a>, <a class="el" href="app__sms_8c_source.html#l00222">sms_s::dcs</a>, <a class="el" href="app__sms_8c_source.html#l00242">sms_s::imsg</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="app__sms_8c_source.html#l00223">sms_s::mr</a>, <a class="el" href="app__sms_8c_source.html#l00218">sms_s::oa</a>, <a class="el" href="app__sms_8c_source.html#l00221">sms_s::pid</a>, <a class="el" href="app__sms_8c_source.html#l00228">sms_s::rp</a>, <a class="el" href="app__sms_8c_source.html#l00216">sms_s::rx</a>, <a class="el" href="app__sms_8c_source.html#l00220">sms_s::scts</a>, <a class="el" href="app__sms_8c_source.html#l00984">sms_writefile()</a>, <a class="el" href="app__sms_8c_source.html#l00215">sms_s::smsc</a>, <a class="el" href="app__sms_8c_source.html#l00226">sms_s::srr</a>, <a class="el" href="app__sms_8c_source.html#l00230">sms_s::ud</a>, <a class="el" href="app__sms_8c_source.html#l00231">sms_s::udh</a>, <a class="el" href="app__sms_8c_source.html#l00227">sms_s::udhi</a>, <a class="el" href="app__sms_8c_source.html#l00225">sms_s::udhl</a>, <a class="el" href="app__sms_8c_source.html#l00224">sms_s::udl</a>, <a class="el" href="app__sms_8c_source.html#l00719">unpackaddress()</a>, <a class="el" href="app__sms_8c_source.html#l00571">unpackdate()</a>, <a class="el" href="app__sms_8c_source.html#l00704">unpacksms()</a>, and <a class="el" href="app__sms_8c_source.html#l00229">sms_s::vp</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01488">sms_messagerx()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01099"></a>01099 {
<a name="l01100"></a>01100    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> p = 3;
<a name="l01101"></a>01101    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ac407ce793f99be51a1804050b3565deb">smsc</a>) {                          <span class="comment">/* SMSC */</span>
<a name="l01102"></a>01102       <span class="keywordflow">if</span> ((h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2] &amp; 3) == 1) {        <span class="comment">/* SMS-SUBMIT */</span>
<a name="l01103"></a>01103          h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a> = h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> = 0;
<a name="l01104"></a>01104          h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> = 0;
<a name="l01105"></a>01105          h-&gt;<a class="code" href="structsms__s.html#a0f7adeccf32fc4c52946d5d20b34c1cd">srr</a> = ((h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2] &amp; 0x20) ? 1 : 0);
<a name="l01106"></a>01106          h-&gt;<a class="code" href="structsms__s.html#a50b93d20a60c5ca8290725dff70be020">udhi</a> = ((h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2] &amp; 0x40) ? 1 : 0);
<a name="l01107"></a>01107          h-&gt;<a class="code" href="structsms__s.html#aa04ad9c90e68d8a6f92b612f798db482">rp</a> = ((h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2] &amp; 0x80) ? 1 : 0);
<a name="l01108"></a>01108          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>, h-&gt;<a class="code" href="structsms__s.html#a306f4c1d73939a3ccb91b0caf7127453">cli</a>, <span class="keyword">sizeof</span>(h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>));
<a name="l01109"></a>01109          h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l01110"></a>01110          h-&gt;<a class="code" href="structsms__s.html#a423cb59610482ae25dcd3df51afdde25">mr</a> = h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[p++];
<a name="l01111"></a>01111          p += <a class="code" href="app__sms_8c.html#ad38c7ea91c75338009d7ef07df937ee9" title="unpack an address from i, return byte length, unpack to o">unpackaddress</a>(h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a>, h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a> + p);
<a name="l01112"></a>01112          h-&gt;<a class="code" href="structsms__s.html#a2c7d9a176d66d466f3e8c54fd519460e">pid</a> = h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[p++];
<a name="l01113"></a>01113          h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a> = h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[p++];
<a name="l01114"></a>01114          <span class="keywordflow">if</span> ((h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2] &amp; 0x18) == 0x10) {       <span class="comment">/* relative VP */</span>
<a name="l01115"></a>01115             <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[p] &lt; 144) {
<a name="l01116"></a>01116                h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> = (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[p] + 1) * 5;
<a name="l01117"></a>01117             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[p] &lt; 168) {
<a name="l01118"></a>01118                h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> = 720 + (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[p] - 143) * 30;
<a name="l01119"></a>01119             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[p] &lt; 197) {
<a name="l01120"></a>01120                h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> = (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[p] - 166) * 1440;
<a name="l01121"></a>01121             } <span class="keywordflow">else</span> {
<a name="l01122"></a>01122                h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> = (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[p] - 192) * 10080;
<a name="l01123"></a>01123             }
<a name="l01124"></a>01124             p++;
<a name="l01125"></a>01125          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2] &amp; 0x18) {
<a name="l01126"></a>01126             p += 7;                     <span class="comment">/* ignore enhanced / absolute VP */</span>
<a name="l01127"></a>01127          }
<a name="l01128"></a>01128          p += <a class="code" href="app__sms_8c.html#a0ec2365c36d7af29acf3bdaad02b082a" title="general unpack - starts with length byte (octet or septet) and returns number of...">unpacksms</a>(h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>, h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a> + p, h-&gt;<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, &amp;h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>, &amp;h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h-&gt;<a class="code" href="structsms__s.html#a50b93d20a60c5ca8290725dff70be020">udhi</a>);
<a name="l01129"></a>01129          h-&gt;<a class="code" href="structsms__s.html#adae482bcbee5489cc0717323eb521082">rx</a> = 1;                      <span class="comment">/* received message */</span>
<a name="l01130"></a>01130          <a class="code" href="app__sms_8c.html#af45fa5279582c213474672cf0684d219" title="white a received text message to a file">sms_writefile</a>(h);               <span class="comment">/* write the file */</span>
<a name="l01131"></a>01131          <span class="keywordflow">if</span> (p != h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[1] + 2) {
<a name="l01132"></a>01132             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Mismatch receive unpacking %d/%d\n&quot;</span>, p, h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[1] + 2);
<a name="l01133"></a>01133             <span class="keywordflow">return</span> 0xFF;        <span class="comment">/* duh! */</span>
<a name="l01134"></a>01134          }
<a name="l01135"></a>01135       } <span class="keywordflow">else</span> {
<a name="l01136"></a>01136          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown message type %02X\n&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2]);
<a name="l01137"></a>01137          <span class="keywordflow">return</span> 0xFF;
<a name="l01138"></a>01138       }
<a name="l01139"></a>01139    } <span class="keywordflow">else</span> {                                <span class="comment">/* client */</span>
<a name="l01140"></a>01140       <span class="keywordflow">if</span> (!(h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2] &amp; 3)) {            <span class="comment">/* SMS-DELIVER */</span>
<a name="l01141"></a>01141          *h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a> = h-&gt;<a class="code" href="structsms__s.html#a0f7adeccf32fc4c52946d5d20b34c1cd">srr</a> = h-&gt;<a class="code" href="structsms__s.html#aa04ad9c90e68d8a6f92b612f798db482">rp</a> = h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> = h-&gt;<a class="code" href="structsms__s.html#a50b93d20a60c5ca8290725dff70be020">udhi</a> = h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a> = h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> = 0;
<a name="l01142"></a>01142          h-&gt;<a class="code" href="structsms__s.html#a0f7adeccf32fc4c52946d5d20b34c1cd">srr</a> = ((h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2] &amp; 0x20) ? 1 : 0);
<a name="l01143"></a>01143          h-&gt;<a class="code" href="structsms__s.html#a50b93d20a60c5ca8290725dff70be020">udhi</a> = ((h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2] &amp; 0x40) ? 1 : 0);
<a name="l01144"></a>01144          h-&gt;<a class="code" href="structsms__s.html#aa04ad9c90e68d8a6f92b612f798db482">rp</a> = ((h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2] &amp; 0x80) ? 1 : 0);
<a name="l01145"></a>01145          h-&gt;<a class="code" href="structsms__s.html#a423cb59610482ae25dcd3df51afdde25">mr</a> = -1;
<a name="l01146"></a>01146          p += <a class="code" href="app__sms_8c.html#ad38c7ea91c75338009d7ef07df937ee9" title="unpack an address from i, return byte length, unpack to o">unpackaddress</a>(h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>, h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a> + p);
<a name="l01147"></a>01147          h-&gt;<a class="code" href="structsms__s.html#a2c7d9a176d66d466f3e8c54fd519460e">pid</a> = h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[p++];
<a name="l01148"></a>01148          h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a> = h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[p++];
<a name="l01149"></a>01149          h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a> = <a class="code" href="app__sms_8c.html#a7c221ca909fed50cb51bd59b0855bc68" title="unpack a date and return">unpackdate</a>(h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a> + p);
<a name="l01150"></a>01150          p += 7;
<a name="l01151"></a>01151          p += <a class="code" href="app__sms_8c.html#a0ec2365c36d7af29acf3bdaad02b082a" title="general unpack - starts with length byte (octet or septet) and returns number of...">unpacksms</a>(h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>, h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a> + p, h-&gt;<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, &amp;h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>, &amp;h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h-&gt;<a class="code" href="structsms__s.html#a50b93d20a60c5ca8290725dff70be020">udhi</a>);
<a name="l01152"></a>01152          h-&gt;<a class="code" href="structsms__s.html#adae482bcbee5489cc0717323eb521082">rx</a> = 1;                      <span class="comment">/* received message */</span>
<a name="l01153"></a>01153          <a class="code" href="app__sms_8c.html#af45fa5279582c213474672cf0684d219" title="white a received text message to a file">sms_writefile</a>(h);               <span class="comment">/* write the file */</span>
<a name="l01154"></a>01154          <span class="keywordflow">if</span> (p != h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[1] + 2) {
<a name="l01155"></a>01155             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Mismatch receive unpacking %d/%d\n&quot;</span>, p, h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[1] + 2);
<a name="l01156"></a>01156             <span class="keywordflow">return</span> 0xFF;                <span class="comment">/* duh! */</span>
<a name="l01157"></a>01157          }
<a name="l01158"></a>01158       } <span class="keywordflow">else</span> {
<a name="l01159"></a>01159          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown message type %02X\n&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2]);
<a name="l01160"></a>01160          <span class="keywordflow">return</span> 0xFF;
<a name="l01161"></a>01161       }
<a name="l01162"></a>01162    }
<a name="l01163"></a>01163    <span class="keywordflow">return</span> 0;                               <span class="comment">/* no error */</span>
<a name="l01164"></a>01164 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ace3cb96a3f20c144ab6eabc4f6f7304e"></a><!-- doxytag: member="app_sms.c::sms_handleincoming_proto2" ref="ace3cb96a3f20c144ab6eabc4f6f7304e" args="(sms_t *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int sms_handleincoming_proto2 </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>sms_handleincoming_proto2: handle the incoming <a class="el" href="structmessage.html">message</a> </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01248">1248</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="localtime_8c_source.html#l01305">ast_localtime()</a>, <a class="el" href="localtime_8c_source.html#l01920">ast_mktime()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="app__sms_8c_source.html#l00219">sms_s::da</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="app__sms_8c_source.html#l00242">sms_s::imsg</a>, <a class="el" href="app__sms_8c_source.html#l01234">MAX_DEBUG_LEN</a>, <a class="el" href="adsistub_8c_source.html#l00055">msg</a>, <a class="el" href="app__sms_8c_source.html#l00218">sms_s::oa</a>, <a class="el" href="app__sms_8c_source.html#l00216">sms_s::rx</a>, <a class="el" href="app__sms_8c_source.html#l00220">sms_s::scts</a>, <a class="el" href="app__sms_8c_source.html#l01235">sms_hexdump()</a>, <a class="el" href="app__sms_8c_source.html#l00984">sms_writefile()</a>, <a class="el" href="localtime_8h_source.html#l00030">ast_tm::tm_hour</a>, <a class="el" href="localtime_8h_source.html#l00031">ast_tm::tm_mday</a>, <a class="el" href="localtime_8h_source.html#l00029">ast_tm::tm_min</a>, <a class="el" href="localtime_8h_source.html#l00032">ast_tm::tm_mon</a>, <a class="el" href="localtime_8h_source.html#l00028">ast_tm::tm_sec</a>, <a class="el" href="app__sms_8c_source.html#l00230">sms_s::ud</a>, and <a class="el" href="app__sms_8c_source.html#l00224">sms_s::udl</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01329">sms_messagerx2()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01249"></a>01249 {
<a name="l01250"></a>01250    <span class="keywordtype">int</span> <a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>, i, sz = 0;
<a name="l01251"></a>01251    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, msgsz;
<a name="l01252"></a>01252    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l01253"></a>01253    <span class="keyword">struct </span>timeval now = { 0, 0 };
<a name="l01254"></a>01254    <span class="keywordtype">char</span> debug_buf[<a class="code" href="app__sms_8c.html#ad88625c032fc5b3a096a60ddd129e2f4">MAX_DEBUG_LEN</a> * 3 + 1];
<a name="l01255"></a>01255 
<a name="l01256"></a>01256    sz = h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[1] + 2;
<a name="l01257"></a>01257    <span class="comment">/* ast_verb(3, &quot;SMS-P2 Frame: %s\n&quot;, sms_hexdump(h-&gt;imsg, sz, debug_buf)); */</span>
<a name="l01258"></a>01258 
<a name="l01259"></a>01259    <span class="comment">/* Parse message body (called payload) */</span>
<a name="l01260"></a>01260    now = h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l01261"></a>01261    <span class="keywordflow">for</span> (f = 4; f &lt; sz; ) {
<a name="l01262"></a>01262       msg = h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f++];
<a name="l01263"></a>01263       msgsz = h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f++];
<a name="l01264"></a>01264       msgsz += (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f++] * 256);
<a name="l01265"></a>01265       <span class="keywordflow">switch</span> (msg) {
<a name="l01266"></a>01266       <span class="keywordflow">case</span> 0x13:                          <span class="comment">/* Body */</span>
<a name="l01267"></a>01267          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;SMS-P2 Body#%02X=[%.*s]\n&quot;</span>, msg, msgsz, &amp;h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f]);
<a name="l01268"></a>01268          <span class="keywordflow">if</span> (msgsz &gt;= <span class="keyword">sizeof</span>(h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>)) {
<a name="l01269"></a>01269             msgsz = <span class="keyword">sizeof</span>(h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>) - 1;
<a name="l01270"></a>01270          }
<a name="l01271"></a>01271          <span class="keywordflow">for</span> (i = 0; i &lt; msgsz; i++) {
<a name="l01272"></a>01272             h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[i] = h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f + i];
<a name="l01273"></a>01273          }
<a name="l01274"></a>01274          h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> = msgsz;
<a name="l01275"></a>01275          <span class="keywordflow">break</span>;
<a name="l01276"></a>01276       <span class="keywordflow">case</span> 0x14:                          <span class="comment">/* Date SCTS */</span>
<a name="l01277"></a>01277          now = h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l01278"></a>01278          <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;tm, NULL);
<a name="l01279"></a>01279          tm.tm_mon = ( (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f] * 10) + h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f + 1] ) - 1;
<a name="l01280"></a>01280          tm.tm_mday = ( (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f + 2] * 10) + h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f + 3] );
<a name="l01281"></a>01281          tm.tm_hour = ( (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f + 4] * 10) + h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f + 5] );
<a name="l01282"></a>01282          tm.tm_min = ( (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f + 6] * 10) + h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f + 7] );
<a name="l01283"></a>01283          tm.tm_sec = 0;
<a name="l01284"></a>01284          h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a> = <a class="code" href="localtime_8h.html#ae0843e4dbbd1fed36d2676dda58e0c44" title="Timezone-independent version of mktime(3).">ast_mktime</a>(&amp;tm, NULL);
<a name="l01285"></a>01285          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;SMS-P2 Date#%02X=%02d/%02d %02d:%02d\n&quot;</span>, msg, tm.tm_mday, tm.tm_mon + 1, tm.tm_hour, tm.tm_min);
<a name="l01286"></a>01286          <span class="keywordflow">break</span>;
<a name="l01287"></a>01287       <span class="keywordflow">case</span> 0x15:                          <span class="comment">/* Calling line (from SMSC) */</span>
<a name="l01288"></a>01288          <span class="keywordflow">if</span> (msgsz &gt;= 20) {
<a name="l01289"></a>01289             msgsz = 20 - 1;
<a name="l01290"></a>01290          }
<a name="l01291"></a>01291          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;SMS-P2 Origin#%02X=[%.*s]\n&quot;</span>, msg, msgsz, &amp;h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f]);
<a name="l01292"></a>01292          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>, (<span class="keywordtype">char</span> *)(&amp;h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f]), msgsz + 1);
<a name="l01293"></a>01293          <span class="keywordflow">break</span>;
<a name="l01294"></a>01294       <span class="keywordflow">case</span> 0x18:                          <span class="comment">/* Destination(from TE/phone) */</span>
<a name="l01295"></a>01295          <span class="keywordflow">if</span> (msgsz &gt;= 20) {
<a name="l01296"></a>01296             msgsz = 20 - 1;
<a name="l01297"></a>01297          }
<a name="l01298"></a>01298          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;SMS-P2 Destination#%02X=[%.*s]\n&quot;</span>, msg, msgsz, &amp;h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f]);
<a name="l01299"></a>01299          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a>, (<span class="keywordtype">char</span> *)(&amp;h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f]), msgsz + 1);
<a name="l01300"></a>01300          <span class="keywordflow">break</span>;
<a name="l01301"></a>01301       <span class="keywordflow">case</span> 0x1C:                          <span class="comment">/* Notify */</span>
<a name="l01302"></a>01302          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;SMS-P2 Notify#%02X=%s\n&quot;</span>, msg, <a class="code" href="app__sms_8c.html#a5f9bfb13333d20c981dfa1de202ee13f">sms_hexdump</a>(&amp;h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f], 3, debug_buf));
<a name="l01303"></a>01303          <span class="keywordflow">break</span>;
<a name="l01304"></a>01304       <span class="keywordflow">default</span>:
<a name="l01305"></a>01305          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;SMS-P2 Par#%02X [%d]: %s\n&quot;</span>, msg, msgsz, <a class="code" href="app__sms_8c.html#a5f9bfb13333d20c981dfa1de202ee13f">sms_hexdump</a>(&amp;h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[f], msgsz, debug_buf));
<a name="l01306"></a>01306          <span class="keywordflow">break</span>;
<a name="l01307"></a>01307       }
<a name="l01308"></a>01308       f+=msgsz;                           <span class="comment">/* Skip to next */</span>
<a name="l01309"></a>01309    }
<a name="l01310"></a>01310    h-&gt;<a class="code" href="structsms__s.html#adae482bcbee5489cc0717323eb521082">rx</a> = 1;                              <span class="comment">/* received message */</span>
<a name="l01311"></a>01311    <a class="code" href="app__sms_8c.html#af45fa5279582c213474672cf0684d219" title="white a received text message to a file">sms_writefile</a>(h);                       <span class="comment">/* write the file */</span>
<a name="l01312"></a>01312    <span class="keywordflow">return</span> 0;                               <span class="comment">/* no error */</span>
<a name="l01313"></a>01313 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5f9bfb13333d20c981dfa1de202ee13f"></a><!-- doxytag: member="app_sms.c::sms_hexdump" ref="a5f9bfb13333d20c981dfa1de202ee13f" args="(unsigned char buf[], int size, char *s)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* sms_hexdump </td>
          <td>(</td>
          <td class="paramtype">unsigned char&nbsp;</td>
          <td class="paramname"> <em>buf</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>s</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01235">1235</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="format__g726_8c_source.html#l00177">f</a>, and <a class="el" href="app__sms_8c_source.html#l01234">MAX_DEBUG_LEN</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01248">sms_handleincoming_proto2()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01236"></a>01236 {
<a name="l01237"></a>01237    <span class="keywordtype">char</span> *p;
<a name="l01238"></a>01238    <span class="keywordtype">int</span> <a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l01239"></a>01239 
<a name="l01240"></a>01240    <span class="keywordflow">for</span> (p = <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, f = 0; f &lt; size &amp;&amp; f &lt; <a class="code" href="app__sms_8c.html#ad88625c032fc5b3a096a60ddd129e2f4">MAX_DEBUG_LEN</a>; f++, p += 3) {
<a name="l01241"></a>01241       sprintf(p, <span class="stringliteral">&quot;%02X &quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[f]);
<a name="l01242"></a>01242    }
<a name="l01243"></a>01243    <span class="keywordflow">return</span>(<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>);
<a name="l01244"></a>01244 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad5e0ab37f40bc7f8885617847ffd3fee"></a><!-- doxytag: member="app_sms.c::sms_log" ref="ad5e0ab37f40bc7f8885617847ffd3fee" args="(sms_t *h, char status)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void sms_log </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>status</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Log the output, and remove file. </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00765">765</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="asterisk_8h_source.html#l00036">AST_FILE_MODE</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="app__sms_8c_source.html#l00219">sms_s::da</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="app__sms_8c_source.html#l00295">isodate()</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="app__sms_8c_source.html#l00223">sms_s::mr</a>, <a class="el" href="app__sms_8c_source.html#l00218">sms_s::oa</a>, <a class="el" href="app__sms_8c_source.html#l00217">sms_s::queue</a>, <a class="el" href="app__sms_8c_source.html#l00216">sms_s::rx</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, <a class="el" href="app__sms_8c_source.html#l00215">sms_s::smsc</a>, <a class="el" href="app__sms_8c_source.html#l00230">sms_s::ud</a>, and <a class="el" href="app__sms_8c_source.html#l00224">sms_s::udl</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01488">sms_messagerx()</a>, and <a class="el" href="app__sms_8c_source.html#l01329">sms_messagerx2()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00766"></a>00766 {
<a name="l00767"></a>00767    <span class="keywordtype">int</span> o;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769    <span class="keywordflow">if</span> (*h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a> == <span class="charliteral">&apos;\0&apos;</span> &amp;&amp; *h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a> == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l00770"></a>00770       <span class="keywordflow">return</span>;
<a name="l00771"></a>00771    }
<a name="l00772"></a>00772    o = open(<a class="code" href="app__sms_8c.html#ad0345d4821606480fcb0e28327340660">log_file</a>, O_CREAT | O_APPEND | O_WRONLY, <a class="code" href="asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>);
<a name="l00773"></a>00773    <span class="keywordflow">if</span> (o &gt;= 0) {
<a name="l00774"></a>00774       <span class="keywordtype">char</span> line[1000], mrs[3] = <span class="stringliteral">&quot;&quot;</span>, *p;
<a name="l00775"></a>00775       <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[30];
<a name="l00776"></a>00776       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> n;
<a name="l00777"></a>00777 
<a name="l00778"></a>00778       <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a423cb59610482ae25dcd3df51afdde25">mr</a> &gt;= 0) {
<a name="l00779"></a>00779          snprintf(mrs, <span class="keyword">sizeof</span>(mrs), <span class="stringliteral">&quot;%02X&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#a423cb59610482ae25dcd3df51afdde25">mr</a>);
<a name="l00780"></a>00780       }
<a name="l00781"></a>00781       snprintf(line, <span class="keyword">sizeof</span>(line), <span class="stringliteral">&quot;%s %c%c%c%s %s %s %s &quot;</span>,
<a name="l00782"></a>00782          <a class="code" href="app__sms_8c.html#aa82dbf6bb6292091b6f9ac19cc841428" title="static, return a date/time in ISO format">isodate</a>(time(NULL), buf, <span class="keyword">sizeof</span>(buf)),
<a name="l00783"></a>00783          <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>, h-&gt;<a class="code" href="structsms__s.html#adae482bcbee5489cc0717323eb521082">rx</a> ? <span class="charliteral">&apos;I&apos;</span> : <span class="charliteral">&apos;O&apos;</span>, h-&gt;<a class="code" href="structsms__s.html#ac407ce793f99be51a1804050b3565deb">smsc</a> ? <span class="charliteral">&apos;S&apos;</span> : <span class="charliteral">&apos;M&apos;</span>, mrs, h-&gt;<a class="code" href="structsms__s.html#ae029547c37a01a171c894cefb942743f">queue</a>,
<a name="l00784"></a>00784          <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>, <span class="stringliteral">&quot;-&quot;</span>), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a>, <span class="stringliteral">&quot;-&quot;</span>) );
<a name="l00785"></a>00785       p = line + strlen(line);
<a name="l00786"></a>00786       <span class="keywordflow">for</span> (n = 0; n &lt; h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>; n++) {
<a name="l00787"></a>00787          <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[n] == <span class="charliteral">&apos;\\&apos;</span>) {
<a name="l00788"></a>00788             *p++ = <span class="charliteral">&apos;\\&apos;</span>;
<a name="l00789"></a>00789             *p++ = <span class="charliteral">&apos;\\&apos;</span>;
<a name="l00790"></a>00790          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[n] == <span class="charliteral">&apos;\n&apos;</span>) {
<a name="l00791"></a>00791             *p++ = <span class="charliteral">&apos;\\&apos;</span>;
<a name="l00792"></a>00792             *p++ = <span class="charliteral">&apos;n&apos;</span>;
<a name="l00793"></a>00793          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[n] == <span class="charliteral">&apos;\r&apos;</span>) {
<a name="l00794"></a>00794             *p++ = <span class="charliteral">&apos;\\&apos;</span>;
<a name="l00795"></a>00795             *p++ = <span class="charliteral">&apos;r&apos;</span>;
<a name="l00796"></a>00796          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[n] &lt; 32 || h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[n] == 127) {
<a name="l00797"></a>00797             *p++ = 191;
<a name="l00798"></a>00798          } <span class="keywordflow">else</span> {
<a name="l00799"></a>00799             *p++ = h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[n];
<a name="l00800"></a>00800          }
<a name="l00801"></a>00801       }
<a name="l00802"></a>00802       *p++ = <span class="charliteral">&apos;\n&apos;</span>;
<a name="l00803"></a>00803       *p = 0;
<a name="l00804"></a>00804       <span class="keywordflow">if</span> (write(o, line, strlen(line)) &lt; 0) {
<a name="l00805"></a>00805          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;write() failed: %s\n&quot;</span>, strerror(errno));
<a name="l00806"></a>00806       }
<a name="l00807"></a>00807       close(o);
<a name="l00808"></a>00808    }
<a name="l00809"></a>00809    *h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a> = *h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a> = h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> = 0;
<a name="l00810"></a>00810 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a24b70dbd9b6b663969974c877a202d61"></a><!-- doxytag: member="app_sms.c::sms_messagerx" ref="a24b70dbd9b6b663969974c877a202d61" args="(sms_t *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void sms_messagerx </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01488">1488</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="channel_8c_source.html#l00136">cause</a>, <a class="el" href="app__sms_8c_source.html#l01468">DIR_RX</a>, <a class="el" href="app__sms_8c_source.html#l00214">sms_s::err</a>, <a class="el" href="app__sms_8c_source.html#l00213">sms_s::hangup</a>, <a class="el" href="app__sms_8c_source.html#l00242">sms_s::imsg</a>, <a class="el" href="app__sms_8c_source.html#l00241">sms_s::omsg</a>, <a class="el" href="app__sms_8c_source.html#l00266">sms_s::protocol</a>, <a class="el" href="app__sms_8c_source.html#l01470">sms_debug()</a>, <a class="el" href="app__sms_8c_source.html#l01098">sms_handleincoming()</a>, <a class="el" href="app__sms_8c_source.html#l00765">sms_log()</a>, <a class="el" href="app__sms_8c_source.html#l01329">sms_messagerx2()</a>, <a class="el" href="app__sms_8c_source.html#l01546">sms_messagetx()</a>, and <a class="el" href="app__sms_8c_source.html#l01428">sms_nextoutgoing()</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01695">sms_process()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01489"></a>01489 {
<a name="l01490"></a>01490    <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>;
<a name="l01491"></a>01491 
<a name="l01492"></a>01492    <a class="code" href="app__sms_8c.html#aec1ab10167ae5ed9af8793c90c10c475">sms_debug</a> (<a class="code" href="app__sms_8c.html#aa4fbf8951a3590171e5def3f7d4cd666">DIR_RX</a>, h);
<a name="l01493"></a>01493    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ab30e8d7e05ae904d3248e0d51255c005">protocol</a> == 2) {
<a name="l01494"></a>01494       <a class="code" href="app__sms_8c.html#aa92b5f49b3da5a82098a3011f8bb7947">sms_messagerx2</a>(h);
<a name="l01495"></a>01495       <span class="keywordflow">return</span>;
<a name="l01496"></a>01496    }
<a name="l01497"></a>01497    <span class="comment">/* parse incoming message for Protocol 1 */</span>
<a name="l01498"></a>01498    <span class="keywordflow">switch</span> (h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[0]) {
<a name="l01499"></a>01499    <span class="keywordflow">case</span> 0x91:                              <span class="comment">/* SMS_DATA */</span>
<a name="l01500"></a>01500       cause = <a class="code" href="app__sms_8c.html#a43baf6d9daec56e893ebc9c204d852f3" title="handle the incoming message">sms_handleincoming</a> (h);
<a name="l01501"></a>01501       <span class="keywordflow">if</span> (!cause) {
<a name="l01502"></a>01502          <a class="code" href="app__sms_8c.html#ad5e0ab37f40bc7f8885617847ffd3fee" title="Log the output, and remove file.">sms_log</a>(h, <span class="charliteral">&apos;Y&apos;</span>);
<a name="l01503"></a>01503          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = 0x95;              <span class="comment">/* SMS_ACK */</span>
<a name="l01504"></a>01504          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = 0x02;
<a name="l01505"></a>01505          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[2] = 0x00;              <span class="comment">/* deliver report */</span>
<a name="l01506"></a>01506          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[3] = 0x00;              <span class="comment">/* no parameters */</span>
<a name="l01507"></a>01507       } <span class="keywordflow">else</span> {                            <span class="comment">/* NACK */</span>
<a name="l01508"></a>01508          <a class="code" href="app__sms_8c.html#ad5e0ab37f40bc7f8885617847ffd3fee" title="Log the output, and remove file.">sms_log</a>(h, <span class="charliteral">&apos;N&apos;</span>);
<a name="l01509"></a>01509          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = 0x96;              <span class="comment">/* SMS_NACK */</span>
<a name="l01510"></a>01510          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = 3;
<a name="l01511"></a>01511          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[2] = 0;                 <span class="comment">/* delivery report */</span>
<a name="l01512"></a>01512          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[3] = cause;             <span class="comment">/* cause */</span>
<a name="l01513"></a>01513          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[4] = 0;                 <span class="comment">/* no parameters */</span>
<a name="l01514"></a>01514       }
<a name="l01515"></a>01515       <a class="code" href="app__sms_8c.html#a47041feede8f04106f4d6221af763e9d">sms_messagetx</a>(h);
<a name="l01516"></a>01516       <span class="keywordflow">break</span>;
<a name="l01517"></a>01517 
<a name="l01518"></a>01518    <span class="keywordflow">case</span> 0x92:                              <span class="comment">/* SMS_ERROR */</span>
<a name="l01519"></a>01519       h-&gt;<a class="code" href="structsms__s.html#a157434392012e4ce1590980a31f692ac">err</a> = 1;
<a name="l01520"></a>01520       <a class="code" href="app__sms_8c.html#a47041feede8f04106f4d6221af763e9d">sms_messagetx</a>(h);                   <span class="comment">/* send whatever we sent again */</span>
<a name="l01521"></a>01521       <span class="keywordflow">break</span>;
<a name="l01522"></a>01522    <span class="keywordflow">case</span> 0x93:                              <span class="comment">/* SMS_EST */</span>
<a name="l01523"></a>01523       <a class="code" href="app__sms_8c.html#aacb45147ec48b5972784c3cf3086d147" title="find and fill in next message, or send a REL if none waiting">sms_nextoutgoing</a> (h);
<a name="l01524"></a>01524       <span class="keywordflow">break</span>;
<a name="l01525"></a>01525    <span class="keywordflow">case</span> 0x94:                              <span class="comment">/* SMS_REL */</span>
<a name="l01526"></a>01526       h-&gt;<a class="code" href="structsms__s.html#ada449bf15f71bb79ab0e662561c78706">hangup</a> = 1;                      <span class="comment">/* hangup */</span>
<a name="l01527"></a>01527       <span class="keywordflow">break</span>;
<a name="l01528"></a>01528    <span class="keywordflow">case</span> 0x95:                              <span class="comment">/* SMS_ACK */</span>
<a name="l01529"></a>01529       <a class="code" href="app__sms_8c.html#ad5e0ab37f40bc7f8885617847ffd3fee" title="Log the output, and remove file.">sms_log</a>(h, <span class="charliteral">&apos;Y&apos;</span>);
<a name="l01530"></a>01530       <a class="code" href="app__sms_8c.html#aacb45147ec48b5972784c3cf3086d147" title="find and fill in next message, or send a REL if none waiting">sms_nextoutgoing</a> (h);
<a name="l01531"></a>01531       <span class="keywordflow">break</span>;
<a name="l01532"></a>01532    <span class="keywordflow">case</span> 0x96:                              <span class="comment">/* SMS_NACK */</span>
<a name="l01533"></a>01533       h-&gt;<a class="code" href="structsms__s.html#a157434392012e4ce1590980a31f692ac">err</a> = 1;
<a name="l01534"></a>01534       <a class="code" href="app__sms_8c.html#ad5e0ab37f40bc7f8885617847ffd3fee" title="Log the output, and remove file.">sms_log</a>(h, <span class="charliteral">&apos;N&apos;</span>);
<a name="l01535"></a>01535       <a class="code" href="app__sms_8c.html#aacb45147ec48b5972784c3cf3086d147" title="find and fill in next message, or send a REL if none waiting">sms_nextoutgoing</a> (h);
<a name="l01536"></a>01536       <span class="keywordflow">break</span>;
<a name="l01537"></a>01537    <span class="keywordflow">default</span>:                                <span class="comment">/* Unknown */</span>
<a name="l01538"></a>01538       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = 0x92;                  <span class="comment">/* SMS_ERROR */</span>
<a name="l01539"></a>01539       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = 1;
<a name="l01540"></a>01540       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[2] = 3;                     <span class="comment">/* unknown message type */</span>
<a name="l01541"></a>01541       <a class="code" href="app__sms_8c.html#a47041feede8f04106f4d6221af763e9d">sms_messagetx</a>(h);
<a name="l01542"></a>01542       <span class="keywordflow">break</span>;
<a name="l01543"></a>01543    }
<a name="l01544"></a>01544 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa92b5f49b3da5a82098a3011f8bb7947"></a><!-- doxytag: member="app_sms.c::sms_messagerx2" ref="aa92b5f49b3da5a82098a3011f8bb7947" args="(sms_t *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void sms_messagerx2 </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01329">1329</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="channel_8c_source.html#l00136">cause</a>, <a class="el" href="app__sms_8c.html#a6c597ad0ac2a2eea8e6653e622742287">DLL2_ACK</a>, <a class="el" href="app__sms_8c_source.html#l00175">DLL2_SMS_ACK0</a>, <a class="el" href="app__sms_8c_source.html#l00176">DLL2_SMS_ACK1</a>, <a class="el" href="app__sms_8c_source.html#l00170">DLL2_SMS_EST</a>, <a class="el" href="app__sms_8c_source.html#l00171">DLL2_SMS_INFO_MO</a>, <a class="el" href="app__sms_8c_source.html#l00172">DLL2_SMS_INFO_MT</a>, <a class="el" href="app__sms_8c_source.html#l00174">DLL2_SMS_NACK</a>, <a class="el" href="app__sms_8c_source.html#l00178">DLL2_SMS_REL</a>, <a class="el" href="app__sms_8c_source.html#l00156">DLL_SMS_MASK</a>, <a class="el" href="app__sms_8c_source.html#l00213">sms_s::hangup</a>, <a class="el" href="app__sms_8c_source.html#l00242">sms_s::imsg</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="app__sms_8c_source.html#l00241">sms_s::omsg</a>, <a class="el" href="app__sms_8c_source.html#l01248">sms_handleincoming_proto2()</a>, <a class="el" href="app__sms_8c_source.html#l00765">sms_log()</a>, <a class="el" href="app__sms_8c_source.html#l01546">sms_messagetx()</a>, and <a class="el" href="app__sms_8c_source.html#l01428">sms_nextoutgoing()</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01488">sms_messagerx()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01330"></a>01330 {
<a name="l01331"></a>01331    <span class="keywordtype">int</span> p = h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[0] &amp; <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9ab52fa5194e2be3c8953de452277a1ae6">DLL_SMS_MASK</a> ; <span class="comment">/* mask the high bit */</span>
<a name="l01332"></a>01332    <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>;
<a name="l01333"></a>01333 
<a name="l01334"></a>01334 <span class="preprocessor">#define DLL2_ACK(h) ((h-&gt;framenumber &amp; 1) ? DLL2_SMS_ACK1: DLL2_SMS_ACK1)</span>
<a name="l01335"></a>01335 <span class="preprocessor"></span>   <span class="keywordflow">switch</span> (p) {
<a name="l01336"></a>01336    <span class="keywordflow">case</span> <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a5df5d537055950e483ab1b368c26d73f">DLL2_SMS_EST</a>:                      <span class="comment">/* Protocol 2: Connection ready (fake): send message  */</span>
<a name="l01337"></a>01337       <a class="code" href="app__sms_8c.html#aacb45147ec48b5972784c3cf3086d147" title="find and fill in next message, or send a REL if none waiting">sms_nextoutgoing</a> (h);
<a name="l01338"></a>01338       <span class="comment">/* smssend(h,&quot;11 29 27 00 10 01 00 00 11 06 00 00 00 00 00 00 00 12 03 00 02 00 04 13 01 00 41 14 08 00 30 39 31 35 30 02 30 02 15 02 00 39 30 &quot;); */</span>
<a name="l01339"></a>01339       <span class="keywordflow">break</span>;
<a name="l01340"></a>01340 
<a name="l01341"></a>01341    <span class="keywordflow">case</span> <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a3d9593f4f21b1e09861ef6ff8787b3e5">DLL2_SMS_INFO_MO</a>:                  <span class="comment">/* transport SMS_SUBMIT */</span>
<a name="l01342"></a>01342    <span class="keywordflow">case</span> <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a01cbc78b9b22bc743fa76b52bc31b99b">DLL2_SMS_INFO_MT</a>:                  <span class="comment">/* transport SMS_DELIVERY */</span>
<a name="l01343"></a>01343       cause = <a class="code" href="app__sms_8c.html#ace3cb96a3f20c144ab6eabc4f6f7304e" title="sms_handleincoming_proto2: handle the incoming message">sms_handleincoming_proto2</a>(h);
<a name="l01344"></a>01344       <span class="keywordflow">if</span> (!cause) {                       <span class="comment">/* ACK */</span>
<a name="l01345"></a>01345          <a class="code" href="app__sms_8c.html#ad5e0ab37f40bc7f8885617847ffd3fee" title="Log the output, and remove file.">sms_log</a>(h, <span class="charliteral">&apos;Y&apos;</span>);
<a name="l01346"></a>01346       }
<a name="l01347"></a>01347       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = <a class="code" href="app__sms_8c.html#a6c597ad0ac2a2eea8e6653e622742287">DLL2_ACK</a>(h);
<a name="l01348"></a>01348       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = 0x06;                  <span class="comment">/* msg len */</span>
<a name="l01349"></a>01349       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[2] = 0x04;                  <span class="comment">/* payload len */</span>
<a name="l01350"></a>01350       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[3] = 0x00;                  <span class="comment">/* payload len */</span>
<a name="l01351"></a>01351       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[4] = 0x1f;                  <span class="comment">/* Response type */</span>
<a name="l01352"></a>01352       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[5] = 0x01;                  <span class="comment">/* parameter len */</span>
<a name="l01353"></a>01353       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[6] = 0x00;                  <span class="comment">/* parameter len */</span>
<a name="l01354"></a>01354       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[7] = cause;                 <span class="comment">/* CONFIRM or error */</span>
<a name="l01355"></a>01355       <a class="code" href="app__sms_8c.html#a47041feede8f04106f4d6221af763e9d">sms_messagetx</a>(h);
<a name="l01356"></a>01356       <span class="keywordflow">break</span>;
<a name="l01357"></a>01357 
<a name="l01358"></a>01358    <span class="keywordflow">case</span> <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9ae7948b7f83c79737c57370e63d2b6ea8">DLL2_SMS_NACK</a>:                     <span class="comment">/* Protocol 2: SMS_NAK */</span>
<a name="l01359"></a>01359       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a4beada5edbf9c5838f1bbc26eb74b8bf">DLL2_SMS_REL</a>;          <span class="comment">/* SMS_REL */</span>
<a name="l01360"></a>01360       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = 0x00;                  <span class="comment">/* msg len */</span>
<a name="l01361"></a>01361       <a class="code" href="app__sms_8c.html#a47041feede8f04106f4d6221af763e9d">sms_messagetx</a>(h);
<a name="l01362"></a>01362       <span class="keywordflow">break</span>;
<a name="l01363"></a>01363 
<a name="l01364"></a>01364    <span class="keywordflow">case</span> <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a20c3011fb7a87c560c2defa4de284855">DLL2_SMS_ACK0</a>:
<a name="l01365"></a>01365    <span class="keywordflow">case</span> <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a0939445034985054325921b2b0e8403a">DLL2_SMS_ACK1</a>:
<a name="l01366"></a>01366       <span class="comment">/* SMS_ACK also transport SMS_SUBMIT or SMS_DELIVERY */</span>
<a name="l01367"></a>01367       <span class="keywordflow">if</span> ( (h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] &amp; <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9ab52fa5194e2be3c8953de452277a1ae6">DLL_SMS_MASK</a>) == <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a4beada5edbf9c5838f1bbc26eb74b8bf">DLL2_SMS_REL</a>) {
<a name="l01368"></a>01368          <span class="comment">/* a response to our Release, just hangup */</span>
<a name="l01369"></a>01369          h-&gt;<a class="code" href="structsms__s.html#ada449bf15f71bb79ab0e662561c78706">hangup</a> = 1;                  <span class="comment">/* hangup */</span>
<a name="l01370"></a>01370       } <span class="keywordflow">else</span> {
<a name="l01371"></a>01371          <span class="comment">/* XXX depending on what we are.. */</span>
<a name="l01372"></a>01372          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;SMS_SUBMIT or SMS_DELIVERY&quot;</span>);
<a name="l01373"></a>01373          <a class="code" href="app__sms_8c.html#aacb45147ec48b5972784c3cf3086d147" title="find and fill in next message, or send a REL if none waiting">sms_nextoutgoing</a> (h);
<a name="l01374"></a>01374       }
<a name="l01375"></a>01375       <span class="keywordflow">break</span>;
<a name="l01376"></a>01376 
<a name="l01377"></a>01377    <span class="keywordflow">case</span> <a class="code" href="app__sms_8c.html#aadad57a8949618b7d23705b7d718c9f9a4beada5edbf9c5838f1bbc26eb74b8bf">DLL2_SMS_REL</a>:                      <span class="comment">/* Protocol 2: SMS_REL (hangup req) */</span>
<a name="l01378"></a>01378       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = <a class="code" href="app__sms_8c.html#a6c597ad0ac2a2eea8e6653e622742287">DLL2_ACK</a>(h);
<a name="l01379"></a>01379       h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = 0;
<a name="l01380"></a>01380       <a class="code" href="app__sms_8c.html#a47041feede8f04106f4d6221af763e9d">sms_messagetx</a>(h);
<a name="l01381"></a>01381       <span class="keywordflow">break</span>;
<a name="l01382"></a>01382    }
<a name="l01383"></a>01383 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a47041feede8f04106f4d6221af763e9d"></a><!-- doxytag: member="app_sms.c::sms_messagetx" ref="a47041feede8f04106f4d6221af763e9d" args="(sms_t *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void sms_messagetx </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01546">1546</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="app__sms_8c_source.html#l01469">DIR_TX</a>, <a class="el" href="app__sms_8c_source.html#l00268">sms_s::framenumber</a>, <a class="el" href="func__strings_8c_source.html#l00821">len()</a>, <a class="el" href="app__sms_8c_source.html#l00237">sms_s::obitp</a>, <a class="el" href="app__sms_8c_source.html#l00235">sms_s::obyte</a>, <a class="el" href="app__sms_8c_source.html#l00240">sms_s::obyten</a>, <a class="el" href="app__sms_8c_source.html#l00239">sms_s::obytep</a>, <a class="el" href="app__sms_8c_source.html#l00241">sms_s::omsg</a>, <a class="el" href="app__sms_8c_source.html#l00236">sms_s::opause</a>, <a class="el" href="app__sms_8c_source.html#l00265">sms_s::opause_0</a>, <a class="el" href="app__sms_8c_source.html#l00267">sms_s::oseizure</a>, <a class="el" href="app__sms_8c_source.html#l00238">sms_s::osync</a>, <a class="el" href="app__sms_8c_source.html#l00146">OSYNC_BITS</a>, <a class="el" href="app__sms_8c_source.html#l00266">sms_s::protocol</a>, and <a class="el" href="app__sms_8c_source.html#l01470">sms_debug()</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01488">sms_messagerx()</a>, <a class="el" href="app__sms_8c_source.html#l01329">sms_messagerx2()</a>, <a class="el" href="app__sms_8c_source.html#l01428">sms_nextoutgoing()</a>, and <a class="el" href="app__sms_8c_source.html#l01695">sms_process()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01547"></a>01547 {
<a name="l01548"></a>01548    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c = 0, p;
<a name="l01549"></a>01549    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] + 2;               <span class="comment">/* total message length excluding checksum */</span>
<a name="l01550"></a>01550 
<a name="l01551"></a>01551    <span class="keywordflow">for</span> (p = 0; p &lt; len; p++) {             <span class="comment">/* compute checksum */</span>
<a name="l01552"></a>01552       c += h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[p];
<a name="l01553"></a>01553    }
<a name="l01554"></a>01554    h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[len] = 0 - c;                   <span class="comment">/* actually, (256 - (c &amp; 0fxx)) &amp; 0xff) */</span>
<a name="l01555"></a>01555    <a class="code" href="app__sms_8c.html#aec1ab10167ae5ed9af8793c90c10c475">sms_debug</a>(<a class="code" href="app__sms_8c.html#af85a8c6a09856dbb3bc88c829432db58">DIR_TX</a>, h);
<a name="l01556"></a>01556    h-&gt;<a class="code" href="structsms__s.html#a68ed7cd4df73b8c9bf4b23d948d1e638">framenumber</a>++;                       <span class="comment">/* Proto 2 */</span>
<a name="l01557"></a>01557    h-&gt;<a class="code" href="structsms__s.html#a8fa429a43fa2c62a852096b184fbcdc4">obytep</a> = 0;
<a name="l01558"></a>01558    h-&gt;<a class="code" href="structsms__s.html#aebe123f864a95e87c1178e3c295aba49">obitp</a> = 0;
<a name="l01559"></a>01559    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ab30e8d7e05ae904d3248e0d51255c005">protocol</a> == 2) {                 <span class="comment">/* Proto 2: */</span>
<a name="l01560"></a>01560       h-&gt;<a class="code" href="structsms__s.html#a8468bed3bf799ea150212c167133e6ef">oseizure</a> = 300;                  <span class="comment">/* 300bits (or more ?) */</span>
<a name="l01561"></a>01561       h-&gt;<a class="code" href="structsms__s.html#a91573120b8594c3c1581a187c1abbca3">obyte</a> = 0;                       <span class="comment">/* Seizure starts with  space (0) */</span>
<a name="l01562"></a>01562       <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] == 0x7F) {
<a name="l01563"></a>01563          h-&gt;<a class="code" href="structsms__s.html#a600d3882475c4c4c8e0855a8516562aa">opause</a> = 8 * h-&gt;<a class="code" href="structsms__s.html#a07d0d1d8e847071c2d9e766749c03da3">opause_0</a>;    <span class="comment">/* initial message delay */</span>
<a name="l01564"></a>01564       } <span class="keywordflow">else</span> {
<a name="l01565"></a>01565          h-&gt;<a class="code" href="structsms__s.html#a600d3882475c4c4c8e0855a8516562aa">opause</a> = 400;
<a name="l01566"></a>01566       }
<a name="l01567"></a>01567    } <span class="keywordflow">else</span> {                                <span class="comment">/* Proto 1: */</span>
<a name="l01568"></a>01568       h-&gt;<a class="code" href="structsms__s.html#a8468bed3bf799ea150212c167133e6ef">oseizure</a> = 0;                    <span class="comment">/* No seizure */</span>
<a name="l01569"></a>01569       h-&gt;<a class="code" href="structsms__s.html#a91573120b8594c3c1581a187c1abbca3">obyte</a> = 1;                       <span class="comment">/* send mark (&apos;1&apos;) at the beginning */</span>
<a name="l01570"></a>01570       <span class="comment">/* Change the initial message delay. BT requires 300ms,</span>
<a name="l01571"></a>01571 <span class="comment">       * but for others this might be way too much and the phone</span>
<a name="l01572"></a>01572 <span class="comment">       * could time out. XXX make it configurable.</span>
<a name="l01573"></a>01573 <span class="comment">      */</span>
<a name="l01574"></a>01574       <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] == 0x93) {
<a name="l01575"></a>01575          h-&gt;<a class="code" href="structsms__s.html#a600d3882475c4c4c8e0855a8516562aa">opause</a> = 8 * h-&gt;<a class="code" href="structsms__s.html#a07d0d1d8e847071c2d9e766749c03da3">opause_0</a>;    <span class="comment">/* initial message delay */</span>
<a name="l01576"></a>01576       } <span class="keywordflow">else</span> {
<a name="l01577"></a>01577          h-&gt;<a class="code" href="structsms__s.html#a600d3882475c4c4c8e0855a8516562aa">opause</a> = 200;
<a name="l01578"></a>01578       }
<a name="l01579"></a>01579    }
<a name="l01580"></a>01580    <span class="comment">/* Note - setting osync triggers the generator */</span>
<a name="l01581"></a>01581    h-&gt;<a class="code" href="structsms__s.html#a3fd2579a2aaf53083eb8d3d85094554c">osync</a> = <a class="code" href="app__sms_8c.html#ae0ea1fb3f3d1fdc8111f0c54d71afb1c">OSYNC_BITS</a>;                  <span class="comment">/* 80 sync bits */</span>
<a name="l01582"></a>01582    h-&gt;<a class="code" href="structsms__s.html#a299a3166d8ff58de5a5510b0715c552c">obyten</a> = len + 1;                    <span class="comment">/* bytes to send (including checksum) */</span>
<a name="l01583"></a>01583 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aacb45147ec48b5972784c3cf3086d147"></a><!-- doxytag: member="app_sms.c::sms_nextoutgoing" ref="aacb45147ec48b5972784c3cf3086d147" args="(sms_t *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void sms_nextoutgoing </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>find and fill in next <a class="el" href="structmessage.html">message</a>, or send a REL if none waiting </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01428">1428</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="asterisk_8c_source.html#l00251">ast_config_AST_SPOOL_DIR</a>, <a class="el" href="utils_8c_source.html#l01765">ast_mkdir()</a>, <a class="el" href="app__sms_8c_source.html#l00219">sms_s::da</a>, <a class="el" href="app__sms_8c_source.html#l00218">sms_s::oa</a>, <a class="el" href="app__sms_8c_source.html#l00241">sms_s::omsg</a>, <a class="el" href="app__sms_8c_source.html#l00266">sms_s::protocol</a>, <a class="el" href="app__sms_8c_source.html#l00217">sms_s::queue</a>, <a class="el" href="app__sms_8c_source.html#l01088">readdirqueue()</a>, <a class="el" href="app__sms_8c_source.html#l00216">sms_s::rx</a>, <a class="el" href="app__sms_8c_source.html#l01386">sms_compose1()</a>, <a class="el" href="app__sms_8c_source.html#l01199">sms_compose2()</a>, <a class="el" href="app__sms_8c_source.html#l01546">sms_messagetx()</a>, <a class="el" href="app__sms_8c_source.html#l00813">sms_readfile()</a>, and <a class="el" href="app__sms_8c_source.html#l00215">sms_s::smsc</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01488">sms_messagerx()</a>, and <a class="el" href="app__sms_8c_source.html#l01329">sms_messagerx2()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01429"></a>01429 {    
<a name="l01430"></a>01430    <span class="keywordtype">char</span> fn[100 + NAME_MAX] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01431"></a>01431    DIR *d;
<a name="l01432"></a>01432    <span class="keywordtype">char</span> more = 0;
<a name="l01433"></a>01433 
<a name="l01434"></a>01434    *h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a> = *h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a> = <span class="charliteral">&apos;\0&apos;</span>;                 <span class="comment">/* clear destinations */</span>
<a name="l01435"></a>01435    h-&gt;<a class="code" href="structsms__s.html#adae482bcbee5489cc0717323eb521082">rx</a> = 0;                              <span class="comment">/* outgoing message */</span>
<a name="l01436"></a>01436    snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;%s/sms/%s&quot;</span>, <a class="code" href="paths_8h.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">ast_config_AST_SPOOL_DIR</a>, h-&gt;<a class="code" href="structsms__s.html#ac407ce793f99be51a1804050b3565deb">smsc</a> ? <span class="stringliteral">&quot;mttx&quot;</span> : <span class="stringliteral">&quot;motx&quot;</span>);
<a name="l01437"></a>01437    <a class="code" href="utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0" title="Recursively create directory path.">ast_mkdir</a>(fn, 0777);                    <span class="comment">/* ensure it exists */</span>
<a name="l01438"></a>01438    d = opendir(fn);
<a name="l01439"></a>01439    <span class="keywordflow">if</span> (d) {
<a name="l01440"></a>01440       <span class="keyword">struct </span>dirent *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = <a class="code" href="app__sms_8c.html#abe8206bb9c2adf04e478cd8e01bd5a94" title="read dir skipping dot files...">readdirqueue</a>(d, h-&gt;<a class="code" href="structsms__s.html#ae029547c37a01a171c894cefb942743f">queue</a>);
<a name="l01441"></a>01441       <span class="keywordflow">if</span> (f) {
<a name="l01442"></a>01442          snprintf(fn + strlen(fn), <span class="keyword">sizeof</span>(fn) - strlen(fn), <span class="stringliteral">&quot;/%s&quot;</span>, f-&gt;d_name);
<a name="l01443"></a>01443          <a class="code" href="app__sms_8c.html#a35be9014d402309539c591ab37a4e7c4" title="parse and delete a file">sms_readfile</a>(h, fn);
<a name="l01444"></a>01444          <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#abe8206bb9c2adf04e478cd8e01bd5a94" title="read dir skipping dot files...">readdirqueue</a>(d, h-&gt;<a class="code" href="structsms__s.html#ae029547c37a01a171c894cefb942743f">queue</a>)) {
<a name="l01445"></a>01445             more = 1;                   <span class="comment">/* more to send */</span>
<a name="l01446"></a>01446          }
<a name="l01447"></a>01447       }
<a name="l01448"></a>01448       closedir(d);
<a name="l01449"></a>01449    }
<a name="l01450"></a>01450    <span class="keywordflow">if</span> (*h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a> || *h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>) {                 <span class="comment">/* message to send */</span>
<a name="l01451"></a>01451       <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ab30e8d7e05ae904d3248e0d51255c005">protocol</a> == 2) {
<a name="l01452"></a>01452          <a class="code" href="app__sms_8c.html#a4cea080950ce2066ed4987ee16fcb8d5">sms_compose2</a>(h, more);
<a name="l01453"></a>01453       } <span class="keywordflow">else</span> {
<a name="l01454"></a>01454          <a class="code" href="app__sms_8c.html#a184a0ba43954b42a5db9a1b1a4854ccb" title="compose a message for protocol 1">sms_compose1</a>(h, more);
<a name="l01455"></a>01455       }
<a name="l01456"></a>01456    } <span class="keywordflow">else</span> {                                <span class="comment">/* no message */</span>
<a name="l01457"></a>01457       <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ab30e8d7e05ae904d3248e0d51255c005">protocol</a> == 2) {
<a name="l01458"></a>01458          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = 0x17;              <span class="comment">/* SMS_REL */</span>
<a name="l01459"></a>01459          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = 0;
<a name="l01460"></a>01460       } <span class="keywordflow">else</span> {
<a name="l01461"></a>01461          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = 0x94;              <span class="comment">/* SMS_REL */</span>
<a name="l01462"></a>01462          h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = 0;
<a name="l01463"></a>01463       }
<a name="l01464"></a>01464    }
<a name="l01465"></a>01465    <a class="code" href="app__sms_8c.html#a47041feede8f04106f4d6221af763e9d">sms_messagetx</a>(h);
<a name="l01466"></a>01466 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa1cc2166cf9b6a4496caf3bb1d11cb6e"></a><!-- doxytag: member="app_sms.c::sms_process" ref="aa1cc2166cf9b6a4496caf3bb1d11cb6e" args="(sms_t *h, int samples, signed short *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void sms_process </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>samples</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">signed short *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Process an incoming frame, trying to detect the carrier and decode the <a class="el" href="structmessage.html">message</a>. The two frequencies are 1300 and 2100 Hz. The decoder detects the amplitude of the signal over the last few samples, filtering the absolute <a class="el" href="structvalues.html">values</a> with a lowpass filter. If the magnitude (h-&gt;imag) is large enough, multiply the signal by the two carriers, and compute the amplitudes m0 and m1. Record the current sample as '0' or '1' depending on which one is greater. The last 3 bits are stored in h-&gt;ibith, with the count of '1' bits in h-&gt;ibitt. XXX the rest is to be determined. </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01695">1695</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="app__sms_8c_source.html#l00214">sms_s::err</a>, <a class="el" href="app__sms_8c_source.html#l00268">sms_s::framenumber</a>, <a class="el" href="app__sms_8c_source.html#l00213">sms_s::hangup</a>, <a class="el" href="app__sms_8c_source.html#l00254">sms_s::ibitc</a>, <a class="el" href="app__sms_8c_source.html#l00261">sms_s::ibith</a>, <a class="el" href="app__sms_8c_source.html#l00253">sms_s::ibitl</a>, <a class="el" href="app__sms_8c_source.html#l00256">sms_s::ibitn</a>, <a class="el" href="app__sms_8c_source.html#l00262">sms_s::ibitt</a>, <a class="el" href="app__sms_8c_source.html#l00259">sms_s::ibytec</a>, <a class="el" href="app__sms_8c_source.html#l00258">sms_s::ibytep</a>, <a class="el" href="app__sms_8c_source.html#l00257">sms_s::ibytev</a>, <a class="el" href="app__sms_8c_source.html#l00247">sms_s::idle</a>, <a class="el" href="app__sms_8c_source.html#l00260">sms_s::ierr</a>, <a class="el" href="app__sms_8c_source.html#l00248">sms_s::imag</a>, <a class="el" href="app__sms_8c_source.html#l00243">sms_s::imc0</a>, <a class="el" href="app__sms_8c_source.html#l00243">sms_s::imc1</a>, <a class="el" href="app__sms_8c_source.html#l00243">sms_s::ims0</a>, <a class="el" href="app__sms_8c_source.html#l00243">sms_s::ims1</a>, <a class="el" href="app__sms_8c_source.html#l00242">sms_s::imsg</a>, <a class="el" href="app__sms_8c_source.html#l00251">sms_s::ipc0</a>, <a class="el" href="app__sms_8c_source.html#l00252">sms_s::ipc1</a>, <a class="el" href="app__sms_8c_source.html#l00255">sms_s::iphasep</a>, <a class="el" href="app__sms_8c_source.html#l00249">sms_s::ips0</a>, <a class="el" href="app__sms_8c_source.html#l00250">sms_s::ips1</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="aesopt_8h_source.html#l00576">m1</a>, <a class="el" href="app__sms_8c_source.html#l00240">sms_s::obyten</a>, <a class="el" href="app__sms_8c_source.html#l00241">sms_s::omsg</a>, <a class="el" href="app__sms_8c_source.html#l00238">sms_s::osync</a>, <a class="el" href="app__sms_8c_source.html#l00266">sms_s::protocol</a>, <a class="el" href="app__sms_8c_source.html#l01488">sms_messagerx()</a>, and <a class="el" href="app__sms_8c_source.html#l01546">sms_messagetx()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01696"></a>01696 {
<a name="l01697"></a>01697    <span class="keywordtype">int</span> bit;
<a name="l01698"></a>01698 
<a name="l01699"></a>01699    <span class="comment">/*</span>
<a name="l01700"></a>01700 <span class="comment">    * Ignore incoming audio while a packet is being transmitted,</span>
<a name="l01701"></a>01701 <span class="comment">    * the protocol is half-duplex.</span>
<a name="l01702"></a>01702 <span class="comment">    * Unfortunately this means that if the outbound and incoming</span>
<a name="l01703"></a>01703 <span class="comment">    * transmission overlap (which is an error condition anyways),</span>
<a name="l01704"></a>01704 <span class="comment">    * we may miss some data and this makes debugging harder.</span>
<a name="l01705"></a>01705 <span class="comment">    */</span>
<a name="l01706"></a>01706    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a299a3166d8ff58de5a5510b0715c552c">obyten</a> || h-&gt;<a class="code" href="structsms__s.html#a3fd2579a2aaf53083eb8d3d85094554c">osync</a>) {
<a name="l01707"></a>01707       <span class="keywordflow">return</span>;
<a name="l01708"></a>01708    }
<a name="l01709"></a>01709    <span class="keywordflow">for</span> ( ; samples-- ; data++) {
<a name="l01710"></a>01710       <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> m0, <a class="code" href="aesopt_8h.html#a112fa29c92065d6624349eb69f35f0fb">m1</a>;
<a name="l01711"></a>01711       <span class="keywordflow">if</span> (abs(*data) &gt; h-&gt;<a class="code" href="structsms__s.html#aef3956e134f50849c6e9f0da45e39302">imag</a>) {
<a name="l01712"></a>01712          h-&gt;<a class="code" href="structsms__s.html#aef3956e134f50849c6e9f0da45e39302">imag</a> = abs(*data);
<a name="l01713"></a>01713       } <span class="keywordflow">else</span> {
<a name="l01714"></a>01714          h-&gt;<a class="code" href="structsms__s.html#aef3956e134f50849c6e9f0da45e39302">imag</a> = h-&gt;<a class="code" href="structsms__s.html#aef3956e134f50849c6e9f0da45e39302">imag</a> * 7 / 8;
<a name="l01715"></a>01715       }
<a name="l01716"></a>01716       <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aef3956e134f50849c6e9f0da45e39302">imag</a> &lt;= 500) {               <span class="comment">/* below [arbitrary] threahold: lost carrier */</span>
<a name="l01717"></a>01717          <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ad68b3622d25bbc56f730bedd0214405f">idle</a>++ == 80000) {       <span class="comment">/* nothing happening */</span>
<a name="l01718"></a>01718             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No data, hanging up\n&quot;</span>);
<a name="l01719"></a>01719             h-&gt;<a class="code" href="structsms__s.html#ada449bf15f71bb79ab0e662561c78706">hangup</a> = 1;
<a name="l01720"></a>01720             h-&gt;<a class="code" href="structsms__s.html#a157434392012e4ce1590980a31f692ac">err</a> = 1;
<a name="l01721"></a>01721          }
<a name="l01722"></a>01722          <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ac78f4035f45f1aa49feb4182b1867a5b">ierr</a>) {                  <span class="comment">/* error */</span>
<a name="l01723"></a>01723             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Error %d, hanging up\n&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#ac78f4035f45f1aa49feb4182b1867a5b">ierr</a>);
<a name="l01724"></a>01724             <span class="comment">/* Protocol 1 */</span>
<a name="l01725"></a>01725             h-&gt;<a class="code" href="structsms__s.html#a157434392012e4ce1590980a31f692ac">err</a> = 1;
<a name="l01726"></a>01726             h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[0] = 0x92;          <span class="comment">/* error */</span>
<a name="l01727"></a>01727             h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[1] = 1;
<a name="l01728"></a>01728             h-&gt;<a class="code" href="structsms__s.html#a2363e944aac6fa90443ce57f8a70c78a">omsg</a>[2] = h-&gt;<a class="code" href="structsms__s.html#ac78f4035f45f1aa49feb4182b1867a5b">ierr</a>;
<a name="l01729"></a>01729             <a class="code" href="app__sms_8c.html#a47041feede8f04106f4d6221af763e9d">sms_messagetx</a>(h);           <span class="comment">/* send error */</span>
<a name="l01730"></a>01730          }
<a name="l01731"></a>01731          h-&gt;<a class="code" href="structsms__s.html#ac78f4035f45f1aa49feb4182b1867a5b">ierr</a> = h-&gt;<a class="code" href="structsms__s.html#a3db9d3dbeac51ea5edbb3829ce02c4ef">ibitn</a> = h-&gt;<a class="code" href="structsms__s.html#a3130aa304b0c5b6b85bf740f27eeaac7">ibytep</a> = h-&gt;<a class="code" href="structsms__s.html#a8d3b48d2e2b2b6c045f807e327bf70f1">ibytec</a> = 0;
<a name="l01732"></a>01732          <span class="keywordflow">continue</span>;
<a name="l01733"></a>01733       }
<a name="l01734"></a>01734       h-&gt;<a class="code" href="structsms__s.html#ad68b3622d25bbc56f730bedd0214405f">idle</a> = 0;
<a name="l01735"></a>01735 
<a name="l01736"></a>01736       <span class="comment">/* multiply signal by the two carriers. */</span>
<a name="l01737"></a>01737       h-&gt;<a class="code" href="structsms__s.html#ad7828ea9fc6b6265334a5eb61a564b00">ims0</a> = (h-&gt;<a class="code" href="structsms__s.html#ad7828ea9fc6b6265334a5eb61a564b00">ims0</a> * 6 + *data * <a class="code" href="app__sms_8c.html#abac9a140958529feb213ec48e0deaca7">wave</a>[h-&gt;<a class="code" href="structsms__s.html#a30b0b8cecb7293bd35f9f2b6f8de16c6">ips0</a>]) / 7;
<a name="l01738"></a>01738       h-&gt;<a class="code" href="structsms__s.html#a15f6e9f44eaba4de3b697b74886b3ea4">imc0</a> = (h-&gt;<a class="code" href="structsms__s.html#a15f6e9f44eaba4de3b697b74886b3ea4">imc0</a> * 6 + *data * <a class="code" href="app__sms_8c.html#abac9a140958529feb213ec48e0deaca7">wave</a>[h-&gt;<a class="code" href="structsms__s.html#adb1bd77faccb1c8198882df8475b5979">ipc0</a>]) / 7;
<a name="l01739"></a>01739       h-&gt;<a class="code" href="structsms__s.html#a6ef929fe1fcd221a71fdedffb986414e">ims1</a> = (h-&gt;<a class="code" href="structsms__s.html#a6ef929fe1fcd221a71fdedffb986414e">ims1</a> * 6 + *data * <a class="code" href="app__sms_8c.html#abac9a140958529feb213ec48e0deaca7">wave</a>[h-&gt;<a class="code" href="structsms__s.html#acf0933f5bc0ccfc7dbd8b7bfe867629f">ips1</a>]) / 7;
<a name="l01740"></a>01740       h-&gt;<a class="code" href="structsms__s.html#a1a29b56b3352d6832f4ba42f3f3138fb">imc1</a> = (h-&gt;<a class="code" href="structsms__s.html#a1a29b56b3352d6832f4ba42f3f3138fb">imc1</a> * 6 + *data * <a class="code" href="app__sms_8c.html#abac9a140958529feb213ec48e0deaca7">wave</a>[h-&gt;<a class="code" href="structsms__s.html#a60ee36698e956201dc2fd920eacf25fe">ipc1</a>]) / 7;
<a name="l01741"></a>01741       <span class="comment">/* compute the amplitudes */</span>
<a name="l01742"></a>01742       m0 = h-&gt;<a class="code" href="structsms__s.html#ad7828ea9fc6b6265334a5eb61a564b00">ims0</a> * h-&gt;<a class="code" href="structsms__s.html#ad7828ea9fc6b6265334a5eb61a564b00">ims0</a> + h-&gt;<a class="code" href="structsms__s.html#a15f6e9f44eaba4de3b697b74886b3ea4">imc0</a> * h-&gt;<a class="code" href="structsms__s.html#a15f6e9f44eaba4de3b697b74886b3ea4">imc0</a>;
<a name="l01743"></a>01743       m1 = h-&gt;<a class="code" href="structsms__s.html#a6ef929fe1fcd221a71fdedffb986414e">ims1</a> * h-&gt;<a class="code" href="structsms__s.html#a6ef929fe1fcd221a71fdedffb986414e">ims1</a> + h-&gt;<a class="code" href="structsms__s.html#a1a29b56b3352d6832f4ba42f3f3138fb">imc1</a> * h-&gt;<a class="code" href="structsms__s.html#a1a29b56b3352d6832f4ba42f3f3138fb">imc1</a>;
<a name="l01744"></a>01744 
<a name="l01745"></a>01745       <span class="comment">/* advance the sin/cos pointers */</span>
<a name="l01746"></a>01746       <span class="keywordflow">if</span> ((h-&gt;<a class="code" href="structsms__s.html#a30b0b8cecb7293bd35f9f2b6f8de16c6">ips0</a> += 21) &gt;= 80) {
<a name="l01747"></a>01747          h-&gt;<a class="code" href="structsms__s.html#a30b0b8cecb7293bd35f9f2b6f8de16c6">ips0</a> -= 80;
<a name="l01748"></a>01748       }
<a name="l01749"></a>01749       <span class="keywordflow">if</span> ((h-&gt;<a class="code" href="structsms__s.html#adb1bd77faccb1c8198882df8475b5979">ipc0</a> += 21) &gt;= 80) {
<a name="l01750"></a>01750          h-&gt;<a class="code" href="structsms__s.html#adb1bd77faccb1c8198882df8475b5979">ipc0</a> -= 80;
<a name="l01751"></a>01751       }
<a name="l01752"></a>01752       <span class="keywordflow">if</span> ((h-&gt;<a class="code" href="structsms__s.html#acf0933f5bc0ccfc7dbd8b7bfe867629f">ips1</a> += 13) &gt;= 80) {
<a name="l01753"></a>01753          h-&gt;<a class="code" href="structsms__s.html#acf0933f5bc0ccfc7dbd8b7bfe867629f">ips1</a> -= 80;
<a name="l01754"></a>01754       }
<a name="l01755"></a>01755       <span class="keywordflow">if</span> ((h-&gt;<a class="code" href="structsms__s.html#a60ee36698e956201dc2fd920eacf25fe">ipc1</a> += 13) &gt;= 80) {
<a name="l01756"></a>01756          h-&gt;<a class="code" href="structsms__s.html#a60ee36698e956201dc2fd920eacf25fe">ipc1</a> -= 80;
<a name="l01757"></a>01757       }
<a name="l01758"></a>01758 
<a name="l01759"></a>01759       <span class="comment">/* set new bit to 1 or 0 depending on which value is stronger */</span>
<a name="l01760"></a>01760       h-&gt;<a class="code" href="structsms__s.html#a17932b980ed0450a7cdb1ab8ea145cfc">ibith</a> &lt;&lt;= 1;
<a name="l01761"></a>01761       <span class="keywordflow">if</span> (m1 &gt; m0) {
<a name="l01762"></a>01762          h-&gt;<a class="code" href="structsms__s.html#a17932b980ed0450a7cdb1ab8ea145cfc">ibith</a> |= 1;
<a name="l01763"></a>01763       }
<a name="l01764"></a>01764       <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a17932b980ed0450a7cdb1ab8ea145cfc">ibith</a> &amp; 8) {
<a name="l01765"></a>01765          h-&gt;<a class="code" href="structsms__s.html#a0d992c1c927311c7a080f721f4d87f28">ibitt</a>--;
<a name="l01766"></a>01766       }
<a name="l01767"></a>01767       <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a17932b980ed0450a7cdb1ab8ea145cfc">ibith</a> &amp; 1) {
<a name="l01768"></a>01768          h-&gt;<a class="code" href="structsms__s.html#a0d992c1c927311c7a080f721f4d87f28">ibitt</a>++;
<a name="l01769"></a>01769       }
<a name="l01770"></a>01770       bit = ((h-&gt;<a class="code" href="structsms__s.html#a0d992c1c927311c7a080f721f4d87f28">ibitt</a> &gt; 1) ? 1 : 0);
<a name="l01771"></a>01771       <span class="keywordflow">if</span> (bit != h-&gt;<a class="code" href="structsms__s.html#a9213f0f8b45857a26cbd8234deeec54b">ibitl</a>) {
<a name="l01772"></a>01772          h-&gt;<a class="code" href="structsms__s.html#a596bd4e14c0c7e431e4224d2740fad17">ibitc</a> = 1;
<a name="l01773"></a>01773       } <span class="keywordflow">else</span> {
<a name="l01774"></a>01774          h-&gt;<a class="code" href="structsms__s.html#a596bd4e14c0c7e431e4224d2740fad17">ibitc</a>++;
<a name="l01775"></a>01775       }
<a name="l01776"></a>01776       h-&gt;<a class="code" href="structsms__s.html#a9213f0f8b45857a26cbd8234deeec54b">ibitl</a> = bit;
<a name="l01777"></a>01777       <span class="keywordflow">if</span> (!h-&gt;<a class="code" href="structsms__s.html#a3db9d3dbeac51ea5edbb3829ce02c4ef">ibitn</a> &amp;&amp; h-&gt;<a class="code" href="structsms__s.html#a596bd4e14c0c7e431e4224d2740fad17">ibitc</a> == 4 &amp;&amp; !bit) {
<a name="l01778"></a>01778          h-&gt;<a class="code" href="structsms__s.html#a3db9d3dbeac51ea5edbb3829ce02c4ef">ibitn</a> = 1;
<a name="l01779"></a>01779          h-&gt;<a class="code" href="structsms__s.html#a8c9d26644b469879cc24afd0bcb6dc8f">iphasep</a> = 0;
<a name="l01780"></a>01780       }
<a name="l01781"></a>01781       <span class="keywordflow">if</span> (bit &amp;&amp; h-&gt;<a class="code" href="structsms__s.html#a596bd4e14c0c7e431e4224d2740fad17">ibitc</a> == 200) {       <span class="comment">/* sync, restart message */</span>
<a name="l01782"></a>01782          <span class="comment">/* Protocol 2: empty connection ready (I am master) */</span>
<a name="l01783"></a>01783          <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a68ed7cd4df73b8c9bf4b23d948d1e638">framenumber</a> &lt; 0 &amp;&amp; h-&gt;<a class="code" href="structsms__s.html#a8d3b48d2e2b2b6c045f807e327bf70f1">ibytec</a> &gt;= 160 &amp;&amp; !memcmp(h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>, <span class="stringliteral">&quot;UUUUUUUUUUUUUUUUUUUU&quot;</span>, 20)) {
<a name="l01784"></a>01784             h-&gt;<a class="code" href="structsms__s.html#a68ed7cd4df73b8c9bf4b23d948d1e638">framenumber</a> = 1;
<a name="l01785"></a>01785             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;SMS protocol 2 detected\n&quot;</span>);
<a name="l01786"></a>01786             h-&gt;<a class="code" href="structsms__s.html#ab30e8d7e05ae904d3248e0d51255c005">protocol</a> = 2;
<a name="l01787"></a>01787             h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[0] = 0xff;          <span class="comment">/* special message (fake) */</span>
<a name="l01788"></a>01788             h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[1] = h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[2] = 0x00;
<a name="l01789"></a>01789             h-&gt;<a class="code" href="structsms__s.html#ac78f4035f45f1aa49feb4182b1867a5b">ierr</a> = h-&gt;<a class="code" href="structsms__s.html#a3db9d3dbeac51ea5edbb3829ce02c4ef">ibitn</a> = h-&gt;<a class="code" href="structsms__s.html#a3130aa304b0c5b6b85bf740f27eeaac7">ibytep</a> = h-&gt;<a class="code" href="structsms__s.html#a8d3b48d2e2b2b6c045f807e327bf70f1">ibytec</a> = 0;
<a name="l01790"></a>01790             <a class="code" href="app__sms_8c.html#a24b70dbd9b6b663969974c877a202d61">sms_messagerx</a>(h);
<a name="l01791"></a>01791          }
<a name="l01792"></a>01792          h-&gt;<a class="code" href="structsms__s.html#ac78f4035f45f1aa49feb4182b1867a5b">ierr</a> = h-&gt;<a class="code" href="structsms__s.html#a3db9d3dbeac51ea5edbb3829ce02c4ef">ibitn</a> = h-&gt;<a class="code" href="structsms__s.html#a3130aa304b0c5b6b85bf740f27eeaac7">ibytep</a> = h-&gt;<a class="code" href="structsms__s.html#a8d3b48d2e2b2b6c045f807e327bf70f1">ibytec</a> = 0;
<a name="l01793"></a>01793       }
<a name="l01794"></a>01794       <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a3db9d3dbeac51ea5edbb3829ce02c4ef">ibitn</a>) {
<a name="l01795"></a>01795          h-&gt;<a class="code" href="structsms__s.html#a8c9d26644b469879cc24afd0bcb6dc8f">iphasep</a> += 12;
<a name="l01796"></a>01796          <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a8c9d26644b469879cc24afd0bcb6dc8f">iphasep</a> &gt;= 80) {         <span class="comment">/* next bit */</span>
<a name="l01797"></a>01797             h-&gt;<a class="code" href="structsms__s.html#a8c9d26644b469879cc24afd0bcb6dc8f">iphasep</a> -= 80;
<a name="l01798"></a>01798             <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a3db9d3dbeac51ea5edbb3829ce02c4ef">ibitn</a>++ == 9) {      <span class="comment">/* end of byte */</span>
<a name="l01799"></a>01799                <span class="keywordflow">if</span> (!bit) {             <span class="comment">/* bad stop bit */</span>
<a name="l01800"></a>01800                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;bad stop bit&quot;</span>);
<a name="l01801"></a>01801                   h-&gt;<a class="code" href="structsms__s.html#ac78f4035f45f1aa49feb4182b1867a5b">ierr</a> = 0xFF;     <span class="comment">/* unknown error */</span>
<a name="l01802"></a>01802                } <span class="keywordflow">else</span> {
<a name="l01803"></a>01803                   <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a3130aa304b0c5b6b85bf740f27eeaac7">ibytep</a> &lt; <span class="keyword">sizeof</span>(h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>)) {
<a name="l01804"></a>01804                      h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[h-&gt;<a class="code" href="structsms__s.html#a3130aa304b0c5b6b85bf740f27eeaac7">ibytep</a>] = h-&gt;<a class="code" href="structsms__s.html#a84557faba63a8f3240f1c8cde8a4d690">ibytev</a>;
<a name="l01805"></a>01805                      h-&gt;<a class="code" href="structsms__s.html#a8d3b48d2e2b2b6c045f807e327bf70f1">ibytec</a> += h-&gt;<a class="code" href="structsms__s.html#a84557faba63a8f3240f1c8cde8a4d690">ibytev</a>;
<a name="l01806"></a>01806                      h-&gt;<a class="code" href="structsms__s.html#a3130aa304b0c5b6b85bf740f27eeaac7">ibytep</a>++;
<a name="l01807"></a>01807                   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a3130aa304b0c5b6b85bf740f27eeaac7">ibytep</a> == <span class="keyword">sizeof</span>(h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>)) {
<a name="l01808"></a>01808                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;msg too large&quot;</span>);
<a name="l01809"></a>01809                      h-&gt;<a class="code" href="structsms__s.html#ac78f4035f45f1aa49feb4182b1867a5b">ierr</a> = 2;    <span class="comment">/* bad message length */</span>
<a name="l01810"></a>01810                   }
<a name="l01811"></a>01811                   <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a3130aa304b0c5b6b85bf740f27eeaac7">ibytep</a> &gt; 1 &amp;&amp; h-&gt;<a class="code" href="structsms__s.html#a3130aa304b0c5b6b85bf740f27eeaac7">ibytep</a> == 3 + h-&gt;<a class="code" href="structsms__s.html#ab2a8421a184a36fdb85c4fb515ee54f8">imsg</a>[1] &amp;&amp; !h-&gt;<a class="code" href="structsms__s.html#ac78f4035f45f1aa49feb4182b1867a5b">ierr</a>) {
<a name="l01812"></a>01812                      <span class="keywordflow">if</span> (!h-&gt;<a class="code" href="structsms__s.html#a8d3b48d2e2b2b6c045f807e327bf70f1">ibytec</a>) {
<a name="l01813"></a>01813                         <a class="code" href="app__sms_8c.html#a24b70dbd9b6b663969974c877a202d61">sms_messagerx</a>(h);
<a name="l01814"></a>01814                      } <span class="keywordflow">else</span> {
<a name="l01815"></a>01815                         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;bad checksum&quot;</span>);
<a name="l01816"></a>01816                         h-&gt;<a class="code" href="structsms__s.html#ac78f4035f45f1aa49feb4182b1867a5b">ierr</a> = 1; <span class="comment">/* bad checksum */</span>
<a name="l01817"></a>01817                      }
<a name="l01818"></a>01818                   }
<a name="l01819"></a>01819                }
<a name="l01820"></a>01820                h-&gt;<a class="code" href="structsms__s.html#a3db9d3dbeac51ea5edbb3829ce02c4ef">ibitn</a> = 0;
<a name="l01821"></a>01821             }
<a name="l01822"></a>01822             h-&gt;<a class="code" href="structsms__s.html#a84557faba63a8f3240f1c8cde8a4d690">ibytev</a> = (h-&gt;<a class="code" href="structsms__s.html#a84557faba63a8f3240f1c8cde8a4d690">ibytev</a> &gt;&gt; 1) + (bit ? 0x80 : 0);
<a name="l01823"></a>01823          }
<a name="l01824"></a>01824       }
<a name="l01825"></a>01825    }
<a name="l01826"></a>01826 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a35be9014d402309539c591ab37a4e7c4"></a><!-- doxytag: member="app_sms.c::sms_readfile" ref="a35be9014d402309539c591ab37a4e7c4" args="(sms_t *h, char *fn)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void sms_readfile </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fn</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>parse and delete a file </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00813">813</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="localtime_8c_source.html#l01920">ast_mktime()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="app__sms_8c_source.html#l00219">sms_s::da</a>, <a class="el" href="app__sms_8c_source.html#l00222">sms_s::dcs</a>, <a class="el" href="app__sms_8c_source.html#l00275">is16bit</a>, <a class="el" href="app__sms_8c_source.html#l00273">is7bit</a>, <a class="el" href="app__sms_8c_source.html#l00274">is8bit</a>, <a class="el" href="logger_8h_source.html#l00130">LOG_EVENT</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="app__sms_8c_source.html#l00223">sms_s::mr</a>, <a class="el" href="app__sms_8c_source.html#l00280">numcpy()</a>, <a class="el" href="app__sms_8c_source.html#l00218">sms_s::oa</a>, <a class="el" href="app__sms_8c_source.html#l00477">packsms16()</a>, <a class="el" href="app__sms_8c_source.html#l00361">packsms7()</a>, <a class="el" href="app__sms_8c_source.html#l00438">packsms8()</a>, <a class="el" href="app__sms_8c_source.html#l00221">sms_s::pid</a>, <a class="el" href="chan__usbradio_8c_source.html#l03157">pp</a>, <a class="el" href="app__sms_8c_source.html#l00228">sms_s::rp</a>, <a class="el" href="app__sms_8c_source.html#l00216">sms_s::rx</a>, <a class="el" href="app__meetme_8c.html#abd5465a13e11fe1c52a5a0f7b0b0812e">S</a>, <a class="el" href="aesopt_8h_source.html#l00399">s</a>, <a class="el" href="app__sms_8c_source.html#l00220">sms_s::scts</a>, <a class="el" href="app__sms_8c_source.html#l00209">SMSLEN</a>, <a class="el" href="app__sms_8c_source.html#l00226">sms_s::srr</a>, <a class="el" href="localtime_8h_source.html#l00030">ast_tm::tm_hour</a>, <a class="el" href="localtime_8h_source.html#l00036">ast_tm::tm_isdst</a>, <a class="el" href="localtime_8h_source.html#l00031">ast_tm::tm_mday</a>, <a class="el" href="localtime_8h_source.html#l00029">ast_tm::tm_min</a>, <a class="el" href="localtime_8h_source.html#l00032">ast_tm::tm_mon</a>, <a class="el" href="localtime_8h_source.html#l00028">ast_tm::tm_sec</a>, <a class="el" href="localtime_8h_source.html#l00033">ast_tm::tm_year</a>, <a class="el" href="app__sms_8c_source.html#l00230">sms_s::ud</a>, <a class="el" href="app__sms_8c_source.html#l00231">sms_s::udh</a>, <a class="el" href="app__sms_8c_source.html#l00227">sms_s::udhi</a>, <a class="el" href="app__sms_8c_source.html#l00225">sms_s::udhl</a>, <a class="el" href="app__sms_8c_source.html#l00224">sms_s::udl</a>, <a class="el" href="app__sms_8c_source.html#l00269">sms_s::udtxt</a>, <a class="el" href="app__sms_8c_source.html#l00307">utf8decode()</a>, and <a class="el" href="app__sms_8c_source.html#l00229">sms_s::vp</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01428">sms_nextoutgoing()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00814"></a>00814 {
<a name="l00815"></a>00815    <span class="keywordtype">char</span> line[1000];
<a name="l00816"></a>00816    FILE *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00817"></a>00817    <span class="keywordtype">char</span> dcsset = 0;                        <span class="comment">/* if DSC set */</span>
<a name="l00818"></a>00818    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#af7c8529df13c84f0c9d1122f36a94a41">LOG_EVENT</a>, <span class="stringliteral">&quot;Sending %s\n&quot;</span>, fn);
<a name="l00819"></a>00819    h-&gt;<a class="code" href="structsms__s.html#adae482bcbee5489cc0717323eb521082">rx</a> = h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> = *h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a> = *h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a> = h-&gt;<a class="code" href="structsms__s.html#a2c7d9a176d66d466f3e8c54fd519460e">pid</a> = h-&gt;<a class="code" href="structsms__s.html#a0f7adeccf32fc4c52946d5d20b34c1cd">srr</a> = h-&gt;<a class="code" href="structsms__s.html#a50b93d20a60c5ca8290725dff70be020">udhi</a> = h-&gt;<a class="code" href="structsms__s.html#aa04ad9c90e68d8a6f92b612f798db482">rp</a> = h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> = h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a> = 0;
<a name="l00820"></a>00820    h-&gt;<a class="code" href="structsms__s.html#a423cb59610482ae25dcd3df51afdde25">mr</a> = -1;
<a name="l00821"></a>00821    h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a> = 0xF1;                          <span class="comment">/* normal messages class 1 */</span>
<a name="l00822"></a>00822    h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00823"></a>00823    s = fopen(fn, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00824"></a>00824    <span class="keywordflow">if</span> (s) {
<a name="l00825"></a>00825       <span class="keywordflow">if</span> (unlink(fn)) {                   <span class="comment">/* concurrent access, we lost */</span>
<a name="l00826"></a>00826          fclose(s);
<a name="l00827"></a>00827          <span class="keywordflow">return</span>;
<a name="l00828"></a>00828       }
<a name="l00829"></a>00829       <span class="keywordflow">while</span> (fgets (line, <span class="keyword">sizeof</span>(line), s)) {   <span class="comment">/* process line in file */</span>
<a name="l00830"></a>00830          <span class="keywordtype">char</span> *p;
<a name="l00831"></a>00831          <span class="keywordtype">void</span> *<a class="code" href="chan__usbradio_8c.html#a76ef0d203c3e50e32968f67eb382677d">pp</a> = &amp;p;
<a name="l00832"></a>00832          <span class="keywordflow">for</span> (p = line; *p &amp;&amp; *p != <span class="charliteral">&apos;\n&apos;</span> &amp;&amp; *p != <span class="charliteral">&apos;\r&apos;</span>; p++);
<a name="l00833"></a>00833          *p = 0;                         <span class="comment">/* strip eoln */</span>
<a name="l00834"></a>00834          p = line;
<a name="l00835"></a>00835          <span class="keywordflow">if</span> (!*p || *p == <span class="charliteral">&apos;;&apos;</span>) {
<a name="l00836"></a>00836             <span class="keywordflow">continue</span>;                   <span class="comment">/* blank line or comment, ignore */</span>
<a name="l00837"></a>00837          }
<a name="l00838"></a>00838          <span class="keywordflow">while</span> (isalnum(*p)) {
<a name="l00839"></a>00839             *p = tolower (*p);
<a name="l00840"></a>00840             p++;
<a name="l00841"></a>00841          }
<a name="l00842"></a>00842          <span class="keywordflow">while</span> (isspace (*p)) {
<a name="l00843"></a>00843             *p++ = 0;
<a name="l00844"></a>00844          }
<a name="l00845"></a>00845          <span class="keywordflow">if</span> (*p == <span class="charliteral">&apos;=&apos;</span>) {
<a name="l00846"></a>00846             *p++ = 0;
<a name="l00847"></a>00847             <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;ud&quot;</span>)) {  <span class="comment">/* parse message (UTF-8) */</span>
<a name="l00848"></a>00848                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> o = 0;
<a name="l00849"></a>00849                memcpy(h-&gt;<a class="code" href="structsms__s.html#aaa5504977ac9f7302b9632878eb455e5">udtxt</a>, p, <a class="code" href="app__sms_8c.html#a92bf696f8279259f5741564c2c2b2af2">SMSLEN</a>); <span class="comment">/* for protocol 2 */</span>
<a name="l00850"></a>00850                <span class="keywordflow">while</span> (*p &amp;&amp; o &lt; <a class="code" href="app__sms_8c.html#a92bf696f8279259f5741564c2c2b2af2">SMSLEN</a>) {
<a name="l00851"></a>00851                   h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[o++] = <a class="code" href="app__sms_8c.html#a375cda00ad33985349625ad6f8ae70ef" title="Reads next UCS character from NUL terminated UTF-8 string and advance pointer.">utf8decode</a>(pp);
<a name="l00852"></a>00852                }
<a name="l00853"></a>00853                h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> = o;
<a name="l00854"></a>00854                <span class="keywordflow">if</span> (*p) {
<a name="l00855"></a>00855                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;UD too long in %s\n&quot;</span>, fn);
<a name="l00856"></a>00856                }
<a name="l00857"></a>00857             } <span class="keywordflow">else</span> {
<a name="l00858"></a>00858                <span class="keywordflow">while</span> (isspace (*p)) {
<a name="l00859"></a>00859                   p++;
<a name="l00860"></a>00860                }
<a name="l00861"></a>00861                <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;oa&quot;</span>) &amp;&amp; strlen(p) &lt; <span class="keyword">sizeof</span>(h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>)) {
<a name="l00862"></a>00862                   <a class="code" href="app__sms_8c.html#a660b5407faba61b0835356de97c78a0c" title="copy number, skipping non digits apart from leading +">numcpy</a> (h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>, p);
<a name="l00863"></a>00863                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;da&quot;</span>) &amp;&amp; strlen(p) &lt; <span class="keyword">sizeof</span>(h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>)) {
<a name="l00864"></a>00864                   <a class="code" href="app__sms_8c.html#a660b5407faba61b0835356de97c78a0c" title="copy number, skipping non digits apart from leading +">numcpy</a> (h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a>, p);
<a name="l00865"></a>00865                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;pid&quot;</span>)) {
<a name="l00866"></a>00866                   h-&gt;<a class="code" href="structsms__s.html#a2c7d9a176d66d466f3e8c54fd519460e">pid</a> = atoi(p);
<a name="l00867"></a>00867                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;dcs&quot;</span>)) {
<a name="l00868"></a>00868                   h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a> = atoi(p);
<a name="l00869"></a>00869                   dcsset = 1;
<a name="l00870"></a>00870                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;mr&quot;</span>)) {
<a name="l00871"></a>00871                   h-&gt;<a class="code" href="structsms__s.html#a423cb59610482ae25dcd3df51afdde25">mr</a> = atoi(p);
<a name="l00872"></a>00872                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;srr&quot;</span>)) {
<a name="l00873"></a>00873                   h-&gt;<a class="code" href="structsms__s.html#a0f7adeccf32fc4c52946d5d20b34c1cd">srr</a> = (atoi(p) ? 1 : 0);
<a name="l00874"></a>00874                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;vp&quot;</span>)) {
<a name="l00875"></a>00875                   h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a> = atoi(p);
<a name="l00876"></a>00876                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;rp&quot;</span>)) {
<a name="l00877"></a>00877                   h-&gt;<a class="code" href="structsms__s.html#aa04ad9c90e68d8a6f92b612f798db482">rp</a> = (atoi(p) ? 1 : 0);
<a name="l00878"></a>00878                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;scts&quot;</span>)) {    <span class="comment">/* get date/time */</span>
<a name="l00879"></a>00879                   <span class="keywordtype">int</span> Y, m, d, H, M, <a class="code" href="app__meetme_8c.html#abd5465a13e11fe1c52a5a0f7b0b0812e">S</a>;
<a name="l00880"></a>00880                   <span class="comment">/* XXX Why aren&apos;t we using ast_strptime here? */</span>
<a name="l00881"></a>00881                   <span class="keywordflow">if</span> (sscanf(p, <span class="stringliteral">&quot;%4d-%2d-%2dT%2d:%2d:%2d&quot;</span>, &amp;Y, &amp;m, &amp;d, &amp;H, &amp;M, &amp;S) == 6) {
<a name="l00882"></a>00882                      <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> t = { 0, };
<a name="l00883"></a>00883                      t.<a class="code" href="structast__tm.html#a994c4f4519ba57e186580d21cc86f9e5">tm_year</a> = Y - 1900;
<a name="l00884"></a>00884                      t.<a class="code" href="structast__tm.html#ada983deda100b604bee5716512453658">tm_mon</a> = m - 1;
<a name="l00885"></a>00885                      t.<a class="code" href="structast__tm.html#a02048604d30b880033311cf542d63f92">tm_mday</a> = d;
<a name="l00886"></a>00886                      t.<a class="code" href="structast__tm.html#a4d171061df9e012fcfbd1172b8440d5f">tm_hour</a> = H;
<a name="l00887"></a>00887                      t.<a class="code" href="structast__tm.html#a987fa9280fe4cd6c6b8f77409f1c1504">tm_min</a> = M;
<a name="l00888"></a>00888                      t.<a class="code" href="structast__tm.html#a18df301c1a10c8d493da86ce5c2aea78">tm_sec</a> = S;
<a name="l00889"></a>00889                      t.<a class="code" href="structast__tm.html#a7d102a87f898878ebf37ebd87504e099">tm_isdst</a> = -1;
<a name="l00890"></a>00890                      h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a> = <a class="code" href="localtime_8h.html#ae0843e4dbbd1fed36d2676dda58e0c44" title="Timezone-independent version of mktime(3).">ast_mktime</a>(&amp;t, NULL);
<a name="l00891"></a>00891                      <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a>.tv_sec == 0) {
<a name="l00892"></a>00892                         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Bad date/timein %s: %s&quot;</span>, fn, p);
<a name="l00893"></a>00893                      }
<a name="l00894"></a>00894                   }
<a name="l00895"></a>00895                } <span class="keywordflow">else</span> {
<a name="l00896"></a>00896                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot parse in %s: %s=%si\n&quot;</span>, fn, line, p);
<a name="l00897"></a>00897                }
<a name="l00898"></a>00898             }
<a name="l00899"></a>00899          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*p == <span class="charliteral">&apos;#&apos;</span>) {                   <span class="comment">/* raw hex format */</span>
<a name="l00900"></a>00900             *p++ = 0;
<a name="l00901"></a>00901             <span class="keywordflow">if</span> (*p == <span class="charliteral">&apos;#&apos;</span>) {
<a name="l00902"></a>00902                p++;
<a name="l00903"></a>00903                <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;ud&quot;</span>)) {        <span class="comment">/* user data */</span>
<a name="l00904"></a>00904                   <span class="keywordtype">int</span> o = 0;
<a name="l00905"></a>00905                   <span class="keywordflow">while</span> (*p &amp;&amp; o &lt; <a class="code" href="app__sms_8c.html#a92bf696f8279259f5741564c2c2b2af2">SMSLEN</a>) {
<a name="l00906"></a>00906                      <span class="keywordflow">if</span> (isxdigit(*p) &amp;&amp; isxdigit(p[1]) &amp;&amp; isxdigit(p[2]) &amp;&amp; isxdigit(p[3])) {
<a name="l00907"></a>00907                         h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[o++] =
<a name="l00908"></a>00908                            (((isalpha(*p) ? 9 : 0) + (*p &amp; 0xF)) &lt;&lt; 12) +
<a name="l00909"></a>00909                            (((isalpha(p[1]) ? 9 : 0) + (p[1] &amp; 0xF)) &lt;&lt; 8) +
<a name="l00910"></a>00910                            (((isalpha(p[2]) ? 9 : 0) + (p[2] &amp; 0xF)) &lt;&lt; 4) + ((isalpha(p[3]) ? 9 : 0) + (p[3] &amp; 0xF));
<a name="l00911"></a>00911                         p += 4;
<a name="l00912"></a>00912                      } <span class="keywordflow">else</span>
<a name="l00913"></a>00913                         <span class="keywordflow">break</span>;
<a name="l00914"></a>00914                   }
<a name="l00915"></a>00915                   h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> = o;
<a name="l00916"></a>00916                   <span class="keywordflow">if</span> (*p)
<a name="l00917"></a>00917                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;UD too long / invalid UCS-2 hex in %s\n&quot;</span>, fn);
<a name="l00918"></a>00918                } <span class="keywordflow">else</span>
<a name="l00919"></a>00919                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Only ud can use ## format, %s\n&quot;</span>, fn);
<a name="l00920"></a>00920             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;ud&quot;</span>)) {       <span class="comment">/* user data */</span>
<a name="l00921"></a>00921                <span class="keywordtype">int</span> o = 0;
<a name="l00922"></a>00922                <span class="keywordflow">while</span> (*p &amp;&amp; o &lt; <a class="code" href="app__sms_8c.html#a92bf696f8279259f5741564c2c2b2af2">SMSLEN</a>) {
<a name="l00923"></a>00923                   <span class="keywordflow">if</span> (isxdigit(*p) &amp;&amp; isxdigit(p[1])) {
<a name="l00924"></a>00924                      h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[o++] = (((isalpha(*p) ? 9 : 0) + (*p &amp; 0xF)) &lt;&lt; 4) + ((isalpha(p[1]) ? 9 : 0) + (p[1] &amp; 0xF));
<a name="l00925"></a>00925                      p += 2;
<a name="l00926"></a>00926                   } <span class="keywordflow">else</span> {
<a name="l00927"></a>00927                      <span class="keywordflow">break</span>;
<a name="l00928"></a>00928                   }
<a name="l00929"></a>00929                }
<a name="l00930"></a>00930                h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> = o;
<a name="l00931"></a>00931                <span class="keywordflow">if</span> (*p) {
<a name="l00932"></a>00932                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;UD too long / invalid UCS-1 hex in %s\n&quot;</span>, fn);
<a name="l00933"></a>00933                }
<a name="l00934"></a>00934             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(line, <span class="stringliteral">&quot;udh&quot;</span>)) {      <span class="comment">/* user data header */</span>
<a name="l00935"></a>00935                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> o = 0;
<a name="l00936"></a>00936                h-&gt;<a class="code" href="structsms__s.html#a50b93d20a60c5ca8290725dff70be020">udhi</a> = 1;
<a name="l00937"></a>00937                <span class="keywordflow">while</span> (*p &amp;&amp; o &lt; <a class="code" href="app__sms_8c.html#a92bf696f8279259f5741564c2c2b2af2">SMSLEN</a>) {
<a name="l00938"></a>00938                   <span class="keywordflow">if</span> (isxdigit(*p) &amp;&amp; isxdigit(p[1])) {
<a name="l00939"></a>00939                      h-&gt;<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>[o] = (((isalpha(*p) ? 9 : 0) + (*p &amp; 0xF)) &lt;&lt; 4) + ((isalpha(p[1]) ? 9 : 0) + (p[1] &amp; 0xF));
<a name="l00940"></a>00940                      o++;
<a name="l00941"></a>00941                      p += 2;
<a name="l00942"></a>00942                   } <span class="keywordflow">else</span> {
<a name="l00943"></a>00943                      <span class="keywordflow">break</span>;
<a name="l00944"></a>00944                   }
<a name="l00945"></a>00945                }
<a name="l00946"></a>00946                h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a> = o;
<a name="l00947"></a>00947                <span class="keywordflow">if</span> (*p) {
<a name="l00948"></a>00948                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;UDH too long / invalid hex in %s\n&quot;</span>, fn);
<a name="l00949"></a>00949                }
<a name="l00950"></a>00950             } <span class="keywordflow">else</span> {
<a name="l00951"></a>00951                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Only ud and udh can use # format, %s\n&quot;</span>, fn);
<a name="l00952"></a>00952             }
<a name="l00953"></a>00953          } <span class="keywordflow">else</span> {
<a name="l00954"></a>00954             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot parse in %s: %s\n&quot;</span>, fn, line);
<a name="l00955"></a>00955          }
<a name="l00956"></a>00956       }
<a name="l00957"></a>00957       fclose(s);
<a name="l00958"></a>00958       <span class="keywordflow">if</span> (!dcsset &amp;&amp; <a class="code" href="app__sms_8c.html#a172d0c2bb9c8a56df817acb5ce7bfe3c" title="takes a binary header (udhl bytes at udh) and UCS-2 message (udl characters at ud)...">packsms7</a>(0, h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h-&gt;<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>) &lt; 0) {
<a name="l00959"></a>00959          <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#aa3645875887568a20059ae86c7a66f74" title="takes a binary header (udhl bytes at udh) and UCS-2 message (udl characters at ud)...">packsms8</a>(0, h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h-&gt;<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>) &lt; 0) {
<a name="l00960"></a>00960             <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#a77ab80a9e6251174378df1f59b5dbc44" title="takes a binary header (udhl bytes at udh) and UCS-2 message (udl characters at ud)...">packsms16</a>(0, h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h-&gt;<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>) &lt; 0) {
<a name="l00961"></a>00961                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid UTF-8 message even for UCS-2 (%s)\n&quot;</span>, fn);
<a name="l00962"></a>00962             } <span class="keywordflow">else</span> {
<a name="l00963"></a>00963                h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a> = 0x08;          <span class="comment">/* default to 16 bit */</span>
<a name="l00964"></a>00964                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Sending in 16 bit format(%s)\n&quot;</span>, fn);
<a name="l00965"></a>00965             }
<a name="l00966"></a>00966          } <span class="keywordflow">else</span> {
<a name="l00967"></a>00967             h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a> = 0xF5;              <span class="comment">/* default to 8 bit */</span>
<a name="l00968"></a>00968             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Sending in 8 bit format(%s)\n&quot;</span>, fn);
<a name="l00969"></a>00969          }
<a name="l00970"></a>00970       }
<a name="l00971"></a>00971       <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#a39743cbea53fca38237f049acd4cb834">is7bit</a>(h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>) &amp;&amp; <a class="code" href="app__sms_8c.html#a172d0c2bb9c8a56df817acb5ce7bfe3c" title="takes a binary header (udhl bytes at udh) and UCS-2 message (udl characters at ud)...">packsms7</a>(0, h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h-&gt;<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>) &lt; 0) {
<a name="l00972"></a>00972          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid 7 bit GSM data %s\n&quot;</span>, fn);
<a name="l00973"></a>00973       }
<a name="l00974"></a>00974       <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#a5f533f0d22e8b3eac586398fbae67636">is8bit</a>(h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>) &amp;&amp; <a class="code" href="app__sms_8c.html#aa3645875887568a20059ae86c7a66f74" title="takes a binary header (udhl bytes at udh) and UCS-2 message (udl characters at ud)...">packsms8</a>(0, h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h-&gt;<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>) &lt; 0) {
<a name="l00975"></a>00975          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid 8 bit data %s\n&quot;</span>, fn);
<a name="l00976"></a>00976       }
<a name="l00977"></a>00977       <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#a8bdd552aa3abf01b520c87815e1c2b24">is16bit</a>(h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>) &amp;&amp; <a class="code" href="app__sms_8c.html#a77ab80a9e6251174378df1f59b5dbc44" title="takes a binary header (udhl bytes at udh) and UCS-2 message (udl characters at ud)...">packsms16</a>(0, h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>, h-&gt;<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>, h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>, h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>) &lt; 0) {
<a name="l00978"></a>00978          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid 16 bit data %s\n&quot;</span>, fn);
<a name="l00979"></a>00979       }
<a name="l00980"></a>00980    }
<a name="l00981"></a>00981 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab0fd8690c8108023eafe2da490478f56"></a><!-- doxytag: member="app_sms.c::sms_release" ref="ab0fd8690c8108023eafe2da490478f56" args="(struct ast_channel *chan, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void sms_release </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01672">1672</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01673"></a>01673 {
<a name="l01674"></a>01674    <span class="keywordflow">return</span>;  <span class="comment">/* nothing to do here. */</span>
<a name="l01675"></a>01675 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af45fa5279582c213474672cf0684d219"></a><!-- doxytag: member="app_sms.c::sms_writefile" ref="af45fa5279582c213474672cf0684d219" args="(sms_t *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void sms_writefile </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structsms__s.html">sms_t</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>white a received text <a class="el" href="structmessage.html">message</a> to a file </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00984">984</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="asterisk_8c_source.html#l00251">ast_config_AST_SPOOL_DIR</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8c_source.html#l01765">ast_mkdir()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="time_8h_source.html#l00099">ast_tvzero()</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="app__sms_8c_source.html#l00219">sms_s::da</a>, <a class="el" href="app__sms_8c_source.html#l00222">sms_s::dcs</a>, <a class="el" href="app__sms_8c_source.html#l00295">isodate()</a>, <a class="el" href="logger_8h_source.html#l00130">LOG_EVENT</a>, <a class="el" href="app__sms_8c_source.html#l00223">sms_s::mr</a>, <a class="el" href="app__sms_8c_source.html#l00218">sms_s::oa</a>, <a class="el" href="app__sms_8c_source.html#l00221">sms_s::pid</a>, <a class="el" href="app__sms_8c_source.html#l00217">sms_s::queue</a>, <a class="el" href="app__sms_8c_source.html#l00228">sms_s::rp</a>, <a class="el" href="app__sms_8c_source.html#l00216">sms_s::rx</a>, <a class="el" href="app__sms_8c_source.html#l00220">sms_s::scts</a>, <a class="el" href="app__sms_8c_source.html#l00215">sms_s::smsc</a>, <a class="el" href="app__sms_8c_source.html#l00226">sms_s::srr</a>, <a class="el" href="app__sms_8c_source.html#l00230">sms_s::ud</a>, <a class="el" href="app__sms_8c_source.html#l00231">sms_s::udh</a>, <a class="el" href="app__sms_8c_source.html#l00227">sms_s::udhi</a>, <a class="el" href="app__sms_8c_source.html#l00225">sms_s::udhl</a>, <a class="el" href="app__sms_8c_source.html#l00224">sms_s::udl</a>, and <a class="el" href="app__sms_8c_source.html#l00229">sms_s::vp</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01098">sms_handleincoming()</a>, and <a class="el" href="app__sms_8c_source.html#l01248">sms_handleincoming_proto2()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00985"></a>00985 {
<a name="l00986"></a>00986    <span class="keywordtype">char</span> fn[200] = <span class="stringliteral">&quot;&quot;</span>, fn2[200] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00987"></a>00987    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[30];
<a name="l00988"></a>00988    FILE *o;
<a name="l00989"></a>00989 
<a name="l00990"></a>00990    <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a>)) {
<a name="l00991"></a>00991       h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00992"></a>00992    }
<a name="l00993"></a>00993    snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;%s/sms/%s&quot;</span>, <a class="code" href="paths_8h.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">ast_config_AST_SPOOL_DIR</a>, h-&gt;<a class="code" href="structsms__s.html#ac407ce793f99be51a1804050b3565deb">smsc</a> ? h-&gt;<a class="code" href="structsms__s.html#adae482bcbee5489cc0717323eb521082">rx</a> ? <span class="stringliteral">&quot;morx&quot;</span> : <span class="stringliteral">&quot;mttx&quot;</span> : h-&gt;<a class="code" href="structsms__s.html#adae482bcbee5489cc0717323eb521082">rx</a> ? <span class="stringliteral">&quot;mtrx&quot;</span> : <span class="stringliteral">&quot;motx&quot;</span>);
<a name="l00994"></a>00994    <a class="code" href="utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0" title="Recursively create directory path.">ast_mkdir</a>(fn, 0777);                    <span class="comment">/* ensure it exists */</span>
<a name="l00995"></a>00995    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fn2, fn, <span class="keyword">sizeof</span>(fn2));
<a name="l00996"></a>00996    snprintf(fn2 + strlen(fn2), <span class="keyword">sizeof</span>(fn2) - strlen(fn2), <span class="stringliteral">&quot;/%s.%s-%d&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#ae029547c37a01a171c894cefb942743f">queue</a>, <a class="code" href="app__sms_8c.html#aa82dbf6bb6292091b6f9ac19cc841428" title="static, return a date/time in ISO format">isodate</a>(h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a>.tv_sec, buf, <span class="keyword">sizeof</span>(buf)), <a class="code" href="app__sms_8c.html#a8514112da88a5d13451aaf8c9b064017">seq</a>++);
<a name="l00997"></a>00997    snprintf(fn + strlen(fn), <span class="keyword">sizeof</span>(fn) - strlen(fn), <span class="stringliteral">&quot;/.%s&quot;</span>, fn2 + strlen(fn) + 1);
<a name="l00998"></a>00998    <span class="keywordflow">if</span> ((o = fopen(fn, <span class="stringliteral">&quot;w&quot;</span>)) == NULL) {
<a name="l00999"></a>00999       <span class="keywordflow">return</span>;
<a name="l01000"></a>01000    }
<a name="l01001"></a>01001 
<a name="l01002"></a>01002    <span class="keywordflow">if</span> (*h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>) {
<a name="l01003"></a>01003       fprintf(o, <span class="stringliteral">&quot;oa=%s\n&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#a32a2774c5e456ab25f26d45cc145e882">oa</a>);
<a name="l01004"></a>01004    }
<a name="l01005"></a>01005    <span class="keywordflow">if</span> (*h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a>) {
<a name="l01006"></a>01006       fprintf(o, <span class="stringliteral">&quot;da=%s\n&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#a2474e717dcd2fd71d03e63cf76965c86">da</a>);
<a name="l01007"></a>01007    }
<a name="l01008"></a>01008    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a50b93d20a60c5ca8290725dff70be020">udhi</a>) {
<a name="l01009"></a>01009       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p;
<a name="l01010"></a>01010       fprintf(o, <span class="stringliteral">&quot;udh#&quot;</span>);
<a name="l01011"></a>01011       <span class="keywordflow">for</span> (p = 0; p &lt; h-&gt;<a class="code" href="structsms__s.html#a74432ad1d458c890a5f136080c831d57">udhl</a>; p++) {
<a name="l01012"></a>01012          fprintf(o, <span class="stringliteral">&quot;%02X&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#a37cf044b446d0c9825730351ae1be8a0">udh</a>[p]);
<a name="l01013"></a>01013       }
<a name="l01014"></a>01014       fprintf(o, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01015"></a>01015    }
<a name="l01016"></a>01016    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>) {
<a name="l01017"></a>01017       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p;
<a name="l01018"></a>01018       <span class="keywordflow">for</span> (p = 0; p &lt; h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> &amp;&amp; h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[p] &gt;= <span class="charliteral">&apos; &apos;</span>; p++);
<a name="l01019"></a>01019       <span class="keywordflow">if</span> (p &lt; h-&gt;udl) {
<a name="l01020"></a>01020          fputc(<span class="charliteral">&apos;;&apos;</span>, o);                  <span class="comment">/* cannot use ud=, but include as a comment for human readable */</span>
<a name="l01021"></a>01021       }
<a name="l01022"></a>01022       fprintf(o, <span class="stringliteral">&quot;ud=&quot;</span>);
<a name="l01023"></a>01023       <span class="keywordflow">for</span> (p = 0; p &lt; h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>; p++) {
<a name="l01024"></a>01024          <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> v = h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[p];
<a name="l01025"></a>01025          <span class="keywordflow">if</span> (v &lt; 32) {
<a name="l01026"></a>01026             fputc(191, o);
<a name="l01027"></a>01027          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v &lt; 0x80) {
<a name="l01028"></a>01028             fputc(v, o);
<a name="l01029"></a>01029          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v &lt; 0x800) {
<a name="l01030"></a>01030             fputc(0xC0 + (v &gt;&gt; 6), o);
<a name="l01031"></a>01031             fputc(0x80 + (v &amp; 0x3F), o);
<a name="l01032"></a>01032          } <span class="keywordflow">else</span> {
<a name="l01033"></a>01033             fputc(0xE0 + (v &gt;&gt; 12), o);
<a name="l01034"></a>01034             fputc(0x80 + ((v &gt;&gt; 6) &amp; 0x3F), o);
<a name="l01035"></a>01035             fputc(0x80 + (v &amp; 0x3F), o);
<a name="l01036"></a>01036          }
<a name="l01037"></a>01037       }
<a name="l01038"></a>01038       fprintf(o, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01039"></a>01039       <span class="keywordflow">for</span> (p = 0; p &lt; h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> &amp;&amp; h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[p] &gt;= <span class="charliteral">&apos; &apos;</span>; p++);
<a name="l01040"></a>01040       <span class="keywordflow">if</span> (p &lt; h-&gt;udl) {
<a name="l01041"></a>01041          <span class="keywordflow">for</span> (p = 0; p &lt; h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a> &amp;&amp; h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[p] &lt; 0x100; p++);
<a name="l01042"></a>01042          <span class="keywordflow">if</span> (p == h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>) {              <span class="comment">/* can write in ucs-1 hex */</span>
<a name="l01043"></a>01043             fprintf(o, <span class="stringliteral">&quot;ud#&quot;</span>);
<a name="l01044"></a>01044             <span class="keywordflow">for</span> (p = 0; p &lt; h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>; p++) {
<a name="l01045"></a>01045                fprintf(o, <span class="stringliteral">&quot;%02X&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[p]);
<a name="l01046"></a>01046             }
<a name="l01047"></a>01047             fprintf(o, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01048"></a>01048          } <span class="keywordflow">else</span> {                        <span class="comment">/* write in UCS-2 */</span>
<a name="l01049"></a>01049             fprintf(o, <span class="stringliteral">&quot;ud##&quot;</span>);
<a name="l01050"></a>01050             <span class="keywordflow">for</span> (p = 0; p &lt; h-&gt;<a class="code" href="structsms__s.html#ab1209480aaab84c2ae9759e9c1d412aa">udl</a>; p++) {
<a name="l01051"></a>01051                fprintf(o, <span class="stringliteral">&quot;%04X&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#aff5fb37156142d0ad278675d2900d335">ud</a>[p]);
<a name="l01052"></a>01052             }
<a name="l01053"></a>01053             fprintf(o, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01054"></a>01054          }
<a name="l01055"></a>01055       }
<a name="l01056"></a>01056    }
<a name="l01057"></a>01057    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a>.tv_sec) {
<a name="l01058"></a>01058       <span class="keywordtype">char</span> datebuf[30];
<a name="l01059"></a>01059       fprintf(o, <span class="stringliteral">&quot;scts=%s\n&quot;</span>, <a class="code" href="app__sms_8c.html#aa82dbf6bb6292091b6f9ac19cc841428" title="static, return a date/time in ISO format">isodate</a>(h-&gt;<a class="code" href="structsms__s.html#a508fcb3b8587a645768074435743d2f2">scts</a>.tv_sec, datebuf, <span class="keyword">sizeof</span>(datebuf)));
<a name="l01060"></a>01060    }
<a name="l01061"></a>01061    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a2c7d9a176d66d466f3e8c54fd519460e">pid</a>) {
<a name="l01062"></a>01062       fprintf(o, <span class="stringliteral">&quot;pid=%d\n&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#a2c7d9a176d66d466f3e8c54fd519460e">pid</a>);
<a name="l01063"></a>01063    }
<a name="l01064"></a>01064    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a> != 0xF1) {
<a name="l01065"></a>01065       fprintf(o, <span class="stringliteral">&quot;dcs=%d\n&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#a1f0cc56d7098ac627c3a2ac4bd94b6d9">dcs</a>);
<a name="l01066"></a>01066    }
<a name="l01067"></a>01067    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a>) {
<a name="l01068"></a>01068       fprintf(o, <span class="stringliteral">&quot;vp=%d\n&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#aed8d77b45e82e228b7c993a844228e53">vp</a>);
<a name="l01069"></a>01069    }
<a name="l01070"></a>01070    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a0f7adeccf32fc4c52946d5d20b34c1cd">srr</a>) {
<a name="l01071"></a>01071       fprintf(o, <span class="stringliteral">&quot;srr=1\n&quot;</span>);
<a name="l01072"></a>01072    }
<a name="l01073"></a>01073    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#a423cb59610482ae25dcd3df51afdde25">mr</a> &gt;= 0) {
<a name="l01074"></a>01074       fprintf(o, <span class="stringliteral">&quot;mr=%d\n&quot;</span>, h-&gt;<a class="code" href="structsms__s.html#a423cb59610482ae25dcd3df51afdde25">mr</a>);
<a name="l01075"></a>01075    }
<a name="l01076"></a>01076    <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structsms__s.html#aa04ad9c90e68d8a6f92b612f798db482">rp</a>) {
<a name="l01077"></a>01077       fprintf(o, <span class="stringliteral">&quot;rp=1\n&quot;</span>);
<a name="l01078"></a>01078    }
<a name="l01079"></a>01079    fclose(o);
<a name="l01080"></a>01080    <span class="keywordflow">if</span> (rename(fn, fn2)) {
<a name="l01081"></a>01081       unlink(fn);
<a name="l01082"></a>01082    } <span class="keywordflow">else</span> {
<a name="l01083"></a>01083       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#af7c8529df13c84f0c9d1122f36a94a41">LOG_EVENT</a>, <span class="stringliteral">&quot;Received to %s\n&quot;</span>, fn2);
<a name="l01084"></a>01084    }
<a name="l01085"></a>01085 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad09fa931f468002152a3cc2d5ce25eae"></a><!-- doxytag: member="app_sms.c::unload_module" ref="ad09fa931f468002152a3cc2d5ce25eae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unload_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l02047">2047</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l06403">ast_unregister_application()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02048"></a>02048 {
<a name="l02049"></a>02049    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a>);
<a name="l02050"></a>02050 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad38c7ea91c75338009d7ef07df937ee9"></a><!-- doxytag: member="app_sms.c::unpackaddress" ref="ad38c7ea91c75338009d7ef07df937ee9" args="(char *o, unsigned char *i)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static unsigned char unpackaddress </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>o</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>i</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>unpack an address from i, return byte length, unpack to o </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00719">719</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01098">sms_handleincoming()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00720"></a>00720 {
<a name="l00721"></a>00721    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> l = i[0], p;
<a name="l00722"></a>00722    <span class="keywordflow">if</span> (i[1] == 0x91) {
<a name="l00723"></a>00723       *o++ = <span class="charliteral">&apos;+&apos;</span>;
<a name="l00724"></a>00724    }
<a name="l00725"></a>00725    <span class="keywordflow">for</span> (p = 0; p &lt; l; p++) {
<a name="l00726"></a>00726       <span class="keywordflow">if</span> (p &amp; 1) {
<a name="l00727"></a>00727          *o++ = (i[2 + p / 2] &gt;&gt; 4) + <span class="charliteral">&apos;0&apos;</span>;
<a name="l00728"></a>00728       } <span class="keywordflow">else</span> {
<a name="l00729"></a>00729          *o++ = (i[2 + p / 2] &amp; 0xF) + <span class="charliteral">&apos;0&apos;</span>;
<a name="l00730"></a>00730       }
<a name="l00731"></a>00731    }
<a name="l00732"></a>00732    *o = 0;
<a name="l00733"></a>00733    <span class="keywordflow">return</span> (l + 5) / 2;
<a name="l00734"></a>00734 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7c221ca909fed50cb51bd59b0855bc68"></a><!-- doxytag: member="app_sms.c::unpackdate" ref="a7c221ca909fed50cb51bd59b0855bc68" args="(unsigned char *i)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct timeval unpackdate </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>i</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>unpack a date and return </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00571">571</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="localtime_8c_source.html#l01920">ast_mktime()</a>, <a class="el" href="localtime_8h_source.html#l00030">ast_tm::tm_hour</a>, <a class="el" href="localtime_8h_source.html#l00036">ast_tm::tm_isdst</a>, <a class="el" href="localtime_8h_source.html#l00031">ast_tm::tm_mday</a>, <a class="el" href="localtime_8h_source.html#l00029">ast_tm::tm_min</a>, <a class="el" href="localtime_8h_source.html#l00032">ast_tm::tm_mon</a>, <a class="el" href="localtime_8h_source.html#l00028">ast_tm::tm_sec</a>, and <a class="el" href="localtime_8h_source.html#l00033">ast_tm::tm_year</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01098">sms_handleincoming()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00572"></a>00572 {
<a name="l00573"></a>00573    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> t;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575    t.tm_year = 100 + (i[0] &amp; 0xF) * 10 + (i[0] &gt;&gt; 4);
<a name="l00576"></a>00576    t.tm_mon = (i[1] &amp; 0xF) * 10 + (i[1] &gt;&gt; 4) - 1;
<a name="l00577"></a>00577    t.tm_mday = (i[2] &amp; 0xF) * 10 + (i[2] &gt;&gt; 4);
<a name="l00578"></a>00578    t.tm_hour = (i[3] &amp; 0xF) * 10 + (i[3] &gt;&gt; 4);
<a name="l00579"></a>00579    t.tm_min = (i[4] &amp; 0xF) * 10 + (i[4] &gt;&gt; 4);
<a name="l00580"></a>00580    t.tm_sec = (i[5] &amp; 0xF) * 10 + (i[5] &gt;&gt; 4);
<a name="l00581"></a>00581    t.tm_isdst = 0;
<a name="l00582"></a>00582    <span class="keywordflow">if</span> (i[6] &amp; 0x08) {
<a name="l00583"></a>00583       t.tm_min += 15 * ((i[6] &amp; 0x7) * 10 + (i[6] &gt;&gt; 4));
<a name="l00584"></a>00584    } <span class="keywordflow">else</span> {
<a name="l00585"></a>00585       t.tm_min -= 15 * ((i[6] &amp; 0x7) * 10 + (i[6] &gt;&gt; 4));
<a name="l00586"></a>00586    }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588    <span class="keywordflow">return</span> <a class="code" href="localtime_8h.html#ae0843e4dbbd1fed36d2676dda58e0c44" title="Timezone-independent version of mktime(3).">ast_mktime</a>(&amp;t, NULL);
<a name="l00589"></a>00589 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0ec2365c36d7af29acf3bdaad02b082a"></a><!-- doxytag: member="app_sms.c::unpacksms" ref="a0ec2365c36d7af29acf3bdaad02b082a" args="(unsigned char dcs, unsigned char *i, unsigned char *udh, int *udhl, unsigned short *ud, int *udl, char udhi)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unpacksms </td>
          <td>(</td>
          <td class="paramtype">unsigned char&nbsp;</td>
          <td class="paramname"> <em>dcs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>udh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>udhl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned short *&nbsp;</td>
          <td class="paramname"> <em>ud</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>udl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>udhi</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>general unpack - starts with length byte (octet or septet) and returns <a class="el" href="structnumber.html" title="Number structure.">number</a> of bytes used, inc length </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00704">704</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>References <a class="el" href="app__sms_8c_source.html#l00273">is7bit</a>, <a class="el" href="app__sms_8c_source.html#l00274">is8bit</a>, <a class="el" href="app__sms_8c_source.html#l00676">unpacksms16()</a>, <a class="el" href="app__sms_8c_source.html#l00594">unpacksms7()</a>, and <a class="el" href="app__sms_8c_source.html#l00650">unpacksms8()</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l01098">sms_handleincoming()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00705"></a>00705 {
<a name="l00706"></a>00706    <span class="keywordtype">int</span> l = *i++;
<a name="l00707"></a>00707    <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#a39743cbea53fca38237f049acd4cb834">is7bit</a>(dcs)) {
<a name="l00708"></a>00708       <a class="code" href="app__sms_8c.html#aa65901d23702596493c076cac99112f0" title="unpacks bytes (7 bit encoding) at i, len l septets, and places in udh and ud setting...">unpacksms7</a>(i, l, udh, udhl, ud, udl, udhi);
<a name="l00709"></a>00709       l = (l * 7 + 7) / 8;                <span class="comment">/* adjust length to return */</span>
<a name="l00710"></a>00710    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="app__sms_8c.html#a5f533f0d22e8b3eac586398fbae67636">is8bit</a>(dcs)) {
<a name="l00711"></a>00711       <a class="code" href="app__sms_8c.html#a6b1ce90cce234e2c4dc75da9046c21b5" title="unpacks bytes (8 bit encoding) at i, len l septets, and places in udh and ud setting...">unpacksms8</a>(i, l, udh, udhl, ud, udl, udhi);
<a name="l00712"></a>00712    } <span class="keywordflow">else</span> {
<a name="l00713"></a>00713       <a class="code" href="app__sms_8c.html#ab53eb989ad561eab70f9002277d99703" title="unpacks bytes (16 bit encoding) at i, len l septets, and places in udh and ud setting...">unpacksms16</a>(i, l, udh, udhl, ud, udl, udhi);
<a name="l00714"></a>00714    }
<a name="l00715"></a>00715    <span class="keywordflow">return</span> l + 1;
<a name="l00716"></a>00716 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab53eb989ad561eab70f9002277d99703"></a><!-- doxytag: member="app_sms.c::unpacksms16" ref="ab53eb989ad561eab70f9002277d99703" args="(unsigned char *i, unsigned char l, unsigned char *udh, int *udhl, unsigned short *ud, int *udl, char udhi)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void unpacksms16 </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char&nbsp;</td>
          <td class="paramname"> <em>l</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>udh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>udhl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned short *&nbsp;</td>
          <td class="paramname"> <em>ud</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>udl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>udhi</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>unpacks bytes (16 bit encoding) at i, len l septets, and places in udh and ud setting udhl and udl. udh not used if udhi not set </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00676">676</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00704">unpacksms()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00677"></a>00677 {
<a name="l00678"></a>00678    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *o = ud;
<a name="l00679"></a>00679    *udhl = 0;
<a name="l00680"></a>00680    <span class="keywordflow">if</span> (udhi) {
<a name="l00681"></a>00681       <span class="keywordtype">int</span> n = *i;
<a name="l00682"></a>00682       *udhl = n;
<a name="l00683"></a>00683       <span class="keywordflow">if</span> (n) {
<a name="l00684"></a>00684          i++;
<a name="l00685"></a>00685          l--;
<a name="l00686"></a>00686          <span class="keywordflow">while</span> (l &amp;&amp; n) {
<a name="l00687"></a>00687             l--;
<a name="l00688"></a>00688             n--;
<a name="l00689"></a>00689             *udh++ = *i++;
<a name="l00690"></a>00690          }
<a name="l00691"></a>00691       }
<a name="l00692"></a>00692    }
<a name="l00693"></a>00693    <span class="keywordflow">while</span> (l--) {
<a name="l00694"></a>00694       <span class="keywordtype">int</span> v = *i++;
<a name="l00695"></a>00695       <span class="keywordflow">if</span> (l--) {
<a name="l00696"></a>00696          v = (v &lt;&lt; 8) + *i++;
<a name="l00697"></a>00697       }
<a name="l00698"></a>00698       *o++ = v;
<a name="l00699"></a>00699    }
<a name="l00700"></a>00700    *udl = (o - ud);
<a name="l00701"></a>00701 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa65901d23702596493c076cac99112f0"></a><!-- doxytag: member="app_sms.c::unpacksms7" ref="aa65901d23702596493c076cac99112f0" args="(unsigned char *i, unsigned char l, unsigned char *udh, int *udhl, unsigned short *ud, int *udl, char udhi)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void unpacksms7 </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char&nbsp;</td>
          <td class="paramname"> <em>l</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>udh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>udhl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned short *&nbsp;</td>
          <td class="paramname"> <em>ud</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>udl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>udhi</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>unpacks bytes (7 bit encoding) at i, len l septets, and places in udh and ud setting udhl and udl. udh not used if udhi not set </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00594">594</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00704">unpacksms()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00595"></a>00595 {
<a name="l00596"></a>00596    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> b = 0, p = 0;
<a name="l00597"></a>00597    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *o = ud;
<a name="l00598"></a>00598    *udhl = 0;
<a name="l00599"></a>00599    <span class="keywordflow">if</span> (udhi &amp;&amp; l) {                        <span class="comment">/* header */</span>
<a name="l00600"></a>00600       <span class="keywordtype">int</span> h = i[p];
<a name="l00601"></a>00601       *udhl = h;
<a name="l00602"></a>00602       <span class="keywordflow">if</span> (h) {
<a name="l00603"></a>00603          b = 1;
<a name="l00604"></a>00604          p++;
<a name="l00605"></a>00605          l--;
<a name="l00606"></a>00606          <span class="keywordflow">while</span> (h-- &amp;&amp; l) {
<a name="l00607"></a>00607             *udh++ = i[p++];
<a name="l00608"></a>00608             b += 8;
<a name="l00609"></a>00609             <span class="keywordflow">while</span> (b &gt;= 7) {
<a name="l00610"></a>00610                b -= 7;
<a name="l00611"></a>00611                l--;
<a name="l00612"></a>00612                <span class="keywordflow">if</span> (!l) {
<a name="l00613"></a>00613                   <span class="keywordflow">break</span>;
<a name="l00614"></a>00614                }
<a name="l00615"></a>00615             }
<a name="l00616"></a>00616          }
<a name="l00617"></a>00617          <span class="comment">/* adjust for fill, septets */</span>
<a name="l00618"></a>00618          <span class="keywordflow">if</span> (b) {
<a name="l00619"></a>00619             b = 7 - b;
<a name="l00620"></a>00620             l--;
<a name="l00621"></a>00621          }
<a name="l00622"></a>00622       }
<a name="l00623"></a>00623    }
<a name="l00624"></a>00624    <span class="keywordflow">while</span> (l--) {
<a name="l00625"></a>00625       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> v;
<a name="l00626"></a>00626       <span class="keywordflow">if</span> (b &lt; 2) {
<a name="l00627"></a>00627          v = ((i[p] &gt;&gt; b) &amp; 0x7F);       <span class="comment">/* everything in one byte */</span>
<a name="l00628"></a>00628       } <span class="keywordflow">else</span> {
<a name="l00629"></a>00629          v = ((((i[p] &gt;&gt; b) + (i[p + 1] &lt;&lt; (8 - b)))) &amp; 0x7F);
<a name="l00630"></a>00630       }
<a name="l00631"></a>00631       b += 7;
<a name="l00632"></a>00632       <span class="keywordflow">if</span> (b &gt;= 8) {
<a name="l00633"></a>00633          b -= 8;
<a name="l00634"></a>00634          p++;
<a name="l00635"></a>00635       }
<a name="l00636"></a>00636       <span class="comment">/* 0x00A0 is the encoding of ESC (27) in defaultalphabet */</span>
<a name="l00637"></a>00637       <span class="keywordflow">if</span> (o &gt; ud &amp;&amp; o[-1] == 0x00A0 &amp;&amp; <a class="code" href="app__sms_8c.html#a70ca3c30c6f517d2f8ebd04edae4d892">escapes</a>[v]) {
<a name="l00638"></a>00638          o[-1] = <a class="code" href="app__sms_8c.html#a70ca3c30c6f517d2f8ebd04edae4d892">escapes</a>[v];
<a name="l00639"></a>00639       } <span class="keywordflow">else</span> {
<a name="l00640"></a>00640          *o++ = <a class="code" href="app__sms_8c.html#a34ddced579016642f988389bc44752c0">defaultalphabet</a>[v];
<a name="l00641"></a>00641       }
<a name="l00642"></a>00642    }
<a name="l00643"></a>00643    *udl = (o - ud);
<a name="l00644"></a>00644 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6b1ce90cce234e2c4dc75da9046c21b5"></a><!-- doxytag: member="app_sms.c::unpacksms8" ref="a6b1ce90cce234e2c4dc75da9046c21b5" args="(unsigned char *i, unsigned char l, unsigned char *udh, int *udhl, unsigned short *ud, int *udl, char udhi)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void unpacksms8 </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char&nbsp;</td>
          <td class="paramname"> <em>l</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>udh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>udhl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned short *&nbsp;</td>
          <td class="paramname"> <em>ud</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>udl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>udhi</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>unpacks bytes (8 bit encoding) at i, len l septets, and places in udh and ud setting udhl and udl. udh not used if udhi not set. </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00650">650</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00704">unpacksms()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00651"></a>00651 {
<a name="l00652"></a>00652    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *o = ud;
<a name="l00653"></a>00653    *udhl = 0;
<a name="l00654"></a>00654    <span class="keywordflow">if</span> (udhi) {
<a name="l00655"></a>00655       <span class="keywordtype">int</span> n = *i;
<a name="l00656"></a>00656       *udhl = n;
<a name="l00657"></a>00657       <span class="keywordflow">if</span> (n) {
<a name="l00658"></a>00658          i++;
<a name="l00659"></a>00659          l--;
<a name="l00660"></a>00660          <span class="keywordflow">while</span> (l &amp;&amp; n) {
<a name="l00661"></a>00661             l--;
<a name="l00662"></a>00662             n--;
<a name="l00663"></a>00663             *udh++ = *i++;
<a name="l00664"></a>00664          }
<a name="l00665"></a>00665       }
<a name="l00666"></a>00666    }
<a name="l00667"></a>00667    <span class="keywordflow">while</span> (l--) {
<a name="l00668"></a>00668       *o++ = *i++;                        <span class="comment">/* not to UTF-8 as explicitly 8 bit coding in DCS */</span>
<a name="l00669"></a>00669    }
<a name="l00670"></a>00670    *udl = (o - ud);
<a name="l00671"></a>00671 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a375cda00ad33985349625ad6f8ae70ef"></a><!-- doxytag: member="app_sms.c::utf8decode" ref="a375cda00ad33985349625ad6f8ae70ef" args="(unsigned char **pp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static long utf8decode </td>
          <td>(</td>
          <td class="paramtype">unsigned char **&nbsp;</td>
          <td class="paramname"> <em>pp</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reads next UCS character from NUL terminated UTF-8 string and advance pointer. </p>

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00307">307</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__sms_8c_source.html#l00813">sms_readfile()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00308"></a>00308 {
<a name="l00309"></a>00309    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p = *<a class="code" href="chan__usbradio_8c.html#a76ef0d203c3e50e32968f67eb382677d">pp</a>;
<a name="l00310"></a>00310    <span class="keywordflow">if</span> (!*p) {
<a name="l00311"></a>00311       <span class="keywordflow">return</span> 0;                           <span class="comment">/* null termination of string */</span>
<a name="l00312"></a>00312    }
<a name="l00313"></a>00313    (*pp)++;
<a name="l00314"></a>00314    <span class="keywordflow">if</span> (*p &lt; 0xC0) {
<a name="l00315"></a>00315       <span class="keywordflow">return</span> *p;                          <span class="comment">/* ascii or continuation character */</span>
<a name="l00316"></a>00316    }
<a name="l00317"></a>00317    <span class="keywordflow">if</span> (*p &lt; 0xE0) {
<a name="l00318"></a>00318       <span class="keywordflow">if</span> (*p &lt; 0xC2 || (p[1] &amp; 0xC0) != 0x80) {
<a name="l00319"></a>00319          <span class="keywordflow">return</span> *p;                      <span class="comment">/* not valid UTF-8 */</span>
<a name="l00320"></a>00320       }
<a name="l00321"></a>00321       (*pp)++;
<a name="l00322"></a>00322       <span class="keywordflow">return</span> ((*p &amp; 0x1F) &lt;&lt; 6) + (p[1] &amp; 0x3F);
<a name="l00323"></a>00323       }
<a name="l00324"></a>00324    <span class="keywordflow">if</span> (*p &lt; 0xF0) {
<a name="l00325"></a>00325       <span class="keywordflow">if</span> ((*p == 0xE0 &amp;&amp; p[1] &lt; 0xA0) || (p[1] &amp; 0xC0) != 0x80 || (p[2] &amp; 0xC0) != 0x80) {
<a name="l00326"></a>00326          <span class="keywordflow">return</span> *p;                      <span class="comment">/* not valid UTF-8 */</span>
<a name="l00327"></a>00327       }
<a name="l00328"></a>00328       (*pp) += 2;
<a name="l00329"></a>00329       <span class="keywordflow">return</span> ((*p &amp; 0x0F) &lt;&lt; 12) + ((p[1] &amp; 0x3F) &lt;&lt; 6) + (p[2] &amp; 0x3F);
<a name="l00330"></a>00330    }
<a name="l00331"></a>00331    <span class="keywordflow">if</span> (*p &lt; 0xF8) {
<a name="l00332"></a>00332       <span class="keywordflow">if</span> ((*p == 0xF0 &amp;&amp; p[1] &lt; 0x90) || (p[1] &amp; 0xC0) != 0x80 || (p[2] &amp; 0xC0) != 0x80 || (p[3] &amp; 0xC0) != 0x80) {
<a name="l00333"></a>00333          <span class="keywordflow">return</span> *p;                      <span class="comment">/* not valid UTF-8 */</span>
<a name="l00334"></a>00334       }
<a name="l00335"></a>00335       (*pp) += 3;
<a name="l00336"></a>00336       <span class="keywordflow">return</span> ((*p &amp; 0x07) &lt;&lt; 18) + ((p[1] &amp; 0x3F) &lt;&lt; 12) + ((p[2] &amp; 0x3F) &lt;&lt; 6) + (p[3] &amp; 0x3F);
<a name="l00337"></a>00337    }
<a name="l00338"></a>00338    <span class="keywordflow">if</span> (*p &lt; 0xFC) {
<a name="l00339"></a>00339       <span class="keywordflow">if</span> ((*p == 0xF8 &amp;&amp; p[1] &lt; 0x88) || (p[1] &amp; 0xC0) != 0x80 || (p[2] &amp; 0xC0) != 0x80 || (p[3] &amp; 0xC0) != 0x80
<a name="l00340"></a>00340          || (p[4] &amp; 0xC0) != 0x80) {
<a name="l00341"></a>00341          <span class="keywordflow">return</span> *p;                      <span class="comment">/* not valid UTF-8 */</span>
<a name="l00342"></a>00342       }
<a name="l00343"></a>00343       (*pp) += 4;
<a name="l00344"></a>00344       <span class="keywordflow">return</span> ((*p &amp; 0x03) &lt;&lt; 24) + ((p[1] &amp; 0x3F) &lt;&lt; 18) + ((p[2] &amp; 0x3F) &lt;&lt; 12) + ((p[3] &amp; 0x3F) &lt;&lt; 6) + (p[4] &amp; 0x3F);
<a name="l00345"></a>00345    }
<a name="l00346"></a>00346    <span class="keywordflow">if</span> (*p &lt; 0xFE) {
<a name="l00347"></a>00347       <span class="keywordflow">if</span> ((*p == 0xFC &amp;&amp; p[1] &lt; 0x84) || (p[1] &amp; 0xC0) != 0x80 || (p[2] &amp; 0xC0) != 0x80 || (p[3] &amp; 0xC0) != 0x80
<a name="l00348"></a>00348          || (p[4] &amp; 0xC0) != 0x80 || (p[5] &amp; 0xC0) != 0x80) {
<a name="l00349"></a>00349          <span class="keywordflow">return</span> *p;                      <span class="comment">/* not valid UTF-8 */</span>
<a name="l00350"></a>00350       }
<a name="l00351"></a>00351       (*pp) += 5;
<a name="l00352"></a>00352       <span class="keywordflow">return</span> ((*p &amp; 0x01) &lt;&lt; 30) + ((p[1] &amp; 0x3F) &lt;&lt; 24) + ((p[2] &amp; 0x3F) &lt;&lt; 18) + ((p[3] &amp; 0x3F) &lt;&lt; 12) + ((p[4] &amp; 0x3F) &lt;&lt; 6) + (p[5] &amp; 0x3F);
<a name="l00353"></a>00353    }
<a name="l00354"></a>00354    <span class="keywordflow">return</span> *p;                              <span class="comment">/* not sensible */</span>
<a name="l00355"></a>00355 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a9e5f57131367eff409b9e0bd7b31aa1a"></a><!-- doxytag: member="app_sms.c::app" ref="a9e5f57131367eff409b9e0bd7b31aa1a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="res__agi_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a> = &quot;SMS&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00118">118</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

</div>
</div>
<a class="anchor" id="a34ddced579016642f988389bc44752c0"></a><!-- doxytag: member="app_sms.c::defaultalphabet" ref="a34ddced579016642f988389bc44752c0" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const unsigned short <a class="el" href="app__sms_8c.html#a34ddced579016642f988389bc44752c0">defaultalphabet</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00185">185</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

</div>
</div>
<a class="anchor" id="a70ca3c30c6f517d2f8ebd04edae4d892"></a><!-- doxytag: member="app_sms.c::escapes" ref="a70ca3c30c6f517d2f8ebd04edae4d892" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const unsigned short <a class="el" href="app__sms_8c.html#a70ca3c30c6f517d2f8ebd04edae4d892">escapes</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00198">198</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

</div>
</div>
<a class="anchor" id="ad0345d4821606480fcb0e28327340660"></a><!-- doxytag: member="app_sms.c::log_file" ref="ad0345d4821606480fcb0e28327340660" args="[255]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="app__sms_8c.html#ad0345d4821606480fcb0e28327340660">log_file</a>[255]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00116">116</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

</div>
</div>
<a class="anchor" id="a0e5e2d705fb17b7f583cd711a5d47467"></a><!-- doxytag: member="app_sms.c::message_ref" ref="a0e5e2d705fb17b7f583cd711a5d47467" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile unsigned char <a class="el" href="app__sms_8c.html#a0e5e2d705fb17b7f583cd711a5d47467">message_ref</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00113">113</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

</div>
</div>
<a class="anchor" id="a8514112da88a5d13451aaf8c9b064017"></a><!-- doxytag: member="app_sms.c::seq" ref="a8514112da88a5d13451aaf8c9b064017" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile unsigned int <a class="el" href="res__monitor_8c.html#a189930c4babdc38135a74db479534069">seq</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00114">114</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="udptl_8c_source.html#l01060">ast_udptl_write()</a>, <a class="el" href="app__rpt_8c_source.html#l06676">handle_link_data()</a>, <a class="el" href="app__rpt_8c_source.html#l10234">handle_remote_data()</a>, <a class="el" href="chan__unistim_8c_source.html#l03464">parsing()</a>, <a class="el" href="rtp_8c_source.html#l00923">process_cisco_dtmf()</a>, <a class="el" href="chan__unistim_8c_source.html#l01157">send_retransmit()</a>, <a class="el" href="app__rpt_8c_source.html#l01949">statpost()</a>, and <a class="el" href="udptl_8c_source.html#l00526">udptl_build_packet()</a>.</p>

</div>
</div>
<a class="anchor" id="a8caa98f3ff84c7125419ed99ac08631f"></a><!-- doxytag: member="app_sms.c::sms_flags" ref="a8caa98f3ff84c7125419ed99ac08631f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum { ... }   <a class="el" href="app__sms_8c.html#a8caa98f3ff84c7125419ed99ac08631f">sms_flags</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a0177ab258c23182996ff959baca1df16"></a><!-- doxytag: member="app_sms.c::sms_opt_args" ref="a0177ab258c23182996ff959baca1df16" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum { ... }   <a class="el" href="app__sms_8c.html#a0177ab258c23182996ff959baca1df16">sms_opt_args</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a1905c14fd0a53bc591a77d9bb4d029ca"></a><!-- doxytag: member="app_sms.c::smsgen" ref="a1905c14fd0a53bc591a77d9bb4d029ca" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__generator.html">ast_generator</a> <a class="el" href="app__sms_8c.html#a1905c14fd0a53bc591a77d9bb4d029ca">smsgen</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
   .alloc = <a class="code" href="app__sms_8c.html#a44ab7b172d33e28647b2383346814b9f">sms_alloc</a>,
   .release = <a class="code" href="app__sms_8c.html#ab0fd8690c8108023eafe2da490478f56">sms_release</a>,
   .generate = <a class="code" href="app__sms_8c.html#afda4211248e1b0e0083be7bd80a7d4b0">sms_generate</a>,
}
</pre></div>
<p>Definition at line <a class="el" href="app__sms_8c_source.html#l01677">1677</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

</div>
</div>
<a class="anchor" id="abac9a140958529feb213ec48e0deaca7"></a><!-- doxytag: member="app_sms.c::wave" ref="abac9a140958529feb213ec48e0deaca7" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">signed short <a class="el" href="app__sms_8c.html#abac9a140958529feb213ec48e0deaca7">wave</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00126">126</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

<p>Referenced by <a class="el" href="app__festival_8c_source.html#l00268">festival_exec()</a>.</p>

</div>
</div>
<a class="anchor" id="a1c6c81d0dd59e7e04ac232639a5db460"></a><!-- doxytag: member="app_sms.c::wave_out" ref="a1c6c81d0dd59e7e04ac232639a5db460" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="app__sms_8c.html#a4008af70ba477f60e932df6815dac38d">output_t</a>* <a class="el" href="app__sms_8c.html#a1c6c81d0dd59e7e04ac232639a5db460">wave_out</a> = <a class="el" href="app__sms_8c.html#abac9a140958529feb213ec48e0deaca7">wave</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__sms_8c_source.html#l00142">142</a> of file <a class="el" href="app__sms_8c_source.html">app_sms.c</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:19:21 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
