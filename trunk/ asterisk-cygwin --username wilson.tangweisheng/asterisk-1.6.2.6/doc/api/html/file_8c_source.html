<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:40 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>file.c</h1><a href="file_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Generic File Format Support.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt; </span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 238632 $&quot;</span>)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="__private_8h.html" title="Prototypes for public functions only of internal interest,.">asterisk/_private.h</a>&quot;</span>   <span class="comment">/* declare ast_file_init() */</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="paths_8h.html" title="Asterisk file paths, configured in asterisk.conf.">asterisk/paths.h</a>&quot;</span>   <span class="comment">/* use ast_config_AST_DATA_DIR */</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="mod__format_8h.html" title="Header for providers of file and format handling routines. Clients of these routines...">asterisk/mod_format.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="sched_8h.html" title="Scheduler Routines (derived from cheops).">asterisk/sched.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="translate_8h.html" title="Support for translation of data formats. translate.c.">asterisk/translate.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="linkedlists_8h.html" title="A set of macros to manage forward-linked lists.">asterisk/linkedlists.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="astobj2_8h.html">asterisk/astobj2.h</a>&quot;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="comment">/*</span>
<a name="l00050"></a>00050 <span class="comment"> * The following variable controls the layout of localized sound files.</span>
<a name="l00051"></a>00051 <span class="comment"> * If 0, use the historical layout with prefix just before the filename</span>
<a name="l00052"></a>00052 <span class="comment"> * (i.e. digits/en/1.gsm , digits/it/1.gsm or default to digits/1.gsm),</span>
<a name="l00053"></a>00053 <span class="comment"> * if 1 put the prefix at the beginning of the filename</span>
<a name="l00054"></a>00054 <span class="comment"> * (i.e. en/digits/1.gsm, it/digits/1.gsm or default to digits/1.gsm).</span>
<a name="l00055"></a>00055 <span class="comment"> * The latter permits a language to be entirely in one directory.</span>
<a name="l00056"></a>00056 <span class="comment"> */</span>
<a name="l00057"></a><a class="code" href="file_8c.html#a248e5c086666b04d29a9cd876ad370b3">00057</a> <span class="keywordtype">int</span> <a class="code" href="options_8h.html#a248e5c086666b04d29a9cd876ad370b3">ast_language_is_prefix</a> = 1;
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="structformats.html#ace4e0066a5b24f84b90536e9906619f6">00059</a> <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structformats.html">formats</a>, <a class="code" href="structast__format.html" title="Each supported file format is described by the following structure.">ast_format</a>);
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="file_8c.html#a6359e64eb164c3db4696f159f9503185">00061</a> <span class="keywordtype">int</span> <a class="code" href="mod__format_8h.html#a6359e64eb164c3db4696f159f9503185" title="Register a new file format capability. Adds a format to Asterisk&amp;#39;s format abilities...">__ast_format_register</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__format.html" title="Each supported file format is described by the following structure.">ast_format</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>, <span class="keyword">struct</span> <a class="code" href="structast__module.html">ast_module</a> *mod)
<a name="l00062"></a>00062 {
<a name="l00063"></a>00063    <span class="keyword">struct </span><a class="code" href="structast__format.html" title="Each supported file format is described by the following structure.">ast_format</a> *tmp;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l00066"></a>00066    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structformats.html">formats</a>, tmp, <a class="code" href="structast__format.html#ad0c8f8a1ef89f35f7f1fcce75787632f">list</a>) {
<a name="l00067"></a>00067       <span class="keywordflow">if</span> (!strcasecmp(f-&gt;<a class="code" href="structast__format.html#a3777dbae63a15da001b2baa317a25149">name</a>, tmp-&gt;<a class="code" href="structast__format.html#a3777dbae63a15da001b2baa317a25149">name</a>)) {
<a name="l00068"></a>00068          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l00069"></a>00069          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Tried to register &apos;%s&apos; format, already registered\n&quot;</span>, f-&gt;<a class="code" href="structast__format.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00070"></a>00070          <span class="keywordflow">return</span> -1;
<a name="l00071"></a>00071       }
<a name="l00072"></a>00072    }
<a name="l00073"></a>00073    <span class="keywordflow">if</span> (!(tmp = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tmp)))) {
<a name="l00074"></a>00074       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l00075"></a>00075       <span class="keywordflow">return</span> -1;
<a name="l00076"></a>00076    }
<a name="l00077"></a>00077    *tmp = *f;
<a name="l00078"></a>00078    tmp-&gt;<a class="code" href="structast__format.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">module</a> = mod;
<a name="l00079"></a>00079    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__format.html#a4c813abab25e4df4e95d8f0b0ca61500">buf_size</a>) {
<a name="l00080"></a>00080       <span class="comment">/*</span>
<a name="l00081"></a>00081 <span class="comment">       * Align buf_size properly, rounding up to the machine-specific</span>
<a name="l00082"></a>00082 <span class="comment">       * alignment for pointers.</span>
<a name="l00083"></a>00083 <span class="comment">       */</span>
<a name="l00084"></a>00084       <span class="keyword">struct </span>_test_align { <span class="keywordtype">void</span> *a, *b; } p;
<a name="l00085"></a>00085       <span class="keywordtype">int</span> align = (<span class="keywordtype">char</span> *)&amp;p.b - (<span class="keywordtype">char</span> *)&amp;p.a;
<a name="l00086"></a>00086       tmp-&gt;<a class="code" href="structast__format.html#a4c813abab25e4df4e95d8f0b0ca61500">buf_size</a> = ((f-&gt;<a class="code" href="structast__format.html#a4c813abab25e4df4e95d8f0b0ca61500">buf_size</a> + align - 1) / align) * align;
<a name="l00087"></a>00087    }
<a name="l00088"></a>00088    
<a name="l00089"></a>00089    memset(&amp;tmp-&gt;<a class="code" href="structast__format.html#ad0c8f8a1ef89f35f7f1fcce75787632f">list</a>, 0, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structast__format.html#ad0c8f8a1ef89f35f7f1fcce75787632f">list</a>));
<a name="l00090"></a>00090 
<a name="l00091"></a>00091    <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;<a class="code" href="structformats.html">formats</a>, tmp, list);
<a name="l00092"></a>00092    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l00093"></a>00093    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Registered file format %s, extension(s) %s\n&quot;</span>, f-&gt;<a class="code" href="structast__format.html#a3777dbae63a15da001b2baa317a25149">name</a>, f-&gt;<a class="code" href="structast__format.html#ade71f534a49925f1955a1598556219e2">exts</a>);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095    <span class="keywordflow">return</span> 0;
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="file_8c.html#a356574c4ec4b2e89b8128b86b086af4e">00098</a> <span class="keywordtype">int</span> <a class="code" href="mod__format_8h.html#a356574c4ec4b2e89b8128b86b086af4e" title="Unregisters a file format.">ast_format_unregister</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100    <span class="keyword">struct </span><a class="code" href="structast__format.html" title="Each supported file format is described by the following structure.">ast_format</a> *tmp;
<a name="l00101"></a>00101    <span class="keywordtype">int</span> res = -1;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l00104"></a>00104    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structformats.html">formats</a>, tmp, <a class="code" href="structast__format.html#ad0c8f8a1ef89f35f7f1fcce75787632f">list</a>) {
<a name="l00105"></a>00105       <span class="keywordflow">if</span> (!strcasecmp(name, tmp-&gt;<a class="code" href="structast__format.html#a3777dbae63a15da001b2baa317a25149">name</a>)) {
<a name="l00106"></a>00106          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(<a class="code" href="structast__format.html#ad0c8f8a1ef89f35f7f1fcce75787632f">list</a>);
<a name="l00107"></a>00107          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l00108"></a>00108          res = 0;
<a name="l00109"></a>00109       }
<a name="l00110"></a>00110    }
<a name="l00111"></a>00111    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l00112"></a>00112    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l00113"></a>00113 
<a name="l00114"></a>00114    <span class="keywordflow">if</span> (!res)
<a name="l00115"></a>00115       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Unregistered format %s\n&quot;</span>, name);
<a name="l00116"></a>00116    <span class="keywordflow">else</span>
<a name="l00117"></a>00117       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Tried to unregister format %s, already unregistered\n&quot;</span>, name);
<a name="l00118"></a>00118 
<a name="l00119"></a>00119    <span class="keywordflow">return</span> res;
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a><a class="code" href="file_8c.html#a2f0d358c02e7a6cbe06d4b67237aca3d">00122</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *tmp)
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(tmp);
<a name="l00125"></a>00125 
<a name="l00126"></a>00126    <span class="comment">/* Stop a running stream if there is one */</span>
<a name="l00127"></a>00127    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>) {
<a name="l00128"></a>00128       <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(tmp-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>);
<a name="l00129"></a>00129       tmp-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> = NULL;
<a name="l00130"></a>00130       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__channel.html#a8668180049a7ed4e28b17842144e6d05">oldwriteformat</a> &amp;&amp; <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(tmp, tmp-&gt;<a class="code" href="structast__channel.html#a8668180049a7ed4e28b17842144e6d05">oldwriteformat</a>))
<a name="l00131"></a>00131          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to restore format back to %d\n&quot;</span>, tmp-&gt;<a class="code" href="structast__channel.html#a8668180049a7ed4e28b17842144e6d05">oldwriteformat</a>);
<a name="l00132"></a>00132    }
<a name="l00133"></a>00133    <span class="comment">/* Stop the video stream too */</span>
<a name="l00134"></a>00134    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__channel.html#ad224fea293daa62d4fba90f86c3503ee">vstream</a> != NULL) {
<a name="l00135"></a>00135       <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(tmp-&gt;<a class="code" href="structast__channel.html#ad224fea293daa62d4fba90f86c3503ee">vstream</a>);
<a name="l00136"></a>00136       tmp-&gt;<a class="code" href="structast__channel.html#ad224fea293daa62d4fba90f86c3503ee">vstream</a> = NULL;
<a name="l00137"></a>00137    }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(tmp);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141    <span class="keywordflow">return</span> 0;
<a name="l00142"></a>00142 }
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="file_8c.html#a3608386b919ef0949d2858cdeb02d12e">00144</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#a3608386b919ef0949d2858cdeb02d12e" title="Writes a frame to a stream.">ast_writestream</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146    <span class="keywordtype">int</span> res = -1;
<a name="l00147"></a>00147    <span class="keywordtype">int</span> alt = 0;
<a name="l00148"></a>00148    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) {
<a name="l00149"></a>00149       <span class="keywordflow">if</span> (fs-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a> &amp; <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a>) {
<a name="l00150"></a>00150          <span class="comment">/* This is the audio portion.  Call the video one... */</span>
<a name="l00151"></a>00151          <span class="keywordflow">if</span> (!fs-&gt;<a class="code" href="structast__filestream.html#a084d8f087c50442f51245ec3333abac4">vfs</a> &amp;&amp; fs-&gt;<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>) {
<a name="l00152"></a>00152             <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a> = <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; ~0x1);
<a name="l00153"></a>00153             fs-&gt;<a class="code" href="structast__filestream.html#a084d8f087c50442f51245ec3333abac4">vfs</a> = <a class="code" href="file_8h.html#a964f8ef393c07609d7b9e02937faed52" title="Starts writing a file.">ast_writefile</a>(fs-&gt;<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, type, NULL, fs-&gt;<a class="code" href="structast__filestream.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>, 0, fs-&gt;<a class="code" href="structast__filestream.html#adc8d3cf511ceb277aea0cfa1cd027c59">mode</a>);
<a name="l00154"></a>00154             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Opened video output file\n&quot;</span>);
<a name="l00155"></a>00155          }
<a name="l00156"></a>00156          <span class="keywordflow">if</span> (fs-&gt;<a class="code" href="structast__filestream.html#a084d8f087c50442f51245ec3333abac4">vfs</a>)
<a name="l00157"></a>00157             <span class="keywordflow">return</span> <a class="code" href="file_8h.html#a3608386b919ef0949d2858cdeb02d12e" title="Writes a frame to a stream.">ast_writestream</a>(fs-&gt;<a class="code" href="structast__filestream.html#a084d8f087c50442f51245ec3333abac4">vfs</a>, f);
<a name="l00158"></a>00158          <span class="comment">/* else ignore */</span>
<a name="l00159"></a>00159          <span class="keywordflow">return</span> 0;            
<a name="l00160"></a>00160       } <span class="keywordflow">else</span> {
<a name="l00161"></a>00161          <span class="comment">/* Might / might not have mark set */</span>
<a name="l00162"></a>00162          alt = 1;
<a name="l00163"></a>00163       }
<a name="l00164"></a>00164    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {
<a name="l00165"></a>00165       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Tried to write non-voice frame\n&quot;</span>);
<a name="l00166"></a>00166       <span class="keywordflow">return</span> -1;
<a name="l00167"></a>00167    }
<a name="l00168"></a>00168    <span class="keywordflow">if</span> (((fs-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a> | alt) &amp; f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) == f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) {
<a name="l00169"></a>00169       res =  fs-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#add47f1ec31efb08853aacc02c294bfb5">write</a>(fs, f);
<a name="l00170"></a>00170       <span class="keywordflow">if</span> (res &lt; 0) 
<a name="l00171"></a>00171          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Natural write failed\n&quot;</span>);
<a name="l00172"></a>00172       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &gt; 0)
<a name="l00173"></a>00173          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Huh??\n&quot;</span>);
<a name="l00174"></a>00174    } <span class="keywordflow">else</span> {
<a name="l00175"></a>00175       <span class="comment">/* XXX If they try to send us a type of frame that isn&apos;t the normal frame, and isn&apos;t</span>
<a name="l00176"></a>00176 <span class="comment">             the one we&apos;ve setup a translator for, we do the &quot;wrong thing&quot; XXX */</span>
<a name="l00177"></a>00177       <span class="keywordflow">if</span> (fs-&gt;<a class="code" href="structast__filestream.html#ad98134a98f3e3e3b5611a5fd2117e8e4">trans</a> &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != fs-&gt;<a class="code" href="structast__filestream.html#a5f69e0efa6b940c8909dc7e32a06c95b">lastwriteformat</a>) {
<a name="l00178"></a>00178          <a class="code" href="translate_8h.html#a8f767bf5c2095f182e7cbaa73e391207" title="Frees a translator path Frees the given translator path structure.">ast_translator_free_path</a>(fs-&gt;<a class="code" href="structast__filestream.html#ad98134a98f3e3e3b5611a5fd2117e8e4">trans</a>);
<a name="l00179"></a>00179          fs-&gt;<a class="code" href="structast__filestream.html#ad98134a98f3e3e3b5611a5fd2117e8e4">trans</a> = NULL;
<a name="l00180"></a>00180       }
<a name="l00181"></a>00181       <span class="keywordflow">if</span> (!fs-&gt;<a class="code" href="structast__filestream.html#ad98134a98f3e3e3b5611a5fd2117e8e4">trans</a>) 
<a name="l00182"></a>00182          fs-&gt;<a class="code" href="structast__filestream.html#ad98134a98f3e3e3b5611a5fd2117e8e4">trans</a> = <a class="code" href="translate_8h.html#ae53a058fb0d55f3f0b3264813b50232a" title="Builds a translator path Build a path (possibly NULL) from source to dest.">ast_translator_build_path</a>(fs-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a>, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00183"></a>00183       <span class="keywordflow">if</span> (!fs-&gt;<a class="code" href="structast__filestream.html#ad98134a98f3e3e3b5611a5fd2117e8e4">trans</a>)
<a name="l00184"></a>00184          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to translate to format %s, source format %s\n&quot;</span>,
<a name="l00185"></a>00185             fs-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a3777dbae63a15da001b2baa317a25149">name</a>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>));
<a name="l00186"></a>00186       <span class="keywordflow">else</span> {
<a name="l00187"></a>00187          <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *trf;
<a name="l00188"></a>00188          fs-&gt;<a class="code" href="structast__filestream.html#a5f69e0efa6b940c8909dc7e32a06c95b">lastwriteformat</a> = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l00189"></a>00189          <span class="comment">/* Get the translated frame but don&apos;t consume the original in case they&apos;re using it on another stream */</span>
<a name="l00190"></a>00190          <span class="keywordflow">if</span> ((trf = <a class="code" href="translate_8h.html#ab09d3ccb95d1f828d2871530226f9456" title="translates one or more frames Apply an input frame into the translator and receive...">ast_translate</a>(fs-&gt;<a class="code" href="structast__filestream.html#ad98134a98f3e3e3b5611a5fd2117e8e4">trans</a>, f, 0))) {
<a name="l00191"></a>00191             <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *cur;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193             <span class="comment">/* the translator may have returned multiple frames, so process them */</span>
<a name="l00194"></a>00194             <span class="keywordflow">for</span> (cur = trf; cur; cur = <a class="code" href="linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6" title="Returns the next entry in the list after the given entry.">AST_LIST_NEXT</a>(cur, frame_list)) {
<a name="l00195"></a>00195                <span class="keywordflow">if</span> ((res = fs-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#add47f1ec31efb08853aacc02c294bfb5">write</a>(fs, trf))) {
<a name="l00196"></a>00196                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Translated frame write failed\n&quot;</span>);
<a name="l00197"></a>00197                   <span class="keywordflow">break</span>;
<a name="l00198"></a>00198                }
<a name="l00199"></a>00199             }
<a name="l00200"></a>00200             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(trf);
<a name="l00201"></a>00201          } <span class="keywordflow">else</span> {
<a name="l00202"></a>00202             res = 0;
<a name="l00203"></a>00203          }
<a name="l00204"></a>00204       }
<a name="l00205"></a>00205    }
<a name="l00206"></a>00206    <span class="keywordflow">return</span> res;
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a><a class="code" href="file_8c.html#a939eb1d85b6fd5dfc16d00d1c3f86df0">00209</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#a939eb1d85b6fd5dfc16d00d1c3f86df0">copy</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *infile, <span class="keyword">const</span> <span class="keywordtype">char</span> *outfile)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211    <span class="keywordtype">int</span> ifd, ofd, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l00212"></a>00212    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[4096];   <span class="comment">/* XXX make it lerger. */</span>
<a name="l00213"></a>00213 
<a name="l00214"></a>00214    <span class="keywordflow">if</span> ((ifd = open(infile, O_RDONLY)) &lt; 0) {
<a name="l00215"></a>00215       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open %s in read-only mode\n&quot;</span>, infile);
<a name="l00216"></a>00216       <span class="keywordflow">return</span> -1;
<a name="l00217"></a>00217    }
<a name="l00218"></a>00218    <span class="keywordflow">if</span> ((ofd = open(outfile, O_WRONLY | O_TRUNC | O_CREAT, <a class="code" href="asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>)) &lt; 0) {
<a name="l00219"></a>00219       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open %s in write-only mode\n&quot;</span>, outfile);
<a name="l00220"></a>00220       close(ifd);
<a name="l00221"></a>00221       <span class="keywordflow">return</span> -1;
<a name="l00222"></a>00222    }
<a name="l00223"></a>00223    <span class="keywordflow">while</span> ( (len = read(ifd, buf, <span class="keyword">sizeof</span>(buf)) ) ) {
<a name="l00224"></a>00224       <span class="keywordtype">int</span> res;
<a name="l00225"></a>00225       <span class="keywordflow">if</span> (len &lt; 0) {
<a name="l00226"></a>00226          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Read failed on %s: %s\n&quot;</span>, infile, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00227"></a>00227          <span class="keywordflow">break</span>;
<a name="l00228"></a>00228       }
<a name="l00229"></a>00229       <span class="comment">/* XXX handle partial writes */</span>
<a name="l00230"></a>00230       res = write(ofd, buf, len);
<a name="l00231"></a>00231       <span class="keywordflow">if</span> (res != len) {
<a name="l00232"></a>00232          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Write failed on %s (%d of %d): %s\n&quot;</span>, outfile, res, len, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00233"></a>00233          len = -1; <span class="comment">/* error marker */</span>
<a name="l00234"></a>00234          <span class="keywordflow">break</span>;
<a name="l00235"></a>00235       }
<a name="l00236"></a>00236    }
<a name="l00237"></a>00237    close(ifd);
<a name="l00238"></a>00238    close(ofd);
<a name="l00239"></a>00239    <span class="keywordflow">if</span> (len &lt; 0) {
<a name="l00240"></a>00240       unlink(outfile);
<a name="l00241"></a>00241       <span class="keywordflow">return</span> -1; <span class="comment">/* error */</span>
<a name="l00242"></a>00242    }
<a name="l00243"></a>00243    <span class="keywordflow">return</span> 0;   <span class="comment">/* success */</span>
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 <span class="comment"></span>
<a name="l00246"></a>00246 <span class="comment">/*!</span>
<a name="l00247"></a>00247 <span class="comment"> * \brief construct a filename. Absolute pathnames are preserved,</span>
<a name="l00248"></a>00248 <span class="comment"> * relative names are prefixed by the sounds/ directory.</span>
<a name="l00249"></a>00249 <span class="comment"> * The wav49 suffix is replaced by &apos;WAV&apos;.</span>
<a name="l00250"></a>00250 <span class="comment"> * Returns a malloc&apos;ed string to be freed by the caller.</span>
<a name="l00251"></a>00251 <span class="comment"> */</span>
<a name="l00252"></a><a class="code" href="file_8c.html#a2a836416f6627399f3b75ef2705bcd89">00252</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="file_8c.html#a2a836416f6627399f3b75ef2705bcd89" title="construct a filename. Absolute pathnames are preserved, relative names are prefixed...">build_filename</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>)
<a name="l00253"></a>00253 {
<a name="l00254"></a>00254    <span class="keywordtype">char</span> *fn = NULL;
<a name="l00255"></a>00255 
<a name="l00256"></a>00256    <span class="keywordflow">if</span> (!strcmp(ext, <span class="stringliteral">&quot;wav49&quot;</span>))
<a name="l00257"></a>00257       ext = <span class="stringliteral">&quot;WAV&quot;</span>;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259    <span class="keywordflow">if</span> (filename[0] == <span class="charliteral">&apos;/&apos;</span>) {
<a name="l00260"></a>00260       <span class="keywordflow">if</span> (<a class="code" href="astmm_8h.html#a5d1f84199c77c83b8b51928dd359e228">asprintf</a>(&amp;fn, <span class="stringliteral">&quot;%s.%s&quot;</span>, filename, ext) &lt; 0) {
<a name="l00261"></a>00261          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;asprintf() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00262"></a>00262          fn = NULL;
<a name="l00263"></a>00263       }
<a name="l00264"></a>00264    } <span class="keywordflow">else</span> {
<a name="l00265"></a>00265       <span class="keywordflow">if</span> (<a class="code" href="astmm_8h.html#a5d1f84199c77c83b8b51928dd359e228">asprintf</a>(&amp;fn, <span class="stringliteral">&quot;%s/sounds/%s.%s&quot;</span>,
<a name="l00266"></a>00266               <a class="code" href="paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a>, filename, ext) &lt; 0) {
<a name="l00267"></a>00267          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;asprintf() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00268"></a>00268          fn = NULL;
<a name="l00269"></a>00269       }
<a name="l00270"></a>00270    }
<a name="l00271"></a>00271    <span class="keywordflow">return</span> fn;
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 <span class="comment">/* compare type against the list &apos;exts&apos; */</span>
<a name="l00275"></a>00275 <span class="comment">/* XXX need a better algorithm */</span>
<a name="l00276"></a><a class="code" href="file_8c.html#a553ad7eb5306fd161fae25fa17c665ef">00276</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#a553ad7eb5306fd161fae25fa17c665ef">exts_compare</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *exts, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)
<a name="l00277"></a>00277 {
<a name="l00278"></a>00278    <span class="keywordtype">char</span> tmp[256];
<a name="l00279"></a>00279    <span class="keywordtype">char</span> *stringp = tmp, *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, exts, <span class="keyword">sizeof</span>(tmp));
<a name="l00282"></a>00282    <span class="keywordflow">while</span> ((ext = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>))) {
<a name="l00283"></a>00283       <span class="keywordflow">if</span> (!strcmp(ext, type))
<a name="l00284"></a>00284          <span class="keywordflow">return</span> 1;
<a name="l00285"></a>00285    }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287    <span class="keywordflow">return</span> 0;
<a name="l00288"></a>00288 }
<a name="l00289"></a>00289 
<a name="l00290"></a><a class="code" href="file_8c.html#a776a9332979114886ee9fbf55bab1801">00290</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="file_8c.html#a776a9332979114886ee9fbf55bab1801">filestream_destructor</a>(<span class="keywordtype">void</span> *arg)
<a name="l00291"></a>00291 {
<a name="l00292"></a>00292    <span class="keywordtype">char</span> *cmd = NULL;
<a name="l00293"></a>00293    <span class="keywordtype">size_t</span> size = 0;
<a name="l00294"></a>00294    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = arg;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296    <span class="comment">/* Stop a running stream if there is one */</span>
<a name="l00297"></a>00297    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l00298"></a>00298       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a> &lt; <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a>) {
<a name="l00299"></a>00299          f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> = NULL;
<a name="l00300"></a>00300          <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a7de986d04c859684e7754ac888e18532">streamid</a>);
<a name="l00301"></a>00301          <a class="code" href="channel_8h.html#abb39926813ff8874f8e453ca04307e53" title="Enable or disable timer ticks for a channel.">ast_settimeout</a>(f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, 0, NULL, NULL);
<a name="l00302"></a>00302       } <span class="keywordflow">else</span> {
<a name="l00303"></a>00303          f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#ad224fea293daa62d4fba90f86c3503ee">vstream</a> = NULL;
<a name="l00304"></a>00304          <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a3b898697f8133bfc6b3e23906b7d6877">vstreamid</a>);
<a name="l00305"></a>00305       }
<a name="l00306"></a>00306    }
<a name="l00307"></a>00307    <span class="comment">/* destroy the translator on exit */</span>
<a name="l00308"></a>00308    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#ad98134a98f3e3e3b5611a5fd2117e8e4">trans</a>)
<a name="l00309"></a>00309       <a class="code" href="translate_8h.html#a8f767bf5c2095f182e7cbaa73e391207" title="Frees a translator path Frees the given translator path structure.">ast_translator_free_path</a>(f-&gt;<a class="code" href="structast__filestream.html#ad98134a98f3e3e3b5611a5fd2117e8e4">trans</a>);
<a name="l00310"></a>00310 
<a name="l00311"></a>00311    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#a198a1121327381d95b1bb6c501e38333">realfilename</a> &amp;&amp; f-&gt;<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>) {
<a name="l00312"></a>00312          size = strlen(f-&gt;<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>) + strlen(f-&gt;<a class="code" href="structast__filestream.html#a198a1121327381d95b1bb6c501e38333">realfilename</a>) + 15;
<a name="l00313"></a>00313          cmd = alloca(size);
<a name="l00314"></a>00314          memset(cmd,0,size);
<a name="l00315"></a>00315          snprintf(cmd,size,<span class="stringliteral">&quot;/bin/mv -f %s %s&quot;</span>,f-&gt;<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>,f-&gt;<a class="code" href="structast__filestream.html#a198a1121327381d95b1bb6c501e38333">realfilename</a>);
<a name="l00316"></a>00316          <a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(cmd);
<a name="l00317"></a>00317    }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>)
<a name="l00320"></a>00320       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(f-&gt;<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>);
<a name="l00321"></a>00321    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#a198a1121327381d95b1bb6c501e38333">realfilename</a>)
<a name="l00322"></a>00322       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(f-&gt;<a class="code" href="structast__filestream.html#a198a1121327381d95b1bb6c501e38333">realfilename</a>);
<a name="l00323"></a>00323    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#adab132ed465750705cd2961e77f59e1b">close</a>) {
<a name="l00324"></a>00324       void (*closefn)(<span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *) = f-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#adab132ed465750705cd2961e77f59e1b">close</a>;
<a name="l00325"></a>00325       closefn(f);
<a name="l00326"></a>00326    }
<a name="l00327"></a>00327    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>)
<a name="l00328"></a>00328       fclose(f-&gt;<a class="code" href="structast__filestream.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>);
<a name="l00329"></a>00329    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#a084d8f087c50442f51245ec3333abac4">vfs</a>)
<a name="l00330"></a>00330       <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(f-&gt;<a class="code" href="structast__filestream.html#a084d8f087c50442f51245ec3333abac4">vfs</a>);
<a name="l00331"></a>00331    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#a6de7f628c7786f3686214488c8edfc27">write_buffer</a>) {
<a name="l00332"></a>00332       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(f-&gt;<a class="code" href="structast__filestream.html#a6de7f628c7786f3686214488c8edfc27">write_buffer</a>);
<a name="l00333"></a>00333    }
<a name="l00334"></a>00334    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#afa3ba2491683e48895a1e174f7bd7431">orig_chan_name</a>)
<a name="l00335"></a>00335       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>((<span class="keywordtype">void</span> *) f-&gt;<a class="code" href="structast__filestream.html#afa3ba2491683e48895a1e174f7bd7431">orig_chan_name</a>);
<a name="l00336"></a>00336    <a class="code" href="module_8h.html#ac65fa15b16dbc563a2424af744ab003d">ast_module_unref</a>(f-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">module</a>);
<a name="l00337"></a>00337 }
<a name="l00338"></a>00338 
<a name="l00339"></a><a class="code" href="file_8c.html#a6c638cbfc5c6d1f62231935f80a8986a">00339</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="file_8c.html#a6c638cbfc5c6d1f62231935f80a8986a">get_filestream</a>(<span class="keyword">struct</span> <a class="code" href="structast__format.html" title="Each supported file format is described by the following structure.">ast_format</a> *<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>, FILE *bfile)
<a name="l00340"></a>00340 {
<a name="l00341"></a>00341    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343    <span class="keywordtype">int</span> l = <span class="keyword">sizeof</span>(*s) + fmt-&gt;<a class="code" href="structast__format.html#a4c813abab25e4df4e95d8f0b0ca61500">buf_size</a> + fmt-&gt;<a class="code" href="structast__format.html#a0f96ba898b665b247108f83d84ce412c">desc_size</a>;  <span class="comment">/* total allocation size */</span>
<a name="l00344"></a>00344    <span class="keywordflow">if</span> ( (s = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(l, <a class="code" href="file_8c.html#a776a9332979114886ee9fbf55bab1801">filestream_destructor</a>)) == NULL)
<a name="l00345"></a>00345       <span class="keywordflow">return</span> NULL;
<a name="l00346"></a>00346    s-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a> = fmt;
<a name="l00347"></a>00347    s-&gt;<a class="code" href="structast__filestream.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a> = bfile;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349    <span class="keywordflow">if</span> (fmt-&gt;<a class="code" href="structast__format.html#a0f96ba898b665b247108f83d84ce412c">desc_size</a>)
<a name="l00350"></a>00350       s-&gt;<a class="code" href="structast__filestream.html#a1cb76d737bf6f5b53e6c970073cba051">_private</a> = ((<span class="keywordtype">char</span> *)(s + 1)) + fmt-&gt;<a class="code" href="structast__format.html#a4c813abab25e4df4e95d8f0b0ca61500">buf_size</a>;
<a name="l00351"></a>00351    if (fmt-&gt;<a class="code" href="structast__format.html#a4c813abab25e4df4e95d8f0b0ca61500">buf_size</a>)
<a name="l00352"></a>00352       s-&gt;<a class="code" href="structast__filestream.html#a1fe855c208bc17a51a4d34fefdb2d5b1">buf</a> = (<span class="keywordtype">char</span> *)(s + 1);
<a name="l00353"></a>00353    s-&gt;<a class="code" href="structast__filestream.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>.<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a> = fmt-&gt;<a class="code" href="structast__format.html#a3777dbae63a15da001b2baa317a25149">name</a>;
<a name="l00354"></a>00354    <span class="keywordflow">return</span> s;
<a name="l00355"></a>00355 }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357 <span class="comment">/*</span>
<a name="l00358"></a>00358 <span class="comment"> * Default implementations of open and rewrite.</span>
<a name="l00359"></a>00359 <span class="comment"> * Only use them if you don&apos;t have expensive stuff to do.</span>
<a name="l00360"></a>00360 <span class="comment"> */</span>
<a name="l00361"></a><a class="code" href="file_8c.html#a4131813449b33963d46e2345c919e137afacafddc383b7c51dfc4fa2082f95d6f">00361</a> <span class="keyword">enum</span> <a class="code" href="file_8c.html#a4131813449b33963d46e2345c919e137">wrap_fn</a> { <a class="code" href="file_8c.html#a4131813449b33963d46e2345c919e137ab717747f3d4bbdfef86f1fd625bb8150">WRAP_OPEN</a>, <a class="code" href="file_8c.html#a4131813449b33963d46e2345c919e137afacafddc383b7c51dfc4fa2082f95d6f">WRAP_REWRITE</a> };
<a name="l00362"></a>00362 
<a name="l00363"></a><a class="code" href="file_8c.html#ac764765c2aa449eb5840087a2148e5ef">00363</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#ac764765c2aa449eb5840087a2148e5ef">fn_wrapper</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael__lex_8c.html#a43be22b7a1b528eaf759e034ec581543">comment</a>, <span class="keyword">enum</span> <a class="code" href="file_8c.html#a4131813449b33963d46e2345c919e137">wrap_fn</a> <a class="code" href="structast__filestream.html#adc8d3cf511ceb277aea0cfa1cd027c59">mode</a>)
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365    <span class="keyword">struct </span><a class="code" href="structast__format.html" title="Each supported file format is described by the following structure.">ast_format</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = s-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>;
<a name="l00366"></a>00366    <span class="keywordtype">int</span> ret = -1;
<a name="l00367"></a>00367    int (*openfn)(<span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *s);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369    <span class="keywordflow">if</span> (mode == <a class="code" href="file_8c.html#a4131813449b33963d46e2345c919e137ab717747f3d4bbdfef86f1fd625bb8150">WRAP_OPEN</a> &amp;&amp; (openfn = f-&gt;<a class="code" href="structast__format.html#a1ae983131ebe78df1a8160da611f7705" title="Prepare an input stream for playback.">open</a>) &amp;&amp; openfn(s))
<a name="l00370"></a>00370       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open format %s\n&quot;</span>, f-&gt;<a class="code" href="structast__format.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00371"></a>00371    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <a class="code" href="file_8c.html#a4131813449b33963d46e2345c919e137afacafddc383b7c51dfc4fa2082f95d6f">WRAP_REWRITE</a> &amp;&amp; f-&gt;<a class="code" href="structast__format.html#a48bfd7b650b4dca2fec146eab6825e88" title="Prepare a stream for output, and comment it appropriately if applicable.">rewrite</a> &amp;&amp; f-&gt;<a class="code" href="structast__format.html#a48bfd7b650b4dca2fec146eab6825e88" title="Prepare a stream for output, and comment it appropriately if applicable.">rewrite</a>(s, comment))
<a name="l00372"></a>00372       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to rewrite format %s\n&quot;</span>, f-&gt;<a class="code" href="structast__format.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00373"></a>00373    <span class="keywordflow">else</span> {
<a name="l00374"></a>00374       <span class="comment">/* preliminary checks succeed. update usecount */</span>
<a name="l00375"></a>00375       <a class="code" href="module_8h.html#aa08fcee0b390e15532dd03803c8728c4">ast_module_ref</a>(f-&gt;<a class="code" href="structast__format.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">module</a>);
<a name="l00376"></a>00376       ret = 0;
<a name="l00377"></a>00377    }
<a name="l00378"></a>00378    <span class="keywordflow">return</span> ret;
<a name="l00379"></a>00379 }
<a name="l00380"></a>00380 
<a name="l00381"></a><a class="code" href="file_8c.html#acbe06882238f9fabfff485fefc6fa619">00381</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#acbe06882238f9fabfff485fefc6fa619">rewrite_wrapper</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael__lex_8c.html#a43be22b7a1b528eaf759e034ec581543">comment</a>)
<a name="l00382"></a>00382 {
<a name="l00383"></a>00383    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#ac764765c2aa449eb5840087a2148e5ef">fn_wrapper</a>(s, comment, <a class="code" href="file_8c.html#a4131813449b33963d46e2345c919e137afacafddc383b7c51dfc4fa2082f95d6f">WRAP_REWRITE</a>);
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a><a class="code" href="file_8c.html#ac17ab5a9432e8fbe75d7968221897716">00386</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#ac17ab5a9432e8fbe75d7968221897716">open_wrapper</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l00387"></a>00387 {
<a name="l00388"></a>00388    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#ac764765c2aa449eb5840087a2148e5ef">fn_wrapper</a>(s, NULL, <a class="code" href="file_8c.html#a4131813449b33963d46e2345c919e137ab717747f3d4bbdfef86f1fd625bb8150">WRAP_OPEN</a>);
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a><a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01">00391</a> <span class="keyword">enum</span> <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01">file_action</a> {
<a name="l00392"></a><a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a3ed1ec6240a2d6ba30efbcdfc6470975">00392</a>    <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a3ed1ec6240a2d6ba30efbcdfc6470975">ACTION_EXISTS</a> = 1, <span class="comment">/* return matching format if file exists, 0 otherwise */</span>
<a name="l00393"></a><a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a92f147f69db5353fd464f636eaf02904">00393</a>    <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a92f147f69db5353fd464f636eaf02904">ACTION_DELETE</a>, <span class="comment">/* delete file, return 0 on success, -1 on error */</span>
<a name="l00394"></a><a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01ae266c94c6d3f3d0940c34c798e5842a6">00394</a>    <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01ae266c94c6d3f3d0940c34c798e5842a6">ACTION_RENAME</a>, <span class="comment">/* rename file. return 0 on success, -1 on error */</span>
<a name="l00395"></a><a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a04bda3b7d3fbe904b2d0c85602e73cc7">00395</a>    <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a04bda3b7d3fbe904b2d0c85602e73cc7">ACTION_OPEN</a>,
<a name="l00396"></a><a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a7930542f31154bb3b8a33654af6cfd4f">00396</a>    <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a7930542f31154bb3b8a33654af6cfd4f">ACTION_COPY</a> <span class="comment">/* copy file. return 0 on success, -1 on error */</span>
<a name="l00397"></a>00397 };
<a name="l00398"></a>00398 <span class="comment"></span>
<a name="l00399"></a>00399 <span class="comment">/*!</span>
<a name="l00400"></a>00400 <span class="comment"> * \brief perform various actions on a file. Second argument</span>
<a name="l00401"></a>00401 <span class="comment"> * arg2 depends on the command:</span>
<a name="l00402"></a>00402 <span class="comment"> * unused for EXISTS and DELETE</span>
<a name="l00403"></a>00403 <span class="comment"> * destination file name (const char *) for COPY and RENAME</span>
<a name="l00404"></a>00404 <span class="comment"> *    struct ast_channel * for OPEN</span>
<a name="l00405"></a>00405 <span class="comment"> * if fmt is NULL, OPEN will return the first matching entry,</span>
<a name="l00406"></a>00406 <span class="comment"> * whereas other functions will run on all matching entries.</span>
<a name="l00407"></a>00407 <span class="comment"> */</span>
<a name="l00408"></a><a class="code" href="file_8c.html#ae45ebf66fbe68ddba09480cf2e89ce71">00408</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#ae45ebf66fbe68ddba09480cf2e89ce71" title="perform various actions on a file. Second argument arg2 depends on the command: unused...">ast_filehelper</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">void</span> *arg2, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>, <span class="keyword">const</span> <span class="keyword">enum</span> <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01">file_action</a> action)
<a name="l00409"></a>00409 {
<a name="l00410"></a>00410    <span class="keyword">struct </span><a class="code" href="structast__format.html" title="Each supported file format is described by the following structure.">ast_format</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00411"></a>00411    <span class="keywordtype">int</span> res = (action == <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a3ed1ec6240a2d6ba30efbcdfc6470975">ACTION_EXISTS</a>) ? 0 : -1;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l00414"></a>00414    <span class="comment">/* Check for a specific format */</span>
<a name="l00415"></a>00415    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structformats.html">formats</a>, f, <a class="code" href="structast__format.html#ad0c8f8a1ef89f35f7f1fcce75787632f">list</a>) {
<a name="l00416"></a>00416       <span class="keywordtype">char</span> *stringp, *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a> = NULL;
<a name="l00417"></a>00417 
<a name="l00418"></a>00418       <span class="keywordflow">if</span> (fmt &amp;&amp; !<a class="code" href="file_8c.html#a553ad7eb5306fd161fae25fa17c665ef">exts_compare</a>(f-&gt;<a class="code" href="structast__format.html#ade71f534a49925f1955a1598556219e2">exts</a>, fmt))
<a name="l00419"></a>00419          <span class="keywordflow">continue</span>;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421       <span class="comment">/* Look for a file matching the supported extensions.</span>
<a name="l00422"></a>00422 <span class="comment">       * The file must exist, and for OPEN, must match</span>
<a name="l00423"></a>00423 <span class="comment">       * one of the formats supported by the channel.</span>
<a name="l00424"></a>00424 <span class="comment">       */</span>
<a name="l00425"></a>00425       stringp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(f-&gt;<a class="code" href="structast__format.html#ade71f534a49925f1955a1598556219e2">exts</a>);  <span class="comment">/* this is in the stack so does not need to be freed */</span>
<a name="l00426"></a>00426       <span class="keywordflow">while</span> ( (ext = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>)) ) {
<a name="l00427"></a>00427          <span class="keyword">struct </span>stat st;
<a name="l00428"></a>00428          <span class="keywordtype">char</span> *fn = <a class="code" href="file_8c.html#a2a836416f6627399f3b75ef2705bcd89" title="construct a filename. Absolute pathnames are preserved, relative names are prefixed...">build_filename</a>(filename, ext);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430          <span class="keywordflow">if</span> (fn == NULL)
<a name="l00431"></a>00431             <span class="keywordflow">continue</span>;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433          <span class="keywordflow">if</span> ( stat(fn, &amp;st) ) { <span class="comment">/* file not existent */</span>
<a name="l00434"></a>00434             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fn);
<a name="l00435"></a>00435             <span class="keywordflow">continue</span>;
<a name="l00436"></a>00436          }
<a name="l00437"></a>00437          <span class="comment">/* for &apos;OPEN&apos; we need to be sure that the format matches</span>
<a name="l00438"></a>00438 <span class="comment">          * what the channel can process</span>
<a name="l00439"></a>00439 <span class="comment">          */</span>
<a name="l00440"></a>00440          <span class="keywordflow">if</span> (action == <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a04bda3b7d3fbe904b2d0c85602e73cc7">ACTION_OPEN</a>) {
<a name="l00441"></a>00441             <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a> = (<span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *)arg2;
<a name="l00442"></a>00442             FILE *bfile;
<a name="l00443"></a>00443             <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445             <span class="keywordflow">if</span> ( !(chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> &amp; f-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a>) &amp;&amp;
<a name="l00446"></a>00446                  !((f-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a> &amp; <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a> &amp;&amp; fmt) ||
<a name="l00447"></a>00447                  (f-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a> &amp; <a class="code" href="frame_8h.html#ad048231af8a6271706585e3c8630dc69">AST_FORMAT_VIDEO_MASK</a> &amp;&amp; fmt))) {
<a name="l00448"></a>00448                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fn);
<a name="l00449"></a>00449                <span class="keywordflow">continue</span>;   <span class="comment">/* not a supported format */</span>
<a name="l00450"></a>00450             }
<a name="l00451"></a>00451             <span class="keywordflow">if</span> ( (bfile = fopen(fn, <span class="stringliteral">&quot;r&quot;</span>)) == NULL) {
<a name="l00452"></a>00452                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fn);
<a name="l00453"></a>00453                <span class="keywordflow">continue</span>;   <span class="comment">/* cannot open file */</span>
<a name="l00454"></a>00454             }
<a name="l00455"></a>00455             s = <a class="code" href="file_8c.html#a6c638cbfc5c6d1f62231935f80a8986a">get_filestream</a>(f, bfile);
<a name="l00456"></a>00456             <span class="keywordflow">if</span> (!s) {
<a name="l00457"></a>00457                fclose(bfile);
<a name="l00458"></a>00458                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fn);  <span class="comment">/* cannot allocate descriptor */</span>
<a name="l00459"></a>00459                <span class="keywordflow">continue</span>;
<a name="l00460"></a>00460             }
<a name="l00461"></a>00461             <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#ac17ab5a9432e8fbe75d7968221897716">open_wrapper</a>(s)) {
<a name="l00462"></a>00462                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fn);
<a name="l00463"></a>00463                <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(s);
<a name="l00464"></a>00464                <span class="keywordflow">continue</span>;   <span class="comment">/* cannot run open on file */</span>
<a name="l00465"></a>00465             }
<a name="l00466"></a>00466             <span class="keywordflow">if</span> (st.st_size == 0) {
<a name="l00467"></a>00467                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;File %s detected to have zero size.\n&quot;</span>, fn);
<a name="l00468"></a>00468             }
<a name="l00469"></a>00469             <span class="comment">/* ok this is good for OPEN */</span>
<a name="l00470"></a>00470             res = 1; <span class="comment">/* found */</span>
<a name="l00471"></a>00471             s-&gt;<a class="code" href="structast__filestream.html#a486275f508390f690dcd44b31e4d0e87">lasttimeout</a> = -1;
<a name="l00472"></a>00472             s-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a> = f;
<a name="l00473"></a>00473             s-&gt;<a class="code" href="structast__filestream.html#ad98134a98f3e3e3b5611a5fd2117e8e4">trans</a> = NULL;
<a name="l00474"></a>00474             s-&gt;<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a> = NULL;
<a name="l00475"></a>00475             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a> &amp; <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a>) {
<a name="l00476"></a>00476                <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>)
<a name="l00477"></a>00477                   <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>);
<a name="l00478"></a>00478                chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> = s;
<a name="l00479"></a>00479             } <span class="keywordflow">else</span> {
<a name="l00480"></a>00480                <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#ad224fea293daa62d4fba90f86c3503ee">vstream</a>)
<a name="l00481"></a>00481                   <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#ad224fea293daa62d4fba90f86c3503ee">vstream</a>);
<a name="l00482"></a>00482                chan-&gt;<a class="code" href="structast__channel.html#ad224fea293daa62d4fba90f86c3503ee">vstream</a> = s;
<a name="l00483"></a>00483             }
<a name="l00484"></a>00484             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fn);
<a name="l00485"></a>00485             <span class="keywordflow">break</span>;
<a name="l00486"></a>00486          }
<a name="l00487"></a>00487          <span class="keywordflow">switch</span> (action) {
<a name="l00488"></a>00488          <span class="keywordflow">case</span> <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a04bda3b7d3fbe904b2d0c85602e73cc7">ACTION_OPEN</a>:
<a name="l00489"></a>00489             <span class="keywordflow">break</span>;   <span class="comment">/* will never get here */</span>
<a name="l00490"></a>00490 
<a name="l00491"></a>00491          <span class="keywordflow">case</span> <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a3ed1ec6240a2d6ba30efbcdfc6470975">ACTION_EXISTS</a>:  <span class="comment">/* return the matching format */</span>
<a name="l00492"></a>00492             res |= f-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a>;
<a name="l00493"></a>00493             <span class="keywordflow">break</span>;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495          <span class="keywordflow">case</span> <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a92f147f69db5353fd464f636eaf02904">ACTION_DELETE</a>:
<a name="l00496"></a>00496             <span class="keywordflow">if</span> ( (res = unlink(fn)) )
<a name="l00497"></a>00497                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;unlink(%s) failed: %s\n&quot;</span>, fn, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00498"></a>00498             <span class="keywordflow">break</span>;
<a name="l00499"></a>00499 
<a name="l00500"></a>00500          <span class="keywordflow">case</span> <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01ae266c94c6d3f3d0940c34c798e5842a6">ACTION_RENAME</a>:
<a name="l00501"></a>00501          <span class="keywordflow">case</span> <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a7930542f31154bb3b8a33654af6cfd4f">ACTION_COPY</a>: {
<a name="l00502"></a>00502             <span class="keywordtype">char</span> *nfn = <a class="code" href="file_8c.html#a2a836416f6627399f3b75ef2705bcd89" title="construct a filename. Absolute pathnames are preserved, relative names are prefixed...">build_filename</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)arg2, ext);
<a name="l00503"></a>00503             <span class="keywordflow">if</span> (!nfn)
<a name="l00504"></a>00504                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of memory\n&quot;</span>);
<a name="l00505"></a>00505             <span class="keywordflow">else</span> {
<a name="l00506"></a>00506                res = action == <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a7930542f31154bb3b8a33654af6cfd4f">ACTION_COPY</a> ? <a class="code" href="file_8c.html#a939eb1d85b6fd5dfc16d00d1c3f86df0">copy</a>(fn, nfn) : rename(fn, nfn);
<a name="l00507"></a>00507                <span class="keywordflow">if</span> (res)
<a name="l00508"></a>00508                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s(%s,%s) failed: %s\n&quot;</span>,
<a name="l00509"></a>00509                      action == <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a7930542f31154bb3b8a33654af6cfd4f">ACTION_COPY</a> ? <span class="stringliteral">&quot;copy&quot;</span> : <span class="stringliteral">&quot;rename&quot;</span>,
<a name="l00510"></a>00510                       fn, nfn, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00511"></a>00511                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(nfn);
<a name="l00512"></a>00512             }
<a name="l00513"></a>00513              }
<a name="l00514"></a>00514             <span class="keywordflow">break</span>;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516          <span class="keywordflow">default</span>:
<a name="l00517"></a>00517             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown helper %d\n&quot;</span>, action);
<a name="l00518"></a>00518          }
<a name="l00519"></a>00519          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fn);
<a name="l00520"></a>00520       }
<a name="l00521"></a>00521    }
<a name="l00522"></a>00522    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l00523"></a>00523    <span class="keywordflow">return</span> res;
<a name="l00524"></a>00524 }
<a name="l00525"></a>00525 
<a name="l00526"></a><a class="code" href="file_8c.html#ab2ba253f0cfdacc7312206800f7bd2bb">00526</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#ab2ba253f0cfdacc7312206800f7bd2bb">is_absolute_path</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>)
<a name="l00527"></a>00527 {
<a name="l00528"></a>00528    <span class="keywordflow">return</span> filename[0] == <span class="charliteral">&apos;/&apos;</span>;
<a name="l00529"></a>00529 }
<a name="l00530"></a>00530 
<a name="l00531"></a><a class="code" href="file_8c.html#a98c721a508c1e3d84740d2473a2e3d78">00531</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#a98c721a508c1e3d84740d2473a2e3d78">fileexists_test</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang,
<a name="l00532"></a>00532             <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> buflen)
<a name="l00533"></a>00533 {
<a name="l00534"></a>00534    <span class="keywordflow">if</span> (buf == NULL) {
<a name="l00535"></a>00535       <span class="keywordflow">return</span> -1;
<a name="l00536"></a>00536    }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538    <span class="keywordflow">if</span> (ast_language_is_prefix &amp;&amp; !<a class="code" href="file_8c.html#ab2ba253f0cfdacc7312206800f7bd2bb">is_absolute_path</a>(filename)) { <span class="comment">/* new layout */</span>
<a name="l00539"></a>00539       <span class="keywordflow">if</span> (lang) {
<a name="l00540"></a>00540          snprintf(buf, buflen, <span class="stringliteral">&quot;%s/%s&quot;</span>, lang, filename);
<a name="l00541"></a>00541       } <span class="keywordflow">else</span> {
<a name="l00542"></a>00542          snprintf(buf, buflen, <span class="stringliteral">&quot;%s&quot;</span>, filename);
<a name="l00543"></a>00543       }
<a name="l00544"></a>00544    } <span class="keywordflow">else</span> { <span class="comment">/* old layout */</span>
<a name="l00545"></a>00545       strcpy(buf, filename);  <span class="comment">/* first copy the full string */</span>
<a name="l00546"></a>00546       <span class="keywordflow">if</span> (lang) {
<a name="l00547"></a>00547          <span class="comment">/* insert the language and suffix if needed */</span>
<a name="l00548"></a>00548          <span class="keyword">const</span> <span class="keywordtype">char</span> *c = strrchr(filename, <span class="charliteral">&apos;/&apos;</span>);
<a name="l00549"></a>00549          <span class="keywordtype">int</span> offset = c ? c - filename + 1 : 0; <span class="comment">/* points right after the last &apos;/&apos; */</span>
<a name="l00550"></a>00550          snprintf(buf + offset, buflen - offset, <span class="stringliteral">&quot;%s/%s&quot;</span>, lang, filename + offset);
<a name="l00551"></a>00551       }
<a name="l00552"></a>00552    }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#ae45ebf66fbe68ddba09480cf2e89ce71" title="perform various actions on a file. Second argument arg2 depends on the command: unused...">ast_filehelper</a>(buf, NULL, fmt, <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a3ed1ec6240a2d6ba30efbcdfc6470975">ACTION_EXISTS</a>);
<a name="l00555"></a>00555 }
<a name="l00556"></a>00556 <span class="comment"></span>
<a name="l00557"></a>00557 <span class="comment">/*!</span>
<a name="l00558"></a>00558 <span class="comment"> * \brief helper routine to locate a file with a given format</span>
<a name="l00559"></a>00559 <span class="comment"> * and language preference.</span>
<a name="l00560"></a>00560 <span class="comment"> * Try preflang, preflang with stripped &apos;_&apos; suffix, or NULL.</span>
<a name="l00561"></a>00561 <span class="comment"> * In the standard asterisk, language goes just before the last component.</span>
<a name="l00562"></a>00562 <span class="comment"> * In an alternative configuration, the language should be a prefix</span>
<a name="l00563"></a>00563 <span class="comment"> * to the actual filename.</span>
<a name="l00564"></a>00564 <span class="comment"> *</span>
<a name="l00565"></a>00565 <span class="comment"> * The last parameter(s) point to a buffer of sufficient size,</span>
<a name="l00566"></a>00566 <span class="comment"> * which on success is filled with the matching filename.</span>
<a name="l00567"></a>00567 <span class="comment"> */</span>
<a name="l00568"></a><a class="code" href="file_8c.html#a8306f2512acb0dfd082c61a023cefe0c">00568</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#a8306f2512acb0dfd082c61a023cefe0c" title="helper routine to locate a file with a given format and language preference. Try...">fileexists_core</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang,
<a name="l00569"></a>00569             <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> buflen)
<a name="l00570"></a>00570 {
<a name="l00571"></a>00571    <span class="keywordtype">int</span> res = -1;
<a name="l00572"></a>00572    <span class="keywordtype">char</span> *lang = NULL;
<a name="l00573"></a>00573 
<a name="l00574"></a>00574    <span class="keywordflow">if</span> (buf == NULL) {
<a name="l00575"></a>00575       <span class="keywordflow">return</span> -1;
<a name="l00576"></a>00576    }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578    <span class="comment">/* We try languages in the following order:</span>
<a name="l00579"></a>00579 <span class="comment">    *    preflang (may include dialect)</span>
<a name="l00580"></a>00580 <span class="comment">    *    lang (preflang without dialect - if any)</span>
<a name="l00581"></a>00581 <span class="comment">    *    &lt;none&gt;</span>
<a name="l00582"></a>00582 <span class="comment">    *    default (unless the same as preflang or lang without dialect)</span>
<a name="l00583"></a>00583 <span class="comment">    */</span>
<a name="l00584"></a>00584 
<a name="l00585"></a>00585    <span class="comment">/* Try preferred language */</span>
<a name="l00586"></a>00586    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(preflang)) {
<a name="l00587"></a>00587       <span class="comment">/* try the preflang exactly as it was requested */</span>
<a name="l00588"></a>00588       <span class="keywordflow">if</span> ((res = <a class="code" href="file_8c.html#a98c721a508c1e3d84740d2473a2e3d78">fileexists_test</a>(filename, fmt, preflang, buf, buflen)) &gt; 0) {
<a name="l00589"></a>00589          <span class="keywordflow">return</span> res;
<a name="l00590"></a>00590       } <span class="keywordflow">else</span> {
<a name="l00591"></a>00591          <span class="comment">/* try without a dialect */</span>
<a name="l00592"></a>00592          <span class="keywordtype">char</span> *postfix = NULL;
<a name="l00593"></a>00593          postfix = lang = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(preflang);
<a name="l00594"></a>00594 
<a name="l00595"></a>00595          <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;postfix, <span class="stringliteral">&quot;_&quot;</span>);
<a name="l00596"></a>00596          <span class="keywordflow">if</span> (postfix) {
<a name="l00597"></a>00597             <span class="keywordflow">if</span> ((res = <a class="code" href="file_8c.html#a98c721a508c1e3d84740d2473a2e3d78">fileexists_test</a>(filename, fmt, lang, buf, buflen)) &gt; 0) {
<a name="l00598"></a>00598                <span class="keywordflow">return</span> res;
<a name="l00599"></a>00599             }
<a name="l00600"></a>00600          }
<a name="l00601"></a>00601       }
<a name="l00602"></a>00602    }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604    <span class="comment">/* Try without any language */</span>
<a name="l00605"></a>00605    <span class="keywordflow">if</span> ((res = <a class="code" href="file_8c.html#a98c721a508c1e3d84740d2473a2e3d78">fileexists_test</a>(filename, fmt, NULL, buf, buflen)) &gt; 0) {
<a name="l00606"></a>00606       <span class="keywordflow">return</span> res;
<a name="l00607"></a>00607    }
<a name="l00608"></a>00608 
<a name="l00609"></a>00609    <span class="comment">/* Finally try the default language unless it was already tried before */</span>
<a name="l00610"></a>00610    <span class="keywordflow">if</span> ((<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(preflang) || strcmp(preflang, <a class="code" href="asterisk_8h.html#a2a112ca1c7c7dc54fe43375469738dc4">DEFAULT_LANGUAGE</a>)) &amp;&amp; (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(lang) || strcmp(lang, <a class="code" href="asterisk_8h.html#a2a112ca1c7c7dc54fe43375469738dc4">DEFAULT_LANGUAGE</a>))) {
<a name="l00611"></a>00611       <span class="keywordflow">if</span> ((res = <a class="code" href="file_8c.html#a98c721a508c1e3d84740d2473a2e3d78">fileexists_test</a>(filename, fmt, <a class="code" href="asterisk_8h.html#a2a112ca1c7c7dc54fe43375469738dc4">DEFAULT_LANGUAGE</a>, buf, buflen)) &gt; 0) {
<a name="l00612"></a>00612          <span class="keywordflow">return</span> res;
<a name="l00613"></a>00613       }
<a name="l00614"></a>00614    }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616    <span class="keywordflow">return</span> 0;
<a name="l00617"></a>00617 }
<a name="l00618"></a>00618 
<a name="l00619"></a><a class="code" href="file_8c.html#ad85c951fa1d6988d2d7e169833a951a8">00619</a> <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="file_8h.html#ad85c951fa1d6988d2d7e169833a951a8" title="Opens stream for use in seeking, playing.">ast_openstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang)
<a name="l00620"></a>00620 {
<a name="l00621"></a>00621    <span class="keywordflow">return</span> <a class="code" href="file_8h.html#ae2d6dfeafd18a99d47195178cd752a3d" title="Opens stream for use in seeking, playing.">ast_openstream_full</a>(chan, filename, preflang, 0);
<a name="l00622"></a>00622 }
<a name="l00623"></a>00623 
<a name="l00624"></a><a class="code" href="file_8c.html#ae2d6dfeafd18a99d47195178cd752a3d">00624</a> <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="file_8h.html#ae2d6dfeafd18a99d47195178cd752a3d" title="Opens stream for use in seeking, playing.">ast_openstream_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang, <span class="keywordtype">int</span> asis)
<a name="l00625"></a>00625 {
<a name="l00626"></a>00626    <span class="comment">/* </span>
<a name="l00627"></a>00627 <span class="comment">    * Use fileexists_core() to find a file in a compatible</span>
<a name="l00628"></a>00628 <span class="comment">    * language and format, set up a suitable translator,</span>
<a name="l00629"></a>00629 <span class="comment">    * and open the stream.</span>
<a name="l00630"></a>00630 <span class="comment">    */</span>
<a name="l00631"></a>00631    <span class="keywordtype">int</span> fmts, res, buflen;
<a name="l00632"></a>00632    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l00633"></a>00633 
<a name="l00634"></a>00634    <span class="keywordflow">if</span> (!asis) {
<a name="l00635"></a>00635       <span class="comment">/* do this first, otherwise we detect the wrong writeformat */</span>
<a name="l00636"></a>00636       <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l00637"></a>00637       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a4e855ab0f984741b9083b2c5a0fdfe18">generator</a>)
<a name="l00638"></a>00638          <a class="code" href="channel_8h.html#a7160355005776732fba88cc020f4a45b">ast_deactivate_generator</a>(chan);
<a name="l00639"></a>00639    }
<a name="l00640"></a>00640    <span class="keywordflow">if</span> (preflang == NULL)
<a name="l00641"></a>00641       preflang = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00642"></a>00642    buflen = strlen(preflang) + strlen(filename) + 4;
<a name="l00643"></a>00643    buf = alloca(buflen);
<a name="l00644"></a>00644    <span class="keywordflow">if</span> (buf == NULL)
<a name="l00645"></a>00645       <span class="keywordflow">return</span> NULL;
<a name="l00646"></a>00646    fmts = <a class="code" href="file_8c.html#a8306f2512acb0dfd082c61a023cefe0c" title="helper routine to locate a file with a given format and language preference. Try...">fileexists_core</a>(filename, NULL, preflang, buf, buflen);
<a name="l00647"></a>00647    <span class="keywordflow">if</span> (fmts &gt; 0)
<a name="l00648"></a>00648       fmts &amp;= <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a>;
<a name="l00649"></a>00649    <span class="keywordflow">if</span> (fmts &lt; 1) {
<a name="l00650"></a>00650       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;File %s does not exist in any format\n&quot;</span>, filename);
<a name="l00651"></a>00651       <span class="keywordflow">return</span> NULL;
<a name="l00652"></a>00652    }
<a name="l00653"></a>00653    chan-&gt;<a class="code" href="structast__channel.html#a8668180049a7ed4e28b17842144e6d05">oldwriteformat</a> = chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l00654"></a>00654    <span class="comment">/* Set the channel to a format we can work with */</span>
<a name="l00655"></a>00655    res = <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, fmts);
<a name="l00656"></a>00656    res = <a class="code" href="file_8c.html#ae45ebf66fbe68ddba09480cf2e89ce71" title="perform various actions on a file. Second argument arg2 depends on the command: unused...">ast_filehelper</a>(buf, chan, NULL, <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a04bda3b7d3fbe904b2d0c85602e73cc7">ACTION_OPEN</a>);
<a name="l00657"></a>00657    <span class="keywordflow">if</span> (res &gt;= 0)
<a name="l00658"></a>00658       <span class="keywordflow">return</span> chan-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>;
<a name="l00659"></a>00659    <span class="keywordflow">return</span> NULL;
<a name="l00660"></a>00660 }
<a name="l00661"></a>00661 
<a name="l00662"></a><a class="code" href="file_8c.html#aeed49fff2d6008a89f996230988d944d">00662</a> <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="file_8h.html#aeed49fff2d6008a89f996230988d944d" title="Opens stream for use in seeking, playing.">ast_openvstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang)
<a name="l00663"></a>00663 {
<a name="l00664"></a>00664    <span class="comment">/* As above, but for video. But here we don&apos;t have translators</span>
<a name="l00665"></a>00665 <span class="comment">    * so we must enforce a format.</span>
<a name="l00666"></a>00666 <span class="comment">    */</span>
<a name="l00667"></a>00667    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>;
<a name="l00668"></a>00668    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l00669"></a>00669    <span class="keywordtype">int</span> buflen;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671    <span class="keywordflow">if</span> (preflang == NULL)
<a name="l00672"></a>00672       preflang = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00673"></a>00673    buflen = strlen(preflang) + strlen(filename) + 4;
<a name="l00674"></a>00674    buf = alloca(buflen);
<a name="l00675"></a>00675    <span class="keywordflow">if</span> (buf == NULL)
<a name="l00676"></a>00676       <span class="keywordflow">return</span> NULL;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678    <span class="keywordflow">for</span> (format = <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a> + 1; format &lt;= <a class="code" href="frame_8h.html#ad048231af8a6271706585e3c8630dc69">AST_FORMAT_VIDEO_MASK</a>; format = format &lt;&lt; 1) {
<a name="l00679"></a>00679       <span class="keywordtype">int</span> fd;
<a name="l00680"></a>00680       <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>;
<a name="l00681"></a>00681 
<a name="l00682"></a>00682       <span class="keywordflow">if</span> (!(chan-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> &amp; format))
<a name="l00683"></a>00683          <span class="keywordflow">continue</span>;
<a name="l00684"></a>00684       fmt = <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(format);
<a name="l00685"></a>00685       <span class="keywordflow">if</span> ( <a class="code" href="file_8c.html#a8306f2512acb0dfd082c61a023cefe0c" title="helper routine to locate a file with a given format and language preference. Try...">fileexists_core</a>(filename, fmt, preflang, buf, buflen) &lt; 1)   <span class="comment">/* no valid format */</span>
<a name="l00686"></a>00686          <span class="keywordflow">continue</span>;
<a name="l00687"></a>00687       fd = <a class="code" href="file_8c.html#ae45ebf66fbe68ddba09480cf2e89ce71" title="perform various actions on a file. Second argument arg2 depends on the command: unused...">ast_filehelper</a>(buf, chan, fmt, <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a04bda3b7d3fbe904b2d0c85602e73cc7">ACTION_OPEN</a>);
<a name="l00688"></a>00688       <span class="keywordflow">if</span> (fd &gt;= 0)
<a name="l00689"></a>00689          <span class="keywordflow">return</span> chan-&gt;<a class="code" href="structast__channel.html#ad224fea293daa62d4fba90f86c3503ee">vstream</a>;
<a name="l00690"></a>00690       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;File %s has video but couldn&apos;t be opened\n&quot;</span>, filename);
<a name="l00691"></a>00691    }
<a name="l00692"></a>00692    <span class="keywordflow">return</span> NULL;
<a name="l00693"></a>00693 }
<a name="l00694"></a>00694 
<a name="l00695"></a><a class="code" href="file_8c.html#a3d11f27997994d366d52d54a084ec944">00695</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="file_8c.html#a3d11f27997994d366d52d54a084ec944">read_frame</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> *whennext)
<a name="l00696"></a>00696 {
<a name="l00697"></a>00697    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *fr, *new_fr;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699    <span class="keywordflow">if</span> (!s || !s-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>) {
<a name="l00700"></a>00700       <span class="keywordflow">return</span> NULL;
<a name="l00701"></a>00701    }
<a name="l00702"></a>00702 
<a name="l00703"></a>00703    <span class="keywordflow">if</span> (!(fr = s-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a66013f22f94740f8716711002d0f11fe">read</a>(s, whennext))) {
<a name="l00704"></a>00704       <span class="keywordflow">return</span> NULL;
<a name="l00705"></a>00705    }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707    <span class="keywordflow">if</span> (!(new_fr = <a class="code" href="frame_8h.html#aa7dbd9b12889d9f96fb6c01f94b4909e" title="Makes a frame independent of any static storage.">ast_frisolate</a>(fr))) {
<a name="l00708"></a>00708       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l00709"></a>00709       <span class="keywordflow">return</span> NULL;
<a name="l00710"></a>00710    }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712    <span class="keywordflow">if</span> (new_fr != fr) {
<a name="l00713"></a>00713       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l00714"></a>00714       fr = new_fr;
<a name="l00715"></a>00715    }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717    <span class="keywordflow">return</span> fr;
<a name="l00718"></a>00718 }
<a name="l00719"></a>00719 
<a name="l00720"></a><a class="code" href="file_8c.html#a962bc31d7a953b0a0290c72b168d41a7">00720</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="file_8h.html#a962bc31d7a953b0a0290c72b168d41a7" title="Read a frame from a filestream.">ast_readframe</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l00721"></a>00721 {
<a name="l00722"></a>00722    <span class="keywordtype">int</span> whennext = 0;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a3d11f27997994d366d52d54a084ec944">read_frame</a>(s, &amp;whennext);
<a name="l00725"></a>00725 }
<a name="l00726"></a>00726 
<a name="l00727"></a><a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7">00727</a> <span class="keyword">enum</span> <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7">fsread_res</a> {
<a name="l00728"></a><a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7a51689576f6677be835337676977f6d3b">00728</a>    <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7a51689576f6677be835337676977f6d3b">FSREAD_FAILURE</a>,
<a name="l00729"></a><a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7a949ffc736fc694146f20c7ab3c26b3f5">00729</a>    <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7a949ffc736fc694146f20c7ab3c26b3f5">FSREAD_SUCCESS_SCHED</a>,
<a name="l00730"></a><a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7aed05dcad19f8741d107494ccf0bd2674">00730</a>    <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7aed05dcad19f8741d107494ccf0bd2674">FSREAD_SUCCESS_NOSCHED</a>,
<a name="l00731"></a>00731 };
<a name="l00732"></a>00732 
<a name="l00733"></a>00733 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#a96cb704a3da3fbee98696c7a89850a37">ast_fsread_audio</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>);
<a name="l00734"></a>00734 
<a name="l00735"></a><a class="code" href="file_8c.html#aa6782e0130a721c4eeb51d2d10d791f8">00735</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7">fsread_res</a> <a class="code" href="file_8c.html#aa6782e0130a721c4eeb51d2d10d791f8">ast_readaudio_callback</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l00736"></a>00736 {
<a name="l00737"></a>00737    <span class="keywordtype">int</span> whennext = 0;
<a name="l00738"></a>00738 
<a name="l00739"></a>00739    <span class="keywordflow">while</span> (!whennext) {
<a name="l00740"></a>00740       <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *fr;
<a name="l00741"></a>00741 
<a name="l00742"></a>00742       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__filestream.html#afa3ba2491683e48895a1e174f7bd7431">orig_chan_name</a> &amp;&amp; strcasecmp(s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;name, s-&gt;<a class="code" href="structast__filestream.html#afa3ba2491683e48895a1e174f7bd7431">orig_chan_name</a>)) {
<a name="l00743"></a>00743          <span class="keywordflow">goto</span> return_failure;
<a name="l00744"></a>00744       }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746       fr = <a class="code" href="file_8c.html#a3d11f27997994d366d52d54a084ec944">read_frame</a>(s, &amp;whennext);
<a name="l00747"></a>00747 
<a name="l00748"></a>00748       <span class="keywordflow">if</span> (!fr <span class="comment">/* stream complete */</span> || <a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, fr) <span class="comment">/* error writing */</span>) {
<a name="l00749"></a>00749          <span class="keywordflow">if</span> (fr) {
<a name="l00750"></a>00750             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to write frame\n&quot;</span>);
<a name="l00751"></a>00751             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l00752"></a>00752          }
<a name="l00753"></a>00753          <span class="keywordflow">goto</span> return_failure;
<a name="l00754"></a>00754       } 
<a name="l00755"></a>00755 
<a name="l00756"></a>00756       <span class="keywordflow">if</span> (fr) {
<a name="l00757"></a>00757          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l00758"></a>00758       }
<a name="l00759"></a>00759    }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761    <span class="keywordflow">if</span> (whennext != s-&gt;<a class="code" href="structast__filestream.html#a486275f508390f690dcd44b31e4d0e87">lasttimeout</a>) {
<a name="l00762"></a>00762       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a31160ea68032ecf93ec55a3127edd2f9">timingfd</a> &gt; -1) {
<a name="l00763"></a>00763          <span class="keywordtype">float</span> samp_rate = (float) <a class="code" href="frame_8h.html#a29a7b93f4295966d4d441e91bff2b01e" title="Get the sample rate for a given format.">ast_format_rate</a>(s-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a>);
<a name="l00764"></a>00764          <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rate;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766          rate = (<span class="keywordtype">unsigned</span> int) roundf(samp_rate / ((<span class="keywordtype">float</span>) whennext));
<a name="l00767"></a>00767 
<a name="l00768"></a>00768          <a class="code" href="channel_8h.html#abb39926813ff8874f8e453ca04307e53" title="Enable or disable timer ticks for a channel.">ast_settimeout</a>(s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, rate, <a class="code" href="file_8c.html#a96cb704a3da3fbee98696c7a89850a37">ast_fsread_audio</a>, s);
<a name="l00769"></a>00769       } <span class="keywordflow">else</span> {
<a name="l00770"></a>00770          s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a7de986d04c859684e7754ac888e18532">streamid</a> = <a class="code" href="sched_8h.html#a97176531282ac4e70aa107b2e8ee5543" title="Adds a scheduled event Schedule an event to take place at some point in the future...">ast_sched_add</a>(s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, 
<a name="l00771"></a>00771             whennext / (<a class="code" href="frame_8h.html#a29a7b93f4295966d4d441e91bff2b01e" title="Get the sample rate for a given format.">ast_format_rate</a>(s-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a>) / 1000), <a class="code" href="file_8c.html#a96cb704a3da3fbee98696c7a89850a37">ast_fsread_audio</a>, s);
<a name="l00772"></a>00772       }
<a name="l00773"></a>00773       s-&gt;<a class="code" href="structast__filestream.html#a486275f508390f690dcd44b31e4d0e87">lasttimeout</a> = whennext;
<a name="l00774"></a>00774       <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7aed05dcad19f8741d107494ccf0bd2674">FSREAD_SUCCESS_NOSCHED</a>;
<a name="l00775"></a>00775    }
<a name="l00776"></a>00776    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7a949ffc736fc694146f20c7ab3c26b3f5">FSREAD_SUCCESS_SCHED</a>;
<a name="l00777"></a>00777 
<a name="l00778"></a>00778 return_failure:
<a name="l00779"></a>00779    s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a7de986d04c859684e7754ac888e18532">streamid</a> = -1;
<a name="l00780"></a>00780    <a class="code" href="channel_8h.html#abb39926813ff8874f8e453ca04307e53" title="Enable or disable timer ticks for a channel.">ast_settimeout</a>(s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, 0, NULL, NULL);
<a name="l00781"></a>00781    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7a51689576f6677be835337676977f6d3b">FSREAD_FAILURE</a>;
<a name="l00782"></a>00782 }
<a name="l00783"></a>00783 
<a name="l00784"></a><a class="code" href="file_8c.html#a96cb704a3da3fbee98696c7a89850a37">00784</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#a96cb704a3da3fbee98696c7a89850a37">ast_fsread_audio</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>)
<a name="l00785"></a>00785 {
<a name="l00786"></a>00786    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs = (<span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *)data;
<a name="l00787"></a>00787    <span class="keyword">enum</span> <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7">fsread_res</a> res;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789    res = <a class="code" href="file_8c.html#aa6782e0130a721c4eeb51d2d10d791f8">ast_readaudio_callback</a>(fs);
<a name="l00790"></a>00790 
<a name="l00791"></a>00791    <span class="keywordflow">if</span> (res == <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7a949ffc736fc694146f20c7ab3c26b3f5">FSREAD_SUCCESS_SCHED</a>)
<a name="l00792"></a>00792       <span class="keywordflow">return</span> 1;
<a name="l00793"></a>00793    
<a name="l00794"></a>00794    <span class="keywordflow">return</span> 0;
<a name="l00795"></a>00795 }
<a name="l00796"></a>00796 
<a name="l00797"></a>00797 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#a3a9125b21f4ad00a14edbbfeaebace35">ast_fsread_video</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data);
<a name="l00798"></a>00798 
<a name="l00799"></a><a class="code" href="file_8c.html#af8b623c146b07dbc4a96be4d8adbcfc4">00799</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7">fsread_res</a> <a class="code" href="file_8c.html#af8b623c146b07dbc4a96be4d8adbcfc4">ast_readvideo_callback</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l00800"></a>00800 {
<a name="l00801"></a>00801    <span class="keywordtype">int</span> whennext = 0;
<a name="l00802"></a>00802 
<a name="l00803"></a>00803    <span class="keywordflow">while</span> (!whennext) {
<a name="l00804"></a>00804       <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *fr = <a class="code" href="file_8c.html#a3d11f27997994d366d52d54a084ec944">read_frame</a>(s, &amp;whennext);
<a name="l00805"></a>00805 
<a name="l00806"></a>00806       <span class="keywordflow">if</span> (!fr <span class="comment">/* stream complete */</span> || <a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, fr) <span class="comment">/* error writing */</span>) {
<a name="l00807"></a>00807          <span class="keywordflow">if</span> (fr) {
<a name="l00808"></a>00808             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to write frame\n&quot;</span>);
<a name="l00809"></a>00809             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l00810"></a>00810          }
<a name="l00811"></a>00811          s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a3b898697f8133bfc6b3e23906b7d6877">vstreamid</a> = -1;
<a name="l00812"></a>00812          <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7a51689576f6677be835337676977f6d3b">FSREAD_FAILURE</a>;
<a name="l00813"></a>00813       }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815       <span class="keywordflow">if</span> (fr) {
<a name="l00816"></a>00816          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l00817"></a>00817       }
<a name="l00818"></a>00818    }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820    <span class="keywordflow">if</span> (whennext != s-&gt;<a class="code" href="structast__filestream.html#a486275f508390f690dcd44b31e4d0e87">lasttimeout</a>) {
<a name="l00821"></a>00821       s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a3b898697f8133bfc6b3e23906b7d6877">vstreamid</a> = <a class="code" href="sched_8h.html#a97176531282ac4e70aa107b2e8ee5543" title="Adds a scheduled event Schedule an event to take place at some point in the future...">ast_sched_add</a>(s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, 
<a name="l00822"></a>00822          whennext / (<a class="code" href="frame_8h.html#a29a7b93f4295966d4d441e91bff2b01e" title="Get the sample rate for a given format.">ast_format_rate</a>(s-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a>) / 1000), 
<a name="l00823"></a>00823          <a class="code" href="file_8c.html#a3a9125b21f4ad00a14edbbfeaebace35">ast_fsread_video</a>, s);
<a name="l00824"></a>00824       s-&gt;<a class="code" href="structast__filestream.html#a486275f508390f690dcd44b31e4d0e87">lasttimeout</a> = whennext;
<a name="l00825"></a>00825       <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7aed05dcad19f8741d107494ccf0bd2674">FSREAD_SUCCESS_NOSCHED</a>;
<a name="l00826"></a>00826    }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7a949ffc736fc694146f20c7ab3c26b3f5">FSREAD_SUCCESS_SCHED</a>;
<a name="l00829"></a>00829 }
<a name="l00830"></a>00830 
<a name="l00831"></a><a class="code" href="file_8c.html#a3a9125b21f4ad00a14edbbfeaebace35">00831</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#a3a9125b21f4ad00a14edbbfeaebace35">ast_fsread_video</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>)
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs = (<span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *)data;
<a name="l00834"></a>00834    <span class="keyword">enum</span> <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7">fsread_res</a> res;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836    res = <a class="code" href="file_8c.html#af8b623c146b07dbc4a96be4d8adbcfc4">ast_readvideo_callback</a>(fs);
<a name="l00837"></a>00837 
<a name="l00838"></a>00838    <span class="keywordflow">if</span> (res == <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7a949ffc736fc694146f20c7ab3c26b3f5">FSREAD_SUCCESS_SCHED</a>)
<a name="l00839"></a>00839       <span class="keywordflow">return</span> 1;
<a name="l00840"></a>00840    
<a name="l00841"></a>00841    <span class="keywordflow">return</span> 0;
<a name="l00842"></a>00842 }
<a name="l00843"></a>00843 
<a name="l00844"></a><a class="code" href="file_8c.html#a618e3120b6d019312ef2d617d9f14571">00844</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#a618e3120b6d019312ef2d617d9f14571" title="Applys a open stream to a channel.">ast_applystream</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l00845"></a>00845 {
<a name="l00846"></a>00846    s-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = chan;
<a name="l00847"></a>00847    <span class="keywordflow">return</span> 0;
<a name="l00848"></a>00848 }
<a name="l00849"></a>00849 
<a name="l00850"></a><a class="code" href="file_8c.html#ad59224750b8b617f9590b28b88457b14">00850</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#ad59224750b8b617f9590b28b88457b14" title="Play a open stream on a channel.">ast_playstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l00851"></a>00851 {
<a name="l00852"></a>00852    <span class="keyword">enum</span> <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7">fsread_res</a> res;
<a name="l00853"></a>00853 
<a name="l00854"></a>00854    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a> &amp; <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a>)
<a name="l00855"></a>00855       res = <a class="code" href="file_8c.html#aa6782e0130a721c4eeb51d2d10d791f8">ast_readaudio_callback</a>(s);
<a name="l00856"></a>00856    <span class="keywordflow">else</span>
<a name="l00857"></a>00857       res = <a class="code" href="file_8c.html#af8b623c146b07dbc4a96be4d8adbcfc4">ast_readvideo_callback</a>(s);
<a name="l00858"></a>00858 
<a name="l00859"></a>00859    <span class="keywordflow">return</span> (res == <a class="code" href="file_8c.html#a0245c792fdf4fe895383125a79000fa7a51689576f6677be835337676977f6d3b">FSREAD_FAILURE</a>) ? -1 : 0;
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 
<a name="l00862"></a><a class="code" href="file_8c.html#a36f6bba05952162d5d1ee7fb9819bd07">00862</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs, off_t sample_offset, <span class="keywordtype">int</span> whence)
<a name="l00863"></a>00863 {
<a name="l00864"></a>00864    <span class="keywordflow">return</span> fs-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#ace04d77265c68620f1f1f7c2c4eb4123">seek</a>(fs, sample_offset, whence);
<a name="l00865"></a>00865 }
<a name="l00866"></a>00866 
<a name="l00867"></a><a class="code" href="file_8c.html#aa647ac352a00b559131f90ffffea2c3c">00867</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#aa647ac352a00b559131f90ffffea2c3c" title="Trunc stream at current location.">ast_truncstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs)
<a name="l00868"></a>00868 {
<a name="l00869"></a>00869    <span class="keywordflow">return</span> fs-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a81ae1164851a9963c1680ee92436ce91">trunc</a>(fs);
<a name="l00870"></a>00870 }
<a name="l00871"></a>00871 
<a name="l00872"></a><a class="code" href="file_8c.html#a01771a318e7adea51499040f27b4278a">00872</a> off_t <a class="code" href="file_8h.html#a01771a318e7adea51499040f27b4278a" title="Tell where we are in a stream.">ast_tellstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs)
<a name="l00873"></a>00873 {
<a name="l00874"></a>00874    <span class="keywordflow">return</span> fs-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#af6d9675f12feb1f1bca6b99c35ba6d8a">tell</a>(fs);
<a name="l00875"></a>00875 }
<a name="l00876"></a>00876 
<a name="l00877"></a><a class="code" href="file_8c.html#ac2137b5da91f3408f86d580952f32e94">00877</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#ac2137b5da91f3408f86d580952f32e94" title="Fast forward stream ms.">ast_stream_fastforward</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs, off_t ms)
<a name="l00878"></a>00878 {
<a name="l00879"></a>00879    <span class="keywordflow">return</span> <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(fs, ms * <a class="code" href="asterisk_8h.html#ab2dba0d8b577d63452ed65647bb22a3f">DEFAULT_SAMPLES_PER_MS</a>, SEEK_CUR);
<a name="l00880"></a>00880 }
<a name="l00881"></a>00881 
<a name="l00882"></a><a class="code" href="file_8c.html#a4c7c02a659b09bb06dd63e1f42692666">00882</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#a4c7c02a659b09bb06dd63e1f42692666" title="Rewind stream ms.">ast_stream_rewind</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs, off_t ms)
<a name="l00883"></a>00883 {
<a name="l00884"></a>00884    <span class="keywordflow">return</span> <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(fs, -ms * <a class="code" href="asterisk_8h.html#ab2dba0d8b577d63452ed65647bb22a3f">DEFAULT_SAMPLES_PER_MS</a>, SEEK_CUR);
<a name="l00885"></a>00885 }
<a name="l00886"></a>00886 
<a name="l00887"></a><a class="code" href="file_8c.html#ab53bd2c3c55d509790c7f7620aac6373">00887</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)
<a name="l00888"></a>00888 {
<a name="l00889"></a>00889    <span class="comment">/* This used to destroy the filestream, but it now just decrements a refcount.</span>
<a name="l00890"></a>00890 <span class="comment">    * We need to force the stream to quit queuing frames now, because we might</span>
<a name="l00891"></a>00891 <span class="comment">    * change the writeformat, which could result in a subsequent write error, if</span>
<a name="l00892"></a>00892 <span class="comment">    * the format is different. */</span>
<a name="l00893"></a>00893 
<a name="l00894"></a>00894    <span class="comment">/* Stop a running stream if there is one */</span>
<a name="l00895"></a>00895    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l00896"></a>00896       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a> &lt; <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a>) {
<a name="l00897"></a>00897          f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> = NULL;
<a name="l00898"></a>00898          <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a7de986d04c859684e7754ac888e18532">streamid</a>);
<a name="l00899"></a>00899          <a class="code" href="channel_8h.html#abb39926813ff8874f8e453ca04307e53" title="Enable or disable timer ticks for a channel.">ast_settimeout</a>(f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, 0, NULL, NULL);
<a name="l00900"></a>00900       } <span class="keywordflow">else</span> {
<a name="l00901"></a>00901          f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#ad224fea293daa62d4fba90f86c3503ee">vstream</a> = NULL;
<a name="l00902"></a>00902          <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, f-&gt;<a class="code" href="structast__filestream.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a3b898697f8133bfc6b3e23906b7d6877">vstreamid</a>);
<a name="l00903"></a>00903       }
<a name="l00904"></a>00904    }
<a name="l00905"></a>00905 
<a name="l00906"></a>00906    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(f, -1);
<a name="l00907"></a>00907    <span class="keywordflow">return</span> 0;
<a name="l00908"></a>00908 }
<a name="l00909"></a>00909 
<a name="l00910"></a>00910 
<a name="l00911"></a>00911 <span class="comment">/*</span>
<a name="l00912"></a>00912 <span class="comment"> * Look the various language-specific places where a file could exist.</span>
<a name="l00913"></a>00913 <span class="comment"> */</span>
<a name="l00914"></a><a class="code" href="file_8c.html#ab9b8ab8e5ee34c9b4da25779255cafde">00914</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang)
<a name="l00915"></a>00915 {
<a name="l00916"></a>00916    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l00917"></a>00917    <span class="keywordtype">int</span> buflen;
<a name="l00918"></a>00918 
<a name="l00919"></a>00919    <span class="keywordflow">if</span> (preflang == NULL)
<a name="l00920"></a>00920       preflang = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00921"></a>00921    buflen = strlen(preflang) + strlen(filename) + 4;  <span class="comment">/* room for everything */</span>
<a name="l00922"></a>00922    buf = alloca(buflen);
<a name="l00923"></a>00923    <span class="keywordflow">if</span> (buf == NULL)
<a name="l00924"></a>00924       <span class="keywordflow">return</span> 0;
<a name="l00925"></a>00925    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a8306f2512acb0dfd082c61a023cefe0c" title="helper routine to locate a file with a given format and language preference. Try...">fileexists_core</a>(filename, fmt, preflang, buf, buflen);
<a name="l00926"></a>00926 }
<a name="l00927"></a>00927 
<a name="l00928"></a><a class="code" href="file_8c.html#adb15d6efecc1a13b8835bee6d3562ddb">00928</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>)
<a name="l00929"></a>00929 {
<a name="l00930"></a>00930    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#ae45ebf66fbe68ddba09480cf2e89ce71" title="perform various actions on a file. Second argument arg2 depends on the command: unused...">ast_filehelper</a>(filename, NULL, fmt, <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a92f147f69db5353fd464f636eaf02904">ACTION_DELETE</a>);
<a name="l00931"></a>00931 }
<a name="l00932"></a>00932 
<a name="l00933"></a><a class="code" href="file_8c.html#a846dc319b598ef3f0ae9b0c6152e27ba">00933</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba" title="Renames a file.">ast_filerename</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename2, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>)
<a name="l00934"></a>00934 {
<a name="l00935"></a>00935    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#ae45ebf66fbe68ddba09480cf2e89ce71" title="perform various actions on a file. Second argument arg2 depends on the command: unused...">ast_filehelper</a>(filename, filename2, fmt, <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01ae266c94c6d3f3d0940c34c798e5842a6">ACTION_RENAME</a>);
<a name="l00936"></a>00936 }
<a name="l00937"></a>00937 
<a name="l00938"></a><a class="code" href="file_8c.html#af927e220efdaacab3041f5046ea2973b">00938</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#aab7814972ae21f8cc68e1d62b97fc88b" title="Copies a file.">ast_filecopy</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename2, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>)
<a name="l00939"></a>00939 {
<a name="l00940"></a>00940    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#ae45ebf66fbe68ddba09480cf2e89ce71" title="perform various actions on a file. Second argument arg2 depends on the command: unused...">ast_filehelper</a>(filename, filename2, fmt, <a class="code" href="file_8c.html#a8944b5bc4c79736a07589a3761113d01a7930542f31154bb3b8a33654af6cfd4f">ACTION_COPY</a>);
<a name="l00941"></a>00941 }
<a name="l00942"></a>00942 
<a name="l00943"></a><a class="code" href="file_8c.html#a0e0d3e6f2bebe7f68fd264438e0d2059">00943</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang)
<a name="l00944"></a>00944 {
<a name="l00945"></a>00945    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs;
<a name="l00946"></a>00946    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="structast__filestream.html#a084d8f087c50442f51245ec3333abac4">vfs</a>=NULL;
<a name="l00947"></a>00947    <span class="keywordtype">char</span> <a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>[256];
<a name="l00948"></a>00948    <span class="keywordtype">int</span> seekattempt;
<a name="l00949"></a>00949    <span class="keywordtype">int</span> res;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951    fs = <a class="code" href="file_8h.html#ad85c951fa1d6988d2d7e169833a951a8" title="Opens stream for use in seeking, playing.">ast_openstream</a>(chan, filename, preflang);
<a name="l00952"></a>00952    <span class="keywordflow">if</span> (!fs) {
<a name="l00953"></a>00953       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open %s (format %s): %s\n&quot;</span>, filename, <a class="code" href="frame_8h.html#a37cdc7e78686b0bfa4e47e645f782b30" title="Get the names of a set of formats.">ast_getformatname_multiple</a>(fmt, <span class="keyword">sizeof</span>(fmt), chan-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>), strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00954"></a>00954       <span class="keywordflow">return</span> -1;
<a name="l00955"></a>00955    }
<a name="l00956"></a>00956 
<a name="l00957"></a>00957    <span class="comment">/* check to see if there is any data present (not a zero length file),</span>
<a name="l00958"></a>00958 <span class="comment">    * done this way because there is no where for ast_openstream_full to</span>
<a name="l00959"></a>00959 <span class="comment">    * return the file had no data. */</span>
<a name="l00960"></a>00960    seekattempt = fseek(fs-&gt;<a class="code" href="structast__filestream.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>, -1, SEEK_END);
<a name="l00961"></a>00961    <span class="keywordflow">if</span> (!seekattempt)
<a name="l00962"></a>00962       <a class="code" href="file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07" title="Seeks into stream.">ast_seekstream</a>(fs, 0, SEEK_SET);
<a name="l00963"></a>00963    <span class="keywordflow">else</span>
<a name="l00964"></a>00964       <span class="keywordflow">return</span> 0;
<a name="l00965"></a>00965 
<a name="l00966"></a>00966    vfs = <a class="code" href="file_8h.html#aeed49fff2d6008a89f996230988d944d" title="Opens stream for use in seeking, playing.">ast_openvstream</a>(chan, filename, preflang);
<a name="l00967"></a>00967    <span class="keywordflow">if</span> (vfs) {
<a name="l00968"></a>00968       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Ooh, found a video stream, too, format %s\n&quot;</span>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(vfs-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a>-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a>));
<a name="l00969"></a>00969    }
<a name="l00970"></a>00970 
<a name="l00971"></a>00971    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a44e6b334058bf9555fd4b834ad532046">AST_FLAG_MASQ_NOSTREAM</a>))
<a name="l00972"></a>00972       fs-&gt;<a class="code" href="structast__filestream.html#afa3ba2491683e48895a1e174f7bd7431">orig_chan_name</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(chan-&gt;name);
<a name="l00973"></a>00973    <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a618e3120b6d019312ef2d617d9f14571" title="Applys a open stream to a channel.">ast_applystream</a>(chan, fs))
<a name="l00974"></a>00974       <span class="keywordflow">return</span> -1;
<a name="l00975"></a>00975    <span class="keywordflow">if</span> (vfs &amp;&amp; <a class="code" href="file_8h.html#a618e3120b6d019312ef2d617d9f14571" title="Applys a open stream to a channel.">ast_applystream</a>(chan, vfs))
<a name="l00976"></a>00976       <span class="keywordflow">return</span> -1;
<a name="l00977"></a>00977    res = <a class="code" href="file_8h.html#ad59224750b8b617f9590b28b88457b14" title="Play a open stream on a channel.">ast_playstream</a>(fs);
<a name="l00978"></a>00978    <span class="keywordflow">if</span> (!res &amp;&amp; vfs)
<a name="l00979"></a>00979       res = <a class="code" href="file_8h.html#ad59224750b8b617f9590b28b88457b14" title="Play a open stream on a channel.">ast_playstream</a>(vfs);
<a name="l00980"></a>00980    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;&lt;%s&gt; Playing &apos;%s.%s&apos; (language &apos;%s&apos;)\n&quot;</span>, chan-&gt;name, filename, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>), preflang ? preflang : <span class="stringliteral">&quot;default&quot;</span>);
<a name="l00981"></a>00981 
<a name="l00982"></a>00982    <span class="keywordflow">return</span> res;
<a name="l00983"></a>00983 }
<a name="l00984"></a>00984 
<a name="l00985"></a><a class="code" href="file_8c.html#ad572060ea434390db3d1ccde4511dfcd">00985</a> <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="file_8h.html#ad572060ea434390db3d1ccde4511dfcd" title="Starts reading from a file.">ast_readfile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael__lex_8c.html#a43be22b7a1b528eaf759e034ec581543">comment</a>, <span class="keywordtype">int</span> <a class="code" href="structast__filestream.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>, <span class="keywordtype">int</span> check, mode_t <a class="code" href="structast__filestream.html#adc8d3cf511ceb277aea0cfa1cd027c59">mode</a>)
<a name="l00986"></a>00986 {
<a name="l00987"></a>00987    FILE *bfile;
<a name="l00988"></a>00988    <span class="keyword">struct </span><a class="code" href="structast__format.html" title="Each supported file format is described by the following structure.">ast_format</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00989"></a>00989    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs = NULL;
<a name="l00990"></a>00990    <span class="keywordtype">char</span> *fn;
<a name="l00991"></a>00991    <span class="keywordtype">int</span> format_found = 0;   
<a name="l00992"></a>00992 
<a name="l00993"></a>00993    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l00994"></a>00994 
<a name="l00995"></a>00995    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structformats.html">formats</a>, f, list) {
<a name="l00996"></a>00996       fs = NULL;
<a name="l00997"></a>00997       <span class="keywordflow">if</span> (!<a class="code" href="file_8c.html#a553ad7eb5306fd161fae25fa17c665ef">exts_compare</a>(f-&gt;<a class="code" href="structast__format.html#ade71f534a49925f1955a1598556219e2">exts</a>, type))
<a name="l00998"></a>00998          <span class="keywordflow">continue</span>;
<a name="l00999"></a>00999       <span class="keywordflow">else</span> 
<a name="l01000"></a>01000          format_found = 1;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002       fn = <a class="code" href="file_8c.html#a2a836416f6627399f3b75ef2705bcd89" title="construct a filename. Absolute pathnames are preserved, relative names are prefixed...">build_filename</a>(filename, type);
<a name="l01003"></a>01003       <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l01004"></a>01004       bfile = fopen(fn, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l01005"></a>01005 
<a name="l01006"></a>01006       <span class="keywordflow">if</span> (!bfile || (fs = <a class="code" href="file_8c.html#a6c638cbfc5c6d1f62231935f80a8986a">get_filestream</a>(f, bfile)) == NULL || <a class="code" href="file_8c.html#ac17ab5a9432e8fbe75d7968221897716">open_wrapper</a>(fs) ) {
<a name="l01007"></a>01007          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open %s\n&quot;</span>, fn);
<a name="l01008"></a>01008          <span class="keywordflow">if</span> (fs) {
<a name="l01009"></a>01009             <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(fs);
<a name="l01010"></a>01010          }
<a name="l01011"></a>01011          fs = NULL;
<a name="l01012"></a>01012          bfile = NULL;
<a name="l01013"></a>01013          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fn);
<a name="l01014"></a>01014          <span class="keywordflow">break</span>;            
<a name="l01015"></a>01015       }
<a name="l01016"></a>01016       <span class="comment">/* found it */</span>
<a name="l01017"></a>01017       fs-&gt;<a class="code" href="structast__filestream.html#ad98134a98f3e3e3b5611a5fd2117e8e4">trans</a> = NULL;
<a name="l01018"></a>01018       fs-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a> = f;
<a name="l01019"></a>01019       fs-&gt;<a class="code" href="structast__filestream.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> = flags;
<a name="l01020"></a>01020       fs-&gt;<a class="code" href="structast__filestream.html#adc8d3cf511ceb277aea0cfa1cd027c59">mode</a> = mode;
<a name="l01021"></a>01021       fs-&gt;<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(filename);
<a name="l01022"></a>01022       fs-&gt;<a class="code" href="structast__filestream.html#a084d8f087c50442f51245ec3333abac4">vfs</a> = NULL;
<a name="l01023"></a>01023       <span class="keywordflow">break</span>;
<a name="l01024"></a>01024    }
<a name="l01025"></a>01025 
<a name="l01026"></a>01026    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l01027"></a>01027    <span class="keywordflow">if</span> (!format_found)
<a name="l01028"></a>01028       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such format &apos;%s&apos;\n&quot;</span>, type);
<a name="l01029"></a>01029 
<a name="l01030"></a>01030    <span class="keywordflow">return</span> fs;
<a name="l01031"></a>01031 }
<a name="l01032"></a>01032 
<a name="l01033"></a><a class="code" href="file_8c.html#a964f8ef393c07609d7b9e02937faed52">01033</a> <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="file_8h.html#a964f8ef393c07609d7b9e02937faed52" title="Starts writing a file.">ast_writefile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael__lex_8c.html#a43be22b7a1b528eaf759e034ec581543">comment</a>, <span class="keywordtype">int</span> <a class="code" href="structast__filestream.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>, <span class="keywordtype">int</span> check, mode_t <a class="code" href="structast__filestream.html#adc8d3cf511ceb277aea0cfa1cd027c59">mode</a>)
<a name="l01034"></a>01034 {
<a name="l01035"></a>01035    <span class="keywordtype">int</span> fd, myflags = 0;
<a name="l01036"></a>01036    <span class="comment">/* compiler claims this variable can be used before initialization... */</span>
<a name="l01037"></a>01037    FILE *bfile = NULL;
<a name="l01038"></a>01038    <span class="keyword">struct </span><a class="code" href="structast__format.html" title="Each supported file format is described by the following structure.">ast_format</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l01039"></a>01039    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *fs = NULL;
<a name="l01040"></a>01040    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a> = NULL;
<a name="l01041"></a>01041    <span class="keywordtype">size_t</span> size = 0;
<a name="l01042"></a>01042    <span class="keywordtype">int</span> format_found = 0;
<a name="l01043"></a>01043 
<a name="l01044"></a>01044    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l01045"></a>01045 
<a name="l01046"></a>01046    <span class="comment">/* set the O_TRUNC flag if and only if there is no O_APPEND specified */</span>
<a name="l01047"></a>01047    <span class="comment">/* We really can&apos;t use O_APPEND as it will break WAV header updates */</span>
<a name="l01048"></a>01048    <span class="keywordflow">if</span> (flags &amp; O_APPEND) { 
<a name="l01049"></a>01049       flags &amp;= ~O_APPEND;
<a name="l01050"></a>01050    } <span class="keywordflow">else</span> {
<a name="l01051"></a>01051       myflags = O_TRUNC;
<a name="l01052"></a>01052    }
<a name="l01053"></a>01053    
<a name="l01054"></a>01054    myflags |= O_WRONLY | O_CREAT;
<a name="l01055"></a>01055 
<a name="l01056"></a>01056    <span class="comment">/* XXX need to fix this - we should just do the fopen,</span>
<a name="l01057"></a>01057 <span class="comment">    * not open followed by fdopen()</span>
<a name="l01058"></a>01058 <span class="comment">    */</span>
<a name="l01059"></a>01059    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structformats.html">formats</a>, f, list) {
<a name="l01060"></a>01060       <span class="keywordtype">char</span> *fn, *orig_fn = NULL;
<a name="l01061"></a>01061       <span class="keywordflow">if</span> (fs)
<a name="l01062"></a>01062          <span class="keywordflow">break</span>;
<a name="l01063"></a>01063 
<a name="l01064"></a>01064       <span class="keywordflow">if</span> (!<a class="code" href="file_8c.html#a553ad7eb5306fd161fae25fa17c665ef">exts_compare</a>(f-&gt;<a class="code" href="structast__format.html#ade71f534a49925f1955a1598556219e2">exts</a>, type))
<a name="l01065"></a>01065          <span class="keywordflow">continue</span>;
<a name="l01066"></a>01066       <span class="keywordflow">else</span>
<a name="l01067"></a>01067          format_found = 1;
<a name="l01068"></a>01068 
<a name="l01069"></a>01069       fn = <a class="code" href="file_8c.html#a2a836416f6627399f3b75ef2705bcd89" title="construct a filename. Absolute pathnames are preserved, relative names are prefixed...">build_filename</a>(filename, type);
<a name="l01070"></a>01070       fd = open(fn, flags | myflags, mode);
<a name="l01071"></a>01071       <span class="keywordflow">if</span> (fd &gt; -1) {
<a name="l01072"></a>01072          <span class="comment">/* fdopen() the resulting file stream */</span>
<a name="l01073"></a>01073          bfile = fdopen(fd, ((flags | myflags) &amp; O_RDWR) ? <span class="stringliteral">&quot;w+&quot;</span> : <span class="stringliteral">&quot;w&quot;</span>);
<a name="l01074"></a>01074          <span class="keywordflow">if</span> (!bfile) {
<a name="l01075"></a>01075             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Whoa, fdopen failed: %s!\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01076"></a>01076             close(fd);
<a name="l01077"></a>01077             fd = -1;
<a name="l01078"></a>01078          }
<a name="l01079"></a>01079       }
<a name="l01080"></a>01080       
<a name="l01081"></a>01081       <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a3472349abbba9eb4a158cdf4299bf740">ast_opt_cache_record_files</a> &amp;&amp; (fd &gt; -1)) {
<a name="l01082"></a>01082          <span class="keywordtype">char</span> *c;
<a name="l01083"></a>01083 
<a name="l01084"></a>01084          fclose(bfile); <span class="comment">/* this also closes fd */</span>
<a name="l01085"></a>01085          <span class="comment">/*</span>
<a name="l01086"></a>01086 <span class="comment">           We touch orig_fn just as a place-holder so other things (like vmail) see the file is there.</span>
<a name="l01087"></a>01087 <span class="comment">           What we are really doing is writing to record_cache_dir until we are done then we will mv the file into place.</span>
<a name="l01088"></a>01088 <span class="comment">         */</span>
<a name="l01089"></a>01089          orig_fn = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(fn);
<a name="l01090"></a>01090          <span class="keywordflow">for</span> (c = fn; *c; c++)
<a name="l01091"></a>01091             <span class="keywordflow">if</span> (*c == <span class="charliteral">&apos;/&apos;</span>)
<a name="l01092"></a>01092                *c = <span class="charliteral">&apos;_&apos;</span>;
<a name="l01093"></a>01093 
<a name="l01094"></a>01094          size = strlen(fn) + strlen(<a class="code" href="options_8h.html#a08a845bf43007945cede2f5a6a62225c">record_cache_dir</a>) + 2;
<a name="l01095"></a>01095          buf = alloca(size);
<a name="l01096"></a>01096          strcpy(buf, <a class="code" href="options_8h.html#a08a845bf43007945cede2f5a6a62225c">record_cache_dir</a>);
<a name="l01097"></a>01097          strcat(buf, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l01098"></a>01098          strcat(buf, fn);
<a name="l01099"></a>01099          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fn);
<a name="l01100"></a>01100          fn = buf;
<a name="l01101"></a>01101          fd = open(fn, flags | myflags, mode);
<a name="l01102"></a>01102          <span class="keywordflow">if</span> (fd &gt; -1) {
<a name="l01103"></a>01103             <span class="comment">/* fdopen() the resulting file stream */</span>
<a name="l01104"></a>01104             bfile = fdopen(fd, ((flags | myflags) &amp; O_RDWR) ? <span class="stringliteral">&quot;w+&quot;</span> : <span class="stringliteral">&quot;w&quot;</span>);
<a name="l01105"></a>01105             <span class="keywordflow">if</span> (!bfile) {
<a name="l01106"></a>01106                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Whoa, fdopen failed: %s!\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01107"></a>01107                close(fd);
<a name="l01108"></a>01108                fd = -1;
<a name="l01109"></a>01109             }
<a name="l01110"></a>01110          }
<a name="l01111"></a>01111       }
<a name="l01112"></a>01112       <span class="keywordflow">if</span> (fd &gt; -1) {
<a name="l01113"></a>01113          <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l01114"></a>01114          fs = <a class="code" href="file_8c.html#a6c638cbfc5c6d1f62231935f80a8986a">get_filestream</a>(f, bfile);
<a name="l01115"></a>01115          <span class="keywordflow">if</span> (!fs || <a class="code" href="file_8c.html#acbe06882238f9fabfff485fefc6fa619">rewrite_wrapper</a>(fs, comment)) {
<a name="l01116"></a>01116             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to rewrite %s\n&quot;</span>, fn);
<a name="l01117"></a>01117             close(fd);
<a name="l01118"></a>01118             <span class="keywordflow">if</span> (orig_fn) {
<a name="l01119"></a>01119                unlink(fn);
<a name="l01120"></a>01120                unlink(orig_fn);
<a name="l01121"></a>01121             }
<a name="l01122"></a>01122             <span class="keywordflow">if</span> (fs) {
<a name="l01123"></a>01123                <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(fs);
<a name="l01124"></a>01124                fs = NULL;
<a name="l01125"></a>01125             }
<a name="l01126"></a>01126             <span class="keywordflow">continue</span>;
<a name="l01127"></a>01127          }
<a name="l01128"></a>01128          fs-&gt;<a class="code" href="structast__filestream.html#ad98134a98f3e3e3b5611a5fd2117e8e4">trans</a> = NULL;
<a name="l01129"></a>01129          fs-&gt;<a class="code" href="structast__filestream.html#af4e7a9f36c380991c59c9a49122de100">fmt</a> = f;
<a name="l01130"></a>01130          fs-&gt;<a class="code" href="structast__filestream.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> = flags;
<a name="l01131"></a>01131          fs-&gt;<a class="code" href="structast__filestream.html#adc8d3cf511ceb277aea0cfa1cd027c59">mode</a> = mode;
<a name="l01132"></a>01132          <span class="keywordflow">if</span> (orig_fn) {
<a name="l01133"></a>01133             fs-&gt;<a class="code" href="structast__filestream.html#a198a1121327381d95b1bb6c501e38333">realfilename</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(orig_fn);
<a name="l01134"></a>01134             fs-&gt;<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(fn);
<a name="l01135"></a>01135          } <span class="keywordflow">else</span> {
<a name="l01136"></a>01136             fs-&gt;<a class="code" href="structast__filestream.html#a198a1121327381d95b1bb6c501e38333">realfilename</a> = NULL;
<a name="l01137"></a>01137             fs-&gt;<a class="code" href="structast__filestream.html#aeac90097f29f7529968697163cea5c18">filename</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(filename);
<a name="l01138"></a>01138          }
<a name="l01139"></a>01139          fs-&gt;<a class="code" href="structast__filestream.html#a084d8f087c50442f51245ec3333abac4">vfs</a> = NULL;
<a name="l01140"></a>01140          <span class="comment">/* If truncated, we&apos;ll be at the beginning; if not truncated, then append */</span>
<a name="l01141"></a>01141 
<a name="l01142"></a>01142          <span class="keywordflow">if</span> ((fs-&gt;<a class="code" href="structast__filestream.html#a6de7f628c7786f3686214488c8edfc27">write_buffer</a> = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(32768))){
<a name="l01143"></a>01143             setvbuf(fs-&gt;<a class="code" href="structast__filestream.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>, fs-&gt;<a class="code" href="structast__filestream.html#a6de7f628c7786f3686214488c8edfc27">write_buffer</a>, _IOFBF, 32768);
<a name="l01144"></a>01144          }
<a name="l01145"></a>01145 
<a name="l01146"></a>01146          f-&gt;<a class="code" href="structast__format.html#ace04d77265c68620f1f1f7c2c4eb4123">seek</a>(fs, 0, SEEK_END);
<a name="l01147"></a>01147       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EEXIST) {
<a name="l01148"></a>01148          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open file %s: %s\n&quot;</span>, fn, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01149"></a>01149          <span class="keywordflow">if</span> (orig_fn)
<a name="l01150"></a>01150             unlink(orig_fn);
<a name="l01151"></a>01151       }
<a name="l01152"></a>01152       <span class="comment">/* if buf != NULL then fn is already free and pointing to it */</span>
<a name="l01153"></a>01153       <span class="keywordflow">if</span> (!buf)
<a name="l01154"></a>01154          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fn);
<a name="l01155"></a>01155    }
<a name="l01156"></a>01156 
<a name="l01157"></a>01157    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l01158"></a>01158 
<a name="l01159"></a>01159    <span class="keywordflow">if</span> (!format_found)
<a name="l01160"></a>01160       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such format &apos;%s&apos;\n&quot;</span>, type);
<a name="l01161"></a>01161 
<a name="l01162"></a>01162    <span class="keywordflow">return</span> fs;
<a name="l01163"></a>01163 }
<a name="l01164"></a>01164 <span class="comment"></span>
<a name="l01165"></a>01165 <span class="comment">/*!</span>
<a name="l01166"></a>01166 <span class="comment"> * \brief the core of all waitstream() functions</span>
<a name="l01167"></a>01167 <span class="comment"> */</span>
<a name="l01168"></a><a class="code" href="file_8c.html#a8498b7140122fecadf08ae1c7b2c033c">01168</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#a8498b7140122fecadf08ae1c7b2c033c" title="the core of all waitstream() functions">waitstream_core</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *breakon,
<a name="l01169"></a>01169    <span class="keyword">const</span> <span class="keywordtype">char</span> *forward, <span class="keyword">const</span> <span class="keywordtype">char</span> *reverse, <span class="keywordtype">int</span> skip_ms,
<a name="l01170"></a>01170    <span class="keywordtype">int</span> audiofd, <span class="keywordtype">int</span> cmdfd,  <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>)
<a name="l01171"></a>01171 {
<a name="l01172"></a>01172    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__filestream.html#afa3ba2491683e48895a1e174f7bd7431">orig_chan_name</a> = NULL;
<a name="l01173"></a>01173    <span class="keywordtype">int</span> err = 0;
<a name="l01174"></a>01174 
<a name="l01175"></a>01175    <span class="keywordflow">if</span> (!breakon)
<a name="l01176"></a>01176       breakon = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01177"></a>01177    <span class="keywordflow">if</span> (!forward)
<a name="l01178"></a>01178       forward = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01179"></a>01179    <span class="keywordflow">if</span> (!reverse)
<a name="l01180"></a>01180       reverse = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01181"></a>01181 
<a name="l01182"></a>01182    <span class="comment">/* Switch the channel to end DTMF frame only. waitstream_core doesn&apos;t care about the start of DTMF. */</span>
<a name="l01183"></a>01183    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a668ac945c84f50becaca2a6134e64058">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l01184"></a>01184 
<a name="l01185"></a>01185    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a44e6b334058bf9555fd4b834ad532046">AST_FLAG_MASQ_NOSTREAM</a>))
<a name="l01186"></a>01186       orig_chan_name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(c-&gt;name);
<a name="l01187"></a>01187 
<a name="l01188"></a>01188    <span class="keywordflow">while</span> (c-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>) {
<a name="l01189"></a>01189       <span class="keywordtype">int</span> res;
<a name="l01190"></a>01190       <span class="keywordtype">int</span> ms;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192       <span class="keywordflow">if</span> (orig_chan_name &amp;&amp; strcasecmp(orig_chan_name, c-&gt;name)) {
<a name="l01193"></a>01193          <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(c);
<a name="l01194"></a>01194          err = 1;
<a name="l01195"></a>01195          <span class="keywordflow">break</span>;
<a name="l01196"></a>01196       }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198       ms = <a class="code" href="sched_8h.html#a64797d66b6051095debfcdb7f790e605" title="Determines number of seconds until the next outstanding event to take place Determine...">ast_sched_wait</a>(c-&gt;<a class="code" href="structast__channel.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>);
<a name="l01199"></a>01199 
<a name="l01200"></a>01200       <span class="keywordflow">if</span> (ms &lt; 0 &amp;&amp; !c-&gt;timingfunc) {
<a name="l01201"></a>01201          <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(c);
<a name="l01202"></a>01202          <span class="keywordflow">break</span>;
<a name="l01203"></a>01203       }
<a name="l01204"></a>01204       <span class="keywordflow">if</span> (ms &lt; 0)
<a name="l01205"></a>01205          ms = 1000;
<a name="l01206"></a>01206       <span class="keywordflow">if</span> (cmdfd &lt; 0) {
<a name="l01207"></a>01207          res = <a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(c, ms);
<a name="l01208"></a>01208          <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01209"></a>01209             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Select failed (%s)\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01210"></a>01210             <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a668ac945c84f50becaca2a6134e64058">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l01211"></a>01211             <span class="keywordflow">return</span> res;
<a name="l01212"></a>01212          }
<a name="l01213"></a>01213       } <span class="keywordflow">else</span> {
<a name="l01214"></a>01214          <span class="keywordtype">int</span> outfd;
<a name="l01215"></a>01215          <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *rchan = <a class="code" href="channel_8h.html#a5e62602ca9e229304f60ab5c2b32e13b" title="Waits for activity on a group of channels.">ast_waitfor_nandfds</a>(&amp;c, 1, &amp;cmdfd, (cmdfd &gt; -1) ? 1 : 0, NULL, &amp;outfd, &amp;ms);
<a name="l01216"></a>01216          <span class="keywordflow">if</span> (!rchan &amp;&amp; (outfd &lt; 0) &amp;&amp; (ms)) {
<a name="l01217"></a>01217             <span class="comment">/* Continue */</span>
<a name="l01218"></a>01218             <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EINTR)
<a name="l01219"></a>01219                <span class="keywordflow">continue</span>;
<a name="l01220"></a>01220             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Wait failed (%s)\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01221"></a>01221             <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a668ac945c84f50becaca2a6134e64058">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l01222"></a>01222             <span class="keywordflow">return</span> -1;
<a name="l01223"></a>01223          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (outfd &gt; -1) { <span class="comment">/* this requires cmdfd set */</span>
<a name="l01224"></a>01224             <span class="comment">/* The FD we were watching has something waiting */</span>
<a name="l01225"></a>01225             <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a668ac945c84f50becaca2a6134e64058">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l01226"></a>01226             <span class="keywordflow">return</span> 1;
<a name="l01227"></a>01227          }
<a name="l01228"></a>01228          <span class="comment">/* if rchan is set, it is &apos;c&apos; */</span>
<a name="l01229"></a>01229          res = rchan ? 1 : 0; <span class="comment">/* map into &apos;res&apos; values */</span>
<a name="l01230"></a>01230       }
<a name="l01231"></a>01231       <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l01232"></a>01232          <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *fr = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(c);
<a name="l01233"></a>01233          <span class="keywordflow">if</span> (!fr) {
<a name="l01234"></a>01234             <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a668ac945c84f50becaca2a6134e64058">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l01235"></a>01235             <span class="keywordflow">return</span> -1;
<a name="l01236"></a>01236          }
<a name="l01237"></a>01237          <span class="keywordflow">switch</span> (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>) {
<a name="l01238"></a>01238          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>:
<a name="l01239"></a>01239             <span class="keywordflow">if</span> (context) {
<a name="l01240"></a>01240                <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>[2] = { fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, <span class="charliteral">&apos;\0&apos;</span> };
<a name="l01241"></a>01241                <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(c, context, exten, 1, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l01242"></a>01242                   res = fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l01243"></a>01243                   <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l01244"></a>01244                   <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a668ac945c84f50becaca2a6134e64058">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l01245"></a>01245                   <span class="keywordflow">return</span> res;
<a name="l01246"></a>01246                }
<a name="l01247"></a>01247             } <span class="keywordflow">else</span> {
<a name="l01248"></a>01248                res = fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l01249"></a>01249                <span class="keywordflow">if</span> (strchr(forward, res)) {
<a name="l01250"></a>01250                   <span class="keywordtype">int</span> eoftest;
<a name="l01251"></a>01251                   <a class="code" href="file_8h.html#ac2137b5da91f3408f86d580952f32e94" title="Fast forward stream ms.">ast_stream_fastforward</a>(c-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>, skip_ms);
<a name="l01252"></a>01252                   eoftest = fgetc(c-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>-&gt;<a class="code" href="structast__filestream.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>);
<a name="l01253"></a>01253                   <span class="keywordflow">if</span> (feof(c-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>-&gt;<a class="code" href="structast__filestream.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>)) {
<a name="l01254"></a>01254                      <a class="code" href="file_8h.html#a4c7c02a659b09bb06dd63e1f42692666" title="Rewind stream ms.">ast_stream_rewind</a>(c-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>, skip_ms);
<a name="l01255"></a>01255                   } <span class="keywordflow">else</span> {
<a name="l01256"></a>01256                      ungetc(eoftest, c-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>-&gt;<a class="code" href="structast__filestream.html#a3efb0e1a16208deecbd84c15401f7cf8">f</a>);
<a name="l01257"></a>01257                   }
<a name="l01258"></a>01258                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(reverse, res)) {
<a name="l01259"></a>01259                   <a class="code" href="file_8h.html#a4c7c02a659b09bb06dd63e1f42692666" title="Rewind stream ms.">ast_stream_rewind</a>(c-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>, skip_ms);
<a name="l01260"></a>01260                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(breakon, res)) {
<a name="l01261"></a>01261                   <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l01262"></a>01262                   <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a668ac945c84f50becaca2a6134e64058">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l01263"></a>01263                   <span class="keywordflow">return</span> res;
<a name="l01264"></a>01264                }              
<a name="l01265"></a>01265             }
<a name="l01266"></a>01266             <span class="keywordflow">break</span>;
<a name="l01267"></a>01267          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>:
<a name="l01268"></a>01268             <span class="keywordflow">switch</span> (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) {
<a name="l01269"></a>01269             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa7dac1c1896ab418c2ff351aae707fba">AST_CONTROL_HANGUP</a>:
<a name="l01270"></a>01270             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a387635982df3d2edb669a1eece92c875">AST_CONTROL_BUSY</a>:
<a name="l01271"></a>01271             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a850bb06a1702741c93a3fd67cc9637ab">AST_CONTROL_CONGESTION</a>:
<a name="l01272"></a>01272                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l01273"></a>01273                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a668ac945c84f50becaca2a6134e64058">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l01274"></a>01274                <span class="keywordflow">return</span> -1;
<a name="l01275"></a>01275             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>:
<a name="l01276"></a>01276             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a9e3135920bd5bdbfd8c57fdaaa6b1dbe">AST_CONTROL_ANSWER</a>:
<a name="l01277"></a>01277             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a417bc8ac5817cc1525a3b530abfc1528">AST_CONTROL_VIDUPDATE</a>:
<a name="l01278"></a>01278             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a009e81151b19671f42b5e84ab6a619f4">AST_CONTROL_SRCUPDATE</a>:
<a name="l01279"></a>01279             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>:
<a name="l01280"></a>01280             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>:
<a name="l01281"></a>01281             <span class="keywordflow">case</span> -1:
<a name="l01282"></a>01282                <span class="comment">/* Unimportant */</span>
<a name="l01283"></a>01283                <span class="keywordflow">break</span>;
<a name="l01284"></a>01284             <span class="keywordflow">default</span>:
<a name="l01285"></a>01285                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unexpected control subclass &apos;%d&apos;\n&quot;</span>, fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l01286"></a>01286             }
<a name="l01287"></a>01287             <span class="keywordflow">break</span>;
<a name="l01288"></a>01288          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>:
<a name="l01289"></a>01289             <span class="comment">/* Write audio if appropriate */</span>
<a name="l01290"></a>01290             <span class="keywordflow">if</span> (audiofd &gt; -1) {
<a name="l01291"></a>01291                <span class="keywordflow">if</span> (write(audiofd, fr-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, fr-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>) &lt; 0) {
<a name="l01292"></a>01292                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;write() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01293"></a>01293                }
<a name="l01294"></a>01294             }
<a name="l01295"></a>01295          <span class="keywordflow">default</span>:
<a name="l01296"></a>01296             <span class="comment">/* Ignore all others */</span>
<a name="l01297"></a>01297             <span class="keywordflow">break</span>;
<a name="l01298"></a>01298          }
<a name="l01299"></a>01299          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l01300"></a>01300       }
<a name="l01301"></a>01301       <a class="code" href="sched_8h.html#a2867b39106061847a8508bf49e38f420" title="Runs the queue.">ast_sched_runq</a>(c-&gt;<a class="code" href="structast__channel.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>);
<a name="l01302"></a>01302    }
<a name="l01303"></a>01303 
<a name="l01304"></a>01304    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a668ac945c84f50becaca2a6134e64058">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l01305"></a>01305 
<a name="l01306"></a>01306    <span class="keywordflow">return</span> (err || c-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a>) ? -1 : 0;
<a name="l01307"></a>01307 }
<a name="l01308"></a>01308 
<a name="l01309"></a><a class="code" href="file_8c.html#a42226fa82166fc67e698a77b84f3c692">01309</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#a5ce837632e3746a3af17f8311060e510" title="Same as waitstream but allows stream to be forwarded or rewound.">ast_waitstream_fr</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *breakon, <span class="keyword">const</span> <span class="keywordtype">char</span> *forward, <span class="keyword">const</span> <span class="keywordtype">char</span> *reverse, <span class="keywordtype">int</span> ms)
<a name="l01310"></a>01310 {
<a name="l01311"></a>01311    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a8498b7140122fecadf08ae1c7b2c033c" title="the core of all waitstream() functions">waitstream_core</a>(c, breakon, forward, reverse, ms,
<a name="l01312"></a>01312       -1 <span class="comment">/* no audiofd */</span>, -1 <span class="comment">/* no cmdfd */</span>, NULL <span class="comment">/* no context */</span>);
<a name="l01313"></a>01313 }
<a name="l01314"></a>01314 
<a name="l01315"></a><a class="code" href="file_8c.html#affc21cb57c6bf72a2cb7ec8a379b2137">01315</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *breakon)
<a name="l01316"></a>01316 {
<a name="l01317"></a>01317    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a8498b7140122fecadf08ae1c7b2c033c" title="the core of all waitstream() functions">waitstream_core</a>(c, breakon, NULL, NULL, 0, -1, -1, NULL);
<a name="l01318"></a>01318 }
<a name="l01319"></a>01319 
<a name="l01320"></a><a class="code" href="file_8c.html#a09fa137da8f6383a8075c1fe273f6b7b">01320</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#a3089874cd5223053f670c8499e911ec4">ast_waitstream_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *breakon, <span class="keywordtype">int</span> audiofd, <span class="keywordtype">int</span> cmdfd)
<a name="l01321"></a>01321 {
<a name="l01322"></a>01322    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a8498b7140122fecadf08ae1c7b2c033c" title="the core of all waitstream() functions">waitstream_core</a>(c, breakon, NULL, NULL, 0,
<a name="l01323"></a>01323       audiofd, cmdfd, NULL <span class="comment">/* no context */</span>);
<a name="l01324"></a>01324 }
<a name="l01325"></a>01325 
<a name="l01326"></a><a class="code" href="file_8c.html#ae6eb4e1e4576abe04a4b185688f6690c">01326</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#ae6eb4e1e4576abe04a4b185688f6690c" title="Waits for a stream to stop or digit matching a valid one digit exten to be pressed...">ast_waitstream_exten</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>)
<a name="l01327"></a>01327 {
<a name="l01328"></a>01328    <span class="comment">/* Waitstream, with return in the case of a valid 1 digit extension */</span>
<a name="l01329"></a>01329    <span class="comment">/* in the current or specified context being pressed */</span>
<a name="l01330"></a>01330 
<a name="l01331"></a>01331    <span class="keywordflow">if</span> (!context)
<a name="l01332"></a>01332       context = c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l01333"></a>01333    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a8498b7140122fecadf08ae1c7b2c033c" title="the core of all waitstream() functions">waitstream_core</a>(c, NULL, NULL, NULL, 0,
<a name="l01334"></a>01334       -1, -1, context);
<a name="l01335"></a>01335 }
<a name="l01336"></a>01336 
<a name="l01337"></a>01337 <span class="comment">/*</span>
<a name="l01338"></a>01338 <span class="comment"> * if the file name is non-empty, try to play it.</span>
<a name="l01339"></a>01339 <span class="comment"> * Return 0 if success, -1 if error, digit if interrupted by a digit.</span>
<a name="l01340"></a>01340 <span class="comment"> * If digits == &quot;&quot; then we can simply check for non-zero.</span>
<a name="l01341"></a>01341 <span class="comment"> */</span>
<a name="l01342"></a><a class="code" href="file_8c.html#a95b94a020720147325a486e210b36775">01342</a> <span class="keywordtype">int</span> <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keyword">const</span> <span class="keywordtype">char</span> *digits)
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344    <span class="keywordtype">int</span> res = 0;
<a name="l01345"></a>01345    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(file)) {
<a name="l01346"></a>01346       res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, file, chan-&gt;language);
<a name="l01347"></a>01347       <span class="keywordflow">if</span> (!res) {
<a name="l01348"></a>01348          res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, digits);
<a name="l01349"></a>01349       }
<a name="l01350"></a>01350    }
<a name="l01351"></a>01351    <span class="keywordflow">return</span> res;
<a name="l01352"></a>01352 } 
<a name="l01353"></a>01353 
<a name="l01354"></a><a class="code" href="file_8c.html#aa526fd9bb57d7d9afac2113c30d236f8">01354</a> <span class="keywordtype">char</span> *<a class="code" href="file_8h.html#aa526fd9bb57d7d9afac2113c30d236f8">ast_format_str_reduce</a>(<span class="keywordtype">char</span> *fmts)
<a name="l01355"></a>01355 {
<a name="l01356"></a>01356    <span class="keyword">struct </span><a class="code" href="structast__format.html" title="Each supported file format is described by the following structure.">ast_format</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l01357"></a>01357    <span class="keyword">struct </span><a class="code" href="structast__format.html" title="Each supported file format is described by the following structure.">ast_format</a> *fmts_ptr[<a class="code" href="file_8h.html#aa932272aad0c1610b79e9b04e54e57ea">AST_MAX_FORMATS</a>];
<a name="l01358"></a>01358    <span class="keywordtype">char</span> *fmts_str[<a class="code" href="file_8h.html#aa932272aad0c1610b79e9b04e54e57ea">AST_MAX_FORMATS</a>];
<a name="l01359"></a>01359    <span class="keywordtype">char</span> *stringp, *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>;
<a name="l01360"></a>01360    <span class="keywordtype">char</span> *orig = fmts;
<a name="l01361"></a>01361    <span class="keywordtype">int</span> i, j, x, <a class="code" href="devicestate_8c.html#abd2135e6f8a41bc900933b1985d97165">first</a>, found = 0;
<a name="l01362"></a>01362    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(fmts) + 1;
<a name="l01363"></a>01363    <span class="keywordtype">int</span> res;
<a name="l01364"></a>01364 
<a name="l01365"></a>01365    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>)) {
<a name="l01366"></a>01366       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to lock format list\n&quot;</span>);
<a name="l01367"></a>01367       <span class="keywordflow">return</span> NULL;
<a name="l01368"></a>01368    }
<a name="l01369"></a>01369 
<a name="l01370"></a>01370    stringp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(fmts);
<a name="l01371"></a>01371 
<a name="l01372"></a>01372    <span class="keywordflow">for</span> (x = 0; (type = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>)) &amp;&amp; x &lt; <a class="code" href="file_8h.html#aa932272aad0c1610b79e9b04e54e57ea">AST_MAX_FORMATS</a>; x++) {
<a name="l01373"></a>01373       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structformats.html">formats</a>, f, <a class="code" href="structast__format.html#ad0c8f8a1ef89f35f7f1fcce75787632f">list</a>) {
<a name="l01374"></a>01374          <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#a553ad7eb5306fd161fae25fa17c665ef">exts_compare</a>(f-&gt;<a class="code" href="structast__format.html#ade71f534a49925f1955a1598556219e2">exts</a>, type)) {
<a name="l01375"></a>01375             found = 1;
<a name="l01376"></a>01376             <span class="keywordflow">break</span>;
<a name="l01377"></a>01377          }
<a name="l01378"></a>01378       }
<a name="l01379"></a>01379 
<a name="l01380"></a>01380       fmts_str[x] = type;
<a name="l01381"></a>01381       <span class="keywordflow">if</span> (found) {
<a name="l01382"></a>01382          fmts_ptr[x] = f;
<a name="l01383"></a>01383       } <span class="keywordflow">else</span> {
<a name="l01384"></a>01384          fmts_ptr[x] = NULL;
<a name="l01385"></a>01385       }
<a name="l01386"></a>01386    }
<a name="l01387"></a>01387    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l01388"></a>01388 
<a name="l01389"></a>01389    first = 1;
<a name="l01390"></a>01390    <span class="keywordflow">for</span> (i = 0; i &lt; x; i++) {
<a name="l01391"></a>01391       <span class="comment">/* ignore invalid entries */</span>
<a name="l01392"></a>01392       <span class="keywordflow">if</span> (!fmts_ptr[i]) {
<a name="l01393"></a>01393          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;ignoring unknown format &apos;%s&apos;\n&quot;</span>, fmts_str[i]);
<a name="l01394"></a>01394          <span class="keywordflow">continue</span>;
<a name="l01395"></a>01395       }
<a name="l01396"></a>01396 
<a name="l01397"></a>01397       <span class="comment">/* special handling for the first entry */</span>
<a name="l01398"></a>01398       <span class="keywordflow">if</span> (first) {
<a name="l01399"></a>01399          res = snprintf(fmts, len, <span class="stringliteral">&quot;%s&quot;</span>, fmts_str[i]);
<a name="l01400"></a>01400          fmts += res;
<a name="l01401"></a>01401          len -= res;
<a name="l01402"></a>01402          first = 0;
<a name="l01403"></a>01403          <span class="keywordflow">continue</span>;
<a name="l01404"></a>01404       }
<a name="l01405"></a>01405 
<a name="l01406"></a>01406       found = 0;
<a name="l01407"></a>01407       <span class="keywordflow">for</span> (j = 0; j &lt; i; j++) {
<a name="l01408"></a>01408          <span class="comment">/* this is a duplicate */</span>
<a name="l01409"></a>01409          <span class="keywordflow">if</span> (fmts_ptr[j] == fmts_ptr[i]) {
<a name="l01410"></a>01410             found = 1;
<a name="l01411"></a>01411             <span class="keywordflow">break</span>;
<a name="l01412"></a>01412          }
<a name="l01413"></a>01413       }
<a name="l01414"></a>01414 
<a name="l01415"></a>01415       <span class="keywordflow">if</span> (!found) {
<a name="l01416"></a>01416          res = snprintf(fmts, len, <span class="stringliteral">&quot;|%s&quot;</span>, fmts_str[i]);
<a name="l01417"></a>01417          fmts += res;
<a name="l01418"></a>01418          len -= res;
<a name="l01419"></a>01419       }
<a name="l01420"></a>01420    }
<a name="l01421"></a>01421 
<a name="l01422"></a>01422    <span class="keywordflow">if</span> (first) {
<a name="l01423"></a>01423       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;no known formats found in format list (%s)\n&quot;</span>, orig);
<a name="l01424"></a>01424       <span class="keywordflow">return</span> NULL;
<a name="l01425"></a>01425    }
<a name="l01426"></a>01426 
<a name="l01427"></a>01427    <span class="keywordflow">return</span> orig;
<a name="l01428"></a>01428 }
<a name="l01429"></a>01429 
<a name="l01430"></a><a class="code" href="file_8c.html#ac71e8d82ba7e263ff1d3ec9dbade3848">01430</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="file_8c.html#ac71e8d82ba7e263ff1d3ec9dbade3848">handle_cli_core_show_file_formats</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01431"></a>01431 {
<a name="l01432"></a>01432 <span class="preprocessor">#define FORMAT &quot;%-10s %-10s %-20s\n&quot;</span>
<a name="l01433"></a>01433 <span class="preprocessor"></span><span class="preprocessor">#define FORMAT2 &quot;%-10s %-10s %-20s\n&quot;</span>
<a name="l01434"></a>01434 <span class="preprocessor"></span>   <span class="keyword">struct </span><a class="code" href="structast__format.html" title="Each supported file format is described by the following structure.">ast_format</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l01435"></a>01435    <span class="keywordtype">int</span> count_fmt = 0;
<a name="l01436"></a>01436 
<a name="l01437"></a>01437    <span class="keywordflow">switch</span> (cmd) {
<a name="l01438"></a>01438    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01439"></a>01439       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show file formats&quot;</span>;
<a name="l01440"></a>01440       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01441"></a>01441          <span class="stringliteral">&quot;Usage: core show file formats\n&quot;</span>
<a name="l01442"></a>01442          <span class="stringliteral">&quot;       Displays currently registered file formats (if any).\n&quot;</span>;
<a name="l01443"></a>01443       <span class="keywordflow">return</span> NULL;
<a name="l01444"></a>01444    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01445"></a>01445       <span class="keywordflow">return</span> NULL;
<a name="l01446"></a>01446    }
<a name="l01447"></a>01447 
<a name="l01448"></a>01448    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l01449"></a>01449       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01450"></a>01450 
<a name="l01451"></a>01451    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, <span class="stringliteral">&quot;Format&quot;</span>, <span class="stringliteral">&quot;Name&quot;</span>, <span class="stringliteral">&quot;Extensions&quot;</span>);
<a name="l01452"></a>01452    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, <span class="stringliteral">&quot;------&quot;</span>, <span class="stringliteral">&quot;----&quot;</span>, <span class="stringliteral">&quot;----------&quot;</span>);
<a name="l01453"></a>01453 
<a name="l01454"></a>01454    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l01455"></a>01455    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structformats.html">formats</a>, f, <a class="code" href="structast__format.html#ad0c8f8a1ef89f35f7f1fcce75787632f">list</a>) {
<a name="l01456"></a>01456       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#acfd58ce0ec836919236d7a1908494970">FORMAT2</a>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(f-&gt;<a class="code" href="structast__format.html#a317afff57d87a89158c2b038d37b2b08">format</a>), f-&gt;<a class="code" href="structast__format.html#a3777dbae63a15da001b2baa317a25149">name</a>, f-&gt;<a class="code" href="structast__format.html#ade71f534a49925f1955a1598556219e2">exts</a>);
<a name="l01457"></a>01457       count_fmt++;
<a name="l01458"></a>01458    }
<a name="l01459"></a>01459    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structformats.html">formats</a>);
<a name="l01460"></a>01460    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d file formats registered.\n&quot;</span>, count_fmt);
<a name="l01461"></a>01461    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01462"></a>01462 <span class="preprocessor">#undef FORMAT</span>
<a name="l01463"></a>01463 <span class="preprocessor"></span><span class="preprocessor">#undef FORMAT2</span>
<a name="l01464"></a>01464 <span class="preprocessor"></span>}
<a name="l01465"></a>01465 
<a name="l01466"></a><a class="code" href="file_8c.html#abaef9acc752363813eb89bb0b72721a7">01466</a> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="file_8c.html#abaef9acc752363813eb89bb0b72721a7">cli_file</a>[] = {
<a name="l01467"></a>01467    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="file_8c.html#ac71e8d82ba7e263ff1d3ec9dbade3848">handle_cli_core_show_file_formats</a>, <span class="stringliteral">&quot;Displays file formats&quot;</span>)
<a name="l01468"></a>01468 };
<a name="l01469"></a>01469 
<a name="l01470"></a><a class="code" href="file_8c.html#aeac4fbc3c21ddf2548bc7ae7fab717f3">01470</a> <span class="keywordtype">int</span> <a class="code" href="__private_8h.html#aeac4fbc3c21ddf2548bc7ae7fab717f3">ast_file_init</a>(<span class="keywordtype">void</span>)
<a name="l01471"></a>01471 {
<a name="l01472"></a>01472    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(cli_file, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_file));
<a name="l01473"></a>01473    <span class="keywordflow">return</span> 0;
<a name="l01474"></a>01474 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:40 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
