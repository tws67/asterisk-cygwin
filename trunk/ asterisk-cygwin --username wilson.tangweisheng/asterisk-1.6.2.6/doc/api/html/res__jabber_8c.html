<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:23:13 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_318a70d4e812a718d9ecaeea98fff199.html">res</a>
  </div>
</div>
<div class="contents">
<h1>res_jabber.c File Reference</h1>
<p>A resource for interfacing Asterisk directly as a client or a component to a XMPP/Jabber compliant server.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &lt;ctype.h&gt;</code><br/>
<code>#include &lt;iksemel.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="channel_8h_source.html">asterisk/channel.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="jabber_8h_source.html">asterisk/jabber.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="file_8h_source.html">asterisk/file.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="config_8h_source.html">asterisk/config.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="callerid_8h_source.html">asterisk/callerid.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="lock_8h_source.html">asterisk/lock.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cli_8h_source.html">asterisk/cli.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="app_8h_source.html">asterisk/app.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pbx_8h_source.html">asterisk/pbx.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="md5_8h_source.html">asterisk/md5.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="acl_8h_source.html">asterisk/acl.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="module_8h_source.html">asterisk/module.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="astobj_8h_source.html">asterisk/astobj.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="astdb_8h_source.html">asterisk/astdb.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="manager_8h_source.html">asterisk/manager.h</a>&quot;</code><br/>

<p><a href="res__jabber_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ae61bb5ae111d446dd928959847812526">JABBER_CONFIG</a>&nbsp;&nbsp;&nbsp;&quot;jabber.conf&quot;</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a88b7c88fed6b80fd18f34f97757dfc04">__reg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#afeab1257bd17282b95875499393a147a">__unreg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ac5044645216f6146c0bed265a2f8367c">acf_jabberstatus_read</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, const char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, char *data, char *<a class="el" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, size_t buflen)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ad0e9114c8ba0981e4a4f3f7d93f5ef3c">aji_act_hook</a> (void *data, int <a class="el" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, iks *node)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The action hook parses the inbound packets, constantly running.  <a href="#ad0e9114c8ba0981e4a4f3f7d93f5ef3c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561">aji_buddy_destroy</a> (struct <a class="el" href="structaji__buddy.html">aji_buddy</a> *obj)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Deletes the <a class="el" href="structaji__buddy.html">aji_buddy</a> data structure.  <a href="#a8df4b1f53a33f2e7f894be7b69dba561"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a1343493e50b3f08e612a65f0b73625b5">aji_client_connect</a> (void *data, ikspak *pak)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">connects as a client to jabber server.  <a href="#a1343493e50b3f08e612a65f0b73625b5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207">aji_client_destroy</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *obj)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Deletes the <a class="el" href="structaji__client.html">aji_client</a> data structure.  <a href="#a86b1a4282e5190def65358b7867a5207"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a1d851da5bdfbfdd92ab5a8e80229b5d3">aji_client_info_handler</a> (void *data, ikspak *pak)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handle add extra info.  <a href="#a1d851da5bdfbfdd92ab5a8e80229b5d3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a1097eeb9e8887f482496e95a77cbb371">aji_create_buddy</a> (char *label, struct <a class="el" href="structaji__client.html">aji_client</a> *client)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">creates buddy.  <a href="#a1097eeb9e8887f482496e95a77cbb371"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a6381553337670894fe004c0536752062">aji_create_client</a> (char *label, struct <a class="el" href="structast__variable.html">ast_variable</a> *var, int <a class="el" href="app__rpt_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">creates <a class="el" href="structaji__client.html">aji_client</a> structure.  <a href="#a6381553337670894fe004c0536752062"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a08475a2aad43ee4b4dc1f10453547daf">aji_dinfo_handler</a> (void *data, ikspak *pak)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handler of the return info packet.  <a href="#a08475a2aad43ee4b4dc1f10453547daf"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a1fa5630459ae90c51157f306d589a96c">aji_ditems_handler</a> (void *data, ikspak *pak)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handles stuff.  <a href="#a1fa5630459ae90c51157f306d589a96c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a0a89c3ed58b2a5083948fb2fa980eb88">aji_do_reload</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Reload jabber module.  <a href="#a0a89c3ed58b2a5083948fb2fa980eb88"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#af61d5277d284f24cf7e83867342ed724">aji_do_set_debug</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Turn on/off <a class="el" href="structconsole.html">console</a> debugging.  <a href="#af61d5277d284f24cf7e83867342ed724"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ab465ef5fd9bb14b30208091d039f1100">aji_filter_roster</a> (void *data, ikspak *pak)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">filters the roster packet we get back from server.  <a href="#ab465ef5fd9bb14b30208091d039f1100"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structaji__resource.html">aji_resource</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a6628a57705b502b2c15c5c66bdc4bd67">aji_find_resource</a> (struct <a class="el" href="structaji__buddy.html">aji_buddy</a> *buddy, char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Find the <a class="el" href="structaji__resource.html">aji_resource</a> we want.  <a href="#a6628a57705b502b2c15c5c66bdc4bd67"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structaji__version.html">aji_version</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a26b7d6d55f963dbca6e3694d053273d5">aji_find_version</a> (char *node, char *<a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>, ikspak *pak)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Find version in XML stream and populate our capabilities list.  <a href="#a26b7d6d55f963dbca6e3694d053273d5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a064f178d1c5b750e1ee2c0a80da62771">aji_get_roster</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get the roster of jabber <a class="el" href="structusers.html" title="list of users found in the config file">users</a>.  <a href="#a064f178d1c5b750e1ee2c0a80da62771"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ab9777927f36394dc186f89a30b222135">aji_handle_iq</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, iks *node)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handles.  <a href="#ab9777927f36394dc186f89a30b222135"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a7a01af36e4db2dfe018982d63fda2fb2">aji_handle_message</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, ikspak *pak)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handles presence packets.  <a href="#a7a01af36e4db2dfe018982d63fda2fb2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a163e096310bad60196f9b09b4d5169af">aji_handle_presence</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, ikspak *pak)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check the presence info.  <a href="#a163e096310bad60196f9b09b4d5169af"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ae9cccc06634afa62ab69827e3a07efb2">aji_handle_subscribe</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, ikspak *pak)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">handles subscription <a class="el" href="structrequests.html">requests</a>.  <a href="#ae9cccc06634afa62ab69827e3a07efb2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a34f1590817ad7108962f22772caa9bb1">aji_initialize</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">prepares client for connect.  <a href="#a34f1590817ad7108962f22772caa9bb1"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a7487004afc39b2fbdd92ab9faaff8231">aji_io_recv</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, char *buffer, size_t buf_len, int timeout)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Secured or unsecured IO socket receiving function.  <a href="#a7487004afc39b2fbdd92ab9faaff8231"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14">aji_is_secure</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Tests whether the connection is secured or not.  <a href="#ab521080cf1f1741b1e3fdd0ee39f5b14"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ae5802ee540d5ced70ff5a0b32d20bb70">aji_load_config</a> (int reload)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a0c0224cfe2418f3e1779239f44d0266c">aji_log_hook</a> (void *data, const char *xmpp, size_t size, int is_incoming)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">the debug loop.  <a href="#a0c0224cfe2418f3e1779239f44d0266c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a023bfb1346d00de355930f4224b94699">aji_pruneregister</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">goes through roster and prunes <a class="el" href="structusers.html" title="list of users found in the config file">users</a> not needed in list, or adds them accordingly.  <a href="#a023bfb1346d00de355930f4224b94699"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ae14793d1d8300f1c377fccb8e5773250">aji_reconnect</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">reconnect to jabber server  <a href="#ae14793d1d8300f1c377fccb8e5773250"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a94ce06e757ee266951a03520fa126741">aji_recv</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, int timeout)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Tries to receive data from the Jabber server.  <a href="#a94ce06e757ee266951a03520fa126741"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a29f749367c5d39d4eb02841f70a07006">aji_recv_loop</a> (void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">receive <a class="el" href="structmessage.html">message</a> loop.  <a href="#a29f749367c5d39d4eb02841f70a07006"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ae086e18b972394df16015895af3b0e84">aji_register_approve_handler</a> (void *data, ikspak *pak)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Unknown.  <a href="#ae086e18b972394df16015895af3b0e84"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a82642d571c9e2cc5476d1b25c99d51cc">aji_register_query_handler</a> (void *data, ikspak *pak)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">register handler for incoming querys (IQ's)  <a href="#a82642d571c9e2cc5476d1b25c99d51cc"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ad7e3d90484987374674cd6568d39a3de">aji_reload</a> (int reload)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Reload the jabber module.  <a href="#ad7e3d90484987374674cd6568d39a3de"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a26515ff8bd0588f1181bb6a3abc56f90">aji_send_exec</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Dial plan function to send a <a class="el" href="structmessage.html">message</a>.  <a href="#a26515ff8bd0588f1181bb6a3abc56f90"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a21ae37866a3ab62cb29456b23c423a9c">aji_send_header</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, const char *to)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Sends XMPP header to the server.  <a href="#a21ae37866a3ab62cb29456b23c423a9c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a265a12987d4ab3483e7cd733f03ca1d6">aji_send_raw</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, const char *xmlstr)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Sends an XML string over an XMPP connection.  <a href="#a265a12987d4ab3483e7cd733f03ca1d6"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a889348ddb7c785a009c26acb81ed232c">aji_set_presence</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, char *to, char *from, int level, char *<a class="el" href="channel_8c.html#a710bce51374aba96ab04912897666c35">desc</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">set presence of client.  <a href="#a889348ddb7c785a009c26acb81ed232c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a3eedb3c8124c4a01ac80f62b7bab047f">aji_show_buddies</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Show buddy lists.  <a href="#a3eedb3c8124c4a01ac80f62b7bab047f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ab098aeaf9f3ec6b05f4360ab16113afc">aji_show_clients</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Show client status.  <a href="#ab098aeaf9f3ec6b05f4360ab16113afc"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a1b15523e274d7f26568ef5521a73e7ce">aji_start_sasl</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, enum ikssasltype <a class="el" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, char *username, char *<a class="el" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">A wrapper function for iks_start_sasl.  <a href="#a1b15523e274d7f26568ef5521a73e7ce"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ad7bb4a25ad47122d109b34c3e8552f96">aji_start_tls</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Starts the TLS procedure.  <a href="#ad7bb4a25ad47122d109b34c3e8552f96"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#af34ff341cd5689c2c1355daf38e38682">aji_status_exec</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Dial plan function <a class="el" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status()</a>. puts the status of watched <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> into a channel variable.  <a href="#af34ff341cd5689c2c1355daf38e38682"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#af86ff7c316e29a5c6a914b4a9c2bc330">aji_test</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Send test <a class="el" href="structmessage.html">message</a> for debugging.  <a href="#af86ff7c316e29a5c6a914b4a9c2bc330"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a626fb8236724be309a0d3ee3a2e979ed">aji_tls_handshake</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">TLS handshake, OpenSSL initialization.  <a href="#a626fb8236724be309a0d3ee3a2e979ed"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a8ce87df2b2878a7384640e3720ba1c2c">ast_aji_create_chat</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, char *room, char *server, char *topic)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">create a chatroom.  <a href="#a8ce87df2b2878a7384640e3720ba1c2c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a06f01ad5dc78d9300fed1415b54be04a">ast_aji_disconnect</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">disconnect from jabber server.  <a href="#a06f01ad5dc78d9300fed1415b54be04a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a6689c8e948c8d55e092f30277336fde7">ast_aji_get_client</a> (const char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">grab a <a class="el" href="structaji__client.html">aji_client</a> structure by label name or JID (without the resource string)  <a href="#a6689c8e948c8d55e092f30277336fde7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structaji__client__container.html">aji_client_container</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a740bf5f4ba6bf40ff9273ca8f7a89710">ast_aji_get_clients</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a6e4ae95e74b73933aa6e6d6817df9023">ast_aji_increment_mid</a> (char *mid)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">increments the mid field for messages and other events.  <a href="#a6e4ae95e74b73933aa6e6d6817df9023"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a0fe274254c01bee899843b9057929abe">ast_aji_invite_chat</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, char *<a class="el" href="structuser.html">user</a>, char *room, char *<a class="el" href="structmessage.html">message</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">invite to a chatroom.  <a href="#a0fe274254c01bee899843b9057929abe"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#aad4fd8a9604fb1d017882c76511c36f7">ast_aji_join_chat</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, char *room)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">join a chatroom.  <a href="#aad4fd8a9604fb1d017882c76511c36f7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a3c77ceecc909619207e971421fc3e9ef">ast_aji_send</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, iks *x)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Wraps raw sending.  <a href="#a3c77ceecc909619207e971421fc3e9ef"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#af2b674ed94b89a5798fe22714a44f046">ast_aji_send_chat</a> (struct <a class="el" href="structaji__client.html">aji_client</a> *client, const char *address, const char *<a class="el" href="structmessage.html">message</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">sends messages.  <a href="#af2b674ed94b89a5798fe22714a44f046"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ad006b2b4ce6bbe60f32b13b3e430affb">gtalk_yuck</a> (iks *node)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Jabber GTalk function.  <a href="#ad006b2b4ce6bbe60f32b13b3e430affb"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static iks *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a09cc645b12759b721001a5245f64165a">jabber_make_auth</a> (iksid *<a class="el" href="res__ais_8c.html#a2465fd4497a7402ad72da7d6e03f9934">id</a>, const char *<a class="el" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>, const char *sid)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setup the authentication struct.  <a href="#a09cc645b12759b721001a5245f64165a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Unload the jabber module.  <a href="#ac3382bf6da54c56b37069bd76bbdf4f9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a48ebc7a99890a29f1901304e574d4f03">manager_jabber_send</a> (struct <a class="el" href="structmansession.html">mansession</a> *s, const struct <a class="el" href="structmessage.html">message</a> *m)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Send a Jabber Message via call from the Manager.  <a href="#a48ebc7a99890a29f1901304e574d4f03"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Wrapper for aji_reload.  <a href="#ad1982509765f4870f1f63412a53ea668"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Unload the jabber module.  <a href="#ad09fa931f468002152a3cc2d5ce25eae"></a><br/></td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_GLOBAL_SYMBOLS , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;AJI - Asterisk Jabber Interface&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, .reload = reload, }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a40ba67b6a93d32c6cf9f58ec7ef0980c">aji_cli</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a8e769b687824e8e46d6977f708f0d061">app_ajisend</a> = &quot;JabberSend&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#aac8db588d5c711d05e12d78bb8a28dcb">app_ajistatus</a> = &quot;JabberStatus&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#ae25b9f3970870610911f8850897e8ead">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structaji__capabilities.html">aji_capabilities</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#aa7afd7ba4814dbf49b1867019891fd14">capabilities</a> = NULL</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structaji__client__container.html">aji_client_container</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__flags.html">ast_flags</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a> = { AJI_AUTOREGISTER }</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Global flags, initialized to default <a class="el" href="structvalues.html">values</a>.  <a href="#a3888fe259904a2eb18b173cbf56bfa86"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__custom__function.html">ast_custom_function</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a12ea81a7f47eca38c7c4ac9a07bddd40">jabberstatus_function</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__jabber_8c.html#a06597455b511878dd26b69b5bfc4e529">mandescr_jabber_send</a> []</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>A resource for interfacing Asterisk directly as a client or a component to a XMPP/Jabber compliant server. </p>
<p>References:</p>
<ul>
<li><a href="http://www.xmpp.org">http://www.xmpp.org</a> - The XMPP standards foundation</li>
</ul>
<dl class="extref"><dt><b><a class="el" href="extref.html#_extref000022">ExtRef:</a></b></dt><dd>Iksemel <a href="http://code.google.com/p/iksemel/">http://code.google.com/p/iksemel/</a></dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000091">Todo:</a></b></dt><dd><p class="startdd">If you unload this module, chan_gtalk/jingle will be dead. How do we handle that? </p>
<p class="enddd">Dialplan applications need RETURN variable, like JABBERSENDSTATUS</p>
</dd></dl>

<p>Definition in file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="ae61bb5ae111d446dd928959847812526"></a><!-- doxytag: member="res_jabber.c::JABBER_CONFIG" ref="ae61bb5ae111d446dd928959847812526" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define JABBER_CONFIG&nbsp;&nbsp;&nbsp;&quot;jabber.conf&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000092">Todo:</a></b></dt><dd>This should really be renamed to xmpp.conf. For backwards compatibility, we need to read both files </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00173">173</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l02907">aji_load_config()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a88b7c88fed6b80fd18f34f97757dfc04"></a><!-- doxytag: member="res_jabber.c::__reg_module" ref="a88b7c88fed6b80fd18f34f97757dfc04" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __reg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l03111">3111</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

</div>
</div>
<a class="anchor" id="afeab1257bd17282b95875499393a147a"></a><!-- doxytag: member="res_jabber.c::__unreg_module" ref="afeab1257bd17282b95875499393a147a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __unreg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l03111">3111</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

</div>
</div>
<a class="anchor" id="ac5044645216f6146c0bed265a2f8367c"></a><!-- doxytag: member="res_jabber.c::acf_jabberstatus_read" ref="ac5044645216f6146c0bed265a2f8367c" args="(struct ast_channel *chan, const char *name, char *data, char *buf, size_t buflen)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int acf_jabberstatus_read </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&nbsp;</td>
          <td class="paramname"> <em>buflen</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00489">489</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00370">aji_find_resource()</a>, <a class="el" href="res__jabber_8c_source.html#l02954">ast_aji_get_client()</a>, <a class="el" href="app_8h_source.html#l00338">AST_APP_ARG</a>, <a class="el" href="app_8h_source.html#l00355">AST_DECLARE_APP_ARGS</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="app_8h_source.html#l00402">AST_NONSTANDARD_APP_ARGS</a>, <a class="el" href="app_8h_source.html#l00387">AST_STANDARD_APP_ARGS</a>, <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="jabber_8h_source.html#l00109">aji_resource::resource</a>, <a class="el" href="jabber_8h_source.html#l00127">aji_buddy::resources</a>, and <a class="el" href="jabber_8h_source.html#l00108">aji_resource::status</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00490"></a>00490 {
<a name="l00491"></a>00491    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l00492"></a>00492    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = NULL;
<a name="l00493"></a>00493    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *r = NULL;
<a name="l00494"></a>00494    <span class="keywordtype">int</span> stat = 7;
<a name="l00495"></a>00495    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l00496"></a>00496       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(sender);
<a name="l00497"></a>00497       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(jid);
<a name="l00498"></a>00498    );
<a name="l00499"></a>00499    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(jid,
<a name="l00500"></a>00500       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(screenname);
<a name="l00501"></a>00501       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>);
<a name="l00502"></a>00502    );
<a name="l00503"></a>00503 
<a name="l00504"></a>00504    <span class="keywordflow">if</span> (!data) {
<a name="l00505"></a>00505       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Usage: JABBER_STATUS(&lt;sender&gt;,&lt;jid&gt;[/&lt;resource&gt;])\n&quot;</span>);
<a name="l00506"></a>00506       <span class="keywordflow">return</span> 0;
<a name="l00507"></a>00507    }
<a name="l00508"></a>00508    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, data);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510    <span class="keywordflow">if</span> (args.argc != 2) {
<a name="l00511"></a>00511       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER_STATUS requires 2 arguments: sender and jid.\n&quot;</span>);
<a name="l00512"></a>00512       <span class="keywordflow">return</span> -1;
<a name="l00513"></a>00513    }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515    <a class="code" href="app_8h.html#accfcb380df76a64251d88ef49c2dd4e3" title="Performs the &amp;#39;nonstandard&amp;#39; argument separation process for an application...">AST_NONSTANDARD_APP_ARGS</a>(jid, args.jid, <span class="charliteral">&apos;/&apos;</span>);
<a name="l00516"></a>00516 
<a name="l00517"></a>00517    <span class="keywordflow">if</span> (!(client = <a class="code" href="jabber_8h.html#a6689c8e948c8d55e092f30277336fde7" title="grab a aji_client structure by label name or JID (without the resource string)">ast_aji_get_client</a>(args.sender))) {
<a name="l00518"></a>00518       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find sender connection: &apos;%s&apos;\n&quot;</span>, args.sender);
<a name="l00519"></a>00519       <span class="keywordflow">return</span> -1;
<a name="l00520"></a>00520    }
<a name="l00521"></a>00521    buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, jid.screenname);
<a name="l00522"></a>00522    <span class="keywordflow">if</span> (!buddy) {
<a name="l00523"></a>00523       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find buddy in list: &apos;%s&apos;\n&quot;</span>, jid.screenname);
<a name="l00524"></a>00524       <span class="keywordflow">return</span> -1;
<a name="l00525"></a>00525    }
<a name="l00526"></a>00526    r = <a class="code" href="res__jabber_8c.html#a6628a57705b502b2c15c5c66bdc4bd67" title="Find the aji_resource we want.">aji_find_resource</a>(buddy, jid.resource);
<a name="l00527"></a>00527    <span class="keywordflow">if</span> (!r &amp;&amp; buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>) 
<a name="l00528"></a>00528       r = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l00529"></a>00529    <span class="keywordflow">if</span> (!r)
<a name="l00530"></a>00530       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Resource %s of buddy %s was not found.\n&quot;</span>, jid.resource, jid.screenname);
<a name="l00531"></a>00531    <span class="keywordflow">else</span>
<a name="l00532"></a>00532       stat = r-&gt;<a class="code" href="structaji__resource.html#a6e27f49150e9a14580fb313cc2777e00">status</a>;
<a name="l00533"></a>00533    snprintf(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, buflen, <span class="stringliteral">&quot;%d&quot;</span>, stat);
<a name="l00534"></a>00534    <span class="keywordflow">return</span> 0;
<a name="l00535"></a>00535 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad0e9114c8ba0981e4a4f3f7d93f5ef3c"></a><!-- doxytag: member="res_jabber.c::aji_act_hook" ref="ad0e9114c8ba0981e4a4f3f7d93f5ef3c" args="(void *data, int type, iks *node)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_act_hook </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">iks *&nbsp;</td>
          <td class="paramname"> <em>node</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>The action hook parses the inbound packets, constantly running. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>aji client structure </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>type</em>&nbsp;</td><td>type of packet </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>node</em>&nbsp;</td><td>the actual packet. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_OK or IKS_HOOK . </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00944">944</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l02327">aji_client_connect()</a>, <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="jabber_8h_source.html#l00080">AJI_CONNECTED</a>, <a class="el" href="jabber_8h_source.html#l00079">AJI_CONNECTING</a>, <a class="el" href="jabber_8h_source.html#l00078">AJI_DISCONNECTED</a>, <a class="el" href="jabber_8h_source.html#l00077">AJI_DISCONNECTING</a>, <a class="el" href="res__jabber_8c_source.html#l01554">aji_handle_iq()</a>, <a class="el" href="res__jabber_8c_source.html#l01564">aji_handle_message()</a>, <a class="el" href="res__jabber_8c_source.html#l01604">aji_handle_presence()</a>, <a class="el" href="res__jabber_8c_source.html#l01822">aji_handle_subscribe()</a>, <a class="el" href="res__jabber_8c_source.html#l00583">aji_is_secure()</a>, <a class="el" href="res__jabber_8c_source.html#l00721">aji_recv()</a>, <a class="el" href="res__jabber_8c_source.html#l00792">aji_send_header()</a>, <a class="el" href="res__jabber_8c_source.html#l00831">aji_send_raw()</a>, <a class="el" href="res__jabber_8c_source.html#l00895">aji_start_sasl()</a>, <a class="el" href="res__jabber_8c_source.html#l00599">aji_start_tls()</a>, <a class="el" href="res__jabber_8c_source.html#l00617">aji_tls_handshake()</a>, <a class="el" href="astmm_8h_source.html#l00108">asprintf</a>, <a class="el" href="res__jabber_8c_source.html#l02038">ast_aji_increment_mid()</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8c_source.html#l00246">ast_sha1_hash()</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="jabber_8h_source.html#l00169">aji_client::authorized</a>, <a class="el" href="jabber_8h_source.html#l00171">aji_client::component</a>, <a class="el" href="jabber_8h_source.html#l00151">aji_client::f</a>, <a class="el" href="res__jabber_8c_source.html#l00404">jabber_make_auth()</a>, <a class="el" href="jabber_8h_source.html#l00149">aji_client::jid</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="jabber_8h_source.html#l00148">aji_client::mid</a>, <a class="el" href="jabber_8h_source.html#l00141">aji_client::password</a>, <a class="el" href="chan__h323_8c_source.html#l00145">secret</a>, <a class="el" href="jabber_8h_source.html#l00159">aji_client::state</a>, <a class="el" href="jabber_8h_source.html#l00157">aji_client::stream_flags</a>, <a class="el" href="jabber_8h_source.html#l00050">TRY_SECURE</a>, <a class="el" href="jabber_8h_source.html#l00164">aji_client::usesasl</a>, and <a class="el" href="jabber_8h_source.html#l00162">aji_client::usetls</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00945"></a>00945 {
<a name="l00946"></a>00946    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l00947"></a>00947    ikspak *pak = NULL;
<a name="l00948"></a>00948    iks *auth = NULL;
<a name="l00949"></a>00949    <span class="keywordtype">int</span> features = 0;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951    <span class="keywordflow">if</span>(!node) {
<a name="l00952"></a>00952       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;aji_act_hook was called with out a packet\n&quot;</span>); <span class="comment">/* most likely cause type is IKS_NODE_ERROR lost connection */</span>
<a name="l00953"></a>00953       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l00954"></a>00954       <span class="keywordflow">return</span> IKS_HOOK;
<a name="l00955"></a>00955    }
<a name="l00956"></a>00956 
<a name="l00957"></a>00957    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a9f2e9be855a781b74badbe0c1bda278e">AJI_DISCONNECTING</a>) {
<a name="l00958"></a>00958       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l00959"></a>00959       <span class="keywordflow">return</span> IKS_HOOK;
<a name="l00960"></a>00960    }
<a name="l00961"></a>00961 
<a name="l00962"></a>00962    pak = iks_packet(node);
<a name="l00963"></a>00963 
<a name="l00964"></a>00964    <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>) { <span class="comment">/*client */</span>
<a name="l00965"></a>00965       <span class="keywordflow">switch</span> (<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>) {
<a name="l00966"></a>00966       <span class="keywordflow">case</span> IKS_NODE_START:
<a name="l00967"></a>00967          <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#a411370ea698a05d61798dffbc10eba17">usetls</a> &amp;&amp; !<a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(client)) {
<a name="l00968"></a>00968 <span class="preprocessor">#ifndef HAVE_OPENSSL</span>
<a name="l00969"></a>00969 <span class="preprocessor"></span>            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;OpenSSL not installed. You need to install OpenSSL on this system, or disable the TLS option in your configuration file\n&quot;</span>);
<a name="l00970"></a>00970             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l00971"></a>00971             <span class="keywordflow">return</span> IKS_HOOK;
<a name="l00972"></a>00972 <span class="preprocessor">#else</span>
<a name="l00973"></a>00973 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="res__jabber_8c.html#ad7bb4a25ad47122d109b34c3e8552f96" title="Starts the TLS procedure.">aji_start_tls</a>(client) == IKS_NET_TLSFAIL) {
<a name="l00974"></a>00974                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not start TLS\n&quot;</span>);
<a name="l00975"></a>00975                <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l00976"></a>00976                <span class="keywordflow">return</span> IKS_HOOK;     
<a name="l00977"></a>00977             }
<a name="l00978"></a>00978 <span class="preprocessor">#endif</span>
<a name="l00979"></a>00979 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
<a name="l00980"></a>00980          }
<a name="l00981"></a>00981          <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#af88c655607efe917c3030f7ea0c00397">usesasl</a>) {
<a name="l00982"></a>00982             iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a1343493e50b3f08e612a65f0b73625b5" title="connects as a client to jabber server.">aji_client_connect</a>, client, IKS_RULE_TYPE, IKS_PAK_IQ, IKS_RULE_SUBTYPE, IKS_TYPE_RESULT, IKS_RULE_ID, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>, IKS_RULE_DONE);
<a name="l00983"></a>00983             auth = <a class="code" href="res__jabber_8c.html#a09cc645b12759b721001a5245f64165a" title="Setup the authentication struct.">jabber_make_auth</a>(client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>, client-&gt;<a class="code" href="structaji__client.html#a0d6c13cf4ff6b4c5b3f049bc7955c8b6">password</a>, iks_find_attrib(node, <span class="stringliteral">&quot;id&quot;</span>));
<a name="l00984"></a>00984             <span class="keywordflow">if</span> (auth) {
<a name="l00985"></a>00985                iks_insert_attrib(auth, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l00986"></a>00986                iks_insert_attrib(auth, <span class="stringliteral">&quot;to&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;server);
<a name="l00987"></a>00987                <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l00988"></a>00988                <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, auth);
<a name="l00989"></a>00989                iks_delete(auth);
<a name="l00990"></a>00990             } <span class="keywordflow">else</span>
<a name="l00991"></a>00991                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l00992"></a>00992          }
<a name="l00993"></a>00993          <span class="keywordflow">break</span>;
<a name="l00994"></a>00994 
<a name="l00995"></a>00995       <span class="keywordflow">case</span> IKS_NODE_NORMAL:
<a name="l00996"></a>00996 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l00997"></a>00997 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> &amp; <a class="code" href="jabber_8h.html#ab432cc1c9f5228a80e1fe12e301a2f0f">TRY_SECURE</a>) {
<a name="l00998"></a>00998             <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;proceed&quot;</span>, iks_name(node))) {
<a name="l00999"></a>00999                <span class="keywordflow">return</span> <a class="code" href="res__jabber_8c.html#a626fb8236724be309a0d3ee3a2e979ed" title="TLS handshake, OpenSSL initialization.">aji_tls_handshake</a>(client);
<a name="l01000"></a>01000             }
<a name="l01001"></a>01001          }
<a name="l01002"></a>01002 <span class="preprocessor">#endif</span>
<a name="l01003"></a>01003 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;stream:features&quot;</span>, iks_name(node))) {
<a name="l01004"></a>01004             features = iks_stream_features(node);
<a name="l01005"></a>01005             <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#af88c655607efe917c3030f7ea0c00397">usesasl</a>) {
<a name="l01006"></a>01006                <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#a411370ea698a05d61798dffbc10eba17">usetls</a> &amp;&amp; !<a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(client))
<a name="l01007"></a>01007                   <span class="keywordflow">break</span>;
<a name="l01008"></a>01008                <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#af8817598c239b6e65a000760866a5cde">authorized</a>) {
<a name="l01009"></a>01009                   <span class="keywordflow">if</span> (features &amp; IKS_STREAM_BIND) {
<a name="l01010"></a>01010                      iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a1343493e50b3f08e612a65f0b73625b5" title="connects as a client to jabber server.">aji_client_connect</a>, client, IKS_RULE_TYPE, IKS_PAK_IQ, IKS_RULE_SUBTYPE, IKS_TYPE_RESULT, IKS_RULE_DONE);
<a name="l01011"></a>01011                      auth = iks_make_resource_bind(client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>);
<a name="l01012"></a>01012                      <span class="keywordflow">if</span> (auth) {
<a name="l01013"></a>01013                         iks_insert_attrib(auth, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01014"></a>01014                         <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01015"></a>01015                         <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, auth);
<a name="l01016"></a>01016                         iks_delete(auth);
<a name="l01017"></a>01017                      } <span class="keywordflow">else</span> {
<a name="l01018"></a>01018                         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01019"></a>01019                         <span class="keywordflow">break</span>;
<a name="l01020"></a>01020                      }
<a name="l01021"></a>01021                   }
<a name="l01022"></a>01022                   <span class="keywordflow">if</span> (features &amp; IKS_STREAM_SESSION) {
<a name="l01023"></a>01023                      iks_filter_add_rule (client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a1343493e50b3f08e612a65f0b73625b5" title="connects as a client to jabber server.">aji_client_connect</a>, client, IKS_RULE_TYPE, IKS_PAK_IQ, IKS_RULE_SUBTYPE, IKS_TYPE_RESULT, IKS_RULE_ID, <span class="stringliteral">&quot;auth&quot;</span>, IKS_RULE_DONE);
<a name="l01024"></a>01024                      auth = iks_make_session();
<a name="l01025"></a>01025                      <span class="keywordflow">if</span> (auth) {
<a name="l01026"></a>01026                         iks_insert_attrib(auth, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;auth&quot;</span>);
<a name="l01027"></a>01027                         <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01028"></a>01028                         <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, auth);
<a name="l01029"></a>01029                         iks_delete(auth);
<a name="l01030"></a>01030                      } <span class="keywordflow">else</span> {
<a name="l01031"></a>01031                         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01032"></a>01032                      }
<a name="l01033"></a>01033                   }
<a name="l01034"></a>01034                } <span class="keywordflow">else</span> {
<a name="l01035"></a>01035                   <span class="keywordtype">int</span> ret;
<a name="l01036"></a>01036                   <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;user) {
<a name="l01037"></a>01037                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Malformed Jabber ID : %s (domain missing?)\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01038"></a>01038                      <span class="keywordflow">break</span>;
<a name="l01039"></a>01039                   }
<a name="l01040"></a>01040 
<a name="l01041"></a>01041                   ret = <a class="code" href="res__jabber_8c.html#a1b15523e274d7f26568ef5521a73e7ce" title="A wrapper function for iks_start_sasl.">aji_start_sasl</a>(client, features, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;user, client-&gt;<a class="code" href="structaji__client.html#a0d6c13cf4ff6b4c5b3f049bc7955c8b6">password</a>);
<a name="l01042"></a>01042                   <span class="keywordflow">if</span> (ret != IKS_OK) {
<a name="l01043"></a>01043                      <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01044"></a>01044                      <span class="keywordflow">return</span> IKS_HOOK;
<a name="l01045"></a>01045                   }
<a name="l01046"></a>01046                   <span class="keywordflow">break</span>;
<a name="l01047"></a>01047                }
<a name="l01048"></a>01048             }
<a name="l01049"></a>01049          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;failure&quot;</span>, iks_name(node))) {
<a name="l01050"></a>01050             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER: encryption failure. possible bad password.\n&quot;</span>);
<a name="l01051"></a>01051          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;success&quot;</span>, iks_name(node))) {
<a name="l01052"></a>01052             client-&gt;<a class="code" href="structaji__client.html#af8817598c239b6e65a000760866a5cde">authorized</a> = 1;
<a name="l01053"></a>01053             <a class="code" href="res__jabber_8c.html#a21ae37866a3ab62cb29456b23c423a9c" title="Sends XMPP header to the server.">aji_send_header</a>(client, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;server);
<a name="l01054"></a>01054          }
<a name="l01055"></a>01055          <span class="keywordflow">break</span>;
<a name="l01056"></a>01056       <span class="keywordflow">case</span> IKS_NODE_ERROR: 
<a name="l01057"></a>01057             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER: Node Error\n&quot;</span>);
<a name="l01058"></a>01058             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01059"></a>01059             <span class="keywordflow">return</span> IKS_HOOK;
<a name="l01060"></a>01060             <span class="keywordflow">break</span>;
<a name="l01061"></a>01061       <span class="keywordflow">case</span> IKS_NODE_STOP: 
<a name="l01062"></a>01062             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JABBER: Disconnected\n&quot;</span>);
<a name="l01063"></a>01063             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01064"></a>01064             <span class="keywordflow">return</span> IKS_HOOK;
<a name="l01065"></a>01065             <span class="keywordflow">break</span>;
<a name="l01066"></a>01066       }
<a name="l01067"></a>01067    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> != <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a> &amp;&amp; client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>) {
<a name="l01068"></a>01068       <span class="keywordflow">switch</span> (<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>) {
<a name="l01069"></a>01069       <span class="keywordflow">case</span> IKS_NODE_START:
<a name="l01070"></a>01070          <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a46d3c148625b0889f793b6c355051d3b">AJI_DISCONNECTED</a>) {
<a name="l01071"></a>01071             <span class="keywordtype">char</span> <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>[160], shasum[320], *handshake;
<a name="l01072"></a>01072 
<a name="l01073"></a>01073             sprintf(secret, <span class="stringliteral">&quot;%s%s&quot;</span>, pak-&gt;id, client-&gt;<a class="code" href="structaji__client.html#a0d6c13cf4ff6b4c5b3f049bc7955c8b6">password</a>);
<a name="l01074"></a>01074             <a class="code" href="utils_8h.html#a89565d41a0b343afc57a1c0d9eb85160" title="Produces SHA1 hash based on input string.">ast_sha1_hash</a>(shasum, secret);
<a name="l01075"></a>01075             handshake = NULL;
<a name="l01076"></a>01076             <span class="keywordflow">if</span> (<a class="code" href="astmm_8h.html#a5d1f84199c77c83b8b51928dd359e228">asprintf</a>(&amp;handshake, <span class="stringliteral">&quot;&lt;handshake&gt;%s&lt;/handshake&gt;&quot;</span>, shasum) &gt;= 0) {
<a name="l01077"></a>01077                <a class="code" href="res__jabber_8c.html#a265a12987d4ab3483e7cd733f03ca1d6" title="Sends an XML string over an XMPP connection.">aji_send_raw</a>(client, handshake);
<a name="l01078"></a>01078                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(handshake);
<a name="l01079"></a>01079                handshake = NULL;
<a name="l01080"></a>01080             }
<a name="l01081"></a>01081             client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ade80d6f33c170eeaeb1fbc84ebdb1a2f">AJI_CONNECTING</a>;
<a name="l01082"></a>01082             <span class="keywordflow">if</span>(<a class="code" href="res__jabber_8c.html#a94ce06e757ee266951a03520fa126741" title="Tries to receive data from the Jabber server.">aji_recv</a>(client, 1) == 2) <span class="comment">/*XXX proper result for iksemel library on iks_recv of &lt;handshake/&gt; XXX*/</span>
<a name="l01083"></a>01083                client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a>;
<a name="l01084"></a>01084             <span class="keywordflow">else</span>
<a name="l01085"></a>01085                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Jabber didn&apos;t seem to handshake, failed to authenticate.\n&quot;</span>);
<a name="l01086"></a>01086             <span class="keywordflow">break</span>;
<a name="l01087"></a>01087          }
<a name="l01088"></a>01088          <span class="keywordflow">break</span>;
<a name="l01089"></a>01089 
<a name="l01090"></a>01090       <span class="keywordflow">case</span> IKS_NODE_NORMAL:
<a name="l01091"></a>01091          <span class="keywordflow">break</span>;
<a name="l01092"></a>01092 
<a name="l01093"></a>01093       <span class="keywordflow">case</span> IKS_NODE_ERROR:
<a name="l01094"></a>01094          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER: Node Error\n&quot;</span>);
<a name="l01095"></a>01095          <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01096"></a>01096          <span class="keywordflow">return</span> IKS_HOOK;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098       <span class="keywordflow">case</span> IKS_NODE_STOP:
<a name="l01099"></a>01099          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JABBER: Disconnected\n&quot;</span>);
<a name="l01100"></a>01100          <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01101"></a>01101          <span class="keywordflow">return</span> IKS_HOOK;
<a name="l01102"></a>01102       }
<a name="l01103"></a>01103    }
<a name="l01104"></a>01104 
<a name="l01105"></a>01105    <span class="keywordflow">switch</span> (pak-&gt;type) {
<a name="l01106"></a>01106    <span class="keywordflow">case</span> IKS_PAK_NONE:
<a name="l01107"></a>01107       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;JABBER: I don&apos;t know what to do with paktype NONE.\n&quot;</span>);
<a name="l01108"></a>01108       <span class="keywordflow">break</span>;
<a name="l01109"></a>01109    <span class="keywordflow">case</span> IKS_PAK_MESSAGE:
<a name="l01110"></a>01110       <a class="code" href="res__jabber_8c.html#a7a01af36e4db2dfe018982d63fda2fb2" title="Handles presence packets.">aji_handle_message</a>(client, pak);
<a name="l01111"></a>01111       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;JABBER: Handling paktype MESSAGE.\n&quot;</span>);
<a name="l01112"></a>01112       <span class="keywordflow">break</span>;
<a name="l01113"></a>01113    <span class="keywordflow">case</span> IKS_PAK_PRESENCE:
<a name="l01114"></a>01114       <a class="code" href="res__jabber_8c.html#a163e096310bad60196f9b09b4d5169af" title="Check the presence info.">aji_handle_presence</a>(client, pak);
<a name="l01115"></a>01115       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;JABBER: Handling paktype PRESENCE\n&quot;</span>);
<a name="l01116"></a>01116       <span class="keywordflow">break</span>;
<a name="l01117"></a>01117    <span class="keywordflow">case</span> IKS_PAK_S10N:
<a name="l01118"></a>01118       <a class="code" href="res__jabber_8c.html#ae9cccc06634afa62ab69827e3a07efb2" title="handles subscription requests.">aji_handle_subscribe</a>(client, pak);
<a name="l01119"></a>01119       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;JABBER: Handling paktype S10N\n&quot;</span>);
<a name="l01120"></a>01120       <span class="keywordflow">break</span>;
<a name="l01121"></a>01121    <span class="keywordflow">case</span> IKS_PAK_IQ:
<a name="l01122"></a>01122       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;JABBER: Handling paktype IQ\n&quot;</span>);
<a name="l01123"></a>01123       <a class="code" href="res__jabber_8c.html#ab9777927f36394dc186f89a30b222135" title="Handles.">aji_handle_iq</a>(client, node);
<a name="l01124"></a>01124       <span class="keywordflow">break</span>;
<a name="l01125"></a>01125    <span class="keywordflow">default</span>:
<a name="l01126"></a>01126       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;JABBER: I don&apos;t know anything about paktype &apos;%d&apos;\n&quot;</span>, pak-&gt;type);
<a name="l01127"></a>01127       <span class="keywordflow">break</span>;
<a name="l01128"></a>01128    }
<a name="l01129"></a>01129    
<a name="l01130"></a>01130    iks_filter_packet(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, pak);
<a name="l01131"></a>01131 
<a name="l01132"></a>01132    <span class="keywordflow">if</span> (node)
<a name="l01133"></a>01133       iks_delete(node);
<a name="l01134"></a>01134 
<a name="l01135"></a>01135    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01136"></a>01136    <span class="keywordflow">return</span> IKS_OK;
<a name="l01137"></a>01137 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a8df4b1f53a33f2e7f894be7b69dba561"></a><!-- doxytag: member="res_jabber.c::aji_buddy_destroy" ref="a8df4b1f53a33f2e7f894be7b69dba561" args="(struct aji_buddy *obj)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void aji_buddy_destroy </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__buddy.html">aji_buddy</a> *&nbsp;</td>
          <td class="paramname"> <em>obj</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Deletes the <a class="el" href="structaji__buddy.html">aji_buddy</a> data structure. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>obj</em>&nbsp;</td><td><a class="el" href="structaji__buddy.html">aji_buddy</a> The structure we will delete. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>void. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00281">281</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="jabber_8h_source.html#l00110">aji_resource::description</a>, <a class="el" href="jabber_8h_source.html#l00113">aji_resource::next</a>, and <a class="el" href="jabber_8h_source.html#l00127">aji_buddy::resources</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="res__jabber_8c_source.html#l02880">aji_create_buddy()</a>, and <a class="el" href="res__jabber_8c_source.html#l01604">aji_handle_presence()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00282"></a>00282 {
<a name="l00283"></a>00283    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *tmp;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285    <span class="keywordflow">while</span> ((tmp = obj-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>)) {
<a name="l00286"></a>00286       obj-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = obj-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l00287"></a>00287       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__resource.html#a8444d6e0dfe2bbab0b5e7b24308f1559">description</a>);
<a name="l00288"></a>00288       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l00289"></a>00289    }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(obj);
<a name="l00292"></a>00292 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1343493e50b3f08e612a65f0b73625b5"></a><!-- doxytag: member="res_jabber.c::aji_client_connect" ref="a1343493e50b3f08e612a65f0b73625b5" args="(void *data, ikspak *pak)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_client_connect </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ikspak *&nbsp;</td>
          <td class="paramname"> <em>pak</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>connects as a client to jabber server. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>void </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pak</em>&nbsp;</td><td>ikspak iksemel packet </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>res. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02327">2327</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="jabber_8h_source.html#l00079">AJI_CONNECTING</a>, <a class="el" href="jabber_8h_source.html#l00078">AJI_DISCONNECTED</a>, <a class="el" href="res__jabber_8c_source.html#l02200">aji_filter_roster()</a>, <a class="el" href="res__jabber_8c_source.html#l02305">aji_get_roster()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="jabber_8h_source.html#l00171">aji_client::component</a>, <a class="el" href="jabber_8h_source.html#l00151">aji_client::f</a>, <a class="el" href="jabber_8h_source.html#l00149">aji_client::jid</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="jabber_8h_source.html#l00152">aji_client::stack</a>, and <a class="el" href="jabber_8h_source.html#l00159">aji_client::state</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02328"></a>02328 {
<a name="l02329"></a>02329    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l02330"></a>02330    <span class="keywordtype">int</span> res = 0;
<a name="l02331"></a>02331 
<a name="l02332"></a>02332    <span class="keywordflow">if</span> (client) {
<a name="l02333"></a>02333       <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a46d3c148625b0889f793b6c355051d3b">AJI_DISCONNECTED</a>) {
<a name="l02334"></a>02334          iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#ab465ef5fd9bb14b30208091d039f1100" title="filters the roster packet we get back from server.">aji_filter_roster</a>, client, IKS_RULE_TYPE, IKS_PAK_IQ, IKS_RULE_SUBTYPE, IKS_TYPE_RESULT, IKS_RULE_ID, <span class="stringliteral">&quot;roster&quot;</span>, IKS_RULE_DONE);
<a name="l02335"></a>02335          client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ade80d6f33c170eeaeb1fbc84ebdb1a2f">AJI_CONNECTING</a>;
<a name="l02336"></a>02336          client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a> = (iks_find_cdata(pak-&gt;query, <span class="stringliteral">&quot;jid&quot;</span>)) ? iks_id_new(client-&gt;<a class="code" href="structaji__client.html#ae0c738f7612f5fd8ef0f227f8033324f">stack</a>, iks_find_cdata(pak-&gt;query, <span class="stringliteral">&quot;jid&quot;</span>)) : client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>;
<a name="l02337"></a>02337          iks_filter_remove_hook(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a1343493e50b3f08e612a65f0b73625b5" title="connects as a client to jabber server.">aji_client_connect</a>);
<a name="l02338"></a>02338          <span class="keywordflow">if</span>(!client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>) <span class="comment">/*client*/</span>
<a name="l02339"></a>02339             <a class="code" href="res__jabber_8c.html#a064f178d1c5b750e1ee2c0a80da62771" title="Get the roster of jabber users.">aji_get_roster</a>(client);
<a name="l02340"></a>02340       }
<a name="l02341"></a>02341    } <span class="keywordflow">else</span>
<a name="l02342"></a>02342       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l02343"></a>02343 
<a name="l02344"></a>02344    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02345"></a>02345    <span class="keywordflow">return</span> res;
<a name="l02346"></a>02346 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a86b1a4282e5190def65358b7867a5207"></a><!-- doxytag: member="res_jabber.c::aji_client_destroy" ref="a86b1a4282e5190def65358b7867a5207" args="(struct aji_client *obj)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void aji_client_destroy </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>obj</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Deletes the <a class="el" href="structaji__client.html">aji_client</a> data structure. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>obj</em>&nbsp;</td><td><a class="el" href="structaji__client.html">aji_client</a> The structure we will delete. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>void. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00257">257</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00281">aji_buddy_destroy()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="linkedlists_8h_source.html#l00637">AST_LIST_HEAD_DESTROY</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00817">AST_LIST_REMOVE_HEAD</a>, <a class="el" href="astobj_8h_source.html#l00765">ASTOBJ_CONTAINER_DESTROY</a>, <a class="el" href="astobj_8h_source.html#l00453">ASTOBJ_CONTAINER_DESTROYALL</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="jabber_8h_source.html#l00151">aji_client::f</a>, <a class="el" href="jabber_8h_source.html#l00117">aji_message::from</a>, <a class="el" href="jabber_8h_source.html#l00118">aji_message::message</a>, <a class="el" href="jabber_8h_source.html#l00150">aji_client::p</a>, and <a class="el" href="jabber_8h_source.html#l00152">aji_client::stack</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>, <a class="el" href="res__jabber_8c_source.html#l02327">aji_client_connect()</a>, <a class="el" href="res__jabber_8c_source.html#l01353">aji_client_info_handler()</a>, <a class="el" href="res__jabber_8c_source.html#l01413">aji_dinfo_handler()</a>, <a class="el" href="res__jabber_8c_source.html#l01258">aji_ditems_handler()</a>, <a class="el" href="res__jabber_8c_source.html#l00863">aji_log_hook()</a>, <a class="el" href="res__jabber_8c_source.html#l01985">aji_recv_loop()</a>, <a class="el" href="res__jabber_8c_source.html#l01144">aji_register_approve_handler()</a>, <a class="el" href="res__jabber_8c_source.html#l01187">aji_register_query_handler()</a>, <a class="el" href="res__jabber_8c_source.html#l03035">aji_reload()</a>, <a class="el" href="res__jabber_8c_source.html#l02380">ast_aji_disconnect()</a>, and <a class="el" href="res__jabber_8c_source.html#l03061">unload_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00258"></a>00258 {
<a name="l00259"></a>00259    <span class="keyword">struct </span><a class="code" href="structaji__message.html">aji_message</a> *tmp;
<a name="l00260"></a>00260    <a class="code" href="astobj_8h.html#a5b923418ce1d4908359bb3b27b211411" title="Empty a container.">ASTOBJ_CONTAINER_DESTROYALL</a>(&amp;obj-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, <a class="code" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561" title="Deletes the aji_buddy data structure.">aji_buddy_destroy</a>);
<a name="l00261"></a>00261    <a class="code" href="astobj_8h.html#a49ab9467549d53be33f3f9f3ecae97f9" title="Destroy a container.">ASTOBJ_CONTAINER_DESTROY</a>(&amp;obj-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>);
<a name="l00262"></a>00262    iks_filter_delete(obj-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>);
<a name="l00263"></a>00263    iks_parser_delete(obj-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>);
<a name="l00264"></a>00264    iks_stack_delete(obj-&gt;<a class="code" href="structaji__client.html#ae0c738f7612f5fd8ef0f227f8033324f">stack</a>);
<a name="l00265"></a>00265    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;obj-&gt;messages);
<a name="l00266"></a>00266    <span class="keywordflow">while</span> ((tmp = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;obj-&gt;messages, list))) {
<a name="l00267"></a>00267       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>)
<a name="l00268"></a>00268          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>);
<a name="l00269"></a>00269       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>)
<a name="l00270"></a>00270          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>);
<a name="l00271"></a>00271    }
<a name="l00272"></a>00272    <a class="code" href="linkedlists_8h.html#a47bafe663a14b91827082787d7654d7c" title="Destroys a list head structure.">AST_LIST_HEAD_DESTROY</a>(&amp;obj-&gt;messages);
<a name="l00273"></a>00273    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(obj);
<a name="l00274"></a>00274 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1d851da5bdfbfdd92ab5a8e80229b5d3"></a><!-- doxytag: member="res_jabber.c::aji_client_info_handler" ref="a1d851da5bdfbfdd92ab5a8e80229b5d3" args="(void *data, ikspak *pak)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_client_info_handler </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ikspak *&nbsp;</td>
          <td class="paramname"> <em>pak</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Handle add extra info. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>void </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pak</em>&nbsp;</td><td>ikspak </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_FILTER_EAT </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01353">1353</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="res__jabber_8c_source.html#l00370">aji_find_resource()</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="jabber_8h_source.html#l00111">aji_resource::cap</a>, <a class="el" href="jabber_8h_source.html#l00149">aji_client::jid</a>, <a class="el" href="jabber_8h_source.html#l00096">aji_version::jingle</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, and <a class="el" href="jabber_8h_source.html#l00109">aji_resource::resource</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01354"></a>01354 {
<a name="l01355"></a>01355    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l01356"></a>01356    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a> = NULL;
<a name="l01357"></a>01357    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, pak-&gt;from-&gt;partial);
<a name="l01358"></a>01358 
<a name="l01359"></a>01359    resource = <a class="code" href="res__jabber_8c.html#a6628a57705b502b2c15c5c66bdc4bd67" title="Find the aji_resource we want.">aji_find_resource</a>(buddy, pak-&gt;from-&gt;resource);
<a name="l01360"></a>01360    <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_RESULT) {
<a name="l01361"></a>01361       <span class="keywordflow">if</span> (!resource) {
<a name="l01362"></a>01362          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;JABBER: Received client info from %s when not requested.\n&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01363"></a>01363          <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01364"></a>01364          <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01365"></a>01365       }
<a name="l01366"></a>01366       <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;query, <span class="stringliteral">&quot;feature&quot;</span>, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://www.google.com/xmpp/protocol/voice/v1&quot;</span>)) {
<a name="l01367"></a>01367          resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> = 1;
<a name="l01368"></a>01368       } <span class="keywordflow">else</span>
<a name="l01369"></a>01369          resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> = 0;
<a name="l01370"></a>01370    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_GET) {
<a name="l01371"></a>01371       iks *iq, *disco, *ident, *google, *query;
<a name="l01372"></a>01372       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01373"></a>01373       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01374"></a>01374       ident = iks_new(<span class="stringliteral">&quot;identity&quot;</span>);
<a name="l01375"></a>01375       disco = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01376"></a>01376       google = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01377"></a>01377       <span class="keywordflow">if</span> (iq &amp;&amp; ident &amp;&amp; disco &amp;&amp; google) {
<a name="l01378"></a>01378          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01379"></a>01379          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01380"></a>01380          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01381"></a>01381          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01382"></a>01382          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>);
<a name="l01383"></a>01383          iks_insert_attrib(ident, <span class="stringliteral">&quot;category&quot;</span>, <span class="stringliteral">&quot;client&quot;</span>);
<a name="l01384"></a>01384          iks_insert_attrib(ident, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;pc&quot;</span>);
<a name="l01385"></a>01385          iks_insert_attrib(ident, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;asterisk&quot;</span>);
<a name="l01386"></a>01386          iks_insert_attrib(disco, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>);
<a name="l01387"></a>01387          iks_insert_attrib(google, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://www.google.com/xmpp/protocol/voice/v1&quot;</span>);
<a name="l01388"></a>01388          iks_insert_node(iq, query);
<a name="l01389"></a>01389          iks_insert_node(query, ident);
<a name="l01390"></a>01390          iks_insert_node(query, google);
<a name="l01391"></a>01391          iks_insert_node(query, disco);
<a name="l01392"></a>01392          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01393"></a>01393       } <span class="keywordflow">else</span>
<a name="l01394"></a>01394          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of Memory.\n&quot;</span>);
<a name="l01395"></a>01395 
<a name="l01396"></a>01396       iks_delete(iq);
<a name="l01397"></a>01397       iks_delete(query);
<a name="l01398"></a>01398       iks_delete(ident);
<a name="l01399"></a>01399       iks_delete(google);
<a name="l01400"></a>01400       iks_delete(disco);
<a name="l01401"></a>01401    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_ERROR) {
<a name="l01402"></a>01402       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;User %s does not support discovery.\n&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01403"></a>01403    }
<a name="l01404"></a>01404    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01405"></a>01405    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01406"></a>01406 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1097eeb9e8887f482496e95a77cbb371"></a><!-- doxytag: member="res_jabber.c::aji_create_buddy" ref="a1097eeb9e8887f482496e95a77cbb371" args="(char *label, struct aji_client *client)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_create_buddy </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>label</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>creates buddy. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>label</em>&nbsp;</td><td>char. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>1 on success, 0 on failure. load config file. </dd>
<dd>
1. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02880">2880</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00281">aji_buddy_destroy()</a>, <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, <a class="el" href="astobj_8h_source.html#l00776">ASTOBJ_CONTAINER_LINK</a>, <a class="el" href="astobj_8h_source.html#l00264">ASTOBJ_INIT</a>, <a class="el" href="astobj_8h_source.html#l00109">ASTOBJ_UNLOCK</a>, <a class="el" href="astobj_8h_source.html#l00251">ASTOBJ_UNMARK</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="astobj_8h_source.html#l00104">ASTOBJ_WRLOCK</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, and <a class="el" href="jabber_8h_source.html#l00125">aji_buddy::name</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l02660">aji_create_client()</a>, <a class="el" href="res__jabber_8c_source.html#l01604">aji_handle_presence()</a>, and <a class="el" href="res__jabber_8c_source.html#l01822">aji_handle_subscribe()</a>.</p>

</div>
</div>
<a class="anchor" id="a6381553337670894fe004c0536752062"></a><!-- doxytag: member="res_jabber.c::aji_create_client" ref="a6381553337670894fe004c0536752062" args="(char *label, struct ast_variable *var, int debug)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_create_client </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>label</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td>
          <td class="paramname"> <em>var</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>debug</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>creates <a class="el" href="structaji__client.html">aji_client</a> structure. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>label</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>var</em>&nbsp;</td><td><a class="el" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>debug</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>0. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02660">2660</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="jabber_8h_source.html#l00084">AJI_AUTOPRUNE</a>, <a class="el" href="jabber_8h_source.html#l00085">AJI_AUTOREGISTER</a>, <a class="el" href="res__jabber_8c_source.html#l02880">aji_create_buddy()</a>, <a class="el" href="jabber_8h_source.html#l00078">AJI_DISCONNECTED</a>, <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="utils_8h_source.html#l00082">ast_copy_flags</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="utils_8c_source.html#l01328">ast_false()</a>, <a class="el" href="utils_8h_source.html#l00194">AST_FLAGS_ALL</a>, <a class="el" href="linkedlists_8h_source.html#l00610">AST_LIST_HEAD_INIT</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8h_source.html#l00092">ast_set2_flag</a>, <a class="el" href="utils_8c_source.html#l01311">ast_true()</a>, <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, <a class="el" href="astobj_8h_source.html#l00752">ASTOBJ_CONTAINER_INIT</a>, <a class="el" href="astobj_8h_source.html#l00782">ASTOBJ_CONTAINER_MARKALL</a>, <a class="el" href="astobj_8h_source.html#l00264">ASTOBJ_INIT</a>, <a class="el" href="astobj_8h_source.html#l00251">ASTOBJ_UNMARK</a>, <a class="el" href="astobj_8h_source.html#l00104">ASTOBJ_WRLOCK</a>, <a class="el" href="jabber_8h_source.html#l00169">aji_client::authorized</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="res__jabber_8c_source.html#l00246">clients</a>, <a class="el" href="jabber_8h_source.html#l00171">aji_client::component</a>, <a class="el" href="jabber_8h_source.html#l00161">aji_client::debug</a>, <a class="el" href="jabber_8h_source.html#l00170">aji_client::flags</a>, <a class="el" href="jabber_8h_source.html#l00163">aji_client::forcessl</a>, <a class="el" href="jabber_8h_source.html#l00165">aji_client::keepalive</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="jabber_8h_source.html#l00168">aji_client::message_timeout</a>, <a class="el" href="jabber_8h_source.html#l00148">aji_client::mid</a>, <a class="el" href="config_8h_source.html#l00075">ast_variable::name</a>, <a class="el" href="jabber_8h_source.html#l00141">aji_client::name</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, <a class="el" href="jabber_8h_source.html#l00141">aji_client::password</a>, <a class="el" href="jabber_8h_source.html#l00160">aji_client::port</a>, <a class="el" href="jabber_8h_source.html#l00176">aji_client::priority</a>, <a class="el" href="jabber_8h_source.html#l00144">aji_client::serverhost</a>, <a class="el" href="jabber_8h_source.html#l00159">aji_client::state</a>, <a class="el" href="jabber_8h_source.html#l00177">aji_client::status</a>, <a class="el" href="jabber_8h_source.html#l00145">aji_client::statusmessage</a>, <a class="el" href="jabber_8h_source.html#l00167">aji_client::timeout</a>, <a class="el" href="jabber_8h_source.html#l00143">aji_client::user</a>, <a class="el" href="jabber_8h_source.html#l00164">aji_client::usesasl</a>, <a class="el" href="jabber_8h_source.html#l00162">aji_client::usetls</a>, and <a class="el" href="config_8h_source.html#l00076">ast_variable::value</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l02907">aji_load_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02661"></a>02661 {
<a name="l02662"></a>02662    <span class="keywordtype">char</span> *resource;
<a name="l02663"></a>02663    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l02664"></a>02664    <span class="keywordtype">int</span> flag = 0;
<a name="l02665"></a>02665 
<a name="l02666"></a>02666    client = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>,label);
<a name="l02667"></a>02667    <span class="keywordflow">if</span> (!client) {
<a name="l02668"></a>02668       flag = 1;
<a name="l02669"></a>02669       client = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*client));
<a name="l02670"></a>02670       <span class="keywordflow">if</span> (!client) {
<a name="l02671"></a>02671          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory!\n&quot;</span>);
<a name="l02672"></a>02672          <span class="keywordflow">return</span> 0;
<a name="l02673"></a>02673       }
<a name="l02674"></a>02674       <a class="code" href="astobj_8h.html#a996db3d193843755068f61f21e14c3dd" title="Initialize an object.">ASTOBJ_INIT</a>(client);
<a name="l02675"></a>02675       <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(client);
<a name="l02676"></a>02676       <a class="code" href="astobj_8h.html#a8551f606c8aecc4797ef7728c7792827" title="Initialize a container.">ASTOBJ_CONTAINER_INIT</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>);
<a name="l02677"></a>02677    } <span class="keywordflow">else</span> {
<a name="l02678"></a>02678       <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(client);
<a name="l02679"></a>02679       <a class="code" href="astobj_8h.html#a789fc1432f54cb615e839f0db9decad5" title="Unmark an ASTOBJ by subtracting the ASTOBJ_FLAG_MARKED flag from its objflags mask...">ASTOBJ_UNMARK</a>(client);
<a name="l02680"></a>02680    }
<a name="l02681"></a>02681    <a class="code" href="astobj_8h.html#a5e865869ca1acadd652b42810fec2ec9" title="Mark all the objects in a container.">ASTOBJ_CONTAINER_MARKALL</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>);
<a name="l02682"></a>02682    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>, label, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>));
<a name="l02683"></a>02683    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>, <span class="stringliteral">&quot;aaaaa&quot;</span>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>));
<a name="l02684"></a>02684 
<a name="l02685"></a>02685    <span class="comment">/* Set default values for the client object */</span>
<a name="l02686"></a>02686    client-&gt;<a class="code" href="structaji__client.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = <a class="code" href="app__rpt_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a>;
<a name="l02687"></a>02687    <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#aec78000b2897c094f68ed72559e18acd">flags</a>, &amp;<a class="code" href="res__jabber_8c.html#a3888fe259904a2eb18b173cbf56bfa86" title="Global flags, initialized to default values.">globalflags</a>, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l02688"></a>02688    client-&gt;<a class="code" href="structaji__client.html#a63c89c04d1feae07ca35558055155ffb">port</a> = 5222;
<a name="l02689"></a>02689    client-&gt;<a class="code" href="structaji__client.html#a411370ea698a05d61798dffbc10eba17">usetls</a> = 1;
<a name="l02690"></a>02690    client-&gt;<a class="code" href="structaji__client.html#af88c655607efe917c3030f7ea0c00397">usesasl</a> = 1;
<a name="l02691"></a>02691    client-&gt;<a class="code" href="structaji__client.html#aed71bc56a369c9f2e0faae6a0c713e20">forcessl</a> = 0;
<a name="l02692"></a>02692    client-&gt;<a class="code" href="structaji__client.html#ae314c4b48027be9feab52906b6313b73">keepalive</a> = 1;
<a name="l02693"></a>02693    client-&gt;<a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> = 50;
<a name="l02694"></a>02694    client-&gt;<a class="code" href="structaji__client.html#afcb76ae4daf94120b9c6e8e3a8926e36">message_timeout</a> = 100;
<a name="l02695"></a>02695    <a class="code" href="linkedlists_8h.html#a6f42d3bf45cc9af6f794d9d1cf8c45ca" title="Initializes a list head structure.">AST_LIST_HEAD_INIT</a>(&amp;client-&gt;messages);
<a name="l02696"></a>02696    client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a> = 0;
<a name="l02697"></a>02697    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>, <span class="stringliteral">&quot;Online and Available&quot;</span>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>));
<a name="l02698"></a>02698    client-&gt;<a class="code" href="structaji__client.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 0;
<a name="l02699"></a>02699    client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_AVAILABLE;
<a name="l02700"></a>02700 
<a name="l02701"></a>02701    <span class="keywordflow">if</span> (flag) {
<a name="l02702"></a>02702       client-&gt;<a class="code" href="structaji__client.html#af8817598c239b6e65a000760866a5cde">authorized</a> = 0;
<a name="l02703"></a>02703       client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a46d3c148625b0889f793b6c355051d3b">AJI_DISCONNECTED</a>;
<a name="l02704"></a>02704    }
<a name="l02705"></a>02705    <span class="keywordflow">while</span> (var) {
<a name="l02706"></a>02706       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;username&quot;</span>))
<a name="l02707"></a>02707          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>));
<a name="l02708"></a>02708       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;serverhost&quot;</span>))
<a name="l02709"></a>02709          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#ae6f9b37fdd3bec79fe5bb6f71242f9f5">serverhost</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#ae6f9b37fdd3bec79fe5bb6f71242f9f5">serverhost</a>));
<a name="l02710"></a>02710       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;secret&quot;</span>))
<a name="l02711"></a>02711          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#a0d6c13cf4ff6b4c5b3f049bc7955c8b6">password</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#a0d6c13cf4ff6b4c5b3f049bc7955c8b6">password</a>));
<a name="l02712"></a>02712       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;statusmessage&quot;</span>))
<a name="l02713"></a>02713          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>));
<a name="l02714"></a>02714       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;port&quot;</span>))
<a name="l02715"></a>02715          client-&gt;<a class="code" href="structaji__client.html#a63c89c04d1feae07ca35558055155ffb">port</a> = atoi(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02716"></a>02716       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;timeout&quot;</span>))
<a name="l02717"></a>02717          client-&gt;<a class="code" href="structaji__client.html#afcb76ae4daf94120b9c6e8e3a8926e36">message_timeout</a> = atoi(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02718"></a>02718       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;debug&quot;</span>))
<a name="l02719"></a>02719          client-&gt;<a class="code" href="structaji__client.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) ? 0 : 1;
<a name="l02720"></a>02720       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;type&quot;</span>)) {
<a name="l02721"></a>02721          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;component&quot;</span>))
<a name="l02722"></a>02722             client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a> = 1;
<a name="l02723"></a>02723       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;usetls&quot;</span>)) {
<a name="l02724"></a>02724          client-&gt;<a class="code" href="structaji__client.html#a411370ea698a05d61798dffbc10eba17">usetls</a> = (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) ? 0 : 1;
<a name="l02725"></a>02725       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;usesasl&quot;</span>)) {
<a name="l02726"></a>02726          client-&gt;<a class="code" href="structaji__client.html#af88c655607efe917c3030f7ea0c00397">usesasl</a> = (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) ? 0 : 1;
<a name="l02727"></a>02727       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;forceoldssl&quot;</span>))
<a name="l02728"></a>02728          client-&gt;<a class="code" href="structaji__client.html#aed71bc56a369c9f2e0faae6a0c713e20">forcessl</a> = (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) ? 0 : 1;
<a name="l02729"></a>02729       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;keepalive&quot;</span>))
<a name="l02730"></a>02730          client-&gt;<a class="code" href="structaji__client.html#ae314c4b48027be9feab52906b6313b73">keepalive</a> = (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) ? 0 : 1;
<a name="l02731"></a>02731       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autoprune&quot;</span>))
<a name="l02732"></a>02732          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a5bf8f469c15d256015b2a3084bcdef59">AJI_AUTOPRUNE</a>);
<a name="l02733"></a>02733       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autoregister&quot;</span>))
<a name="l02734"></a>02734          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02735"></a>02735       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;buddy&quot;</span>))
<a name="l02736"></a>02736          <a class="code" href="res__jabber_8c.html#a1097eeb9e8887f482496e95a77cbb371" title="creates buddy.">aji_create_buddy</a>((<span class="keywordtype">char</span> *)var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, client);
<a name="l02737"></a>02737       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;priority&quot;</span>))
<a name="l02738"></a>02738          client-&gt;<a class="code" href="structaji__client.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = atoi(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02739"></a>02739       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;status&quot;</span>)) {
<a name="l02740"></a>02740          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;unavailable&quot;</span>))
<a name="l02741"></a>02741             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_UNAVAILABLE;
<a name="l02742"></a>02742          <span class="keywordflow">else</span>
<a name="l02743"></a>02743          if (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;available&quot;</span>)
<a name="l02744"></a>02744           || !strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;online&quot;</span>))
<a name="l02745"></a>02745             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_AVAILABLE;
<a name="l02746"></a>02746          <span class="keywordflow">else</span>
<a name="l02747"></a>02747          if (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;chat&quot;</span>)
<a name="l02748"></a>02748           || !strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;chatty&quot;</span>))
<a name="l02749"></a>02749             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_CHAT;
<a name="l02750"></a>02750          <span class="keywordflow">else</span>
<a name="l02751"></a>02751          if (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;away&quot;</span>))
<a name="l02752"></a>02752             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_AWAY;
<a name="l02753"></a>02753          <span class="keywordflow">else</span>
<a name="l02754"></a>02754          if (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;xa&quot;</span>)
<a name="l02755"></a>02755           || !strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;xaway&quot;</span>))
<a name="l02756"></a>02756             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_XA;
<a name="l02757"></a>02757          <span class="keywordflow">else</span>
<a name="l02758"></a>02758          if (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;dnd&quot;</span>))
<a name="l02759"></a>02759             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_DND;
<a name="l02760"></a>02760          <span class="keywordflow">else</span>
<a name="l02761"></a>02761          if (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;invisible&quot;</span>))
<a name="l02762"></a>02762          #ifdef IKS_SHOW_INVISIBLE
<a name="l02763"></a>02763             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_INVISIBLE;
<a name="l02764"></a>02764          #<span class="keywordflow">else</span>
<a name="l02765"></a>02765          {
<a name="l02766"></a>02766             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Your iksemel doesn&apos;t support invisible status: falling back to DND\n&quot;</span>);
<a name="l02767"></a>02767             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_DND;
<a name="l02768"></a>02768          }
<a name="l02769"></a>02769 <span class="preprocessor">         #endif</span>
<a name="l02770"></a>02770 <span class="preprocessor"></span>         <span class="keywordflow">else</span>
<a name="l02771"></a>02771             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown presence status: %s\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02772"></a>02772       }
<a name="l02773"></a>02773    <span class="comment">/* no transport support in this version */</span>
<a name="l02774"></a>02774    <span class="comment">/* else if (!strcasecmp(var-&gt;name, &quot;transport&quot;))</span>
<a name="l02775"></a>02775 <span class="comment">            aji_create_transport(var-&gt;value, client);</span>
<a name="l02776"></a>02776 <span class="comment">   */</span>
<a name="l02777"></a>02777       var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l02778"></a>02778    }
<a name="l02779"></a>02779    <span class="keywordflow">if</span> (!flag) {
<a name="l02780"></a>02780       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(client);
<a name="l02781"></a>02781       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02782"></a>02782       <span class="keywordflow">return</span> 1;
<a name="l02783"></a>02783    }
<a name="l02784"></a>02784 
<a name="l02785"></a>02785    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#af15d57ddbee9fc1081f785f111f52b46">name_space</a>, (client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>) ? <span class="stringliteral">&quot;jabber:component:accept&quot;</span> : <span class="stringliteral">&quot;jabber:client&quot;</span>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#af15d57ddbee9fc1081f785f111f52b46">name_space</a>));
<a name="l02786"></a>02786    client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a> = iks_stream_new(client-&gt;<a class="code" href="structaji__client.html#af15d57ddbee9fc1081f785f111f52b46">name_space</a>, client, <a class="code" href="res__jabber_8c.html#ad0e9114c8ba0981e4a4f3f7d93f5ef3c" title="The action hook parses the inbound packets, constantly running.">aji_act_hook</a>);
<a name="l02787"></a>02787    <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>) {
<a name="l02788"></a>02788       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to create stream for client &apos;%s&apos;!\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l02789"></a>02789       <span class="keywordflow">return</span> 0;
<a name="l02790"></a>02790    }
<a name="l02791"></a>02791    client-&gt;<a class="code" href="structaji__client.html#ae0c738f7612f5fd8ef0f227f8033324f">stack</a> = iks_stack_new(8192, 8192);
<a name="l02792"></a>02792    <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#ae0c738f7612f5fd8ef0f227f8033324f">stack</a>) {
<a name="l02793"></a>02793       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to allocate stack for client &apos;%s&apos;\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l02794"></a>02794       <span class="keywordflow">return</span> 0;
<a name="l02795"></a>02795    }
<a name="l02796"></a>02796    client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a> = iks_filter_new();
<a name="l02797"></a>02797    <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>) {
<a name="l02798"></a>02798       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to create filter for client &apos;%s&apos;\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l02799"></a>02799       <span class="keywordflow">return</span> 0;
<a name="l02800"></a>02800    }
<a name="l02801"></a>02801    <span class="keywordflow">if</span> (!strchr(client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>, <span class="charliteral">&apos;/&apos;</span>) &amp;&amp; !client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>) { <span class="comment">/*client */</span>
<a name="l02802"></a>02802       resource = NULL;
<a name="l02803"></a>02803       <span class="keywordflow">if</span> (<a class="code" href="astmm_8h.html#a5d1f84199c77c83b8b51928dd359e228">asprintf</a>(&amp;resource, <span class="stringliteral">&quot;%s/asterisk&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>) &gt;= 0) {
<a name="l02804"></a>02804          client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a> = iks_id_new(client-&gt;<a class="code" href="structaji__client.html#ae0c738f7612f5fd8ef0f227f8033324f">stack</a>, resource);
<a name="l02805"></a>02805          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(resource);
<a name="l02806"></a>02806       }
<a name="l02807"></a>02807    } <span class="keywordflow">else</span>
<a name="l02808"></a>02808       client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a> = iks_id_new(client-&gt;<a class="code" href="structaji__client.html#ae0c738f7612f5fd8ef0f227f8033324f">stack</a>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l02809"></a>02809    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>) {
<a name="l02810"></a>02810       iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a08475a2aad43ee4b4dc1f10453547daf" title="Handler of the return info packet.">aji_dinfo_handler</a>, client, IKS_RULE_NS, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>, IKS_RULE_DONE);
<a name="l02811"></a>02811       iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a1fa5630459ae90c51157f306d589a96c" title="Handles stuff.">aji_ditems_handler</a>, client, IKS_RULE_NS, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#items&quot;</span>, IKS_RULE_DONE);
<a name="l02812"></a>02812       iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a82642d571c9e2cc5476d1b25c99d51cc" title="register handler for incoming querys (IQ&amp;#39;s)">aji_register_query_handler</a>, client, IKS_RULE_SUBTYPE, IKS_TYPE_GET, IKS_RULE_NS, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>, IKS_RULE_DONE);
<a name="l02813"></a>02813       iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#ae086e18b972394df16015895af3b0e84" title="Unknown.">aji_register_approve_handler</a>, client, IKS_RULE_SUBTYPE, IKS_TYPE_SET, IKS_RULE_NS, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>, IKS_RULE_DONE);
<a name="l02814"></a>02814    } <span class="keywordflow">else</span> {
<a name="l02815"></a>02815       iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a1d851da5bdfbfdd92ab5a8e80229b5d3" title="Handle add extra info.">aji_client_info_handler</a>, client, IKS_RULE_NS, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>, IKS_RULE_DONE);
<a name="l02816"></a>02816    }
<a name="l02817"></a>02817    iks_set_log_hook(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>, <a class="code" href="res__jabber_8c.html#a0c0224cfe2418f3e1779239f44d0266c" title="the debug loop.">aji_log_hook</a>);
<a name="l02818"></a>02818    <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(client);
<a name="l02819"></a>02819    <a class="code" href="astobj_8h.html#a73bb2d9f59430fd47007a3c6ea651de6" title="Add an object to a container.">ASTOBJ_CONTAINER_LINK</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>,client);
<a name="l02820"></a>02820    <span class="keywordflow">return</span> 1;
<a name="l02821"></a>02821 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a08475a2aad43ee4b4dc1f10453547daf"></a><!-- doxytag: member="res_jabber.c::aji_dinfo_handler" ref="a08475a2aad43ee4b4dc1f10453547daf" args="(void *data, ikspak *pak)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_dinfo_handler </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ikspak *&nbsp;</td>
          <td class="paramname"> <em>pak</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Handler of the return info packet. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td><a class="el" href="structaji__client.html">aji_client</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pak</em>&nbsp;</td><td>ikspak </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_FILTER_EAT </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01413">1413</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="res__jabber_8c_source.html#l00370">aji_find_resource()</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="jabber_8h_source.html#l00111">aji_resource::cap</a>, <a class="el" href="res__agi_8c_source.html#l02479">commands</a>, <a class="el" href="jabber_8h_source.html#l00096">aji_version::jingle</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="jabber_8h_source.html#l00109">aji_resource::resource</a>, <a class="el" href="jabber_8h_source.html#l00143">aji_client::user</a>, and <a class="el" href="res__config__ldap_8c_source.html#l00071">version</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01414"></a>01414 {
<a name="l01415"></a>01415    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l01416"></a>01416    <span class="keywordtype">char</span> *node = NULL;
<a name="l01417"></a>01417    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a> = NULL;
<a name="l01418"></a>01418    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, pak-&gt;from-&gt;partial);
<a name="l01419"></a>01419 
<a name="l01420"></a>01420    resource = <a class="code" href="res__jabber_8c.html#a6628a57705b502b2c15c5c66bdc4bd67" title="Find the aji_resource we want.">aji_find_resource</a>(buddy, pak-&gt;from-&gt;resource);
<a name="l01421"></a>01421    <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_ERROR) {
<a name="l01422"></a>01422       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Received error from a client, turn on jabber debug!\n&quot;</span>);
<a name="l01423"></a>01423       <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01424"></a>01424    }
<a name="l01425"></a>01425    <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_RESULT) {
<a name="l01426"></a>01426       <span class="keywordflow">if</span> (!resource) {
<a name="l01427"></a>01427          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;JABBER: Received client info from %s when not requested.\n&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01428"></a>01428          <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01429"></a>01429          <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01430"></a>01430       }
<a name="l01431"></a>01431       <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;query, <span class="stringliteral">&quot;feature&quot;</span>, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://www.google.com/xmpp/protocol/voice/v1&quot;</span>)) {
<a name="l01432"></a>01432          resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> = 1;
<a name="l01433"></a>01433       } <span class="keywordflow">else</span>
<a name="l01434"></a>01434          resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> = 0;
<a name="l01435"></a>01435    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_GET &amp;&amp; !(node = iks_find_attrib(pak-&gt;query, <span class="stringliteral">&quot;node&quot;</span>))) {
<a name="l01436"></a>01436       iks *iq, *query, *identity, *disco, *reg, *<a class="code" href="res__agi_8c.html#aaaa94f6da87a703160a7acb2fd67422d" title="AGI commands list.">commands</a>, *gateway, *<a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>, *vcard, *search;
<a name="l01437"></a>01437 
<a name="l01438"></a>01438       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01439"></a>01439       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01440"></a>01440       identity = iks_new(<span class="stringliteral">&quot;identity&quot;</span>);
<a name="l01441"></a>01441       disco = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01442"></a>01442       reg = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01443"></a>01443       commands = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01444"></a>01444       gateway = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01445"></a>01445       version = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01446"></a>01446       vcard = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01447"></a>01447       search = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01448"></a>01448 
<a name="l01449"></a>01449       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; identity &amp;&amp; disco &amp;&amp; reg &amp;&amp; commands &amp;&amp; gateway &amp;&amp; version &amp;&amp; vcard &amp;&amp; search &amp;&amp; client) {
<a name="l01450"></a>01450          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01451"></a>01451          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01452"></a>01452          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01453"></a>01453          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01454"></a>01454          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>);
<a name="l01455"></a>01455          iks_insert_attrib(identity, <span class="stringliteral">&quot;category&quot;</span>, <span class="stringliteral">&quot;gateway&quot;</span>);
<a name="l01456"></a>01456          iks_insert_attrib(identity, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;pstn&quot;</span>);
<a name="l01457"></a>01457          iks_insert_attrib(identity, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;Asterisk The Open Source PBX&quot;</span>);
<a name="l01458"></a>01458          iks_insert_attrib(disco, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco&quot;</span>);
<a name="l01459"></a>01459          iks_insert_attrib(reg, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>);
<a name="l01460"></a>01460          iks_insert_attrib(commands, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>);
<a name="l01461"></a>01461          iks_insert_attrib(gateway, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;jabber:iq:gateway&quot;</span>);
<a name="l01462"></a>01462          iks_insert_attrib(version, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;jabber:iq:version&quot;</span>);
<a name="l01463"></a>01463          iks_insert_attrib(vcard, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;vcard-temp&quot;</span>);
<a name="l01464"></a>01464          iks_insert_attrib(search, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;jabber:iq:search&quot;</span>);
<a name="l01465"></a>01465 
<a name="l01466"></a>01466          iks_insert_node(iq, query);
<a name="l01467"></a>01467          iks_insert_node(query, identity);
<a name="l01468"></a>01468          iks_insert_node(query, disco);
<a name="l01469"></a>01469          iks_insert_node(query, reg);
<a name="l01470"></a>01470          iks_insert_node(query, commands);
<a name="l01471"></a>01471          iks_insert_node(query, gateway);
<a name="l01472"></a>01472          iks_insert_node(query, version);
<a name="l01473"></a>01473          iks_insert_node(query, vcard);
<a name="l01474"></a>01474          iks_insert_node(query, search);
<a name="l01475"></a>01475          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01476"></a>01476       } <span class="keywordflow">else</span> {
<a name="l01477"></a>01477          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01478"></a>01478       }
<a name="l01479"></a>01479 
<a name="l01480"></a>01480       iks_delete(iq);
<a name="l01481"></a>01481       iks_delete(query);
<a name="l01482"></a>01482       iks_delete(identity);
<a name="l01483"></a>01483       iks_delete(disco);
<a name="l01484"></a>01484       iks_delete(reg);
<a name="l01485"></a>01485       iks_delete(commands);
<a name="l01486"></a>01486       iks_delete(gateway);
<a name="l01487"></a>01487       iks_delete(version);
<a name="l01488"></a>01488       iks_delete(vcard);
<a name="l01489"></a>01489       iks_delete(search);
<a name="l01490"></a>01490 
<a name="l01491"></a>01491    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_GET &amp;&amp; !strcasecmp(node, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>)) {
<a name="l01492"></a>01492       iks *iq, *query, *confirm;
<a name="l01493"></a>01493       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01494"></a>01494       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01495"></a>01495       confirm = iks_new(<span class="stringliteral">&quot;item&quot;</span>);
<a name="l01496"></a>01496 
<a name="l01497"></a>01497       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; confirm &amp;&amp; client) {
<a name="l01498"></a>01498          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01499"></a>01499          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01500"></a>01500          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01501"></a>01501          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01502"></a>01502          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#items&quot;</span>);
<a name="l01503"></a>01503          iks_insert_attrib(query, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>);
<a name="l01504"></a>01504          iks_insert_attrib(confirm, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;confirmaccount&quot;</span>);
<a name="l01505"></a>01505          iks_insert_attrib(confirm, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;Confirm AIM account&quot;</span>);
<a name="l01506"></a>01506          iks_insert_attrib(confirm, <span class="stringliteral">&quot;jid&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01507"></a>01507          iks_insert_node(iq, query);
<a name="l01508"></a>01508          iks_insert_node(query, confirm);
<a name="l01509"></a>01509          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01510"></a>01510       } <span class="keywordflow">else</span> {
<a name="l01511"></a>01511          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01512"></a>01512       }
<a name="l01513"></a>01513 
<a name="l01514"></a>01514       iks_delete(iq);
<a name="l01515"></a>01515       iks_delete(query);
<a name="l01516"></a>01516       iks_delete(confirm);
<a name="l01517"></a>01517 
<a name="l01518"></a>01518    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_GET &amp;&amp; !strcasecmp(node, <span class="stringliteral">&quot;confirmaccount&quot;</span>)) {
<a name="l01519"></a>01519       iks *iq, *query, *feature;
<a name="l01520"></a>01520 
<a name="l01521"></a>01521       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01522"></a>01522       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01523"></a>01523       feature = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01524"></a>01524 
<a name="l01525"></a>01525       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; feature &amp;&amp; client) {
<a name="l01526"></a>01526          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01527"></a>01527          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01528"></a>01528          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01529"></a>01529          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01530"></a>01530          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>);
<a name="l01531"></a>01531          iks_insert_attrib(feature, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>);
<a name="l01532"></a>01532          iks_insert_node(iq, query);
<a name="l01533"></a>01533          iks_insert_node(query, feature);
<a name="l01534"></a>01534          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01535"></a>01535       } <span class="keywordflow">else</span> {
<a name="l01536"></a>01536          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01537"></a>01537       }
<a name="l01538"></a>01538 
<a name="l01539"></a>01539       iks_delete(iq);
<a name="l01540"></a>01540       iks_delete(query);
<a name="l01541"></a>01541       iks_delete(feature);
<a name="l01542"></a>01542    }
<a name="l01543"></a>01543 
<a name="l01544"></a>01544    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01545"></a>01545    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01546"></a>01546 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1fa5630459ae90c51157f306d589a96c"></a><!-- doxytag: member="res_jabber.c::aji_ditems_handler" ref="a1fa5630459ae90c51157f306d589a96c" args="(void *data, ikspak *pak)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_ditems_handler </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ikspak *&nbsp;</td>
          <td class="paramname"> <em>pak</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Handles stuff. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>void </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pak</em>&nbsp;</td><td>ikspak </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_FILTER_EAT. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01258">1258</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="jabber_8h_source.html#l00143">aji_client::user</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01259"></a>01259 {
<a name="l01260"></a>01260    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l01261"></a>01261    <span class="keywordtype">char</span> *node = NULL;
<a name="l01262"></a>01262 
<a name="l01263"></a>01263    <span class="keywordflow">if</span> (!(node = iks_find_attrib(pak-&gt;query, <span class="stringliteral">&quot;node&quot;</span>))) {
<a name="l01264"></a>01264       iks *iq = NULL, *query = NULL, *item = NULL;
<a name="l01265"></a>01265       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01266"></a>01266       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01267"></a>01267       item = iks_new(<span class="stringliteral">&quot;item&quot;</span>);
<a name="l01268"></a>01268 
<a name="l01269"></a>01269       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; item) {
<a name="l01270"></a>01270          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01271"></a>01271          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01272"></a>01272          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01273"></a>01273          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01274"></a>01274          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#items&quot;</span>);
<a name="l01275"></a>01275          iks_insert_attrib(item, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>);
<a name="l01276"></a>01276          iks_insert_attrib(item, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;Million Dollar Asterisk Commands&quot;</span>);
<a name="l01277"></a>01277          iks_insert_attrib(item, <span class="stringliteral">&quot;jid&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01278"></a>01278 
<a name="l01279"></a>01279          iks_insert_node(iq, query);
<a name="l01280"></a>01280          iks_insert_node(query, item);
<a name="l01281"></a>01281          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01282"></a>01282       } <span class="keywordflow">else</span> {
<a name="l01283"></a>01283          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01284"></a>01284       }
<a name="l01285"></a>01285 
<a name="l01286"></a>01286       iks_delete(iq);
<a name="l01287"></a>01287       iks_delete(query);
<a name="l01288"></a>01288       iks_delete(item);
<a name="l01289"></a>01289 
<a name="l01290"></a>01290    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(node, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>)) {
<a name="l01291"></a>01291       iks *iq, *query, *confirm;
<a name="l01292"></a>01292       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01293"></a>01293       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01294"></a>01294       confirm = iks_new(<span class="stringliteral">&quot;item&quot;</span>);
<a name="l01295"></a>01295       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; confirm &amp;&amp; client) {
<a name="l01296"></a>01296          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01297"></a>01297          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01298"></a>01298          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01299"></a>01299          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01300"></a>01300          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#items&quot;</span>);
<a name="l01301"></a>01301          iks_insert_attrib(query, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>);
<a name="l01302"></a>01302          iks_insert_attrib(confirm, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;confirmaccount&quot;</span>);
<a name="l01303"></a>01303          iks_insert_attrib(confirm, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;Confirm AIM account&quot;</span>);
<a name="l01304"></a>01304          iks_insert_attrib(confirm, <span class="stringliteral">&quot;jid&quot;</span>, <span class="stringliteral">&quot;blog.astjab.org&quot;</span>);
<a name="l01305"></a>01305 
<a name="l01306"></a>01306          iks_insert_node(iq, query);
<a name="l01307"></a>01307          iks_insert_node(query, confirm);
<a name="l01308"></a>01308          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01309"></a>01309       } <span class="keywordflow">else</span> {
<a name="l01310"></a>01310          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01311"></a>01311       }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313       iks_delete(iq);
<a name="l01314"></a>01314       iks_delete(query);
<a name="l01315"></a>01315       iks_delete(confirm);
<a name="l01316"></a>01316 
<a name="l01317"></a>01317    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(node, <span class="stringliteral">&quot;confirmaccount&quot;</span>)) {
<a name="l01318"></a>01318       iks *iq = NULL, *query = NULL, *feature = NULL;
<a name="l01319"></a>01319 
<a name="l01320"></a>01320       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01321"></a>01321       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01322"></a>01322       feature = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01323"></a>01323 
<a name="l01324"></a>01324       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; feature &amp;&amp; client) {
<a name="l01325"></a>01325          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01326"></a>01326          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01327"></a>01327          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01328"></a>01328          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01329"></a>01329          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#items&quot;</span>);
<a name="l01330"></a>01330          iks_insert_attrib(feature, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>);
<a name="l01331"></a>01331          iks_insert_node(iq, query);
<a name="l01332"></a>01332          iks_insert_node(query, feature);
<a name="l01333"></a>01333          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01334"></a>01334       } <span class="keywordflow">else</span> {
<a name="l01335"></a>01335          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01336"></a>01336       }
<a name="l01337"></a>01337 
<a name="l01338"></a>01338       iks_delete(iq);
<a name="l01339"></a>01339       iks_delete(query);
<a name="l01340"></a>01340       iks_delete(feature);
<a name="l01341"></a>01341    }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01344"></a>01344    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01345"></a>01345 
<a name="l01346"></a>01346 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0a89c3ed58b2a5083948fb2fa980eb88"></a><!-- doxytag: member="res_jabber.c::aji_do_reload" ref="a0a89c3ed58b2a5083948fb2fa980eb88" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char * aji_do_reload </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reload jabber module. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>CLI_SUCCESS. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02482">2482</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l03035">aji_reload()</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02483"></a>02483 {
<a name="l02484"></a>02484    <span class="keywordflow">switch</span> (cmd) {
<a name="l02485"></a>02485    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l02486"></a>02486       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;jabber reload&quot;</span>;
<a name="l02487"></a>02487       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l02488"></a>02488          <span class="stringliteral">&quot;Usage: jabber reload\n&quot;</span>
<a name="l02489"></a>02489          <span class="stringliteral">&quot;       Reloads the Jabber module.\n&quot;</span>;
<a name="l02490"></a>02490       <span class="keywordflow">return</span> NULL;
<a name="l02491"></a>02491    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l02492"></a>02492       <span class="keywordflow">return</span> NULL;
<a name="l02493"></a>02493    }
<a name="l02494"></a>02494 
<a name="l02495"></a>02495    <a class="code" href="res__jabber_8c.html#ad7e3d90484987374674cd6568d39a3de" title="Reload the jabber module.">aji_reload</a>(1);
<a name="l02496"></a>02496    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Jabber Reloaded.\n&quot;</span>);
<a name="l02497"></a>02497    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02498"></a>02498 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af61d5277d284f24cf7e83867342ed724"></a><!-- doxytag: member="res_jabber.c::aji_do_set_debug" ref="af61d5277d284f24cf7e83867342ed724" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char * aji_do_set_debug </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Turn on/off <a class="el" href="structconsole.html">console</a> debugging. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>CLI_SUCCESS. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02442">2442</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8h_source.html#l00167">ast_cli_entry::args</a>, <a class="el" href="cli_8h_source.html#l00141">ast_cli_args::argv</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="astobj_8h_source.html#l00376">ASTOBJ_CONTAINER_TRAVERSE</a>, <a class="el" href="astobj_8h_source.html#l00100">ASTOBJ_RDLOCK</a>, <a class="el" href="astobj_8h_source.html#l00109">ASTOBJ_UNLOCK</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="res__jabber_8c_source.html#l00246">clients</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02443"></a>02443 {
<a name="l02444"></a>02444    <span class="keywordflow">switch</span> (cmd) {
<a name="l02445"></a>02445    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l02446"></a>02446       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;jabber set debug {on|off}&quot;</span>;
<a name="l02447"></a>02447       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l02448"></a>02448          <span class="stringliteral">&quot;Usage: jabber set debug {on|off}\n&quot;</span>
<a name="l02449"></a>02449          <span class="stringliteral">&quot;       Enables/disables dumping of XMPP/Jabber packets for debugging purposes.\n&quot;</span>;
<a name="l02450"></a>02450       <span class="keywordflow">return</span> NULL;
<a name="l02451"></a>02451    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l02452"></a>02452       <span class="keywordflow">return</span> NULL;
<a name="l02453"></a>02453    }
<a name="l02454"></a>02454 
<a name="l02455"></a>02455    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l02456"></a>02456       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l02457"></a>02457 
<a name="l02458"></a>02458    <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1], <span class="stringliteral">&quot;on&quot;</span>, 2)) {
<a name="l02459"></a>02459       <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l02460"></a>02460          <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator); 
<a name="l02461"></a>02461          iterator-&gt;debug = 1;
<a name="l02462"></a>02462          <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02463"></a>02463       });
<a name="l02464"></a>02464       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Jabber Debugging Enabled.\n&quot;</span>);
<a name="l02465"></a>02465       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02466"></a>02466    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1], <span class="stringliteral">&quot;off&quot;</span>, 3)) {
<a name="l02467"></a>02467       <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l02468"></a>02468          <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator); 
<a name="l02469"></a>02469          iterator-&gt;debug = 0;
<a name="l02470"></a>02470          <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02471"></a>02471       });
<a name="l02472"></a>02472       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Jabber Debugging Disabled.\n&quot;</span>);
<a name="l02473"></a>02473       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02474"></a>02474    }
<a name="l02475"></a>02475    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>; <span class="comment">/* defaults to invalid */</span>
<a name="l02476"></a>02476 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab465ef5fd9bb14b30208091d039f1100"></a><!-- doxytag: member="res_jabber.c::aji_filter_roster" ref="ab465ef5fd9bb14b30208091d039f1100" args="(void *data, ikspak *pak)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_filter_roster </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ikspak *&nbsp;</td>
          <td class="paramname"> <em>pak</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>filters the roster packet we get back from server. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>void </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pak</em>&nbsp;</td><td>ikspak iksemel packet. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_FILTER_EAT. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02200">2200</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="jabber_8h_source.html#l00084">AJI_AUTOPRUNE</a>, <a class="el" href="jabber_8h_source.html#l00085">AJI_AUTOREGISTER</a>, <a class="el" href="jabber_8h_source.html#l00080">AJI_CONNECTED</a>, <a class="el" href="utils_8h_source.html#l00075">ast_clear_flag</a>, <a class="el" href="utils_8h_source.html#l00082">ast_copy_flags</a>, <a class="el" href="astobj_8h_source.html#l00376">ASTOBJ_CONTAINER_TRAVERSE</a>, <a class="el" href="astobj_8h_source.html#l00100">ASTOBJ_RDLOCK</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="astobj_8h_source.html#l00109">ASTOBJ_UNLOCK</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="jabber_8h_source.html#l00170">aji_client::flags</a>, and <a class="el" href="jabber_8h_source.html#l00159">aji_client::state</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l02327">aji_client_connect()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02201"></a>02201 {
<a name="l02202"></a>02202    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l02203"></a>02203    <span class="keywordtype">int</span> flag = 0;
<a name="l02204"></a>02204    iks *x = NULL;
<a name="l02205"></a>02205    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy;
<a name="l02206"></a>02206    
<a name="l02207"></a>02207    client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a>;
<a name="l02208"></a>02208    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, 1, {
<a name="l02209"></a>02209       <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02210"></a>02210       x = iks_child(pak-&gt;query);
<a name="l02211"></a>02211       flag = 0;
<a name="l02212"></a>02212       <span class="keywordflow">while</span> (x) {
<a name="l02213"></a>02213          <span class="keywordflow">if</span> (!iks_strcmp(iks_name(x), <span class="stringliteral">&quot;item&quot;</span>)) {
<a name="l02214"></a>02214             <span class="keywordflow">if</span> (!strcasecmp(iterator-&gt;name, iks_find_attrib(x, <span class="stringliteral">&quot;jid&quot;</span>))) {
<a name="l02215"></a>02215                flag = 1;
<a name="l02216"></a>02216                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;iterator-&gt;flags, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a5bf8f469c15d256015b2a3084bcdef59">AJI_AUTOPRUNE</a> | <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02217"></a>02217             }
<a name="l02218"></a>02218          }
<a name="l02219"></a>02219          x = iks_next(x);
<a name="l02220"></a>02220       }
<a name="l02221"></a>02221       <span class="keywordflow">if</span> (!flag)
<a name="l02222"></a>02222          <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;iterator-&gt;flags, &amp;client-&gt;<a class="code" href="structaji__client.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02223"></a>02223       iks_delete(x);
<a name="l02224"></a>02224       
<a name="l02225"></a>02225       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02226"></a>02226    });
<a name="l02227"></a>02227 
<a name="l02228"></a>02228    x = iks_child(pak-&gt;query);
<a name="l02229"></a>02229    <span class="keywordflow">while</span> (x) {
<a name="l02230"></a>02230       flag = 0;
<a name="l02231"></a>02231       <span class="keywordflow">if</span> (iks_strcmp(iks_name(x), <span class="stringliteral">&quot;item&quot;</span>) == 0) {
<a name="l02232"></a>02232          <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, 1, {
<a name="l02233"></a>02233             <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02234"></a>02234             <span class="keywordflow">if</span> (!strcasecmp(iterator-&gt;name, iks_find_attrib(x, <span class="stringliteral">&quot;jid&quot;</span>)))
<a name="l02235"></a>02235                flag = 1;
<a name="l02236"></a>02236             <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02237"></a>02237          });
<a name="l02238"></a>02238 
<a name="l02239"></a>02239          <span class="keywordflow">if</span> (flag) {
<a name="l02240"></a>02240             <span class="comment">/* found buddy, don&apos;t create a new one */</span>
<a name="l02241"></a>02241             x = iks_next(x);
<a name="l02242"></a>02242             <span class="keywordflow">continue</span>;
<a name="l02243"></a>02243          }
<a name="l02244"></a>02244          
<a name="l02245"></a>02245          buddy = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*buddy));
<a name="l02246"></a>02246          <span class="keywordflow">if</span> (!buddy) {
<a name="l02247"></a>02247             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of memory\n&quot;</span>);
<a name="l02248"></a>02248             <span class="keywordflow">return</span> 0;
<a name="l02249"></a>02249          }
<a name="l02250"></a>02250          <a class="code" href="astobj_8h.html#a996db3d193843755068f61f21e14c3dd" title="Initialize an object.">ASTOBJ_INIT</a>(buddy);
<a name="l02251"></a>02251          <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(buddy);
<a name="l02252"></a>02252          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buddy-&gt;<a class="code" href="structaji__buddy.html#aa65d2e8413d62f15b0528e19af53a2b4">name</a>, iks_find_attrib(x, <span class="stringliteral">&quot;jid&quot;</span>), <span class="keyword">sizeof</span>(buddy-&gt;<a class="code" href="structaji__buddy.html#aa65d2e8413d62f15b0528e19af53a2b4">name</a>));
<a name="l02253"></a>02253          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;buddy-&gt;<a class="code" href="structaji__buddy.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l02254"></a>02254          <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a5bf8f469c15d256015b2a3084bcdef59">AJI_AUTOPRUNE</a>)) {
<a name="l02255"></a>02255             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;buddy-&gt;<a class="code" href="structaji__buddy.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a5bf8f469c15d256015b2a3084bcdef59">AJI_AUTOPRUNE</a>);
<a name="l02256"></a>02256             <a class="code" href="astobj_8h.html#ad51464686c5c2948bd337f8bb2c483b7" title="Mark an ASTOBJ by adding the ASTOBJ_FLAG_MARKED flag to its objflags mask.">ASTOBJ_MARK</a>(buddy);
<a name="l02257"></a>02257          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!iks_strcmp(iks_find_attrib(x, <span class="stringliteral">&quot;subscription&quot;</span>), <span class="stringliteral">&quot;none&quot;</span>) || !iks_strcmp(iks_find_attrib(x, <span class="stringliteral">&quot;subscription&quot;</span>), <span class="stringliteral">&quot;from&quot;</span>)) {
<a name="l02258"></a>02258             <span class="comment">/* subscribe to buddy&apos;s presence only </span>
<a name="l02259"></a>02259 <span class="comment">               if we really need to */</span>
<a name="l02260"></a>02260             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;buddy-&gt;<a class="code" href="structaji__buddy.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02261"></a>02261          }
<a name="l02262"></a>02262          <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(buddy);
<a name="l02263"></a>02263          <span class="keywordflow">if</span> (buddy) {
<a name="l02264"></a>02264             <a class="code" href="astobj_8h.html#a73bb2d9f59430fd47007a3c6ea651de6" title="Add an object to a container.">ASTOBJ_CONTAINER_LINK</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, buddy);
<a name="l02265"></a>02265             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(buddy, <a class="code" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561" title="Deletes the aji_buddy data structure.">aji_buddy_destroy</a>);
<a name="l02266"></a>02266          }
<a name="l02267"></a>02267       }
<a name="l02268"></a>02268       x = iks_next(x);
<a name="l02269"></a>02269    }
<a name="l02270"></a>02270 
<a name="l02271"></a>02271    iks_delete(x);
<a name="l02272"></a>02272    <a class="code" href="res__jabber_8c.html#a023bfb1346d00de355930f4224b94699" title="goes through roster and prunes users not needed in list, or adds them accordingly...">aji_pruneregister</a>(client);
<a name="l02273"></a>02273 
<a name="l02274"></a>02274    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02275"></a>02275    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l02276"></a>02276 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6628a57705b502b2c15c5c66bdc4bd67"></a><!-- doxytag: member="res_jabber.c::aji_find_resource" ref="a6628a57705b502b2c15c5c66bdc4bd67" args="(struct aji_buddy *buddy, char *name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structaji__resource.html">aji_resource</a>* aji_find_resource </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__buddy.html">aji_buddy</a> *&nbsp;</td>
          <td class="paramname"> <em>buddy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>name</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Find the <a class="el" href="structaji__resource.html">aji_resource</a> we want. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buddy</em>&nbsp;</td><td><a class="el" href="structaji__buddy.html">aji_buddy</a> A buddy </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>name</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd><a class="el" href="structaji__resource.html">aji_resource</a> object </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00370">370</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="jabber_8h_source.html#l00113">aji_resource::next</a>, <a class="el" href="jabber_8h_source.html#l00109">aji_resource::resource</a>, and <a class="el" href="jabber_8h_source.html#l00127">aji_buddy::resources</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00489">acf_jabberstatus_read()</a>, <a class="el" href="res__jabber_8c_source.html#l01353">aji_client_info_handler()</a>, <a class="el" href="res__jabber_8c_source.html#l01413">aji_dinfo_handler()</a>, and <a class="el" href="res__jabber_8c_source.html#l00432">aji_status_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00371"></a>00371 {
<a name="l00372"></a>00372    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *res = NULL;
<a name="l00373"></a>00373    <span class="keywordflow">if</span> (!buddy || !<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l00374"></a>00374       <span class="keywordflow">return</span> res;
<a name="l00375"></a>00375    res = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l00376"></a>00376    <span class="keywordflow">while</span> (res) {
<a name="l00377"></a>00377       <span class="keywordflow">if</span> (!strcasecmp(res-&gt;<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)) {
<a name="l00378"></a>00378          <span class="keywordflow">break</span>;
<a name="l00379"></a>00379       }
<a name="l00380"></a>00380       res = res-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l00381"></a>00381    }
<a name="l00382"></a>00382    <span class="keywordflow">return</span> res;
<a name="l00383"></a>00383 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a26b7d6d55f963dbca6e3694d053273d5"></a><!-- doxytag: member="res_jabber.c::aji_find_version" ref="a26b7d6d55f963dbca6e3694d053273d5" args="(char *node, char *version, ikspak *pak)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structaji__version.html">aji_version</a>* aji_find_version </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>node</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>version</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ikspak *&nbsp;</td>
          <td class="paramname"> <em>pak</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Find version in XML stream and populate our capabilities list. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>node</em>&nbsp;</td><td>the node attribute in the caps element we'll look for or add to our list </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>version</em>&nbsp;</td><td>the version attribute in the caps element we'll look for or add to our list </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pak</em>&nbsp;</td><td>struct The XML stanza we're processing </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>a pointer to the added or found <a class="el" href="structaji__version.html">aji_version</a> structure </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00303">303</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astmm_8h_source.html#l00081">ast_malloc</a>, <a class="el" href="jabber_8h_source.html#l00096">aji_version::jingle</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="jabber_8h_source.html#l00104">aji_capabilities::next</a>, <a class="el" href="jabber_8h_source.html#l00098">aji_version::next</a>, <a class="el" href="jabber_8h_source.html#l00102">aji_capabilities::node</a>, <a class="el" href="jabber_8h_source.html#l00097">aji_version::parent</a>, <a class="el" href="jabber_8h_source.html#l00095">aji_version::version</a>, and <a class="el" href="jabber_8h_source.html#l00103">aji_capabilities::versions</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l01604">aji_handle_presence()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00304"></a>00304 {
<a name="l00305"></a>00305    <span class="keyword">struct </span><a class="code" href="structaji__capabilities.html">aji_capabilities</a> *list = NULL;
<a name="l00306"></a>00306    <span class="keyword">struct </span><a class="code" href="structaji__version.html">aji_version</a> *res = NULL;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308    list = <a class="code" href="res__jabber_8c.html#aa7afd7ba4814dbf49b1867019891fd14">capabilities</a>;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310    <span class="keywordflow">if</span>(!node)
<a name="l00311"></a>00311       node = pak-&gt;from-&gt;full;
<a name="l00312"></a>00312    <span class="keywordflow">if</span>(!<a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>)
<a name="l00313"></a>00313       <a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> = <span class="stringliteral">&quot;none supplied.&quot;</span>;
<a name="l00314"></a>00314    <span class="keywordflow">while</span>(list) {
<a name="l00315"></a>00315       <span class="keywordflow">if</span>(!strcasecmp(list-&gt;<a class="code" href="structaji__capabilities.html#a987239273bb4a074ad22c76c6486d5b1">node</a>, node)) {
<a name="l00316"></a>00316          res = list-&gt;<a class="code" href="structaji__capabilities.html#abfcf4ae8635bc0465422997f97b656c8">versions</a>;
<a name="l00317"></a>00317          <span class="keywordflow">while</span>(res) {
<a name="l00318"></a>00318              <span class="keywordflow">if</span>(!strcasecmp(res-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>, <a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>))
<a name="l00319"></a>00319                 <span class="keywordflow">return</span> res;
<a name="l00320"></a>00320              res = res-&gt;<a class="code" href="structaji__version.html#a44b6483c4f7906a4da3ef6381c5b24f7">next</a>;
<a name="l00321"></a>00321          }
<a name="l00322"></a>00322          <span class="comment">/* Specified version not found. Let&apos;s add it to </span>
<a name="l00323"></a>00323 <span class="comment">            this node in our capabilities list */</span>
<a name="l00324"></a>00324          <span class="keywordflow">if</span>(!res) {
<a name="l00325"></a>00325             res = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(<span class="keyword">sizeof</span>(*res));
<a name="l00326"></a>00326             <span class="keywordflow">if</span>(!res) {
<a name="l00327"></a>00327                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory!\n&quot;</span>);
<a name="l00328"></a>00328                <span class="keywordflow">return</span> NULL;
<a name="l00329"></a>00329             }
<a name="l00330"></a>00330             res-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> = 0;
<a name="l00331"></a>00331             res-&gt;<a class="code" href="structaji__version.html#a99020efc7f580df36182fc3be139f1b9">parent</a> = list;
<a name="l00332"></a>00332             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(res-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>, <a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>, <span class="keyword">sizeof</span>(res-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>));
<a name="l00333"></a>00333             res-&gt;<a class="code" href="structaji__version.html#a44b6483c4f7906a4da3ef6381c5b24f7">next</a> = list-&gt;<a class="code" href="structaji__capabilities.html#abfcf4ae8635bc0465422997f97b656c8">versions</a>;
<a name="l00334"></a>00334             list-&gt;<a class="code" href="structaji__capabilities.html#abfcf4ae8635bc0465422997f97b656c8">versions</a> = res;
<a name="l00335"></a>00335             <span class="keywordflow">return</span> res;
<a name="l00336"></a>00336          }
<a name="l00337"></a>00337       }
<a name="l00338"></a>00338       list = list-&gt;<a class="code" href="structaji__capabilities.html#a121b3d8dfc41b0b80678fb8de4e4f109">next</a>;
<a name="l00339"></a>00339    }
<a name="l00340"></a>00340    <span class="comment">/* Specified node not found. Let&apos;s add it our capabilities list */</span>
<a name="l00341"></a>00341    <span class="keywordflow">if</span>(!list) {
<a name="l00342"></a>00342       list = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(<span class="keyword">sizeof</span>(*list));
<a name="l00343"></a>00343       <span class="keywordflow">if</span>(!list) {
<a name="l00344"></a>00344          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory!\n&quot;</span>);
<a name="l00345"></a>00345          <span class="keywordflow">return</span> NULL;
<a name="l00346"></a>00346       }
<a name="l00347"></a>00347       res = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(<span class="keyword">sizeof</span>(*res));
<a name="l00348"></a>00348       <span class="keywordflow">if</span>(!res) {
<a name="l00349"></a>00349          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory!\n&quot;</span>);
<a name="l00350"></a>00350          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(list);
<a name="l00351"></a>00351          <span class="keywordflow">return</span> NULL;
<a name="l00352"></a>00352       }
<a name="l00353"></a>00353       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(list-&gt;<a class="code" href="structaji__capabilities.html#a987239273bb4a074ad22c76c6486d5b1">node</a>, node, <span class="keyword">sizeof</span>(list-&gt;<a class="code" href="structaji__capabilities.html#a987239273bb4a074ad22c76c6486d5b1">node</a>));
<a name="l00354"></a>00354       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(res-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>, <a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>, <span class="keyword">sizeof</span>(res-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>));
<a name="l00355"></a>00355       res-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> = 0;
<a name="l00356"></a>00356       res-&gt;<a class="code" href="structaji__version.html#a99020efc7f580df36182fc3be139f1b9">parent</a> = list;
<a name="l00357"></a>00357       res-&gt;<a class="code" href="structaji__version.html#a44b6483c4f7906a4da3ef6381c5b24f7">next</a> = NULL;
<a name="l00358"></a>00358       list-&gt;<a class="code" href="structaji__capabilities.html#abfcf4ae8635bc0465422997f97b656c8">versions</a> = res;
<a name="l00359"></a>00359       list-&gt;<a class="code" href="structaji__capabilities.html#a121b3d8dfc41b0b80678fb8de4e4f109">next</a> = <a class="code" href="res__jabber_8c.html#aa7afd7ba4814dbf49b1867019891fd14">capabilities</a>;
<a name="l00360"></a>00360       <a class="code" href="res__jabber_8c.html#aa7afd7ba4814dbf49b1867019891fd14">capabilities</a> = list;
<a name="l00361"></a>00361    }
<a name="l00362"></a>00362    <span class="keywordflow">return</span> res;
<a name="l00363"></a>00363 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a064f178d1c5b750e1ee2c0a80da62771"></a><!-- doxytag: member="res_jabber.c::aji_get_roster" ref="a064f178d1c5b750e1ee2c0a80da62771" args="(struct aji_client *client)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_get_roster </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get the roster of jabber <a class="el" href="structusers.html" title="list of users found in the config file">users</a>. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>1. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02305">2305</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l02408">aji_set_presence()</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="jabber_8h_source.html#l00149">aji_client::jid</a>, <a class="el" href="jabber_8h_source.html#l00177">aji_client::status</a>, and <a class="el" href="jabber_8h_source.html#l00145">aji_client::statusmessage</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l02327">aji_client_connect()</a>, and <a class="el" href="res__jabber_8c_source.html#l03035">aji_reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02306"></a>02306 {
<a name="l02307"></a>02307    iks *roster = NULL;
<a name="l02308"></a>02308    roster = iks_make_iq(IKS_TYPE_GET, IKS_NS_ROSTER);
<a name="l02309"></a>02309 
<a name="l02310"></a>02310    <span class="keywordflow">if</span>(roster) {
<a name="l02311"></a>02311       iks_insert_attrib(roster, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;roster&quot;</span>);
<a name="l02312"></a>02312       <a class="code" href="res__jabber_8c.html#a889348ddb7c785a009c26acb81ed232c" title="set presence of client.">aji_set_presence</a>(client, NULL, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full, client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a>, client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>);
<a name="l02313"></a>02313       <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, roster);
<a name="l02314"></a>02314    }
<a name="l02315"></a>02315 
<a name="l02316"></a>02316    iks_delete(roster);
<a name="l02317"></a>02317    
<a name="l02318"></a>02318    <span class="keywordflow">return</span> 1;
<a name="l02319"></a>02319 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab9777927f36394dc186f89a30b222135"></a><!-- doxytag: member="res_jabber.c::aji_handle_iq" ref="ab9777927f36394dc186f89a30b222135" args="(struct aji_client *client, iks *node)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void aji_handle_iq </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">iks *&nbsp;</td>
          <td class="paramname"> <em>node</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Handles. </p>
<div class="fragment"><pre class="fragment">&lt;iq&gt; </pre></div><p> tags. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>node</em>&nbsp;</td><td>iks </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>void. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01554">1554</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01555"></a>01555 {
<a name="l01556"></a>01556    <span class="comment">/*Nothing to see here */</span>
<a name="l01557"></a>01557 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7a01af36e4db2dfe018982d63fda2fb2"></a><!-- doxytag: member="res_jabber.c::aji_handle_message" ref="a7a01af36e4db2dfe018982d63fda2fb2" args="(struct aji_client *client, ikspak *pak)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void aji_handle_message </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ikspak *&nbsp;</td>
          <td class="paramname"> <em>pak</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Handles presence packets. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pak</em>&nbsp;</td><td>ikspak the node </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01564">1564</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="jabber_8h_source.html#l00120">aji_message::arrived</a>, <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="linkedlists_8h_source.html#l00695">AST_LIST_INSERT_HEAD</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00553">AST_LIST_REMOVE_CURRENT</a>, <a class="el" href="linkedlists_8h_source.html#l00528">AST_LIST_TRAVERSE_SAFE_BEGIN</a>, <a class="el" href="linkedlists_8h_source.html#l00599">AST_LIST_TRAVERSE_SAFE_END</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="astmm_8h_source.html#l00099">ast_strdup</a>, <a class="el" href="jabber_8h_source.html#l00117">aji_message::from</a>, <a class="el" href="jabber_8h_source.html#l00119">aji_message::id</a>, <a class="el" href="jabber_8h_source.html#l00118">aji_message::message</a>, and <a class="el" href="jabber_8h_source.html#l00168">aji_client::message_timeout</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01565"></a>01565 {
<a name="l01566"></a>01566    <span class="keyword">struct </span><a class="code" href="structaji__message.html">aji_message</a> *insert, *tmp;
<a name="l01567"></a>01567    <span class="keywordtype">int</span> flag = 0;
<a name="l01568"></a>01568    
<a name="l01569"></a>01569    <span class="keywordflow">if</span> (!(insert = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*insert))))
<a name="l01570"></a>01570       <span class="keywordflow">return</span>;
<a name="l01571"></a>01571    time(&amp;insert-&gt;<a class="code" href="structaji__message.html#aec3ba7effb2fee6e19a3a258b1749394">arrived</a>);
<a name="l01572"></a>01572    <span class="keywordflow">if</span> (iks_find_cdata(pak-&gt;x, <span class="stringliteral">&quot;body&quot;</span>))
<a name="l01573"></a>01573       insert-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(iks_find_cdata(pak-&gt;x, <span class="stringliteral">&quot;body&quot;</span>));
<a name="l01574"></a>01574    <span class="keywordflow">if</span> (pak-&gt;id)
<a name="l01575"></a>01575       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(insert-&gt;<a class="code" href="structaji__message.html#a51d291314bf1da3f9ac4479963a4fadd">id</a>, pak-&gt;id, <span class="keyword">sizeof</span>(insert-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>));
<a name="l01576"></a>01576    <span class="keywordflow">if</span> (pak-&gt;from)
<a name="l01577"></a>01577       insert-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(pak-&gt;from-&gt;full);
<a name="l01578"></a>01578    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;client-&gt;messages);
<a name="l01579"></a>01579    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;client-&gt;messages, tmp, list) {
<a name="l01580"></a>01580       <span class="keywordflow">if</span> (flag) {
<a name="l01581"></a>01581          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l01582"></a>01582          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>)
<a name="l01583"></a>01583             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>);
<a name="l01584"></a>01584          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>)
<a name="l01585"></a>01585             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>);
<a name="l01586"></a>01586       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (difftime(time(NULL), tmp-&gt;<a class="code" href="structaji__message.html#aec3ba7effb2fee6e19a3a258b1749394">arrived</a>) &gt;= client-&gt;<a class="code" href="structaji__client.html#afcb76ae4daf94120b9c6e8e3a8926e36">message_timeout</a>) {
<a name="l01587"></a>01587          flag = 1;
<a name="l01588"></a>01588          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l01589"></a>01589          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>)
<a name="l01590"></a>01590             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>);
<a name="l01591"></a>01591          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>)
<a name="l01592"></a>01592             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>);
<a name="l01593"></a>01593       }
<a name="l01594"></a>01594    }
<a name="l01595"></a>01595    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l01596"></a>01596    <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;client-&gt;messages, insert, list);
<a name="l01597"></a>01597    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;client-&gt;messages);
<a name="l01598"></a>01598 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a163e096310bad60196f9b09b4d5169af"></a><!-- doxytag: member="res_jabber.c::aji_handle_presence" ref="a163e096310bad60196f9b09b4d5169af" args="(struct aji_client *client, ikspak *pak)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void aji_handle_presence </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ikspak *&nbsp;</td>
          <td class="paramname"> <em>pak</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check the presence info. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pak</em>&nbsp;</td><td>ikspak </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01604">1604</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00281">aji_buddy_destroy()</a>, <a class="el" href="jabber_8h_source.html#l00080">AJI_CONNECTED</a>, <a class="el" href="res__jabber_8c_source.html#l02880">aji_create_buddy()</a>, <a class="el" href="res__jabber_8c_source.html#l00303">aji_find_version()</a>, <a class="el" href="res__jabber_8c_source.html#l02408">aji_set_presence()</a>, <a class="el" href="res__jabber_8c_source.html#l02038">ast_aji_increment_mid()</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astmm_8h_source.html#l00099">ast_strdup</a>, <a class="el" href="logger_8h_source.html#l00079">ast_verbose</a>, <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, <a class="el" href="astobj_8h_source.html#l00109">ASTOBJ_UNLOCK</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="astobj_8h_source.html#l00104">ASTOBJ_WRLOCK</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="jabber_8h_source.html#l00171">aji_client::component</a>, <a class="el" href="app__externalivr_8c_source.html#l00054">descrip</a>, <a class="el" href="jabber_8h_source.html#l00110">aji_resource::description</a>, <a class="el" href="res__jabber_8c_source.html#l00390">gtalk_yuck()</a>, <a class="el" href="jabber_8h_source.html#l00149">aji_client::jid</a>, <a class="el" href="devicestate_8c_source.html#l00198">last</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="jabber_8h_source.html#l00148">aji_client::mid</a>, <a class="el" href="jabber_8h_source.html#l00113">aji_resource::next</a>, <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>, <a class="el" href="jabber_8h_source.html#l00112">aji_resource::priority</a>, <a class="el" href="jabber_8h_source.html#l00109">aji_resource::resource</a>, <a class="el" href="jabber_8h_source.html#l00127">aji_buddy::resources</a>, <a class="el" href="jabber_8h_source.html#l00159">aji_client::state</a>, <a class="el" href="jabber_8h_source.html#l00108">aji_resource::status</a>, <a class="el" href="jabber_8h_source.html#l00177">aji_client::status</a>, <a class="el" href="app__jack_8c_source.html#l00141">status</a>, <a class="el" href="jabber_8h_source.html#l00145">aji_client::statusmessage</a>, <a class="el" href="evt_8c_source.html#l00071">type</a>, and <a class="el" href="adsistub_8c_source.html#l00053">ver</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01605"></a>01605 {
<a name="l01606"></a>01606    <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>, priority;
<a name="l01607"></a>01607    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy;
<a name="l01608"></a>01608    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *tmp = NULL, *<a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a> = NULL, *found = NULL;
<a name="l01609"></a>01609    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a4408245b2edc5f227220ea4f24ea0fab">ver</a>, *node, *<a class="code" href="app__externalivr_8c.html#a39aaf66c43ce14a3febf2c17aa7738d2">descrip</a>, *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>;
<a name="l01610"></a>01610    
<a name="l01611"></a>01611    <span class="keywordflow">if</span>(client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> != <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a>)
<a name="l01612"></a>01612       <a class="code" href="res__jabber_8c.html#a1097eeb9e8887f482496e95a77cbb371" title="creates buddy.">aji_create_buddy</a>(pak-&gt;from-&gt;partial, client);
<a name="l01613"></a>01613 
<a name="l01614"></a>01614    buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, pak-&gt;from-&gt;partial);
<a name="l01615"></a>01615    <span class="keywordflow">if</span> (!buddy &amp;&amp; pak-&gt;from-&gt;partial) {
<a name="l01616"></a>01616       <span class="comment">/* allow our jid to be used to log in with another resource */</span>
<a name="l01617"></a>01617       <span class="keywordflow">if</span> (!strcmp((<span class="keyword">const</span> <span class="keywordtype">char</span> *)pak-&gt;from-&gt;partial, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;partial))
<a name="l01618"></a>01618          <a class="code" href="res__jabber_8c.html#a1097eeb9e8887f482496e95a77cbb371" title="creates buddy.">aji_create_buddy</a>(pak-&gt;from-&gt;partial, client);
<a name="l01619"></a>01619       <span class="keywordflow">else</span>
<a name="l01620"></a>01620          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Got presence packet from %s, someone not in our roster!!!!\n&quot;</span>, pak-&gt;from-&gt;partial);
<a name="l01621"></a>01621       <span class="keywordflow">return</span>;
<a name="l01622"></a>01622    }
<a name="l01623"></a>01623    type = iks_find_attrib(pak-&gt;x, <span class="stringliteral">&quot;type&quot;</span>);
<a name="l01624"></a>01624    <span class="keywordflow">if</span>(client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a> &amp;&amp; type &amp;&amp;!strcasecmp(<span class="stringliteral">&quot;probe&quot;</span>, type)) {
<a name="l01625"></a>01625       <a class="code" href="res__jabber_8c.html#a889348ddb7c785a009c26acb81ed232c" title="set presence of client.">aji_set_presence</a>(client, pak-&gt;from-&gt;full, iks_find_attrib(pak-&gt;x, <span class="stringliteral">&quot;to&quot;</span>), client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a>, client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>);
<a name="l01626"></a>01626       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;what i was looking for \n&quot;</span>);
<a name="l01627"></a>01627    }
<a name="l01628"></a>01628    <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(buddy);
<a name="l01629"></a>01629    status = (pak-&gt;show) ? pak-&gt;show : 6;
<a name="l01630"></a>01630    priority = atoi((iks_find_cdata(pak-&gt;x, <span class="stringliteral">&quot;priority&quot;</span>)) ? iks_find_cdata(pak-&gt;x, <span class="stringliteral">&quot;priority&quot;</span>) : <span class="stringliteral">&quot;0&quot;</span>);
<a name="l01631"></a>01631    tmp = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l01632"></a>01632    descrip = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(iks_find_cdata(pak-&gt;x,<span class="stringliteral">&quot;status&quot;</span>));
<a name="l01633"></a>01633 
<a name="l01634"></a>01634    <span class="keywordflow">while</span> (tmp &amp;&amp; pak-&gt;from-&gt;<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>) {
<a name="l01635"></a>01635       <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>, pak-&gt;from-&gt;resource)) {
<a name="l01636"></a>01636          tmp-&gt;<a class="code" href="structaji__resource.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = status;
<a name="l01637"></a>01637          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__resource.html#a8444d6e0dfe2bbab0b5e7b24308f1559">description</a>) <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__resource.html#a8444d6e0dfe2bbab0b5e7b24308f1559">description</a>);
<a name="l01638"></a>01638          tmp-&gt;<a class="code" href="structaji__resource.html#a8444d6e0dfe2bbab0b5e7b24308f1559">description</a> = descrip;
<a name="l01639"></a>01639          found = tmp;
<a name="l01640"></a>01640          <span class="keywordflow">if</span> (status == 6) {   <span class="comment">/* Sign off Destroy resource */</span>
<a name="l01641"></a>01641             <span class="keywordflow">if</span> (last &amp;&amp; found-&gt;next) {
<a name="l01642"></a>01642                last-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = found-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l01643"></a>01643             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!last) {
<a name="l01644"></a>01644                <span class="keywordflow">if</span> (found-&gt;next)
<a name="l01645"></a>01645                   buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = found-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l01646"></a>01646                <span class="keywordflow">else</span>
<a name="l01647"></a>01647                   buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = NULL;
<a name="l01648"></a>01648             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!found-&gt;next) {
<a name="l01649"></a>01649                <span class="keywordflow">if</span> (last)
<a name="l01650"></a>01650                   last-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = NULL;
<a name="l01651"></a>01651                <span class="keywordflow">else</span>
<a name="l01652"></a>01652                   buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = NULL;
<a name="l01653"></a>01653             }
<a name="l01654"></a>01654             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(found);
<a name="l01655"></a>01655             found = NULL;
<a name="l01656"></a>01656             <span class="keywordflow">break</span>;
<a name="l01657"></a>01657          }
<a name="l01658"></a>01658          <span class="comment">/* resource list is sorted by descending priority */</span>
<a name="l01659"></a>01659          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__resource.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> != priority) {
<a name="l01660"></a>01660             found-&gt;priority = priority;
<a name="l01661"></a>01661             <span class="keywordflow">if</span> (!last &amp;&amp; !found-&gt;next)
<a name="l01662"></a>01662                <span class="comment">/* resource was found to be unique,</span>
<a name="l01663"></a>01663 <span class="comment">                  leave loop */</span>
<a name="l01664"></a>01664                <span class="keywordflow">break</span>;
<a name="l01665"></a>01665             <span class="comment">/* search for resource in our list</span>
<a name="l01666"></a>01666 <span class="comment">               and take it out for the moment */</span>
<a name="l01667"></a>01667             <span class="keywordflow">if</span> (last)
<a name="l01668"></a>01668                last-&gt;next = found-&gt;next;
<a name="l01669"></a>01669             <span class="keywordflow">else</span>
<a name="l01670"></a>01670                buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = found-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l01671"></a>01671 
<a name="l01672"></a>01672             last = NULL;
<a name="l01673"></a>01673             tmp = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l01674"></a>01674             <span class="keywordflow">if</span> (!buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>)
<a name="l01675"></a>01675                buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = found;
<a name="l01676"></a>01676             <span class="comment">/* priority processing */</span>
<a name="l01677"></a>01677             <span class="keywordflow">while</span> (tmp) {
<a name="l01678"></a>01678                <span class="comment">/* insert resource back according to </span>
<a name="l01679"></a>01679 <span class="comment">                  its priority value */</span>
<a name="l01680"></a>01680                <span class="keywordflow">if</span> (found-&gt;priority &gt; tmp-&gt;<a class="code" href="structaji__resource.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>) {
<a name="l01681"></a>01681                   <span class="keywordflow">if</span> (last)
<a name="l01682"></a>01682                      <span class="comment">/* insert within list */</span>
<a name="l01683"></a>01683                      last-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = found;
<a name="l01684"></a>01684                   found-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = tmp;
<a name="l01685"></a>01685                   <span class="keywordflow">if</span> (!last)
<a name="l01686"></a>01686                      <span class="comment">/* insert on top */</span>
<a name="l01687"></a>01687                      buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = found;
<a name="l01688"></a>01688                   <span class="keywordflow">break</span>;
<a name="l01689"></a>01689                }
<a name="l01690"></a>01690                <span class="keywordflow">if</span> (!tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>) {
<a name="l01691"></a>01691                   <span class="comment">/* insert at the end of the list */</span>
<a name="l01692"></a>01692                   tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = found;
<a name="l01693"></a>01693                   found-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = NULL;
<a name="l01694"></a>01694                   <span class="keywordflow">break</span>;
<a name="l01695"></a>01695                }
<a name="l01696"></a>01696                last = tmp;
<a name="l01697"></a>01697                tmp = tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l01698"></a>01698             }
<a name="l01699"></a>01699          }
<a name="l01700"></a>01700          <span class="keywordflow">break</span>;
<a name="l01701"></a>01701       }
<a name="l01702"></a>01702       last = tmp;
<a name="l01703"></a>01703       tmp = tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l01704"></a>01704    }
<a name="l01705"></a>01705 
<a name="l01706"></a>01706    <span class="comment">/* resource not found in our list, create it */</span>
<a name="l01707"></a>01707    <span class="keywordflow">if</span> (!found &amp;&amp; status != 6 &amp;&amp; pak-&gt;from-&gt;resource) {
<a name="l01708"></a>01708       found = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*found));
<a name="l01709"></a>01709 
<a name="l01710"></a>01710       <span class="keywordflow">if</span> (!found) {
<a name="l01711"></a>01711          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory!\n&quot;</span>);
<a name="l01712"></a>01712          <span class="keywordflow">return</span>;
<a name="l01713"></a>01713       }
<a name="l01714"></a>01714       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(found-&gt;resource, pak-&gt;from-&gt;resource, <span class="keyword">sizeof</span>(found-&gt;resource));
<a name="l01715"></a>01715       found-&gt;status = status;
<a name="l01716"></a>01716       found-&gt;description = descrip;
<a name="l01717"></a>01717       found-&gt;priority = priority;
<a name="l01718"></a>01718       found-&gt;next = NULL;
<a name="l01719"></a>01719       last = NULL;
<a name="l01720"></a>01720       tmp = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l01721"></a>01721       <span class="keywordflow">while</span> (tmp) {
<a name="l01722"></a>01722          <span class="keywordflow">if</span> (found-&gt;priority &gt; tmp-&gt;<a class="code" href="structaji__resource.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>) {
<a name="l01723"></a>01723             <span class="keywordflow">if</span> (last)
<a name="l01724"></a>01724                last-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = found;
<a name="l01725"></a>01725             found-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = tmp;
<a name="l01726"></a>01726             <span class="keywordflow">if</span> (!last)
<a name="l01727"></a>01727                buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = found;
<a name="l01728"></a>01728             <span class="keywordflow">break</span>;
<a name="l01729"></a>01729          }
<a name="l01730"></a>01730          <span class="keywordflow">if</span> (!tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>) {
<a name="l01731"></a>01731             tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = found;
<a name="l01732"></a>01732             <span class="keywordflow">break</span>;
<a name="l01733"></a>01733          }
<a name="l01734"></a>01734          last = tmp;
<a name="l01735"></a>01735          tmp = tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l01736"></a>01736       }
<a name="l01737"></a>01737       <span class="keywordflow">if</span> (!tmp)
<a name="l01738"></a>01738          buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = found;
<a name="l01739"></a>01739    }
<a name="l01740"></a>01740    
<a name="l01741"></a>01741    <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(buddy);
<a name="l01742"></a>01742    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(buddy, <a class="code" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561" title="Deletes the aji_buddy data structure.">aji_buddy_destroy</a>);
<a name="l01743"></a>01743 
<a name="l01744"></a>01744    node = iks_find_attrib(iks_find(pak-&gt;x, <span class="stringliteral">&quot;c&quot;</span>), <span class="stringliteral">&quot;node&quot;</span>);
<a name="l01745"></a>01745    ver = iks_find_attrib(iks_find(pak-&gt;x, <span class="stringliteral">&quot;c&quot;</span>), <span class="stringliteral">&quot;ver&quot;</span>);
<a name="l01746"></a>01746 
<a name="l01747"></a>01747    <span class="comment">/* handle gmail client&apos;s special caps:c tag */</span>
<a name="l01748"></a>01748    <span class="keywordflow">if</span> (!node &amp;&amp; !ver) {
<a name="l01749"></a>01749       node = iks_find_attrib(iks_find(pak-&gt;x, <span class="stringliteral">&quot;caps:c&quot;</span>), <span class="stringliteral">&quot;node&quot;</span>);
<a name="l01750"></a>01750       ver = iks_find_attrib(iks_find(pak-&gt;x, <span class="stringliteral">&quot;caps:c&quot;</span>), <span class="stringliteral">&quot;ver&quot;</span>);
<a name="l01751"></a>01751    }
<a name="l01752"></a>01752 
<a name="l01753"></a>01753    <span class="comment">/* retrieve capabilites of the new resource */</span>
<a name="l01754"></a>01754    <span class="keywordflow">if</span>(status !=6 &amp;&amp; found &amp;&amp; !found-&gt;cap) {
<a name="l01755"></a>01755       found-&gt;cap = <a class="code" href="res__jabber_8c.html#a26b7d6d55f963dbca6e3694d053273d5" title="Find version in XML stream and populate our capabilities list.">aji_find_version</a>(node, ver, pak);
<a name="l01756"></a>01756       <span class="keywordflow">if</span>(<a class="code" href="res__jabber_8c.html#ad006b2b4ce6bbe60f32b13b3e430affb" title="Jabber GTalk function.">gtalk_yuck</a>(pak-&gt;x)) <span class="comment">/* gtalk should do discover */</span>
<a name="l01757"></a>01757          found-&gt;cap-&gt;jingle = 1;
<a name="l01758"></a>01758       <span class="keywordflow">if</span>(found-&gt;cap-&gt;jingle &amp;&amp; <a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 4) {
<a name="l01759"></a>01759          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;Special case for google till they support discover.\n&quot;</span>);
<a name="l01760"></a>01760       }
<a name="l01761"></a>01761       <span class="keywordflow">else</span> {
<a name="l01762"></a>01762          iks *iq, *query;
<a name="l01763"></a>01763          iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01764"></a>01764          query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01765"></a>01765          <span class="keywordflow">if</span>(query &amp;&amp; iq)  {
<a name="l01766"></a>01766             iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;get&quot;</span>);
<a name="l01767"></a>01767             iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01768"></a>01768             iks_insert_attrib(iq,<span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01769"></a>01769             iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01770"></a>01770             <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01771"></a>01771             iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>);
<a name="l01772"></a>01772             iks_insert_node(iq, query);
<a name="l01773"></a>01773             <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01774"></a>01774             
<a name="l01775"></a>01775          } <span class="keywordflow">else</span>
<a name="l01776"></a>01776             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01777"></a>01777          
<a name="l01778"></a>01778          iks_delete(query);
<a name="l01779"></a>01779          iks_delete(iq);
<a name="l01780"></a>01780       }
<a name="l01781"></a>01781    }
<a name="l01782"></a>01782    <span class="keywordflow">switch</span> (pak-&gt;subtype) {
<a name="l01783"></a>01783    <span class="keywordflow">case</span> IKS_TYPE_AVAILABLE:
<a name="l01784"></a>01784       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: I am available ^_* %i\n&quot;</span>, pak-&gt;subtype);
<a name="l01785"></a>01785       <span class="keywordflow">break</span>;
<a name="l01786"></a>01786    <span class="keywordflow">case</span> IKS_TYPE_UNAVAILABLE:
<a name="l01787"></a>01787       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: I am unavailable ^_* %i\n&quot;</span>, pak-&gt;subtype);
<a name="l01788"></a>01788       <span class="keywordflow">break</span>;
<a name="l01789"></a>01789    <span class="keywordflow">default</span>:
<a name="l01790"></a>01790       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: Ohh sexy and the wrong type: %i\n&quot;</span>, pak-&gt;subtype);
<a name="l01791"></a>01791    }
<a name="l01792"></a>01792    <span class="keywordflow">switch</span> (pak-&gt;show) {
<a name="l01793"></a>01793    <span class="keywordflow">case</span> IKS_SHOW_UNAVAILABLE:
<a name="l01794"></a>01794       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: type: %i subtype %i\n&quot;</span>, pak-&gt;subtype, pak-&gt;show);
<a name="l01795"></a>01795       <span class="keywordflow">break</span>;
<a name="l01796"></a>01796    <span class="keywordflow">case</span> IKS_SHOW_AVAILABLE:
<a name="l01797"></a>01797       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: type is available\n&quot;</span>);
<a name="l01798"></a>01798       <span class="keywordflow">break</span>;
<a name="l01799"></a>01799    <span class="keywordflow">case</span> IKS_SHOW_CHAT:
<a name="l01800"></a>01800       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: type: %i subtype %i\n&quot;</span>, pak-&gt;subtype, pak-&gt;show);
<a name="l01801"></a>01801       <span class="keywordflow">break</span>;
<a name="l01802"></a>01802    <span class="keywordflow">case</span> IKS_SHOW_AWAY:
<a name="l01803"></a>01803       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: type is away\n&quot;</span>);
<a name="l01804"></a>01804       <span class="keywordflow">break</span>;
<a name="l01805"></a>01805    <span class="keywordflow">case</span> IKS_SHOW_XA:
<a name="l01806"></a>01806       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: type: %i subtype %i\n&quot;</span>, pak-&gt;subtype, pak-&gt;show);
<a name="l01807"></a>01807       <span class="keywordflow">break</span>;
<a name="l01808"></a>01808    <span class="keywordflow">case</span> IKS_SHOW_DND:
<a name="l01809"></a>01809       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: type: %i subtype %i\n&quot;</span>, pak-&gt;subtype, pak-&gt;show);
<a name="l01810"></a>01810       <span class="keywordflow">break</span>;
<a name="l01811"></a>01811    <span class="keywordflow">default</span>:
<a name="l01812"></a>01812       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: Kinky! how did that happen %i\n&quot;</span>, pak-&gt;show);
<a name="l01813"></a>01813    }
<a name="l01814"></a>01814 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae9cccc06634afa62ab69827e3a07efb2"></a><!-- doxytag: member="res_jabber.c::aji_handle_subscribe" ref="ae9cccc06634afa62ab69827e3a07efb2" args="(struct aji_client *client, ikspak *pak)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void aji_handle_subscribe </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ikspak *&nbsp;</td>
          <td class="paramname"> <em>pak</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>handles subscription <a class="el" href="structrequests.html">requests</a>. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pak</em>&nbsp;</td><td>ikspak iksemel packet. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>void. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01822">1822</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l02880">aji_create_buddy()</a>, <a class="el" href="res__jabber_8c_source.html#l02408">aji_set_presence()</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="logger_8h_source.html#l00079">ast_verbose</a>, <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="jabber_8h_source.html#l00171">aji_client::component</a>, <a class="el" href="jabber_8h_source.html#l00149">aji_client::jid</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="asterisk_8c_source.html#l00174">option_verbose</a>, <a class="el" href="jabber_8h_source.html#l00177">aji_client::status</a>, <a class="el" href="app__jack_8c_source.html#l00141">status</a>, <a class="el" href="jabber_8h_source.html#l00145">aji_client::statusmessage</a>, and <a class="el" href="logger_8h_source.html#l00043">VERBOSE_PREFIX_3</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01823"></a>01823 {
<a name="l01824"></a>01824    iks *presence = NULL, *<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = NULL;
<a name="l01825"></a>01825    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a>* buddy = NULL;
<a name="l01826"></a>01826 
<a name="l01827"></a>01827    <span class="keywordflow">switch</span> (pak-&gt;subtype) { 
<a name="l01828"></a>01828    <span class="keywordflow">case</span> IKS_TYPE_SUBSCRIBE:
<a name="l01829"></a>01829       presence = iks_new(<span class="stringliteral">&quot;presence&quot;</span>);
<a name="l01830"></a>01830       status = iks_new(<span class="stringliteral">&quot;status&quot;</span>);
<a name="l01831"></a>01831       <span class="keywordflow">if</span> (presence &amp;&amp; status) {
<a name="l01832"></a>01832          iks_insert_attrib(presence, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;subscribed&quot;</span>);
<a name="l01833"></a>01833          iks_insert_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01834"></a>01834          iks_insert_attrib(presence, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01835"></a>01835          <span class="keywordflow">if</span> (pak-&gt;id)
<a name="l01836"></a>01836             iks_insert_attrib(presence, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01837"></a>01837          iks_insert_cdata(status, <span class="stringliteral">&quot;Asterisk has approved subscription&quot;</span>, 0);
<a name="l01838"></a>01838          iks_insert_node(presence, status);
<a name="l01839"></a>01839          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, presence);
<a name="l01840"></a>01840       } <span class="keywordflow">else</span>
<a name="l01841"></a>01841          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to allocate nodes\n&quot;</span>);
<a name="l01842"></a>01842 
<a name="l01843"></a>01843       iks_delete(presence);
<a name="l01844"></a>01844       iks_delete(status);
<a name="l01845"></a>01845 
<a name="l01846"></a>01846       <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>)
<a name="l01847"></a>01847          <a class="code" href="res__jabber_8c.html#a889348ddb7c785a009c26acb81ed232c" title="set presence of client.">aji_set_presence</a>(client, pak-&gt;from-&gt;full, iks_find_attrib(pak-&gt;x, <span class="stringliteral">&quot;to&quot;</span>), client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a>, client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>);
<a name="l01848"></a>01848    <span class="keywordflow">case</span> IKS_TYPE_SUBSCRIBED:
<a name="l01849"></a>01849       buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, pak-&gt;from-&gt;partial);
<a name="l01850"></a>01850       <span class="keywordflow">if</span> (!buddy &amp;&amp; pak-&gt;from-&gt;partial) {
<a name="l01851"></a>01851          <a class="code" href="res__jabber_8c.html#a1097eeb9e8887f482496e95a77cbb371" title="creates buddy.">aji_create_buddy</a>(pak-&gt;from-&gt;partial, client);
<a name="l01852"></a>01852       }
<a name="l01853"></a>01853    <span class="keywordflow">default</span>:
<a name="l01854"></a>01854       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">option_verbose</a> &gt; 4) {
<a name="l01855"></a>01855          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<a class="code" href="logger_8h.html#a24b0f46e22f4ea3226fa082e955dd4ef">VERBOSE_PREFIX_3</a> <span class="stringliteral">&quot;JABBER: This is a subcription of type %i\n&quot;</span>, pak-&gt;subtype);
<a name="l01856"></a>01856       }
<a name="l01857"></a>01857    }
<a name="l01858"></a>01858 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a34f1590817ad7108962f22772caa9bb1"></a><!-- doxytag: member="res_jabber.c::aji_initialize" ref="a34f1590817ad7108962f22772caa9bb1" args="(struct aji_client *client)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_initialize </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>prepares client for connect. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>1. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02353">2353</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="jabber_8h_source.html#l00171">aji_client::component</a>, <a class="el" href="cdr__pgsql_8c_source.html#l00058">connected</a>, <a class="el" href="jabber_8h_source.html#l00149">aji_client::jid</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="jabber_8h_source.html#l00141">aji_client::name</a>, <a class="el" href="jabber_8h_source.html#l00150">aji_client::p</a>, <a class="el" href="jabber_8h_source.html#l00160">aji_client::port</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, <a class="el" href="jabber_8h_source.html#l00144">aji_client::serverhost</a>, <a class="el" href="jabber_8h_source.html#l00157">aji_client::stream_flags</a>, and <a class="el" href="jabber_8h_source.html#l00143">aji_client::user</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l02283">aji_reconnect()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02354"></a>02354 {
<a name="l02355"></a>02355    <span class="keywordtype">int</span> <a class="code" href="cdr__pgsql_8c.html#a9709aefe4930807392898aecb0cb8a79">connected</a> = IKS_NET_NOCONN;
<a name="l02356"></a>02356 
<a name="l02357"></a>02357 <span class="preprocessor">#ifdef HAVE_OPENSSL  </span>
<a name="l02358"></a>02358 <span class="preprocessor"></span>   <span class="comment">/* reset stream flags */</span>
<a name="l02359"></a>02359    client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> = 0;
<a name="l02360"></a>02360 <span class="preprocessor">#endif</span>
<a name="l02361"></a>02361 <span class="preprocessor"></span>   <span class="comment">/* If it&apos;s a component, connect to user, otherwise, connect to server */</span>
<a name="l02362"></a>02362    connected = iks_connect_via(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(client-&gt;<a class="code" href="structaji__client.html#ae6f9b37fdd3bec79fe5bb6f71242f9f5">serverhost</a>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;server), client-&gt;<a class="code" href="structaji__client.html#a63c89c04d1feae07ca35558055155ffb">port</a>, client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a> ? client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a> : client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;server);
<a name="l02363"></a>02363 
<a name="l02364"></a>02364    <span class="keywordflow">if</span> (connected == IKS_NET_NOCONN) {
<a name="l02365"></a>02365       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER ERROR: No Connection\n&quot;</span>);
<a name="l02366"></a>02366       <span class="keywordflow">return</span> IKS_HOOK;
<a name="l02367"></a>02367    } <span class="keywordflow">else</span>   <span class="keywordflow">if</span> (connected == IKS_NET_NODNS) {
<a name="l02368"></a>02368       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER ERROR: No DNS %s for client to  %s\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(client-&gt;<a class="code" href="structaji__client.html#ae6f9b37fdd3bec79fe5bb6f71242f9f5">serverhost</a>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;server));
<a name="l02369"></a>02369       <span class="keywordflow">return</span> IKS_HOOK;
<a name="l02370"></a>02370    }
<a name="l02371"></a>02371 
<a name="l02372"></a>02372    <span class="keywordflow">return</span> IKS_OK;
<a name="l02373"></a>02373 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7487004afc39b2fbdd92ab9faaff8231"></a><!-- doxytag: member="res_jabber.c::aji_io_recv" ref="a7487004afc39b2fbdd92ab9faaff8231" args="(struct aji_client *client, char *buffer, size_t buf_len, int timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_io_recv </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&nbsp;</td>
          <td class="paramname"> <em>buf_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Secured or unsecured IO socket receiving function. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buffer</em>&nbsp;</td><td>the reception buffer </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buf_len</em>&nbsp;</td><td>the size of the buffer </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>timeout</em>&nbsp;</td><td>the select timer </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>the <a class="el" href="structnumber.html" title="Number structure.">number</a> of read bytes on success, 0 on timeout expiration, -1 on error </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00669">669</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00583">aji_is_secure()</a>, <a class="el" href="channel_8h_source.html#l01726">ast_select()</a>, <a class="el" href="func__strings_8c_source.html#l00821">len()</a>, <a class="el" href="jabber_8h_source.html#l00150">aji_client::p</a>, and <a class="el" href="jabber_8h_source.html#l00155">aji_client::ssl_session</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00721">aji_recv()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00670"></a>00670 {
<a name="l00671"></a>00671    <span class="keywordtype">int</span> sock;
<a name="l00672"></a>00672    fd_set fds;
<a name="l00673"></a>00673    <span class="keyword">struct </span>timeval <a class="code" href="time_8h.html#a9cf96982557d56650f0f4cd3762f05a0">tv</a>, *tvptr = NULL;
<a name="l00674"></a>00674    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, res;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l00677"></a>00677 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(client)) {
<a name="l00678"></a>00678       sock = SSL_get_fd(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>);
<a name="l00679"></a>00679       <span class="keywordflow">if</span> (sock &lt; 0)
<a name="l00680"></a>00680          <span class="keywordflow">return</span> -1;     
<a name="l00681"></a>00681    } <span class="keywordflow">else</span>
<a name="l00682"></a>00682 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_OPENSSL */</span>
<a name="l00683"></a>00683       sock = iks_fd(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>);  
<a name="l00684"></a>00684 
<a name="l00685"></a>00685    memset(&amp;tv, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> timeval));
<a name="l00686"></a>00686    FD_ZERO(&amp;fds);
<a name="l00687"></a>00687    FD_SET(sock, &amp;fds);
<a name="l00688"></a>00688    <a class="code" href="time_8h.html#a9cf96982557d56650f0f4cd3762f05a0">tv</a>.tv_sec = timeout;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690    <span class="comment">/* NULL value for tvptr makes ast_select wait indefinitely */</span>
<a name="l00691"></a>00691    tvptr = (timeout != -1) ? &amp;tv : NULL;
<a name="l00692"></a>00692 
<a name="l00693"></a>00693    <span class="comment">/* ast_select emulates linux behaviour in terms of timeout handling */</span>
<a name="l00694"></a>00694    res = <a class="code" href="channel_8h.html#a056ed4f99440f01c251b2e8ca4501a56" title="Waits for activity on a group of channels.">ast_select</a>(sock + 1, &amp;fds, NULL, NULL, tvptr);
<a name="l00695"></a>00695    <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l00696"></a>00696 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(client)) {
<a name="l00698"></a>00698          len = SSL_read(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>, buffer, buf_len);
<a name="l00699"></a>00699       } <span class="keywordflow">else</span>
<a name="l00700"></a>00700 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_OPENSSL */</span>
<a name="l00701"></a>00701          len = recv(sock, buffer, buf_len, 0);
<a name="l00702"></a>00702 
<a name="l00703"></a>00703       <span class="keywordflow">if</span> (len &gt; 0) {
<a name="l00704"></a>00704          <span class="keywordflow">return</span> len;
<a name="l00705"></a>00705       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt;= 0) {
<a name="l00706"></a>00706          <span class="keywordflow">return</span> -1;
<a name="l00707"></a>00707       }
<a name="l00708"></a>00708    }
<a name="l00709"></a>00709    <span class="keywordflow">return</span> res;
<a name="l00710"></a>00710 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab521080cf1f1741b1e3fdd0ee39f5b14"></a><!-- doxytag: member="res_jabber.c::aji_is_secure" ref="ab521080cf1f1741b1e3fdd0ee39f5b14" args="(struct aji_client *client)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_is_secure </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Tests whether the connection is secured or not. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>0 if the connection is not secured </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00583">583</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="jabber_8h_source.html#l00051">SECURE</a>, and <a class="el" href="jabber_8h_source.html#l00157">aji_client::stream_flags</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>, <a class="el" href="res__jabber_8c_source.html#l00669">aji_io_recv()</a>, <a class="el" href="res__jabber_8c_source.html#l00831">aji_send_raw()</a>, and <a class="el" href="res__jabber_8c_source.html#l00895">aji_start_sasl()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00584"></a>00584 {
<a name="l00585"></a>00585 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l00586"></a>00586 <span class="preprocessor"></span>   <span class="keywordflow">return</span> client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> &amp; <a class="code" href="jabber_8h.html#aff0ca0337402eb888baf747ce2469641">SECURE</a>;
<a name="l00587"></a>00587 <span class="preprocessor">#else</span>
<a name="l00588"></a>00588 <span class="preprocessor"></span>   <span class="keywordflow">return</span> 0;
<a name="l00589"></a>00589 <span class="preprocessor">#endif</span>
<a name="l00590"></a>00590 <span class="preprocessor"></span>}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae5802ee540d5ced70ff5a0b32d20bb70"></a><!-- doxytag: member="res_jabber.c::aji_load_config" ref="ae5802ee540d5ced70ff5a0b32d20bb70" args="(int reload)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_load_config </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>reload</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02907">2907</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="jabber_8h_source.html#l00084">AJI_AUTOPRUNE</a>, <a class="el" href="jabber_8h_source.html#l00085">AJI_AUTOREGISTER</a>, <a class="el" href="res__jabber_8c_source.html#l02660">aji_create_client()</a>, <a class="el" href="config_8c_source.html#l00613">ast_category_browse()</a>, <a class="el" href="config_8c_source.html#l00827">ast_config_destroy()</a>, <a class="el" href="config_8h_source.html#l00139">ast_config_load</a>, <a class="el" href="utils_8c_source.html#l01328">ast_false()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8h_source.html#l00092">ast_set2_flag</a>, <a class="el" href="utils_8h_source.html#l00068">ast_set_flag</a>, <a class="el" href="utils_8c_source.html#l01311">ast_true()</a>, <a class="el" href="config_8c_source.html#l00411">ast_variable_browse()</a>, <a class="el" href="config_8c_source.html#l00435">ast_variable_retrieve()</a>, <a class="el" href="config_8h_source.html#l00043">CONFIG_FLAG_FILEUNCHANGED</a>, <a class="el" href="config_8h_source.html#l00050">CONFIG_STATUS_FILEINVALID</a>, <a class="el" href="config_8h_source.html#l00048">CONFIG_STATUS_FILEMISSING</a>, <a class="el" href="config_8h_source.html#l00049">CONFIG_STATUS_FILEUNCHANGED</a>, <a class="el" href="app__rpt_8c_source.html#l00439">debug</a>, <a class="el" href="res__jabber_8c_source.html#l00173">JABBER_CONFIG</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="config_8h_source.html#l00075">ast_variable::name</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, <a class="el" href="config_8h_source.html#l00076">ast_variable::value</a>, and <a class="el" href="ast__expr2f_8c_source.html#l00613">var</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l03035">aji_reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02908"></a>02908 {
<a name="l02909"></a>02909    <span class="keywordtype">char</span> *cat = NULL;
<a name="l02910"></a>02910    <span class="keywordtype">int</span> <a class="code" href="app__rpt_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = 1;
<a name="l02911"></a>02911    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg = NULL;
<a name="l02912"></a>02912    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a> = NULL;
<a name="l02913"></a>02913    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="app__rpt_8c.html#a1f57f20c1f46890828791a4827fe8752">config_flags</a> = { <a class="code" href="res__jabber_8c.html#ad1982509765f4870f1f63412a53ea668" title="Wrapper for aji_reload.">reload</a> ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l02914"></a>02914 
<a name="l02915"></a>02915    <span class="keywordflow">if</span> ((cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="res__jabber_8c.html#ae61bb5ae111d446dd928959847812526">JABBER_CONFIG</a>, config_flags)) == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>)
<a name="l02916"></a>02916       <span class="keywordflow">return</span> -1;
<a name="l02917"></a>02917 
<a name="l02918"></a>02918    <span class="comment">/* Reset flags to default value */</span>
<a name="l02919"></a>02919    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;<a class="code" href="res__jabber_8c.html#a3888fe259904a2eb18b173cbf56bfa86" title="Global flags, initialized to default values.">globalflags</a>, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02920"></a>02920 
<a name="l02921"></a>02921    <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l02922"></a>02922       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such configuration file %s\n&quot;</span>, <a class="code" href="res__jabber_8c.html#ae61bb5ae111d446dd928959847812526">JABBER_CONFIG</a>);
<a name="l02923"></a>02923       <span class="keywordflow">return</span> 0;
<a name="l02924"></a>02924    }
<a name="l02925"></a>02925 
<a name="l02926"></a>02926    cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, NULL);
<a name="l02927"></a>02927    <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l02928"></a>02928       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;debug&quot;</span>)) {
<a name="l02929"></a>02929          debug = (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;debug&quot;</span>))) ? 0 : 1;
<a name="l02930"></a>02930       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autoprune&quot;</span>)) {
<a name="l02931"></a>02931          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;<a class="code" href="res__jabber_8c.html#a3888fe259904a2eb18b173cbf56bfa86" title="Global flags, initialized to default values.">globalflags</a>, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a5bf8f469c15d256015b2a3084bcdef59">AJI_AUTOPRUNE</a>);
<a name="l02932"></a>02932       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autoregister&quot;</span>)) {
<a name="l02933"></a>02933          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;<a class="code" href="res__jabber_8c.html#a3888fe259904a2eb18b173cbf56bfa86" title="Global flags, initialized to default values.">globalflags</a>, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02934"></a>02934       }
<a name="l02935"></a>02935    }
<a name="l02936"></a>02936 
<a name="l02937"></a>02937    <span class="keywordflow">while</span> (cat) {
<a name="l02938"></a>02938       <span class="keywordflow">if</span> (strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>)) {
<a name="l02939"></a>02939             var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat);
<a name="l02940"></a>02940             <a class="code" href="res__jabber_8c.html#a6381553337670894fe004c0536752062" title="creates aji_client structure.">aji_create_client</a>(cat, var, debug);
<a name="l02941"></a>02941       }
<a name="l02942"></a>02942       cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, cat);
<a name="l02943"></a>02943    }
<a name="l02944"></a>02944    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg); <span class="comment">/* or leak memory */</span>
<a name="l02945"></a>02945    <span class="keywordflow">return</span> 1;
<a name="l02946"></a>02946 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0c0224cfe2418f3e1779239f44d0266c"></a><!-- doxytag: member="res_jabber.c::aji_log_hook" ref="a0c0224cfe2418f3e1779239f44d0266c" args="(void *data, const char *xmpp, size_t size, int is_incoming)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void aji_log_hook </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>xmpp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&nbsp;</td>
          <td class="paramname"> <em>size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>is_incoming</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>the debug loop. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>void </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>xmpp</em>&nbsp;</td><td>xml data as string </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>size</em>&nbsp;</td><td>size of string </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>is_incoming</em>&nbsp;</td><td>direction of packet 1 for inbound 0 for outbound. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00863">863</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="logger_8h_source.html#l00079">ast_verbose</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="jabber_8h_source.html#l00161">aji_client::debug</a>, <a class="el" href="manager_8h_source.html#l00067">EVENT_FLAG_USER</a>, <a class="el" href="manager_8h_source.html#l00181">manager_event</a>, <a class="el" href="jabber_8h_source.html#l00141">aji_client::name</a>, and <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00721">aji_recv()</a>, and <a class="el" href="res__jabber_8c_source.html#l00831">aji_send_raw()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00864"></a>00864 {
<a name="l00865"></a>00865    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l00866"></a>00866 
<a name="l00867"></a>00867    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(xmpp))
<a name="l00868"></a>00868       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acc12c2bc03dce67ddd1590d67ab11f4d">EVENT_FLAG_USER</a>, <span class="stringliteral">&quot;JabberEvent&quot;</span>, <span class="stringliteral">&quot;Account: %s\r\nPacket: %s\r\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>, xmpp);
<a name="l00869"></a>00869 
<a name="l00870"></a>00870    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a>) {
<a name="l00871"></a>00871       <span class="keywordflow">if</span> (is_incoming)
<a name="l00872"></a>00872          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;\nJABBER: %s INCOMING: %s\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>, xmpp);
<a name="l00873"></a>00873       <span class="keywordflow">else</span> {
<a name="l00874"></a>00874          <span class="keywordflow">if</span>( strlen(xmpp) == 1) {
<a name="l00875"></a>00875             <span class="keywordflow">if</span>(<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 2  &amp;&amp; xmpp[0] == <span class="charliteral">&apos; &apos;</span>) {
<a name="l00876"></a>00876                <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;\nJABBER: Keep alive packet\n&quot;</span>);
<a name="l00877"></a>00877             }
<a name="l00878"></a>00878          } <span class="keywordflow">else</span>
<a name="l00879"></a>00879             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;\nJABBER: %s OUTGOING: %s\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>, xmpp);
<a name="l00880"></a>00880       }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882    }
<a name="l00883"></a>00883    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l00884"></a>00884 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a023bfb1346d00de355930f4224b94699"></a><!-- doxytag: member="res_jabber.c::aji_pruneregister" ref="a023bfb1346d00de355930f4224b94699" args="(struct aji_client *client)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void aji_pruneregister </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>goes through roster and prunes <a class="el" href="structusers.html" title="list of users found in the config file">users</a> not needed in list, or adds them accordingly. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>void. </dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>The messages here should be configurable. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02146">2146</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="jabber_8h_source.html#l00084">AJI_AUTOPRUNE</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="astobj_8h_source.html#l00376">ASTOBJ_CONTAINER_TRAVERSE</a>, <a class="el" href="astobj_8h_source.html#l00100">ASTOBJ_RDLOCK</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="jabber_8h_source.html#l00149">aji_client::jid</a>, and <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02147"></a>02147 {
<a name="l02148"></a>02148    <span class="keywordtype">int</span> res = 0;
<a name="l02149"></a>02149    iks *removeiq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l02150"></a>02150    iks *removequery = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l02151"></a>02151    iks *removeitem = iks_new(<span class="stringliteral">&quot;item&quot;</span>);
<a name="l02152"></a>02152    iks *send = iks_make_iq(IKS_TYPE_GET, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#items&quot;</span>);
<a name="l02153"></a>02153    <span class="keywordflow">if</span> (!client || !removeiq || !removequery || !removeitem || !send) {
<a name="l02154"></a>02154       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l02155"></a>02155       <span class="keywordflow">goto</span> safeout;
<a name="l02156"></a>02156    }
<a name="l02157"></a>02157 
<a name="l02158"></a>02158    iks_insert_node(removeiq, removequery);
<a name="l02159"></a>02159    iks_insert_node(removequery, removeitem);
<a name="l02160"></a>02160    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, 1, {
<a name="l02161"></a>02161       <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02162"></a>02162       <span class="comment">/* For an aji_buddy, both AUTOPRUNE and AUTOREGISTER will never</span>
<a name="l02163"></a>02163 <span class="comment">       * be called at the same time */</span>
<a name="l02164"></a>02164       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;iterator-&gt;flags, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a5bf8f469c15d256015b2a3084bcdef59">AJI_AUTOPRUNE</a>)) { <span class="comment">/* If autoprune is set on jabber.conf */</span>
<a name="l02165"></a>02165          res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iks_make_s10n(IKS_TYPE_UNSUBSCRIBE, iterator-&gt;name,
<a name="l02166"></a>02166                          <span class="stringliteral">&quot;GoodBye. Your status is no longer needed by Asterisk the Open Source PBX&quot;</span>
<a name="l02167"></a>02167                          <span class="stringliteral">&quot; so I am no longer subscribing to your presence.\n&quot;</span>));
<a name="l02168"></a>02168          res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iks_make_s10n(IKS_TYPE_UNSUBSCRIBED, iterator-&gt;name,
<a name="l02169"></a>02169                          <span class="stringliteral">&quot;GoodBye.  You are no longer in the Asterisk config file so I am removing&quot;</span>
<a name="l02170"></a>02170                          <span class="stringliteral">&quot; your access to my presence.\n&quot;</span>));
<a name="l02171"></a>02171          iks_insert_attrib(removeiq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full); 
<a name="l02172"></a>02172          iks_insert_attrib(removeiq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;set&quot;</span>); 
<a name="l02173"></a>02173          iks_insert_attrib(removequery, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;jabber:iq:roster&quot;</span>);
<a name="l02174"></a>02174          iks_insert_attrib(removeitem, <span class="stringliteral">&quot;jid&quot;</span>, iterator-&gt;name);
<a name="l02175"></a>02175          iks_insert_attrib(removeitem, <span class="stringliteral">&quot;subscription&quot;</span>, <span class="stringliteral">&quot;remove&quot;</span>);
<a name="l02176"></a>02176          res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, removeiq);
<a name="l02177"></a>02177       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;iterator-&gt;flags, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>)) {
<a name="l02178"></a>02178          res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iks_make_s10n(IKS_TYPE_SUBSCRIBE, iterator-&gt;name, 
<a name="l02179"></a>02179                          <span class="stringliteral">&quot;Greetings! I am the Asterisk Open Source PBX and I want to subscribe to your presence\n&quot;</span>));
<a name="l02180"></a>02180          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;iterator-&gt;flags, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02181"></a>02181       }
<a name="l02182"></a>02182       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02183"></a>02183    });
<a name="l02184"></a>02184 
<a name="l02185"></a>02185  safeout:
<a name="l02186"></a>02186    iks_delete(removeiq);
<a name="l02187"></a>02187    iks_delete(removequery);
<a name="l02188"></a>02188    iks_delete(removeitem);
<a name="l02189"></a>02189    iks_delete(send);
<a name="l02190"></a>02190    
<a name="l02191"></a>02191    <a class="code" href="astobj_8h.html#a794727ca4ef71982250ff9f36a9668d7" title="Prune marked objects from a container.">ASTOBJ_CONTAINER_PRUNE_MARKED</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, <a class="code" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561" title="Deletes the aji_buddy data structure.">aji_buddy_destroy</a>);
<a name="l02192"></a>02192 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae14793d1d8300f1c377fccb8e5773250"></a><!-- doxytag: member="res_jabber.c::aji_reconnect" ref="ae14793d1d8300f1c377fccb8e5773250" args="(struct aji_client *client)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_reconnect </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>reconnect to jabber server </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>res. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02283">2283</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="jabber_8h_source.html#l00078">AJI_DISCONNECTED</a>, <a class="el" href="res__jabber_8c_source.html#l02353">aji_initialize()</a>, <a class="el" href="jabber_8h_source.html#l00169">aji_client::authorized</a>, <a class="el" href="jabber_8h_source.html#l00150">aji_client::p</a>, <a class="el" href="jabber_8h_source.html#l00159">aji_client::state</a>, and <a class="el" href="jabber_8h_source.html#l00167">aji_client::timeout</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l01985">aji_recv_loop()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02284"></a>02284 {
<a name="l02285"></a>02285    <span class="keywordtype">int</span> res = 0;
<a name="l02286"></a>02286 
<a name="l02287"></a>02287    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a>)
<a name="l02288"></a>02288       client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a46d3c148625b0889f793b6c355051d3b">AJI_DISCONNECTED</a>;
<a name="l02289"></a>02289    client-&gt;<a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>=50;
<a name="l02290"></a>02290    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>)
<a name="l02291"></a>02291       iks_parser_reset(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>);
<a name="l02292"></a>02292    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#af8817598c239b6e65a000760866a5cde">authorized</a>)
<a name="l02293"></a>02293       client-&gt;<a class="code" href="structaji__client.html#af8817598c239b6e65a000760866a5cde">authorized</a> = 0;
<a name="l02294"></a>02294 
<a name="l02295"></a>02295    res = <a class="code" href="res__jabber_8c.html#a34f1590817ad7108962f22772caa9bb1" title="prepares client for connect.">aji_initialize</a>(client);
<a name="l02296"></a>02296 
<a name="l02297"></a>02297    <span class="keywordflow">return</span> res;
<a name="l02298"></a>02298 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a94ce06e757ee266951a03520fa126741"></a><!-- doxytag: member="res_jabber.c::aji_recv" ref="a94ce06e757ee266951a03520fa126741" args="(struct aji_client *client, int timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_recv </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Tries to receive data from the Jabber server. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>timeout</em>&nbsp;</td><td>the timeout value This function receives (encrypted or unencrypted) data from the XMPP server, and passes it to the parser. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_OK on success, IKS_NET_RWERR on IO error, IKS_NET_NOCONN, if no connection available, IKS_NET_EXPIRED on timeout expiration </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00721">721</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00669">aji_io_recv()</a>, <a class="el" href="res__jabber_8c_source.html#l00863">aji_log_hook()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="jabber_8h_source.html#l00057">IKS_NET_EXPIRED</a>, <a class="el" href="func__strings_8c_source.html#l00821">len()</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="jabber_8h_source.html#l00055">NET_IO_BUF_SIZE</a>, and <a class="el" href="jabber_8h_source.html#l00150">aji_client::p</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>, and <a class="el" href="res__jabber_8c_source.html#l01985">aji_recv_loop()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00722"></a>00722 {
<a name="l00723"></a>00723    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, ret;
<a name="l00724"></a>00724    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="jabber_8h.html#a88194d0f499931c26ef4df0738f26ec1">NET_IO_BUF_SIZE</a> - 1];
<a name="l00725"></a>00725    <span class="keywordtype">char</span> newbuf[<a class="code" href="jabber_8h.html#a88194d0f499931c26ef4df0738f26ec1">NET_IO_BUF_SIZE</a> - 1];
<a name="l00726"></a>00726    <span class="keywordtype">int</span> pos = 0;
<a name="l00727"></a>00727    <span class="keywordtype">int</span> newbufpos = 0;
<a name="l00728"></a>00728    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730    memset(buf, 0, <span class="keyword">sizeof</span>(buf));
<a name="l00731"></a>00731    memset(newbuf, 0, <span class="keyword">sizeof</span>(newbuf));
<a name="l00732"></a>00732 
<a name="l00733"></a>00733    <span class="keywordflow">while</span> (1) {
<a name="l00734"></a>00734       len = <a class="code" href="res__jabber_8c.html#a7487004afc39b2fbdd92ab9faaff8231" title="Secured or unsecured IO socket receiving function.">aji_io_recv</a>(client, buf, <a class="code" href="jabber_8h.html#a88194d0f499931c26ef4df0738f26ec1">NET_IO_BUF_SIZE</a> - 2, <a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>);
<a name="l00735"></a>00735       <span class="keywordflow">if</span> (len &lt; 0) <span class="keywordflow">return</span> IKS_NET_RWERR;
<a name="l00736"></a>00736       <span class="keywordflow">if</span> (len == 0) <span class="keywordflow">return</span> <a class="code" href="jabber_8h.html#a99fa4c2cecd405f4430c8d137af93db9">IKS_NET_EXPIRED</a>;
<a name="l00737"></a>00737       buf[len] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00738"></a>00738 
<a name="l00739"></a>00739       <span class="comment">/* our iksemel parser won&apos;t work as expected if we feed</span>
<a name="l00740"></a>00740 <span class="comment">         it with XML packets that contain multiple whitespace </span>
<a name="l00741"></a>00741 <span class="comment">         characters between tags */</span>
<a name="l00742"></a>00742       <span class="keywordflow">while</span> (pos &lt; len) {
<a name="l00743"></a>00743          c = buf[pos];
<a name="l00744"></a>00744          <span class="comment">/* if we stumble on the ending tag character,</span>
<a name="l00745"></a>00745 <span class="comment">            we skip any whitespace that follows it*/</span>
<a name="l00746"></a>00746          <span class="keywordflow">if</span> (c == <span class="charliteral">&apos;&gt;&apos;</span>) {
<a name="l00747"></a>00747             <span class="keywordflow">while</span> (isspace(buf[pos+1])) {
<a name="l00748"></a>00748                pos++;
<a name="l00749"></a>00749             }
<a name="l00750"></a>00750          }
<a name="l00751"></a>00751          newbuf[newbufpos] = c;
<a name="l00752"></a>00752          newbufpos ++;
<a name="l00753"></a>00753          pos++;
<a name="l00754"></a>00754       }
<a name="l00755"></a>00755       pos = 0;
<a name="l00756"></a>00756       newbufpos = 0;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758       <span class="comment">/* Log the message here, because iksemel&apos;s logHook is </span>
<a name="l00759"></a>00759 <span class="comment">         unaccessible */</span>
<a name="l00760"></a>00760       <a class="code" href="res__jabber_8c.html#a0c0224cfe2418f3e1779239f44d0266c" title="the debug loop.">aji_log_hook</a>(client, buf, len, 1);
<a name="l00761"></a>00761 
<a name="l00762"></a>00762       <span class="comment">/* let iksemel deal with the string length, </span>
<a name="l00763"></a>00763 <span class="comment">         and reset our buffer */</span>
<a name="l00764"></a>00764       ret = iks_parse(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>, newbuf, 0, 0);
<a name="l00765"></a>00765       memset(newbuf, 0, <span class="keyword">sizeof</span>(newbuf));
<a name="l00766"></a>00766 
<a name="l00767"></a>00767       <span class="keywordflow">switch</span> (ret) {
<a name="l00768"></a>00768       <span class="keywordflow">case</span> IKS_NOMEM:
<a name="l00769"></a>00769          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Parsing failure: Out of memory.\n&quot;</span>);
<a name="l00770"></a>00770          <span class="keywordflow">break</span>;
<a name="l00771"></a>00771       <span class="keywordflow">case</span> IKS_BADXML:
<a name="l00772"></a>00772          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Parsing failure: Invalid XML.\n&quot;</span>);
<a name="l00773"></a>00773          <span class="keywordflow">break</span>;
<a name="l00774"></a>00774       <span class="keywordflow">case</span> IKS_HOOK:
<a name="l00775"></a>00775          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Parsing failure: Hook returned an error.\n&quot;</span>);
<a name="l00776"></a>00776          <span class="keywordflow">break</span>;
<a name="l00777"></a>00777       }
<a name="l00778"></a>00778       <span class="keywordflow">if</span> (ret != IKS_OK) {
<a name="l00779"></a>00779          <span class="keywordflow">return</span> ret;
<a name="l00780"></a>00780       }
<a name="l00781"></a>00781       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;XML parsing successful\n&quot;</span>); 
<a name="l00782"></a>00782    }
<a name="l00783"></a>00783    <span class="keywordflow">return</span> IKS_OK;
<a name="l00784"></a>00784 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a29f749367c5d39d4eb02841f70a07006"></a><!-- doxytag: member="res_jabber.c::aji_recv_loop" ref="a29f749367c5d39d4eb02841f70a07006" args="(void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void * aji_recv_loop </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>receive <a class="el" href="structmessage.html">message</a> loop. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>void </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>void. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01985">1985</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="jabber_8h_source.html#l00080">AJI_CONNECTED</a>, <a class="el" href="jabber_8h_source.html#l00077">AJI_DISCONNECTING</a>, <a class="el" href="res__jabber_8c_source.html#l02283">aji_reconnect()</a>, <a class="el" href="res__jabber_8c_source.html#l00721">aji_recv()</a>, <a class="el" href="res__jabber_8c_source.html#l00831">aji_send_raw()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="jabber_8h_source.html#l00057">IKS_NET_EXPIRED</a>, <a class="el" href="jabber_8h_source.html#l00165">aji_client::keepalive</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="jabber_8h_source.html#l00159">aji_client::state</a>, and <a class="el" href="jabber_8h_source.html#l00167">aji_client::timeout</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l03035">aji_reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01986"></a>01986 {
<a name="l01987"></a>01987    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l01988"></a>01988    <span class="keywordtype">int</span> res = IKS_HOOK;
<a name="l01989"></a>01989 
<a name="l01990"></a>01990    <span class="keywordflow">while</span>(res != IKS_OK) {
<a name="l01991"></a>01991       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: Connecting.\n&quot;</span>);
<a name="l01992"></a>01992       res = <a class="code" href="res__jabber_8c.html#ae14793d1d8300f1c377fccb8e5773250" title="reconnect to jabber server">aji_reconnect</a>(client);
<a name="l01993"></a>01993       sleep(4);
<a name="l01994"></a>01994    }
<a name="l01995"></a>01995 
<a name="l01996"></a>01996    <span class="keywordflow">do</span> {
<a name="l01997"></a>01997       <span class="keywordflow">if</span> (res == IKS_NET_RWERR || client-&gt;<a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> == 0) {
<a name="l01998"></a>01998          <span class="keywordflow">while</span>(res != IKS_OK) {
<a name="l01999"></a>01999             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: reconnecting.\n&quot;</span>);
<a name="l02000"></a>02000             res = <a class="code" href="res__jabber_8c.html#ae14793d1d8300f1c377fccb8e5773250" title="reconnect to jabber server">aji_reconnect</a>(client);
<a name="l02001"></a>02001             sleep(4);
<a name="l02002"></a>02002          }
<a name="l02003"></a>02003       }
<a name="l02004"></a>02004 
<a name="l02005"></a>02005       res = <a class="code" href="res__jabber_8c.html#a94ce06e757ee266951a03520fa126741" title="Tries to receive data from the Jabber server.">aji_recv</a>(client, 1);
<a name="l02006"></a>02006       
<a name="l02007"></a>02007       <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a9f2e9be855a781b74badbe0c1bda278e">AJI_DISCONNECTING</a>) {
<a name="l02008"></a>02008          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Ending our Jabber client&apos;s thread due to a disconnect\n&quot;</span>);
<a name="l02009"></a>02009          pthread_exit(NULL);
<a name="l02010"></a>02010       }
<a name="l02011"></a>02011 
<a name="l02012"></a>02012       <span class="comment">/* Decrease timeout if no data received */</span>
<a name="l02013"></a>02013       <span class="keywordflow">if</span> (res == <a class="code" href="jabber_8h.html#a99fa4c2cecd405f4430c8d137af93db9">IKS_NET_EXPIRED</a>)
<a name="l02014"></a>02014          client-&gt;<a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>--;
<a name="l02015"></a>02015 
<a name="l02016"></a>02016       <span class="keywordflow">if</span> (res == IKS_HOOK) 
<a name="l02017"></a>02017          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JABBER: Got hook event.\n&quot;</span>);
<a name="l02018"></a>02018       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == IKS_NET_TLSFAIL)
<a name="l02019"></a>02019          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER:  Failure in TLS.\n&quot;</span>);
<a name="l02020"></a>02020       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> == 0 &amp;&amp; client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a>) {
<a name="l02021"></a>02021          res = client-&gt;<a class="code" href="structaji__client.html#ae314c4b48027be9feab52906b6313b73">keepalive</a> ? <a class="code" href="res__jabber_8c.html#a265a12987d4ab3483e7cd733f03ca1d6" title="Sends an XML string over an XMPP connection.">aji_send_raw</a>(client, <span class="stringliteral">&quot; &quot;</span>) : IKS_OK;
<a name="l02022"></a>02022          <span class="keywordflow">if</span>(res == IKS_OK)
<a name="l02023"></a>02023             client-&gt;<a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> = 50;
<a name="l02024"></a>02024          <span class="keywordflow">else</span>
<a name="l02025"></a>02025             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JABBER:  Network Timeout\n&quot;</span>);
<a name="l02026"></a>02026       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == IKS_NET_RWERR)
<a name="l02027"></a>02027          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JABBER: socket read error\n&quot;</span>);
<a name="l02028"></a>02028    } <span class="keywordflow">while</span> (client);
<a name="l02029"></a>02029    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02030"></a>02030    <span class="keywordflow">return</span> 0;
<a name="l02031"></a>02031 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae086e18b972394df16015895af3b0e84"></a><!-- doxytag: member="res_jabber.c::aji_register_approve_handler" ref="ae086e18b972394df16015895af3b0e84" args="(void *data, ikspak *pak)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_register_approve_handler </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ikspak *&nbsp;</td>
          <td class="paramname"> <em>pak</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Unknown. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>void </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pak</em>&nbsp;</td><td>ikspak </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_FILTER_EAT. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01144">1144</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="res__jabber_8c_source.html#l02038">ast_aji_increment_mid()</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="jabber_8h_source.html#l00149">aji_client::jid</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="jabber_8h_source.html#l00148">aji_client::mid</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01145"></a>01145 {
<a name="l01146"></a>01146    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l01147"></a>01147    iks *iq = NULL, *presence = NULL, *x = NULL;
<a name="l01148"></a>01148 
<a name="l01149"></a>01149    iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01150"></a>01150    presence = iks_new(<span class="stringliteral">&quot;presence&quot;</span>);
<a name="l01151"></a>01151    x = iks_new(<span class="stringliteral">&quot;x&quot;</span>);
<a name="l01152"></a>01152    <span class="keywordflow">if</span> (client &amp;&amp; iq &amp;&amp; presence &amp;&amp; x) {
<a name="l01153"></a>01153       <span class="keywordflow">if</span> (!iks_find(pak-&gt;query, <span class="stringliteral">&quot;remove&quot;</span>)) {
<a name="l01154"></a>01154          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01155"></a>01155          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01156"></a>01156          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01157"></a>01157          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01158"></a>01158          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01159"></a>01159 
<a name="l01160"></a>01160          iks_insert_attrib(presence, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01161"></a>01161          iks_insert_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;partial);
<a name="l01162"></a>01162          iks_insert_attrib(presence, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01163"></a>01163          <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01164"></a>01164          iks_insert_attrib(presence, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;subscribe&quot;</span>);
<a name="l01165"></a>01165          iks_insert_attrib(x, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;vcard-temp:x:update&quot;</span>);
<a name="l01166"></a>01166          iks_insert_node(presence, x);
<a name="l01167"></a>01167          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, presence); 
<a name="l01168"></a>01168       }
<a name="l01169"></a>01169    } <span class="keywordflow">else</span> {
<a name="l01170"></a>01170       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01171"></a>01171    }
<a name="l01172"></a>01172 
<a name="l01173"></a>01173 
<a name="l01174"></a>01174    iks_delete(iq);
<a name="l01175"></a>01175    iks_delete(presence);
<a name="l01176"></a>01176    iks_delete(x);
<a name="l01177"></a>01177    
<a name="l01178"></a>01178    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01179"></a>01179    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01180"></a>01180 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a82642d571c9e2cc5476d1b25c99d51cc"></a><!-- doxytag: member="res_jabber.c::aji_register_query_handler" ref="a82642d571c9e2cc5476d1b25c99d51cc" args="(void *data, ikspak *pak)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_register_query_handler </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ikspak *&nbsp;</td>
          <td class="paramname"> <em>pak</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>register handler for incoming querys (IQ's) </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>incoming <a class="el" href="structaji__client.html">aji_client</a> request </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pak</em>&nbsp;</td><td>ikspak </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_FILTER_EAT. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01187">1187</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, <a class="el" href="astobj_8h_source.html#l00201">ASTOBJ_REF</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="jabber_8h_source.html#l00143">aji_client::user</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01188"></a>01188 {
<a name="l01189"></a>01189    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l01190"></a>01190    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = NULL; 
<a name="l01191"></a>01191    <span class="keywordtype">char</span> *node = NULL;
<a name="l01192"></a>01192    iks *iq = NULL, *query = NULL;
<a name="l01193"></a>01193 
<a name="l01194"></a>01194    client = (<span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *) data;
<a name="l01195"></a>01195 
<a name="l01196"></a>01196    buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, pak-&gt;from-&gt;partial);
<a name="l01197"></a>01197    <span class="keywordflow">if</span> (!buddy) {
<a name="l01198"></a>01198       iks  *error = NULL, *notacceptable = NULL;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Someone.... %s tried to register but they aren&apos;t allowed\n&quot;</span>, pak-&gt;from-&gt;partial);
<a name="l01201"></a>01201       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01202"></a>01202       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01203"></a>01203       error = iks_new(<span class="stringliteral">&quot;error&quot;</span>);
<a name="l01204"></a>01204       notacceptable = iks_new(<span class="stringliteral">&quot;not-acceptable&quot;</span>);
<a name="l01205"></a>01205       <span class="keywordflow">if</span>(iq &amp;&amp; query &amp;&amp; error &amp;&amp; notacceptable) {
<a name="l01206"></a>01206          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;error&quot;</span>);
<a name="l01207"></a>01207          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01208"></a>01208          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01209"></a>01209          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01210"></a>01210          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>);
<a name="l01211"></a>01211          iks_insert_attrib(error, <span class="stringliteral">&quot;code&quot;</span> , <span class="stringliteral">&quot;406&quot;</span>);
<a name="l01212"></a>01212          iks_insert_attrib(error, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;modify&quot;</span>);
<a name="l01213"></a>01213          iks_insert_attrib(notacceptable, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;urn:ietf:params:xml:ns:xmpp-stanzas&quot;</span>);
<a name="l01214"></a>01214          iks_insert_node(iq, query);
<a name="l01215"></a>01215          iks_insert_node(iq, error);
<a name="l01216"></a>01216          iks_insert_node(error, notacceptable);
<a name="l01217"></a>01217          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01218"></a>01218       } <span class="keywordflow">else</span> {
<a name="l01219"></a>01219          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01220"></a>01220       }
<a name="l01221"></a>01221 
<a name="l01222"></a>01222       iks_delete(error);
<a name="l01223"></a>01223       iks_delete(notacceptable);
<a name="l01224"></a>01224    } <span class="keywordflow">else</span>   <span class="keywordflow">if</span> (!(node = iks_find_attrib(pak-&gt;query, <span class="stringliteral">&quot;node&quot;</span>))) {
<a name="l01225"></a>01225       iks *instructions = NULL;
<a name="l01226"></a>01226       <span class="keywordtype">char</span> *explain = <span class="stringliteral">&quot;Welcome to Asterisk - the Open Source PBX.\n&quot;</span>;
<a name="l01227"></a>01227       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01228"></a>01228       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01229"></a>01229       instructions = iks_new(<span class="stringliteral">&quot;instructions&quot;</span>);
<a name="l01230"></a>01230       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; instructions &amp;&amp; client) {
<a name="l01231"></a>01231          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01232"></a>01232          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01233"></a>01233          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01234"></a>01234          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01235"></a>01235          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>);
<a name="l01236"></a>01236          iks_insert_cdata(instructions, explain, 0);
<a name="l01237"></a>01237          iks_insert_node(iq, query);
<a name="l01238"></a>01238          iks_insert_node(query, instructions);
<a name="l01239"></a>01239          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01240"></a>01240       } <span class="keywordflow">else</span> {
<a name="l01241"></a>01241          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01242"></a>01242       }
<a name="l01243"></a>01243 
<a name="l01244"></a>01244       iks_delete(instructions);
<a name="l01245"></a>01245    }
<a name="l01246"></a>01246    iks_delete(iq);
<a name="l01247"></a>01247    iks_delete(query);
<a name="l01248"></a>01248    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01249"></a>01249    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01250"></a>01250 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad7e3d90484987374674cd6568d39a3de"></a><!-- doxytag: member="res_jabber.c::aji_reload" ref="ad7e3d90484987374674cd6568d39a3de" args="(int reload)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_reload </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>reload</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reload the jabber module. </p>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l03035">3035</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="jabber_8h_source.html#l00079">AJI_CONNECTING</a>, <a class="el" href="jabber_8h_source.html#l00078">AJI_DISCONNECTED</a>, <a class="el" href="res__jabber_8c_source.html#l02305">aji_get_roster()</a>, <a class="el" href="res__jabber_8c_source.html#l02907">aji_load_config()</a>, <a class="el" href="res__jabber_8c_source.html#l01985">aji_recv_loop()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8h_source.html#l00384">ast_pthread_create_background</a>, <a class="el" href="astobj_8h_source.html#l00782">ASTOBJ_CONTAINER_MARKALL</a>, <a class="el" href="astobj_8h_source.html#l00651">ASTOBJ_CONTAINER_PRUNE_MARKED</a>, <a class="el" href="astobj_8h_source.html#l00376">ASTOBJ_CONTAINER_TRAVERSE</a>, <a class="el" href="astobj_8h_source.html#l00100">ASTOBJ_RDLOCK</a>, <a class="el" href="astobj_8h_source.html#l00109">ASTOBJ_UNLOCK</a>, <a class="el" href="res__jabber_8c_source.html#l00246">clients</a>, and <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l02482">aji_do_reload()</a>, <a class="el" href="res__jabber_8c_source.html#l03085">load_module()</a>, and <a class="el" href="res__jabber_8c_source.html#l03101">reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03036"></a>03036 {
<a name="l03037"></a>03037    <span class="keywordtype">int</span> res;
<a name="l03038"></a>03038 
<a name="l03039"></a>03039    <a class="code" href="astobj_8h.html#a5e865869ca1acadd652b42810fec2ec9" title="Mark all the objects in a container.">ASTOBJ_CONTAINER_MARKALL</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>);
<a name="l03040"></a>03040    <span class="keywordflow">if</span> (!(res = <a class="code" href="res__jabber_8c.html#ae5802ee540d5ced70ff5a0b32d20bb70">aji_load_config</a>(<a class="code" href="res__jabber_8c.html#ad1982509765f4870f1f63412a53ea668" title="Wrapper for aji_reload.">reload</a>))) {
<a name="l03041"></a>03041       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER: Failed to load config.\n&quot;</span>);
<a name="l03042"></a>03042       <span class="keywordflow">return</span> 0;
<a name="l03043"></a>03043    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == -1)
<a name="l03044"></a>03044       <span class="keywordflow">return</span> 1;
<a name="l03045"></a>03045 
<a name="l03046"></a>03046    <a class="code" href="astobj_8h.html#a794727ca4ef71982250ff9f36a9668d7" title="Prune marked objects from a container.">ASTOBJ_CONTAINER_PRUNE_MARKED</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l03047"></a>03047    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l03048"></a>03048       <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l03049"></a>03049       <span class="keywordflow">if</span>(iterator-&gt;state == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a46d3c148625b0889f793b6c355051d3b">AJI_DISCONNECTED</a>) {
<a name="l03050"></a>03050          <span class="keywordflow">if</span> (!iterator-&gt;thread)
<a name="l03051"></a>03051             <a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;iterator-&gt;thread, NULL, <a class="code" href="res__jabber_8c.html#a29f749367c5d39d4eb02841f70a07006" title="receive message loop.">aji_recv_loop</a>, iterator);
<a name="l03052"></a>03052       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iterator-&gt;state == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ade80d6f33c170eeaeb1fbc84ebdb1a2f">AJI_CONNECTING</a>)
<a name="l03053"></a>03053          <a class="code" href="res__jabber_8c.html#a064f178d1c5b750e1ee2c0a80da62771" title="Get the roster of jabber users.">aji_get_roster</a>(iterator);
<a name="l03054"></a>03054       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l03055"></a>03055    });
<a name="l03056"></a>03056    
<a name="l03057"></a>03057    <span class="keywordflow">return</span> 1;
<a name="l03058"></a>03058 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a26515ff8bd0588f1181bb6a3abc56f90"></a><!-- doxytag: member="res_jabber.c::aji_send_exec" ref="a26515ff8bd0588f1181bb6a3abc56f90" args="(struct ast_channel *chan, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_send_exec </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Dial plan function to send a <a class="el" href="structmessage.html">message</a>. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td><a class="el" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>Data is sender|receiver|message. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>0 on success,-1 on error. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00548">548</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l02954">ast_aji_get_client()</a>, <a class="el" href="res__jabber_8c_source.html#l01867">ast_aji_send_chat()</a>, <a class="el" href="app_8h_source.html#l00338">AST_APP_ARG</a>, <a class="el" href="app_8h_source.html#l00355">AST_DECLARE_APP_ARGS</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="app_8h_source.html#l00387">AST_STANDARD_APP_ARGS</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, and <a class="el" href="aesopt_8h_source.html#l00399">s</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l03085">load_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00549"></a>00549 {
<a name="l00550"></a>00550    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l00551"></a>00551    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00552"></a>00552    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l00553"></a>00553       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(sender);
<a name="l00554"></a>00554       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(recipient);
<a name="l00555"></a>00555       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structmessage.html">message</a>);
<a name="l00556"></a>00556    );
<a name="l00557"></a>00557 
<a name="l00558"></a>00558    <span class="keywordflow">if</span> (!data) {
<a name="l00559"></a>00559       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Usage:  JabberSend(&lt;sender&gt;,&lt;recipient&gt;,&lt;message&gt;)\n&quot;</span>);
<a name="l00560"></a>00560       <span class="keywordflow">return</span> 0;
<a name="l00561"></a>00561    }
<a name="l00562"></a>00562    s = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l00563"></a>00563 
<a name="l00564"></a>00564    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, s);
<a name="l00565"></a>00565    <span class="keywordflow">if</span> (args.argc &lt; 3) {
<a name="l00566"></a>00566       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JabberSend requires 3 arguments: &apos;%s&apos;\n&quot;</span>, (<span class="keywordtype">char</span> *) data);
<a name="l00567"></a>00567       <span class="keywordflow">return</span> -1;
<a name="l00568"></a>00568    }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570    <span class="keywordflow">if</span> (!(client = <a class="code" href="jabber_8h.html#a6689c8e948c8d55e092f30277336fde7" title="grab a aji_client structure by label name or JID (without the resource string)">ast_aji_get_client</a>(args.sender))) {
<a name="l00571"></a>00571       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find sender connection: &apos;%s&apos;\n&quot;</span>, args.sender);
<a name="l00572"></a>00572       <span class="keywordflow">return</span> -1;
<a name="l00573"></a>00573    }
<a name="l00574"></a>00574    <span class="keywordflow">if</span> (strchr(args.recipient, <span class="charliteral">&apos;@&apos;</span>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.message))
<a name="l00575"></a>00575       <a class="code" href="jabber_8h.html#af2b674ed94b89a5798fe22714a44f046" title="sends messages.">ast_aji_send_chat</a>(client, args.recipient, args.message);
<a name="l00576"></a>00576    <span class="keywordflow">return</span> 0;
<a name="l00577"></a>00577 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a21ae37866a3ab62cb29456b23c423a9c"></a><!-- doxytag: member="res_jabber.c::aji_send_header" ref="a21ae37866a3ab62cb29456b23c423a9c" args="(struct aji_client *client, const char *to)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_send_header </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>to</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Sends XMPP header to the server. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>to</em>&nbsp;</td><td>the target XMPP server </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_OK on success, any other value on failure </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00792">792</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00831">aji_send_raw()</a>, <a class="el" href="func__strings_8c_source.html#l00821">len()</a>, <a class="el" href="adsistub_8c_source.html#l00055">msg</a>, and <a class="el" href="jabber_8h_source.html#l00146">aji_client::name_space</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>, and <a class="el" href="res__jabber_8c_source.html#l00617">aji_tls_handshake()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00793"></a>00793 {
<a name="l00794"></a>00794    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>;
<a name="l00795"></a>00795    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, err;
<a name="l00796"></a>00796 
<a name="l00797"></a>00797    len = 91 + strlen(client-&gt;<a class="code" href="structaji__client.html#af15d57ddbee9fc1081f785f111f52b46">name_space</a>) + 6 + strlen(to) + 16 + 1;
<a name="l00798"></a>00798    msg = iks_malloc(len);
<a name="l00799"></a>00799    <span class="keywordflow">if</span> (!msg)
<a name="l00800"></a>00800       <span class="keywordflow">return</span> IKS_NOMEM;
<a name="l00801"></a>00801    sprintf(msg, <span class="stringliteral">&quot;&lt;?xml version=&apos;1.0&apos;?&gt;&quot;</span>
<a name="l00802"></a>00802       <span class="stringliteral">&quot;&lt;stream:stream xmlns:stream=&apos;http://etherx.jabber.org/streams&apos; xmlns=&apos;&quot;</span>
<a name="l00803"></a>00803       <span class="stringliteral">&quot;%s&apos; to=&apos;%s&apos; version=&apos;1.0&apos;&gt;&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af15d57ddbee9fc1081f785f111f52b46">name_space</a>, to);
<a name="l00804"></a>00804    err = <a class="code" href="res__jabber_8c.html#a265a12987d4ab3483e7cd733f03ca1d6" title="Sends an XML string over an XMPP connection.">aji_send_raw</a>(client, msg);
<a name="l00805"></a>00805    iks_free(msg);
<a name="l00806"></a>00806    <span class="keywordflow">if</span> (err != IKS_OK)
<a name="l00807"></a>00807       <span class="keywordflow">return</span> err;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809    <span class="keywordflow">return</span> IKS_OK;
<a name="l00810"></a>00810 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a265a12987d4ab3483e7cd733f03ca1d6"></a><!-- doxytag: member="res_jabber.c::aji_send_raw" ref="a265a12987d4ab3483e7cd733f03ca1d6" args="(struct aji_client *client, const char *xmlstr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_send_raw </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>xmlstr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Sends an XML string over an XMPP connection. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>xmlstr</em>&nbsp;</td><td>the XML string to send The XML data is sent whether the connection is secured or not. In the latter case, we just call iks_send_raw(). </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_OK on success, any other value on failure </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00831">831</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00583">aji_is_secure()</a>, <a class="el" href="res__jabber_8c_source.html#l00863">aji_log_hook()</a>, <a class="el" href="func__strings_8c_source.html#l00821">len()</a>, <a class="el" href="jabber_8h_source.html#l00150">aji_client::p</a>, and <a class="el" href="jabber_8h_source.html#l00155">aji_client::ssl_session</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>, <a class="el" href="res__jabber_8c_source.html#l01985">aji_recv_loop()</a>, <a class="el" href="res__jabber_8c_source.html#l00792">aji_send_header()</a>, and <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00832"></a>00832 {
<a name="l00833"></a>00833    <span class="keywordtype">int</span> ret;
<a name="l00834"></a>00834 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l00835"></a>00835 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(xmlstr);
<a name="l00836"></a>00836 
<a name="l00837"></a>00837    <span class="keywordflow">if</span> (<a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(client)) {
<a name="l00838"></a>00838       ret = SSL_write(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>, xmlstr, len);
<a name="l00839"></a>00839       <span class="keywordflow">if</span> (ret) {
<a name="l00840"></a>00840          <span class="comment">/* Log the message here, because iksemel&apos;s logHook is </span>
<a name="l00841"></a>00841 <span class="comment">            unaccessible */</span>
<a name="l00842"></a>00842          <a class="code" href="res__jabber_8c.html#a0c0224cfe2418f3e1779239f44d0266c" title="the debug loop.">aji_log_hook</a>(client, xmlstr, len, 0);
<a name="l00843"></a>00843          <span class="keywordflow">return</span> IKS_OK;
<a name="l00844"></a>00844       }
<a name="l00845"></a>00845    }
<a name="l00846"></a>00846 <span class="preprocessor">#endif</span>
<a name="l00847"></a>00847 <span class="preprocessor"></span>   <span class="comment">/* If needed, data will be sent unencrypted, and logHook will </span>
<a name="l00848"></a>00848 <span class="comment">      be called inside iks_send_raw */</span>
<a name="l00849"></a>00849    ret = iks_send_raw(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>, xmlstr);
<a name="l00850"></a>00850    <span class="keywordflow">if</span> (ret != IKS_OK)
<a name="l00851"></a>00851       <span class="keywordflow">return</span> ret; 
<a name="l00852"></a>00852 
<a name="l00853"></a>00853    <span class="keywordflow">return</span> IKS_OK;
<a name="l00854"></a>00854 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a889348ddb7c785a009c26acb81ed232c"></a><!-- doxytag: member="res_jabber.c::aji_set_presence" ref="a889348ddb7c785a009c26acb81ed232c" args="(struct aji_client *client, char *to, char *from, int level, char *desc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void aji_set_presence </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>to</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>from</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>level</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>desc</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>set presence of client. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>to</em>&nbsp;</td><td><a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> send it to </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>from</em>&nbsp;</td><td><a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> it came from </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>level</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>desc</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>void. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02408">2408</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="jabber_8h_source.html#l00176">aji_client::priority</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l02305">aji_get_roster()</a>, <a class="el" href="res__jabber_8c_source.html#l01604">aji_handle_presence()</a>, and <a class="el" href="res__jabber_8c_source.html#l01822">aji_handle_subscribe()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02409"></a>02409 {
<a name="l02410"></a>02410    <span class="keywordtype">int</span> res = 0;
<a name="l02411"></a>02411    iks *presence = iks_make_pres(level, <a class="code" href="channel_8c.html#a710bce51374aba96ab04912897666c35">desc</a>);
<a name="l02412"></a>02412    iks *cnode = iks_new(<span class="stringliteral">&quot;c&quot;</span>);
<a name="l02413"></a>02413    iks *<a class="code" href="structaji__client.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = iks_new(<span class="stringliteral">&quot;priority&quot;</span>);
<a name="l02414"></a>02414    <span class="keywordtype">char</span> priorityS[10];
<a name="l02415"></a>02415 
<a name="l02416"></a>02416    <span class="keywordflow">if</span> (presence &amp;&amp; cnode &amp;&amp; client &amp;&amp; priority) {
<a name="l02417"></a>02417       <span class="keywordflow">if</span>(to)
<a name="l02418"></a>02418          iks_insert_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, to);
<a name="l02419"></a>02419       <span class="keywordflow">if</span>(from)
<a name="l02420"></a>02420          iks_insert_attrib(presence, <span class="stringliteral">&quot;from&quot;</span>, from);
<a name="l02421"></a>02421       snprintf(priorityS, <span class="keyword">sizeof</span>(priorityS), <span class="stringliteral">&quot;%d&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l02422"></a>02422       iks_insert_cdata(priority, priorityS, strlen(priorityS));
<a name="l02423"></a>02423       iks_insert_node(presence, priority);
<a name="l02424"></a>02424       iks_insert_attrib(cnode, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;http://www.asterisk.org/xmpp/client/caps&quot;</span>);
<a name="l02425"></a>02425       iks_insert_attrib(cnode, <span class="stringliteral">&quot;ver&quot;</span>, <span class="stringliteral">&quot;asterisk-xmpp&quot;</span>);
<a name="l02426"></a>02426       iks_insert_attrib(cnode, <span class="stringliteral">&quot;ext&quot;</span>, <span class="stringliteral">&quot;voice-v1&quot;</span>);
<a name="l02427"></a>02427       iks_insert_attrib(cnode, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/caps&quot;</span>);
<a name="l02428"></a>02428       iks_insert_node(presence, cnode);
<a name="l02429"></a>02429       res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, presence);
<a name="l02430"></a>02430    } <span class="keywordflow">else</span>
<a name="l02431"></a>02431       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l02432"></a>02432 
<a name="l02433"></a>02433    iks_delete(cnode);
<a name="l02434"></a>02434    iks_delete(presence);
<a name="l02435"></a>02435    iks_delete(priority);
<a name="l02436"></a>02436 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3eedb3c8124c4a01ac80f62b7bab047f"></a><!-- doxytag: member="res_jabber.c::aji_show_buddies" ref="a3eedb3c8124c4a01ac80f62b7bab047f" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char * aji_show_buddies </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Show buddy lists. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>CLI_SUCCESS. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02549">2549</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="astobj_8h_source.html#l00376">ASTOBJ_CONTAINER_TRAVERSE</a>, <a class="el" href="astobj_8h_source.html#l00100">ASTOBJ_RDLOCK</a>, <a class="el" href="astobj_8h_source.html#l00109">ASTOBJ_UNLOCK</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="jabber_8h_source.html#l00111">aji_resource::cap</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="res__jabber_8c_source.html#l00246">clients</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="jabber_8h_source.html#l00096">aji_version::jingle</a>, <a class="el" href="jabber_8h_source.html#l00113">aji_resource::next</a>, <a class="el" href="jabber_8h_source.html#l00102">aji_capabilities::node</a>, <a class="el" href="jabber_8h_source.html#l00097">aji_version::parent</a>, <a class="el" href="jabber_8h_source.html#l00112">aji_resource::priority</a>, <a class="el" href="jabber_8h_source.html#l00109">aji_resource::resource</a>, <a class="el" href="jabber_8h_source.html#l00108">aji_resource::status</a>, <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>, and <a class="el" href="jabber_8h_source.html#l00095">aji_version::version</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02550"></a>02550 {
<a name="l02551"></a>02551    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>;
<a name="l02552"></a>02552    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client;
<a name="l02553"></a>02553 
<a name="l02554"></a>02554    <span class="keywordflow">switch</span> (cmd) {
<a name="l02555"></a>02555    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l02556"></a>02556       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;jabber show buddies&quot;</span>;
<a name="l02557"></a>02557       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l02558"></a>02558          <span class="stringliteral">&quot;Usage: jabber show buddies\n&quot;</span>
<a name="l02559"></a>02559          <span class="stringliteral">&quot;       Shows buddy lists of our clients\n&quot;</span>;
<a name="l02560"></a>02560       <span class="keywordflow">return</span> NULL;
<a name="l02561"></a>02561    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l02562"></a>02562       <span class="keywordflow">return</span> NULL;
<a name="l02563"></a>02563    }
<a name="l02564"></a>02564 
<a name="l02565"></a>02565    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Jabber buddy lists\n&quot;</span>);
<a name="l02566"></a>02566    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l02567"></a>02567       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;Client: %s\n&quot;</span>, iterator-&gt;user);
<a name="l02568"></a>02568       client = iterator;
<a name="l02569"></a>02569       <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, 1, {
<a name="l02570"></a>02570          <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02571"></a>02571          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\tBuddy:\t%s\n&quot;</span>, iterator-&gt;name);
<a name="l02572"></a>02572          <span class="keywordflow">if</span> (!iterator-&gt;resources)
<a name="l02573"></a>02573             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\tResource: None\n&quot;</span>); 
<a name="l02574"></a>02574          <span class="keywordflow">for</span> (resource = iterator-&gt;resources; resource; resource = resource-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>) {
<a name="l02575"></a>02575             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\tResource: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>);
<a name="l02576"></a>02576             <span class="keywordflow">if</span>(resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>) {
<a name="l02577"></a>02577                <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\t\tnode: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a99020efc7f580df36182fc3be139f1b9">parent</a>-&gt;<a class="code" href="structaji__capabilities.html#a987239273bb4a074ad22c76c6486d5b1">node</a>);
<a name="l02578"></a>02578                <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\t\tversion: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>);
<a name="l02579"></a>02579                <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\t\tJingle capable: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> ? <span class="stringliteral">&quot;yes&quot;</span> : <span class="stringliteral">&quot;no&quot;</span>);
<a name="l02580"></a>02580             }
<a name="l02581"></a>02581             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\tStatus: %d\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a6e27f49150e9a14580fb313cc2777e00">status</a>);
<a name="l02582"></a>02582             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\tPriority: %d\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l02583"></a>02583          }
<a name="l02584"></a>02584          <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02585"></a>02585       });
<a name="l02586"></a>02586       iterator = client;
<a name="l02587"></a>02587    });
<a name="l02588"></a>02588    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02589"></a>02589 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab098aeaf9f3ec6b05f4360ab16113afc"></a><!-- doxytag: member="res_jabber.c::aji_show_clients" ref="ab098aeaf9f3ec6b05f4360ab16113afc" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char * aji_show_clients </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Show client status. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>CLI_SUCCESS. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02504">2504</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="jabber_8h_source.html#l00080">AJI_CONNECTED</a>, <a class="el" href="jabber_8h_source.html#l00079">AJI_CONNECTING</a>, <a class="el" href="jabber_8h_source.html#l00078">AJI_DISCONNECTED</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="astobj_8h_source.html#l00376">ASTOBJ_CONTAINER_TRAVERSE</a>, <a class="el" href="astobj_8h_source.html#l00100">ASTOBJ_RDLOCK</a>, <a class="el" href="astobj_8h_source.html#l00109">ASTOBJ_UNLOCK</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="res__jabber_8c_source.html#l00246">clients</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="app__jack_8c_source.html#l00141">status</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02505"></a>02505 {
<a name="l02506"></a>02506    <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>;
<a name="l02507"></a>02507    <span class="keywordtype">int</span> count = 0;
<a name="l02508"></a>02508    
<a name="l02509"></a>02509    <span class="keywordflow">switch</span> (cmd) {
<a name="l02510"></a>02510    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l02511"></a>02511       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;jabber show connected&quot;</span>;
<a name="l02512"></a>02512       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l02513"></a>02513          <span class="stringliteral">&quot;Usage: jabber show connected\n&quot;</span>
<a name="l02514"></a>02514          <span class="stringliteral">&quot;       Shows state of clients and components\n&quot;</span>;
<a name="l02515"></a>02515       <span class="keywordflow">return</span> NULL;
<a name="l02516"></a>02516    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l02517"></a>02517       <span class="keywordflow">return</span> NULL;
<a name="l02518"></a>02518    }
<a name="l02519"></a>02519 
<a name="l02520"></a>02520    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Jabber Users and their status:\n&quot;</span>);
<a name="l02521"></a>02521    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l02522"></a>02522       <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02523"></a>02523       count++;
<a name="l02524"></a>02524       <span class="keywordflow">switch</span> (iterator-&gt;state) {
<a name="l02525"></a>02525       <span class="keywordflow">case</span> <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a46d3c148625b0889f793b6c355051d3b">AJI_DISCONNECTED</a>:
<a name="l02526"></a>02526          status = <span class="stringliteral">&quot;Disconnected&quot;</span>;
<a name="l02527"></a>02527          <span class="keywordflow">break</span>;
<a name="l02528"></a>02528       <span class="keywordflow">case</span> <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ade80d6f33c170eeaeb1fbc84ebdb1a2f">AJI_CONNECTING</a>:
<a name="l02529"></a>02529          status = <span class="stringliteral">&quot;Connecting&quot;</span>;
<a name="l02530"></a>02530          <span class="keywordflow">break</span>;
<a name="l02531"></a>02531       <span class="keywordflow">case</span> <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a>:
<a name="l02532"></a>02532          status = <span class="stringliteral">&quot;Connected&quot;</span>;
<a name="l02533"></a>02533          <span class="keywordflow">break</span>;
<a name="l02534"></a>02534       <span class="keywordflow">default</span>:
<a name="l02535"></a>02535          status = <span class="stringliteral">&quot;Unknown&quot;</span>;
<a name="l02536"></a>02536       }
<a name="l02537"></a>02537       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;       User: %s     - %s\n&quot;</span>, iterator-&gt;user, status);
<a name="l02538"></a>02538       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02539"></a>02539    });
<a name="l02540"></a>02540    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;----\n&quot;</span>);
<a name="l02541"></a>02541    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;   Number of users: %d\n&quot;</span>, count);
<a name="l02542"></a>02542    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02543"></a>02543 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1b15523e274d7f26568ef5521a73e7ce"></a><!-- doxytag: member="res_jabber.c::aji_start_sasl" ref="a1b15523e274d7f26568ef5521a73e7ce" args="(struct aji_client *client, enum ikssasltype type, char *username, char *pass)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_start_sasl </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum ikssasltype&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>username</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>pass</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>A wrapper function for iks_start_sasl. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>type</em>&nbsp;</td><td>the SASL authentication type. Supported types are PLAIN and MD5 </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>username</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pass</em>&nbsp;</td><td>password.</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_OK on success, IKSNET_NOTSUPP on failure. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00895">895</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00583">aji_is_secure()</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="utils_8c_source.html#l00342">ast_base64encode()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8c_source.html#l00065">base64</a>, <a class="el" href="func__strings_8c_source.html#l00821">len()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="jabber_8h_source.html#l00150">aji_client::p</a>, and <a class="el" href="aesopt_8h_source.html#l00399">s</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00896"></a>00896 {
<a name="l00897"></a>00897    iks *x = NULL;
<a name="l00898"></a>00898    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l00899"></a>00899    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00900"></a>00900    <span class="keywordtype">char</span> *<a class="code" href="utils_8c.html#a094cd85754f67592588ab5a0636cf0ea">base64</a>;
<a name="l00901"></a>00901 
<a name="l00902"></a>00902    <span class="comment">/* trigger SASL DIGEST-MD5 only over an unsecured connection.</span>
<a name="l00903"></a>00903 <span class="comment">      iks_start_sasl is an iksemel API function and relies on GnuTLS,</span>
<a name="l00904"></a>00904 <span class="comment">      whereas we use OpenSSL */</span>
<a name="l00905"></a>00905    <span class="keywordflow">if</span> ((<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a> &amp; IKS_STREAM_SASL_MD5) &amp;&amp; !<a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(client))
<a name="l00906"></a>00906       <span class="keywordflow">return</span> iks_start_sasl(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>, IKS_SASL_DIGEST_MD5, username, <a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>); 
<a name="l00907"></a>00907    <span class="keywordflow">if</span> (!(<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a> &amp; IKS_STREAM_SASL_PLAIN)) {
<a name="l00908"></a>00908       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Server does not support SASL PLAIN authentication\n&quot;</span>);
<a name="l00909"></a>00909       <span class="keywordflow">return</span> IKS_NET_NOTSUPP;
<a name="l00910"></a>00910    }
<a name="l00911"></a>00911 
<a name="l00912"></a>00912    x = iks_new(<span class="stringliteral">&quot;auth&quot;</span>); 
<a name="l00913"></a>00913    <span class="keywordflow">if</span> (!x) {
<a name="l00914"></a>00914       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l00915"></a>00915       <span class="keywordflow">return</span> IKS_NET_NOTSUPP;
<a name="l00916"></a>00916    }
<a name="l00917"></a>00917 
<a name="l00918"></a>00918    iks_insert_attrib(x, <span class="stringliteral">&quot;xmlns&quot;</span>, IKS_NS_XMPP_SASL);
<a name="l00919"></a>00919    len = strlen(username) + strlen(<a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>) + 3;
<a name="l00920"></a>00920    s = alloca(len);
<a name="l00921"></a>00921    base64 = alloca((len + 2) * 4 / 3);
<a name="l00922"></a>00922    iks_insert_attrib(x, <span class="stringliteral">&quot;mechanism&quot;</span>, <span class="stringliteral">&quot;PLAIN&quot;</span>);
<a name="l00923"></a>00923    snprintf(s, len, <span class="stringliteral">&quot;%c%s%c%s&quot;</span>, 0, username, 0, <a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>);
<a name="l00924"></a>00924 
<a name="l00925"></a>00925    <span class="comment">/* exclude the NULL training byte from the base64 encoding operation</span>
<a name="l00926"></a>00926 <span class="comment">      as some XMPP servers will refuse it.</span>
<a name="l00927"></a>00927 <span class="comment">      The format for authentication is [authzid]\0authcid\0password</span>
<a name="l00928"></a>00928 <span class="comment">      not [authzid]\0authcid\0password\0 */</span>
<a name="l00929"></a>00929    <a class="code" href="utils_8h.html#a555dad1bd5b23acf01cf08f1affab879" title="Encode data in base64.">ast_base64encode</a>(base64, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) s, len - 1, (len + 2) * 4 / 3);
<a name="l00930"></a>00930    iks_insert_cdata(x, base64, 0);
<a name="l00931"></a>00931    <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, x);
<a name="l00932"></a>00932    iks_delete(x);
<a name="l00933"></a>00933 
<a name="l00934"></a>00934    <span class="keywordflow">return</span> IKS_OK;
<a name="l00935"></a>00935 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad7bb4a25ad47122d109b34c3e8552f96"></a><!-- doxytag: member="res_jabber.c::aji_start_tls" ref="ad7bb4a25ad47122d109b34c3e8552f96" args="(struct aji_client *client)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_start_tls </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Starts the TLS procedure. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_OK on success, an error code if sending failed, IKS_NET_TLSFAIL if OpenSSL is not installed </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00599">599</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="jabber_8h_source.html#l00150">aji_client::p</a>, <a class="el" href="jabber_8h_source.html#l00157">aji_client::stream_flags</a>, and <a class="el" href="jabber_8h_source.html#l00050">TRY_SECURE</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00600"></a>00600 {
<a name="l00601"></a>00601    <span class="keywordtype">int</span> ret;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603    <span class="comment">/* This is sent not encrypted */</span>
<a name="l00604"></a>00604    ret = iks_send_raw(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>, <span class="stringliteral">&quot;&lt;starttls xmlns=&apos;urn:ietf:params:xml:ns:xmpp-tls&apos;/&gt;&quot;</span>);
<a name="l00605"></a>00605    <span class="keywordflow">if</span> (ret)
<a name="l00606"></a>00606       <span class="keywordflow">return</span> ret;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608    client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> |= <a class="code" href="jabber_8h.html#ab432cc1c9f5228a80e1fe12e301a2f0f">TRY_SECURE</a>;
<a name="l00609"></a>00609    <span class="keywordflow">return</span> IKS_OK;
<a name="l00610"></a>00610 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af34ff341cd5689c2c1355daf38e38682"></a><!-- doxytag: member="res_jabber.c::aji_status_exec" ref="af34ff341cd5689c2c1355daf38e38682" args="(struct ast_channel *chan, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_status_exec </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Dial plan function <a class="el" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status()</a>. puts the status of watched <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> into a channel variable. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td><a class="el" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>0 on success, -1 on error </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00432">432</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00370">aji_find_resource()</a>, <a class="el" href="res__jabber_8c_source.html#l02954">ast_aji_get_client()</a>, <a class="el" href="app_8h_source.html#l00338">AST_APP_ARG</a>, <a class="el" href="app_8h_source.html#l00355">AST_DECLARE_APP_ARGS</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="app_8h_source.html#l00402">AST_NONSTANDARD_APP_ARGS</a>, <a class="el" href="app_8h_source.html#l00387">AST_STANDARD_APP_ARGS</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>, <a class="el" href="jabber_8h_source.html#l00109">aji_resource::resource</a>, <a class="el" href="jabber_8h_source.html#l00127">aji_buddy::resources</a>, <a class="el" href="aesopt_8h_source.html#l00399">s</a>, <a class="el" href="jabber_8h_source.html#l00108">aji_resource::status</a>, and <a class="el" href="app__jack_8c_source.html#l00141">status</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l03085">load_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00433"></a>00433 {
<a name="l00434"></a>00434    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l00435"></a>00435    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = NULL;
<a name="l00436"></a>00436    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *r = NULL;
<a name="l00437"></a>00437    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = NULL;
<a name="l00438"></a>00438    <span class="keywordtype">int</span> stat = 7;
<a name="l00439"></a>00439    <span class="keywordtype">char</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>[2];
<a name="l00440"></a>00440    <span class="keyword">static</span> <span class="keywordtype">int</span> deprecation_warning = 0;
<a name="l00441"></a>00441    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l00442"></a>00442       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(sender);
<a name="l00443"></a>00443       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(jid);
<a name="l00444"></a>00444       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(variable);
<a name="l00445"></a>00445    );
<a name="l00446"></a>00446    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(jid,
<a name="l00447"></a>00447       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(screenname);
<a name="l00448"></a>00448       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>);
<a name="l00449"></a>00449    );
<a name="l00450"></a>00450 
<a name="l00451"></a>00451    <span class="keywordflow">if</span> (deprecation_warning++ % 10 == 0)
<a name="l00452"></a>00452       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JabberStatus is deprecated.  Please use the JABBER_STATUS dialplan function in the future.\n&quot;</span>);
<a name="l00453"></a>00453 
<a name="l00454"></a>00454    <span class="keywordflow">if</span> (!data) {
<a name="l00455"></a>00455       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Usage: JabberStatus(&lt;sender&gt;,&lt;jid&gt;[/&lt;resource&gt;],&lt;varname&gt;\n&quot;</span>);
<a name="l00456"></a>00456       <span class="keywordflow">return</span> 0;
<a name="l00457"></a>00457    }
<a name="l00458"></a>00458    s = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l00459"></a>00459    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, s);
<a name="l00460"></a>00460 
<a name="l00461"></a>00461    <span class="keywordflow">if</span> (args.argc != 3) {
<a name="l00462"></a>00462       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JabberStatus() requires 3 arguments.\n&quot;</span>);
<a name="l00463"></a>00463       <span class="keywordflow">return</span> -1;
<a name="l00464"></a>00464    }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466    <a class="code" href="app_8h.html#accfcb380df76a64251d88ef49c2dd4e3" title="Performs the &amp;#39;nonstandard&amp;#39; argument separation process for an application...">AST_NONSTANDARD_APP_ARGS</a>(jid, args.jid, <span class="charliteral">&apos;/&apos;</span>);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468    <span class="keywordflow">if</span> (!(client = <a class="code" href="jabber_8h.html#a6689c8e948c8d55e092f30277336fde7" title="grab a aji_client structure by label name or JID (without the resource string)">ast_aji_get_client</a>(args.sender))) {
<a name="l00469"></a>00469       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find sender connection: &apos;%s&apos;\n&quot;</span>, args.sender);
<a name="l00470"></a>00470       <span class="keywordflow">return</span> -1;
<a name="l00471"></a>00471    }
<a name="l00472"></a>00472    buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, jid.screenname);
<a name="l00473"></a>00473    <span class="keywordflow">if</span> (!buddy) {
<a name="l00474"></a>00474       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find buddy in list: &apos;%s&apos;\n&quot;</span>, jid.screenname);
<a name="l00475"></a>00475       <span class="keywordflow">return</span> -1;
<a name="l00476"></a>00476    }
<a name="l00477"></a>00477    r = <a class="code" href="res__jabber_8c.html#a6628a57705b502b2c15c5c66bdc4bd67" title="Find the aji_resource we want.">aji_find_resource</a>(buddy, jid.resource);
<a name="l00478"></a>00478    <span class="keywordflow">if</span> (!r &amp;&amp; buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>) 
<a name="l00479"></a>00479       r = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l00480"></a>00480    <span class="keywordflow">if</span> (!r)
<a name="l00481"></a>00481       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Resource &apos;%s&apos; of buddy &apos;%s&apos; was not found\n&quot;</span>, jid.resource, jid.screenname);
<a name="l00482"></a>00482    <span class="keywordflow">else</span>
<a name="l00483"></a>00483       stat = r-&gt;<a class="code" href="structaji__resource.html#a6e27f49150e9a14580fb313cc2777e00">status</a>;
<a name="l00484"></a>00484    snprintf(status, <span class="keyword">sizeof</span>(status), <span class="stringliteral">&quot;%d&quot;</span>, stat);
<a name="l00485"></a>00485    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, args.variable, status);
<a name="l00486"></a>00486    <span class="keywordflow">return</span> 0;
<a name="l00487"></a>00487 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af86ff7c316e29a5c6a914b4a9c2bc330"></a><!-- doxytag: member="res_jabber.c::aji_test" ref="af86ff7c316e29a5c6a914b4a9c2bc330" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char * aji_test </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Send test <a class="el" href="structmessage.html">message</a> for debugging. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>CLI_SUCCESS,CLI_FAILURE. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02595">2595</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8h_source.html#l00141">ast_cli_args::argv</a>, <a class="el" href="res__jabber_8c_source.html#l01867">ast_aji_send_chat()</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="logger_8h_source.html#l00079">ast_verbose</a>, <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, <a class="el" href="astobj_8h_source.html#l00376">ASTOBJ_CONTAINER_TRAVERSE</a>, <a class="el" href="astobj_8h_source.html#l00100">ASTOBJ_RDLOCK</a>, <a class="el" href="astobj_8h_source.html#l00109">ASTOBJ_UNLOCK</a>, <a class="el" href="jabber_8h_source.html#l00172">aji_client::buddies</a>, <a class="el" href="jabber_8h_source.html#l00111">aji_resource::cap</a>, <a class="el" href="cli_8h_source.html#l00045">CLI_FAILURE</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="res__jabber_8c_source.html#l00246">clients</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="jabber_8h_source.html#l00110">aji_resource::description</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="jabber_8h_source.html#l00096">aji_version::jingle</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00053">name</a>, <a class="el" href="jabber_8h_source.html#l00113">aji_resource::next</a>, <a class="el" href="jabber_8h_source.html#l00102">aji_capabilities::node</a>, <a class="el" href="jabber_8h_source.html#l00097">aji_version::parent</a>, <a class="el" href="jabber_8h_source.html#l00112">aji_resource::priority</a>, <a class="el" href="jabber_8h_source.html#l00109">aji_resource::resource</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, <a class="el" href="jabber_8h_source.html#l00108">aji_resource::status</a>, <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>, and <a class="el" href="jabber_8h_source.html#l00095">aji_version::version</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02596"></a>02596 {
<a name="l02597"></a>02597    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client;
<a name="l02598"></a>02598    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>;
<a name="l02599"></a>02599    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a> = <span class="stringliteral">&quot;asterisk&quot;</span>;
<a name="l02600"></a>02600    <span class="keyword">struct </span><a class="code" href="structaji__message.html">aji_message</a> *tmp;
<a name="l02601"></a>02601 
<a name="l02602"></a>02602    <span class="keywordflow">switch</span> (cmd) {
<a name="l02603"></a>02603    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l02604"></a>02604       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;jabber test&quot;</span>;
<a name="l02605"></a>02605       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l02606"></a>02606          <span class="stringliteral">&quot;Usage: jabber test [client]\n&quot;</span>
<a name="l02607"></a>02607          <span class="stringliteral">&quot;       Sends test message for debugging purposes.  A specific client\n&quot;</span>
<a name="l02608"></a>02608          <span class="stringliteral">&quot;       as configured in jabber.conf can be optionally specified.\n&quot;</span>;
<a name="l02609"></a>02609       <span class="keywordflow">return</span> NULL;
<a name="l02610"></a>02610    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l02611"></a>02611       <span class="keywordflow">return</span> NULL;
<a name="l02612"></a>02612    }
<a name="l02613"></a>02613 
<a name="l02614"></a>02614    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 3)
<a name="l02615"></a>02615       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l02616"></a>02616    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3)
<a name="l02617"></a>02617       name = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2];
<a name="l02618"></a>02618 
<a name="l02619"></a>02619    <span class="keywordflow">if</span> (!(client = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, name))) {
<a name="l02620"></a>02620       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unable to find client &apos;%s&apos;!\n&quot;</span>, name);
<a name="l02621"></a>02621       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l02622"></a>02622    }
<a name="l02623"></a>02623 
<a name="l02624"></a>02624    <span class="comment">/* XXX Does Matt really want everyone to use his personal address for tests? */</span> <span class="comment">/* XXX yes he does */</span>
<a name="l02625"></a>02625    <a class="code" href="jabber_8h.html#af2b674ed94b89a5798fe22714a44f046" title="sends messages.">ast_aji_send_chat</a>(client, <span class="stringliteral">&quot;mogorman@astjab.org&quot;</span>, <span class="stringliteral">&quot;blahblah&quot;</span>);
<a name="l02626"></a>02626    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, 1, {
<a name="l02627"></a>02627       <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02628"></a>02628       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;User: %s\n&quot;</span>, iterator-&gt;name);
<a name="l02629"></a>02629       <span class="keywordflow">for</span> (resource = iterator-&gt;resources; resource; resource = resource-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>) {
<a name="l02630"></a>02630          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Resource: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>);
<a name="l02631"></a>02631          <span class="keywordflow">if</span>(resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>) {
<a name="l02632"></a>02632             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;   client: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a99020efc7f580df36182fc3be139f1b9">parent</a>-&gt;<a class="code" href="structaji__capabilities.html#a987239273bb4a074ad22c76c6486d5b1">node</a>);
<a name="l02633"></a>02633             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;   version: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>);
<a name="l02634"></a>02634             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;   Jingle Capable: %d\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a>);
<a name="l02635"></a>02635          }
<a name="l02636"></a>02636          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Priority: %d\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l02637"></a>02637          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Status: %d\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a6e27f49150e9a14580fb313cc2777e00">status</a>); 
<a name="l02638"></a>02638          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Message: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(resource-&gt;<a class="code" href="structaji__resource.html#a8444d6e0dfe2bbab0b5e7b24308f1559">description</a>,<span class="stringliteral">&quot;&quot;</span>)); 
<a name="l02639"></a>02639       }
<a name="l02640"></a>02640       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02641"></a>02641    });
<a name="l02642"></a>02642    <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;\nOooh a working message stack!\n&quot;</span>);
<a name="l02643"></a>02643    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;client-&gt;messages);
<a name="l02644"></a>02644    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;client-&gt;messages, tmp, list) {
<a name="l02645"></a>02645       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Message from: %s with id %s @ %s %s\n&quot;</span>,tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(tmp-&gt;<a class="code" href="structaji__message.html#a51d291314bf1da3f9ac4479963a4fadd">id</a>,<span class="stringliteral">&quot;&quot;</span>), ctime(&amp;tmp-&gt;<a class="code" href="structaji__message.html#aec3ba7effb2fee6e19a3a258b1749394">arrived</a>), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>, <span class="stringliteral">&quot;&quot;</span>));
<a name="l02646"></a>02646    }
<a name="l02647"></a>02647    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;client-&gt;messages);
<a name="l02648"></a>02648    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02649"></a>02649 
<a name="l02650"></a>02650    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02651"></a>02651 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a626fb8236724be309a0d3ee3a2e979ed"></a><!-- doxytag: member="res_jabber.c::aji_tls_handshake" ref="a626fb8236724be309a0d3ee3a2e979ed" args="(struct aji_client *client)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int aji_tls_handshake </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>TLS handshake, OpenSSL initialization. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_OK on success, IKS_NET_TLSFAIL on failure </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00617">617</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00792">aji_send_header()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="jabber_8h_source.html#l00149">aji_client::jid</a>, <a class="el" href="jabber_8h_source.html#l00150">aji_client::p</a>, <a class="el" href="jabber_8h_source.html#l00051">SECURE</a>, <a class="el" href="jabber_8h_source.html#l00154">aji_client::ssl_context</a>, <a class="el" href="jabber_8h_source.html#l00156">aji_client::ssl_method</a>, <a class="el" href="jabber_8h_source.html#l00155">aji_client::ssl_session</a>, <a class="el" href="jabber_8h_source.html#l00157">aji_client::stream_flags</a>, and <a class="el" href="jabber_8h_source.html#l00050">TRY_SECURE</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00618"></a>00618 {
<a name="l00619"></a>00619    <span class="keywordtype">int</span> ret;
<a name="l00620"></a>00620    <span class="keywordtype">int</span> sock;
<a name="l00621"></a>00621    
<a name="l00622"></a>00622    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Starting TLS handshake\n&quot;</span>); 
<a name="l00623"></a>00623 
<a name="l00624"></a>00624    <span class="comment">/* Choose an SSL/TLS protocol version, create SSL_CTX */</span>
<a name="l00625"></a>00625    client-&gt;<a class="code" href="structaji__client.html#ae7d8930ee375c24f1dc8769888441e55">ssl_method</a> = SSLv3_method();
<a name="l00626"></a>00626    client-&gt;<a class="code" href="structaji__client.html#a8c5d83fcb87f22326009954a4652d92e">ssl_context</a> = SSL_CTX_new(client-&gt;<a class="code" href="structaji__client.html#ae7d8930ee375c24f1dc8769888441e55">ssl_method</a>);                
<a name="l00627"></a>00627    <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#a8c5d83fcb87f22326009954a4652d92e">ssl_context</a>)
<a name="l00628"></a>00628       <span class="keywordflow">return</span> IKS_NET_TLSFAIL;
<a name="l00629"></a>00629 
<a name="l00630"></a>00630    <span class="comment">/* Create new SSL session */</span>
<a name="l00631"></a>00631    client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a> = SSL_new(client-&gt;<a class="code" href="structaji__client.html#a8c5d83fcb87f22326009954a4652d92e">ssl_context</a>);
<a name="l00632"></a>00632    <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>)
<a name="l00633"></a>00633       <span class="keywordflow">return</span> IKS_NET_TLSFAIL;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635    <span class="comment">/* Enforce TLS on our XMPP connection */</span>
<a name="l00636"></a>00636    sock = iks_fd(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>);
<a name="l00637"></a>00637    ret = SSL_set_fd(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>, sock);
<a name="l00638"></a>00638    <span class="keywordflow">if</span> (!ret)
<a name="l00639"></a>00639       <span class="keywordflow">return</span> IKS_NET_TLSFAIL;
<a name="l00640"></a>00640 
<a name="l00641"></a>00641    <span class="comment">/* Perform SSL handshake */</span>
<a name="l00642"></a>00642    ret = SSL_connect(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>);
<a name="l00643"></a>00643    <span class="keywordflow">if</span> (!ret)
<a name="l00644"></a>00644       <span class="keywordflow">return</span> IKS_NET_TLSFAIL;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646    client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> &amp;= (~<a class="code" href="jabber_8h.html#ab432cc1c9f5228a80e1fe12e301a2f0f">TRY_SECURE</a>);
<a name="l00647"></a>00647    client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> |= <a class="code" href="jabber_8h.html#aff0ca0337402eb888baf747ce2469641">SECURE</a>;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649    <span class="comment">/* Sent over the established TLS connection */</span>
<a name="l00650"></a>00650    ret = <a class="code" href="res__jabber_8c.html#a21ae37866a3ab62cb29456b23c423a9c" title="Sends XMPP header to the server.">aji_send_header</a>(client, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;server);
<a name="l00651"></a>00651    <span class="keywordflow">if</span> (ret != IKS_OK)
<a name="l00652"></a>00652       <span class="keywordflow">return</span> IKS_NET_TLSFAIL;
<a name="l00653"></a>00653 
<a name="l00654"></a>00654    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;TLS started with server\n&quot;</span>); 
<a name="l00655"></a>00655 
<a name="l00656"></a>00656    <span class="keywordflow">return</span> IKS_OK;
<a name="l00657"></a>00657 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a8ce87df2b2878a7384640e3720ba1c2c"></a><!-- doxytag: member="res_jabber.c::ast_aji_create_chat" ref="a8ce87df2b2878a7384640e3720ba1c2c" args="(struct aji_client *client, char *room, char *server, char *topic)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_aji_create_chat </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>room</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>server</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>topic</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>create a chatroom. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>room</em>&nbsp;</td><td>name of room </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>server</em>&nbsp;</td><td>name of server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>topic</em>&nbsp;</td><td>topic for the room. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>0. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01894">1894</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l02038">ast_aji_increment_mid()</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="jabber_8h_source.html#l00148">aji_client::mid</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01895"></a>01895 {
<a name="l01896"></a>01896    <span class="keywordtype">int</span> res = 0;
<a name="l01897"></a>01897    iks *iq = NULL;
<a name="l01898"></a>01898    iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01899"></a>01899 
<a name="l01900"></a>01900    <span class="keywordflow">if</span> (iq &amp;&amp; client) {
<a name="l01901"></a>01901       iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;get&quot;</span>);
<a name="l01902"></a>01902       iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, server);
<a name="l01903"></a>01903       iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01904"></a>01904       <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01905"></a>01905       <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01906"></a>01906    } <span class="keywordflow">else</span> 
<a name="l01907"></a>01907       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01908"></a>01908 
<a name="l01909"></a>01909    iks_delete(iq);
<a name="l01910"></a>01910 
<a name="l01911"></a>01911    <span class="keywordflow">return</span> res;
<a name="l01912"></a>01912 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a06f01ad5dc78d9300fed1415b54be04a"></a><!-- doxytag: member="res_jabber.c::ast_aji_disconnect" ref="a06f01ad5dc78d9300fed1415b54be04a" args="(struct aji_client *client)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_aji_disconnect </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>disconnect from jabber server. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>1. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02380">2380</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="astobj_8h_source.html#l00218">ASTOBJ_UNREF</a>, <a class="el" href="jabber_8h_source.html#l00150">aji_client::p</a>, <a class="el" href="jabber_8h_source.html#l00051">SECURE</a>, <a class="el" href="jabber_8h_source.html#l00154">aji_client::ssl_context</a>, <a class="el" href="jabber_8h_source.html#l00155">aji_client::ssl_session</a>, and <a class="el" href="jabber_8h_source.html#l00157">aji_client::stream_flags</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l03061">unload_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02381"></a>02381 {
<a name="l02382"></a>02382    <span class="keywordflow">if</span> (client) {
<a name="l02383"></a>02383       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;JABBER: Disconnecting\n&quot;</span>);
<a name="l02384"></a>02384 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l02385"></a>02385 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> &amp; <a class="code" href="jabber_8h.html#aff0ca0337402eb888baf747ce2469641">SECURE</a>) {
<a name="l02386"></a>02386          SSL_shutdown(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>);
<a name="l02387"></a>02387          SSL_CTX_free(client-&gt;<a class="code" href="structaji__client.html#a8c5d83fcb87f22326009954a4652d92e">ssl_context</a>);
<a name="l02388"></a>02388          SSL_free(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>);
<a name="l02389"></a>02389       }
<a name="l02390"></a>02390 <span class="preprocessor">#endif</span>
<a name="l02391"></a>02391 <span class="preprocessor"></span>      iks_disconnect(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>);
<a name="l02392"></a>02392       iks_parser_delete(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>);
<a name="l02393"></a>02393       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02394"></a>02394    }
<a name="l02395"></a>02395 
<a name="l02396"></a>02396    <span class="keywordflow">return</span> 1;
<a name="l02397"></a>02397 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6689c8e948c8d55e092f30277336fde7"></a><!-- doxytag: member="res_jabber.c::ast_aji_get_client" ref="a6689c8e948c8d55e092f30277336fde7" args="(const char *name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structaji__client.html">aji_client</a>* ast_aji_get_client </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>grab a <a class="el" href="structaji__client.html">aji_client</a> structure by label name or JID (without the resource string) </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>name</em>&nbsp;</td><td>label or JID </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd><a class="el" href="structaji__client.html">aji_client</a>. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02954">2954</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="astobj_8h_source.html#l00401">ASTOBJ_CONTAINER_FIND</a>, <a class="el" href="astobj_8h_source.html#l00376">ASTOBJ_CONTAINER_TRAVERSE</a>, <a class="el" href="res__jabber_8c_source.html#l00246">clients</a>, and <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00489">acf_jabberstatus_read()</a>, <a class="el" href="res__jabber_8c_source.html#l00548">aji_send_exec()</a>, <a class="el" href="res__jabber_8c_source.html#l00432">aji_status_exec()</a>, <a class="el" href="chan__gtalk_8c_source.html#l01840">gtalk_create_member()</a>, <a class="el" href="chan__gtalk_8c_source.html#l01154">gtalk_newcall()</a>, <a class="el" href="chan__gtalk_8c_source.html#l01637">gtalk_request()</a>, <a class="el" href="chan__jingle_8c_source.html#l01666">jingle_create_member()</a>, <a class="el" href="chan__jingle_8c_source.html#l00954">jingle_newcall()</a>, <a class="el" href="chan__jingle_8c_source.html#l01468">jingle_request()</a>, and <a class="el" href="res__jabber_8c_source.html#l02994">manager_jabber_send()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02955"></a>02955 {
<a name="l02956"></a>02956    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l02957"></a>02957    <span class="keywordtype">char</span> *aux = NULL;
<a name="l02958"></a>02958 
<a name="l02959"></a>02959    client = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l02960"></a>02960    <span class="keywordflow">if</span> (!client &amp;&amp; strchr(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="charliteral">&apos;@&apos;</span>)) {
<a name="l02961"></a>02961       <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l02962"></a>02962          aux = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(iterator-&gt;user);
<a name="l02963"></a>02963          <span class="keywordflow">if</span> (strchr(aux, <span class="charliteral">&apos;/&apos;</span>)) {
<a name="l02964"></a>02964             <span class="comment">/* strip resource for comparison */</span>
<a name="l02965"></a>02965             aux = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;aux, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l02966"></a>02966          }
<a name="l02967"></a>02967          <span class="keywordflow">if</span> (!strncasecmp(aux, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, strlen(aux))) {
<a name="l02968"></a>02968             client = iterator;
<a name="l02969"></a>02969          }           
<a name="l02970"></a>02970       });
<a name="l02971"></a>02971    }
<a name="l02972"></a>02972 
<a name="l02973"></a>02973    <span class="keywordflow">return</span> client;
<a name="l02974"></a>02974 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a740bf5f4ba6bf40ff9273ca8f7a89710"></a><!-- doxytag: member="res_jabber.c::ast_aji_get_clients" ref="a740bf5f4ba6bf40ff9273ca8f7a89710" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structaji__client__container.html">aji_client_container</a>* ast_aji_get_clients </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02976">2976</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00246">clients</a>.</p>

<p>Referenced by <a class="el" href="chan__gtalk_8c_source.html#l01901">gtalk_load_config()</a>, and <a class="el" href="chan__jingle_8c_source.html#l01724">jingle_load_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02977"></a>02977 {
<a name="l02978"></a>02978    <span class="keywordflow">return</span> &amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>;
<a name="l02979"></a>02979 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6e4ae95e74b73933aa6e6d6817df9023"></a><!-- doxytag: member="res_jabber.c::ast_aji_increment_mid" ref="a6e4ae95e74b73933aa6e6d6817df9023" args="(char *mid)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_aji_increment_mid </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>mid</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>increments the mid field for messages and other events. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>mid</em>&nbsp;</td><td>char. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>void. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02038">2038</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>, <a class="el" href="res__jabber_8c_source.html#l01604">aji_handle_presence()</a>, <a class="el" href="res__jabber_8c_source.html#l01144">aji_register_approve_handler()</a>, <a class="el" href="res__jabber_8c_source.html#l01894">ast_aji_create_chat()</a>, <a class="el" href="res__jabber_8c_source.html#l01951">ast_aji_invite_chat()</a>, <a class="el" href="chan__gtalk_8c_source.html#l01078">gtalk_action()</a>, <a class="el" href="chan__gtalk_8c_source.html#l00773">gtalk_create_candidates()</a>, <a class="el" href="chan__gtalk_8c_source.html#l01512">gtalk_digit()</a>, <a class="el" href="chan__gtalk_8c_source.html#l00379">gtalk_invite()</a>, <a class="el" href="chan__gtalk_8c_source.html#l00458">gtalk_invite_response()</a>, <a class="el" href="chan__jingle_8c_source.html#l00311">jingle_accept_call()</a>, <a class="el" href="chan__jingle_8c_source.html#l00883">jingle_action()</a>, <a class="el" href="chan__jingle_8c_source.html#l00583">jingle_create_candidates()</a>, <a class="el" href="chan__jingle_8c_source.html#l01284">jingle_digit()</a>, and <a class="el" href="chan__jingle_8c_source.html#l01346">jingle_transmit_invite()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02039"></a>02039 {
<a name="l02040"></a>02040    <span class="keywordtype">int</span> i = 0;
<a name="l02041"></a>02041 
<a name="l02042"></a>02042    <span class="keywordflow">for</span> (i = strlen(<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>) - 1; i &gt;= 0; i--) {
<a name="l02043"></a>02043       <span class="keywordflow">if</span> (<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>[i] != <span class="charliteral">&apos;z&apos;</span>) {
<a name="l02044"></a>02044          <a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>[i] = <a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>[i] + 1;
<a name="l02045"></a>02045          i = 0;
<a name="l02046"></a>02046       } <span class="keywordflow">else</span>
<a name="l02047"></a>02047          <a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>[i] = <span class="charliteral">&apos;a&apos;</span>;
<a name="l02048"></a>02048    }
<a name="l02049"></a>02049 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0fe274254c01bee899843b9057929abe"></a><!-- doxytag: member="res_jabber.c::ast_aji_invite_chat" ref="a0fe274254c01bee899843b9057929abe" args="(struct aji_client *client, char *user, char *room, char *message)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_aji_invite_chat </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>room</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>message</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>invite to a chatroom. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a></em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>room</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structmessage.html">message</a></em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>res. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01951">1951</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l02038">ast_aji_increment_mid()</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="jabber_8h_source.html#l00148">aji_client::mid</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01952"></a>01952 {
<a name="l01953"></a>01953    <span class="keywordtype">int</span> res = 0;
<a name="l01954"></a>01954    iks *invite, *body, *<span class="keyword">namespace</span>;
<a name="l01955"></a>01955 
<a name="l01956"></a>01956    invite = iks_new(<span class="stringliteral">&quot;message&quot;</span>);
<a name="l01957"></a>01957    body = iks_new(<span class="stringliteral">&quot;body&quot;</span>);
<a name="l01958"></a>01958    <span class="keyword">namespace </span>= iks_new(&quot;x&quot;);
<a name="l01959"></a>01959    <span class="keywordflow">if</span> (client &amp;&amp; invite &amp;&amp; body &amp;&amp; <span class="keyword">namespace</span>) {
<a name="l01960"></a>01960       iks_insert_attrib(invite, <span class="stringliteral">&quot;to&quot;</span>, <a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>);
<a name="l01961"></a>01961       iks_insert_attrib(invite, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01962"></a>01962       <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01963"></a>01963       iks_insert_cdata(body, <a class="code" href="structmessage.html">message</a>, 0);
<a name="l01964"></a>01964       iks_insert_attrib(<span class="keyword">namespace</span>, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;jabber:x:conference&quot;</span>);
<a name="l01965"></a>01965       iks_insert_attrib(<span class="keyword">namespace</span>, <span class="stringliteral">&quot;jid&quot;</span>, room);
<a name="l01966"></a>01966       iks_insert_node(invite, body);
<a name="l01967"></a>01967       iks_insert_node(invite, <span class="keyword">namespace</span>);
<a name="l01968"></a>01968       res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, invite);
<a name="l01969"></a>01969    } <span class="keywordflow">else</span> 
<a name="l01970"></a>01970       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01971"></a>01971 
<a name="l01972"></a>01972    iks_delete(body);
<a name="l01973"></a>01973    iks_delete(<span class="keyword">namespace</span>);
<a name="l01974"></a>01974    iks_delete(invite);
<a name="l01975"></a>01975    
<a name="l01976"></a>01976    <span class="keywordflow">return</span> res;
<a name="l01977"></a>01977 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aad4fd8a9604fb1d017882c76511c36f7"></a><!-- doxytag: member="res_jabber.c::ast_aji_join_chat" ref="aad4fd8a9604fb1d017882c76511c36f7" args="(struct aji_client *client, char *room)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_aji_join_chat </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>room</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>join a chatroom. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>room</em>&nbsp;</td><td>room to join </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>res. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01920">1920</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, and <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01921"></a>01921 {
<a name="l01922"></a>01922    <span class="keywordtype">int</span> res = 0;
<a name="l01923"></a>01923    iks *presence = NULL, *priority = NULL;
<a name="l01924"></a>01924    presence = iks_new(<span class="stringliteral">&quot;presence&quot;</span>);
<a name="l01925"></a>01925    priority = iks_new(<span class="stringliteral">&quot;priority&quot;</span>);
<a name="l01926"></a>01926    <span class="keywordflow">if</span> (presence &amp;&amp; priority &amp;&amp; client) {
<a name="l01927"></a>01927       iks_insert_cdata(priority, <span class="stringliteral">&quot;0&quot;</span>, 1);
<a name="l01928"></a>01928       iks_insert_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, room);
<a name="l01929"></a>01929       iks_insert_node(presence, priority);
<a name="l01930"></a>01930       res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, presence);
<a name="l01931"></a>01931       iks_insert_cdata(priority, <span class="stringliteral">&quot;5&quot;</span>, 1);
<a name="l01932"></a>01932       iks_insert_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, room);
<a name="l01933"></a>01933       res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, presence);
<a name="l01934"></a>01934    } <span class="keywordflow">else</span> 
<a name="l01935"></a>01935       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01936"></a>01936    
<a name="l01937"></a>01937    iks_delete(presence);
<a name="l01938"></a>01938    iks_delete(priority);
<a name="l01939"></a>01939    
<a name="l01940"></a>01940    <span class="keywordflow">return</span> res;
<a name="l01941"></a>01941 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3c77ceecc909619207e971421fc3e9ef"></a><!-- doxytag: member="res_jabber.c::ast_aji_send" ref="a3c77ceecc909619207e971421fc3e9ef" args="(struct aji_client *client, iks *x)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_aji_send </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">iks *&nbsp;</td>
          <td class="paramname"> <em>x</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Wraps raw sending. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>x</em>&nbsp;</td><td>the XMPP packet to send </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>IKS_OK on success, any other value on failure </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00818">818</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00831">aji_send_raw()</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>, <a class="el" href="res__jabber_8c_source.html#l01353">aji_client_info_handler()</a>, <a class="el" href="res__jabber_8c_source.html#l01413">aji_dinfo_handler()</a>, <a class="el" href="res__jabber_8c_source.html#l01258">aji_ditems_handler()</a>, <a class="el" href="res__jabber_8c_source.html#l02305">aji_get_roster()</a>, <a class="el" href="res__jabber_8c_source.html#l01604">aji_handle_presence()</a>, <a class="el" href="res__jabber_8c_source.html#l01822">aji_handle_subscribe()</a>, <a class="el" href="res__jabber_8c_source.html#l02146">aji_pruneregister()</a>, <a class="el" href="res__jabber_8c_source.html#l01144">aji_register_approve_handler()</a>, <a class="el" href="res__jabber_8c_source.html#l01187">aji_register_query_handler()</a>, <a class="el" href="res__jabber_8c_source.html#l02408">aji_set_presence()</a>, <a class="el" href="res__jabber_8c_source.html#l00895">aji_start_sasl()</a>, <a class="el" href="res__jabber_8c_source.html#l01894">ast_aji_create_chat()</a>, <a class="el" href="res__jabber_8c_source.html#l01951">ast_aji_invite_chat()</a>, <a class="el" href="res__jabber_8c_source.html#l01920">ast_aji_join_chat()</a>, <a class="el" href="res__jabber_8c_source.html#l01867">ast_aji_send_chat()</a>, <a class="el" href="chan__gtalk_8c_source.html#l01078">gtalk_action()</a>, <a class="el" href="chan__gtalk_8c_source.html#l01302">gtalk_add_candidate()</a>, <a class="el" href="chan__gtalk_8c_source.html#l00773">gtalk_create_candidates()</a>, <a class="el" href="chan__gtalk_8c_source.html#l01512">gtalk_digit()</a>, <a class="el" href="chan__gtalk_8c_source.html#l00379">gtalk_invite()</a>, <a class="el" href="chan__gtalk_8c_source.html#l00458">gtalk_invite_response()</a>, <a class="el" href="chan__gtalk_8c_source.html#l00571">gtalk_response()</a>, <a class="el" href="chan__jingle_8c_source.html#l00311">jingle_accept_call()</a>, <a class="el" href="chan__jingle_8c_source.html#l00883">jingle_action()</a>, <a class="el" href="chan__jingle_8c_source.html#l01089">jingle_add_candidate()</a>, <a class="el" href="chan__jingle_8c_source.html#l00583">jingle_create_candidates()</a>, <a class="el" href="chan__jingle_8c_source.html#l01284">jingle_digit()</a>, <a class="el" href="chan__jingle_8c_source.html#l00446">jingle_response()</a>, and <a class="el" href="chan__jingle_8c_source.html#l01346">jingle_transmit_invite()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00819"></a>00819 {
<a name="l00820"></a>00820    <span class="keywordflow">return</span> <a class="code" href="res__jabber_8c.html#a265a12987d4ab3483e7cd733f03ca1d6" title="Sends an XML string over an XMPP connection.">aji_send_raw</a>(client, iks_string(iks_stack(x), x));
<a name="l00821"></a>00821 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af2b674ed94b89a5798fe22714a44f046"></a><!-- doxytag: member="res_jabber.c::ast_aji_send_chat" ref="af2b674ed94b89a5798fe22714a44f046" args="(struct aji_client *client, const char *address, const char *message)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_aji_send_chat </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structaji__client.html">aji_client</a> *&nbsp;</td>
          <td class="paramname"> <em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>address</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>message</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>sends messages. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>client</em>&nbsp;</td><td>the configured XMPP client we use to connect to a XMPP server </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>address</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structmessage.html">message</a></em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>1. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l01867">1867</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="jabber_8h_source.html#l00080">AJI_CONNECTED</a>, <a class="el" href="res__jabber_8c_source.html#l00818">ast_aji_send()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="jabber_8h_source.html#l00149">aji_client::jid</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, and <a class="el" href="jabber_8h_source.html#l00159">aji_client::state</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00548">aji_send_exec()</a>, <a class="el" href="res__jabber_8c_source.html#l02595">aji_test()</a>, and <a class="el" href="res__jabber_8c_source.html#l02994">manager_jabber_send()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01868"></a>01868 {
<a name="l01869"></a>01869    <span class="keywordtype">int</span> res = 0;
<a name="l01870"></a>01870    iks *message_packet = NULL;
<a name="l01871"></a>01871    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a>) {
<a name="l01872"></a>01872       message_packet = iks_make_msg(IKS_TYPE_CHAT, address, <a class="code" href="structmessage.html">message</a>);
<a name="l01873"></a>01873       <span class="keywordflow">if</span> (message_packet) {
<a name="l01874"></a>01874          iks_insert_attrib(message_packet, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01875"></a>01875          res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, message_packet);
<a name="l01876"></a>01876       } <span class="keywordflow">else</span> {
<a name="l01877"></a>01877          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01878"></a>01878       }
<a name="l01879"></a>01879 
<a name="l01880"></a>01880       iks_delete(message_packet);
<a name="l01881"></a>01881    } <span class="keywordflow">else</span>
<a name="l01882"></a>01882       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JABBER: Not connected can&apos;t send\n&quot;</span>);
<a name="l01883"></a>01883    <span class="keywordflow">return</span> 1;
<a name="l01884"></a>01884 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad006b2b4ce6bbe60f32b13b3e430affb"></a><!-- doxytag: member="res_jabber.c::gtalk_yuck" ref="ad006b2b4ce6bbe60f32b13b3e430affb" args="(iks *node)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int gtalk_yuck </td>
          <td>(</td>
          <td class="paramtype">iks *&nbsp;</td>
          <td class="paramname"> <em>node</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Jabber GTalk function. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>node</em>&nbsp;</td><td>iks </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>1 on success, 0 on failure. </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00390">390</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l01604">aji_handle_presence()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00391"></a>00391 {
<a name="l00392"></a>00392    <span class="keywordflow">if</span> (iks_find_with_attrib(node, <span class="stringliteral">&quot;c&quot;</span>, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;http://www.google.com/xmpp/client/caps&quot;</span>))
<a name="l00393"></a>00393       <span class="keywordflow">return</span> 1;
<a name="l00394"></a>00394    <span class="keywordflow">return</span> 0;
<a name="l00395"></a>00395 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a09cc645b12759b721001a5245f64165a"></a><!-- doxytag: member="res_jabber.c::jabber_make_auth" ref="a09cc645b12759b721001a5245f64165a" args="(iksid *id, const char *pass, const char *sid)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static iks * jabber_make_auth </td>
          <td>(</td>
          <td class="paramtype">iksid *&nbsp;</td>
          <td class="paramname"> <em>id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>pass</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>sid</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Setup the authentication struct. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>id</em>&nbsp;</td><td>iksid </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pass</em>&nbsp;</td><td>password </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>sid</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>x iks </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00404">404</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="utils_8c_source.html#l00246">ast_sha1_hash()</a>, and <a class="el" href="adsistub_8c_source.html#l00059">buf</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l00944">aji_act_hook()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00405"></a>00405 {
<a name="l00406"></a>00406    iks *x, *y;
<a name="l00407"></a>00407    x = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l00408"></a>00408    iks_insert_attrib(x, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;set&quot;</span>);
<a name="l00409"></a>00409    y = iks_insert(x, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l00410"></a>00410    iks_insert_attrib(y, <span class="stringliteral">&quot;xmlns&quot;</span>, IKS_NS_AUTH);
<a name="l00411"></a>00411    iks_insert_cdata(iks_insert(y, <span class="stringliteral">&quot;username&quot;</span>), <a class="code" href="app__queue_8c.html#acd1f0e9b4730ec60f62cb0806cb06ef1">id</a>-&gt;user, 0);
<a name="l00412"></a>00412    iks_insert_cdata(iks_insert(y, <span class="stringliteral">&quot;resource&quot;</span>), <a class="code" href="app__queue_8c.html#acd1f0e9b4730ec60f62cb0806cb06ef1">id</a>-&gt;resource, 0);
<a name="l00413"></a>00413    <span class="keywordflow">if</span> (sid) {
<a name="l00414"></a>00414       <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[41];
<a name="l00415"></a>00415       <span class="keywordtype">char</span> sidpass[100];
<a name="l00416"></a>00416       snprintf(sidpass, <span class="keyword">sizeof</span>(sidpass), <span class="stringliteral">&quot;%s%s&quot;</span>, sid, <a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>);
<a name="l00417"></a>00417       <a class="code" href="utils_8h.html#a89565d41a0b343afc57a1c0d9eb85160" title="Produces SHA1 hash based on input string.">ast_sha1_hash</a>(buf, sidpass);
<a name="l00418"></a>00418       iks_insert_cdata(iks_insert(y, <span class="stringliteral">&quot;digest&quot;</span>), buf, 0);
<a name="l00419"></a>00419    } <span class="keywordflow">else</span> {
<a name="l00420"></a>00420       iks_insert_cdata(iks_insert(y, <span class="stringliteral">&quot;password&quot;</span>), <a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>, 0);
<a name="l00421"></a>00421    }
<a name="l00422"></a>00422    <span class="keywordflow">return</span> x;
<a name="l00423"></a>00423 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac3382bf6da54c56b37069bd76bbdf4f9"></a><!-- doxytag: member="res_jabber.c::load_module" ref="ac3382bf6da54c56b37069bd76bbdf4f9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Unload the jabber module. </p>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l03085">3085</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l03035">aji_reload()</a>, <a class="el" href="res__jabber_8c_source.html#l00548">aji_send_exec()</a>, <a class="el" href="res__jabber_8c_source.html#l00432">aji_status_exec()</a>, <a class="el" href="isdn__lib_8c_source.html#l00040">ARRAY_LEN</a>, <a class="el" href="cli_8c_source.html#l01927">ast_cli_register_multiple()</a>, <a class="el" href="pbx_8h_source.html#l01028">ast_custom_function_register</a>, <a class="el" href="manager_8c_source.html#l03448">ast_manager_register2()</a>, <a class="el" href="module_8h_source.html#l00062">AST_MODULE_LOAD_DECLINE</a>, <a class="el" href="module_8h_source.html#l00406">ast_register_application_xml</a>, <a class="el" href="astobj_8h_source.html#l00752">ASTOBJ_CONTAINER_INIT</a>, <a class="el" href="res__jabber_8c_source.html#l00246">clients</a>, <a class="el" href="manager_8h_source.html#l00061">EVENT_FLAG_SYSTEM</a>, and <a class="el" href="res__jabber_8c_source.html#l02994">manager_jabber_send()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03086"></a>03086 {
<a name="l03087"></a>03087    <a class="code" href="astobj_8h.html#a8551f606c8aecc4797ef7728c7792827" title="Initialize a container.">ASTOBJ_CONTAINER_INIT</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>);
<a name="l03088"></a>03088    <span class="keywordflow">if</span>(!<a class="code" href="res__jabber_8c.html#ad7e3d90484987374674cd6568d39a3de" title="Reload the jabber module.">aji_reload</a>(0))
<a name="l03089"></a>03089       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l03090"></a>03090    <a class="code" href="group__Group__AMI.html#ga332bf7ef48f67d63d849dd9febb18fb2" title="Register a manager command with the manager interface.">ast_manager_register2</a>(<span class="stringliteral">&quot;JabberSend&quot;</span>, <a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <a class="code" href="res__jabber_8c.html#a48ebc7a99890a29f1901304e574d4f03" title="Send a Jabber Message via call from the Manager.">manager_jabber_send</a>,
<a name="l03091"></a>03091          <span class="stringliteral">&quot;Sends a message to a Jabber Client&quot;</span>, <a class="code" href="res__jabber_8c.html#a06597455b511878dd26b69b5bfc4e529">mandescr_jabber_send</a>);
<a name="l03092"></a>03092    <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(<a class="code" href="res__jabber_8c.html#a8e769b687824e8e46d6977f708f0d061">app_ajisend</a>, <a class="code" href="res__jabber_8c.html#a26515ff8bd0588f1181bb6a3abc56f90" title="Dial plan function to send a message.">aji_send_exec</a>);
<a name="l03093"></a>03093    <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(<a class="code" href="res__jabber_8c.html#aac8db588d5c711d05e12d78bb8a28dcb">app_ajistatus</a>, <a class="code" href="res__jabber_8c.html#af34ff341cd5689c2c1355daf38e38682" title="Dial plan function status(). puts the status of watched user into a channel variable...">aji_status_exec</a>);
<a name="l03094"></a>03094    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="res__jabber_8c.html#a40ba67b6a93d32c6cf9f58ec7ef0980c">aji_cli</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="res__jabber_8c.html#a40ba67b6a93d32c6cf9f58ec7ef0980c">aji_cli</a>));
<a name="l03095"></a>03095    <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;<a class="code" href="res__jabber_8c.html#a12ea81a7f47eca38c7c4ac9a07bddd40">jabberstatus_function</a>);
<a name="l03096"></a>03096 
<a name="l03097"></a>03097    <span class="keywordflow">return</span> 0;
<a name="l03098"></a>03098 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a48ebc7a99890a29f1901304e574d4f03"></a><!-- doxytag: member="res_jabber.c::manager_jabber_send" ref="a48ebc7a99890a29f1901304e574d4f03" args="(struct mansession *s, const struct message *m)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int manager_jabber_send </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structmansession.html">mansession</a> *&nbsp;</td>
          <td class="paramname"> <em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structmessage.html">message</a> *&nbsp;</td>
          <td class="paramname"> <em>m</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Send a Jabber Message via call from the Manager. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>s</em>&nbsp;</td><td><a class="el" href="structmansession.html">mansession</a> Manager session </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>m</em>&nbsp;</td><td><a class="el" href="structmessage.html">message</a> Message to send </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>0 </dd></dl>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02994">2994</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l02954">ast_aji_get_client()</a>, <a class="el" href="res__jabber_8c_source.html#l01867">ast_aji_send_chat()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="manager_8c_source.html#l00969">astman_append()</a>, <a class="el" href="manager_8c_source.html#l00897">astman_get_header()</a>, <a class="el" href="manager_8c_source.html#l01032">astman_send_ack()</a>, and <a class="el" href="manager_8c_source.html#l01027">astman_send_error()</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l03085">load_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02995"></a>02995 {
<a name="l02996"></a>02996    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l02997"></a>02997    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l02998"></a>02998    <span class="keyword">const</span> <span class="keywordtype">char</span> *jabber = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;Jabber&quot;</span>);
<a name="l02999"></a>02999    <span class="keyword">const</span> <span class="keywordtype">char</span> *screenname = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;ScreenName&quot;</span>);
<a name="l03000"></a>03000    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmessage.html">message</a> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;Message&quot;</span>);
<a name="l03001"></a>03001 
<a name="l03002"></a>03002    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(jabber)) {
<a name="l03003"></a>03003       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No transport specified&quot;</span>);
<a name="l03004"></a>03004       <span class="keywordflow">return</span> 0;
<a name="l03005"></a>03005    }
<a name="l03006"></a>03006    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(screenname)) {
<a name="l03007"></a>03007       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No ScreenName specified&quot;</span>);
<a name="l03008"></a>03008       <span class="keywordflow">return</span> 0;
<a name="l03009"></a>03009    }
<a name="l03010"></a>03010    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(message)) {
<a name="l03011"></a>03011       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No Message specified&quot;</span>);
<a name="l03012"></a>03012       <span class="keywordflow">return</span> 0;
<a name="l03013"></a>03013    }
<a name="l03014"></a>03014 
<a name="l03015"></a>03015    <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Attempting to send Jabber Message&quot;</span>);
<a name="l03016"></a>03016    client = <a class="code" href="jabber_8h.html#a6689c8e948c8d55e092f30277336fde7" title="grab a aji_client structure by label name or JID (without the resource string)">ast_aji_get_client</a>(jabber);
<a name="l03017"></a>03017    <span class="keywordflow">if</span> (!client) {
<a name="l03018"></a>03018       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Could not find Sender&quot;</span>);
<a name="l03019"></a>03019       <span class="keywordflow">return</span> 0;
<a name="l03020"></a>03020    }
<a name="l03021"></a>03021    <span class="keywordflow">if</span> (strchr(screenname, <span class="charliteral">&apos;@&apos;</span>) &amp;&amp; message) {
<a name="l03022"></a>03022       <a class="code" href="jabber_8h.html#af2b674ed94b89a5798fe22714a44f046" title="sends messages.">ast_aji_send_chat</a>(client, screenname, message);
<a name="l03023"></a>03023       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Response: Success\r\n&quot;</span>);
<a name="l03024"></a>03024    } <span class="keywordflow">else</span> {
<a name="l03025"></a>03025       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Response: Error\r\n&quot;</span>);
<a name="l03026"></a>03026    }
<a name="l03027"></a>03027    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keywordtype">id</span>)) {
<a name="l03028"></a>03028       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>,<span class="keywordtype">id</span>);
<a name="l03029"></a>03029    }
<a name="l03030"></a>03030    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;\r\n&quot;</span>);
<a name="l03031"></a>03031    <span class="keywordflow">return</span> 0;
<a name="l03032"></a>03032 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad1982509765f4870f1f63412a53ea668"></a><!-- doxytag: member="res_jabber.c::reload" ref="ad1982509765f4870f1f63412a53ea668" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int reload </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Wrapper for aji_reload. </p>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l03101">3101</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l03035">aji_reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03102"></a>03102 {
<a name="l03103"></a>03103    <a class="code" href="res__jabber_8c.html#ad7e3d90484987374674cd6568d39a3de" title="Reload the jabber module.">aji_reload</a>(1);
<a name="l03104"></a>03104    <span class="keywordflow">return</span> 0;
<a name="l03105"></a>03105 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad09fa931f468002152a3cc2d5ce25eae"></a><!-- doxytag: member="res_jabber.c::unload_module" ref="ad09fa931f468002152a3cc2d5ce25eae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unload_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Unload the jabber module. </p>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l03061">3061</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>References <a class="el" href="res__jabber_8c_source.html#l00257">aji_client_destroy()</a>, <a class="el" href="jabber_8h_source.html#l00077">AJI_DISCONNECTING</a>, <a class="el" href="isdn__lib_8c_source.html#l00040">ARRAY_LEN</a>, <a class="el" href="res__jabber_8c_source.html#l02380">ast_aji_disconnect()</a>, <a class="el" href="cli_8c_source.html#l01937">ast_cli_unregister_multiple()</a>, <a class="el" href="pbx_8c_source.html#l03216">ast_custom_function_unregister()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="manager_8c_source.html#l03379">ast_manager_unregister()</a>, <a class="el" href="pbx_8c_source.html#l06403">ast_unregister_application()</a>, <a class="el" href="astobj_8h_source.html#l00765">ASTOBJ_CONTAINER_DESTROY</a>, <a class="el" href="astobj_8h_source.html#l00453">ASTOBJ_CONTAINER_DESTROYALL</a>, <a class="el" href="astobj_8h_source.html#l00376">ASTOBJ_CONTAINER_TRAVERSE</a>, <a class="el" href="astobj_8h_source.html#l00100">ASTOBJ_RDLOCK</a>, <a class="el" href="astobj_8h_source.html#l00109">ASTOBJ_UNLOCK</a>, and <a class="el" href="res__jabber_8c_source.html#l00246">clients</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03062"></a>03062 {
<a name="l03063"></a>03063 
<a name="l03064"></a>03064    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(<a class="code" href="res__jabber_8c.html#a40ba67b6a93d32c6cf9f58ec7ef0980c">aji_cli</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="res__jabber_8c.html#a40ba67b6a93d32c6cf9f58ec7ef0980c">aji_cli</a>));
<a name="l03065"></a>03065    <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(<a class="code" href="res__jabber_8c.html#a8e769b687824e8e46d6977f708f0d061">app_ajisend</a>);
<a name="l03066"></a>03066    <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(<a class="code" href="res__jabber_8c.html#aac8db588d5c711d05e12d78bb8a28dcb">app_ajistatus</a>);
<a name="l03067"></a>03067    <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;JabberSend&quot;</span>);
<a name="l03068"></a>03068    <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;<a class="code" href="res__jabber_8c.html#a12ea81a7f47eca38c7c4ac9a07bddd40">jabberstatus_function</a>);
<a name="l03069"></a>03069    
<a name="l03070"></a>03070    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l03071"></a>03071       <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l03072"></a>03072       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: Releasing and disconnecting client: %s\n&quot;</span>, iterator-&gt;name);
<a name="l03073"></a>03073       iterator-&gt;state = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a9f2e9be855a781b74badbe0c1bda278e">AJI_DISCONNECTING</a>;
<a name="l03074"></a>03074       <a class="code" href="jabber_8h.html#a06f01ad5dc78d9300fed1415b54be04a" title="disconnect from jabber server.">ast_aji_disconnect</a>(iterator);
<a name="l03075"></a>03075       pthread_join(iterator-&gt;thread, NULL);
<a name="l03076"></a>03076       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l03077"></a>03077    });
<a name="l03078"></a>03078 
<a name="l03079"></a>03079    <a class="code" href="astobj_8h.html#a5b923418ce1d4908359bb3b27b211411" title="Empty a container.">ASTOBJ_CONTAINER_DESTROYALL</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l03080"></a>03080    <a class="code" href="astobj_8h.html#a49ab9467549d53be33f3f9f3ecae97f9" title="Destroy a container.">ASTOBJ_CONTAINER_DESTROY</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>);
<a name="l03081"></a>03081    <span class="keywordflow">return</span> 0;
<a name="l03082"></a>03082 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="ab22f32016155f7f403e7178767163d7d"></a><!-- doxytag: member="res_jabber.c::__mod_info" ref="ab22f32016155f7f403e7178767163d7d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a> <a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_GLOBAL_SYMBOLS , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;AJI - Asterisk Jabber Interface&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, .reload = reload, }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l03111">3111</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

</div>
</div>
<a class="anchor" id="a40ba67b6a93d32c6cf9f58ec7ef0980c"></a><!-- doxytag: member="res_jabber.c::aji_cli" ref="a40ba67b6a93d32c6cf9f58ec7ef0980c" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> <a class="el" href="res__jabber_8c.html#a40ba67b6a93d32c6cf9f58ec7ef0980c">aji_cli</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00234">234</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

</div>
</div>
<a class="anchor" id="a8e769b687824e8e46d6977f708f0d061"></a><!-- doxytag: member="res_jabber.c::app_ajisend" ref="a8e769b687824e8e46d6977f708f0d061" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="res__jabber_8c.html#a8e769b687824e8e46d6977f708f0d061">app_ajisend</a> = &quot;JabberSend&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00242">242</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

</div>
</div>
<a class="anchor" id="aac8db588d5c711d05e12d78bb8a28dcb"></a><!-- doxytag: member="res_jabber.c::app_ajistatus" ref="aac8db588d5c711d05e12d78bb8a28dcb" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="res__jabber_8c.html#aac8db588d5c711d05e12d78bb8a28dcb">app_ajistatus</a> = &quot;JabberStatus&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00244">244</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

</div>
</div>
<a class="anchor" id="ae25b9f3970870610911f8850897e8ead"></a><!-- doxytag: member="res_jabber.c::ast_module_info" ref="ae25b9f3970870610911f8850897e8ead" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a>* <a class="el" href="structast__module__info.html">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l03111">3111</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

</div>
</div>
<a class="anchor" id="aa7afd7ba4814dbf49b1867019891fd14"></a><!-- doxytag: member="res_jabber.c::capabilities" ref="aa7afd7ba4814dbf49b1867019891fd14" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structaji__capabilities.html">aji_capabilities</a>* <a class="el" href="res__jabber_8c.html#aa7afd7ba4814dbf49b1867019891fd14">capabilities</a> = NULL</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00247">247</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>Referenced by <a class="el" href="channel_8c_source.html#l03986">ast_request()</a>.</p>

</div>
</div>
<a class="anchor" id="a412e6d5d6035a37146acd5af40e881cb"></a><!-- doxytag: member="res_jabber.c::clients" ref="a412e6d5d6035a37146acd5af40e881cb" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structaji__client__container.html">aji_client_container</a> <a class="el" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00246">246</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l02660">aji_create_client()</a>, <a class="el" href="res__jabber_8c_source.html#l02442">aji_do_set_debug()</a>, <a class="el" href="res__jabber_8c_source.html#l03035">aji_reload()</a>, <a class="el" href="res__jabber_8c_source.html#l02549">aji_show_buddies()</a>, <a class="el" href="res__jabber_8c_source.html#l02504">aji_show_clients()</a>, <a class="el" href="res__jabber_8c_source.html#l02595">aji_test()</a>, <a class="el" href="res__jabber_8c_source.html#l02954">ast_aji_get_client()</a>, <a class="el" href="res__jabber_8c_source.html#l02976">ast_aji_get_clients()</a>, <a class="el" href="chan__gtalk_8c_source.html#l01901">gtalk_load_config()</a>, <a class="el" href="chan__jingle_8c_source.html#l01724">jingle_load_config()</a>, <a class="el" href="res__jabber_8c_source.html#l03085">load_module()</a>, and <a class="el" href="res__jabber_8c_source.html#l03061">unload_module()</a>.</p>

</div>
</div>
<a class="anchor" id="a3888fe259904a2eb18b173cbf56bfa86"></a><!-- doxytag: member="res_jabber.c::globalflags" ref="a3888fe259904a2eb18b173cbf56bfa86" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__flags.html">ast_flags</a> <a class="el" href="res__jabber_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a> = { AJI_AUTOREGISTER }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Global flags, initialized to default <a class="el" href="structvalues.html">values</a>. </p>

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00250">250</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

</div>
</div>
<a class="anchor" id="a12ea81a7f47eca38c7c4ac9a07bddd40"></a><!-- doxytag: member="res_jabber.c::jabberstatus_function" ref="a12ea81a7f47eca38c7c4ac9a07bddd40" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__custom__function.html">ast_custom_function</a> <a class="el" href="res__jabber_8c.html#a12ea81a7f47eca38c7c4ac9a07bddd40">jabberstatus_function</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
   .name = <span class="stringliteral">&quot;JABBER_STATUS&quot;</span>,
   .read = <a class="code" href="res__jabber_8c.html#ac5044645216f6146c0bed265a2f8367c">acf_jabberstatus_read</a>,
}
</pre></div>
<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l00537">537</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

</div>
</div>
<a class="anchor" id="a06597455b511878dd26b69b5bfc4e529"></a><!-- doxytag: member="res_jabber.c::mandescr_jabber_send" ref="a06597455b511878dd26b69b5bfc4e529" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__jabber_8c.html#a06597455b511878dd26b69b5bfc4e529">mandescr_jabber_send</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__jabber_8c_source.html#l02981">2981</a> of file <a class="el" href="res__jabber_8c_source.html">res_jabber.c</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:23:15 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
