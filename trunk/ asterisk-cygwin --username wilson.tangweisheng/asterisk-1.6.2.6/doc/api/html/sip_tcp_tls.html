<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:23:35 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="sip_tcp_tls">SIP TCP and TLS support </a></h1><dl class="user"><dt><b>tcpfixes TCP implementation changes needed</b></dt><dd></dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000013">Todo:</a></b></dt><dd><p class="startdd">Fix TCP/TLS handling in dialplan, SRV records, transfers and much more </p>
<p>Save TCP/TLS <a class="el" href="structsessions.html">sessions</a> in registry If someone registers a SIPS uri, this forces us to set up a TLS connection back. </p>
<p>Add TCP/TLS information to function SIPPEER and SIPCHANINFO </p>
<p>If tcpenable=yes, we must open a TCP socket on the same address as the IP for UDP. The tcpbindaddr config option should only be used to open ADDITIONAL ports So we should propably go back to bindaddr= the default address to bind to. If tcpenable=yes, then bind this to both udp and TCP if tlsenable=yes, open TLS port (provided we also have cert) tcpbindaddr = extra address for additional TCP connections tlsbindaddr = extra address for additional TCP/TLS connections udpbindaddr = extra address for additional UDP connections These three options should take multiple IP/port pairs Note: Since opening additional listen sockets is a *new* feature we do not have today the XXXbindaddr options needs to be disabled until we have support for it</p>
<p>We need to test TCP <a class="el" href="structsessions.html">sessions</a> with SIP proxies and in regards to the SIP outbound specs. </p>
<p>;transport=tls was deprecated in RFC3261 and should not be used at all. See section 26.2.2.</p>
<p>Since we have had multidomain support in Asterisk for quite a while, we need to support multiple domains in our TLS implementation, meaning one socket and one cert per <a class="el" href="structdomain.html" title="Domain data structure.">domain</a> </p>
<p>Selection of transport for a request needs to be done after we've parsed all route headers, also considering outbound proxy options. First request: Outboundproxy, routes, (reg contact or URI. If URI doesn't have port: DNS <a class="el" href="structnaptr.html">naptr</a>, srv, AAA) Intermediate <a class="el" href="structrequests.html">requests</a>: Outboundproxy(only when forced), routes, contact/uri DNS <a class="el" href="structnaptr.html">naptr</a> support is crucial. A SIP uri might lead to a TLS connection. Also note that due to outbound proxy settings, a SIPS uri might have to be sent on UDP (not to recommend though) </p>
<p class="enddd">Default transports are set to UDP, which cause the wrong behaviour when contacting remote devices directly from the dialplan. UDP is only a fallback if no other method works, in order to be compatible with RFC2543 (SIP/1.0) devices. For transactions that exceed the MTU (like INIVTE with video, audio and RTT) TCP should be preferred.</p>
</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000014">Todo:</a></b></dt><dd>re-evaluate the transport= setting in sip.conf. This is right now not well thought of. If a device in sip.conf contacts us via TCP, we should not switch transport, even if udp is the configured first transport.</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000015">Todo:</a></b></dt><dd>Be prepared for one outbound and another incoming socket per pvt. This applies specially to communication with other <a class="el" href="structpeers.html">peers</a> (proxies). </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000016">Todo:</a></b></dt><dd>If the <a class="el" href="structmessage.html">message</a> is smaller than the given Content-length, the request should get a 400 Bad request <a class="el" href="structmessage.html">message</a>. If it's a response, it should be dropped. (RFC 3261, Section 18.3) </dd></dl>
<p>When dialling unconfigured <a class="el" href="structpeers.html">peers</a> (with no port <a class="el" href="structnumber.html" title="Number structure.">number</a>) or devices in external domains NAPTR records MUST be consulted to find configured transport. If they are not found, SRV records for both TCP and UDP should be checked. If there's a record for TCP, use that. If there's no record for TCP, then use UDP as a last resort. If there's no SRV records, </p>
<dl class="note"><dt><b>Note:</b></dt><dd>this only applies if there's no outbound proxy configured for the session. If an outbound proxy is configured, these procedures might apply for locating the proxy and determining the transport to use for communication with the proxy. </dd></dl>
<dl class="user"><dt><b>Other bugs to fix ----</b></dt><dd><a class="el" href="chan__sip_8c.html#a72c87ae8363b1a2b612f26c45c50d401">__set_address_from_contact(const char *fullcontact, struct sockaddr_in *sin, int tcp)</a><ul>
<li>sets TLS port as default for all TCP connections, unless other port is given in contact. <a class="el" href="chan__sip_8c.html#abf4d1c3b841a3db0b0ed118c55b8e790" title="Parse contact header and save registration (peer registration).">parse_register_contact(struct sip_pvt *pvt, struct sip_peer *peer, struct sip_request *req)</a></li>
<li>assumes that the contact the UA registers is using the same transport as the REGISTER request, which is a bad guess.<ul>
<li>Does not save any information about TCP/TLS connected devices, which is a severe BUG, as discussed on the mailing list. <a class="el" href="chan__sip_8c.html#ad09393c70f95fa46e487d279b3baa69a" title="Find out who the call is for. We use the request uri as a destination. This code...">get_destination(struct sip_pvt *p, struct sip_request *oreq)</a></li>
</ul>
</li>
<li>Doesn't store the information that we got an incoming SIPS request in the channel, so that we can require a secure signalling path OUT of Asterisk (on SIP or IAX2). Possibly, the call should fail on in-secure signalling paths if there's no override in our configuration. At least, provide a channel variable in the dialplan. <a class="el" href="chan__sip_8c.html#a62952723b70a0589e97ab31e028cd7f1" title="Call transfer support (the REFER method) Extracts Refer headers into pvt dialog structure...">get_refer_info(struct sip_pvt *transferer, struct sip_request *outgoing_req)</a></li>
<li>As above, if we have a SIPS: uri in the refer-to header</li>
<li>Does not check transport in refer_to uri. </li>
</ul>
</dd></dl>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:23:35 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
